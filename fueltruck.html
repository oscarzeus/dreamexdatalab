<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Truck Loading Operations - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --truck-color: #27ae60; /* Green theme for truck operations */
            --accent-color: var(--truck-color);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .profile-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: border-color 0.2s ease;
        }

        .profile-btn:hover img {
            border-color: rgba(52, 152, 219, 0.5);
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* New AuthManager dropdown styles */
        .dropdown-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .dropdown-avatar {
            margin-right: 12px;
        }

        .dropdown-info {
            flex: 1;
        }

        .dropdown-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .dropdown-email {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 2px;
        }

        .dropdown-role {
            font-size: 0.75rem;
            color: #888;
        }

        .dropdown-divider {
            margin: 0;
            border: none;
            border-top: 1px solid #e5e5e5;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        .avatar-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 18px 24px;
            background: linear-gradient(135deg, #27ae60, #219a52);
            border-radius: 12px;
            color: white;
        }

        .content-header h1 {
            margin: 0;
            color: white;
            font-size: 1.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-header h1::before {
            content: '\f0d1';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 1.4rem;
        }

        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-create {
            background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
            color: white;
            box-shadow: 0 3px 12px rgba(39, 174, 96, 0.25);
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
            background: linear-gradient(135deg, #219a52 0%, #1e8449 100%);
        }

        .btn-create i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .btn-create:hover i {
            transform: rotate(90deg);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-in-transit {
            background: #cce5ff;
            color: #004085;
        }

        .status-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* During loading, hide all menu items by default */
        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
            }
            
            .top-nav {
                left: 0.5rem;
            }
            
            .content-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .content-header h1 {
                font-size: 1.3rem;
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            margin: 0 0 8px 0;
            color: #374151;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2::before {
            content: '\f0d1';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--truck-color);
        }

        .form-section h3 {
            margin: 0 0 1rem 0;
            color: var(--truck-color);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-group label.required::after {
            content: ' *';
            color: #e74c3c;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--truck-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .form-control.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
            border-color: var(--truck-color);
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
            accent-color: var(--truck-color);
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            flex: 1;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-submit {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-submit:hover {
            background: linear-gradient(135deg, #219a52, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress indicator */
        .safety-progress {
            background: #e9ecef;
            border-radius: 20px;
            height: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .safety-progress-bar {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .safety-progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #666;
        }

        /* Table Controls & Actions */
        .table-controls {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--truck-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin: 0 0.125rem;
        }

        .action-btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .action-btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-1px);
        }

        .action-btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .action-btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-1px);
        }

        .action-btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .action-btn-warning:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-1px);
        }

        .action-btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .action-btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-1px);
        }

        /* Sort indicators */
        .sort-asc::after {
            content: ' ▲';
            color: var(--truck-color);
        }

        .sort-desc::after {
            content: ' ▼';
            color: var(--truck-color);
        }

        /* Row selection */
        .data-table tbody tr.selected {
            background: rgba(39, 174, 96, 0.1) !important;
            border-left: 4px solid var(--truck-color);
        }

        /* Status update modal */
        .status-update-modal {
            max-width: 400px;
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-option:hover {
            border-color: var(--truck-color);
            background: #f8f9fa;
        }

        .status-option input[type="radio"] {
            margin: 0;
            transform: scale(1.2);
            accent-color: var(--truck-color);
        }

        .status-option.selected {
            border-color: var(--truck-color);
            background: rgba(39, 174, 96, 0.1);
        }

        /* Responsive table controls */
        @media (max-width: 768px) {
            .table-controls {
                flex-direction: column;
                align-items: stretch !important;
            }
            
            .table-controls-left,
            .table-controls-right {
                justify-content: center;
                width: 100%;
            }
            
            .search-box input {
                width: 100%;
            }
        }
    </style>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Centralized Authentication System (Module imports) -->
    <script type="module" src="js/firebase-config-v8.js"></script>
    <script type="module" src="js/company-data-service.js"></script>
    <script type="module" src="js/auth.js"></script>
    
    <!-- Module Integration Script -->
    <script type="module">
        // Initialize the centralized authentication system
        import AuthManager from './js/auth.js';
        import companyDataService from './js/company-data-service.js';
        
        // Make auth manager available globally for backward compatibility
        window.authManager = new AuthManager();
        window.companyDataService = companyDataService;
        
        // Expose Firebase for direct use if needed
        import { getDatabase, ref, get, set, update, remove } from './js/firebase-config-v8.js';
        window.getDatabase = getDatabase;
        window.ref = ref;
        window.get = get;
        window.set = set;
        window.update = update;
        window.remove = remove;
        
        // Initialize Firebase Storage v8 for profile pictures and file uploads
        window.getStorage = () => window.firebase.storage();
        window.getStorageRef = (path) => window.firebase.storage().ref(path);
        window.uploadToStorage = async (storageRef, file) => {
            return await storageRef.put(file);
        };
        window.getDownloadURL = async (storageRef) => {
            return await storageRef.getDownloadURL();
        };
    </script>
    
    <!-- Immediate Firebase initialization for backward compatibility -->
    <script>
        // Firebase v8 configuration for immediate availability
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 immediately for direct access
        if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
            window.firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase v8 initialized immediately for fuel truck loading page');
        }
        
        // Ensure Firebase Storage is available
        if (window.firebase && window.firebase.storage) {
            console.log('✅ Firebase Storage v8 is available');
            // Make storage methods globally available
            window.firebaseStorage = window.firebase.storage();
        } else {
            console.warn('⚠️ Firebase Storage not available');
        }
    </script>
    
    <!-- Complete AuthManager Integration -->
    <script>
        // Complete AuthManager from staff.html
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.currentCompany = null;
                this.db = null;
                this.auth = null;
                this.storage = null;
                this.initializeAuth();
            }

            async initializeAuth() {
                console.log('🔧 Starting AuthManager initialization...');
                
                try {
                    // Wait for Firebase to be fully loaded
                    if (typeof firebase === 'undefined') {
                        console.error('❌ Firebase not loaded');
                        return;
                    }

                    // Initialize Firebase services
                    this.auth = firebase.auth();
                    this.db = firebase.database();
                    
                    if (firebase.storage) {
                        this.storage = firebase.storage();
                        console.log('✅ Firebase Storage initialized');
                    }

                    console.log('✅ Firebase services initialized');

                    // Set up authentication state listener
                    this.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            console.log('🔐 User authenticated:', user.email);
                            await this.loadUserRole(user);
                            await this.loadUserCompany();
                            await this.updateUIForAuthenticatedUser();
                            await this.updateMenuVisibility();
                        } else {
                            console.log('🚪 User signed out');
                            this.currentUser = null;
                            this.currentCompany = null;
                            this.redirectToLogin();
                        }
                    });

                } catch (error) {
                    console.error('❌ Error initializing AuthManager:', error);
                }
            }

            async loadUserRole(firebaseUser) {
                try {
                    console.log('👤 Loading user role for:', firebaseUser.email);
                    
                    const userRef = firebase.database().ref(`users/${firebaseUser.uid}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (userSnapshot.exists()) {
                        const userData = userSnapshot.val();
                        console.log('✅ User data found:', userData);
                        
                        // Merge Firebase user with database user data
                        this.currentUser = {
                            uid: firebaseUser.uid,
                            email: firebaseUser.email,
                            displayName: firebaseUser.displayName,
                            photoURL: firebaseUser.photoURL,
                            ...userData
                        };
                        
                        // Store in session for quick access
                        sessionStorage.setItem('user', JSON.stringify(this.currentUser));
                        
                        console.log('✅ Current user set:', {
                            email: this.currentUser.email,
                            role: this.currentUser.role,
                            companyId: this.currentUser.companyId
                        });
                    } else {
                        console.log('⚠️ No user data found in database for:', firebaseUser.email);
                        // Create basic user object with Firebase data
                        this.currentUser = {
                            uid: firebaseUser.uid,
                            email: firebaseUser.email,
                            displayName: firebaseUser.displayName,
                            photoURL: firebaseUser.photoURL,
                            role: null,
                            companyId: null
                        };
                    }
                } catch (error) {
                    console.error('❌ Error loading user role:', error);
                }
            }

            async loadUserCompany() {
                try {
                    if (!this.currentUser || !this.currentUser.companyId) {
                        console.log('⚠️ No company ID found for user');
                        return;
                    }

                    console.log('🏢 Loading company data for ID:', this.currentUser.companyId);
                    
                    const companyRef = firebase.database().ref(`companies/${this.currentUser.companyId}`);
                    const companySnapshot = await companyRef.once('value');
                    
                    if (companySnapshot.exists()) {
                        this.currentCompany = companySnapshot.val();
                        console.log('✅ Company loaded:', this.currentCompany.companyName);
                        
                        // Store in session for quick access
                        sessionStorage.setItem('company', JSON.stringify(this.currentCompany));
                        
                    } else {
                        console.log('⚠️ Company not found with ID:', this.currentUser.companyId);
                    }
                } catch (error) {
                    console.error('❌ Error loading company:', error);
                }
            }

            async updateUIForAuthenticatedUser() {
                try {
                    console.log('🎨 Updating UI for authenticated user...');
                    
                    if (!this.currentUser) {
                        console.log('⚠️ No current user found');
                        return;
                    }
                    
                    // Get display name
                    let displayName = this.currentUser.displayName;
                    if (!displayName && this.currentUser.firstName && this.currentUser.lastName) {
                        displayName = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                    }
                    if (!displayName) {
                        displayName = this.currentUser.email;
                    }
                    
                    console.log('👤 Display name:', displayName);
                    
                    // Update profile button
                    const profileBtn = document.getElementById('profileBtn');
                    if (profileBtn) {
                        // Preload avatar URL to avoid showing initials first
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        // Update profile button image
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Create avatar for dropdown (either real avatar or initials)
                        let dropdownAvatarHtml;
                        if (avatarUrl) {
                            dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            const initials = this.getUserInitials();
                            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                            const backgroundColor = colors[displayName.length % colors.length];
                            
                            dropdownAvatarHtml = `
                                <div class="avatar-initials" style="
                                    width: 32px; height: 32px; border-radius: 50%; 
                                    background-color: ${backgroundColor}; color: white;
                                    display: flex; align-items: center; justify-content: center;
                                    font-weight: 600; font-size: 12px;
                                ">
                                    ${initials}
                                </div>
                            `;
                        }
                        
                        // Update profile dropdown
                        const profileDropdown = document.getElementById('profileDropdown');
                        if (profileDropdown) {
                            const role = this.currentUser.role || 'User';
                            const companyName = this.currentCompany ? this.currentCompany.companyName : 'No Company';
                            
                            profileDropdown.innerHTML = `
                                <div class="dropdown-header">
                                    <div class="dropdown-avatar">
                                        ${dropdownAvatarHtml}
                                    </div>
                                    <div class="dropdown-info">
                                        <div class="dropdown-name">${displayName}</div>
                                        <div class="dropdown-email">${this.currentUser.email}</div>
                                        <div class="dropdown-role">${role} • ${companyName}</div>
                                    </div>
                                </div>
                                <hr class="dropdown-divider">
                                <a href="profile.html" class="dropdown-item">
                                    <i class="fas fa-user"></i> Profile
                                </a>
                                <a href="account.html" class="dropdown-item">
                                    <i class="fas fa-cog"></i> Account Settings
                                </a>
                                <hr class="dropdown-divider">
                                <a href="#" class="dropdown-item" onclick="authManager.logout()">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            `;
                        }
                        
                        console.log('✅ Profile UI updated');
                    } else {
                        console.log('⚠️ Profile button not found');
                    }
                    
                } catch (error) {
                    console.error('❌ Error updating UI:', error);
                }
            }

            getUserInitials() {
                if (!this.currentUser) return '?';
                
                let name = this.currentUser.displayName;
                if (!name && this.currentUser.firstName && this.currentUser.lastName) {
                    name = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                }
                if (!name) {
                    name = this.currentUser.email;
                }
                
                const words = name.split(' ').filter(word => word.length > 0);
                if (words.length >= 2) {
                    return (words[0][0] + words[1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
            }

            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            }

            redirectToLogin() {
                // Clear any stored data
                sessionStorage.removeItem('user');
                sessionStorage.removeItem('company');
                
                // Redirect to login page
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/') {
                    window.location.href = 'index.html';
                }
            }

            logout() {
                if (this.auth) {
                    this.auth.signOut().then(() => {
                        console.log('✅ User signed out successfully');
                        sessionStorage.removeItem('user');
                        this.currentUser = null;
                        window.location.href = 'index.html';
                    }).catch((error) => {
                        console.error('❌ Error signing out:', error);
                    });
                } else {
                    // Fallback if auth is not available
                    console.log('⚠️ Auth not available, clearing session and redirecting');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    window.location.href = 'index.html';
                }
            }

            // Menu visibility methods
            resetMenuVisibility() {
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                });
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
            }

            showBasicMenu() {
                console.log('🔧 Emergency fallback: Showing basic menu items');
                this.resetMenuVisibility();
                
                // Remove loading class
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                // Show basic menu items
                const homeItem = document.querySelector('[data-feature="home_view"]');
                if (homeItem) {
                    homeItem.classList.add('menu-visible');
                    console.log('✅ Showing home menu item as fallback');
                }
                
                // Show fuel management dropdown and truck loading since we're on the fuel truck page
                const fuelDropdown = document.querySelector('[data-feature="fuel_management"]');
                const truckLoadingItem = document.querySelector('[data-feature="truck_loading"]');
                
                if (fuelDropdown && truckLoadingItem) {
                    fuelDropdown.classList.add('menu-visible');
                    truckLoadingItem.classList.add('menu-visible');
                    console.log('✅ Showing fuel management menu as fallback');
                }
                
                // Show communication as basic item
                const communicationItem = document.querySelector('[data-feature="communication_view"]');
                if (communicationItem) {
                    communicationItem.classList.add('menu-visible');
                    console.log('✅ Showing communication menu as fallback');
                }
            }

            async updateMenuVisibility() {
                console.log('🔧 Starting menu visibility update...');
                
                // Remove loading class
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                try {
                    if (!this.currentUser) {
                        console.log('❌ No authenticated user found');
                        this.showBasicMenu();
                        return;
                    }
                    
                    // Get user's company ID and role
                    const companyId = this.currentUser.companyId;
                    const userRole = this.currentUser.role;
                    
                    if (!companyId || !userRole) {
                        console.log('❌ Missing company ID or user role');
                        this.showBasicMenu();
                        return;
                    }
                    
                    console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                    
                    // Get company role permissions
                    const permissionsRef = firebase.database().ref(`companies/${companyId}/roles/${userRole}/permissions`);
                    console.log(`🔍 Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                    
                    const permissionsSnapshot = await permissionsRef.once('value');
                    
                    if (!permissionsSnapshot.exists()) {
                        console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                        
                        // Try to get all roles to see what's available
                        const allRolesRef = firebase.database().ref(`companies/${companyId}/roles`);
                        const allRolesSnapshot = await allRolesRef.once('value');
                        
                        if (allRolesSnapshot.exists()) {
                            const allRoles = allRolesSnapshot.val();
                            console.log('🔍 Available roles in company:', Object.keys(allRoles));
                            
                            // Check if the role exists with different casing or format
                            const roleKeys = Object.keys(allRoles);
                            const matchingRole = roleKeys.find(key => 
                                key.toLowerCase() === userRole.toLowerCase() ||
                                key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                            );
                            
                            if (matchingRole && allRoles[matchingRole].permissions) {
                                console.log(`✅ Found matching role: ${matchingRole}`);
                                const permissions = allRoles[matchingRole].permissions;
                                this.updateMenuWithPermissions(permissions);
                                return;
                            }
                        }
                        
                        console.log('❌ No valid permissions found - showing basic menu');
                        this.showBasicMenu();
                        return;
                    }
                    
                    const permissions = permissionsSnapshot.val();
                    console.log('✅ Loaded permissions:', permissions);
                    this.updateMenuWithPermissions(permissions);
                    
                } catch (error) {
                    console.error('❌ Error updating menu visibility:', error);
                    this.showBasicMenu();
                }
            }

            updateMenuWithPermissions(permissions) {
                console.log('🎯 Updating menu with permissions...');
                console.log('🎯 Permissions object:', permissions);
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!permissions) {
                    console.log('⚠️ No permissions object provided');
                    return;
                }
                
                // Update menu visibility based on permissions
                const menuItems = document.querySelectorAll('[data-feature]');
                console.log(`🎯 Found ${menuItems.length} menu items to check`);
                let visibleCount = 0;
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const isSubmenuItem = item.closest('.submenu') !== null;
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    const parentDropdown = item.closest('.menu-dropdown');
                    const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                    
                    console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                        return;
                    }
                    
                    // If item doesn't require permission, show it
                    if (!requiresPermission) {
                        // Check if user has permission for this feature
                        if (feature && permissions[feature]) {
                            const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                            if (hasViewPermission) {
                                item.classList.add('menu-visible');
                                visibleCount++;
                                console.log(`✅ Showing menu item: ${feature}`);
                            } else {
                                console.log(`❌ No view permission for: ${feature}`);
                            }
                        } else {
                            // For basic features like home, show by default
                            if (feature === 'home_view') {
                                item.classList.add('menu-visible');
                                visibleCount++;
                                console.log(`✅ Showing basic menu item: ${feature}`);
                            } else {
                                console.log(`⚪ Feature not found in permissions: ${feature}`);
                            }
                        }
                        return;
                    }
                    
                    // If item requires permission, check if user has it
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature}`);
                        } else {
                            console.log(`❌ No view permission for: ${feature}`);
                        }
                    } else {
                        console.log(`⚪ Feature not found in permissions: ${feature}`);
                    }
                });
                
                // Handle parent dropdowns - show only if they have visible children
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    console.log(`� Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                    } else {
                        console.log(`❌ Hiding parent dropdown ${dropdownFeature} (no visible children)`);
                    }
                });
                
                console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
                
                // If no items are visible, show at least home (only if user has home permission)
                if (visibleCount === 0) {
                    const homeItem = document.querySelector('[data-feature="home_view"]');
                    if (homeItem && permissions && permissions.home_view && 
                        (permissions.home_view.view === true || permissions.home_view === true)) {
                        homeItem.classList.add('menu-visible');
                        console.log('⚠️ No permissions found - showing home as fallback');
                    }
                }
            }

            // Utility methods
            getCurrentUser() {
                return this.currentUser;
            }

            getCurrentCompany() {
                return this.currentCompany;
            }
        }

        // Reset menu visibility function
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Show basic menu function
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Flag to prevent multiple simultaneous executions
        let isMenuUpdateInProgress = false;

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            // Prevent multiple simultaneous executions
            if (isMenuUpdateInProgress) {
                console.log('🔄 Menu update already in progress, skipping...');
                return;
            }
            
            isMenuUpdateInProgress = true;
            console.log('🎯 Starting feature-based menu authorization for fueltruck.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                } else {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId);
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            } finally {
                // Reset the flag to allow future updates
                isMenuUpdateInProgress = false;
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('🔐 All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('🎯 Authorized features for fueltruck.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu authorization completed for fueltruck.html - ${visibleCount} items visible`);
                
                // Remove loading class after successful authorization
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

        // Initialize authentication system
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the centralized auth manager
            console.log('Initializing AuthManager for fuel truck loading page');
            window.authManager = new AuthManager();
            
            // Wait for auth manager to be ready, use feature-based authorization
            setTimeout(async () => {
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error('❌ Error initializing feature-based menu:', error);
                    showBasicMenu();
                }
            }, 1500);
        });
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="top-nav-left">
                    <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div class="header-logo-placeholder" id="headerLogoPlaceholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header">Loading...</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button class="notification-btn" onclick="toggleNotifications()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="profileBtn" class="profile-btn">
                            <img id="userProfileImage" 
                                 src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHR4dCB4PSIyMCIgeT0iMjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlU8L3R4dD4KPHN2Zz4K" 
                                 alt="User Avatar">
                        </button>
                        <div id="profileDropdown" class="profile-dropdown">
                            <!-- Profile dropdown content will be populated by AuthManager -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Content -->
            <div class="content">
                <div class="content-header">
                    <h1>Fuel Truck Loading Operations</h1>
                    <button class="btn btn-create" onclick="openTruckLoadingModal()">
                        <i class="fas fa-plus"></i>
                        New Truck Loading
                    </button>
                </div>

                <!-- Truck Loading Summary Cards -->
                <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="summary-card" style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 1.5rem; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;" id="activeLoadingsCount">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Active Loadings</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #5dade2); color: white; padding: 1.5rem; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;" id="todayLoadingsCount">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Today's Loadings</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f39c12, #f4d03f); color: white; padding: 1.5rem; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;" id="totalVolumeCount">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Volume (L)</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #e74c3c, #ec7063); color: white; padding: 1.5rem; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;" id="trucksInTransitCount">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Trucks In Transit</div>
                    </div>
                </div>

                <!-- Truck Loading Records Table -->
                <div class="table-container">
                    <!-- Table Controls -->
                    <div class="table-controls" style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div class="table-controls-left" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                            <!-- Search Box -->
                            <div class="search-box" style="position: relative;">
                                <input type="text" id="searchInput" placeholder="Search operations..." 
                                       style="padding: 0.5rem 0.75rem 0.5rem 2.5rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 0.9rem; width: 250px; transition: all 0.2s ease;"
                                       onkeyup="filterTable()">
                                <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                            </div>
                            
                            <!-- Status Filter -->
                            <select id="statusFilter" onchange="filterTable()" 
                                    style="padding: 0.5rem 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">All Status</option>
                                <option value="Loading">Loading</option>
                                <option value="Completed">Completed</option>
                                <option value="In-Transit">In Transit</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                            
                            <!-- Fuel Type Filter -->
                            <select id="fuelTypeFilter" onchange="filterTable()" 
                                    style="padding: 0.5rem 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">All Fuel Types</option>
                                <option value="Gasoline-95">Gasoline 95</option>
                                <option value="Gasoline-91">Gasoline 91</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Kerosene">Kerosene</option>
                                <option value="Aviation-Fuel">Aviation Fuel</option>
                                <option value="Marine-Gas-Oil">Marine Gas Oil</option>
                            </select>
                        </div>
                        
                        <div class="table-controls-right" style="display: flex; align-items: center; gap: 1rem;">
                            <!-- Bulk Actions -->
                            <select id="bulkAction" disabled 
                                    style="padding: 0.5rem 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">Bulk Actions</option>
                                <option value="update-status">Update Status</option>
                                <option value="export-selected">Export Selected</option>
                                <option value="delete-selected">Delete Selected</option>
                            </select>
                            
                            <!-- Export Button -->
                            <button onclick="exportTableData()" 
                                    style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease;">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                            
                            <!-- Results Counter -->
                            <span id="resultsCounter" style="color: #6c757d; font-size: 0.9rem;">0 operations</span>
                        </div>
                    </div>

                    <table class="data-table" id="truckLoadingTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="transform: scale(1.2); accent-color: var(--truck-color);">
                                </th>
                                <th onclick="sortTable('id')" style="cursor: pointer; user-select: none;">
                                    Operation ID <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('truckPlate')" style="cursor: pointer; user-select: none;">
                                    Truck Plate <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('driverName')" style="cursor: pointer; user-select: none;">
                                    Driver <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('fuelType')" style="cursor: pointer; user-select: none;">
                                    Fuel Type <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('requestedVolume')" style="cursor: pointer; user-select: none;">
                                    Volume <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('loadingBay')" style="cursor: pointer; user-select: none;">
                                    Loading Bay <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('status')" style="cursor: pointer; user-select: none;">
                                    Status <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th onclick="sortTable('createdAt')" style="cursor: pointer; user-select: none;">
                                    Date <i class="fas fa-sort" style="margin-left: 5px; color: #6c757d;"></i>
                                </th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="truckLoadingTableBody">
                            <!-- Truck loading records will be populated here -->
                        </tbody>
                    </table>
                    
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-truck"></i>
                        <h3>No Truck Loading Operations</h3>
                        <p>Create your first truck loading operation to get started</p>
                    </div>
                    
                    <!-- No Results State -->
                    <div class="empty-state" id="noResultsState" style="display: none;">
                        <i class="fas fa-search"></i>
                        <h3>No Results Found</h3>
                        <p>Try adjusting your search or filter criteria</p>
                    </div>
                </div>
                    </table>
                    
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-truck"></i>
                        <h3>No Truck Loading Records</h3>
                        <p>Start by creating your first truck loading operation.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Truck Loading Modal -->
    <div id="truckLoadingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Truck Loading Operation</h2>
                <button class="modal-close" onclick="closeTruckLoadingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="truckLoadingForm">
                    <div class="form-grid">
                        <!-- Truck Information Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-truck"></i> Truck Information</h3>
                            <div class="form-group">
                                <label for="truckPlate" class="required">Truck Plate Number</label>
                                <input type="text" id="truckPlate" name="truckPlate" class="form-control" placeholder="Enter truck plate number" required>
                                <div class="error-message" id="truckPlateError"></div>
                            </div>
                            <div class="form-group">
                                <label for="truckCapacity" class="required">Tank Capacity (Liters)</label>
                                <input type="number" id="truckCapacity" name="truckCapacity" class="form-control" placeholder="Enter tank capacity" required min="1000" max="50000">
                                <div class="error-message" id="truckCapacityError"></div>
                            </div>
                            <div class="form-group">
                                <label for="loadingBay" class="required">Loading Bay</label>
                                <select id="loadingBay" name="loadingBay" class="form-control" required>
                                    <option value="">Select Loading Bay</option>
                                    <option value="Bay-1">Bay 1 - North Terminal</option>
                                    <option value="Bay-2">Bay 2 - North Terminal</option>
                                    <option value="Bay-3">Bay 3 - South Terminal</option>
                                    <option value="Bay-4">Bay 4 - South Terminal</option>
                                    <option value="Bay-5">Bay 5 - East Terminal</option>
                                    <option value="Bay-6">Bay 6 - West Terminal</option>
                                </select>
                                <div class="error-message" id="loadingBayError"></div>
                            </div>
                        </div>

                        <!-- Driver Information Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Driver Information</h3>
                            <div class="form-group">
                                <label for="driverName" class="required">Driver Name</label>
                                <input type="text" id="driverName" name="driverName" class="form-control" placeholder="Enter driver's full name" required>
                                <div class="error-message" id="driverNameError"></div>
                            </div>
                            <div class="form-group">
                                <label for="driverLicense" class="required">Driver License Number</label>
                                <input type="text" id="driverLicense" name="driverLicense" class="form-control" placeholder="Enter license number" required>
                                <div class="error-message" id="driverLicenseError"></div>
                            </div>
                            <div class="form-group">
                                <label for="driverPhone">Driver Phone</label>
                                <input type="tel" id="driverPhone" name="driverPhone" class="form-control" placeholder="Enter phone number">
                                <div class="error-message" id="driverPhoneError"></div>
                            </div>
                            <div class="form-group">
                                <label for="transportCompany">Transport Company</label>
                                <input type="text" id="transportCompany" name="transportCompany" class="form-control" placeholder="Enter company name">
                                <div class="error-message" id="transportCompanyError"></div>
                            </div>
                        </div>

                        <!-- Fuel Information Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-gas-pump"></i> Fuel Information</h3>
                            <div class="form-group">
                                <label for="fuelType" class="required">Fuel Type</label>
                                <select id="fuelType" name="fuelType" class="form-control" required>
                                    <option value="">Select Fuel Type</option>
                                    <option value="Gasoline-95">Gasoline 95 Octane</option>
                                    <option value="Gasoline-91">Gasoline 91 Octane</option>
                                    <option value="Diesel">Diesel Fuel</option>
                                    <option value="Kerosene">Kerosene</option>
                                    <option value="Aviation-Fuel">Aviation Fuel</option>
                                    <option value="Marine-Gas-Oil">Marine Gas Oil</option>
                                </select>
                                <div class="error-message" id="fuelTypeError"></div>
                            </div>
                            <div class="form-group">
                                <label for="requestedVolume" class="required">Requested Volume (Liters)</label>
                                <input type="number" id="requestedVolume" name="requestedVolume" class="form-control" placeholder="Enter volume to load" required min="100">
                                <div class="error-message" id="requestedVolumeError"></div>
                            </div>
                            <div class="form-group">
                                <label for="sourceTank" class="required">Source Tank</label>
                                <select id="sourceTank" name="sourceTank" class="form-control" required>
                                    <option value="">Select Source Tank</option>
                                    <option value="Tank-A1">Tank A1 - Gasoline Storage</option>
                                    <option value="Tank-A2">Tank A2 - Gasoline Storage</option>
                                    <option value="Tank-D1">Tank D1 - Diesel Storage</option>
                                    <option value="Tank-D2">Tank D2 - Diesel Storage</option>
                                    <option value="Tank-K1">Tank K1 - Kerosene Storage</option>
                                    <option value="Tank-AF1">Tank AF1 - Aviation Fuel</option>
                                </select>
                                <div class="error-message" id="sourceTankError"></div>
                            </div>
                        </div>

                        <!-- Safety Checklist Section -->
                        <div class="form-section" style="grid-column: 1 / -1;">
                            <h3><i class="fas fa-shield-alt"></i> Safety Checklist</h3>
                            <div class="safety-progress">
                                <div class="safety-progress-bar" id="safetyProgressBar"></div>
                            </div>
                            <div class="safety-progress-text" id="safetyProgressText">Safety Checklist: 0/10 items completed</div>
                            
                            <div class="checkbox-group" id="safetyChecklist">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety1" name="safetyChecks" value="truck-inspection" onchange="updateSafetyProgress()">
                                    <label for="safety1">Truck exterior and interior inspection completed</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety2" name="safetyChecks" value="tank-inspection" onchange="updateSafetyProgress()">
                                    <label for="safety2">Tank compartments inspected for damage or leaks</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety3" name="safetyChecks" value="fire-safety" onchange="updateSafetyProgress()">
                                    <label for="safety3">Fire extinguisher and safety equipment checked</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety4" name="safetyChecks" value="grounding" onchange="updateSafetyProgress()">
                                    <label for="safety4">Proper grounding and bonding established</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety5" name="safetyChecks" value="ppe" onchange="updateSafetyProgress()">
                                    <label for="safety5">Driver wearing required PPE (helmet, safety vest, shoes)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety6" name="safetyChecks" value="permits" onchange="updateSafetyProgress()">
                                    <label for="safety6">Valid permits and documentation verified</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety7" name="safetyChecks" value="emergency" onchange="updateSafetyProgress()">
                                    <label for="safety7">Emergency procedures briefed to driver</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety8" name="safetyChecks" value="communication" onchange="updateSafetyProgress()">
                                    <label for="safety8">Communication equipment tested and functional</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety9" name="safetyChecks" value="weather" onchange="updateSafetyProgress()">
                                    <label for="safety9">Weather conditions assessed and approved for loading</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="safety10" name="safetyChecks" value="loading-area" onchange="updateSafetyProgress()">
                                    <label for="safety10">Loading area cleared and secured</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeTruckLoadingModal()">Cancel</button>
                <button type="button" class="btn-submit" onclick="submitTruckLoading()">
                    <span class="loading-spinner" id="submitSpinner"></span>
                    <i class="fas fa-save"></i>
                    Start Loading Operation
                </button>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusUpdateModal" class="modal">
        <div class="modal-content status-update-modal">
            <div class="modal-header">
                <h2>Update Operation Status</h2>
                <button class="modal-close" onclick="closeStatusUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="statusUpdateMessage" style="margin-bottom: 1.5rem; color: #495057;"></p>
                
                <div class="status-options">
                    <div class="status-option" onclick="selectStatus('Loading')">
                        <input type="radio" name="newStatus" value="Loading" id="statusLoading">
                        <label for="statusLoading" style="cursor: pointer; flex: 1;">
                            <strong>Loading</strong><br>
                            <small style="color: #6c757d;">Operation is currently loading fuel</small>
                        </label>
                    </div>
                    
                    <div class="status-option" onclick="selectStatus('Completed')">
                        <input type="radio" name="newStatus" value="Completed" id="statusCompleted">
                        <label for="statusCompleted" style="cursor: pointer; flex: 1;">
                            <strong>Completed</strong><br>
                            <small style="color: #6c757d;">Loading operation completed successfully</small>
                        </label>
                    </div>
                    
                    <div class="status-option" onclick="selectStatus('In-Transit')">
                        <input type="radio" name="newStatus" value="In-Transit" id="statusInTransit">
                        <label for="statusInTransit" style="cursor: pointer; flex: 1;">
                            <strong>In Transit</strong><br>
                            <small style="color: #6c757d;">Truck is en route to destination</small>
                        </label>
                    </div>
                    
                    <div class="status-option" onclick="selectStatus('Delivered')">
                        <input type="radio" name="newStatus" value="Delivered" id="statusDelivered">
                        <label for="statusDelivered" style="cursor: pointer; flex: 1;">
                            <strong>Delivered</strong><br>
                            <small style="color: #6c757d;">Fuel delivered to destination</small>
                        </label>
                    </div>
                    
                    <div class="status-option" onclick="selectStatus('Cancelled')">
                        <input type="radio" name="newStatus" value="Cancelled" id="statusCancelled">
                        <label for="statusCancelled" style="cursor: pointer; flex: 1;">
                            <strong>Cancelled</strong><br>
                            <small style="color: #6c757d;">Operation was cancelled</small>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="statusUpdateNotes">Update Notes (Optional)</label>
                    <textarea id="statusUpdateNotes" class="form-control" rows="3" placeholder="Add any notes about this status update..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeStatusUpdateModal()">Cancel</button>
                <button type="button" class="btn-submit" onclick="confirmStatusUpdate()">
                    <i class="fas fa-save"></i>
                    Update Status
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Operation Modal -->
    <div id="editOperationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Truck Loading Operation</h2>
                <button class="modal-close" onclick="closeEditOperationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editOperationForm">
                    <input type="hidden" id="editOperationId">
                    <div class="form-grid">
                        <!-- Truck Information Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-truck"></i> Truck Information</h3>
                            <div class="form-group">
                                <label for="editTruckPlate" class="required">Truck Plate Number</label>
                                <input type="text" id="editTruckPlate" name="truckPlate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="editTruckCapacity" class="required">Tank Capacity (Liters)</label>
                                <input type="number" id="editTruckCapacity" name="truckCapacity" class="form-control" required min="1000" max="50000">
                            </div>
                            <div class="form-group">
                                <label for="editLoadingBay" class="required">Loading Bay</label>
                                <select id="editLoadingBay" name="loadingBay" class="form-control" required>
                                    <option value="">Select Loading Bay</option>
                                    <option value="Bay-1">Bay 1 - North Terminal</option>
                                    <option value="Bay-2">Bay 2 - North Terminal</option>
                                    <option value="Bay-3">Bay 3 - South Terminal</option>
                                    <option value="Bay-4">Bay 4 - South Terminal</option>
                                    <option value="Bay-5">Bay 5 - East Terminal</option>
                                    <option value="Bay-6">Bay 6 - West Terminal</option>
                                </select>
                            </div>
                        </div>

                        <!-- Driver Information Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Driver Information</h3>
                            <div class="form-group">
                                <label for="editDriverName" class="required">Driver Name</label>
                                <input type="text" id="editDriverName" name="driverName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="editDriverLicense" class="required">Driver License Number</label>
                                <input type="text" id="editDriverLicense" name="driverLicense" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="editDriverPhone">Driver Phone</label>
                                <input type="tel" id="editDriverPhone" name="driverPhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="editTransportCompany">Transport Company</label>
                                <input type="text" id="editTransportCompany" name="transportCompany" class="form-control">
                            </div>
                        </div>

                        <!-- Fuel Information Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-gas-pump"></i> Fuel Information</h3>
                            <div class="form-group">
                                <label for="editFuelType" class="required">Fuel Type</label>
                                <select id="editFuelType" name="fuelType" class="form-control" required>
                                    <option value="">Select Fuel Type</option>
                                    <option value="Gasoline-95">Gasoline 95 Octane</option>
                                    <option value="Gasoline-91">Gasoline 91 Octane</option>
                                    <option value="Diesel">Diesel Fuel</option>
                                    <option value="Kerosene">Kerosene</option>
                                    <option value="Aviation-Fuel">Aviation Fuel</option>
                                    <option value="Marine-Gas-Oil">Marine Gas Oil</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editRequestedVolume" class="required">Requested Volume (Liters)</label>
                                <input type="number" id="editRequestedVolume" name="requestedVolume" class="form-control" required min="100">
                            </div>
                            <div class="form-group">
                                <label for="editSourceTank" class="required">Source Tank</label>
                                <select id="editSourceTank" name="sourceTank" class="form-control" required>
                                    <option value="">Select Source Tank</option>
                                    <option value="Tank-A1">Tank A1 - Gasoline Storage</option>
                                    <option value="Tank-A2">Tank A2 - Gasoline Storage</option>
                                    <option value="Tank-D1">Tank D1 - Diesel Storage</option>
                                    <option value="Tank-D2">Tank D2 - Diesel Storage</option>
                                    <option value="Tank-K1">Tank K1 - Kerosene Storage</option>
                                    <option value="Tank-AF1">Tank AF1 - Aviation Fuel</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeEditOperationModal()">Cancel</button>
                <button type="button" class="btn-submit" onclick="saveEditedOperation()">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for basic functionality -->
    <script>
        // Toggle sidebar functionality
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('show');
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.querySelector('.notification-dropdown');
            dropdown.classList.toggle('show');
        }

        // Profile dropdown functionality
        document.addEventListener('click', function(e) {
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (profileBtn && profileDropdown) {
                if (profileBtn.contains(e.target)) {
                    e.preventDefault();
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                } else if (!profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            }

            // Close notifications if clicking outside
            const notificationDropdown = document.querySelector('.notification-dropdown');
            const notificationBtn = document.querySelector('.notification-btn');
            if (notificationDropdown && !notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                notificationDropdown.classList.remove('show');
            }
        });

        // Placeholder function for opening truck loading modal
        function openTruckLoadingModal() {
            const modal = document.getElementById('truckLoadingModal');
            if (modal) {
                modal.classList.add('show');
                // Reset form
                document.getElementById('truckLoadingForm').reset();
                updateSafetyProgress();
                clearFormErrors();
            }
        }

        // Close truck loading modal
        function closeTruckLoadingModal() {
            const modal = document.getElementById('truckLoadingModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Update safety checklist progress
        function updateSafetyProgress() {
            const checkboxes = document.querySelectorAll('input[name="safetyChecks"]');
            const checkedBoxes = document.querySelectorAll('input[name="safetyChecks"]:checked');
            const progressBar = document.getElementById('safetyProgressBar');
            const progressText = document.getElementById('safetyProgressText');
            
            const total = checkboxes.length;
            const completed = checkedBoxes.length;
            const percentage = (completed / total) * 100;
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            
            if (progressText) {
                progressText.textContent = `Safety Checklist: ${completed}/${total} items completed`;
            }
        }

        // Clear form validation errors
        function clearFormErrors() {
            document.querySelectorAll('.form-control').forEach(control => {
                control.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
            });
        }

        // Show form validation error
        function showFormError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (field) {
                field.classList.add('error');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }

        // Validate truck loading form
        function validateTruckLoadingForm() {
            clearFormErrors();
            let isValid = true;

            // Validate truck plate
            const truckPlate = document.getElementById('truckPlate').value.trim();
            if (!truckPlate) {
                showFormError('truckPlate', 'Truck plate number is required');
                isValid = false;
            } else if (truckPlate.length < 3) {
                showFormError('truckPlate', 'Truck plate number must be at least 3 characters');
                isValid = false;
            }

            // Validate truck capacity
            const truckCapacity = parseInt(document.getElementById('truckCapacity').value);
            if (!truckCapacity || truckCapacity < 1000) {
                showFormError('truckCapacity', 'Tank capacity must be at least 1000 liters');
                isValid = false;
            } else if (truckCapacity > 50000) {
                showFormError('truckCapacity', 'Tank capacity cannot exceed 50000 liters');
                isValid = false;
            }

            // Validate loading bay
            const loadingBay = document.getElementById('loadingBay').value;
            if (!loadingBay) {
                showFormError('loadingBay', 'Please select a loading bay');
                isValid = false;
            }

            // Validate driver name
            const driverName = document.getElementById('driverName').value.trim();
            if (!driverName) {
                showFormError('driverName', 'Driver name is required');
                isValid = false;
            } else if (driverName.length < 2) {
                showFormError('driverName', 'Driver name must be at least 2 characters');
                isValid = false;
            }

            // Validate driver license
            const driverLicense = document.getElementById('driverLicense').value.trim();
            if (!driverLicense) {
                showFormError('driverLicense', 'Driver license number is required');
                isValid = false;
            }

            // Validate phone (if provided)
            const driverPhone = document.getElementById('driverPhone').value.trim();
            if (driverPhone && !/^[\+]?[0-9\-\(\)\s]+$/.test(driverPhone)) {
                showFormError('driverPhone', 'Please enter a valid phone number');
                isValid = false;
            }

            // Validate fuel type
            const fuelType = document.getElementById('fuelType').value;
            if (!fuelType) {
                showFormError('fuelType', 'Please select a fuel type');
                isValid = false;
            }

            // Validate requested volume
            const requestedVolume = parseInt(document.getElementById('requestedVolume').value);
            if (!requestedVolume || requestedVolume < 100) {
                showFormError('requestedVolume', 'Requested volume must be at least 100 liters');
                isValid = false;
            } else if (requestedVolume > truckCapacity) {
                showFormError('requestedVolume', 'Requested volume cannot exceed truck capacity');
                isValid = false;
            }

            // Validate source tank
            const sourceTank = document.getElementById('sourceTank').value;
            if (!sourceTank) {
                showFormError('sourceTank', 'Please select a source tank');
                isValid = false;
            }

            // Validate safety checklist
            const checkedSafetyItems = document.querySelectorAll('input[name="safetyChecks"]:checked');
            if (checkedSafetyItems.length < 10) {
                alert(`Safety checklist incomplete. Please complete all ${10 - checkedSafetyItems.length} remaining safety checks before proceeding.`);
                isValid = false;
            }

            return isValid;
        }

        // Generate unique loading operation ID
        function generateLoadingId() {
            const prefix = 'TL';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.random().toString(36).substr(2, 3).toUpperCase();
            return `${prefix}${timestamp}${random}`;
        }

        // Submit truck loading form
        async function submitTruckLoading() {
            if (!validateTruckLoadingForm()) {
                return;
            }

            const submitBtn = document.querySelector('.btn-submit');
            const spinner = document.getElementById('submitSpinner');
            
            // Show loading state
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            submitBtn.querySelector('span:last-child').textContent = 'Creating Loading Operation...';

            try {
                // Collect form data
                const formData = {
                    id: generateLoadingId(),
                    truckPlate: document.getElementById('truckPlate').value.trim(),
                    truckCapacity: parseInt(document.getElementById('truckCapacity').value),
                    loadingBay: document.getElementById('loadingBay').value,
                    driverName: document.getElementById('driverName').value.trim(),
                    driverLicense: document.getElementById('driverLicense').value.trim(),
                    driverPhone: document.getElementById('driverPhone').value.trim(),
                    transportCompany: document.getElementById('transportCompany').value.trim(),
                    fuelType: document.getElementById('fuelType').value,
                    requestedVolume: parseInt(document.getElementById('requestedVolume').value),
                    sourceTank: document.getElementById('sourceTank').value,
                    safetyChecks: Array.from(document.querySelectorAll('input[name="safetyChecks"]:checked')).map(cb => cb.value),
                    status: 'Loading',
                    createdAt: new Date().toISOString(),
                    createdBy: window.authManager?.getCurrentUser()?.email || 'Unknown User',
                    companyId: window.authManager?.getCurrentUser()?.companyId || 'unknown'
                };

                console.log('Creating truck loading operation:', formData);

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Here you would typically save to Firebase/database
                // For now, we'll just simulate success
                
                // Store in localStorage for demo purposes
                const existingOperations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
                existingOperations.unshift(formData);
                localStorage.setItem('truckLoadingOperations', JSON.stringify(existingOperations));

                // Success feedback
                alert('✅ Truck loading operation created successfully!\n\nOperation ID: ' + formData.id);
                
                // Close modal and refresh data
                closeTruckLoadingModal();
                loadTruckLoadingData();
                updateSummaryCards();

            } catch (error) {
                console.error('Error creating truck loading operation:', error);
                alert('❌ Error creating loading operation. Please try again.');
            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                submitBtn.querySelector('span:last-child').textContent = 'Start Loading Operation';
            }
        }

        // Load truck loading data from storage
        function loadTruckLoadingData() {
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            window.allOperations = operations; // Store for filtering
            displayOperations(operations);
            updateResultsCounter(operations.length);
        }

        // Display operations in table
        function displayOperations(operations) {
            const tableBody = document.getElementById('truckLoadingTableBody');
            const emptyState = document.getElementById('emptyState');
            const noResultsState = document.getElementById('noResultsState');
            
            if (!tableBody) return;
            
            // Hide all states first
            if (emptyState) emptyState.style.display = 'none';
            if (noResultsState) noResultsState.style.display = 'none';
            
            if (operations.length === 0) {
                // Check if this is due to filtering or genuinely empty
                const allOps = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
                if (allOps.length === 0) {
                    if (emptyState) emptyState.style.display = 'block';
                } else {
                    if (noResultsState) noResultsState.style.display = 'block';
                }
                tableBody.innerHTML = '';
                return;
            }
            
            tableBody.innerHTML = operations.map(op => `
                <tr data-operation-id="${op.id}">
                    <td>
                        <input type="checkbox" class="row-select" value="${op.id}" onchange="updateBulkActions()" style="transform: scale(1.2); accent-color: var(--truck-color);">
                    </td>
                    <td><strong>${op.id}</strong></td>
                    <td>${op.truckPlate}</td>
                    <td>${op.driverName}</td>
                    <td>${op.fuelType}</td>
                    <td>${op.requestedVolume.toLocaleString()} L</td>
                    <td>${op.loadingBay}</td>
                    <td><span class="status-badge status-${op.status.toLowerCase().replace('-', '')}">${op.status}</span></td>
                    <td>${new Date(op.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="action-btn action-btn-primary" onclick="viewTruckLoadingDetails('${op.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn action-btn-warning" onclick="editOperation('${op.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn action-btn-success" onclick="updateOperationStatus('${op.id}')" title="Update Status">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="action-btn action-btn-danger" onclick="deleteOperation('${op.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter table based on search and filters
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const fuelTypeFilter = document.getElementById('fuelTypeFilter').value;
            
            const allOperations = window.allOperations || [];
            
            const filteredOperations = allOperations.filter(op => {
                const matchesSearch = !searchTerm || 
                    op.id.toLowerCase().includes(searchTerm) ||
                    op.truckPlate.toLowerCase().includes(searchTerm) ||
                    op.driverName.toLowerCase().includes(searchTerm) ||
                    op.fuelType.toLowerCase().includes(searchTerm) ||
                    op.loadingBay.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || op.status === statusFilter;
                const matchesFuelType = !fuelTypeFilter || op.fuelType === fuelTypeFilter;
                
                return matchesSearch && matchesStatus && matchesFuelType;
            });
            
            displayOperations(filteredOperations);
            updateResultsCounter(filteredOperations.length);
        }

        // Update results counter
        function updateResultsCounter(count) {
            const counter = document.getElementById('resultsCounter');
            if (counter) {
                counter.textContent = `${count} operation${count !== 1 ? 's' : ''}`;
            }
        }

        // Sort table by column
        let currentSort = { column: null, direction: 'asc' };
        
        function sortTable(column) {
            const operations = window.allOperations || [];
            
            // Toggle direction if same column, otherwise reset to ascending
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.data-table th i').forEach(icon => {
                icon.className = 'fas fa-sort';
                icon.style.color = '#6c757d';
            });
            
            const sortIcon = document.querySelector(`th[onclick="sortTable('${column}')"] i`);
            if (sortIcon) {
                sortIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'}`;
                sortIcon.style.color = 'var(--truck-color)';
            }
            
            // Sort operations
            operations.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle different data types
                if (column === 'requestedVolume') {
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                } else if (column === 'createdAt') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            window.allOperations = operations;
            filterTable(); // Reapply current filters
        }

        // Toggle select all checkbox
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const rowSelects = document.querySelectorAll('.row-select');
            
            rowSelects.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const row = checkbox.closest('tr');
                if (checkbox.checked) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
            
            updateBulkActions();
        }

        // Update bulk actions based on selection
        function updateBulkActions() {
            const selectedCheckboxes = document.querySelectorAll('.row-select:checked');
            const bulkAction = document.getElementById('bulkAction');
            const selectAll = document.getElementById('selectAll');
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.row-select');
            if (selectedCheckboxes.length === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (selectedCheckboxes.length === allCheckboxes.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else {
                selectAll.indeterminate = true;
                selectAll.checked = false;
            }
            
            // Enable/disable bulk actions
            if (bulkAction) {
                bulkAction.disabled = selectedCheckboxes.length === 0;
            }
            
            // Update row highlighting
            selectedCheckboxes.forEach(checkbox => {
                checkbox.closest('tr').classList.add('selected');
            });
            
            document.querySelectorAll('.row-select:not(:checked)').forEach(checkbox => {
                checkbox.closest('tr').classList.remove('selected');
            });
        }

        // View truck loading details
        function viewTruckLoadingDetails(operationId) {
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const operation = operations.find(op => op.id === operationId);
            
            if (!operation) {
                alert('Operation not found!');
                return;
            }
            
            // Create a detailed view modal (you can enhance this further)
            const detailsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div><strong>Operation ID:</strong> ${operation.id}</div>
                    <div><strong>Status:</strong> <span class="status-badge status-${operation.status.toLowerCase().replace('-', '')}">${operation.status}</span></div>
                    <div><strong>Truck Plate:</strong> ${operation.truckPlate}</div>
                    <div><strong>Tank Capacity:</strong> ${operation.truckCapacity.toLocaleString()} L</div>
                    <div><strong>Driver Name:</strong> ${operation.driverName}</div>
                    <div><strong>Driver License:</strong> ${operation.driverLicense}</div>
                    <div><strong>Driver Phone:</strong> ${operation.driverPhone || 'N/A'}</div>
                    <div><strong>Transport Company:</strong> ${operation.transportCompany || 'N/A'}</div>
                    <div><strong>Fuel Type:</strong> ${operation.fuelType}</div>
                    <div><strong>Requested Volume:</strong> ${operation.requestedVolume.toLocaleString()} L</div>
                    <div><strong>Source Tank:</strong> ${operation.sourceTank}</div>
                    <div><strong>Loading Bay:</strong> ${operation.loadingBay}</div>
                    <div><strong>Created Date:</strong> ${new Date(operation.createdAt).toLocaleString()}</div>
                    <div><strong>Created By:</strong> ${operation.createdBy}</div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <strong>Safety Checks Completed:</strong>
                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        ${operation.safetyChecks.map(check => `<li>${check.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            // You can implement a proper details modal here
            alert(`Operation Details:\n\nID: ${operation.id}\nTruck: ${operation.truckPlate}\nDriver: ${operation.driverName}\nFuel: ${operation.fuelType}\nVolume: ${operation.requestedVolume.toLocaleString()} L\nStatus: ${operation.status}\nDate: ${new Date(operation.createdAt).toLocaleDateString()}`);
        }

        // Edit operation
        function editOperation(operationId) {
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const operation = operations.find(op => op.id === operationId);
            
            if (!operation) {
                alert('Operation not found!');
                return;
            }
            
            // Populate edit form
            document.getElementById('editOperationId').value = operation.id;
            document.getElementById('editTruckPlate').value = operation.truckPlate;
            document.getElementById('editTruckCapacity').value = operation.truckCapacity;
            document.getElementById('editLoadingBay').value = operation.loadingBay;
            document.getElementById('editDriverName').value = operation.driverName;
            document.getElementById('editDriverLicense').value = operation.driverLicense;
            document.getElementById('editDriverPhone').value = operation.driverPhone || '';
            document.getElementById('editTransportCompany').value = operation.transportCompany || '';
            document.getElementById('editFuelType').value = operation.fuelType;
            document.getElementById('editRequestedVolume').value = operation.requestedVolume;
            document.getElementById('editSourceTank').value = operation.sourceTank;
            
            // Show edit modal
            document.getElementById('editOperationModal').classList.add('show');
        }

        // Close edit modal
        function closeEditOperationModal() {
            document.getElementById('editOperationModal').classList.remove('show');
        }

        // Save edited operation
        function saveEditedOperation() {
            const operationId = document.getElementById('editOperationId').value;
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const operationIndex = operations.findIndex(op => op.id === operationId);
            
            if (operationIndex === -1) {
                alert('Operation not found!');
                return;
            }
            
            // Update operation data
            operations[operationIndex] = {
                ...operations[operationIndex],
                truckPlate: document.getElementById('editTruckPlate').value,
                truckCapacity: parseInt(document.getElementById('editTruckCapacity').value),
                loadingBay: document.getElementById('editLoadingBay').value,
                driverName: document.getElementById('editDriverName').value,
                driverLicense: document.getElementById('editDriverLicense').value,
                driverPhone: document.getElementById('editDriverPhone').value,
                transportCompany: document.getElementById('editTransportCompany').value,
                fuelType: document.getElementById('editFuelType').value,
                requestedVolume: parseInt(document.getElementById('editRequestedVolume').value),
                sourceTank: document.getElementById('editSourceTank').value,
                updatedAt: new Date().toISOString(),
                updatedBy: window.authManager?.getCurrentUser()?.email || 'Unknown User'
            };
            
            // Save to localStorage
            localStorage.setItem('truckLoadingOperations', JSON.stringify(operations));
            
            // Refresh data and close modal
            loadTruckLoadingData();
            updateSummaryCards();
            closeEditOperationModal();
            
            alert('✅ Operation updated successfully!');
        }

        // Update operation status
        let currentOperationForStatusUpdate = null;
        
        function updateOperationStatus(operationId) {
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const operation = operations.find(op => op.id === operationId);
            
            if (!operation) {
                alert('Operation not found!');
                return;
            }
            
            currentOperationForStatusUpdate = operationId;
            
            // Update modal message
            document.getElementById('statusUpdateMessage').textContent = 
                `Update status for Operation ${operationId} (${operation.truckPlate} - ${operation.driverName})`;
            
            // Clear previous selection
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('input[name="newStatus"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Clear notes
            document.getElementById('statusUpdateNotes').value = '';
            
            // Show modal
            document.getElementById('statusUpdateModal').classList.add('show');
        }

        // Select status option
        function selectStatus(status) {
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`input[value="${status}"]`).closest('.status-option');
            selectedOption.classList.add('selected');
            document.querySelector(`input[value="${status}"]`).checked = true;
        }

        // Close status update modal
        function closeStatusUpdateModal() {
            document.getElementById('statusUpdateModal').classList.remove('show');
            currentOperationForStatusUpdate = null;
        }

        // Confirm status update
        function confirmStatusUpdate() {
            const selectedStatus = document.querySelector('input[name="newStatus"]:checked');
            const notes = document.getElementById('statusUpdateNotes').value;
            
            if (!selectedStatus) {
                alert('Please select a status!');
                return;
            }
            
            if (!currentOperationForStatusUpdate) {
                alert('No operation selected!');
                return;
            }
            
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const operationIndex = operations.findIndex(op => op.id === currentOperationForStatusUpdate);
            
            if (operationIndex === -1) {
                alert('Operation not found!');
                return;
            }
            
            // Update operation status
            operations[operationIndex].status = selectedStatus.value;
            operations[operationIndex].lastStatusUpdate = new Date().toISOString();
            operations[operationIndex].statusUpdateBy = window.authManager?.getCurrentUser()?.email || 'Unknown User';
            
            if (notes) {
                operations[operationIndex].statusNotes = notes;
            }
            
            // Save to localStorage
            localStorage.setItem('truckLoadingOperations', JSON.stringify(operations));
            
            // Refresh data and close modal
            loadTruckLoadingData();
            updateSummaryCards();
            closeStatusUpdateModal();
            
            alert(`✅ Status updated to "${selectedStatus.value}" successfully!`);
        }

        // Delete operation
        function deleteOperation(operationId) {
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const operation = operations.find(op => op.id === operationId);
            
            if (!operation) {
                alert('Operation not found!');
                return;
            }
            
            const confirmDelete = confirm(
                `Are you sure you want to delete this operation?\n\n` +
                `Operation ID: ${operation.id}\n` +
                `Truck: ${operation.truckPlate}\n` +
                `Driver: ${operation.driverName}\n` +
                `Status: ${operation.status}\n\n` +
                `This action cannot be undone!`
            );
            
            if (!confirmDelete) return;
            
            // Remove operation
            const updatedOperations = operations.filter(op => op.id !== operationId);
            localStorage.setItem('truckLoadingOperations', JSON.stringify(updatedOperations));
            
            // Refresh data
            loadTruckLoadingData();
            updateSummaryCards();
            
            alert('✅ Operation deleted successfully!');
        }

        // Export table data
        function exportTableData() {
            const operations = window.allOperations || [];
            
            if (operations.length === 0) {
                alert('No data to export!');
                return;
            }
            
            // Create CSV content
            const headers = [
                'Operation ID', 'Truck Plate', 'Tank Capacity', 'Driver Name', 'Driver License', 
                'Driver Phone', 'Transport Company', 'Fuel Type', 'Requested Volume', 
                'Source Tank', 'Loading Bay', 'Status', 'Created Date', 'Created By'
            ];
            
            const csvContent = [
                headers.join(','),
                ...operations.map(op => [
                    op.id,
                    op.truckPlate,
                    op.truckCapacity,
                    `"${op.driverName}"`,
                    op.driverLicense,
                    op.driverPhone || '',
                    `"${op.transportCompany || ''}"`,
                    op.fuelType,
                    op.requestedVolume,
                    op.sourceTank,
                    op.loadingBay,
                    op.status,
                    new Date(op.createdAt).toLocaleDateString(),
                    `"${op.createdBy}"`
                ].join(','))
            ].join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `truck_loading_operations_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('✅ Data exported successfully!');
            } else {
                alert('❌ Export not supported in this browser!');
            }
        }

        // Handle bulk actions
        document.addEventListener('change', function(e) {
            if (e.target.id === 'bulkAction' && e.target.value) {
                const selectedOperations = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
                
                if (selectedOperations.length === 0) {
                    alert('No operations selected!');
                    e.target.value = '';
                    return;
                }
                
                switch (e.target.value) {
                    case 'update-status':
                        bulkUpdateStatus(selectedOperations);
                        break;
                    case 'export-selected':
                        exportSelectedOperations(selectedOperations);
                        break;
                    case 'delete-selected':
                        bulkDeleteOperations(selectedOperations);
                        break;
                }
                
                e.target.value = '';
            }
        });

        // Bulk update status
        function bulkUpdateStatus(operationIds) {
            const newStatus = prompt(`Enter new status for ${operationIds.length} operations:\n\nOptions: Loading, Completed, In-Transit, Delivered, Cancelled`);
            
            if (!newStatus) return;
            
            const validStatuses = ['Loading', 'Completed', 'In-Transit', 'Delivered', 'Cancelled'];
            if (!validStatuses.includes(newStatus)) {
                alert('Invalid status! Please use one of: ' + validStatuses.join(', '));
                return;
            }
            
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            let updatedCount = 0;
            
            operationIds.forEach(id => {
                const operationIndex = operations.findIndex(op => op.id === id);
                if (operationIndex !== -1) {
                    operations[operationIndex].status = newStatus;
                    operations[operationIndex].lastStatusUpdate = new Date().toISOString();
                    operations[operationIndex].statusUpdateBy = window.authManager?.getCurrentUser()?.email || 'Unknown User';
                    updatedCount++;
                }
            });
            
            localStorage.setItem('truckLoadingOperations', JSON.stringify(operations));
            loadTruckLoadingData();
            updateSummaryCards();
            
            alert(`✅ ${updatedCount} operations updated to "${newStatus}" status!`);
        }

        // Export selected operations
        function exportSelectedOperations(operationIds) {
            const allOperations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const selectedOperations = allOperations.filter(op => operationIds.includes(op.id));
            
            // Temporarily set selected operations for export
            const originalOperations = window.allOperations;
            window.allOperations = selectedOperations;
            exportTableData();
            window.allOperations = originalOperations;
        }

        // Bulk delete operations
        function bulkDeleteOperations(operationIds) {
            const confirmDelete = confirm(
                `Are you sure you want to delete ${operationIds.length} selected operations?\n\n` +
                `This action cannot be undone!`
            );
            
            if (!confirmDelete) return;
            
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const updatedOperations = operations.filter(op => !operationIds.includes(op.id));
            
            localStorage.setItem('truckLoadingOperations', JSON.stringify(updatedOperations));
            loadTruckLoadingData();
            updateSummaryCards();
            
            alert(`✅ ${operationIds.length} operations deleted successfully!`);
        }

        // Initialize summary data
        function updateSummaryCards() {
            const operations = JSON.parse(localStorage.getItem('truckLoadingOperations') || '[]');
            const today = new Date().toDateString();
            
            // Calculate metrics
            const activeLoadings = operations.filter(op => op.status === 'Loading').length;
            const todayLoadings = operations.filter(op => new Date(op.createdAt).toDateString() === today).length;
            const totalVolume = operations.reduce((sum, op) => sum + (op.requestedVolume || 0), 0);
            const trucksInTransit = operations.filter(op => op.status === 'In-Transit').length;
            
            // Update DOM elements
            const activeElement = document.getElementById('activeLoadingsCount');
            const todayElement = document.getElementById('todayLoadingsCount');
            const volumeElement = document.getElementById('totalVolumeCount');
            const transitElement = document.getElementById('trucksInTransitCount');
            
            if (activeElement) activeElement.textContent = activeLoadings.toString();
            if (todayElement) todayElement.textContent = todayLoadings.toString();
            if (volumeElement) volumeElement.textContent = (totalVolume / 1000).toFixed(1) + 'K';
            if (transitElement) transitElement.textContent = trucksInTransit.toString();
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚛 Fuel Truck Loading page initialized');
            updateSummaryCards();
            loadTruckLoadingData();
            
            // Initialize modal close functionality
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('truckLoadingModal');
                if (e.target === modal) {
                    closeTruckLoadingModal();
                }
            });
            
            // Initialize form field change handlers
            const requestedVolumeField = document.getElementById('requestedVolume');
            const truckCapacityField = document.getElementById('truckCapacity');
            
            if (requestedVolumeField && truckCapacityField) {
                requestedVolumeField.addEventListener('input', function() {
                    const capacity = parseInt(truckCapacityField.value);
                    const requested = parseInt(this.value);
                    
                    if (capacity && requested && requested > capacity) {
                        showFormError('requestedVolume', 'Requested volume cannot exceed truck capacity');
                    } else {
                        clearFormErrors();
                    }
                });
            }
        });
    </script>
</body>
</html>
