<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Template Creator - Dreamex Datalab HSE</title>
    
    <!-- Font Awesome Icons - CDN for proper icon display -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Firebase v8 CDN for compatibility with Storage -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Firebase Configuration and Initialization -->
    <script>
        // Firebase v8 configuration - matches roles.html for compatibility
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully');
            }
            return window.firebase;
        }

        // Initialize Firebase immediately
        try {
            if (typeof firebase !== 'undefined') {
                initializeFirebase();
            }
        } catch (error) {
            console.warn('Firebase initialization failed, will use localStorage fallback:', error);
        }
        
        // Firebase v8 compatibility functions for Database operations
        function ref(database, path) {
            return database.ref(path);
        }
        
        function get(reference) {
            return reference.once('value');
        }
        
        function set(reference, value) {
            return reference.set(value);
        }
    </script>
    
    <style>
        /* Font Awesome 6.4.0 - Enhanced Definitions */
        .fa, .fas, .fa-solid, .far, .fa-regular, .fab, .fa-brands {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands";
            font-style: normal;
            line-height: 1;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .fas, .fa-solid {
            font-weight: 900;
        }

        .far, .fa-regular {
            font-weight: 400;
        }

        .fab, .fa-brands {
            font-family: "Font Awesome 6 Brands";
            font-weight: 400;
        }

        .fa, .fab, .fad, .fal, .far, .fas, .fat {
            -moz-osx-font-smoothing: grayscale;
            -webkit-font-smoothing: antialiased;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }

        /* Ensure icons are properly sized and aligned */
        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 1.2rem;
            text-align: center;
            font-size: 1rem;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .page-title i {
            margin-right: 0.75rem;
            color: var(--secondary-color);
        }

        .tab i {
            margin-right: 0.5rem;
        }

        /* Enhanced Avatar Styles for Profile Pictures */
        .avatar-initials {
            overflow: hidden !important;
            border: 2px solid #e9ecef !important;
            position: relative !important;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-initials:hover .avatar-upload-overlay {
            display: flex;
        }

        .profile-upload-input {
            display: none;
        }
    </style>
    
    <!-- Embedded Essential CSS from styles.css -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        /* Sidebar Styles */
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform var(--transition-speed);
        }

        .sidebar .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .sidebar .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .sidebar .menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar .menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 1.2rem;
            text-align: center;
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        .menu-dropdown .submenu li a {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Sidebar Toggle */
        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .sidebar.collapsed {
            transform: translateX(-250px);
        }

        .main-content {
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Company Header */
        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        /* Notifications */
        .notifications {
            position: relative;
            margin-right: 1rem;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .notification-btn i {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* User Profile */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
    
    <style>
        /* Global Reset for Full Width Layout */
        * {
            box-sizing: border-box;
        }
          html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            font-size: 14px;
        }
        
        /* Document Template Creator specific styles */
        .container {
            width: 100%;
            max-width: none;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }/* Main Layout Structure */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            background: #f8f9fa;
            min-height: 100vh;
            width: calc(100vw - 250px);
        }

        .content {
            padding: 0 1rem 2rem 1rem;
            width: 100%;
        }        /* Tab Content Full Width */
        .tab-content {
            width: 100%;
            max-width: none;
            display: none;
        }
        
        .tab-content.active {
            display: block;
            width: 100%;
        }

        /* Template Builder Layout - Full Width */
        .template-content {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: none;
        }

        .template-builder {
            flex: 1;
            padding: 2rem;
            border-right: 1px solid #e9ecef;
            background: #fafbfc;
            min-width: 0; /* Allows flex item to shrink below content size */
        }

        .template-preview {
            flex: 1;
            padding: 2rem;
            background: white;
            min-width: 0; /* Allows flex item to shrink below content size */
        }

        .section {
            margin-bottom: 2rem;
        }        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }        .form-label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }.form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        .section-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .section-item:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .preview-area {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 2rem;
            background: #f8f9fa;
            min-height: 400px;
            font-family: 'Times New Roman', serif;
        }

        .template-actions {
            padding: 2rem;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-templates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .template-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .template-card h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }        .template-card p {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .template-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 2rem;
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .tab:hover {
            color: var(--primary-color);
            background: #f8f9fa;
        }

        .tab.active {
            color: #ffffff;
            background: var(--primary-color);
        }

        /* User Profile Avatar and Dropdown Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li {
            padding: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }

        .profile-dropdown li:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        /* Notification styles */
        .notifications {
            position: relative;
            margin-right: 1rem;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .notification-btn i {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #2c3e50;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Page Header Styles */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.25rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 2rem;
            margin: 0 2rem 2rem 2rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        /* Professional stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 0 2rem 1.5rem 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .stat-card .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            line-height: 1;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .stat-card div:last-child {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            line-height: 1.2;
        }

        /* Top Navigation Styles */
        .top-nav {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }        /* Template Library Styles */
        .template-library-container {
            padding: 2rem;
            max-width: 100%;
        }

        .template-library-container .page-header {
            margin-bottom: 2rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        /* Textarea section styles */
        .textarea-options {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .textarea-preview {
            position: relative;
        }
        
        .textarea-preview textarea {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .textarea-preview textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: 0;
        }
        
        .textarea-preview .textarea-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .textarea-required-indicator {
            color: #dc3545;
            font-weight: 500;
        }
        
        .textarea-readonly-indicator {
            color: #28a745;
            font-weight: 500;
        }
        
        .textarea-maxlength-indicator {
            color: #6c757d;
        }

        /* Upload Progress Styles */
        .upload-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
        }
        
        .upload-progress .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .template-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 1rem;
                max-height: 70vh;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
            background: white;
        }

        .modal-footer {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Template view content styles */
        .template-view-content {
            font-family: inherit;
            line-height: 1.6;
        }

        .template-view-content h1,
        .template-view-content h2,
        .template-view-content h3 {
            color: #2c3e50;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .template-view-content h1 {
            font-size: 2rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .template-view-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .template-view-content table th,
        .template-view-content table td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        .template-view-content table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .template-view-content .placeholder {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }

        .template-view-content textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .template-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 1rem;
                max-height: 70vh;
            }
        }
    </style>

    <!-- Local JavaScript Libraries -->
    <script>
        // Simple Auth State Management (replaces Firebase)
        const localAuth = {
            currentUser: null,
            
            getCurrentUser() {
                const userData = localStorage.getItem('currentUser');
                return userData ? JSON.parse(userData) : null;
            },
            
            setCurrentUser(user) {
                this.currentUser = user;
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    localStorage.removeItem('currentUser');
                }
            },
            
            isLoggedIn() {
                return this.getCurrentUser() !== null;
            }
        };

        // Simple Database Simulation (replaces Firebase Database)
        const localDB = {
            data: JSON.parse(localStorage.getItem('localDB') || '{}'),
            
            save() {
                localStorage.setItem('localDB', JSON.stringify(this.data));
            },
            
            ref(path) {
                return {
                    set: (value) => {
                        this.setPath(path, value);
                        this.save();
                        return Promise.resolve();
                    },
                    
                    get: () => {
                        const value = this.getPath(path);
                        return Promise.resolve({ exists: () => value !== undefined, val: () => value });
                    },
                    
                    on: (event, callback) => {
                        // Simulate real-time updates
                        callback({ val: () => this.getPath(path) });
                    }
                };
            },
            
            getPath(path) {
                const keys = path.split('/').filter(k => k);
                let current = this.data;
                for (const key of keys) {
                    if (current[key] === undefined) return undefined;
                    current = current[key];
                }
                return current;
            },
            
            setPath(path, value) {
                const keys = path.split('/').filter(k => k);
                let current = this.data;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) current[keys[i]] = {};
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;
            }
        };

        // Firebase compatibility layer with Storage support
        const firebase = {
            auth: () => ({
                currentUser: localAuth.getCurrentUser(),
                onAuthStateChanged: (callback) => {
                    // Simulate auth state change
                    setTimeout(() => callback(localAuth.getCurrentUser()), 100);
                }
            }),
            database: () => ({
                ref: (path) => localDB.ref(path)
            }),
            storage: () => ({
                ref: (path) => ({
                    put: (file) => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                // Store as base64 in localStorage for offline mode
                                const imageData = e.target.result;
                                localStorage.setItem(`storage_${path}`, imageData);
                                
                                // Simulate upload progress
                                const uploadTask = {
                                    snapshot: {
                                        ref: {
                                            getDownloadURL: () => Promise.resolve(imageData)
                                        }
                                    }
                                };
                                resolve(uploadTask);
                            };
                            reader.readAsDataURL(file);
                        });
                    },
                    getDownloadURL: () => {
                        const imageData = localStorage.getItem(`storage_${path}`);
                        return Promise.resolve(imageData || null);
                    }
                })
            }),
            firestore: () => ({
                collection: (name) => ({
                    doc: (id) => ({
                        set: (data) => {
                            localDB.ref(`${name}/${id}`).set(data);
                            return Promise.resolve();
                        }
                    })
                })
            })
        };

        // Initialize Firebase if available
        if (typeof window.firebase !== 'undefined') {
            // Use real Firebase
            console.log('Using real Firebase');
        } else {
            // Use local fallback
            window.firebase = firebase;
            console.log('Using Firebase fallback with local storage');
        }
    </script>
    <!-- GitHub Pages Fix Script -->
    <!-- Embedded GitHub Pages Fix and Common Components -->
</head>
<body>
    <!-- Upload Progress Indicator -->
    <div id="uploadProgress" class="upload-progress">
        <div class="spinner"></div>
        <span id="uploadMessage">Uploading...</span>
    </div>
    
    <div class="app-container">
        <!-- Sidebar Menu -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                        <li data-feature="emissions_view"><a href="emissions.html">Emissions</a></li>
                        <li data-feature="waste_view"><a href="wasteboard.html">Waste Management</a></li>
                        <li data-feature="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li><a href="#"><i class="fas fa-truck"></i> Logistics</a></li>
                <li class="menu-dropdown" data-feature="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="recruitment_view"><a href="jobscreen.html">Recruitment</a></li>
                        <li data-feature="interview_view"><a href="interview.html">Interview Applicants</a></li>
                        <li data-feature="contract_view"><a href="contract.html">Employee Contracts</a></li>
                        <li data-feature="document_templates_view"><a href="dochtml.html">Document Templates</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companyboard.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html">Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button class="sidebar-toggle-btn" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header">Document Creator</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="header-top-row">
                        <div>
                            <h1 class="page-title">
                                <i class="fas fa-file-alt"></i>
                                Document Template Creator
                            </h1>
                            <p class="page-subtitle">Create reusable document templates for your entire organization</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTemplates">0</div>
                        <div>Total Templates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeTemplates">0</div>
                        <div>Active Templates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recentTemplates">0</div>
                        <div>Recent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="draftTemplates">0</div>
                        <div>Drafts</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('builder')">
                        <i class="fas fa-hammer"></i> Template Builder
                    </button>
                    <button class="tab" onclick="switchTab('library')">
                        <i class="fas fa-folder"></i> Template Library
                    </button>
                </div>                <!-- Template Builder Tab -->
                <div id="builderTab" class="tab-content active">
                    <div class="template-content">
                        <!-- Template Builder -->
                        <div class="template-builder">                            <div class="section">
                                <div class="section-title">
                                    <i class="fas fa-info-circle"></i>
                                    Basic Information
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Template Name</label>
                                    <input type="text" id="templateName" class="form-control" placeholder="Enter template name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea id="templateDescription" class="form-control" rows="3" placeholder="Describe this template"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select id="templateCategory" class="form-control">
                                        <option value="">Select category</option>
                                        <option value="contract">Contract Templates</option>
                                        <option value="letter">Letter Templates</option>
                                        <option value="report">Report Templates</option>
                                        <option value="form">Form Templates</option>
                                        <option value="invoice">Invoice Templates</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-image"></i>
                                        Template Logo
                                    </label>
                                    <div style="border: 2px dashed #e9ecef; border-radius: 8px; padding: 1.5rem; text-align: center; transition: all 0.3s ease;" id="logoUploadArea">
                                        <div id="logoPreview" style="display: none; margin-bottom: 1rem;">
                                            <img id="logoImage" src="" alt="Logo Preview" style="max-height: 80px; max-width: 200px; object-fit: contain; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        </div>
                                        <div id="logoUploadPrompt">
                                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6c757d; margin-bottom: 0.5rem;"></i>
                                            <p style="color: #6c757d; margin-bottom: 1rem;">Click to upload logo or drag and drop</p>
                                            <p style="color: #6c757d; font-size: 0.8rem; margin: 0;">Supported formats: PNG, JPG, SVG (Max 2MB)</p>
                                        </div>
                                        <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                        <div style="margin-top: 1rem;">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('logoInput').click()">
                                                <i class="fas fa-upload"></i> Choose Logo
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="removeLogo()" id="removeLogoBtn" style="display: none; margin-left: 0.5rem;">
                                                <i class="fas fa-trash"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div class="section-title">
                                    <i class="fas fa-puzzle-piece"></i>
                                    Template Sections
                                    <button class="btn btn-success" onclick="addSection()" style="margin-left: auto;">
                                        <i class="fas fa-plus"></i> Add Section
                                    </button>
                                </div>
                                <div id="sectionsContainer">
                                    <!-- Sections will be added here -->
                                </div>
                            </div>
                        </div>

                        <!-- Template Preview -->
                        <div class="template-preview">
                            <div class="section-title">
                                <i class="fas fa-eye"></i>
                                Live Preview
                            </div>
                            <div id="previewArea" class="preview-area">
                                <p style="color: #6c757d; text-align: center; font-style: italic;">
                                    Add sections to see the template preview
                                </p>
                            </div>
                        </div>
                    </div>

            <!-- Template Actions -->
            <div class="template-actions">
                <div>
                    <button class="btn btn-secondary" onclick="clearTemplate()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-secondary" onclick="newTemplate()">
                        <i class="fas fa-plus"></i> New Template
                    </button>
                    <button class="btn btn-primary" onclick="exportTemplate()">
                        <i class="fas fa-download"></i> Export Template
                    </button>
                    <button id="saveTemplateBtn" class="btn btn-success" onclick="saveTemplate()">
                        <i class="fas fa-save"></i> Save Template
                    </button>
                    <span id="editingIndicator" style="color: #28a745; font-size: 0.9rem; display: none;">
                        <i class="fas fa-edit"></i> Editing existing template
                    </span>
                </div>
            </div>
        </div>        <!-- Template Library Tab -->
        <div id="libraryTab" class="tab-content">
            <div class="template-library-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Your Templates</h3>
                    <button class="btn btn-info" onclick="migrateTemplatesToDualStorage()" title="Migrate templates to ensure they appear in contract creation">
                        <i class="fas fa-sync-alt"></i> Sync Templates
                    </button>
                </div>
                <div id="savedTemplates" class="saved-templates">
                    <!-- Saved templates will be displayed here -->
                </div>
            </div>
        </div>
            </div>
        </main>
    </div>

    <!-- Template View Modal -->
    <div id="templateViewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="viewModalTitle">Template Preview</h2>
                <span class="close" onclick="closeTemplateViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="templateViewContent">
                    <!-- Template content will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplateViewModal()">Close</button>
                <button class="btn btn-primary" onclick="editFromView()">Edit Template</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sectionCounter = 0;
        let templates = []; // Will be loaded from company-scoped storage
        let currentEditingTemplateId = null; // Track which template is being edited

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - starting template builder initialization');
            loadCompanyTemplates(); // Load company-scoped templates
            updatePreview();
            setupSidebarToggle();
            
            // Initialize auth with a slight delay to ensure all elements are ready
            setTimeout(() => {
                console.log('Loading user profile via dashboard.html method...');
                loadUserProfile().then(() => {
                    console.log('Profile loading completed in DOMContentLoaded');
                }).catch(error => {
                    console.error('Error in DOMContentLoaded profile loading:', error);
                });
            }, 200);
        });

        // Sidebar toggle functionality
        function setupSidebarToggle() {
            const toggleBtn = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (toggleBtn && sidebar && mainContent) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                    
                    // Save sidebar state
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                });
                
                // Restore sidebar state
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                }
            }
        }

        // User profile dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');

            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userProfileBtn.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }            // Initialize Firebase authentication
            initializeAuth();
        });

        // Initialize Firebase authentication
        function initializeAuth() {
            // The centralized AuthManager handles all authentication
            // This function is kept for compatibility but delegates to centralized system
            console.log('Using centralized authentication system');
            
            // The authManager is already initialized and handles:
            // - User authentication state
            // - Profile picture loading from Firebase Storage or localStorage  
            // - Company branding
            // - UI updates
        }

        // Load user profile information (dashboard.html compatibility)
        async function loadUserProfile() {
            if (!authManager || !authManager.currentUser) return;
            
            const userData = authManager.currentUser;
            const userAvatar = document.getElementById('userAvatar');
            
            if (userData && userAvatar) {
                // Use AuthManager methods to get user info
                const displayName = authManager.getUserDisplayName();
                const email = authManager.getUserEmail();
                
                // Preload avatar URL to avoid showing initials first
                const avatarUrl = await authManager.getUserAvatarUrl();
                
                // Check if user has a profile picture
                if (avatarUrl) {
                    userAvatar.src = avatarUrl;
                    userAvatar.alt = displayName || 'User Avatar';
                    console.log('✅ Profile picture loaded from:', avatarUrl.substring(0, 50) + '...');
                } else if (userData.profilePicture) {
                    userAvatar.src = userData.profilePicture;
                    userAvatar.alt = displayName || 'User Avatar';
                    console.log('✅ Profile picture loaded from userData.profilePicture');
                } else if (userData.photoURL) {
                    userAvatar.src = userData.photoURL;
                    userAvatar.alt = displayName || 'User Avatar';
                    console.log('✅ Profile picture loaded from userData.photoURL');
                } else {
                    // Generate initials avatar using AuthManager
                    authManager.generateInitialsAvatar(displayName, userAvatar);
                    console.log('✅ Generated initials avatar for:', displayName);
                }
            }
        }

        // Update user profile in UI (delegated to centralized authManager)
        function updateUserProfile(user) {
            // This function is kept for compatibility but delegates to centralized authManager
            console.log('Delegating user profile update to centralized authManager');
            if (authManager && authManager.updateUserAvatarDisplay) {
                authManager.updateUserAvatarDisplay('userAvatar');
            }
        }        // Tab switching functionality with edit protection
        function switchTab(tabName) {
            // Check if user is editing and has unsaved changes
            if (currentEditingTemplateId && tabName !== 'builder') {
                const templateName = document.getElementById('templateName').value.trim();
                if (templateName && !confirm('You are currently editing a template. Are you sure you want to leave? Unsaved changes may be lost.')) {
                    return; // Don't switch tabs
                }
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Load saved templates when switching to library tab
            if (tabName === 'library') {
                loadCompanyTemplates(); // Reload company-scoped templates
            }
        }

        // Add a new section to the template
        function addSection(title = '', content = '', type = 'text') {
            const container = document.getElementById('sectionsContainer');
            const sectionId = `section_${++sectionCounter}`;
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section-item';
            sectionDiv.id = sectionId;
            
            sectionDiv.innerHTML = `
                <button class="remove-btn" onclick="removeSection('${sectionId}')">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="form-group">
                    <label class="form-label">Section Type</label>                    <select class="form-control section-type" onchange="updateSectionType('${sectionId}', this.value)">
                        <option value="text" ${type === 'text' ? 'selected' : ''}>Text Content</option>
                        <option value="heading" ${type === 'heading' ? 'selected' : ''}>Heading</option>
                        <option value="list" ${type === 'list' ? 'selected' : ''}>List</option>
                        <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>Large Text Area</option>
                        <option value="table" ${type === 'table' ? 'selected' : ''}>Table</option>
                        <option value="placeholder" ${type === 'placeholder' ? 'selected' : ''}>Placeholder Field</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Section Title</label>
                    <input type="text" class="form-control section-title-input" value="${title}" 
                           placeholder="Enter section title" onkeyup="updatePreview()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-control section-content" rows="4" 
                              placeholder="Enter section content" onkeyup="updatePreview()">${content}</textarea>
                </div>
                
                <div class="form-group" id="extraOptions_${sectionId}" style="display: none;">
                    <!-- Extra options for specific section types will be added here -->
                </div>
            `;
              container.appendChild(sectionDiv);
            updateSectionType(sectionId, type);
            setupTextareaCounters();
            updatePreview();
        }

        // Remove a section
        function removeSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && confirm('Are you sure you want to remove this section?')) {
                section.remove();
                updatePreview();
            }
        }

        // Update section type and show relevant options
        function updateSectionType(sectionId, type) {
            const extraOptions = document.getElementById(`extraOptions_${sectionId}`);
            const section = document.getElementById(sectionId);
            const contentTextarea = section.querySelector('.section-content');
            
            // Clear extra options
            extraOptions.innerHTML = '';
            extraOptions.style.display = 'none';
              // Update placeholder based on type
            switch(type) {
                case 'heading':
                    contentTextarea.placeholder = 'Enter heading text';
                    break;
                case 'list':
                    contentTextarea.placeholder = 'Enter list items (one per line)';
                    break;                case 'textarea':
                    contentTextarea.placeholder = 'Enter large text content (supports multiple paragraphs)';
                    contentTextarea.rows = 8; // Make it larger for textarea type
                    extraOptions.innerHTML = `
                        <div class="textarea-options">
                            <label class="form-label" style="margin-bottom: 0.75rem; display: block; font-weight: 600;">
                                <i class="fas fa-cog"></i> Text Area Configuration
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                                    <input type="checkbox" class="textarea-readonly" onchange="updatePreview()">
                                    <i class="fas fa-lock" style="color: #28a745;"></i>
                                    Read-only
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                                    <input type="checkbox" class="textarea-required" onchange="updatePreview()">
                                    <i class="fas fa-asterisk" style="color: #dc3545;"></i>
                                    Required
                                </label>
                            </div>                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <label style="font-weight: 500; color: #495057;">
                                    <i class="fas fa-ruler-horizontal"></i> Character Limit:
                                </label>
                                <input type="number" class="form-control textarea-maxlength" 
                                       style="width: 120px;" placeholder="500" min="0" max="10000" 
                                       onchange="updatePreview(); updateTextareaCounter('${sectionId}')">
                                <small style="color: #6c757d;">Leave empty for no limit</small>
                            </div>
                        </div>
                    `;
                    extraOptions.style.display = 'block';
                    break;
                case 'table':
                    contentTextarea.placeholder = 'Enter table data (use | to separate columns, one row per line)';
                    extraOptions.innerHTML = `
                        <label class="form-label">Table Headers (separated by |)</label>
                        <input type="text" class="form-control table-headers" 
                               placeholder="Header 1 | Header 2 | Header 3" onkeyup="updatePreview()">
                    `;
                    extraOptions.style.display = 'block';
                    break;
                case 'placeholder':
                    contentTextarea.placeholder = 'Enter placeholder name (e.g., {{employee_name}})';
                    extraOptions.innerHTML = `
                        <label class="form-label">Placeholder Type</label>
                        <select class="form-control placeholder-type" onchange="updatePreview()">
                            <option value="text">Text Input</option>
                            <option value="date">Date</option>
                            <option value="number">Number</option>
                            <option value="email">Email</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <label class="form-label">Default Value</label>
                        <input type="text" class="form-control placeholder-default" 
                               placeholder="Default value (optional)" onkeyup="updatePreview()">
                    `;
                    extraOptions.style.display = 'block';
                    break;                default:
                    contentTextarea.placeholder = 'Enter section content';
                    contentTextarea.rows = 4; // Reset to default rows for other types
            }
            
            updatePreview();
        }        // Update the live preview
        function updatePreview() {
            const previewArea = document.getElementById('previewArea');
            const sections = document.querySelectorAll('.section-item');
            const logo = getCurrentLogo();
            
            let previewHTML = '';
            
            // Add logo at the top if available
            if (logo && logo !== 'data:') {
                previewHTML += `
                    <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                        <img src="${logo}" alt="Template Logo" style="max-height: 80px; max-width: 200px; object-fit: contain;">
                    </div>
                `;
            }
            
            if (sections.length === 0) {
                if (!logo || logo === 'data:') {
                    previewArea.innerHTML = `
                        <p style="color: #6c757d; text-align: center; font-style: italic;">
                            Add sections to see the template preview
                        </p>
                    `;
                } else {
                    previewArea.innerHTML = previewHTML + `
                        <p style="color: #6c757d; text-align: center; font-style: italic;">
                            Add sections to see the template preview
                        </p>
                    `;
                }
                return;
            }
            
            sections.forEach(section => {
                const type = section.querySelector('.section-type').value;
                const title = section.querySelector('.section-title-input').value;
                const content = section.querySelector('.section-content').value;
                
                if (title || content) {
                    switch(type) {
                        case 'heading':
                            previewHTML += `<h2 style="color: #2c3e50; margin-bottom: 1rem;">${title || content}</h2>`;
                            break;case 'list':
                            if (content) {
                                const items = content.split('\n').filter(item => item.trim());
                                previewHTML += title ? `<h3>${title}</h3>` : '';
                                previewHTML += '<ul>';
                                items.forEach(item => {
                                    previewHTML += `<li>${item.trim()}</li>`;
                                });
                                previewHTML += '</ul>';
                            }
                            break;                        case 'textarea':
                            const isReadonly = section.querySelector('.textarea-readonly')?.checked || false;
                            const isRequired = section.querySelector('.textarea-required')?.checked || false;
                            const maxLength = section.querySelector('.textarea-maxlength')?.value || '';
                            
                            previewHTML += title ? `<h3>${title}</h3>` : '';
                            previewHTML += `
                                <div class="textarea-preview" style="margin-bottom: 1rem;">
                                    <textarea 
                                        style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; 
                                               font-family: inherit; font-size: 0.9rem; line-height: 1.5; resize: vertical;
                                               min-height: 120px; background: ${isReadonly ? '#f8f9fa' : 'white'};"
                                        placeholder="${content || 'Enter your text here...'}"
                                        ${isReadonly ? 'readonly' : ''}
                                        ${isRequired ? 'required' : ''}
                                        ${maxLength ? `maxlength="${maxLength}"` : ''}
                                    >${content}</textarea>
                                    <div class="textarea-info">
                                        <div>
                                            ${isRequired ? '<span class="textarea-required-indicator">* Required field</span>' : ''}
                                            ${isReadonly ? '<span class="textarea-readonly-indicator">📖 Read-only</span>' : ''}
                                        </div>
                                        ${maxLength ? `<span class="textarea-maxlength-indicator">Max: ${maxLength} characters</span>` : ''}
                                    </div>
                                </div>
                            `;
                            break;
                        case 'table':
                            const headers = section.querySelector('.table-headers')?.value || '';
                            if (content || headers) {
                                previewHTML += title ? `<h3>${title}</h3>` : '';
                                previewHTML += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">';
                                
                                if (headers) {
                                    const headerCells = headers.split('|').map(h => h.trim());
                                    previewHTML += '<thead><tr>';
                                    headerCells.forEach(header => {
                                        previewHTML += `<th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;">${header}</th>`;
                                    });
                                    previewHTML += '</tr></thead>';
                                }
                                
                                if (content) {
                                    const rows = content.split('\n').filter(row => row.trim());
                                    previewHTML += '<tbody>';
                                    rows.forEach(row => {
                                        const cells = row.split('|').map(c => c.trim());
                                        previewHTML += '<tr>';
                                        cells.forEach(cell => {
                                            previewHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`;
                                        });
                                        previewHTML += '</tr>';
                                    });
                                    previewHTML += '</tbody>';
                                }
                                
                                previewHTML += '</table>';
                            }
                            break;
                        case 'placeholder':
                            const placeholderType = section.querySelector('.placeholder-type')?.value || 'text';
                            const defaultValue = section.querySelector('.placeholder-default')?.value || '';
                            previewHTML += title ? `<h3>${title}</h3>` : '';
                            previewHTML += `<div style="background: #e3f2fd; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem;">
                                <strong>Placeholder:</strong> ${content} 
                                <span style="color: #666;">(${placeholderType}${defaultValue ? ', default: ' + defaultValue : ''})</span>
                            </div>`;
                            break;
                        default:
                            previewHTML += title ? `<h3>${title}</h3>` : '';
                            previewHTML += `<p style="margin-bottom: 1rem;">${content.replace(/\n/g, '<br>')}</p>`;
                    }
                }
            });
            
            previewArea.innerHTML = previewHTML || `
                <p style="color: #6c757d; text-align: center; font-style: italic;">
                    Add content to sections to see the preview
                </p>
            `;
        }

        // Load templates from company-scoped storage
        async function loadCompanyTemplates() {
            console.log('🔄 Loading company-scoped templates...');
            
            try {
                // Get current company ID
                const companyId = companyDataService?.getCurrentCompanyId();
                if (!companyId) {
                    console.error('❌ No company context found - templates require company scope');
                    alert('Error: Templates require company context. Please ensure you are logged in with proper company access.');
                    templates = []; // Clear templates if no company context
                    loadSavedTemplates();
                    return;
                }
                
                console.log('🏢 Loading templates for company:', companyId);
                
                // Try to load from Firebase Firestore first
                if (typeof firebase !== 'undefined' && firebase.firestore && typeof initializeFirebase === 'function') {
                    try {
                        const firebaseInstance = initializeFirebase();
                        if (firebaseInstance && firebaseInstance.apps.length > 0) {
                            const db = firebaseInstance.firestore();
                            
                            console.log('🔍 Fetching company templates from Firestore...');
                            const templatesQuery = await db.collection('documentTemplates')
                                .where('companyId', '==', companyId)
                                .orderBy('lastModified', 'desc')
                                .get();
                            
                            if (!templatesQuery.empty) {
                                templates = templatesQuery.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                
                                console.log(`✅ Loaded ${templates.length} company templates from Firestore`);
                                
                                // Cache in localStorage with company prefix
                                localStorage.setItem(`documentTemplates_${companyId}`, JSON.stringify(templates));
                                loadSavedTemplates();
                                return;
                            } else {
                                console.log('ℹ️ No company templates found in Firestore');
                            }
                        }
                    } catch (firebaseError) {
                        console.log('Firebase Firestore not available:', firebaseError);
                    }
                }
                
                // Load from company-scoped localStorage only
                console.log('🔄 Loading from company-scoped localStorage...');
                templates = JSON.parse(localStorage.getItem(`documentTemplates_${companyId}`)) || [];
                console.log(`✅ Loaded ${templates.length} templates from company-scoped localStorage`);
                
            } catch (error) {
                console.error('Error loading company templates:', error);
                // No fallback to global - company scope is required
                templates = [];
                console.log('❌ Failed to load templates - company scope required');
            }
            
            loadSavedTemplates();
        }

        // Save template to company-scoped storage
        async function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const description = document.getElementById('templateDescription').value.trim();
            const category = document.getElementById('templateCategory').value;
            const logo = getCurrentLogo(); // Get logo data
            
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            // Validate company context BEFORE processing sections
            const companyId = companyDataService?.getCurrentCompanyId();
            if (!companyId) {
                alert('❌ Error: Templates must be created within a company context. Please ensure you are logged in with proper company access.');
                console.error('❌ Cannot save template: No company context found');
                return;
            }
            
            const sections = [];
            document.querySelectorAll('.section-item').forEach(section => {
                const type = section.querySelector('.section-type').value;
                const title = section.querySelector('.section-title-input').value;
                const content = section.querySelector('.section-content').value;
                
                const sectionData = { type, title, content };
                  // Add extra options based on type
                if (type === 'table') {
                    sectionData.headers = section.querySelector('.table-headers')?.value || '';
                } else if (type === 'placeholder') {
                    sectionData.placeholderType = section.querySelector('.placeholder-type')?.value || 'text';
                    sectionData.defaultValue = section.querySelector('.placeholder-default')?.value || '';
                } else if (type === 'textarea') {
                    sectionData.readonly = section.querySelector('.textarea-readonly')?.checked || false;
                    sectionData.required = section.querySelector('.textarea-required')?.checked || false;
                    sectionData.maxLength = section.querySelector('.textarea-maxlength')?.value || '';
                }
                
                sections.push(sectionData);
            });
              if (sections.length === 0) {
                alert('Please add at least one section to the template');
                return;
            }

            try {
                // Check if we're editing an existing template or creating a new one
                if (currentEditingTemplateId) {
                    // Update existing template
                    const existingTemplateIndex = templates.findIndex(t => t.id === currentEditingTemplateId);
                    if (existingTemplateIndex !== -1) {
                        const existingTemplate = templates[existingTemplateIndex];
                        const updatedTemplate = {
                            ...existingTemplate, // Keep original ID and createdAt
                            name,
                            description,
                            category,
                            logo, // Include logo data
                            sections,
                            companyId, // Ensure company scope
                            lastModified: new Date().toISOString()
                        };
                        
                        templates[existingTemplateIndex] = updatedTemplate;
                        
                        // Save to localStorage FIRST (fast, reliable)
                        saveTemplateToCompanyScope(templates);
                        
                        // Then save to Firebase Realtime Database (PRIORITY - for contractsub.html)
                        await saveTemplateToRealtimeDB(updatedTemplate, companyId);
                        
                        // Finally save to Firebase Firestore (backup/search)
                        await saveTemplateToFirestore(updatedTemplate, companyId);
                        
                        alert('✅ Template updated successfully and saved to company database!');
                        // Don't clear editing state - keep it for further edits
                        updateEditingUI();
                    } else {
                        // Template not found, create new one
                        currentEditingTemplateId = null;
                        await saveAsNewTemplate(name, description, category, logo, sections);
                    }
                } else {
                    // Create new template
                    await saveAsNewTemplate(name, description, category, logo, sections);
                }
                
                loadSavedTemplates();
            } catch (error) {
                console.error('❌ Error saving template:', error);
                alert('❌ Error saving template: ' + error.message + '\nTemplate saved to local storage only.');
            }
        }
          // Helper function to save as new template
        async function saveAsNewTemplate(name, description, category, logo, sections) {
            const companyId = companyDataService?.getCurrentCompanyId();
            
            // Validate company context before creating template
            if (!companyId) {
                console.error('❌ Cannot create template: No company context found');
                alert('❌ Error: Templates must be created within a company context. Please ensure you are logged in with proper company access.');
                throw new Error('Company context required for template creation');
            }
            
            const newTemplate = {
                id: Date.now().toString(),
                name,
                description,
                category,
                logo, // Include logo data
                sections,
                companyId, // Add company scope
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            try {
                templates.push(newTemplate);
                
                // Save to localStorage FIRST (fast, reliable)
                saveTemplateToCompanyScope(templates);
                
                // Then save to Firebase Realtime Database (PRIORITY - for contractsub.html)
                await saveTemplateToRealtimeDB(newTemplate, companyId);
                
                // Finally save to Firebase Firestore (backup/search)
                const savedTemplate = await saveTemplateToFirestore(newTemplate, companyId);
                if (savedTemplate && savedTemplate.id !== newTemplate.id) {
                    // Update local template with Firebase ID
                    const templateIndex = templates.findIndex(t => t.id === newTemplate.id);
                    if (templateIndex !== -1) {
                        templates[templateIndex].id = savedTemplate.id;
                        newTemplate.id = savedTemplate.id;
                        saveTemplateToCompanyScope(templates);
                        
                        // Re-save to Realtime DB with updated ID
                        await saveTemplateToRealtimeDB(newTemplate, companyId);
                    }
                }
                
                alert('✅ Template saved successfully to company database!');
                // Set the editing ID to the new template for further edits
                currentEditingTemplateId = newTemplate.id;
                updateEditingUI();
            } catch (error) {
                console.error('❌ Error in saveAsNewTemplate:', error);
                alert('❌ Error saving template: ' + error.message);
                throw error;
            }
        }

        // Helper function to save templates to company-scoped storage
        function saveTemplateToCompanyScope(templatesArray) {
            const companyId = companyDataService?.getCurrentCompanyId();
            if (companyId) {
                // Save to company-scoped localStorage only
                localStorage.setItem(`documentTemplates_${companyId}`, JSON.stringify(templatesArray));
                console.log(`✅ Templates saved to company scope: ${companyId}`);
            } else {
                // Throw error if no company context - templates must be company-scoped
                console.error('❌ Cannot save templates: No company context found');
                alert('Error: Templates must be saved within a company context. Please ensure you are logged in with proper company access.');
                throw new Error('Company context required for template storage');
            }
        }

        // Helper function to save template to Firebase Firestore with company scope
        async function saveTemplateToFirestore(template, companyId) {
            if (!companyId) {
                console.warn('No company ID provided for Firestore save');
                return template;
            }

            try {
                if (typeof firebase !== 'undefined' && firebase.firestore && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.firestore();
                        const authUser = authManager?.getCurrentUser();
                        
                        if (authUser) {
                            const templateData = {
                                ...template,
                                companyId, // Ensure company scope
                                userId: authUser.uid || authUser.id,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastModified: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            if (template.id && template.id !== Date.now().toString()) {
                                // Update existing template
                                console.log('🔄 Updating template in Firestore:', template.id);
                                await db.collection('documentTemplates').doc(template.id).update({
                                    ...templateData,
                                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                console.log('✅ Template updated in Firestore');
                                return template;
                            } else {
                                // Create new template
                                console.log('💾 Saving new template to Firestore with company scope:', companyId);
                                const docRef = await db.collection('documentTemplates').add(templateData);
                                console.log('✅ New template saved to Firestore with ID:', docRef.id);
                                return { ...template, id: docRef.id };
                            }
                        } else {
                            console.warn('No authenticated user for Firestore save');
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving template to Firestore:', error);
            }
            
            return template;
        }

        // Helper function to save template to Firebase Realtime Database (for contractsub.html compatibility)
        async function saveTemplateToRealtimeDB(template, companyId) {
            if (!companyId) {
                console.error('❌ Cannot save to Realtime Database: No company ID provided - templates must be company-scoped');
                throw new Error('Company ID required for Realtime Database storage');
            }

            try {
                if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.database();
                        
                        const templateData = {
                            ...template,
                            companyId, // Ensure company scope
                            createdAt: template.createdAt || new Date().toISOString(),
                            lastModified: new Date().toISOString()
                        };
                        
                        // Save to companies/{companyId}/documentTemplates/{templateId} - COMPANY SCOPED ONLY
                        const templateRef = db.ref(`companies/${companyId}/documentTemplates/${template.id}`);
                        await templateRef.set(templateData);
                        
                        // Trigger real-time notification for contractsub.html
                        const notificationRef = db.ref(`companies/${companyId}/templateUpdates`);
                        await notificationRef.set({
                            templateId: template.id,
                            action: 'created_or_updated',
                            timestamp: new Date().toISOString(),
                            templateName: template.name
                        });
                        
                        console.log('✅ Template saved to COMPANY-SCOPED Realtime Database:', `companies/${companyId}/documentTemplates/${template.id}`);
                        console.log('✅ Real-time notification sent for contractsub.html');
                        return template;
                    } else {
                        console.warn('⚠️ Firebase not properly initialized - template saved to localStorage only');
                    }
                } else {
                    console.warn('⚠️ Firebase Realtime Database not available - template saved to localStorage only');
                }
            } catch (error) {
                console.error('❌ Error saving template to Realtime Database:', error);
                throw error; // Re-throw to handle in calling function
            }
            
            return template;
        }

        // Export template as JSON
        function exportTemplate() {
            const name = document.getElementById('templateName').value.trim();
            
            if (!name) {
                alert('Please enter a template name before exporting');
                return;
            }
            
            const sections = [];
            document.querySelectorAll('.section-item').forEach(section => {
                const type = section.querySelector('.section-type').value;
                const title = section.querySelector('.section-title-input').value;
                const content = section.querySelector('.section-content').value;
                
                const sectionData = { type, title, content };
                
                if (type === 'table') {
                    sectionData.headers = section.querySelector('.table-headers')?.value || '';
                } else if (type === 'placeholder') {
                    sectionData.placeholderType = section.querySelector('.placeholder-type')?.value || 'text';
                    sectionData.defaultValue = section.querySelector('.placeholder-default')?.value || '';
                }
                
                sections.push(sectionData);
            });
            
            const template = {
                name,
                description: document.getElementById('templateDescription').value.trim(),
                category: document.getElementById('templateCategory').value,
                sections,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_template.json`;
            link.click();
        }        // Clear all template data
        function clearTemplate() {
            if (confirm('Are you sure you want to clear all template data? This action cannot be undone.')) {
                document.getElementById('templateName').value = '';
                document.getElementById('templateDescription').value = '';
                document.getElementById('templateCategory').value = '';
                removeLogo(); // Clear logo
                document.getElementById('sectionsContainer').innerHTML = '';
                sectionCounter = 0;
                updatePreview();
            }
        }

        // Update stats on the page
        function updateStats() {
            const totalTemplates = templates.length;
            const activeTemplates = templates.filter(t => t.status === 'active' || !t.status).length;
            const now = Date.now();
            const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
            const recentTemplates = templates.filter(t => {
                const createdAt = new Date(t.createdAt || 0).getTime();
                return createdAt > oneWeekAgo;
            }).length;
            const draftTemplates = templates.filter(t => t.status === 'draft').length;

            document.getElementById('totalTemplates').textContent = totalTemplates;
            document.getElementById('activeTemplates').textContent = activeTemplates;
            document.getElementById('recentTemplates').textContent = recentTemplates;
            document.getElementById('draftTemplates').textContent = draftTemplates;
        }

        // Load saved templates in the library tab
        function loadSavedTemplates() {
            const container = document.getElementById('savedTemplates');
            
            // Update stats
            updateStats();
            
            if (templates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                        <h3>No Templates Found</h3>
                        <p>Create your first template using the Template Builder</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = templates.map(template => {
                const logoHtml = template.logo ? 
                    `<div style="text-align: center; margin-bottom: 1rem;">
                        <img src="${template.logo}" alt="Template Logo" style="max-height: 40px; max-width: 80px; object-fit: contain; border-radius: 4px;">
                    </div>` : '';
                
                return `
                    <div class="template-card">
                        ${logoHtml}
                        <h4>${template.name}</h4>
                        <p>${template.description || 'No description'}</p>
                        <div style="margin-bottom: 1rem;">
                            <span style="background: #e3f2fd; color: #1976d2; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                ${template.category || 'Uncategorized'}
                            </span>
                            <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                                ${template.sections.length} sections
                            </span>
                        </div>                        <div class="template-card-actions">
                            <button class="btn btn-info" onclick="viewTemplate('${template.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-primary" onclick="loadTemplate('${template.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-secondary" onclick="duplicateTemplate('${template.id}')">
                                <i class="fas fa-copy"></i> Duplicate
                            </button>
                            <button class="btn btn-danger" onclick="deleteTemplate('${template.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }// Load a template for editing
        function loadTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
              // Set the currently editing template ID
            currentEditingTemplateId = templateId;
            
            // Update UI to show we're editing
            updateEditingUI();
            
            // Switch to builder tab
            switchTab('builder');
            
            // Clear existing sections
            document.getElementById('sectionsContainer').innerHTML = '';
            sectionCounter = 0;
            
            // Load template data
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateDescription').value = template.description || '';
            document.getElementById('templateCategory').value = template.category || '';
            
            // Load sections
            template.sections.forEach(section => {
                addSection(section.title, section.content, section.type);
                  // Load extra options
                const sectionElement = document.getElementById(`section_${sectionCounter}`);
                if (section.type === 'table' && section.headers) {
                    const headersInput = sectionElement.querySelector('.table-headers');
                    if (headersInput) headersInput.value = section.headers;
                } else if (section.type === 'placeholder') {
                    const typeSelect = sectionElement.querySelector('.placeholder-type');
                    const defaultInput = sectionElement.querySelector('.placeholder-default');
                    if (typeSelect) typeSelect.value = section.placeholderType || 'text';
                    if (defaultInput) defaultInput.value = section.defaultValue || '';
                } else if (section.type === 'textarea') {
                    const readonlyCheckbox = sectionElement.querySelector('.textarea-readonly');
                    const requiredCheckbox = sectionElement.querySelector('.textarea-required');
                    const maxLengthInput = sectionElement.querySelector('.textarea-maxlength');
                    if (readonlyCheckbox) readonlyCheckbox.checked = section.readonly || false;
                    if (requiredCheckbox) requiredCheckbox.checked = section.required || false;
                    if (maxLengthInput) maxLengthInput.value = section.maxLength || '';
                }
            });
            
            // Set logo if available
            setLogo(template.logo);

            updatePreview();
        }        // Duplicate a template
        async function duplicateTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            const companyId = companyDataService?.getCurrentCompanyId();
            const duplicatedTemplate = {
                ...template,
                id: Date.now().toString(),
                name: template.name + ' (Copy)',
                companyId, // Ensure company scope
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            templates.push(duplicatedTemplate);
            saveTemplateToCompanyScope(templates);
            
            // Save to Firebase Firestore if available
            const savedTemplate = await saveTemplateToFirestore(duplicatedTemplate, companyId);
            if (savedTemplate && savedTemplate.id !== duplicatedTemplate.id) {
                // Update local template with Firebase ID
                const templateIndex = templates.findIndex(t => t.id === duplicatedTemplate.id);
                if (templateIndex !== -1) {
                    templates[templateIndex].id = savedTemplate.id;
                    duplicatedTemplate.id = savedTemplate.id;
                    saveTemplateToCompanyScope(templates);
                }
            }
            
            // Also save to Firebase Realtime Database for contractsub.html compatibility
            await saveTemplateToRealtimeDB(duplicatedTemplate, companyId);
            
            // Ask if user wants to edit the copy immediately
            if (confirm('Template duplicated successfully! Do you want to edit the copy now?')) {
                loadTemplate(duplicatedTemplate.id);
            } else {
                loadSavedTemplates();
            }
        }

        // Delete a template
        async function deleteTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            if (confirm(`Are you sure you want to delete "${template.name}"? This action cannot be undone.`)) {
                // Remove from local array
                templates = templates.filter(t => t.id !== templateId);
                
                // Save updated array to company-scoped storage
                saveTemplateToCompanyScope(templates);
                
                // Delete from Firebase Firestore if available
                await deleteTemplateFromFirestore(templateId);
                
                // Also delete from Firebase Realtime Database for contractsub.html compatibility
                await deleteTemplateFromRealtimeDB(templateId, companyDataService?.getCurrentCompanyId());
                
                // If we were editing this template, clear the editing state
                if (currentEditingTemplateId === templateId) {
                    currentEditingTemplateId = null;
                    updateEditingUI();
                }
                
                loadSavedTemplates();
            }
        }

        // Helper function to delete template from Firebase Firestore
        async function deleteTemplateFromFirestore(templateId) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.firestore();
                        
                        console.log('🗑️ Deleting template from Firestore:', templateId);
                        await db.collection('documentTemplates').doc(templateId).delete();
                        console.log('✅ Template deleted from Firestore');
                    }
                }
            } catch (error) {
                console.error('Error deleting template from Firestore:', error);
            }
        }

        // Helper function to delete template from Firebase Realtime Database
        async function deleteTemplateFromRealtimeDB(templateId, companyId) {
            if (!companyId) {
                console.warn('No company ID provided for Realtime Database delete');
                return;
            }

            try {
                if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.database();
                        
                        console.log('🗑️ Deleting template from Realtime Database:', templateId);
                        await db.ref(`companies/${companyId}/documentTemplates/${templateId}`).remove();
                        
                        // Trigger real-time notification for contractsub.html
                        const notificationRef = db.ref(`companies/${companyId}/templateUpdates`);
                        await notificationRef.set({
                            templateId: templateId,
                            action: 'deleted',
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        console.log('✅ Template deleted from Realtime Database with real-time notification');
                    }
                }
            } catch (error) {
                console.error('Error deleting template from Realtime Database:', error);
            }
        }        // Add initial section on page load
        window.addEventListener('load', function() {
            if (document.querySelectorAll('.section-item').length === 0) {
                addSection('Introduction', 'Welcome to our document template system.');
            }
        });

        // Character counter for textarea sections
        function setupTextareaCounters() {
            document.querySelectorAll('.section-content').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const section = this.closest('.section-item');
                    if (section && section.querySelector('.section-type').value === 'textarea') {
                        const maxLength = section.querySelector('.textarea-maxlength')?.value;
                        if (maxLength) {
                            const currentLength = this.value.length;
                            const counter = section.querySelector('.character-counter');
                            if (counter) {
                                counter.textContent = `${currentLength}/${maxLength}`;
                                counter.style.color = currentLength > maxLength * 0.9 ? '#dc3545' : '#6c757d';
                            }
                        }
                        updatePreview();
                    }
                });
            });
        }

        // Update character counter when textarea settings change
        function updateTextareaCounter(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const textarea = section.querySelector('.section-content');
            const maxLengthInput = section.querySelector('.textarea-maxlength');
            const extraOptions = section.querySelector('#extraOptions_' + sectionId.split('_')[1]);
            
            if (textarea && maxLengthInput && extraOptions) {
                const maxLength = maxLengthInput.value;
                let counterDiv = extraOptions.querySelector('.character-counter-container');
                
                if (maxLength && maxLength > 0) {
                    if (!counterDiv) {
                        counterDiv = document.createElement('div');
                        counterDiv.className = 'character-counter-container';
                        counterDiv.style.cssText = 'margin-top: 0.5rem; text-align: right;';
                        extraOptions.appendChild(counterDiv);
                    }
                    
                    const currentLength = textarea.value.length;
                    counterDiv.innerHTML = `
                        <small class="character-counter" style="color: ${currentLength > maxLength * 0.9 ? '#dc3545' : '#6c757d'};">
                            ${currentLength}/${maxLength} characters
                        </small>
                    `;
                } else if (counterDiv) {
                    counterDiv.remove();
                }
            }
        }

        // Start a new template (clear editing state)
        function newTemplate() {
            if (currentEditingTemplateId && confirm('You are currently editing a template. Do you want to start a new template? Unsaved changes will be lost.')) {
                clearTemplateForm();
            } else if (!currentEditingTemplateId) {
                clearTemplateForm();
            }
        }
          // Clear the template form and reset editing state
        function clearTemplateForm() {
            currentEditingTemplateId = null;
            
            // Clear form fields
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templateCategory').value = '';
            
            // Clear logo
            removeLogo();
            
            // Clear sections
            document.getElementById('sectionsContainer').innerHTML = '';
            sectionCounter = 0;
            
            // Update UI to show we're creating a new template
            updateEditingUI();
            
            // Clear preview
            updatePreview();
            
            console.log('Started new template');
        }
        
        // Migrate existing templates to dual-storage (one-time migration helper)
        async function migrateTemplatesToDualStorage() {
            const companyId = companyDataService?.getCurrentCompanyId();
            if (!companyId) {
                alert('Please ensure you are logged in with a company account before migrating templates.');
                return;
            }

            const confirmMigration = confirm('This will migrate all your existing templates to ensure they appear in contract creation. Continue?');
            if (!confirmMigration) return;

            const templates = JSON.parse(localStorage.getItem(`documentTemplates_${companyId}`) || '[]');
            let migratedCount = 0;

            console.log(`🔄 Starting migration of ${templates.length} templates...`);

            for (const template of templates) {
                try {
                    // Save to both Firestore and Realtime Database
                    await saveTemplateToFirestore(template, companyId);
                    await saveTemplateToRealtimeDB(template, companyId);
                    migratedCount++;
                    console.log(`✅ Migrated template: ${template.name}`);
                } catch (error) {
                    console.error(`❌ Failed to migrate template: ${template.name}`, error);
                }
            }

            alert(`Migration complete! ${migratedCount} templates have been migrated to dual-storage.`);
            loadSavedTemplates();
        }
        
        // Update UI elements based on editing state
        function updateEditingUI() {
            const saveBtn = document.getElementById('saveTemplateBtn');
            const editingIndicator = document.getElementById('editingIndicator');
            
            if (currentEditingTemplateId) {
                // We're editing an existing template
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Template';
                saveBtn.className = 'btn btn-warning';
                editingIndicator.style.display = 'inline';
                console.log('UI updated for editing mode');
            } else {
                // We're creating a new template
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Template';
                saveBtn.className = 'btn btn-success';
                editingIndicator.style.display = 'none';
                console.log('UI updated for new template mode');
            }
        }

        // Initialize template builder on page load
        function initializeTemplateBuilder() {
            // Ensure we start in new template mode
            currentEditingTemplateId = null;
            updateEditingUI();
            
            // Add initial section if none exist
            if (document.querySelectorAll('.section-item').length === 0) {
                addSection('Introduction', 'Welcome to our document template system.');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTemplateBuilder();
        });

        // ===============================
        // LOGO HANDLING FUNCTIONS
        // ===============================

        // Handle logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Logo file size must be less than 2MB');
                return;
            }

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (PNG, JPG, or SVG)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const logoData = e.target.result;
                displayLogoPreview(logoData);
                updatePreview(); // Update the template preview
            };
            reader.readAsDataURL(file);
        }

        // Display logo preview
        function displayLogoPreview(logoData) {
            const logoPreview = document.getElementById('logoPreview');
            const logoImage = document.getElementById('logoImage');
            const logoUploadPrompt = document.getElementById('logoUploadPrompt');
            const removeLogoBtn = document.getElementById('removeLogoBtn');
            const logoUploadArea = document.getElementById('logoUploadArea');

            logoImage.src = logoData;
            logoPreview.style.display = 'block';
            logoUploadPrompt.style.display = 'none';
            removeLogoBtn.style.display = 'inline-block';
            logoUploadArea.style.borderColor = '#28a745';
            logoUploadArea.style.backgroundColor = '#f8fff9';
        }

        // Remove logo
        function removeLogo() {
            const logoPreview = document.getElementById('logoPreview');
            const logoImage = document.getElementById('logoImage');
            const logoUploadPrompt = document.getElementById('logoUploadPrompt');
            const removeLogoBtn = document.getElementById('removeLogoBtn');
            const logoUploadArea = document.getElementById('logoUploadArea');
            const logoInput = document.getElementById('logoInput');

            logoImage.src = '';
            logoPreview.style.display = 'none';
            logoUploadPrompt.style.display = 'block';
            removeLogoBtn.style.display = 'none';
            logoUploadArea.style.borderColor = '#e9ecef';
            logoUploadArea.style.backgroundColor = 'transparent';
            logoInput.value = '';
            
            updatePreview(); // Update the template preview
        }

        // Get current logo data
        function getCurrentLogo() {
            const logoImage = document.getElementById('logoImage');
            return logoImage.src || null;
        }

        // Set logo from data (used when loading templates)
        function setLogo(logoData) {
            if (logoData) {
                displayLogoPreview(logoData);
            } else {
                removeLogo();
            }
        }

        // Drag and drop functionality for logo upload
        document.addEventListener('DOMContentLoaded', function() {
            const logoUploadArea = document.getElementById('logoUploadArea');
            
            if (logoUploadArea) {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    logoUploadArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop area when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    logoUploadArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    logoUploadArea.addEventListener(eventName, unhighlight, false);
                });

                // Handle dropped files
                logoUploadArea.addEventListener('drop', handleDrop, false);
            }
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            const logoUploadArea = document.getElementById('logoUploadArea');
            logoUploadArea.style.borderColor = '#007bff';
            logoUploadArea.style.backgroundColor = '#f8f9ff';
        }

        function unhighlight(e) {
            const logoUploadArea = document.getElementById('logoUploadArea');
            const logoPreview = document.getElementById('logoPreview');
            
            if (logoPreview.style.display === 'none') {
                logoUploadArea.style.borderColor = '#e9ecef';
                logoUploadArea.style.backgroundColor = 'transparent';
            } else {
                logoUploadArea.style.borderColor = '#28a745';
                logoUploadArea.style.backgroundColor = '#f8fff9';
            }
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const logoInput = document.getElementById('logoInput');
                logoInput.files = files;
                handleLogoUpload({ target: { files: files } });
            }
        }

        // ===============================
        // END LOGO HANDLING
        // ===============================
    </script>

    <!-- All Firebase dependencies replaced with local storage -->

    <script>
        // Local Configuration (Firebase URLs removed for self-contained operation)
        const localConfig = {
            appName: 'Document Creator',
            version: '1.0.0',
            offlineMode: true
        };

        // Local app initialization (Firebase dependency removed)
    </script>

    <!-- All external dependencies have been embedded -->
    <script>
        // Company Data Service and Centralized Auth Manager (embedded for self-contained operation)
        const companyDataService = {
            currentCompanyId: localStorage.getItem('currentCompanyId'),
            
            getCurrentCompanyId() {
                return this.currentCompanyId || localStorage.getItem('currentCompanyId');
            },
            
            setCurrentCompanyId(companyId) {
                this.currentCompanyId = companyId;
                localStorage.setItem('currentCompanyId', companyId);
            },
            
            initializeUserContext() {
                const user = localAuth.getCurrentUser();
                if (user && user.companyId) {
                    this.setCurrentCompanyId(user.companyId);
                }
                
                // Initialize default company data if none exists
                this.initializeDefaultCompanyData();
                return Promise.resolve();
            },
            
            initializeDefaultCompanyData() {
                const existingData = localStorage.getItem('companyData');
                if (!existingData) {
                    const defaultCompanyData = {
                        'dreamex-datalab': {
                            id: 'dreamex-datalab',
                            name: 'Dreamex Datalab',
                            companyName: 'Dreamex Datalab', // Add companyName property for compatibility
                            logo: null, // No logo by default
                            logoUrl: null, // Add logoUrl property for compatibility
                            settings: {
                                primaryColor: '#2c3e50',
                                secondaryColor: '#3498db'
                            },
                            branding: {
                                primaryColor: '#2c3e50',
                                secondaryColor: '#3498db'
                            }
                        }
                    };
                    localStorage.setItem('companyData', JSON.stringify(defaultCompanyData));
                }
                
                // Set default company if no current company is selected
                if (!this.getCurrentCompanyId()) {
                    this.setCurrentCompanyId('dreamex-datalab');
                }
            }
        };

        window.companyDataService = companyDataService;

        // Centralized Authentication Manager (embedded from auth.js for self-contained operation)
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = null; // Will use localStorage for self-contained operation
                this.currentCompany = null;
                this.initializeAuth();
            }
            
            getCurrentUser() {
                // First check for 'currentUser' key (used by main login system)
                let user = localStorage.getItem('currentUser');
                if (user) {
                    console.log('✅ Found user in currentUser key');
                    return JSON.parse(user);
                }
                
                // If not found, check for 'user' key (used by index.html modal login)
                user = localStorage.getItem('user');
                if (user) {
                    console.log('✅ Found user in user key - migrating to currentUser');
                    const userData = JSON.parse(user);
                    // Migrate the user data to the standard 'currentUser' key for consistency
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    localStorage.removeItem('user'); // Clean up old key
                    return userData;
                }
                
                // Also check for other possible login keys used by the system
                const possibleKeys = ['authUser', 'loggedInUser', 'sessionUser'];
                for (const key of possibleKeys) {
                    user = localStorage.getItem(key);
                    if (user) {
                        console.log(`✅ Found user in ${key} key - migrating to currentUser`);
                        const userData = JSON.parse(user);
                        localStorage.setItem('currentUser', JSON.stringify(userData));
                        return userData;
                    }
                }
                
                console.log('❌ No user found in any localStorage key');
                return null;
            }
            
            setCurrentUser(user) {
                this.currentUser = user;
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    localStorage.removeItem('currentUser');
                }
            }
            
            initializeAuth() {
                // For dochtml.html, we'll initialize only if we have a real user
                if (this.currentUser) {
                    console.log('Initializing with logged-in user:', this.currentUser.displayName || this.currentUser.email);
                    this.loadUserCompany();
                    this.updateUIForAuthenticatedUser();
                } else {
                    console.warn('No user found - user must log in from index.html');
                    // Redirect to login if no user is found
                    window.location.href = 'index.html';
                }
            }
            
            async loadUserCompany() {
                if (!this.currentUser) return;
                
                try {
                    // Get user's company information from company data service
                    if (window.companyDataService) {
                        await window.companyDataService.initializeUserContext();
                        const companyId = window.companyDataService.getCurrentCompanyId();
                        
                        if (companyId) {
                            console.log('🏢 Loading company data from Firebase for ID:', companyId);
                            
                            // Try to load company data from Firebase Database first (like roles.html)
                            if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                                try {
                                    const firebaseInstance = initializeFirebase();
                                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                                        const db = firebaseInstance.database();
                                        const companyRef = db.ref(`companies/${companyId}`);
                                        
                                        console.log('🔍 Fetching company data from Firebase Database...');
                                        const companySnapshot = await companyRef.once('value');
                                        
                                        if (companySnapshot.exists()) {
                                            this.currentCompany = companySnapshot.val();
                                            console.log('✅ Company data loaded from Firebase:', this.currentCompany);
                                            
                                            // Check for company logo in Firebase Storage if no direct URL
                                            if (!this.currentCompany.logo && !this.currentCompany.logoUrl) {
                                                console.log('🔍 No direct logo URL, checking Firebase Storage...');
                                                await this.loadCompanyLogoFromStorage(companyId);
                                            }
                                            
                                            this.updateCompanyBranding();
                                            return;
                                        } else {
                                            console.log('ℹ️ No company data found in Firebase Database');
                                        }
                                    }
                                } catch (firebaseError) {
                                    console.log('Firebase Database not available:', firebaseError);
                                }
                            }
                            
                            // Fallback to localStorage company data
                            console.log('🔄 Falling back to localStorage company data...');
                            const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
                            this.currentCompany = companyData[companyId];
                            this.updateCompanyBranding();
                        } else {
                            console.warn('No company context found for user');
                        }
                    } else {
                        console.warn('Company data service not available');
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }
            
            // Load company logo from Firebase Storage (SVG support)
            async loadCompanyLogoFromStorage(companyId) {
                if (!companyId) return null;
                
                try {
                    if (typeof firebase !== 'undefined' && firebase.storage && typeof initializeFirebase === 'function') {
                        const firebaseInstance = initializeFirebase();
                        if (firebaseInstance && firebaseInstance.apps.length > 0) {
                            const storage = firebaseInstance.storage();
                            
                            // Try different possible logo file formats (prioritize SVG)
                            const logoFormats = ['logo.svg', 'logo.png', 'logo.jpg', 'logo.jpeg'];
                            
                            for (const format of logoFormats) {
                                try {
                                    const logoPath = `companies/${companyId}/${format}`;
                                    console.log(`🔍 Checking Firebase Storage for: ${logoPath}`);
                                    
                                    const logoRef = storage.ref(logoPath);
                                    const logoUrl = await logoRef.getDownloadURL();
                                    
                                    console.log(`✅ Company logo found in Firebase Storage (${format}):`, logoUrl);
                                    
                                    // Update the current company data with the logo URL
                                    if (this.currentCompany) {
                                        this.currentCompany.logoUrl = logoUrl;
                                        this.currentCompany.logo = logoUrl;
                                    }
                                    
                                    return logoUrl;
                                } catch (formatError) {
                                    console.log(`❌ ${format} not found in Firebase Storage`);
                                    continue;
                                }
                            }
                            
                            console.log('ℹ️ No company logo found in Firebase Storage');
                        }
                    }
                } catch (error) {
                    console.log('Error loading company logo from Firebase Storage:', error);
                }
                
                return null;
            }
            
            async updateUIForAuthenticatedUser() {
                const profileBtn = document.querySelector('.profile-btn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();
                        
                        // Update profile image using centralized method
                        await this.updateUserAvatarDisplay('userAvatar');
                        
                        // Update profile dropdown with user info
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                        ${initials}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#" onclick="authManager.logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        `;
                        
                        profileDropdown.innerHTML = userInfoHtml;
                    }
                }
                
                // Update company branding
                this.updateCompanyBranding();
            }
            
            getUserInitials() {
                if (!this.currentUser) return 'U';
                
                const displayName = this.getUserDisplayName();
                return displayName.split(' ').map(name => name.charAt(0).toUpperCase()).join('').slice(0, 2);
            }
            
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                return this.currentUser.displayName || this.currentUser.email?.split('@')[0] || 'User';
            }
            
            getUserEmail() {
                if (!this.currentUser) return '';
                return this.currentUser.email || '';
            }
            
            // Centralized method to get user avatar URL (matches auth.js)
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    // First check localStorage cache
                    const cachedUrl = localStorage.getItem(`profilePicture_${this.currentUser.uid}`);
                    if (cachedUrl && cachedUrl !== 'null' && cachedUrl !== '') {
                        return cachedUrl;
                    }
                    
                    // Check user profile for photoURL
                    if (this.currentUser.photoURL && this.currentUser.photoURL !== 'null') {
                        return this.currentUser.photoURL;
                    }
                    
                    // Try Firebase Storage if available
                    if (typeof firebase !== 'undefined' && typeof initializeFirebase === 'function') {
                        try {
                            const firebaseInstance = initializeFirebase();
                            if (firebaseInstance && firebaseInstance.storage && firebaseInstance.apps.length > 0) {
                                const storage = firebaseInstance.storage();
                                const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                                const avatarRef = storage.ref(avatarPath);
                                
                                return await avatarRef.getDownloadURL();
                            }
                        } catch (firebaseError) {
                            console.log('Firebase Storage not available:', firebaseError);
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.log('No custom avatar found:', error);
                    return null;
                }
            }
            
            // Centralized method to update user avatar display (matches auth.js exactly)
            async updateUserAvatarDisplay(elementId = 'userAvatar') {
                const avatarElement = document.getElementById(elementId);
                if (!avatarElement) {
                    console.warn(`Avatar element with id '${elementId}' not found`);
                    return;
                }

                try {
                    const avatarUrl = await this.getUserAvatarUrl();
                    if (avatarUrl) {
                        // Show custom avatar - replace entire element content like roles.html
                        if (avatarElement.tagName === 'IMG') {
                            avatarElement.src = avatarUrl;
                            avatarElement.alt = 'Profile Picture';
                            avatarElement.onerror = () => {
                                // Fallback to initials if image fails to load
                                const initials = this.getUserInitials();
                                const initialsDataUri = this.generateInitialsDataUri(initials);
                                avatarElement.src = initialsDataUri;
                                avatarElement.alt = `${initials} Avatar`;
                                console.log('Image failed to load, using initials fallback');
                            };
                        } else {
                            avatarElement.innerHTML = `<img src="${avatarUrl}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${this.getUserInitials()}';">`;
                        }
                        console.log('✅ Displaying custom avatar from:', avatarUrl);
                    } else {
                        // Show initials - replace with text or data URI
                        this.displayInitials(avatarElement);
                        console.log('✅ Displaying initials:', this.getUserInitials());
                    }
                } catch (error) {
                    // Fallback to initials on any error
                    this.displayInitials(avatarElement);
                    console.log('Fallback to initials due to error:', error);
                }
            }

            // Helper method to display initials
            displayInitials(avatarElement) {
                const initials = this.getUserInitials();
                if (avatarElement.tagName === 'IMG') {
                    const initialsDataUri = this.generateInitialsDataUri(initials);
                    avatarElement.src = initialsDataUri;
                    avatarElement.alt = `${initials} Avatar`;
                } else {
                    avatarElement.textContent = initials;
                }
            }
            
            // Generate a data URI with user initials (for img elements)
            generateInitialsDataUri(initials) {
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="#3498db"/>
                        <text x="20" y="26" font-family="Arial, sans-serif" font-size="14" font-weight="600" text-anchor="middle" fill="white">${initials}</text>
                    </svg>
                `;
                return `data:image/svg+xml;base64,${btoa(svg)}`;
            }

            // Generate initials avatar (dashboard.html compatibility method)
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }
            
            updateCompanyBranding() {
                console.log('🏢 updateCompanyBranding() called');
                
                // First try to use Firebase-loaded company data
                if (this.currentCompany) {
                    console.log('✅ Using Firebase-loaded company data:', this.currentCompany);
                    this.displayCompanyBranding(this.currentCompany);
                    return;
                }
                
                // Fallback to localStorage-based approach
                const companyId = companyDataService.getCurrentCompanyId();
                console.log('Updating company branding for:', companyId);
                
                const logoElement = document.getElementById('headerCompanyLogo');
                const placeholderElement = document.getElementById('headerLogoPlaceholder');
                const companyNameElement = document.getElementById('headerCompanyName');
                
                if (!companyId) {
                    // Set default company name if no company is selected
                    if (companyNameElement) {
                        companyNameElement.textContent = 'Document Creator';
                    }
                    // Show placeholder
                    if (placeholderElement) {
                        placeholderElement.style.display = 'flex';
                    }
                    if (logoElement) {
                        logoElement.classList.remove('visible');
                        logoElement.style.display = 'none';
                    }
                    return;
                }
                
                const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
                const company = companyData[companyId];
                console.log('Company data:', company);
                
                if (company) {
                    this.displayCompanyBranding(company);
                } else {
                    // Fallback to default if company data not found
                    if (companyNameElement) {
                        companyNameElement.textContent = 'Document Creator';
                    }
                    // Show placeholder
                    if (placeholderElement) {
                        placeholderElement.style.display = 'flex';
                    }
                    if (logoElement) {
                        logoElement.classList.remove('visible');
                        logoElement.style.display = 'none';
                    }
                }
            }
            
            // Display company branding (works with both Firebase and localStorage data)
            displayCompanyBranding(company) {
                const logoElement = document.getElementById('headerCompanyLogo');
                const placeholderElement = document.getElementById('headerLogoPlaceholder');
                const companyNameElement = document.getElementById('headerCompanyName');
                
                console.log('🎨 Displaying company branding:', company);
                
                // Check for logo URL (try both 'logo' and 'logoUrl' properties like staff.html)
                const logoUrl = company.logo || company.logoUrl;
                console.log('🖼️ Company logo check:', {
                    logo: company.logo || 'Not found',
                    logoUrl: company.logoUrl || 'Not found',
                    finalUrl: logoUrl || 'None available'
                });
                
                if (logoUrl && logoUrl.trim() !== '' && logoElement) {
                    console.log('✅ Displaying company logo:', logoUrl);
                    logoElement.src = logoUrl;
                    logoElement.classList.add('visible');
                    logoElement.style.display = 'block';
                    if (placeholderElement) placeholderElement.style.display = 'none';
                } else {
                    console.log('ℹ️ No company logo URL available, showing placeholder');
                    // Show placeholder when no logo
                    if (placeholderElement) {
                        placeholderElement.style.display = 'flex';
                    }
                    if (logoElement) {
                        logoElement.classList.remove('visible');
                        logoElement.style.display = 'none';
                    }
                }
                
                // Update company name (try multiple possible property names)
                const companyName = company.name || company.companyName || 'Document Creator';
                if (companyNameElement) {
                    companyNameElement.textContent = companyName;
                }
                
                console.log('✅ Company branding updated');
            }
            
            logout() {
                this.setCurrentUser(null);
                window.location.href = 'login.html';
            }
        }

        // Create global authManager instance (matches other pages)
        const authManager = new AuthManager();
        window.authManager = authManager;

        // Debug function to test profile picture display (centralized approach)
        function testProfilePicture() {
            const user = authManager.getCurrentUser();
            if (user) {
                console.log('Testing profile picture for user:', user);
                console.log('Current user photoURL:', user.photoURL);
                console.log('Cached photoURL:', localStorage.getItem(`profilePicture_${user.uid}`));
                authManager.updateUserAvatarDisplay('userAvatar');
            } else {
                console.log('No user found for testing');
            }
        }

        // Make test function available globally for debugging
        window.testProfilePicture = testProfilePicture;
        
        // Debug function to test company logo display
        function testCompanyLogo() {
            console.log('🧪 Testing company logo functionality...');
            
            const companyId = companyDataService.getCurrentCompanyId();
            const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
            const currentCompany = companyData[companyId];
            
            console.log('Debug info:', {
                currentCompanyId: companyId,
                companyData: companyData,
                currentCompany: currentCompany,
                firebaseCompany: authManager.currentCompany,
                hasLocalStorageLogo: !!(currentCompany && (currentCompany.logo || currentCompany.logoUrl)),
                hasFirebaseLogo: !!(authManager.currentCompany && (authManager.currentCompany.logo || authManager.currentCompany.logoUrl)),
                logoElement: document.getElementById('headerCompanyLogo'),
                placeholderElement: document.getElementById('headerLogoPlaceholder')
            });
            
            // Test Firebase loading
            if (typeof firebase !== 'undefined' && firebase.database) {
                console.log('🔥 Firebase is available - testing company data loading...');
                authManager.loadUserCompany().then(() => {
                    console.log('✅ Firebase company loading completed');
                    authManager.updateCompanyBranding();
                });
            } else {
                console.log('ℹ️ Firebase not available - using localStorage fallback');
                // Force update with localStorage data
                authManager.updateCompanyBranding();
            }
        }
        
        // Make company logo test function available globally
        window.testCompanyLogo = testCompanyLogo;
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  // All CSS has been embedded - no external stylesheets needed
  console.log('Document Creator initialized with embedded dependencies');
  
  // Check if user is logged in from index.html
  const currentUser = authManager.getCurrentUser();
  if (currentUser) {
    console.log('✅ User found:', currentUser.displayName || currentUser.email);
    console.log('User initials:', authManager.getUserInitials());
  } else {
    console.warn('❌ No user found - user must log in from index.html');
    // Redirect to login if no user is found
    alert('Please log in from the main page first.');
    window.location.href = 'index.html';
    return;
  }
  
  // Initialize company data service first
  companyDataService.initializeUserContext().then(() => {
    console.log('Company data initialized');
    console.log('Current company ID:', companyDataService.getCurrentCompanyId());
    
    // Initialize authentication manager (centralized)
    authManager.initializeAuth();
    console.log('Centralized auth manager initialized');
    
    // Load user profile using dashboard.html method
    loadUserProfile().then(() => {
      console.log('User profile loaded via dashboard.html method');
      
      // Force update company branding after everything is loaded
      setTimeout(() => {
        console.log('🔄 Force updating company branding...');
        authManager.updateCompanyBranding();
      }, 100);
    }).catch(error => {
      console.error('Error loading user profile:', error);
    });
  });
  
  // Initialize page functionality
  setupSidebarToggle();
  initializeAuth();
  
  // Initialize stats display
  updateStats();
});
</script>
</body>
</html>

