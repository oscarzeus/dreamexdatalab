<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Template Creator - Dreamex Datalab HSE</title>
    
    <!-- Font Awesome Icons - CDN for proper icon display -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Firebase v8 CDN for compatibility with Storage -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Firebase Configuration and Initialization -->
    <script>
        // Firebase v8 configuration - matches roles.html for compatibility
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully');
            }
            return window.firebase;
        }
        // Ensure the signature labels UI matches selected count (2 or 3)
        // Also expose a per-signature stamp toggle and uploader
        function updateSignatureOptionsUI(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const extraOptions = document.getElementById(`extraOptions_${sectionId}`);
            const countEl = extraOptions?.querySelector('.signature-count');
            const labelsHost = document.getElementById(`signatureLabels_${sectionId}`);
            if (!countEl || !labelsHost) return;
            const count = Math.max(2, Math.min(3, parseInt(countEl.value || '2', 10)));
            const existingValues = Array.from(labelsHost.querySelectorAll('input.signature-label')).map(i => i.value);
            const existingEnabled = Array.from(labelsHost.querySelectorAll('input.sig-stamp-enabled')).map(i => i.checked);
            const existingStampData = Array.from(labelsHost.querySelectorAll('input.sig-stamp-file')).map(i => i.dataset.stampDataUrl || '');
                labelsHost.innerHTML = ''; 
                const inlineStampEnabled = Array.from(labelsHost.querySelectorAll('input.sig-stamp-enabled')).map(i => i.checked);
                const inlineStampData = Array.from(labelsHost.querySelectorAll('input.sig-stamp-file')).map(i => i.dataset.stampDataUrl || '');
            const gridCols = count === 2 ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)';
            labelsHost.style.display = 'grid';
            labelsHost.style.gridTemplateColumns = gridCols;
            labelsHost.style.gap = '0.5rem';
            for (let i = 0; i < count; i++) {
                const value = existingValues[i] || (i === 0 ? 'Employee' : i === 1 ? 'Manager' : 'Witness');
                const wrapper = document.createElement('div');
                const enabled = !!existingEnabled[i];
                const dataUrl = existingStampData[i] || '';
                wrapper.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:.35rem;">
                        <input type="text" class="form-control signature-label" placeholder="Label ${i+1}" value="${value}" onkeyup="updatePreview()">
                        <label style="font-size:.85rem; color:#334155; display:flex; align-items:center; gap:.5rem;">
                            <input type="checkbox" class="sig-stamp-enabled" onchange="toggleInlineStamp(this); updatePreview()" ${enabled ? 'checked' : ''}>
                            Add stamp under this signature
                        </label>
                        <div class="sig-stamp-uploader" style="${enabled ? '' : 'display:none;'}">
                            <input type="file" accept="image/*" class="form-control sig-stamp-file" onchange="handleInlineSigStampUpload(this); updatePreview()" ${dataUrl ? `data-stamp-data-url='${dataUrl.replace(/'/g, "&#39;")}'` : ''}>
                            <div class="sig-stamp-preview" style="${dataUrl ? '' : 'display:none;'} margin-top:.25rem;">
                                <img src="${dataUrl}" alt="Stamp Preview" style="max-width:120px; height:auto; opacity:.92; border:1px dashed #cbd5e1; padding:2px; background:#fff;">
                            </div>
                        </div>
                    </div>`;
                labelsHost.appendChild(wrapper);
            }
        }

        // Toggle inline stamp uploader visibility for a given signature row
        function toggleInlineStamp(checkboxEl) {
            const host = checkboxEl.closest('div');
            if (!host) return;
            const uploader = host.parentElement?.querySelector('.sig-stamp-uploader');
            if (uploader) uploader.style.display = checkboxEl.checked ? '' : 'none';
        }

        // Handle inline stamp image upload for a specific signature slot
        function handleInlineSigStampUpload(inputEl) {
            if (!inputEl || !inputEl.files || !inputEl.files[0]) return;
            const file = inputEl.files[0];
            const reader = new FileReader();
            const preview = inputEl.parentElement?.querySelector('.sig-stamp-preview');
            const img = preview?.querySelector('img');
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                inputEl.dataset.stampDataUrl = dataUrl;
                if (img) img.src = dataUrl;
                if (preview) preview.style.display = '';
            };
            reader.readAsDataURL(file);
        }

        // Handle stamp image upload for a section
        function handleStampUpload(inputEl) {
            if (!inputEl || !inputEl.files || !inputEl.files[0]) return;
            const file = inputEl.files[0];
            const reader = new FileReader();
            const sectionEl = inputEl.closest('.section-item');
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                // set preview
                const preview = sectionEl.querySelector('.stamp-preview');
                const img = preview?.querySelector('img');
                if (img) {
                    img.src = dataUrl;
                    preview.style.display = 'block';
                }
                // store on element dataset for save
                sectionEl.dataset.stampImage = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        // Populate signature section dropdown for stamp positioning
        function populateSignatureLinksForStamp(stampSectionId) {
            const stampSection = document.getElementById(stampSectionId);
            if (!stampSection) return;
            const select = stampSection.querySelector('.stamp-signature-link');
            if (!select) return;
            
            // Find all signature sections
            const allSections = document.querySelectorAll('.section-item');
            const signatures = [];
            allSections.forEach(sec => {
                const typeSelect = sec.querySelector('.section-type');
                if (typeSelect && typeSelect.value === 'signature') {
                    const titleInput = sec.querySelector('.section-title-input');
                    const title = titleInput ? titleInput.value.trim() : '';
                    const label = title || `Signature Section (${sec.id})`;
                    signatures.push({ id: sec.id, label });
                }
            });
            
            // Clear and rebuild options
            const currentValue = select.value;
            select.innerHTML = '<option value="">None (standalone)</option>';
            signatures.forEach(sig => {
                const opt = document.createElement('option');
                opt.value = sig.id;
                opt.textContent = sig.label;
                select.appendChild(opt);
            });
            
            // Restore previous selection if still valid
            if (currentValue && signatures.some(s => s.id === currentValue)) {
                select.value = currentValue;
            }
        }

        // Initialize Firebase immediately
        try {
            if (typeof firebase !== 'undefined') {
                initializeFirebase();
            }
        } catch (error) {
            console.warn('Firebase initialization failed, will use localStorage fallback:', error);
        }
        
        // Firebase v8 compatibility functions for Database operations
        function ref(database, path) {
            return database.ref(path);
        }
        
        function get(reference) {
            return reference.once('value');
        }
        
        function set(reference, value) {
            return reference.set(value);
        }
    </script>
    
    <style>
        /* Font Awesome 6.4.0 - Enhanced Definitions */
        .fa, .fas, .fa-solid, .far, .fa-regular, .fab, .fa-brands {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands";
            font-style: normal;
            line-height: 1;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .fas, .fa-solid {
            font-weight: 900;
        }

        .far, .fa-regular {
            font-weight: 400;
        }

        .fab, .fa-brands {
            font-family: "Font Awesome 6 Brands";
            font-weight: 400;
        }

        .fa, .fab, .fad, .fal, .far, .fas, .fat {
            -moz-osx-font-smoothing: grayscale;
            -webkit-font-smoothing: antialiased;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }

        /* Ensure icons are properly sized and aligned */
        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 1.2rem;
            text-align: center;
            font-size: 1rem;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .page-title i {
            margin-right: 0.75rem;
            color: var(--secondary-color);
        }

        .tab i {
            margin-right: 0.5rem;
        }

        /* Enhanced Avatar Styles for Profile Pictures */
        .avatar-initials {
            overflow: hidden !important;
            border: 2px solid #e9ecef !important;
            position: relative !important;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-initials:hover .avatar-upload-overlay {
            display: flex;
        }

        .profile-upload-input {
            display: none;
        }
    </style>
    
    <!-- Embedded Essential CSS from styles.css -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        /* Sidebar Styles */
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform var(--transition-speed);
        }

        .sidebar .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .sidebar .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .sidebar .menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar .menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 1.2rem;
            text-align: center;
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        .menu-dropdown .submenu li a {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Sidebar Toggle */
        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .sidebar.collapsed {
            transform: translateX(-250px);
        }

        .main-content {
            transition: margin-left 0.3s ease;
        }

        /* Match project-list.html behavior */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        /* Feature/permission-based menu visibility (opt-in gating) */
        /* By default, show all menu items; when authorization completes, JS adds .menu-gated to the sidebar
           and only then we hide items that are not marked .menu-visible. This prevents an empty sidebar if
           auth fails or runs slowly. */
        .sidebar.menu-gated [data-feature]:not(.menu-visible) { display: none !important; }
        .sidebar.menu-gated .menu-dropdown:not(.menu-visible) { display: none !important; }
        /* Ensure menu-visible items are always shown when gating is active */
        .sidebar.menu-gated .menu-visible { display: block !important; }
        .sidebar.menu-gated li.menu-visible,
        .sidebar.menu-gated [data-feature].menu-visible { display: block !important; }

        /* Company Header */
        .header-company-logo {
            width: 32px;
            height: 32px;
            border-radius: 0;
            object-fit: contain;
            background: transparent;
            border: none;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 0;
            background: transparent;
            border: none;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        /* Notifications */
        .notifications {
            position: relative;
            margin-right: 1rem;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .notification-btn i {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* User Profile */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
    
    <style>
        /* Global Reset for Full Width Layout */
        * {
            box-sizing: border-box;
        }
          html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            font-size: 14px;
        }
        
        /* Document Template Creator specific styles */
        .container {
            width: 100%;
            max-width: none;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }/* Main Layout Structure */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .main-content {
            flex: 1;
            margin-left: 0;
            background: #f8f9fa;
            min-height: 100vh;
            width: 100vw;
        }

        .content {
            padding: 0 1rem 2rem 1rem;
            width: 100%;
        }        /* Tab Content Full Width */
        .tab-content {
            width: 100%;
            max-width: none;
            display: none;
        }
        
        .tab-content.active {
            display: block;
            width: 100%;
        }

        /* Template Builder Layout - Full Width */
        .template-content {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: none;
        }

        .template-builder {
            flex: 1;
            padding: 2rem;
            border-right: 1px solid #e9ecef;
            background: #fafbfc;
            min-width: 0; /* Allows flex item to shrink below content size */
        }

        .template-preview {
            flex: 1;
            padding: 2rem;
            background: white;
            min-width: 0; /* Allows flex item to shrink below content size */
        }

        .section {
            margin-bottom: 2rem;
        }        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }        .form-label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }.form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        .section-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .section-item:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .preview-area {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem; /* outer padding around the page */
            background: #ffffff; /* white background as requested */
            min-height: 400px;
            font-family: 'Times New Roman', serif;
            overflow: auto;
        }

        /* A4 page wrapper for preview */
        .a4-page {
            width: 210mm;           /* A4 width */
            min-height: 297mm;      /* A4 height */
            background: #ffffff;    /* ensure page is white */
            margin: 0 auto;         /* center horizontally */
            padding: 15mm;          /* typical document margins */
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            box-sizing: border-box;
        }

        .template-actions {
            padding: 2rem;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-templates {
            display: block; /* switched from grid to block for table layout */
            width: 100%;
            margin-top: 1rem;
        }

        .template-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .template-card h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }        .template-card p {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .template-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 2rem;
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .tab:hover {
            color: var(--primary-color);
            background: #f8f9fa;
        }

        .tab.active {
            color: #ffffff;
            background: var(--primary-color);
        }

        /* User Profile Avatar and Dropdown Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li {
            padding: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }

        .profile-dropdown li:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        /* Notification styles */
        .notifications {
            position: relative;
            margin-right: 1rem;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .notification-btn i {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #2c3e50;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Page Header Styles */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.25rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 2rem;
            margin: 0 2rem 2rem 2rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        /* Professional stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 0 2rem 1.5rem 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .stat-card .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            line-height: 1;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .stat-card div:last-child {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            line-height: 1.2;
        }

        /* Top Navigation Styles */
        .top-nav {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }        /* Template Library Styles */
        .template-library-container {
            padding: 0; /* remove internal padding */
            max-width: 100%;
            width: 100%;
        }

        .template-library-container .page-header {
            margin-bottom: 2rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        /* Textarea section styles */
        .textarea-options {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .textarea-preview {
            position: relative;
        }
        
        .textarea-preview textarea {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .textarea-preview textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: 0;
        }
        
        .textarea-preview .textarea-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .textarea-required-indicator {
            color: #dc3545;
            font-weight: 500;
        }
        
        .textarea-readonly-indicator {
            color: #28a745;
            font-weight: 500;
        }
        
        .textarea-maxlength-indicator {
            color: #6c757d;
        }

        /* Upload Progress Styles */
        .upload-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
        }
        
        .upload-progress .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .template-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 1rem;
                max-height: 70vh;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
            background: white;
        }

        .modal-footer {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Template view content styles */
        .template-view-content {
            font-family: inherit;
            line-height: 1.6;
        }

        .template-view-content h1,
        .template-view-content h2,
        .template-view-content h3 {
            color: #2c3e50;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .template-view-content h1 {
            font-size: 2rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .template-view-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .template-view-content table th,
        .template-view-content table td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        .template-view-content table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .template-view-content .placeholder {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }

        .template-view-content textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .template-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 1rem;
                max-height: 70vh;
            }
        }
    </style>

    <!-- Local JavaScript Libraries -->
    <script>
        // Simple Auth State Management (replaces Firebase)
        const localAuth = {
            currentUser: null,
            
            getCurrentUser() {
                const userData = localStorage.getItem('currentUser');
                return userData ? JSON.parse(userData) : null;
            },
            
            setCurrentUser(user) {
                this.currentUser = user;
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    localStorage.removeItem('currentUser');
                }
            },
            
            isLoggedIn() {
                return this.getCurrentUser() !== null;
            }
        };

        // Simple Database Simulation (replaces Firebase Database)
        const localDB = {
            data: JSON.parse(localStorage.getItem('localDB') || '{}'),
            
            save() {
                localStorage.setItem('localDB', JSON.stringify(this.data));
            },
            
            ref(path) {
                return {
                    set: (value) => {
                        this.setPath(path, value);
                        this.save();
                        return Promise.resolve();
                    },
                    
                    get: () => {
                        const value = this.getPath(path);
                        return Promise.resolve({ exists: () => value !== undefined, val: () => value });
                    },
                    
                    on: (event, callback) => {
                        // Simulate real-time updates
                        callback({ val: () => this.getPath(path) });
                    }
                };
            },
            
            getPath(path) {
                const keys = path.split('/').filter(k => k);
                let current = this.data;
                for (const key of keys) {
                    if (current[key] === undefined) return undefined;
                    current = current[key];
                }
                return current;
            },
            
            setPath(path, value) {
                const keys = path.split('/').filter(k => k);
                let current = this.data;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) current[keys[i]] = {};
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;
            }
        };

        // Firebase compatibility layer with Storage support
        const firebase = {
            auth: () => ({
                currentUser: localAuth.getCurrentUser(),
                onAuthStateChanged: (callback) => {
                    // Simulate auth state change
                    setTimeout(() => callback(localAuth.getCurrentUser()), 100);
                }
            }),
            database: () => ({
                ref: (path) => localDB.ref(path)
            }),
            storage: () => ({
                ref: (path) => ({
                    put: (file) => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                // Store as base64 in localStorage for offline mode
                                const imageData = e.target.result;
                                localStorage.setItem(`storage_${path}`, imageData);
                                
                                // Simulate upload progress
                                const uploadTask = {
                                    snapshot: {
                                        ref: {
                                            getDownloadURL: () => Promise.resolve(imageData)
                                        }
                                    }
                                };
                                resolve(uploadTask);
                            };
                            reader.readAsDataURL(file);
                        });
                    },
                    getDownloadURL: () => {
                        const imageData = localStorage.getItem(`storage_${path}`);
                        return Promise.resolve(imageData || null);
                    }
                })
            }),
            firestore: () => ({
                collection: (name) => ({
                    doc: (id) => ({
                        set: (data) => {
                            localDB.ref(`${name}/${id}`).set(data);
                            return Promise.resolve();
                        }
                    })
                })
            })
        };

        // Initialize Firebase if available
        if (typeof window.firebase !== 'undefined') {
            // Use real Firebase
            console.log('Using real Firebase');
        } else {
            // Use local fallback
            window.firebase = firebase;
            console.log('Using Firebase fallback with local storage');
        }
    </script>
    <!-- GitHub Pages Fix Script -->
    <!-- Embedded GitHub Pages Fix and Common Components -->
</head>
<body>
    <!-- Upload Progress Indicator -->
    <div id="uploadProgress" class="upload-progress">
        <div class="spinner"></div>
        <span id="uploadMessage">Uploading...</span>
    </div>
    
    <div class="app-container">
        <!-- Sidebar removed intentionally for full-width layout -->

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <!-- Sidebar toggle removed -->
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="header-top-row">
                        <div>
                            <h1 class="page-title">
                                <i class="fas fa-file-alt"></i>
                                Document Template Creator
                            </h1>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTemplates">0</div>
                        <div>Total Templates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeTemplates">0</div>
                        <div>Active Templates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recentTemplates">0</div>
                        <div>Recent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="draftTemplates">0</div>
                        <div>Drafts</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('builder')">
                        <i class="fas fa-hammer"></i> Template Builder
                    </button>
                    <button class="tab" onclick="switchTab('preview')">
                        <i class="fas fa-eye"></i> Template Preview
                    </button>
                    <button class="tab" onclick="switchTab('library')">
                        <i class="fas fa-folder"></i> Template Library
                    </button>
                </div>                <!-- Template Builder Tab -->
                <div id="builderTab" class="tab-content active">
                    <div class="template-content">
                        <!-- Template Builder -->
                        <div class="template-builder">                            <div class="section">
                                <div class="section-title">
                                    <i class="fas fa-info-circle"></i>
                                    Basic Information
                                </div>
                                <div class="basic-info-grid" style="display:flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
                                    <div class="basic-info-left" style="flex: 1 1 520px; min-width: 320px;">
                                        <div class="form-row" style="display:flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                                            <div class="form-group" style="flex: 1 1 280px; min-width: 240px;">
                                                <label class="form-label">Template Name</label>
                                                <input type="text" id="templateName" class="form-control" placeholder="Enter template name">
                                            </div>
                                            <div class="form-group" style="flex: 0 0 260px; min-width: 220px;">
                                                <label class="form-label">Category</label>
                                                <select id="templateCategory" class="form-control">
                                                    <option value="">Select category</option>
                                                    <option value="contract">Contract Templates</option>
                                                    <option value="letter">Letter Templates</option>
                                                    <option value="report">Report Templates</option>
                                                    <option value="form">Form Templates</option>
                                                    <option value="invoice">Invoice Templates</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            <div class="form-group" style="flex: 1 1 280px; min-width: 240px;">
                                                <label class="form-label">Company Name</label>
                                                <input type="text" id="templateCompanyName" class="form-control" placeholder="Enter company name (auto-fills)">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Title</label>
                                            <input type="text" id="templateTitle" class="form-control" placeholder="Enter document title (optional)">
                                        </div>
                                        
                                    </div>
                                    <div class="basic-info-right" style="flex: 0 0 320px; min-width: 260px; align-self: flex-start;">
                                        <div class="form-group">
                                            <label class="form-label" style="margin-bottom: 0.25rem; font-size: 0.9rem;">
                                                <i class="fas fa-image"></i>
                                                Template Logo
                                            </label>
                                            <div style="display:flex; align-items: center; gap: 0.5rem;">
                                                <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 0.5rem; text-align: center; transition: all 0.3s ease; width: 100%; min-width: 220px; max-height: 130px; overflow: hidden;" id="logoUploadArea">
                                                    <div id="logoPreview" style="display: none; margin-bottom: 0.4rem;">
                                                        <img id="logoImage" src="" alt="Logo Preview" style="max-height: 60px; max-width: 180px; object-fit: contain; border-radius: 4px;">
                                                    </div>
                                                    <div id="logoUploadPrompt" style="margin: 0;">
                                                        <div style="color:#6c757d; font-size: 0.75rem; line-height: 1.2;">Click to upload or drag & drop (PNG/JPG/SVG, max 2MB)</div>
                                                    </div>
                                                    <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                                    <div style="margin-top: 0.25rem;">
                                                        <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('logoInput').click()" title="Choose Logo" aria-label="Choose Logo" style="padding: 0.2rem 0.35rem; line-height: 1; background: transparent !important; border: none !important; box-shadow: none !important; color: #6c757d;">
                                                            <i class="fas fa-upload"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm" onclick="removeLogo()" id="removeLogoBtn" title="Remove Logo" aria-label="Remove Logo" style="display: none; margin-left: 0.25rem; padding: 0.2rem 0.35rem; line-height: 1; background: transparent !important; border: none !important; box-shadow: none !important; color: #dc3545;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="logo-position-side" style="display:flex; flex-direction: column; align-items: flex-start; gap: 0.25rem; min-width: 120px;">
                                                    <div class="form-label" style="margin: 0 0 0.25rem 0; font-size: 0.85rem;">
                                                        <i class="fas fa-arrows-alt"></i>
                                                        Logo Position
                                                    </div>
                                                    <div id="logoPositionControls" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                                        <label style="display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; line-height: 1.1;">
                                                            <input type="checkbox" id="logoPosTop" checked> Top
                                                        </label>
                                                        <label style="display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; line-height: 1.1;">
                                                            <input type="checkbox" id="logoPosBottom"> Bottom
                                                        </label>
                                                        <label style="display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; line-height: 1.1;">
                                                            <input type="checkbox" id="logoPosLeft"> Left
                                                        </label>
                                                        <label style="display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; line-height: 1.1;">
                                                            <input type="checkbox" id="logoPosRight"> Right
                                                        </label>
                                                    </div>
                                                    <div style="color:#6c757d; font-size:0.7rem;">
                                                        Select one or more positions.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Header & Footer Controls (Full Width) -->
                            <div class="section">
                                <div class="section-title">
                                    <i class="fas fa-border-all"></i>
                                    Header & Footer
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; width: 100%;">
                                    <div style="background:#f8f9fa; padding:.75rem; border:1px solid #e9ecef; border-radius:6px;">
                                        <label style="display:flex; align-items:center; gap:.5rem; font-weight:500; margin-bottom:.5rem;">
                                            <input type="checkbox" id="enableHeader" onchange="updatePreview()"> Show custom header
                                        </label>
                                        <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
                                            <label style="min-width:70px; color:#495057;">Align</label>
                                            <select id="headerAlign" class="form-control" style="max-width: 160px;" onchange="updatePreview()">
                                                <option value="left">Left</option>
                                                <option value="center" selected>Center</option>
                                                <option value="right">Right</option>
                                            </select>
                                        </div>
                                        <textarea id="headerContent" class="form-control" rows="3" placeholder="Enter header content (e.g., address, tagline)" onkeyup="updatePreview()"></textarea>
                                        <small style="color:#6c757d;">Header shows above the document content. Company logo/name/title still apply.</small>
                                    </div>
                                    <div style="background:#f8f9fa; padding:.75rem; border:1px solid #e9ecef; border-radius:6px;">
                                        <label style="display:flex; align-items:center; gap:.5rem; font-weight:500; margin-bottom:.5rem;">
                                            <input type="checkbox" id="enableFooter" onchange="updatePreview()"> Show footer
                                        </label>
                                        <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
                                            <label style="min-width:70px; color:#495057;">Align</label>
                                            <select id="footerAlign" class="form-control" style="max-width: 160px;" onchange="updatePreview()">
                                                <option value="left">Left</option>
                                                <option value="center" selected>Center</option>
                                                <option value="right">Right</option>
                                            </select>
                                        </div>
                                        <textarea id="footerContent" class="form-control" rows="3" placeholder="Enter footer content (e.g., address, contacts, disclaimer)" onkeyup="updatePreview()"></textarea>
                                        <small style="color:#6c757d;">Footer sticks to the bottom of the A4 page preview.</small>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div class="section-title">
                                    <i class="fas fa-puzzle-piece"></i>
                                    Template Sections
                                </div>
                                <div id="sectionsContainer">
                                    <!-- Sections will be added here -->
                                </div>
                                <div class="add-section-footer" style="margin-top: 1rem; display: flex; justify-content: flex-start;">
                                    <button class="btn btn-success" onclick="addSection()">
                                        <i class="fas fa-plus"></i> Add Section
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                    </div>

            <!-- Template Actions -->
            <div class="template-actions">
                <div>
                    <button class="btn btn-secondary" onclick="clearTemplate()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-secondary" onclick="newTemplate()">
                        <i class="fas fa-plus"></i> New Template
                    </button>
                    <button class="btn btn-primary" onclick="exportTemplate()">
                        <i class="fas fa-download"></i> Export Template
                    </button>
                    <button id="saveTemplateBtn" class="btn btn-success" onclick="saveTemplate()">
                        <i class="fas fa-save"></i> Save Template
                    </button>
                    <span id="editingIndicator" style="color: #28a745; font-size: 0.9rem; display: none;">
                        <i class="fas fa-edit"></i> Editing existing template
                    </span>
                </div>
            </div>
        </div>        <!-- Template Library Tab -->
    <div id="previewTab" class="tab-content">
            <div class="template-library-container">
                <div class="section-title" style="margin: 0 0 1rem 0;">
                    <i class="fas fa-eye"></i>
                    Live Preview
                </div>
                <div id="previewArea" class="preview-area">
                    <p style="color: #6c757d; text-align: center; font-style: italic;">
                        Add sections to see the template preview
                    </p>
                </div>
            </div>
        </div>
    <div id="libraryTab" class="tab-content">
            <div class="template-library-container">
                <div id="savedTemplates" class="saved-templates">
                    <!-- Saved templates will be displayed here -->
                </div>
            </div>
        </div>
            </div>
        </main>
    </div>

    <!-- Template View Modal -->
    <div id="templateViewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="viewModalTitle">Template Preview</h2>
                <span class="close" onclick="closeTemplateViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="templateViewContent">
                    <!-- Template content will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplateViewModal()">Close</button>
                <button class="btn btn-primary" onclick="editFromView()">Edit Template</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sectionCounter = 0;
        let templates = []; // Will be loaded from company-scoped storage
        let currentEditingTemplateId = null; // Track which template is being edited

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - starting template builder initialization');
            loadCompanyTemplates(); // Load company-scoped templates
            updatePreview();
            // Initialize sidebar toggle only if a toggle and sidebar exist (sidebar has been removed on this page)
            if (document.getElementById('sidebarToggle') && document.querySelector('.sidebar')) {
                setupSidebarToggle();
            }
            
            // Initialize auth with a slight delay to ensure all elements are ready
            setTimeout(() => {
                console.log('Loading user profile via dashboard.html method...');
                loadUserProfile().then(() => {
                    console.log('Profile loading completed in DOMContentLoaded');
                }).catch(error => {
                    console.error('Error in DOMContentLoaded profile loading:', error);
                });
            }, 200);
        });

        // Sidebar toggle functionality
        function setupSidebarToggle() {
            const toggleBtn = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.getElementById('mainContent');

            if (toggleBtn && sidebar && mainContent) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');

                    // Save sidebar state
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                });

                // Restore sidebar state
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('sidebar-collapsed');
                }
            }
        }

        // User profile dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');

            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userProfileBtn.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }            // Initialize Firebase authentication
            initializeAuth();
            
            // Initialize menu authorization after auth kicks in
            if (typeof initializeMenuAuthorization === 'function') {
                initializeMenuAuthorization();
            } else if (typeof updateMenuWithFeatureAuthorization === 'function') {
                updateMenuWithFeatureAuthorization();
            }
        });

        // Initialize Firebase authentication
        function initializeAuth() {
            // The centralized AuthManager handles all authentication
            // This function is kept for compatibility but delegates to centralized system
            console.log('Using centralized authentication system');
            
            // The authManager is already initialized and handles:
            // - User authentication state
            // - Profile picture loading from Firebase Storage or localStorage  
            // - Company branding
            // - UI updates
        }

        // Load user profile information (dashboard.html compatibility)
        async function loadUserProfile() {
            if (!authManager || !authManager.currentUser) return;
            
            const userData = authManager.currentUser;
            const userAvatar = document.getElementById('userAvatar');
            
            if (userData && userAvatar) {
                // Use AuthManager methods to get user info
                const displayName = authManager.getUserDisplayName();
                const email = authManager.getUserEmail();
                
                // Preload avatar URL to avoid showing initials first
                const avatarUrl = await authManager.getUserAvatarUrl();
                
                // Check if user has a profile picture
                if (avatarUrl) {
                    userAvatar.src = avatarUrl;
                    userAvatar.alt = displayName || 'User Avatar';
                    console.log('✅ Profile picture loaded from:', avatarUrl.substring(0, 50) + '...');
                } else if (userData.profilePicture) {
                    userAvatar.src = userData.profilePicture;
                    userAvatar.alt = displayName || 'User Avatar';
                    console.log('✅ Profile picture loaded from userData.profilePicture');
                } else if (userData.photoURL) {
                    userAvatar.src = userData.photoURL;
                    userAvatar.alt = displayName || 'User Avatar';
                    console.log('✅ Profile picture loaded from userData.photoURL');
                } else {
                    // Generate initials avatar using AuthManager
                    authManager.generateInitialsAvatar(displayName, userAvatar);
                    console.log('✅ Generated initials avatar for:', displayName);
                }
            }
        }

        // Update user profile in UI (delegated to centralized authManager)
        function updateUserProfile(user) {
            // This function is kept for compatibility but delegates to centralized authManager
            console.log('Delegating user profile update to centralized authManager');
            if (authManager && authManager.updateUserAvatarDisplay) {
                authManager.updateUserAvatarDisplay('userAvatar');
            }
        }        // Tab switching functionality with edit protection
        function switchTab(tabName) {
            // Check if user is editing and has unsaved changes
            if (currentEditingTemplateId && tabName !== 'builder') {
                const templateName = document.getElementById('templateName').value.trim();
                if (templateName && !confirm('You are currently editing a template. Are you sure you want to leave? Unsaved changes may be lost.')) {
                    return; // Don't switch tabs
                }
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => { tab.classList.remove('active'); });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to selected tab
            const tabs = document.querySelectorAll('.tabs .tab');
            // Map tabs to indices: 0=builder,1=preview,2=library
            const indexMap = { builder: 0, preview: 1, library: 2 };
            const idx = indexMap[tabName];
            if (typeof idx === 'number' && tabs[idx]) {
                tabs[idx].classList.add('active');
            }
            
            // Load saved templates when switching to library tab
            if (tabName === 'library') {
                loadCompanyTemplates(); // Reload company-scoped templates
            } else if (tabName === 'preview') {
                // Ensure the preview is up to date
                if (typeof updatePreview === 'function') updatePreview();
            }
        }

        // Add a new section to the template
        function addSection(title = '', content = '', type = 'text') {
            const container = document.getElementById('sectionsContainer');
            const sectionId = `section_${++sectionCounter}`;
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section-item';
            sectionDiv.id = sectionId;
            
            sectionDiv.innerHTML = `
                <button class="remove-btn" onclick="removeSection('${sectionId}')">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="form-group">
                    <label class="form-label">Section Type</label>                    <select class="form-control section-type" onchange="updateSectionType('${sectionId}', this.value)">
                        <option value="text" ${type === 'text' ? 'selected' : ''}>Text Content</option>
                        <option value="heading" ${type === 'heading' ? 'selected' : ''}>Heading</option>
                        <option value="list" ${type === 'list' ? 'selected' : ''}>List</option>
                        <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>Large Text Area</option>
                        <option value="table" ${type === 'table' ? 'selected' : ''}>Table</option>
                        <option value="placeholder" ${type === 'placeholder' ? 'selected' : ''}>Placeholder Field</option>
                        <option value="signature" ${type === 'signature' ? 'selected' : ''}>Signature Row</option>
                        <option value="stamp" ${type === 'stamp' ? 'selected' : ''}>Stamp (Image)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Section Title</label>
                    <input type="text" class="form-control section-title-input" value="${title}" 
                           placeholder="Enter section title" onkeyup="updatePreview()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alignment</label>
                    <div style="display:flex; gap: 1rem; align-items: center;">
                        <label style="display:inline-flex; align-items:center; gap:0.4rem;">
                            <input type="radio" name="align_${sectionId}" class="section-align" value="left" checked onchange="updatePreview()"> Left
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:0.4rem;">
                            <input type="radio" name="align_${sectionId}" class="section-align" value="center" onchange="updatePreview()"> Center
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:0.4rem;">
                            <input type="radio" name="align_${sectionId}" class="section-align" value="right" onchange="updatePreview()"> Right
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-control section-content" rows="4" 
                              placeholder="Enter section content" onkeyup="updatePreview()">${content}</textarea>
                </div>
                
                <div class="form-group" id="extraOptions_${sectionId}" style="display: none;">
                    <!-- Extra options for specific section types will be added here -->
                </div>
            `;
              container.appendChild(sectionDiv);
            updateSectionType(sectionId, type);
            setupTextareaCounters();
            updatePreview();
        }

        // Remove a section
        function removeSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && confirm('Are you sure you want to remove this section?')) {
                section.remove();
                updatePreview();
            }
        }

        // Update section type and show relevant options
        function updateSectionType(sectionId, type) {
            const extraOptions = document.getElementById(`extraOptions_${sectionId}`);
            const section = document.getElementById(sectionId);
            const contentTextarea = section.querySelector('.section-content');
            
            // Clear extra options
            extraOptions.innerHTML = '';
            extraOptions.style.display = 'none';
              // Update placeholder based on type
            switch(type) {
                case 'heading':
                    contentTextarea.placeholder = 'Enter heading text';
                    break;
                case 'list':
                    contentTextarea.placeholder = 'Enter list items (one per line)';
                    break;                case 'textarea':
                    contentTextarea.placeholder = 'Enter large text content (supports multiple paragraphs)';
                    contentTextarea.rows = 8; // Make it larger for textarea type
                    extraOptions.innerHTML = `
                        <div class="textarea-options">
                            <label class="form-label" style="margin-bottom: 0.75rem; display: block; font-weight: 600;">
                                <i class="fas fa-cog"></i> Text Area Configuration
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                                    <input type="checkbox" class="textarea-readonly" onchange="updatePreview()">
                                    <i class="fas fa-lock" style="color: #28a745;"></i>
                                    Read-only
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                                    <input type="checkbox" class="textarea-required" onchange="updatePreview()">
                                    <i class="fas fa-asterisk" style="color: #dc3545;"></i>
                                    Required
                                </label>
                            </div>                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <label style="font-weight: 500; color: #495057;">
                                    <i class="fas fa-ruler-horizontal"></i> Character Limit:
                                </label>
                                <input type="number" class="form-control textarea-maxlength" 
                                       style="width: 120px;" placeholder="500" min="0" max="10000" 
                                       onchange="updatePreview(); updateTextareaCounter('${sectionId}')">
                                <small style="color: #6c757d;">Leave empty for no limit</small>
                            </div>
                            <div style="margin-top:.75rem; padding:.5rem; border:1px dashed #cbd5e1; border-radius:6px; background:#f8fafc;">
                                <label class="form-label" style="display:block; margin-bottom:.5rem;">
                                    <i class="fas fa-magic-wand-sparkles"></i> Insert Placeholder
                                </label>
                                <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                                    <select class="form-control" style="max-width:260px;" id="ph_${sectionId}">
                                        <option value="">Select a placeholder...</option>
                                        <option value="{{employeeName}}">Employee Name</option>
                                        <option value="{{employeeId}}">Employee ID</option>
                                        <option value="{{employeeEmail}}">Employee Email</option>
                                        <option value="{{employeePhone}}">Employee Phone</option>
                                        <option value="{{positionTitle}}">Position Title</option>
                                        <option value="{{department}}">Department</option>
                                        <option value="{{reportingManager}}">Reporting Manager</option>
                                        <option value="{{workLocation}}">Work Location</option>
                                        <option value="{{nationality}}">Nationality</option>
                                        <option value="{{gender}}">Gender</option>
                                        <option value="{{fatherName}}">Father Name</option>
                                        <option value="{{motherName}}">Mother Name</option>
                                        <option value="{{birthDate|date}}">Birth Date</option>
                                        <option value="{{birthCountry}}">Birth Country</option>
                                        <option value="{{maritalStatus}}">Marital Status</option>
                                        <option value="{{address}}">Address</option>
                                        <option value="{{accommodationAllowance|currency}}">Accommodation Allowance</option>
                                        <option value="{{housingAllowance|currency}}">Transportation Allowance</option>
                                        <option value="{{salaryAmount|currency}}">Salary Amount (Currency)</option>
                                        <option value="{{grossSalary|currency}}">Gross Salary (Currency)</option>
                                        <option value="{{workingHours}}">Working Hours</option>
                                        <option value="{{currency}}">Currency Code</option>
                                        <option value="{{employmentType}}">Employment Type</option>
                                        <option value="{{contractType}}">Contract Type</option>
                                        <option value="{{startDate|date}}">Start Date</option>
                                        <option value="{{endDate|date}}">End Date</option>
                                        <option value="{{probationPeriod}}">Probation Period</option>
                                        <option value="{{workingHours}}">Working Hours</option>
                                        <option value="{{annualLeave}}">Annual Leave</option>
                                        <option value="{{companyName}}">Company Name</option>
                                        <option value="{{today|date}}">Today's Date</option>
                                    </select>
                                    <button type="button" class="btn btn-secondary" onclick="insertPlaceholderIntoSection('${sectionId}')" title="Insert placeholder at cursor">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <small style="color:#6c757d;">Tip: Placeholders use double curly braces, e.g. {{employeeName}}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    extraOptions.style.display = 'block';
                    break;
                case 'text':
                    contentTextarea.placeholder = 'Enter section content (supports placeholders like {{employeeName}})';
                    extraOptions.innerHTML = `
                        <div style="margin-top:.25rem; padding:.5rem; border:1px dashed #cbd5e1; border-radius:6px; background:#f8fafc;">
                            <label class="form-label" style="display:block; margin-bottom:.5rem;">
                                <i class="fas fa-magic-wand-sparkles"></i> Insert Placeholder
                            </label>
                            <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                                <select class="form-control" style="max-width:260px;" id="ph_${sectionId}">
                                    <option value="">Select a placeholder...</option>
                                    <option value="{{employeeName}}">Employee Name</option>
                                    <option value="{{employeeId}}">Employee ID</option>
                                    <option value="{{employeeEmail}}">Employee Email</option>
                                    <option value="{{employeePhone}}">Employee Phone</option>
                                    <option value="{{positionTitle}}">Position Title</option>
                                    <option value="{{department}}">Department</option>
                                    <option value="{{reportingManager}}">Reporting Manager</option>
                                    <option value="{{workLocation}}">Work Location</option>
                                    <option value="{{nationality}}">Nationality</option>
                                    <option value="{{gender}}">Gender</option>
                                    <option value="{{fatherName}}">Father Name</option>
                                    <option value="{{motherName}}">Mother Name</option>
                                    <option value="{{birthDate|date}}">Birth Date</option>
                                    <option value="{{birthCountry}}">Birth Country</option>
                                    <option value="{{maritalStatus}}">Marital Status</option>
                                    <option value="{{address}}">Address</option>
                                    <option value="{{accommodationAllowance|currency}}">Accommodation Allowance</option>
                                    <option value="{{housingAllowance|currency}}">Transportation Allowance</option>
                                    <option value="{{salaryAmount|currency}}">Salary Amount (Currency)</option>
                                    <option value="{{grossSalary|currency}}">Gross Salary (Currency)</option>
                                    <option value="{{workingHours}}">Working Hours</option>
                                    <option value="{{grossSalary|currency}}">Gross Salary (Currency)</option>
                                    <option value="{{workingHours}}">Working Hours</option>
                                    <option value="{{currency}}">Currency Code</option>
                                    <option value="{{employmentType}}">Employment Type</option>
                                    <option value="{{contractType}}">Contract Type</option>
                                    <option value="{{startDate|date}}">Start Date</option>
                                    <option value="{{endDate|date}}">End Date</option>
                                    <option value="{{probationPeriod}}">Probation Period</option>
                                    <option value="{{workingHours}}">Working Hours</option>
                                    <option value="{{annualLeave}}">Annual Leave</option>
                                    <option value="{{companyName}}">Company Name</option>
                                    <option value="{{today|date}}">Today's Date</option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="insertPlaceholderIntoSection('${sectionId}')" title="Insert placeholder at cursor">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <small style="color:#6c757d;">Tip: Placeholders use double curly braces, e.g. {{employeeName}}</small>
                            </div>
                        </div>
                    `;
                    extraOptions.style.display = 'block';
                    break;
                case 'table':
                    contentTextarea.placeholder = 'Enter table data (use | to separate columns, one row per line)';
                    extraOptions.innerHTML = `
                        <label class="form-label">Table Headers (separated by |)</label>
                        <input type="text" class="form-control table-headers" 
                               placeholder="Header 1 | Header 2 | Header 3" onkeyup="updatePreview()">
                    `;
                    extraOptions.style.display = 'block';
                    break;
                case 'placeholder':
                    contentTextarea.placeholder = 'Enter placeholder name (e.g., {{employee_name}})';
                    extraOptions.innerHTML = `
                        <label class="form-label">Placeholder Type</label>
                        <select class="form-control placeholder-type" onchange="updatePreview()">
                            <option value="text">Text Input</option>
                            <option value="date">Date</option>
                            <option value="number">Number</option>
                            <option value="email">Email</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <label class="form-label">Default Value</label>
                        <input type="text" class="form-control placeholder-default" 
                               placeholder="Default value (optional)" onkeyup="updatePreview()">
                    `;
                    extraOptions.style.display = 'block';
                    break;
                case 'signature':
                    contentTextarea.placeholder = 'Optional instructions to display above signatures';
                    contentTextarea.rows = 2;
                    extraOptions.innerHTML = `
                        <div class="form-group" style="margin-top: .5rem;">
                            <label class="form-label"><i class="fas fa-pen-fancy"></i> Signature Options</label>
                            <div style="display:flex; gap:1rem; align-items:center; margin-bottom:.5rem;">
                                <label style="display:inline-flex; align-items:center; gap:.5rem;">
                                    Count:
                                    <select class="form-control signature-count" style="width:100px;" onchange="updateSignatureOptionsUI('${sectionId}'); updatePreview();">
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                    </select>
                                </label>
                            </div>
                            <div class="signature-labels" id="signatureLabels_${sectionId}"></div>
                            <small style="color:#6c757d;">Labels appear under each signature line (e.g., Employee, Manager, Witness).</small>
                        </div>
                    `;
                    extraOptions.style.display = 'block';
                    // Initialize labels inputs
                    setTimeout(() => { updateSignatureOptionsUI(sectionId); }, 0);
                    break;
                case 'stamp':
                    contentTextarea.placeholder = 'Optional caption under the stamp';
                    contentTextarea.rows = 2;
                    extraOptions.innerHTML = `
                        <div class="form-group" style="margin-top:.5rem;">
                            <label class="form-label"><i class="fas fa-stamp"></i> Stamp Options</label>
                            <div style="display:grid; grid-template-columns: 1fr; gap:.75rem;">
                                <div>
                                    <input type="file" accept="image/*" class="form-control stamp-file" onchange="handleStampUpload(this); updatePreview()">
                                    <small style="color:#6c757d;">Upload a PNG with transparency for best results.</small>
                                </div>
                                <div>
                                    <label class="form-label">Position Under Signature</label>
                                    <select class="form-control stamp-signature-link" onchange="updatePreview()">
                                        <option value="">None (standalone)</option>
                                    </select>
                                    <small style="color:#6c757d;">Select which signature this stamp should appear under.</small>
                                </div>
                                <div style="display:flex; align-items:center; gap:.75rem;">
                                    <label style="min-width:80px;">Size</label>
                                    <input type="range" min="40" max="240" step="4" value="120" class="stamp-size" oninput="this.nextElementSibling.value=this.value; updatePreview()">
                                    <output>120</output>
                                    <small style="color:#6c757d;">pixels (diameter/width)</small>
                                </div>
                                <div style="display:flex; align-items:center; gap:1rem;">
                                    <label style="display:inline-flex; align-items:center; gap:.4rem;">
                                        <input type="checkbox" class="stamp-circular" onchange="updatePreview()"> Circular
                                    </label>
                                    <label style="display:inline-flex; align-items:center; gap:.4rem;">
                                        <input type="checkbox" class="stamp-border" checked onchange="updatePreview()"> Border
                                    </label>
                                </div>
                                <div class="stamp-preview" style="display:none; text-align:center;">
                                    <img src="" alt="Stamp Preview" style="max-width:200px; height:auto; opacity:0.9;">
                                </div>
                            </div>
                        </div>
                    `;
                    extraOptions.style.display = 'block';
                    // Populate signature dropdown
                    setTimeout(() => { populateSignatureLinksForStamp(sectionId); }, 0);
                    break;
                default:
                    contentTextarea.placeholder = 'Enter section content';
                    contentTextarea.rows = 4; // Reset to default rows for other types
            }
            
            updatePreview();
        }
        // Insert selected placeholder token into the section content at the cursor position
        function insertPlaceholderIntoSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const sel = section.querySelector(`#ph_${sectionId}`);
            const ta = section.querySelector('.section-content');
            if (!sel || !ta) return;
            const token = sel.value;
            if (!token) return;
            // Insert at caret
            const start = ta.selectionStart || 0;
            const end = ta.selectionEnd || 0;
            const val = ta.value || '';
            ta.value = val.slice(0, start) + token + val.slice(end);
            // Move caret after inserted token
            const pos = start + token.length;
            try { ta.setSelectionRange(pos, pos); } catch(e) { /* ignore */ }
            ta.focus();
            if (typeof updatePreview === 'function') updatePreview();
        }
        // Ensure the signature labels UI matches selected count (2 or 3)
        function updateSignatureOptionsUI(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const extraOptions = document.getElementById(`extraOptions_${sectionId}`);
            const countEl = extraOptions?.querySelector('.signature-count');
            const labelsHost = document.getElementById(`signatureLabels_${sectionId}`);
            if (!countEl || !labelsHost) return;
            const count = Math.max(2, Math.min(3, parseInt(countEl.value || '2', 10)));
            const existingValues = Array.from(labelsHost.querySelectorAll('input.signature-label')).map(i => i.value);
            const existingEnabled = Array.from(labelsHost.querySelectorAll('input.sig-stamp-enabled')).map(i => i.checked);
            const existingStampData = Array.from(labelsHost.querySelectorAll('input.sig-stamp-file')).map(i => i.dataset.stampDataUrl || '');
            labelsHost.innerHTML = '';
            const gridCols = count === 2 ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)';
            labelsHost.style.display = 'grid';
            labelsHost.style.gridTemplateColumns = gridCols;
            labelsHost.style.gap = '0.5rem';
            for (let i = 0; i < count; i++) {
                const value = existingValues[i] || (i === 0 ? 'Employee' : i === 1 ? 'Manager' : 'Witness');
                const wrapper = document.createElement('div');
                const enabled = !!existingEnabled[i];
                const dataUrl = existingStampData[i] || '';
                wrapper.innerHTML = `
                    <div style=\"display:flex; flex-direction:column; gap:.35rem;\">\n                        <input type=\"text\" class=\"form-control signature-label\" placeholder=\"Label ${i+1}\" value=\"${value}\" onkeyup=\"updatePreview()\">\n                        <label style=\"font-size:.85rem; color:#334155; display:flex; align-items:center; gap:.5rem;\">\n                            <input type=\"checkbox\" class=\"sig-stamp-enabled\" onchange=\"toggleInlineStamp(this); updatePreview()\" ${enabled ? 'checked' : ''}>\n                            Add stamp under this signature\n                        </label>\n                        <div class=\"sig-stamp-uploader\" style=\"${enabled ? '' : 'display:none;'}\">\n                            <input type=\"file\" accept=\"image/*\" class=\"form-control sig-stamp-file\" onchange=\"handleInlineSigStampUpload(this); updatePreview()\" ${dataUrl ? `data-stamp-data-url='${dataUrl.replace(/'/g, "&#39;")}'` : ''}>\n                            <div class=\"sig-stamp-preview\" style=\"${dataUrl ? '' : 'display:none;'} margin-top:.25rem;\">\n                                <img src=\"${dataUrl}\" alt=\"Stamp Preview\" style=\"max-width:120px; height:auto; opacity:.92; border:1px dashed #cbd5e1; padding:2px; background:#fff;\">\n                            </div>\n                        </div>\n                    </div>
                `;
                labelsHost.appendChild(wrapper);
            }
        }
        // Update the live preview with support for logo positions
        function updatePreview() {
            const previewArea = document.getElementById('previewArea');
            const sections = document.querySelectorAll('.section-item');
            const logo = getCurrentLogo();
            const positions = getSelectedLogoPositions();
            const companyName = (document.getElementById('templateCompanyName')?.value || '').trim();
            const docTitle = (document.getElementById('templateTitle')?.value || '').trim();
            // Header/Footer state
            const enableHeader = document.getElementById('enableHeader')?.checked || false;
            const headerAlign = document.getElementById('headerAlign')?.value || 'center';
            const headerContent = (document.getElementById('headerContent')?.value || '').trim();
            const enableFooter = document.getElementById('enableFooter')?.checked || false;
            const footerAlign = document.getElementById('footerAlign')?.value || 'center';
            const footerContent = (document.getElementById('footerContent')?.value || '').trim();

            // 1) Build the content HTML from sections with stamp-under-signature positioning
            let contentHTML = '';
            const stampsBySignature = new Map(); // Map signature section ID to array of stamp sections
            
            sections.forEach(section => {
                const type = section.querySelector('.section-type').value;
                if (type === 'stamp') {
                    const linkedSigId = section.querySelector('.stamp-signature-link')?.value;
                    if (linkedSigId) {
                        if (!stampsBySignature.has(linkedSigId)) stampsBySignature.set(linkedSigId, []);
                        stampsBySignature.get(linkedSigId).push(section);
                    }
                }
            });
            
            sections.forEach(section => {
                const type = section.querySelector('.section-type').value;
                const title = section.querySelector('.section-title-input').value;
                const content = section.querySelector('.section-content').value;
                const align = section.querySelector('.section-align:checked')?.value || 'left';
                const alignStyle = `text-align: ${align};`;

                if (title || content || type === 'signature') {
                    switch (type) {
                        case 'heading':
                            contentHTML += `<div style="${alignStyle}"><h2 style="color: #2c3e50; margin-bottom: 1rem; display: inline-block;">${title || content}</h2></div>`;
                            break;
                        case 'list':
                            if (content) {
                                const items = content.split('\n').filter(item => item.trim());
                                contentHTML += `<div style="${alignStyle}">`;
                                contentHTML += title ? `<h3 style="display:inline-block;">${title}</h3>` : '';
                                contentHTML += '<ul style="display:inline-block; text-align: left;">';
                                items.forEach(item => {
                                    contentHTML += `<li>${item.trim()}</li>`;
                                });
                                contentHTML += '</ul>';
                                contentHTML += '</div>';
                            }
                            break;
                        case 'textarea': {
                            const isReadonly = section.querySelector('.textarea-readonly')?.checked || false;
                            const isRequired = section.querySelector('.textarea-required')?.checked || false;
                            const maxLength = section.querySelector('.textarea-maxlength')?.value || '';

                            contentHTML += title ? `<div style="${alignStyle}"><h3 style="display:inline-block;">${title}</h3></div>` : '';
                            contentHTML += `
                                <div class="textarea-preview" style="margin-bottom: 1rem; ${alignStyle}">
                                    <textarea 
                                        style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; 
                                               font-family: inherit; font-size: 0.9rem; line-height: 1.5; resize: vertical;
                                               min-height: 120px; background: ${isReadonly ? '#f8f9fa' : 'white'};"
                                        placeholder="${content || 'Enter your text here...'}"
                                        ${isReadonly ? 'readonly' : ''}
                                        ${isRequired ? 'required' : ''}
                                        ${maxLength ? `maxlength="${maxLength}"` : ''}
                                    >${content}</textarea>
                                    <div class="textarea-info">
                                        <div>
                                            ${isRequired ? '<span class="textarea-required-indicator">* Required field</span>' : ''}
                                            ${isReadonly ? '<span class="textarea-readonly-indicator">📖 Read-only</span>' : ''}
                                        </div>
                                        ${maxLength ? `<span class="textarea-maxlength-indicator">Max: ${maxLength} characters</span>` : ''}
                                    </div>
                                </div>`;
                            break;
                        }
                        case 'table': {
                            const headers = section.querySelector('.table-headers')?.value || '';
                            if (content || headers) {
                                contentHTML += title ? `<div style="${alignStyle}"><h3 style="display:inline-block;">${title}</h3></div>` : '';
                                contentHTML += `<div style="${alignStyle}">`;
                                contentHTML += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">';

                                if (headers) {
                                    const headerCells = headers.split('|').map(h => h.trim());
                                    contentHTML += '<thead><tr>';
                                    headerCells.forEach(header => {
                                        contentHTML += `<th style=\"border: 1px solid #ddd; padding: 8px; background: #f8f9fa;\">${header}</th>`;
                                    });
                                    contentHTML += '</tr></thead>';
                                }

                                if (content) {
                                    const rows = content.split('\n').filter(row => row.trim());
                                    contentHTML += '<tbody>';
                                    rows.forEach(row => {
                                        const cells = row.split('|').map(c => c.trim());
                                        contentHTML += '<tr>';
                                        cells.forEach(cell => {
                                            contentHTML += `<td style=\"border: 1px solid #ddd; padding: 8px;\">${cell}</td>`;
                                        });
                                        contentHTML += '</tr>';
                                    });
                                    contentHTML += '</tbody>';
                                }

                                contentHTML += '</table>';
                                contentHTML += '</div>'; // close align wrapper
                            }
                            break;
                        }
                        case 'placeholder': {
                            const placeholderType = section.querySelector('.placeholder-type')?.value || 'text';
                            const defaultValue = section.querySelector('.placeholder-default')?.value || '';
                            contentHTML += title ? `<div style="${alignStyle}"><h3 style="display:inline-block;">${title}</h3></div>` : '';
                            contentHTML += `<div style="${alignStyle}">
                                <div style="display:inline-block; background: #e3f2fd; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; text-align: left;">
                                <strong>Placeholder:</strong> ${content} 
                                <span style="color: #666;">(${placeholderType}${defaultValue ? ', default: ' + defaultValue : ''})</span>
                                </div>
                            </div>`;
                            break;
                        }
                        case 'signature': {
                            const count = parseInt(section.querySelector('.signature-count')?.value || '2', 10);
                            const labels = Array.from(section.querySelectorAll('.signature-label')).map(i => i.value.trim()).filter(Boolean);
                            const inlineStampEnabled = Array.from(section.querySelectorAll('.sig-stamp-enabled')).map(cb => cb.checked);
                            const inlineStampData = Array.from(section.querySelectorAll('.sig-stamp-file')).map(inp => inp.dataset.stampDataUrl || '');
                            const n = Math.max(2, Math.min(3, count || 2));
                            const jc = (align === 'right') ? 'flex-end' : (align === 'center' ? 'center' : 'flex-start');
                            const blockWidth = n === 2 ? '48%' : '31%';
                            contentHTML += title ? `<div style="${alignStyle}"><h3 style="display:inline-block;">${title}</h3></div>` : '';
                            if (content) contentHTML += `<div style="${alignStyle}; color:#475569; font-size:.9rem; margin-bottom:.25rem;">${content.replace(/\n/g, '<br>')}</div>`;
                            contentHTML += `<div style="display:flex; gap:1rem; justify-content:${jc}; ${alignStyle}">`;
                            for (let i = 0; i < n; i++) {
                                const label = labels[i] || `Signature ${i+1}`;
                                let stampHTML = '';
                                if (inlineStampEnabled[i] && inlineStampData[i]) {
                                    const size = 120; // default inline size
                                    stampHTML = `<div style="margin-top:.35rem;"><img src="${inlineStampData[i]}" alt="Stamp" style="width:${size}px; height:${size}px; object-fit:contain; opacity:.92;"></div>`;
                                }
                                contentHTML += `
                                    <div style="width:${blockWidth}; min-width:160px; text-align:center;">
                                        <div style="height:56px; border-bottom:1px solid #94a3b8; margin:0 6px;"></div>
                                        <div style="margin-top:.35rem; font-size:.85rem; color:#334155;">${label}</div>
                                        ${stampHTML}
                                    </div>
                                `;
                            }
                            contentHTML += `</div>`;
                            
                            // Render stamps linked to this signature
                            const linkedStamps = stampsBySignature.get(section.id) || [];
                            linkedStamps.forEach(stampSec => {
                                const stampTitle = stampSec.querySelector('.section-title-input')?.value || '';
                                const stampContent = stampSec.querySelector('.section-content')?.value || '';
                                const stampSize = parseInt(stampSec.querySelector('.stamp-size')?.value || '120', 10);
                                const stampCircular = stampSec.querySelector('.stamp-circular')?.checked || false;
                                const stampBorder = stampSec.querySelector('.stamp-border')?.checked || false;
                                const stampData = stampSec.dataset.stampImage || '';
                                const stampAlign = stampSec.querySelector('.section-align:checked')?.value || 'left';
                                const stampAlignStyle = `text-align:${stampAlign};`;
                                const radius = stampCircular ? '50%' : '0';
                                const border = stampBorder ? '2px solid rgba(100,116,139,0.6)' : 'none';
                                const caption = stampContent ? `<div style="margin-top:.35rem; font-size:.85rem; color:#334155;">${stampContent.replace(/\n/g, '<br>')}</div>` : '';
                                const imgHTML = stampData
                                    ? `<img src="${stampData}" alt="Stamp" style="width:${stampSize}px; height:${stampSize}px; object-fit:contain; border-radius:${radius}; border:${border}; opacity:.92; background:transparent;">`
                                    : `<div style="width:${stampSize}px; height:${stampSize}px; display:flex; align-items:center; justify-content:center; color:#94a3b8; border:${border}; border-radius:${radius};">No Stamp</div>`;
                                contentHTML += stampTitle ? `<div style="${stampAlignStyle}; margin-top:.5rem;"><h4 style="display:inline-block; font-size:.9rem;">${stampTitle}</h4></div>` : '';
                                contentHTML += `<div style="${stampAlignStyle}; margin-top:.25rem;">
                                    <div style="display:inline-flex; align-items:center; justify-content:center; width:${stampSize}px; height:${stampSize}px;">${imgHTML}</div>
                                    ${caption}
                                </div>`;
                            });
                            break;
                        }
                        case 'stamp': {
                            // Skip stamps linked to signatures; they'll render under the signature
                            const linkedSigId = section.querySelector('.stamp-signature-link')?.value;
                            if (linkedSigId) break;
                            
                            const size = parseInt(section.querySelector('.stamp-size')?.value || '120', 10);
                            const circular = section.querySelector('.stamp-circular')?.checked || false;
                            const showBorder = section.querySelector('.stamp-border')?.checked || false;
                            const dataUrl = section.dataset.stampImage || '';
                            const radius = circular ? '50%' : '0';
                            const border = showBorder ? '2px solid rgba(100,116,139,0.6)' : 'none';
                            const caption = content ? `<div style="margin-top:.35rem; font-size:.85rem; color:#334155;">${content.replace(/\n/g, '<br>')}</div>` : '';
                            const imgHTML = dataUrl
                                ? `<img src="${dataUrl}" alt="Stamp" style="width:${size}px; height:${size}px; object-fit:contain; border-radius:${radius}; border:${border}; opacity:.92; background:transparent;">`
                                : `<div style="width:${size}px; height:${size}px; display:flex; align-items:center; justify-content:center; color:#94a3b8; border:${border}; border-radius:${radius};">No Stamp</div>`;
                            contentHTML += title ? `<div style="${alignStyle}"><h3 style="display:inline-block;">${title}</h3></div>` : '';
                            contentHTML += `<div style="${alignStyle}">
                                <div style="display:inline-flex; align-items:center; justify-content:center; width:${size}px; height:${size}px;">${imgHTML}</div>
                                ${caption}
                            </div>`;
                            break;
                        }
                        default:
                            contentHTML += title ? `<div style="${alignStyle}"><h3 style="display:inline-block;">${title}</h3></div>` : '';
                            contentHTML += `<div style="${alignStyle}"><p style="display:inline-block; margin-bottom: 1rem; text-align: left;">${(content || '').replace(/\n/g, '<br>')}</p></div>`;
                    }
                }
            });

            if (!contentHTML) {
                contentHTML = `
                    <p style="color: #6c757d; text-align: center; font-style: italic;">
                        Add content to sections to see the preview
                    </p>`;
            }

            // 2) Compose header with logo(s) positioned AROUND the company name (not the page content)
            const hasLogo = !!(logo && logo !== 'data:');
            const logoImg = hasLogo ? `<img src="${logo}" alt="Template Logo" style="max-height: 80px; max-width: 200px; object-fit: contain;">` : '';

            let headerHTML = '';

            // Determine if we have any header elements to show
            const showLeft = hasLogo && positions.includes('left');
            const showRight = hasLogo && positions.includes('right');
            const showTop = hasLogo && positions.includes('top'); // logo above company name
            const showBottom = hasLogo && positions.includes('bottom'); // logo below company name

            // Build the primary header row: [Left logo] [Top inline logo + Company Name] [Right logo]
            // If no positions selected but company name exists, still render the company name centered
            const hasAnyHeader = !!companyName || !!docTitle || showLeft || showRight || showTop || showBottom;

            if (hasAnyHeader) {
                const leftHTML = showLeft ? `<div style="width: 120px; text-align: center;">${logoImg}</div>` : '';
                const centerNameHTML = companyName ? `<div style=\"font-weight: 700; font-size: 1.15rem;\">${companyName}</div>` : '';
                const rightHTML = showRight ? `<div style="width: 120px; text-align: center;">${logoImg}</div>` : '';
                const hasRow = !!companyName || showLeft || showRight;

                // Compose the header block
                headerHTML = `
                    <div style="margin-bottom: 1rem; padding-bottom: 0.75rem; ${hasAnyHeader ? 'border-bottom: 1px solid #e9ecef;' : ''}">
                        ${showTop ? `<div style=\"text-align: center; margin-bottom: 0.5rem;\">${logoImg}</div>` : ''}
                        ${hasRow ? `<div style=\"display: flex; align-items: center; justify-content: center; gap: 0.75rem;\">${leftHTML}${centerNameHTML}${rightHTML}</div>` : ''}
                        ${docTitle ? `<div style=\"text-align: center; font-weight: 600; font-size: 1rem; margin-top: ${hasRow ? '0.25rem' : '0'};\">${docTitle}</div>` : ''}
                        ${showBottom ? `<div style=\"text-align: center; margin-top: 0.5rem;\">${logoImg}</div>` : ''}
                    </div>`;
            }

            // 2b) Optional custom header content (separate band)
            let customHeaderHTML = '';
            if (enableHeader && headerContent) {
                const ha = headerAlign === 'right' ? 'right' : headerAlign === 'left' ? 'left' : 'center';
                customHeaderHTML = `
                    <div style="border-bottom:1px solid #e9ecef; padding-bottom:.5rem; margin-bottom:.75rem;">
                        <div style="text-align:${ha}; font-size:.9rem; color:#334155; white-space:pre-wrap;">${headerContent.replace(/\n/g,'<br>')}</div>
                    </div>`;
            }

            // Optional footer content
            let customFooterHTML = '';
            if (enableFooter && footerContent) {
                const fa = footerAlign === 'right' ? 'right' : footerAlign === 'left' ? 'left' : 'center';
                customFooterHTML = `
                    <div style="border-top:1px solid #e9ecef; padding-top:.5rem; margin-top:1rem;">
                        <div style="text-align:${fa}; font-size:.9rem; color:#334155; white-space:pre-wrap;">${footerContent.replace(/\n/g,'<br>')}</div>
                    </div>`;
            }

            // Wrap with A4 page for display. Footer sits at bottom via flex layout.
            previewArea.innerHTML = `
                <div class="a4-page" style="display:flex; flex-direction:column;">
                    <div>
                        ${headerHTML}${customHeaderHTML}${contentHTML}
                    </div>
                    <div style="margin-top:auto;">${customFooterHTML}</div>
                </div>
            `;
        }

        // Load templates from company-scoped storage
        async function loadCompanyTemplates() {
            console.log('🔄 Loading company-scoped templates...');
            
            try {
                // Get current company ID
                const companyId = companyDataService?.getCurrentCompanyId();
                if (!companyId) {
                    console.error('❌ No company context found - templates require company scope');
                    alert('Error: Templates require company context. Please ensure you are logged in with proper company access.');
                    templates = []; // Clear templates if no company context
                    loadSavedTemplates();
                    return;
                }
                
                console.log('🏢 Loading templates for company:', companyId);
                // First, try to load from Firebase Realtime Database (authoritative for stamps)
                if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                    try {
                        const firebaseInstance = initializeFirebase();
                        if (firebaseInstance && firebaseInstance.apps.length > 0) {
                            const rtdb = firebaseInstance.database();
                            console.log('🔍 Fetching company templates from Realtime Database...');
                            const snapshot = await rtdb.ref(`companies/${companyId}/documentTemplates`).once('value');
                            const data = snapshot.val() || {};
                            const list = Object.values(data);
                            if (list.length > 0) {
                                // Sort by lastModified desc if available
                                list.sort((a,b) => new Date(b.lastModified||0) - new Date(a.lastModified||0));
                                templates = list;
                                console.log(`✅ Loaded ${templates.length} company templates from Realtime Database`);
                                // Cache in localStorage
                                localStorage.setItem(`documentTemplates_${companyId}`, JSON.stringify(templates));
                                loadSavedTemplates();
                                return;
                            } else {
                                console.log('ℹ️ No company templates found in Realtime Database');
                            }
                        }
                    } catch (rtdbError) {
                        console.log('Firebase Realtime Database not available:', rtdbError);
                    }
                }

                // Next, try to load from Firebase Firestore
                if (typeof firebase !== 'undefined' && firebase.firestore && typeof initializeFirebase === 'function') {
                    try {
                        const firebaseInstance = initializeFirebase();
                        if (firebaseInstance && firebaseInstance.apps.length > 0) {
                            const db = firebaseInstance.firestore();
                            
                            console.log('🔍 Fetching company templates from Firestore...');
                            const templatesQuery = await db.collection('documentTemplates')
                                .where('companyId', '==', companyId)
                                .orderBy('lastModified', 'desc')
                                .get();
                            
                            if (!templatesQuery.empty) {
                                templates = templatesQuery.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                
                                console.log(`✅ Loaded ${templates.length} company templates from Firestore`);
                                
                                // Cache in localStorage with company prefix
                                localStorage.setItem(`documentTemplates_${companyId}`, JSON.stringify(templates));
                                loadSavedTemplates();
                                return;
                            } else {
                                console.log('ℹ️ No company templates found in Firestore');
                            }
                        }
                    } catch (firebaseError) {
                        console.log('Firebase Firestore not available:', firebaseError);
                    }
                }
                
                // Load from company-scoped localStorage only
                console.log('🔄 Loading from company-scoped localStorage...');
                templates = JSON.parse(localStorage.getItem(`documentTemplates_${companyId}`)) || [];
                console.log(`✅ Loaded ${templates.length} templates from company-scoped localStorage`);
                
            } catch (error) {
                console.error('Error loading company templates:', error);
                // No fallback to global - company scope is required
                templates = [];
                console.log('❌ Failed to load templates - company scope required');
            }
            
            loadSavedTemplates();
        }

        // Save template to company-scoped storage
        async function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const description = (document.getElementById('templateDescription')?.value || '').trim();
            const category = document.getElementById('templateCategory').value;
            const logo = getCurrentLogo(); // Get logo data
            const logoPositions = getSelectedLogoPositions();
            const companyName = (document.getElementById('templateCompanyName')?.value || '').trim();
            const docTitle = (document.getElementById('templateTitle')?.value || '').trim();
            // Header/footer fields
            const headerSettings = {
                enabled: document.getElementById('enableHeader')?.checked || false,
                align: document.getElementById('headerAlign')?.value || 'center',
                content: (document.getElementById('headerContent')?.value || '').trim()
            };
            const footerSettings = {
                enabled: document.getElementById('enableFooter')?.checked || false,
                align: document.getElementById('footerAlign')?.value || 'center',
                content: (document.getElementById('footerContent')?.value || '').trim()
            };
            
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            // Validate company context BEFORE processing sections
            const companyId = companyDataService?.getCurrentCompanyId();
            if (!companyId) {
                alert('❌ Error: Templates must be created within a company context. Please ensure you are logged in with proper company access.');
                console.error('❌ Cannot save template: No company context found');
                return;
            }
            
            const sections = [];
            document.querySelectorAll('.section-item').forEach(section => {
                const type = section.querySelector('.section-type').value;
                const title = section.querySelector('.section-title-input').value;
                const content = section.querySelector('.section-content').value;
                const alignment = section.querySelector('.section-align:checked')?.value || 'left';
                
                const sectionData = { type, title, content, alignment };
                  // Add extra options based on type
                if (type === 'table') {
                    sectionData.headers = section.querySelector('.table-headers')?.value || '';
                } else if (type === 'placeholder') {
                    sectionData.placeholderType = section.querySelector('.placeholder-type')?.value || 'text';
                    sectionData.defaultValue = section.querySelector('.placeholder-default')?.value || '';
                } else if (type === 'textarea') {
                    sectionData.readonly = section.querySelector('.textarea-readonly')?.checked || false;
                    sectionData.required = section.querySelector('.textarea-required')?.checked || false;
                    sectionData.maxLength = section.querySelector('.textarea-maxlength')?.value || '';
                } else if (type === 'signature') {
                    sectionData.signatureCount = parseInt(section.querySelector('.signature-count')?.value || '2', 10);
                    sectionData.signatureLabels = Array.from(section.querySelectorAll('.signature-label')).map(i => i.value.trim());
                    // Persist per-signature inline stamp options
                    sectionData.inlineStamps = Array.from(section.querySelectorAll('.sig-stamp-enabled')).map((cb, idx) => ({
                        enabled: cb.checked,
                        dataUrl: (section.querySelectorAll('.sig-stamp-file')[idx]?.dataset?.stampDataUrl) || ''
                    }));
                } else if (type === 'stamp') {
                    sectionData.stampImage = section.closest('.section-item')?.dataset?.stampImage || '';
                    sectionData.stampSize = parseInt(section.querySelector('.stamp-size')?.value || '120', 10);
                    sectionData.stampCircular = section.querySelector('.stamp-circular')?.checked || false;
                    sectionData.stampBorder = section.querySelector('.stamp-border')?.checked || false;
                    sectionData.stampSignatureLink = section.querySelector('.stamp-signature-link')?.value || '';
                }
                
                sections.push(sectionData);
            });
              if (sections.length === 0) {
                alert('Please add at least one section to the template');
                return;
            }

            try {
                // Check if we're editing an existing template or creating a new one
                if (currentEditingTemplateId) {
                    // Update existing template
                    const existingTemplateIndex = templates.findIndex(t => t.id === currentEditingTemplateId);
                    if (existingTemplateIndex !== -1) {
                        const existingTemplate = templates[existingTemplateIndex];
                        const updatedTemplate = {
                            ...existingTemplate, // Keep original ID and createdAt
                            name,
                            description,
                            category,
                            logo, // Include logo data
                            logoPositions,
                            companyName,
                            sections,
                            title: docTitle,
                            headerSettings,
                            footerSettings,
                            companyId, // Ensure company scope
                            lastModified: new Date().toISOString()
                        };
                        
                        templates[existingTemplateIndex] = updatedTemplate;
                        
                        // Save to localStorage FIRST (fast, reliable)
                        saveTemplateToCompanyScope(templates);
                        
                        // Then save to Firebase Realtime Database (PRIORITY - for contractsub.html)
                        await saveTemplateToRealtimeDB(updatedTemplate, companyId);
                        
                        // Finally save to Firebase Firestore (backup/search)
                        await saveTemplateToFirestore(updatedTemplate, companyId);
                        
                        alert('✅ Template updated successfully and saved to company database!');
                        // Don't clear editing state - keep it for further edits
                        updateEditingUI();
                    } else {
                        // Template not found, create new one
                        currentEditingTemplateId = null;
                        await saveAsNewTemplate(name, description, category, logo, logoPositions, sections, companyName, docTitle);
                    }
                } else {
                    // Create new template
                await saveAsNewTemplate(name, description, category, logo, logoPositions, sections, companyName, docTitle);
                }
                
                loadSavedTemplates();
            } catch (error) {
                console.error('❌ Error saving template:', error);
                alert('❌ Error saving template: ' + error.message + '\nTemplate saved to local storage only.');
            }
        }
          // Helper function to save as new template
    async function saveAsNewTemplate(name, description, category, logo, logoPositions, sections, companyName, docTitle) {
            const companyId = companyDataService?.getCurrentCompanyId();
            
            // Validate company context before creating template
            if (!companyId) {
                console.error('❌ Cannot create template: No company context found');
                alert('❌ Error: Templates must be created within a company context. Please ensure you are logged in with proper company access.');
                throw new Error('Company context required for template creation');
            }
            
            // Read header/footer again in case called directly
            const headerSettings = {
                enabled: document.getElementById('enableHeader')?.checked || false,
                align: document.getElementById('headerAlign')?.value || 'center',
                content: (document.getElementById('headerContent')?.value || '').trim()
            };
            const footerSettings = {
                enabled: document.getElementById('enableFooter')?.checked || false,
                align: document.getElementById('footerAlign')?.value || 'center',
                content: (document.getElementById('footerContent')?.value || '').trim()
            };

            const newTemplate = {
                id: Date.now().toString(),
                name,
                description,
                category,
                logo, // Include logo data
                logoPositions,
                companyName,
                title: docTitle,
                sections,
                headerSettings,
                footerSettings,
                companyId, // Add company scope
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            try {
                templates.push(newTemplate);
                
                // Save to localStorage FIRST (fast, reliable)
                saveTemplateToCompanyScope(templates);
                
                // Then save to Firebase Realtime Database (PRIORITY - for contractsub.html)
                await saveTemplateToRealtimeDB(newTemplate, companyId);
                
                // Finally save to Firebase Firestore (backup/search)
                const savedTemplate = await saveTemplateToFirestore(newTemplate, companyId);
                if (savedTemplate && savedTemplate.id !== newTemplate.id) {
                    // Update local template with Firebase ID
                    const templateIndex = templates.findIndex(t => t.id === newTemplate.id);
                    if (templateIndex !== -1) {
                        templates[templateIndex].id = savedTemplate.id;
                        newTemplate.id = savedTemplate.id;
                        saveTemplateToCompanyScope(templates);
                        
                        // Re-save to Realtime DB with updated ID
                        await saveTemplateToRealtimeDB(newTemplate, companyId);
                    }
                }
                
                alert('✅ Template saved successfully to company database!');
                // Set the editing ID to the new template for further edits
                currentEditingTemplateId = newTemplate.id;
                updateEditingUI();
            } catch (error) {
                console.error('❌ Error in saveAsNewTemplate:', error);
                alert('❌ Error saving template: ' + error.message);
                throw error;
            }
        }

        // Helper function to save templates to company-scoped storage
        function saveTemplateToCompanyScope(templatesArray) {
            const companyId = companyDataService?.getCurrentCompanyId();
            if (companyId) {
                // Save to company-scoped localStorage only
                localStorage.setItem(`documentTemplates_${companyId}`, JSON.stringify(templatesArray));
                console.log(`✅ Templates saved to company scope: ${companyId}`);
            } else {
                // Throw error if no company context - templates must be company-scoped
                console.error('❌ Cannot save templates: No company context found');
                alert('Error: Templates must be saved within a company context. Please ensure you are logged in with proper company access.');
                throw new Error('Company context required for template storage');
            }
        }

        // Helper function to save template to Firebase Firestore with company scope
        async function saveTemplateToFirestore(template, companyId) {
            if (!companyId) {
                console.warn('No company ID provided for Firestore save');
                return template;
            }

            try {
                if (typeof firebase !== 'undefined' && firebase.firestore && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.firestore();
                        const authUser = authManager?.getCurrentUser();
                        
                        if (authUser) {
                            const templateData = {
                                ...template,
                                companyId, // Ensure company scope
                                userId: authUser.uid || authUser.id,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastModified: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            if (template.id && template.id !== Date.now().toString()) {
                                // Update existing template
                                console.log('🔄 Updating template in Firestore:', template.id);
                                await db.collection('documentTemplates').doc(template.id).update({
                                    ...templateData,
                                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                console.log('✅ Template updated in Firestore');
                                return template;
                            } else {
                                // Create new template
                                console.log('💾 Saving new template to Firestore with company scope:', companyId);
                                const docRef = await db.collection('documentTemplates').add(templateData);
                                console.log('✅ New template saved to Firestore with ID:', docRef.id);
                                return { ...template, id: docRef.id };
                            }
                        } else {
                            console.warn('No authenticated user for Firestore save');
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving template to Firestore:', error);
            }
            
            return template;
        }

        // Helper function to save template to Firebase Realtime Database (for contractsub.html compatibility)
        async function saveTemplateToRealtimeDB(template, companyId) {
            if (!companyId) {
                console.error('❌ Cannot save to Realtime Database: No company ID provided - templates must be company-scoped');
                throw new Error('Company ID required for Realtime Database storage');
            }

            try {
                if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.database();
                        
                        const templateData = {
                            ...template,
                            companyId, // Ensure company scope
                            createdAt: template.createdAt || new Date().toISOString(),
                            lastModified: new Date().toISOString()
                        };
                        
                        // Save to companies/{companyId}/documentTemplates/{templateId} - COMPANY SCOPED ONLY
                        const templateRef = db.ref(`companies/${companyId}/documentTemplates/${template.id}`);
                        await templateRef.set(templateData);
                        
                        // Trigger real-time notification for contractsub.html
                        const notificationRef = db.ref(`companies/${companyId}/templateUpdates`);
                        await notificationRef.set({
                            templateId: template.id,
                            action: 'created_or_updated',
                            timestamp: new Date().toISOString(),
                            templateName: template.name
                        });
                        
                        console.log('✅ Template saved to COMPANY-SCOPED Realtime Database:', `companies/${companyId}/documentTemplates/${template.id}`);
                        console.log('✅ Real-time notification sent for contractsub.html');
                        return template;
                    } else {
                        console.warn('⚠️ Firebase not properly initialized - template saved to localStorage only');
                    }
                } else {
                    console.warn('⚠️ Firebase Realtime Database not available - template saved to localStorage only');
                }
            } catch (error) {
                console.error('❌ Error saving template to Realtime Database:', error);
                throw error; // Re-throw to handle in calling function
            }
            
            return template;
        }

        // Export template as JSON
        function exportTemplate() {
            const name = document.getElementById('templateName').value.trim();
            
            if (!name) {
                alert('Please enter a template name before exporting');
                return;
            }
            
            const sections = [];
            document.querySelectorAll('.section-item').forEach(section => {
                const type = section.querySelector('.section-type').value;
                const title = section.querySelector('.section-title-input').value;
                const content = section.querySelector('.section-content').value;
                const alignment = section.querySelector('.section-align:checked')?.value || 'left';
                
                const sectionData = { type, title, content, alignment };
                
                if (type === 'table') {
                    sectionData.headers = section.querySelector('.table-headers')?.value || '';
                } else if (type === 'placeholder') {
                    sectionData.placeholderType = section.querySelector('.placeholder-type')?.value || 'text';
                    sectionData.defaultValue = section.querySelector('.placeholder-default')?.value || '';
                }
                
                sections.push(sectionData);
            });
            
            const template = {
                name,
                companyName: (document.getElementById('templateCompanyName')?.value || '').trim(),
                title: (document.getElementById('templateTitle')?.value || '').trim(),
                description: (document.getElementById('templateDescription')?.value || '').trim(),
                category: document.getElementById('templateCategory').value,
                sections,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_template.json`;
            link.click();
        }        // Clear all template data
        function clearTemplate() {
            if (confirm('Are you sure you want to clear all template data? This action cannot be undone.')) {
                document.getElementById('templateName').value = '';
                if (document.getElementById('templateCompanyName')) {
                    document.getElementById('templateCompanyName').value = '';
                }
                if (document.getElementById('templateTitle')) { document.getElementById('templateTitle').value = ''; }
                if (document.getElementById('templateDescription')) { document.getElementById('templateDescription').value = ''; }
                document.getElementById('templateCategory').value = '';
                removeLogo(); // Clear logo
                document.getElementById('sectionsContainer').innerHTML = '';
                sectionCounter = 0;
                updatePreview();
            }
        }

        // Update stats on the page
        function updateStats() {
            const totalTemplates = templates.length;
            const activeTemplates = templates.filter(t => t.status === 'active' || !t.status).length;
            const now = Date.now();
            const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
            const recentTemplates = templates.filter(t => {
                const createdAt = new Date(t.createdAt || 0).getTime();
                return createdAt > oneWeekAgo;
            }).length;
            const draftTemplates = templates.filter(t => t.status === 'draft').length;

            document.getElementById('totalTemplates').textContent = totalTemplates;
            document.getElementById('activeTemplates').textContent = activeTemplates;
            document.getElementById('recentTemplates').textContent = recentTemplates;
            document.getElementById('draftTemplates').textContent = draftTemplates;
        }

        // Load saved templates in the library tab
        function loadSavedTemplates() {
            const container = document.getElementById('savedTemplates');
            
            // Update stats
            updateStats();
            
            if (templates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                        <h3>No Templates Found</h3>
                        <p>Create your first template using the Template Builder</p>
                    </div>
                `;
                return;
            }

            const rows = templates.map((t, idx) => {
                const logoTd = t.logo ? `<img src="${t.logo}" alt="Logo" style=\"height:28px; max-width:60px; object-fit:contain; border-radius:4px;\">` : '<span style="color:#94a3b8;">—</span>';
                const secCount = Array.isArray(t.sections) ? t.sections.length : 0;
                const lm = t.lastModified || t.updatedAt || t.modifiedAt || t.updated_on;
                const cm = t.createdAt || t.created_on;
                const lmText = lm ? new Date(lm).toLocaleString() : '—';
                const cmText = cm ? new Date(cm).toLocaleString() : '—';
                const category = t.category || 'Uncategorized';
                return `
                    <tr>
                        <td style="text-align:center; color:#64748b; padding:.6rem; border-bottom:1px solid #e5e7eb;">${idx + 1}</td>
                        <td style="text-align:center; padding:.6rem; border-bottom:1px solid #e5e7eb;">${logoTd}</td>
                        <td style="padding:.6rem; border-bottom:1px solid #e5e7eb;">${t.name || ''}</td>
                        <td style="padding:.6rem; border-bottom:1px solid #e5e7eb;"><span style="background:#e3f2fd; color:#1976d2; padding:0.15rem 0.4rem; border-radius:4px; font-size:0.8rem;">${category}</span></td>
                        <td style="text-align:center; padding:.6rem; border-bottom:1px solid #e5e7eb;">${secCount}</td>
                        <td style="white-space:nowrap; padding:.6rem; border-bottom:1px solid #e5e7eb;">${lmText}</td>
                        <td style="white-space:nowrap; padding:.6rem; border-bottom:1px solid #e5e7eb;">${cmText}</td>
                        <td style="white-space:nowrap; text-align:center; padding:.4rem .6rem; border-bottom:1px solid #e5e7eb;">
                            <button class="btn btn-info" style="padding:.35rem .5rem;" title="View" aria-label="View" onclick="viewTemplate('${t.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-primary" style="padding:.35rem .5rem;" title="Edit" aria-label="Edit" onclick="loadTemplate('${t.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary" style="padding:.35rem .5rem;" title="Duplicate" aria-label="Duplicate" onclick="duplicateTemplate('${t.id}')"><i class="fas fa-copy"></i></button>
                            <button class="btn btn-danger" style="padding:.35rem .5rem;" title="Delete" aria-label="Delete" onclick="deleteTemplate('${t.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            }).join('');

            container.innerHTML = `
                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white; border:1px solid #e5e7eb;">
                        <thead>
                            <tr style="background:#f8fafc;">
                                <th style="text-align:center; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:60px;">#</th>
                                <th style="text-align:center; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:90px;">Logo</th>
                                <th style="text-align:left; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600;">Template Name</th>
                                <th style="text-align:left; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:160px;">Category</th>
                                <th style="text-align:center; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:120px;">Sections</th>
                                <th style="text-align:left; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:200px;">Last Modified</th>
                                <th style="text-align:left; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:200px;">Created</th>
                                <th style="text-align:center; padding:.6rem; border-bottom:1px solid #e5e7eb; color:#334155; font-weight:600; width:200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>`;
        }// Load a template for editing
        function loadTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
              // Set the currently editing template ID
            currentEditingTemplateId = templateId;
            
            // Update UI to show we're editing
            updateEditingUI();
            
            // Switch to builder tab
            switchTab('builder');
            
            // Clear existing sections
            document.getElementById('sectionsContainer').innerHTML = '';
            sectionCounter = 0;
            
            // Load template data
            document.getElementById('templateName').value = template.name;
            if (document.getElementById('templateCompanyName')) {
                document.getElementById('templateCompanyName').value = template.companyName || '';
            }
            if (document.getElementById('templateTitle')) { document.getElementById('templateTitle').value = template.title || ''; }
            if (document.getElementById('templateDescription')) { document.getElementById('templateDescription').value = template.description || ''; }
            document.getElementById('templateCategory').value = template.category || '';
            // Restore header/footer
            const hs = template.headerSettings || {};
            const fs = template.footerSettings || {};
            if (document.getElementById('enableHeader')) document.getElementById('enableHeader').checked = !!hs.enabled;
            if (document.getElementById('headerAlign')) document.getElementById('headerAlign').value = hs.align || 'center';
            if (document.getElementById('headerContent')) document.getElementById('headerContent').value = hs.content || '';
            if (document.getElementById('enableFooter')) document.getElementById('enableFooter').checked = !!fs.enabled;
            if (document.getElementById('footerAlign')) document.getElementById('footerAlign').value = fs.align || 'center';
            if (document.getElementById('footerContent')) document.getElementById('footerContent').value = fs.content || '';
            
            // Load sections
            template.sections.forEach(section => {
                addSection(section.title, section.content, section.type);
                  // Load extra options
                const sectionElement = document.getElementById(`section_${sectionCounter}`);
                // Restore alignment
                if (section.alignment) {
                    const alignRadio = sectionElement.querySelector(`input.section-align[value="${section.alignment}"]`);
                    if (alignRadio) alignRadio.checked = true;
                }
                if (section.type === 'table' && section.headers) {
                    const headersInput = sectionElement.querySelector('.table-headers');
                    if (headersInput) headersInput.value = section.headers;
                } else if (section.type === 'placeholder') {
                    const typeSelect = sectionElement.querySelector('.placeholder-type');
                    const defaultInput = sectionElement.querySelector('.placeholder-default');
                    if (typeSelect) typeSelect.value = section.placeholderType || 'text';
                    if (defaultInput) defaultInput.value = section.defaultValue || '';
                } else if (section.type === 'textarea') {
                    const readonlyCheckbox = sectionElement.querySelector('.textarea-readonly');
                    const requiredCheckbox = sectionElement.querySelector('.textarea-required');
                    const maxLengthInput = sectionElement.querySelector('.textarea-maxlength');
                    if (readonlyCheckbox) readonlyCheckbox.checked = section.readonly || false;
                    if (requiredCheckbox) requiredCheckbox.checked = section.required || false;
                    if (maxLengthInput) maxLengthInput.value = section.maxLength || '';
                } else if (section.type === 'signature') {
                    const countSel = sectionElement.querySelector('.signature-count');
                    if (countSel) countSel.value = String(section.signatureCount || 2);
                    if (typeof updateSignatureOptionsUI === 'function') updateSignatureOptionsUI(sectionElement.id);
                    const labelsInputs = sectionElement.querySelectorAll('.signature-label');
                    if (labelsInputs && Array.isArray(section.signatureLabels)) {
                        section.signatureLabels.forEach((lbl, idx) => {
                            if (labelsInputs[idx]) labelsInputs[idx].value = lbl || '';
                        });
                    }
                    // Restore per-signature inline stamps (enabled checkbox + image preview)
                    if (Array.isArray(section.inlineStamps)) {
                        const enabledEls = sectionElement.querySelectorAll('.sig-stamp-enabled');
                        const fileEls = sectionElement.querySelectorAll('.sig-stamp-file');
                        const uploaderEls = sectionElement.querySelectorAll('.sig-stamp-uploader');
                        const previewEls = sectionElement.querySelectorAll('.sig-stamp-preview');
                        section.inlineStamps.forEach((st, idx) => {
                            if (!st) return;
                            if (enabledEls[idx]) {
                                enabledEls[idx].checked = !!st.enabled;
                            }
                            if (uploaderEls[idx]) {
                                uploaderEls[idx].style.display = st.enabled ? '' : 'none';
                            }
                            if (fileEls[idx] && st.dataUrl) {
                                fileEls[idx].dataset.stampDataUrl = st.dataUrl;
                                const img = previewEls[idx]?.querySelector('img');
                                if (img) img.src = st.dataUrl;
                                if (previewEls[idx]) previewEls[idx].style.display = '';
                            }
                        });
                    }
                } else if (section.type === 'stamp') {
                    const sizeEl = sectionElement.querySelector('.stamp-size');
                    const circularEl = sectionElement.querySelector('.stamp-circular');
                    const borderEl = sectionElement.querySelector('.stamp-border');
                    const linkSel = sectionElement.querySelector('.stamp-signature-link');
                    const preview = sectionElement.querySelector('.stamp-preview');
                    const img = preview?.querySelector('img');
                    if (sizeEl && section.stampSize) { sizeEl.value = String(section.stampSize); const output = sizeEl.nextElementSibling; if (output && output.tagName === 'OUTPUT') output.value = String(section.stampSize); }
                    if (circularEl) circularEl.checked = !!section.stampCircular;
                    if (borderEl) borderEl.checked = !!section.stampBorder;
                    if (linkSel && section.stampSignatureLink) linkSel.value = section.stampSignatureLink;
                    if (img && section.stampImage) {
                        img.src = section.stampImage;
                        preview.style.display = 'block';
                        sectionElement.dataset.stampImage = section.stampImage;
                    }
                }
            });
            
            // Set logo if available
            setLogo(template.logo);
            // Restore logo positions if present
            if (Array.isArray(template.logoPositions)) {
                setLogoPositions(template.logoPositions);
            } else {
                // Default to Top only if none saved
                setLogoPositions(['top']);
            }
            updatePreview();
        }        // Duplicate a template
        async function duplicateTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            const companyId = companyDataService?.getCurrentCompanyId();
            const duplicatedTemplate = {
                ...template,
                id: Date.now().toString(),
                name: template.name + ' (Copy)',
                logoPositions: Array.isArray(template.logoPositions) ? [...template.logoPositions] : ['top'],
                companyName: template.companyName || '',
                title: template.title || '',
                companyId, // Ensure company scope
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            templates.push(duplicatedTemplate);
            saveTemplateToCompanyScope(templates);
            
            // Save to Firebase Firestore if available
            const savedTemplate = await saveTemplateToFirestore(duplicatedTemplate, companyId);
            if (savedTemplate && savedTemplate.id !== duplicatedTemplate.id) {
                // Update local template with Firebase ID
                const templateIndex = templates.findIndex(t => t.id === duplicatedTemplate.id);
                if (templateIndex !== -1) {
                    templates[templateIndex].id = savedTemplate.id;
                    duplicatedTemplate.id = savedTemplate.id;
                    saveTemplateToCompanyScope(templates);
                }
            }
            
            // Also save to Firebase Realtime Database for contractsub.html compatibility
            await saveTemplateToRealtimeDB(duplicatedTemplate, companyId);
            
            // Ask if user wants to edit the copy immediately
            if (confirm('Template duplicated successfully! Do you want to edit the copy now?')) {
                loadTemplate(duplicatedTemplate.id);
            } else {
                loadSavedTemplates();
            }
        }

        // Delete a template
        async function deleteTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            if (confirm(`Are you sure you want to delete "${template.name}"? This action cannot be undone.`)) {
                // Remove from local array
                templates = templates.filter(t => t.id !== templateId);
                
                // Save updated array to company-scoped storage
                saveTemplateToCompanyScope(templates);
                
                // Delete from Firebase Firestore if available
                await deleteTemplateFromFirestore(templateId);
                
                // Also delete from Firebase Realtime Database for contractsub.html compatibility
                await deleteTemplateFromRealtimeDB(templateId, companyDataService?.getCurrentCompanyId());
                
                // If we were editing this template, clear the editing state
                if (currentEditingTemplateId === templateId) {
                    currentEditingTemplateId = null;
                    updateEditingUI();
                }
                
                loadSavedTemplates();
            }
        }

        // Helper function to delete template from Firebase Firestore
        async function deleteTemplateFromFirestore(templateId) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.firestore();
                        
                        console.log('🗑️ Deleting template from Firestore:', templateId);
                        await db.collection('documentTemplates').doc(templateId).delete();
                        console.log('✅ Template deleted from Firestore');
                    }
                }
            } catch (error) {
                console.error('Error deleting template from Firestore:', error);
            }
        }

        // Helper function to delete template from Firebase Realtime Database
        async function deleteTemplateFromRealtimeDB(templateId, companyId) {
            if (!companyId) {
                console.warn('No company ID provided for Realtime Database delete');
                return;
            }

            try {
                if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                    const firebaseInstance = initializeFirebase();
                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                        const db = firebaseInstance.database();
                        
                        console.log('🗑️ Deleting template from Realtime Database:', templateId);
                        await db.ref(`companies/${companyId}/documentTemplates/${templateId}`).remove();
                        
                        // Trigger real-time notification for contractsub.html
                        const notificationRef = db.ref(`companies/${companyId}/templateUpdates`);
                        await notificationRef.set({
                            templateId: templateId,
                            action: 'deleted',
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        console.log('✅ Template deleted from Realtime Database with real-time notification');
                    }
                }
            } catch (error) {
                console.error('Error deleting template from Realtime Database:', error);
            }
        }        // Add initial section on page load
        window.addEventListener('load', function() {
            if (document.querySelectorAll('.section-item').length === 0) {
                addSection('Introduction', 'Welcome to our document template system.');
            }
        });

        // Character counter for textarea sections
        function setupTextareaCounters() {
            document.querySelectorAll('.section-content').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const section = this.closest('.section-item');
                    if (section && section.querySelector('.section-type').value === 'textarea') {
                        const maxLength = section.querySelector('.textarea-maxlength')?.value;
                        if (maxLength) {
                            const currentLength = this.value.length;
                            const counter = section.querySelector('.character-counter');
                            if (counter) {
                                counter.textContent = `${currentLength}/${maxLength}`;
                                counter.style.color = currentLength > maxLength * 0.9 ? '#dc3545' : '#6c757d';
                            }
                        }
                        updatePreview();
                    }
                });
            });
        }

        // Update character counter when textarea settings change
        function updateTextareaCounter(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const textarea = section.querySelector('.section-content');
            const maxLengthInput = section.querySelector('.textarea-maxlength');
            const extraOptions = section.querySelector('#extraOptions_' + sectionId.split('_')[1]);
            
            if (textarea && maxLengthInput && extraOptions) {
                const maxLength = maxLengthInput.value;
                let counterDiv = extraOptions.querySelector('.character-counter-container');
                
                if (maxLength && maxLength > 0) {
                    if (!counterDiv) {
                        counterDiv = document.createElement('div');
                        counterDiv.className = 'character-counter-container';
                        counterDiv.style.cssText = 'margin-top: 0.5rem; text-align: right;';
                        extraOptions.appendChild(counterDiv);
                    }
                    
                    const currentLength = textarea.value.length;
                    counterDiv.innerHTML = `
                        <small class="character-counter" style="color: ${currentLength > maxLength * 0.9 ? '#dc3545' : '#6c757d'};">
                            ${currentLength}/${maxLength} characters
                        </small>
                    `;
                } else if (counterDiv) {
                    counterDiv.remove();
                }
            }
        }

        // Start a new template (clear editing state)
        function newTemplate() {
            if (currentEditingTemplateId && confirm('You are currently editing a template. Do you want to start a new template? Unsaved changes will be lost.')) {
                clearTemplateForm();
            } else if (!currentEditingTemplateId) {
                clearTemplateForm();
            }
            // Default logo position for new template
            if (typeof setLogoPositions === 'function') setLogoPositions(['top']);
            // Auto-fill company name if available
            const cnEl = document.getElementById('templateCompanyName');
            if (cnEl && !cnEl.value && window.companyDataService && typeof window.companyDataService.getCurrentCompanyName === 'function') {
                const inferred = window.companyDataService.getCurrentCompanyName();
                if (inferred) {
                    cnEl.value = inferred;
                    if (typeof updatePreview === 'function') updatePreview();
                }
            }
        }
          // Clear the template form and reset editing state
        function clearTemplateForm() {
            currentEditingTemplateId = null;
            
            // Clear form fields
            document.getElementById('templateName').value = '';
            if (document.getElementById('templateCompanyName')) {
                document.getElementById('templateCompanyName').value = '';
            }
            if (document.getElementById('templateDescription')) { document.getElementById('templateDescription').value = ''; }
            document.getElementById('templateCategory').value = '';
            
            // Clear logo
            removeLogo();
            // Reset logo positions
            if (typeof setLogoPositions === 'function') setLogoPositions(['top']);
            
            // Clear sections
            document.getElementById('sectionsContainer').innerHTML = '';
            sectionCounter = 0;
            
            // Update UI to show we're creating a new template
            updateEditingUI();
            
            // Clear preview
            updatePreview();
            
            console.log('Started new template');
        }
        
        // Migrate existing templates to dual-storage (one-time migration helper)
        async function migrateTemplatesToDualStorage() {
            const companyId = companyDataService?.getCurrentCompanyId();
            if (!companyId) {
                alert('Please ensure you are logged in with a company account before migrating templates.');
                return;
            }

            const confirmMigration = confirm('This will migrate all your existing templates to ensure they appear in contract creation. Continue?');
            if (!confirmMigration) return;

            const templates = JSON.parse(localStorage.getItem(`documentTemplates_${companyId}`) || '[]');
            let migratedCount = 0;

            console.log(`🔄 Starting migration of ${templates.length} templates...`);

            for (const template of templates) {
                try {
                    // Save to both Firestore and Realtime Database
                    await saveTemplateToFirestore(template, companyId);
                    await saveTemplateToRealtimeDB(template, companyId);
                    migratedCount++;
                    console.log(`✅ Migrated template: ${template.name}`);
                } catch (error) {
                    console.error(`❌ Failed to migrate template: ${template.name}`, error);
                }
            }

            alert(`Migration complete! ${migratedCount} templates have been migrated to dual-storage.`);
            loadSavedTemplates();
        }
        
        // Update UI elements based on editing state
        function updateEditingUI() {
            const saveBtn = document.getElementById('saveTemplateBtn');
            const editingIndicator = document.getElementById('editingIndicator');
            
            if (currentEditingTemplateId) {
                // We're editing an existing template
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Template';
                saveBtn.className = 'btn btn-warning';
                editingIndicator.style.display = 'inline';
                console.log('UI updated for editing mode');
            } else {
                // We're creating a new template
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Template';
                saveBtn.className = 'btn btn-success';
                editingIndicator.style.display = 'none';
                console.log('UI updated for new template mode');
            }
        }

        // Initialize template builder on page load
        function initializeTemplateBuilder() {
            // Ensure we start in new template mode
            currentEditingTemplateId = null;
            updateEditingUI();
            
            // Add initial section if none exist
            if (document.querySelectorAll('.section-item').length === 0) {
                addSection('Introduction', 'Welcome to our document template system.');
            }

            // Wire company name input change to preview
            const companyNameInput = document.getElementById('templateCompanyName');
            if (companyNameInput) {
                companyNameInput.addEventListener('input', () => updatePreview());
            }
            const titleInput = document.getElementById('templateTitle');
            if (titleInput) {
                titleInput.addEventListener('input', () => updatePreview());
            }

            // Try to auto-fill company name from context
            try {
                const inputEl = document.getElementById('templateCompanyName');
                if (inputEl && !inputEl.value) {
                    let inferredName = '';
                    // Prefer companyDataService if available
                    if (window.companyDataService) {
                        // Attempt to pull from current company data in localStorage
                        const companyId = window.companyDataService.getCurrentCompanyId?.();
                        const companiesRaw = localStorage.getItem('companyData');
                        if (companiesRaw) {
                            const companies = JSON.parse(companiesRaw);
                            const company = companies?.[companyId];
                            inferredName = company?.name || company?.companyName || '';
                        }
                        // Fallback to helper (added below) if present
                        if (!inferredName && typeof window.companyDataService.getCurrentCompanyName === 'function') {
                            inferredName = window.companyDataService.getCurrentCompanyName();
                        }
                    }
                    // Fallback to authManager currentCompany
                    if (!inferredName && window.authManager && window.authManager.currentCompany) {
                        const cc = window.authManager.currentCompany;
                        inferredName = cc.name || cc.companyName || '';
                    }
                    if (inferredName) {
                        inputEl.value = inferredName;
                        updatePreview();
                    }
                }
            } catch (e) {
                console.warn('Company name auto-fill skipped:', e);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTemplateBuilder();
        });

        // ===============================
        // LOGO HANDLING FUNCTIONS
        // ===============================

        // Handle logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Logo file size must be less than 2MB');
                return;
            }

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (PNG, JPG, or SVG)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const logoData = e.target.result;
                displayLogoPreview(logoData);
                updatePreview(); // Update the template preview
            };
            reader.readAsDataURL(file);
        }

        // Display logo preview
        function displayLogoPreview(logoData) {
            const logoPreview = document.getElementById('logoPreview');
            const logoImage = document.getElementById('logoImage');
            const logoUploadPrompt = document.getElementById('logoUploadPrompt');
            const removeLogoBtn = document.getElementById('removeLogoBtn');
            const logoUploadArea = document.getElementById('logoUploadArea');

            logoImage.src = logoData;
            logoPreview.style.display = 'block';
            if (logoUploadPrompt) logoUploadPrompt.style.display = 'none';
            removeLogoBtn.style.display = 'inline-block';
            logoUploadArea.style.borderColor = '#28a745';
            logoUploadArea.style.backgroundColor = '#f8fff9';
            // Update the preview to reflect the uploaded logo
            if (typeof updatePreview === 'function') updatePreview();
        }

        // Remove logo
        function removeLogo() {
            const logoPreview = document.getElementById('logoPreview');
            const logoImage = document.getElementById('logoImage');
            const logoUploadPrompt = document.getElementById('logoUploadPrompt');
            const removeLogoBtn = document.getElementById('removeLogoBtn');
            const logoUploadArea = document.getElementById('logoUploadArea');
            const logoInput = document.getElementById('logoInput');

            logoImage.src = '';
            logoPreview.style.display = 'none';
            if (logoUploadPrompt) logoUploadPrompt.style.display = 'block';
            removeLogoBtn.style.display = 'none';
            logoUploadArea.style.borderColor = '#e9ecef';
            logoUploadArea.style.backgroundColor = 'transparent';
            logoInput.value = '';
            // Update the template preview after removing the logo
            if (typeof updatePreview === 'function') updatePreview();
        }

        // Get current logo data
        function getCurrentLogo() {
            const logoImage = document.getElementById('logoImage');
            return logoImage.src || null;
        }

        // Set logo from data (used when loading templates)
        function setLogo(logoData) {
            if (logoData) {
                displayLogoPreview(logoData);
            } else {
                removeLogo();
            }
        }

        // Drag and drop functionality for logo upload and logo position controls
        document.addEventListener('DOMContentLoaded', function() {
            const logoUploadArea = document.getElementById('logoUploadArea');
            
            if (logoUploadArea) {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    logoUploadArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop area when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    logoUploadArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    logoUploadArea.addEventListener(eventName, unhighlight, false);
                });

                // Handle dropped files
                logoUploadArea.addEventListener('drop', handleDrop, false);
            }

            // Hook up logo position checkboxes to live update the preview
            ['logoPosTop','logoPosBottom','logoPosLeft','logoPosRight'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => {
                    if (typeof updatePreview === 'function') updatePreview();
                });
            });
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            const logoUploadArea = document.getElementById('logoUploadArea');
            logoUploadArea.style.borderColor = '#007bff';
            logoUploadArea.style.backgroundColor = '#f8f9ff';
        }

        function unhighlight(e) {
            const logoUploadArea = document.getElementById('logoUploadArea');
            const logoPreview = document.getElementById('logoPreview');
            
            if (logoPreview.style.display === 'none') {
                logoUploadArea.style.borderColor = '#e9ecef';
                logoUploadArea.style.backgroundColor = 'transparent';
            } else {
                logoUploadArea.style.borderColor = '#28a745';
                logoUploadArea.style.backgroundColor = '#f8fff9';
            }
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const logoInput = document.getElementById('logoInput');
                logoInput.files = files;
                handleLogoUpload({ target: { files: files } });
            }
        }

        // ===============================
        // END LOGO HANDLING
        // ===============================

        // Helpers for logo position selection
        function getSelectedLogoPositions() {
            const positions = [];
            if (document.getElementById('logoPosTop')?.checked) positions.push('top');
            if (document.getElementById('logoPosBottom')?.checked) positions.push('bottom');
            if (document.getElementById('logoPosLeft')?.checked) positions.push('left');
            if (document.getElementById('logoPosRight')?.checked) positions.push('right');
            return positions;
        }

        function setLogoPositions(positions) {
            const set = new Set(positions || []);
            const map = {
                top: document.getElementById('logoPosTop'),
                bottom: document.getElementById('logoPosBottom'),
                left: document.getElementById('logoPosLeft'),
                right: document.getElementById('logoPosRight')
            };
            Object.entries(map).forEach(([pos, el]) => { if (el) el.checked = set.has(pos); });
        }
    </script>

    <!-- All Firebase dependencies replaced with local storage -->

    <script>
        // Local Configuration (Firebase URLs removed for self-contained operation)
        const localConfig = {
            appName: 'Document Creator',
            version: '1.0.0',
            offlineMode: true
        };

        // Local app initialization (Firebase dependency removed)
    </script>

    <!-- All external dependencies have been embedded -->
    <script>
        // Company Data Service and Centralized Auth Manager (embedded for self-contained operation)
        const companyDataService = {
            currentCompanyId: localStorage.getItem('currentCompanyId'),
            
            getCurrentCompanyId() {
                return this.currentCompanyId || localStorage.getItem('currentCompanyId');
            },
            getCurrentCompanyName() {
                try {
                    const id = this.getCurrentCompanyId();
                    const companies = JSON.parse(localStorage.getItem('companyData') || '{}');
                    const company = companies?.[id];
                    return company?.name || company?.companyName || '';
                } catch {
                    return '';
                }
            },
            
            setCurrentCompanyId(companyId) {
                this.currentCompanyId = companyId;
                localStorage.setItem('currentCompanyId', companyId);
            },
            
            initializeUserContext() {
                const user = localAuth.getCurrentUser();
                if (user && user.companyId) {
                    this.setCurrentCompanyId(user.companyId);
                }
                
                // Initialize default company data if none exists
                this.initializeDefaultCompanyData();
                return Promise.resolve();
            },
            
            initializeDefaultCompanyData() {
                const existingData = localStorage.getItem('companyData');
                if (!existingData) {
                    const defaultCompanyData = {
                        'dreamex-datalab': {
                            id: 'dreamex-datalab',
                            name: 'Dreamex Datalab',
                            companyName: 'Dreamex Datalab', // Add companyName property for compatibility
                            logo: null, // No logo by default
                            logoUrl: null, // Add logoUrl property for compatibility
                            settings: {
                                primaryColor: '#2c3e50',
                                secondaryColor: '#3498db'
                            },
                            branding: {
                                primaryColor: '#2c3e50',
                                secondaryColor: '#3498db'
                            }
                        }
                    };
                    localStorage.setItem('companyData', JSON.stringify(defaultCompanyData));
                }
                
                // Set default company if no current company is selected
                if (!this.getCurrentCompanyId()) {
                    this.setCurrentCompanyId('dreamex-datalab');
                }
            }
        };

        window.companyDataService = companyDataService;

        // Centralized Authentication Manager (embedded from auth.js for self-contained operation)
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = null; // Will use localStorage for self-contained operation
                this.currentCompany = null;
                this.initializeAuth();
            }
            
            getCurrentUser() {
                // First check for 'currentUser' key (used by main login system)
                let user = localStorage.getItem('currentUser');
                if (user) {
                    console.log('✅ Found user in currentUser key');
                    return JSON.parse(user);
                }
                
                // If not found, check for 'user' key (used by index.html modal login)
                user = localStorage.getItem('user');
                if (user) {
                    console.log('✅ Found user in user key - migrating to currentUser');
                    const userData = JSON.parse(user);
                    // Migrate the user data to the standard 'currentUser' key for consistency
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    localStorage.removeItem('user'); // Clean up old key
                    return userData;
                }
                
                // Also check for other possible login keys used by the system
                const possibleKeys = ['authUser', 'loggedInUser', 'sessionUser'];
                for (const key of possibleKeys) {
                    user = localStorage.getItem(key);
                    if (user) {
                        console.log(`✅ Found user in ${key} key - migrating to currentUser`);
                        const userData = JSON.parse(user);
                        localStorage.setItem('currentUser', JSON.stringify(userData));
                        return userData;
                    }
                }
                
                console.log('❌ No user found in any localStorage key');
                return null;
            }
            
            setCurrentUser(user) {
                this.currentUser = user;
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    localStorage.removeItem('currentUser');
                }
            }
            
            initializeAuth() {
                // For dochtml.html, we'll initialize only if we have a real user
                if (this.currentUser) {
                    console.log('Initializing with logged-in user:', this.currentUser.displayName || this.currentUser.email);
                    this.loadUserCompany();
                    this.updateUIForAuthenticatedUser();
                } else {
                    console.warn('No user found - user must log in from index.html');
                    // Redirect to login if no user is found
                    window.location.href = 'index.html';
                }
            }
            
            async loadUserCompany() {
                if (!this.currentUser) return;
                
                try {
                    // Get user's company information from company data service
                    if (window.companyDataService) {
                        await window.companyDataService.initializeUserContext();
                        const companyId = window.companyDataService.getCurrentCompanyId();
                        
                        if (companyId) {
                            console.log('🏢 Loading company data from Firebase for ID:', companyId);
                            
                            // Try to load company data from Firebase Database first (like roles.html)
                            if (typeof firebase !== 'undefined' && firebase.database && typeof initializeFirebase === 'function') {
                                try {
                                    const firebaseInstance = initializeFirebase();
                                    if (firebaseInstance && firebaseInstance.apps.length > 0) {
                                        const db = firebaseInstance.database();
                                        const companyRef = db.ref(`companies/${companyId}`);
                                        
                                        console.log('🔍 Fetching company data from Firebase Database...');
                                        const companySnapshot = await companyRef.once('value');
                                        
                                        if (companySnapshot.exists()) {
                                            this.currentCompany = companySnapshot.val();
                                            console.log('✅ Company data loaded from Firebase:', this.currentCompany);
                                            
                                            // Check for company logo in Firebase Storage if no direct URL
                                            if (!this.currentCompany.logo && !this.currentCompany.logoUrl) {
                                                console.log('🔍 No direct logo URL, checking Firebase Storage...');
                                                await this.loadCompanyLogoFromStorage(companyId);
                                            }
                                            
                                            this.updateCompanyBranding();
                                            return;
                                        } else {
                                            console.log('ℹ️ No company data found in Firebase Database');
                                        }
                                    }
                                } catch (firebaseError) {
                                    console.log('Firebase Database not available:', firebaseError);
                                }
                            }
                            
                            // Fallback to localStorage company data
                            console.log('🔄 Falling back to localStorage company data...');
                            const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
                            this.currentCompany = companyData[companyId];
                            this.updateCompanyBranding();
                        } else {
                            console.warn('No company context found for user');
                        }
                    } else {
                        console.warn('Company data service not available');
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }
            
            // Load company logo from Firebase Storage (SVG support)
            async loadCompanyLogoFromStorage(companyId) {
                if (!companyId) return null;
                
                try {
                    if (typeof firebase !== 'undefined' && firebase.storage && typeof initializeFirebase === 'function') {
                        const firebaseInstance = initializeFirebase();
                        if (firebaseInstance && firebaseInstance.apps.length > 0) {
                            const storage = firebaseInstance.storage();
                            
                            // Try different possible logo file formats (prioritize SVG)
                            const logoFormats = ['logo.svg', 'logo.png', 'logo.jpg', 'logo.jpeg'];
                            
                            for (const format of logoFormats) {
                                try {
                                    const logoPath = `companies/${companyId}/${format}`;
                                    console.log(`🔍 Checking Firebase Storage for: ${logoPath}`);
                                    
                                    const logoRef = storage.ref(logoPath);
                                    const logoUrl = await logoRef.getDownloadURL();
                                    
                                    console.log(`✅ Company logo found in Firebase Storage (${format}):`, logoUrl);
                                    
                                    // Update the current company data with the logo URL
                                    if (this.currentCompany) {
                                        this.currentCompany.logoUrl = logoUrl;
                                        this.currentCompany.logo = logoUrl;
                                    }
                                    
                                    return logoUrl;
                                } catch (formatError) {
                                    console.log(`❌ ${format} not found in Firebase Storage`);
                                    continue;
                                }
                            }
                            
                            console.log('ℹ️ No company logo found in Firebase Storage');
                        }
                    }
                } catch (error) {
                    console.log('Error loading company logo from Firebase Storage:', error);
                }
                
                return null;
            }
            
            async updateUIForAuthenticatedUser() {
                const profileBtn = document.querySelector('.profile-btn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();

                        // Update header avatar image using centralized method
                        await this.updateUserAvatarDisplay('userAvatar');

                        // Prepare avatar block for dropdown (match contractsub.html)
                        let avatarUrl = null;
                        try { avatarUrl = await this.getUserAvatarUrl(); } catch (e) { /* ignore */ }
                        const avatarHtml = avatarUrl
                            ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`
                            : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${initials}</div>`;

                        // Build dropdown HTML exactly like contractsub.html (name + email header, then links)
                        const dropdownHtml = `
                            <li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    ${avatarHtml}
                                    <div>
                                        <div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div>
                                        <div style="color:#666;font-size:12px;">${email}</div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                            <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
                            <li><a href="#" onclick="authManager.logout()"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
                        `;

                        profileDropdown.innerHTML = dropdownHtml;
                    }
                }
                
                // Update company branding
                this.updateCompanyBranding();
            }
            
            getUserInitials() {
                if (!this.currentUser) return 'U';
                
                const displayName = this.getUserDisplayName();
                return displayName.split(' ').map(name => name.charAt(0).toUpperCase()).join('').slice(0, 2);
            }
            
            getUserDisplayName() {
                if (!this.currentUser) return 'User';

                const u = this.currentUser;
                const clean = (s) => {
                    if (typeof s !== 'string') return '';
                    const t = s.trim();
                    if (!t) return '';
                    const lower = t.toLowerCase();
                    return (lower === 'null' || lower === 'undefined' || lower === 'na') ? '' : t;
                };

                // Try common full name fields first (dashboard-style)
                const fullName = clean(u.fullName) || clean(u.name);
                if (fullName) return fullName;

                // Build from first/last across potential nesting
                const first = clean(u.firstName) || clean(u.first_name) || clean(u.givenName) || clean(u.given_name) || clean(u.profile?.firstName) || clean(u.profile?.first_name) || clean(u.userProfile?.firstName);
                const last  = clean(u.lastName)  || clean(u.last_name)  || clean(u.familyName) || clean(u.family_name) || clean(u.profile?.lastName)  || clean(u.profile?.last_name)  || clean(u.userProfile?.lastName);
                const built = [first, last].filter(Boolean).join(' ').trim();
                if (built) return built;

                // Next, typical identity display fields
                const candidate = clean(u.displayName) || clean(u.username) || clean(u.nickName) || clean(u.nickname);
                if (candidate) return candidate;

                // Fallback to email local-part
                if (u.email && typeof u.email === 'string') {
                    const local = clean(u.email.split('@')[0] || '');
                    if (local) return local;
                }

                return 'User';
            }
            
            getUserEmail() {
                if (!this.currentUser) return '';
                return this.currentUser.email || '';
            }
            
            // Centralized method to get user avatar URL (company-scoped only)
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;

                try {
                    const companyId = this.currentUser.companyId || 'default';
                    const cacheKey = `profilePicture_${this.currentUser.uid}`;
                    const expectedEncodedPrefix = `companies%2F${companyId}%2Favatars%2F${this.currentUser.uid}%2F`;

                    // 1) Local cache first, but only if pointing to company scope
                    const cachedUrl = localStorage.getItem(cacheKey);
                    if (cachedUrl && cachedUrl !== 'null' && cachedUrl !== '' && cachedUrl.includes(expectedEncodedPrefix)) {
                        return cachedUrl;
                    } else if (cachedUrl) {
                        // Remove non-company-scoped cache
                        localStorage.removeItem(cacheKey);
                    }

                    // 2) Direct profile photoURL, only if company-scoped
                    if (this.currentUser.photoURL && this.currentUser.photoURL !== 'null' && this.currentUser.photoURL.includes(expectedEncodedPrefix)) {
                        localStorage.setItem(cacheKey, this.currentUser.photoURL);
                        return this.currentUser.photoURL;
                    }

                    // 3) Try Firebase Storage company-scoped paths only (multiple extensions)
                    if (typeof firebase !== 'undefined' && typeof initializeFirebase === 'function') {
                        try {
                            const fb = initializeFirebase();
                            if (fb && fb.storage && fb.apps.length > 0) {
                                const possiblePaths = [
                                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
                                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
                                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
                                    `companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
                                    `companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`
                                ];

                                for (const path of possiblePaths) {
                                    try {
                                        const url = await fb.storage().ref(path).getDownloadURL();
                                        // Cache and return
                                        localStorage.setItem(cacheKey, url);
                                        return url;
                                    } catch (e) {
                                        // Continue to next path
                                        continue;
                                    }
                                }
                            }
                        } catch (firebaseError) {
                            console.log('Firebase Storage not available:', firebaseError);
                        }
                    }

                    return null;
                } catch (error) {
                    console.log('No custom avatar found:', error);
                    return null;
                }
            }
            
            // Centralized method to update user avatar display (matches auth.js exactly)
            async updateUserAvatarDisplay(elementId = 'userAvatar') {
                const avatarElement = document.getElementById(elementId);
                if (!avatarElement) {
                    console.warn(`Avatar element with id '${elementId}' not found`);
                    return;
                }

                try {
                    const avatarUrl = await this.getUserAvatarUrl();
                    if (avatarUrl) {
                        // Show custom avatar - replace entire element content like roles.html
                        if (avatarElement.tagName === 'IMG') {
                            avatarElement.src = avatarUrl;
                            avatarElement.alt = 'Profile Picture';
                            avatarElement.onerror = () => {
                                // Fallback to initials if image fails to load
                                const initials = this.getUserInitials();
                                const initialsDataUri = this.generateInitialsDataUri(initials);
                                avatarElement.src = initialsDataUri;
                                avatarElement.alt = `${initials} Avatar`;
                                console.log('Image failed to load, using initials fallback');
                            };
                        } else {
                            avatarElement.innerHTML = `<img src="${avatarUrl}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${this.getUserInitials()}';">`;
                        }
                        console.log('✅ Displaying custom avatar from:', avatarUrl);
                    } else {
                        // Show initials - replace with text or data URI
                        this.displayInitials(avatarElement);
                        console.log('✅ Displaying initials:', this.getUserInitials());
                    }
                } catch (error) {
                    // Fallback to initials on any error
                    this.displayInitials(avatarElement);
                    console.log('Fallback to initials due to error:', error);
                }
            }

            // Helper method to display initials
            displayInitials(avatarElement) {
                const initials = this.getUserInitials();
                if (avatarElement.tagName === 'IMG') {
                    const initialsDataUri = this.generateInitialsDataUri(initials);
                    avatarElement.src = initialsDataUri;
                    avatarElement.alt = `${initials} Avatar`;
                } else {
                    avatarElement.textContent = initials;
                }
            }
            
            // Generate a data URI with user initials (for img elements)
            generateInitialsDataUri(initials) {
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="#3498db"/>
                        <text x="20" y="26" font-family="Arial, sans-serif" font-size="14" font-weight="600" text-anchor="middle" fill="white">${initials}</text>
                    </svg>
                `;
                return `data:image/svg+xml;base64,${btoa(svg)}`;
            }

            // Generate initials avatar (dashboard.html compatibility method)
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }
            
            updateCompanyBranding() {
                console.log('🏢 updateCompanyBranding() called');
                
                // First try to use Firebase-loaded company data
                if (this.currentCompany) {
                    console.log('✅ Using Firebase-loaded company data:', this.currentCompany);
                    this.displayCompanyBranding(this.currentCompany);
                    return;
                }
                
                // Fallback to localStorage-based approach
                const companyId = companyDataService.getCurrentCompanyId();
                console.log('Updating company branding for:', companyId);
                
                const logoElement = document.getElementById('headerCompanyLogo');
                const placeholderElement = document.getElementById('headerLogoPlaceholder');
                const companyNameElement = document.getElementById('headerCompanyName');
                
                if (!companyId) {
                    // No company selected - do not set a default name; keep empty like project-list
                    if (companyNameElement) {
                        companyNameElement.textContent = '';
                    }
                    // Show placeholder
                    if (placeholderElement) {
                        placeholderElement.style.display = 'flex';
                    }
                    if (logoElement) {
                        logoElement.classList.remove('visible');
                        logoElement.style.display = 'none';
                    }
                    return;
                }
                
                const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
                const company = companyData[companyId];
                console.log('Company data:', company);
                
                if (company) {
                    this.displayCompanyBranding(company);
                } else {
                    // Company data not found - keep name empty
                    if (companyNameElement) {
                        companyNameElement.textContent = '';
                    }
                    // Show placeholder
                    if (placeholderElement) {
                        placeholderElement.style.display = 'flex';
                    }
                    if (logoElement) {
                        logoElement.classList.remove('visible');
                        logoElement.style.display = 'none';
                    }
                }
            }
            
            // Display company branding (works with both Firebase and localStorage data)
            displayCompanyBranding(company) {
                const logoElement = document.getElementById('headerCompanyLogo');
                const placeholderElement = document.getElementById('headerLogoPlaceholder');
                const companyNameElement = document.getElementById('headerCompanyName');
                
                console.log('🎨 Displaying company branding:', company);
                
                // Check for logo URL (try both 'logo' and 'logoUrl' properties like staff.html)
                const logoUrl = company.logo || company.logoUrl;
                console.log('🖼️ Company logo check:', {
                    logo: company.logo || 'Not found',
                    logoUrl: company.logoUrl || 'Not found',
                    finalUrl: logoUrl || 'None available'
                });
                
                if (logoUrl && logoUrl.trim() !== '' && logoElement) {
                    console.log('✅ Displaying company logo:', logoUrl);
                    logoElement.src = logoUrl;
                    logoElement.classList.add('visible');
                    logoElement.style.display = 'block';
                    if (placeholderElement) placeholderElement.style.display = 'none';
                } else {
                    console.log('ℹ️ No company logo URL available, showing placeholder');
                    // Show placeholder when no logo
                    if (placeholderElement) {
                        placeholderElement.style.display = 'flex';
                    }
                    if (logoElement) {
                        logoElement.classList.remove('visible');
                        logoElement.style.display = 'none';
                    }
                }
                
                // Update company name (try multiple possible property names)
                const companyName = company.name || company.companyName || '';
                if (companyNameElement) {
                    companyNameElement.textContent = companyName;
                }
                
                console.log('✅ Company branding updated');
            }
            
            logout() {
                this.setCurrentUser(null);
                window.location.href = 'login.html';
            }
        }

        // Create global authManager instance (matches other pages)
        const authManager = new AuthManager();
        window.authManager = authManager;

        // Debug function to test profile picture display (centralized approach)
        function testProfilePicture() {
            const user = authManager.getCurrentUser();
            if (user) {
                console.log('Testing profile picture for user:', user);
                console.log('Current user photoURL:', user.photoURL);
                console.log('Cached photoURL:', localStorage.getItem(`profilePicture_${user.uid}`));
                authManager.updateUserAvatarDisplay('userAvatar');
            } else {
                console.log('No user found for testing');
            }
        }

        // Make test function available globally for debugging
        window.testProfilePicture = testProfilePicture;
        
        // Debug function to test company logo display
        function testCompanyLogo() {
            console.log('🧪 Testing company logo functionality...');
            
            const companyId = companyDataService.getCurrentCompanyId();
            const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
            const currentCompany = companyData[companyId];
            
            console.log('Debug info:', {
                currentCompanyId: companyId,
                companyData: companyData,
                currentCompany: currentCompany,
                firebaseCompany: authManager.currentCompany,
                hasLocalStorageLogo: !!(currentCompany && (currentCompany.logo || currentCompany.logoUrl)),
                hasFirebaseLogo: !!(authManager.currentCompany && (authManager.currentCompany.logo || authManager.currentCompany.logoUrl)),
                logoElement: document.getElementById('headerCompanyLogo'),
                placeholderElement: document.getElementById('headerLogoPlaceholder')
            });
            
            // Test Firebase loading
            if (typeof firebase !== 'undefined' && firebase.database) {
                console.log('🔥 Firebase is available - testing company data loading...');
                authManager.loadUserCompany().then(() => {
                    console.log('✅ Firebase company loading completed');
                    authManager.updateCompanyBranding();
                    // Ensure sidebar gating updates after company context resolves
                    if (typeof window.updateMenuWithFeatureAuthorization === 'function') {
                        setTimeout(() => window.updateMenuWithFeatureAuthorization(), 150);
                    }
                });
            } else {
                console.log('ℹ️ Firebase not available - using localStorage fallback');
                // Force update with localStorage data
                authManager.updateCompanyBranding();
            }
        }
        
        // Make company logo test function available globally
        window.testCompanyLogo = testCompanyLogo;
    </script>

        <!-- Role + Feature-based Menu Authorization (mirrors project-list.html) -->
        <script>
        // Prevent concurrent updates
        let isMenuUpdateInProgress = false;

        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(el => el.classList.remove('menu-visible'));
            document.querySelectorAll('.menu-dropdown').forEach(el => el.classList.remove('menu-visible'));
        }

        function ensureHomeIsVisible() {
            const home = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
            if (home && !home.classList.contains('menu-visible')) home.classList.add('menu-visible');
        }

        function showSidebarAfterAuth() {
            const sidebar = document.getElementById('sidebar');
            // After we finish computing visibility, enable gating so hidden items are actually hidden
            if (sidebar) sidebar.classList.add('menu-gated');
        }

        async function updateMenuWithFeatureAuthorization() {
            if (isMenuUpdateInProgress) return;
            isMenuUpdateInProgress = true;
            console.log('🔄 Starting menu authorization...');
            try {
                let currentUser = null, companyId = null, userRole = null;
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                } else if (firebase && firebase.auth && firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                }

                console.log('📋 Authorization context:', { currentUser: currentUser?.email, companyId, userRole });

                // Resolve company if missing
                if (!companyId && currentUser && typeof firebase !== 'undefined' && firebase.database) {
                    try {
                        const companiesSnap = await firebase.database().ref('companies').once('value');
                        if (companiesSnap.exists()) {
                            const companies = companiesSnap.val();
                            for (const [cId, company] of Object.entries(companies)) {
                                if (company?.status !== 'active') continue;
                                if (company?.users && company.users[currentUser.uid]) {
                                    companyId = cId;
                                    userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                                    console.log('🏢 Found company via Firebase:', { companyId, userRole });
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Company resolution via Firebase failed, will try local fallback:', e);
                    }
                }

                // Local fallback company resolution (dashboard-style)
                if (!companyId && window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                    companyId = window.companyDataService.getCurrentCompanyId();
                    console.log('🏢 Found company via companyDataService:', companyId);
                }
                if (!userRole && currentUser) {
                    userRole = currentUser.role || currentUser.userRole || currentUser.position || null;
                    console.log('👤 Found user role:', userRole);
                }

                if (!companyId) { 
                    console.warn('❌ No company ID found - showing default menu');
                    resetMenuVisibility(); ensureHomeIsVisible(); showSidebarAfterAuth(); return; 
                }

                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                if (userRole) {
                    await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                } else {
                    // No role found: keep company feature visibility as-is
                    console.warn('⚠️ No user role found - applying feature-only filtering');
                    showSidebarAfterAuth();
                }
            } catch (e) {
                console.error('Menu authorization error:', e);
                resetMenuVisibility();
                ensureHomeIsVisible();
                showSidebarAfterAuth();
            } finally {
                isMenuUpdateInProgress = false;
            }
        }

        async function applyFeatureBasedMenuVisibility(companyId) {
            console.log('🎯 Applying feature-based menu visibility for company:', companyId);
            try {
                let featuresData = null;
                let company = null;
                let selected = [];
                let authorizedPages = [];

                const firebaseAvailable = (typeof firebase !== 'undefined') && firebase.database;
                if (firebaseAvailable) {
                    try {
                        const [featuresSnap, companySnap] = await Promise.all([
                            firebase.database().ref('/platformFeatures').once('value'),
                            firebase.database().ref(`/companies/${companyId}`).once('value')
                        ]);
                        if (featuresSnap.exists()) featuresData = featuresSnap.val();
                        if (companySnap.exists()) company = companySnap.val();
                        console.log('📊 Firebase data loaded:', { 
                            featuresCount: featuresData ? Object.keys(featuresData).length : 0, 
                            companyFound: !!company 
                        });
                    } catch (dbErr) {
                        console.warn('Firebase feature/company fetch failed, will use local fallback:', dbErr);
                    }
                }

                // Local fallback (dashboard-style)
                if (!company) {
                    const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
                    company = companyData[companyId] || null;
                    console.log('💾 Local company data:', company ? 'found' : 'not found');
                }
                if (!featuresData) {
                    // Try local cache of platformFeatures if present
                    featuresData = JSON.parse(localStorage.getItem('platformFeatures') || 'null');
                    console.log('💾 Local platform features:', featuresData ? Object.keys(featuresData).length : 'none');
                }

                // Determine selected features
                selected = Array.isArray(company?.selectedFeatures) ? company.selectedFeatures : (company?.selectedFeatures || []);
                console.log('✅ Company selected features:', selected);

                // If featuresData + authorizedPages mapping is available, use it, otherwise treat selected as feature keys
                if (featuresData && selected.length > 0) {
                    selected.forEach(fid => {
                        const f = featuresData[fid];
                        if (f && (f.status === 'active' || typeof f.status === 'undefined') && Array.isArray(f.authorizedPages)) {
                            authorizedPages.push(...f.authorizedPages);
                        }
                    });
                    console.log('📄 Authorized pages from features:', authorizedPages.length);
                }

                resetMenuVisibility();
                const authorizedFeatures = new Set();

                if (authorizedPages.length > 0) {
                    authorizedPages.forEach(p => { if (p && p.feature) authorizedFeatures.add(p.feature); });
                } else if (selected.length > 0) {
                    // Fallback: assume selected values are feature keys
                    selected.forEach(k => { if (typeof k === 'string') authorizedFeatures.add(k); });
                }

                console.log('🔑 Authorized features:', Array.from(authorizedFeatures));

                if (authorizedFeatures.size > 0) {
                    // Show individual items whose feature is authorized
                    document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li => {
                        const feature = li.getAttribute('data-feature');
                        const isDropdown = li.classList.contains('menu-dropdown');
                        if (isDropdown) return; // handle dropdown later
                        if (authorizedFeatures.has(feature)) {
                            li.classList.add('menu-visible');
                            console.log(`✅ Showing feature: ${feature}`);
                        } else {
                            console.log(`❌ Hiding feature: ${feature}`);
                        }
                    });

                    // Show dropdowns if they have visible children or are directly authorized
                    document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop => {
                        const dropFeature = drop.getAttribute('data-feature');
                        const hasChildren = drop.querySelectorAll('.submenu li.menu-visible').length > 0;
                        if (hasChildren || authorizedFeatures.has(dropFeature)) {
                            drop.classList.add('menu-visible');
                            console.log(`✅ Showing dropdown: ${dropFeature} (children: ${hasChildren})`);
                        } else {
                            console.log(`❌ Hiding dropdown: ${dropFeature} (no children or not authorized)`);
                        }
                    });
                } else {
                    console.log('⚠️ No authorized features found - using permissive fallback');
                    // Permissive fallback: if we don't know company-selected features, start with all features visible
                    // and let the role-permission filter remove disallowed items.
                    document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li => {
                        const isDropdown = li.classList.contains('menu-dropdown');
                        if (!isDropdown) li.classList.add('menu-visible');
                    });
                    document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop => {
                        const hasChildren = drop.querySelectorAll('.submenu li.menu-visible').length > 0;
                        if (hasChildren) drop.classList.add('menu-visible');
                    });
                }

                return authorizedPages;
            } catch (e) {
                console.error('Feature visibility error:', e);
                resetMenuVisibility();
                ensureHomeIsVisible();
                showSidebarAfterAuth();
                return [];
            }
        }

        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            console.log('👮 Applying role-based filtering:', { companyId, userRole });
            try {
                let permissions = null;
                const firebaseAvailable = (typeof firebase !== 'undefined') && firebase.database;
                if (firebaseAvailable) {
                    try {
                        const permSnap = await firebase.database().ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
                        if (permSnap.exists()) {
                            permissions = permSnap.val();
                            console.log('🔐 Firebase permissions loaded:', permissions);
                        }
                    } catch (dbErr) {
                        console.warn('Firebase role permissions fetch failed, using local fallback:', dbErr);
                    }
                }

                if (!permissions) {
                    const companyData = JSON.parse(localStorage.getItem('companyData') || '{}');
                    const company = companyData[companyId];
                    permissions = company?.roles?.[userRole]?.permissions || null;
                    console.log('💾 Local permissions loaded:', permissions);
                }

                if (!permissions) {
                    if (String(userRole || '').toLowerCase() === 'administrator') { 
                        console.log('👑 Administrator bypass - showing all features');
                        showSidebarAfterAuth(); 
                        return; 
                    }
                    console.warn('⚠️ No permissions found - hiding items requiring permissions');
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }

                filterMenuByPermissions(permissions);
            } catch (e) {
                console.error('Role filtering error:', e);
                showSidebarAfterAuth();
            }
        }

        // Helper: support both object- and array-shaped permission models
        function hasPermission(permissions, key) {
            if (!permissions || !key) return false;
            const k = String(key).trim();
            if (!k) return false;
            // Object map: { perm: true } or { perm: { view: true } }
            if (typeof permissions === 'object' && !Array.isArray(permissions)) {
                const val = permissions[k] ?? permissions[k.toLowerCase()] ?? permissions[k.toUpperCase()];
                if (val === true) return true;
                if (val && typeof val === 'object') return !!(val.view === true || val.read === true || val.access === true);
                return false;
            }
            // Array list: ["perm1", "perm2"]
            if (Array.isArray(permissions)) {
                const lowered = permissions.map(p => String(p).trim());
                return lowered.includes(k) || lowered.includes(k.toLowerCase()) || lowered.includes(k.toUpperCase());
            }
            return false;
        }

        function filterMenuByPermissions(permissions) {
            console.log('🔒 Filtering menu by permissions:', permissions);
            let hiddenCount = 0;
            
            // Hide items that require permissions the user lacks
            document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]')
                .forEach(li => {
                    const req = li.getAttribute('data-requires-permission');
                    const has = hasPermission(permissions, req);
                    if (!has) {
                        li.classList.remove('menu-visible');
                        hiddenCount++;
                        console.log(`❌ Hiding item requiring permission: ${req}`);
                    } else {
                        console.log(`✅ Keeping item with permission: ${req}`);
                    }
                });

            // Hide dropdowns with no visible children or lacking required permission themselves
            document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop => {
                const visibleChildren = drop.querySelectorAll('.submenu li.menu-visible').length;
                const req = drop.getAttribute('data-requires-permission');
                const dropFeature = drop.getAttribute('data-feature');
                
                if (visibleChildren === 0) {
                    if (req) {
                        const hasDrop = hasPermission(permissions, req);
                        if (!hasDrop) {
                            drop.classList.remove('menu-visible');
                            console.log(`❌ Hiding dropdown ${dropFeature}: no permission ${req}`);
                        } else {
                            drop.classList.remove('menu-visible'); // no children => hide anyway
                            console.log(`❌ Hiding dropdown ${dropFeature}: has permission but no children`);
                        }
                    } else {
                        drop.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown ${dropFeature}: no children and no permission required`);
                    }
                } else if (req) {
                    // If dropdown has children but the dropdown itself requires a permission, ensure it's allowed
                    const hasDrop = hasPermission(permissions, req);
                    if (!hasDrop) {
                        drop.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown ${dropFeature}: missing permission ${req} despite having children`);
                    } else {
                        console.log(`✅ Keeping dropdown ${dropFeature}: has permission ${req} and ${visibleChildren} children`);
                    }
                } else {
                    console.log(`✅ Keeping dropdown ${dropFeature}: no permission required, ${visibleChildren} children`);
                }
            });

            console.log(`🎯 Permission filtering complete: ${hiddenCount} items hidden`);
            ensureHomeIsVisible();
            showSidebarAfterAuth();
        }

        function hideItemsRequiringPermissions() {
            document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]')
                .forEach(li => li.classList.remove('menu-visible'));
            document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop => {
                const visibleChildren = drop.querySelectorAll('.submenu li.menu-visible').length;
                if (visibleChildren === 0) drop.classList.remove('menu-visible');
            });
            ensureHomeIsVisible();
        }

        function initializeMenuAuthorization() {
            // Do not hide anything up-front; compute visibility first, then enable gating
            setTimeout(() => updateMenuWithFeatureAuthorization(), 150);
        }

        // Optional: quick debugger
        window.debugMenuState = function() {
            const items = document.querySelectorAll('#roleBasedMenu [data-feature]');
            console.table(Array.from(items).map(el => ({
                feature: el.getAttribute('data-feature'),
                requires: el.getAttribute('data-requires-permission') || '',
                visible: el.classList.contains('menu-visible')
            })));
        };

        // Expose init fn
        window.initializeMenuAuthorization = initializeMenuAuthorization;
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
        </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  // All CSS has been embedded - no external stylesheets needed
  console.log('Document Creator initialized with embedded dependencies');
  
  // Check if user is logged in from index.html
  const currentUser = authManager.getCurrentUser();
  if (currentUser) {
    console.log('✅ User found:', currentUser.displayName || currentUser.email);
    console.log('User initials:', authManager.getUserInitials());
  } else {
    console.warn('❌ No user found - user must log in from index.html');
    // Redirect to login if no user is found
    alert('Please log in from the main page first.');
    window.location.href = 'index.html';
    return;
  }
  
  // Initialize company data service first
  companyDataService.initializeUserContext().then(() => {
    console.log('Company data initialized');
    console.log('Current company ID:', companyDataService.getCurrentCompanyId());
    
    // Initialize authentication manager (centralized)
    authManager.initializeAuth();
    console.log('Centralized auth manager initialized');
    
    // Load user profile using dashboard.html method
    loadUserProfile().then(() => {
      console.log('User profile loaded via dashboard.html method');
      
      // Force update company branding after everything is loaded
      setTimeout(() => {
        console.log('🔄 Force updating company branding...');
        authManager.updateCompanyBranding();
      }, 100);

      // Apply menu visibility logic after profile is loaded and auth is complete
      setTimeout(() => {
        console.log('🔒 Applying menu visibility based on company features + user roles...');
        if (typeof initializeMenuAuthorization === 'function') {
          initializeMenuAuthorization();
        } else if (typeof updateMenuWithFeatureAuthorization === 'function') {
          updateMenuWithFeatureAuthorization();
        }
      }, 200);
    }).catch(error => {
      console.error('Error loading user profile:', error);
    });
  });
  
    // Initialize page functionality
        initializeAuth();
  
  // Initialize stats display
  updateStats();
});
</script>
</body>
</html>

