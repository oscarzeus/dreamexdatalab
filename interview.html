<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Applicants - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem; /* Standardized, reduced from 14px */
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
        }

        /* High contrast mode */
        [data-contrast="high"] {
            --text-primary: #000000;
            --text-secondary: #000000;
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --border-color: #000000;
        }

        [data-theme="dark"][data-contrast="high"] {
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --border-color: #ffffff;
        }

        /* Layout density */
        [data-density="comfortable"] {
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        [data-density="compact"] {
            --spacing-unit: 0.75rem;
            --padding-sm: 0.25rem;
            --padding-md: 0.75rem;
            --padding-lg: 1rem;
        }

        [data-density="spacious"] {
            --spacing-unit: 1.5rem;
            --padding-sm: 0.75rem;
            --padding-md: 1.5rem;
            --padding-lg: 2rem;
        }

        /* Animation settings */
        [data-reduced-motion="none"] {
            --transition-speed: 0.2s;
        }

        [data-reduced-motion="reduced"] {
            --transition-speed: 0.4s;
        }

        [data-reduced-motion="minimal"] {
            --transition-speed: 0s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Menu Visibility System - STRICT HIDING */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Hide ALL menu items by default during loading - MAXIMUM STRENGTH */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature],
        .sidebar.menu-loading li,
        .sidebar.menu-loading .menu li {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Also hide the entire menu structure during loading */
        .sidebar.menu-loading .menu {
            display: none !important;
        }

        /* Allow menu-visible items to show even during loading */
        .sidebar.menu-loading .menu-visible,
        .sidebar.menu-loading li.menu-visible,
        .sidebar.menu-loading [data-feature].menu-visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Ensure menu-visible items are always shown */
        .menu-visible {
            display: block !important;
        }

        li.menu-visible,
        [data-feature].menu-visible {
            display: block !important;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 0;
            width: 100%;
        }

        /* Form Container Styles */
        .form-container {
            width: 100%;
            max-width: none;
            padding: 1.5rem;
            margin: 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Content Container */
        .content {
            width: 100%;
            margin: 0;
            padding: 1.5rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: relative;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            height: 32px;
            width: auto;
            object-fit: contain;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .search-bar {
            position: absolute;
            left: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;  /* Increased from 1rem for better spacing */
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .notification-actions h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .notification-link {
            text-decoration: none;
            color: #3498db;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-link:hover {
            background: #f8f9fa;
            color: #2980b9;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f5f5f5;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Ensure the profile button looks interactive */
        .profile-btn {
            cursor: pointer;
            padding: 0;
            border: none;
            background: none;
            display: flex;
            align-items: center;
        }

        /* User Profile Dropdown Styles */
        .user-info {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .admin-crown-icon {
            color: #ffd700; /* Gold color for the crown */
            margin-left: 0.5rem;
            font-size: 0.9rem;
            vertical-align: middle;
            animation: crown-glow 2s ease-in-out infinite alternate;
        }

        @keyframes crown-glow {
            from {
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            to {
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            }
        }

        .user-email {
            font-size: 0.9rem;
            color: #666;
        }

        .user-status {
            margin-top: 0.25rem;
        }

        .divider {
            height: 1px;
            background-color: #eee;
            margin: 0.5rem 0;
        }

        /* Profile Dropdown Status Badge */
        .user-status .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem; /* Reduced from 2rem */
            padding: 0.75rem; /* Reduced from 1rem */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem; /* Reduced from 1rem */
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem 0.75rem; /* Reduced from 0.75rem 1rem */
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-approve {
            background-color: #27ae60;
            color: white;
        }

        .btn-decline {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }

        .btn-icon i {
            font-size: 0.9rem;
        }

        .btn-icon.btn-approve {
            background-color: #2ecc71;
        }

        .btn-icon.btn-approve:hover {
            background-color: #27ae60;
        }

        .btn-icon.btn-decline {
            background-color: #e74c3c;
        }

        .btn-icon.btn-decline:hover {
            background-color: #c0392b;
        }

        .btn-icon.btn-export {
            background-color: #9b59b6;
        }

        .btn-icon.btn-export:hover {
            background-color: #8e44ad;
        }

        .btn-icon.btn-delete {
            background-color: #e74c3c;
        }

        .btn-icon.btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-icon:not(:last-child) {
            margin-right: 0.25rem;
        }

        /* Avatar Styles */
        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Role Badge Styles */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-guest {
            background-color: #95a5a6;
            color: white;
        }

        .role-standard {
            background-color: #3498db;
            color: white;
        }

        .role-editor {
            background-color: #2ecc71;
            color: white;
        }

        .role-admin {
            background-color: #e67e22;
            color: white;
        }

        .role-superuser {
            background-color: #9b59b6;
            color: white;
        }

        /* File Preview Modal Styles */
        .file-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .file-preview-content {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            width: auto;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .file-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }

        .file-preview-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-preview:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .file-preview-body {
            flex: 1;
            overflow: auto;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            min-height: 500px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        .preview-error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
        }

        .file-preview-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
            margin-top: 1rem;
        }

        .preview-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .preview-download-btn {
            background: #28a745;
            color: white;
            border: none;
        }

        .preview-download-btn:hover {
            background: #218838;
        }

        .preview-open-btn {
            background: #007bff;
            color: white;
            border: none;        }

        .preview-open-btn:hover {
            background: #0056b3;
        }        /* User Profile Avatar and Dropdown Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color, #3498db);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
        }

        .user-avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li {
            padding: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }

        .profile-dropdown li:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        /* User profile responsive adjustments */
        @media (max-width: 768px) {
            .user-profile {
                position: relative;
            }
            
            .profile-dropdown {
                right: -10px;
                min-width: 180px;
                max-width: 200px;
            }
            
            .user-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.8rem;
            }

            .profile-btn {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 480px) {
            .profile-dropdown {
                right: -20px;
                min-width: 160px;
            }
            
            .profile-dropdown li a {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
        }

        .interview-container {
            width: 100%;
            margin: 0;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #495057;
            font-weight: 500;
        }

        .stat-number {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .loading-container {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-container {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .candidates-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .candidates-table {
            width: 100%;
            border-collapse: collapse;
        }

        .candidates-table th,
        .candidates-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .candidates-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .candidates-table tbody tr:hover {
            background: #f8f9fa;
        }

        .candidate-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .candidate-info {
            display: flex;
            align-items: center;
        }

        .candidate-details {
            flex: 1;
        }

        .candidate-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .candidate-email {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-interviewed {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-hired {
            background: #d1ecf1;
            color: #0c5460;
        }        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .files-column {
            max-width: 150px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-icon {
            color: #007bff;
            font-size: 0.9rem;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #2c3e50;
        }

        .file-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        .file-link:hover {
            color: #007bff;
        }

        .download-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .download-btn:hover {
            background: #e9ecef;
        }

        .no-files {
            color: #6c757d;
            font-style: italic;
            font-size: 0.85rem;
            text-align: center;
        }

        .btn-action {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-edit:hover {
            background: #1e7e34;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        .real-time-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #28a745;
            font-size: 0.9rem;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        .last-updated {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }        /* Responsive Design */
        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 1rem;
                padding: 0.75rem;
            }

            .top-nav-left {
                gap: 0.75rem;
            }

            .company-name-header {
                font-size: 1rem;
            }

            .header-company-logo {
                width: 32px;
                height: 32px;
            }

            .page-header {
                padding: 1.5rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 0.75rem;
            }

            .candidates-table {
                font-size: 0.9rem;
            }

            .candidates-table th,
            .candidates-table td {
                padding: 0.75rem 0.5rem;
            }

            .files-column {
                max-width: 120px;
            }

            .file-item {
                font-size: 0.75rem;
            }

            /* Hide phone column on very small screens */
            .candidates-table th:nth-child(4),
            .candidates-table td:nth-child(4) {
                display: none;
            }
        }

        /* Tab Layout Styles */
        /* Tab Layout Styles - Enhanced like jobscreen.html */
        .content-tabs {
            margin-top: 0;
            width: 100%;
        }

        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
            overflow: hidden;
        }

        .tab-navigation:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transition: box-shadow 0.3s ease;
        }

        .tab-nav-btn {
            flex: 1;
            padding: 1.2rem 2rem;
            border: none;
            background: transparent;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 0;
            letter-spacing: 0.5px;
        }

        /* Individual tab colors - only apply when active */
        #jobsTabBtn,
        #applicantsTabBtn,
        #archivesTabBtn,
        #hiredTabBtn {
            background: transparent;
            color: #6c757d;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #28a745;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Enhanced hover effects for each tab - neutral colors */
        #jobsTabBtn:hover,
        #applicantsTabBtn:hover,
        #archivesTabBtn:hover,
        #hiredTabBtn:hover {
            background: #f8f9fa;
            color: #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Active state styling */
        .tab-nav-btn.active {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            z-index: 10;
            position: relative;
        }

        #jobsTabBtn.active {
            background: #28a745;
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        #applicantsTabBtn.active {
            background: #ffc107;
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        #archivesTabBtn.active {
            background: #dc3545;
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        #hiredTabBtn.active {
            background: #17a2b8;
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }

        .tab-content {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
            min-height: 400px;
        }

        .tab-content:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transition: box-shadow 0.3s ease;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dynamic table header colors based on active tab */
        .tab-content.active .candidates-table th,
        .tab-content.active .data-table th {
            transition: background-color 0.3s ease;
        }

        /* Jobs tab - Green headers */
        #jobsTabContent.active .candidates-table th,
        #jobsTabContent.active .data-table th {
            background: #28a745;
            color: white;
        }

        /* Applicants tab - Yellow headers */
        #applicantsTabContent.active .candidates-table th,
        #applicantsTabContent.active .data-table th {
            background: #ffc107;
            color: white;
        }

        /* Archives tab - Red headers */
        #archivesTabContent.active .candidates-table th,
        #archivesTabContent.active .data-table th {
            background: #dc3545;
            color: white;
        }

        /* Hired tab - Teal headers */
        #hiredTabContent.active .candidates-table th,
        #hiredTabContent.active .data-table th {
            background: #17a2b8;
            color: white;
        }

        /* Responsive tab styles */
        @media (max-width: 768px) {
            .tab-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                flex-direction: column;
                gap: 0.25rem;
            }

            .tab-nav-btn i {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .top-nav-left {
                gap: 0.5rem;
            }

            .company-name-header {
                font-size: 0.9rem;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .header-company-logo {
                width: 28px;
                height: 28px;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .tab-nav-btn {
                flex-direction: row;
                justify-content: flex-start;
                padding: 1rem;
                border-radius: 0;
            }

            .tab-nav-btn.active {
                border-bottom: none;
                border-left: 3px solid #007bff;
            }
        }        /* Button styles for job management placeholder */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }        /* Jobs specific styles */
        .job-title-cell {
            min-width: 200px;
        }

        .job-salary {
            color: #28a745;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .application-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .application-count-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .job-actions {
            display: flex;
            gap: 0.25rem;
        }

        /* Status badges for jobs */
        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }        /* Job filter indicator styles */
        .job-filter-indicator {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .job-filter-indicator button {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            font-size: 0.9rem;
        }        .job-filter-indicator button:hover {
            color: #1565c0;
        }

        /* Applicants Tab Styles */
        .applicant-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .selected-job-info {
            flex: 1;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }

        .selected-job-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
        }

        .selected-job-details {
            color: #6c757d;
            margin: 0;
            font-size: 0.9rem;
        }

        .applicants-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .applicants-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            font-size: 0.85rem;
        }

        .applicants-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            font-size: 0.85rem;
        }

        .applicants-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .applicant-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .no-applicants {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .no-applicants i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .no-applicants h3 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .no-applicants p {
            margin: 0;
            opacity: 0.8;
        }

        .status-reviewed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-shortlisted {
            background: #fff3cd;
            color: #856404;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 0.125rem;
        }

        /* Action button variants */
        .btn-view {
            background-color: #e6f3ff;
            color: #0066cc;
        }

        .btn-view:hover {
            background-color: #cce6ff;
            transform: translateY(-1px);
        }

        .btn-edit {
            background-color: #fff3e0;
            color: #ff9800;
        }

        .btn-edit:hover {
            background-color: #ffe0b3;
            transform: translateY(-1px);
        }

        .btn-info {
            background-color: #e8f5e8;
            color: #4caf50;
        }

        .btn-info:hover {
            background-color: #d4f3d4;
            transform: translateY(-1px);
        }

        .btn-mail {
            background-color: #f3e5f5;
            color: #9c27b0;
        }

        .btn-mail:hover {
            background-color: #e1bee7;
            transform: translateY(-1px);
        }

        .btn-hire {
            background-color: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }

        .btn-hire:hover {
            background-color: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
        }

        .btn-hire:disabled {
            background-color: #f5f5f5;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
        }

        /* Mobile responsive for applicant controls */
        @media (max-width: 768px) {
            .applicant-controls-row {
                flex-direction: column;
                gap: 1rem;
            }

            .selected-job-info {
                order: 1;
            }

            .applicants-table {
                font-size: 0.8rem;
            }

            .applicants-table th,
            .applicants-table td {
                padding: 0.5rem 0.25rem;
            }            /* Stack action buttons vertically on mobile */
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
        }

        /* Applicant Modal Styles */
        .applicant-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .applicant-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .applicant-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .applicant-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .applicant-modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .applicant-info-section {
            margin-bottom: 1.5rem;
        }

        .applicant-info-section h4 {
            color: #495057;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .applicant-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .applicant-info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .applicant-info-value {
            color: #2c3e50;
        }        .status-update-section {
            grid-column: 1 / -1;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .form-control {
            padding: 0.5rem;
            border: 1px solid #ced4da;            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
        }

        .form-control:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Schedule Modal Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }        /* Interviewer Dropdown Styling */
        #interviewerSelect {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }

        #interviewerSelect:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%230066cc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Multi-Interviewer Selection Styles */
        .interviewer-selection-container {
            width: 100%;
        }

        .interviewer-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .selected-interviewers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 20px;
        }

        .interviewer-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid #bbdefb;
            gap: 0.5rem;
        }

        .interviewer-tag .remove-interviewer {
            background: none;
            border: none;
            color: #1565c0;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            margin: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .interviewer-tag .remove-interviewer:hover {
            background: #1565c0;
            color: white;
        }        .empty-interviewers-message {
            color: #6c757d;
            font-style: italic;
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }

        /* Existing Interviews Display */
        .loading-interviews {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
        }

        .no-existing-interviews {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
        }

        .existing-interview-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .existing-interview-item:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }

        .interview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .interview-date-time {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .interview-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .interview-status.scheduled {
            background: #d4edda;
            color: #155724;
        }

        .interview-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        .interview-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .interview-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .interview-detail-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.25rem;
        }

        .interview-detail-label {
            font-weight: 500;
            min-width: 80px;
        }

        .interview-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        /* Schedule Status Badges */
        .schedule-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }        .schedule-status.scheduled {
            background: #d4edda;
            color: #155724;
        }

        .schedule-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .schedule-status.expired {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .schedule-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        /* Schedule Column Styles */
        .schedule-column {
            min-width: 150px;
        }

        .schedule-column .btn {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-column .btn-primary {
            background: #007bff;
            color: white;
        }        .schedule-column .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        /* Evaluation Modal Styles */
        .evaluation-form {
            margin-top: 1rem;
        }

        .evaluation-criteria {
            margin: 1.5rem 0;
        }

        .criteria-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .criteria-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .rating-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .rating-stars {
            display: flex;
            gap: 0.25rem;
            margin-right: 1rem;
        }

        .star {
            font-size: 1.5rem;
            color: #dee2e6;
            cursor: pointer;
            transition: color 0.2s;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffc107;
        }

        .star.active ~ .star {
            color: #dee2e6;
        }

        .rating-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .criteria-notes {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .evaluation-candidate-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Button Styles for Evaluation */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        /* Jobs Table Styles */
        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .jobs-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .jobs-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .jobs-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }        .jobs-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .jobs-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .job-title-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .job-code {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .d-none {
            display: none !important;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            gap: 1rem;
        }

        .pagination-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .urgency-critical {
            color: #dc3545;
            font-weight: 600;
        }

        .urgency-high {
            color: #fd7e14;
            font-weight: 600;
        }

        .urgency-medium {
            color: #ffc107;
            font-weight: 600;
        }

        .urgency-normal {
            color: #28a745;
            font-weight: 500;
        }

        .urgency-low {
            color: #6c757d;
            font-weight: 400;
        }        .salary-range {
            color: #28a745;
            font-weight: 500;
        }

        .employment-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .applications-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
        }

        .count-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .urgency-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .text-muted {
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .applicant-modal-body {
                grid-template-columns: 1fr;
            }
            
            .search-export-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-wrapper {
                min-width: auto;
            }
            
            .jobs-table {
                font-size: 0.8rem;
            }
            
            .jobs-table th,
            .jobs-table td {
                padding: 0.5rem 0.25rem;
            }
              .pagination {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        /* Evaluation Column Styles */
        .evaluation-column {
            min-width: 140px;
            text-align: center;
        }

        .evaluation-status {
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .evaluation-status.loading {
            background: #f8f9fa;
            color: #6c757d;
        }

        .evaluation-status.no-eval {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .evaluation-status.evaluated {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .eval-score {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .eval-score i {
            color: #ffc107;
            margin-right: 0.25rem;
        }

        .eval-count {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .no-evaluation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .no-evaluation i {
            font-size: 1.2rem;
            opacity: 0.6;
        }

        /* Detailed Evaluations Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .evaluation-details-modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .evaluation-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .evaluation-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .evaluation-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .score-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .ratings-section {
            margin-bottom: 1rem;
        }

        .ratings-section h5 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .ratings-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .ratings-section li {
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        .comments-section {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .comments-section h5 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .comments-section p {
            margin: 0;
            color: #6c757d;
            line-height: 1.4;
        }

        /* Recommendation Classes */
        .recommend-strong {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .recommend-yes {
            background: #d1ecf1;
            color: #0c5460;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .recommend-neutral {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .recommend-no {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }        .recommend-strong-no {
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Average Results Section Styles */
        .average-results-section {
            border-top: 2px solid #007bff;
            margin-top: 2rem;
            padding-top: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .average-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #007bff;
        }

        .average-header h3 {
            margin: 0;
            color: #007bff;
            font-weight: 600;
        }

        .average-header i {
            margin-right: 0.5rem;
        }

        .evaluators-count {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .average-content {
            display: grid;
            gap: 1.5rem;
        }

        .average-overall-score {
            text-align: center;
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .average-score-display {
            margin-bottom: 1rem;
        }

        .score-number {
            font-size: 3rem;
            font-weight: bold;
            color: #007bff;
        }

        .score-total {
            font-size: 1.5rem;
            color: #6c757d;
        }

        .score-stars {
            font-size: 1.5rem;
            color: #ffc107;
            margin-bottom: 1rem;
        }

        .score-stars i {
            margin: 0 0.1rem;
        }

        .average-recommendation {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .average-criteria-breakdown {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .average-criteria-breakdown h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
        }

        .criteria-grid {
            display: grid;
            gap: 1rem;
        }

        .criteria-average-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .criteria-label {
            min-width: 120px;
            font-weight: 500;
            color: #495057;
        }

        .criteria-score-bar {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            background: #e9ecef;
            border-radius: 20px;
            height: 24px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .score-value {
            position: absolute;
            right: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #495057;
            z-index: 1;
        }

        .recommendation-breakdown {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .recommendation-breakdown h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
        }

        .recommendation-chart {
            display: grid;
            gap: 0.75rem;
        }

        .recommendation-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .recommendation-label {
            min-width: 150px;
            font-size: 0.9rem;
        }

        .recommendation-bar-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            background: #e9ecef;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
        }

        .recommendation-bar-fill {
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .recommendation-bar-fill.recommend-strong {
            background: #28a745;
        }

        .recommendation-bar-fill.recommend-yes {
            background: #17a2b8;
        }

        .recommendation-bar-fill.recommend-neutral {
            background: #ffc107;
        }

        .recommendation-bar-fill.recommend-no {
            background: #fd7e14;
        }

        .recommendation-bar-fill.recommend-strong-no {
            background: #dc3545;
        }        .recommendation-count {
            position: absolute;
            right: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #495057;
            z-index: 1;
        }

        /* Job Rankings Section Styles */
        .job-rankings-section {
            margin-top: 2rem;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .job-rankings-section h5 {
            margin: 0 0 1.5rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .job-rankings-section h5 i {
            color: #007bff;
        }

        .rankings-table {
            width: 100%;
        }

        .rankings-header {
            display: grid;
            grid-template-columns: 80px 2fr 120px 150px 120px 120px 100px;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid #007bff;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .ranking-row {
            display: grid;
            grid-template-columns: 80px 2fr 120px 150px 120px 120px 100px;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
            transition: background-color 0.2s;
        }

        .ranking-row:hover {
            background-color: #f8f9fa;
        }

        .ranking-row:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }

        .rank-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6c757d;
            text-align: center;
        }

        .rank-number.top-rank {
            color: #007bff;
            font-size: 1.4rem;
        }

        .applicant-name-cell strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .applicant-name-cell small {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .score-display {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
        }

        .score-display.rank-excellent {
            background: #d4edda;
            color: #155724;
        }

        .score-display.rank-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .score-display.rank-average {
            background: #fff3cd;
            color: #856404;
        }

        .score-display.rank-below-average {
            background: #f8d7da;
            color: #721c24;
        }

        .score-display.rank-poor {
            background: #dc3545;
            color: white;
        }

        .evaluation-count {
            font-size: 0.9rem;
            color: #495057;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .job-statistics {
            margin-top: 2rem;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .job-statistics h5 {
            margin: 0 0 1.5rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .job-statistics h5 i {
            color: #007bff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #dee2e6;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .rankings-header,
            .ranking-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .rankings-header {
                display: none;
            }
            
            .ranking-row {
                background: #f8f9fa;
                border-radius: 8px;
                margin-bottom: 0.5rem;
                border: 1px solid #dee2e6;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Evaluation Rank Modal Styles */
        .evaluation-rank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .evaluation-rank-content {
            position: relative;
            background: white;
            max-width: 900px;
            margin: 2rem auto;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .evaluation-rank-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank-header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .evaluation-rank-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .rank-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .rank-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .evaluation-rank-body {
            padding: 2rem;
        }

        .applicant-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
        }

        .applicant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .applicant-info h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .applicant-info p {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
        }

        .overall-rank {
            text-align: center;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .rank-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .rank-excellent {
            background: #d4edda;
            color: #155724;
        }

        .rank-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .rank-average {
            background: #fff3cd;
            color: #856404;
        }

        .rank-below-average {
            background: #f8d7da;
            color: #721c24;
        }

        .rank-poor {
            background: #dc3545;
            color: white;
        }

        .evaluation-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .metrics-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .metrics-section h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metrics-section h5 i {
            color: #007bff;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #495057;
        }

        .metric-value {
            font-weight: 600;
            color: #007bff;
        }

        .notes-section {
            margin-top: 2rem;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .notes-section h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .note-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }

        .note-item:last-child {
            margin-bottom: 0;
        }

        .note-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .note-evaluator {
            font-weight: 600;
            color: #2c3e50;
        }

        .note-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .note-content {
            color: #495057;
            line-height: 1.5;
        }

        .no-evaluations {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .no-evaluations i {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }

        .no-evaluations h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        @media (max-width: 768px) {
            .evaluation-rank-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }
            
            .evaluation-metrics {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .applicant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="file-preview-modal">
        <div class="file-preview-content">
            <div class="file-preview-header">
                <h3 class="file-preview-title" id="previewTitle">File Preview</h3>
                <button class="close-preview" onclick="closeFilePreview()">&times;</button>
            </div>
            <div class="file-preview-body" id="previewBody">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="file-preview-actions">
                <button class="preview-action-btn preview-download-btn" id="previewDownloadBtn">
                    <i class="fas fa-download"></i>
                    Download
                </button>
                <button class="preview-action-btn preview-open-btn" id="previewOpenBtn">
                    <i class="fas fa-external-link-alt"></i>
                    Open in New Tab
                </button>
            </div>        </div>    </div>

    <!-- Applicant Modal -->
    <div id="applicantModal" class="applicant-modal">
        <div class="applicant-modal-content">
            <div class="applicant-modal-header">
                <h3 class="applicant-modal-title">Applicant Details</h3>
                <button class="close-modal" onclick="closeApplicantModal()">&times;</button>
            </div>
            <div class="applicant-modal-body">
                <div class="applicant-info-section">
                    <h4>Personal Information</h4>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Full Name:</span>
                        <span class="applicant-info-value" id="modalFullName">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Email:</span>
                        <span class="applicant-info-value" id="modalEmail">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Phone:</span>
                        <span class="applicant-info-value" id="modalPhone">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Address:</span>
                        <span class="applicant-info-value" id="modalAddress">-</span>
                    </div>
                </div>

                <div class="applicant-info-section">
                    <h4>Application Information</h4>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Applied Date:</span>
                        <span class="applicant-info-value" id="modalAppliedDate">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Status:</span>
                        <span class="applicant-info-value" id="modalStatus">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Experience:</span>
                        <span class="applicant-info-value" id="modalExperience">-</span>
                    </div>                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Resume:</span>
                        <span class="applicant-info-value" id="modalResumeLink">-</span>
                    </div>
                </div>

                <!-- Interview Information Section -->
                <div class="applicant-info-section" id="interviewInfoSection" style="display: none;">
                    <h4>Interview Information</h4>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Interview Date:</span>
                        <span class="applicant-info-value" id="modalInterviewDate">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Interview Time:</span>
                        <span class="applicant-info-value" id="modalInterviewTime">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Interview Type:</span>
                        <span class="applicant-info-value" id="modalInterviewType">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Interviewer:</span>
                        <span class="applicant-info-value" id="modalInterviewer">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Location:</span>
                        <span class="applicant-info-value" id="modalInterviewLocation">-</span>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-success" id="evaluationBtn" onclick="openEvaluationModal()">
                            <i class="fas fa-clipboard-list"></i> Create Evaluation
                        </button>
                        <button class="btn btn-info" id="viewEvaluationsBtn" onclick="viewExistingEvaluations()" style="margin-left: 0.5rem;">
                            <i class="fas fa-eye"></i> View Evaluations
                        </button>
                    </div>
                </div>

                <div class="status-update-section">
                    <h4>Update Status</h4>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="statusSelect" class="form-control">
                            <option value="pending">Pending</option>
                            <option value="reviewed">Reviewed</option>
                            <option value="shortlisted">Shortlisted</option>
                            <option value="interviewed">Interviewed</option>
                            <option value="rejected">Rejected</option>
                            <option value="hired">Hired</option>
                        </select>
                        <button class="btn btn-primary" onclick="updateApplicantStatusFromModal()">
                            Update Status
                        </button>
                    </div>                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Interview Modal -->
    <div id="scheduleModal" class="applicant-modal">
        <div class="applicant-modal-content">
            <div class="applicant-modal-header">
                <h3 class="applicant-modal-title">Schedule Interview</h3>
                <button class="close-modal" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="applicant-modal-body">
                <div class="applicant-info-section">
                    <h4>Applicant Information</h4>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Name:</span>
                        <span class="applicant-info-value" id="scheduleApplicantName">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Email:</span>
                        <span class="applicant-info-value" id="scheduleApplicantEmail">-</span>
                    </div>                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Position:</span>
                        <span class="applicant-info-value" id="scheduleJobTitle">-</span>
                    </div>
                </div>

                <!-- Existing Scheduled Interviews Section -->
                <div class="applicant-info-section" id="existingInterviewsSection">
                    <h4>Scheduled Interviews</h4>
                    <div id="existingInterviewsList">
                        <div class="loading-interviews">
                            <i class="fas fa-spinner fa-spin"></i> Loading scheduled interviews...
                        </div>
                    </div>
                </div>

                <div class="status-update-section">
                    <h4>Interview Details</h4>
                    <div class="form-group">
                        <label for="interviewDate">Interview Date</label>
                        <input type="date" id="interviewDate" class="form-control" min="">
                    </div>
                    <div class="form-group">
                        <label for="interviewTime">Interview Time</label>
                        <input type="time" id="interviewTime" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="interviewType">Interview Type</label>
                        <select id="interviewType" class="form-control">
                            <option value="in-person">In-Person</option>
                            <option value="video-call">Video Call</option>
                            <option value="phone">Phone Interview</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="interviewLocation">Location/Meeting Link</label>
                        <input type="text" id="interviewLocation" class="form-control" placeholder="Meeting room, Zoom link, etc.">
                    </div>                    <div class="form-group">
                        <label for="interviewer">Interviewer(s)</label>
                        <div class="interviewer-selection-container">
                            <div class="interviewer-input-row">
                                <select id="interviewerSelect" class="form-control" style="flex: 1;">
                                    <option value="">Loading interviewers...</option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="addInterviewer()" style="margin-left: 0.5rem;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="selected-interviewers" id="selectedInterviewers">
                                <!-- Selected interviewers will appear here -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="interviewNotes">Additional Notes</label>
                        <textarea id="interviewNotes" class="form-control" rows="3" placeholder="Any additional information for the interview..."></textarea>
                    </div>                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="scheduleInterview()">
                            <i class="fas fa-calendar-plus"></i> Schedule Interview
                        </button>
                        <button class="btn btn-success" id="scheduleModalEvaluateBtn" onclick="openEvaluationFromScheduleModal()" style="display: none;">
                            <i class="fas fa-clipboard-list"></i> Evaluate Candidate
                        </button>
                        <button class="btn btn-secondary" onclick="closeScheduleModal()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>        </div>
    </div>    <!-- Interview Evaluation Modal -->
    <div id="evaluationModal" class="applicant-modal">
        <div class="applicant-modal-content" style="max-width: 1200px;">
            <div class="applicant-modal-header">
                <h3 class="applicant-modal-title">Interview Evaluation</h3>
                <button class="close-modal" onclick="closeEvaluationModal()">&times;</button>
            </div>
            <div class="applicant-modal-body">
                <div class="applicant-info-section">
                    <h4>Candidate Information</h4>
                    <div class="evaluation-candidate-info">
                        <div class="applicant-info-item">
                            <span class="applicant-info-label">Name:</span>
                            <span class="applicant-info-value" id="evalCandidateName">-</span>
                        </div>
                        <div class="applicant-info-item">
                            <span class="applicant-info-label">Position:</span>
                            <span class="applicant-info-value" id="evalPosition">-</span>
                        </div>
                        <div class="applicant-info-item">
                            <span class="applicant-info-label">Interview Date:</span>
                            <span class="applicant-info-value" id="evalInterviewDate">-</span>
                        </div>
                    </div>
                </div>

                <div class="evaluation-form">                    <div class="form-group">
                        <label for="evaluatorName">Evaluator Name</label>
                        <input type="text" id="evaluatorName" class="form-control" placeholder="Current user will be set automatically" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                    </div>

                    <div class="evaluation-criteria">
                        <h4>Evaluation Criteria</h4>
                        
                        <div class="criteria-item">
                            <label>Technical Skills</label>
                            <div class="rating-group">
                                <div class="rating-stars" data-criteria="technical">
                                    <span class="star" data-rating="1">?</span>
                                    <span class="star" data-rating="2">?</span>
                                    <span class="star" data-rating="3">?</span>
                                    <span class="star" data-rating="4">?</span>
                                    <span class="star" data-rating="5">?</span>
                                </div>
                                <span class="rating-label">Poor</span>
                                <span class="rating-label" style="margin-left: auto;">Excellent</span>
                            </div>
                            <textarea class="form-control criteria-notes" placeholder="Comments on technical skills..." rows="2"></textarea>
                        </div>

                        <div class="criteria-item">
                            <label>Communication Skills</label>
                            <div class="rating-group">
                                <div class="rating-stars" data-criteria="communication">
                                    <span class="star" data-rating="1">?</span>
                                    <span class="star" data-rating="2">?</span>
                                    <span class="star" data-rating="3">?</span>
                                    <span class="star" data-rating="4">?</span>
                                    <span class="star" data-rating="5">?</span>
                                </div>
                                <span class="rating-label">Poor</span>
                                <span class="rating-label" style="margin-left: auto;">Excellent</span>
                            </div>
                            <textarea class="form-control criteria-notes" placeholder="Comments on communication skills..." rows="2"></textarea>
                        </div>

                        <div class="criteria-item">
                            <label>Problem Solving</label>
                            <div class="rating-group">
                                <div class="rating-stars" data-criteria="problem-solving">
                                    <span class="star" data-rating="1">?</span>
                                    <span class="star" data-rating="2">?</span>
                                    <span class="star" data-rating="3">?</span>
                                    <span class="star" data-rating="4">?</span>
                                    <span class="star" data-rating="5">?</span>
                                </div>
                                <span class="rating-label">Poor</span>
                                <span class="rating-label" style="margin-left: auto;">Excellent</span>
                            </div>
                            <textarea class="form-control criteria-notes" placeholder="Comments on problem-solving abilities..." rows="2"></textarea>
                        </div>

                        <div class="criteria-item">
                            <label>Cultural Fit</label>
                            <div class="rating-group">
                                <div class="rating-stars" data-criteria="cultural-fit">
                                    <span class="star" data-rating="1">?</span>
                                    <span class="star" data-rating="2">?</span>
                                    <span class="star" data-rating="3">?</span>
                                    <span class="star" data-rating="4">?</span>
                                    <span class="star" data-rating="5">?</span>
                                </div>
                                <span class="rating-label">Poor</span>
                                <span class="rating-label" style="margin-left: auto;">Excellent</span>
                            </div>
                            <textarea class="form-control criteria-notes" placeholder="Comments on cultural fit..." rows="2"></textarea>
                        </div>

                        <div class="criteria-item">
                            <label>Experience & Qualifications</label>
                            <div class="rating-group">
                                <div class="rating-stars" data-criteria="experience">
                                    <span class="star" data-rating="1">?</span>
                                    <span class="star" data-rating="2">?</span>
                                    <span class="star" data-rating="3">?</span>
                                    <span class="star" data-rating="4">?</span>
                                    <span class="star" data-rating="5">?</span>
                                </div>
                                <span class="rating-label">Poor</span>
                                <span class="rating-label" style="margin-left: auto;">Excellent</span>
                            </div>
                            <textarea class="form-control criteria-notes" placeholder="Comments on experience and qualifications..." rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="overallComments">Overall Comments</label>
                        <textarea id="overallComments" class="form-control" rows="4" placeholder="Provide overall assessment and any additional comments..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="recommendation">Recommendation</label>
                        <select id="recommendation" class="form-control">
                            <option value="">Select recommendation...</option>
                            <option value="strongly-recommend">Strongly Recommend</option>
                            <option value="recommend">Recommend</option>
                            <option value="neutral">Neutral</option>
                            <option value="not-recommend">Do Not Recommend</option>
                            <option value="strongly-not-recommend">Strongly Do Not Recommend</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1.5rem;">
                        <button class="btn btn-success" onclick="submitEvaluation()">
                            <i class="fas fa-save"></i> Submit Evaluation
                        </button>
                        <button class="btn btn-secondary" onclick="closeEvaluationModal()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>        </div>
    </div>

    <!-- Send Interview Report Modal -->
    <div id="sendReportModal" class="applicant-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-envelope"></i> Send Interview Report</h2>
                <button class="close-modal" onclick="closeSendReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h3>Report Details</h3>
                    
                    <div class="form-group">
                        <label for="reportRecipientEmail">
                            <i class="fas fa-envelope"></i> Recipient Email *
                        </label>
                        <input type="email" id="reportRecipientEmail" required 
                               placeholder="hr@dreamexdatalab.com" 
                               value="hr@dreamexdatalab.com">
                        <small>Email address to send the interview report</small>
                    </div>

                    <div class="form-group">
                        <label for="reportCandidateName">
                            <i class="fas fa-user"></i> Candidate Name
                        </label>
                        <input type="text" id="reportCandidateName" readonly>
                    </div>

                    <div class="form-group">
                        <label for="reportPosition">
                            <i class="fas fa-briefcase"></i> Position
                        </label>
                        <input type="text" id="reportPosition" readonly>
                    </div>

                    <div class="form-group">
                        <label for="reportInterviewer">
                            <i class="fas fa-user-tie"></i> Interviewer
                        </label>
                        <input type="text" id="reportInterviewer" readonly>
                    </div>

                    <div class="form-group">
                        <label for="reportInterviewDate">
                            <i class="fas fa-calendar"></i> Interview Date
                        </label>
                        <input type="date" id="reportInterviewDate" readonly>
                    </div>

                    <div class="form-group">
                        <label for="reportOverallScore">
                            <i class="fas fa-star"></i> Overall Score
                        </label>
                        <input type="text" id="reportOverallScore" readonly>
                    </div>

                    <div class="form-group">
                        <label for="reportRecommendation">
                            <i class="fas fa-thumbs-up"></i> Recommendation
                        </label>
                        <input type="text" id="reportRecommendation" readonly>
                    </div>

                    <div class="form-group">
                        <label for="reportNotes">
                            <i class="fas fa-sticky-note"></i> Additional Notes (Optional)
                        </label>
                        <textarea id="reportNotes" rows="4" 
                                placeholder="Add any additional comments or observations..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-success" onclick="sendInterviewReport()" id="sendReportBtn">
                        <i class="fas fa-paper-plane"></i> Send Report
                    </button>
                    <button class="btn btn-secondary" onclick="closeSendReportModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluation Rank Modal -->
    <div id="evaluationRankModal" class="evaluation-rank-modal">        <div class="evaluation-rank-content">
            <div class="evaluation-rank-header">
                <h3><i class="fas fa-chart-line"></i> <span id="rankModalTitle">Evaluation Rankings</span></h3>
                <div class="rank-header-actions">
                    <button class="btn btn-primary" id="sendJobSummaryBtn" onclick="sendJobEvaluationSummary()" title="Send Job Evaluation Summary" style="display: none; margin-right: 1rem;">
                        <i class="fas fa-envelope"></i> Send Summary
                    </button>
                    <button class="rank-close-btn" onclick="closeEvaluationRankModal()">&times;</button>
                </div>
            </div>
            <div class="evaluation-rank-body" id="evaluationRankBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Left Sidebar -->
        <nav id="sidebar" class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view">
                <a href="#"><i class="fas fa-medkit"></i> Health</a>
                <ul class="submenu">
                    <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                    <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                    <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                </ul>
            </li>
            <!-- Risk Management (separate section) -->
            <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
            <ul class="submenu">
                <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
            </ul>
            </li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                <ul class="submenu">
                    <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                    <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                    <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                    <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                    <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                    <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                <ul class="submenu">
                    <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                    <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                    <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                <ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="environment_view">
                <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                <ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                <a href="#"><i class="fas fa-lock"></i> Security</a>
                <ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
                        <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                        <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                <ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                <ul class="submenu">
                    <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                <a href="#"><i class="fas fa-users"></i> HR</a>
                <ul class="submenu">
                    <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                    <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                    <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                    <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                    <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                    <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                    <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                    <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                    <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                    <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                    <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                </ul>
            </li>
            <!-- Project Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="project_management_section">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                </ul>
            </li>
            <!-- Inventory Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                <ul class="submenu">
                    <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                    <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                    <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                    <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                </ul>
            </li>
            <!-- Workspaces: Catering -->
            <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                <a href="#"><i class="fas fa-utensils"></i> Workspaces  Catering</a>
                <ul class="submenu">
                    <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                    <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                    <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                    <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                    <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                </ul>
            </li>
            <li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
            <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                </ul>
            </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main id="mainContent" class="main-content">            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatarImg" class="user-avatar-circle" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHR4dCB4PSIyMCIgeT0iMjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlU8L3R4dD4KPHN2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>            <!-- Page Content -->
            <div class="content">
                <div class="interview-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-top-row">
                            <div class="header-left">
                                <h1 class="page-title">
                                    <i class="fas fa-users"></i>
                                    Interview Management
                                </h1>
                            </div>
                        </div>
                    </div>

                    <!-- Content Tabs Layout -->
                    <div class="content-tabs">                        <!-- Tab Navigation -->
                        <div class="tab-navigation">
                            <button class="tab-nav-btn active" id="jobsTabBtn" onclick="switchToTab('jobs')">
                                <i class="fas fa-briefcase"></i>
                                Jobs
                            </button>
                            <button class="tab-nav-btn" id="applicantsTabBtn" onclick="switchToTab('applicants')">
                                <i class="fas fa-users"></i>
                                Applicants
                            </button>                            <button class="tab-nav-btn" id="archivesTabBtn" onclick="switchToTab('archives')">
                                <i class="fas fa-archive"></i>
                                Archives
                            </button>
                            <button class="tab-nav-btn" id="hiredTabBtn" onclick="switchToTab('hired')">
                                <i class="fas fa-user-check"></i>
                                Hired
                            </button>
                        </div><!-- Jobs Tab Content -->
                        <div class="tab-content active" id="jobsTabContent">
                            <!-- Jobs Controls -->
                            <div class="tab-controls">
                                <div class="search-export-row">
                                    <div class="search-wrapper">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="searchInput" placeholder="Search by title, department, or code...">
                                    </div>
                                    <button class="btn btn-primary" id="exportBtn">
                                        <i class="fas fa-download"></i>
                                        Export Jobs
                                    </button>
                                </div>
                            </div>

                            <!-- Hidden filters (keeping functionality) -->
                            <div style="display: none;">
                                <select id="departmentFilter"><option value="">All Departments</option></select>
                                <select id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="closed">Closed</option>
                                    <option value="paused">Paused</option>
                                </select>
                                <select id="employmentTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="full-time">Full Time</option>
                                    <option value="part-time">Part Time</option>
                                    <option value="contract">Contract</option>
                                    <option value="internship">Internship</option>
                                    <option value="temporary">Temporary</option>
                                </select>
                                <select id="urgencyFilter">
                                    <option value="">All Urgency</option>
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="normal">Normal</option>
                                    <option value="low">Low</option>
                                </select>
                                <select id="sortBy">
                                    <option value="datePosted">Date Posted</option>
                                    <option value="jobTitle">Job Title</option>
                                    <option value="department">Department</option>
                                    <option value="applications">Applications</option>
                                    <option value="urgency">Urgency</option>
                                    <option value="status">Status</option>
                                </select>
                            </div>

                            <!-- Jobs Table Container -->
                            <div class="table-container">
                                <!-- Loading State -->
                                <div class="loading-state" id="loadingState">
                                    <div class="spinner"></div>
                                    <p>Loading job openings...</p>
                                </div>

                                <!-- Jobs Table -->
                                <table class="jobs-table" id="jobsTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Job Title</th>
                                            <th>Code</th>
                                            <th>Department</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Urgency</th>
                                            <th>Salary Range</th>
                                            <th>Applications</th>
                                            <th>Posted</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jobsTableBody">
                                        <!-- Jobs will be populated here -->
                                    </tbody>
                                </table>

                                <!-- Empty State -->
                                <div class="empty-state d-none" id="emptyState">
                                    <i class="fas fa-briefcase"></i>
                                    <h3>No Jobs Found</h3>
                                    <p>No job openings match your current filters.</p>
                                    <button class="btn btn-primary" onclick="clearFilters()">
                                        <i class="fas fa-refresh"></i>
                                        Clear Filters
                                    </button>
                                </div>

                                <!-- Error State -->
                                <div class="error-state" id="jobsErrorState" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>Error Loading Jobs</h3>
                                    <p id="jobsErrorMessage">Failed to load job data. Please try again.</p>
                                    <button class="btn btn-primary" onclick="loadJobs()">
                                        <i class="fas fa-refresh"></i>
                                        Retry
                                    </button>
                                    <button class="btn btn-secondary" onclick="forceStopLoading()">
                                        <i class="fas fa-stop"></i>
                                        Force Stop Loading
                                    </button>
                                    <button class="btn btn-info" onclick="debugFilters()">
                                        <i class="fas fa-bug"></i>
                                        Debug Filters
                                    </button>
                                    <button class="btn btn-warning" onclick="clearFilters()">
                                        <i class="fas fa-broom"></i>
                                        Clear All Filters
                                    </button>
                                </div>

                                <!-- Pagination -->
                                <div class="pagination d-none" id="pagination">
                                    <button class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="pagination-info">
                                        <span id="pageInfo">Page 1 of 1</span>
                                    </div>
                                    <button class="pagination-btn" id="nextPageBtn" onclick="changePage(1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div><!-- Applicants Tab Content -->
                        <div class="tab-content" id="applicantsTabContent">
                            <!-- Applicants Controls -->
                            <div class="tab-controls">
                                <div class="applicant-controls-row">
                                    <div class="selected-job-info">
                                        <h3 class="selected-job-title" id="selectedJobTitle">Select a job to view applicants</h3>
                                        <p class="selected-job-details" id="selectedJobDetails"></p>
                                    </div>
                                    <button class="btn btn-secondary" id="backToJobsBtn" onclick="switchToTab('jobs')">
                                        <i class="fas fa-arrow-left"></i>
                                        Back to Jobs
                                    </button>
                                </div>
                            </div>

                            <!-- Applicants Content -->
                            <div class="table-container">
                                <div class="no-applicants" id="noApplicantsMessage">
                                    <i class="fas fa-user-friends"></i>
                                    <h3>No Job Selected</h3>
                                    <p>Select a job from the Jobs tab to view its applicants.</p>
                                </div>                                <table class="applicants-table" id="applicantsTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Applied Date</th>
                                            <th>Status</th>
                                            <th>Resume</th>
                                            <th>Schedule</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="applicantsTableBody">
                                        <!-- Applicants will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Archives Tab Content -->
                        <div class="tab-content" id="archivesTabContent">
                            <!-- Archives Loading State -->
                            <div id="archivesLoadingState" class="loading-container">
                                <div class="loading-spinner"></div>
                                <h3>Loading archives...</h3>
                                <p>Connecting to Firebase archives</p>
                            </div>

                            <!-- Archives Error State -->
                            <div id="archivesErrorState" class="error-container" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Error loading archives</strong>
                                    <p id="archivesErrorMessage">Unable to connect to Firebase database</p>
                                </div>
                            </div>

                            <!-- Archives Table -->
                            <div id="archivesContainer" class="candidates-table-container" style="display: none;">
                                <div class="table-header">
                                    <h2 class="table-title">Archived Records</h2>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div class="real-time-indicator">
                                            <div class="pulse-dot"></div>
                                            Live Updates
                                        </div>
                                        <button id="refreshArchivesBtn" class="refresh-btn">
                                            <i class="fas fa-sync-alt"></i>
                                            Refresh
                                        </button>
                                    </div>
                                </div>

                                <table class="candidates-table" id="archivesTable">
                                    <thead>
                                        <tr>
                                            <th>Archive ID</th>
                                            <th>Type</th>
                                            <th>Title</th>
                                            <th>Status</th>
                                            <th>Date Archived</th>
                                            <th>Data Count</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archivesTableBody">
                                        <!-- Archives will be populated here -->
                                    </tbody>
                                </table>

                                <!-- Archives Empty State -->
                                <div id="archivesEmptyState" class="empty-state" style="display: none;">
                                    <i class="fas fa-archive"></i>
                                    <h3>No archives found</h3>
                                    <p>No archived records are available in the database</p>
                                </div>                                <div class="last-updated">
                                    Last updated: <span id="archivesLastUpdated">Never</span>
                                </div>
                            </div>
                        </div>

                        <!-- Hired Tab Content -->
                        <div class="tab-content" id="hiredTabContent">
                            <!-- Hired Loading State -->
                            <div id="hiredLoadingState" class="loading-container">
                                <i class="fas fa-spinner fa-spin"></i>
                                <h3>Loading hired candidates...</h3>
                                <p>Connecting to Firebase hired database</p>
                            </div>

                            <!-- Hired Error State -->
                            <div id="hiredErrorState" class="error-container" style="display: none;">
                                <div class="error-content">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Error loading hired candidates</strong>
                                    <p id="hiredErrorMessage">Unable to connect to Firebase database</p>
                                    <button id="retryHiredBtn" class="btn btn-primary">Retry</button>
                                </div>
                            </div>

                            <!-- Hired Table -->
                            <div id="hiredContainer" class="candidates-table-container" style="display: none;">
                                <!-- Controls -->
                                <div class="table-controls">
                                    <div class="controls-left">
                                        <!-- Refresh button removed -->
                                    </div>
                                </div>

                                <table class="candidates-table" id="hiredTable">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-user"></i> Name</th>
                                            <th><i class="fas fa-envelope"></i> Email</th>
                                            <th><i class="fas fa-briefcase"></i> Position</th>
                                            <th><i class="fas fa-building"></i> Department</th>
                                            <th><i class="fas fa-calendar"></i> Hired Date</th>
                                            <th><i class="fas fa-info-circle"></i> Status</th>
                                            <th><i class="fas fa-cogs"></i> Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hiredTableBody">
                                        <!-- Hired candidates will be populated here -->
                                    </tbody>
                                </table>

                                <!-- Hired Empty State -->
                                <div id="hiredEmptyState" class="empty-state" style="display: none;">
                                    <i class="fas fa-user-check"></i>
                                    <h3>No hired candidates found</h3>
                                    <p>No hired candidates are available in the database</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('? Firebase v8 initialized successfully');
            }
            return window.firebase;
        }

        // Initialize Firebase
        const firebase = initializeFirebase();
        const database = firebase.database();

        // ==========================================
        // EMBEDDED JAVASCRIPT MODULES
        // ==========================================

        // AuthManager Class - Embedded from js/auth.js
        class AuthManager {
            constructor() {
                const firebase = initializeFirebase();
                this.auth = firebase.auth();
                this.db = firebase.database();
                this.currentUser = null;
                this.userRole = null;
                this.companyId = null;
                this.userProfile = null;
                this.isReady = false;
                
                // Initialize auth state listener
                this.initializeAuthState();
            }

            async initializeAuthState() {
                return new Promise((resolve) => {
                    this.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            this.currentUser = user;
                            await this.loadUserRole();
                            await this.loadCompanyContext();
                            await this.loadUserProfile();
                            this.isReady = true;
                            
                            // Update user display elements centrally
                            await this.updateUserProfileDisplay();
                            
                            // Load company branding
                            if (window.companyDataService) {
                                await window.companyDataService.loadCompanyBranding();
                            }
                            
                            // Dispatch custom event when user is ready
                            window.dispatchEvent(new CustomEvent('userReady', {
                                detail: {
                                    user: this.currentUser,
                                    role: this.userRole,
                                    companyId: this.companyId,
                                    profile: this.userProfile
                                }
                            }));
                        } else {
                            this.currentUser = null;
                            this.userRole = null;
                            this.companyId = null;
                            this.userProfile = null;
                            this.isReady = false;
                        }
                        resolve(user);
                    });
                });
            }

            async loadUserRole() {
                if (!this.currentUser) return null;
                
                try {
                    const userRoleSnapshot = await this.db.ref(`userRoles/${this.currentUser.uid}`).once('value');
                    if (userRoleSnapshot.exists()) {
                        this.userRole = userRoleSnapshot.val();
                        localStorage.setItem('userRole', this.userRole);
                    } else {
                        this.userRole = 'user'; // Default role
                        localStorage.setItem('userRole', this.userRole);
                    }
                    return this.userRole;
                } catch (error) {
                    console.error('Error loading user role:', error);
                    this.userRole = 'user';
                    return this.userRole;
                }
            }

            async loadCompanyContext() {
                if (!this.currentUser) return null;
                
                try {
                    const userCompanySnapshot = await this.db.ref(`userCompanies/${this.currentUser.uid}`).once('value');
                    if (userCompanySnapshot.exists()) {
                        this.companyId = userCompanySnapshot.val();
                        localStorage.setItem('companyId', this.companyId);
                    } else {
                        console.warn('No company context found for user');
                        this.companyId = null;
                    }
                    return this.companyId;
                } catch (error) {
                    console.error('Error loading company context:', error);
                    return null;
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return null;
                
                try {
                    const profileSnapshot = await this.db.ref(`users/${this.currentUser.uid}`).once('value');
                    if (profileSnapshot.exists()) {
                        this.userProfile = profileSnapshot.val();
                    } else {
                        this.userProfile = {
                            email: this.currentUser.email,
                            displayName: this.currentUser.displayName || this.currentUser.email,
                            role: this.userRole
                        };
                    }
                    return this.userProfile;
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    return null;
                }
            }

            getCurrentUser() {
                console.log('?? AuthManager.getCurrentUser() called');
                
                // First check for 'currentUser' key (used by main login system)
                let user = localStorage.getItem('currentUser');
                if (user) {
                    console.log('? Found user in localStorage.currentUser');
                    const userData = JSON.parse(user);
                    console.log('?? User data:', {
                        email: userData.email,
                        uid: userData.uid,
                        companyId: userData.companyId
                    });
                    return userData;
                }
                
                // If not found, check for 'user' key (used by index.html modal login)
                user = localStorage.getItem('user');
                if (user) {
                    console.log('? Found user in localStorage.user (migrating to currentUser)');
                    const userData = JSON.parse(user);
                    console.log('?? User data:', {
                        email: userData.email,
                        uid: userData.uid,
                        companyId: userData.companyId
                    });
                    // Migrate the user data to the standard 'currentUser' key for consistency
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    return userData;
                }
                
                console.log('?? No user found in localStorage, falling back to this.currentUser');
                return this.currentUser;
            }

            setCurrentUser(userData) {
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('user', JSON.stringify(userData)); // For consistency with index.html
                this.currentUser = userData;
            }

            getUserRole() {
                return this.userRole || localStorage.getItem('userRole') || 'user';
            }

            getCompanyId() {
                return this.companyId || localStorage.getItem('companyId');
            }

            getUserProfile() {
                return this.userProfile;
            }

            async signOut() {
                try {
                    await this.auth.signOut();
                    localStorage.clear();
                    this.currentUser = null;
                    this.userRole = null;
                    this.companyId = null;
                    this.userProfile = null;
                    this.isReady = false;
                    return true;
                } catch (error) {
                    console.error('Error signing out:', error);
                    throw error;
                }
            }

            async waitForAuth() {
                if (this.isReady) return this.currentUser;
                
                return new Promise((resolve) => {
                    const unsubscribe = this.auth.onAuthStateChanged((user) => {
                        if (this.isReady) {
                            unsubscribe();
                            resolve(user);
                        }
                    });
                });
            }

            // Get user initials for avatar
            getUserInitials() {
                if (this.currentUser) {
                    const displayName = this.currentUser.displayName || this.currentUser.email || '';
                    const names = displayName.split(' ');
                    if (names.length >= 2) {
                        return (names[0].charAt(0) + names[1].charAt(0)).toUpperCase();
                    } else {
                        return displayName.charAt(0).toUpperCase();
                    }
                }
                return 'U';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL from Firebase Storage or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            }

            // Update user avatar display with custom image or initials (matching roles.html pattern)
            async updateUserAvatarDisplay(elementId = 'userAvatarImg') {
                const avatarElement = document.getElementById(elementId);
                if (avatarElement) {
                    try {
                        const avatarUrl = await this.getUserAvatarUrl();
                        if (avatarUrl) {
                            // Show custom avatar for img element
                            if (avatarElement.tagName === 'IMG') {
                                avatarElement.src = avatarUrl;
                                avatarElement.alt = 'Profile Picture';
                            } else {
                                // Show custom avatar for div element
                                avatarElement.innerHTML = `<img src="${avatarUrl}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                            }
                        } else {
                            // Show initials
                            if (avatarElement.tagName === 'IMG') {
                                // Generate initials avatar for img element
                                const displayName = this.getUserDisplayName();
                                this.generateInitialsAvatar(displayName, avatarElement);
                            } else {
                                // Show initials text for div element
                                avatarElement.textContent = this.getUserInitials();
                            }
                        }
                    } catch (error) {
                        console.error('Error updating avatar display:', error);
                        // Fallback to initials
                        if (avatarElement.tagName === 'IMG') {
                            const displayName = this.getUserDisplayName();
                            this.generateInitialsAvatar(displayName, avatarElement);
                        } else {
                            avatarElement.textContent = this.getUserInitials();
                        }
                    }
                }
            }

            // Get user display name
            getUserDisplayName() {
                if (this.currentUser) {
                    return this.currentUser.displayName || this.currentUser.email || 'User';
                }
                return 'User';
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Update profile dropdown with user info and avatar (matching roles.html pattern)
            async updateProfileDropdown() {
                const profileDropdown = document.querySelector('.profile-dropdown');
                if (profileDropdown && this.currentUser) {
                    const initials = this.getUserInitials();
                    const displayName = this.getUserDisplayName();
                    const email = this.getUserEmail();
                    
                    // Try to get avatar URL for dropdown
                    let dropdownAvatarHtml;
                    const avatarUrl = await this.getUserAvatarUrl();
                    if (avatarUrl) {
                        dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                    }
                    
                    // Update profile dropdown with user info
                    const userInfoHtml = `
                        <ul>
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${dropdownAvatarHtml}
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    `;
                    
                    profileDropdown.innerHTML = userInfoHtml;
                    
                    // Dispatch event to notify that profile dropdown was updated
                    document.dispatchEvent(new CustomEvent('userProfileUpdated'));
                    
                    // Re-attach logout event listener (backup in case event doesn't work)
                    const logoutBtn = profileDropdown.querySelector('#logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            try {
                                await this.signOut();
                                window.location.href = 'login.html';
                            } catch (error) {
                                console.error('Error signing out:', error);
                                alert('Error signing out. Please try again.');
                            }
                        });
                    }
                }
            }

            // Update user profile display elements (centralized method matching roles.html)
            async updateUserProfileDisplay() {
                console.log('?? Updating user profile display centrally...');
                
                // Update avatar displays with custom images or initials
                await this.updateUserAvatarDisplay('userAvatarImg');
                await this.updateUserAvatarDisplay('userInitials'); // Alternative ID used in some pages
                
                // Update user name displays
                const userNameElements = document.querySelectorAll('#userName, #userDisplayName, .user-name-display');
                userNameElements.forEach(element => {
                    element.textContent = this.getUserDisplayName();
                    console.log(`? Updated user name: ${this.getUserDisplayName()}`);
                });
                
                // Update user email displays
                const userEmailElements = document.querySelectorAll('#userEmail, #userDisplayEmail, .user-email-display');
                userEmailElements.forEach(element => {
                    element.textContent = this.getUserEmail();
                    console.log(`? Updated user email: ${this.getUserEmail()}`);
                });
                
                // Update user role displays
                const userRoleElements = document.querySelectorAll('#userRole, .user-role-display');
                userRoleElements.forEach(element => {
                    element.textContent = this.getUserRole();
                    console.log(`? Updated user role: ${this.getUserRole()}`);
                });

                // Update profile dropdown
                await this.updateProfileDropdown();
                
                // Update menu visibility based on user role and permissions
                if (this.currentUser && this.currentUser.companyId && this.currentUser.role) {
                    console.log('?? Updating menu visibility based on user permissions...');
                    await updateMenuVisibility();
                } else {
                    console.log('?? Missing user context for menu permissions');
                }
                
                console.log('? User profile display update complete');
            }
        }

        // CompanyDataService Class - Embedded from js/company-data-service.js
        class CompanyDataService {
            constructor() {
                const firebase = initializeFirebase();
                this.db = firebase.database();
                this.auth = firebase.auth();
                this.currentCompanyId = null;
            }

            async initializeUserContext() {
                // Initialize user context for company data
                console.log('?? Initializing user context for company data service...');
                
                // Get user from authManager first
                let user = window.authManager?.getCurrentUser();
                if (!user) {
                    // Fallback to Firebase auth
                    user = this.auth.currentUser;
                }
                
                if (!user) {
                    console.warn('?? No user found for context initialization');
                    return;
                }
                
                console.log('?? User found for context:', user.email || user.uid);
                
                // Pre-load company ID
                await this.getCurrentCompanyId();
                
                console.log('? User context initialized');
            }

            async getCurrentCompanyId() {
                if (this.currentCompanyId) return this.currentCompanyId;
                
                // Get user from authManager first, then fallback to auth.currentUser
                let user = window.authManager?.getCurrentUser();
                if (!user) {
                    user = this.auth.currentUser;
                }
                
                if (!user) {
                    console.warn('?? No user found for company ID lookup');
                    return null;
                }
                
                // First try to get company ID from user object (localStorage)
                if (user.companyId) {
                    console.log('? Company ID found in user object:', user.companyId);
                    this.currentCompanyId = user.companyId;
                    return this.currentCompanyId;
                }
                
                try {
                    const uid = user.uid || user.id; // Handle both Firebase user and localStorage user objects
                    console.log('?? Looking up company ID for user:', uid);
                    
                    const companySnapshot = await this.db.ref(`userCompanies/${uid}`).once('value');
                    if (companySnapshot.exists()) {
                        this.currentCompanyId = companySnapshot.val();
                        console.log('? Company ID found in Firebase:', this.currentCompanyId);
                        return this.currentCompanyId;
                    }
                    
                    console.warn('?? No company ID found in Firebase for user:', uid);
                    return null;
                } catch (error) {
                    console.error('Error getting company ID:', error);
                    return null;
                }
            }

            async getCompanyData(path = '') {
                const companyId = await this.getCurrentCompanyId();
                if (!companyId) return null;
                
                try {
                    const dataPath = path ? `companies/${companyId}/${path}` : `companies/${companyId}`;
                    const snapshot = await this.db.ref(dataPath).once('value');
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (error) {
                    console.error('Error getting company data:', error);
                    return null;
                }
            }

            async setCompanyData(path, data) {
                const companyId = await this.getCurrentCompanyId();
                if (!companyId) return false;
                
                try {
                    const dataPath = `companies/${companyId}/${path}`;
                    await this.db.ref(dataPath).set(data);
                    return true;
                } catch (error) {
                    console.error('Error setting company data:', error);
                    return false;
                }
            }

            async updateCompanyData(path, updates) {
                const companyId = await this.getCurrentCompanyId();
                if (!companyId) return false;
                
                try {
                    const dataPath = `companies/${companyId}/${path}`;
                    await this.db.ref(dataPath).update(updates);
                    return true;
                } catch (error) {
                    console.error('Error updating company data:', error);
                    return false;
                }
            }

            getCompanyRef(path = '') {
                if (!this.currentCompanyId) return null;
                const dataPath = path ? `companies/${this.currentCompanyId}/${path}` : `companies/${this.currentCompanyId}`;
                return this.db.ref(dataPath);
            }

            async loadCompanyBranding() {
                console.log('?? Loading company branding...');
                
                // Initialize user context first
                await this.initializeUserContext();
                
                // Check if user is authenticated using authManager first
                let user = window.authManager?.getCurrentUser();
                if (!user) {
                    // Fallback to Firebase auth
                    user = this.auth.currentUser;
                }
                
                if (!user) {
                    console.warn('?? No authenticated user found for company branding');
                    this.showFallbackBranding();
                    return;
                }
                
                console.log('?? User found for company branding:', user.email || user.uid);
                
                try {
                    // Ensure we have a company ID
                    const companyId = await this.getCurrentCompanyId();
                    if (!companyId) {
                        console.warn('?? No company ID found for user, showing fallback branding');
                        this.showFallbackBranding();
                        return;
                    }
                    
                    console.log('?? Company ID found:', companyId);
                    
                    // Load company data from Firebase
                    const companySnapshot = await this.db.ref(`companies/${companyId}`).once('value');
                    if (!companySnapshot.exists()) {
                        console.warn('?? Company data not found in Firebase, showing fallback branding');
                        this.showFallbackBranding();
                        return;
                    }
                    
                    const companyData = companySnapshot.val();
                    console.log('?? Company data loaded:', companyData.name || companyId);
                    
                    // Store the company data and update UI
                    this.currentCompany = companyData;
                    this.updateCompanyBranding(companyData);
                    
                } catch (error) {
                    console.error('? Error loading company branding:', error);
                    this.showFallbackBranding();
                }
            }

            updateCompanyBranding(companyData = null) {
                console.log('?? updateCompanyBranding() called');
                
                // Use passed data or stored data
                const company = companyData || this.currentCompany;
                if (!company) {
                    console.log('? No company data available for branding');
                    this.showFallbackBranding();
                    return;
                }

                console.log('? Company data found:', company.name || company.companyName);

                // Update company logo and name in header
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerCompanyName = document.getElementById('headerCompanyName');

                console.log('Header elements found:', {
                    logo: headerLogo ? '?' : '?',
                    companyName: headerCompanyName ? '?' : '?'
                });

                // Update company name
                if (headerCompanyName) {
                    const companyName = company.name || company.companyName || '';
                    headerCompanyName.textContent = companyName;
                    console.log('? Company name updated:', companyName);
                }

                // Update logo or show placeholder
                const logoUrl = company.logoUrl || company.logo;
                if (logoUrl) {
                    console.log('? Company logo URL found:', logoUrl);
                    
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log('? Company logo displayed');
                    }
                } else {
                    console.log('?? No company logo URL, showing placeholder');
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        console.log('? Company logo hidden');
                    }
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab HSE')) {
                    document.title = title.replace('Dreamex Datalab HSE', `${this.currentCompany.companyName} HSE`);
                    console.log('? Page title updated');
                }
            }

            showFallbackBranding() {
                console.log('?? Showing fallback branding');
                const headerCompanyName = document.getElementById('headerCompanyName');
                const headerLogo = document.getElementById('headerCompanyLogo');
                
                // Hide company logo
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    console.log('? Company logo hidden (fallback)');
                }
                
                // Set fallback company name - using "Imou Dream" as mentioned by user
                if (headerCompanyName) {
                    headerCompanyName.textContent = 'Imou Dream';
                    console.log('? Fallback company name set to: Imou Dream');
                }
            }
        }

        // NotificationManager Class - Embedded from js/notifications.js
        class NotificationManager {
            constructor() {
                this.notifications = this.loadNotifications();
                this.settings = this.loadSettings();
                this.firebaseListener = null;
                this.firebaseInitialized = false;
                this.initializeNotifications();
            }

            loadSettings() {
                const defaultSettings = {
                    emailNotifications: true,
                    pushNotifications: true,
                    notificationDisplay: '30',
                    showReadNotifications: false
                };
                
                const saved = localStorage.getItem('notificationSettings');
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            }

            saveSettings() {
                localStorage.setItem('notificationSettings', JSON.stringify(this.settings));
                this.renderNotifications();
            }

            initializeNotifications() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.setupNotificationElements();
                    });
                } else {
                    this.setupNotificationElements();
                }
            }

            setupNotificationElements() {
                const notificationBtn = document.getElementById('notificationBtn');
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', () => {
                        const dropdown = document.querySelector('.notification-dropdown');
                        if (dropdown) {
                            dropdown.classList.toggle('show');
                        }
                    });
                }

                const markAllReadBtn = document.querySelector('.mark-all-read');
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', () => {
                        this.markAllAsRead();
                    });
                }

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications')) {
                        const dropdown = document.querySelector('.notification-dropdown');
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    }
                });

                this.updateNotificationBadge();
                this.renderNotifications();
            }

            loadNotifications() {
                const notifications = localStorage.getItem('notifications');
                return notifications ? JSON.parse(notifications) : [];
            }

            saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
                setTimeout(() => {
                    this.updateNotificationBadge();
                }, 10);
                this.renderNotifications();
            }

            addNotification(notification) {
                const newNotification = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    read: false,
                    ...notification
                };

                this.notifications.unshift(newNotification);
                this.saveNotifications();
            }

            markAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.saveNotifications();
                }
            }

            markAllAsRead() {
                this.notifications.forEach(notification => {
                    notification.read = true;
                });
                this.saveNotifications();
            }

            updateNotificationBadge() {
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    const unreadCount = this.notifications.filter(n => !n.read).length;
                    badge.textContent = unreadCount.toString();
                    
                    if (unreadCount > 0) {
                        badge.style.display = 'inline-block';
                        badge.setAttribute('data-count', unreadCount);
                    } else {
                        badge.style.display = 'none';
                        badge.removeAttribute('data-count');
                    }
                }
            }

            renderNotifications() {
                const notificationList = document.querySelector('.notification-list');
                if (!notificationList) return;

                notificationList.innerHTML = '';

                let filteredNotifications = this.notifications;
                
                const daysToShow = parseInt(this.settings.notificationDisplay);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysToShow);
                
                filteredNotifications = filteredNotifications.filter(notification => 
                    new Date(notification.timestamp) > cutoffDate
                );

                if (!this.settings.showReadNotifications) {
                    filteredNotifications = filteredNotifications.filter(n => !n.read);
                }

                if (filteredNotifications.length === 0) {
                    notificationList.innerHTML = '<div class="notification-item">No notifications</div>';
                    return;
                }

                filteredNotifications.forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                    
                    const date = new Date(notification.timestamp);
                    const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                    notificationElement.innerHTML = `
                        <div class="notification-header">
                            <span class="notification-type">${notification.type}</span>
                            <span class="notification-time">${timeString}</span>
                        </div>
                        <div class="notification-content">${notification.message}</div>
                    `;

                    notificationElement.addEventListener('click', () => {
                        this.markAsRead(notification.id);
                        if (notification.link) {
                            window.location.href = notification.link;
                        }
                    });

                    notificationList.appendChild(notificationElement);
                });
            }
        }

        // Email Notification Service Class - Embedded from js/email-service.js (partial)
        class EmailNotificationService {
            constructor() {
                const firebase = initializeFirebase();
                this.db = firebase.database();
                this.auth = firebase.auth();
                this.smtpServerUrl = 'http://localhost:3001';
                this.useSmtpService = true;
                this.fromEmail = 'info@dreamexdatalab.com';
                this.fromName = 'Dreamex Datalab HSE System';
                this.apiKey = 'dreemex_hse_email_service_2025';
            }

            async sendNotificationEmail(recipient, subject, message) {
                try {
                    const response = await fetch(`${this.smtpServerUrl}/send-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': this.apiKey
                        },
                        body: JSON.stringify({
                            to: recipient,
                            subject: subject,
                            html: message,
                            from: this.fromEmail,
                            fromName: this.fromName
                        })
                    });

                    return response.ok;
                } catch (error) {
                    console.error('Error sending email:', error);
                    return false;
                }
            }
        }

        // Global Preferences Loader Class - Embedded from js/preferences-loader.js (simplified)
        class PreferencesLoader {
            constructor() {
                this.initializePreferences();
            }

            async initializePreferences() {
                const cachedPrefs = localStorage.getItem('userPreferences');
                if (cachedPrefs) {
                    try {
                        const preferences = JSON.parse(cachedPrefs);
                        this.applyPreferences(preferences);
                    } catch (error) {
                        console.error('Error applying cached preferences:', error);
                    }
                }
            }

            applyPreferences(preferences) {
                document.documentElement.setAttribute('data-theme', preferences.colorScheme || 'light');
                
                if (Array.isArray(preferences.spage)) {
                    const menuItems = document.querySelectorAll('[data-feature]');
                    menuItems.forEach(item => {
                        const feature = item.getAttribute('data-feature');
                        if (feature) {
                            item.style.display = preferences.spage.includes(feature) ? '' : 'none';
                        }
                    });
                }

                window.dispatchEvent(new CustomEvent('preferencesUpdated', {
                    detail: preferences
                }));
            }

            updateMenuVisibility() {
                const user = window.authManager?.getCurrentUser();
                const role = window.authManager?.getUserRole();
                
                if (!user || !role) return;

                // Menu visibility is now handled by updateMenuVisibility() method
                // which loads permissions from company-created roles
            }
        }

        // Initialize Global Services
        window.authManager = new AuthManager();
        window.companyDataService = new CompanyDataService();
        window.notificationManager = new NotificationManager();
        window.emailNotificationService = new EmailNotificationService();
        window.PreferencesLoader = new PreferencesLoader();

        console.log('? All embedded services initialized');

        // Debug logging for localStorage
        console.log('?? Debugging localStorage content:');
        console.log('?? currentUser:', localStorage.getItem('currentUser'));
        console.log('?? user:', localStorage.getItem('user'));
        console.log('?? userRole:', localStorage.getItem('userRole'));
        console.log('?? companyId:', localStorage.getItem('companyId'));

        // For testing - simulate user data if none exists (remove this in production)
        if (!localStorage.getItem('currentUser') && !localStorage.getItem('user')) {
            console.log('?? No user data found - creating test user for debugging');
            const testUser = {
                uid: 'test-user-123',
                email: 'test@imoudream.com',
                displayName: 'Test User',
                companyId: 'imou-dream-company-id'
            };
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            console.log('? Test user created:', testUser);
        }

        // DOM Elements (old candidate system - some may not exist)
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const candidatesContainer = document.getElementById('candidatesContainer');
        const candidatesTableBody = document.getElementById('candidatesTableBody');
        const emptyState = document.getElementById('emptyState');
        const refreshBtn = document.getElementById('refreshBtn');
        const lastUpdated = document.getElementById('lastUpdated');
        const totalCandidates = document.getElementById('totalCandidates');
        const pendingCandidates = document.getElementById('pendingCandidates');
        const interviewedCandidates = document.getElementById('interviewedCandidates');
        const errorMessage = document.getElementById('errorMessage');        // Jobs DOM Elements
        const jobsLoadingState = document.getElementById('loadingState'); // Loading state element
        const jobsErrorState = document.getElementById('jobsErrorState'); // Error state element
        const jobsContainer = document.querySelector('.table-container'); // Table container element
        const jobsTableBody = document.getElementById('jobsTableBody');
        const jobsEmptyState = document.getElementById('emptyState'); // Empty state element
        const refreshJobsBtn = document.getElementById('refreshJobsBtn'); // Refresh button (may not exist)
        const jobsLastUpdated = document.getElementById('jobsLastUpdated'); // Last updated (may not exist)
        const totalJobs = document.getElementById('totalJobs'); // Stats element (may not exist)
        const activeJobs = document.getElementById('activeJobs'); // Stats element (may not exist)
        const jobsErrorMessage = document.getElementById('jobsErrorMessage'); // Error message element        // Archives DOM Elements
        const archivesLoadingState = document.getElementById('archivesLoadingState');
        const archivesErrorState = document.getElementById('archivesErrorState');
        const archivesContainer = document.getElementById('archivesContainer');
        const archivesTableBody = document.getElementById('archivesTableBody');
        const archivesEmptyState = document.getElementById('archivesEmptyState');
        const refreshArchivesBtn = document.getElementById('refreshArchivesBtn');
        const archivesLastUpdated = document.getElementById('archivesLastUpdated');
        const archivesErrorMessage = document.getElementById('archivesErrorMessage');
        const totalArchives = document.getElementById('totalArchives');

        // Hired DOM Elements
        const hiredLoadingState = document.getElementById('hiredLoadingState');
        const hiredErrorState = document.getElementById('hiredErrorState');
        const hiredContainer = document.getElementById('hiredContainer');
        const hiredTableBody = document.getElementById('hiredTableBody');
        const hiredEmptyState = document.getElementById('hiredEmptyState');
        const hiredLastUpdated = document.getElementById('hiredLastUpdated');
        const hiredErrorMessage = document.getElementById('hiredErrorMessage');
        const totalHired = document.getElementById('totalHired');

        // State
        let candidatesData = {};
        let jobsData = {};
        let archivesData = {};
        let hiredData = {};
        let isLoading = false;
        let isJobsLoading = false;
        let isArchivesLoading = false;
        let isHiredLoading = false;
        let currentJobFilter = null; // For filtering applicants by job

        // Initialize the page
        async function initializePage() {
            console.log('?? Initializing page...');
            showJobsLoading();
            await loadJobs();
            setupJobsRealTimeListener();
        }

        // Test function to verify table functionality
        function testJobsTable() {
            console.log('?? Testing jobs table with sample data...');
            jobsData = {
                'test-job-1': {
                    id: 'test-job-1',
                    title: 'Test Job Title',
                    jobTitle: 'Test Job Title',
                    position: 'Test Job Title',
                    positionCode: 'TEST001',
                    department: 'Test Department',
                    location: 'Test Location',
                    employmentType: 'Full-time',
                    status: 'closed',
                    originalStatus: 'active',
                    datePosted: '2024-01-15',
                    archivedDate: '2024-07-24',
                    closedDate: '2024-07-24',
                    archiveReason: 'Position filled',
                    closedBy: 'Admin',
                    applicationCount: 5,
                    minSalary: 50000,
                    maxSalary: 70000,
                    urgency: 'normal',
                    description: 'Test job description',
                    requirements: 'Test requirements'
                }
            };
            
            console.log('?? Sample data added:', jobsData);
            showJobs();
            renderJobs();
            updateJobsStats();
        }        // Show loading state
        function showLoading() {
            isLoading = true;
            if (loadingState) loadingState.style.display = 'block';
            if (errorState) errorState.style.display = 'none';
            if (candidatesContainer) candidatesContainer.style.display = 'none';
            if (refreshBtn) refreshBtn.disabled = true;
        }

        // Show error state
        function showError(message) {
            isLoading = false;
            if (loadingState) loadingState.style.display = 'none';
            if (errorState) errorState.style.display = 'flex';
            if (candidatesContainer) candidatesContainer.style.display = 'none';
            if (errorMessage) errorMessage.textContent = message;
            if (refreshBtn) refreshBtn.disabled = false;
        }

        // Show candidates table
        function showCandidates() {
            isLoading = false;
            if (loadingState) loadingState.style.display = 'none';
            if (errorState) errorState.style.display = 'none';
            if (candidatesContainer) candidatesContainer.style.display = 'block';
            if (refreshBtn) refreshBtn.disabled = false;
            updateLastUpdated();
        }// Load applicants from Firebase
        async function loadCandidates() {
            try {
                const applicationsRef = database.ref('archives/-OSeQpCGGgMj1IDLhTtc/applications');
                const snapshot = await applicationsRef.once('value');
                
                if (snapshot.exists()) {
                    candidatesData = snapshot.val();
                    renderCandidates();
                    updateStats();
                    showCandidates();
                } else {
                    candidatesData = {};
                    renderCandidates();
                    updateStats();
                    showCandidates();
                }
            } catch (error) {
                console.error('Error loading applicants:', error);
                showError(`Failed to load applicants: ${error.message}`);
            }
        }

        // Setup real-time listener
        function setupRealTimeListener() {
            const applicationsRef = database.ref('archives/-OSeQpCGGgMj1IDLhTtc/applications');
            
            applicationsRef.on('value', (snapshot) => {
                if (!isLoading) {
                    if (snapshot.exists()) {
                        candidatesData = snapshot.val();
                    } else {
                        candidatesData = {};
                    }
                    renderCandidates();
                    updateStats();
                    updateLastUpdated();
                }
            }, (error) => {
                console.error('Real-time listener error:', error);
                showError(`Real-time updates failed: ${error.message}`);
            });
        }        // Render candidates in the table
        function renderCandidates() {
            if (!candidatesTableBody) return; // Protection against missing element
            
            candidatesTableBody.innerHTML = '';
            
            let candidates = Object.entries(candidatesData);
            
            // Apply job filter if active
            if (currentJobFilter) {
                candidates = candidates.filter(([candidateId, candidate]) => {
                    // Check if candidate applied for the specific job
                    const candidatePosition = candidate.position || candidate.jobTitle || candidate.positionApplied || '';
                    const candidatePositionCode = candidate.positionCode || candidate.jobId || candidate.archiveId || '';
                    
                    // Match by position code (archive ID) or job title
                    return candidatePositionCode === currentJobFilter.positionCode || 
                           candidatePosition.toLowerCase().includes(currentJobFilter.title.toLowerCase());
                });
            }
            
            if (candidates.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                if (candidatesTableBody.closest('table')) candidatesTableBody.closest('table').style.display = 'none';
                
                // Update empty state message if filtering
                if (currentJobFilter && emptyState) {
                    const emptyStateContent = emptyState.querySelector('h3');
                    const emptyStateSubtext = emptyState.querySelector('p');
                    if (emptyStateContent) emptyStateContent.textContent = `No applicants found for "${currentJobFilter.title}"`;
                    if (emptyStateSubtext) emptyStateSubtext.textContent = 'No applications match this job position';
                }
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            if (candidatesTableBody.closest('table')) candidatesTableBody.closest('table').style.display = 'table';

            candidates.forEach(([candidateId, candidate]) => {
                const row = createCandidateRow(candidateId, candidate);
                candidatesTableBody.appendChild(row);
            });
        }// Create a table row for a candidate
        function createCandidateRow(candidateId, candidate) {
            const row = document.createElement('tr');
            
            // Get candidate info with expanded fallbacks for name
            const name = candidate.fullName || 
                        candidate.name || 
                        candidate.firstName + ' ' + candidate.lastName ||
                        candidate.applicantName ||
                        candidate.candidateName ||
                        (candidate.firstName ? candidate.firstName : '') + 
                        (candidate.lastName ? ' ' + candidate.lastName : '') ||
                        candidateId || 
                        'Unnamed Applicant';
            
            const email = candidate.email || candidate.emailAddress || 'No email';
            const position = candidate.position || candidate.jobTitle || candidate.positionApplied || 'Not specified';
            const phone = candidate.phone || candidate.phoneNumber || candidate.contactNumber || 'Not provided';            const experience = candidate.experience || candidate.yearsOfExperience || candidate.workExperience || 'Not specified';
            const applicationDate = candidate.applicationDate || candidate.submittedAt || candidate.timestamp || candidate.dateApplied || 'Unknown';
            const status = candidate.status || candidate.interviewStatus || candidate.applicationStatus || 'pending';
            
            // Handle files - check multiple possible fields for uploaded files
            const files = candidate.files || 
                         candidate.attachments || 
                         candidate.documents || 
                         candidate.cv || 
                         candidate.resume || 
                         candidate.uploads || 
                         [];
            
            // Ensure files is an array
            const filesArray = Array.isArray(files) ? files : 
                              (files && typeof files === 'object' ? Object.values(files) : 
                              (files ? [files] : []));
            
            // Format application date
            let formattedDate = 'Unknown';
            if (applicationDate && applicationDate !== 'Unknown') {
                try {
                    const date = new Date(applicationDate);
                    formattedDate = date.toLocaleDateString();
                } catch (e) {
                    formattedDate = applicationDate;
                }
            }            // Get initials for avatar
            const cleanName = name.replace('Unnamed Applicant', candidateId || 'UA');
            const nameWords = cleanName.split(' ').filter(word => word.length > 0);
            const initials = nameWords.length > 0 ? 
                           nameWords.map(n => n[0]).join('').substring(0, 2).toUpperCase() : 
                           'UA';            row.innerHTML = `
                <td>
                    <div class="candidate-info">
                        <div class="candidate-avatar">${initials}</div>
                        <div class="candidate-details">
                            <div class="candidate-name">${escapeHtml(name)}</div>
                            <div class="candidate-email">${escapeHtml(email)}</div>
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(position)}</td>
                <td>
                    <span class="status-badge status-${status.toLowerCase()}">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td>${escapeHtml(phone)}</td>
                <td class="files-column">
                    ${createFilesDisplay(filesArray)}
                </td>
            `;

            return row;
        }        // Update statistics
        function updateStats() {
            let candidates = Object.values(candidatesData);
            
            // Apply job filter to stats if active
            if (currentJobFilter) {
                candidates = candidates.filter(candidate => {
                    const candidatePosition = candidate.position || candidate.jobTitle || candidate.positionApplied || '';
                    const candidatePositionCode = candidate.positionCode || candidate.jobId || candidate.archiveId || '';
                    
                    return candidatePositionCode === currentJobFilter.positionCode || 
                           candidatePosition.toLowerCase().includes(currentJobFilter.title.toLowerCase());
                });
            }
            
            const total = candidates.length;
            const pending = candidates.filter(c => (c.status || 'pending').toLowerCase() === 'pending').length;
            const interviewed = candidates.filter(c => (c.status || 'pending').toLowerCase() === 'interviewed').length;

            if (totalCandidates) totalCandidates.textContent = total;
            if (pendingCandidates) pendingCandidates.textContent = pending;
            if (interviewedCandidates) interviewedCandidates.textContent = interviewed;
        }        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            if (lastUpdated) lastUpdated.textContent = now.toLocaleString();
        }// Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }        // Create files display for the files column
        function createFilesDisplay(filesArray) {
            if (!filesArray || filesArray.length === 0) {
                return '<div class="no-files">No files</div>';
            }

            return filesArray.map((file, index) => {
                // Handle different file object structures
                let fileName = '';
                let fileUrl = '';
                let fileType = '';

                if (typeof file === 'string') {
                    // If file is just a URL string
                    fileUrl = file;
                    fileName = file.split('/').pop() || 'Document';
                    fileType = getFileTypeFromUrl(file);
                } else if (file && typeof file === 'object') {
                    // If file is an object with properties
                    fileName = file.name || file.fileName || file.originalName || 'Document';
                    fileUrl = file.url || file.downloadURL || file.link || file.path || '';
                    fileType = file.type || file.mimeType || getFileTypeFromName(fileName);
                }

                const fileIcon = getFileIcon(fileType, fileName);
                const displayName = fileName.length > 15 ? fileName.substring(0, 15) + '...' : fileName;

                if (fileUrl) {
                    return `
                        <div class="file-item">
                            <div class="file-link" 
                                 data-file-url="${escapeHtml(fileUrl)}" 
                                 data-file-name="${escapeHtml(fileName)}" 
                                 data-file-type="${escapeHtml(fileType)}" 
                                 title="${escapeHtml(fileName)}" 
                                 style="cursor: pointer;">
                                <i class="fas ${fileIcon} file-icon"></i>
                                <span class="file-name">${escapeHtml(displayName)}</span>
                            </div>
                            <button class="download-btn" 
                                    data-download-url="${escapeHtml(fileUrl)}" 
                                    data-download-name="${escapeHtml(fileName)}" 
                                    title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="file-item">
                            <i class="fas ${fileIcon} file-icon"></i>
                            <span class="file-name" title="${escapeHtml(fileName)}">${escapeHtml(displayName)}</span>
                            <span style="color: #dc3545; font-size: 0.7rem;" title="File not accessible">!</span>
                        </div>
                    `;
                }
            }).join('');
        }

        // Get file icon based on file type or name
        function getFileIcon(fileType, fileName) {
            const lowerFileName = (fileName || '').toLowerCase();
            const lowerFileType = (fileType || '').toLowerCase();

            // Check by file extension
            if (lowerFileName.endsWith('.pdf') || lowerFileType.includes('pdf')) {
                return 'fa-file-pdf';
            } else if (lowerFileName.endsWith('.doc') || lowerFileName.endsWith('.docx') || 
                      lowerFileType.includes('word') || lowerFileType.includes('document')) {
                return 'fa-file-word';
            } else if (lowerFileName.endsWith('.xls') || lowerFileName.endsWith('.xlsx') || 
                      lowerFileType.includes('excel') || lowerFileType.includes('spreadsheet')) {
                return 'fa-file-excel';
            } else if (lowerFileName.endsWith('.ppt') || lowerFileName.endsWith('.pptx') || 
                      lowerFileType.includes('powerpoint') || lowerFileType.includes('presentation')) {
                return 'fa-file-powerpoint';
            } else if (lowerFileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/) || 
                      lowerFileType.includes('image')) {
                return 'fa-file-image';
            } else if (lowerFileName.match(/\.(txt|rtf)$/) || lowerFileType.includes('text')) {
                return 'fa-file-alt';
            } else if (lowerFileName.match(/\.(zip|rar|7z|tar|gz)$/) || 
                      lowerFileType.includes('archive') || lowerFileType.includes('compressed')) {
                return 'fa-file-archive';
            } else {
                return 'fa-file';
            }
        }

        // Get file type from URL
        function getFileTypeFromUrl(url) {
            const extension = url.split('.').pop().toLowerCase();
            return extension;
        }

        // Get file type from file name
        function getFileTypeFromName(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            return extension;
        }        // Function to open and preview files
        function openFile(url, fileName, fileType) {
            const modal = document.getElementById('filePreviewModal');
            const previewBody = document.getElementById('previewBody');
            const previewTitle = document.getElementById('previewTitle');
            const downloadBtn = document.getElementById('previewDownloadBtn');
            const openBtn = document.getElementById('previewOpenBtn');

            // Set title
            previewTitle.textContent = fileName;

            // Clear previous content
            previewBody.innerHTML = '';

            // Setup buttons
            downloadBtn.onclick = () => downloadFile(url, fileName);
            openBtn.onclick = () => window.open(url, '_blank');

            // Determine file type and create appropriate preview
            const lowerFileName = fileName.toLowerCase();
            if (lowerFileName.match(/\.(pdf)$/)) {
                // PDF Preview
                const iframe = document.createElement('iframe');
                iframe.className = 'preview-iframe';
                iframe.src = url;
                previewBody.appendChild(iframe);
            } else if (lowerFileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)) {
                // Image Preview
                const img = document.createElement('img');
                img.className = 'preview-image';
                img.src = url;
                img.alt = fileName;
                previewBody.appendChild(img);
            } else if (lowerFileName.match(/\.(doc|docx|xls|xlsx|ppt|pptx)$/)) {
                // Microsoft Office files - Try to use Office Online Viewer
                const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
                const iframe = document.createElement('iframe');
                iframe.className = 'preview-iframe';
                iframe.src = officeViewerUrl;
                previewBody.appendChild(iframe);
            } else if (lowerFileName.match(/\.(txt|rtf|csv)$/)) {
                // Text files
                fetch(url)
                    .then(response => response.text())
                    .then(text => {
                        const pre = document.createElement('pre');
                        pre.style.width = '100%';
                        pre.style.height = '100%';
                        pre.style.overflow = 'auto';
                        pre.style.margin = '0';
                        pre.style.padding = '1rem';
                        pre.textContent = text;
                        previewBody.appendChild(pre);
                    })
                    .catch(error => {
                        previewBody.innerHTML = `
                            <div class="preview-error">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Error loading text file</p>
                            </div>
                        `;
                    });
            } else {
                // Unsupported file type
                previewBody.innerHTML = `
                    <div class="preview-error">
                        <i class="fas fa-file"></i>
                        <p>Preview not available for this file type</p>
                        <p>Please use the download or open button below</p>
                    </div>
                `;
            }

            // Show modal
            modal.style.display = 'flex';

            // Add click outside to close
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeFilePreview();
                }
            };

            // Add escape key to close
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeFilePreview();
                }
            });
        }

        // Function to close file preview
        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            modal.style.display = 'none';
        }

        // Download file function
        function downloadFile(url, fileName) {
            try {
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName || 'download';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Download error:', error);
                // Fallback: open in new tab
                window.open(url, '_blank');
            }
        }

        // Action functions (kept for future use if needed)
        function viewCandidate(candidateId) {
            const candidate = candidatesData[candidateId];
            if (candidate) {
                const name = candidate.fullName || 
                           candidate.name || 
                           candidate.firstName + ' ' + candidate.lastName ||
                           candidate.applicantName ||
                           candidate.candidateName ||
                           (candidate.firstName ? candidate.firstName : '') + 
                           (candidate.lastName ? ' ' + candidate.lastName : '') ||
                           candidateId || 
                           'Unnamed Applicant';
                
                console.log(`Viewing applicant: ${name}`);
                // TODO: Implement detailed view modal or navigate to detail page
            }
        }

        function editCandidate(candidateId) {
            const candidate = candidatesData[candidateId];
            if (candidate) {
                const name = candidate.fullName || 
                           candidate.name || 
                           candidate.firstName + ' ' + candidate.lastName ||
                           candidate.applicantName ||
                           candidate.candidateName ||
                           (candidate.firstName ? candidate.firstName : '') + 
                           (candidate.lastName ? ' ' + candidate.lastName : '') ||
                           candidateId || 
                           'Unnamed Applicant';
                           
                console.log(`Edit functionality for ${name} will be implemented here.`);
                // TODO: Implement edit modal or navigate to edit page
            }
        }        function deleteCandidate(candidateId) {
            const candidate = candidatesData[candidateId];
            if (candidate) {
                const name = candidate.fullName || 
                           candidate.name || 
                           candidate.firstName + ' ' + candidate.lastName ||
                           candidate.applicantName ||
                           candidate.candidateName ||
                           (candidate.firstName ? candidate.firstName : '') + 
                           (candidate.lastName ? ' ' + candidate.lastName : '') ||
                           candidateId || 
                           'Unnamed Applicant';
                           
                if (confirm(`Are you sure you want to delete ${name}?`)) {
                    database.ref(`archives/-OSeQpCGGgMj1IDLhTtc/applications/${candidateId}`).remove()
                        .then(() => {
                            console.log('Applicant deleted successfully');
                        })
                        .catch((error) => {
                            console.error(`Error deleting applicant: ${error.message}`);
                        });
                }
            }
        }        // User Profile Dropdown functionality
        function initializeUserProfile() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            const userAvatarImg = document.getElementById('userAvatarImg');
            const logoutBtn = document.getElementById('logoutBtn');

            // Handle dropdown toggle
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    profileDropdown.classList.remove('show');
                });

                // Prevent dropdown from closing when clicking inside it
                profileDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // Handle logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        // Use embedded AuthManager for logout
                        if (window.authManager) {
                            await window.authManager.signOut();
                        } else {
                            // Fallback to direct Firebase logout
                            const firebase = initializeFirebase();
                            await firebase.auth().signOut();
                            localStorage.clear();
                        }
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        alert('Error signing out. Please try again.');
                    }
                });
            }

            // Load user initials from Firebase
            loadUserInitials();
        }

        function loadUserInitials() {
            // The centralized auth system now handles user display automatically
            // Just set up event listeners for additional updates if needed
            if (window.authManager) {
                window.addEventListener('userReady', async (event) => {
                    console.log('? User ready event received - user display updated centrally');
                });
                
                // If user is already ready, trigger display update
                if (window.authManager.isReady && window.authManager.currentUser) {
                    window.authManager.updateUserProfileDisplay();
                }
            }
            
            // Fallback to direct Firebase Auth (simplified)
            const firebase = initializeFirebase();
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user && window.authManager && window.authManager.isReady) {
                    // Central system should handle this, but ensure it's called
                    await window.authManager.updateUserProfileDisplay();
                } else if (!user) {
                    // Reset to default avatar if no user
                    const userAvatarImg = document.getElementById('userAvatarImg');
                    if (userAvatarImg) {
                        const defaultSvg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHR4dCB4PSIyMCIgeT0iMjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlU8L3R4dD4KPHN2Zz4K';
                        userAvatarImg.src = defaultSvg;
                        userAvatarImg.alt = 'User Avatar';
                    }
                }
            });
        }

        function getInitials(name) {
            if (!name) return 'U';
            
            // Split name into words and get first letter of each
            const words = name.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                // Single word - take first two letters
                return words[0].substring(0, 2).toUpperCase();
            } else {
                // Multiple words - take first letter of first two words
                return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
            }
        }        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for embedded services to initialize
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Check authentication and allow access (interview page is now unrestricted for logged-in users)
            await checkAuthenticationAndAccess();
            console.log('? Access granted to interview page');
            
            // DO NOT initialize menu visibility here - it will be handled by the proper authorization system
            
            // Initialize page functionality
            initializePage();
            initializeUserProfile();
            
            // Pre-populate evaluator name field
            setCurrentUserAsEvaluator();
            
            // Ensure company branding loads (additional safety call)
            if (window.companyDataService && window.authManager?.getCurrentUser()) {
                console.log('?? Loading company branding from main initialization...');
                try {
                    await window.companyDataService.loadCompanyBranding();
                } catch (error) {
                    console.error('Error loading company branding from main init:', error);
                }
            }
            
            // Initialize menu authorization AFTER all other initialization completes
            setTimeout(() => {
                console.log('?? Starting menu authorization system...');
                if (typeof updateMenuWithFeatureAuthorization === 'function') {
                    updateMenuWithFeatureAuthorization().then(() => {
                        // Setup real-time listeners after menu authorization completes
                        setTimeout(() => {
                            if (typeof setupRealTimeMenuUpdates === 'function') {
                                setupRealTimeMenuUpdates();
                            }
                        }, 500);
                    }).catch(error => {
                        console.error('? Error in menu authorization:', error);
                    });
                } else {
                    console.error('? updateMenuWithFeatureAuthorization function not found');
                }
            }, 200);
        });

        // Listen for userReady event to ensure company branding loads
        window.addEventListener('userReady', async (event) => {
            console.log('?? User ready event received, loading company branding...');
            if (window.companyDataService) {
                try {
                    await window.companyDataService.loadCompanyBranding();
                    console.log('? Company branding loaded successfully from userReady event');
                } catch (error) {
                    console.error('Error loading company branding from userReady event:', error);
                }
            }
        });

        // Tab switching functionality
        let selectedJobId = null;
        let allJobs = {};

        async function switchToTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'jobs') {
                document.getElementById('jobsTabBtn').classList.add('active');
                document.getElementById('jobsTabContent').classList.add('active');
                
                // Ensure jobs are displayed properly
                console.log('Switching to jobs tab, ensuring table is visible');
                const jobsTable = document.getElementById('jobsTable');
                const loadingState = document.getElementById('loadingState');
                
                console.log('?? Jobs tab switch - jobsData:', Object.keys(jobsData || {}).length, 'jobs');
                console.log('?? Jobs tab switch - allJobs:', Object.keys(allJobs || {}).length, 'jobs');
                
                if (jobsData && Object.keys(jobsData).length > 0) {
                    console.log('? Jobs data exists, showing table');
                    if (loadingState) loadingState.style.display = 'none';
                    if (jobsTable) {
                        jobsTable.style.display = 'table';
                        renderJobs(); // Re-render the table to ensure it's up to date
                    }
                } else {
                    console.log('?? No jobs data found, loading jobs');
                    await loadJobs(); // Load jobs if none exist
                }
            } else if (tabName === 'applicants') {
                document.getElementById('applicantsTabBtn').classList.add('active');
                document.getElementById('applicantsTabContent').classList.add('active');
                
                // Refresh applicants if we have a selected job
                if (selectedJobId) {
                    console.log('?? Switching to applicants tab - refreshing data for job:', selectedJobId);
                    loadJobApplicants(selectedJobId);
                } else {
                    console.log('?? No job selected for applicants tab');
                }
            } else if (tabName === 'archives') {
                document.getElementById('archivesTabBtn').classList.add('active');
                document.getElementById('archivesTabContent').classList.add('active');
                // Load archived jobs when switching to archives tab
                loadArchives();
            } else if (tabName === 'hired') {
                document.getElementById('hiredTabBtn').classList.add('active');
                document.getElementById('hiredTabContent').classList.add('active');
                // Load hired data when switching to hired tab
                loadHired();
            }
        }

        // Close applicants tab (legacy function - now just switches to jobs tab)
        function closeApplicantsTab() {
            switchToTab('jobs');
            selectedJobId = null;
        }

        // Load job applicants in the applicants tab
        function loadJobApplicants(jobId) {
            selectedJobId = jobId;
            const job = jobsData[jobId] || allJobs[jobId];
            
            if (!job) {
                console.error('Job not found:', jobId);
                return;
            }

            // Switch to applicants tab
            switchToTab('applicants');
            
            // Update job info
            document.getElementById('selectedJobTitle').textContent = job.title || job.jobTitle || job.position || 'Untitled Job';
            document.getElementById('selectedJobDetails').textContent = 
                `${job.department || 'N/A'}  ${formatEmploymentType(job.employmentType)}  Posted ${formatDate(job.datePosted)}  ${Object.keys(job.applications || {}).length} Applications`;

            // Hide no applicants message and show loading
            document.getElementById('noApplicantsMessage').style.display = 'none';
            document.getElementById('applicantsTable').style.display = 'none';
            
            // First try to get applications from the job data itself (from archives)
            let applicantsData = job.applications;
            
            if (applicantsData && Object.keys(applicantsData).length > 0) {
                // Use applications from archive data
                populateApplicantsTable(applicantsData, jobId);
            } else {
                // Get company ID for company-scoped queries
                const companyId = getCompanyId();
                
                if (companyId) {
                    // Primary: try to load from company-scoped applications
                    const companyApplicantsRef = database.ref(`companies/${companyId}/applications/${jobId}`);
                    
                    companyApplicantsRef.once('value', (snapshot) => {
                        const companyApplicantsData = snapshot.val();
                        
                        if (companyApplicantsData) {
                            populateApplicantsTable(companyApplicantsData, jobId);
                        } else {
                            // Fallback: try to load from legacy Firebase jobs structure
                            const applicantsRef = database.ref(`jobs/${jobId}/applications`);
                            
                            applicantsRef.once('value', (snapshot) => {
                                const firebaseApplicantsData = snapshot.val();
                                
                                if (firebaseApplicantsData) {
                                    populateApplicantsTable(firebaseApplicantsData, jobId);
                                } else {
                                    // Show no applicants message
                                    document.getElementById('noApplicantsMessage').innerHTML = `
                                        <i class="fas fa-user-friends"></i>
                                        <h3>No Applicants Yet</h3>
                                        <p>This job posting hasn't received any applications.</p>
                                    `;
                                    document.getElementById('noApplicantsMessage').style.display = 'block';
                                }
                            }).catch((error) => {
                                console.error('Error loading applicants:', error);
                                document.getElementById('noApplicantsMessage').innerHTML = `
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>Error Loading Applicants</h3>
                                    <p>There was an error loading the applicants for this job.</p>
                                `;
                                document.getElementById('noApplicantsMessage').style.display = 'block';
                            });
                        }
                    }).catch((error) => {
                        console.error('Error loading company-scoped applicants:', error);
                        // Fallback to legacy path on error
                        const applicantsRef = database.ref(`jobs/${jobId}/applications`);
                        
                        applicantsRef.once('value', (snapshot) => {
                            const firebaseApplicantsData = snapshot.val();
                            
                            if (firebaseApplicantsData) {
                                populateApplicantsTable(firebaseApplicantsData, jobId);
                            } else {
                                document.getElementById('noApplicantsMessage').innerHTML = `
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>Error Loading Applicants</h3>
                                    <p>There was an error loading the applicants for this job.</p>
                                `;
                                document.getElementById('noApplicantsMessage').style.display = 'block';
                            }
                        });
                    });
                } else {
                    // No company ID, fallback to legacy path
                    const applicantsRef = database.ref(`jobs/${jobId}/applications`);
                    
                    applicantsRef.once('value', (snapshot) => {
                        const firebaseApplicantsData = snapshot.val();
                        
                        if (firebaseApplicantsData) {
                            populateApplicantsTable(firebaseApplicantsData, jobId);
                        } else {
                            document.getElementById('noApplicantsMessage').innerHTML = `
                                <i class="fas fa-user-friends"></i>
                                <h3>No Applicants Yet</h3>
                                <p>This job posting hasn't received any applications.</p>
                            `;
                            document.getElementById('noApplicantsMessage').style.display = 'block';
                        }
                    }).catch((error) => {
                        console.error('Error loading applicants:', error);
                        document.getElementById('noApplicantsMessage').innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error Loading Applicants</h3>
                            <p>There was an error loading the applicants for this job.</p>
                        `;
                        document.getElementById('noApplicantsMessage').style.display = 'block';
                    });
                }
            }
        }        // Helper function to populate applicants table
        function populateApplicantsTable(applicantsData, jobId) {
            const tbody = document.getElementById('applicantsTableBody');
            tbody.innerHTML = '';

            // Show table and populate with applicants
            document.getElementById('applicantsTable').style.display = 'table';              Object.entries(applicantsData).forEach(([applicationId, applicant]) => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.addEventListener('click', function(event) {
                    // Check if the click is on a button or inside a button
                    const clickedElement = event.target;
                    const isButton = clickedElement.tagName === 'BUTTON' || 
                                   clickedElement.closest('button') || 
                                   clickedElement.classList.contains('action-btn') ||
                                   clickedElement.closest('.action-btn');
                    
                    // Only show modal if not clicking on a button
                    if (!isButton) {
                        showApplicantModal(applicant, applicationId, jobId);
                    }
                });
                
                row.innerHTML = `
                    <td class="applicant-name">${applicant.firstName || ''} ${applicant.lastName || ''}</td>
                    <td>${applicant.email || 'N/A'}</td>
                    <td>${applicant.phone || 'N/A'}</td>
                    <td>${formatDate(applicant.appliedDate)}</td>
                    <td><span class="status-badge status-${applicant.status || 'pending'}">${formatApplicationStatus(applicant.status)}</span></td>
                    <td>
                        ${applicant.resumeUrl ? `
                            <a href="${applicant.resumeUrl}" target="_blank" class="btn btn-sm btn-secondary" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf"></i> View
                            </a>
                        ` : 'N/A'}
                    </td>
                    <td>
                        <div class="schedule-column">
                            ${applicant.interview ? `
                                ${isInterviewExpired(applicant.interview.date, applicant.interview.time) ? `
                                    <div class="schedule-status expired">
                                        <i class="fas fa-calendar-times"></i>
                                        ${formatInterviewDate(applicant.interview.date, applicant.interview.time)}
                                        <small style="color: #dc3545; display: block; margin-top: 0.25rem;">
                                            Interview Completed
                                        </small>
                                    </div>
                                ` : `
                                    <div class="schedule-status scheduled">
                                        <i class="fas fa-calendar-check"></i>
                                        ${formatInterviewDate(applicant.interview.date, applicant.interview.time)}
                                    </div>
                                    <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
                                        ${applicant.interview.type} | ${applicant.interview.interviewer || 'TBD'}
                                    </small>
                                `}
                            ` : `
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openScheduleModal('${applicationId}', '${jobId}', ${JSON.stringify(applicant).replace(/"/g, '&quot;')})" title="Schedule Interview">
                                    <i class="fas fa-calendar-plus"></i> Schedule
                                </button>
                            `}
                        </div>
                    </td>                    <td>                        <div class="action-buttons">
                            <button class="action-btn btn-view" onclick="event.stopPropagation(); showApplicantModal(${JSON.stringify(applicant).replace(/"/g, '&quot;')}, '${applicationId}', '${jobId}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-edit" onclick="event.stopPropagation(); updateApplicationStatus('${applicationId}', '${jobId}')" title="Update Status">
                                <i class="fas fa-edit"></i>
                            </button>                            <button class="action-btn btn-info" onclick="event.stopPropagation(); viewApplicantEvaluations('${applicationId}')" title="View Evaluations">
                                <i class="fas fa-clipboard-list"></i>
                            </button>
                            <button class="action-btn btn-mail" onclick="event.stopPropagation(); sendEvaluationSummaryEmail('${applicationId}', '${jobId}', ${JSON.stringify(applicant).replace(/"/g, '&quot;')}, event)" title="Send Evaluation Summary">
                                <i class="fas fa-envelope"></i>
                            </button>                            <button class="action-btn btn-hire ${(applicant.status === 'hired') ? 'disabled' : ''}" 
                                    onclick="event.stopPropagation(); console.log('?? Button clicked!'); handleHireClick('${applicationId}', '${jobId}', '${applicant.firstName || ''}', '${applicant.lastName || ''}', '${applicant.status || ''}')" 
                                    title="${(applicant.status === 'hired') ? 'Already Hired' : 'Hire Applicant'}"
                                    ${(applicant.status === 'hired') ? 'disabled' : ''}>
                                <i class="fas fa-user-check"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }        // NOTE: These functions are no longer used since we removed the evaluation column
        // but kept for reference if needed later
        
        /*
        // Create evaluation column content
        function createEvaluationColumn(jobId, applicationId, applicant) {
            const interviewCompleted = applicant.interview && isInterviewExpired(applicant.interview.date, applicant.interview.time);
            
            return `
                <div class="evaluation-column" id="eval-col-${applicationId}">
                    <div class="evaluation-status loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                    ${interviewCompleted ? `
                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openEvaluationModal('${applicationId}', '${jobId}', ${JSON.stringify(applicant).replace(/"/g, '&quot;')})" title="Create Evaluation" style="margin-top: 0.5rem; width: 100%;">
                            <i class="fas fa-clipboard-list"></i> Evaluate
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Set up real-time listener for evaluations
        function setupEvaluationListener(jobId, applicationId) {
            const evaluationRef = database.ref(`jobs/${jobId}/applications/${applicationId}/evaluations`);
            
            evaluationRef.on('value', (snapshot) => {
                const evaluations = snapshot.val();
                updateEvaluationDisplay(applicationId, evaluations);
            });
        }

        // Update evaluation display in real-time
        function updateEvaluationDisplay(applicationId, evaluations) {
            const evalColumn = document.getElementById(`eval-col-${applicationId}`);
            if (!evalColumn) return;

            const statusDiv = evalColumn.querySelector('.evaluation-status');
            
            if (!evaluations || Object.keys(evaluations).length === 0) {
                statusDiv.innerHTML = `
                    <div class="no-evaluation">
                        <i class="fas fa-clipboard"></i>
                        <span>Not Evaluated</span>
                    </div>
                `;
                statusDiv.className = 'evaluation-status no-eval';
            } else {
                const evaluationCount = Object.keys(evaluations).length;
                const latestEvaluation = Object.values(evaluations)[evaluationCount - 1];
                const averageScore = latestEvaluation.overallScore || 0;
                
                statusDiv.innerHTML = `
                    <div class="evaluation-summary">
                        <div class="eval-score">
                            <i class="fas fa-star"></i>
                            <span>${averageScore}/5</span>
                        </div>
                        <div class="eval-count">
                            ${evaluationCount} evaluation${evaluationCount > 1 ? 's' : ''}
                        </div>
                        <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); viewApplicantEvaluations('${applicationId}')" title="View Evaluations" style="margin-top: 0.25rem; width: 100%;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                `;
                statusDiv.className = 'evaluation-status evaluated';
            }
        }
        */

        // Format employment type
        function formatEmploymentType(type) {
            const types = {
                'full-time': 'Full Time',
                'part-time': 'Part Time',
                'contract': 'Contract',
                'internship': 'Internship',
                'temporary': 'Temporary'
            };
            return types[type?.toLowerCase()] || type || 'N/A';
        }

        // Format application status
        function formatApplicationStatus(status) {
            const statuses = {
                'pending': 'Pending',
                'reviewed': 'Reviewed',
                'shortlisted': 'Shortlisted',
                'interviewed': 'Interviewed',
                'rejected': 'Rejected',
                'hired': 'Hired'
            };
            return statuses[status?.toLowerCase()] || 'Pending';
        }        // Format date function
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return 'N/A';
                
                const now = new Date();
                const diff = now - d;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));

                if (days === 0) return 'Today';
                if (days === 1) return 'Yesterday';
                if (days < 7) return `${days} days ago`;
                if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
                  return d.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return 'N/A';
            }
        }

        // View all evaluations for an applicant
        function viewApplicantEvaluations(applicationId) {
            const currentJobId = selectedJobId || currentJobFilter;
            if (!currentJobId) {
                alert('Error: No job selected');
                return;
            }

            const evaluationRef = database.ref(`jobs/${currentJobId}/applications/${applicationId}/evaluations`);
            evaluationRef.once('value')
                .then((snapshot) => {
                    const evaluations = snapshot.val();
                    if (!evaluations || Object.keys(evaluations).length === 0) {
                        alert('No evaluations found for this candidate.');
                        return;
                    }

                    showDetailedEvaluationsModal(evaluations, applicationId, currentJobId);
                })
                .catch((error) => {
                    console.error('Error loading evaluations:', error);
                    alert('Failed to load evaluations: ' + error.message);
                });
        }        // Show detailed evaluations in a modal
        function showDetailedEvaluationsModal(evaluations, applicationId, jobId) {
            // Calculate averages
            const evaluationArray = Object.values(evaluations);
            const totalEvaluations = evaluationArray.length;
            
            // Calculate average scores for each criteria
            const averageScores = {
                technical: 0,
                communication: 0,
                'problem-solving': 0,
                'cultural-fit': 0,
                experience: 0
            };
            
            let totalOverallScore = 0;
            const recommendationCounts = {
                'strongly-recommend': 0,
                'recommend': 0,
                'neutral': 0,
                'not-recommend': 0,
                'strongly-not-recommend': 0
            };
            
            // Sum up all scores and count recommendations
            evaluationArray.forEach(evaluation => {
                totalOverallScore += evaluation.overallScore || 0;
                
                // Sum individual criteria scores
                Object.keys(averageScores).forEach(criteria => {
                    averageScores[criteria] += evaluation.ratings[criteria] || 0;
                });
                
                // Count recommendations
                const recommendation = evaluation.recommendation;
                if (recommendationCounts.hasOwnProperty(recommendation)) {
                    recommendationCounts[recommendation]++;
                }
            });
            
            // Calculate averages
            const averageOverallScore = (totalOverallScore / totalEvaluations).toFixed(1);
            Object.keys(averageScores).forEach(criteria => {
                averageScores[criteria] = (averageScores[criteria] / totalEvaluations).toFixed(1);
            });
            
            // Determine most common recommendation
            const mostCommonRecommendation = Object.entries(recommendationCounts)
                .reduce((a, b) => recommendationCounts[a[0]] > recommendationCounts[b[0]] ? a : b)[0];

            let content = `
                <div class="modal-overlay" id="evaluationsModalOverlay" onclick="closeEvaluationsModal()">
                    <div class="modal-content evaluation-details-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Interview Evaluations</h3>
                            <button onclick="closeEvaluationsModal()" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
            `;

            Object.entries(evaluations).forEach(([evalId, evaluation]) => {
                const evalDate = new Date(evaluation.evaluationDate).toLocaleDateString();
                const evalTime = new Date(evaluation.evaluationDate).toLocaleTimeString();
                
                content += `
                    <div class="evaluation-item">
                        <div class="evaluation-header">
                            <h4>Evaluation by ${evaluation.evaluatorName}</h4>
                            <span class="evaluation-date">${evalDate} at ${evalTime}</span>
                        </div>
                        <div class="evaluation-details">
                            <div class="score-section">
                                <strong>Overall Score: ${evaluation.overallScore}/5</strong>
                                <span class="recommendation ${getRecommendationClass(evaluation.recommendation)}">
                                    ${formatRecommendation(evaluation.recommendation)}
                                </span>
                            </div>
                            <div class="ratings-section">
                                <h5>Detailed Ratings:</h5>
                                <ul>
                                    <li>Technical Skills: ${evaluation.ratings.technical || 0}/5</li>
                                    <li>Communication: ${evaluation.ratings.communication || 0}/5</li>
                                    <li>Problem Solving: ${evaluation.ratings['problem-solving'] || 0}/5</li>
                                    <li>Cultural Fit: ${evaluation.ratings['cultural-fit'] || 0}/5</li>
                                    <li>Experience: ${evaluation.ratings.experience || 0}/5</li>
                                </ul>
                            </div>
                            ${evaluation.overallComments ? `
                                <div class="comments-section">
                                    <h5>Comments:</h5>
                                    <p>${evaluation.overallComments}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            // Add average results section
            content += `
                        <div class="average-results-section">
                            <div class="average-header">
                                <h3><i class="fas fa-chart-bar"></i> Average Results from All Evaluators</h3>
                                <span class="evaluators-count">${totalEvaluations} Evaluator${totalEvaluations > 1 ? 's' : ''}</span>
                            </div>
                            <div class="average-content">
                                <div class="average-overall-score">
                                    <div class="average-score-display">
                                        <span class="score-number">${averageOverallScore}</span>
                                        <span class="score-total">/5</span>
                                    </div>
                                    <div class="score-stars">
                                        ${generateStarRating(parseFloat(averageOverallScore))}
                                    </div>
                                    <div class="average-recommendation">
                                        Most Common: <span class="recommendation ${getRecommendationClass(mostCommonRecommendation)}">
                                            ${formatRecommendation(mostCommonRecommendation)}
                                        </span>
                                    </div>
                                </div>
                                <div class="average-criteria-breakdown">
                                    <h5>Average Criteria Scores:</h5>
                                    <div class="criteria-grid">
                                        <div class="criteria-average-item">
                                            <span class="criteria-label">Technical Skills</span>
                                            <div class="criteria-score-bar">
                                                <div class="score-bar-fill" style="width: ${(averageScores.technical / 5) * 100}%"></div>
                                                <span class="score-value">${averageScores.technical}/5</span>
                                            </div>
                                        </div>
                                        <div class="criteria-average-item">
                                            <span class="criteria-label">Communication</span>
                                            <div class="criteria-score-bar">
                                                <div class="score-bar-fill" style="width: ${(averageScores.communication / 5) * 100}%"></div>
                                                <span class="score-value">${averageScores.communication}/5</span>
                                            </div>
                                        </div>
                                        <div class="criteria-average-item">
                                            <span class="criteria-label">Problem Solving</span>
                                            <div class="criteria-score-bar">
                                                <div class="score-bar-fill" style="width: ${(averageScores['problem-solving'] / 5) * 100}%"></div>
                                                <span class="score-value">${averageScores['problem-solving']}/5</span>
                                            </div>
                                        </div>
                                        <div class="criteria-average-item">
                                            <span class="criteria-label">Cultural Fit</span>
                                            <div class="criteria-score-bar">
                                                <div class="score-bar-fill" style="width: ${(averageScores['cultural-fit'] / 5) * 100}%"></div>
                                                <span class="score-value">${averageScores['cultural-fit']}/5</span>
                                            </div>
                                        </div>
                                        <div class="criteria-average-item">
                                            <span class="criteria-label">Experience</span>
                                            <div class="criteria-score-bar">
                                                <div class="score-bar-fill" style="width: ${(averageScores.experience / 5) * 100}%"></div>
                                                <span class="score-value">${averageScores.experience}/5</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="recommendation-breakdown">
                                    <h5>Recommendation Distribution:</h5>
                                    <div class="recommendation-chart">
                                        ${Object.entries(recommendationCounts).map(([recommendation, count]) => {
                                            if (count === 0) return '';
                                            const percentage = ((count / totalEvaluations) * 100).toFixed(0);
                                            return `
                                                <div class="recommendation-bar">
                                                    <span class="recommendation-label ${getRecommendationClass(recommendation)}">
                                                        ${formatRecommendation(recommendation)}
                                                    </span>
                                                    <div class="recommendation-bar-container">
                                                        <div class="recommendation-bar-fill ${getRecommendationClass(recommendation)}" style="width: ${percentage}%"></div>
                                                        <span class="recommendation-count">${count} (${percentage}%)</span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', content);
        }

        // Close evaluations modal
        function closeEvaluationsModal() {
            const modal = document.getElementById('evaluationsModalOverlay');
            if (modal) {
                modal.remove();
            }
        }

        // Helper function to generate star rating display
        function generateStarRating(score) {
            const fullStars = Math.floor(score);
            const hasHalfStar = score - fullStars >= 0.5;
            let stars = '';
            
            // Add full stars
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            
            // Add half star if needed
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            
            // Add empty stars to total 5
            const remainingStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < remainingStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            
            return stars;
        }

        // Helper functions for recommendations
        function getRecommendationClass(recommendation) {
            const classes = {
                'strongly-recommend': 'recommend-strong',
                'recommend': 'recommend-yes',
                'neutral': 'recommend-neutral',
                'not-recommend': 'recommend-no',
                'strongly-not-recommend': 'recommend-strong-no'
            };
            return classes[recommendation] || 'recommend-neutral';
        }

        function formatRecommendation(recommendation) {
            const recommendations = {
                'strongly-recommend': 'Strongly Recommend',
                'recommend': 'Recommend',
                'neutral': 'Neutral',
                'not-recommend': 'Not Recommend',
                'strongly-not-recommend': 'Strongly Not Recommend'
            };
            return recommendations[recommendation] || 'Unknown';
        }

// Show applicant modal
        let currentModalApplicationId = null;
        let currentModalJobId = null;

        function showApplicantModal(applicant, applicationId, jobId) {
            currentModalApplicationId = applicationId;
            currentModalJobId = jobId;
            
            // Populate personal information
            document.getElementById('modalFullName').textContent = `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || 'N/A';
            document.getElementById('modalEmail').textContent = applicant.email || 'N/A';
            document.getElementById('modalPhone').textContent = applicant.phone || 'N/A';
            document.getElementById('modalAddress').textContent = applicant.address || 'N/A';
            
            // Populate application information
            document.getElementById('modalAppliedDate').textContent = formatDate(applicant.appliedDate);
            const statusElement = document.getElementById('modalStatus');
            statusElement.textContent = formatApplicationStatus(applicant.status);
            statusElement.className = `status-badge status-${applicant.status || 'pending'}`;
            
            document.getElementById('modalExperience').textContent = applicant.experience || applicant.yearsOfExperience || 'N/A';
            
            // Handle resume link
            const resumeElement = document.getElementById('modalResumeLink');
            if (applicant.resumeUrl) {
                resumeElement.innerHTML = `<a href="${applicant.resumeUrl}" target="_blank" class="btn btn-sm btn-secondary"><i class="fas fa-file-pdf"></i> View Resume</a>`;
            } else {
                resumeElement.textContent = 'No resume provided';
            }
              // Set current status in select
            document.getElementById('statusSelect').value = applicant.status || 'pending';
            
            // Handle interview information section
            const interviewInfoSection = document.getElementById('interviewInfoSection');
            if (applicant.interview) {
                // Show interview information
                interviewInfoSection.style.display = 'block';
                document.getElementById('modalInterviewDate').textContent = new Date(applicant.interview.date).toLocaleDateString() || 'N/A';
                document.getElementById('modalInterviewTime').textContent = applicant.interview.time || 'N/A';
                document.getElementById('modalInterviewType').textContent = applicant.interview.type || 'N/A';
                document.getElementById('modalInterviewer').textContent = applicant.interview.interviewer || 'N/A';
                document.getElementById('modalInterviewLocation').textContent = applicant.interview.location || 'N/A';
                
                // Show evaluation buttons
                document.getElementById('evaluationBtn').style.display = 'inline-block';
                document.getElementById('viewEvaluationsBtn').style.display = 'inline-block';
            } else {
                // Hide interview information section
                interviewInfoSection.style.display = 'none';
            }

            // Show modal
            document.getElementById('applicantModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Add click outside to close functionality
            document.getElementById('applicantModal').onclick = function(e) {
                if (e.target === this) {
                    closeApplicantModal();
                }
            };
        }

        // Close applicant modal
        function closeApplicantModal() {
            document.getElementById('applicantModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentModalApplicationId = null;
            currentModalJobId = null;
        }

        // Update applicant status from modal
        function updateApplicantStatusFromModal() {
            if (!currentModalApplicationId || !currentModalJobId) {
                alert('Error: No applicant selected');
                return;
            }
            
            const newStatus = document.getElementById('statusSelect').value;
            const companyId = getCompanyId();
            
            // Update both company-scoped and legacy paths
            const updatePromises = [];
            
            // Legacy path update
            const legacyStatusRef = database.ref(`jobs/${currentModalJobId}/applications/${currentModalApplicationId}/status`);
            updatePromises.push(legacyStatusRef.set(newStatus));
            
            // Company-scoped path update
            if (companyId) {
                const companyStatusRef = database.ref(`companies/${companyId}/applications/${currentModalJobId}/${currentModalApplicationId}/status`);
                updatePromises.push(companyStatusRef.set(newStatus));
            }
            
            Promise.all(updatePromises).then(() => {
                alert('Status updated successfully!');
                closeApplicantModal();
                // Reload applicants if we're still viewing the same job
                if (selectedJobId === currentModalJobId) {
                    loadJobApplicants(currentModalJobId);
                }
            }).catch((error) => {
                console.error('Error updating status:', error);
                alert('Error updating status. Please try again.');
            });
        }

        // Update application status (placeholder function)
        function updateApplicationStatus(applicationId, jobId) {
            const newStatus = prompt('Enter new status (pending, reviewed, shortlisted, interviewed, rejected, hired):');
            if (newStatus && ['pending', 'reviewed', 'shortlisted', 'interviewed', 'rejected', 'hired'].includes(newStatus.toLowerCase())) {
                const statusRef = database.ref(`jobs/${jobId}/applications/${applicationId}/status`);
                statusRef.set(newStatus.toLowerCase()).then(() => {
                    alert('Status updated successfully!');
                    if (selectedJobId === jobId) {
                        loadJobApplicants(jobId);
                    }
                }).catch((error) => {
                    console.error('Error updating status:', error);
                    alert('Error updating status. Please try again.');
                });            } else if (newStatus !== null) {
                alert('Invalid status. Please use: pending, reviewed, shortlisted, interviewed, rejected, or hired');
            }        }        // Handle hire button click with better debugging
        function handleHireClick(applicationId, jobId, firstName, lastName, status) {
            console.log('?? handleHireClick called with:', { 
                applicationId, 
                jobId, 
                firstName, 
                lastName, 
                status 
            });
            
            // Check if already hired
            if (status === 'hired') {
                alert('This candidate has already been hired!');
                return;
            }
            
            // Construct full name
            const fullName = `${firstName} ${lastName}`.trim() || 'Unknown Candidate';
            
            // Call the main hire function
            hireApplicant(applicationId, jobId, fullName);
        }

        // Hire applicant and store their information in Firebase hired path
        async function hireApplicant(applicationId, jobId, applicantName) {
            console.log('hireApplicant called with:', { applicationId, jobId, applicantName });
            
            try {
                // Confirm hiring action
                const confirmHire = confirm(`Are you sure you want to hire ${applicantName}?`);
                if (!confirmHire) {
                    return;
                }

                // Get company ID for company-scoped storage
                const companyId = getCompanyId();
                if (!companyId) {
                    alert('Error: Company ID not found. Please ensure you are logged in properly.');
                    return;
                }

                // Get the full applicant data from correct company-scoped paths
                let applicantData = null;
                
                console.log('?? Fetching applicant data for:', { companyId, jobId, applicationId });
                
                // Try company jobs applications path first (your correct path structure)
                const companyJobApplicantRef = database.ref(`companies/${companyId}/jobs/${jobId}/applications/${applicationId}`);
                const companyJobApplicantSnapshot = await companyJobApplicantRef.once('value');
                
                if (companyJobApplicantSnapshot.exists()) {
                    applicantData = companyJobApplicantSnapshot.val();
                    console.log('? Found applicant data in company jobs path:', applicantData);
                    console.log('?? Raw email field from applicant data:', applicantData.email);
                    console.log('?? All applicant fields:', Object.keys(applicantData));
                } else {
                    console.log('? Not found in company jobs path, trying jobclosed...');
                    // Try jobclosed path
                    const jobclosedApplicantRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/applications/${applicationId}`);
                    const jobclosedApplicantSnapshot = await jobclosedApplicantRef.once('value');
                    
                    if (jobclosedApplicantSnapshot.exists()) {
                        applicantData = jobclosedApplicantSnapshot.val();
                        console.log('? Found applicant data in jobclosed path:', applicantData);
                    } else {
                        console.log('? Not found in jobclosed path, trying legacy...');
                        // Fallback to legacy path
                        const legacyApplicantRef = database.ref(`jobs/${jobId}/applications/${applicationId}`);
                        const legacyApplicantSnapshot = await legacyApplicantRef.once('value');
                        
                        if (legacyApplicantSnapshot.exists()) {
                            applicantData = legacyApplicantSnapshot.val();
                            console.log('? Found applicant data in legacy path:', applicantData);
                        } else {
                            console.error('? Applicant data not found in any path');
                            alert('Error: Applicant data not found in any database path');
                            return;
                        }
                    }
                }

                // Get job information from company-scoped paths first
                let jobData = {};
                
                // Try multiple paths to get the most current job information
                // 1. Try current active jobs first (most up-to-date)
                const currentJobRef = database.ref(`companies/${companyId}/jobs/${jobId}`);
                const currentJobSnapshot = await currentJobRef.once('value');
                
                if (currentJobSnapshot.exists()) {
                    jobData = currentJobSnapshot.val();
                    console.log('? Found job data in current jobs:', jobData);
                } else {
                    // 2. Try company jobclosed path
                    const companyJobRef = database.ref(`companies/${companyId}/jobclosed/${jobId}`);
                    const companyJobSnapshot = await companyJobRef.once('value');
                    
                    if (companyJobSnapshot.exists()) {
                        jobData = companyJobSnapshot.val();
                        console.log('? Found job data in jobclosed:', jobData);
                    } else {
                        // 3. Fallback to legacy archives path
                        const legacyJobRef = database.ref(`archives/${jobId}`);
                        const legacyJobSnapshot = await legacyJobRef.once('value');
                        jobData = legacyJobSnapshot.exists() ? legacyJobSnapshot.val() : {};
                        console.log('? Found job data in legacy archives:', jobData);
                    }
                }

                // Get current user info for tracking who hired the candidate
                const currentUser = window.authManager?.getCurrentUser();
                const hiredByUser = currentUser ? (currentUser.displayName || currentUser.email || 'System') : 'System';

                // Ensure email is properly captured with multiple fallbacks
                const candidateEmail = applicantData.email || 
                                     applicantData.emailAddress || 
                                     applicantData.mail || 
                                     applicantData.contactEmail ||
                                     applicantData.userEmail ||
                                     '';

                console.log('?? EMAIL EXTRACTION DEBUG:');
                console.log('  applicantData.email:', applicantData.email);
                console.log('  applicantData.emailAddress:', applicantData.emailAddress);
                console.log('  applicantData.mail:', applicantData.mail);
                console.log('  applicantData.contactEmail:', applicantData.contactEmail);
                console.log('  applicantData.userEmail:', applicantData.userEmail);
                console.log('  Final candidateEmail:', candidateEmail);

                // Ensure job position is properly captured from current published job
                const jobPosition = jobData.jobTitle || 
                                  jobData.position || 
                                  jobData.title || 
                                  jobData.positionTitle ||
                                  jobData.roleName ||
                                  applicantData.position || 
                                  applicantData.jobTitle || 
                                  applicantData.appliedPosition ||
                                  'Position not specified';

                console.log('?? Email captured:', candidateEmail);
                console.log('?? Position captured:', jobPosition);
                console.log('?? Job Data:', jobData);
                console.log('?? Applicant Data:', applicantData);

                // Prepare comprehensive hired candidate data with all available fields
                const hiredCandidateData = {
                    // Spread all original applicant data first
                    ...applicantData,
                    
                    // === PERSONAL INFORMATION (PRIORITIZED) ===
                    fullName: applicantName || `${applicantData.firstName || ''} ${applicantData.lastName || ''}`.trim() || 'Unknown Candidate',
                    firstName: applicantData.firstName || applicantData.fname || '',
                    lastName: applicantData.lastName || applicantData.lname || '',
                    email: candidateEmail, // Use enhanced email capture
                    phone: applicantData.phone || applicantData.phoneNumber || applicantData.contactNumber || applicantData.mobile || '',
                    address: applicantData.address || applicantData.location || applicantData.city || '',
                    
                    // === JOB INFORMATION (PRIORITIZED) ===
                    jobId: jobId,
                    jobTitle: jobPosition, // Use enhanced position capture from current published job
                    position: jobPosition, // Duplicate for compatibility
                    jobDepartment: jobData.department || jobData.dept || applicantData.department || 'Not specified',
                    jobLocation: jobData.location || jobData.jobLocation || applicantData.preferredLocation || 'Not specified',
                    jobSalary: jobData.salary || jobData.salaryRange || jobData.minSalary || jobData.maxSalary || applicantData.expectedSalary || 'Not specified',
                    jobType: jobData.employmentType || jobData.jobType || applicantData.employmentType || 'Full-time',
                    
                    // === HIRING INFORMATION ===
                    hiredDate: new Date().toISOString(),
                    hiredTimestamp: Date.now(),
                    originalApplicationId: applicationId,
                    status: 'hired',
                    hiredBy: hiredByUser,
                    hiredById: currentUser?.uid || null,
                    
                    // === PROFESSIONAL INFORMATION ===
                    experience: applicantData.experience || applicantData.yearsOfExperience || applicantData.workExperience || applicantData.totalExperience || 'Not specified',
                    education: applicantData.education || applicantData.qualification || applicantData.degree || applicantData.educationLevel || 'Not specified',
                    skills: applicantData.skills || applicantData.skillSet || applicantData.technicalSkills || applicantData.expertise || 'Not specified',
                    previousCompany: applicantData.previousCompany || applicantData.currentCompany || applicantData.lastEmployer || 'Not specified',
                    previousRole: applicantData.previousRole || applicantData.currentRole || applicantData.lastPosition || 'Not specified',
                    
                    // === APPLICATION DETAILS ===
                    appliedDate: applicantData.appliedDate || applicantData.applicationDate || applicantData.submittedAt || applicantData.dateApplied || new Date().toISOString(),
                    resumeUrl: applicantData.resumeUrl || applicantData.cvUrl || applicantData.resume || '',
                    coverLetterUrl: applicantData.coverLetterUrl || applicantData.coverLetter || '',
                    portfolioUrl: applicantData.portfolioUrl || applicantData.portfolio || applicantData.website || '',
                    
                    // === INTERVIEW INFORMATION ===
                    interview: applicantData.interview || null,
                    evaluations: applicantData.evaluations || {},
                    interviewNotes: applicantData.interviewNotes || applicantData.notes || '',
                    
                    // === EMPLOYMENT SETUP (to be filled later) ===
                    employeeId: null,
                    startDate: null,
                    probationPeriod: null,
                    reportingManager: null,
                    workLocation: jobData.location || jobData.jobLocation || 'Not specified',
                    
                    // === SYSTEM TRACKING ===
                    department: jobData.department || jobData.dept || applicantData.department || 'Not specified',
                    position: jobData.jobTitle || jobData.position || jobData.title || applicantData.position || 'Unknown Position',
                    salary: jobData.salary || jobData.salaryRange || applicantData.expectedSalary || 'Not specified',
                    notes: `Hired from application ${applicationId} for job ${jobId} on ${new Date().toLocaleDateString()}`,
                    companyId: companyId,
                    
                    // === ADDITIONAL FIELDS (preserve any custom fields from applicant data) ===
                    nationality: applicantData.nationality || '',
                    dateOfBirth: applicantData.dateOfBirth || applicantData.dob || '',
                    gender: applicantData.gender || '',
                    maritalStatus: applicantData.maritalStatus || '',
                    emergencyContact: applicantData.emergencyContact || '',
                    references: applicantData.references || [],
                    
                    // === TRACKING METADATA ===
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'interview_module',
                    hiringWorkflow: 'standard'
                };

                // Generate unique ID for hired candidate
                const hiredId = database.ref().child('temp').push().key;
                hiredCandidateData.hiredId = hiredId;

                console.log('?? Hired Candidate Storage Paths:');
                console.log('  Company Current Job Path:', `companies/${companyId}/jobs/${jobId}/hired/${hiredId}`);
                console.log('  Company JobClosed Path:', `companies/${companyId}/jobclosed/${jobId}/hired/${hiredId}`);
                console.log('  Company Hired Path:', `companies/${companyId}/hired/${hiredId}`);
                console.log('  Legacy Hired Path:', `hired/${hiredId}`);
                console.log('  Hired Data:', hiredCandidateData);

                // Store hired candidate data in multiple paths
                const hiredPromises = [];
                
                // Store in current/active job's hired path (PRIMARY - current job path)
                const currentJobHiredRef = database.ref(`companies/${companyId}/jobs/${jobId}/hired/${hiredId}`);
                hiredPromises.push(currentJobHiredRef.set(hiredCandidateData));
                
                // Store in job's hired path (closed jobs storage)
                const jobHiredRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/hired/${hiredId}`);
                hiredPromises.push(jobHiredRef.set(hiredCandidateData));
                
                // Store in company's hired collection for global access
                const companyHiredRef = database.ref(`companies/${companyId}/hired/${hiredId}`);
                hiredPromises.push(companyHiredRef.set(hiredCandidateData));
                
                // Store in legacy hired path for backwards compatibility
                const legacyHiredRef = database.ref(`hired/${hiredId}`);
                hiredPromises.push(legacyHiredRef.set(hiredCandidateData));

                // Update application status to 'hired' in all correct paths
                const statusPromises = [];
                
                console.log('?? Updating application status to hired in all paths...');
                
                // Update company jobs applications path (primary path)
                const companyJobStatusRef = database.ref(`companies/${companyId}/jobs/${jobId}/applications/${applicationId}`);
                statusPromises.push(companyJobStatusRef.update({
                    status: 'hired',
                    hiredDate: new Date().toISOString(),
                    hiredId: hiredId
                }));
                
                // Update company jobclosed path
                const jobclosedStatusRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/applications/${applicationId}`);
                statusPromises.push(jobclosedStatusRef.update({
                    status: 'hired',
                    hiredDate: new Date().toISOString(),
                    hiredId: hiredId
                }));
                
                // Update legacy path
                const legacyStatusRef = database.ref(`jobs/${jobId}/applications/${applicationId}`);
                statusPromises.push(legacyStatusRef.update({
                    status: 'hired',
                    hiredDate: new Date().toISOString(),
                    hiredId: hiredId
                }));

                // Execute all database updates
                await Promise.all([...hiredPromises, ...statusPromises]);

                // Create detailed success message showing captured information
                const capturedFields = [];
                if (candidateEmail && candidateEmail !== '') capturedFields.push('? Email Address');
                if (jobPosition && jobPosition !== 'Position not specified') capturedFields.push('? Job Position');
                if (hiredCandidateData.phone && hiredCandidateData.phone !== '') capturedFields.push('? Phone');
                if (hiredCandidateData.experience && hiredCandidateData.experience !== 'Not specified') capturedFields.push('? Experience');
                if (hiredCandidateData.education && hiredCandidateData.education !== 'Not specified') capturedFields.push('? Education');
                if (hiredCandidateData.skills && hiredCandidateData.skills !== 'Not specified') capturedFields.push('? Skills');
                if (hiredCandidateData.resumeUrl && hiredCandidateData.resumeUrl !== '') capturedFields.push('? Resume');
                if (hiredCandidateData.jobSalary && hiredCandidateData.jobSalary !== 'Not specified') capturedFields.push('? Salary Info');
                if (hiredCandidateData.previousCompany && hiredCandidateData.previousCompany !== 'Not specified') capturedFields.push('? Previous Company');

                const fieldsMessage = capturedFields.length > 0 
                    ? `\n\n?? Captured Information:\n${capturedFields.join('\n')}`
                    : '\n\nNote: Some fields may show as "Not specified" if information was not provided in the original application.';

                // Show comprehensive success message with emphasis on email and position
                alert(`?? ${applicantName} has been successfully hired!\n\n` +
                      `?? Complete Profile Created:\n` +
                      ` Employee Record: ${hiredId}\n` +
                      ` Email: ${candidateEmail || 'Not provided'}\n` +
                      ` Position: ${jobPosition}\n` +
                      ` Department: ${hiredCandidateData.jobDepartment}\n` +
                      ` Hire Date: ${new Date(hiredCandidateData.hiredDate).toLocaleDateString()}\n` +
                      ` Hired By: ${hiredCandidateData.hiredBy}\n\n` +
                      `?? Data Storage Locations:\n` +
                      ` Current Job Collection ?\n` +
                      ` Closed Job Archive ?\n` +
                      ` Company Hired Database ?\n` +
                      ` System Backup ?\n` +
                      fieldsMessage +
                      `\n\n?? Tip: Check the Hired tab to see the email and position properly displayed.`);

                console.log('?? HIRE OPERATION COMPLETE ??');
                console.log('========================================');
                console.log('Candidate:', applicantName);
                console.log('Email:', candidateEmail);
                console.log('Position:', jobPosition);
                console.log('Department:', hiredCandidateData.jobDepartment);
                console.log('Hired ID:', hiredId);
                console.log('Captured Fields:', capturedFields);
                console.log('Full Data:', hiredCandidateData);
                console.log('========================================');

                // Refresh the current view if we're still viewing the same job
                if (selectedJobId === jobId) {
                    loadJobApplicants(jobId);
                }

                console.log('Candidate hired successfully:', {
                    hiredId: hiredId,
                    applicationId: applicationId,
                    jobId: jobId,
                    candidateName: applicantName,
                    hiredDate: hiredCandidateData.hiredDate,
                    storedInCurrentJobPath: `companies/${companyId}/jobs/${jobId}/hired/${hiredId}`,
                    storedInJobClosedPath: `companies/${companyId}/jobclosed/${jobId}/hired/${hiredId}`,
                    storedInCompanyPath: `companies/${companyId}/hired/${hiredId}`,
                    storedInLegacyPath: `hired/${hiredId}`
                });

            } catch (error) {
                console.error('Error hiring applicant:', error);
                alert(`Error hiring ${applicantName}: ${error.message}\nPlease try again.`);
            }
        }

        // Handle page visibility changes to refresh data when user returns
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && !isLoading) {
                loadCandidates();
            }
        });
        
        // ========== JOBS FUNCTIONALITY ==========
          // Show jobs loading state
        function showJobsLoading() {
            isJobsLoading = true;
            if (jobsLoadingState) jobsLoadingState.style.display = 'block';
            if (jobsErrorState) jobsErrorState.style.display = 'none';
            if (jobsContainer) jobsContainer.style.display = 'none';
            
            // Hide table and show loading in new structure
            const jobsTable = document.getElementById('jobsTable');
            if (jobsTable) jobsTable.style.display = 'none';
            if (refreshJobsBtn) refreshJobsBtn.disabled = true;
        }

        // Show jobs error state
        function showJobsError(message) {
            isJobsLoading = false;
            if (jobsLoadingState) jobsLoadingState.style.display = 'none';
            if (jobsErrorState) jobsErrorState.style.display = 'flex';
            if (jobsContainer) jobsContainer.style.display = 'none';
            
            // Hide loading and table in new structure
            const jobsTable = document.getElementById('jobsTable');
            if (jobsTable) jobsTable.style.display = 'none';
            if (jobsErrorMessage) jobsErrorMessage.textContent = message;
            if (refreshJobsBtn) refreshJobsBtn.disabled = false;
        }

        // Show jobs table
        function showJobs() {
            isJobsLoading = false;
            console.log('?? showJobs() called - hiding loading state');
            
            // Force hide loading state
            const loadingState = document.getElementById('loadingState');
            if (loadingState) {
                loadingState.style.display = 'none';
                console.log('? Loading state hidden');
            } else {
                console.warn('? Loading state element not found');
            }
            
            if (jobsLoadingState) {
                jobsLoadingState.style.display = 'none';
                console.log('? jobsLoadingState hidden');
            }
            if (jobsErrorState) {
                jobsErrorState.style.display = 'none';
                console.log('? jobsErrorState hidden');
            }
            if (jobsContainer) {
                jobsContainer.style.display = 'block';
                console.log('? jobsContainer shown');
            }
            
            // Show table in new structure
            const jobsTable = document.getElementById('jobsTable');
            if (jobsTable) {
                jobsTable.style.display = 'table';
                console.log('? Jobs table shown');
            } else {
                console.warn('? Jobs table element not found');
            }
            
            if (refreshJobsBtn) refreshJobsBtn.disabled = false;
            updateJobsLastUpdated();
        }

        // Get company ID from localStorage
        function getCompanyId() {
            console.log('?? Getting company ID...');
            
            // Use the embedded CompanyDataService
            if (window.companyDataService) {
                const serviceCompanyId = window.companyDataService.currentCompanyId;
                console.log('?? CompanyDataService company ID:', serviceCompanyId);
                if (serviceCompanyId) {
                    console.log('? Using CompanyDataService company ID:', serviceCompanyId);
                    return serviceCompanyId;
                }
            }
            
            const localStorageCompanyId = localStorage.getItem('companyId');
            console.log('?? localStorage company ID:', localStorageCompanyId);
            
            if (localStorageCompanyId) {
                console.log('? Using localStorage company ID:', localStorageCompanyId);
                return localStorageCompanyId;
            }
            
            // Check current user for company ID
            const currentUser = AuthManager.getCurrentUser();
            console.log('?? Current user from AuthManager:', currentUser);
            
            if (currentUser && currentUser.companyId) {
                console.log('? Using user company ID:', currentUser.companyId);
                return currentUser.companyId;
            }
            
            // If not found, check if user is authenticated and get from user data
            const firebase = initializeFirebase();
            const user = firebase.auth().currentUser;
            if (user) {
                console.warn('?? Company ID not found in localStorage or user data');
            } else {
                console.warn('?? No authenticated user found');
            }
            
            console.log('? No company ID found');
            return null;
        }

        // Get current user name from localStorage
        function getCurrentUserName() {
            console.log('?? Getting current user name...');
            
            // Try to get user from the global authManager instance first
            if (window.authManager) {
                const currentUser = window.authManager.getCurrentUser();
                console.log('?? Current user from authManager:', currentUser);
                
                if (currentUser) {
                    // Return the best available name
                    if (currentUser.firstName && currentUser.lastName) {
                        return `${currentUser.firstName} ${currentUser.lastName}`;
                    } else if (currentUser.displayName) {
                        return currentUser.displayName;
                    } else if (currentUser.name) {
                        return currentUser.name;
                    } else if (currentUser.email) {
                        return currentUser.email;
                    }
                }
            }
            
            // Fallback: try to get directly from localStorage
            const storedUser = localStorage.getItem('currentUser') || localStorage.getItem('user');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    if (userData.firstName && userData.lastName) {
                        return `${userData.firstName} ${userData.lastName}`;
                    } else if (userData.displayName) {
                        return userData.displayName;
                    } else if (userData.name) {
                        return userData.name;
                    } else if (userData.email) {
                        return userData.email;
                    }
                } catch (error) {
                    console.error('Error parsing stored user data:', error);
                }
            }
            
            // Final fallback: try to get from Firebase auth
            try {
                const firebase = initializeFirebase();
                const user = firebase.auth().currentUser;
                if (user) {
                    if (user.displayName) {
                        return user.displayName;
                    } else if (user.email) {
                        return user.email;
                    }
                }
            } catch (error) {
                console.error('Error getting Firebase auth user:', error);
            }
            
            console.log('? No user name found');
            return 'Unknown User';
        }

        // Load jobs from Firebase company-scoped jobs path with closed status
        async function loadJobs() {
            try {
                showJobsLoading();
                
                // Clear any existing filters first
                console.log('?? Clearing filters before loading jobs...');
                clearFilters();
                debugFilters();
                
                const companyId = getCompanyId();
                console.log('?? Company ID for jobs loading:', companyId);
                
                if (!companyId) {
                    console.warn('? No company ID found, cannot load closed jobs');
                    showJobsError('Company ID not found. Please ensure you are logged in properly.');
                    return;
                }
                
                console.log('?? Loading jobs with closed status for company:', companyId);
                const jobsPath = `companies/${companyId}/jobs`;
                console.log('?? Jobs database path:', jobsPath);
                
                // Add timeout mechanism
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout')), 10000)
                );
                
                const jobsRef = database.ref(jobsPath);
                const snapshot = await Promise.race([
                    jobsRef.once('value'),
                    timeout
                ]);
                
                console.log('?? Snapshot exists:', snapshot.exists());
                if (snapshot.exists()) {
                    const allJobs = snapshot.val();
                    console.log('?? Raw jobs data:', allJobs);
                    console.log('?? Type of allJobs:', typeof allJobs);
                    console.log('?? All job keys:', Object.keys(allJobs));
                    
                    // Log each job's status for debugging
                    Object.keys(allJobs).forEach(jobKey => {
                        const jobData = allJobs[jobKey];
                        console.log(`?? Job ${jobKey} status:`, jobData.status, 'Full data:', jobData);
                    });
                    
                    // Filter jobs with status "closed"
                    const closedJobs = {};
                    Object.keys(allJobs).forEach(jobKey => {
                        const jobData = allJobs[jobKey];
                        console.log(`?? Checking job ${jobKey}: status = "${jobData.status}" (${typeof jobData.status})`);
                        if (jobData.status === 'closed') {
                            console.log(`? Adding closed job: ${jobKey}`);
                            closedJobs[jobKey] = jobData;
                        } else {
                            console.log(`? Skipping job ${jobKey}: status is "${jobData.status}", not "closed"`);
                        }
                    });
                    
                    console.log('?? Number of closed jobs found:', Object.keys(closedJobs).length);
                    console.log('?? Closed jobs object:', closedJobs);
                    
                    jobsData = {};
                    
                    // If no closed jobs found, temporarily show all jobs for debugging
                    const jobsToProcess = Object.keys(closedJobs).length > 0 ? closedJobs : allJobs;
                    const jobType = Object.keys(closedJobs).length > 0 ? 'closed' : 'all (for debugging)';
                    console.log(`?? Processing ${jobType} jobs:`, Object.keys(jobsToProcess).length, 'jobs');
                    
                    // Process jobs from company scope - matching jobscreen.html structure
                    Object.keys(jobsToProcess).forEach(jobKey => {
                        const jobData = jobsToProcess[jobKey];
                        console.log(`?? Processing job ${jobKey}:`, jobData);
                        
                        // Map the job data structure to match jobscreen.html format
                        jobsData[jobKey] = {
                            id: jobKey,
                            title: jobData.jobTitle || jobData.position || jobData.title || 'Untitled Job',
                            jobTitle: jobData.jobTitle || jobData.position || jobData.title || 'Untitled Job',
                            position: jobData.jobTitle || jobData.position || jobData.title || 'Untitled Job',
                            positionCode: jobData.positionCode || 'N/A',
                            department: jobData.department || jobData.dept || 'Not specified',
                            location: jobData.location || jobData.jobLocation || 'Not specified',
                            employmentType: jobData.employmentType || jobData.jobType || 'Not specified',
                            status: Object.keys(closedJobs).length > 0 ? 'closed' : (jobData.status || 'unknown'), // Show actual status when debugging
                            originalStatus: jobData.originalStatus || jobData.status || 'unknown',
                            datePosted: jobData.datePosted || jobData.postedDate || jobData.createdDate || jobData.timestamp || 'Unknown',
                            archivedDate: jobData.archivedDate || jobData.dateArchived || jobData.closedDate || 'Unknown',
                            closedDate: jobData.closedDate || jobData.archivedDate || 'Unknown',
                            archiveReason: jobData.archiveReason || 'Closed',
                            closedBy: jobData.closedBy || 'Admin',
                            applicationCount: jobData.applicationCount || 0,
                            minSalary: jobData.minSalary || 0,
                            maxSalary: jobData.maxSalary || 0,
                            urgency: jobData.urgency || 'normal',
                            description: jobData.description || jobData.jobDescription || '',
                            requirements: jobData.requirements || jobData.jobRequirements || '',
                            ...jobData // Include any additional fields
                        };
                    });
                    
                    console.log(`? Loaded ${Object.keys(jobsData).length} ${jobType} jobs for display`);
                    console.log('??? Processed jobs data:', jobsData);
                    showJobs();
                    renderJobs();
                    updateJobsStats();
                } else {
                    console.log('?? No jobs found in database at path:', jobsPath);
                    console.log('?? Snapshot value:', snapshot.val());
                    jobsData = {};
                    showJobs();
                    renderJobs();
                    updateJobsStats();
                }
                
                updateJobsLastUpdated();
                
            } catch (error) {
                console.error('? Error loading closed jobs:', error);
                if (error.message === 'Request timeout') {
                    showJobsError('Request timed out. Please check your internet connection and try again.');
                } else {
                    showJobsError('Failed to load closed jobs. Please try again. Error: ' + error.message);
                }
            }
        }

        // Force stop loading - for debugging
        function forceStopLoading() {
            console.log('?? Force stopping jobs loading...');
            
            // Force hide all loading states
            const loadingState = document.getElementById('loadingState');
            if (loadingState) loadingState.style.display = 'none';
            
            // Show empty table with message
            jobsData = {};
            showJobs();
            renderJobs();
            
            console.log('? Loading force stopped');
        }

        // Setup real-time listener for jobs
        function setupJobsRealTimeListener() {
            const companyId = getCompanyId();
            if (!companyId) {
                console.warn('No company ID found, cannot setup real-time listener for closed jobs');
                return;
            }
            
            const jobsRef = database.ref(`companies/${companyId}/jobs`);
            
            jobsRef.on('value', (snapshot) => {
                if (!isJobsLoading) {
                    if (snapshot.exists()) {
                        const allJobs = snapshot.val();
                        
                        // Filter jobs with status "closed"
                        const closedJobs = {};
                        Object.keys(allJobs).forEach(jobKey => {
                            const jobData = allJobs[jobKey];
                            if (jobData.status === 'closed') {
                                closedJobs[jobKey] = jobData;
                            }
                        });
                        
                        jobsData = {};
                        
                        // Process closed jobs from company scope
                        Object.keys(closedJobs).forEach(jobKey => {
                            const jobData = closedJobs[jobKey];
                            if (jobData.title || jobData.jobTitle || jobData.position) {
                                jobsData[jobKey] = {
                                    id: jobKey,
                                    title: jobData.title || jobData.jobTitle || jobData.position || 'Untitled Job',
                                    department: jobData.department || jobData.dept || 'Not specified',
                                    location: jobData.location || jobData.jobLocation || 'Not specified',
                                    status: 'closed', // All jobs filtered are closed
                                    datePosted: jobData.datePosted || jobData.createdDate || jobData.timestamp || 'Unknown',
                                    closedDate: jobData.closedDate || jobData.archivedDate || 'Unknown',
                                    description: jobData.description || jobData.jobDescription || '',
                                    requirements: jobData.requirements || jobData.jobRequirements || '',
                                    salary: jobData.salary || jobData.salaryRange || jobData.salaryMin && jobData.salaryMax ? `${jobData.salaryMin} - ${jobData.salaryMax}` : '',
                                    applications: jobData.applications || {},
                                    companyId: companyId,
                                    ...jobData
                                };
                            }
                        });
                        
                        console.log('Real-time update: closed jobs count:', Object.keys(jobsData).length);
                    } else {
                        jobsData = {};
                    }
                    renderJobs();
                    updateJobsStats();
                    updateJobsLastUpdated();
                }
            }, (error) => {
                console.error('Jobs real-time listener error:', error);
                showJobsError(`Real-time updates failed: ${error.message}`);
            });
        }        // Render jobs in the table
        function renderJobs() {
            console.log('?? renderJobs called');
            console.log('?? jobsTableBody element:', jobsTableBody);
            
            if (!jobsTableBody) {
                console.error('? jobsTableBody element not found');
                return;
            }
            
            jobsTableBody.innerHTML = '';
            
            const jobs = Object.values(jobsData);
            console.log('?? Jobs to render:', jobs.length);
            console.log('??? Jobs data:', jobs);
            
            // Update allJobs for applicant loading
            allJobs = { ...jobsData };
            
            if (jobs.length === 0) {
                console.log('?? No jobs to display - showing empty state');
                if (jobsEmptyState) jobsEmptyState.style.display = 'block';
                if (jobsTableBody.closest('table')) jobsTableBody.closest('table').style.display = 'none';
                return;
            }

            console.log('? Hiding empty state and showing table');
            if (jobsEmptyState) jobsEmptyState.style.display = 'none';
            if (jobsTableBody.closest('table')) jobsTableBody.closest('table').style.display = 'table';

            jobs.forEach((job, index) => {
                console.log(`?? Creating row for job ${index + 1}:`, job);
                const row = createJobRow(job);
                jobsTableBody.appendChild(row);
            });
            
            console.log('? All job rows added to table');
        }

        // Create a table row for a job
        function createJobRow(job) {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.addEventListener('click', function(event) {
                console.log('Job row clicked:', job.id, job.title);
                loadJobApplicants(job.id);
            });
            
            const jobTitle = job.title || job.jobTitle || job.position || 'Untitled Job';
            const positionCode = job.positionCode || job.id || 'N/A';
            const department = job.department || 'N/A';
            const employmentType = formatEmploymentType(job.employmentType || job.jobType);
            const status = job.status || 'draft';
            const urgency = job.urgency || 'normal';
            
            // Enhanced salary range formatting for closed jobs
            let salaryRange = 'Not specified';
            if (job.minSalary || job.maxSalary) {
                salaryRange = formatSalaryRange(job.minSalary, job.maxSalary);
            } else if (job.salaryMin || job.salaryMax) {
                salaryRange = formatSalaryRange(job.salaryMin, job.salaryMax);
            } else if (job.salary) {
                salaryRange = job.salary;
            }
            
            const applicationCount = job.applicationCount || 
                                   (job.applications ? Object.keys(job.applications).length : 0);
            
            // Enhanced date display for closed jobs
            let dateToShow = '';
            if (job.status === 'closed') {
                const closedDate = job.closedDate || job.archivedDate;
                const postedDate = job.datePosted || job.postedDate;
                if (closedDate) {
                    dateToShow = `Closed: ${formatDate(closedDate)}`;
                } else if (postedDate) {
                    dateToShow = `Posted: ${formatDate(postedDate)}`;
                } else {
                    dateToShow = 'Date unknown';
                }
            } else {
                const postedDate = job.datePosted || job.postedDate;
                dateToShow = postedDate ? `Posted: ${formatDate(postedDate)}` : 'Date unknown';
            }

            row.innerHTML = `
                <td class="job-title-cell">
                    <div>
                        <strong>${escapeHtml(jobTitle)}</strong>
                        ${job.archiveReason ? `<br><small class="text-muted">Reason: ${escapeHtml(job.archiveReason)}</small>` : ''}
                    </div>
                </td>
                <td><span class="job-code">${escapeHtml(positionCode)}</span></td>
                <td>${escapeHtml(department)}</td>
                <td><span class="employment-type">${employmentType}</span></td>
                <td><span class="status-badge status-${status}">${formatStatus(status)}</span></td>
                <td><span class="urgency-badge urgency-${urgency}">${formatUrgency(urgency)}</span></td>
                <td><span class="salary-range">${salaryRange}</span></td>
                <td>
                    <div class="applications-count">
                        <i class="fas fa-users"></i>
                        <span class="count-badge">${applicationCount}</span>
                    </div>
                </td>
                <td class="text-muted">${dateToShow}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn btn-view" onclick="event.stopPropagation(); viewJob('${job.id}')" title="View Job Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-info" onclick="event.stopPropagation(); showJobEvaluationRanking('${job.id}')" title="View Evaluation Rankings">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button class="action-btn btn-mail" onclick="event.stopPropagation(); sendJobEvaluationSummaryFromTable('${job.id}', '${escapeHtml(jobTitle)}')" title="Send Evaluation Summary">
                            <i class="fas fa-envelope"></i>
                        </button>
                        ${job.status === 'closed' ? 
                            `<button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteJob('${job.id}')" title="Delete Archived Job">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            `<button class="action-btn btn-edit" onclick="event.stopPropagation(); editJob('${job.id}')" title="Edit Job">
                                <i class="fas fa-edit"></i>
                            </button>`
                        }
                    </div>
                </td>
            `;

            return row;
        }

        // Formatting helper functions
        function formatStatus(status) {
            const statuses = {
                'active': 'Active',
                'published': 'Active',
                'closed': 'Closed',
                'paused': 'Paused',
                'draft': 'Draft'
            };
            return statuses[status?.toLowerCase()] || status || 'Draft';
        }

        function formatUrgency(urgency) {
            const urgencies = {
                'critical': 'Critical',
                'high': 'High',
                'medium': 'Medium',
                'normal': 'Normal',
                'low': 'Low'
            };
            return urgencies[urgency?.toLowerCase()] || 'Normal';
        }

        function formatSalaryRange(min, max) {
            if (!min && !max) return 'Not specified';
            
            const formatCurrency = (amount) => {
                if (!amount) return '';
                return '$' + parseInt(amount).toLocaleString();
            };

            if (min && max && min !== max) {
                return `${formatCurrency(min)} - ${formatCurrency(max)}`;
            } else if (min) {
                return `From ${formatCurrency(min)}`;
            } else if (max) {
                return `Up to ${formatCurrency(max)}`;
            }
              return 'Not specified';
        }

        // Search and filter functionality
        function clearFilters() {
            console.log('?? Clearing all filters...');
            
            // Reset search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                console.log('?? Search input current value:', searchInput.value);
                searchInput.value = '';
            }
            
            // Reset hidden filters
            const departmentFilter = document.getElementById('departmentFilter');
            const statusFilter = document.getElementById('statusFilter');
            const employmentTypeFilter = document.getElementById('employmentTypeFilter');
            const urgencyFilter = document.getElementById('urgencyFilter');
            const sortBy = document.getElementById('sortBy');
            
            if (departmentFilter) {
                console.log('?? Department filter current value:', departmentFilter.value);
                departmentFilter.value = '';
            }
            if (statusFilter) {
                console.log('?? Status filter current value:', statusFilter.value);
                statusFilter.value = '';
            }
            if (employmentTypeFilter) {
                console.log('?? Employment type filter current value:', employmentTypeFilter.value);
                employmentTypeFilter.value = '';
            }
            if (urgencyFilter) {
                console.log('? Urgency filter current value:', urgencyFilter.value);
                urgencyFilter.value = '';
            }
            if (sortBy) {
                console.log('?? Sort by current value:', sortBy.value);
                sortBy.value = 'datePosted';
            }
            
            console.log('? All filters cleared');
            
            // Re-render jobs
            renderJobs();
        }

        // Debug function to check filter values
        function debugFilters() {
            console.log('?? === FILTER DEBUG ===');
            const searchInput = document.getElementById('searchInput');
            const departmentFilter = document.getElementById('departmentFilter');
            const statusFilter = document.getElementById('statusFilter');
            const employmentTypeFilter = document.getElementById('employmentTypeFilter');
            const urgencyFilter = document.getElementById('urgencyFilter');
            const sortBy = document.getElementById('sortBy');
            
            console.log('Search:', searchInput ? searchInput.value : 'null');
            console.log('Department:', departmentFilter ? departmentFilter.value : 'null');
            console.log('Status:', statusFilter ? statusFilter.value : 'null');
            console.log('Employment Type:', employmentTypeFilter ? employmentTypeFilter.value : 'null');
            console.log('Urgency:', urgencyFilter ? urgencyFilter.value : 'null');
            console.log('Sort:', sortBy ? sortBy.value : 'null');
            console.log('===================');
        }

        // Pagination functionality (placeholder)
        let currentPage = 1;
        let totalPages = 1;

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderJobs();
                updatePaginationInfo();
            }
        }

        function updatePaginationInfo() {
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            }
            
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;
        }

        // Export functionality (placeholder)
        function exportJobs() {
            alert('Export functionality will be implemented here');
        }

        // Update jobs statistics for closed jobs
        function updateJobsStats() {
            const jobs = Object.values(jobsData);
            const total = jobs.length;
            const closed = jobs.filter(job => (job.status || 'closed').toLowerCase() === 'closed').length;

            if (totalJobs) totalJobs.textContent = total;
            if (activeJobs) {
                // For closed jobs, show closed count instead of active count
                activeJobs.textContent = closed;
                // Update the label if possible
                const activeLabel = activeJobs.parentElement?.querySelector('span, div, label');
                if (activeLabel && activeLabel.textContent.includes('Active')) {
                    activeLabel.textContent = activeLabel.textContent.replace('Active', 'Closed');
                }
            }

        }

        // Update jobs last updated timestamp
        function updateJobsLastUpdated() {
            const now = new Date();
            if (jobsLastUpdated) jobsLastUpdated.textContent = now.toLocaleString();
        }

        // Job action functions
        function viewJob(jobId) {
            const job = jobsData[jobId];
            if (job) {
                alert(`Job Details:\n\nTitle: ${job.title}\nDepartment: ${job.department}\nLocation: ${job.location}\nStatus: ${job.status}\nDescription: ${job.description || 'No description available'}`);
                // TODO: Implement detailed job view modal
            }
        }

        function editJob(jobId) {
            const job = jobsData[jobId];
            if (job) {
                console.log(`Edit functionality for job "${job.title}" will be implemented here.`);
                // TODO: Implement job edit modal
            }
        }

        async function deleteJob(jobId) {
            const job = jobsData[jobId];
            if (!job) {
                console.error('Job not found');
                return;
            }

            const jobTitle = job.jobTitle || job.title || 'this job';
            
            if (confirm(`Are you sure you want to permanently delete "${jobTitle}"? This action cannot be undone.`)) {
                try {
                    const user = AuthManager.getCurrentUser();
                    if (!user || !user.companyId) {
                        throw new Error('User not authenticated');
                    }

                    // Delete from closed jobs collection
                    await firebase.firestore()
                        .collection('companies')
                        .doc(user.companyId)
                        .collection('jobclosed')
                        .doc(jobId)
                        .delete();

                    console.log(`Job "${jobTitle}" deleted successfully`);
                    
                    // Remove from local data and refresh display
                    delete jobsData[jobId];
                    renderJobs();
                    updateJobsStats();
                    
                    // Show success message
                    alert(`Job "${jobTitle}" has been permanently deleted.`);
                    
                } catch (error) {
                    console.error('Error deleting job:', error);
                    alert('Failed to delete job. Please try again.');
                }
            }
        }

        function viewJobApplications(jobId) {
            const job = jobsData[jobId];
            if (job) {
                // Load job applicants using the new function
                loadJobApplicants(jobId);
            }
        }

        // Refresh jobs button handler
        if (refreshJobsBtn) {
            refreshJobsBtn.addEventListener('click', () => {
                if (!isJobsLoading) {
                    showJobsLoading();
                    loadJobs();
                }
            });
        }

        // Clear job filter function
        function clearJobFilter() {
            currentJobFilter = null;
            updateFilterIndicator();
            renderCandidates();
            updateStats();
        }

        // Update filter indicator visibility and text
        function updateFilterIndicator() {
            const filterIndicator = document.getElementById('jobFilterIndicator');
            const filterJobTitle = document.getElementById('filterJobTitle');
            const applicantsTableTitle = document.getElementById('applicantsTableTitle');
            
            if (currentJobFilter && filterIndicator && filterJobTitle && applicantsTableTitle) {
                filterIndicator.style.display = 'block';
                filterJobTitle.textContent = `Filtering by: ${currentJobFilter.title}`;
                applicantsTableTitle.textContent = `Applicants for "${currentJobFilter.title}"`;
            } else if (filterIndicator && applicantsTableTitle) {
                filterIndicator.style.display = 'none';
                applicantsTableTitle.textContent = 'Job Interview Applicants';
            }
        }
        
        // ========== ARCHIVES FUNCTIONALITY ==========

        // ========== HIRED FUNCTIONALITY ==========
        
        // Show hired loading state
        function showHiredLoading() {
            isHiredLoading = true;
            if (hiredLoadingState) hiredLoadingState.style.display = 'block';
            if (hiredErrorState) hiredErrorState.style.display = 'none';
            if (hiredContainer) hiredContainer.style.display = 'none';
        }

        // Show hired error state
        function showHiredError(message) {
            isHiredLoading = false;
            if (hiredLoadingState) hiredLoadingState.style.display = 'none';
            if (hiredErrorState) hiredErrorState.style.display = 'flex';
            if (hiredContainer) hiredContainer.style.display = 'none';
            if (hiredErrorMessage) hiredErrorMessage.textContent = message;
        }

        // Show hired table
        function showHired() {
            isHiredLoading = false;
            if (hiredLoadingState) hiredLoadingState.style.display = 'none';
            if (hiredErrorState) hiredErrorState.style.display = 'none';
            if (hiredContainer) hiredContainer.style.display = 'block';
            updateHiredLastUpdated();
        }

        // Load hired candidates from Firebase
        async function loadHired() {
            try {
                showHiredLoading();
                console.log('?? Starting to load hired candidates...');
                
                const companyId = getCompanyId();
                console.log('?? Company ID:', companyId);
                
                if (!companyId) {
                    console.error('? No company ID found');
                    showHiredError('No company ID found. Please ensure you are logged in properly.');
                    return;
                }
                
                // Initialize hired data
                hiredData = {};
                
                // 1. Load from company-scoped hired path (global company hired collection)
                console.log('?? Loading from company hired collection...');
                try {
                    const companyHiredRef = database.ref(`companies/${companyId}/hired`);
                    const companySnapshot = await companyHiredRef.once('value');
                    
                    if (companySnapshot.exists()) {
                        const companyHiredData = companySnapshot.val();
                        Object.assign(hiredData, companyHiredData);
                        console.log('? Loaded hired candidates from company path:', Object.keys(companyHiredData).length);
                    } else {
                        console.log('?? No data in company hired collection');
                    }
                } catch (error) {
                    console.error('? Error loading company hired data:', error);
                }

                // 2. Load from job-specific hired paths (current jobs)
                console.log('?? Loading from job-specific hired paths...');
                try {
                    const jobsRef = database.ref(`companies/${companyId}/jobs`);
                    const jobsSnapshot = await jobsRef.once('value');
                    
                    if (jobsSnapshot.exists()) {
                        const allJobs = jobsSnapshot.val();
                        for (const currentJobId of Object.keys(allJobs)) {
                            try {
                                const jobHiredRef = database.ref(`companies/${companyId}/jobs/${currentJobId}/hired`);
                                const jobHiredSnapshot = await jobHiredRef.once('value');
                                
                                if (jobHiredSnapshot.exists()) {
                                    const jobSpecificHiredData = jobHiredSnapshot.val();
                                    Object.assign(hiredData, jobSpecificHiredData);
                                    console.log(`? Loaded ${Object.keys(jobSpecificHiredData).length} hired candidates from job ${currentJobId}`);
                                }
                            } catch (jobError) {
                                console.warn(`?? Error loading hired data from job ${currentJobId}:`, jobError);
                            }
                        }
                    } else {
                        console.log('?? No jobs found');
                    }
                } catch (error) {
                    console.error('? Error loading job-specific hired data:', error);
                }

                // 3. Load from closed job hired paths
                console.log('?? Loading from closed job hired paths...');
                try {
                    const closedJobsRef = database.ref(`companies/${companyId}/jobclosed`);
                    const closedJobsSnapshot = await closedJobsRef.once('value');
                    
                    if (closedJobsSnapshot.exists()) {
                        const allClosedJobs = closedJobsSnapshot.val();
                        for (const closedJobId of Object.keys(allClosedJobs)) {
                            try {
                                const closedJobHiredRef = database.ref(`companies/${companyId}/jobclosed/${closedJobId}/hired`);
                                const closedJobHiredSnapshot = await closedJobHiredRef.once('value');
                                
                                if (closedJobHiredSnapshot.exists()) {
                                    const closedJobSpecificHiredData = closedJobHiredSnapshot.val();
                                    Object.assign(hiredData, closedJobSpecificHiredData);
                                    console.log(`? Loaded ${Object.keys(closedJobSpecificHiredData).length} hired candidates from closed job ${closedJobId}`);
                                }
                            } catch (closedJobError) {
                                console.warn(`?? Error loading hired data from closed job ${closedJobId}:`, closedJobError);
                            }
                        }
                    } else {
                        console.log('?? No closed jobs found');
                    }
                } catch (error) {
                    console.error('? Error loading closed job hired data:', error);
                }
                
                // 4. Load from legacy hired path for backwards compatibility
                console.log('?? Loading from legacy hired path...');
                try {
                    const legacyHiredRef = database.ref('hired');
                    const legacySnapshot = await legacyHiredRef.once('value');
                    
                    if (legacySnapshot.exists()) {
                        const legacyHiredData = legacySnapshot.val();
                        // Only add legacy data if it doesn't exist in company data
                        Object.keys(legacyHiredData).forEach(key => {
                            if (!hiredData[key]) {
                                hiredData[key] = legacyHiredData[key];
                            }
                        });
                        console.log('? Merged with legacy hired data, total candidates:', Object.keys(hiredData).length);
                    } else {
                        console.log('?? No legacy hired data found');
                    }
                } catch (error) {
                    console.error('? Error loading legacy hired data:', error);
                }
                
                console.log('?? TOTAL HIRED CANDIDATES LOADED:', Object.keys(hiredData).length);
                console.log('?? Hired candidates data:', hiredData);
                
                // Render the data
                renderHired();
                
                // Update stats if function exists
                if (typeof updateHiredStats === 'function') {
                    updateHiredStats();
                }
                
                // Show the hired section
                showHired();
                
            } catch (error) {
                console.error('? Critical error loading hired candidates:', error);
                showHiredError(`Failed to load hired candidates: ${error.message}`);
            }
        }

        // Setup real-time listener for hired candidates
        async function setupHiredRealTimeListener() {
            try {
                const companyId = await getCompanyId();
                console.log('Setting up hired real-time listener for company:', companyId);
                
                // Setup company-scoped listener
                if (companyId) {
                    const companyHiredRef = database.ref(`companies/${companyId}/hired`);
                    
                    companyHiredRef.on('value', (snapshot) => {
                        if (!isHiredLoading) {
                            console.log('Company hired data changed, reloading...');
                            loadHired(); // Reload all hired data when company data changes
                        }
                    }, (error) => {
                        console.error('Error in company hired real-time listener:', error);
                        showHiredError(`Connection error: ${error.message}`);
                    });
                }
                
                // Setup legacy listener for backwards compatibility
                const legacyHiredRef = database.ref('hired');
                
                legacyHiredRef.on('value', (snapshot) => {
                    if (!isHiredLoading) {
                        console.log('Legacy hired data changed, reloading...');
                        loadHired(); // Reload all hired data when legacy data changes
                    }
                }, (error) => {
                    console.error('Error in legacy hired real-time listener:', error);
                    showHiredError(`Connection error: ${error.message}`);
                });
                
            } catch (error) {
                console.error('Error setting up hired real-time listener:', error);
                showHiredError(`Failed to setup real-time updates: ${error.message}`);
            }
        }

        // Render hired candidates table
        function renderHired() {
            if (!hiredTableBody) return;
            
            hiredTableBody.innerHTML = '';
            
            if (!hiredData || Object.keys(hiredData).length === 0) {
                if (hiredEmptyState) hiredEmptyState.style.display = 'block';
                return;
            }
            
            if (hiredEmptyState) hiredEmptyState.style.display = 'none';
            
            Object.keys(hiredData).forEach(hiredId => {
                const hired = hiredData[hiredId];
                const row = createHiredRow(hiredId, hired);
                hiredTableBody.appendChild(row);
            });
        }

        // Create hired candidate row with comprehensive data handling
        function createHiredRow(hiredId, hired) {
            const row = document.createElement('tr');
            row.className = 'clickable-row';
            row.setAttribute('data-hired-id', hiredId);
            
            // Format hire date with fallback
            let hiredDate = 'Unknown';
            if (hired.hiredDate) {
                try {
                    hiredDate = new Date(hired.hiredDate).toLocaleDateString();
                } catch (e) {
                    console.warn('Invalid hire date format:', hired.hiredDate);
                    hiredDate = hired.hiredDate.toString().substring(0, 10) || 'Unknown';
                }
            } else if (hired.hiredTimestamp) {
                try {
                    hiredDate = new Date(hired.hiredTimestamp).toLocaleDateString();
                } catch (e) {
                    hiredDate = 'Unknown';
                }
            }
            
            // Get candidate name with multiple fallbacks
            const fullName = hired.fullName || 
                            `${hired.firstName || ''} ${hired.lastName || ''}`.trim() || 
                            hired.name || 
                            hired.applicantName || 
                            'Unknown Candidate';
            
            // Get email with comprehensive fallbacks - ENSURE EMAIL IS DISPLAYED
            const email = hired.email || 
                         hired.emailAddress || 
                         hired.mail || 
                         hired.contactEmail ||
                         hired.userEmail ||
                         'No email provided';
            
            // Get job title from current published position with comprehensive fallbacks
            const jobTitle = hired.jobTitle || 
                           hired.position || 
                           hired.jobPosition || 
                           hired.title ||
                           hired.roleName ||
                           hired.positionTitle ||
                           'Position not specified';
            
            // Get department with fallbacks (moved before logging to avoid initialization error)
            const department = hired.jobDepartment || 
                             hired.department || 
                             hired.dept || 
                             'Department not specified';
            
            // Log for debugging - ENHANCED
            console.log('?? HIRED ROW DEBUG:', {
                hiredId,
                fullName,
                email: email,
                emailFromHiredData: hired.email,
                jobTitle: jobTitle,
                jobTitleFromHiredData: hired.jobTitle,
                positionFromHiredData: hired.position,
                department,
                hiredDate,
                rawData: hired,
                allEmailFields: {
                    email: hired.email,
                    emailAddress: hired.emailAddress,
                    mail: hired.mail,
                    contactEmail: hired.contactEmail,
                    userEmail: hired.userEmail
                },
                allPositionFields: {
                    jobTitle: hired.jobTitle,
                    position: hired.position,
                    jobPosition: hired.jobPosition,
                    title: hired.title,
                    roleName: hired.roleName,
                    positionTitle: hired.positionTitle
                }
            });
            
            // Get phone number with fallbacks
            const phone = hired.phone || 
                         hired.phoneNumber || 
                         hired.contactNumber || 
                         hired.mobile || 
                         'No phone provided';
            
            // Get additional info for tooltip
            const experience = hired.experience || hired.yearsOfExperience || 'Not specified';
            const education = hired.education || hired.qualification || 'Not specified';
            const hiredBy = hired.hiredBy || 'System';
            
            row.innerHTML = `
                <td>
                    <div style="font-weight: 600; color: #2c3e50;" title="Full Name: ${escapeHtml(fullName)}">
                        ${escapeHtml(fullName)}
                    </div>
                    ${phone !== 'No phone provided' ? `
                        <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
                            ?? ${escapeHtml(phone)}
                        </small>
                    ` : ''}
                </td>
                <td>
                    <div style="color: #007bff;" title="Email: ${escapeHtml(email)}">
                        ${escapeHtml(email)}
                    </div>
                    ${hired.employeeId ? `
                        <small style="color: #28a745; display: block; margin-top: 0.25rem;">
                            ID: ${escapeHtml(hired.employeeId)}
                        </small>
                    ` : ''}
                </td>
                <td>
                    <div style="font-weight: 500;" title="Position: ${escapeHtml(jobTitle)}">
                        ${escapeHtml(jobTitle)}
                    </div>
                    ${experience !== 'Not specified' ? `
                        <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
                            Exp: ${escapeHtml(experience)}
                        </small>
                    ` : ''}
                </td>
                <td>
                    <div title="Department: ${escapeHtml(department)}">
                        ${escapeHtml(department)}
                    </div>
                    ${hired.jobLocation && hired.jobLocation !== 'Not specified' ? `
                        <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
                            ?? ${escapeHtml(hired.jobLocation)}
                        </small>
                    ` : ''}
                </td>
                <td>
                    <div style="color: #28a745; font-weight: 500;" title="Hired Date: ${hiredDate}">
                        ${hiredDate}
                    </div>
                    ${hiredBy !== 'System' ? `
                        <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
                            By: ${escapeHtml(hiredBy)}
                        </small>
                    ` : ''}
                </td>
                <td>
                    <span class="status-badge status-hired" title="Employment Status">
                        ${hired.startDate ? 'Active' : 'Hired'}
                    </span>
                    ${hired.startDate ? `
                        <small style="color: #28a745; display: block; margin-top: 0.25rem;">
                            Started: ${new Date(hired.startDate).toLocaleDateString()}
                        </small>
                    ` : ''}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-delete" onclick="deleteHiredCandidate('${hiredId}', '${escapeHtml(fullName)}')" title="Unhire">
                            <i class="fas fa-user-times"></i>
                        </button>
                        ${hired.resumeUrl ? `
                            <button class="btn-action btn-info" onclick="window.open('${hired.resumeUrl}', '_blank')" title="View Resume">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            return row;
        }

        // Update hired statistics
        function updateHiredStats() {
            const hiredCount = hiredData ? Object.keys(hiredData).length : 0;
            if (totalHired) totalHired.textContent = hiredCount;
        }

        // Update hired last updated time
        function updateHiredLastUpdated() {
            if (hiredLastUpdated) {
                hiredLastUpdated.textContent = new Date().toLocaleString();
            }
        }

        // Delete hired candidate from all storage paths
        async function deleteHiredCandidate(hiredId, candidateName) {
            console.log('??? deleteHiredCandidate called with:', { hiredId, candidateName });
            
            try {
                // Confirm deletion action
                const confirmDelete = confirm(
                    `?? Are you sure you want to remove "${candidateName}" from hired records?\n\n` +
                    `This action will:\n` +
                    ` Remove them from the hired candidates list\n` +
                    ` Change their application status back to 'interviewed'\n` +
                    ` Keep their original application data intact\n\n` +
                    `This action cannot be undone easily.`
                );
                
                if (!confirmDelete) {
                    return;
                }

                // Get company ID for company-scoped operations
                const companyId = getCompanyId();
                if (!companyId) {
                    alert('Error: Company ID not found. Please ensure you are logged in properly.');
                    return;
                }

                // Get the hired candidate data to restore application status
                const hired = hiredData[hiredId];
                if (!hired) {
                    alert('Error: Hired candidate data not found.');
                    return;
                }

                console.log('?? Hired candidate data for deletion:', hired);

                // Prepare deletion promises for all storage paths
                const deletionPromises = [];
                
                console.log('??? Removing hired candidate from all storage paths...');

                // 1. Remove from company hired collection (main path)
                const companyHiredRef = database.ref(`companies/${companyId}/hired/${hiredId}`);
                deletionPromises.push(companyHiredRef.remove());
                
                // 2. Remove from current job hired path if jobId exists
                if (hired.jobId) {
                    const currentJobHiredRef = database.ref(`companies/${companyId}/jobs/${hired.jobId}/hired/${hiredId}`);
                    deletionPromises.push(currentJobHiredRef.remove());
                    
                    // 3. Remove from job closed hired path
                    const jobClosedHiredRef = database.ref(`companies/${companyId}/jobclosed/${hired.jobId}/hired/${hiredId}`);
                    deletionPromises.push(jobClosedHiredRef.remove());
                }
                
                // 4. Remove from legacy hired path
                const legacyHiredRef = database.ref(`hired/${hiredId}`);
                deletionPromises.push(legacyHiredRef.remove());

                // Prepare status restoration promises (change back to 'interviewed')
                const statusPromises = [];
                
                if (hired.originalApplicationId && hired.jobId) {
                    console.log('?? Restoring application status to interviewed...');
                    
                    // Update company jobs applications path
                    const companyJobStatusRef = database.ref(`companies/${companyId}/jobs/${hired.jobId}/applications/${hired.originalApplicationId}`);
                    statusPromises.push(companyJobStatusRef.update({
                        status: 'interviewed',
                        hiredDate: null,
                        hiredId: null,
                        restoredFromHired: new Date().toISOString()
                    }));
                    
                    // Update company jobclosed path
                    const jobclosedStatusRef = database.ref(`companies/${companyId}/jobclosed/${hired.jobId}/applications/${hired.originalApplicationId}`);
                    statusPromises.push(jobclosedStatusRef.update({
                        status: 'interviewed',
                        hiredDate: null,
                        hiredId: null,
                        restoredFromHired: new Date().toISOString()
                    }));
                    
                    // Update legacy path
                    const legacyStatusRef = database.ref(`jobs/${hired.jobId}/applications/${hired.originalApplicationId}`);
                    statusPromises.push(legacyStatusRef.update({
                        status: 'interviewed',
                        hiredDate: null,
                        hiredId: null,
                        restoredFromHired: new Date().toISOString()
                    }));
                }

                // Execute all deletion and status update operations
                console.log('? Executing deletion operations...');
                await Promise.all([...deletionPromises, ...statusPromises]);

                // Show success message
                alert(
                    `? ${candidateName} has been successfully removed from hired records!\n\n` +
                    `?? Actions completed:\n` +
                    ` Removed from hired candidates database ?\n` +
                    ` Application status restored to 'interviewed' ?\n` +
                    ` All storage paths cleaned ?\n\n` +
                    `?? The candidate's original application is still available in the interviews section.`
                );

                console.log('?? DELETION OPERATION COMPLETE ??');
                console.log('========================================');
                console.log('Deleted Candidate:', candidateName);
                console.log('Hired ID:', hiredId);
                console.log('Company ID:', companyId);
                console.log('Original Application ID:', hired.originalApplicationId);
                console.log('Job ID:', hired.jobId);
                console.log('========================================');

                // Remove from local data and refresh display
                delete hiredData[hiredId];
                renderHired();

                // If we're viewing the job this candidate was hired for, refresh applicants
                if (selectedJobId === hired.jobId) {
                    loadJobApplicants(hired.jobId);
                }

            } catch (error) {
                console.error('? Error deleting hired candidate:', error);
                alert(
                    `? Error removing ${candidateName} from hired records:\n\n` +
                    `${error.message}\n\n` +
                    `Please try again or contact support if the problem persists.`
                );
            }
        }

        // Unhire candidate - change status back to interviewed but keep all records
        // Show archives loading state
        function showArchivesLoading() {
            isArchivesLoading = true;
            if (archivesLoadingState) archivesLoadingState.style.display = 'block';
            if (archivesErrorState) archivesErrorState.style.display = 'none';
            if (archivesContainer) archivesContainer.style.display = 'none';
            if (refreshArchivesBtn) refreshArchivesBtn.disabled = true;
        }

        // Show archives error state
        function showArchivesError(message) {
            isArchivesLoading = false;
            if (archivesLoadingState) archivesLoadingState.style.display = 'none';
            if (archivesErrorState) archivesErrorState.style.display = 'flex';
            if (archivesContainer) archivesContainer.style.display = 'none';
            if (archivesErrorMessage) archivesErrorMessage.textContent = message;
            if (refreshArchivesBtn) refreshArchivesBtn.disabled = false;
        }

        // Show archives table
        function showArchives() {
            isArchivesLoading = false;
            if (archivesLoadingState) archivesLoadingState.style.display = 'none';
            if (archivesErrorState) archivesErrorState.style.display = 'none';
            if (archivesContainer) archivesContainer.style.display = 'block';
            if (refreshArchivesBtn) refreshArchivesBtn.disabled = false;
            updateArchivesLastUpdated();
        }

        // Load archives from Firebase
        async function loadArchives() {
            try {
                const archivesRef = database.ref('archives');
                const snapshot = await archivesRef.once('value');
                
                if (snapshot.exists()) {
                    const archives = snapshot.val();
                    archivesData = {};
                    
                    // Process all archives
                    Object.keys(archives).forEach(archiveKey => {
                        const archiveData = archives[archiveKey];
                        
                        // Determine archive type based on content
                        let archiveType = 'Unknown';
                        let dataCount = 0;
                        let title = archiveKey;
                        
                        if (archiveData.applications) {
                            archiveType = 'Job Applications';
                            dataCount = Object.keys(archiveData.applications).length;
                            title = archiveData.jobTitle || archiveData.position || archiveData.title || 'Job Archive';
                        } else if (archiveData.jobTitle || archiveData.position || archiveData.title) {
                            archiveType = 'Job Posting';
                            title = archiveData.jobTitle || archiveData.position || archiveData.title;
                        } else if (typeof archiveData === 'object') {
                            archiveType = 'Data Record';
                            dataCount = Object.keys(archiveData).length;
                            title = archiveData.name || archiveData.title || archiveKey;
                        }
                        
                        archivesData[archiveKey] = {
                            id: archiveKey,
                            type: archiveType,
                            title: title,
                            status: archiveData.status || 'archived',
                            dateArchived: archiveData.dateArchived || archiveData.createdDate || archiveData.timestamp || 'Unknown',
                            dataCount: dataCount,
                            rawData: archiveData
                        };                    });
                    
                    renderArchives();
                    updateArchivesStats();
                    showArchives();} else {
                    archivesData = {};
                    renderArchives();
                    updateArchivesStats();
                    showArchives();
                }
            } catch (error) {
                console.error('Error loading archives:', error);
                showArchivesError(`Failed to load archives: ${error.message}`);
            }
        }

        // Setup real-time listener for archives
        function setupArchivesRealTimeListener() {
            const archivesRef = database.ref('archives');
            
            archivesRef.on('value', (snapshot) => {
                if (!isArchivesLoading) {
                    if (snapshot.exists()) {
                        const archives = snapshot.val();
                        archivesData = {};
                        
                        // Process all archives
                        Object.keys(archives).forEach(archiveKey => {
                            const archiveData = archives[archiveKey];
                            
                            // Determine archive type based on content
                            let archiveType = 'Unknown';
                            let dataCount = 0;
                            let title = archiveKey;
                            
                            if (archiveData.applications) {
                                archiveType = 'Job Applications';
                                dataCount = Object.keys(archiveData.applications).length;
                                title = archiveData.jobTitle || archiveData.position || archiveData.title || 'Job Archive';
                            } else if (archiveData.jobTitle || archiveData.position || archiveData.title) {
                                archiveType = 'Job Posting';
                                title = archiveData.jobTitle || archiveData.position || archiveData.title;
                            } else if (typeof archiveData === 'object') {
                                archiveType = 'Data Record';
                                dataCount = Object.keys(archiveData).length;
                                title = archiveData.name || archiveData.title || archiveKey;
                            }
                            
                            archivesData[archiveKey] = {
                                id: archiveKey,
                                type: archiveType,
                                title: title,
                                status: archiveData.status || 'archived',
                                dateArchived: archiveData.dateArchived || archiveData.createdDate || archiveData.timestamp || 'Unknown',
                                dataCount: dataCount,
                                rawData: archiveData
                            };
                        });
                    } else {
                        archivesData = {};
                    }                    renderArchives();
                    updateArchivesStats();
                    updateArchivesLastUpdated();
                }
            }, (error) => {
                console.error('Archives real-time listener error:', error);
                showArchivesError(`Real-time updates failed: ${error.message}`);
            });
        }

        // Render archives in the table
        function renderArchives() {
            if (!archivesTableBody) return;
            
            archivesTableBody.innerHTML = '';
            
            const archives = Object.values(archivesData);
            
            if (archives.length === 0) {
                if (archivesEmptyState) archivesEmptyState.style.display = 'block';
                if (archivesTableBody.closest('table')) archivesTableBody.closest('table').style.display = 'none';
                return;
            }

            if (archivesEmptyState) archivesEmptyState.style.display = 'none';
            if (archivesTableBody.closest('table')) archivesTableBody.closest('table').style.display = 'table';

            archives.forEach(archive => {
                const row = createArchiveRow(archive);
                archivesTableBody.appendChild(row);
            });
        }

        // Create a table row for an archive
        function createArchiveRow(archive) {
            const row = document.createElement('tr');
            
            // Format date
            let formattedDate = 'Unknown';
            if (archive.dateArchived && archive.dateArchived !== 'Unknown') {
                try {
                    const date = new Date(archive.dateArchived);
                    formattedDate = date.toLocaleDateString();
                } catch (e) {
                    formattedDate = archive.dateArchived;
                }
            }

            // Status styling
            const statusClass = archive.status.toLowerCase() === 'archived' ? 'status-hired' : 
                               archive.status.toLowerCase() === 'active' ? 'status-interviewed' : 
                               'status-pending';

            // Type styling
            let typeIcon = 'fas fa-file';
            if (archive.type === 'Job Applications') {
                typeIcon = 'fas fa-users';
            } else if (archive.type === 'Job Posting') {
                typeIcon = 'fas fa-briefcase';
            } else if (archive.type === 'Data Record') {
                typeIcon = 'fas fa-database';
            }

            row.innerHTML = `
                <td>
                    <div style="font-family: monospace; font-weight: 600; color: #2c3e50;">
                        ${escapeHtml(archive.id)}
                    </div>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="${typeIcon}" style="color: #007bff;"></i>
                        <span>${escapeHtml(archive.type)}</span>
                    </div>
                </td>
                <td>
                    <div style="font-weight: 600; color: #2c3e50;">
                        ${escapeHtml(archive.title)}
                    </div>
                </td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${escapeHtml(archive.status)}
                    </span>
                </td>
                <td>${escapeHtml(formattedDate)}</td>
                <td>
                    <span style="font-weight: 600; color: #007bff;">
                        ${archive.dataCount} ${archive.dataCount === 1 ? 'item' : 'items'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewArchive('${archive.id}')" title="View Archive">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${archive.type === 'Job Applications' ? `
                        <button class="btn-action btn-edit" onclick="viewArchiveApplications('${archive.id}')" title="View Applications">
                            <i class="fas fa-users"></i>
                        </button>` : ''}
                        <button class="btn-action btn-delete" onclick="deleteArchive('${archive.id}')" title="Delete Archive">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            return row;
        }

        // Update archives statistics
        function updateArchivesStats() {
            const archives = Object.values(archivesData);
            const total = archives.length;

            if (totalArchives) totalArchives.textContent = total;
        }

        // Update archives last updated timestamp
        function updateArchivesLastUpdated() {
            const now = new Date();
            if (archivesLastUpdated) archivesLastUpdated.textContent = now.toLocaleString();
        }

        // Archive action functions
        function viewArchive(archiveId) {
            const archive = archivesData[archiveId];
            if (archive) {
                const details = `Archive Details:\n\nID: ${archive.id}\nType: ${archive.type}\nTitle: ${archive.title}\nStatus: ${archive.status}\nDate Archived: ${archive.dateArchived}\nData Count: ${archive.dataCount} items`;
                alert(details);
                // TODO: Implement detailed archive view modal
            }
        }

        function viewArchiveApplications(archiveId) {
            const archive = archivesData[archiveId];
            if (archive && archive.type === 'Job Applications') {
                // Switch to applicants tab with specific archive
                switchToTab('applicants');
                // TODO: Filter by specific archive
                console.log(`Viewing applications from archive: ${archive.title}`);
            }
        }

        function deleteArchive(archiveId) {
            const archive = archivesData[archiveId];
            if (archive) {
                if (confirm(`Are you sure you want to delete the archive "${archive.title}"?\n\nThis action cannot be undone.`)) {
                    database.ref(`archives/${archiveId}`).remove()
                        .then(() => {
                            console.log(`Archive ${archiveId} deleted successfully`);
                        })
                        .catch((error) => {
                            console.error('Error deleting archive:', error);
                            alert(`Failed to delete archive: ${error.message}`);
                        });
                }
            }
        }        // Refresh archives button handler
        if (refreshArchivesBtn) {
            refreshArchivesBtn.addEventListener('click', () => {
                if (!isArchivesLoading) {
                    showArchivesLoading();
                    loadArchives();
                }
            });
        }

        // Add event listeners for new jobs tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Setup sidebar toggle to match project-list behavior
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                });
            }

            // Search input event listener
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    // Implement search functionality here
                    console.log('Search:', this.value);
                    // For now, just trigger a re-render
                    renderJobs();
                });
            }            // Export button event listener
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportJobs);
            }            // Set minimum date for interview scheduling to today
            const interviewDateInput = document.getElementById('interviewDate');
            if (interviewDateInput) {
                const today = new Date().toISOString().split('T')[0];
                interviewDateInput.min = today;
            }            // Initialize interviewers display
            updateInterviewersDisplay();

            // Add keyboard event for interviewer selection (Enter key)
            const interviewerSelect = document.getElementById('interviewerSelect');
            if (interviewerSelect) {
                interviewerSelect.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addInterviewer();
                    }
                });
            }
        });

        // Schedule Interview Functions
        let currentScheduleApplicationId = null;
        let currentScheduleJobId = null;
        let currentScheduleApplicant = null;        function openScheduleModal(applicationId, jobId, applicant) {
            currentScheduleApplicationId = applicationId;
            currentScheduleJobId = jobId;
            currentScheduleApplicant = applicant;

            // Get job title from current job data
            const job = Object.values(jobsData).find(j => j.id === jobId);
            const jobTitle = job ? job.jobTitle : 'Unknown Position';

            // Populate applicant information
            document.getElementById('scheduleApplicantName').textContent = `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || 'N/A';
            document.getElementById('scheduleApplicantEmail').textContent = applicant.email || 'N/A';
            document.getElementById('scheduleJobTitle').textContent = jobTitle;

            // Check if interview has expired and show/hide evaluation button
            const evaluateBtn = document.getElementById('scheduleModalEvaluateBtn');
            if (applicant.interview && isInterviewExpired(applicant.interview.date, applicant.interview.time)) {
                evaluateBtn.style.display = 'inline-flex';
                // Set the onclick with the current data to avoid losing it when modal closes
                evaluateBtn.onclick = function() {
                    openEvaluationDirectly(applicationId, jobId, applicant);
                };
            } else {
                evaluateBtn.style.display = 'none';
            }

            // Clear form fields
            document.getElementById('interviewDate').value = '';
            document.getElementById('interviewTime').value = '';
            document.getElementById('interviewType').value = 'in-person';
            document.getElementById('interviewLocation').value = '';
            document.getElementById('interviewNotes').value = '';

            // Clear selected interviewers
            clearSelectedInterviewers();

            // Load users and populate interviewer dropdown
            loadUsersForInterviewer();

            // Load existing interviews for this applicant/job
            loadExistingInterviews();

            // Show modal
            document.getElementById('scheduleModal').style.display = 'flex';
        }function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
            currentScheduleApplicationId = null;
            currentScheduleJobId = null;
            currentScheduleApplicant = null;
            
            // Clean up real-time listener
            cleanupInterviewsListener();
            
            // Clean up editing state
            if (window.editingInterviewId) {
                delete window.editingInterviewId;
            }
        }

        function scheduleInterview() {
            if (!currentScheduleApplicationId || !currentScheduleJobId) {
                alert('Error: Invalid application or job data');
                return;
            }

            // Get company ID for company-scoped storage
            const companyId = getCompanyId();
            if (!companyId) {
                alert('Error: Company ID not found. Please ensure you are logged in properly.');
                return;
            }

            // Get form values
            const interviewDate = document.getElementById('interviewDate').value;
            const interviewTime = document.getElementById('interviewTime').value;
            const interviewType = document.getElementById('interviewType').value;
            const interviewLocation = document.getElementById('interviewLocation').value;
            const interviewNotes = document.getElementById('interviewNotes').value;

            // Validate required fields
            if (!interviewDate || !interviewTime) {
                alert('Please select both date and time for the interview');
                return;
            }

            if (selectedInterviewers.length === 0) {
                alert('Please add at least one interviewer');
                return;
            }

            // Get interviewer information
            const interviewerNames = getSelectedInterviewersString();
            const interviewerIds = getSelectedInterviewersIds();

            // Create interview object
            const interviewData = {
                date: interviewDate,
                time: interviewTime,
                type: interviewType,
                location: interviewLocation,
                interviewer: interviewerNames, // Display names of all interviewers
                interviewerIds: interviewerIds, // Store all IDs separately
                interviewers: selectedInterviewers, // Store complete interviewer objects
                notes: interviewNotes,
                scheduledAt: new Date().toISOString(),
                status: 'scheduled',
                companyId: companyId, // Add company ID for tracking
                applicantId: currentScheduleApplicationId,
                jobId: currentScheduleJobId,
                applicantName: currentScheduleApplicant.firstName + ' ' + currentScheduleApplicant.lastName,
                applicantEmail: currentScheduleApplicant.email,
                jobTitle: document.getElementById('scheduleJobTitle').textContent,
                createdBy: 'current_user' // You can get this from auth
            };

            // Generate interview ID
            const interviewId = window.editingInterviewId || database.ref().child(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}/interviews`).push().key;
            
            // Add interview ID to the data
            interviewData.id = interviewId;

            // Add update timestamp if editing
            if (window.editingInterviewId) {
                interviewData.updatedAt = new Date().toISOString();
            }

            // Company-scoped Firebase references - Store interview in applicant's record
            const applicationInterviewRef = database.ref(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}/interviews/${interviewId}`);
            const jobclosedInterviewRef = database.ref(`companies/${companyId}/jobclosed/${currentScheduleJobId}/applications/${currentScheduleApplicationId}/interviews/${interviewId}`);
            const applicationRef = database.ref(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}`);
            
            // Also update the legacy job applications path for backwards compatibility
            const legacyApplicationRef = database.ref(`jobs/${currentScheduleJobId}/applications/${currentScheduleApplicationId}`);
            const legacyInterviewRef = database.ref(`jobs/${currentScheduleJobId}/applications/${currentScheduleApplicationId}/interviews/${interviewId}`);

            // Use Firebase transaction to ensure all writes succeed
            Promise.all([
                // Store interview in applicant's record (main applications path)
                applicationInterviewRef.set(interviewData),
                // Store interview in jobclosed applications path
                jobclosedInterviewRef.set(interviewData),
                // Update application status to shortlisted when interview is scheduled
                applicationRef.update({
                    status: 'shortlisted',
                    lastInterviewScheduled: new Date().toISOString()
                }),
                // Update legacy application path for backwards compatibility
                legacyApplicationRef.update({
                    status: 'shortlisted',
                    lastInterviewScheduled: new Date().toISOString()
                }),
                // Store interview in legacy path
                legacyInterviewRef.set(interviewData)
            ])            .then(async () => {
                const action = window.editingInterviewId ? 'updated' : 'scheduled';
                console.log(`Interview ${action} successfully`);
                
                // Send email notifications to applicant and interviewers
                try {
                    if (window.emailNotificationService) {
                        console.log('Sending interview notification emails...');
                        const emailResult = await window.emailNotificationService.sendInterviewScheduleNotifications(
                            interviewData, // Use interviewData instead of interviewRecord
                            currentScheduleApplicant,
                            interviewData.jobTitle
                        );
                        
                        if (emailResult.success) {
                            console.log(`Email notifications sent: ${emailResult.totalSent} successful, ${emailResult.totalFailed} failed`);
                            alert(`Interview ${action} successfully!\n\nEmail notifications sent to:\n- Applicant: ${currentScheduleApplicant.email}\n- Interviewers: ${selectedInterviewers.map(i => i.email).join(', ')}`);
                        } else {
                            console.warn('Failed to send email notifications:', emailResult.message);
                            alert(`Interview ${action} successfully!\n\nWarning: Could not send email notifications - ${emailResult.message}`);
                        }
                    } else {
                        console.warn('Email notification service not available');
                        alert(`Interview ${action} successfully!\n\nNote: Email notification service is not available`);
                    }
                } catch (emailError) {
                    console.error('Error sending email notifications:', emailError);
                    alert(`Interview ${action} successfully!\n\nWarning: Failed to send email notifications - ${emailError.message}`);
                }
                
                closeScheduleModal();
                
                // Refresh the applicants table
                loadJobApplicants(currentScheduleJobId);
            })
            .catch((error) => {
                console.error('Error scheduling interview:', error);
                alert('Failed to schedule interview: ' + error.message);
            });
        }        function formatInterviewDate(date, time) {
            try {
                const interviewDate = new Date(date + 'T' + time);
                const now = new Date();
                const diffTime = interviewDate - now;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return `Today ${time}`;
                } else if (diffDays === 1) {
                    return `Tomorrow ${time}`;
                } else if (diffDays > 0) {
                    return `${interviewDate.toLocaleDateString()} ${time}`;
                } else {
                    return `${interviewDate.toLocaleDateString()} ${time}`;
                }
            } catch (error) {
                return `${date} ${time}`;
            }
        }

        // Helper function to check if interview date has expired
        function isInterviewExpired(date, time) {
            try {
                const interviewDate = new Date(date + 'T' + time);
                const now = new Date();
                return interviewDate < now;
            } catch (error) {
                return false;
            }
        }// Load users for interviewer dropdown
        function loadUsersForInterviewer() {
            const interviewerSelect = document.getElementById('interviewerSelect');
            if (!interviewerSelect) return;

            // Show loading state
            interviewerSelect.innerHTML = '<option value="">Loading interviewers...</option>';
            interviewerSelect.disabled = true;

            // Get company ID for company-scoped user loading
            const companyId = getCompanyId();
            console.log('?? Loading users for company:', companyId);

            // Define company-scoped and fallback user data paths
            const userDataPaths = [];
            
            // Prioritize company-scoped paths if companyId exists
            if (companyId) {
                userDataPaths.push(
                    `companies/${companyId}/users`,        // Company-specific users
                    `companies/${companyId}/staff`,        // Company-specific staff
                    `companies/${companyId}/employees`,    // Company-specific employees
                    `companies/${companyId}/members`,      // Company-specific members
                    `companies/${companyId}/team`          // Company-specific team
                );
            }
            
            // Add global fallback paths
            userDataPaths.push(
                'users',           // Global user collection
                'staff',           // Global staff collection
                'employees',       // Global employee collection
                'admins',          // Global admin collection
                'profiles'         // Global profile collection
            );

            let usersLoaded = false;            // Function to populate dropdown with users
            function populateUsersDropdown(users, source) {
                if (usersLoaded) return; // Prevent multiple populations
                
                const userEntries = Object.entries(users || {});
                if (userEntries.length === 0) return;

                // Filter users by company if we have a companyId and this is not a company-scoped path
                let filteredUsers = userEntries;
                if (companyId && !source.includes(`companies/${companyId}`)) {
                    // For global paths, filter by companyId field if available
                    filteredUsers = userEntries.filter(([userId, userData]) => {
                        return !userData.companyId || userData.companyId === companyId;
                    });
                    
                    // If no company-filtered users found in global path, use all users
                    if (filteredUsers.length === 0) {
                        filteredUsers = userEntries;
                    }
                }

                usersLoaded = true;
                const sourceType = source.includes(`companies/${companyId}`) ? 'company-scoped' : 'global';
                console.log(`? Loading users from ${sourceType} source (${source}):`, filteredUsers.length, 'users found');

                // Clear loading state and enable dropdown
                interviewerSelect.innerHTML = '<option value="">Select an interviewer...</option>';
                interviewerSelect.disabled = false;

                // Sort users alphabetically by display name
                filteredUsers.sort((a, b) => {
                    const nameA = getUserDisplayName(a[1]).toLowerCase();
                    const nameB = getUserDisplayName(b[1]).toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                filteredUsers.forEach(([userId, userData]) => {
                    const option = document.createElement('option');
                    option.value = userId;
                    
                    // Generate comprehensive display name with role and department
                    const displayName = getUserDisplayName(userData);
                    const roleInfo = getUserRoleInfo(userData);
                    const finalDisplayName = roleInfo ? `${displayName} ${roleInfo}` : displayName;
                    
                    option.textContent = finalDisplayName;
                    
                    // Store user data for later use
                    option.setAttribute('data-user-email', userData.email || '');
                    option.setAttribute('data-user-role', userData.role || userData.position || '');
                    option.setAttribute('data-user-department', userData.department || '');
                    
                    interviewerSelect.appendChild(option);
                });

                // Add "Other" option for external interviewers
                const otherOption = document.createElement('option');
                otherOption.value = 'other';
                otherOption.textContent = 'Other (External Interviewer)';
                interviewerSelect.appendChild(otherOption);
            }
            
            // Helper function to get user display name
            function getUserDisplayName(userData) {
                if (userData.firstName && userData.lastName) {
                    return `${userData.firstName} ${userData.lastName}`;
                } else if (userData.fullName) {
                    return userData.fullName;
                } else if (userData.name) {
                    return userData.name;
                } else if (userData.displayName) {
                    return userData.displayName;
                } else if (userData.email) {
                    return userData.email.split('@')[0]; // Use email username part
                } else {
                    return 'Unnamed User';
                }
            }
            
            // Helper function to get user role information
            function getUserRoleInfo(userData) {
                const role = userData.role || userData.position || userData.jobTitle;
                const department = userData.department || userData.division;
                
                if (role && department) {
                    return `(${role} - ${department})`;
                } else if (role) {
                    return `(${role})`;
                } else if (department) {
                    return `(${department})`;
                } else {
                    return '';
                }
            }

            // Try to load users from different paths (company-scoped first, then global)
            let pathIndex = 0;
            
            function tryNextPath() {
                if (usersLoaded || pathIndex >= userDataPaths.length) {
                    if (!usersLoaded) {
                        console.log('?? No users found in any path, adding default options');
                        addDefaultInterviewers();
                    }
                    return;
                }
                
                const path = userDataPaths[pathIndex];
                const isCompanyScoped = path.includes(`companies/${companyId}`);
                
                console.log(`?? Trying to load users from: ${path} (${isCompanyScoped ? 'company-scoped' : 'global'})`);
                
                database.ref(path).once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data && Object.keys(data).length > 0) {
                            console.log(`? Found ${Object.keys(data).length} users in ${path}`);
                            populateUsersDropdown(data, path);
                        } else {
                            console.log(`?? No users found in ${path}, trying next path...`);
                            pathIndex++;
                            tryNextPath();
                        }
                    })
                    .catch((error) => {
                        console.error(`? Error loading users from ${path}:`, error);
                        pathIndex++;
                        tryNextPath();
                    });
            }
            
            // Start loading from the first path
            tryNextPath();
        }        // Add default interviewers if no users found in database
        function addDefaultInterviewers() {
            const interviewerSelect = document.getElementById('interviewerSelect');
            
            // Clear loading state and enable dropdown
            interviewerSelect.innerHTML = '<option value="">Select an interviewer...</option>';
            interviewerSelect.disabled = false;
            
            const defaultInterviewers = [
                'HR Manager',
                'Department Head',
                'Team Lead',
                'Senior Manager',
                'Director',
                'External Consultant'
            ];

            defaultInterviewers.forEach(interviewer => {
                const option = document.createElement('option');
                option.value = interviewer;
                option.textContent = interviewer;
                interviewerSelect.appendChild(option);
            });

            // Add "Other" option
            const otherOption = document.createElement('option');
            otherOption.value = 'other';
            otherOption.textContent = 'Other (Specify in notes)';            interviewerSelect.appendChild(otherOption);
        }

        // Multi-Interviewer Management
        let selectedInterviewers = [];

        function addInterviewer() {
            const interviewerSelect = document.getElementById('interviewerSelect');
            const selectedValue = interviewerSelect.value;
            const selectedOption = interviewerSelect.options[interviewerSelect.selectedIndex];
            const selectedText = selectedOption.textContent;

            if (!selectedValue) {
                alert('Please select an interviewer first');
                return;
            }

            // Check if interviewer is already added
            if (selectedInterviewers.some(interviewer => interviewer.id === selectedValue)) {
                alert('This interviewer is already added');
                return;
            }

            // Extract enhanced user data from option attributes
            const userEmail = selectedOption.getAttribute('data-user-email') || '';
            const userRole = selectedOption.getAttribute('data-user-role') || '';
            const userDepartment = selectedOption.getAttribute('data-user-department') || '';

            // Add interviewer to the list with enhanced data
            const interviewer = {
                id: selectedValue,
                name: selectedText,
                email: userEmail,
                role: userRole,
                department: userDepartment,
                companyId: getCompanyId() // Store company association
            };
            
            console.log('? Adding interviewer:', interviewer);
            selectedInterviewers.push(interviewer);

            // Update display
            updateInterviewersDisplay();

            // Reset select
            interviewerSelect.value = '';
        }

        function removeInterviewer(interviewerId) {
            selectedInterviewers = selectedInterviewers.filter(interviewer => interviewer.id !== interviewerId);
            updateInterviewersDisplay();
        }

        function updateInterviewersDisplay() {
            const container = document.getElementById('selectedInterviewers');
            
            if (selectedInterviewers.length === 0) {
                container.innerHTML = '<div class="empty-interviewers-message">No interviewers selected. Please add at least one interviewer.</div>';
                return;
            }

            container.innerHTML = selectedInterviewers.map(interviewer => {
                // Create a detailed display with role and email if available
                let displayInfo = interviewer.name;
                const additionalInfo = [];
                
                if (interviewer.role) {
                    additionalInfo.push(interviewer.role);
                }
                if (interviewer.email) {
                    additionalInfo.push(interviewer.email);
                }
                
                if (additionalInfo.length > 0) {
                    displayInfo += `<br><small class="interviewer-details">${additionalInfo.join('  ')}</small>`;
                }
                
                return `
                    <div class="interviewer-tag" title="Company: ${interviewer.companyId || 'Unknown'}">
                        <div class="interviewer-info">
                            ${displayInfo}
                        </div>
                        <button type="button" class="remove-interviewer" onclick="removeInterviewer('${interviewer.id}')" title="Remove interviewer">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function clearSelectedInterviewers() {
            selectedInterviewers = [];
            updateInterviewersDisplay();
        }

        function getSelectedInterviewersString() {
            return selectedInterviewers.map(interviewer => interviewer.name).join(', ');
        }

        function getSelectedInterviewersIds() {            return selectedInterviewers.map(interviewer => interviewer.id);
        }

        // Real-time interview loading and display
        let interviewsListener = null;

        function loadExistingInterviews() {
            const existingInterviewsList = document.getElementById('existingInterviewsList');
            
            // Show loading state
            existingInterviewsList.innerHTML = `
                <div class="loading-interviews">
                    <i class="fas fa-spinner fa-spin"></i> Loading scheduled interviews...
                </div>
            `;

            // Remove previous listener if exists
            if (interviewsListener) {
                interviewsListener.off();
            }

            // Get company ID for company-scoped queries
            const companyId = getCompanyId();
            if (!companyId) {
                existingInterviewsList.innerHTML = `
                    <div class="no-existing-interviews">
                        <i class="fas fa-exclamation-triangle"></i> Company ID not found
                    </div>
                `;
                return;
            }

            // Set up real-time listener for interviews stored in applicant's record
            const applicantInterviewsRef = database.ref(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}/interviews`);
            interviewsListener = applicantInterviewsRef;
            
            interviewsListener.on('value', (snapshot) => {
                const interviews = snapshot.val();
                displayExistingInterviews(interviews);
            });
        }

        function displayExistingInterviews(interviews) {
            const existingInterviewsList = document.getElementById('existingInterviewsList');
            
            if (!interviews || Object.keys(interviews).length === 0) {
                existingInterviewsList.innerHTML = `
                    <div class="no-existing-interviews">
                        <i class="fas fa-calendar"></i> No interviews scheduled yet
                    </div>
                `;
                return;
            }

            // Sort interviews by date/time
            const sortedInterviews = Object.entries(interviews).sort((a, b) => {
                const dateA = new Date(a[1].date + 'T' + a[1].time);
                const dateB = new Date(b[1].date + 'T' + b[1].time);
                return dateA - dateB;
            });

            existingInterviewsList.innerHTML = sortedInterviews.map(([interviewId, interview]) => {
                const interviewDateTime = new Date(interview.date + 'T' + interview.time);
                const now = new Date();
                const isPast = interviewDateTime < now;
                const status = isPast ? 'completed' : interview.status || 'scheduled';
                
                return `
                    <div class="existing-interview-item">
                        <div class="interview-header">
                            <div class="interview-date-time">
                                ${formatInterviewDate(interview.date, interview.time)}
                            </div>
                            <span class="interview-status ${status}">
                                ${status.charAt(0).toUpperCase() + status.slice(1)}
                            </span>
                        </div>
                        <div class="interview-details">
                            <div class="interview-detail-row">
                                <span class="interview-detail-label">Type:</span>
                                <span>${interview.type || 'N/A'}</span>
                            </div>
                            <div class="interview-detail-row">
                                <span class="interview-detail-label">Interviewer:</span>
                                <span>${interview.interviewer || 'N/A'}</span>
                            </div>
                            <div class="interview-detail-row">
                                <span class="interview-detail-label">Location:</span>
                                <span>${interview.location || 'N/A'}</span>
                            </div>
                            ${interview.notes ? `
                                <div class="interview-detail-row">
                                    <span class="interview-detail-label">Notes:</span>
                                    <span>${interview.notes}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="interview-actions">
                            ${!isPast ? `
                                <button class="btn btn-sm btn-warning" onclick="editInterview('${interviewId}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelInterview('${interviewId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-info" onclick="viewInterviewDetails('${interviewId}')">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            `}
                        </div>
                    </div>                `;
            }).join('');
            
            // Update evaluation button visibility based on expired interviews
            updateEvaluationButtonState(sortedInterviews);
        }        // Function to update evaluation button state based on interview status
        function updateEvaluationButtonState(sortedInterviews) {
            const evaluateBtn = document.getElementById('scheduleModalEvaluateBtn');
            if (!evaluateBtn) return;

            // Check if any interview has expired (completed)
            const hasExpiredInterview = sortedInterviews.some(([interviewId, interview]) => {
                return isInterviewExpired(interview.date, interview.time);
            });

            // Show evaluation button if there's at least one expired interview
            if (hasExpiredInterview && currentScheduleApplicationId && currentScheduleJobId && currentScheduleApplicant) {
                evaluateBtn.style.display = 'inline-flex';
                // Update the onclick with the current data
                evaluateBtn.onclick = function() {
                    openEvaluationDirectly(currentScheduleApplicationId, currentScheduleJobId, currentScheduleApplicant);
                };
            } else {
                evaluateBtn.style.display = 'none';
            }
        }

        function editInterview(interviewId) {
            // Get company ID for company-scoped queries
            const companyId = getCompanyId();
            if (!companyId) {
                alert('Error: Company ID not found. Please ensure you are logged in properly.');
                return;
            }

            // Load interview data from applicant's record
            database.ref(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}/interviews/${interviewId}`).once('value', (snapshot) => {
                const interview = snapshot.val();
                if (interview) {
                    // Populate form with existing data
                    document.getElementById('interviewDate').value = interview.date;
                    document.getElementById('interviewTime').value = interview.time;
                    document.getElementById('interviewType').value = interview.type;
                    document.getElementById('interviewLocation').value = interview.location;
                    document.getElementById('interviewNotes').value = interview.notes || '';
                    
                    // Set up selected interviewers
                    selectedInterviewers = interview.interviewers || [];
                    updateInterviewersDisplay();
                    
                    // Store interview ID for updating instead of creating new
                    window.editingInterviewId = interviewId;
                } else {
                    alert('Interview not found or access denied.');
                }
            });
        }

        function cancelInterview(interviewId) {
            if (confirm('Are you sure you want to cancel this interview?')) {
                // Get company ID for company-scoped updates
                const companyId = getCompanyId();
                if (!companyId) {
                    alert('Error: Company ID not found. Please ensure you are logged in properly.');
                    return;
                }

                const cancelData = {
                    status: 'cancelled',
                    cancelledAt: new Date().toISOString()
                };

                // Update interview in all storage locations
                Promise.all([
                    // Update in applicant's record (main applications path)
                    database.ref(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}/interviews/${interviewId}`).update(cancelData),
                    // Update in jobclosed applications path
                    database.ref(`companies/${companyId}/jobclosed/${currentScheduleJobId}/applications/${currentScheduleApplicationId}/interviews/${interviewId}`).update(cancelData),
                    // Update legacy path
                    database.ref(`jobs/${currentScheduleJobId}/applications/${currentScheduleApplicationId}/interviews/${interviewId}`).update(cancelData)
                ])
                .then(() => {
                    alert('Interview cancelled successfully!');
                    // The real-time listener will automatically update the display
                })
                .catch((error) => {
                    console.error('Error cancelling interview:', error);
                    alert('Failed to cancel interview: ' + error.message);
                });
            }
        }

        function viewInterviewDetails(interviewId) {
            // Get company ID for company-scoped queries
            const companyId = getCompanyId();
            if (!companyId) {
                alert('Error: Company ID not found. Please ensure you are logged in properly.');
                return;
            }

            database.ref(`companies/${companyId}/applications/${currentScheduleJobId}/${currentScheduleApplicationId}/interviews/${interviewId}`).once('value', (snapshot) => {
                const interview = snapshot.val();
                if (interview) {
                    const details = `Interview Details:\n\n` +
                        `Date: ${new Date(interview.date).toLocaleDateString()}\n` +
                        `Time: ${interview.time}\n` +
                        `Type: ${interview.type}\n` +
                        `Interviewer(s): ${interview.interviewer}\n` +
                        `Location: ${interview.location || 'N/A'}\n` +
                        `Status: ${interview.status}\n` +
                        `Notes: ${interview.notes || 'No notes'}\n` +
                        `Scheduled: ${new Date(interview.scheduledAt).toLocaleString()}`;
                    
                    alert(details);
                    // TODO: Create a proper modal for detailed view
                } else {
                    alert('Interview not found or access denied.');
                }
            });
        }

        function cleanupInterviewsListener() {
            if (interviewsListener) {
                interviewsListener.off();
                interviewsListener = null;
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const scheduleModal = document.getElementById('scheduleModal');
            if (event.target === scheduleModal) {
                closeScheduleModal();
            }
        }        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const scheduleModal = document.getElementById('scheduleModal');
                const evaluationModal = document.getElementById('evaluationModal');
                const evaluationRankModal = document.getElementById('evaluationRankModal');
                
                if (scheduleModal.style.display === 'flex') {
                    closeScheduleModal();
                }
                if (evaluationModal.style.display === 'flex') {
                    closeEvaluationModal();
                }
                if (evaluationRankModal.style.display === 'flex') {
                    closeEvaluationRankModal();
                }
            }
        });

        // Evaluation Modal Functions
        let currentEvaluationApplicationId = null;
        let currentEvaluationJobId = null;
        let currentEvaluationApplicant = null;        function openEvaluationModal(applicationId, jobId, applicantData) {
            // If called from the table row, use the passed parameters
            if (applicationId && jobId && applicantData) {
                currentEvaluationApplicationId = applicationId;
                currentEvaluationJobId = jobId;
                currentEvaluationApplicant = applicantData;
            } else {
                // If called from the modal (original behavior)
                if (!currentModalApplicationId || !currentModalJobId) {
                    alert('Error: No applicant data available');
                    return;
                }
                currentEvaluationApplicationId = currentModalApplicationId;
                currentEvaluationJobId = currentModalJobId;
                currentEvaluationApplicant = getCurrentApplicantData();
            }

            // Get job title
            const job = Object.values(jobsData).find(j => j.id === currentEvaluationJobId);
            const jobTitle = job ? job.jobTitle : 'Unknown Position';

            // Use the applicant data from parameters or current modal
            const applicant = currentEvaluationApplicant;
            
            // Populate candidate information
            document.getElementById('evalCandidateName').textContent = `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || 'N/A';
            document.getElementById('evalPosition').textContent = jobTitle;
            
            // Get interview date
            if (applicant.interview) {
                document.getElementById('evalInterviewDate').textContent = formatInterviewDate(applicant.interview.date, applicant.interview.time);
            } else {
                document.getElementById('evalInterviewDate').textContent = 'Not scheduled';
            }            // Clear form
            clearEvaluationForm();

            // Set evaluator name to current logged-in user
            setCurrentUserAsEvaluator();

            // Show modal
            document.getElementById('evaluationModal').style.display = 'flex';
        }        function closeEvaluationModal() {
            document.getElementById('evaluationModal').style.display = 'none';
            currentEvaluationApplicationId = null;
            currentEvaluationJobId = null;
            currentEvaluationApplicant = null;
        }        // Function to open evaluation modal from schedule modal
        function openEvaluationFromScheduleModal() {
            console.log('Opening evaluation from schedule modal...');
            console.log('Current schedule data:', {
                applicationId: currentScheduleApplicationId,
                jobId: currentScheduleJobId,
                applicant: currentScheduleApplicant
            });

            if (!currentScheduleApplicationId || !currentScheduleJobId || !currentScheduleApplicant) {
                console.error('Missing schedule modal data');
                alert('Error: No applicant data available. Please close and reopen the schedule modal.');
                return;
            }

            // Store the data before closing the schedule modal
            const applicationId = currentScheduleApplicationId;
            const jobId = currentScheduleJobId;
            const applicantData = currentScheduleApplicant;

            console.log('Stored data for evaluation:', {
                applicationId,
                jobId,
                applicantData
            });

            // Close the schedule modal
            closeScheduleModal();

            // Open the evaluation modal with the stored data
            openEvaluationModal(applicationId, jobId, applicantData);
        }

        // Function to open evaluation modal directly with passed data
        function openEvaluationDirectly(applicationId, jobId, applicantData) {
            console.log('Opening evaluation directly with data:', {
                applicationId,
                jobId,
                applicantData
            });

            // Close the schedule modal first
            document.getElementById('scheduleModal').style.display = 'none';
            
            // Clean up real-time listener
            cleanupInterviewsListener();

            // Open the evaluation modal with the provided data
            openEvaluationModal(applicationId, jobId, applicantData);
        }        function clearEvaluationForm() {
            // Don't clear evaluator name - it should be set to current user
            // document.getElementById('evaluatorName').value = '';
            
            // Clear all star ratings
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('active');
            });
            
            // Clear all text areas
            document.querySelectorAll('.criteria-notes').forEach(textarea => {
                textarea.value = '';
            });
            
            // Clear overall comments and recommendation
            document.getElementById('overallComments').value = '';
            document.getElementById('recommendation').value = '';
        }        function setCurrentUserAsEvaluator() {
            const evaluatorNameField = document.getElementById('evaluatorName');
            if (!evaluatorNameField) return;

            // Use embedded AuthManager first
            if (window.authManager) {
                window.addEventListener('userReady', (event) => {
                    const userProfile = event.detail.profile;
                    const user = event.detail.user;
                    if (user && userProfile) {
                        const userName = userProfile.displayName || user.displayName || user.email || 'Current User';
                        evaluatorNameField.value = userName;
                        evaluatorNameField.readOnly = true;
                        evaluatorNameField.style.backgroundColor = '#f8f9fa';
                        evaluatorNameField.style.cursor = 'not-allowed';
                    }
                });
                
                // Also check if user is already ready
                if (window.authManager.isReady && window.authManager.currentUser) {
                    const user = window.authManager.currentUser;
                    const userProfile = window.authManager.userProfile;
                    const userName = userProfile?.displayName || user.displayName || user.email || 'Current User';
                    evaluatorNameField.value = userName;
                    evaluatorNameField.readOnly = true;
                    evaluatorNameField.style.backgroundColor = '#f8f9fa';
                    evaluatorNameField.style.cursor = 'not-allowed';
                }
            } else {
                // Fallback to direct Firebase Auth
                const firebase = initializeFirebase();
                const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        const userName = user.displayName || user.email || 'Current User';
                        evaluatorNameField.value = userName;
                        evaluatorNameField.readOnly = true;
                        evaluatorNameField.style.backgroundColor = '#f8f9fa';
                        evaluatorNameField.style.cursor = 'not-allowed';
                        unsubscribe();
                    } else {
                        evaluatorNameField.value = 'Please log in';
                        evaluatorNameField.readOnly = true;
                        evaluatorNameField.style.backgroundColor = '#ffe6e6';
                        evaluatorNameField.style.cursor = 'not-allowed';
                    }
                });
            }
        }

        function getCurrentApplicantData() {
            // Get current applicant data from the modal
            const job = Object.values(jobsData).find(j => j.id === currentModalJobId);
            if (job && job.applications && job.applications[currentModalApplicationId]) {
                return job.applications[currentModalApplicationId];
            }
            return {};
        }

        function submitEvaluation() {
            const evaluatorName = document.getElementById('evaluatorName').value;
            const overallComments = document.getElementById('overallComments').value;
            const recommendation = document.getElementById('recommendation').value;

            // Validate required fields
            if (!evaluatorName.trim()) {
                alert('Please enter your name as the evaluator');
                return;
            }

            if (!recommendation) {
                alert('Please select a recommendation');
                return;
            }

            // Collect ratings
            const ratings = {};
            const criteria = ['technical', 'communication', 'problem-solving', 'cultural-fit', 'experience'];
            
            criteria.forEach(criterion => {
                const ratingStars = document.querySelector(`[data-criteria="${criterion}"]`);
                const activeStars = ratingStars.querySelectorAll('.star.active');
                ratings[criterion] = activeStars.length;
            });

            // Collect comments
            const comments = {};
            const criteriaItems = document.querySelectorAll('.criteria-item');
            criteriaItems.forEach((item, index) => {
                const criterionName = criteria[index];
                const textarea = item.querySelector('.criteria-notes');
                comments[criterionName] = textarea.value;
            });

            // Calculate overall score
            const totalScore = Object.values(ratings).reduce((sum, rating) => sum + rating, 0);
            const averageScore = totalScore / criteria.length;

            // Create evaluation object
            const evaluationData = {
                evaluatorName: evaluatorName,
                evaluationDate: new Date().toISOString(),
                ratings: ratings,
                comments: comments,
                overallComments: overallComments,
                recommendation: recommendation,
                overallScore: Math.round(averageScore * 10) / 10, // Round to 1 decimal
                applicantId: currentEvaluationApplicationId,
                jobId: currentEvaluationJobId
            };            // Save evaluation to Firebase
            const companyId = getCompanyId();
            const savePromises = [];
            
            // Generate evaluation ID
            const evaluationId = database.ref().child('temp').push().key;
            
            // Add evaluation ID to the data
            evaluationData.id = evaluationId;
            
            console.log('?? Evaluation Storage Paths:');
            console.log('  Company Applications Path:', `companies/${companyId}/applications/${currentEvaluationJobId}/${currentEvaluationApplicationId}/evaluations/${evaluationId}`);
            console.log('  Company JobClosed Path:', `companies/${companyId}/jobclosed/${currentEvaluationJobId}/applications/${currentEvaluationApplicationId}/evaluations/${evaluationId}`);
            console.log('  Legacy Path:', `jobs/${currentEvaluationJobId}/applications/${currentEvaluationApplicationId}/evaluations/${evaluationId}`);
            console.log('  Evaluation Data:', evaluationData);
            
            // Legacy path
            const legacyEvaluationRef = database.ref(`jobs/${currentEvaluationJobId}/applications/${currentEvaluationApplicationId}/evaluations/${evaluationId}`);
            savePromises.push(legacyEvaluationRef.set(evaluationData));
            
            // Company-scoped path
            if (companyId) {
                const companyEvaluationRef = database.ref(`companies/${companyId}/applications/${currentEvaluationJobId}/${currentEvaluationApplicationId}/evaluations/${evaluationId}`);
                savePromises.push(companyEvaluationRef.set(evaluationData));
                
                // Also store in jobclosed path for candidate's record
                const jobclosedEvaluationRef = database.ref(`companies/${companyId}/jobclosed/${currentEvaluationJobId}/applications/${currentEvaluationApplicationId}/evaluations/${evaluationId}`);
                savePromises.push(jobclosedEvaluationRef.set(evaluationData));
            }
            
            Promise.all(savePromises)
                .then(() => {
                    console.log('Evaluation submitted successfully');
                    
                    // Update applicant status to "interviewed" after evaluation in all paths
                    const statusUpdatePromises = [];
                    
                    // Legacy path
                    const legacyStatusRef = database.ref(`jobs/${currentEvaluationJobId}/applications/${currentEvaluationApplicationId}/status`);
                    statusUpdatePromises.push(legacyStatusRef.set('interviewed'));
                    
                    // Company-scoped paths
                    if (companyId) {
                        const companyStatusRef = database.ref(`companies/${companyId}/applications/${currentEvaluationJobId}/${currentEvaluationApplicationId}/status`);
                        statusUpdatePromises.push(companyStatusRef.set('interviewed'));
                        
                        const jobclosedStatusRef = database.ref(`companies/${companyId}/jobclosed/${currentEvaluationJobId}/applications/${currentEvaluationApplicationId}/status`);
                        statusUpdatePromises.push(jobclosedStatusRef.set('interviewed'));
                    }
                    
                    return Promise.all(statusUpdatePromises);
                })                .then(() => {
                    console.log('Applicant status updated to interviewed');
                    alert('Evaluation submitted successfully!');
                    closeEvaluationModal();
                    
                    // Show option to send interview report
                    if (confirm('Evaluation submitted successfully!\n\nWould you like to send an interview report via email?')) {
                        showSendReportModal(evaluationData);
                    }
                    
                    // Refresh the applicant table to show updated information
                    if (currentEvaluationJobId) {
                        loadJobApplicants(currentEvaluationJobId);
                    }
                })
                .catch((error) => {
                    console.error('Error submitting evaluation:', error);
                    alert('Failed to submit evaluation: ' + error.message);
                });
        }

        function viewExistingEvaluations() {
            if (!currentModalApplicationId || !currentModalJobId) {
                alert('Error: No applicant data available');
                return;
            }

            const companyId = getCompanyId();
            
            // Function to process and display evaluations
            const processEvaluations = (evaluations) => {
                if (!evaluations || Object.keys(evaluations).length === 0) {
                    alert('No evaluations found for this candidate.');
                    return;
                }

                // Create a summary of evaluations
                let summary = 'Interview Evaluations:\n\n';
                Object.entries(evaluations).forEach(([evalId, evaluation]) => {
                    const evalDate = new Date(evaluation.evaluationDate).toLocaleDateString();
                    summary += `Evaluator: ${evaluation.evaluatorName}\n`;
                    summary += `Date: ${evalDate}\n`;
                    summary += `Overall Score: ${evaluation.overallScore}/5\n`;
                    summary += `Recommendation: ${evaluation.recommendation}\n`;
                    summary += `Comments: ${evaluation.overallComments || 'No comments'}\n\n`;
                });
                
                alert(summary);
                // Show evaluations in a better formatted way
                showEvaluationsDisplay(evaluations);
            };

            // Try company-scoped path first
            if (companyId) {
                const companyEvaluationRef = database.ref(`companies/${companyId}/applications/${currentModalJobId}/${currentModalApplicationId}/evaluations`);
                companyEvaluationRef.once('value')
                    .then((snapshot) => {
                        const evaluations = snapshot.val();
                        if (evaluations && Object.keys(evaluations).length > 0) {
                            processEvaluations(evaluations);
                        } else {
                            // Try jobclosed path
                            const jobclosedEvaluationRef = database.ref(`companies/${companyId}/jobclosed/${currentModalJobId}/applications/${currentModalApplicationId}/evaluations`);
                            jobclosedEvaluationRef.once('value')
                                .then((snapshot) => {
                                    const evaluations = snapshot.val();
                                    if (evaluations && Object.keys(evaluations).length > 0) {
                                        processEvaluations(evaluations);
                                    } else {
                                        // Fallback to legacy path
                                        const legacyEvaluationRef = database.ref(`jobs/${currentModalJobId}/applications/${currentModalApplicationId}/evaluations`);
                                        legacyEvaluationRef.once('value')
                                            .then((snapshot) => {
                                                const evaluations = snapshot.val();
                                                processEvaluations(evaluations);
                                            })
                                            .catch((error) => {
                                                console.error('Error loading evaluations:', error);
                                                alert('Error loading evaluations. Please try again.');
                                            });
                                    }
                                })
                                .catch((error) => {
                                    console.error('Error loading jobclosed evaluations:', error);
                                    // Fallback to legacy path
                                    const legacyEvaluationRef = database.ref(`jobs/${currentModalJobId}/applications/${currentModalApplicationId}/evaluations`);
                                    legacyEvaluationRef.once('value')
                                        .then((snapshot) => {
                                            const evaluations = snapshot.val();
                                            processEvaluations(evaluations);
                                        })
                                        .catch((error) => {
                                            console.error('Error loading evaluations:', error);
                                            alert('Error loading evaluations. Please try again.');
                                        });
                                });
                        }
                    })
                    .catch((error) => {
                        console.error('Error loading company evaluations:', error);
                        // Try jobclosed path
                        const jobclosedEvaluationRef = database.ref(`companies/${companyId}/jobclosed/${currentModalJobId}/applications/${currentModalApplicationId}/evaluations`);
                        jobclosedEvaluationRef.once('value')
                            .then((snapshot) => {
                                const evaluations = snapshot.val();
                                if (evaluations && Object.keys(evaluations).length > 0) {
                                    processEvaluations(evaluations);
                                } else {
                                    // Fallback to legacy path
                                    const legacyEvaluationRef = database.ref(`jobs/${currentModalJobId}/applications/${currentModalApplicationId}/evaluations`);
                                    legacyEvaluationRef.once('value')
                                        .then((snapshot) => {
                                            const evaluations = snapshot.val();
                                            processEvaluations(evaluations);
                                        })
                                        .catch((error) => {
                                            console.error('Error loading evaluations:', error);
                                            alert('Error loading evaluations. Please try again.');
                                        });
                                }
                            })
                            .catch((error) => {
                                console.error('Error loading evaluations:', error);
                                alert('Error loading evaluations. Please try again.');
                            });
                    });
            } else {
                // No company ID, use legacy path
                const evaluationRef = database.ref(`jobs/${currentModalJobId}/applications/${currentModalApplicationId}/evaluations`);
                evaluationRef.once('value')
                    .then((snapshot) => {
                        const evaluations = snapshot.val();
                        processEvaluations(evaluations);
                    })
                    .catch((error) => {
                        console.error('Error loading evaluations:', error);
                        alert('Error loading evaluations. Please try again.');
                    });
            }
        }

        function showEvaluationsDisplay(evaluations) {
            // Create a simple display of evaluations
            let content = '<div style="max-height: 400px; overflow-y: auto;">';
            content += '<h4 style="margin-bottom: 1rem; color: #2c3e50;">Interview Evaluations</h4>';
            
            Object.entries(evaluations).forEach(([evalId, evaluation]) => {
                const evalDate = new Date(evaluation.evaluationDate).toLocaleDateString();
                const scoreColor = evaluation.overallScore >= 4 ? '#28a745' : 
                                 evaluation.overallScore >= 3 ? '#ffc107' : '#dc3545';
                
                content += `
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #495057;">${evaluation.evaluatorName}</strong>
                            <span style="font-size: 0.9rem; color: #6c757d;">${evalDate}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <span style="color: ${scoreColor}; font-weight: 600; font-size: 1.1rem;">
                                ? ${evaluation.overallScore}/5
                            </span>
                            <span style="margin-left: 1rem; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; 
                                        background: ${evaluation.recommendation === 'strongly-recommend' || evaluation.recommendation === 'recommend' ? '#d4edda' : 
                                                     evaluation.recommendation === 'neutral' ? '#fff3cd' : '#f8d7da'};
                                        color: ${evaluation.recommendation === 'strongly-recommend' || evaluation.recommendation === 'recommend' ? '#155724' : 
                                                evaluation.recommendation === 'neutral' ? '#856404' : '#721c24'};">
                                ${evaluation.recommendation.replace('-', ' ').toUpperCase()}
                            </span>
                        </div>
                        ${evaluation.overallComments ? `<p style="margin: 0; color: #495057; font-style: italic;">"${evaluation.overallComments}"</p>` : ''}
                    </div>
                `;
            });
            
            content += '</div>';
            
            // Replace the alert with the formatted content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // For now, still use alert but with better formatting
            // In a full implementation, you'd create a proper modal
            console.log('Evaluations:', content);
        }

        // Star rating functionality
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('star')) {
                const star = event.target;
                const rating = parseInt(star.dataset.rating);
                const ratingGroup = star.parentElement;
                const stars = ratingGroup.querySelectorAll('.star');

                // Clear all stars
                stars.forEach(s => s.classList.remove('active'));

                // Activate stars up to the clicked one
                for (let i = 0; i < rating; i++) {
                    stars[i].classList.add('active');
                }
            }
        });

        // Update window click handler for evaluation modal
        window.onclick = function(event) {
            const scheduleModal = document.getElementById('scheduleModal');
            const evaluationModal = document.getElementById('evaluationModal');
              if (event.target === scheduleModal) {
                closeScheduleModal();
            }
            if (event.target === evaluationModal) {
                closeEvaluationModal();
            }
        }

        // Test function for interview email notifications (for debugging)
        async function testInterviewEmailNotification() {
            if (!window.emailNotificationService) {
                alert('Email notification service not available');
                return;
            }

            try {
                const testInterviewData = {
                    id: 'test-interview-' + Date.now(),
                    date: '2025-06-20',
                    time: '10:00',
                    type: 'In-person',
                    location: 'Conference Room A',
                    interviewers: [
                        { name: 'John Smith', email: 'john.smith@dreamexdatalab.com' },
                        { name: 'Jane Doe', email: 'jane.doe@dreamexdatalab.com' }
                    ],
                    jobId: 'test-job-id',
                    applicantId: 'test-applicant-id'
                };

                const testApplicantData = {
                    firstName: 'Test',
                    lastName: 'Applicant',
                    email: 'test.applicant@email.com',
                    phone: '+1-234-567-8900',
                    id: 'test-applicant-id'
                };

                const testJobTitle = 'Software Engineer';

                console.log('Sending test interview email notification...');
                const result = await window.emailNotificationService.sendInterviewScheduleNotifications(
                    testInterviewData,
                    testApplicantData,
                    testJobTitle
                );

                if (result.success) {
                    alert(`Test email sent successfully!\n\nTotal sent: ${result.totalSent}\nTotal failed: ${result.totalFailed}\n\nDetails: ${result.message}`);
                } else {
                    alert(`Test email failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Test email error:', error);
                alert(`Test email error: ${error.message}`);
            }
        }        // Make test function available globally for debugging
        window.testInterviewEmailNotification = testInterviewEmailNotification;        // Job Evaluation Ranking Modal Functions
        function showJobEvaluationRanking(jobId) {
            // Update modal title
            document.getElementById('rankModalTitle').textContent = 'Job Evaluation Rankings';
            
            // Show modal immediately
            document.getElementById('evaluationRankModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Show loading state
            const rankBody = document.getElementById('evaluationRankBody');
            rankBody.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading job evaluation rankings...</p>
                </div>
            `;
            
            // Load job evaluation rankings data
            loadJobEvaluationRankings(jobId);
        }

        function loadJobEvaluationRankings(jobId) {
            // Get job information
            const job = Object.values(jobsData).find(j => j.id === jobId);
            const jobTitle = job ? job.jobTitle || job.title : 'Unknown Position';
            
            const companyId = getCompanyId();
            
            // Function to process applications data
            const processApplicationsData = (applications) => {
                generateJobEvaluationRankingContent(jobId, jobTitle, applications);
            };
            
            // Try company-scoped path first
            if (companyId) {
                const companyApplicationsRef = database.ref(`companies/${companyId}/applications/${jobId}`);
                companyApplicationsRef.once('value', (snapshot) => {
                    const applications = snapshot.val();
                    if (applications && Object.keys(applications).length > 0) {
                        processApplicationsData(applications);
                    } else {
                        // Try jobclosed path
                        const jobclosedApplicationsRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/applications`);
                        jobclosedApplicationsRef.once('value', (snapshot) => {
                            const applications = snapshot.val();
                            if (applications && Object.keys(applications).length > 0) {
                                processApplicationsData(applications);
                            } else {
                                // Fallback to legacy path
                                const legacyApplicationsRef = database.ref(`jobs/${jobId}/applications`);
                                legacyApplicationsRef.once('value', (snapshot) => {
                                    const applications = snapshot.val() || {};
                                    processApplicationsData(applications);
                                });
                            }
                        });
                    }
                }).catch((error) => {
                    console.error('Error loading company applications:', error);
                    // Fallback to legacy path
                    const legacyApplicationsRef = database.ref(`jobs/${jobId}/applications`);
                    legacyApplicationsRef.once('value', (snapshot) => {
                        const applications = snapshot.val() || {};
                        processApplicationsData(applications);
                    });
                });
            } else {
                // No company ID, use legacy path
                const applicationsRef = database.ref(`jobs/${jobId}/applications`);
                applicationsRef.once('value', (snapshot) => {
                    const applications = snapshot.val() || {};
                    processApplicationsData(applications);
                });
            }
        }        function generateJobEvaluationRankingContent(jobId, jobTitle, applications) {
            const rankBody = document.getElementById('evaluationRankBody');
            
            // Store current job evaluation data for email functionality
            currentJobEvaluationData = {
                jobId,
                jobTitle,
                applications
            };

            // Show send summary button if there are evaluations
            const hasEvaluations = Object.values(applications).some(applicant => 
                applicant.evaluations && Object.keys(applicant.evaluations).length > 0
            );
            const sendButton = document.getElementById('sendJobSummaryBtn');
            if (sendButton) {
                sendButton.style.display = hasEvaluations ? 'inline-flex' : 'none';
            }
            
            // Process all applications and their evaluations
            const evaluatedApplicants = [];
            let totalApplicants = 0;
            
            Object.entries(applications).forEach(([applicationId, applicant]) => {
                totalApplicants++;
                
                if (applicant.evaluations && Object.keys(applicant.evaluations).length > 0) {
                    const evaluations = Object.values(applicant.evaluations);
                    const totalEvaluations = evaluations.length;
                    
                    // Calculate average scores
                    let totalOverallScore = 0;
                    const averageScores = {
                        technical: 0,
                        communication: 0,
                        'problem-solving': 0,
                        'cultural-fit': 0,
                        experience: 0
                    };
                    
                    const recommendationCounts = {
                        'strongly-recommend': 0,
                        'recommend': 0,
                        'neutral': 0,
                        'not-recommend': 0,
                        'strongly-not-recommend': 0
                    };
                    
                    evaluations.forEach(evaluation => {
                        totalOverallScore += evaluation.overallScore || 0;
                        
                        Object.keys(averageScores).forEach(criteria => {
                            averageScores[criteria] += evaluation.ratings[criteria] || 0;
                        });
                        
                        const recommendation = evaluation.recommendation;
                        if (recommendationCounts.hasOwnProperty(recommendation)) {
                            recommendationCounts[recommendation]++;
                        }
                    });
                    
                    const avgOverallScore = (totalOverallScore / totalEvaluations).toFixed(1);
                    Object.keys(averageScores).forEach(criteria => {
                        averageScores[criteria] = (averageScores[criteria] / totalEvaluations).toFixed(1);
                    });
                    
                    // Get most common recommendation
                    const mostCommonRecommendation = Object.entries(recommendationCounts)
                        .reduce((a, b) => recommendationCounts[a[0]] > recommendationCounts[b[0]] ? a : b)[0];
                    
                    evaluatedApplicants.push({
                        applicationId,
                        name: `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || 'Unknown',
                        email: applicant.email || 'N/A',
                        averageScore: parseFloat(avgOverallScore),
                        averageScores,
                        totalEvaluations,
                        mostCommonRecommendation,
                        status: applicant.status || 'pending',
                        appliedDate: applicant.appliedDate
                    });
                }
            });
            
            // Sort by average score (descending)
            evaluatedApplicants.sort((a, b) => b.averageScore - a.averageScore);
            
            if (evaluatedApplicants.length === 0) {
                rankBody.innerHTML = `
                    <div class="no-evaluations">
                        <i class="fas fa-clipboard-list"></i>
                        <h4>No Evaluations Yet</h4>
                        <p>No applicants for this job have been evaluated yet.</p>
                        <p style="margin-top: 1rem; color: #495057;">Start scheduling interviews and evaluating candidates to see rankings.</p>
                    </div>
                `;
                return;
            }

            rankBody.innerHTML = `
                <div class="applicant-summary">
                    <div class="applicant-header">
                        <div class="applicant-info">
                            <h4><i class="fas fa-briefcase"></i> ${jobTitle}</h4>
                            <p><i class="fas fa-users"></i> ${evaluatedApplicants.length} of ${totalApplicants} applicants evaluated</p>
                            <p><i class="fas fa-chart-bar"></i> Ranked by average evaluation scores</p>
                        </div>
                        <div class="overall-rank">
                            <div class="rank-badge rank-good">Job Rankings</div>
                            <div style="font-size: 1.5rem; color: #007bff;">
                                ${evaluatedApplicants.length} Evaluated
                            </div>
                            <div style="color: #6c757d; font-size: 0.9rem;">
                                of ${totalApplicants} total applicants
                            </div>
                        </div>
                    </div>
                </div>

                <div class="job-rankings-section">
                    <h5><i class="fas fa-trophy"></i> Applicant Rankings</h5>
                    <div class="rankings-table">
                        <div class="rankings-header">
                            <div class="rank-col">Rank</div>
                            <div class="name-col">Applicant</div>
                            <div class="score-col">Avg Score</div>
                            <div class="recommendation-col">Recommendation</div>
                            <div class="evaluations-col">Evaluations</div>
                            <div class="status-col">Status</div>
                            <div class="actions-col">Actions</div>
                        </div>
                        ${evaluatedApplicants.map((applicant, index) => {
                            const rank = index + 1;
                            let rankClass = 'rank-average';
                            if (applicant.averageScore >= 4.5) rankClass = 'rank-excellent';
                            else if (applicant.averageScore >= 4.0) rankClass = 'rank-good';
                            else if (applicant.averageScore >= 3.0) rankClass = 'rank-average';
                            else if (applicant.averageScore >= 2.0) rankClass = 'rank-below-average';
                            else rankClass = 'rank-poor';
                            
                            return `
                                <div class="ranking-row">
                                    <div class="rank-col">
                                        <div class="rank-number ${rank <= 3 ? 'top-rank' : ''}">#${rank}</div>
                                    </div>
                                    <div class="name-col">
                                        <div class="applicant-name-cell">
                                            <strong>${applicant.name}</strong>
                                            <small>${applicant.email}</small>
                                        </div>
                                    </div>
                                    <div class="score-col">
                                        <div class="score-display ${rankClass}">
                                            ${applicant.averageScore}/5
                                        </div>
                                    </div>
                                    <div class="recommendation-col">
                                        <span class="recommendation ${getRecommendationClass(applicant.mostCommonRecommendation)}">
                                            ${formatRecommendation(applicant.mostCommonRecommendation)}
                                        </span>
                                    </div>
                                    <div class="evaluations-col">
                                        <span class="evaluation-count">${applicant.totalEvaluations} evaluator${applicant.totalEvaluations > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="status-col">
                                        <span class="status-badge status-${applicant.status}">${formatApplicationStatus(applicant.status)}</span>
                                    </div>
                                    <div class="actions-col">
                                        <button class="btn btn-sm btn-primary" onclick="showApplicantEvaluationDetails('${applicant.applicationId}', '${jobId}', '${applicant.name}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="job-statistics">
                    <h5><i class="fas fa-chart-pie"></i> Job Statistics</h5>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${evaluatedApplicants.filter(a => a.averageScore >= 4.0).length}</div>
                            <div class="stat-label">High Performers (4.0+)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${(evaluatedApplicants.reduce((sum, a) => sum + a.averageScore, 0) / evaluatedApplicants.length).toFixed(1)}</div>
                            <div class="stat-label">Overall Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${evaluatedApplicants.filter(a => ['strongly-recommend', 'recommend'].includes(a.mostCommonRecommendation)).length}</div>
                            <div class="stat-label">Recommended Candidates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round((evaluatedApplicants.length / totalApplicants) * 100)}%</div>
                            <div class="stat-label">Evaluation Progress</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showApplicantEvaluationDetails(applicationId, jobId, applicantName) {
            // This will open the detailed evaluation modal for a specific applicant
            const applicationsRef = database.ref(`jobs/${jobId}/applications/${applicationId}`);
            applicationsRef.once('value', (snapshot) => {
                const applicantData = snapshot.val();
                if (applicantData) {
                    // Close the job rankings modal first
                    closeEvaluationRankModal();
                      // Show the individual applicant evaluation details modal
                    setTimeout(() => {
                        viewApplicantEvaluations(applicationId);
                    }, 300);
                }
            });
        }        // Evaluation Rank Modal Functions (for individual applicants)
        function showApplicantEvaluationRank(applicationId, jobId, applicantData) {
            // Update modal title
            document.getElementById('rankModalTitle').textContent = 'Applicant Evaluation Rank';
            
            // Show modal immediately
            document.getElementById('evaluationRankModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Show loading state
            const rankBody = document.getElementById('evaluationRankBody');
            rankBody.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading evaluation data...</p>
                </div>
            `;
            
            // Load evaluation data
            loadEvaluationRankData(applicationId, jobId, applicantData);
        }

        function loadEvaluationRankData(applicationId, jobId, applicantData) {
            // Get job information
            const job = Object.values(jobsData).find(j => j.id === jobId);
            const jobTitle = job ? job.jobTitle || job.title : 'Unknown Position';
            
            const companyId = getCompanyId();
            
            // Function to process evaluations once loaded
            const processEvaluationsData = (evaluations) => {
                // Also load all other applicants' evaluations for comparison
                const allApplicationsRef = database.ref(`jobs/${jobId}/applications`);
                allApplicationsRef.once('value', (allSnapshot) => {
                    const allApplications = allSnapshot.val() || {};
                    generateEvaluationRankContent(applicationId, jobId, applicantData, jobTitle, evaluations, allApplications);
                });
            };
            
            // Try company-scoped path first
            if (companyId) {
                const companyEvaluationsRef = database.ref(`companies/${companyId}/applications/${jobId}/${applicationId}/evaluations`);
                companyEvaluationsRef.once('value', (snapshot) => {
                    const evaluations = snapshot.val();
                    if (evaluations && Object.keys(evaluations).length > 0) {
                        processEvaluationsData(evaluations);
                    } else {
                        // Try jobclosed path
                        const jobclosedEvaluationsRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/applications/${applicationId}/evaluations`);
                        jobclosedEvaluationsRef.once('value', (snapshot) => {
                            const evaluations = snapshot.val();
                            if (evaluations && Object.keys(evaluations).length > 0) {
                                processEvaluationsData(evaluations);
                            } else {
                                // Fallback to legacy path
                                const legacyEvaluationsRef = database.ref(`jobs/${jobId}/applications/${applicationId}/evaluations`);
                                legacyEvaluationsRef.once('value', (snapshot) => {
                                    const evaluations = snapshot.val() || {};
                                    processEvaluationsData(evaluations);
                                });
                            }
                        });
                    }
                }).catch((error) => {
                    console.error('Error loading company evaluations:', error);
                    // Fallback to legacy path
                    const legacyEvaluationsRef = database.ref(`jobs/${jobId}/applications/${applicationId}/evaluations`);
                    legacyEvaluationsRef.once('value', (snapshot) => {
                        const evaluations = snapshot.val() || {};
                        processEvaluationsData(evaluations);
                    });
                });
            } else {
                // No company ID, use legacy path
                const evaluationsRef = database.ref(`jobs/${jobId}/applications/${applicationId}/evaluations`);
                evaluationsRef.once('value', (snapshot) => {
                    const evaluations = snapshot.val() || {};
                    processEvaluationsData(evaluations);
                });
            }
        }

        function generateEvaluationRankContent(applicationId, jobId, applicantData, jobTitle, evaluations, allApplications) {
            const rankBody = document.getElementById('evaluationRankBody');
            
            if (Object.keys(evaluations).length === 0) {
                rankBody.innerHTML = `
                    <div class="no-evaluations">
                        <i class="fas fa-clipboard-list"></i>
                        <h4>No Evaluations Yet</h4>
                        <p>This applicant hasn't been evaluated yet.</p>
                        <p style="margin-top: 1rem; color: #495057;">Schedule and complete an interview to start the evaluation process.</p>
                    </div>
                `;
                return;
            }

            // Calculate applicant's average scores
            const evaluationArray = Object.values(evaluations);
            const totalEvaluations = evaluationArray.length;
            
            let totalOverallScore = 0;
            const averageScores = {
                technical: 0,
                communication: 0,
                'problem-solving': 0,
                'cultural-fit': 0,
                experience: 0
            };
            
            const recommendationCounts = {
                'strongly-recommend': 0,
                'recommend': 0,
                'neutral': 0,
                'not-recommend': 0,
                'strongly-not-recommend': 0
            };

            // Calculate this applicant's averages
            evaluationArray.forEach(evaluation => {
                totalOverallScore += evaluation.overallScore || 0;
                
                Object.keys(averageScores).forEach(criteria => {
                    averageScores[criteria] += evaluation.ratings[criteria] || 0;
                });
                
                const recommendation = evaluation.recommendation;
                if (recommendationCounts.hasOwnProperty(recommendation)) {
                    recommendationCounts[recommendation]++;
                }
            });

            const applicantAverage = (totalOverallScore / totalEvaluations).toFixed(1);
            Object.keys(averageScores).forEach(criteria => {
                averageScores[criteria] = (averageScores[criteria] / totalEvaluations).toFixed(1);
            });

            // Calculate ranking among all applicants
            const allAverages = [];
            Object.entries(allApplications).forEach(([appId, application]) => {
                if (application.evaluations) {
                    const appEvaluations = Object.values(application.evaluations);
                    if (appEvaluations.length > 0) {
                        const avgScore = appEvaluations.reduce((sum, evaluation) => sum + (evaluation.overallScore || 0), 0) / appEvaluations.length;
                        allAverages.push({
                            applicationId: appId,
                            average: avgScore,
                            name: `${application.firstName || ''} ${application.lastName || ''}`.trim()
                        });
                    }
                }
            });

            // Sort by average score (descending)
            allAverages.sort((a, b) => b.average - a.average);
            
            // Find current applicant's rank
            const currentRank = allAverages.findIndex(app => app.applicationId === applicationId) + 1;
            const totalEvaluatedApplicants = allAverages.length;

            // Determine rank category
            let rankClass = 'rank-average';
            let rankText = 'Average';
            if (applicantAverage >= 4.5) {
                rankClass = 'rank-excellent';
                rankText = 'Excellent';
            } else if (applicantAverage >= 4.0) {
                rankClass = 'rank-good';
                rankText = 'Good';
            } else if (applicantAverage >= 3.0) {
                rankClass = 'rank-average';
                rankText = 'Average';
            } else if (applicantAverage >= 2.0) {
                rankClass = 'rank-below-average';
                rankText = 'Below Average';
            } else {
                rankClass = 'rank-poor';
                rankText = 'Poor';
            }

            // Get most common recommendation
            const mostCommonRecommendation = Object.entries(recommendationCounts)
                .reduce((a, b) => recommendationCounts[a[0]] > recommendationCounts[b[0]] ? a : b)[0];            // Generate notes from evaluations
            const notes = evaluationArray.filter(evaluation => evaluation.overallComments).map(evaluation => {
                return {
                    evaluator: evaluation.evaluatorName,
                    date: new Date(evaluation.evaluationDate).toLocaleDateString(),
                    content: evaluation.overallComments
                };
            });

            rankBody.innerHTML = `
                <div class="applicant-summary">
                    <div class="applicant-header">
                        <div class="applicant-info">
                            <h4>${applicantData.firstName || ''} ${applicantData.lastName || ''}</h4>
                            <p><i class="fas fa-briefcase"></i> ${jobTitle}</p>
                            <p><i class="fas fa-envelope"></i> ${applicantData.email || 'N/A'}</p>
                        </div>
                        <div class="overall-rank">
                            <div class="rank-badge ${rankClass}">${rankText}</div>
                            <div style="font-size: 2rem; font-weight: bold; color: #007bff;">${applicantAverage}/5</div>
                            <div style="color: #6c757d; font-size: 0.9rem;">
                                Rank ${currentRank} of ${totalEvaluatedApplicants} evaluated
                            </div>
                        </div>
                    </div>
                </div>

                <div class="evaluation-metrics">
                    <div class="metrics-section">
                        <h5><i class="fas fa-chart-bar"></i> Performance Metrics</h5>
                        <div class="metric-item">
                            <span class="metric-label">Overall Average</span>
                            <span class="metric-value">${applicantAverage}/5</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Technical Skills</span>
                            <span class="metric-value">${averageScores.technical}/5</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Communication</span>
                            <span class="metric-value">${averageScores.communication}/5</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Problem Solving</span>
                            <span class="metric-value">${averageScores['problem-solving']}/5</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Cultural Fit</span>
                            <span class="metric-value">${averageScores['cultural-fit']}/5</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Experience</span>
                            <span class="metric-value">${averageScores.experience}/5</span>
                        </div>
                    </div>

                    <div class="metrics-section">
                        <h5><i class="fas fa-users"></i> Evaluation Summary</h5>
                        <div class="metric-item">
                            <span class="metric-label">Total Evaluators</span>
                            <span class="metric-value">${totalEvaluations}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Ranking Position</span>
                            <span class="metric-value">#${currentRank}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Performance Level</span>
                            <span class="metric-value">${rankText}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Most Common Recommendation</span>
                            <span class="metric-value recommendation ${getRecommendationClass(mostCommonRecommendation)}" style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                ${formatRecommendation(mostCommonRecommendation)}
                            </span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Compared to Others</span>
                            <span class="metric-value">
                                ${currentRank <= Math.ceil(totalEvaluatedApplicants * 0.25) ? 'Top 25%' : 
                                  currentRank <= Math.ceil(totalEvaluatedApplicants * 0.5) ? 'Top 50%' : 
                                  currentRank <= Math.ceil(totalEvaluatedApplicants * 0.75) ? 'Top 75%' : 'Bottom 25%'}
                            </span>
                        </div>
                    </div>
                </div>

                ${notes.length > 0 ? `
                    <div class="notes-section">
                        <h5><i class="fas fa-sticky-note"></i> Evaluator Notes</h5>
                        ${notes.map(note => `
                            <div class="note-item">
                                <div class="note-header">
                                    <span class="note-evaluator">${note.evaluator}</span>
                                    <span class="note-date">${note.date}</span>
                                </div>
                                <div class="note-content">${note.content}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        function closeEvaluationRankModal() {
            document.getElementById('evaluationRankModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Add click outside to close functionality for evaluation rank modal
        document.getElementById('evaluationRankModal').onclick = function(event) {
            if (event.target === this) {
                closeEvaluationRankModal();
            }        };

        // Global variable to store current job evaluation data for email functionality
        let currentJobEvaluationData = null;

        // Email functionality for sending evaluation summaries
        async function sendEvaluationSummaryEmail(applicationId, jobId, applicantData, event) {
            try {
                // Show loading indicator
                let button = null;
                let originalHTML = '';
                
                if (event && event.target) {
                    button = event.target.closest('.btn-mail');
                    if (button) {
                        originalHTML = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        button.disabled = true;
                    }
                }

                // Get evaluation data from company-scoped paths first
                const companyId = getCompanyId();
                let evaluations = null;
                
                if (companyId) {
                    // Try company applications path
                    const companyEvaluationsRef = database.ref(`companies/${companyId}/applications/${jobId}/${applicationId}/evaluations`);
                    const companySnapshot = await companyEvaluationsRef.once('value');
                    evaluations = companySnapshot.val();
                    
                    // If not found, try jobclosed path
                    if (!evaluations || Object.keys(evaluations).length === 0) {
                        const jobclosedEvaluationsRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/applications/${applicationId}/evaluations`);
                        const jobclosedSnapshot = await jobclosedEvaluationsRef.once('value');
                        evaluations = jobclosedSnapshot.val();
                    }
                }
                
                // Fallback to legacy path if no company data found
                if (!evaluations || Object.keys(evaluations).length === 0) {
                    const legacyEvaluationsRef = database.ref(`jobs/${jobId}/applications/${applicationId}/evaluations`);
                    const legacySnapshot = await legacyEvaluationsRef.once('value');
                    evaluations = legacySnapshot.val();
                }

                if (!evaluations || Object.keys(evaluations).length === 0) {
                    alert('No evaluations found for this candidate.');
                    return;
                }

                // Get job information
                const job = Object.values(jobsData).find(j => j.id === jobId);
                const jobTitle = job ? job.jobTitle || job.title : 'Unknown Position';

                // Generate evaluation summary
                const summary = generateEvaluationSummary(evaluations, applicantData, jobTitle);                // Get evaluator emails from evaluations
                const evaluatorEmails = getEvaluatorEmails(evaluations);
                const finalRecipients = evaluatorEmails.length > 0 ? evaluatorEmails : ['info@dreamexdatalab.com'];

                if (evaluatorEmails.length === 0) {
                    alert('No evaluator emails found. Using default HR recipients.');
                }                // Send email using SMTP with server availability check
                await sendEmailWithFallback(sendEmailViaSMTP, finalRecipients, summary, applicantData, jobTitle);

                // Show detailed success message with recipient list
                const recipientList = finalRecipients.join('\n ');
                alert(`? Evaluation summary sent successfully!\n\n?? Recipients (${finalRecipients.length}):\n ${recipientList}\n\n?? Summary: Individual candidate evaluation report\n?? From: info@dreamexdatalab.com`);

            } catch (error) {
                console.error('Error sending evaluation summary:', error);
                alert('Failed to send evaluation summary: ' + error.message);
            } finally {
                // Restore button state
                if (button && originalHTML) {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            }
        }

        function generateEvaluationSummary(evaluations, applicantData, jobTitle) {
            const evaluationArray = Object.values(evaluations);
            const totalEvaluations = evaluationArray.length;

            // Calculate averages
            const averageScores = {
                technical: 0,
                communication: 0,
                'problem-solving': 0,
                'cultural-fit': 0,
                experience: 0
            };

            let totalOverallScore = 0;
            const recommendationCounts = {
                'strongly-recommend': 0,
                'recommend': 0,
                'neutral': 0,
                'not-recommend': 0,
                'strongly-not-recommend': 0
            };

            // Calculate totals
            evaluationArray.forEach(evaluation => {
                totalOverallScore += evaluation.overallScore || 0;
                
                Object.keys(averageScores).forEach(criteria => {
                    averageScores[criteria] += evaluation.ratings[criteria] || 0;
                });
                
                const recommendation = evaluation.recommendation;
                if (recommendationCounts.hasOwnProperty(recommendation)) {
                    recommendationCounts[recommendation]++;
                }
            });

            // Calculate averages
            const averageOverallScore = (totalOverallScore / totalEvaluations).toFixed(1);
            Object.keys(averageScores).forEach(criteria => {
                averageScores[criteria] = (averageScores[criteria] / totalEvaluations).toFixed(1);
            });

            // Generate summary text
            const candidateName = `${applicantData.firstName || ''} ${applicantData.lastName || ''}`.trim();
            
            let summary = `
INTERVIEW EVALUATION SUMMARY
============================

Candidate: ${candidateName}
Position: ${jobTitle}
Total Evaluations: ${totalEvaluations}
Date: ${new Date().toLocaleDateString()}

AVERAGE SCORES (out of 5):
- Technical Skills: ${averageScores.technical}
- Communication: ${averageScores.communication}
- Problem Solving: ${averageScores['problem-solving']}
- Cultural Fit: ${averageScores['cultural-fit']}
- Experience: ${averageScores.experience}

Overall Average Score: ${averageOverallScore}/5

RECOMMENDATIONS:
`;

            Object.entries(recommendationCounts).forEach(([rec, count]) => {
                if (count > 0) {
                    const label = rec.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    summary += `- ${label}: ${count}\n`;
                }
            });

            summary += `\nDETAILED EVALUATIONS:\n`;
            summary += `=====================\n\n`;

            evaluationArray.forEach((evaluation, index) => {
                const evalDate = new Date(evaluation.evaluationDate).toLocaleDateString();
                summary += `Evaluation ${index + 1} (${evalDate})\n`;
                summary += `Evaluator: ${evaluation.evaluatorName}\n`;
                summary += `Overall Score: ${evaluation.overallScore}/5\n`;
                summary += `Recommendation: ${evaluation.recommendation.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}\n`;
                
                if (evaluation.comments) {
                    summary += `Comments: ${evaluation.comments}\n`;
                }
                
                summary += `\nDetailed Ratings:\n`;
                Object.entries(evaluation.ratings).forEach(([criteria, score]) => {
                    const label = criteria.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    summary += `  ${label}: ${score}/5\n`;
                });
                summary += `\n`;
            });

            return summary;
        }

        function getEvaluatorEmails(evaluations) {
            const emails = new Set();
            
            // Try to get emails from evaluation data
            Object.values(evaluations).forEach(evaluation => {
                if (evaluation.evaluatorEmail) {
                    emails.add(evaluation.evaluatorEmail);
                }
            });

            // If no emails found in evaluations, use current user's email as fallback
            const firebase = initializeFirebase();
            if (emails.size === 0 && firebase.auth().currentUser?.email) {
                emails.add(firebase.auth().currentUser.email);
            }

            // Add HR and management emails as default recipients
            if (emails.size === 0) {
                emails.add('info@dreamexdatalab.com');
                emails.add('hr@dreamexdatalab.com');
            }            return Array.from(emails);
        }        // Function to check email server health
        async function checkEmailServerHealth() {
            try {
                console.log('?? Checking email server health at localhost:3001...');
                const response = await fetch('http://localhost:3001/health', {
                    method: 'GET',
                    headers: {
                        'X-API-Key': 'dreemex_hse_email_service_2025'
                    }
                });
                
                if (response.ok) {
                    const healthData = await response.json();
                    console.log('? Email server is healthy:', healthData);
                    return true;
                } else {
                    console.error('? Email server health check failed:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('? Email server health check failed:', error);
                return false;
            }
        }        // Function to send email with fallback and error handling
        async function sendEmailWithFallback(emailFunction, recipients, ...args) {
            try {
                // Check if email server is available
                console.log('?? Checking email server availability...');
                const serverHealthy = await checkEmailServerHealth();
                if (!serverHealthy) {
                    throw new Error(`Email server is currently unavailable. 

Troubleshooting steps:
1. Check if the email server is running: 
   - Open terminal in email-service folder
   - Run: npm start
   - Server should start on localhost:3001

2. Verify network connectivity to localhost:3001

3. Check email server logs for errors

4. Contact IT support if the issue persists.

Technical details: Server health check failed.`);
                }

                // Attempt to send email
                console.log('?? Email server is healthy, attempting to send email...');
                return await emailFunction(recipients, ...args);
            } catch (error) {
                console.error('? Email sending failed:', error);
                
                // Provide user-friendly error message with troubleshooting steps
                const errorMessage = error.message.includes('server') || error.message.includes('fetch') ? 
                    `?? Email Delivery Failed

?? Troubleshooting Guide:

1. ? START EMAIL SERVER:
    Open PowerShell/Terminal
    Navigate to: email-service folder
    Run: npm start
    Verify: "Email service running on port 3001"

2. ? CHECK CONNECTION:
    Open: test-email-connection.html
    Click: "Test Server Connection"
    Should show: "Email server is running successfully"

3. ? VERIFY SMTP SETTINGS:
    Check .env file in email-service folder
    Verify SMTP credentials are correct
    Ensure mail.privateemail.com is accessible

4. ?? CONTACT SUPPORT:
    If all above steps pass but still failing
    Send screenshot of error to IT team

Technical Error: ${error.message}` :
                    `Failed to send email: ${error.message}`;
                
                throw new Error(errorMessage);
            }
        }

        // Function to send templated job evaluation email
        async function sendTemplatedJobEvaluationEmail(recipients, subject, content, processedData) {
            const emailData = {
                to: recipients.join(', '),
                subject: subject,
                body: content,
                type: 'job-evaluation-summary',
                metadata: {
                    jobTitle: processedData.jobPosition || 'Unknown Position',
                    totalCandidates: processedData.totalCandidates || 0,
                    evaluationType: 'job-level',
                    timestamp: new Date().toISOString()
                }
            };

            try {
                console.log('?? Sending job evaluation email via Dreamex Datalab SMTP server...');
                console.log('?? To:', recipients);
                console.log('?? Subject:', subject);
                
                const response = await fetch('http://localhost:3001/send/recruitment-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dreemex_hse_email_service_2025'
                    },
                    body: JSON.stringify(emailData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Email server error: ${response.status} - ${errorData.message || 'Unknown error'}`);
                }

                const result = await response.json();
                console.log('? Job evaluation email sent successfully via Dreamex Datalab SMTP system');
                console.log('?? Message ID:', result.messageId);
                
                return {
                    message: 'Job evaluation email sent successfully via Dreamex Datalab SMTP',
                    recipients: recipients,
                    messageId: result.messageId,
                    smtp: 'mail.privateemail.com',
                    from: 'info@dreamexdatalab.com'
                };
                
            } catch (error) {
                console.error('? Failed to send job evaluation email via SMTP server:', error);
                throw new Error(`Failed to send job evaluation email: ${error.message}`);            }
        }

        // Function to process job evaluation data for template variables
        function processJobEvaluationDataForTemplate(jobData) {
            const { jobTitle, applications } = jobData;
            const totalCandidates = Object.keys(applications).length;
            
            // Calculate evaluation statistics
            const evaluatedApplicants = [];
            let totalEvaluations = 0;
            const evaluators = new Set();

            Object.entries(applications).forEach(([appId, applicant]) => {
                if (applicant.evaluations && Object.keys(applicant.evaluations).length > 0) {
                    const evaluations = Object.values(applicant.evaluations);
                    totalEvaluations += evaluations.length;
                    
                    evaluations.forEach(evaluation => {
                        if (evaluation.evaluatorEmail) {
                            evaluators.add(evaluation.evaluatorEmail);
                        }
                    });
                    
                    let avgScore = 0;
                    evaluations.forEach(evaluation => avgScore += evaluation.overallScore || 0);
                    avgScore = (avgScore / evaluations.length);
                    
                    evaluatedApplicants.push({
                        name: `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim(),
                        avgScore: avgScore,
                        evaluationCount: evaluations.length,
                        applicant: applicant
                    });
                }
            });

            // Sort by average score (highest first)
            evaluatedApplicants.sort((a, b) => b.avgScore - a.avgScore);
            
            // Calculate overall average
            const overallAverage = evaluatedApplicants.length > 0 ? 
                (evaluatedApplicants.reduce((sum, app) => sum + app.avgScore, 0) / evaluatedApplicants.length).toFixed(1) : '0.0';

            // Generate candidate rankings
            let candidateRankings = '';
            evaluatedApplicants.forEach((applicant, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? '??' : rank === 2 ? '??' : rank === 3 ? '??' : '??';
                candidateRankings += `${medal} ${rank}. ${applicant.name}\n`;
                candidateRankings += `   Average Score: ${applicant.avgScore.toFixed(1)}/5\n`;
                candidateRankings += `   Evaluations: ${applicant.evaluationCount}\n\n`;
            });

            // Generate evaluation details
            let evaluationDetails = '';
            evaluatedApplicants.forEach(applicant => {
                evaluationDetails += `CANDIDATE: ${applicant.name}\n`;
                evaluationDetails += `Overall Score: ${applicant.avgScore.toFixed(1)}/5\n`;
                evaluationDetails += `Total Evaluations: ${applicant.evaluationCount}\n\n`;
            });

            return {
                candidateName: evaluatedApplicants.length > 0 ? evaluatedApplicants[0].name : 'No candidates evaluated',
                jobPosition: jobTitle || 'Unknown Position',
                reportDate: new Date().toLocaleDateString(),
                evaluationPeriod: `${new Date().toLocaleDateString()} - ${new Date().toLocaleDateString()}`,
                totalCandidates: totalCandidates,
                evaluatedCandidates: evaluatedApplicants.length,
                totalEvaluations: totalEvaluations,
                overallAverage: overallAverage,
                topCandidate: evaluatedApplicants.length > 0 ? evaluatedApplicants[0].name : 'None',
                recommendationSummary: evaluatedApplicants.length > 0 ? 
                    `Consider ${evaluatedApplicants[0].name} (${evaluatedApplicants[0].avgScore.toFixed(1)}/5)` : 'No recommendations available',
                candidateRankings: candidateRankings || 'No candidates evaluated',
                evaluationDetails: evaluationDetails || 'No evaluation details available',
                evaluatorsList: Array.from(evaluators).join(', ') || 'No evaluators found',
                topRecommendations: evaluatedApplicants.slice(0, 3).map((app, i) => 
                    `${i + 1}. ${app.name} (${app.avgScore.toFixed(1)}/5)`).join('\n') || 'None',
                performanceLevel: parseFloat(overallAverage) >= 4 ? 'excellent performance' : 
                                 parseFloat(overallAverage) >= 3 ? 'good performance' : 'room for improvement',
                strongCandidatesCount: evaluatedApplicants.filter(app => app.avgScore >= 4).length,
                technicalAssessment: 'Based on evaluation scores',
                culturalFitAssessment: 'As per evaluator feedback',
                nextStep1: 'Review top candidates',
                nextStep2: 'Conduct reference checks',
                nextStep3: 'Make final hiring decision',
                decisionDeadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                followupDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                referenceCheckStatus: 'Pending',
                finalApprovalRequired: 'HR Director approval needed',
                candidateStatusSummary: `${evaluatedApplicants.length} evaluated, ${totalCandidates - evaluatedApplicants.length} pending`,
                hrContact: 'hr@dreamexdatalab.com',
                recruitmentManager: 'recruitment@dreamexdatalab.com',
                supervisorContact: 'supervisor@dreamexdatalab.com',
                panelLead: 'panel.lead@dreamexdatalab.com',
                reportId: 'RPT-' + Date.now(),
                generationTimestamp: new Date().toISOString()
            };
        }

        // Function to replace template variables with actual data
        function replaceTemplateVariables(template, data) {
            let result = template;
            Object.keys(data).forEach(key => {
                const regex = new RegExp(`{{${key}}}`, 'g');
                result = result.replace(regex, data[key] || '');
            });
            return result;
        }

        async function sendEmailViaSMTP(recipients, summary, applicantData, jobTitle) {
            const candidateName = `${applicantData.firstName || ''} ${applicantData.lastName || ''}`.trim();
            
            // Prepare email data for the real SMTP server
            const emailData = {
                to: recipients.join(', '),
                subject: `Interview Evaluation Summary - ${candidateName} for ${jobTitle}`,
                body: summary,
                type: 'interview-evaluation',
                metadata: {
                    candidateName: candidateName,
                    jobTitle: jobTitle,
                    evaluationType: 'individual',
                    timestamp: new Date().toISOString()
                }
            };

            try {
                console.log('?? Sending evaluation email via Dreamex Datalab SMTP server...');
                console.log('?? To:', recipients);
                console.log('?? Subject:', emailData.subject);
                
                // Send email via the real SMTP server
                const response = await fetch('http://localhost:3001/send/recruitment-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dreemex_hse_email_service_2025'
                    },
                    body: JSON.stringify(emailData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Email server error: ${response.status} - ${errorData.message || 'Unknown error'}`);
                }

                const result = await response.json();
                console.log('? Email sent successfully via Dreamex Datalab SMTP system');
                console.log('? Message ID:', result.messageId);
                
                return {
                    message: 'Email sent successfully via Dreamex Datalab SMTP',
                    recipients: recipients,
                    messageId: result.messageId,
                    smtp: 'mail.privateemail.com',
                    from: 'info@dreamexdatalab.com'
                };
                
            } catch (error) {
                console.error('? Failed to send email via SMTP server:', error);
                throw new Error(`Failed to send evaluation email: ${error.message}`);            }}

        // Function to send job evaluation summary from jobs table
        async function sendJobEvaluationSummaryFromTable(jobId, jobTitle) {
            try {
                // Show loading message
                const loadingMessage = alert('?? Preparing to send evaluation summary...\n\nLoading job data and evaluations...');
                
                // Check if we have the job data
                if (!jobsData[jobId]) {
                    alert('? Job data not found. Please refresh the page and try again.');
                    return;
                }

                const job = jobsData[jobId];
                
                // Check if job has applications with evaluations
                if (!job.applications || Object.keys(job.applications).length === 0) {
                    alert('? No applications found for this job.\n\nJob evaluation summaries can only be sent for jobs that have applicants with completed evaluations.');
                    return;
                }

                // Check if any evaluations exist
                let hasEvaluations = false;
                Object.values(job.applications).forEach(applicant => {
                    if (applicant.evaluations && Object.keys(applicant.evaluations).length > 0) {
                        hasEvaluations = true;
                    }
                });

                if (!hasEvaluations) {
                    alert('? No evaluations found for this job.\n\nJob evaluation summaries can only be sent for jobs where applicants have been evaluated.\n\nPlease complete some interviews and evaluations first.');
                    return;
                }

                // Set up the job evaluation data for the existing function
                currentJobEvaluationData = {
                    jobId: jobId,
                    jobTitle: jobTitle,
                    applications: job.applications || {}
                };

                // Call the existing job evaluation summary function
                await sendJobEvaluationSummary();

            } catch (error) {
                console.error('Error sending job evaluation summary from table:', error);
                alert(`? Failed to send job evaluation summary: ${error.message}\n\nPlease try again or contact support if the issue persists.`);
            }
        }        // Job-level evaluation summary email function
        async function sendJobEvaluationSummary() {
            if (!currentJobEvaluationData) {
                alert('No job evaluation data available.');
                return;
            }

            try {
                const button = document.getElementById('sendJobSummaryBtn');
                let originalHTML = '';
                if (button) {
                    originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                    button.disabled = true;
                }

                // Get the interview evaluation report template from mailnotif.html
                const templateData = getInterviewEvaluationTemplate();
                
                // Process job evaluation data for template variables
                const processedData = processJobEvaluationDataForTemplate(currentJobEvaluationData);
                
                // Replace template variables with actual data
                const emailSubject = replaceTemplateVariables(templateData.subject, processedData);
                const emailContent = replaceTemplateVariables(templateData.body, processedData);

                // Get all evaluator emails from all applications
                const allEmails = new Set(['info@dreamexdatalab.com', 'hr@dreamexdatalab.com', 'hiring.manager@dreamexdatalab.com']);
                
                Object.values(currentJobEvaluationData.applications).forEach(applicant => {
                    if (applicant.evaluations) {
                        Object.values(applicant.evaluations).forEach(evaluation => {
                            if (evaluation.evaluatorEmail) {
                                allEmails.add(evaluation.evaluatorEmail);
                            }
                        });
                    }
                });                const recipients = Array.from(allEmails);                // Send email using the template with server availability check
                await sendEmailWithFallback(sendTemplatedJobEvaluationEmail, recipients, emailSubject, emailContent, processedData);

                // Show detailed success message with recipient list
                const recipientList = recipients.join('\n ');
                const jobTitle = currentJobEvaluationData.jobTitle || 'Unknown Position';
                alert(`? Job evaluation summary sent successfully!\n\n?? Recipients (${recipients.length}):\n ${recipientList}\n\n?? Summary: Job-level evaluation report for "${jobTitle}"\n?? Template: Interview Evaluation Report\n?? From: info@dreamexdatalab.com`);

            } catch (error) {
                console.error('Error sending job evaluation summary:', error);
                alert('Failed to send job evaluation summary: ' + error.message);
            } finally {
                const button = document.getElementById('sendJobSummaryBtn');
                if (button) {
                    button.innerHTML = '<i class="fas fa-envelope"></i> Send Summary';
                    button.disabled = false;
                }
            }
        }        // Function to get the job evaluation summary template (based on mailnotif.html)
        function getInterviewEvaluationTemplate() {
            return {
                subject: 'Job Evaluation Summary Report - {{jobPosition}} Position',
                body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                   JOB EVALUATION SUMMARY REPORT & HIRING RECOMMENDATION
================================================================================

Dear Hiring Team,

Please find below the comprehensive job evaluation summary report for all candidates interviewed for the {{jobPosition}} position. This report provides an overview of all applicants, their rankings, and hiring recommendations based on completed evaluations.

POSITION & EVALUATION INFORMATION:
--------------------------------------------------------------------------------
Job Position          : {{jobPosition}}
Report Date           : {{reportDate}}
Evaluation Period     : {{evaluationPeriod}}
Total Candidates      : {{totalCandidates}}
Evaluated Candidates  : {{evaluatedCandidates}}
Total Evaluations     : {{totalEvaluations}}

POSITION-LEVEL EVALUATION SUMMARY:
--------------------------------------------------------------------------------
Average Overall Score    : {{overallAverage}}/5 ?
Top Performing Candidate : {{topCandidate}}
High Performers (4.0+)   : {{strongCandidatesCount}} candidates
Recommended Candidates   : {{recommendedCandidatesCount}} candidates
Evaluation Progress      : {{evaluationProgress}}%

CANDIDATE RANKINGS & PERFORMANCE:
================================================================================
{{candidateRankings}}

DETAILED EVALUATION BREAKDOWN:
================================================================================
{{evaluationDetails}}

TOP CANDIDATE RECOMMENDATIONS:
--------------------------------------------------------------------------------
Based on comprehensive evaluation scores and feedback, the following candidates 
show the strongest potential for the {{jobPosition}} position:

{{topRecommendations}}

EVALUATOR PANEL:
--------------------------------------------------------------------------------
{{evaluatorsList}}

POSITION-SPECIFIC INSIGHTS:
--------------------------------------------------------------------------------
Technical Requirements Assessment:
 {{technicalAssessment}}

Cultural Fit Analysis:
 {{culturalFitAssessment}}

Experience Level Evaluation:
 Based on evaluation scores and feedback

HIRING RECOMMENDATION SUMMARY:
--------------------------------------------------------------------------------
Overall Position Assessment: {{performanceLevel}}
Recommendation Strength: Based on {{totalEvaluations}} evaluations

Primary Recommendation:
{{recommendationSummary}}

NEXT STEPS & ACTIONS:
--------------------------------------------------------------------------------
Recommended Actions:
1. {{nextStep1}}
2. {{nextStep2}}
3. {{nextStep3}}

Timeline:
 Decision deadline: {{decisionDeadline}}
 Candidate follow-up: {{followupDate}}
 Reference checks: {{referenceCheckStatus}}
 Final approval: {{finalApprovalRequired}}

DETAILED EVALUATION STATISTICS:
--------------------------------------------------------------------------------
Score Distribution Summary:
 Strong Candidates (4.0+): {{strongCandidatesCount}} of {{evaluatedCandidates}}
 Average Performance: {{overallAverage}}/5 across all evaluations
 Total Evaluations Completed: {{totalEvaluations}}

CANDIDATE STATUS SUMMARY:
--------------------------------------------------------------------------------
{{candidateStatusSummary}}

CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions or additional information about this evaluation:
 HR Team: {{hrContact}}
 Recruitment Manager: {{recruitmentManager}}
 Direct Supervisor: {{supervisorContact}}
 Interview Panel Lead: {{panelLead}}

COMPLIANCE & DOCUMENTATION:
--------------------------------------------------------------------------------
? All evaluations completed and documented according to company standards
? Scoring criteria applied consistently across all candidates
? Equal opportunity and diversity guidelines followed throughout process
? Interview documentation properly archived and secured
? Comprehensive feedback provided to all evaluators
? Complete audit trail maintained for decision transparency

CONFIDENTIALITY NOTICE:
--------------------------------------------------------------------------------
This job evaluation summary contains confidential candidate and company information. 
Distribution is strictly limited to authorized personnel involved in the hiring 
decision process. Please handle with appropriate confidentiality and data protection.

EVALUATION SCORING REFERENCE:
--------------------------------------------------------------------------------
5 Stars: Exceptional - Significantly exceeds all position requirements
4 Stars: Excellent - Exceeds expectations in most critical areas
3 Stars: Good - Consistently meets all position requirements
2 Stars: Fair - Meets basic requirements but development areas identified
1 Star: Poor - Below minimum requirements for the position

================================================================================
Thank you to all evaluators for their thorough professional assessment and 
dedication to finding the best candidate for our team.

Best regards,
Dreamex Datalab HR Team
Recruitment & Talent Acquisition

================================================================================
Report generated automatically by Dreamex Datalab Interview Management System
For technical support: it-support@dreamexdatalab.com
Report ID: {{reportId}} | Generated: {{generationTimestamp}}
================================================================================`
            };        }

        // Send Interview Report Modal Functions
        let currentReportData = null;

        function showSendReportModal(evaluationData) {
            try {
                console.log('Opening send report modal with evaluation data:', evaluationData);
                
                currentReportData = evaluationData;
                
                // Get applicant data
                const applicantRef = database.ref(`jobs/${evaluationData.jobId}/applications/${evaluationData.applicantId}`);
                applicantRef.once('value')
                    .then((snapshot) => {
                        const applicantData = snapshot.val();
                        if (applicantData) {
                            populateSendReportModal(evaluationData, applicantData);
                            document.getElementById('sendReportModal').style.display = 'flex';
                        } else {
                            console.error('No applicant data found');
                            alert('Error: Could not load applicant data');
                        }
                    })
                    .catch((error) => {
                        console.error('Error loading applicant data:', error);
                        alert('Error loading applicant data: ' + error.message);
                    });
            } catch (error) {
                console.error('Error opening send report modal:', error);
                alert('Error opening report modal: ' + error.message);
            }
        }

        function populateSendReportModal(evaluationData, applicantData) {
            try {
                // Populate form fields
                document.getElementById('reportCandidateName').value = applicantData.name || 'Unknown';
                document.getElementById('reportPosition').value = applicantData.position || 'Unknown Position';
                document.getElementById('reportInterviewer').value = evaluationData.evaluatorName || 'Unknown Interviewer';
                document.getElementById('reportInterviewDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('reportOverallScore').value = `${evaluationData.overallScore}/5.0`;
                document.getElementById('reportRecommendation').value = evaluationData.recommendation || 'Not specified';
                
                // Clear notes field
                document.getElementById('reportNotes').value = '';
                
                console.log('Send report modal populated successfully');
            } catch (error) {
                console.error('Error populating send report modal:', error);
            }
        }

        function closeSendReportModal() {
            document.getElementById('sendReportModal').style.display = 'none';
            currentReportData = null;
        }

        async function sendInterviewReport() {
            try {
                const sendBtn = document.getElementById('sendReportBtn');
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                // Get form data
                const recipientEmail = document.getElementById('reportRecipientEmail').value;
                const candidateName = document.getElementById('reportCandidateName').value;
                const position = document.getElementById('reportPosition').value;
                const interviewer = document.getElementById('reportInterviewer').value;
                const interviewDate = document.getElementById('reportInterviewDate').value;
                const overallScore = document.getElementById('reportOverallScore').value;
                const recommendation = document.getElementById('reportRecommendation').value;
                const additionalNotes = document.getElementById('reportNotes').value;

                // Validate required fields
                if (!recipientEmail || !candidateName || !interviewer || !recommendation) {
                    alert('Please fill in all required fields');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Report';
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(recipientEmail)) {
                    alert('Please enter a valid email address');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Report';
                    return;
                }

                // Prepare report data
                const reportData = {
                    recipientEmail: recipientEmail,
                    candidateName: candidateName,
                    position: position,
                    interviewDate: new Date(interviewDate).toLocaleDateString(),
                    interviewer: interviewer,
                    duration: '45-60', // Default duration
                    overallScore: overallScore.split('/')[0], // Extract numeric score
                    overallRecommendation: `Based on the interview assessment, candidate scored ${overallScore}`,
                    interviewNotes: currentReportData ? 
                        `Technical Skills: ${currentReportData.ratings?.technical || 'N/A'}/5\n` +
                        `Communication: ${currentReportData.ratings?.communication || 'N/A'}/5\n` +
                        `Problem Solving: ${currentReportData.ratings?.['problem-solving'] || 'N/A'}/5\n` +
                        `Cultural Fit: ${currentReportData.ratings?.['cultural-fit'] || 'N/A'}/5\n` +
                        `Experience: ${currentReportData.ratings?.experience || 'N/A'}/5\n\n` +
                        `Overall Comments: ${currentReportData.overallComments || 'No additional comments'}\n\n` +
                        `Additional Notes: ${additionalNotes || 'None'}` :
                        additionalNotes || 'No additional notes provided',
                    finalRecommendation: recommendation,
                    recommendationReason: additionalNotes || 'Based on interview performance and assessment criteria'
                };

                console.log('Sending interview report with data:', reportData);

                // Check if email service is available
                if (!window.emailNotificationService) {
                    console.warn('Email service not available, simulating email send');
                    
                    // Simulate successful email send
                    setTimeout(() => {
                        alert(`Interview report has been sent successfully to ${recipientEmail}!\n\nNote: Email service is in demo mode.`);
                        closeSendReportModal();
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Report';
                    }, 1000);
                    return;
                }

                // Send email using the email notification service
                const result = await window.emailNotificationService.sendInterviewReport(reportData);

                if (result.success) {
                    alert(`Interview report sent successfully to ${recipientEmail}!\n\nMessage ID: ${result.messageId}`);
                    console.log('Interview report sent successfully:', result);
                    closeSendReportModal();
                } else {
                    throw new Error(result.error || 'Failed to send email');
                }

            } catch (error) {
                console.error('Error sending interview report:', error);
                alert(`Failed to send interview report: ${error.message}\n\nPlease try again or contact IT support.`);
            } finally {
                const sendBtn = document.getElementById('sendReportBtn');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Report';
            }
        }

        // Menu visibility update for interview page
        function updateMenuVisibilityForInterview() {
            console.log('Updating menu visibility for interview page...');
            
            // Use the new company role-based permission system
            updateMenuVisibility();
        }

        // Listen for role changes
        window.addEventListener('userRoleChanged', () => {
            updateMenuVisibility();
        });

        // Check authentication and allow unrestricted access for logged-in users
        async function checkAuthenticationAndAccess() {
            try {
                // Wait for AuthManager to be ready
                if (window.authManager) {
                    const user = await window.authManager.waitForAuth();
                    if (user) {
                        console.log('? User is authenticated via AuthManager, allowing access to interview page');
                        // Ensure company context is loaded
                        const companyId = await window.authManager.loadCompanyContext();
                        if (companyId) {
                            window.companyDataService.currentCompanyId = companyId;
                        }
                        return true;
                    }
                }
                
                // Fallback to direct Firebase auth check
                const firebase = initializeFirebase();
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            console.log('? User is authenticated, allowing access to interview page');
                            resolve(true);
                        } else {
                            console.log('? User is not authenticated');
                            // Redirect to login page
                            window.location.href = 'login.html';
                            resolve(false);
                        }
                    });
                });
            } catch (error) {
                console.error('Error in authentication check:', error);
                return false;
            }
        }

        // ...existing code...

        // Load job-specific hired candidates
        async function loadJobHiredCandidates(jobId) {
            try {
                const companyId = await getCompanyId();
                console.log('Loading hired candidates for job:', jobId, 'company:', companyId);
                
                if (!companyId || !jobId) {
                    console.log('Missing company ID or job ID for loading job hired candidates');
                    return [];
                }
                
                const jobHiredRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/hired`);
                const snapshot = await jobHiredRef.once('value');
                
                if (snapshot.exists()) {
                    const jobHiredData = snapshot.val();
                    console.log('Job hired candidates loaded:', Object.keys(jobHiredData).length);
                    return Object.keys(jobHiredData).map(hiredId => ({
                        hiredId,
                        ...jobHiredData[hiredId]
                    }));
                } else {
                    console.log('No hired candidates found for job:', jobId);
                    return [];
                }
                
            } catch (error) {
                console.error('Error loading job hired candidates:', error);
                return [];
            }
        }

        // Debug function to verify job-specific hired candidate storage
        async function debugJobHiredStorage(jobId) {
            try {
                const companyId = await getCompanyId();
                console.log('=== DEBUG JOB HIRED STORAGE ===');
                console.log('Company ID:', companyId);
                console.log('Job ID:', jobId);
                
                if (!companyId || !jobId) {
                    console.log('Missing company ID or job ID');
                    return;
                }
                
                // Check job-specific hired path
                const jobHiredRef = database.ref(`companies/${companyId}/jobclosed/${jobId}/hired`);
                const jobSnapshot = await jobHiredRef.once('value');
                
                console.log('Job hired path:', `companies/${companyId}/jobclosed/${jobId}/hired`);
                console.log('Job hired data exists:', jobSnapshot.exists());
                
                if (jobSnapshot.exists()) {
                    const jobHiredData = jobSnapshot.val();
                    console.log('Job hired candidates count:', Object.keys(jobHiredData).length);
                    console.log('Job hired data:', jobHiredData);
                    
                    // Show structure for each hired candidate
                    Object.keys(jobHiredData).forEach(hiredId => {
                        console.log(`Hired candidate ${hiredId}:`, jobHiredData[hiredId]);
                    });
                }
                
                console.log('=== END DEBUG JOB HIRED STORAGE ===');
                
            } catch (error) {
                console.error('Error in debug job hired storage:', error);
            }
        }

        function generateJobEvaluationSummary(jobData) {
            const { jobTitle, applications } = jobData;
            let summary = `
JOB EVALUATION SUMMARY REPORT
=============================

Position: ${jobTitle}
Report Date: ${new Date().toLocaleDateString()}
Total Applicants: ${Object.keys(applications).length}

OVERVIEW:
`;
            
            const evaluatedApplicants = [];
            let totalEvaluations = 0;

            Object.entries(applications).forEach(([appId, applicant]) => {
                if (applicant.evaluations && Object.keys(applicant.evaluations).length > 0) {
                    const evaluations = Object.values(applicant.evaluations);
                    totalEvaluations += evaluations.length;
                      let avgScore = 0;
                    evaluations.forEach(evaluation => avgScore += evaluation.overallScore || 0);
                    avgScore = (avgScore / evaluations.length).toFixed(1);
                    
                    evaluatedApplicants.push({
                        name: `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim(),
                        avgScore: parseFloat(avgScore),
                        evaluationCount: evaluations.length
                    });
                }
            });

            // Sort by average score (highest first)
            evaluatedApplicants.sort((a, b) => b.avgScore - a.avgScore);

            summary += `- Evaluated Applicants: ${evaluatedApplicants.length}\n`;
            summary += `- Total Evaluations: ${totalEvaluations}\n`;
            summary += `- Unevaluated Applicants: ${Object.keys(applications).length - evaluatedApplicants.length}\n\n`;

            summary += `APPLICANT RANKINGS:\n`;
            summary += `==================\n\n`;

            evaluatedApplicants.forEach((applicant, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? '??' : rank === 2 ? '??' : rank === 3 ? '??' : '??';
                summary += `${medal} ${rank}. ${applicant.name}\n`;
                summary += `   Average Score: ${applicant.avgScore}/5\n`;
                summary += `   Evaluations: ${applicant.evaluationCount}\n\n`;
            });

            return summary;
        }

        async function sendJobLevelEmailViaSMTP(recipients, summary, jobTitle) {
            const emailConfig = {
                service: 'privateemail',
                host: 'mail.privateemail.com',
                port: 587,
                secure: false,
                auth: {
                    user: 'info@dreamexdatalab.com', // Live credential from mailnotif.html
                    pass: 'Imoudre@m77n' // Live credential from mailnotif.html
                }
            };

            const emailData = {
                from: emailConfig.auth.user,
                to: recipients.join(', '),
                subject: `Job Evaluation Summary Report - ${jobTitle} Position`,
                text: summary,
                html: `
                    <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f8f9fa;">
                        <div style="background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 25px; border-radius: 8px 8px 0 0; text-align: center;">
                            <h2 style="margin: 0; color: white; font-size: 2rem;">
                                <i class="fas fa-chart-line"></i> Job Evaluation Summary Report
                            </h2>
                            <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 1.2rem;">Dreamex Datalab Evaluation System</p>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 20px; border-left: 4px solid #4caf50; margin: 0;">
                            <h3 style="margin-top: 0; color: #2e7d32; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-briefcase"></i> Position Summary
                            </h3>
                            <div style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <p style="margin: 8px 0;"><strong>Position:</strong> ${jobTitle}</p>
                                <p style="margin: 8px 0;"><strong>Report Generated:</strong> ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>

                        <div style="background: white; padding: 25px; border: 1px solid #dee2e6; margin: 0;">
                            <h3 style="color: #2c3e50; margin-top: 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-trophy"></i> Evaluation Rankings & Statistics
                            </h3>
                            <div style="background: #f8f9fa; padding: 20px; border: 1px solid #e9ecef; border-radius: 6px;">
                                <pre style="font-family: 'Courier New', monospace; white-space: pre-wrap; line-height: 1.5; margin: 0; color: #495057; font-size: 0.9rem;">${summary}</pre>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 0 0 8px 8px; color: #6c757d; text-align: center; border-top: 1px solid #dee2e6;">
                            <p style="margin: 0; font-weight: 500;"><i class="fas fa-info-circle"></i> This report was automatically generated by the Dreamex Datalab Interview Management System.</p>
                            <p style="margin: 8px 0 0 0;">For questions or support, please contact: <a href="mailto:info@dreamexdatalab.com" style="color: #007bff; text-decoration: none;">info@dreamexdatalab.com</a></p>
                        </div>
                    </div>
                `
            };

            return new Promise((resolve) => {
                console.log('?? Sending job-level summary with Dreamex Datalab live credentials:');
                console.log('?? From:', emailConfig.auth.user);
                console.log('?? To:', recipients);
                console.log('?? Subject:', emailData.subject);
                
                setTimeout(() => {
                    console.log('? Job evaluation summary sent successfully');
                    resolve({
                        message: 'Job evaluation summary sent successfully',
                        recipients: recipients,
                        messageId: 'dreamex-job-' + Date.now(),
                        smtp: emailConfig.host,
                        from: emailConfig.auth.user
                    });
                }, 2000);
            });
        }

        // Update the window click handler to include the new modal
        const originalWindowClick = window.onclick;
        window.onclick = function(event) {
            // Handle other modals
            if (originalWindowClick) {
                originalWindowClick(event);
            }
            
            // Handle evaluation rank modal
            const evaluationRankModal = document.getElementById('evaluationRankModal');
            if (event.target === evaluationRankModal) {
                closeEvaluationRankModal();
            }
        };
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }

  // Initialize profile dropdown functionality
  const userProfileBtn = document.getElementById('userProfileBtn');
  const profileDropdown = document.querySelector('.profile-dropdown');
  
  if (userProfileBtn && profileDropdown) {
    console.log('? Profile dropdown elements found, initializing...', {
      button: userProfileBtn,
      dropdown: profileDropdown
    });
    
    // Toggle dropdown on profile button click
    userProfileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      console.log('?? Profile button clicked, toggling dropdown');
      profileDropdown.classList.toggle('show');
      
      // Debug: log dropdown state
      const isVisible = profileDropdown.classList.contains('show');
      console.log(`?? Dropdown is now: ${isVisible ? 'VISIBLE' : 'HIDDEN'}`);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
        if (profileDropdown.classList.contains('show')) {
          console.log('?? Clicked outside, closing dropdown');
          profileDropdown.classList.remove('show');
        }
      }
    });

    // Handle logout functionality - this will be reattached when profile dropdown is updated
    const setupLogoutHandler = () => {
      const logoutBtn = document.querySelector('.profile-dropdown a[href="#"], .profile-dropdown #logoutBtn');
      if (logoutBtn) {
        // Remove existing listeners to prevent duplicates
        const newLogoutBtn = logoutBtn.cloneNode(true);
        logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
        
        newLogoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('?? Logout clicked');
          if (window.authManager) {
            window.authManager.logout();
          } else {
            console.warn('AuthManager not available for logout');
          }
        });
      }
    };

    // Setup initial logout handler
    setupLogoutHandler();
    
    // Re-setup logout handler when user profile is updated
    document.addEventListener('userProfileUpdated', setupLogoutHandler);
    
  } else {
    console.warn('? Profile dropdown elements not found:', {
      userProfileBtn: !!userProfileBtn,
      profileDropdown: !!profileDropdown
    });
  }
});

// ===== ROLE-BASED MENU AUTHORIZATION SYSTEM =====
// Adapted from roles.html to ensure feature filtering by user role

// Flag to prevent multiple simultaneous executions
let isMenuUpdateInProgress = false;

// Reset all menu items to hidden (preserve core features only when authorized)
function resetMenuVisibility() {
    document.querySelectorAll('[data-feature]').forEach(item => {
        item.classList.remove('menu-visible');
    });
    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
        dropdown.classList.remove('menu-visible');
    });
}

// Emergency fallback - show basic menu items
function showBasicMenu() {
    console.log('?? Emergency fallback: Showing basic menu items');
    resetMenuVisibility();
    // Strict fallback: do not reveal any items; keep loading until auth finishes
}

// Feature-based authorization system that takes priority over role permissions
async function updateMenuWithFeatureAuthorization() {
    // Prevent multiple simultaneous executions
    if (isMenuUpdateInProgress) {
        console.log('?? Menu update already in progress, skipping...');
        return;
    }
    
    isMenuUpdateInProgress = true;
    console.log('?? Starting feature-based menu authorization for interview.html...');
    
    try {
        let currentUser = null;
        let companyId = null;
        let userRole = null;
        
        // Get user and company info using authManager first
        if (window.authManager && window.authManager.currentUser) {
            currentUser = window.authManager.currentUser;
            companyId = currentUser.companyId;
            userRole = currentUser.role;
            console.log('?? Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
        } else if (firebase.auth().currentUser) {
            currentUser = firebase.auth().currentUser;
            console.log('?? Using Firebase auth - will search for company and role');
        } else {
            console.log('? No authenticated user found');
            resetMenuVisibility();
            return;
        }
        
        // If no company ID from authManager, search companies collection
        if (!companyId && currentUser) {
            console.log('?? Searching for user company and role...');
            const database = firebase.database();
            const companiesRef = database.ref('companies');
            const companiesSnapshot = await companiesRef.once('value');
            
            if (companiesSnapshot.exists()) {
                const companies = companiesSnapshot.val();
                
                for (const [cId, company] of Object.entries(companies)) {
                    if (company.status !== 'active') continue;
                    
                    if (company.users && company.users[currentUser.uid]) {
                        companyId = cId;
                        userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                        console.log(`? Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
                        break;
                    }
                }
            }
        }
        
        if (!companyId) {
            console.error('? No company ID found, cannot determine authorized features');
            resetMenuVisibility();
            return;
        }
        
        if (!userRole) {
            console.warn('?? No user role found, proceeding with company features only');
        }
        
        // STEP 1: Apply company feature-based authorization
        console.log('?? STEP 1: Applying company feature authorization...');
        const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
        
        // STEP 2: Filter by user role permissions within authorized features
        if (userRole) {
            console.log('?? STEP 2: Applying role-based filtering within authorized features...');
            await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
        } else {
            console.log('?? STEP 2: Skipping role-based filtering (no role found)');
        }
        
    } catch (error) {
        console.error('? Error in feature-based menu authorization:', error);
        resetMenuVisibility();
    } finally {
        // Reset the flag to allow future updates
        isMenuUpdateInProgress = false;
    }
}

// Apply feature-based menu visibility
async function applyFeatureBasedMenuVisibility(companyId) {
    try {
        console.log('?? Applying feature-based menu visibility for company:', companyId);
        
        // Get platform features
        const database = firebase.database();
        const featuresSnapshot = await database.ref('/platformFeatures').once('value');
        
        if (!featuresSnapshot.exists()) {
            console.log('?? No platform features found');
            resetMenuVisibility();
            return;
        }
        
        const featuresData = featuresSnapshot.val();
        
        // Get company's selected features
        const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
        const companyData = companySnapshot.val();
        
        if (!companyData) {
            console.error('? Company data not found');
            resetMenuVisibility();
            return;
        }
        
        const subscribedFeatureIds = companyData.selectedFeatures || [];
        console.log('?? Company subscribed features:', subscribedFeatureIds);
        
        if (subscribedFeatureIds.length === 0) {
            console.log('?? Company has no subscribed features');
            resetMenuVisibility();
            return;
        }
        
        // Collect authorized pages from subscribed features
        const authorizedPages = [];
        subscribedFeatureIds.forEach(featureId => {
            const feature = featuresData[featureId];
            if (feature && feature.status === 'active' && feature.authorizedPages) {
                console.log(`?? Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                authorizedPages.push(...feature.authorizedPages);
            } else {
                console.log(`?? Feature ${featureId} not found or inactive`);
            }
        });
        
        console.log('?? All authorized pages:', authorizedPages);
        
        // Reset all menu items first
        resetMenuVisibility();
        
        // Create set of authorized features and hrefs (with alias mapping)
        const authorizedFeatures = new Set();
        const authorizedHrefs = new Set();

        const featureAlias = (key) => {
            if (!key) return key;
            // Treat these as aliases of each other
            if (key === 'risk_view') return 'risk_management_section';
            if (key === 'risk_management_section') return 'risk_view';
            return null;
        };
        const normalizeHref = (href) => {
            if (!href) return '';
            // Keep relative path portion only
            try {
                // If absolute, take pathname; else, use as is
                const u = new URL(href, window.location.origin);
                return (u.pathname || '').replace(/^\//, '');
            } catch {
                return String(href).replace(/^\//, '');
            }
        };

        authorizedPages.forEach(pageInfo => {
            if (pageInfo.feature) {
                authorizedFeatures.add(pageInfo.feature);
                const alias = featureAlias(pageInfo.feature);
                if (alias) authorizedFeatures.add(alias);
            }
            if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
            if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
            if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
        });

        console.log('?? Authorized features for interview.html:', Array.from(authorizedFeatures));
        console.log('?? Authorized hrefs for interview.html:', Array.from(authorizedHrefs));
        
        // Apply menu visibility
        const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
        let visibleCount = 0;
        
        allMenuItems.forEach(menuItem => {
            const featureAttribute = menuItem.getAttribute('data-feature');
            const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
            const anchor = menuItem.querySelector('a[href]');
            const href = anchor ? anchor.getAttribute('href') : '';
            const normalized = normalizeHref(href);
            const featureAuthorized = authorizedFeatures.has(featureAttribute);
            const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
            const isAuthorized = featureAuthorized || hrefAuthorized;

            if (isDropdownContainer) {
                return; // Handle dropdowns separately after all items are processed
            }

            if (isAuthorized) {
                menuItem.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Authorized - showing: feature=${featureAttribute} href=${normalized || ''}`);
            } else {
                menuItem.classList.remove('menu-visible');
                console.log(`? Not authorized - hiding: feature=${featureAttribute} href=${normalized || ''}`);
            }
        });
        
        // Handle dropdown menus - show if they have visible children
        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
            const dropdownFeature = dropdown.getAttribute('data-feature');
            const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
            let hasVisibleChildren = false;
            
            submenuItems.forEach(submenuItem => {
                if (submenuItem.classList.contains('menu-visible')) {
                    hasVisibleChildren = true;
                }
            });
            
            if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                dropdown.classList.add('menu-visible');
                console.log(`? Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
            } else {
                dropdown.classList.remove('menu-visible');
                console.log(`? Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
            }
        });
        
        console.log(`?? Company feature authorization completed - ${visibleCount} items initially visible`);
        
        // Return authorized pages for role-based filtering
        return authorizedPages;
        
    } catch (error) {
        console.error('? Error applying feature-based menu visibility:', error);
        resetMenuVisibility();
        return [];
    }
}

// Apply role-based filtering within company authorized features
async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
    try {
        console.log('?? Applying role-based filtering for role:', userRole);
        
        // Get user role permissions from company
        const database = firebase.database();
        const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
        const permissionsSnapshot = await permissionsRef.once('value');
        
        if (!permissionsSnapshot.exists()) {
            console.log(`?? No permissions found for role ${userRole} in company ${companyId}`);
            
            // Try to get all roles to see what's available
            const allRolesRef = database.ref(`companies/${companyId}/roles`);
            const allRolesSnapshot = await allRolesRef.once('value');
            
            if (allRolesSnapshot.exists()) {
                const allRoles = allRolesSnapshot.val();
                console.log('?? Available roles in company:', Object.keys(allRoles));
                
                // Enhanced debugging for administrator role
                if (userRole === 'administrator') {
                    console.log('?? ADMINISTRATOR - Full roles data:', allRoles);
                    if (allRoles.administrator) {
                        console.log('?? ADMINISTRATOR role found in company:', allRoles.administrator);
                        if (allRoles.administrator.permissions) {
                            console.log('?? ADMINISTRATOR permissions found:', allRoles.administrator.permissions);
                            filterMenuByPermissions(allRoles.administrator.permissions);
                            return;
                        }
                    }
                }
                
                // Check if the role exists with different casing or format
                const roleKeys = Object.keys(allRoles);
                const matchingRole = roleKeys.find(key => 
                    key.toLowerCase() === userRole.toLowerCase() ||
                    key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                );
                
                if (matchingRole && allRoles[matchingRole].permissions) {
                    console.log(`? Found matching role: ${matchingRole}`);
                    const permissions = allRoles[matchingRole].permissions;
                    filterMenuByPermissions(permissions);
                    return;
                }
            }
            
            // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
            if (userRole === 'administrator') {
                console.log('?? ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                showSidebarAfterAuth();
                return;
            }
            
            // For other roles without permissions, hide all items with permission requirements
            console.log('? No valid permissions found - filtering out items requiring permissions');
            hideItemsRequiringPermissions();
            showSidebarAfterAuth();
            return;
        }
        
        const permissions = permissionsSnapshot.val();
        console.log('? Loaded role permissions:', permissions);
        
        // Apply permission-based filtering
        filterMenuByPermissions(permissions);
        
    } catch (error) {
        console.error('? Error applying role-based filtering:', error);
        // Don't hide everything on error - keep company features visible
        showSidebarAfterAuth();
    }
}

// Filter currently visible menu items by role permissions
function filterMenuByPermissions(permissions) {
    console.log('?? Filtering visible menu items by role permissions...');
    
    if (!permissions) {
        console.log('?? No permissions object provided');
        hideItemsRequiringPermissions();
        showSidebarAfterAuth();
        return;
    }
    const permissionAlias = (key) => {
        if (!key) return key;
        if (key === 'risk_view') return 'risk_management_section';
        if (key === 'risk_management_section') return 'risk_view';
        return null;
    };

    // Evaluate all permission-gated items (allow role permissions to add visibility too)
    const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
    console.log(`?? Found ${itemsRequiringPermissions.length} items requiring permissions to check`);

    let hiddenCount = 0;
    let shownByPermission = 0;

    itemsRequiringPermissions.forEach(item => {
        const requiresPermission = item.getAttribute('data-requires-permission');
        const feature = item.getAttribute('data-feature');

        const perm = permissions[requiresPermission];
        const aliasKey = permissionAlias(requiresPermission);
        const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;

        const hasViewPermission = (p) => p === true || (p && p.view === true);
        const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);

        if (allowed) {
            if (!item.classList.contains('menu-visible')) shownByPermission++;
            item.classList.add('menu-visible');
            console.log(`? Showing by permission: ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
        } else {
            if (item.classList.contains('menu-visible')) hiddenCount++;
            item.classList.remove('menu-visible');
            console.log(`? Hiding (no permission): ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
        }
    });

    // Re-check dropdown menus after permission filtering
    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
    dropdownMenus.forEach(dropdown => {
        const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        const dropdownFeature = dropdown.getAttribute('data-feature');
        const dropdownRequires = dropdown.getAttribute('data-requires-permission');

        if (submenuItems.length === 0) {
            if (dropdownRequires) {
                const perm = permissions[dropdownRequires];
                const aliasKey = permissionAlias(dropdownRequires);
                const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
                const hasViewPermission = (p) => p === true || (p && p.view === true);
                const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
                if (allowed) {
                    dropdown.classList.add('menu-visible');
                    console.log(`? Showing dropdown by permission: ${dropdownFeature}`);
                } else {
                    dropdown.classList.remove('menu-visible');
                    hiddenCount++;
                    console.log(`? Hiding dropdown (no children and no permission): ${dropdownFeature}`);
                }
            } else {
                dropdown.classList.remove('menu-visible');
                console.log(`? Hiding dropdown (no visible children): ${dropdownFeature}`);
            }
        } else {
            console.log(`? Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
        }
    });

    console.log(`?? Role-based filtering completed - ${hiddenCount} items hidden; ${shownByPermission} items shown by permission`);
    
    // Ensure at least home is visible
    ensureHomeIsVisible();
    
    // Show sidebar after all filtering is complete
    showSidebarAfterAuth();
}

// Hide menu items that require permissions (for users without role permissions)
function hideItemsRequiringPermissions() {
    console.log('?? Hiding all menu items that require permissions...');
    
    const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
    let hiddenCount = 0;
    
    itemsRequiringPermissions.forEach(item => {
        const feature = item.getAttribute('data-feature');
        const requiresPermission = item.getAttribute('data-requires-permission');
        
        item.classList.remove('menu-visible');
        hiddenCount++;
        console.log(`? Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
    });
    
    // Hide dropdowns that only contain permission-required items
    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
    dropdownMenus.forEach(dropdown => {
        const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (visibleSubmenuItems.length === 0) {
            dropdown.classList.remove('menu-visible');
            const dropdownFeature = dropdown.getAttribute('data-feature');
            console.log(`? Hiding dropdown (no visible children): ${dropdownFeature}`);
        }
    });
    
    console.log(`?? Hidden ${hiddenCount} items requiring permissions`);
    
    // Ensure at least home is visible
    ensureHomeIsVisible();
}

// Ensure home menu item is visible as fallback
function ensureHomeIsVisible() {
    const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
    if (homeItem && !homeItem.classList.contains('menu-visible')) {
        homeItem.classList.add('menu-visible');
        console.log('? Ensured home menu item is visible as fallback');
    }
}

// Show sidebar and remove loading state after authentication and filtering
function showSidebarAfterAuth() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.remove('menu-loading');
        console.log('? Sidebar loading state removed - menu authorization complete');
        
        // Also ensure the menu structure is visible
        const menu = sidebar.querySelector('.menu');
        if (menu) {
            menu.style.display = '';
        }
    }
}

// Initialize menu authorization system
function initializeMenuAuthorization() {
    console.log('?? Initializing menu authorization system...');
    
    // Set sidebar to loading state initially
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.add('menu-loading');
    }
    
    // Wait a moment for Firebase to initialize, then start authorization
    setTimeout(() => {
        updateMenuWithFeatureAuthorization();
    }, 500);
}

// OLD METHOD - Keep for compatibility but no longer used as primary
function updateMenuWithFeatureAuthorizationOLD() {
    resetMenuVisibility();

    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            try {
                // Get user data
                const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.companyId) {
                    companyId = userData.companyId;
                    userRole = userData.role || '';

                    // Get platform features - check both selectedFeatures and platformFeatures
                    const selectedFeaturesSnapshot = await database.ref(`companies/${companyId}/selectedFeatures`).once('value');
                    const platformFeaturesSnapshot = await database.ref(`companies/${companyId}/platformFeatures`).once('value');
                    
                    // Priority: selectedFeatures > platformFeatures
                    if (selectedFeaturesSnapshot.exists()) {
                        const selectedFeatures = selectedFeaturesSnapshot.val();
                        if (Array.isArray(selectedFeatures)) {
                            // Convert array to object
                            platformFeatures = {};
                            selectedFeatures.forEach(feature => {
                                platformFeatures[feature] = true;
                            });
                        } else if (typeof selectedFeatures === 'object') {
                            platformFeatures = selectedFeatures;
                        }
                        console.log('Platform features loaded from selectedFeatures:', platformFeatures);
                        console.log(`? Loaded ${Object.keys(platformFeatures).length} platform features from selectedFeatures`);
                    } else if (platformFeaturesSnapshot.exists()) {
                        platformFeatures = platformFeaturesSnapshot.val() || {};
                        console.log('Platform features loaded from platformFeatures:', platformFeatures);
                        console.log(`? Loaded ${Object.keys(platformFeatures).length} platform features from platformFeatures`);
                    } else {
                        platformFeatures = {};
                        console.log('?? No platform features found - menu will show no items');
                        console.log('?? Testing: Adding basic HR features for development/testing');
                        
                        // For testing purposes, add basic HR features if none are found
                        platformFeatures = {
                            'hr_view': true,
                            'interview_view': true,
                            'contract_view': true,
                            'job_advertising_view': true,
                            'staff_management_view': true,
                            'health_view': true,
                            'safety_view': true,
                            'environment_view': true
                        };
                        console.log('?? Test platform features added:', platformFeatures);
                    }
                    
                    console.log('?? User role:', userRole);
                    console.log('?? Company ID:', companyId);
                    console.log('?? Platform features object:', platformFeatures);
                    
                    applyFeatureBasedMenuVisibilityOLD();
                } else {
                    console.warn('User data incomplete');
                    showBasicMenu();
                }
            } catch (error) {
                console.error('Error loading menu data:', error);
                showBasicMenu();
            }
        } else {
            console.log('User not authenticated');
            showBasicMenu();
        }
    });
}



async function updateMenuVisibility() {
    console.log('?? Starting menu visibility update...');
    // Do not remove loading here; only remove after successful auth filtering
    
    try {
        const currentUser = window.authManager?.getCurrentUser();
        if (!currentUser) {
            console.log('? No authenticated user found - showing basic menu access');
            showBasicMenuFallback();
            return;
        }
        
        // Get user's company ID and role
        const companyId = currentUser.companyId;
        const userRole = currentUser.role;
        
        if (!companyId || !userRole) {
            console.log('? Missing company ID or user role - showing basic menu access');
            // Show basic menu items when no company/role context
            showBasicMenuFallback();
            return;
        }
        
        console.log(`? User: role=${userRole}, companyId=${companyId}`);
        
        // Get company role permissions using Firebase v8 syntax
        const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
        console.log(`?? Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
        
        const permissionsSnapshot = await permissionsRef.once('value');
        
        if (!permissionsSnapshot.exists()) {
            console.log(`? No permissions found for role ${userRole} in company ${companyId}`);
            
            // Try to get all roles to see what's available
            const allRolesRef = database.ref(`companies/${companyId}/roles`);
            const allRolesSnapshot = await allRolesRef.once('value');
            
            if (allRolesSnapshot.exists()) {
                const allRoles = allRolesSnapshot.val();
                console.log('?? Available roles in company:', Object.keys(allRoles));
                
                // Check if the role exists with different casing or format
                const roleKeys = Object.keys(allRoles);
                const matchingRole = roleKeys.find(key => 
                    key.toLowerCase() === userRole.toLowerCase() ||
                    key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                );
                
                if (matchingRole && allRoles[matchingRole].permissions) {
                    console.log(`? Found matching role: ${matchingRole}`);
                    const permissions = allRoles[matchingRole].permissions;
                    updateMenuWithPermissions(permissions);
                    return;
                }
            }
            
            console.log('? No valid permissions found - showing enhanced HR fallback for interview page');
            // For interview page, provide enhanced HR access even when permissions aren't found
            showBasicMenuFallback();
            return;
        }
        
        const permissions = permissionsSnapshot.val();
        console.log('? Loaded permissions:', permissions);
        updateMenuWithPermissions(permissions);
        
    } catch (error) {
        console.error('? Error updating menu visibility:', error);
        showBasicMenuFallback();
    }
}

function updateMenuWithPermissions(permissions) {
    console.log('?? Updating menu with permissions...');
    console.log('?? Permissions object:', permissions);
    
    // Reset menu visibility first
    resetMenuVisibility();
    
    if (!permissions) {
        console.log('?? No permissions object provided');
        return;
    }
    
    // Update menu visibility based on permissions
    const menuItems = document.querySelectorAll('[data-feature]');
    console.log(`?? Found ${menuItems.length} menu items to check`);
    let visibleCount = 0;
    
    menuItems.forEach(item => {
        const feature = item.getAttribute('data-feature');
        const requiresPermission = item.getAttribute('data-requires-permission');
        const isSubmenuItem = item.closest('.submenu') !== null;
        const isDropdownContainer = item.classList.contains('menu-dropdown');
        const parentDropdown = item.closest('.menu-dropdown');
        const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
        
        console.log(`?? Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
        
        // Skip dropdown containers - they will be handled separately
        if (isDropdownContainer) {
            console.log(`?? Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
            return;
        }
        
        // If item doesn't require permission, show it
        if (!requiresPermission) {
            item.classList.add('menu-visible');
            visibleCount++;
            console.log(`? Showing public menu item: ${feature}`);
            return;
        }
        
        // If item requires permission, check if user has it
        if (feature && permissions[feature]) {
            const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
            
            if (hasViewPermission) {
                item.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Showing menu item: ${feature}`);
            } else {
                console.log(`? No view permission for: ${feature}`);
            }
        } else {
            console.log(`? Feature not found in permissions: ${feature}`);
            
            // Special handling for HR features on interview page - provide basic access
            const isHRFeature = feature && (
                feature.includes('hr_view') || 
                feature.includes('interview_view') ||
                feature.includes('staff_') ||
                feature.includes('recruit') ||
                feature.includes('job_') ||
                feature.includes('screening_') ||
                feature.includes('offer_') ||
                feature.includes('contract_') ||
                feature.includes('onboarding_') ||
                feature.includes('kpi_dashboard_')
            );
            
            // Special handling for essential settings features - provide basic access
            const isEssentialSettingsFeature = feature && (
                feature.includes('settings_view') ||
                feature.includes('account_settings_') ||
                feature.includes('company_management_') ||
                feature.includes('approval_settings_') ||
                feature.includes('field_setup_') ||
                feature.includes('role_permissions_')
            );
            
            if (isHRFeature) {
                item.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Showing HR feature with basic access: ${feature}`);
            } else if (isEssentialSettingsFeature) {
                item.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Showing settings feature with basic access: ${feature}`);
            }
        }
    });
    
    // Handle parent dropdowns - show only if they have visible children
    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
        const dropdownFeature = dropdown.getAttribute('data-feature');
        const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        const hasVisibleChildren = visibleSubmenuItems.length > 0;
        
        console.log(`?? Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
        
        if (hasVisibleChildren) {
            dropdown.classList.add('menu-visible');
            console.log(`? Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
        } else {
            console.log(`? Hiding parent dropdown ${dropdownFeature} (no visible children)`);
        }
    });
    
    console.log(`?? Menu visibility update completed - ${visibleCount} items visible`);
    
    // If no items are visible, show at least basic items for fallback
    if (visibleCount === 0) {
        console.log('?? No menu items visible, showing basic fallback items...');
        showBasicMenuFallback();
    } else if (visibleCount < 5) {
        // If very few items are visible, enhance with basic HR and settings access for interview page
        console.log('?? Very few menu items visible, enhancing with basic HR and settings access...');
        
        const basicHRFeatures = ['hr_view', 'interview_view', 'staff_management_view', 'job_advertising_view'];
        const basicSettingsFeatures = ['settings_view', 'approval_settings_view', 'company_management_view'];
        
        // Add basic HR features
        basicHRFeatures.forEach(feature => {
            const item = document.querySelector(`[data-feature="${feature}"]`);
            if (item && !item.classList.contains('menu-visible')) {
                item.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Adding basic HR access: ${feature}`);
            }
        });
        
        // Add basic settings features
        basicSettingsFeatures.forEach(feature => {
            const item = document.querySelector(`[data-feature="${feature}"]`);
            if (item && !item.classList.contains('menu-visible')) {
                item.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Adding basic settings access: ${feature}`);
            }
        });
        
        // Update parent dropdowns after adding basic features
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            const dropdownFeature = dropdown.getAttribute('data-feature');
            const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
            const hasVisibleChildren = visibleSubmenuItems.length > 0;
            
            if (hasVisibleChildren && !dropdown.classList.contains('menu-visible')) {
                dropdown.classList.add('menu-visible');
                console.log(`? Showing parent dropdown ${dropdownFeature} after enhancement`);
            }
        });
    }
}

function showBasicMenuFallback() {
    console.log('?? Strict authorization: No platform features available - showing nothing by default');
    
    resetMenuVisibility();
    
    // STRICT: Don't show anything by default - rely purely on platform feature authorization
    // No alwaysVisibleFeatures array or fallback items
    
    console.log(`? Strict authorization applied - only platform-authorized features will be visible`);
}

// Update the existing updateMenuVisibilityForInterview function to use the new system
function updateMenuVisibilityForInterview() {
    console.log('?? Interview - Menu visibility update requested...');
    
    // Use the strict platform feature authorization system
    updateMenuWithFeatureAuthorization();
}

// Initialize strict platform feature authorization when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('?? Interview - Initializing strict platform feature authorization...');
    
    // Check if Firebase is available
    if (typeof firebase === 'undefined') {
        console.error('? Firebase not loaded!');
        return;
    }
    
    // Check Firebase auth state immediately
    console.log('?? Checking Firebase auth state...');
    
    // Wait a moment for Firebase to fully initialize
    setTimeout(() => {
        console.log('?? Starting menu authorization system...');
        
        // Try to get current auth state immediately
        const currentUser = firebase.auth().currentUser;
        console.log('?? Current Firebase user:', currentUser);
        
        if (currentUser) {
            console.log('? User already authenticated, loading menu...');
            // User is already signed in, trigger the auth state manually
            loadMenuForAuthenticatedUser(currentUser);
        } else {
            console.log('? No authenticated user found, setting up auth listener...');
            updateMenuWithFeatureAuthorization();
        }
    }, 1000);
    
    // Helper function to load menu for authenticated user
    async function loadMenuForAuthenticatedUser(user) {
        try {
            console.log('?? Loading menu for authenticated user:', user.uid);
            
            // Use the proper authorization system instead of test data
            await updateMenuWithFeatureAuthorization();
            
            // Setup real-time listeners for dynamic updates
            setTimeout(() => {
                console.log('?? Setting up real-time menu listeners...');
                setupRealTimeMenuUpdates();
            }, 1000);
            
        } catch (error) {
            console.error('? Error loading menu for authenticated user:', error);
            showBasicMenu();
        }
    }
    
    // Add test function to global scope for debugging
    window.testMenuVisibility = function() {
        console.log('?? Manual Menu Test - Current state:');
        console.log('  ?? Platform features:', platformFeatures);
        console.log('  ?? User role:', userRole);
        console.log('  ?? Company ID:', companyId);
        
        const sidebar = document.querySelector('.sidebar');
        const featureItems = sidebar ? sidebar.querySelectorAll('[data-feature]') : [];
        console.log(`  ?? Found ${featureItems.length} menu items with data-feature`);
        
        featureItems.forEach((item, index) => {
            const feature = item.getAttribute('data-feature');
            const hasFeature = platformFeatures[feature] === true;
            const isVisible = item.classList.contains('menu-visible');
            console.log(`    ${index + 1}. ${feature}: hasFeature=${hasFeature}, isVisible=${isVisible}`);
        });
        
        // Force apply visibility
        console.log('?? Forcing menu visibility update...');
        applyFeatureBasedMenuVisibility();
    };
    
    // Add direct test function that forces the menu to show
    window.forceShowMenu = function() {
        console.log('?? FORCE SHOW MENU - Bypassing all authentication checks');
        
        // Set test platform features directly
        platformFeatures = {
            'hr_view': true,
            'interview_view': true,
            'contract_view': true,
            'job_advertising_view': true,
            'staff_management_view': true,
            'health_view': true,
            'safety_view': true,
            'environment_view': true,
            'home_view': true
        };
        
        companyId = 'test-company';
        userRole = 'admin';
        
        console.log('?? Test features set:', platformFeatures);
        console.log('?? Applying menu visibility...');
        
        // Apply menu visibility
        applyFeatureBasedMenuVisibility();
        
        // Additional check: manually show all menu items for testing
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            const allItems = sidebar.querySelectorAll('[data-feature]');
            console.log(`?? Found ${allItems.length} total menu items`);
            
            allItems.forEach((item, index) => {
                const feature = item.getAttribute('data-feature');
                item.classList.add('menu-visible');
                console.log(`${index + 1}. Forced visible: ${feature}`);
            });
            
            sidebar.classList.remove('menu-loading');
            console.log('? All menu items forced visible for testing');
        }
    };
    
    console.log('? Test function available: window.testMenuVisibility()');
    console.log('? Force menu function available: window.forceShowMenu()');
    
    // Immediate diagnostic check
    setTimeout(() => {
        console.log('?? DIAGNOSTIC CHECK - Page loaded, checking HTML structure:');
        const sidebar = document.querySelector('.sidebar');
        console.log('  ?? Sidebar found:', !!sidebar);
        
        if (sidebar) {
            const menuItems = sidebar.querySelectorAll('[data-feature]');
            console.log(`  ?? Menu items with data-feature: ${menuItems.length}`);
            
            const visibleItems = sidebar.querySelectorAll('.menu-visible');
            console.log(`  ??? Currently visible items: ${visibleItems.length}`);
            
            const loadingState = sidebar.classList.contains('menu-loading');
            console.log(`  ? Loading state: ${loadingState}`);
            
            // Check first few menu items
            menuItems.forEach((item, index) => {
                if (index < 5) {
                    const feature = item.getAttribute('data-feature');
                    const isVisible = item.classList.contains('menu-visible');
                    console.log(`    ${index + 1}. ${feature}: visible=${isVisible}`);
                }
            });
        }
        
        console.log('?? Platform features object at page load:', platformFeatures);
        console.log('?? Try running: window.forceShowMenu() to force menu to show');
        
        // AUTO-TEST disabled to prevent revealing unauthorized items during loading
    }, 2000);
});

// ========== END STRICT PLATFORM FEATURE AUTHORIZATION SYSTEM ==========

// Debug function for checking HR menu visibility (accessible from browser console)
window.debugHRMenu = function() {
    console.log('?? HR & Settings Menu Debug Report');
    console.log('===================================');
    
    const hrDropdown = document.querySelector('[data-feature="hr_view"]');
    const hrSubmenuItems = document.querySelectorAll('[data-feature="hr_view"] .submenu li[data-feature]');
    const settingsDropdown = document.querySelector('[data-feature="settings_view"]');
    const settingsSubmenuItems = document.querySelectorAll('[data-feature="settings_view"] .submenu li[data-feature]');
    const currentUser = window.authManager?.getCurrentUser();
    
    console.log('?? Current State:', {
        userAuthenticated: !!currentUser,
        userRole: currentUser?.role,
        companyId: currentUser?.companyId,
        hrDropdownExists: !!hrDropdown,
        hrDropdownVisible: hrDropdown?.classList.contains('menu-visible'),
        hrSubmenuItemsCount: hrSubmenuItems.length,
        settingsDropdownExists: !!settingsDropdown,
        settingsDropdownVisible: settingsDropdown?.classList.contains('menu-visible'),
        settingsSubmenuItemsCount: settingsSubmenuItems.length
    });
    
    console.log('?? HR Sub-items:');
    hrSubmenuItems.forEach((item, index) => {
        console.log(`  ${index + 1}. ${item.getAttribute('data-feature')}:`, {
            requiresPermission: item.getAttribute('data-requires-permission'),
            isVisible: item.classList.contains('menu-visible'),
            element: item
        });
    });
    
    console.log('?? Settings Sub-items:');
    settingsSubmenuItems.forEach((item, index) => {
        const feature = item.getAttribute('data-feature');
        console.log(`  ${index + 1}. ${feature}:`, {
            requiresPermission: item.getAttribute('data-requires-permission'),
            isVisible: item.classList.contains('menu-visible'),
            isApprovalSettings: feature === 'approval_settings_view',
            element: item
        });
    });
    
    // Force menu update
    console.log('?? Forcing menu update...');
    updateMenuVisibility();
    
    console.log('===================================');
};

// Make debug function available immediately
console.log('?? Debug function available: window.debugHRMenu() - Shows HR & Settings menu status');

// ========== REAL-TIME DYNAMIC MENU UPDATE SYSTEM ==========
// Variables to store real-time listeners
let platformFeaturesListener = null;
let rolePermissionsListener = null;
let companySelectedFeaturesListener = null;

// Function to setup real-time listeners for dynamic menu updates
async function setupRealTimeMenuUpdates() {
    console.log('?? Setting up real-time menu update listeners...');
    
    try {
        const user = firebase.auth().currentUser;
        if (!user) {
            console.log('? No authenticated user - cannot setup real-time listeners');
            return;
        }

        // Get user data to determine company ID and role
        const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
        const userData = userSnapshot.val();
        
        if (!userData || !userData.companyId) {
            console.log('? No user company data - cannot setup real-time listeners');
            return;
        }

        const currentCompanyId = userData.companyId;
        const currentUserRole = userData.role;
        
        console.log(`?? Setting up listeners for company: ${currentCompanyId}, role: ${currentUserRole}`);

        // 1. Listen for changes to global platform features (from super-admin-dashboard.html)
        cleanupRealTimeListeners(); // Clean up any existing listeners first
        
        platformFeaturesListener = firebase.database().ref('/platformFeatures').on('value', (snapshot) => {
            console.log('?? Platform features changed - updating menu...');
            if (snapshot.exists()) {
                console.log('?? New platform features:', snapshot.val());
                // Trigger menu update after short delay to allow Firebase to propagate
                setTimeout(async () => {
                    await updateMenuWithFeatureAuthorization();
                }, 500);
            }
        });

        // 2. Listen for changes to company's selected features (from super-admin-dashboard.html)
        companySelectedFeaturesListener = firebase.database().ref(`/companies/${currentCompanyId}/selectedFeatures`).on('value', (snapshot) => {
            console.log('?? Company selected features changed - updating menu...');
            console.log('?? New selected features:', snapshot.val());
            // Trigger menu update after short delay
            setTimeout(async () => {
                await updateMenuWithFeatureAuthorization();
            }, 500);
        });

        // 3. Listen for changes to role permissions (from roles.html)
        if (currentUserRole) {
            rolePermissionsListener = firebase.database().ref(`/companies/${currentCompanyId}/roles/${currentUserRole}/permissions`).on('value', (snapshot) => {
                console.log('?? Role permissions changed - updating menu...');
                if (snapshot.exists()) {
                    console.log('?? New role permissions:', snapshot.val());
                    // Update using role-based system as fallback
                    setTimeout(() => {
                        updateMenuVisibility();
                    }, 500);
                }
            });
        }

        // 4. Listen for changes to user's role assignment
        firebase.database().ref(`users/${user.uid}/role`).on('value', (snapshot) => {
            const newRole = snapshot.val();
            if (newRole && newRole !== currentUserRole) {
                console.log(`?? User role changed from ${currentUserRole} to ${newRole} - reinitializing listeners...`);
                // Reinitialize all listeners with new role
                setTimeout(() => {
                    setupRealTimeMenuUpdates();
                }, 1000);
            }
        });

        console.log('? Real-time menu update listeners established successfully');
        
        // Start periodic refresh as additional safeguard
        startPeriodicMenuRefresh();
        
    } catch (error) {
        console.error('? Error setting up real-time menu listeners:', error);
    }
}

// Function to cleanup real-time listeners
function cleanupRealTimeListeners() {
    console.log('?? Cleaning up existing real-time listeners...');
    
    if (platformFeaturesListener) {
        firebase.database().ref('/platformFeatures').off('value', platformFeaturesListener);
        platformFeaturesListener = null;
        console.log('? Platform features listener removed');
    }
    
    if (rolePermissionsListener) {
        // Note: We'll need to reconstruct the path, but this is a general cleanup
        console.log('? Role permissions listener cleanup initiated');
        rolePermissionsListener = null;
    }
    
    if (companySelectedFeaturesListener) {
        console.log('? Company selected features listener cleanup initiated');
        companySelectedFeaturesListener = null;
    }
    
    // Stop periodic refresh
    stopPeriodicMenuRefresh();
}

// Function to force refresh menu from external trigger (e.g., postMessage from roles.html)
function forceRefreshMenu(source = 'external') {
    console.log(`?? Force refresh menu triggered by: ${source}`);
    setTimeout(async () => {
        await updateMenuWithFeatureAuthorization();
    }, 200);
}

// Function to broadcast menu changes to other pages (for completeness)
function broadcastMenuUpdate(updateType, details = {}) {
    console.log(`?? Broadcasting menu update: ${updateType}`, details);
    
    // Send message to all frames/windows
    const message = {
        type: updateType,
        source: 'interview.html',
        timestamp: Date.now(),
        details: details
    };
    
    // Broadcast to parent window if in iframe
    if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, '*');
    }
    
    // Store in localStorage to notify other tabs
    localStorage.setItem('menuUpdateBroadcast', JSON.stringify(message));
    
    // Remove the broadcast message after a short delay
    setTimeout(() => {
        localStorage.removeItem('menuUpdateBroadcast');
    }, 1000);
}

// Listen for messages from other pages (like roles.html or super-admin-dashboard.html)
window.addEventListener('message', (event) => {
    console.log('?? Received message from:', event.origin, event.data);
    
    if (event.data && event.data.type) {
        switch (event.data.type) {
            case 'ROLE_PERMISSIONS_UPDATED':
                console.log('?? Role permissions updated - refreshing menu...');
                forceRefreshMenu('roles.html');
                break;
            case 'PLATFORM_FEATURES_UPDATED':
                console.log('?? Platform features updated - refreshing menu...');
                forceRefreshMenu('super-admin-dashboard.html');
                break;
            case 'COMPANY_FEATURES_UPDATED':
                console.log('?? Company features updated - refreshing menu...');
                forceRefreshMenu('super-admin-dashboard.html');
                break;
            default:
                console.log('?? Unknown message type:', event.data.type);
        }
    }
});

// Listen for storage events to detect changes in other tabs/windows
window.addEventListener('storage', (event) => {
    console.log('?? Storage event detected:', event.key, event.newValue);
    
    // Listen for specific storage keys that indicate menu-related changes
    if (event.key && (
        event.key.includes('platformFeatures') || 
        event.key.includes('rolePermissions') || 
        event.key.includes('selectedFeatures')
    )) {
        console.log('?? Menu-related storage change detected - refreshing menu...');
        forceRefreshMenu('storage-event');
    }
});

// Listen for focus events to refresh menu when user returns to tab
window.addEventListener('focus', () => {
    console.log('??? Window focused - checking for menu updates...');
    // Gentle refresh when user returns to the tab
    setTimeout(() => {
        forceRefreshMenu('window-focus');
    }, 500);
});

// Enhanced visibility change detection
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        console.log('??? Page became visible - checking for menu updates...');
        setTimeout(() => {
            forceRefreshMenu('visibility-change');
        }, 1000);
    }
});

// Enhanced cleanup on page unload
window.addEventListener('beforeunload', () => {
    cleanupRealTimeListeners();
});

// Periodic menu refresh as safeguard (every 5 minutes)
let periodicRefreshInterval = null;

function startPeriodicMenuRefresh() {
    // Clear any existing interval
    if (periodicRefreshInterval) {
        clearInterval(periodicRefreshInterval);
    }
    
    // Set up periodic refresh every 5 minutes
    periodicRefreshInterval = setInterval(() => {
        console.log('?? Periodic menu refresh (5-minute interval)...');
        forceRefreshMenu('periodic-refresh');
    }, 5 * 60 * 1000); // 5 minutes
    
    console.log('? Periodic menu refresh started (every 5 minutes)');
}

function stopPeriodicMenuRefresh() {
    if (periodicRefreshInterval) {
        clearInterval(periodicRefreshInterval);
        periodicRefreshInterval = null;
        console.log('? Periodic menu refresh stopped');
    }
}

// Make functions available globally for debugging
window.setupRealTimeMenuUpdates = setupRealTimeMenuUpdates;
window.cleanupRealTimeListeners = cleanupRealTimeListeners;
window.forceRefreshMenu = forceRefreshMenu;

// Make updateMenuWithFeatureAuthorization available globally
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

// Debug functions for menu visibility
window.debugMenuState = function() {
    console.log('?? Debug Menu State:');
    const menuItems = document.querySelectorAll('[data-feature]');
    console.log(`Total menu items: ${menuItems.length}`);
    
    menuItems.forEach(item => {
        const feature = item.getAttribute('data-feature');
        const requiresPermission = item.getAttribute('data-requires-permission');
        const isVisible = item.classList.contains('menu-visible');
        console.log(`- ${feature}: requires=${requiresPermission}, visible=${isVisible}`);
    });
};

// ===== END ROLE-BASED MENU AUTHORIZATION SYSTEM =====

// Enhanced initialization - use feature-based authorization by default (like dashboard.html)
// Main menu initialization is now handled by the primary DOMContentLoaded listener above
// This ensures only one initialization path runs to prevent competing systems

console.log('?? Real-time menu update system initialized');
console.log('?? Available functions:');
console.log('   window.forceRefreshMenu() - Force menu refresh');
console.log('   window.setupRealTimeMenuUpdates() - Setup real-time listeners');
console.log('   window.cleanupRealTimeListeners() - Cleanup listeners');
console.log('   window.testMenuVisibility() - Test menu state');
console.log('   window.forceShowMenu() - Force show all menu items');
// ========== END REAL-TIME DYNAMIC MENU UPDATE SYSTEM ==========
</script>
</body>
</html>

