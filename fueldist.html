<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- EmailJS Public Key (reused from staff.html) -->
    <meta name="emailjs-public-key" content="fHs6oaqQgkcPoUwpv">
    <title>Fuel Distribution Management - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --distribution-color: #f39c12; /* Orange theme for fuel distribution */
            --accent-color: var(--distribution-color);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Chevron icon transition */
        .dropdown-toggle .fa-chevron-down {
            transition: transform 0.3s ease;
        }

        /* Active submenu items */
        .submenu li a {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .submenu li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .submenu li a.active {
            background-color: var(--secondary-color);
            font-weight: 600;
        }

        /* Main Content Styles */
        .main-content {
            flex:1;
            margin-left: var(--sidebar-width);
            padding:0.3rem;
            padding-top:3.2rem;
            transition: margin-left .3s ease;
            width: calc(100% - var(--sidebar-width));
            box-sizing:border-box;
            overflow-x:hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }
        .sidebar { transition: transform .3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .main-content.sidebar-collapsed { margin-left:0; width:100%; max-width:100%; }
        .main-content.sidebar-collapsed .top-nav { left:0.5rem; }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 0.3rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            height: 50px;
            min-height: 50px;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .top-nav-left { display:flex; align-items:center; gap:0.75rem; }

        .sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
        
        .company-branding { display:flex; align-items:center; gap:0.5rem; }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        #headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
        #headerCompanyName { font-weight:600; font-size:0.85rem; }
        .header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }

        .top-nav-right { display:flex; align-items:center; gap:1rem; }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* User Profile Styles (Exact match to project-list.html) */
        .user-profile { position:relative; }
        .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
        .profile-btn img { width:100%; height:100%; object-fit:cover; }
        .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
        .profile-dropdown.show { display:block; }
        .profile-dropdown ul { list-style:none; }
        .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
        .profile-dropdown li a:hover { background:#f1f5f9; }

        /* Content Styles */
        .content {
            margin-top: 1rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Page Header - Match Project List Style */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            margin: 0.35rem 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }

        .page-header h1 {
            color: #fff;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 0.5px;
            margin: 0;
            font-weight: 600;
        }

        .page-header i {
            font-size: 1rem;
        }

        /* Add New Button - Project List Style */
        .btn-add-new {
            background: none;
            border: none;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-add-new:hover {
            color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .btn-add-new i {
            font-size: 1.2rem;
        }

        .page-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        /* Hidden column utility */
        .hidden-col { display: none !important; }

        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }



        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* During loading, hide all menu items by default */
        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Hide ALL menu items by default during loading (exact match to project-list) */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature] {
            display: none !important;
        }

        /* Allow menu-visible items to show even during loading */
        .sidebar.menu-loading .menu-visible,
        .sidebar.menu-loading li.menu-visible,
        .sidebar.menu-loading [data-feature].menu-visible {
            display: block !important;
        }

        /* Ensure menu-visible items are always shown */
        .menu-visible { display: block !important; }
        li.menu-visible,
        [data-feature].menu-visible { display: block !important; }

        /* Enforce: hide all sidebar menu items unless explicitly authorized */
        .menu li { display: none !important; }
        .menu li.menu-visible { display: block !important; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
            }
            
            .top-nav {
                left: 0.5rem;
            }
            
            .page-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .page-header h1 {
                font-size: 1.3rem;
            }
        }

        /* Equipment type styles */
        .equipment-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .equipment-lv {
            background: #e3f2fd;
            color: #1565c0;
        }

        .equipment-hv {
            background: #fff3e0;
            color: #ef6c00;
        }

        .equipment-gen {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .equipment-pump {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .equipment-compressor {
            background: #fce4ec;
            color: #c2185b;
        }

        /* Fuel type styles */
        .fuel-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .fuel-diesel {
            background: #fff8e1;
            color: #f57f17;
        }

        .fuel-petrol {
            background: #e1f5fe;
            color: #0277bd;
        }

        .fuel-aviation {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .fuel-marine {
            background: #e0f2f1;
            color: #00695c;
        }

        /* Distribution status styles */
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #cce5ff;
            color: #004085;
        }

        .status-in-progress {
            background: #fff0b3;
            color: #b8860b;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Quick stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--distribution-color);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--distribution-color);
            margin: 0;
        }

        .stat-card p {
            margin: 0.5rem 0 0 0;
            color: #666;
            font-size: 0.9rem;
        }

        .stat-card i {
            float: right;
            font-size: 2rem;
            color: rgba(243, 156, 18, 0.2);
            margin-top: -0.5rem;
        }

        /* Compact stats variant (reduction request) */
        .stats-cards { gap:0.75rem; margin-bottom:1.25rem; }
        .stat-card { padding:0.85rem 0.9rem; border-radius:6px; }
        .stat-card h3 { font-size:1.35rem; }
        .stat-card p { font-size:0.75rem; margin-top:0.35rem; }
    .stat-card i { font-size:1.35rem; margin-top:-0.25rem; }

    /* Ultra compact stats (further reduction) */
    .stats-cards.compact-ultra .stat-card { padding:0.55rem 0.65rem; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    .stats-cards.compact-ultra .stat-card h3 { font-size:1.05rem; font-weight:600; }
    .stats-cards.compact-ultra .stat-card p { font-size:0.6rem; margin-top:0.2rem; letter-spacing:0.2px; }
    .stats-cards.compact-ultra .stat-card i { font-size:1rem; margin-top:-0.15rem; }

    /* Icon-only action buttons */
    .table-actions .action-btn.icon-only { padding:0.25rem 0.35rem; font-size:0.65rem; }
    .table-actions .action-btn.icon-only i { margin:0; }

        /* Priority indicators */
        .priority-normal {
            border-left: 4px solid #28a745 !important;
        }

        .priority-high {
            border-left: 4px solid #ffc107 !important;
        }

        .priority-emergency {
            border-left: 4px solid #fd7e14 !important;
        }

        .priority-critical {
            border-left: 4px solid #dc3545 !important;
        }

        /* Distribution Management Table Styles */
        .table-container {
            background: white;
            border-radius: 0; /* remove rounded corners */
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-title {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-title::before {
            content: '\f0ce';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
            width: 300px;
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            color: rgba(255,255,255,0.7);
            pointer-events: none;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
        }

        .filter-select option {
            background: #2c3e50;
            color: white;
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-1px);
        }

        .refresh-btn i {
            font-size: 1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* === Employees table style overrides (match payslips.html) === */
        .table-container {
            border:1px solid var(--line, #e2e8f0);
            border-radius:0; /* remove rounded corners */
            box-shadow:0 2px 8px rgba(0,0,0,0.06);
            margin-top:14px;
        }
        .table-header {
            background:#fff;
            color:#1e293b;
            padding:14px 14px 6px 14px;
            border-bottom:1px solid var(--line, #e2e8f0);
            box-shadow:none;
            gap:0.5rem;
        }
        .table-title {
            font-size:.85rem;
            font-weight:600;
            gap:6px;
        }
        .table-title::before { display:none; }
        .table-controls { gap:0.5rem; }
        .search-input, .filter-select, .refresh-btn { border:1px solid #e2e8f0; background:#f8fafc; color:#334155; font-size:.65rem; padding:6px 8px; height:auto; }
        .search-input:focus, .filter-select:focus { background:#fff; border-color:#cbd5e1; }
        .refresh-btn { border-radius:6px; }
        .data-table { font-size:.72rem; border-collapse:collapse; min-width:900px; }
        .data-table th {
            background:#f1f5f9;
            padding:6px 8px;
            font-size:.65rem;
            font-weight:600;
            color:#475569;
            border-bottom:1px solid var(--line, #e2e8f0);
        }
        .data-table td {
            padding:6px 8px;
            font-size:.7rem;
            color:#334155;
            border-bottom:1px solid var(--line, #e2e8f0);
        }
        .data-table tbody tr { transition:background .15s; }
        .data-table tbody tr:hover { background:#f8fafc; transform:none; }
        .table-scroll { overflow:auto; }
        .status-badge { display:inline-block; padding:2px 6px; border-radius:12px; font-size:.6rem; font-weight:600; letter-spacing:.5px; }
        .status-badge.pending { background:#f1f5f9; color:#475569; }
        .status-badge.in_progress { background:#fff7ed; color:#9a3412; }
        .status-badge.completed { background:#dcfce7; color:#166534; }
        .status-badge.cancelled { background:#f1f5f9; color:#334155; }

    /* Contract-style Tabs (reused) */
    .content-tabs { margin:0 0 0.75rem 0; width:100%; }
    .tab-navigation { display:flex; gap:0.5rem; background:#fff; padding:0.5rem; border-radius:0; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
    .tab-nav-btn { padding:0.5rem 1.1rem; border:none; background:transparent; border-radius:0; cursor:pointer; font-size:0.68rem; font-weight:600; letter-spacing:0.5px; transition:all .25s ease; display:flex; align-items:center; gap:0.55rem; color:#6c757d; flex:1; justify-content:center; }
    .tab-nav-btn i { font-size:0.7rem; opacity:0.85; }
    .tab-nav-btn:hover { background:#f8f9fa; color:#495057; }
    .tab-nav-btn.active { background:linear-gradient(135deg, var(--primary-color,#2563eb), var(--secondary-color,#0ea5e9)); color:#fff; box-shadow:0 4px 15px rgba(37,99,235,0.25); }
    .tab-content { display:none; animation: fadeIn .25s ease; }
    .tab-content.active { display:block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(4px);} to { opacity:1; transform:translateY(0);} }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }


        .btn-edit {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc02;
        }

        .btn-edit:hover {
            background: #ffcc02;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        .btn-delete:hover {
            background: #ffcdd2;
            transform: translateY(-1px);
        }


        .distribution-id {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            border-left: 3px solid var(--distribution-color);
        }

        .equipment-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .equipment-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .equipment-details {
            font-size: 0.8rem;
            color: #666;
        }

        .fuel-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            align-items: flex-start;
        }

        .fuel-quantity {
            font-weight: 600;
            color: #2c3e50;
        }

        .fuel-cost {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }


        .date-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            font-size: 0.85rem;
        }

        .requested-date {
            color: #2c3e50;
            font-weight: 500;
        }

        .scheduled-date {
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
        }

        .no-data i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        .loading-container {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--distribution-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            gap: 0.5rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--distribution-color);
            color: white;
            border-color: var(--distribution-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--distribution-color);
            color: white;
            border-color: var(--distribution-color);
        }

        .pagination-info {
            margin: 0 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        /* Hide list pagination controls when on analytics tab */
        #analyticsSection:has(~ .pagination),
        #analyticsSection .pagination {
            display: none !important;
        }
        /* Mobile responsiveness for table */
        @media (max-width: 1024px) {
            .table-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .search-input {
                width: 100%;
            }

            .search-input:focus {
                width: 100%;
            }

            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .table-container {
                margin: 1rem -0.5rem 0;
                border-radius: 0;
            }

            .table-header {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
            }

            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .table-actions {
                flex-direction: column;
                gap: 0.3rem;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Modal Base Styles */
        .modal {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(3px);
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: none;
            transition: none;
            position: relative;
        }

        

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            background: transparent;
            color: inherit;
            padding: 0;
        }

        .modal-header h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #2c3e50; /* Explicit neutral color */
        }

        .modal-header h5 i {
            color: #2c3e50; /* Ensure icon also uses neutral color */
        }

        /* No auto icon for header in staff style */

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover { color: #333; }

        .modal-body { padding: 0; }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .form-section h3 {
            color: var(--distribution-color);
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group label.required::after {
            content: ' *';
            color: #e74c3c;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--distribution-color);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            transition: all 0.3s ease;
            background: white;
        }

        .checkbox-item:hover {
            border-color: var(--distribution-color);
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
            accent-color: var(--distribution-color);
            transform: scale(1.2);
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .safety-progress {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
        }

        .safety-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .safety-progress-text {
            font-weight: 500;
            color: #333;
        }

        .safety-progress-percentage {
            font-weight: 600;
            color: var(--distribution-color);
        }

        .safety-progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .safety-progress-bar {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e0e0e0;
        }

        .btn-submit {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-submit:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
            transform: translateY(-2px);
        }

        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .form-section h3 {
            color: var(--distribution-color);
        }

        .form-control:focus {
            border-color: var(--distribution-color);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .checkbox-item:hover {
            border-color: var(--distribution-color);
        }

        .checkbox-item input[type="checkbox"] {
            accent-color: var(--distribution-color);
        }

        .btn-submit {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-submit:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .modal-header h2::before {
            content: '\f52f';
        }

        /* Remove colored header for Report Preview modal */
        #reportPreviewModal .modal-header {
            background: transparent !important;
        }

        /* Enhanced form grid for better layout */
        .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        /* Enhanced safety progress styling */
        .safety-progress-bar {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        /* Form section specific styling - colors removed */
        .form-section h3 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Enhanced validation styling */
        .form-control.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Enhanced checkbox styling */
        .checkbox-item input[type="checkbox"]:checked + label {
            font-weight: 600;
            color: #27ae60;
        }

        .checkbox-item input[type="checkbox"]:required + label::after {
            content: ' *';
            color: #e74c3c;
            font-weight: bold;
        }

        /* Loading state enhancements */
        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-spinner {
            margin-right: 0.5rem;
        }

        /* Mobile responsiveness for modal */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1rem;
            }
        }

        /* Modal table responsiveness */
        .modal .data-table {
            font-size: 0.65rem;
            min-width: auto;
        }
        
        .modal .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-width: 100%;
        }
        
        /* Ensure modal tables fit within container */
        #modelPreviewModal .data-table,
        #reportPreviewModal .data-table {
            width: 100%;
            min-width: 500px;
            table-layout: fixed;
        }
        
        #modelPreviewModal .data-table th,
        #modelPreviewModal .data-table td,
        #reportPreviewModal .data-table th,
        #reportPreviewModal .data-table td {
            padding: 4px 6px;
            font-size: 0.6rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Chart containers in modals */
        #modelPreviewModal canvas,
        #reportPreviewModal canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        /* Grid layout adjustments for smaller screens */
        @media (max-width: 1200px) {
            #modelPreviewModal [style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>

    <!-- EmailJS (for sending reports) and jsPDF (for PDF generation) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // Reuse EmailJS public key from staff.html
        window.EMAILJS_PUBLIC_KEY = 'fHs6oaqQgkcPoUwpv';
        window.emailjsPublicKey = 'fHs6oaqQgkcPoUwpv';
        // Initialize immediately if library is loaded
        try {
            if (window.emailjs && !window.__emailjsInitialized) {
                emailjs.init({ publicKey: window.EMAILJS_PUBLIC_KEY });
                window.__emailjsInitialized = true;
                console.log('EmailJS initialized in head with shared public key');
            }
        } catch (e) { console.warn('EmailJS head init failed', e); }
        
        // Fallback initialization on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (window.emailjs && !window.__emailjsInitialized) {
                    emailjs.init({ publicKey: window.EMAILJS_PUBLIC_KEY });
                    window.__emailjsInitialized = true;
                    console.log('EmailJS initialized on DOM ready');
                }
            } catch (e) { console.warn('EmailJS DOM init failed', e); }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Excel handling library (SheetJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Centralized Authentication System (Module imports) -->
    <script type="module" src="js/firebase-config-v8.js"></script>
    <script type="module" src="js/company-data-service.js"></script>
    <script type="module" src="js/auth.js"></script>
    
    <!-- Module Integration Script -->
    <script type="module">
        // Initialize the centralized authentication system
        import AuthManager from './js/auth.js';
        import companyDataService from './js/company-data-service.js';
        
        // Make auth manager available globally for backward compatibility
        window.authManager = new AuthManager();
        window.companyDataService = companyDataService;
        
        // Expose Firebase for direct use if needed
        import { getDatabase, ref, get, set, update, remove } from './js/firebase-config-v8.js';
        window.getDatabase = getDatabase;
        window.ref = ref;
        window.get = get;
        window.set = set;
        window.update = update;
        window.remove = remove;
        
        // Initialize Firebase Storage v8 for profile pictures and file uploads
        window.getStorage = () => window.firebase.storage();
        window.getStorageRef = (path) => window.firebase.storage().ref(path);
        window.uploadToStorage = async (storageRef, file) => {
            return await storageRef.put(file);
        };
        window.getDownloadURL = async (storageRef) => {
            return await storageRef.getDownloadURL();
        };
    </script>
    
    <!-- Immediate Firebase initialization for backward compatibility -->
    <script>
        // Firebase v8 configuration for immediate availability
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 immediately for direct access
        if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
            window.firebase.initializeApp(firebaseConfig);
            console.log('? Firebase v8 initialized immediately for fuel distribution page');
        }
        
        // Ensure Firebase Storage is available
        if (window.firebase && window.firebase.storage) {
            console.log('? Firebase Storage v8 is available');
            // Make storage methods globally available
            window.firebaseStorage = window.firebase.storage();
        } else {
            console.warn('?? Firebase Storage not available');
        }
    </script>
    
    <!-- Complete AuthManager Integration -->
    <script>
        // Complete AuthManager with feature-based authorization
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.currentCompany = null;
                this.db = null;
                this.auth = null;
                this.storage = null;
                this.initializeAuth();
            }

            async initializeAuth() {
                console.log('?? Starting AuthManager initialization...');
                
                try {
                    // Wait for Firebase to be fully loaded
                    if (typeof firebase === 'undefined') {
                        console.error('? Firebase not loaded');
                        return;
                    }

                    // Initialize Firebase services
                    this.auth = firebase.auth();
                    this.db = firebase.database();
                    
                    if (firebase.storage) {
                        this.storage = firebase.storage();
                        console.log('? Firebase Storage initialized');
                    }

                    console.log('? Firebase services initialized');

                    // Set up authentication state listener
                    this.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            console.log('?? User authenticated:', user.email);
                            await this.loadUserRole(user);
                            await this.loadUserCompany();
                            await this.updateUIForAuthenticatedUser();
                            
                            // Apply feature-based menu authorization after authentication
                            try {
                                console.log('?? Triggering feature-based menu authorization...');
                                await updateMenuWithFeatureAuthorization();
                            } catch (error) {
                                console.error('? Error applying feature-based menu authorization:', error);
                                showBasicMenu();
                            }
                        } else {
                            console.log('?? User signed out');
                            this.currentUser = null;
                            this.currentCompany = null;
                            this.redirectToLogin();
                        }
                    });

                } catch (error) {
                    console.error('? Error initializing AuthManager:', error);
                }
            }

            async loadUserRole(firebaseUser) {
                try {
                    console.log('?? Loading user role for:', firebaseUser.email);
                    
                    const userRef = firebase.database().ref(`users/${firebaseUser.uid}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (userSnapshot.exists()) {
                        const userData = userSnapshot.val();
                        console.log('? User data found:', userData);
                        
                        // Merge Firebase user with database user data
                        this.currentUser = {
                            uid: firebaseUser.uid,
                            email: firebaseUser.email,
                            displayName: firebaseUser.displayName,
                            photoURL: firebaseUser.photoURL,
                            ...userData
                        };
                        
                        // Store in session for quick access
                        sessionStorage.setItem('user', JSON.stringify(this.currentUser));
                        
                        console.log('? Current user set:', {
                            email: this.currentUser.email,
                            role: this.currentUser.role,
                            companyId: this.currentUser.companyId
                        });
                    } else {
                        console.log('?? No user data found in database for:', firebaseUser.email);
                        // Create basic user object with Firebase data
                        this.currentUser = {
                            uid: firebaseUser.uid,
                            email: firebaseUser.email,
                            displayName: firebaseUser.displayName,
                            photoURL: firebaseUser.photoURL,
                            role: null,
                            companyId: null
                        };
                    }
                } catch (error) {
                    console.error('? Error loading user role:', error);
                }
            }

            async loadUserCompany() {
                try {
                    if (!this.currentUser || !this.currentUser.companyId) {
                        console.log('?? No company ID found for user');
                        return;
                    }

                    console.log('?? Loading company data for ID:', this.currentUser.companyId);
                    
                    const companyRef = firebase.database().ref(`companies/${this.currentUser.companyId}`);
                    const companySnapshot = await companyRef.once('value');
                    
                    if (companySnapshot.exists()) {
                        this.currentCompany = companySnapshot.val();
                        console.log('? Company loaded:', this.currentCompany.companyName);
                        
                        // Store in session for quick access
                        sessionStorage.setItem('company', JSON.stringify(this.currentCompany));
                        
                        // Update header branding with company data
                        this.updateCompanyBranding();
                        
                    } else {
                        console.log('?? Company not found with ID:', this.currentUser.companyId);
                    }
                } catch (error) {
                    console.error('? Error loading company:', error);
                }
            }

            async updateUIForAuthenticatedUser() {
                try {
                    console.log('?? Updating UI for authenticated user...');
                    
                    if (!this.currentUser) {
                        console.log('?? No current user found');
                        return;
                    }
                    
                    // Get display name
                    let displayName = this.currentUser.displayName;
                    if (!displayName && this.currentUser.firstName && this.currentUser.lastName) {
                        displayName = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                    }
                    if (!displayName) {
                        displayName = this.currentUser.email;
                    }
                    
                    console.log('?? Display name:', displayName);
                    
                    // Update profile button
                    const profileBtn = document.getElementById('profileBtn');
                    if (profileBtn) {
                        // Preload avatar URL to avoid showing initials first
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        // Update profile button image
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Create avatar for dropdown (either real avatar or initials)
                        let dropdownAvatarHtml;
                        if (avatarUrl) {
                            dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            const initials = this.getUserInitials();
                            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                            const backgroundColor = colors[displayName.length % colors.length];
                            
                            dropdownAvatarHtml = `
                                <div class="avatar-initials" style="width: 32px; height: 32px; background-color: ${backgroundColor}; color: white; font-size: 14px; font-weight: 600;">
                                    ${initials}
                                </div>
                            `;
                        }
                        
                        // Update profile dropdown (exact project-list structure: ul > li > a)
                        const profileDropdown = document.getElementById('profileDropdown');
                        if (profileDropdown) {
                            // Build list markup
                            profileDropdown.innerHTML = `
                                <ul>
                                    <li style="padding:0.5rem 0.85rem; font-size:0.62rem; font-weight:600; letter-spacing:0.5px; color:#64748b; border-bottom:1px solid #f1f5f9; text-transform:uppercase;">${this.currentUser.email}</li>
                                    <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                                    <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                                    <li><a href="#" onclick="window.authManager.logout()"><i class="fas fa-sign-out-alt"></i> Sign Out</a></li>
                                </ul>
                            `;
                        }
                        
                        console.log('? Profile UI updated');
                    } else {
                        console.log('?? Profile button not found');
                    }
                    
                } catch (error) {
                    console.error('? Error updating UI:', error);
                }
            }

            getUserInitials() {
                if (!this.currentUser) return '?';
                
                let name = this.currentUser.displayName;
                if (!name && this.currentUser.firstName && this.currentUser.lastName) {
                    name = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                }
                if (!name) {
                    name = this.currentUser.email;
                }
                
                const words = name.split(' ').filter(word => word.length > 0);
                if (words.length >= 2) {
                    return (words[0][0] + words[1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
            }

            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            }

            redirectToLogin() {
                // Clear any stored data
                sessionStorage.removeItem('user');
                sessionStorage.removeItem('company');
                
                // Redirect to login page
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/') {
                    window.location.href = 'index.html';
                }
            }

            logout() {
                if (this.auth) {
                    this.auth.signOut().then(() => {
                        console.log('? User signed out successfully');
                        sessionStorage.removeUser('user');
                        this.currentUser = null;
                        window.location.href = 'index.html';
                    }).catch((error) => {
                        console.error('? Error signing out:', error);
                    });
                } else {
                    // Fallback if auth is not available
                    console.log('?? Auth not available, clearing session and redirecting');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    window.location.href = 'index.html';
                }
            }

            // Utility methods
            getCurrentUser() {
                return this.currentUser;
            }

            updateCompanyBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                const nameEl = document.getElementById('headerCompanyName');
                if (!this.currentCompany) { this.showFallbackBranding(); return; }
                if (nameEl) nameEl.textContent = this.currentCompany.companyName || '';
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoEl) {
                    if (logoUrl) {
                        logoEl.src = logoUrl;
                        logoEl.style.display = 'block';
                    } else {
                        const svg = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || ''));
                        logoEl.src = svg;
                        logoEl.style.display = 'block';
                    }
                }
                if (this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    if (this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                }
            }

            showFallbackBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                if (logoEl) {
                    const svg = this.generateCompanyInitialsSVG('DX');
                    logoEl.src = svg;
                    logoEl.style.display = 'block';
                }
            }

            getCompanyInitials(name) {
                if (!name) return 'CO';
                const parts = name.trim().split(/\s+/);
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }

            generateCompanyInitialsSVG(initials) {
                const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
                return 'data:image/svg+xml;base64,' + btoa(svg);
            }

            getCurrentCompany() {
                return this.currentCompany;
            }
        }

        // Reset menu visibility function
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Show basic menu function
        function showBasicMenu() {
            console.log('?? Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            // Show basic menu items for fuel distribution page
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
                console.log('? Showing home menu item as fallback');
            }
            
            // Show fuel management dropdown and fuel distribution since we're on the fuel distribution page
            const fuelDropdown = document.querySelector('[data-feature="fuel_management"]');
            const fuelDistItem = document.querySelector('[data-feature="fuel_distribution"]');
            
            if (fuelDropdown) {
                fuelDropdown.classList.add('menu-visible');
                console.log('? Showing fuel management dropdown as fallback');
            }
            
            if (fuelDistItem) {
                fuelDistItem.classList.add('menu-visible');
                console.log('? Showing fuel distribution item as fallback');
            }
            
            // Show communication as basic item
            const communicationItem = document.querySelector('[data-feature="communication_view"]');
            if (communicationItem) {
                communicationItem.classList.add('menu-visible');
                console.log('? Showing communication menu as fallback');
            }
        }

        // Flag to prevent multiple simultaneous executions
        let isMenuUpdateInProgress = false;

        // Feature-based authorization system that takes priority over role permissions
    async function updateMenuWithFeatureAuthorization() {
            // Prevent multiple simultaneous executions
            if (isMenuUpdateInProgress) {
                console.log('?? Menu update already in progress, skipping...');
                return;
            }
            
            isMenuUpdateInProgress = true;
            console.log('?? Starting feature-based menu authorization for fueldist.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('?? Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('?? Using Firebase auth - will search for company');
                } else {
                    console.log('? No authenticated user found');
                    resetMenuVisibility();
                    showBasicMenu();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('?? Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`? Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('? No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    showBasicMenu();
                    return;
                }
                
                // Apply feature-based authorization
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                // Try to apply role-based filtering if role info is available
                try {
                    const userRole = (window.authManager && window.authManager.currentUser && (window.authManager.currentUser.role || window.authManager.currentUser.userRole)) || null;
                    if (userRole) {
                        await applyRoleBasedFiltering(companyId, userRole, authorizedPages || []);
                    } else {
                        showSidebarAfterAuth();
                    }
                } catch (e) {
                    console.warn('?? Role-based filtering skipped due to error:', e);
                    showSidebarAfterAuth();
                }
                
            } catch (error) {
                console.error('? Error in feature-based menu authorization:', error);
                resetMenuVisibility();
                showBasicMenu();
            } finally {
                isMenuUpdateInProgress = false;
            }
        }

        // Apply feature-based menu visibility
    async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('? Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('?? No platform features found');
                    resetMenuVisibility();
                    showBasicMenu();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('? Company data not found');
                    resetMenuVisibility();
                    showBasicMenu();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('?? Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('?? Company has no subscribed features');
                    resetMenuVisibility();
                    showBasicMenu();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`?? Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`?? Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('?? All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('?? Authorized features for fueldist.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`? Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`? Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`? Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`? Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`?? Feature-based menu authorization completed for fueldist.html - ${visibleCount} items visible`);
                
                // Remove loading class after successful authorization
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                // If no items are visible, show basic menu as fallback
                if (visibleCount === 0) {
                    console.log('?? No menu items visible, showing basic menu as fallback');
                    showBasicMenu();
                }
                // Return authorizedPages for role-based filtering
                return authorizedPages;
                
            } catch (error) {
                console.error('? Error applying feature-based menu visibility:', error);
                showBasicMenu();
                return [];
            }
        }

        // Hide menu items that require permissions (for users without role permissions)
        function hideItemsRequiringPermissions() {
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            itemsRequiringPermissions.forEach(item => item.classList.remove('menu-visible'));
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length === 0) dropdown.classList.remove('menu-visible');
            });
            ensureHomeIsVisible();
        }

        // Ensure home menu item is visible as fallback
        function ensureHomeIsVisible() {
            const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
            if (homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
        }

        // Show sidebar and remove loading state after authentication and filtering
        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('menu-loading');
        }

        // Apply role-based filtering within company authorized features
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                if (!permissionsSnapshot.exists()) {
                    if (userRole === 'administrator') {
                        showSidebarAfterAuth();
                        return;
                    }
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                const permissions = permissionsSnapshot.val();
                filterMenuByPermissions(permissions);
            } catch (error) {
                console.error('? Error applying role-based filtering:', error);
                showSidebarAfterAuth();
            }
        }

        // Filter currently visible menu items by role permissions
        function filterMenuByPermissions(permissions) {
            const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            visibleMenuItems.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const hasPermission = permissions[requiresPermission];
                const hasView = hasPermission === true || (hasPermission && hasPermission.view === true);
                if (!hasView) item.classList.remove('menu-visible');
            });
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const dropdownRequires = dropdown.getAttribute('data-requires-permission');
                if (submenuItems.length === 0) {
                    if (dropdownRequires) {
                        const perm = permissions[dropdownRequires];
                        const ok = perm === true || (perm && perm.view === true);
                        if (!ok) dropdown.classList.remove('menu-visible');
                    } else {
                        dropdown.classList.remove('menu-visible');
                    }
                }
            });
            ensureHomeIsVisible();
            showSidebarAfterAuth();
        }

        // Make the function globally available
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
        
        // Initialize authentication system
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the centralized auth manager
            console.log('?? Initializing AuthManager for fuel distribution page');
            window.authManager = new AuthManager();
            
            // The AuthManager will handle feature-based authorization automatically
            // when the user is authenticated via the onAuthStateChanged listener
            console.log('? AuthManager initialization completed - waiting for authentication state');
        });

        // Initialize menu authorization like project-list.html
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.add('menu-loading');
            setTimeout(() => {
                if (typeof updateMenuWithFeatureAuthorization === 'function') {
                    updateMenuWithFeatureAuthorization();
                }
            }, 500);
        });
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
    <nav id="sidebar" class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                    <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    	<ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    	</ul>
                    </li>
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html" class="active">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
						<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
</ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <!-- Project Management section (parity with project-list.html) -->
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>

                <!-- Inventory Management section (parity with project-list.html) -->
                <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                    <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                    <ul class="submenu">
                        <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                        <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                        <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                        <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                    </ul>
                </li>

                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
    <main id="mainContent" class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <!-- Notifications -->
                    <div class="notifications">
                        <button class="notification-btn" onclick="toggleNotifications()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Notifications</h3>
                                <button class="mark-all-read" onclick="markAllAsRead()">Mark all as read</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <p style="padding: 1rem; text-align: center; color: #666;">No new notifications</p>
                            </div>
                        </div>
                    </div>

                    <!-- User Profile -->
                    <div class="user-profile">
                        <button class="profile-btn" id="profileBtn" onclick="toggleProfileDropdown()">
                            <img src="https://via.placeholder.com/40" alt="User Avatar" id="userAvatar">
                        </button>
                        <div class="profile-dropdown" id="profileDropdown">
                            <!-- Dynamic content will be inserted here by AuthManager -->
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content">
                <div class="page-header">
                    <div class="page-header-left" style="display:flex; align-items:center; gap:0.6rem;">
                        <img id="phCompanyLogo" alt="Company Logo" style="width:34px; height:34px; object-fit:contain; display:none; border-radius:6px; background:#ffffff22; padding:2px;">
                        <div class="ph-company-meta" style="display:flex; flex-direction:column; line-height:1.1;">
                            <span id="phCompanyName" style="font-size:0.7rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; opacity:0.85;"></span>
                            <h1 style="display:flex; align-items:center; gap:0.5rem; font-size:0.9rem; margin:0; font-weight:600; color:#fff;"><i class="fas fa-gas-pump"></i> Fuel Distribution Management</h1>
                        </div>
                    </div>
                    <div class="page-actions">
                        <button class="btn-add-new" onclick="openDistributionModal()" title="Create New Distribution">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Quick Stats Cards removed per request -->

                <!-- Tabs Navigation (Contract style) -->
                <div class="content-tabs">
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" id="fuelTabListBtn" onclick="switchFuelTab('list')"><i class="fas fa-list"></i> List</button>
                        <button class="tab-nav-btn" id="fuelTabAnalyticsBtn" onclick="switchFuelTab('analytics')"><i class="fas fa-chart-line"></i> Analytics</button>
                        <button class="tab-nav-btn" id="fuelTabReportsBtn" onclick="switchFuelTab('reports')"><i class="fas fa-file-alt"></i> Reports</button>
                    </div>
                </div>

                <!-- Tab: List -->
                <div class="tab-content active" id="fuelListTabContent">
                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title" style="display:none;"></h2>
                        <div class="table-controls">
                            <!-- search removed per request -->
                        </div>
                    </div>
                    
                    <div class="table-scroll">
                        <table class="data-table" id="distributionTable">
                            <thead>
                                <tr>
                                    <th class="hidden-col">ID</th>
                                    <th class="hidden-col">Equip. Type</th>
                                    <th>
                                        Equip. ID
                                        <div class="filter-container">
                                            <select class="column-filter" data-column="2">
                                                <option value="">All Equip IDs</option>
                                            </select>
                                        </div>
                                    </th>
                                    <th>
                                        Location
                                        <div class="filter-container">
                                            <select class="column-filter" data-column="3">
                                                <option value="">All Locations</option>
                                            </select>
                                        </div>
                                    </th>
                                    <th>
                                        Site
                                        <div class="filter-container">
                                            <select class="column-filter" data-column="4">
                                                <option value="">All Sites</option>
                                            </select>
                                        </div>
                                    </th>
                                    <th>
                                        Operator
                                        <div class="filter-container">
                                            <select class="column-filter" data-column="5">
                                                <option value="">All Operators</option>
                                            </select>
                                        </div>
                                    </th>
                                    <th>
                                        Quantity (L)
                                        <div class="filter-container">
                                            <input type="number" class="column-filter" data-column="6" placeholder="Min qty..." />
                                        </div>
                                    </th>
                                    <th>
                                        Index
                                        <div class="filter-container">
                                            <input type="number" class="column-filter" data-column="7" placeholder="Min index..." />
                                        </div>
                                    </th>
                                    <th>
                                        Consumption
                                        <div class="filter-container">
                                            <input type="date" class="column-filter" data-column="8" />
                                        </div>
                                    </th>
                                    <th>
                                        Department
                                        <div class="filter-container">
                                            <select class="column-filter" data-column="9">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                    </th>
                                    <th class="hidden-col">Cost Center</th>
                                    <th class="hidden-col">Security Agent</th>
                                    <th class="hidden-col">Supervisor</th>
                                    <th class="hidden-col">Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="distributionTableBody">
                                <!-- Distribution records will be populated here -->
                            </tbody>
                        </table>
                        
                        <!-- Loading State -->
                        <div class="loading-container" id="tableLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Loading distribution records...</p>
                        </div>
                        
                        <!-- No Data State -->
                        <div class="no-data" id="noDataMessage" style="display: none;">
                            <i class="fas fa-truck-loading"></i>
                            <h3>No Distribution Records Found</h3>
                            <p>No fuel distribution records match your current filters.</p>
                            <button class="btn btn-create" onclick="openDistributionModal()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="tablePagination" style="display: none;">
                        <button class="pagination-btn" id="prevBtn" onclick="changePage('prev')" disabled>
                            <i class="fas fa-chevron-left"></i>
                            Previous
                        </button>
                        <span class="pagination-info" id="paginationInfo">Showing 0 - 0 of 0 records</span>
                        <button class="pagination-btn" id="nextBtn" onclick="changePage('next')" disabled>
                            Next
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div> <!-- end table-container -->
                </div> <!-- end list tab -->

                <!-- Tab: Analytics -->
                <div class="tab-content" id="fuelAnalyticsTabContent">
                <div id="analyticsSection" style="margin-top:0.75rem;">
                    <!-- Custom Multi Chart/Table Builder Placeholder -->
                    <div id="analyticsMultiBuilderMount"></div>
                    <!-- Removed legacy analytics controls bar (Category / Date / KPIs / Export) per request -->
                    <div id="analyticsControlsStub" style="display:none">
                        <select id="analyticsCategory"><option value="day" selected>By Day</option></select>
                        <input id="analyticsDateStart" type="date" />
                        <input id="analyticsDateEnd" type="date" />
                        <div id="analyticsInlineKpis"></div>
                        <div id="categoryValueFilter"></div>
                        <div id="analyticsValueDropdown"></div>
                        <div id="analyticsValueDropdownMenu"></div>
                    </div>
                    <div id="analyticsStatus" style="font-size:0.6rem;color:#475569;margin:0.2rem 0 0.6rem 0;"></div>
                    
                    <!-- Initial table/chart suppressed; user must add via Custom Builder 'Add Analytics Set' button -->

                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;margin-top:0.8rem;">
                        <h4 style="margin:0 0 0.4rem 0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;">SAVED ANALYTICS MODELS</h4>
                        <div class="table-scroll" style="max-height:220px;">
                            <table class="data-table" style="font-size:0.6rem;min-width:700px;">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Date Range</th>
                                        <th>Values</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsModelsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div> <!-- end analyticsSection -->
                </div> <!-- end analytics tab -->

                <!-- Tab: Reports -->
                <div class="tab-content" id="fuelReportsTabContent">
                    <div id="reportsInlineStatus" style="margin:0 0 .4rem 0;font-size:.6rem;color:#475569;"></div>
                    <div id="reportsSection" style="margin-top:0.75rem;">
                        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;margin-top:0.8rem;">
                            <h4 style="margin:0 0 0.4rem 0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;">GENERATED REPORTS</h4>
                            <div class="table-scroll" style="max-height:260px;">
                                <table class="data-table" style="font-size:0.6rem;min-width:900px;">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Category</th>
                                            <th>Date Range</th>
                                            <th>Created</th>
                                            <th>File</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportGeneratedBody"></tbody>
                                </table>
                            </div>
                            <div id="reportsEmptyState" style="display:none;font-size:0.6rem;color:#64748b;padding:0.4rem 0;">No reports generated yet.</div>
                        </div>
                    </div>
                </div> <!-- end reports tab -->
            </div>
        </div>

    <!-- Fuel Distribution Modal -->
        <div class="modal" id="distributionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><i class="fas fa-gas-pump"></i> Record Fuel Consumption</h5>
                    <button class="close-btn" onclick="closeDistributionModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="distributionForm" onsubmit="submitDistribution(event)">
                        <div class="form-grid">
                            <!-- Equipment Information Section -->
                            <div class="form-section">
                                <h3><i class="fas fa-cog"></i> Equipment Information</h3>
                                
                                <div class="form-group">
                                    <label for="equipmentType" class="required">Equipment Type</label>
                                    <select id="equipmentType" class="form-control" required onchange="updateEquipmentOptions()">
                                        <option value="">Select Equipment Type</option>
                                        <option value="Vehicles">Vehicles</option>
                                        <option value="Generators">Generators</option>
                                        <option value="Tank">Tank</option>
                                    </select>
                                    <div class="error-message" id="equipmentTypeError"></div>
                                </div>

                                <div class="form-group">
                                    <label for="equipmentId" class="required">Equipment ID/Registration</label>
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <input type="text" id="equipmentSearch" class="form-control" placeholder="Type to search equipment..." oninput="filterEquipmentOptions()" style="flex:1;">
                                        <select id="equipmentId" class="form-control" required style="flex:1;">
                                            <option value="">Select equipment</option>
                                        </select>
                                    </div>
                                    <div class="error-message" id="equipmentIdError"></div>
                                </div>

                                <div class="form-group">
                                    <label for="site">Site</label>
                                    <select id="site" class="form-control">
                                        <option value="">Select Site</option>
                                    </select>
                                </div>

                                <div class="form-group" id="locationGroup" style="display:none; gap:12px; align-items:flex-start;">
                                    <div style="flex:1; min-width:0;">
                                        <label for="equipmentLocation">Current Location</label>
                                        <select id="equipmentLocation" class="form-control">
                                            <option value="">Select Location</option>
                                            <option value="MAIN_YARD">Main Yard</option>
                                            <option value="WORKSHOP">Workshop</option>
                                            <option value="STORAGE_AREA">Storage Area</option>
                                            <option value="LOADING_BAY">Loading Bay</option>
                                            <option value="FIELD_SITE_A">Field Site A</option>
                                            <option value="FIELD_SITE_B">Field Site B</option>
                                            <option value="OFFSHORE">Offshore Location</option>
                                            <option value="OTHER">Other Location</option>
                                        </select>
                                    </div>
                                    <div style="flex:1; min-width:0;">
                                        <label for="operatorName">Operator/Driver Name</label>
                                        <input type="text" id="operatorName" class="form-control" 
                                               placeholder="Enter operator or driver name">
                                    </div>
                                </div>
                            </div>

                            <!-- Fuel Requirements Section -->
                            <div class="form-section">
                                <h3><i class="fas fa-gas-pump"></i> Fuel Requirements</h3>
                                
                                

                                <div class="form-group" style="display:flex; gap:12px; align-items:flex-start;">
                                    <div style="flex:1; min-width:0;">
                                        <label for="requestedQuantity" class="required">Quantity (Liters)</label>
                         <input type="text" id="requestedQuantity" class="form-control" required 
                             placeholder="Enter quantity in liters"
                             inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" title="Enter a positive number; decimals allowed">
                                        <div class="error-message" id="requestedQuantityError"></div>
                                    </div>

                                    <div style="flex:1; min-width:0;">
                                        <label for="meterIndex">Index Reading</label>
                                        <input type="number" id="meterIndex" class="form-control" min="0" step="0.01" placeholder="Enter meter index reading">
                                        <div class="error-message" id="meterIndexError"></div>
                                    </div>
                                </div>

                                
                            </div>

                            <!-- Distribution Details Section -->
                            <div class="form-section">
                                <h3><i class="fas fa-calendar-alt"></i> Consumption Time</h3>
                                
                                <div class="form-group">
                                    <label for="scheduledDateTime" class="required">Consumption Date & Time</label>
                                    <input type="datetime-local" id="scheduledDateTime" class="form-control" required>
                                    <div class="error-message" id="scheduledDateTimeError"></div>
                                </div>

                                
                            </div>

                            <!-- Authorization Section -->
                            <div class="form-section">
                                <h3><i class="fas fa-user-check"></i> Authorization</h3>
                                
                                <div class="form-group">
                     <label for="requestedBy" class="required">Operator</label>
                     <input type="text" id="requestedBy" class="form-control" required 
                         placeholder="Enter operator name">
                                    <div class="error-message" id="requestedByError"></div>
                                </div>

                                <div class="form-group">
                                    <label for="department">Department</label>
                                    <select id="department" class="form-control">
                                        <option value="">Select Department</option>
                                        <option value="OPERATIONS">Operations</option>
                                        <option value="MAINTENANCE">Maintenance</option>
                                        <option value="LOGISTICS">Logistics</option>
                                        <option value="DRILLING">Drilling</option>
                                        <option value="PRODUCTION">Production</option>
                                        <option value="HSE">Health, Safety & Environment</option>
                                        <option value="ADMIN">Administration</option>
                                        <option value="SECURITY">Security</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="costCenter">Cost Center</label>
                                    <input type="text" id="costCenter" class="form-control" 
                                           placeholder="Enter cost center code">
                                </div>

                                <div class="form-group">
                                    <label for="securityAgent">Security Agent</label>
                                    <input type="text" id="securityAgent" class="form-control" 
                                           placeholder="Enter security agent name">
                                </div>

                                <div class="form-group">
                                    <label for="supervisor">Supervisor</label>
                                    <input type="text" id="supervisor" class="form-control" 
                                           placeholder="Enter supervisor name">
                                </div>

                                
                            </div>
                            
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDistributionModal()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button type="submit" form="distributionForm" class="btn btn-primary" id="submitBtn">
                        <span class="loading-spinner" id="loadingSpinner" style="display:none"></span>
                        <i class="fas fa-check" id="submitIcon"></i>
                        Record Consumption
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Preview Modal (from Analytics saved models) -->
        <div class="modal" id="reportPreviewModal">
            <div class="modal-content" style="max-width: 1600px; width: 96%;">
                <div class="modal-header">
                    <h5><i class="fas fa-file-alt"></i> <span id="reportPreviewTitle">Report Preview</span></h5>
                    <button class="close-btn" onclick="closeReportPreviewModal()">&times;</button>
                </div>
                <div class="modal-body" style="padding:0.4rem 0;max-height:calc(96vh - 120px);overflow-y:auto;">
                    <div id="reportPreviewMeta" style="font-size:0.8rem;color:#475569;margin:0 0.75rem 0.5rem 0.75rem;"></div>
                    <div id="reportPreviewStatus" style="font-size:0.8rem;color:#475569;margin:0 0.75rem 0.5rem 0.75rem;"></div>
                    <div style="margin:0 0.75rem 0.6rem 0.75rem;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;height:calc(80vh * 0.3);display:flex;flex-direction:column;">
                        <h4 style="margin:0 0 0.4rem 0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;">CHART</h4>
                        <canvas id="reportPreviewChart" style="flex:1;height:100%;"></canvas>
                    </div>
                    <div class="table-scroll" style="max-height:320px;margin:0 0.75rem;">
                        <table class="data-table" style="font-size:0.72rem;min-width:700px;">
                            <thead><tr id="reportPreviewHead"></tr></thead>
                            <tbody id="reportPreviewBody"></tbody>
                        </table>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin:0.6rem 0.75rem 0 0.75rem;font-size:0.8rem;color:#475569;">
                        <div>Rows: <span id="reportPreviewRowCount">0</span>  Total Liters: <span id="reportPreviewTotalLiters">0</span> L</div>
                        <div style="display:flex;gap:0.4rem;">
                            <button type="button" class="action-btn" style="background:#334155;color:#fff;padding:0.35rem 0.6rem;font-size:0.72rem;" onclick="closeReportPreviewModal()">Close</button>
                        </div>
                    </div>

                    <div style="margin:0.75rem;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;">
                        <h4 style="margin:0 0 0.4rem 0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;">Report Configuration</h4>
                        <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:flex-start;">
                            <div style="display:flex;flex-direction:column;gap:0.25rem;min-width:320px;">
                                <label style="font-size:0.55rem;font-weight:600;color:#475569;letter-spacing:0.5px;">DATE RANGE</label>
                                <div style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">
                                    <input id="modalReportDateStart" type="date" style="font-size:0.6rem;padding:0.25rem 0.4rem;border:1px solid #cbd5e1;border-radius:4px;" />
                                    <span style="font-size:0.55rem;color:#64748b;">to</span>
                                    <input id="modalReportDateEnd" type="date" style="font-size:0.6rem;padding:0.25rem 0.4rem;border:1px solid #cbd5e1;border-radius:4px;" />
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:0.25rem;min-width:260px;">
                                <label style="font-size:0.55rem;font-weight:600;color:#475569;letter-spacing:0.5px;">FREQUENCY</label>
                                <select id="modalReportFrequency" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;min-width:220px;">
                                    <option value="one-time" selected>One-time</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                                <label style="font-size:0.55rem;font-weight:600;color:#475569;letter-spacing:0.5px;">START ON</label>
                                <input id="modalReportStartOn" type="datetime-local" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;min-width:220px;" />
                            </div>
                            <div style="display:flex;flex-direction:column;gap:0.25rem;min-width:320px;">
                                <label style="font-size:0.55rem;font-weight:600;color:#475569;letter-spacing:0.5px;">RECIPIENTS (Company Users)</label>
                                <div id="modalRecipientsDropdown" style="position:relative;min-width:280px;">
                                    <button type="button" id="modalRecipientsDropdownBtn" onclick="toggleModalRecipientsDropdown()" style="width:100%;text-align:left;font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:0.5rem;">
                                        <span>Select recipients</span>
                                        <i class="fas fa-chevron-down" style="font-size:0.7rem;color:#64748b;"></i>
                                    </button>
                                    <div id="modalRecipientsDropdownMenu" style="display:none;position:absolute;z-index:10;left:0;right:0;background:#fff;border:1px solid #e2e8f0;border-radius:6px;margin-top:4px;max-height:220px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:6px;"></div>
                                </div>
                                <div id="modalRecipientsSelected" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;"></div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:0.25rem;min-width:280px;">
                                <label style="font-size:0.55rem;font-weight:600;color:#475569;letter-spacing:0.5px;">ADDITIONAL EMAILS (comma-separated)</label>
                                <input id="modalReportEmails" type="text" placeholder="someone@company.com, other@company.com" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;min-width:260px;" />
                            </div>
                            <div style="display:flex;flex-direction:column;gap:0.25rem;min-width:320px;flex:1;">
                                <label style="font-size:0.55rem;font-weight:600;color:#475569;letter-spacing:0.5px;">EMAIL SUBJECT & MESSAGE</label>
                                <input id="modalReportEmailSubject" type="text" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;" />
                                <textarea id="modalReportEmailMessage" rows="2" placeholder="Add an optional note to recipients..." style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;resize:vertical;"></textarea>
                            </div>
                            <div style="display:flex;gap:0.5rem;margin-left:auto;flex-wrap:wrap;align-items:center;">
                                <button type="button" onclick="scheduleReportFromModal()" style="font-size:0.55rem;padding:0.35rem 0.6rem;background:#64748b;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;">SAVE SCHEDULE</button>
                                <button type="button" onclick="generateAndSaveFuelReportFromModal()" style="font-size:0.55rem;padding:0.35rem 0.6rem;background:#0ea5e9;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;">GENERATE PDF</button>
                                <button type="button" onclick="sendFuelReportFromModal()" style="font-size:0.55rem;padding:0.35rem 0.6rem;background:#16a34a;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;">SEND REPORT</button>
                            </div>
                        </div>
                        <div id="modalReportStatus" style="font-size:0.6rem;color:#475569;margin-top:0.4rem;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consumption Details View Modal -->
        <div class="modal" id="distributionViewModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><i class="fas fa-gas-pump"></i> Consumption Details</h5>
                    <button class="close-btn" onclick="closeViewModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-grid">
                        <!-- Equipment Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-cog"></i> Equipment Information</h3>
                            <div class="form-group">
                                <label>Equipment Type</label>
                                <div class="form-control" id="viewEquipmentType" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Equipment ID/Registration</label>
                                <div class="form-control" id="viewEquipmentId" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Site</label>
                                <div class="form-control" id="viewSite" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group" style="display:flex; gap:12px; align-items:flex-start;">
                                <div style="flex:1; min-width:0;">
                                    <label>Current Location</label>
                                    <div class="form-control" id="viewEquipmentLocation" style="background:#f8f9fa"></div>
                                </div>
                                <div style="flex:1; min-width:0;">
                                    <label>Operator/Driver Name</label>
                                    <div class="form-control" id="viewOperatorName" style="background:#f8f9fa"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Site</label>
                                <div class="form-control" id="viewSite" style="background:#f8f9fa"></div>
                            </div>
                        </div>

                        <!-- Fuel Requirements -->
                        <div class="form-section">
                            <h3><i class="fas fa-gas-pump"></i> Fuel Details</h3>
                            <div class="form-group" style="display:flex; gap:12px; align-items:flex-start;">
                                <div style="flex:1; min-width:0;">
                                    <label>Quantity (Liters)</label>
                                    <div class="form-control" id="viewQuantity" style="background:#f8f9fa"></div>
                                </div>
                                <div style="flex:1; min-width:0;">
                                    <label>Index Reading</label>
                                    <div class="form-control" id="viewIndexReading" style="background:#f8f9fa"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Consumption Time -->
                        <div class="form-section">
                            <h3><i class="fas fa-calendar-alt"></i> Consumption Time</h3>
                            <div class="form-group">
                                <label>Consumption Date & Time</label>
                                <div class="form-control" id="viewConsumptionDateTime" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Recorded At</label>
                                <div class="form-control" id="viewRecordedAt" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <div class="form-control" id="viewStatus" style="background:#f8f9fa"></div>
                            </div>
                        </div>

                        <!-- Authorization -->
                        <div class="form-section">
                            <h3><i class="fas fa-user-check"></i> Authorization</h3>
                            <div class="form-group">
                                <label>Operator</label>
                                <div class="form-control" id="viewRequestedBy" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <div class="form-control" id="viewDepartment" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Cost Center</label>
                                <div class="form-control" id="viewCostCenter" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Security Agent</label>
                                <div class="form-control" id="viewSecurityAgent" style="background:#f8f9fa"></div>
                            </div>
                            <div class="form-group">
                                <label>Supervisor</label>
                                <div class="form-control" id="viewSupervisor" style="background:#f8f9fa"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeViewModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
        </main>
    </div>

    <!-- Basic JavaScript Functions -->
    <script>
        // Sidebar toggle behavior (mirrors project-list.html)
        function initSidebarToggle() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                });
            }
        }

        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            if (!sidebar || !mainContent) return;
            if (window.innerWidth <= 900) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
            }
        }
        window.addEventListener('resize', handleResize);
        window.addEventListener('load', handleResize);
        document.addEventListener('DOMContentLoaded', initSidebarToggle);

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('show');
        }

        // Toggle profile dropdown
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Menu dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add click event listeners to dropdown toggles
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const parentLi = this.closest('li');
                    const submenu = parentLi.querySelector('.submenu');
                    
                    if (submenu) {
                        // Toggle the submenu visibility
                        submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                        
                        // Rotate the chevron icon
                        const chevron = this.querySelector('.fa-chevron-down');
                        if (chevron) {
                            chevron.style.transform = submenu.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0deg)';
                        }
                    }
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-profile')) {
                    const profileDropdown = document.getElementById('profileDropdown');
                    if (profileDropdown) {
                        profileDropdown.classList.remove('show');
                    }
                }
                
                if (!e.target.closest('.notifications')) {
                    const notificationDropdown = document.getElementById('notificationDropdown');
                    if (notificationDropdown) {
                        notificationDropdown.classList.remove('show');
                    }
                }
            });
        });

        // Mark all notifications as read
        function markAllAsRead() {
            const badge = document.getElementById('notificationBadge');
            badge.textContent = '0';
            badge.style.display = 'none';
            
            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = '<p style="padding: 1rem; text-align: center; color: #666;">No new notifications</p>';
            
            toggleNotifications();
        }

        // Open distribution modal (placeholder for Step 2)
        function openDistributionModal() {
            const modal = document.getElementById('distributionModal');
            modal.classList.add('show');
            
            // Initialize form
            initializeDistributionForm();

            // Reset equipment selects
            const typeEl = document.getElementById('equipmentType');
            const idEl = document.getElementById('equipmentId');
            const searchEl = document.getElementById('equipmentSearch');
            if (typeEl) typeEl.value = '';
            if (idEl) { idEl.innerHTML = '<option value="">Select equipment</option>'; }
            if (searchEl) { searchEl.value = ''; }
            
            // Set default scheduled date & time to now rounded to nearest 5 minutes
            const now = new Date();
            now.setSeconds(0, 0);
            const minutes = now.getMinutes();
            now.setMinutes(minutes - (minutes % 5));
            const dtLocal = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            const dtField = document.getElementById('scheduledDateTime');
            if (dtField) dtField.value = dtLocal;
            document.getElementById('requestedBy').value = window.authManager?.getCurrentUser()?.displayName || '';

            // Hide location group initially until site is selected
            const locationGroup = document.getElementById('locationGroup');
            if (locationGroup) {
                locationGroup.style.display = 'none';
            }

            // Load Sites first, then load Tank IDs so filtering can apply
            loadSites().then(() => loadLocationTankIds());
            
            // Update safety progress
            updateSafetyProgress();
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Close distribution modal
        function closeDistributionModal() {
            const modal = document.getElementById('distributionModal');
            modal.classList.remove('show');
            
            // Reset form
            document.getElementById('distributionForm').reset();
            clearFormErrors();
            updateSafetyProgress();
            
            // Remove edit ID if present
            document.getElementById('distributionForm').removeAttribute('data-edit-id');
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        function handleModalClick(event) {
            const modal = document.getElementById('distributionModal');
            const viewModal = document.getElementById('distributionViewModal');
            if (modal && event.target === modal) {
                closeDistributionModal();
                return;
            }
            if (viewModal && event.target === viewModal) {
                closeViewModal();
            }
        }

        // Handle escape key to close modal
        function handleKeyPress(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('distributionModal');
                const viewModal = document.getElementById('distributionViewModal');
                if (modal && modal.classList.contains('show')) {
                    closeDistributionModal();
                    return;
                }
                if (viewModal && viewModal.classList.contains('show')) {
                    closeViewModal();
                }
            }
        }

        // Initialize distribution form
        function initializeDistributionForm() {
            // For consumption: allow past times, prevent future
            const nowIso = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            const dtField = document.getElementById('scheduledDateTime');
            if (dtField) {
                dtField.removeAttribute('min');
                dtField.max = nowIso;
            }
            
            // Add event listeners for real-time validation
            setupFormValidation();
            
            // Initialize safety checklist listeners
            setupSafetyChecklist();

            // Allow easy numeric typing (digits and decimal) across locales
            try {
                const qty = document.getElementById('requestedQuantity');
                if (qty) {
                    qty.setAttribute('inputmode','decimal');
                    qty.setAttribute('pattern','[0-9]*[.,]?[0-9]*');
                    qty.addEventListener('input', (e) => {
                        let v = e.target.value ?? '';
                        // Allow only digits and dot/comma, then normalize
                        v = String(v).replace(',', '.').replace(/[^0-9.]/g, '');
                        // If first char is a dot, keep it as "." to let user type ".5"
                        if (v.startsWith('.')) {
                            // ensure no more dots later
                            v = '.' + v.slice(1).replace(/\./g, '');
                        } else {
                            const firstDot = v.indexOf('.');
                            if (firstDot !== -1) {
                                v = v.slice(0, firstDot + 1) + v.slice(firstDot + 1).replace(/\./g, '');
                            }
                        }
                        // Do not coerce to number here; keep raw string to avoid cursor jumps
                        e.target.value = v;
                    });
                }
            } catch (_) {}
        }

        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('distributionForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('blur', () => validateField(input));
                input.addEventListener('input', () => clearFieldError(input));
            });
        }

        // Setup safety checklist
        function setupSafetyChecklist() {
            const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSafetyProgress);
            });
        }

        // Safety progress (no-op since safety section was removed)
        function updateSafetyProgress() {
            // intentionally left blank
        }

        // Cache for equipment options
        let cachedVehicles = null; // Array of {id, name, plate}
    let cachedGenerators = null; // Array of {id, name}
    let cachedTanks = null; // Array of {id, name} where id=value, name=label from settings

        async function loadVehiclesOnce() {
            if (cachedVehicles) return cachedVehicles;
            const user = window.authManager?.getCurrentUser();
            if (!user?.companyId) return [];
            try {
                const snap = await firebase.database().ref(`companies/${user.companyId}/vehicles`).once('value');
                const result = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const v = child.val() || {};
                        result.push({ id: child.key, name: v.vehicleName || v.name || v.plateNumber || child.key, plate: v.plateNumber || '' });
                    });
                }
                cachedVehicles = result;
                return result;
            } catch (e) {
                console.error('Failed to load vehicles:', e);
                return [];
            }
        }

        async function loadGeneratorsOnce() {
            if (cachedGenerators) return cachedGenerators;
            const user = window.authManager?.getCurrentUser();
            if (!user?.companyId) return [];
            try {
                const snap = await firebase.database().ref(`companies/${user.companyId}/generators`).once('value');
                const result = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const g = child.val() || {};
                        result.push({ id: child.key, name: g.genName || g.name || child.key });
                    });
                }
                cachedGenerators = result;
                return result;
            } catch (e) {
                console.error('Failed to load generators:', e);
                return [];
            }
        }

        function fillEquipmentSelect(options) {
            const select = document.getElementById('equipmentId');
            select.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = options.length ? 'Select equipment' : 'No items found';
            select.appendChild(ph);
            options.forEach(opt => {
                const o = document.createElement('option');
                // Normalize for different item shapes: vehicles {id,name,plate}, generators {id,name}, tanks {id,name}
                const value = (opt.name ?? opt.label ?? opt.value ?? '');
                const display = opt.plate ? `${value} (${opt.plate})` : `${value}`;
                o.value = value; // store display name per existing behavior
                o.textContent = display;
                if (opt.id) o.dataset.id = opt.id;
                select.appendChild(o);
            });
        }

        function filterEquipmentOptions() {
            const type = document.getElementById('equipmentType').value;
            const q = (document.getElementById('equipmentSearch').value || '').toLowerCase();
            let items = [];
            if (type === 'Vehicles') {
                items = (cachedVehicles || []).filter(v =>
                    (v.name || '').toLowerCase().includes(q) || (v.plate || '').toLowerCase().includes(q)
                );
            } else if (type === 'Generators') {
                items = (cachedGenerators || []).filter(g => (g.name || '').toLowerCase().includes(q));
            } else if (type === 'Tank') {
                items = (cachedTanks || []).filter(t => (t.name || '').toLowerCase().includes(q));
            }
            fillEquipmentSelect(items);
        }

        async function updateEquipmentOptions() {
            const equipmentType = document.getElementById('equipmentType').value;
            const select = document.getElementById('equipmentId');
            const search = document.getElementById('equipmentSearch');
            select.disabled = true;
            if (search) search.value = '';
            fillEquipmentSelect([]);

            if (equipmentType === 'Vehicles') {
                const items = await loadVehiclesOnce();
                fillEquipmentSelect(items);
            } else if (equipmentType === 'Generators') {
                const items = await loadGeneratorsOnce();
                fillEquipmentSelect(items);
            } else if (equipmentType === 'Tank') {
                const items = await loadTanksOnce();
                fillEquipmentSelect(items);
            } else {
                fillEquipmentSelect([]);
            }
            select.disabled = false;
        }

        // Load tanks from settings (same source as loadLocationTankIds uses): fieldOptions/tank-id
        async function loadTanksOnce() {
            if (cachedTanks) return cachedTanks;
            try {
                if (!window.firebase) throw new Error('Firebase not available');
                const db = window.firebase.database();
                const fixedPath = 'companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/tank-id';
                const snapshot = await db.ref(fixedPath).once('value');
                const tankIds = snapshot.val();
                const result = [];
                if (Array.isArray(tankIds)) {
                    tankIds.forEach(t => {
                        if (t && (t.enabled === undefined || t.enabled)) {
                            // Normalize to show ID primarily and label as secondary
                            const tankId = t.value ?? t.label ?? '';
                            const label = t.label ?? t.value ?? '';
                            if (tankId && label) result.push({ id: tankId, name: tankId, plate: label });
                        }
                    });
                }
                cachedTanks = result;
                return result;
            } catch (e) {
                console.error('Failed to load tanks:', e);
                return [];
            }
        }

        // Load Tank IDs into Current Location select (same source as fuelstor.html)
        async function loadLocationTankIds(selectedValue) {
            const locSelect = document.getElementById('equipmentLocation');
            if (!locSelect) return;

            // Reset to placeholder
            locSelect.innerHTML = '<option value="">Select Location</option>';

            try {
                if (!window.firebase) throw new Error('Firebase not available');
                const db = window.firebase.database();
                // Using the same fixed path as fuelstor.html for consistency
                const fixedPath = 'companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/tank-id';
                const snapshot = await db.ref(fixedPath).once('value');
                const tankIds = snapshot.val();
                let allowedValues = null;
                // If Site is selected, filter tank IDs by storageStatus where location matches site
                const siteSel = document.getElementById('site');
                const selectedSite = siteSel ? (siteSel.value || '') : '';
                if (selectedSite) {
                    try {
                        const user = window.authManager?.getCurrentUser();
                        const companyId = user?.companyId;
                        if (companyId) {
                            const storageSnap = await db.ref(`companies/${companyId}/fuelmanagement/storageStatus`).once('value');
                            const storageData = storageSnap.val() || {};
                            // Collect tankId values where tank.location matches selectedSite
                            const siteTankIds = Object.values(storageData)
                                .filter(t => (t && (t.location === selectedSite || t.location === (siteSel.options[siteSel.selectedIndex]?.text || selectedSite))))
                                .map(t => t.tankId)
                                .filter(Boolean);
                            allowedValues = new Set(siteTankIds);
                        }
                    } catch (e) {
                        console.warn('Site filter read failed, showing all tank IDs:', e);
                    }
                }

                if (Array.isArray(tankIds)) {
                    tankIds.forEach(tank => {
                        if (tank && tank.enabled) {
                            if (!allowedValues || allowedValues.has(tank.value)) {
                                const option = document.createElement('option');
                                option.value = tank.value;
                                option.textContent = tank.label;
                                locSelect.appendChild(option);
                            }
                        }
                    });
                } else {
                    // Fallback: allow manual entry when settings are not configured
                    addLocationManualEntryOption(locSelect);
                }

                // If a specific value should be selected (e.g., during edit), set it
                if (selectedValue) {
                    // If the value isn't in options yet and isn't empty, insert it for continuity
                    if (![...locSelect.options].some(o => o.value === selectedValue)) {
                        const opt = document.createElement('option');
                        opt.value = selectedValue;
                        opt.textContent = selectedValue;
                        locSelect.appendChild(opt);
                    }
                    locSelect.value = selectedValue;
                }
            } catch (e) {
                console.warn('Unable to load tank IDs for location:', e);
                addLocationManualEntryOption(locSelect);
                if (selectedValue) {
                    const opt = document.createElement('option');
                    opt.value = selectedValue;
                    opt.textContent = selectedValue;
                    locSelect.appendChild(opt);
                    locSelect.value = selectedValue;
                }
            }
        }

        function addLocationManualEntryOption(selectElement) {
            const option = document.createElement('option');
            option.value = 'manual-entry';
            option.textContent = 'Enter Tank ID Manually (Settings Not Configured)';
            selectElement.appendChild(option);

            // Add event listener to allow manual entry
            if (selectElement.dataset.manualEntryAttached !== 'true') {
                selectElement.addEventListener('change', (e) => {
                    if (e.target.value === 'manual-entry') {
                        const manualId = prompt('Enter Tank ID:');
                        if (manualId) {
                            const newOption = document.createElement('option');
                            newOption.value = manualId;
                            newOption.textContent = manualId;
                            newOption.selected = true;
                            selectElement.insertBefore(newOption, selectElement.lastElementChild);
                        }
                    }
                });
                selectElement.dataset.manualEntryAttached = 'true';
            }
        }

        // Load Sites (Locations/Areas) for the new Site field (same as fuelstor.html)
        async function loadSites(selectedValue) {
            const siteSelect = document.getElementById('site');
            if (!siteSelect) return;

            siteSelect.innerHTML = '<option value="">Select Site</option>';

            try {
                if (!window.firebase) throw new Error('Firebase not available');
                const db = window.firebase.database();
                const fixedPath = 'companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area';
                const snapshot = await db.ref(fixedPath).once('value');
                const areas = snapshot.val();

                if (Array.isArray(areas)) {
                    areas.forEach(item => {
                        if (item && (item.enabled === undefined || item.enabled)) {
                            const opt = document.createElement('option');
                            opt.value = item.value ?? item.label ?? '';
                            opt.textContent = item.label ?? item.value ?? '';
                            if (opt.value) siteSelect.appendChild(opt);
                        }
                    });
                } else {
                    addSiteManualEntryOption(siteSelect);
                }

                if (selectedValue) {
                    if (![...siteSelect.options].some(o => o.value === selectedValue)) {
                        const opt = document.createElement('option');
                        opt.value = selectedValue;
                        opt.textContent = selectedValue;
                        siteSelect.appendChild(opt);
                    }
                    siteSelect.value = selectedValue;
                }
            } catch (e) {
                console.warn('Unable to load sites:', e);
                addSiteManualEntryOption(siteSelect);
                if (selectedValue) {
                    const opt = document.createElement('option');
                    opt.value = selectedValue;
                    opt.textContent = selectedValue;
                    siteSelect.appendChild(opt);
                    siteSelect.value = selectedValue;
                }
            }
        }

        function addSiteManualEntryOption(selectElement) {
            const opt = document.createElement('option');
            opt.value = 'manual-entry';
            opt.textContent = 'Enter Site Manually (Settings Not Configured)';
            selectElement.appendChild(opt);
            if (selectElement.dataset.siteManualAttached !== 'true') {
                selectElement.addEventListener('change', (e) => {
                    if (e.target.value === 'manual-entry') {
                        const manual = prompt('Enter Site name:');
                        if (manual) {
                            const newOpt = document.createElement('option');
                            newOpt.value = manual;
                            newOpt.textContent = manual;
                            newOpt.selected = true;
                            selectElement.insertBefore(newOpt, selectElement.lastElementChild);
                        }
                    }
                });
                selectElement.dataset.siteManualAttached = 'true';
            }
        }

        // Refilter Current Location when Site changes and show/hide location field
        document.addEventListener('DOMContentLoaded', function() {
            const siteEl = document.getElementById('site');
            const locationGroup = document.getElementById('locationGroup');
            
            if (siteEl && locationGroup) {
                siteEl.addEventListener('change', function() {
                    const selectedSite = this.value;
                    
                    if (selectedSite) {
                        // Show location field and reload options based on Site
                        locationGroup.style.display = 'flex';
                        loadLocationTankIds('');
                    } else {
                        // Hide location field when no site is selected
                        locationGroup.style.display = 'none';
                        // Clear current location selection
                        const locationEl = document.getElementById('equipmentLocation');
                        if (locationEl) {
                            locationEl.value = '';
                        }
                    }
                });
            }
        });

        // Removed fuel specification and priority helpers (no longer used)

        // Validate scheduled date & time
        function validateScheduleDateTime() {
            const field = document.getElementById('scheduledDateTime');
            if (!field) return true;
            const value = field.value;
            if (!value) {
                showFieldError('scheduledDateTime', 'Consumption date & time is required');
                return false;
            }
            const selected = new Date(value);
            const now = new Date();
            if (selected > now) {
                showFieldError('scheduledDateTime', 'Consumption time cannot be in the future');
                return false;
            }
            clearFieldError(field);
            return true;
        }

        // Approval fields removed

        // Safety checklist removed

        // Update submit button state
        function updateSubmitButtonState() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <span class="loading-spinner" id="loadingSpinner"></span>
                    <i class="fas fa-check" id="submitIcon"></i>
                    Record Consumption
                `;
            }
        }

        // Validate individual field
        function validateField(field) {
            const value = field.value.trim();
            const fieldId = field.id;
            
            // Clear previous error
            clearFieldError(field);
            
            // Validation rules
            switch (fieldId) {
                case 'equipmentType':
                    if (!value) {
                        showFieldError(fieldId, 'Equipment type is required');
                        return false;
                    }
                    break;
                    
                case 'equipmentId':
                    if (!value) {
                        showFieldError(fieldId, 'Please select an equipment');
                        return false;
                    }
                    break;
                    
                // fuelType removed
                    
                case 'requestedQuantity':
                    {
                    const normalized = value.replace(',', '.');
                    if (normalized === '.' || normalized === '') {
                        showFieldError(fieldId, 'Valid quantity is required');
                        return false;
                    }
                    const num = parseFloat(normalized);
                    if (!normalized || isNaN(num) || num <= 0) {
                        showFieldError(fieldId, 'Valid quantity is required');
                        return false;
                    }
                    if (num > 10000) {
                        showFieldError(fieldId, 'Quantity cannot exceed 10,000 liters');
                        return false;
                    }
                    break;
                    }
                case 'meterIndex':
                    if (value && parseFloat(value) < 0) {
                        showFieldError(fieldId, 'Index cannot be negative');
                        return false;
                    }
                    break;
                    
                case 'scheduledDateTime':
                    return validateScheduleDateTime();
                    
                case 'requestedBy':
                    if (!value) {
                        showFieldError(fieldId, 'Operator name is required');
                        return false;
                    }
                    break;
            }
            
            return true;
        }

        // Show field error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (field) {
                field.classList.add('error');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }

        // Clear field error
        function clearFieldError(field) {
            field.classList.remove('error');
            const errorElement = document.getElementById(field.id + 'Error');
            if (errorElement) {
                errorElement.classList.remove('show');
                errorElement.textContent = '';
            }
        }

        // Clear all form errors
        function clearFormErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            const fieldElements = document.querySelectorAll('.form-control');
            
            errorElements.forEach(element => {
                element.classList.remove('show');
                element.textContent = '';
            });
            
            fieldElements.forEach(element => {
                element.classList.remove('error');
            });
        }

        // Submit distribution form
        async function submitDistribution(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const submitIcon = document.getElementById('submitIcon');
            
            // Show loading state
            submitBtn.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            submitIcon.style.display = 'none';
            
            try {
                // Validate form
                if (!validateDistributionForm()) {
                    throw new Error('Please correct the form errors');
                }
                
                // Collect form data
                const formData = collectFormData();
                
                // Generate distribution ID
                const distributionId = generateDistributionId();
                
                // Ensure company scope
                const currentCompanyId = window.authManager?.getCurrentUser()?.companyId;
                if (!currentCompanyId) {
                    throw new Error('Company context not found. Please sign in again.');
                }

                // Prepare distribution record (company-scoped)
                const distributionRecord = {
                    id: distributionId,
                    timestamp: new Date().toISOString(),
                    status: 'COMPLETED',
                    ...formData,
                    createdBy: window.authManager?.getCurrentUser()?.uid || 'unknown',
                    companyId: currentCompanyId
                };
                
                // Save to Firebase
                await saveDistributionToFirebase(distributionRecord);
                // Adjust storage for selected tank (deduct distributed fuel)
                try {
                    await applyFuelStorageAdjustment(distributionRecord, 'decrement');
                } catch (e) {
                    console.warn('Non-blocking: failed to adjust storage for distribution', e);
                }
                
                // Show success message
                alert('Consumption recorded successfully!\nRecord ID: ' + distributionId);
                
                // Close modal and refresh
                closeDistributionModal();
                loadDistributionStats();
                
            } catch (error) {
                console.error('Error recording consumption:', error);
                alert('Error recording consumption: ' + error.message);
            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                submitIcon.style.display = 'inline-block';
            }
        }

        // Validate entire form
        function validateDistributionForm() {
            const requiredFields = [
                'equipmentType', 'equipmentId',
                'requestedQuantity', 'scheduledDateTime', 'requestedBy'
            ];
            
            let isValid = true;
            
            // Validate required fields
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!validateField(field)) {
                    isValid = false;
                }
            });
            
            // Validate required safety checkboxes
            const requiredCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"][required]');
            requiredCheckboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Collect form data
        function collectFormData() {
            return {
                equipment: {
                    type: document.getElementById('equipmentType').value,
                    id: document.getElementById('equipmentId').value,
                    location: document.getElementById('equipmentLocation').value,
                    locationName: (function(){
                        const sel = document.getElementById('equipmentLocation');
                        if (!sel) return '';
                        const opt = sel.options[sel.selectedIndex];
                        return opt ? opt.text.trim() : '';
                    })(),
                    operator: document.getElementById('operatorName').value
                },
                site: (function(){
                    const sel = document.getElementById('site');
                    if (!sel) return { value:'', name:'' };
                    const opt = sel.options[sel.selectedIndex];
                    return { value: sel.value || '', name: (opt ? opt.text.trim() : '') };
                })(),
                fuel: {
                    requestedQuantity: (function(){
                        const raw = (document.getElementById('requestedQuantity').value || '');
                        const v = raw.replace(',', '.');
                        if (v === '.' || v === '') return 0;
                        const n = parseFloat(v);
                        return isNaN(n) ? 0 : n;
                    })(),
                    indexReading: (function(){
                        const el = document.getElementById('meterIndex');
                        if (!el || !el.value) return null;
                        const n = parseFloat(el.value);
                        return isNaN(n) ? null : n;
                    })()
                },
                schedule: (function(){
                    const dt = document.getElementById('scheduledDateTime').value;
                    if (!dt) return { date: '', time: '' };
                    const [date, time] = dt.split('T');
                    return { date, time };
                })(),
                authorization: {
                    requestedBy: document.getElementById('requestedBy').value,
                    department: document.getElementById('department').value,
                    costCenter: document.getElementById('costCenter').value,
                    securityAgent: (document.getElementById('securityAgent') ? document.getElementById('securityAgent').value : ''),
                    supervisor: (document.getElementById('supervisor') ? document.getElementById('supervisor').value : '')
                }
            };
        }

        // Generate distribution ID
        function generateDistributionId() {
            const today = new Date();
            const year = today.getFullYear().toString().substr(-2);
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            
            return `FD${year}${month}${day}${random}`;
        }

        // Save distribution to Firebase
        async function saveDistributionToFirebase(distributionRecord) {
            if (!window.firebase) {
                throw new Error('Firebase not available');
            }
            
            const db = window.firebase.database();
            const companyId = distributionRecord.companyId || window.authManager?.getCurrentUser()?.companyId;
            if (!companyId) {
                throw new Error('Company ID not found. Unable to save distribution.');
            }
            const distributionRef = db.ref(`fuelDistributions/${companyId}/${distributionRecord.id}`);
            
            await distributionRef.set(distributionRecord);
            console.log('? Distribution saved to Firebase:', distributionRecord.id);
        }

        // Adjust storageStatus for a distribution: mode 'decrement' (on create) or 'increment' (on delete)
        async function applyFuelStorageAdjustment(distributionRecord, mode = 'decrement') {
            try {
                if (!window.firebase || !window.firebase.database) return;
                const db = window.firebase.database();
                const companyId = distributionRecord.companyId || window.authManager?.getCurrentUser()?.companyId;
                if (!companyId) return;

                const selectedTankRefValue = distributionRecord?.equipment?.location || '';
                const selectedTankName = distributionRecord?.equipment?.locationName || '';
                const qty = parseFloat(distributionRecord?.fuel?.requestedQuantity) || 0;
                if (!qty) return;

                const storageRef = db.ref(`companies/${companyId}/fuelmanagement/storageStatus`);
                const snap = await storageRef.once('value');
                const storageData = snap.val();
                if (!storageData || typeof storageData !== 'object') return;

                // Find tank by either matching record key, tankId field, or fallback by display name
                let matchKey = null;
                let tank = null;
                for (const [key, val] of Object.entries(storageData)) {
                    if (!val) continue;
                    if (
                        key === selectedTankRefValue ||
                        val.tankId === selectedTankRefValue ||
                        (selectedTankName && (val.tankIdDisplay === selectedTankName))
                    ) {
                        matchKey = key;
                        tank = val;
                        break;
                    }
                }
                if (!matchKey || !tank) {
                    console.warn('No matching tank found for distribution to adjust storage', { selectedTankRefValue, selectedTankName });
                    return;
                }

                const currentVolume = parseFloat(tank.currentVolume) || 0;
                const maxVolume = parseFloat(tank.maxVolume) || 0;
                const newVolume = mode === 'decrement' ? Math.max(0, currentVolume - qty) : currentVolume + qty;
                const capacityPercentage = maxVolume > 0 ? (newVolume / maxVolume) * 100 : 0;
                const ullage = maxVolume > 0 ? Math.max(0, maxVolume - newVolume) : 0;

                const updatedBy = (window.authManager?.getCurrentUser()?.displayName) || (window.authManager?.getCurrentUser()?.email) || (window.authManager?.getCurrentUser()?.uid) || 'system';
                const updatePayload = {
                    currentVolume: newVolume,
                    capacityPercentage,
                    ullage,
                    lastUpdated: new Date().toISOString(),
                    updatedBy
                };

                await storageRef.child(matchKey).update(updatePayload);
                console.log(`? Storage ${mode === 'decrement' ? 'deducted' : 'replenished'} ${qty}L for tank`, { matchKey });
            } catch (e) {
                console.warn('Non-blocking: storage adjustment failed', e);
            }
        }

        // Load distribution stats
        function loadDistributionStats() {
            // Update stats (placeholder - will be implemented with real data in Step 3)
            const stats = {
                total: Math.floor(Math.random() * 200) + 150,
                pending: Math.floor(Math.random() * 20) + 10,
                completed: Math.floor(Math.random() * 15) + 5,
                fuel: Math.floor(Math.random() * 3000) + 2000
            };
            
            document.getElementById('totalDistributions').textContent = stats.total;
            document.getElementById('pendingDistributions').textContent = stats.pending;
            document.getElementById('completedDistributions').textContent = stats.completed;
            document.getElementById('totalFuelDistributed').textContent = `${stats.fuel}L`;
        }

        // One-time migration helper: copy legacy records from fuelDistributions/{id}
        // into fuelDistributions/{companyId}/{id} when possible (non-destructive).
        async function migrateLegacyDistributions() {
            try {
                if (!window.firebase) return;
                const db = window.firebase.database();
                const legacyRef = db.ref('fuelDistributions');
                const snapshot = await legacyRef.once('value');
                const data = snapshot.val();
                if (!data || typeof data !== 'object') return;

                // If keys are companyIds, skip (already migrated structure)
                const looksCompanyScoped = Object.values(data).some(v => v && typeof v === 'object' && v.companyId === undefined && typeof v === 'object' && Object.keys(v).some(k => typeof v[k] === 'object' && v[k].id));
                if (looksCompanyScoped) return;

                const entries = Object.entries(data);
                for (const [id, record] of entries) {
                    if (record && record.companyId && record.id) {
                        const targetRef = db.ref(`fuelDistributions/${record.companyId}/${record.id}`);
                        const targetSnap = await targetRef.once('value');
                        if (!targetSnap.exists()) {
                            await targetRef.set(record);
                            console.log(`?? Migrated distribution ${id} to company-scoped path`);
                        }
                    }
                }
            } catch (e) {
                console.warn('Migration skipped/failed:', e.message);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const notifications = document.querySelector('.notifications');
            const profile = document.querySelector('.user-profile');
            
            if (!notifications.contains(event.target)) {
                document.getElementById('notificationDropdown').classList.remove('show');
            }
            
            if (!profile.contains(event.target)) {
                document.getElementById('profileDropdown').classList.remove('show');
            }
        });

        // Initialize placeholder data
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize table management
            initializeDistributionTable();
            // Initialize column header filters for distribution table
            initializeDistributionTableFilters();
            // Attempt delayed sync of company branding to page header clone
            const syncBrand = () => {
                const nameEl = document.getElementById('headerCompanyName');
                const logoEl = document.getElementById('headerCompanyLogo');
                const phName = document.getElementById('phCompanyName');
                const phLogo = document.getElementById('phCompanyLogo');
                if (nameEl && phName && nameEl.textContent && !phName.textContent) phName.textContent = nameEl.textContent;
                if (logoEl && phLogo && logoEl.src && (!phLogo.src || phLogo.style.display === 'none')) {
                    phLogo.src = logoEl.src; phLogo.style.display = logoEl.style.display !== 'none' ? 'block' : 'none';
                }
            };
            // Run now and after short delays to catch async load
            syncBrand();
            setTimeout(syncBrand, 600);
            setTimeout(syncBrand, 1500);
        });

        // === DISTRIBUTION TABLE MANAGEMENT (Step 3) ===
        
        // Global variables for table management
        let distributionData = [];
        let filteredData = [];
        let currentPage = 1;
        const recordsPerPage = 10;

        // Initialize column header filters (inputs in the table head)
        function initializeDistributionTableFilters() {
            const table = document.getElementById('distributionTable');
            if (!table) return;
            const inputs = table.querySelectorAll('.column-filter');
            inputs.forEach(input => {
                const isSelect = input.tagName === 'SELECT';
                const eventName = isSelect || input.type === 'number' || input.type === 'date' ? 'change' : 'input';
                input.addEventListener(eventName, () => {
                    applyFilters();
                });
            });
        }

        // Read header filter values into a simple object
        function getDistributionHeaderFilters() {
            const table = document.getElementById('distributionTable');
            const values = { equipId:'', location:'', site:'', operator:'', minQty:null, minIndex:null, date:'', department:'' };
            if (!table) return values;
            const inputs = table.querySelectorAll('.column-filter');
            inputs.forEach(input => {
                const col = String(input.getAttribute('data-column'));
                const val = (input.tagName === 'INPUT' && input.type === 'number') ? (input.value !== '' ? Number(input.value) : null) : (input.value || '');
                switch(col){
                    case '2': values.equipId = (val || '').toString(); break;
                    case '3': values.location = (val || '').toString(); break;
                    case '4': values.site = (val || '').toString(); break;
                    case '5': values.operator = (val || '').toString(); break;
                    case '6': values.minQty = (val !== null ? Number(val) : null); break;
                    case '7': values.minIndex = (val !== null ? Number(val) : null); break;
                    case '8': values.date = (val || '').toString(); break; // YYYY-MM-DD
                    case '9': values.department = (val || '').toString(); break;
                }
            });
            return values;
        }

        // Populate dropdown header filters with unique values gathered from data
        function populateHeaderDropdownFilters() {
            const table = document.getElementById('distributionTable');
            if (!table) return;
            const optionSets = {
                '2': new Set(), // Equip ID
                '3': new Set(), // Location (display name if available)
                '4': new Set(), // Site
                '5': new Set(), // Operator/RequestedBy
                '9': new Set(), // Department
            };
            (distributionData || []).forEach(r => {
                if (r?.equipment?.id) optionSets['2'].add(String(r.equipment.id));
                const loc = r?.equipment?.locationName || r?.equipment?.location;
                if (loc) optionSets['3'].add(String(loc));
                const siteVal = r?.site?.name || r?.site?.value;
                if (siteVal) optionSets['4'].add(String(siteVal));
                const op = r?.equipment?.operator || r?.authorization?.requestedBy;
                if (op) optionSets['5'].add(String(op));
                if (r?.authorization?.department) optionSets['9'].add(String(r.authorization.department));
            });
            Object.entries(optionSets).forEach(([col, set]) => {
                const select = table.querySelector(`.column-filter[data-column="${col}"]`);
                if (!select || select.tagName !== 'SELECT') return;
                const current = select.value;
                const allLabel = (select.querySelector('option[value=""]')?.textContent) || 'All';
                select.innerHTML = '';
                const optAll = document.createElement('option');
                optAll.value = '';
                optAll.textContent = allLabel;
                select.appendChild(optAll);
                Array.from(set).sort((a,b)=>String(a).localeCompare(String(b))).forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    select.appendChild(opt);
                });
                if (current && Array.from(set).includes(current)) {
                    select.value = current;
                }
            });
        }

        // Initialize distribution table
        function initializeDistributionTable() {
            // Wait for auth to be ready, then load data
            setTimeout(() => {
                if (window.authManager?.getCurrentUser()) {
                    // Run non-destructive migration in background
                    migrateLegacyDistributions();
                    loadDistributionData();
                } else {
                    // Show placeholder stats
                    document.getElementById('totalDistributions').textContent = '156';
                    document.getElementById('pendingDistributions').textContent = '12';
                    document.getElementById('completedDistributions').textContent = '8';
                    document.getElementById('totalFuelDistributed').textContent = '2,450L';
                }
            }, 2000);
            
            // Add modal event listeners
            setupModalEventListeners();
        }

        // Setup modal event listeners
        function setupModalEventListeners() {
            // Close modal when clicking outside
            const modal = document.getElementById('distributionModal');
            const viewModal = document.getElementById('distributionViewModal');
            if (modal) modal.addEventListener('click', handleModalClick);
            if (viewModal) viewModal.addEventListener('click', handleModalClick);
            
            // Close modal with escape key
            document.addEventListener('keydown', handleKeyPress);
            
            // Ensure modals are hidden on page load
            if (modal) modal.classList.remove('show');
            if (viewModal) viewModal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Load distribution data from Firebase
        async function loadDistributionData() {
            try {
                showTableLoading(true);
                
                const companyId = window.authManager?.getCurrentUser()?.companyId;
                if (!companyId) {
                    console.log('No company ID found');
                    showNoData(true);
                    return;
                }

                const distributionsRef = firebase.database().ref(`fuelDistributions/${companyId}`);
                const snapshot = await distributionsRef.once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    distributionData = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    
                    // Sort by creation date (newest first)
                    distributionData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    console.log('Distribution data loaded:', distributionData.length, 'records');
                } else {
                    distributionData = [];
                    console.log('No distribution data found');
                }
                
                // Apply current filters and render table
                populateHeaderDropdownFilters();
                applyFilters();
                renderDistributionTable();
                updateStatsCards();
                ensureLocationNames();
                // If analytics tab active, refresh analytics
                if (currentFuelTab === 'analytics') {
                    renderFuelAnalytics();
                }
                
            } catch (error) {
                console.error('Error loading distribution data:', error);
                showNoData(true, 'Error loading distribution data. Please try again.');
            } finally {
                showTableLoading(false);
            }
        }

        // --- Analytics Tab Logic ---
    let currentFuelTab = 'list';
    let primaryChartInstance = null;
    let secondaryChartInstance = null;

        function switchFuelTab(tab){
            if (tab === currentFuelTab) return;
            currentFuelTab = tab;
            const mapping = {
                list: { btn: 'fuelTabListBtn', content: 'fuelListTabContent' },
                analytics: { btn: 'fuelTabAnalyticsBtn', content: 'fuelAnalyticsTabContent' },
                reports: { btn: 'fuelTabReportsBtn', content: 'fuelReportsTabContent' }
            };
            Object.keys(mapping).forEach(key => {
                const { btn, content } = mapping[key];
                const bEl = document.getElementById(btn);
                const cEl = document.getElementById(content);
                if (bEl) bEl.classList.toggle('active', key === tab);
                if (cEl) cEl.classList.toggle('active', key === tab);
            });
            if (tab === 'analytics') {
                setupAnalyticsControlsOnce();
                try { renderFuelAnalytics(); } catch(e){ console.warn('renderFuelAnalytics failed', e); }
                try { loadAnalyticsModels(); } catch(e) {}
            } else if (tab === 'reports') {
                setupReportsOnce();
                const statusEl = document.getElementById('reportsInlineStatus');
                if (statusEl && !statusEl.textContent) statusEl.textContent = 'Ready to build or schedule reports.';
                try { loadGeneratedReports(); } catch(e){ console.warn('loadGeneratedReports failed on tab switch', e); }
                try { bindFuelReportsRealtime(); } catch(e){ console.warn('bindFuelReportsRealtime failed', e); }
            }
        }

        function computeFuelAggregates(groupBy, opts) {
            const now = new Date();
            // Inline date inputs (start/end) replace previous popover
            let start = null, end = null;
            let sVal = document.getElementById('analyticsDateStart')?.value || '';
            let eVal = document.getElementById('analyticsDateEnd')?.value || '';
            if (opts && (opts.start || opts.end)) {
                if (opts.start) sVal = opts.start;
                if (opts.end) eVal = opts.end;
            }
            if (sVal) {
                const s = new Date(sVal);
                if (!isNaN(s.getTime())) start = new Date(s.getFullYear(), s.getMonth(), s.getDate());
            }
            if (eVal) {
                const e = new Date(eVal);
                if (!isNaN(e.getTime())) end = new Date(e.getFullYear(), e.getMonth(), e.getDate(), 23,59,59,999);
            }
            // If only one side provided, use same day for both
            if (start && !end) end = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 23,59,59,999);
            if (end && !start) start = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            if (!start || !end) {
                // no explicit range or invalid: include all data
                start = new Date(0);
                end = now;
            }
            // Build category value allow-list (checkbox dropdown; empty => all)
            const selectedValues = Array.isArray(window.__analyticsSelectedValues) ? window.__analyticsSelectedValues : [];
            const hasValueFilter = selectedValues.length > 0;

            // Choose source records (analytics default = all distributionData; reports can pass a dataset)
            const sourceAll = (opts && Array.isArray(opts.dataset)) ? opts.dataset : distributionData;

            const inRange = sourceAll.filter(r => {
                // Use consumption date (schedule.date) for date range filtering
                const d = new Date(r.schedule?.date || r.timestamp || now);
                return d >= start && d <= end;
            });
            const groups = {};
            inRange.forEach(r => {
                let key; let sortVal = undefined;
                switch(groupBy){
                    // Primary time grouping
                    case 'day': {
                        const d = new Date(r.schedule?.date || r.timestamp);
                        key = d.toLocaleDateString(undefined,{ day:'2-digit', month:'short' });
                        sortVal = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
                        break;
                    }
                    case 'consumptionDate': {
                        const d = new Date(r.schedule?.date || r.timestamp);
                        key = d.toISOString().slice(0,10);
                        sortVal = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
                        break;
                    }
                    // Identifiers
                    case 'id': key = r.id || 'Unknown ID'; break;
                    // Equipment related
                    case 'equipment':
                    case 'equipmentId': key = r.equipment?.id || 'Unknown Equipment'; break;
                    case 'type':
                    case 'equipmentType': key = r.equipment?.type || 'Unknown Type'; break;
                    case 'location': key = r.equipment?.location || 'Unknown Location'; break;
                    case 'operator': key = r.equipment?.operator || r.authorization?.requestedBy || 'Unknown Operator'; break;
                    case 'site': key = (r.site?.name || r.site?.value || '').trim() || 'Unknown Site'; break;
                    // Fuel metrics (bucketize by value)
                    case 'quantity': {
                        const q = Number(r.fuel?.requestedQuantity)||0;
                        // Bucket into ranges of 50L for readability
                        const bucket = Math.floor(q / 50) * 50;
                        key = `${bucket}-${bucket+49} L`;
                        break;
                    }
                    case 'index': {
                        const idx = (typeof r.fuel?.indexReading === 'number') ? r.fuel.indexReading : null;
                        key = (idx===null) ? 'No Index' : `Index ${Math.floor(idx/100)*100}-${Math.floor(idx/100)*100+99}`;
                        break;
                    }
                    // Authorization fields
                    case 'department': key = r.authorization?.department || 'Unknown Department'; break;
                    case 'costcenter': key = r.authorization?.costCenter || 'Unknown Cost Center'; break;
                    case 'securityAgent': key = r.authorization?.securityAgent || 'Unknown Security'; break;
                    case 'supervisor': key = r.authorization?.supervisor || 'Unknown Supervisor'; break;
                    // Record status
                    case 'status': key = r.status || 'Unknown Status'; break;
                    default: {
                        const d = new Date(r.schedule?.date || r.timestamp);
                        key = d.toLocaleDateString(undefined,{ day:'2-digit', month:'short' });
                    }
                }
                if (hasValueFilter && !selectedValues.includes(String(key))) return; // filter by chosen values
                if (!groups[key]) groups[key] = { key, records:0, quantity:0, indexTotal:0, sortVal: sortVal };
                // Keep earliest day as sortVal if multiple entries land in same bucket
                if (typeof sortVal === 'number') {
                    if (typeof groups[key].sortVal !== 'number' || sortVal < groups[key].sortVal) {
                        groups[key].sortVal = sortVal;
                    }
                }
                groups[key].records += 1;
                const qty = Number(r.fuel?.requestedQuantity)||0;
                groups[key].quantity += qty;
                if (typeof r.fuel?.indexReading === 'number') groups[key].indexTotal += r.fuel.indexReading;
            });
            let rows = Object.values(groups);
            if (groupBy === 'day' || groupBy === 'consumptionDate') {
                rows.sort((a,b)=> (a.sortVal||0) - (b.sortVal||0));
            } else {
                rows.sort((a,b)=> b.quantity - a.quantity);
            }
            const totals = rows.reduce((acc,r)=>{acc.quantity+=r.quantity;acc.records+=r.records;return acc;},{quantity:0,records:0});
            return { rows, totals, rangeCount: inRange.length };
        }

        // --- NEW: Two-dimensional pivot aggregation (primary + secondary dimension) ---
        function computeFuelPivot(primary, secondary, opts){
            // Fallback to 1D if no secondary or same as primary
            if(!secondary || secondary === primary){
                const one = computeFuelAggregates(primary, opts);
                return { mode:'1d', rows: one.rows, totals: one.totals, rangeCount: one.rangeCount };
            }
            const now = new Date();
            let start=null,end=null;
            if(opts){
                if(opts.start){ const s=new Date(opts.start); if(!isNaN(s)) start=new Date(s.getFullYear(), s.getMonth(), s.getDate()); }
                if(opts.end){ const e=new Date(opts.end); if(!isNaN(e)) end=new Date(e.getFullYear(), e.getMonth(), e.getDate(),23,59,59,999); }
            }
            if(start && !end) end=new Date(start.getFullYear(), start.getMonth(), start.getDate(),23,59,59,999);
            if(end && !start) start=new Date(end.getFullYear(), end.getMonth(), end.getDate());
            if(!start || !end){ start=new Date(0); end=now; }

            const sourceAll = (opts && Array.isArray(opts.dataset)) ? opts.dataset : distributionData;
            const inRange = sourceAll.filter(r=>{ const d=new Date(r.schedule?.date || r.timestamp || now); return d>=start && d<=end; });

            const selRows = Array.isArray(opts?.selectedValues) ? opts.selectedValues : [];
            const selCols = Array.isArray(opts?.selectedValues2) ? opts.selectedValues2 : [];
            const filterRows = selRows.length>0;
            const filterCols = selCols.length>0;

            function dimKey(r, dim){
                let key; let sortVal; // reuse logic from computeFuelAggregates
                switch(dim){
                    case 'day': { const d=new Date(r.schedule?.date || r.timestamp); key=d.toLocaleDateString(undefined,{ day:'2-digit', month:'short' }); sortVal=new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); break; }
                    case 'consumptionDate': { const d=new Date(r.schedule?.date || r.timestamp); key=d.toISOString().slice(0,10); sortVal=new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); break; }
                    case 'id': key = r.id || 'Unknown ID'; break;
                    case 'equipment':
                    case 'equipmentId': key = r.equipment?.id || 'Unknown Equipment'; break;
                    case 'type':
                    case 'equipmentType': key = r.equipment?.type || 'Unknown Type'; break;
                    case 'location': key = r.equipment?.location || 'Unknown Location'; break;
                    case 'operator': key = r.equipment?.operator || r.authorization?.requestedBy || 'Unknown Operator'; break;
                    case 'site': key = (r.site?.name || r.site?.value || '').trim() || 'Unknown Site'; break;
                    case 'quantity': { const q=Number(r.fuel?.requestedQuantity)||0; const bucket=Math.floor(q/50)*50; key=`${bucket}-${bucket+49} L`; break; }
                    case 'index': { const idx=(typeof r.fuel?.indexReading === 'number') ? r.fuel.indexReading : null; key=(idx===null)?'No Index':`Index ${Math.floor(idx/100)*100}-${Math.floor(idx/100)*100+99}`; break; }
                    case 'department': key = r.authorization?.department || 'Unknown Department'; break;
                    case 'costcenter': key = r.authorization?.costCenter || 'Unknown Cost Center'; break;
                    case 'securityAgent': key = r.authorization?.securityAgent || 'Unknown Security'; break;
                    case 'supervisor': key = r.authorization?.supervisor || 'Unknown Supervisor'; break;
                    case 'status': key = r.status || 'Unknown Status'; break;
                    case 'fuelType': key = r.fuel?.type || 'Unknown Fuel Type'; break;
                    default: { const d=new Date(r.schedule?.date || r.timestamp); key=d.toLocaleDateString(undefined,{ day:'2-digit', month:'short' }); }
                }
                return { key, sortVal };
            }

            const matrix = {}; // rowKey -> colKey -> {records, quantity}
            const rowMeta = {}; // rowKey -> { sortVal }
            const colSet = new Set();

            inRange.forEach(r=>{
                const { key: rKey, sortVal: rSort } = dimKey(r, primary);
                const { key: cKey } = dimKey(r, secondary);
                if(filterRows && !selRows.includes(String(rKey))) return;
                if(filterCols && !selCols.includes(String(cKey))) return;
                if(!matrix[rKey]) matrix[rKey] = {};
                if(!matrix[rKey][cKey]) matrix[rKey][cKey] = { records:0, quantity:0 };
                matrix[rKey][cKey].records += 1;
                matrix[rKey][cKey].quantity += Number(r.fuel?.requestedQuantity)||0;
                colSet.add(cKey);
                if(!rowMeta[rKey]) rowMeta[rKey] = { sortVal: rSort };
                else if(typeof rSort === 'number' && (typeof rowMeta[rKey].sortVal !== 'number' || rSort < rowMeta[rKey].sortVal)) rowMeta[rKey].sortVal = rSort;
            });

            let rowKeys = Object.keys(matrix);
            // Sort rows similarly to 1D logic
            if(primary==='day' || primary==='consumptionDate'){
                rowKeys.sort((a,b)=> (rowMeta[a].sortVal||0)-(rowMeta[b].sortVal||0));
            } else {
                // sort by total quantity desc
                rowKeys.sort((a,b)=>{
                    const qa = Object.values(matrix[a]).reduce((s,c)=>s+c.quantity,0);
                    const qb = Object.values(matrix[b]).reduce((s,c)=>s+c.quantity,0);
                    return qb-qa;
                });
            }
            const colKeys = Array.from(colSet);
            // Optionally limit extreme wide tables (keep first 25)
            if(colKeys.length>50) colKeys.splice(50);

            // Compute totals
            const rowTotals = {}; // rowKey -> {records, quantity}
            const colTotals = {}; // colKey -> {records, quantity}
            let grand = { records:0, quantity:0 };
            rowKeys.forEach(rk=>{
                rowTotals[rk] = { records:0, quantity:0 };
                colKeys.forEach(ck=>{
                    const cell = matrix[rk][ck];
                    if(!cell) return;
                    rowTotals[rk].records += cell.records;
                    rowTotals[rk].quantity += cell.quantity;
                    if(!colTotals[ck]) colTotals[ck] = { records:0, quantity:0 };
                    colTotals[ck].records += cell.records;
                    colTotals[ck].quantity += cell.quantity;
                    grand.records += cell.records;
                    grand.quantity += cell.quantity;
                });
            });

            return { mode:'2d', primary, secondary, rowKeys, colKeys, matrix, rowTotals, colTotals, grand };
        }

        // Helper for analysis set specific aggregation (decides 1D vs 2D)
        function computeAnalysisAggregation(cfg, selectedValues, selectedValues2){
            return computeFuelPivot(cfg.groupBy, cfg.groupBy2, { start: cfg.start, end: cfg.end, selectedValues, selectedValues2 });
        }

        function renderFuelAnalytics(){
            const groupBy = document.getElementById('analyticsCategory').value;
            const { rows, totals } = computeFuelAggregates(groupBy);
            // KPIs inline (same line as controls)
            const inlineKpis = document.getElementById('analyticsInlineKpis');
            inlineKpis.innerHTML = `
                ${miniKpi('TOTAL QTY (L)', totals.quantity.toFixed(2))}
                ${miniKpi('ENTRIES', totals.records)}
                ${miniKpi('AVG / ENTRY', totals.records? (totals.quantity/totals.records).toFixed(2):'0')}
            `;
            // Populate category values multiselect
            populateCategoryValueFilter(groupBy);
            // Table
            const headEl = document.getElementById('analyticsHead');
            const bodyEl = document.getElementById('analyticsBody');
            // If user has not added analytics set yet, skip table/chart rendering
            if (!headEl || !bodyEl) return;
            const groupLabel = {
                // Dates
                'day': 'DATE',
                'consumptionDate': 'CONSUMPTION DATE',
                // Identifiers
                'id': 'RECORD ID',
                // Equipment
                'equipment': 'EQUIPMENT ID',
                'equipmentId': 'EQUIPMENT ID',
                'type': 'EQUIPMENT TYPE',
                'equipmentType': 'EQUIPMENT TYPE',
                'location': 'LOCATION',
                'site': 'SITE',
                'operator': 'OPERATOR',
                // Fuel metrics (bucketed)
                'quantity': 'QTY BUCKET (L)',
                'index': 'INDEX BUCKET',
                // Authorization
                'department': 'DEPARTMENT',
                'costcenter': 'COST CENTER',
                'securityAgent': 'SECURITY AGENT',
                'supervisor': 'SUPERVISOR',
                // Status
                'status': 'STATUS'
            }[groupBy] || groupBy.toUpperCase();
            headEl.innerHTML = `<th style="font-size:.55rem;">${groupLabel}</th><th style="font-size:.55rem;">RECORDS</th><th style="font-size:.55rem;">QTY (L)</th><th style="font-size:.55rem;">AVG (L)</th>`;
            bodyEl.innerHTML = rows.map(r=>`<tr><td style="font-size:.6rem;">${r.key}</td><td style="font-size:.6rem;">${r.records}</td><td style="font-size:.6rem;">${r.quantity.toFixed(2)}</td><td style="font-size:.6rem;">${(r.quantity/r.records).toFixed(2)}</td></tr>`).join('');
            // After table render, sync heights once chart is drawn (chart after render)
            requestAnimationFrame(()=>{
                renderFuelCharts(groupBy, rows, ()=>{ try{ syncAnalyticsHeights(); }catch(e){ console.warn('sync heights failed after chart', e); } });
                try{ syncAnalyticsHeights(); }catch(e){ }
            });
        }

        function kpiCard(label,value){
            return `<div style="background:#fff;border:1px solid #e2e8f0;border-radius:6px;padding:0.55rem 0.6rem;display:flex;flex-direction:column;gap:0.25rem;">
                <span style="font-size:0.5rem;font-weight:600;color:#64748b;letter-spacing:0.5px;">${label}</span>
                <span style="font-size:0.95rem;font-weight:600;color:#1e293b;">${value}</span>
            </div>`;
        }

        function miniKpi(label,value){
            return `<div style="display:flex;flex-direction:column;gap:0.1rem;min-width:120px;">
                <span style="font-size:0.45rem;font-weight:600;color:#64748b;letter-spacing:0.4px;">${label}</span>
                <span style="font-size:0.85rem;font-weight:700;color:#1e293b;">${value}</span>
            </div>`;
        }

        function renderFuelCharts(groupBy, rows, done){
            if (typeof Chart === 'undefined') {
                loadChartJs(()=>renderFuelAnalytics());
                return;
            }
            const secondaryCtx = document.getElementById('analyticsSecondaryChart').getContext('2d');
            const labels = rows.map(r=>r.key).slice(0,20);
            const quantities = rows.map(r=>r.quantity).slice(0,20);
            const records = rows.map(r=>r.records).slice(0,20);
            if (secondaryChartInstance) secondaryChartInstance.destroy();
            secondaryChartInstance = new Chart(secondaryCtx, {
                type:'bar',
                data:{ labels, datasets:[
                    { 
                        label:'Quantity (L)', 
                        data:quantities, 
                        backgroundColor:'rgba(37, 99, 235, 0.75)',
                        borderColor:'#2563eb', 
                        borderWidth:2, 
                        borderRadius:6,
                        barPercentage:0.7, 
                        categoryPercentage:0.8,
                        hoverBackgroundColor:'rgba(37, 99, 235, 0.9)',
                        hoverBorderColor:'#1e40af',
                        hoverBorderWidth:3
                    },
                    { 
                        label:'Records', 
                        data:records, 
                        backgroundColor:'rgba(14, 165, 233, 0.65)',
                        borderColor:'#0ea5e9',
                        borderWidth:2,
                        borderRadius:6,
                        barPercentage:0.7, 
                        categoryPercentage:0.8,
                        hoverBackgroundColor:'rgba(14, 165, 233, 0.85)',
                        hoverBorderColor:'#0284c7',
                        hoverBorderWidth:3
                    }
                ]},
                options: (function(){
                    const opt = {
                        layout:{ padding: { left: 10, right: 10, top: 15, bottom: 5 }},
                        plugins:{ 
                            legend:{ 
                                display:true, 
                                position:'top',
                                labels:{ 
                                    boxWidth:12, 
                                    font:{ size:11, weight:'600', family:"'Inter', 'Segoe UI', sans-serif" }, 
                                    padding:12,
                                    color:'#334155',
                                    usePointStyle:true,
                                    pointStyle:'rectRounded'
                                } 
                            },
                            tooltip:{
                                backgroundColor:'rgba(15, 23, 42, 0.95)',
                                titleColor:'#fff',
                                bodyColor:'#e2e8f0',
                                titleFont:{ size:13, weight:'700' },
                                bodyFont:{ size:12 },
                                padding:12,
                                cornerRadius:8,
                                displayColors:true,
                                borderColor:'rgba(148, 163, 184, 0.3)',
                                borderWidth:1
                            }
                        },
                        scales:{
                            x:{ 
                                ticks:{ 
                                    font:{size:10, weight:'500'}, 
                                    maxRotation:45, 
                                    minRotation:0,
                                    autoSkip:true, 
                                    autoSkipPadding:8,
                                    color:'#475569'
                                },
                                grid:{ display:false },
                                border:{ color:'#cbd5e1', width:1 }
                            },
                            y:{ 
                                ticks:{ 
                                    font:{size:10, weight:'500'},
                                    color:'#475569',
                                    padding:8
                                }, 
                                beginAtZero:true,
                                grid:{ color:'rgba(203, 213, 225, 0.4)', lineWidth:1 },
                                border:{ color:'#cbd5e1', width:1 }
                            }
                        },
                        responsive:true,
                        maintainAspectRatio:false,
                        interaction:{ mode:'index', intersect:false }
                    };
                    opt.animation = { 
                        duration: 800,
                        easing: 'easeInOutQuart',
                        onComplete: ()=>{ if (typeof done==='function') done(); } 
                    };
                    return opt;
                })()
            });
            if (!secondaryChartInstance.options.animation || secondaryChartInstance.options.animation===false){
                if (typeof done==='function') done();
            }
        }

        function syncAnalyticsHeights(){
            const tablePanel = document.getElementById('analyticsTablePanel');
            const chartPanel = document.getElementById('analyticsChartPanel');
            const chartHolder = document.getElementById('analyticsChartHolder');
            const canvas = document.getElementById('analyticsSecondaryChart');
            if (!tablePanel || !chartPanel || !chartHolder || !canvas) return;
            // Natural height of table panel
            const tableHeight = tablePanel.getBoundingClientRect().height;
            chartPanel.style.height = tableHeight + 'px';
            chartHolder.style.height = (tableHeight - 30) + 'px'; // account for header
            canvas.style.height = '100%';
            try { if (secondaryChartInstance){ secondaryChartInstance.resize(); } } catch(e){}
        }

        function loadChartJs(cb){
            const existing = document.getElementById('chartjs-lib');
            if (existing) { if (cb) cb(); return; }
            const s = document.createElement('script');
            s.id='chartjs-lib';
            s.src='https://cdn.jsdelivr.net/npm/chart.js';
            s.onload=()=> cb && cb();
            document.head.appendChild(s);
        }

        function escapeCsv(val){
            const s = String(val ?? '');
            if (s.includes(',') || s.includes('"') || s.includes('\n')) {
                return '"' + s.replace(/"/g,'""') + '"';
            }
            return s;
        }

        function exportAnalyticsCsv(){
            const groupBy = document.getElementById('analyticsCategory').value;
            const { rows } = computeFuelAggregates(groupBy);
            const header = `${groupBy.toUpperCase()},RECORDS,QUANTITY_L,AVG_L`;
            const lines = rows.map(r=>`${escapeCsv(r.key)},${r.records},${r.quantity.toFixed(2)},${(r.quantity/Math.max(1,r.records)).toFixed(2)}`);
            const csv = [header, ...lines].join('\n');
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `fuel_analytics_${groupBy}.csv`; a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize one-time analytics control behaviors
        let analyticsControlsWired = false;
        function setupAnalyticsControlsOnce(){
            if (analyticsControlsWired) return; analyticsControlsWired = true;
            // Category change should also refresh value list
            const cat = document.getElementById('analyticsCategory');
            if (cat){ cat.addEventListener('change', ()=> { populateCategoryValueFilter(cat.value); renderFuelAnalytics(); }); }
            // Dropdown open/close
            const ddBtn = document.getElementById('analyticsValueDropdownBtn');
            const ddMenu = document.getElementById('analyticsValueDropdownMenu');
            if (ddBtn && ddMenu){
                ddBtn.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    ddMenu.style.display = (ddMenu.style.display === 'none' || !ddMenu.style.display) ? 'block' : 'none';
                });
                document.addEventListener('click', ()=>{ ddMenu.style.display='none'; });
                ddMenu.addEventListener('click', (e)=> e.stopPropagation());
            }
            // Date inputs are wired inline via onchange attributes in the markup
        }

        function clearDateRange(){
            const s = document.getElementById('analyticsDateStart');
            const e = document.getElementById('analyticsDateEnd');
            if (s) s.value = '';
            if (e) e.value = '';
            renderFuelAnalytics();
        }

        function populateCategoryValueFilter(groupBy){
            const container = document.getElementById('categoryValueFilter');
            const ddMenu = document.getElementById('analyticsValueDropdownMenu');
            const ddBtn = document.getElementById('analyticsValueDropdownBtn');
            if (!container || !ddMenu || !ddBtn) return;
            // Only show for non-date categories
            const hide = (groupBy === 'day' || groupBy === 'consumptionDate');
            container.style.display = hide ? 'none' : 'flex';
            if (hide){ ddMenu.innerHTML = ''; ddBtn.textContent = 'All'; window.__analyticsSelectedValues = []; return; }
            // Collect unique values for current category from all data (unfiltered by date so user can see the universe)
            const set = new Set();
            (distributionData||[]).forEach(r=>{
                let key;
                switch(groupBy){
                    case 'id': key = r.id || 'Unknown ID'; break;
                    case 'equipment':
                    case 'equipmentId': key = r.equipment?.id || 'Unknown Equipment'; break;
                    case 'type':
                    case 'equipmentType': key = r.equipment?.type || 'Unknown Type'; break;
                    case 'location': key = r.equipment?.location || 'Unknown Location'; break;
                    case 'site': key = (r.site?.name || r.site?.value || '').trim() || 'Unknown Site'; break;
                    case 'operator': key = r.equipment?.operator || r.authorization?.requestedBy || 'Unknown Operator'; break;
                    case 'quantity': {
                        const q = Number(r.fuel?.requestedQuantity)||0; const b = Math.floor(q/50)*50; key = `${b}-${b+49} L`; break; }
                    case 'index': {
                        const idx = (typeof r.fuel?.indexReading === 'number') ? r.fuel.indexReading : null; key = (idx===null)?'No Index':`Index ${Math.floor(idx/100)*100}-${Math.floor(idx/100)*100+99}`; break; }
                    case 'department': key = r.authorization?.department || 'Unknown Department'; break;
                    case 'costcenter': key = r.authorization?.costCenter || 'Unknown Cost Center'; break;
                    case 'securityAgent': key = r.authorization?.securityAgent || 'Unknown Security'; break;
                    case 'supervisor': key = r.authorization?.supervisor || 'Unknown Supervisor'; break;
                    case 'status': key = r.status || 'Unknown Status'; break;
                    default: key = undefined;
                }
                if (key !== undefined) set.add(String(key));
            });
            const values = Array.from(set).sort();
            const prev = Array.isArray(window.__analyticsSelectedValues) ? window.__analyticsSelectedValues : [];
            ddMenu.innerHTML = '';
            // Select All
            const allId = 'analytics-val-all';
            const allWrap = document.createElement('div'); allWrap.style.padding='0.2rem 0.1rem';
            const allCb = document.createElement('input'); allCb.type='checkbox'; allCb.id=allId; allCb.checked = prev.length === 0; // empty => All
            const allLbl = document.createElement('label'); allLbl.htmlFor=allId; allLbl.textContent='All'; allLbl.style.marginLeft='0.4rem'; allLbl.style.fontSize='0.6rem';
            allCb.addEventListener('change', ()=>{
                if (allCb.checked){ window.__analyticsSelectedValues = []; updateAnalyticsDropdownLabel(); renderFuelAnalytics();
                    // uncheck others
                    ddMenu.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.id!==allId) cb.checked=false; });
                }
            });
            allWrap.appendChild(allCb); allWrap.appendChild(allLbl); ddMenu.appendChild(allWrap);
            // Options
            values.forEach((v, idx)=>{
                const id = `analytics-val-${idx}`;
                const row = document.createElement('div'); row.style.padding='0.2rem 0.1rem';
                const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v; cb.checked = prev.includes(v);
                const lbl = document.createElement('label'); lbl.htmlFor=id; lbl.textContent=v; lbl.style.marginLeft='0.4rem'; lbl.style.fontSize='0.6rem';
                cb.addEventListener('change', ()=>{
                    const selected = new Set(window.__analyticsSelectedValues || []);
                    if (cb.checked) selected.add(v); else selected.delete(v);
                    window.__analyticsSelectedValues = Array.from(selected);
                    // When any option is selected, uncheck All; when none selected, All is implied
                    const any = window.__analyticsSelectedValues.length>0;
                    const allBox = document.getElementById(allId); if (allBox) allBox.checked = !any;
                    updateAnalyticsDropdownLabel();
                    renderFuelAnalytics();
                });
                row.appendChild(cb); row.appendChild(lbl); ddMenu.appendChild(row);
            });
            updateAnalyticsDropdownLabel();
        }

        function updateAnalyticsDropdownLabel(){
            const ddBtn = document.getElementById('analyticsValueDropdownBtn'); if (!ddBtn) return;
            const vals = window.__analyticsSelectedValues || [];
            ddBtn.textContent = (vals.length === 0) ? 'All' : `${vals.length} selected`;
        }

        // Backfill locationName for legacy records (mapping value->label from current dropdown)
        async function ensureLocationNames(){
            if (!distributionData || !distributionData.length) return;
            
            // Get tank ID mapping from Firebase (same source as dropdown)
            const tankMap = await getTankIdMapping();
            let updated = false;
            
            distributionData.forEach(r => {
                if (r.equipment && r.equipment.location && !r.equipment.locationName) {
                    const val = r.equipment.location;
                    // First try direct mapping from Firebase tank IDs
                    if (tankMap[val]) {
                        r.equipment.locationName = tankMap[val];
                        updated = true;
                    }
                    // Fallback: use the raw value as display name
                    else {
                        r.equipment.locationName = val;
                        updated = true;
                    }
                }
            });
            
            if (updated) {
                populateHeaderDropdownFilters();
                renderDistributionTable();
                if (currentFuelTab === 'analytics') renderFuelAnalytics();
            }
        }

        // Get tank ID mapping from Firebase
        async function getTankIdMapping() {
            const map = {};
            try {
                if (!window.firebase) return map;
                const db = window.firebase.database();
                const fixedPath = 'companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/tank-id';
                const snapshot = await db.ref(fixedPath).once('value');
                const tankIds = snapshot.val();

                if (Array.isArray(tankIds)) {
                    tankIds.forEach(tank => {
                        if (tank && tank.enabled && tank.value && tank.label) {
                            map[tank.value] = tank.label;
                        }
                    });
                }
            } catch (e) {
                console.warn('Unable to load tank ID mapping:', e);
            }
            return map;
        }

        // Render distribution table
        function renderDistributionTable() {
            const tableBody = document.getElementById('distributionTableBody');
            const noDataDiv = document.getElementById('noDataMessage');
            const paginationDiv = document.getElementById('tablePagination');
            
            if (filteredData.length === 0) {
                showNoData(true);
                paginationDiv.style.display = 'none';
                return;
            }
            
            showNoData(false);
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Render table rows
            tableBody.innerHTML = pageData.map(record => createTableRow(record)).join('');

            // Ensure row click delegation is set up once
            setupRowClickDelegation();
            
            // Update pagination
            updatePagination(totalPages, startIndex, endIndex, filteredData.length);
        }

        let rowClickDelegationWired = false;
        function setupRowClickDelegation(){
            if (rowClickDelegationWired) return;
            const tableBody = document.getElementById('distributionTableBody');
            if (!tableBody) return;
            rowClickDelegationWired = true;
            tableBody.addEventListener('click', (e)=>{
                if (e.target.closest('.table-actions')) return;
                const tr = e.target.closest('tr[data-record-id]');
                if (!tr) return;
                const id = tr.getAttribute('data-record-id');
                toggleDistributionInlineDetails(tr, id);
            });
        }

        function getDistributionColumnCount(){
            const headRow = document.querySelector('#distributionTable thead tr');
            return headRow ? headRow.children.length : 12;
        }

        function buildDistributionInlineDetailsRow(record){
            const cols = getDistributionColumnCount();
            const site = record.site?.name || record.site?.value || '';
            const operator = record.equipment?.operator || record.authorization?.requestedBy || '';
            const qty = record.fuel?.requestedQuantity || 0;
            const idx = (typeof record.fuel?.indexReading === 'number') ? record.fuel.indexReading : '-';
            const schedDate = record.schedule?.date ? new Date(`${record.schedule.date}T00:00:00`).toLocaleDateString(undefined,{ day:'2-digit', month:'short' }) : '';
            const schedTime = record.schedule?.time || '';
            const recordedAt = record.timestamp ? new Date(record.timestamp).toLocaleString() : '';
            const status = record.status || '';
            const requestedBy = record.authorization?.requestedBy || '';
            const department = record.authorization?.department || '';
            const costCenter = record.authorization?.costCenter || '';
            const securityAgent = record.authorization?.securityAgent || '';
            const supervisor = record.authorization?.supervisor || '';
            const eqType = record.equipment?.type || '';
            const eqId = record.equipment?.id || '';
            const location = record.equipment?.locationName || record.equipment?.location || '';

            const gridItem = (label, value) => `
                <div style="display:flex;flex-direction:column;gap:2px;min-width:160px;">
                    <span style="font-size:.55rem;font-weight:600;color:#64748b;letter-spacing:.3px;">${label}</span>
                    <span style="font-size:.7rem;color:#0f172a;">${value || '-'}</span>
                </div>`;

            const content = `
                <div style="display:flex;flex-direction:column;gap:.6rem;">
                    <div style="display:flex;flex-wrap:wrap;gap:1rem;">
                        ${gridItem('Equipment Type', eqType)}
                        ${gridItem('Equipment ID', eqId)}
                        ${gridItem('Location', location)}
                        ${gridItem('Site', site)}
                        ${gridItem('Operator', operator)}
                        ${gridItem('Quantity (L)', qty)}
                        ${gridItem('Index Reading', idx)}
                        ${gridItem('Consumption Date', schedDate)}
                        ${gridItem('Consumption Time', schedTime)}
                        ${gridItem('Recorded At', recordedAt)}
                        ${gridItem('Status', status)}
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:1rem;">
                        ${gridItem('Requested By', requestedBy)}
                        ${gridItem('Department', department)}
                        ${gridItem('Cost Center', costCenter)}
                        ${gridItem('Security Agent', securityAgent)}
                        ${gridItem('Supervisor', supervisor)}
                    </div>
                </div>`;

            return `<tr class="details-row" data-details-for="${record.id}"><td colspan="${cols}" style="background:#f8fafc;padding:.6rem .8rem;border-top:1px solid #e2e8f0;">${content}</td></tr>`;
        }

        function toggleDistributionInlineDetails(rowEl, recordId){
            if (!rowEl || !recordId) return;
            const next = rowEl.nextElementSibling;
            if (next && next.classList && next.classList.contains('details-row')) {
                // If same record, collapse; if different, remove and re-add
                if (next.getAttribute('data-details-for') === recordId) {
                    next.remove();
                    return;
                } else {
                    next.remove();
                }
            }
            const record = (filteredData && filteredData.length ? filteredData : distributionData).find(r=>r.id===recordId);
            if (!record) return;
            const detailsHtml = buildDistributionInlineDetailsRow(record);
            rowEl.insertAdjacentHTML('afterend', detailsHtml);
        }

        // Create table row HTML
        function createTableRow(record) {
            const statusClass = `status-${record.status.toLowerCase().replace('_', '-')}`;
            
            // Format dates
            const requestedDate = new Date(record.timestamp).toLocaleDateString(undefined,{ day:'2-digit', month:'short' });
            const scheduledDate = record.schedule?.date ? new Date(`${record.schedule.date}T${record.schedule.time || '00:00'}`).toLocaleString() : 'TBD';
            
            // Format fuel info
            const quantity = record.fuel?.requestedQuantity || 0;
            
            const consumpDate = requestedDate; // original timestamp as request; schedule.date is consumption
            const consumpTime = record.schedule?.time || '';
            const schedDateDisplay = record.schedule?.date ? new Date(`${record.schedule.date}T00:00:00`).toLocaleDateString(undefined,{ day:'2-digit', month:'short' }) : '';
            const operator = record.equipment?.operator || record.authorization?.requestedBy || '';
            const currentUserId = window.authManager?.getCurrentUser()?.uid || '';
            const canEdit = record.createdBy && record.createdBy === currentUserId;
            const canDelete = record.createdBy && record.createdBy === currentUserId;
            return `
                <tr data-record-id="${record.id}">
                    <td class="hidden-col" style="font-size:.72rem;font-weight:500;color:#1e293b;">${record.id}</td>
                    <td class="hidden-col" style="font-size:.7rem;color:#334155;">${record.equipment?.type || ''}</td>
                    <td style="font-size:.7rem;color:#334155;">${record.equipment?.id || ''}</td>
                    <td style="font-size:.7rem;color:#334155;">${record.equipment?.locationName || record.equipment?.location || ''}</td>
                    <td style="font-size:.7rem;color:#334155;">${record.site?.name || record.site?.value || ''}</td>
                    <td style="font-size:.7rem;color:#334155;">${operator}</td>
                    <td style="font-size:.72rem;font-weight:600;color:#1e293b;">${quantity}</td>
                    <td style="font-size:.7rem;color:#334155;">${typeof record.fuel?.indexReading === 'number' ? record.fuel.indexReading : '-'}</td>
                    <td style="font-size:.7rem;color:#334155;" data-ymd="${record.schedule?.date || ''}">${schedDateDisplay}${consumpTime ? `<div style=\"font-size:.6rem;color:#64748b;\">${consumpTime}</div>` : ''}</td>
                    <td style="font-size:.7rem;color:#334155;">${record.authorization?.department || ''}</td>
                    <td class="hidden-col" style="font-size:.7rem;color:#334155;">${record.authorization?.costCenter || ''}</td>
                    <td class="hidden-col" style="font-size:.7rem;color:#334155;">${record.authorization?.securityAgent || ''}</td>
                    <td class="hidden-col" style="font-size:.7rem;color:#334155;">${record.authorization?.supervisor || ''}</td>
                    <td class="hidden-col"><span class="status-badge ${statusClass}" style="text-transform:uppercase;">${record.status}</span></td>
                    <td>
                        <div class="table-actions">
                            ${canEdit ? `<button class="action-btn btn-edit icon-only" onclick="editDistribution('${record.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${canDelete ? `<button class="action-btn btn-delete icon-only" onclick="deleteDistribution('${record.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </td>
                </tr>`;
        }

        // Update pagination
        function updatePagination(totalPages, startIndex, endIndex, totalRecords) {
            const paginationDiv = document.getElementById('tablePagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            
            // Update buttons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            // Update info
            paginationInfo.textContent = `Showing ${startIndex + 1} - ${endIndex} of ${totalRecords} records`;
        }

        // Search distributions
        function searchDistributions() {
            const el = document.getElementById('searchInput');
            const searchTerm = el ? el.value.toLowerCase() : '';

            if (!searchTerm) {
                applyFilters();
                return;
            }
            
            filteredData = distributionData.filter(record => {
                return (
                    record.id.toLowerCase().includes(searchTerm) ||
                    record.equipment?.id?.toLowerCase().includes(searchTerm) ||
                    record.equipment?.type?.toLowerCase().includes(searchTerm) ||
                    record.fuel?.type?.toLowerCase().includes(searchTerm) ||
                    record.authorization?.requestedBy?.toLowerCase().includes(searchTerm) ||
                    record.status.toLowerCase().includes(searchTerm)
                );
            });
            
            currentPage = 1;
            renderDistributionTable();
        }

        // Filter distributions
        function filterDistributions() {
            applyFilters();
        }

        // Apply all filters
        function applyFilters() {
            const statusFilterEl = document.getElementById('statusFilter');
            const equipmentFilterEl = document.getElementById('equipmentFilter');
            const searchInputEl = document.getElementById('searchInput');
            const statusFilter = statusFilterEl ? statusFilterEl.value : '';
            const equipmentFilter = equipmentFilterEl ? equipmentFilterEl.value : '';
            const searchTerm = searchInputEl ? searchInputEl.value.toLowerCase() : '';
            const headerFilters = getDistributionHeaderFilters();
            
            filteredData = distributionData.filter(record => {
                // Status filter
                if (statusFilter && record.status !== statusFilter) {
                    return false;
                }
                
                // Equipment filter
                if (equipmentFilter && record.equipment?.type !== equipmentFilter) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        record.id,
                        record.equipment?.id,
                        record.equipment?.type,
                        record.fuel?.type,
                        record.authorization?.requestedBy,
                        record.status
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }

                // Header filters (per-column)
                // Equip. ID exact (dropdown)
                if (headerFilters.equipId) {
                    const v = (record.equipment?.id || '').toString();
                    if (v.toLowerCase() !== headerFilters.equipId.toLowerCase()) return false;
                }
                // Location exact (dropdown)
                if (headerFilters.location) {
                    const v = (record.equipment?.locationName || record.equipment?.location || '').toString();
                    if (v.toLowerCase() !== headerFilters.location.toLowerCase()) return false;
                }
                // Site exact (dropdown)
                if (headerFilters.site) {
                    const v = (record.site?.name || record.site?.value || '').toString();
                    if (v.toLowerCase() !== headerFilters.site.toLowerCase()) return false;
                }
                // Operator exact (dropdown) - fallback to requestedBy
                if (headerFilters.operator) {
                    const v = (record.equipment?.operator || record.authorization?.requestedBy || '').toString();
                    if (v.toLowerCase() !== headerFilters.operator.toLowerCase()) return false;
                }
                // Min Quantity
                if (headerFilters.minQty !== null && headerFilters.minQty !== undefined && headerFilters.minQty !== '') {
                    const qty = Number(record.fuel?.requestedQuantity) || 0;
                    if (qty < Number(headerFilters.minQty)) return false;
                }
                // Min Index
                if (headerFilters.minIndex !== null && headerFilters.minIndex !== undefined && headerFilters.minIndex !== '') {
                    const idx = (typeof record.fuel?.indexReading === 'number') ? record.fuel.indexReading : NaN;
                    if (isNaN(idx) || idx < Number(headerFilters.minIndex)) return false;
                }
                // Consumption exact date match via normalized YYYY-MM-DD
                if (headerFilters.date) {
                    const ymd = (record.schedule?.date || '').toString();
                    if (ymd !== headerFilters.date) return false;
                }
                // Department exact (dropdown)
                if (headerFilters.department) {
                    const v = (record.authorization?.department || '').toString();
                    if (v.toLowerCase() !== headerFilters.department.toLowerCase()) return false;
                }
                
                return true;
            });
            
            currentPage = 1;
            renderDistributionTable();
        }

        // Refresh distribution table
        function refreshDistributionTable() {
            // Fallback simple refresh if called from elsewhere
            loadDistributionData();
        }

        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            }
            
            renderDistributionTable();
        }

        // View distribution details
        function viewDistribution(distributionId) {
            openViewModal(distributionId);
        }

        function openViewModal(distributionId) {
            const record = distributionData.find(r => r.id === distributionId);
            if (!record) return;
            const modal = document.getElementById('distributionViewModal');
            if (!modal) return;

            const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val ?? ''; };
            setText('viewEquipmentType', record.equipment?.type || '');
            setText('viewEquipmentId', record.equipment?.id || '');
            setText('viewEquipmentLocation', record.equipment?.locationName || record.equipment?.location || '');
            // Also show Site if available
            const siteText = record.site?.name || record.site?.value || '';
            const viewSiteEl = document.getElementById('viewSite');
            if (viewSiteEl) viewSiteEl.textContent = siteText;
            setText('viewOperatorName', record.equipment?.operator || '');
            setText('viewQuantity', (record.fuel?.requestedQuantity || 0) + 'L');
            setText('viewIndexReading', typeof record.fuel?.indexReading === 'number' ? String(record.fuel.indexReading) : '-');
            const dt = record.schedule?.date && record.schedule?.time ? new Date(`${record.schedule.date}T${record.schedule.time}`) : null;
            setText('viewConsumptionDateTime', dt ? dt.toLocaleString() : '');
            setText('viewRecordedAt', record.timestamp ? new Date(record.timestamp).toLocaleString() : '');
            setText('viewStatus', record.status || '');
            setText('viewRequestedBy', record.authorization?.requestedBy || '');
            setText('viewDepartment', record.authorization?.department || '');
            setText('viewCostCenter', record.authorization?.costCenter || '');
            setText('viewSecurityAgent', record.authorization?.securityAgent || '');
            setText('viewSupervisor', record.authorization?.supervisor || '');

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeViewModal() {
            const modal = document.getElementById('distributionViewModal');
            if (!modal) return;
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Edit distribution
        function editDistribution(distributionId) {
            const record = distributionData.find(r => r.id === distributionId);
            if (!record) return;
            
            // Check if current user is the creator
            const currentUser = window.authManager?.getCurrentUser();
            if (!currentUser || !record.createdBy || record.createdBy !== currentUser.uid) {
                alert('You can only edit distributions that you have created.');
                return;
            }
            
            // For now, just open the modal and populate with existing data
            openDistributionModal();
            
            // Populate form with existing data
            setTimeout(() => {
                if (record.equipment) {
                    const typeVal = record.equipment.type === 'GEN' || record.equipment.type === 'Generators' ? 'Generators' : 'Vehicles';
                    document.getElementById('equipmentType').value = typeVal;
                    // Load options then set value
                    updateEquipmentOptions().then(() => {
                        const searchEl = document.getElementById('equipmentSearch');
                        if (searchEl) searchEl.value = '';
                        document.getElementById('equipmentId').value = record.equipment.id || '';
                    });
                    // Populate Site options and preselect, then filter and preselect Location
                    const selectedSite = (record.site && (record.site.value || record.site.name)) || '';
                    loadSites(selectedSite).then(() => {
                        // Show location group if site is selected
                        const locationGroup = document.getElementById('locationGroup');
                        if (locationGroup && selectedSite) {
                            locationGroup.style.display = 'flex';
                        }
                        loadLocationTankIds(record.equipment.location || '');
                    });
                    document.getElementById('operatorName').value = record.equipment.operator || '';
                }
                
                if (record.fuel) {
                    document.getElementById('requestedQuantity').value = record.fuel.requestedQuantity || '';
                    const idxField = document.getElementById('meterIndex');
                    if (idxField) idxField.value = (record.fuel.indexReading ?? '');
                }
                
                if (record.schedule) {
                    const date = record.schedule.date || '';
                    const time = (record.schedule.time || '');
                    const dtField = document.getElementById('scheduledDateTime');
                    if (date && dtField) {
                        const safeTime = time ? time : '00:00';
                        const composed = `${date}T${safeTime}`;
                        dtField.value = composed;
                    }
                    
                }
                
                if (record.authorization) {
                    document.getElementById('requestedBy').value = record.authorization.requestedBy || '';
                    document.getElementById('department').value = record.authorization.department || '';
                    document.getElementById('costCenter').value = record.authorization.costCenter || '';
                    if (document.getElementById('securityAgent')) {
                        document.getElementById('securityAgent').value = record.authorization.securityAgent || '';
                    }
                    if (document.getElementById('supervisor')) {
                        document.getElementById('supervisor').value = record.authorization.supervisor || '';
                    }
                    
                }
                
                // Store the ID for updating instead of creating new
                document.getElementById('distributionForm').setAttribute('data-edit-id', distributionId);
            }, 100);
        }

        // Approve distribution
        async function approveDistribution(distributionId) {
            if (!confirm('Are you sure you want to approve this distribution request?')) {
                return;
            }
            
            try {
                const companyId = window.authManager?.getCurrentUser()?.companyId;
                if (!companyId) throw new Error('Company ID not found');
                
                const distributionRef = firebase.database().ref(`fuelDistributions/${companyId}/${distributionId}`);
                await distributionRef.update({
                    status: 'APPROVED',
                    approvedAt: new Date().toISOString(),
                    approvedBy: window.authManager?.getCurrentUser()?.uid || 'unknown'
                });
                
                alert('Distribution approved successfully!');
                loadDistributionData();
                
            } catch (error) {
                console.error('Error approving distribution:', error);
                alert('Error approving distribution: ' + error.message);
            }
        }

        // Delete distribution
        async function deleteDistribution(distributionId) {
            if (!confirm('Are you sure you want to delete this distribution? This action cannot be undone.')) {
                return;
            }
            
            try {
                const companyId = window.authManager?.getCurrentUser()?.companyId;
                const currentUserId = window.authManager?.getCurrentUser()?.uid || '';
                if (!companyId) throw new Error('Company ID not found');
                
                const distributionRef = firebase.database().ref(`fuelDistributions/${companyId}/${distributionId}`);
                const snap = await distributionRef.once('value');
                if (!snap.exists()) throw new Error('Record not found');
                const record = snap.val();
                if (!record.createdBy || record.createdBy !== currentUserId) {
                    alert('You can only delete distributions you created.');
                    return;
                }
                // Revert storage adjustment prior to deletion (add back quantity to the tank)
                try {
                    await applyFuelStorageAdjustment(record, 'increment');
                } catch (e) {
                    console.warn('Non-blocking: failed to revert storage on delete', e);
                }
                await distributionRef.remove();
                
                alert('Distribution deleted successfully!');
                loadDistributionData();
                
            } catch (error) {
                console.error('Error deleting distribution:', error);
                alert('Error deleting distribution: ' + error.message);
            }
        }

        // ===== Excel Import/Export =====
        function normalizeHeader(h){ return String(h||'').trim().toLowerCase(); }

        function mapRecordToRow(r){
            return {
                id: r.id || '',
                timestamp: r.timestamp || '',
                status: r.status || '',
                equipmentType: r.equipment?.type || '',
                equipmentId: r.equipment?.id || '',
                location: r.equipment?.location || '',
                locationName: r.equipment?.locationName || '',
                operator: r.equipment?.operator || '',
                site: r.site?.value || '',
                siteName: r.site?.name || '',
                quantityL: r.fuel?.requestedQuantity || '',
                indexReading: r.fuel?.indexReading ?? '',
                scheduleDate: r.schedule?.date || '',
                scheduleTime: r.schedule?.time || '',
                requestedBy: r.authorization?.requestedBy || '',
                department: r.authorization?.department || '',
                costCenter: r.authorization?.costCenter || '',
                securityAgent: r.authorization?.securityAgent || '',
                supervisor: r.authorization?.supervisor || ''
            };
        }

        function exportDistributionsToExcel(){
            try{
                const rows = (distributionData && distributionData.length ? distributionData : filteredData).map(mapRecordToRow);
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Distributions');
                const fname = `fuel-distributions-${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fname);
            } catch(e){
                console.error('Excel export failed:', e);
                alert('Failed to export Excel. See console for details.');
            }
        }

        function downloadDistributionTemplate(){
            const headers = [{
                equipmentType:'LV|HV|GEN|PUMP|COMPRESSOR', equipmentId:'', location:'tank id or key', locationName:'optional', operator:'',
                site:'optional', siteName:'optional', quantityL:'number', indexReading:'number optional',
                scheduleDate:'YYYY-MM-DD', scheduleTime:'HH:mm', requestedBy:'', department:'', costCenter:'', securityAgent:'', supervisor:''
            }];
            const ws = XLSX.utils.json_to_sheet(headers);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'fuel-distribution-template.xlsx');
        }

        async function handleExcelImport(evt){
            const file = evt.target.files && evt.target.files[0];
            if(!file) return;
            try{
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, {defval:''});
                if(!Array.isArray(json) || json.length === 0){
                    alert('The Excel file is empty.');
                    return;
                }
                const user = window.authManager?.getCurrentUser?.();
                const companyId = user?.companyId;
                if(!companyId){ alert('No company context. Please sign in.'); return; }

                // Build header map (case-insensitive)
                const headerCells = Object.keys(json[0]);
                const headerMap = {};
                headerCells.forEach(h=>{ headerMap[normalizeHeader(h)] = h; });

                const requiredCols = ['equipmenttype','equipmentid','quantityl'];
                const missing = requiredCols.filter(c=>!(c in headerMap));
                if(missing.length){
                    alert('Missing required columns: ' + missing.join(', '));
                    return;
                }

                const db = window.firebase.database();
                const tasks = [];
                for(const row of json){
                    const equipmentType = row[headerMap['equipmenttype']]?.toString().trim();
                    const equipmentId = row[headerMap['equipmentid']]?.toString().trim();
                    const quantity = parseFloat(row[headerMap['quantityl']]);
                    if(!equipmentType || !equipmentId || !quantity || isNaN(quantity)) continue;

                    const location = headerMap['location'] ? String(row[headerMap['location']]||'').trim() : '';
                    const locationName = headerMap['locationname'] ? String(row[headerMap['locationname']]||'').trim() : '';
                    const operator = headerMap['operator'] ? String(row[headerMap['operator']]||'').trim() : '';
                    const site = headerMap['site'] ? String(row[headerMap['site']]||'').trim() : '';
                    const siteName = headerMap['sitename'] ? String(row[headerMap['sitename']]||'').trim() : '';
                    const indexReading = headerMap['indexreading'] ? parseFloat(row[headerMap['indexreading']]) : null;
                    const scheduleDate = headerMap['scheduledate'] ? String(row[headerMap['scheduledate']]||'').trim() : '';
                    const scheduleTime = headerMap['scheduletime'] ? String(row[headerMap['scheduletime']]||'').trim() : '';
                    const requestedBy = headerMap['requestedby'] ? String(row[headerMap['requestedby']]||'').trim() : '';
                    const department = headerMap['department'] ? String(row[headerMap['department']]||'').trim() : '';
                    const costCenter = headerMap['costcenter'] ? String(row[headerMap['costcenter']]||'').trim() : '';
                    const securityAgent = headerMap['securityagent'] ? String(row[headerMap['securityagent']]||'').trim() : '';
                    const supervisor = headerMap['supervisor'] ? String(row[headerMap['supervisor']]||'').trim() : '';

                    const id = generateDistributionId();
                    const record = {
                        id,
                        timestamp: new Date().toISOString(),
                        status: 'COMPLETED',
                        equipment: { type: equipmentType, id: equipmentId, location, locationName, operator },
                        site: { value: site, name: siteName },
                        fuel: { requestedQuantity: quantity, indexReading: (isNaN(indexReading)? null : indexReading) },
                        schedule: { date: scheduleDate, time: scheduleTime },
                        authorization: { requestedBy, department, costCenter, securityAgent, supervisor },
                        createdBy: user?.uid || 'unknown',
                        companyId
                    };

                    // Save and adjust storage
                    const ref = db.ref(`fuelDistributions/${companyId}/${id}`);
                    tasks.push(ref.set(record).then(()=>applyFuelStorageAdjustment(record, 'decrement')));
                }

                await Promise.all(tasks);
                alert('Excel import completed. Imported: ' + tasks.length);
                document.getElementById('excelInput').value = '';
                loadDistributionData();
            } catch(e){
                console.error('Excel import failed:', e);
                alert('Failed to import Excel. See console for details.');
                document.getElementById('excelInput').value = '';
            }
        }
        // Update stats cards
        function updateStatsCards() {
            const container = document.getElementById('listStatsSection');
            if (!container) return; // stats removed per request; keep function safe
            const today = new Date().toDateString();
            const totalDistributions = distributionData.length;
            const pendingDistributions = distributionData.filter(r => r.status === 'PENDING').length;
            const completedToday = distributionData.filter(r => r.status === 'COMPLETED' && new Date(r.timestamp).toDateString() === today).length;
            const totalFuelToday = distributionData
                .filter(r => r.status === 'COMPLETED' && new Date(r.timestamp).toDateString() === today)
                .reduce((total, r) => total + (r.fuel?.requestedQuantity || 0), 0);
            const el1 = document.getElementById('totalDistributions'); if (el1) el1.textContent = totalDistributions;
            const el2 = document.getElementById('pendingDistributions'); if (el2) el2.textContent = pendingDistributions;
            const el3 = document.getElementById('completedDistributions'); if (el3) el3.textContent = completedToday;
            const el4 = document.getElementById('totalFuelDistributed'); if (el4) el4.textContent = totalFuelToday + 'L';
        }

        // Show/hide table loading
        function showTableLoading(show) {
            document.getElementById('tableLoading').style.display = show ? 'block' : 'none';
            document.getElementById('distributionTable').style.display = show ? 'none' : 'table';
        }

        // Show/hide no data message
        function showNoData(show, message = null) {
            const noDataDiv = document.getElementById('noDataMessage');
            noDataDiv.style.display = show ? 'block' : 'none';
            document.getElementById('distributionTable').style.display = show ? 'none' : 'table';
            
            if (message) {
                noDataDiv.querySelector('p').textContent = message;
            }
        }

        // Load distribution stats (called from existing code)
        function loadDistributionStats() {
            loadDistributionData();
        }

        // === END STEP 3 FUNCTIONS ===
    </script>
    <script>
        // ========================= Reports (new) =========================
        let reportsSetupDone = false;
        function setupReportsOnce(){
            if (reportsSetupDone) return; reportsSetupDone = true;
            // Init EmailJS if keys present on window
            try{
                if (window.emailjs && !window.__emailjsInitialized) {
                    const publicKey = window.EMAILJS_PUBLIC_KEY || window.emailjsPublicKey || '';
                    if (publicKey) { emailjs.init({ publicKey }); window.__emailjsInitialized = true; }
                }
            } catch(e) { console.warn('EmailJS init skipped', e); }

            // Helper to ensure EmailJS is initialized at send-time
            window.ensureEmailJsInit = function ensureEmailJsInit(){
                try{
                    if (!window.emailjs) return false;
                    if (window.__emailjsInitialized) return true;
                    // Try various sources for the public key
                    let pk = window.EMAILJS_PUBLIC_KEY || window.emailjsPublicKey || '';
                    if (!pk){
                        try{ pk = localStorage.getItem('emailjsPublicKey') || pk; }catch(_){ }
                    }
                    if (!pk){
                        const meta = document.querySelector('meta[name="emailjs-public-key"]');
                        if (meta) pk = meta.getAttribute('content') || '';
                    }
                    if (pk){ emailjs.init({ publicKey: pk }); window.__emailjsInitialized = true; return true; }
                    return false;
                }catch(e){ console.warn('ensureEmailJsInit failed', e); return false; }
            };
            // Populate recipients from Firebase users
            try { populateReportRecipientsFromUsers(); } catch(e){ console.warn(e); }
            // Also populate modal recipients for modal-based workflow
            try { populateModalReportRecipients(); } catch(e){ console.warn(e); }
            // Default subject
            const subj = document.getElementById('reportEmailSubject');
            if (subj){ const {start,end}=getReportDateRange(); subj.value = buildDefaultReportSubject(start,end); }
            // Load saved types and generated reports
            // Saved Report Types removed
            try { loadGeneratedReports(); } catch(e) { /* ignore */ }
        }

        function getReportDateRange(){
            const start = (document.getElementById('reportDateStart')?.value || '').trim();
            const end = (document.getElementById('reportDateEnd')?.value || '').trim();
            return { start, end };
        }
        function setReportQuickRange(preset){
            const startEl = document.getElementById('reportDateStart');
            const endEl = document.getElementById('reportDateEnd');
            const today = new Date();
            const toYMD = d => d.toISOString().slice(0,10);
            let s = '', e = '';
            if (preset==='today') { s = e = toYMD(today); }
            else if (preset==='yesterday') { const d=new Date(today); d.setDate(d.getDate()-1); s=e=toYMD(d); }
            else if (preset==='last7') { const d=new Date(today); d.setDate(d.getDate()-6); s=toYMD(d); e=toYMD(today); }
            else if (preset==='thisMonth') { const d1=new Date(today.getFullYear(), today.getMonth(), 1); const d2=new Date(today.getFullYear(), today.getMonth()+1, 0); s=toYMD(d1); e=toYMD(d2); }
            else if (preset==='lastMonth') { const d1=new Date(today.getFullYear(), today.getMonth()-1, 1); const d2=new Date(today.getFullYear(), today.getMonth(), 0); s=toYMD(d1); e=toYMD(d2); }
            else if (preset==='all') { s=''; e=''; }
            if (startEl) startEl.value = s; if (endEl) endEl.value = e;
            const subj = document.getElementById('reportEmailSubject'); if (subj) subj.value = buildDefaultReportSubject(s,e);
            previewFuelReport();
        }
        function syncReportDatesFromAnalytics(){
            const aStart = document.getElementById('analyticsDateStart')?.value || '';
            const aEnd = document.getElementById('analyticsDateEnd')?.value || '';
            const rStart = document.getElementById('reportDateStart'); if (rStart) rStart.value = aStart;
            const rEnd = document.getElementById('reportDateEnd'); if (rEnd) rEnd.value = aEnd;
            const subj = document.getElementById('reportEmailSubject'); if (subj) subj.value = buildDefaultReportSubject(aStart,aEnd);
        }
        function buildDefaultReportSubject(start,end){
            let range='All Time'; if(start&&end) range=`${start} to ${end}`; else if(start) range=`from ${start}`; else if(end) range=`until ${end}`;
            return `Daily Fuel Distribution Report (${range})`;
        }

        // Populate modal recipients using same data source
        function getModalSelectedRecipients(){ return Array.isArray(window.__modalSelectedRecipients) ? window.__modalSelectedRecipients : []; }
        function setModalSelectedRecipients(arr){ window.__modalSelectedRecipients = Array.from(new Set(arr||[])); renderModalSelectedRecipients(); updateModalRecipientsButtonLabel(); }
        function renderModalSelectedRecipients(){
            const cont = document.getElementById('modalRecipientsSelected'); if(!cont) return; cont.innerHTML='';
            const selected = getModalSelectedRecipients();
            selected.forEach(email=>{
                const chip=document.createElement('span');
                chip.style.cssText='display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;padding:2px 6px;border-radius:9999px;font-size:.6rem;';
                chip.innerHTML = `<i class="fas fa-user"></i> ${email} <button type="button" style="border:none;background:transparent;color:#64748b;cursor:pointer;font-size:.7rem;" onclick="removeModalRecipient('${email}')">&times;</button>`;
                cont.appendChild(chip);
            });
        }
        function removeModalRecipient(email){ setModalSelectedRecipients(getModalSelectedRecipients().filter(e=>e!==email)); markDropdownChecksFromSelection(); }
        function updateModalRecipientsButtonLabel(){
            const btn = document.getElementById('modalRecipientsDropdownBtn'); if(!btn) return;
            const count = getModalSelectedRecipients().length; const span=btn.querySelector('span');
            if (span) span.textContent = count ? `${count} recipient${count>1?'s':''} selected` : 'Select recipients';
        }
        function toggleModalRecipientsDropdown(){
            const menu=document.getElementById('modalRecipientsDropdownMenu'); if(!menu) return;
            const isOpen = menu.style.display==='block';
            menu.style.display = isOpen ? 'none' : 'block';
        }
        function markDropdownChecksFromSelection(){
            const menu=document.getElementById('modalRecipientsDropdownMenu'); if(!menu) return;
            const selected = new Set(getModalSelectedRecipients());
            menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked = selected.has(cb.value); });
        }
        async function populateModalReportRecipients(){
            try{
                const menu = document.getElementById('modalRecipientsDropdownMenu'); if (!menu) return; menu.innerHTML='';
                if (!firebase || !firebase.database) return;
                const snap = await firebase.database().ref('users').once('value');
                const val = snap.val() || {};
                const users = Object.values(val).filter(u=>u && u.email);
                users.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                users.forEach(u=>{
                    const id = `modal_r_${(u.email||'').replace(/[^a-z0-9]/gi,'_')}`;
                    const row=document.createElement('label');
                    row.style.cssText='display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;';
                    row.innerHTML = `<input type="checkbox" value="${u.email}"> <span style="font-size:.7rem;color:#0f172a;">${u.name||u.email} <span style="color:#64748b;">&lt;${u.email}&gt;</span></span>`;
                    const cb = row.querySelector('input');
                    cb.addEventListener('change', ()=>{
                        const sel = new Set(getModalSelectedRecipients());
                        if (cb.checked) sel.add(cb.value); else sel.delete(cb.value);
                        setModalSelectedRecipients(Array.from(sel));
                    });
                    menu.appendChild(row);
                });
                markDropdownChecksFromSelection();
            } catch(e){ console.warn('populateModalReportRecipients failed', e); }
        }

        function initModalReportDefaultsFromPreview(){
            const meta = document.getElementById('reportPreviewMeta')?.textContent || '';
            const match = meta.match(/Range: ([^|]+)$/);
            const rangeText = match ? match[1].trim() : '';
            const subj = document.getElementById('modalReportEmailSubject');
            if (subj){
                // Fallback to analytics dates if available
                const aStart = document.getElementById('analyticsDateStart')?.value || '';
                const aEnd = document.getElementById('analyticsDateEnd')?.value || '';
                subj.value = buildDefaultReportSubject(aStart, aEnd) || `Daily Fuel Distribution Report (${rangeText||'All Time'})`;
            }
            // Initialize modal date range from analytics if blank
            const ms = document.getElementById('modalReportDateStart'); const me = document.getElementById('modalReportDateEnd');
            if (ms && me){
                const aStart = document.getElementById('analyticsDateStart')?.value || '';
                const aEnd = document.getElementById('analyticsDateEnd')?.value || '';
                ms.value = aStart; me.value = aEnd;
            }
            // Default schedule start-on to now rounded to next hour
            const startOn = document.getElementById('modalReportStartOn');
            if (startOn){ const now=new Date(); now.setMinutes(0,0,0); now.setHours(now.getHours()+1); startOn.value = now.toISOString().slice(0,16); }
        }

        async function generateAndSaveFuelReportFromModal(){
            // copy modal fields into the main report fields temporarily to reuse existing logic
            const subj = document.getElementById('modalReportEmailSubject')?.value || '';
            const msg = document.getElementById('modalReportEmailMessage')?.value || '';
            const recips = getModalSelectedRecipients();
            const extra = document.getElementById('modalReportEmails')?.value || '';
            // Dates from modal
            const ms = document.getElementById('modalReportDateStart')?.value || '';
            const me = document.getElementById('modalReportDateEnd')?.value || '';
            // Reflect into builder fields expected by existing functions
            if (document.getElementById('reportEmailSubject')) document.getElementById('reportEmailSubject').value = subj;
            if (document.getElementById('reportEmailMessage')) document.getElementById('reportEmailMessage').value = msg;
            if (document.getElementById('reportEmails')) document.getElementById('reportEmails').value = extra;
            const sel = document.getElementById('reportRecipients');
            if (sel){ Array.from(sel.options).forEach(o=> o.selected = recips.includes(o.value)); }
            // Set date range into main controls so getReportData uses modal dates
            if (document.getElementById('reportDateStart')) document.getElementById('reportDateStart').value = ms;
            if (document.getElementById('reportDateEnd')) document.getElementById('reportDateEnd').value = me;
            await generateAndSaveFuelReport();
        }

        // ===== Helpers: chart upload + HTML builders for email =====
        function dataUrlToBlob(dataUrl){
            try{
                const parts = dataUrl.split(',');
                const meta = parts[0]; const b64 = parts[1];
                const mime = (meta.match(/data:(.*?);base64/)||[])[1] || 'image/png';
                const bin = atob(b64);
                const len = bin.length; const arr = new Uint8Array(len);
                for (let i=0;i<len;i++) arr[i] = bin.charCodeAt(i);
                return new Blob([arr], { type: mime });
            }catch(e){ console.warn('dataUrlToBlob failed', e); return null; }
        }
        async function uploadChartDataUrlToStorage(dataUrl, filenameHint='chart.png'){
            try{
                if (!window.firebase || !firebase.storage) return '';
                const blob = dataUrlToBlob(dataUrl); if(!blob) return '';
                const ts = Date.now();
                const safe = String(filenameHint||'chart').replace(/[^a-z0-9]+/gi,'_');
                const path = `reports/fueldist/charts/${safe}_${ts}.png`;
                const ref = firebase.storage().ref().child(path);
                await ref.put(blob);
                const url = await ref.getDownloadURL();
                return url || '';
            }catch(e){ console.warn('uploadChartDataUrlToStorage failed', e); return ''; }
        }
        function buildReportTableHtml(headers, rows, maxRows=100){
            try{
                const lim = Math.max(1, Math.min(maxRows||100, rows.length));
                const extra = rows.length - lim;
                const head = `<tr>${headers.map(h=>`<th style="padding:6px 8px;border:1px solid #e5e7eb;background:#f8fafc;color:#334155;font-weight:600;font-size:12px;text-align:left;">${String(h||'')}</th>`).join('')}</tr>`;
                const body = rows.slice(0,lim).map(r=>`<tr>${r.map(c=>`<td style="padding:6px 8px;border:1px solid #e5e7eb;color:#0f172a;font-size:12px;">${String(c??'')}</td>`).join('')}</tr>`).join('');
                const tbl = `<table cellpadding="0" cellspacing="0" style="border-collapse:collapse;width:100%;max-width:900px;margin:8px 0;">${head}${body}</table>`;
                const note = extra>0 ? `<div style="font-size:12px;color:#64748b;margin-top:4px;"> and ${extra} more row(s) not shown</div>` : '';
                return tbl + note;
            }catch(e){ console.warn('buildReportTableHtml failed', e); return ''; }
        }
        function buildKpisHtml(totalLiters, totalRecords){
            const avg = totalRecords ? (totalLiters/totalRecords) : 0;
            return `
                <div style="display:flex;gap:12px;flex-wrap:wrap;margin:8px 0;">
                  <div style="border:1px solid #e2e8f0;border-radius:6px;padding:8px 10px;min-width:140px;">
                    <div style="font-size:11px;color:#64748b;font-weight:600;">TOTAL QTY (L)</div>
                    <div style="font-size:14px;color:#1e293b;font-weight:700;">${(totalLiters||0).toFixed(2)}</div>
                  </div>
                  <div style="border:1px solid #e2e8f0;border-radius:6px;padding:8px 10px;min-width:140px;">
                    <div style="font-size:11px;color:#64748b;font-weight:600;">ENTRIES</div>
                    <div style="font-size:14px;color:#1e293b;font-weight:700;">${totalRecords||0}</div>
                  </div>
                  <div style="border:1px solid #e2e8f0;border-radius:6px;padding:8px 10px;min-width:140px;">
                    <div style="font-size:11px;color:#64748b;font-weight:600;">AVG / ENTRY</div>
                    <div style="font-size:14px;color:#1e293b;font-weight:700;">${avg.toFixed(2)}</div>
                  </div>
                </div>`;
        }
                function ensureChartJsLoaded(){
                        if (typeof Chart !== 'undefined') return Promise.resolve();
                        return new Promise((resolve)=>{
                                const existing = document.getElementById('chartjs-lib');
                                if (existing){ existing.addEventListener('load', ()=>resolve()); return; }
                                const s = document.createElement('script');
                                s.id='chartjs-lib'; s.src='https://cdn.jsdelivr.net/npm/chart.js';
                                s.onload=()=>resolve();
                                document.head.appendChild(s);
                        });
                }
        async function ensureChartUrlForAgg(agg, filenameHint){
            // Deprecated by buildChartAsset; keep for backward compatibility
            const asset = await buildChartAsset(agg, filenameHint);
            return asset.url || asset.dataUrl || '';
        }
        async function buildChartAsset(agg, filenameHint='chart'){
            await ensureChartJsLoaded();
            let dataUrl='';
            try{
                const canvas = document.getElementById('reportPreviewChart');
                if (canvas && typeof canvas.toDataURL === 'function'){
                    // Allow a couple short retries for render completion
                    for (let i=0;i<4;i++){
                        if (canvas.width && canvas.height) break;
                        await new Promise(r=>setTimeout(r,60));
                    }
                    dataUrl = canvas.toDataURL('image/png');
                }
            }catch(e){ console.warn('Primary chart capture failed', e); }
            if (!dataUrl){
                try {
                    const labels = (agg.rows||[]).map(r=>String(r.key)).slice(0,30);
                    const qty = (agg.rows||[]).map(r=> +(+r.quantity).toFixed(2)).slice(0,30);
                    const off = createOffscreenCanvas(800,350);
                    const ctx = off.getContext('2d');
                    const chart = new Chart(ctx, { 
                        type:'bar', 
                        data:{ 
                            labels, 
                            datasets:[{ 
                                label:'Quantity (L)', 
                                data:qty, 
                                backgroundColor:'rgba(37, 99, 235, 0.8)', 
                                borderColor:'#2563eb', 
                                borderWidth:2,
                                borderRadius:8,
                                hoverBackgroundColor:'rgba(37, 99, 235, 0.95)'
                            }] 
                        }, 
                        options:{ 
                            responsive:false, 
                            plugins:{ 
                                legend:{ 
                                    display:true,
                                    position:'top',
                                    labels:{
                                        font:{ size:14, weight:'700', family:"'Inter', 'Segoe UI', sans-serif" },
                                        color:'#1e293b',
                                        padding:12,
                                        usePointStyle:true
                                    }
                                },
                                title:{
                                    display:true,
                                    text:'Fuel Distribution Analysis',
                                    font:{ size:18, weight:'700', family:"'Inter', 'Segoe UI', sans-serif" },
                                    color:'#0f172a',
                                    padding:{ top:10, bottom:20 }
                                }
                            }, 
                            scales:{ 
                                x:{
                                    ticks:{ 
                                        font:{ size:12, weight:'500' },
                                        color:'#475569',
                                        maxRotation:45,
                                        minRotation:0
                                    },
                                    grid:{ display:false },
                                    border:{ color:'#cbd5e1', width:2 }
                                },
                                y:{ 
                                    beginAtZero:true,
                                    ticks:{ 
                                        font:{ size:12, weight:'500' },
                                        color:'#475569'
                                    },
                                    grid:{ color:'rgba(203, 213, 225, 0.5)', lineWidth:1 },
                                    border:{ color:'#cbd5e1', width:2 }
                                } 
                            },
                            layout:{ padding:{ left:15, right:15, top:10, bottom:10 }}
                        } 
                    });
                    dataUrl = off.toDataURL('image/png');
                    try{ chart.destroy(); }catch(_){ }
                } catch(e){ console.warn('Offscreen chart failed', e); }
            }
            let url='';
            if (dataUrl){
                try { url = await uploadChartDataUrlToStorage(dataUrl, filenameHint); } catch(e){ console.warn('Chart upload failed', e); }
            }
            let inline='';
            if (dataUrl && dataUrl.length < 48000) inline = dataUrl; // keep under EmailJS var limit
            return { url, dataUrl:inline };
        }

        async function sendFuelReportFromModal(){
            try {
                console.log('sendFuelReportFromModal: Starting...');
                const subj = document.getElementById('modalReportEmailSubject')?.value || '';
                const msg = document.getElementById('modalReportEmailMessage')?.value || '';
                const recips = getModalSelectedRecipients();
                const extra = document.getElementById('modalReportEmails')?.value || '';
                const ms = document.getElementById('modalReportDateStart')?.value || '';
                const me = document.getElementById('modalReportDateEnd')?.value || '';
                
                console.log('Modal data:', { subj, msg, recips, extra, ms, me });
                
                // Since Reports tab controls are removed, call sendFuelReport() directly with modal data
                const title = window.__reportPreviewLastModel?.title || 'Daily Fuel Distribution Report';
                const message = msg;
                let recipients = [];
                
                // Get recipients from modal
                const selectedModal = recips || [];
                const extras = extra ? extra.split(',').map(s=>s.trim()).filter(Boolean) : [];
                recipients = Array.from(new Set([...selectedModal, ...extras]));
                
                console.log('Final recipients:', recipients);
                
                if(recipients.length === 0){ 
                    const s = document.getElementById('modalReportStatus'); 
                    if(s){ s.textContent='Select at least one recipient.'; s.style.color='#b91c1c'; } 
                    return; 
                }
                
                console.log('Sending email...');
                if (!window.emailjs) throw new Error('EmailJS SDK not loaded');
                if (typeof window.ensureEmailJsInit === 'function' && !window.ensureEmailJsInit()){
                    const s = document.getElementById('modalReportStatus');
                    if(s){ s.textContent='Email service not configured. Please set EmailJS public key.'; s.style.color='#b91c1c'; }
                    return;
                }
                
                // Build analytics model data for the template (use selected analytics model)
                const m = window.__reportPreviewLastModel || {};
                const modelTitle = m.title || title;
                const modelCategory = m.category || 'day';
                const dateStart = ms || m.start || '';
                const dateEnd = me || m.end || '';
                const dateRangeText = (dateStart || dateEnd) ? `${dateStart || ''} to ${dateEnd || ''}` : 'All Time';
                const dataset = (Array.isArray(window.filteredData) && window.filteredData.length) ? window.filteredData : window.distributionData;
                const templateType = (document.getElementById('modalReportTemplate')?.value || 'summary').trim();
                const agg = (typeof window.computeFuelAggregates === 'function') 
                    ? window.computeFuelAggregates(modelCategory, { start: dateStart, end: dateEnd, dataset })
                    : { rows: [], totals:{ quantity:0, records:0 } };
                const aRows = agg.rows || [];
                if (!aRows.length){ const s = document.getElementById('modalReportStatus'); if(s){ s.textContent='No data available for the selected period.'; s.style.color='#b91c1c'; } return; }
                const totalLiters = (agg.totals?.quantity)|| aRows.reduce((sum, r) => sum + (+r.quantity || 0), 0);
                const recordCount = (agg.totals?.records)|| aRows.reduce((n, r) => n + (r.records || 0), 0);
                const averageLiters = recordCount ? (totalLiters / recordCount) : 0;
                const headers = [...buildAnalyticsHeadersForGroup(modelCategory), 'AVG (L)'];
                const tableRows = aRows.map(r=>[r.key, r.records, (+r.quantity||0).toFixed(2), (r.records? (r.quantity/r.records):0).toFixed(2)]);
                // Skip building HTML blocks (EmailJS template handles presentation). We only need metrics + PDF.
                // Plaintext fallback
                const summaryText = `Report: ${modelTitle}\nCategory: ${modelCategory}\nPeriod: ${dateRangeText}\nTotal liters: ${totalLiters.toFixed(2)}\nTotal transactions: ${recordCount}`;
                const combinedMessage = msg ? `${msg}\n\n${summaryText}` : summaryText;
                                                                // Summary-only email body (no chart/table/kpis) per new requirement
                                                                const noteBlock = msg ? `<div style=\"background:#f1f5f9;border:1px solid #e2e8f0;padding:8px 10px;border-radius:4px;font-size:12px;margin:12px 0;white-space:pre-wrap;\">${msg.replace(/</g,'&lt;')}</div>` : '';
                                                                let siteBreakSection = '';
                                                                if (modelCategory === 'site') {
                                                                    try {
                                                                        const siteRows = (aRows||[]).map(r=>({ key:r.key, qty:+(+r.quantity||0) })).sort((a,b)=>b.qty-a.qty);
                                                                        const limited = siteRows.slice(0,50);
                                                                        const moreSites = siteRows.length - limited.length;
                                                                        const rowsHtml = limited.map(r=>`<tr>`+
                                                                            `<td style=\"padding:4px 6px;border:1px solid #e2e8f0;\">${r.key}</td>`+
                                                                            `<td style=\"padding:4px 6px;border:1px solid #e2e8f0;text-align:right;\">${r.qty.toFixed(2)}</td>`+
                                                                        `</tr>`).join('');
                                                                        siteBreakSection = `<div style=\"margin-top:14px;\">`
                                                                            + `<h3 style=\"margin:0 0 6px 0;font-size:14px;color:#334155;\">Quantity by Site</h3>`
                                                                            + `<table style=\"border-collapse:collapse;font-size:11px;width:100%;max-width:520px;\">`
                                                                                + `<thead><tr>`
                                                                                    + `<th style=\"background:#475569;color:#fff;padding:4px 6px;text-align:left;border:1px solid #475569;font-weight:600;\">Site</th>`
                                                                                    + `<th style=\"background:#475569;color:#fff;padding:4px 6px;text-align:right;border:1px solid #475569;font-weight:600;\">Liters (L)</th>`
                                                                                + `</tr></thead>`
                                                                                + `<tbody>${rowsHtml}${moreSites>0?`<tr><td colspan=\"2\" style=\"padding:4px 6px;border:1px solid #e2e8f0;font-size:10px;color:#64748b;text-align:center;\">(+ ${moreSites} more sites)</td></tr>`:''}</tbody>`
                                                                            + `</table>`
                                                                        + `</div>`;
                                                                    } catch(e){ console.warn('Site breakdown build failed (modal)', e); }
                                                                }
                                                                                                                                // Remove custom HTML - rely on EmailJS template only
                                                                                                                                let messageHtml = '';
                                // Size safeguard: if HTML is too large for EmailJS variable limits, fall back to plaintext summary
                                // Always prefer full HTML for template; keep a plain summary separately
                                const messagePlainSummary = combinedMessage; // plaintext summary (user text + summary)
                                let messageForTemplate = messageHtml;
                                let messageTruncated = false;
                                if (messageForTemplate.length > 48000){
                                    // Hard truncate very large HTML (rare as heavy blocks removed elsewhere)
                                    messageForTemplate = messageForTemplate.slice(0,47000) + '\n<!-- truncated -->';
                                    messageTruncated = true;
                                }

                                // Attempt PDF build (reuse last generated PDF if it matches current parameters to ensure identical output)
                                let attachmentPdfBase64 = '';
                                let attachmentPdfName = '';
                                const lastBlob = window.__lastFuelReportBlob;
                                const lastName = window.__lastFuelReportFilename;
                                const expectKey = `${modelTitle}|${dateStart}|${dateEnd}|${modelCategory}|${templateType}`;
                                // cache key stored when generating via button
                                const lastKey = window.__lastFuelReportKey;
                                async function ensurePdf(){
                                    try {
                                        if (lastBlob && lastName && lastKey === expectKey){
                                            attachmentPdfName = lastName;
                                            const existingB64 = await blobToBase64(lastBlob);
                                            attachmentPdfBase64 = existingB64.split(',')[1];
                                            console.log('[modal PDF] Reusing cached PDF', attachmentPdfName, 'size(b64url)=', existingB64.length);
                                            return;
                                        }
                                        if (typeof buildReportPdf === 'function') {
                                            const freshBlob = await buildReportPdf({ title: modelTitle, start: dateStart, end: dateEnd, headers, rows: tableRows, agg, templateType, totals:{ recordCount, totalLiters, averageLiters } });
                                            attachmentPdfName = (modelTitle.replace(/[^a-z0-9]+/gi,'_') || 'fuel_report') + '_' + Date.now() + '.pdf';
                                            const freshB64Url = await blobToBase64(freshBlob);
                                            attachmentPdfBase64 = freshB64Url.split(',')[1];
                                            // Cache for potential subsequent re-sends
                                            window.__lastFuelReportBlob = freshBlob;
                                            window.__lastFuelReportFilename = attachmentPdfName;
                                            window.__lastFuelReportKey = expectKey;
                                            console.log('[modal PDF] Generated new PDF', attachmentPdfName, 'size(b64url)=', freshB64Url.length, 'template=', templateType);
                                        }
                                    } catch(pdfErr){ console.warn('PDF attachment build failed (modal)', pdfErr); }
                                }
                                await ensurePdf();
                                // Always host PDF to avoid EmailJS 50KB variable limit
                                let pdf_attached = 'no';
                                let pdf_url = '';
                                if (attachmentPdfBase64) {
                                    try {
                                        if (firebase && firebase.storage) {
                                            const storageRef = firebase.storage().ref();
                                            const path = `reports/attachments/${(modelTitle.replace(/[^a-z0-9]+/gi,'_')||'fuel_report')}/${attachmentPdfName}`;
                                            const fileRef = storageRef.child(path);
                                            // Reuse cached blob if available
                                            const blobForUpload = window.__lastFuelReportBlob;
                                            if (blobForUpload) {
                                                await fileRef.put(blobForUpload, { contentType: 'application/pdf' });
                                                pdf_url = await fileRef.getDownloadURL();
                                                pdf_attached = 'hosted';
                                            }
                                        }
                                    } catch(upErr){ console.warn('PDF upload (modal) failed, no attachment URL.', upErr); }
                                }
                                const attachmentDataUri = ''; // do not inline to keep vars small

                                // Helper to optimize params size under EmailJS 50KB limit
                                async function optimizeParams(baseParams){
                                    let params = { ...baseParams };
                                    function paramSize(){ return JSON.stringify(params).length; }
                                    let size = paramSize();
                                    // Remove heavy optional HTML blocks first
                                    if (size > 48000){
                                        delete params.report_table_html;
                                        delete params.report_chart_inline;
                                        delete params.report_chart_img_block;
                                        delete params.report_kpis_html;
                                        delete params.report_combined_html;
                                        // No message_html to optimize since using EmailJS template
                                        size = paramSize();
                                    }
                                    // If still big and we have attachment, attempt fallback to hosted URL
                                    if (size > 48000 && params.attachment){
                                        try {
                                            const blob = window.__lastFuelReportBlob; // should exist after ensurePdf
                                            if (blob && firebase && firebase.storage){
                                                const storageRef=firebase.storage().ref();
                                                const path=`reports/email-fallback/${params.filename||('fuel_report_'+Date.now()+'.pdf')}`;
                                                const fileRef=storageRef.child(path);
                                                await fileRef.put(blob);
                                                const url = await fileRef.getDownloadURL();
                                                params.pdf_url = url;
                                                delete params.attachment; // remove inline data URI
                                                params.pdf_attached = 'no';
                                                size = paramSize();
                                            }
                                        } catch(e){ console.warn('PDF fallback upload failed', e); }
                                    }
                                    // Final safety: if still too large, aggressively truncate message
                                    if (size > 50000){
                                        if (typeof params.message_plain_summary === 'string' && params.message_plain_summary.length > 1200){
                                            params.message_plain_summary = params.message_plain_summary.slice(0,1100) + '\n...[truncated-text]';
                                            params.message_truncated = 'yes';
                                        }
                                        size = paramSize();
                                    }
                                    // As absolute last resort drop filename/base64 pair
                                    if (size > 50000){
                                        delete params.attachment;
                                        params.pdf_attached = 'no-final';
                                    }
                                    return params;
                                }

                
                const filenameBase = (modelTitle || 'daily fuel distribution report').replace(/[^a-z0-9]+/gi,'_').replace(/^_+|_+$/g,'').toLowerCase();
                const summary_text = summaryText; // explicit plaintext summary for template usage
                let params = {
                    to_name: recipients[0].split('@')[0] || 'User',
                    to_email: recipients[0],
                    bcc: recipients.slice(1).join(','),
                    subject: subj || `Daily Fuel Distribution Report (${dateRangeText})`,
                    filename_base: filenameBase,
                    filename: attachmentPdfName || (filenameBase + '_' + Date.now() + '.pdf'),
                    model_title: modelTitle,
                    model_category: modelCategory,
                    report_group_by: modelCategory,
                    report_template: templateType,
                    date_range_text: dateRangeText,
                    record_count: String(recordCount),
                    report_row_count: String(tableRows.length),
                    total_liters: totalLiters.toFixed(2),
                    average_liters: averageLiters.toFixed(2),
                    generation_timestamp: new Date().toLocaleString(),
                    report_id: String(Date.now()),
                    user_message: msg || '',
                    summary_text,
                    message_plain_summary: messagePlainSummary,
                    message: messagePlainSummary,
                    message_truncated: messageTruncated ? 'yes' : 'no',
                    site_breakdown_html: siteBreakSection || '',
                    pdf_url,
                    pdf_attached,
                    model_values: Array.isArray(m.values)? m.values.join(', ') : '',
                    system_link: window.location.href.replace(/\/[^\/]*$/, '/fueldist.html')
                };
                // No inline attachments to prevent 413 size error
                params = await optimizeParams(params);
                
                const serviceId = 'service_p2e9swy'; 
                const templateId = 'template_rvo75m5';
                // Enhanced debug logging block
                try {
                    const approxSize = (()=>{ try { return JSON.stringify(params).length; } catch { return 'n/a'; } })();
                    const keyLengths = Object.entries(params).map(([k,v])=>{
                        let len = '';
                        if (typeof v === 'string') len = v.length;
                        else if (v && typeof v === 'object') len = 'obj';
                        return `${k}:${len}`;
                    });
                    console.log('[EmailJS Debug] Preparing to send email', {
                        serviceId, templateId, approxJsonSize: approxSize,
                        paramCount: Object.keys(params).length,
                        keys: keyLengths
                    });
                    if (params.site_breakdown_html){
                        console.log('[EmailJS Debug] site_breakdown_html preview:', params.site_breakdown_html.slice(0,200)+'...');
                    }
                    if (params.message_plain_summary){
                        console.log('[EmailJS Debug] message_plain_summary preview:', params.message_plain_summary.slice(0,200)+'...');
                    }
                } catch(logErr){ console.warn('[EmailJS Debug] logging failure', logErr); }
                await emailjs.send(serviceId, templateId, params);
                
                const s = document.getElementById('modalReportStatus'); 
                if(s){ s.textContent=`Report sent to ${recipients.length} recipient(s).`; s.style.color='#475569'; }
                
                console.log('[EmailJS Debug] Email sent successfully via template', templateId);
            } catch(e){ 
                console.error('[EmailJS Debug] sendFuelReportFromModal error (service/template): service_p2e9swy/template_rvo75m5', e); 
                const s = document.getElementById('modalReportStatus'); 
                const emsg = (e && (e.text || e.message || e.status)) ? `${e.status? e.status+': ':''}${e.text || e.message || ''}` : (typeof e==='string'? e : JSON.stringify(e));
                if(s){ s.textContent='Failed to send report: '+ emsg; s.style.color='#b91c1c'; }
            }
        }

        async function scheduleReportFromModal(){
            try{
                if (!firebase || !firebase.database){ throw new Error('Firebase unavailable'); }
                const freq = document.getElementById('modalReportFrequency')?.value || 'one-time';
                const startOn = document.getElementById('modalReportStartOn')?.value || '';
                const start = document.getElementById('modalReportDateStart')?.value || '';
                const end = document.getElementById('modalReportDateEnd')?.value || '';
                const subj = document.getElementById('modalReportEmailSubject')?.value || '';
                const msg = document.getElementById('modalReportEmailMessage')?.value || '';
                const recipients = Array.from(document.getElementById('modalReportRecipients')?.selectedOptions||[]).map(o=>o.value);
                const extra = document.getElementById('modalReportEmails')?.value || '';
                const model = window.__reportPreviewLastModel || {};
                if (!recipients.length && !extra.trim()){ const s=document.getElementById('modalReportStatus'); if(s){ s.textContent='Select at least one recipient or add an email.'; s.style.color='#b91c1c'; } return; }
                const payload = {
                    modelId: model.id || '',
                    title: model.title || 'Daily Fuel Distribution Report',
                    category: model.category || 'day',
                    dateRange: { start, end },
                    frequency: freq,
                    startOn: startOn ? new Date(startOn).toISOString() : '',
                    recipients,
                    extraEmails: extra.split(',').map(s=>s.trim()).filter(Boolean),
                    subject: subj,
                    message: msg,
                    createdAt: Date.now(),
                };
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                await firebase.database().ref(`reportSchedules/fueldist/${companyId}`).push(payload);
                const s=document.getElementById('modalReportStatus'); if(s){ s.textContent='Schedule saved.'; s.style.color='#475569'; }
            }catch(e){ const s=document.getElementById('modalReportStatus'); if(s){ s.textContent='Failed to save schedule: '+e.message; s.style.color='#b91c1c'; } }
        }

        async function populateReportRecipientsFromUsers(){
            const sel = document.getElementById('reportRecipients'); if (!sel) return; sel.innerHTML='';
            const tryPaths = ['users','companyUsers']; const added = new Set();
            for (const path of tryPaths){
                try {
                    const snap = await firebase.database().ref(path).once('value');
                    const val = snap.val() || {};
                    Object.values(val).forEach(u=>{
                        const email=(u.email||u.workEmail||'').trim(); const name=(u.name||u.fullName||u.displayName||'').trim();
                        if(email && !added.has(email)){ added.add(email); const opt=document.createElement('option'); opt.value=email; opt.textContent=name?`${name} <${email}>`:email; sel.appendChild(opt); }
                    });
                } catch(e) { /* ignore */ }
            }
        }

        function previewFuelReport(){
            const status = document.getElementById('reportStatus');
            const head = document.getElementById('reportHead');
            const body = document.getElementById('reportBody');
            if (!head || !body) return; head.innerHTML=''; body.innerHTML='';
            const type = document.getElementById('reportType')?.value || 'summary';
            const reportCategory = document.getElementById('reportCategory')?.value || 'day';
            const { start, end } = getReportDateRange();
            const data = getReportData(type, reportCategory, start, end);
            if (!data || !data.rows || data.rows.length === 0){ if(status) status.textContent='No data for selected filters.'; return; }
            if (status) status.textContent='';
            data.headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; head.appendChild(th); });
            data.rows.slice(0,250).forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }); body.appendChild(tr); });
            const rc = document.getElementById('reportRowCount'); if (rc) rc.textContent = String(data.rows.length);
            // Compute total liters
            let totalLiters = 0;
            if ((document.getElementById('reportType')?.value || 'summary') === 'summary'){
                // In summary, Qty is in third column (index 2)
                totalLiters = data.rows.reduce((sum,row)=> sum + (parseFloat(row[2])||0), 0);
            } else {
                // In list, Quantity is 8th column (index 7)
                totalLiters = data.rows.reduce((sum,row)=> sum + (parseFloat(row[7])||0), 0);
            }
            const tl = document.getElementById('reportTotalLiters'); if (tl) tl.textContent = totalLiters.toFixed(2);
        }
        function getReportData(type, reportCategory, start, end){
            try{
                // Source selection: use current table filters if toggle is ON
                const useTable = !!document.getElementById('reportUseTableFilters')?.checked;
                const tableDataset = useTable ? ((Array.isArray(filteredData) && filteredData.length) ? filteredData : distributionData) : distributionData;
                if (type==='summary'){
                    const groupBy=reportCategory; const agg=computeFuelAggregates(groupBy, {start, end, dataset: tableDataset});
                    const headers = buildAnalyticsHeadersForGroup(groupBy);
                    const rows = (agg.rows||[]).map(r=>[r.key, r.records, r.quantity.toFixed(2), (r.quantity/Math.max(1,r.records)).toFixed(2)]);
                    return { headers: [...headers, 'AVG (L)'], rows };
                } else {
                    // List view honors tableDataset and trims by date range
                    const filtered = filterFuelRecordsByDate(start,end, tableDataset);
                    const headers = ['Date','ID','Equipment ID','Type','Location','Site','Operator','Quantity (L)','Index','Department','Cost Center','Security Agent','Supervisor','Status'];
                    const rows = filtered.map(r=>[
                        toYMD(r.schedule?.date || r.timestamp), r.id||'', r.equipment?.id||'', r.equipment?.type||'', r.equipment?.locationName||r.equipment?.location||'', r.site?.name||r.site?.value||'', r.equipment?.operator||'', safeNumber(r.fuel?.requestedQuantity), safeNumber(r.fuel?.indexReading), r.authorization?.department||'', r.authorization?.costCenter||'', r.authorization?.securityAgent||'', r.authorization?.supervisor||'', r.status||''
                    ]);
                    return { headers, rows };
                }
            } catch(e){ console.error('getReportData failed', e); return { headers:[], rows:[] }; }
        }
        function exportReportCsv(){
            const type = document.getElementById('reportType')?.value || 'summary';
            const reportCategory = document.getElementById('reportCategory')?.value || 'day';
            const { start, end } = getReportDateRange();
            const data = getReportData(type, reportCategory, start, end);
            if (!data || !data.rows || data.rows.length===0){ setReportStatus('No data to export.', true); return; }
            const esc = v => '"' + String(v??'').replace(/"/g,'""') + '"';
            const lines = [data.headers.map(esc).join(',')].concat(data.rows.map(r=>r.map(esc).join(',')));
            const csv = lines.join('\n');
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download = `Fuel_Report_${Date.now()}.csv`; a.click();
            setTimeout(()=>URL.revokeObjectURL(url), 1000);
        }
        function buildAnalyticsHeadersForGroup(groupBy){
            const map={
                day:['DATE','RECORDS','QTY (L)'], consumptionDate:['CONSUMPTION DATE','RECORDS','QTY (L)'], id:['RECORD ID','RECORDS','QTY (L)'],
                equipmentId:['EQUIPMENT ID','RECORDS','QTY (L)'], type:['EQUIPMENT TYPE','RECORDS','QTY (L)'], location:['LOCATION','RECORDS','QTY (L)'], site:['SITE','RECORDS','QTY (L)'], operator:['OPERATOR','RECORDS','QTY (L)'], quantity:['QTY BUCKET (L)','RECORDS','QTY (L)'], index:['INDEX BUCKET','RECORDS','QTY (L)'], department:['DEPARTMENT','RECORDS','QTY (L)'], costcenter:['COST CENTER','RECORDS','QTY (L)'], securityAgent:['SECURITY AGENT','RECORDS','QTY (L)'], supervisor:['SUPERVISOR','RECORDS','QTY (L)'], status:['STATUS','RECORDS','QTY (L)']
            }; return map[groupBy] || ['GROUP','RECORDS','QTY (L)'];
        }
        function filterFuelRecordsByDate(start,end, dataset){
            const all = (Array.isArray(dataset) ? dataset : (window.distributionData || []));
            const s = start ? new Date(start) : null; const e = end ? new Date(end) : null;
            return all.filter(r=>{
                const d = new Date(r.schedule?.date || r.timestamp || Date.now());
                if (s && d < new Date(s.getFullYear(), s.getMonth(), s.getDate())) return false;
                if (e && d > new Date(e.getFullYear(), e.getMonth(), e.getDate(), 23,59,59,999)) return false;
                return true;
            });
        }
        function toYMD(x){ try{ const d=new Date(x); if(!isNaN(d)) return d.toISOString().slice(0,10);}catch(e){} return (x||'').toString().slice(0,10); }
        function safeNumber(x){ const n=parseFloat(x||0); return isFinite(n)? +n.toFixed(2) : 0; }

        // ===== Analytics Model Save/Load =====
        function setAnalyticsStatus(msg, isError){ const el=document.getElementById('analyticsStatus'); if(el){ el.textContent=msg||''; el.style.color = isError ? '#b91c1c' : '#475569'; } }
        function getCurrentAnalyticsModelPayload(){
            const title = prompt('Enter a name for this analytics model:','Fuel Analytics Model');
            if (!title) return null;
            const category = document.getElementById('analyticsCategory')?.value || 'day';
            const start = document.getElementById('analyticsDateStart')?.value || '';
            const end = document.getElementById('analyticsDateEnd')?.value || '';
            const values = Array.isArray(window.__analyticsSelectedValues) ? window.__analyticsSelectedValues : [];
            // Capture the visible chart type and labels if available
            const chartMeta = (secondaryChartInstance && secondaryChartInstance.config) ? {
                type: secondaryChartInstance.config.type || 'bar',
                title: secondaryChartInstance.options?.plugins?.title?.text || '',
            } : { type:'bar', title:'' };
            // Capture multi-analysis sets snapshot (full table + chart meta) if helper present
            let sets = [];
            try { if (typeof window.__getAnalysisSetsSnapshot === 'function') sets = window.__getAnalysisSetsSnapshot(); } catch(e){ console.warn('Capture analysisSets failed', e); }
            return { title, category, start, end, values, chart: chartMeta, sets, createdAt: Date.now() };
        }
        async function saveCurrentAnalyticsModel(){
            try{
                if (!firebase || !firebase.database) throw new Error('Firebase not available');
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                const payload = getCurrentAnalyticsModelPayload();
                if (!payload) return;
                const ref = await firebase.database().ref(`analyticsModels/fueldist/${companyId}`).push(payload);
                setAnalyticsStatus('Analytics model saved.');
                await loadAnalyticsModels();
                // Show preview modal with all current analysis sets
                try { showModelPreviewModal(payload.title || 'Model Preview', payload.sets); } catch(e){ console.warn('preview modal failed', e); }
            } catch(e){ console.error(e); setAnalyticsStatus('Failed to save analytics model: '+e.message, true); }
        }
        async function updateCurrentAnalyticsModel(){
            try{
                const id = window.__editingAnalyticsModelId; if(!id){ setAnalyticsStatus('No model selected for update.', true); return; }
                if (!firebase || !firebase.database) throw new Error('Firebase not available');
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                // Build payload without prompting for new title unless user confirms
                const existing = window.__editingAnalyticsModelData || {};
                // Prefer title field from edit modal if present
                let newTitle = existing.title || 'Fuel Analytics Model';
                const titleInput = document.getElementById('modelEditTitle');
                if (titleInput){
                    const v = titleInput.value.trim();
                    if (v) newTitle = v;
                } else {
                    // Fallback to old prompt flow (no modal present)
                    const ask = confirm('Keep existing model title? Click Cancel to enter a new title.');
                    if (!ask){
                        const nt = prompt('Enter new title:', existing.title || 'Fuel Analytics Model');
                        if (nt) newTitle = nt;
                    }
                }
                // Gather current sets snapshot (table + chart meta) using helper if available
                let sets = [];
                try {
                    if (typeof window.__getAnalysisSetsSnapshot === 'function') {
                        sets = window.__getAnalysisSetsSnapshot();
                    } else if (typeof analysisSets !== 'undefined' && analysisSets instanceof Map) {
                        analysisSets.forEach((entry, sid)=>{ sets.push({ id: sid, cfg: { ...entry.cfg } }); });
                    }
                } catch(e){ console.warn('capture sets failed', e); }
                const payload = {
                    title: newTitle,
                    category: document.getElementById('analyticsCategory')?.value || 'day',
                    start: document.getElementById('analyticsDateStart')?.value || '',
                    end: document.getElementById('analyticsDateEnd')?.value || '',
                    values: Array.isArray(window.__analyticsSelectedValues) ? window.__analyticsSelectedValues : [],
                    sets,
                    chart: existing.chart || {},
                    createdAt: existing.createdAt || Date.now(),
                    updatedAt: Date.now()
                };
                await firebase.database().ref(`analyticsModels/fueldist/${companyId}/${id}`).set(payload);
                setAnalyticsStatus('Analytics model updated.');
                window.__editingAnalyticsModelId = null;
                window.__editingAnalyticsModelData = null;
                const upBtn = document.getElementById('mbUpdateModel'); if (upBtn) upBtn.style.display='none';
                const saveBtn = document.getElementById('mbSaveModel'); if (saveBtn) saveBtn.style.display='inline-block';
                await loadAnalyticsModels();
                // Show updated preview
                try { showModelPreviewModal(payload.title || 'Model Preview', payload.sets); } catch(e){ console.warn('preview modal failed', e); }
                closeModelEditModal();
            } catch(e){ console.error(e); setAnalyticsStatus('Failed to update analytics model: '+e.message, true); }
        }
        async function editAnalyticsModel(id){
            try {
                if (!firebase || !firebase.database) throw new Error('Firebase not available');
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                const snap = await firebase.database().ref(`analyticsModels/fueldist/${companyId}/${id}`).once('value');
                const m = snap.val(); if(!m) return;
                // Apply model (clears & restores sets) then toggle UI to update mode
                await applyAnalyticsModel(id);
                window.__editingAnalyticsModelId = id;
                window.__editingAnalyticsModelData = m;
                const upBtn = document.getElementById('mbUpdateModel'); if (upBtn) upBtn.style.display='inline-block';
                const saveBtn = document.getElementById('mbSaveModel'); if (saveBtn) saveBtn.style.display='none';
                setAnalyticsStatus('Edit mode: modify sets or filters, then click Update Model.');
                openModelEditModal(m);
            } catch(e){ console.error(e); setAnalyticsStatus('Failed to enter edit mode: '+e.message, true); }
        }
        let __analyticsModelsClickBound = false;
        async function loadAnalyticsModels(){
            try{
                const body=document.getElementById('analyticsModelsBody'); if(!body) return; body.innerHTML='';
                if (!firebase || !firebase.database) return;
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                const snap = await firebase.database().ref(`analyticsModels/fueldist/${companyId}`).once('value');
                const val = snap.val() || {};
                const rows = Object.entries(val).map(([id,m])=>({id,...m})).sort((a,b)=>b.createdAt-a.createdAt);
                body.innerHTML = rows.map(renderAnalyticsModelRow).join('');
                if (!__analyticsModelsClickBound){
                    body.addEventListener('click', (e)=>{
                        const target = e.target;
                        if ((target && target.closest('button'))) return; // ignore button clicks
                        const tr = target && target.closest('tr[data-id]');
                        if (!tr) return;
                        const id = tr.getAttribute('data-id');
                        if (id){ previewAnalyticsModel(id); }
                    });
                    __analyticsModelsClickBound = true;
                }
            } catch(e){ console.warn('loadAnalyticsModels failed', e); }
        }
        function renderAnalyticsModelRow(m){
            const range = (m.start||m.end) ? `${m.start||''} - ${m.end||''}` : 'All Time';
            const values = (m.values||[]).join(', ');
            const created = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
            return `<tr data-id="${m.id}" style="cursor:pointer;">
                <td>${escapeHtml(m.title||'')}</td>
                <td>${escapeHtml(m.category||'')}</td>
                <td>${escapeHtml(range)}</td>
                <td>${escapeHtml(values)}</td>
                <td>${escapeHtml(created)}</td>
                <td>
                    <button class="action-btn" style="padding:2px 6px;font-size:.6rem;background:#6366f1;color:#fff;" onclick="event.stopPropagation(); previewAnalyticsModel('${m.id}')">Preview</button>
                    <button class="action-btn" style="padding:2px 6px;font-size:.6rem;" onclick="event.stopPropagation(); applyAnalyticsModel('${m.id}')">Use</button>
                    <button class="action-btn" style="padding:2px 6px;font-size:.6rem;background:#475569;color:#fff;" onclick="event.stopPropagation(); openReportPreviewForAnalyticsModel('${m.id}')">Summary</button>
                    <button class="action-btn" style="padding:2px 6px;font-size:.6rem;background:#0d9488;color:#fff;" onclick="event.stopPropagation(); editAnalyticsModel('${m.id}')">Edit</button>
                    <button class="action-btn btn-delete" style="padding:2px 6px;font-size:.6rem;" onclick="event.stopPropagation(); deleteAnalyticsModel('${m.id}')">Delete</button>
                </td>
            </tr>`;
        }
        async function previewAnalyticsModel(id){
            try {
                if (!firebase || !firebase.database) throw new Error('Firebase not available');
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                const snap = await firebase.database().ref(`analyticsModels/fueldist/${companyId}/${id}`).once('value');
                const m = snap.val(); if(!m){ return; }
                const sets = Array.isArray(m.sets) ? m.sets : [];
                if (!sets.length){
                    // Fallback: if no snapshot tables exist but cfgs do, try to reconstruct minimal snapshot from cfgs
                    if (m.sets && m.sets.forEach){
                        // Build transient sets then snapshot
                        try {
                            clearAllCustom();
                            ensureBuilderSection();
                            for (const s of m.sets){ if (s.cfg) createAnalysisSetFromConfig(s.cfg); }
                            if (typeof window.__getAnalysisSetsSnapshot === 'function'){
                                const rebuilt = window.__getAnalysisSetsSnapshot();
                                showModelPreviewModal(m.title||'Model Preview', rebuilt);
                                return;
                            }
                        } catch(e){ console.warn('reconstruct fallback failed', e); }
                    }
                }
                showModelPreviewModal(m.title||'Model Preview', sets);
            } catch(e){ console.error('previewAnalyticsModel failed', e); }
        }
        async function openReportPreviewForAnalyticsModel(id){
            try{
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                const snap = await firebase.database().ref(`analyticsModels/fueldist/${companyId}/${id}`).once('value');
                const m=snap.val(); if(!m) return;
                const title=(m.title?`${m.title} - Summary`:'Daily Fuel Distribution Report');
                
                // Use same logic as preview modal to get snapshot sets
                const sets = Array.isArray(m.sets) ? m.sets : [];
                let reconstructedSets = [];
                
                if (!sets.length && m.sets && m.sets.forEach){
                    // Fallback: reconstruct sets if no snapshot available
                    try {
                        // Build transient sets then snapshot (similar to preview modal fallback)
                        const tempAnalysisSets = new Map();
                        for (const s of m.sets){ 
                            if (s.cfg) {
                                // Simulate set creation to get table/chart data
                                const groupBy = s.cfg.groupBy || 'day';
                                const start = s.cfg.start || '';
                                const end = s.cfg.end || '';
                                const dataset = (Array.isArray(filteredData) && filteredData.length) ? filteredData : distributionData;
                                const agg = computeFuelAggregates(groupBy, { start, end, dataset });
                                const headers = [...buildAnalyticsHeadersForGroup(groupBy), 'AVG (L)'];
                                const rows = (agg.rows||[]).map(r=>[r.key, r.records, r.quantity.toFixed(2), (r.quantity/Math.max(1,r.records)).toFixed(2)]);
                                
                                // Build table HTML
                                let tableHtml = '<table style="width:100%;border-collapse:collapse;font-size:0.55rem;">';
                                tableHtml += '<thead><tr>' + headers.map(h=>`<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;font-weight:600;">${h}</th>`).join('') + '</tr></thead>';
                                tableHtml += '<tbody>' + rows.slice(0,100).map(r=>'<tr>'+r.map(c=>`<td style="padding:4px 6px;border:1px solid #e2e8f0;">${c}</td>`).join('')+'</tr>').join('') + '</tbody>';
                                tableHtml += '</table>';
                                
                                // Build chart meta with enhanced colors
                                const chartMeta = {
                                    type: s.cfg.chartType || 'bar',
                                    labels: (agg.rows||[]).map(r=>r.key).slice(0,50),
                                    datasets: [{ 
                                        label: 'Quantity (L)', 
                                        data: (agg.rows||[]).map(r=> +(+r.quantity).toFixed(2)).slice(0,50), 
                                        backgroundColor: 'rgba(37, 99, 235, 0.75)', 
                                        borderColor: '#2563eb', 
                                        borderWidth: 2,
                                        borderRadius: 6
                                    }]
                                };
                                
                                reconstructedSets.push({ 
                                    id: s.id || ('set_' + reconstructedSets.length), 
                                    cfg: s.cfg, 
                                    table: tableHtml, 
                                    chart: chartMeta 
                                });
                            }
                        }
                    } catch(e){ console.warn('reconstruct sets failed', e); }
                }
                
                const finalSets = sets.length ? sets : reconstructedSets;
                
                // Clear existing content and render sets like preview modal
                const headEl=document.getElementById('reportPreviewHead'); 
                const bodyEl=document.getElementById('reportPreviewBody');
                if (headEl && bodyEl){ 
                    headEl.innerHTML=''; 
                    bodyEl.innerHTML='';
                    
                    if (finalSets.length) {
                        // Create multi-set view in table area
                        let combinedHtml = '';
                        finalSets.forEach((s, idx) => {
                            const { cfg, table, chart } = s;
                            const groupLabel = cfg?.groupBy || 'group';
                            const dateRange = (cfg?.start||cfg?.end)?`(${cfg.start||'...'} to ${cfg.end||'...'})`:'';
                            const chartType = cfg?.chartType || chart?.type || 'bar';
                            
                            combinedHtml += `
                                <div style="border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;margin-bottom:1rem;background:#fff;">
                                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                                        <span style="font-size:0.6rem;font-weight:600;color:#334155;">Set ${idx+1}: ${groupLabel} ${dateRange}</span>
                                        <span style="font-size:0.5rem;color:#64748b;">Chart: ${chartType}</span>
                                    </div>
                                    <div style="display:flex;flex-wrap:wrap;gap:0.75rem;">
                                        <div style="flex:1 1 420px;min-width:320px;border:1px solid #e2e8f0;border-radius:6px;padding:0.4rem;overflow:auto;">
                                            ${table || '<div style="font-size:0.55rem;color:#64748b;">(No table data)</div>'}
                                        </div>
                                        <div style="flex:1 1 420px;min-width:320px;border:1px solid #e2e8f0;border-radius:6px;padding:0.4rem;display:flex;flex-direction:column;">
                                            <canvas id="reportPrevChart_${idx}" style="width:100%;height:260px;"></canvas>
                                        </div>
                                    </div>
                                </div>`;
                        });
                        
                        bodyEl.innerHTML = combinedHtml;
                        
                        // Render charts after DOM insertion
                        const renderCharts = () => {
                            finalSets.forEach((s, idx) => {
                                try {
                                    const canvas = document.getElementById(`reportPrevChart_${idx}`);
                                    if (canvas && s.chart) {
                                        const ctx = canvas.getContext('2d');
                                        // Enhanced chart configuration with modern colors
                                        const enhancedDatasets = (s.chart.datasets || []).map((ds, dsIdx) => ({
                                            ...ds,
                                            backgroundColor: ds.backgroundColor || (dsIdx === 0 ? 'rgba(37, 99, 235, 0.75)' : 'rgba(14, 165, 233, 0.65)'),
                                            borderColor: ds.borderColor || (dsIdx === 0 ? '#2563eb' : '#0ea5e9'),
                                            borderWidth: 2,
                                            borderRadius: 6,
                                            hoverBackgroundColor: dsIdx === 0 ? 'rgba(37, 99, 235, 0.9)' : 'rgba(14, 165, 233, 0.85)',
                                            hoverBorderColor: dsIdx === 0 ? '#1e40af' : '#0284c7',
                                            hoverBorderWidth: 3
                                        }));
                                        
                                        const chartCfg = {
                                            type: s.chart.type || 'bar',
                                            data: { labels: s.chart.labels || [], datasets: enhancedDatasets },
                                            options: { 
                                                responsive:true, 
                                                maintainAspectRatio:false,
                                                layout:{ padding:{ left:10, right:10, top:15, bottom:5 }},
                                                plugins:{ 
                                                    legend:{ 
                                                        display:true,
                                                        position:'top',
                                                        labels:{ 
                                                            font:{ size:11, weight:'600', family:"'Inter', 'Segoe UI', sans-serif" },
                                                            color:'#334155',
                                                            padding:10,
                                                            usePointStyle:true,
                                                            pointStyle:'rectRounded',
                                                            boxWidth:12
                                                        } 
                                                    }, 
                                                    title:{ display:false },
                                                    tooltip:{
                                                        backgroundColor:'rgba(15, 23, 42, 0.95)',
                                                        titleColor:'#fff',
                                                        bodyColor:'#e2e8f0',
                                                        titleFont:{ size:12, weight:'700' },
                                                        bodyFont:{ size:11 },
                                                        padding:10,
                                                        cornerRadius:8,
                                                        displayColors:true,
                                                        borderColor:'rgba(148, 163, 184, 0.3)',
                                                        borderWidth:1
                                                    }
                                                },
                                                scales:{
                                                    x:{
                                                        ticks:{ 
                                                            font:{size:10, weight:'500'},
                                                            color:'#475569',
                                                            maxRotation:45,
                                                            minRotation:0
                                                        },
                                                        grid:{ display:false },
                                                        border:{ color:'#cbd5e1', width:1 }
                                                    },
                                                    y:{
                                                        ticks:{ 
                                                            font:{size:10, weight:'500'},
                                                            color:'#475569'
                                                        },
                                                        grid:{ color:'rgba(203, 213, 225, 0.4)', lineWidth:1 },
                                                        border:{ color:'#cbd5e1', width:1 },
                                                        beginAtZero:true
                                                    }
                                                },
                                                animation:{ 
                                                    duration:700,
                                                    easing:'easeInOutQuart'
                                                },
                                                interaction:{ mode:'index', intersect:false }
                                            }
                                        };
                                        if (typeof Chart !== 'undefined') new Chart(ctx, chartCfg);
                                    }
                                } catch(e){ console.warn('chart render failed', e); }
                            });
                        };
                        
                        if (typeof Chart === 'undefined') {
                            try { loadChartJs(renderCharts); } catch(e){ console.warn('failed to load Chart.js', e); }
                        } else {
                            renderCharts();
                        }
                    } else {
                        bodyEl.innerHTML = '<tr><td colspan="100%" style="text-align:center;padding:2rem;color:#64748b;">No analysis sets available</td></tr>';
                    }
                }
                
                document.getElementById('reportPreviewTitle').textContent = title;
                document.getElementById('reportPreviewMeta').textContent = `${finalSets.length} analysis set${finalSets.length===1?'':'s'}`;
                document.getElementById('reportPreviewRowCount').textContent = String(finalSets.length);
                document.getElementById('reportPreviewTotalLiters').textContent = '0'; // Will be calculated from sets if needed
                
                // Hide the single chart area since we're showing charts within sets
                const singleChartArea = document.getElementById('reportPreviewChart')?.closest('div[style*="height:calc"]');
                if (singleChartArea) singleChartArea.style.display = 'none';
                
                // Stash last applied model for handoff
                window.__reportPreviewLastModel = { id, title, category: m.category, start: m.start, end: m.end };
                openReportPreviewModal();
                populateModalReportRecipients();
                initModalReportDefaultsFromPreview();
            } catch(e){ console.error(e); setAnalyticsStatus('Failed to open report preview: '+e.message, true); }
        }
        function openReportPreviewModal(){
            const modal = document.getElementById('reportPreviewModal'); if(!modal) return; modal.classList.add('show'); document.body.style.overflow='hidden';
        }
        function closeReportPreviewModal(){ const modal=document.getElementById('reportPreviewModal'); if(!modal) return; modal.classList.remove('show'); document.body.style.overflow='auto'; }
        function applyReportPreviewToReports(){
            try{
                const m = window.__reportPreviewLastModel; if(!m) return;
                // Apply to report builder and switch
                document.getElementById('reportTitle').value = m.title;
                document.getElementById('reportType').value = 'summary';
                document.getElementById('reportCategory').value = m.category || 'day';
                document.getElementById('reportDateStart').value = m.start || '';
                document.getElementById('reportDateEnd').value = m.end || '';
                const subj = document.getElementById('reportEmailSubject'); if (subj) subj.value = buildDefaultReportSubject(m.start||'', m.end||'');
                switchFuelTab('reports');
                previewFuelReport();
                closeReportPreviewModal();
            } catch(e){ console.error(e); }
        }
        async function applyAnalyticsModel(id){
            try{
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                const snap = await firebase.database().ref(`analyticsModels/fueldist/${companyId}/${id}`).once('value');
                const m=snap.val(); if(!m) return;
                document.getElementById('analyticsCategory').value = m.category||'day';
                document.getElementById('analyticsDateStart').value = m.start||'';
                document.getElementById('analyticsDateEnd').value = m.end||'';
                // Apply values to the checkbox dropdown state and label
                window.__analyticsSelectedValues = Array.isArray(m.values)? m.values : [];
                try { updateAnalyticsDropdownLabel(); } catch(e) {}
                // Rebuild analysis sets if saved
                if (m.sets && Array.isArray(m.sets)){
                    try{ clearAllCustom(); }catch(e){ console.warn('clearAllCustom failed', e); }
                    // Ensure builder section exists
                    try{ if (typeof ensureBuilderSection === 'function') ensureBuilderSection(); }catch(e){}
                    // For each saved set create a new one with its cfg
                    for (const s of m.sets){
                        try{
                            const cfg = s.cfg || {}; // {groupBy, chartType, start, end}
                            // create set using internal helper mirrored from addAnalysisSet but with cfg
                            createAnalysisSetFromConfig(cfg);
                        }catch(e){ console.warn('restore set failed', e); }
                    }
                }
                setAnalyticsStatus('Analytics model applied (sets restored).');
                try { renderFuelAnalytics(); } catch(e){ }
            } catch(e){ console.error(e); setAnalyticsStatus('Failed to apply analytics model: '+e.message, true); }
        }
        async function deleteAnalyticsModel(id){
            try{
                const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
                await firebase.database().ref(`analyticsModels/fueldist/${companyId}/${id}`).remove();
                await loadAnalyticsModels();
            } catch(e){ console.error(e); setAnalyticsStatus('Failed to delete analytics model: '+e.message, true); }
        }

        function createOffscreenCanvas(w=800,h=300){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

        // Brand / design helpers for consistent palette & styling
        function getBrandPalette(){
            return [
                '#2563eb', // blue-600
                '#0ea5e9', // sky-500
                '#10b981', // emerald-500
                '#f59e0b', // amber-500
                '#ef4444', // red-500
                '#8b5cf6', // violet-500
                '#14b8a6', // teal-500
                '#6366f1'  // indigo-500
            ];
        }

        function buildGradient(ctx, pixelW, pixelH, baseColor){
            try {
                const g = ctx.createLinearGradient(0, 0, 0, pixelH);
                // Lighten & darken stops for subtle depth
                g.addColorStop(0, baseColor + 'E6'); // ~90% opacity
                g.addColorStop(0.5, baseColor + 'B3');
                g.addColorStop(1, baseColor + '80');
                return g;
            } catch(e){ return baseColor; }
        }

        // Lightweight value label plugin (no external dependency)
        const __pdfValueLabelPlugin = {
            id: 'pdfValueLabels',
            afterDatasetsDraw(chart, args, opts){
                const { ctx } = chart;
                const dataset = chart.data.datasets[0];
                if(!dataset) return;
                ctx.save();
                const meta = chart.getDatasetMeta(0);
                const fontSize = (opts && opts.fontSize) || 9 * (opts && opts.scale || 1);
                ctx.font = `600 ${fontSize}px Helvetica`;
                ctx.fillStyle = '#334155';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                meta.data.forEach((elem, i)=>{
                    if(!elem || !elem.x || !elem.y) return;
                    const raw = dataset.data[i];
                    if(raw == null) return;
                    // Skip if bar width too small (avoid clutter)
                    const props = elem.getProps(['x','y','base','width'], true);
                    if(props && props.width && props.width < 14) return;
                    const val = typeof raw === 'number' ? (raw >= 1000 ? raw.toFixed(0) : raw.toFixed(0)) : raw;
                    ctx.fillText(val, elem.x, elem.y - 4);
                });
                ctx.restore();
            }
        };

        function buildReportChartImage(agg){
            try{
                const labels = (agg.rows||[]).map(r=>String(r.key));
                const dataQty = (agg.rows||[]).map(r=> +(+r.quantity).toFixed(2));
                const canvas = createOffscreenCanvas(900, 300);
                const ctx = canvas.getContext('2d');
                const palette = getBrandPalette();
                const baseColor = palette[0];
                const gradient = buildGradient(ctx, canvas.width, canvas.height, baseColor);
                const chart = new Chart(ctx, { 
                    type:'bar', 
                    data:{ labels, datasets:[{ label:'Quantity (L)', data:dataQty, backgroundColor: gradient, borderColor: baseColor, borderWidth:1, maxBarThickness: 48 }] }, 
                    options:{ 
                        responsive:false, 
                        animation:false, 
                        plugins:{ legend:{ display:true, labels:{ color:'#334155', font:{ size:12, weight:600 } } } }, 
                        layout:{ padding:{ top:8, right:8, left:8, bottom:0 } },
                        scales:{ 
                            x:{ ticks:{ color:'#475569', font:{ size:10 } }, grid:{ display:false, drawBorder:false } }, 
                            y:{ ticks:{ color:'#475569', font:{ size:10 } }, grid:{ color:'#e2e8f0', drawBorder:false }, beginAtZero:true } 
                        } 
                    } 
                });
                const dataUrl = canvas.toDataURL('image/png');
                try { chart.destroy(); } catch(e){}
                return { dataUrl, width: canvas.width, height: canvas.height };
            }catch(e){ console.warn('buildReportChartImage failed', e); return null; }
        }

        // Helper: build a chart specifically for PDF with animations disabled (reliable immediate capture) - enhanced quality
        function buildReportChartImageForPdf(agg, width=900, height=280, scale=3){
            // High-DPI rendering: render at scale*width then downscale inside PDF for crispness.
            try{
                if (scale < 1) scale = 1;
                const labels = (agg.rows||[]).map(r=>String(r.key));
                const dataQty = (agg.rows||[]).map(r=> +(+r.quantity).toFixed(2));
                const pixelW = width * scale;
                const pixelH = height * scale;
                const canvas = createOffscreenCanvas(pixelW, pixelH);
                const ctx = canvas.getContext('2d');
                const palette = getBrandPalette();
                const baseColor = palette[0];
                const gradient = buildGradient(ctx, pixelW, pixelH, baseColor);
                const baseTickFont = 9 * scale; // slightly larger for readability
                const baseLegendFont = 11 * scale;
                const chart = new Chart(ctx, { 
                    type:'bar', 
                    data:{ 
                        labels, 
                        datasets:[{ 
                            label:'Quantity (L)', 
                            data:dataQty, 
                            backgroundColor: gradient, 
                            borderColor: baseColor, 
                            borderWidth: Math.max(1, Math.round(scale*0.75)),
                            maxBarThickness: 56
                        }] 
                    }, 
                    options:{ 
                        responsive:false, 
                        animation:false, 
                        maintainAspectRatio:false,
                        plugins:{ 
                            legend:{ display:true, labels:{ font:{ size: baseLegendFont, weight:600 }, color:'#334155', padding: 12 } },
                            pdfValueLabels:{ scale, fontSize: 9 * scale }
                        }, 
                        layout:{ padding:{ top: 12*scale, left: 8*scale, right: 8*scale, bottom: 4*scale } },
                        scales:{ 
                            x:{ ticks:{ font:{ size: baseTickFont }, color:'#475569', maxRotation: 40, autoSkip: true, autoSkipPadding: 4 }, grid:{ display:false, drawBorder:false } }, 
                            y:{ ticks:{ font:{ size: baseTickFont }, color:'#475569' }, grid:{ color:'#e2e8f0', drawBorder:false, lineWidth:1 }, beginAtZero:true } 
                        } 
                    },
                    plugins:[__pdfValueLabelPlugin]
                });
                chart.update(); // force synchronous render
                const dataUrl = canvas.toDataURL('image/png');
                try { chart.destroy(); } catch(_){ }
                return { dataUrl, width, height, pixelWidth: pixelW, pixelHeight: pixelH, scale };
            }catch(e){ console.warn('buildReportChartImageForPdf failed', e); return null; }
        }
        async function buildReportPdf({ title, start, end, headers, rows, agg, templateType='summary', totals }){
            const { jsPDF } = window.jspdf || {}; if (!jsPDF) throw new Error('jsPDF not loaded');
            try { await ensureChartJsLoaded(); } catch(e){ console.warn('Chart.js load before PDF failed', e); }
            const doc = new jsPDF({ orientation:'l', unit:'pt', format:'a4' });
            const marginLeft = 40;
            doc.setFontSize(12); doc.text(title, marginLeft, 30);
            const rangeText = buildDefaultReportSubject(start, end).replace('Daily Fuel Distribution Report ','');
            doc.setFontSize(9); doc.text(rangeText, marginLeft, 44);
            doc.setFontSize(8); doc.text(`Template: ${templateType}`, marginLeft, 56);

            // Metrics (if provided)
            let currentY = 60;
            if (totals && typeof totals === 'object'){
                const metricsHead = [['Metric','Value']];
                const metricsBody = [
                    ['Total Records', String(totals.recordCount||0)],
                    ['Total Fuel (L)', (totals.totalLiters!=null? (+totals.totalLiters).toFixed(2):'0.00')],
                    ['Average / Record (L)', (totals.averageLiters!=null? (+totals.averageLiters).toFixed(2):'0.00')]
                ];
                doc.autoTable({ head: metricsHead, body: metricsBody, startY: currentY, styles:{ fontSize:8 }, headStyles:{ fillColor:[71,85,105] } });
                currentY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 12 : currentY + 12;
            }

            // MAIN DATA TABLE
            doc.autoTable({ head:[headers], body:rows, startY: currentY, styles:{ fontSize:8 }, headStyles:{ fillColor:[51,65,85] } });
            let yAfterTable = doc.lastAutoTable ? doc.lastAutoTable.finalY + 16 : currentY + 16;
            // Then CHART below table (new requirement)
            try {
                const chartImg = buildReportChartImageForPdf(agg||{}, 900, 280, 2); // scale 2x for sharper output
                if (chartImg){
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const maxWidth = pageWidth - marginLeft*2;
                    const ratio = chartImg.height / chartImg.width; // logical size ratio
                    const drawW = Math.min(maxWidth, chartImg.width);
                    const drawH = drawW * ratio;
                    const pageHeight = doc.internal.pageSize.getHeight();
                    if (yAfterTable + drawH + 40 > pageHeight){
                        doc.addPage();
                        yAfterTable = 40;
                    }
                    // Embed high-res bitmap scaled down; jsPDF will downscale from pixelWidth/pixelHeight inside dataUrl
                    doc.addImage(chartImg.dataUrl, 'PNG', marginLeft, yAfterTable, drawW, drawH);
                }
            } catch(e){ console.warn('Chart below-table embedding failed', e); }
            return doc.output('blob');
        }
        async function generateAndSaveFuelReport(){
            // Fallback to modal/preview values when Reports controls are hidden
            const type = document.getElementById('reportType')?.value || 'summary';
            const reportCategory = document.getElementById('reportCategory')?.value || (window.__reportPreviewLastModel?.category || 'day');
            const title = (document.getElementById('reportTitle')?.value || window.__reportPreviewLastModel?.title || 'Daily Fuel Distribution Report').trim();
            let { start, end } = getReportDateRange();
            if (!start && !end){
                start = document.getElementById('modalReportDateStart')?.value || (window.__reportPreviewLastModel?.start || '');
                end = document.getElementById('modalReportDateEnd')?.value || (window.__reportPreviewLastModel?.end || '');
            }
            const data = getReportData(type, reportCategory, start, end);
            if (!data.rows || data.rows.length === 0){ setReportStatus('No data to generate report.', true); return; }
            try{
                // Build agg for chart: if we have a list, aggregate by day for chart
                const srcDataset = (Array.isArray(filteredData) && filteredData.length) ? filteredData : distributionData;
                const agg = (type==='summary') ? computeFuelAggregates(reportCategory, { start, end, dataset: srcDataset }) : computeFuelAggregates('day', { start, end, dataset: srcDataset });
                const pdfBlob = await buildReportPdf({ title, start, end, headers: data.headers, rows: data.rows, agg });
                const filename = `${title.replace(/[^a-z0-9]+/gi,'_')}_${Date.now()}.pdf`;
                let downloadURL='';
                try{
                    if (firebase && firebase.storage){
                        const storageRef=firebase.storage().ref(); const path=`reports/fueldist/${filename}`; const fileRef=storageRef.child(path);
                        await fileRef.put(pdfBlob); downloadURL = await fileRef.getDownloadURL();
                    }
                } catch(e){ console.warn('Upload skipped or failed', e); }
                try{
                    if (firebase && firebase.database){
                        const meta={ title, type, category:reportCategory, start, end, createdAt:Date.now(), file:filename, url:downloadURL||'', rows:data.rows.length };
                        await firebase.database().ref('reports/fueldist').push(meta);
                    }
                } catch(e){ console.warn('DB log skipped', e); }
                setReportStatus(`Report generated${downloadURL?` and uploaded: ${downloadURL}`:'. PDF ready for sending.'}`);
                window.__lastFuelReportBlob = pdfBlob; window.__lastFuelReportFilename = filename; window.__lastFuelReportDownloadURL = downloadURL || '';
                try { loadGeneratedReports(); } catch(e) { /* ignore */ }
            } catch(e){ console.error(e); setReportStatus('Failed to generate report PDF. '+e.message, true); }
        }
        function setReportStatus(msg,isError){ const el=document.getElementById('reportStatus'); if(el){ el.textContent=msg; el.style.color = isError ? '#b91c1c' : '#475569'; } }
        async function sendFuelReport(){
            const title=(document.getElementById('reportTitle')?.value||window.__reportPreviewLastModel?.title||'Daily Fuel Distribution Report').trim();
            const subject=(document.getElementById('reportEmailSubject')?.value||document.getElementById('modalReportEmailSubject')?.value||title).trim();
            const message=(document.getElementById('reportEmailMessage')?.value||document.getElementById('modalReportEmailMessage')?.value||'').trim();
            // Collect recipients from Reports tab controls if present, else from modal
            let recipients=[];
            const sel=document.getElementById('reportRecipients');
            if (sel){
                const extra=(document.getElementById('reportEmails')?.value||'').trim();
                const selected=Array.from(sel.selectedOptions||[]).map(o=>o.value);
                const extras=extra? extra.split(',').map(s=>s.trim()).filter(Boolean):[];
                recipients = Array.from(new Set([...selected, ...extras]));
            } else {
                const selectedModal = (typeof getModalSelectedRecipients==='function') ? getModalSelectedRecipients() : [];
                const extraModal = (document.getElementById('modalReportEmails')?.value||'').trim();
                const extras = extraModal? extraModal.split(',').map(s=>s.trim()).filter(Boolean):[];
                recipients = Array.from(new Set([...selectedModal, ...extras]));
            }
            if(recipients.length===0){ setReportStatus('Select at least one recipient.', true); return; }
            // Build model-aligned HTML (chart + table) and include as template variables; keep payload small.
            try{
                if (!window.emailjs) throw new Error('EmailJS SDK not loaded');
                if (typeof window.ensureEmailJsInit === 'function' && !window.ensureEmailJsInit()){
                    setReportStatus('Email service not configured. Please set EmailJS public key.', true);
                    return;
                }
                
                const m = window.__reportPreviewLastModel || {};
                const modelTitle = m.title || title;
                const modelCategory = m.category || 'day';
                const dateStart = (document.getElementById('modalReportDateStart')?.value||m.start||'');
                const dateEnd = (document.getElementById('modalReportDateEnd')?.value||m.end||'');
                const dateRangeText = (dateStart || dateEnd) ? `${dateStart || ''} to ${dateEnd || ''}` : 'All Time';
                const dataset = (Array.isArray(window.filteredData) && window.filteredData.length) ? window.filteredData : window.distributionData;
                const templateType = (document.getElementById('reportTemplate')?.value || document.getElementById('modalReportTemplate')?.value || 'summary').trim();
                const agg = (typeof window.computeFuelAggregates === 'function') 
                    ? window.computeFuelAggregates(modelCategory, { start: dateStart, end: dateEnd, dataset })
                    : { rows: [], totals:{ quantity:0, records:0 } };
                const aRows = agg.rows || [];
                if (!aRows.length){ setReportStatus('No data available for the selected period.', true); return; }
                const totalLiters = (agg.totals?.quantity)|| aRows.reduce((sum, r) => sum + (+r.quantity || 0), 0);
                const recordCount = (agg.totals?.records)|| aRows.reduce((n, r) => n + (r.records || 0), 0);
                const averageLiters = recordCount ? (totalLiters / recordCount) : 0;
                const headers = [...buildAnalyticsHeadersForGroup(modelCategory), 'AVG (L)'];
                const tableRows = aRows.map(r=>[r.key, r.records, (+r.quantity||0).toFixed(2), (r.records? (r.quantity/r.records):0).toFixed(2)]);
                                // Skip generating large HTML blocks (template renders layout). Only gather metrics and attach PDF.

                // PDF attachment (reuse cached if matches to ensure identical file as generate button)
                let attachmentPdfBase64 = '';
                let attachmentPdfName = '';
                const nmExpectKey = `${modelTitle}|${dateStart}|${dateEnd}|${modelCategory}|${templateType}`;
                const nmLastBlob = window.__lastFuelReportBlob;
                const nmLastName = window.__lastFuelReportFilename;
                const nmLastKey = window.__lastFuelReportKey;
                async function ensurePdfNonModal(){
                    try {
                        if (nmLastBlob && nmLastName && nmLastKey === nmExpectKey){
                            attachmentPdfName = nmLastName;
                            const reuseB64Url = await blobToBase64(nmLastBlob);
                            attachmentPdfBase64 = reuseB64Url.split(',')[1];
                            console.log('[non-modal PDF] Reusing cached PDF', attachmentPdfName, 'size(b64url)=', reuseB64Url.length);
                            return;
                        }
                        if (typeof buildReportPdf === 'function') {
                            const freshBlob = await buildReportPdf({ title: modelTitle, start: dateStart, end: dateEnd, headers, rows: tableRows, agg, templateType, totals:{ recordCount, totalLiters, averageLiters } });
                            attachmentPdfName = (modelTitle.replace(/[^a-z0-9]+/gi,'_') || 'fuel_report') + '_' + Date.now() + '.pdf';
                            const freshB64Url = await blobToBase64(freshBlob);
                            attachmentPdfBase64 = freshB64Url.split(',')[1];
                            window.__lastFuelReportBlob = freshBlob;
                            window.__lastFuelReportFilename = attachmentPdfName;
                            window.__lastFuelReportKey = nmExpectKey;
                            console.log('[non-modal PDF] Generated new PDF', attachmentPdfName, 'size(b64url)=', freshB64Url.length);
                        }
                    } catch(e){ console.warn('Non-modal PDF build failed', e); }
                }
                await ensurePdfNonModal();
                // Always host PDF (remove inline base64 to stay under 50KB limit)
                let pdf_attached = 'no';
                let pdf_url = '';
                if (attachmentPdfBase64) {
                    try {
                        if (firebase && firebase.storage) {
                            const storageRef = firebase.storage().ref();
                            const path = `reports/attachments/${(modelTitle.replace(/[^a-z0-9]+/gi,'_')||'fuel_report')}/${attachmentPdfName}`;
                            const fileRef = storageRef.child(path);
                            const blobForUpload = window.__lastFuelReportBlob;
                            if (blobForUpload) {
                                await fileRef.put(blobForUpload, { contentType: 'application/pdf' });
                                pdf_url = await fileRef.getDownloadURL();
                                pdf_attached = 'hosted';
                            }
                        }
                    } catch(upErr){ console.warn('PDF upload (non-modal) failed.', upErr); }
                }
                const attachmentDataUri2 = '';

                async function optimizeParamsNonModal(baseParams){
                    let params = { ...baseParams };
                    const size = JSON.stringify(params).length;
                    if (size > 48000 && params.attachment){
                        try {
                            const blob = window.__lastFuelReportBlob;
                            if (blob && firebase && firebase.storage){
                                const storageRef=firebase.storage().ref();
                                const path=`reports/email-fallback/${params.filename||('fuel_report_'+Date.now()+'.pdf')}`;
                                const fileRef=storageRef.child(path);
                                await fileRef.put(blob);
                                const url = await fileRef.getDownloadURL();
                                params.pdf_url = url;
                                delete params.attachment;
                                params.pdf_attached = 'no';
                            }
                        } catch(e){ console.warn('Non-modal PDF fallback upload failed', e); }
                    }
                    return params;
                }
                const summaryText = `Report: ${modelTitle}\nCategory: ${modelCategory}\nPeriod: ${dateRangeText}\nTotal liters: ${totalLiters.toFixed(2)}\nTotal transactions: ${recordCount}`;
                const combinedMessage = (message || '').trim() ? `${message}\n\n${summaryText}` : summaryText;
                                                // Summary-only body (no chart/table/kpis) per new requirement
                                                const noteBlock = message ? `<div style=\"background:#f1f5f9;border:1px solid #e2e8f0;padding:8px 10px;border-radius:4px;font-size:12px;margin:12px 0;white-space:pre-wrap;\">${message.replace(/</g,'&lt;')}</div>` : '';
                                                let siteBreakSection2 = '';
                                                if (modelCategory === 'site') {
                                                    try {
                                                        const siteRows2 = (aRows||[]).map(r=>({ key:r.key, qty:+(+r.quantity||0) })).sort((a,b)=>b.qty-a.qty);
                                                        const limited2 = siteRows2.slice(0,50);
                                                        const moreSites2 = siteRows2.length - limited2.length;
                                                        const rowsHtml2 = limited2.map(r=>`<tr>`+
                                                            `<td style=\\"padding:4px 6px;border:1px solid #e2e8f0;\\">${r.key}</td>`+
                                                            `<td style=\\"padding:4px 6px;border:1px solid #e2e8f0;text-align:right;\\">${r.qty.toFixed(2)}</td>`+
                                                        `</tr>`).join('');
                                                        siteBreakSection2 = `<div style=\\"margin-top:14px;\\">`
                                                            + `<h3 style=\\"margin:0 0 6px 0;font-size:14px;color:#334155;\\">Quantity by Site</h3>`
                                                            + `<table style=\\"border-collapse:collapse;font-size:11px;width:100%;max-width:520px;\\">`
                                                                + `<thead><tr>`
                                                                    + `<th style=\\"background:#475569;color:#fff;padding:4px 6px;text-align:left;border:1px solid #475569;font-weight:600;\\">Site</th>`
                                                                    + `<th style=\\"background:#475569;color:#fff;padding:4px 6px;text-align:right;border:1px solid #475569;font-weight:600;\\">Liters (L)</th>`
                                                                + `</tr></thead>`
                                                                + `<tbody>${rowsHtml2}${moreSites2>0?`<tr><td colspan=\\"2\\" style=\\"padding:4px 6px;border:1px solid #e2e8f0;font-size:10px;color:#64748b;text-align:center;\\">(+ ${moreSites2} more sites)</td></tr>`:''}</tbody>`
                                                            + `</table>`
                                                        + `</div>`;
                                                    } catch(e){ console.warn('Site breakdown build failed (non-modal)', e); }
                                                }
                                                                                                // Remove custom HTML - rely on EmailJS template only
                                                                                                let messageHtml = '';
                                const messagePlainSummary = combinedMessage;
                                let messageForTemplate = messageHtml;
                                let messageTruncated = false;
                                if (messageForTemplate.length > 48000){
                                    messageForTemplate = messageForTemplate.slice(0,47000) + '\n<!-- truncated -->';
                                    messageTruncated = true;
                                }
                
                const filenameBase2 = (modelTitle || 'daily fuel distribution report').replace(/[^a-z0-9]+/gi,'_').replace(/^_+|_+$/g,'').toLowerCase();
                const summary_text2 = summaryText; // explicit plaintext summary
                let params = {
                    to_name: recipients[0].split('@')[0] || 'User',
                    to_email: recipients[0],
                    bcc: recipients.slice(1).join(','),
                    subject: subject || `Daily Fuel Distribution Report (${dateRangeText})`,
                    filename_base: filenameBase2,
                    filename: attachmentPdfName || (filenameBase2 + '_' + Date.now() + '.pdf'),
                    model_title: modelTitle,
                    model_category: modelCategory,
                    report_group_by: modelCategory,
                    report_template: templateType,
                    date_range_text: dateRangeText,
                    record_count: String(recordCount),
                    report_row_count: String(tableRows.length),
                    total_liters: totalLiters.toFixed(2),
                    average_liters: averageLiters.toFixed(2),
                    generation_timestamp: new Date().toLocaleString(),
                    report_id: String(Date.now()),
                    user_message: message || '',
                    summary_text: summary_text2,
                    message_plain_summary: messagePlainSummary,
                    message: messagePlainSummary,
                    message_truncated: messageTruncated ? 'yes' : 'no',
                    site_breakdown_html: siteBreakSection2 || '',
                    pdf_url,
                    pdf_attached,
                    model_values: Array.isArray(m.values)? m.values.join(', ') : '',
                    system_link: window.location.href.replace(/\/[^\/]*$/, '/fueldist.html')
                };
                // No inline attachment param
                params = await optimizeParamsNonModal(params);
                
                const serviceId = 'service_p2e9swy'; 
                const templateId = 'template_rvo75m5';
                if (!serviceId || !templateId) throw new Error('Email service/template ID not configured');
                try {
                    const approxSize = (()=>{ try { return JSON.stringify(params).length; } catch { return 'n/a'; } })();
                    const keyLengths = Object.entries(params).map(([k,v])=>{
                        let len = '';
                        if (typeof v === 'string') len = v.length; else if (v && typeof v === 'object') len = 'obj';
                        return `${k}:${len}`;
                    });
                    console.log('[EmailJS Debug] (non-modal) Preparing to send email', { serviceId, templateId, approxJsonSize: approxSize, paramCount: Object.keys(params).length, keys: keyLengths });
                    if (params.site_breakdown_html){
                        console.log('[EmailJS Debug] (non-modal) site_breakdown_html preview:', params.site_breakdown_html.slice(0,200)+'...');
                    }
                    if (params.message_plain_summary){
                        console.log('[EmailJS Debug] (non-modal) message_plain_summary preview:', params.message_plain_summary.slice(0,200)+'...');
                    }
                } catch(logErr){ console.warn('[EmailJS Debug] (non-modal) logging failure', logErr); }
                await emailjs.send(serviceId, templateId, params);
                console.log('[EmailJS Debug] (non-modal) Email sent successfully via template', templateId);
                setReportStatus(`Report sent to ${recipients.length} recipient(s).`);
            } catch(e){ 
                console.error('[EmailJS Debug] non-modal send error (service/template): service_p2e9swy/template_rvo75m5', e); 
                const emsg = (e && (e.text || e.message || e.status)) ? `${e.status? e.status+': ':''}${e.text || e.message || ''}` : (typeof e==='string'? e : JSON.stringify(e));
                setReportStatus('Failed to send report. '+ emsg, true); 
            }
        }
        function blobToBase64(blob){ return new Promise((resolve,reject)=>{ const reader=new FileReader(); reader.onload=()=>resolve(reader.result); reader.onerror=reject; reader.readAsDataURL(blob); }); }

        // Utility: direct generate/save with provided parameters (used when Reports controls are hidden)
    async function generateAndSaveFuelReportWithParams({ title='Daily Fuel Distribution Report', type='summary', category='day', start='', end='' }={}){
            const data = getReportData(type, category, start, end);
            if (!data.rows || data.rows.length === 0){ setReportStatus('No data to generate report.', true); return; }
            try{
                const srcDataset = (Array.isArray(filteredData) && filteredData.length) ? filteredData : distributionData;
                const agg = (type==='summary') ? computeFuelAggregates(category, { start, end, dataset: srcDataset }) : computeFuelAggregates('day', { start, end, dataset: srcDataset });
                const pdfBlob = await buildReportPdf({ title, start, end, headers: data.headers, rows: data.rows, agg });
                const filename = `${title.replace(/[^a-z0-9]+/gi,'_')}_${Date.now()}.pdf`;
                let downloadURL='';
                try{
                    if (firebase && firebase.storage){
                        const storageRef=firebase.storage().ref(); const path=`reports/fueldist/${filename}`; const fileRef=storageRef.child(path);
                        await fileRef.put(pdfBlob); downloadURL = await fileRef.getDownloadURL();
                    }
                } catch(e){ console.warn('Upload skipped or failed', e); }
                try{
                    if (firebase && firebase.database){
                        const meta={ title, type, category, start, end, createdAt:Date.now(), file:filename, url:downloadURL||'', rows:data.rows.length };
                        await firebase.database().ref('reports/fueldist').push(meta);
                    }
                } catch(e){ console.warn('DB log skipped', e); }
                setReportStatus(`Report generated${downloadURL?` and uploaded: ${downloadURL}`:'. PDF ready for sending.'}`);
                window.__lastFuelReportBlob = pdfBlob; window.__lastFuelReportFilename = filename;
                try { loadGeneratedReports(); } catch(e) { /* ignore */ }
            } catch(e){ console.error(e); setReportStatus('Failed to generate report PDF. '+e.message, true); }
        }

        // ===== Saved Report Types & Generated Reports Listing =====
        function saveCurrentReportType(){ /* feature removed */ }
        async function loadReportTypes(){ /* feature removed */ }
        function renderReportTypeRow(){ return ''; }
        function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
        async function applyReportType(){ /* feature removed */ }
        async function deleteReportType(){ /* feature removed */ }
        async function loadGeneratedReports(){
            try{
                const statusEl = document.getElementById('reportsInlineStatus');
                if (statusEl) statusEl.textContent = 'Loading generated reports...';
                const body=document.getElementById('reportGeneratedBody'); if(!body) return; body.innerHTML='';
                if (!firebase || !firebase.database) return;
                const snap = await firebase.database().ref('reports/fueldist').once('value');
                const val = snap.val() || {};
                const rows = Object.entries(val).map(([id,r])=>({id,...r})).sort((a,b)=>b.createdAt-a.createdAt);
                body.innerHTML = rows.map(r=>renderGeneratedReportRow(r)).join('');
                const empty = document.getElementById('reportsEmptyState');
                if (empty) empty.style.display = rows.length ? 'none' : 'block';
                if (statusEl) statusEl.textContent = rows.length ? `Loaded ${rows.length} report${rows.length===1?'':'s'}.` : 'No reports found yet.';
            } catch(e){ console.warn('loadGeneratedReports failed', e); }
        }
        function renderGeneratedReportRow(r){
            const range = (r.start||r.end) ? `${r.start||''} - ${r.end||''}` : 'All Time';
            const created = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
            const link = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">Download</a>` : r.file || '-';
            return `<tr>
                <td>${escapeHtml(r.title||'')}</td>
                <td>${escapeHtml(r.category||'')}</td>
                <td>${escapeHtml(range)}</td>
                <td>${escapeHtml(created)}</td>
                <td>${link}</td>
                <td>
                    <button class="action-btn" style="padding:2px 6px;font-size:.6rem;" onclick="regenerateFromMeta('${r.id||''}')">Regenerate</button>
                    <button class="action-btn" style="padding:2px 6px;font-size:.6rem;background:#dc2626;border-color:#dc2626;" onclick="deleteGeneratedReport('${r.id||''}')">Delete</button>
                </td>
            </tr>`;
        }
        async function deleteGeneratedReport(id){
            if (!id) return;
            if (!confirm('Delete this report record? This does not remove the stored PDF.')) return;
            try {
                await firebase.database().ref('reports/fueldist/'+id).remove();
                try { loadGeneratedReports(); } catch(e){}
            } catch(e){ console.error('Failed to delete report', e); alert('Failed to delete: '+e.message); }
        }
        // Real-time listener (bind once when reports tab first opened)
        let fuelReportsRealtimeBound = false;
        function bindFuelReportsRealtime(){
            if (fuelReportsRealtimeBound) return;
            if (!firebase || !firebase.database) return;
            const ref = firebase.database().ref('reports/fueldist');
            ref.on('value', snap => {
                try {
                    const val = snap.val() || {};
                    const body = document.getElementById('reportGeneratedBody');
                    if (!body) return;
                    const rows = Object.entries(val).map(([id,r])=>({id,...r})).sort((a,b)=>b.createdAt-a.createdAt);
                    body.innerHTML = rows.map(r=>renderGeneratedReportRow(r)).join('');
                    const empty = document.getElementById('reportsEmptyState');
                    if (empty) empty.style.display = rows.length ? 'none' : 'block';
                    const statusEl = document.getElementById('reportsInlineStatus');
                    if (statusEl) statusEl.textContent = rows.length ? `Live: ${rows.length} report${rows.length===1?'':'s'} loaded.` : 'No reports yet.';
                } catch(e){ console.warn('Realtime reports update failed', e); }
            });
            fuelReportsRealtimeBound = true;
        }
        async function regenerateFromMeta(id){
            try{
                const snap = await firebase.database().ref('reports/fueldist/'+id).once('value');
                const meta=snap.val(); if(!meta) return;
                // If Reports controls exist, populate; otherwise, just generate with params
                if (document.getElementById('reportTitle')) document.getElementById('reportTitle').value = meta.title||'';
                if (document.getElementById('reportType')) document.getElementById('reportType').value = meta.type||'summary';
                if (document.getElementById('reportCategory')) document.getElementById('reportCategory').value = meta.category||'day';
                if (document.getElementById('reportDateStart')) document.getElementById('reportDateStart').value = meta.start||'';
                if (document.getElementById('reportDateEnd')) document.getElementById('reportDateEnd').value = meta.end||'';
                if (document.getElementById('reportTitle')){
                    setReportStatus('Loaded report metadata. You can preview or generate again.');
                    previewFuelReport();
                } else {
                    await generateAndSaveFuelReportWithParams({ title: meta.title||'Daily Fuel Distribution Report', type: meta.type||'summary', category: meta.category||'day', start: meta.start||'', end: meta.end||'' });
                }
            } catch(e){ console.error(e); setReportStatus('Failed to load metadata: '+e.message, true); }
        }

        // Reports tab simplified: only Generated Reports table retained
        
                // ======================= Multi Chart/Table Builder (Dynamic) =======================
                (function(){
                        let customChartIdSeq = 0; let customTableIdSeq = 0;
                        const customCharts = new Map(); const customTables = new Map();
                        let builderInitialized = false;

                        function ensureBuilderSection(){
                                if (builderInitialized) return;
                                const mount = document.getElementById('analyticsMultiBuilderMount') || document.querySelector('#analyticsSection');
                                if (!mount) return;
                                const section = document.createElement('section');
                                section.id = 'multiBuilderSection';
                                section.innerHTML = `
                                    <div class="mb-3 p-3 rounded-md shadow-sm border border-slate-200 bg-white">
                                        <h2 class="text-sm font-semibold tracking-wide text-slate-700 mb-3 flex items-center gap-2"><i class="fa fa-layer-group text-amber-500"></i> Custom Tables & Charts</h2>
                                        <div class="flex flex-wrap gap-2 items-end" id="multiBuilderControls">
                                            <!-- Removed global group/chart/date controls; per-set filters still available -->
                                            <button id="mbClearAll" type="button" class="px-3 py-1.5 bg-red-500/80 hover:bg-red-600 text-white text-xs font-semibold rounded shadow-sm">Clear All</button>
                                            <button id="mbAddPrimary" type="button" class="px-3 py-1.5 bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold rounded shadow-sm">Add Analysis Set</button>
                                            <button id="mbSaveModel" type="button" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-semibold rounded shadow-sm">Save Model</button>
                                            <button id="mbUpdateModel" type="button" style="display:none;" class="px-3 py-1.5 bg-teal-600 hover:bg-teal-700 text-white text-xs font-semibold rounded shadow-sm">Update Model</button>
                                        </div>
                                        <p class="mt-2 text-[10px] text-slate-500">Date range optional. Each widget stores its original parameters for refresh.</p>
                                    </div>
                                    <div id="customPrimaryContainer" class="flex flex-wrap gap-4 items-stretch mb-6"></div>
                                    <div id="customChartsContainer" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3 mb-6"></div>
                                    <div id="customTablesContainer" class="space-y-4"></div>
                                `;
                                mount.prepend(section);
                                wireBuilderEvents();
                                builderInitialized = true;
                        }

            function wireBuilderEvents(){
                document.getElementById('mbClearAll')?.addEventListener('click', ()=> clearAllCustom());
							document.getElementById('mbAddPrimary')?.addEventListener('click', ()=> addAnalysisSet());
                document.getElementById('mbSaveModel')?.addEventListener('click', ()=> { try{ saveCurrentAnalyticsModel(); }catch(e){ console.warn('Save model failed', e); } });
                document.getElementById('mbUpdateModel')?.addEventListener('click', ()=> { try{ updateCurrentAnalyticsModel(); }catch(e){ console.warn('Update model failed', e); } });
            }

            function getParams(){
                // Global controls removed; default seeds for new sets
                return { groupBy: 'day', chartType: 'bar', start: '', end: '' };
            }
                        function datasetForRange(start,end){
                                const base = Array.isArray(distributionData)? distributionData : [];
                                if (!start && !end) return base;
                                return filterFuelRecordsByDate(start,end, base);
                        }
                        function aggregate(groupBy,start,end){
                                return computeFuelAggregates(groupBy, { start, end, dataset: datasetForRange(start,end) });
                        }
                        function palette(i){ const c=['#f39c12','#3498db','#2ecc71','#9b59b6','#e74c3c','#16a085','#8e44ad','#d35400','#27ae60','#c0392b']; return c[i % c.length]; }

                        function addCustomChart(){
                                loadChartJs(()=>{
                                        const { groupBy, chartType, start, end } = getParams();
                                        const agg = aggregate(groupBy,start,end);
                                        const id = ++customChartIdSeq;
                                        const wrap = document.createElement('div');
                                        wrap.className='relative border border-slate-200 rounded-md p-2 bg-white shadow-sm';
                                        wrap.dataset.chartId = id;
                                        const title = `${chartType[0].toUpperCase()+chartType.slice(1)} - ${groupBy} ${(start||end)?`(${start||'...'} to ${end||'...'})`:''}`;
                                        wrap.innerHTML = `
                                            <div class='flex items-center justify-between mb-1'>
                                                <h3 class='text-[11px] font-semibold text-slate-700 truncate pr-6'>${title}</h3>
                                                <div class='flex gap-1'>
                                                    <button data-action='refresh' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class="fa fa-rotate"></i></button>
                                                    <button data-action='remove' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class="fa fa-times"></i></button>
                                                </div>
                                            </div>
                                            <canvas height='220' style='max-width:100%;'></canvas>
                                            <div class='mt-1 text-[10px] text-slate-500 flex justify-between'><span>${agg.rows.length} groups</span><span>Total ${(agg.totalQuantity||0).toFixed(2)} L</span></div>`;
                                        document.getElementById('customChartsContainer').appendChild(wrap);
                                        const ctx = wrap.querySelector('canvas').getContext('2d');
                                        const labels = agg.rows.map(r=>String(r.key));
                                        const vals = agg.rows.map(r=> +(+r.quantity).toFixed(2));
                                        let ds;
                                        if (['pie','doughnut'].includes(chartType)){
                                                ds=[{ label:'Quantity (L)', data:vals, backgroundColor: vals.map((_,i)=>palette(i)), borderColor:'#fff', borderWidth:1 }];
                                        } else {
                                                ds=[{ label:'Quantity (L)', data:vals, backgroundColor: vals.map((_,i)=>palette(i)), borderColor: vals.map((_,i)=>palette(i)), borderWidth:1, tension: chartType==='line'?0.25:0 }];
                                        }
                                        const inst = new Chart(ctx,{ type:chartType, data:{ labels, datasets:ds }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ font:{ size:9 }, color:'#334155' } }, tooltip:{ callbacks:{ label:(c)=> `${c.parsed} L` } } }, scales: (['pie','doughnut'].includes(chartType)? {} : { y:{ beginAtZero:true, ticks:{ font:{ size:9 }, color:'#334155' } }, x:{ ticks:{ font:{ size:9 }, color:'#334155' } } }) } });
                                        customCharts.set(id,{ instance:inst, cfg:{ groupBy, chartType, start, end } });
                                        wrap.addEventListener('click', ev=>{ const b=ev.target.closest('button[data-action]'); if(!b)return; if(b.dataset.action==='remove') removeCustomChart(id); if(b.dataset.action==='refresh') refreshCustomChart(id); });
                                });
                        }
                        function refreshCustomChart(id){ const e=customCharts.get(id); if(!e)return; const {cfg,instance}=e; const agg=aggregate(cfg.groupBy,cfg.start,cfg.end); instance.data.labels=agg.rows.map(r=>String(r.key)); const vals=agg.rows.map(r=> +(+r.quantity).toFixed(2)); if(instance.config.type==='pie'||instance.config.type==='doughnut'){ instance.data.datasets[0].data=vals; instance.data.datasets[0].backgroundColor=vals.map((_,i)=>palette(i)); } else { const ds=instance.data.datasets[0]; ds.data=vals; ds.backgroundColor=vals.map((_,i)=>palette(i)); ds.borderColor=vals.map((_,i)=>palette(i)); } instance.update(); }
                        function removeCustomChart(id){ const e=customCharts.get(id); if(!e)return; try{ e.instance.destroy(); }catch(_){ } customCharts.delete(id); const el=document.querySelector(`[data-chart-id="${id}"]`); if(el) el.remove(); }

                        function addCustomTable(){
                                const { groupBy,start,end } = getParams();
                                const agg = aggregate(groupBy,start,end);
                                const id = ++customTableIdSeq;
                                const wrap=document.createElement('div'); wrap.className='border border-slate-200 rounded-md p-2 bg-white shadow-sm relative'; wrap.dataset.tableId=id;
                                const title = `Table - ${groupBy} ${(start||end)?`(${start||'...'} to ${end||'...'})`:''}`;
                                const rowsHtml = agg.rows.map(r=>`<tr class='odd:bg-slate-50 text-[11px]'><td class='px-2 py-1 font-medium text-slate-700'>${r.key}</td><td class='px-2 py-1 text-right'>${(+r.quantity).toFixed(2)}</td><td class='px-2 py-1 text-right'>${r.count||0}</td></tr>`).join('');
                                wrap.innerHTML = `
                                    <div class='flex items-center justify-between mb-1'>
                                        <h3 class='text-[11px] font-semibold text-slate-700 truncate pr-6'>${title}</h3>
                                        <div class='flex gap-1'>
                                            <button data-action='refresh' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class="fa fa-rotate"></i></button>
                                            <button data-action='remove' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class="fa fa-times"></i></button>
                                        </div>
                                    </div>
                                    <table class='w-full border border-slate-200 rounded overflow-hidden'>
                                        <thead class='bg-slate-700 text-white text-[10px]'><tr><th class='px-2 py-1 text-left'>${groupBy}</th><th class='px-2 py-1 text-right'>Quantity (L)</th><th class='px-2 py-1 text-right'>Records</th></tr></thead>
                                        <tbody>${rowsHtml || `<tr><td colspan='3' class='text-center px-2 py-2 text-[11px] text-slate-500'>No rows</td></tr>`}</tbody>
                                        <tfoot class='bg-slate-50 text-[10px]'><tr><td class='px-2 py-1 font-semibold'>Totals</td><td class='px-2 py-1 text-right font-semibold'>${(agg.totalQuantity||0).toFixed(2)}</td><td class='px-2 py-1 text-right font-semibold'>${agg.totalCount||0}</td></tr></tfoot>
                                    </table>`;
                                document.getElementById('customTablesContainer').appendChild(wrap);
                                customTables.set(id,{ cfg:{ groupBy,start,end } });
                                wrap.addEventListener('click', ev=>{ const b=ev.target.closest('button[data-action]'); if(!b)return; if(b.dataset.action==='remove') removeCustomTable(id); if(b.dataset.action==='refresh') refreshCustomTable(id); });
                        }
                        function refreshCustomTable(id){ const e=customTables.get(id); if(!e)return; const {cfg}=e; const agg=aggregate(cfg.groupBy,cfg.start,cfg.end); const wrap=document.querySelector(`[data-table-id="${id}"]`); if(!wrap)return; const tbody=wrap.querySelector('tbody'); if(tbody){ tbody.innerHTML = agg.rows.map(r=>`<tr class='odd:bg-slate-50 text-[11px]'><td class='px-2 py-1 font-medium text-slate-700'>${r.key}</td><td class='px-2 py-1 text-right'>${(+r.quantity).toFixed(2)}</td><td class='px-2 py-1 text-right'>${r.count||0}</td></tr>`).join('') || `<tr><td colspan='3' class='text-center px-2 py-2 text-[11px] text-slate-500'>No rows</td></tr>`; } const tfoot=wrap.querySelectorAll('tfoot td'); if(tfoot.length>=3){ tfoot[1].textContent=(agg.totalQuantity||0).toFixed(2); tfoot[2].textContent=agg.totalCount||0; } }
                        function removeCustomTable(id){ customTables.delete(id); const el=document.querySelector(`[data-table-id="${id}"]`); if(el) el.remove(); }
            function clearAllCustom(){
                customCharts.forEach(c=>{ try{c.instance.destroy();}catch(_){}});
                customCharts.clear();
                customTables.clear();
                analysisSets.forEach(s=>{ try{ s.chart.destroy(); }catch(_){ } });
                analysisSets.clear();
                const cc=document.getElementById('customChartsContainer');
                const tc=document.getElementById('customTablesContainer');
                const pc=document.getElementById('customPrimaryContainer');
                if(cc) cc.innerHTML='';
                if(tc) tc.innerHTML='';
                if(pc){
                    pc.innerHTML='';
                }
                // button remains visible; nothing else needed
            }

            // ===== Primary Analytics Integration =====
            // Deprecated primary integration removed: we now allow multiple independent analysis sets
            function enhancePrimaryTablePanel(panel){
                const header = panel.querySelector('h4');
                if (!header) return;
                const wrap = document.createElement('div');
                wrap.className='flex items-center justify-between mb-1';
                wrap.innerHTML = `<span class='text-[11px] font-semibold text-slate-700'>DETAIL TABLE</span>
                <span class='flex gap-1'>
                   <button data-act='refresh-primary' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class=\"fa fa-rotate\"></i></button>
                   <button data-act='remove-primary-table' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class=\"fa fa-times\"></i></button>
                </span>`;
                header.replaceWith(wrap);
                panel.addEventListener('click', e=>{
                    const btn = e.target.closest('button[data-act]'); if(!btn) return;
                    const act = btn.getAttribute('data-act');
                    if (act==='refresh-primary'){ const sid = panel.dataset.analysisSet; if (sid) refreshAnalysisSet(sid); }
                    if (act==='remove-primary-table'){ const sid = panel.dataset.analysisSet; if (sid) removeAnalysisSet(sid); else panel.remove(); }
                });
            }
            function enhancePrimaryChartPanel(panel){
                const header = panel.querySelector('h4');
                if (!header) return;
                const wrap = document.createElement('div');
                wrap.className='flex items-center justify-between mb-1';
                wrap.innerHTML = `<span class='text-[11px] font-semibold text-slate-700'>DISTRIBUTION CHART</span>
                <span class='flex gap-1'>
                   <button data-act='refresh-primary-chart' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class=\"fa fa-rotate\"></i></button>
                   <button data-act='remove-primary-chart' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class=\"fa fa-times\"></i></button>
                </span>`;
                header.replaceWith(wrap);
                panel.addEventListener('click', e=>{
                    const btn = e.target.closest('button[data-act]'); if(!btn) return;
                    const act = btn.getAttribute('data-act');
                    if (act==='refresh-primary-chart'){ const sid = panel.dataset.analysisSet; if (sid) refreshAnalysisSet(sid); }
                    if (act==='remove-primary-chart'){ const sid = panel.dataset.analysisSet; if (sid) removeAnalysisSet(sid); else panel.remove(); }
                });
            }
            function updatePrimarySetButtonState() { /* button always visible now */ }

            // ===== Multiple Analysis Sets =====
            const analysisSets = new Map(); // id -> { cfg, chart, elements }
            // Snapshot & external helpers
            window.__getAnalysisSetsSnapshot = function(){
                const out = [];
                try {
                    analysisSets.forEach((entry,id)=>{
                        const { cfg, chart, wrap } = entry;
                        let chartMeta = { type: chart?.config?.type || cfg.chartType || 'bar', datasets: [], labels: [] };
                        try {
                            chartMeta.labels = (chart?.data?.labels||[]).slice(0,300);
                            chartMeta.datasets = (chart?.data?.datasets||[]).map(ds=>({ label: ds.label, data: [...ds.data].slice(0,300), backgroundColor: ds.backgroundColor, borderColor: ds.borderColor }));
                        } catch(e) {}
                        const tableEl = wrap.querySelector('table');
                        out.push({ id, cfg: { ...cfg }, chart: chartMeta, table: tableEl ? tableEl.outerHTML : '' });
                    });
                } catch(e){ console.warn('snapshot sets failed', e); }
                return out;
            };
            window.__rebuildAnalysisSet = function(cfg){ createAnalysisSetFromConfig(cfg); };
            window.__analysisSetsRef = analysisSets;
            let analysisSetSeq = 0;

            function addAnalysisSet(){
                loadChartJs(()=> _addAnalysisSetInternal());
            }
            function createAnalysisSetFromConfig(cfg){
                // cfg: {groupBy, chartType, start, end}
                const groupBy = cfg.groupBy || 'day';
                const chartType = cfg.chartType || 'bar';
                const start = cfg.start || '';
                const end = cfg.end || '';
                loadChartJs(()=> _addAnalysisSetInternalFromCfg(groupBy, chartType, start, end));
            }
            function _addAnalysisSetInternal(){
                const { groupBy, chartType, start, end } = getParams();
                const agg = aggregate(groupBy,start,end);
                const id = 'as'+(++analysisSetSeq);
                const primaryContainer = document.getElementById('customPrimaryContainer');
                if (!primaryContainer) return;
                                                                const setWrap = document.createElement('div');
                                                                setWrap.className='analysis-set border border-slate-300 rounded-md p-2 bg-white shadow-sm flex flex-col gap-2 w-full';
                setWrap.dataset.analysisSet = id;
                const title = `${groupBy} ${(start||end)?`(${start||'...'} to ${end||'...'})`:''}`;
                                                                setWrap.innerHTML = `
                                                                     <div class='flex items-center justify-between'>
                                                                         <h3 class='text-[11px] font-semibold text-slate-700'>Analysis Set</h3>
                                                                         <div class='flex gap-1'>
                                                                             <button data-act='refresh-set' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class=\"fa fa-rotate\"></i></button>
                                                                             <button data-act='remove-set' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class=\"fa fa-times\"></i></button>
                                                                         </div>
                                                                     </div>
                                                                     <div class='flex flex-wrap gap-2 items-end text-[10px] bg-slate-50/60 rounded-md p-2 border border-slate-200'>
                                                                            <label class='flex flex-col gap-0.5'>Group
                                                                                <select data-filt='groupBy' class='border rounded px-1 py-0.5 bg-white'>
                                                                                     <option value='day' ${groupBy==='day'?'selected':''}>Day</option>
                                                                                     <option value='consumptionDate' ${groupBy==='consumptionDate'?'selected':''}>Consumption Date</option>
                                                                                     <option value='id' ${groupBy==='id'?'selected':''}>Record ID</option>
                                                                                     <option value='equipmentType' ${groupBy==='equipmentType'?'selected':''}>Equipment Type</option>
                                                                                     <option value='equipmentId' ${groupBy==='equipmentId'?'selected':''}>Equipment ID</option>
                                                                                     <option value='location' ${groupBy==='location'?'selected':''}>Location</option>
                                                                                     <option value='operator' ${groupBy==='operator'?'selected':''}>Operator</option>
                                                                                     <option value='quantity' ${groupBy==='quantity'?'selected':''}>Quantity (Bucket)</option>
                                                                                     <option value='index' ${groupBy==='index'?'selected':''}>Index (Bucket)</option>
                                                                                     <option value='department' ${groupBy==='department'?'selected':''}>Department</option>
                                                                                     <option value='costcenter' ${groupBy==='costcenter'?'selected':''}>Cost Center</option>
                                                                                     <option value='securityAgent' ${groupBy==='securityAgent'?'selected':''}>Security Agent</option>
                                                                                     <option value='supervisor' ${groupBy==='supervisor'?'selected':''}>Supervisor</option>
                                                                                     <option value='status' ${groupBy==='status'?'selected':''}>Status</option>
                                                                                     <option value='site' ${groupBy==='site'?'selected':''}>Site</option>
                                                                                     <option value='fuelType' ${groupBy==='fuelType'?'selected':''}>Fuel Type</option>
                                                                                </select>
                                                                            </label>
                                                                            <label class='flex flex-col gap-0.5'>Group 2
                                                                                <select data-filt='groupBy2' class='border rounded px-1 py-0.5 bg-white'>
                                                                                     <option value=''>-- None --</option>
                                                                                     <option value='day'>Day</option>
                                                                                     <option value='consumptionDate'>Consumption Date</option>
                                                                                     <option value='id'>Record ID</option>
                                                                                     <option value='equipmentType'>Equipment Type</option>
                                                                                     <option value='equipmentId'>Equipment ID</option>
                                                                                     <option value='location'>Location</option>
                                                                                     <option value='operator'>Operator</option>
                                                                                     <option value='quantity'>Quantity (Bucket)</option>
                                                                                     <option value='index'>Index (Bucket)</option>
                                                                                     <option value='department'>Department</option>
                                                                                     <option value='costcenter'>Cost Center</option>
                                                                                     <option value='securityAgent'>Security Agent</option>
                                                                                     <option value='supervisor'>Supervisor</option>
                                                                                     <option value='status'>Status</option>
                                                                                     <option value='site'>Site</option>
                                                                                     <option value='fuelType'>Fuel Type</option>
                                                                                </select>
                                                                            </label>
                                                                            <label class='flex flex-col gap-0.5'>Chart
                                                                                <select data-filt='chartType' class='border rounded px-1 py-0.5 bg-white'>
                                                                                     <option value='bar' ${chartType==='bar'?'selected':''}>Bar</option>
                                                                                     <option value='line' ${chartType==='line'?'selected':''}>Line</option>
                                                                                     <option value='pie' ${chartType==='pie'?'selected':''}>Pie</option>
                                                                                     <option value='doughnut' ${chartType==='doughnut'?'selected':''}>Doughnut</option>
                                                                                </select>
                                                                            </label>
                                                                            <div class='flex flex-col gap-0.5 relative' data-role='valueFilter'>
                                                                                <label class='text-[10px]'>Filter Values</label>
                                                                                <button type='button' data-act='toggle-value-dropdown' class='border rounded px-1 py-0.5 bg-white text-left text-[10px] hover:bg-slate-50 flex items-center justify-between gap-1' style='min-width:140px;'>
                                                                                    <span data-role='valueFilterLabel'>All</span>
                                                                                    <i class='fa fa-chevron-down' style='font-size:8px;'></i>
                                                                                </button>
                                                                                <div data-role='valueDropdown' class='hidden absolute top-full left-0 mt-1 bg-white border border-slate-300 rounded shadow-lg z-50 max-h-[200px] overflow-auto' style='min-width:180px;'>
                                                                                    <div class='p-1 text-[9px] text-slate-500 border-b flex items-center justify-between'>
                                                                                        <span>Select values to show:</span>
                                                                                        <button type='button' data-act='toggle-all-values' class='text-[9px] px-1 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600'>All/None</button>
                                                                                    </div>
                                                                                    <div data-role='valueCheckboxes' class='p-1'></div>
                                                                                </div>
                                                                            </div>
                                                                            <div class='flex flex-col gap-0.5 relative' data-role='valueFilter2'>
                                                                                <label class='text-[10px]'>Filter Values 2</label>
                                                                                <button type='button' data-act='toggle-value2-dropdown' class='border rounded px-1 py-0.5 bg-white text-left text-[10px] hover:bg-slate-50 flex items-center justify-between gap-1' style='min-width:140px;'>
                                                                                    <span data-role='valueFilter2Label'>All</span>
                                                                                    <i class='fa fa-chevron-down' style='font-size:8px;'></i>
                                                                                </button>
                                                                                <div data-role='valueDropdown2' class='hidden absolute top-full left-0 mt-1 bg-white border border-slate-300 rounded shadow-lg z-50 max-h-[200px] overflow-auto' style='min-width:180px;'>
                                                                                    <div class='p-1 text-[9px] text-slate-500 border-b flex items-center justify-between'>
                                                                                        <span>Select values to show:</span>
                                                                                        <button type='button' data-act='toggle-all-values2' class='text-[9px] px-1 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600'>All/None</button>
                                                                                    </div>
                                                                                    <div data-role='valueCheckboxes2' class='p-1'></div>
                                                                                </div>
                                                                            </div>
                                                                            <label class='flex flex-col gap-0.5'>Start
                                                                                <input data-filt='start' type='date' value='${start||''}' class='border rounded px-1 py-0.5 bg-white'/>
                                                                            </label>
                                                                            <label class='flex flex-col gap-0.5'>End
                                                                                <input data-filt='end' type='date' value='${end||''}' class='border rounded px-1 py-0.5 bg-white'/>
                                                                            </label>
                                                                            <div class='flex items-center gap-1 ml-auto'>
                                                                                <button data-act='preset' data-range='7d' class='px-2 py-0.5 rounded bg-slate-200 hover:bg-slate-300 text-slate-700'>7d</button>
                                                                                <button data-act='preset' data-range='30d' class='px-2 py-0.5 rounded bg-slate-200 hover:bg-slate-300 text-slate-700'>30d</button>
                                                                                <button data-act='preset' data-range='clear' class='px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600'>Clear</button>
                                                                                <button data-act='apply-filters' class='px-3 py-0.5 rounded bg-indigo-500 hover:bg-indigo-600 text-white font-semibold'>Apply</button>
                                                                            </div>
                                                                     </div>
                                                                     <div class='text-[10px] text-slate-500 italic -mt-1 mb-1' data-role='summary'>${title}</div>
                                                                     <div class='flex flex-wrap gap-2 items-stretch'>
                                                                         <div class='flex flex-col border border-slate-200 rounded-md p-2 flex-1 min-w-[340px]' data-role='tableBox'>
                                                                                <h4 class='text-[10px] font-semibold text-slate-600 mb-1'>TABLE</h4>
                                                                                <div class='overflow-auto'>
                                                                                     <table class='w-full text-[10px] border-collapse'>
                                                                                         <thead><tr><th class='text-left px-1 py-0.5' data-col='groupHdr'>${groupBy.toUpperCase()}</th><th class='text-right px-1 py-0.5'>Records</th><th class='text-right px-1 py-0.5'>Qty (L)</th><th class='text-right px-1 py-0.5'>Avg (L)</th></tr></thead>
                                                                                         <tbody></tbody>
                                                                                         <tfoot><tr><td class='px-1 py-0.5 font-semibold'>Totals</td><td class='text-right px-1 py-0.5 font-semibold' data-ft-rec></td><td class='text-right px-1 py-0.5 font-semibold' data-ft-qty></td><td></td></tr></tfoot>
                                                                                     </table>
                                                                                </div>
                                                                         </div>
                                                                         <div class='flex flex-col border border-slate-200 rounded-md p-2 flex-1 min-w-[320px]' data-role='chartBox'>
                                                                                <h4 class='text-[10px] font-semibold text-slate-600 mb-1'>CHART</h4>
                                                                                <div style='flex:1;min-height:160px;display:flex;'>
                                                                                        <canvas></canvas>
                                                                                </div>
                                                                         </div>
                                                                     </div>`;
                primaryContainer.appendChild(setWrap);
                // Fill table
                const tbody = setWrap.querySelector('tbody');
                tbody.innerHTML = agg.rows.map(r=>`<tr class='odd:bg-slate-50' data-group="${r.key}"><td class='px-1 py-0.5'>${r.key}</td><td class='text-right px-1 py-0.5'>${r.records}</td><td class='text-right px-1 py-0.5'>${r.quantity.toFixed(2)}</td><td class='text-right px-1 py-0.5' data-field='avg'>${(r.quantity/r.records).toFixed(2)}</td></tr>`).join('');
                setWrap.querySelector('[data-ft-rec]').textContent = agg.rows.reduce((a,r)=>a+r.records,0);
                setWrap.querySelector('[data-ft-qty]').textContent = agg.rows.reduce((a,r)=>a+r.quantity,0).toFixed(2);
                // Chart
                const ctx = setWrap.querySelector('canvas').getContext('2d');
                const labels = agg.rows.map(r=>String(r.key)).slice(0,30);
                const quantities = agg.rows.map(r=>r.quantity).slice(0,30);
                const records = agg.rows.map(r=>r.records).slice(0,30);
                const chart = new Chart(ctx,{ type: chartType==='pie'||chartType==='doughnut'? chartType : 'bar', data:{ labels, datasets:[{ label:'Quantity (L)', data:quantities, backgroundColor:'#f39c12', borderColor:'#d97706', borderWidth:1 }, ...(chartType==='bar'||chartType==='line'? [{ label:'Records', data:records, backgroundColor:'#334155', borderColor:'#1e293b', borderWidth:1 }] : []) ] }, options:{ responsive:true, maintainAspectRatio:false, scales: (chartType==='pie'||chartType==='doughnut') ? {} : { y:{ beginAtZero:true, ticks:{ font:{ size:8 }, color:'#334155' } }, x:{ ticks:{ font:{ size:8 }, color:'#334155' } } }, plugins:{ legend:{ labels:{ font:{ size:8 }, color:'#334155' } } } }});
                // Initialize analysis set (no manual edit overrides now)
                analysisSets.set(id,{ cfg:{ groupBy, groupBy2:'', chartType, start, end }, chart, wrap:setWrap, overrides:null, selectedValues:[], selectedValues2:[] });
                // Inject editable styles once
                if (!document.getElementById('analysis-edit-style')){
                    const st = document.createElement('style');
                    st.id='analysis-edit-style';
                    st.textContent = `.editable-cell{cursor:text;display:inline-block;min-width:22px;padding:0 2px;border-bottom:1px dashed transparent;} .editable-cell:focus{outline:none;border-bottom-color:#2563eb;background:#eff6ff;border-radius:2px;} .edited-cell{background:#fef3c7 !important;}`;
                    document.head.appendChild(st);
                }
                setWrap.addEventListener('click', e=>{
                    const b=e.target.closest('button[data-act]'); if(!b) return;
                    const act=b.getAttribute('data-act');
                    if (act==='refresh-set'){ refreshAnalysisSet(id); return; }
                    if (act==='remove-set'){ removeAnalysisSet(id); return; }
                    if (act==='reset-edits'){ const entry=analysisSets.get(id); if(entry){ entry.overrides={}; } refreshAnalysisSet(id); return; }
                    if (act==='toggle-value-dropdown'){ toggleValueFilterDropdown(id); return; }
                    if (act==='toggle-value2-dropdown'){ toggleValueFilterDropdown2(id); return; }
                    if (act==='toggle-all-values'){ toggleAllValueSelections(id); return; }
                    if (act==='toggle-all-values2'){ toggleAllValueSelections2(id); return; }
                    if (act==='apply-filters'){
                        applyFiltersToAnalysisSet(id);
                        return;
                    }
                    if (act==='preset'){
                        const range = b.getAttribute('data-range');
                        applyPresetRange(id, range);
                        return;
                    }
                });
                // Handle groupBy & groupBy2 change
                const groupBySelect = setWrap.querySelector('select[data-filt="groupBy"]');
                const groupBy2Select = setWrap.querySelector('select[data-filt="groupBy2"]');
                if(groupBySelect){
                    groupBySelect.addEventListener('change', ()=>{
                        const entry = analysisSets.get(id); if(entry){ entry.selectedValues = []; entry.cfg.groupBy = groupBySelect.value; }
                        populateValueFilterOptions(id);
                        populateValueFilterOptions2(id);
                    });
                }
                if(groupBy2Select){
                    groupBy2Select.addEventListener('change', ()=>{
                        const entry = analysisSets.get(id); if(entry){ entry.selectedValues2 = []; entry.cfg.groupBy2 = groupBy2Select.value; }
                        populateValueFilterOptions2(id);
                    });
                }
                populateValueFilterOptions(id);
                populateValueFilterOptions2(id);
                // Editing disabled: no inline edit handlers bound.
            }
            function _addAnalysisSetInternalFromCfg(groupBy, chartType, start, end){
                const agg = aggregate(groupBy,start,end);
                const id = 'as'+(++analysisSetSeq);
                const primaryContainer = document.getElementById('customPrimaryContainer');
                if (!primaryContainer) return;
                // Duplicate of template building (could be refactored, kept explicit for clarity)
                const setWrap = document.createElement('div');
                setWrap.className='analysis-set border border-slate-300 rounded-md p-2 bg-white shadow-sm flex flex-col gap-2 w-full';
                setWrap.dataset.analysisSet = id;
                const title = `${groupBy} ${(start||end)?`(${start||'...'} to ${end||'...'})`:''}`;
                setWrap.innerHTML = `
                     <div class='flex items-center justify-between'>
                         <h3 class='text-[11px] font-semibold text-slate-700'>Analysis Set</h3>
                         <div class='flex gap-1'>
                             <button data-act='refresh-set' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class="fa fa-rotate"></i></button>
                                                                             <button data-act='reset-edits' class='text-[10px] px-2 py-0.5 rounded bg-amber-100 hover:bg-amber-200 text-amber-700' title='Reset Manual Edits'><i class="fa fa-eraser"></i></button>
                             <button data-act='reset-edits' class='text-[10px] px-2 py-0.5 rounded bg-amber-100 hover:bg-amber-200 text-amber-700' title='Reset Manual Edits'><i class="fa fa-eraser"></i></button>
                             <button data-act='remove-set' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class="fa fa-times"></i></button>
                         </div>
                     </div>
                     <div class='flex flex-wrap gap-2 items-end text-[10px] bg-slate-50/60 rounded-md p-2 border border-slate-200'>
                            <label class='flex flex-col gap-0.5'>Group
                                <select data-filt='groupBy' class='border rounded px-1 py-0.5 bg-white'>
                                     <option value='day' ${groupBy==='day'?'selected':''}>Day</option>
                                     <option value='consumptionDate' ${groupBy==='consumptionDate'?'selected':''}>Consumption Date</option>
                                     <option value='id' ${groupBy==='id'?'selected':''}>Record ID</option>
                                     <option value='equipmentType' ${groupBy==='equipmentType'?'selected':''}>Equipment Type</option>
                                     <option value='equipmentId' ${groupBy==='equipmentId'?'selected':''}>Equipment ID</option>
                                     <option value='location' ${groupBy==='location'?'selected':''}>Location</option>
                                     <option value='operator' ${groupBy==='operator'?'selected':''}>Operator</option>
                                     <option value='quantity' ${groupBy==='quantity'?'selected':''}>Quantity (Bucket)</option>
                                     <option value='index' ${groupBy==='index'?'selected':''}>Index (Bucket)</option>
                                     <option value='department' ${groupBy==='department'?'selected':''}>Department</option>
                                     <option value='costcenter' ${groupBy==='costcenter'?'selected':''}>Cost Center</option>
                                     <option value='securityAgent' ${groupBy==='securityAgent'?'selected':''}>Security Agent</option>
                                     <option value='supervisor' ${groupBy==='supervisor'?'selected':''}>Supervisor</option>
                                     <option value='status' ${groupBy==='status'?'selected':''}>Status</option>
                                     <option value='site' ${groupBy==='site'?'selected':''}>Site</option>
                                     <option value='fuelType' ${groupBy==='fuelType'?'selected':''}>Fuel Type</option>
                                </select>
                            </label>
                            <label class='flex flex-col gap-0.5'>Group 2
                                <select data-filt='groupBy2' class='border rounded px-1 py-0.5 bg-white'>
                                     <option value=''>-- None --</option>
                                     <option value='day'>Day</option>
                                     <option value='consumptionDate'>Consumption Date</option>
                                     <option value='id'>Record ID</option>
                                     <option value='equipmentType'>Equipment Type</option>
                                     <option value='equipmentId'>Equipment ID</option>
                                     <option value='location'>Location</option>
                                     <option value='operator'>Operator</option>
                                     <option value='quantity'>Quantity (Bucket)</option>
                                     <option value='index'>Index (Bucket)</option>
                                     <option value='department'>Department</option>
                                     <option value='costcenter'>Cost Center</option>
                                     <option value='securityAgent'>Security Agent</option>
                                     <option value='supervisor'>Supervisor</option>
                                     <option value='status'>Status</option>
                                     <option value='site'>Site</option>
                                     <option value='fuelType'>Fuel Type</option>
                                </select>
                            </label>
                            <label class='flex flex-col gap-0.5'>Chart
                                <select data-filt='chartType' class='border rounded px-1 py-0.5 bg-white'>
                                     <option value='bar' ${chartType==='bar'?'selected':''}>Bar</option>
                                     <option value='line' ${chartType==='line'?'selected':''}>Line</option>
                                     <option value='pie' ${chartType==='pie'?'selected':''}>Pie</option>
                                     <option value='doughnut' ${chartType==='doughnut'?'selected':''}>Doughnut</option>
                                </select>
                            </label>
                            <div class='flex flex-col gap-0.5 relative' data-role='valueFilter'>
                                <label class='text-[10px]'>Filter Values</label>
                                <button type='button' data-act='toggle-value-dropdown' class='border rounded px-1 py-0.5 bg-white text-left text-[10px] hover:bg-slate-50 flex items-center justify-between gap-1' style='min-width:140px;'>
                                    <span data-role='valueFilterLabel'>All</span>
                                    <i class='fa fa-chevron-down' style='font-size:8px;'></i>
                                </button>
                                <div data-role='valueDropdown' class='hidden absolute top-full left-0 mt-1 bg-white border border-slate-300 rounded shadow-lg z-50 max-h-[200px] overflow-auto' style='min-width:180px;'>
                                    <div class='p-1 text-[9px] text-slate-500 border-b flex items-center justify-between'>
                                        <span>Select values to show:</span>
                                        <button type='button' data-act='toggle-all-values' class='text-[9px] px-1 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600'>All/None</button>
                                    </div>
                                    <div data-role='valueCheckboxes' class='p-1'></div>
                                </div>
                            </div>
                            <div class='flex flex-col gap-0.5 relative' data-role='valueFilter2'>
                                <label class='text-[10px]'>Filter Values 2</label>
                                <button type='button' data-act='toggle-value2-dropdown' class='border rounded px-1 py-0.5 bg-white text-left text-[10px] hover:bg-slate-50 flex items-center justify-between gap-1' style='min-width:140px;'>
                                    <span data-role='valueFilter2Label'>All</span>
                                    <i class='fa fa-chevron-down' style='font-size:8px;'></i>
                                </button>
                                <div data-role='valueDropdown2' class='hidden absolute top-full left-0 mt-1 bg-white border border-slate-300 rounded shadow-lg z-50 max-h-[200px] overflow-auto' style='min-width:180px;'>
                                    <div class='p-1 text-[9px] text-slate-500 border-b flex items-center justify-between'>
                                        <span>Select values to show:</span>
                                        <button type='button' data-act='toggle-all-values2' class='text-[9px] px-1 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600'>All/None</button>
                                    </div>
                                    <div data-role='valueCheckboxes2' class='p-1'></div>
                                </div>
                            </div>
                            <label class='flex flex-col gap-0.5'>Start
                                <input data-filt='start' type='date' value='${start||''}' class='border rounded px-1 py-0.5 bg-white'/>
                            </label>
                            <label class='flex flex-col gap-0.5'>End
                                <input data-filt='end' type='date' value='${end||''}' class='border rounded px-1 py-0.5 bg-white'/>
                            </label>
                            <div class='flex items-center gap-1 ml-auto'>
                                <button data-act='preset' data-range='7d' class='px-2 py-0.5 rounded bg-slate-200 hover:bg-slate-300 text-slate-700'>7d</button>
                                <button data-act='preset' data-range='30d' class='px-2 py-0.5 rounded bg-slate-200 hover:bg-slate-300 text-slate-700'>30d</button>
                                <button data-act='preset' data-range='clear' class='px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600'>Clear</button>
                                <button data-act='apply-filters' class='px-3 py-0.5 rounded bg-indigo-500 hover:bg-indigo-600 text-white font-semibold'>Apply</button>
                            </div>
                     </div>
                     <div class='text-[10px] text-slate-500 italic -mt-1 mb-1' data-role='summary'>${title}</div>
                     <div class='flex flex-wrap gap-2 items-stretch'>
                         <div class='flex flex-col border border-slate-200 rounded-md p-2 flex-1 min-w-[340px]' data-role='tableBox'>
                                <h4 class='text-[10px] font-semibold text-slate-600 mb-1'>TABLE</h4>
                                <div class='overflow-auto'>
                                     <table class='w-full text-[10px] border-collapse'>
                                         <thead><tr><th class='text-left px-1 py-0.5' data-col='groupHdr'>${groupBy.toUpperCase()}</th><th class='text-right px-1 py-0.5'>Records</th><th class='text-right px-1 py-0.5'>Qty (L)</th><th class='text-right px-1 py-0.5'>Avg (L)</th></tr></thead>
                                         <tbody></tbody>
                                         <tfoot><tr><td class='px-1 py-0.5 font-semibold'>Totals</td><td class='text-right px-1 py-0.5 font-semibold' data-ft-rec></td><td class='text-right px-1 py-0.5 font-semibold' data-ft-qty></td><td></td></tr></tfoot>
                                     </table>
                                </div>
                         </div>
                         <div class='flex flex-col border border-slate-200 rounded-md p-2 flex-1 min-w-[320px]' data-role='chartBox'>
                                <h4 class='text-[10px] font-semibold text-slate-600 mb-1'>CHART</h4>
                                <div style='flex:1;min-height:160px;display:flex;'>
                                        <canvas></canvas>
                                </div>
                         </div>
                     </div>`;
                primaryContainer.appendChild(setWrap);
                // Fill table
                const tbody = setWrap.querySelector('tbody');
                tbody.innerHTML = agg.rows.map(r=>`<tr class='odd:bg-slate-50' data-group="${r.key}"><td class='px-1 py-0.5'>${r.key}</td><td class='text-right px-1 py-0.5'>${r.records}</td><td class='text-right px-1 py-0.5'>${r.quantity.toFixed(2)}</td><td class='text-right px-1 py-0.5' data-field='avg'>${(r.quantity/r.records).toFixed(2)}</td></tr>`).join('');
                setWrap.querySelector('[data-ft-rec]').textContent = agg.rows.reduce((a,r)=>a+r.records,0);
                setWrap.querySelector('[data-ft-qty]').textContent = agg.rows.reduce((a,r)=>a+r.quantity,0).toFixed(2);
                const ctx = setWrap.querySelector('canvas').getContext('2d');
                const labels = agg.rows.map(r=>String(r.key)).slice(0,30);
                const quantities = agg.rows.map(r=>r.quantity).slice(0,30);
                const records = agg.rows.map(r=>r.records).slice(0,30);
                const chart = new Chart(ctx,{ type: chartType==='pie'||chartType==='doughnut'? chartType : 'bar', data:{ labels, datasets:[{ label:'Quantity (L)', data:quantities, backgroundColor:'#f39c12', borderColor:'#d97706', borderWidth:1 }, ...(chartType==='bar'||chartType==='line'? [{ label:'Records', data:records, backgroundColor:'#334155', borderColor:'#1e293b', borderWidth:1 }] : []) ] }, options:{ responsive:true, maintainAspectRatio:false, scales: (chartType==='pie'||chartType==='doughnut') ? {} : { y:{ beginAtZero:true, ticks:{ font:{ size:8 }, color:'#334155' } }, x:{ ticks:{ font:{ size:8 }, color:'#334155' } } }, plugins:{ legend:{ labels:{ font:{ size:8 }, color:'#334155' } } } }});
                analysisSets.set(id,{ cfg:{ groupBy, groupBy2:'', chartType, start, end }, chart, wrap:setWrap, overrides:{}, selectedValues:[], selectedValues2:[] });
                if (!document.getElementById('analysis-edit-style')){
                    const st = document.createElement('style');
                    st.id='analysis-edit-style';
                    st.textContent = `.editable-cell{cursor:text;display:inline-block;min-width:22px;padding:0 2px;border-bottom:1px dashed transparent;} .editable-cell:focus{outline:none;border-bottom-color:#2563eb;background:#eff6ff;border-radius:2px;} .edited-cell{background:#fef3c7 !important;}`;
                    document.head.appendChild(st);
                }
                setWrap.addEventListener('click', e=>{
                    const b=e.target.closest('button[data-act]'); if(!b) return;
                    const act=b.getAttribute('data-act');
                    if (act==='refresh-set'){ refreshAnalysisSet(id); return; }
                    if (act==='remove-set'){ removeAnalysisSet(id); return; }
                    if (act==='reset-edits'){ const entry=analysisSets.get(id); if(entry){ entry.overrides={}; } refreshAnalysisSet(id); return; }
                    if (act==='toggle-value-dropdown'){ toggleValueFilterDropdown(id); return; }
                    if (act==='toggle-value2-dropdown'){ toggleValueFilterDropdown2(id); return; }
                    if (act==='toggle-all-values'){ toggleAllValueSelections(id); return; }
                    if (act==='toggle-all-values2'){ toggleAllValueSelections2(id); return; }
                    if (act==='apply-filters'){
                        applyFiltersToAnalysisSet(id);
                        return;
                    }
                    if (act==='preset'){
                        const range = b.getAttribute('data-range');
                        applyPresetRange(id, range);
                        return;
                    }
                });
                // Handle groupBy change to repopulate value filter
                const groupBySelect = setWrap.querySelector('select[data-filt="groupBy"]');
                if(groupBySelect){
                    groupBySelect.addEventListener('change', ()=>{
                        const entry = analysisSets.get(id); if(entry){ entry.selectedValues = []; }
                        populateValueFilterOptions(id);
                    });
                }
                // Initialize value filter with current data
                populateValueFilterOptions(id);
                const tbodyEl = setWrap.querySelector('tbody');
                tbodyEl.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); ev.target.blur(); }});
                tbodyEl.addEventListener('blur', ev=>{
                    const span = ev.target.closest('.editable-cell');
                    if(!span) return;
                    const row = span.closest('tr');
                    const groupKey = row?.getAttribute('data-group');
                    if(!groupKey) return;
                    const field = span.getAttribute('data-field');
                    let raw = span.textContent.trim();
                    if(raw===''){ span.textContent = span.dataset.prev || '0'; return; }
                    let val = parseFloat(raw);
                    if(!isFinite(val)){ span.textContent = span.dataset.prev || '0'; return; }
                    const entry = analysisSets.get(id); if(!entry) return;
                    entry.overrides = entry.overrides || {};
                    entry.overrides[groupKey] = entry.overrides[groupKey] || {};
                    entry.overrides[groupKey][field] = val;
                    span.dataset.prev = String(val);
                    span.classList.add('edited-cell');
                    applyOverridesAndRecompute(entry);
                }, true);
            }
            function refreshAnalysisSet(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { cfg, chart, wrap } = entry;
                const agg = computeAnalysisAggregation(cfg, entry.selectedValues, entry.selectedValues2);
                entry._lastAgg = agg; // store raw agg / pivot
                buildAnalysisSetTableBody(entry);
                applyOverridesAndRecompute(entry, false); // false: don't rebuild overrides, just apply
            }
            function buildAnalysisSetTableBody(entry){
                const { wrap, overrides, selectedValues, selectedValues2, cfg } = entry;
                const agg = entry._lastAgg; if(!agg) return;
                const tbody = wrap.querySelector('tbody'); if(!tbody) return;
                const thead = wrap.querySelector('thead');

                if(agg.mode === '2d'){
                    // Build pivot header
                    if(thead){
                        thead.innerHTML = `<tr data-row='hdr1'><th data-col='groupHdr' class='px-1 py-0.5 text-left sticky left-0 bg-white z-10'>${(cfg.groupBy||'ROW').toUpperCase()}</th>${agg.colKeys.map(ck=>`<th class='px-1 py-0.5 text-right'>${ck}</th>`).join('')}<th class='px-1 py-0.5 text-right'>TOTAL</th></tr>`;
                    }
                    tbody.innerHTML = agg.rowKeys.map(rk=>{
                        const rowTotal = agg.rowTotals[rk];
                        return `<tr class='odd:bg-slate-50' data-group='${rk}' data-row-key='${rk}'>
                            <td class='px-1 py-0.5 sticky left-0 bg-white z-10'>${rk}</td>
                            ${agg.colKeys.map(ck=>{
                                const cell = agg.matrix[rk][ck];
                                if(!cell) return `<td data-row-key='${rk}' data-col-key='${ck}' class='text-right px-1 py-0.5 text-slate-300'>-</td>`;
                                const ov = overrides?.[rk]?.[ck] || {};
                                const rec = (typeof ov.records==='number')? ov.records : cell.records;
                                const qty = (typeof ov.quantity==='number')? ov.quantity : cell.quantity;
                                const editedQty = (typeof ov.quantity==='number');
                                return `<td data-row-key='${rk}' data-col-key='${ck}' class='text-right px-1 py-0.5'>${qty.toFixed(2)}</td>`;
                            }).join('')}
                            <td class='text-right px-1 py-0.5 font-semibold'>${rowTotal.quantity.toFixed(2)}</td>
                        </tr>`;
                    }).join('');
                    // Build footer with per-column distribution (record) counts + grand total of records
                    const tfoot = wrap.querySelector('tfoot');
                    if(tfoot){
                        const qtyTotalsRow = `<tr data-row='qtyTotals'><td class='px-1 py-0.5 font-semibold'>Totals (Qty L)</td>${agg.colKeys.map(ck=>`<td class='text-right px-1 py-0.5 font-semibold'>${(agg.colTotals[ck]?.quantity||0).toFixed(2)}</td>`).join('')}<td class='text-right px-1 py-0.5 font-semibold'>${agg.grand.quantity.toFixed(2)}</td></tr>`;
                        tfoot.innerHTML = qtyTotalsRow;
                    }
                } else {
                    // Original 1D rendering
                    // Filter rows by selectedValues (already applied inside agg if 2D not used)  keep as safety.
                    let filteredRows = (agg.rows||[]).filter(r=>{
                        if(!selectedValues || selectedValues.length === 0) return true;
                        return selectedValues.includes(String(r.key));
                    });
                    tbody.innerHTML = filteredRows.map(r=>{
                        let displayKey = r.key;
                        if(typeof displayKey === 'object' && displayKey){
                            const candidate = displayKey.name || displayKey.title || displayKey.code || displayKey.id || displayKey.uid;
                            if(candidate) displayKey = candidate; else { try{ displayKey = JSON.stringify(displayKey);}catch{ displayKey = '[object]'; } }
                        }
                        const ov = overrides && overrides[r.key] || {};
                        const rec = (typeof ov.records==='number') ? ov.records : r.records;
                        const qty = (typeof ov.quantity==='number') ? ov.quantity : r.quantity;
                        const editedRec = (typeof ov.records==='number');
                        const editedQty = (typeof ov.quantity==='number');
                        const avg = rec ? (qty/rec) : 0;
                        return `<tr class='odd:bg-slate-50' data-group="${String(displayKey)}">
                            <td class='px-1 py-0.5'>${displayKey}</td>
                            <td class='text-right px-1 py-0.5'>${rec}</td>
                            <td class='text-right px-1 py-0.5'>${qty.toFixed(2)}</td>
                            <td class='text-right px-1 py-0.5' data-field='avg'>${avg.toFixed(2)}</td>
                        </tr>`;
                    }).join('');
                }
            }
            function applyOverridesAndRecompute(entry, animateChart=true){
                const { overrides, chart, wrap, _lastAgg, selectedValues, selectedValues2, cfg } = entry;
                if(!_lastAgg) return;
                if(_lastAgg.mode === '2d'){
                    // Multi-series: each secondary column becomes a dataset (Quantity)
                    const rowKeys = _lastAgg.rowKeys.slice(0,30); // cap rows for chart
                    const colKeys = _lastAgg.colKeys;
                    // Update footer totals (sum of all quantities & records)
                    let totalQty=0, totalRec=0;
                    rowKeys.forEach(rk=>{
                        colKeys.forEach(ck=>{
                            const cell=_lastAgg.matrix[rk][ck]; if(!cell) return;
                            totalQty += cell.quantity; totalRec += cell.records;
                        });
                    });
                    const ftQtyEl = wrap.querySelector('[data-ft-qty]'); if(ftQtyEl) ftQtyEl.textContent = totalQty.toFixed(2);
                    const ftRecEl = wrap.querySelector('[data-ft-rec]'); if(ftRecEl) ftRecEl.textContent = totalRec;
                    // Rebuild record totals footer row to reflect any override (even though editing disabled, keep logic consistent)
                    const tfoot = wrap.querySelector('tfoot');
                    if(tfoot && _lastAgg.colTotals){
                        const qtyTotals = `<tr data-row='qtyTotals'><td class='px-1 py-0.5 font-semibold'>Totals (Qty L)</td>${colKeys.map(ck=>`<td class='text-right px-1 py-0.5 font-semibold'>${(_lastAgg.colTotals[ck]?.quantity||0).toFixed(2)}</td>`).join('')}<td class='text-right px-1 py-0.5 font-semibold'>${_lastAgg.grand.quantity.toFixed(2)}</td></tr>`;
                        tfoot.innerHTML = qtyTotals;
                    }
                    chart.data.labels = rowKeys;
                    // Generate color palette
                    const palette = [
                        '#2563eb','#f59e0b','#10b981','#ef4444','#6366f1','#0d9488','#d946ef','#f97316','#059669','#dc2626',
                        '#4f46e5','#0891b2','#c026d3','#fb7185','#7c3aed','#65a30d','#9333ea','#ea580c','#15803d','#be123c'
                    ];
                    function colorFor(i){ return palette[i % palette.length]; }
                    // Build datasets
                    const datasets = colKeys.map((ck,ci)=>{
                        const data = rowKeys.map(rk=>{
                            const cell=_lastAgg.matrix[rk][ck]; return cell? cell.quantity : 0;
                        });
                        return {
                            label: ck,
                            data,
                            backgroundColor: colorFor(ci),
                            borderColor: colorFor(ci),
                            borderWidth: 1,
                            fill: cfg.chartType==='line'? false : true,
                            tension: 0.25
                        };
                    });
                    // Replace datasets entirely
                    chart.data.datasets = datasets;
                    // Adjust chart type (if pie/doughnut, fallback to bar for multi-series)
                    if(['pie','doughnut'].includes(chart.config.type)){
                        try{ chart.config.type = 'bar'; }catch(e){}
                    }
                    chart.update(animateChart? undefined : 'none');
                } else {
                    // Existing 1D path
                    let rowsToProcess = _lastAgg.rows;
                    if(selectedValues && selectedValues.length > 0){
                        rowsToProcess = rowsToProcess.filter(r=> selectedValues.includes(String(r.key)));
                    }
                    const rows = rowsToProcess.map(r=>{
                        const ov = overrides && overrides[r.key] || {};
                        const records = (typeof ov.records==='number') ? ov.records : r.records;
                        const quantity = (typeof ov.quantity==='number') ? ov.quantity : r.quantity;
                        return { key:r.key, records, quantity };
                    });
                    chart.data.labels = rows.map(r=>String(r.key)).slice(0,30);
                    wrap.querySelector('[data-ft-qty]').textContent = rows.reduce((a,r)=>a + (r.quantity||0),0).toFixed(2);
                    wrap.querySelector('[data-ft-rec]').textContent = rows.reduce((a,r)=>a + (r.records||0),0);
                    // Averages already correct in static cells; no inline update needed.
                    chart.data.datasets[0].data = rows.map(r=>r.quantity).slice(0,30);
                    if (chart.data.datasets[1]) chart.data.datasets[1].data = rows.map(r=>r.records).slice(0,30);
                    chart.update(animateChart? undefined : 'none');
                }
            }
            function applyFiltersToAnalysisSet(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap } = entry;
                const groupSelect = wrap.querySelector('select[data-filt="groupBy"]');
                const group2Select = wrap.querySelector('select[data-filt="groupBy2"]');
                const chartSelect = wrap.querySelector('select[data-filt="chartType"]');
                const startInput = wrap.querySelector('input[data-filt="start"]');
                const endInput = wrap.querySelector('input[data-filt="end"]');
                const groupBy = groupSelect?.value || entry.cfg.groupBy;
                const groupBy2 = group2Select?.value || entry.cfg.groupBy2;
                const chartType = chartSelect?.value || entry.cfg.chartType;
                const start = startInput?.value || '';
                const end = endInput?.value || '';
                // Update cfg
                entry.cfg.groupBy = groupBy;
                const prevGroup2 = entry.cfg.groupBy2;
                entry.cfg.groupBy2 = groupBy2;
                entry.cfg.chartType = chartType;
                entry.cfg.start = start || null;
                entry.cfg.end = end || null;
                if(prevGroup2 !== groupBy2){
                    entry.selectedValues2 = [];
                    populateValueFilterOptions2(id);
                }
                // Replace chart if type changed
                let chart = entry.chart;
                if (chart.config.type !== chartType && !( (chartType==='doughnut'||chartType==='pie') && (chart.config.type==='pie'||chart.config.type==='doughnut') )){
                    try { chart.destroy(); } catch(_){ }
                    const ctx = wrap.querySelector('canvas').getContext('2d');
                    chart = new Chart(ctx,{ type: chartType, data:{ labels:[], datasets:[{ label:'Quantity (L)', data:[], backgroundColor:'#f39c12', borderColor:'#d97706', borderWidth:1 }] }, options:{ responsive:true, maintainAspectRatio:false, scales: (chartType==='pie'||chartType==='doughnut') ? {} : { y:{ beginAtZero:true, ticks:{ font:{ size:8 }, color:'#334155' } }, x:{ ticks:{ font:{ size:8 }, color:'#334155' } } }, plugins:{ legend:{ labels:{ font:{ size:8 }, color:'#334155' } } } }});
                    entry.chart = chart;
                }
                // Adjust datasets for non-pie types to include records
                if (!(chartType==='pie'||chartType==='doughnut')){
                    if (!chart.data.datasets[1]){
                        chart.data.datasets.push({ label:'Records', data:[], backgroundColor:'#334155', borderColor:'#1e293b', borderWidth:1 });
                    }
                } else {
                    if (chart.data.datasets[1]) chart.data.datasets.splice(1,1);
                }
                wrap.querySelector('[data-col="groupHdr"]').textContent = groupBy.toUpperCase();
                
                // Reset selectedValues when groupBy changes, and repopulate (avoid clearing if unchanged)
                if(entry.cfg.groupBy !== groupBy){
                    entry.selectedValues = [];
                    populateValueFilterOptions(id);
                }
                
                refreshAnalysisSet(id);
                const summary = wrap.querySelector('[data-role="summary"]');
                if (summary){
                    summary.textContent = `${groupBy} ${(start||end)?`(${start||'...'} to ${end||'...'})`:''}`;
                }
            }
            function applyPresetRange(id, range){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap } = entry;
                const startInput = wrap.querySelector('input[data-filt="start"]');
                const endInput = wrap.querySelector('input[data-filt="end"]');
                if (!startInput || !endInput) return;
                if (range==='clear'){
                    startInput.value=''; endInput.value='';
                } else {
                    const today = new Date();
                    const endStr = today.toISOString().slice(0,10);
                    let past = new Date();
                    if (range==='7d') past.setDate(today.getDate()-6); // include today
                    if (range==='30d') past.setDate(today.getDate()-29);
                    const startStr = past.toISOString().slice(0,10);
                    startInput.value = startStr; endInput.value = endStr;
                }
                applyFiltersToAnalysisSet(id);
            }
            function removeAnalysisSet(id){
                const entry = analysisSets.get(id); if(!entry) return;
                try { entry.chart.destroy(); } catch(_){ }
                if (entry.wrap && entry.wrap.parentNode) entry.wrap.parentNode.removeChild(entry.wrap);
                analysisSets.delete(id);
            }
            
            // ===== Value Filter (Multi-Select Checkboxes) =====
            function populateValueFilterOptions(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap, cfg } = entry;
                // Use the live select value (so user can preview options before applying filters)
                const groupBySelect = wrap.querySelector('select[data-filt="groupBy"]');
                const liveGroupBy = groupBySelect?.value || cfg.groupBy || 'day';
                const start = cfg.start || '';
                const end = cfg.end || '';
                
                // Get all unique values for current groupBy from data
                const dataset = (Array.isArray(filteredData) && filteredData.length) ? filteredData : distributionData;
                const filtered = dataset.filter(r=>{
                    if(start && r.consumptionDate < start) return false;
                    if(end && r.consumptionDate > end) return false;
                    return true;
                });
                
                const uniqueValues = new Set();
                const normalizeVal = (v)=>{
                    if(v === undefined || v === null) return '';
                    if(typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') return String(v);
                    if(v instanceof Date) return v.toISOString().slice(0,10);
                    // Try common identifier fields if object
                    if(typeof v === 'object'){
                        const candidate = v.name || v.title || v.code || v.id || v.uid || null;
                        if(candidate) return String(candidate);
                        try { return JSON.stringify(v); } catch { return '[object]'; }
                    }
                    return String(v);
                };
                filtered.forEach(r=>{
                    let raw = r[liveGroupBy];
                    if(liveGroupBy==='day' && r.consumptionDate) raw = r.consumptionDate;
                    const val = normalizeVal(raw);
                    if(val) uniqueValues.add(val);
                });
                
                const sortedValues = Array.from(uniqueValues).sort();
                
                // Populate checkboxes
                const container = wrap.querySelector('[data-role="valueCheckboxes"]');
                if(!container) return;
                
                // If the currently stored selectedValues don't intersect new values (e.g., group changed but filters not applied yet), reset to all
                if(entry.selectedValues && entry.selectedValues.length){
                    entry.selectedValues = entry.selectedValues.filter(v=>sortedValues.includes(v));
                }
                if(!entry.selectedValues || entry.selectedValues.length === 0){
                    // Default select-all for the new group context
                    entry.selectedValues = [...sortedValues];
                }
                
                container.innerHTML = sortedValues.map(val=>{
                    const checked = entry.selectedValues.includes(val);
                    const escapedVal = val.replace(/"/g, '&quot;');
                    return `<label class='flex items-center gap-1 px-1 py-0.5 hover:bg-slate-50 cursor-pointer text-[10px]'>
                        <input type='checkbox' value="${escapedVal}" ${checked?'checked':''} class='cursor-pointer' style='width:12px;height:12px;' data-value-check />
                        <span class='truncate'>${val}</span>
                    </label>`;
                }).join('');
                
                // Add event listeners to checkboxes
                container.querySelectorAll('input[data-value-check]').forEach(cb=>{
                    cb.addEventListener('change', ()=>{
                        const val = cb.value;
                        if(cb.checked){
                            if(!entry.selectedValues.includes(val)) entry.selectedValues.push(val);
                        } else {
                            entry.selectedValues = entry.selectedValues.filter(v=>v!==val);
                        }
                        updateValueFilterLabel(id);
                        refreshAnalysisSet(id);
                    });
                });
                
                updateValueFilterLabel(id);
            }
            
            function toggleValueFilterDropdown(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap } = entry;
                const dropdown = wrap.querySelector('[data-role="valueDropdown"]');
                if(!dropdown) return;
                
                // Close all other dropdowns first
                document.querySelectorAll('[data-role="valueDropdown"]').forEach(d=>{
                    if(d !== dropdown) d.classList.add('hidden');
                });
                
                dropdown.classList.toggle('hidden');
                
                // Close on outside click
                if(!dropdown.classList.contains('hidden')){
                    const closeHandler = (e)=>{
                        if(!dropdown.contains(e.target) && !e.target.closest('[data-act="toggle-value-dropdown"]')){
                            dropdown.classList.add('hidden');
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    setTimeout(()=>document.addEventListener('click', closeHandler), 10);
                }
            }
            
            function toggleAllValueSelections(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap } = entry;
                const container = wrap.querySelector('[data-role="valueCheckboxes"]');
                if(!container) return;
                
                const checkboxes = Array.from(container.querySelectorAll('input[data-value-check]'));
                if(!checkboxes.length) return;
                
                // Check current state
                const allChecked = checkboxes.every(cb => cb.checked);
                
                // Toggle: if all checked, uncheck all; otherwise check all
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                });
                
                // Update selectedValues array
                if(allChecked){
                    entry.selectedValues = [];
                } else {
                    entry.selectedValues = checkboxes.map(cb => cb.getAttribute('data-value-check'));
                }
                
                // Update label and refresh table/chart
                updateValueFilterLabel(id);
                refreshAnalysisSet(id);
            }

            // ===== Secondary Value Filter (Group 2) =====
            function populateValueFilterOptions2(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap, cfg } = entry;
                const groupBy2 = cfg.groupBy2 || '';
                if(!groupBy2){
                    // Clear UI if no secondary group
                    const c = wrap.querySelector('[data-role="valueCheckboxes2"]'); if(c) c.innerHTML='';
                    const l = wrap.querySelector('[data-role="valueFilter2Label"]'); if(l) l.textContent='--';
                    return;
                }
                const start = cfg.start || '';
                const end = cfg.end || '';
                const dataset = (Array.isArray(filteredData) && filteredData.length) ? filteredData : distributionData;
                const filtered = dataset.filter(r=>{
                    if(start && r.consumptionDate < start) return false;
                    if(end && r.consumptionDate > end) return false;
                    return true;
                });
                const normalizeVal = (v)=>{
                    if(v === undefined || v === null) return '';
                    if(typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') return String(v);
                    if(v instanceof Date) return v.toISOString().slice(0,10);
                    if(typeof v === 'object'){
                        const candidate = v.name || v.title || v.code || v.id || v.uid || null;
                        if(candidate) return String(candidate);
                        try { return JSON.stringify(v); } catch { return '[object]'; }
                    }
                    return String(v);
                };
                const uniqueValues = new Set();
                filtered.forEach(r=>{
                    let raw = r[groupBy2];
                    if(groupBy2==='day' && r.consumptionDate) raw = r.consumptionDate;
                    const val = normalizeVal(raw);
                    if(val) uniqueValues.add(val);
                });
                const sortedValues = Array.from(uniqueValues).sort();
                if(entry.selectedValues2 && entry.selectedValues2.length){
                    entry.selectedValues2 = entry.selectedValues2.filter(v=>sortedValues.includes(v));
                }
                if(!entry.selectedValues2 || entry.selectedValues2.length===0){
                    entry.selectedValues2 = [...sortedValues];
                }
                const container = wrap.querySelector('[data-role="valueCheckboxes2"]'); if(!container) return;
                container.innerHTML = sortedValues.map(val=>{
                    const checked = entry.selectedValues2.includes(val);
                    const escapedVal = val.replace(/"/g, '&quot;');
                    return `<label class='flex items-center gap-1 px-1 py-0.5 hover:bg-slate-50 cursor-pointer text-[10px]'>
                        <input type='checkbox' value="${escapedVal}" ${checked?'checked':''} class='cursor-pointer' style='width:12px;height:12px;' data-value2-check />
                        <span class='truncate'>${val}</span>
                    </label>`;
                }).join('');
                container.querySelectorAll('input[data-value2-check]').forEach(cb=>{
                    cb.addEventListener('change', ()=>{
                        const val = cb.value;
                        if(cb.checked){ if(!entry.selectedValues2.includes(val)) entry.selectedValues2.push(val); }
                        else { entry.selectedValues2 = entry.selectedValues2.filter(v=>v!==val); }
                        updateValueFilter2Label(id);
                        refreshAnalysisSet(id);
                    });
                });
                updateValueFilter2Label(id);
            }
            function toggleValueFilterDropdown2(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap } = entry;
                const dropdown = wrap.querySelector('[data-role="valueDropdown2"]'); if(!dropdown) return;
                document.querySelectorAll('[data-role="valueDropdown2"]').forEach(d=>{ if(d!==dropdown) d.classList.add('hidden'); });
                dropdown.classList.toggle('hidden');
                if(!dropdown.classList.contains('hidden')){
                    const closeHandler = (e)=>{
                        if(!dropdown.contains(e.target) && !e.target.closest('[data-act="toggle-value2-dropdown"]')){
                            dropdown.classList.add('hidden');
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    setTimeout(()=>document.addEventListener('click', closeHandler),10);
                }
            }
            function toggleAllValueSelections2(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap } = entry;
                const container = wrap.querySelector('[data-role="valueCheckboxes2"]'); if(!container) return;
                const checkboxes = Array.from(container.querySelectorAll('input[data-value2-check]'));
                if(!checkboxes.length) return;
                const allChecked = checkboxes.every(cb=>cb.checked);
                checkboxes.forEach(cb=> cb.checked = !allChecked);
                entry.selectedValues2 = allChecked ? [] : checkboxes.map(cb=>cb.getAttribute('value'));
                updateValueFilter2Label(id);
                refreshAnalysisSet(id);
            }
            function updateValueFilter2Label(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap, selectedValues2 } = entry;
                const label = wrap.querySelector('[data-role="valueFilter2Label"]'); if(!label) return;
                const container = wrap.querySelector('[data-role="valueCheckboxes2"]');
                const total = container? container.querySelectorAll('input[data-value2-check]').length : 0;
                const count = selectedValues2? selectedValues2.length : 0;
                if(!total) { label.textContent='--'; return; }
                if(count===0) label.textContent='None';
                else if(count===total) label.textContent='All';
                else if(count===1) label.textContent = selectedValues2[0].length>15? selectedValues2[0].slice(0,12)+'...' : selectedValues2[0];
                else label.textContent = `${count} selected`;
            }
            // ===== End Secondary Value Filter =====
            
            function updateValueFilterLabel(id){
                const entry = analysisSets.get(id); if(!entry) return;
                const { wrap, selectedValues } = entry;
                const label = wrap.querySelector('[data-role="valueFilterLabel"]');
                if(!label) return;
                
                const container = wrap.querySelector('[data-role="valueCheckboxes"]');
                const totalCount = container?.querySelectorAll('input[data-value-check]').length || 0;
                const selectedCount = selectedValues?.length || 0;
                
                if(selectedCount === 0){
                    label.textContent = 'None';
                } else if(selectedCount === totalCount){
                    label.textContent = 'All';
                } else if(selectedCount === 1){
                    label.textContent = selectedValues[0].length > 15 ? selectedValues[0].substring(0,12)+'...' : selectedValues[0];
                } else {
                    label.textContent = `${selectedCount} selected`;
                }
            }
            // ===== End Value Filter =====
            
            // ===== End Multiple Analysis Sets =====
            // ===== End Primary Analytics Integration =====

                        // Hook into existing tab switch to init when analytics tab shown
                        const origSwitch = window.switchFuelTab;
                        window.switchFuelTab = function(tab){
                                origSwitch.call(this,tab);
                                if (tab==='analytics'){ setTimeout(()=>{ try{ ensureBuilderSection(); }catch(e){ console.warn('Builder ensure failed', e);} }, 50); }
                        };
                        // If already on analytics when script loads
                        if (typeof currentFuelTab !== 'undefined' && currentFuelTab==='analytics'){
                                ensureBuilderSection();
                        }
                })();
                // ======================= End Multi Chart/Table Builder =======================
    </script>
</body>
<!-- Model Edit Modal -->
<div id="modelEditModal" style="display:none;position:fixed;inset:0;z-index:2100;background:rgba(15,23,42,0.55);backdrop-filter:blur(2px);">
  <div style="position:absolute;top:8%;left:50%;transform:translateX(-50%);width:90%;max-width:520px;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 10px 30px -5px rgba(0,0,0,0.25);padding:1rem 1.1rem;display:flex;flex-direction:column;gap:0.85rem;">
     <div style="display:flex;align-items:center;gap:.5rem;">
         <h3 style="margin:0;font-size:.8rem;font-weight:700;color:#1e293b;">Edit Analytics Model</h3>
         <button type="button" onclick="closeModelEditModal()" style="margin-left:auto;font-size:.55rem;padding:0.35rem 0.55rem;background:#334155;color:#fff;border:none;border-radius:4px;font-weight:600;">Close</button>
     </div>
     <div style="display:flex;flex-direction:column;gap:.65rem;">
         <label style="display:flex;flex-direction:column;font-size:.55rem;font-weight:600;color:#475569;gap:4px;">Title
            <input id="modelEditTitle" type="text" style="font-size:.6rem;padding:.35rem .45rem;border:1px solid #cbd5e1;border-radius:4px;" placeholder="Model Title" />
         </label>
         <div style="display:flex;flex-wrap:wrap;gap:.5rem;">
             <label style="flex:1 1 120px;display:flex;flex-direction:column;font-size:.55rem;font-weight:600;color:#475569;gap:4px;">Category
                 <input id="modelEditCategory" disabled type="text" style="font-size:.6rem;padding:.35rem .45rem;border:1px solid #cbd5e1;border-radius:4px;background:#f1f5f9;" />
             </label>
             <label style="flex:1 1 120px;display:flex;flex-direction:column;font-size:.55rem;font-weight:600;color:#475569;gap:4px;">Start
                 <input id="modelEditStart" disabled type="text" style="font-size:.6rem;padding:.35rem .45rem;border:1px solid #cbd5e1;border-radius:4px;background:#f1f5f9;" />
             </label>
             <label style="flex:1 1 120px;display:flex;flex-direction:column;font-size:.55rem;font-weight:600;color:#475569;gap:4px;">End
                 <input id="modelEditEnd" disabled type="text" style="font-size:.6rem;padding:.35rem .45rem;border:1px solid #cbd5e1;border-radius:4px;background:#f1f5f9;" />
             </label>
         </div>
         <div style="font-size:.55rem;color:#64748b;line-height:1.2;">Modify analysis sets directly in the builder below the main analytics section. When ready, click Update Model to save changes. Title can be edited here.</div>
     </div>
     <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.4rem;">
         <button type="button" onclick="closeModelEditModal()" style="font-size:.55rem;padding:0.4rem 0.7rem;border:1px solid #cbd5e1;border-radius:4px;background:#fff;font-weight:600;color:#334155;">Cancel</button>
         <button type="button" onclick="updateCurrentAnalyticsModel()" style="font-size:.55rem;padding:0.4rem 0.8rem;border:none;border-radius:4px;background:#0d9488;color:#fff;font-weight:600;">Update Model</button>
     </div>
  </div>
</div>

<!-- Model Preview Modal -->
<div id="modelPreviewModal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(15,23,42,0.55);backdrop-filter:blur(2px);">
  <div style="position:absolute;top:2%;left:50%;transform:translateX(-50%);width:96%;max-width:1600px;max-height:96%;overflow:auto;background:#ffffff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 10px 30px -5px rgba(0,0,0,0.25);padding:0.8rem 1rem;display:flex;flex-direction:column;gap:0.6rem;">
     <div style="display:flex;align-items:center;gap:0.75rem;">
        <h3 id="modelPreviewTitle" style="margin:0;font-size:0.75rem;font-weight:700;color:#1e293b;letter-spacing:0.5px;">Model Preview</h3>
        <span id="modelPreviewMeta" style="font-size:0.55rem;color:#64748b;">&nbsp;</span>
        <button type="button" onclick="closeModelPreviewModal()" style="margin-left:auto;font-size:0.55rem;padding:0.35rem 0.55rem;background:#334155;color:#fff;border:none;border-radius:4px;font-weight:600;">Close</button>
     </div>
     <div id="modelPreviewContainer" style="display:flex;flex-direction:column;gap:1rem;"></div>
     <div id="modelPreviewReportConfig" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.65rem;display:flex;flex-direction:column;gap:0.6rem;">
        <h4 style="margin:0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;display:flex;align-items:center;gap:.5rem;">Report Configuration <span style='font-weight:400;color:#64748b;'>(For this model snapshot)</span></h4>
        <div style="display:flex;gap:0.9rem;flex-wrap:wrap;align-items:flex-start;">
            <div style="display:flex;flex-direction:column;gap:0.3rem;min-width:240px;">
                <label style="font-size:0.55rem;font-weight:600;color:#475569;">DATE RANGE</label>
                <div style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">
                    <input id="mpReportDateStart" type="date" style="font-size:0.6rem;padding:0.25rem 0.4rem;border:1px solid #cbd5e1;border-radius:4px;" />
                    <span style="font-size:0.55rem;color:#64748b;">to</span>
                    <input id="mpReportDateEnd" type="date" style="font-size:0.6rem;padding:0.25rem 0.4rem;border:1px solid #cbd5e1;border-radius:4px;" />
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.3rem;min-width:200px;">
                <label style="font-size:0.55rem;font-weight:600;color:#475569;">FREQUENCY</label>
                <select id="mpReportFrequency" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;min-width:180px;">
                    <option value="one-time" selected>One-time</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <label style="font-size:0.55rem;font-weight:600;color:#475569;">START ON</label>
                <input id="mpReportStartOn" type="datetime-local" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;min-width:180px;" />
            </div>
            <div style="display:flex;flex-direction:column;gap:0.3rem;min-width:260px;">
                <label style="font-size:0.55rem;font-weight:600;color:#475569;">RECIPIENTS (Company Users)</label>
                <div id="mpRecipientsDropdown" style="position:relative;min-width:240px;">
                    <button type="button" id="mpRecipientsDropdownBtn" onclick="toggleMpRecipientsDropdown()" style="width:100%;text-align:left;font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:0.5rem;">
                        <span>Select recipients</span>
                        <i class="fas fa-chevron-down" style="font-size:0.7rem;color:#64748b;"></i>
                    </button>
                    <div id="mpRecipientsDropdownMenu" style="display:none;position:absolute;z-index:15;left:0;right:0;background:#fff;border:1px solid #e2e8f0;border-radius:6px;margin-top:4px;max-height:200px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:6px;"></div>
                </div>
                <div id="mpRecipientsSelected" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;"></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.3rem;min-width:240px;">
                <label style="font-size:0.55rem;font-weight:600;color:#475569;">ADDITIONAL EMAILS</label>
                <input id="mpReportEmails" type="text" placeholder="user@company.com, other@company.com" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;min-width:220px;" />
            </div>
            <div style="display:flex;flex-direction:column;gap:0.3rem;min-width:320px;flex:1;">
                <label style="font-size:0.55rem;font-weight:600;color:#475569;">EMAIL SUBJECT & MESSAGE</label>
                <input id="mpReportEmailSubject" type="text" style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;" />
                <textarea id="mpReportEmailMessage" rows="2" placeholder="Optional note..." style="font-size:0.6rem;padding:0.35rem 0.45rem;border:1px solid #cbd5e1;border-radius:4px;resize:vertical;"></textarea>
            </div>
            <div style="display:flex;gap:0.5rem;margin-left:auto;flex-wrap:wrap;align-items:center;">
                <button type="button" onclick="mpScheduleAndSendReport()" style="font-size:0.55rem;padding:0.35rem 0.6rem;background:#16a34a;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;display:inline-flex;align-items:center;gap:0.3rem;"><i class="fas fa-paper-plane"></i> SEND NOW</button>
                <button type="button" onclick="mpScheduleReport()" style="font-size:0.55rem;padding:0.35rem 0.6rem;background:#64748b;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;display:inline-flex;align-items:center;gap:0.3rem;"><i class="fas fa-clock"></i> SAVE SCHEDULE</button>
                <button type="button" onclick="mpGeneratePdf()" style="font-size:0.55rem;padding:0.35rem 0.6rem;background:#0ea5e9;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;display:inline-flex;align-items:center;gap:0.3rem;"><i class="fas fa-file-pdf"></i> PDF ONLY</button>
            </div>
        </div>
        <div id="mpReportStatus" style="font-size:0.55rem;color:#475569;margin-top:0.1rem;"></div>
     </div>
  </div>
</div>

<!-- Summary Modal (mirrors Model Preview content: all tables & charts) -->
<div id="summaryModal" style="display:none;position:fixed;inset:0;z-index:2100;background:rgba(15,23,42,0.55);backdrop-filter:blur(2px);">
    <div style="position:absolute;top:3%;left:50%;transform:translateX(-50%);width:94%;max-width:1700px;max-height:94%;overflow:auto;background:#ffffff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 10px 32px -4px rgba(0,0,0,0.28);padding:0.85rem 1rem 1.1rem;display:flex;flex-direction:column;gap:0.7rem;">
         <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                <h3 id="summaryModalTitle" style="margin:0;font-size:0.78rem;font-weight:700;color:#1e293b;letter-spacing:0.5px;display:flex;align-items:center;gap:0.4rem;"><i class="fas fa-list-alt" style="color:#0f766e;"></i> Summary View</h3>
                <span id="summaryModalMeta" style="font-size:0.55rem;color:#64748b;">&nbsp;</span>
                <div style="margin-left:auto;display:flex;gap:0.4rem;flex-wrap:wrap;">
                        <button type="button" onclick="exportSummaryPdf()" style="font-size:0.55rem;padding:0.4rem 0.65rem;background:#0ea5e9;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;display:inline-flex;align-items:center;gap:0.35rem;"><i class="fas fa-file-pdf"></i> PDF</button>
                        <button type="button" onclick="closeSummaryModal()" style="font-size:0.55rem;padding:0.4rem 0.65rem;background:#334155;color:#fff;border:none;border-radius:4px;font-weight:600;letter-spacing:0.5px;">Close</button>
                </div>
         </div>
         <div id="summaryModalContainer" style="display:flex;flex-direction:column;gap:1rem;"></div>
         <div id="summaryModalStatus" style="font-size:0.55rem;color:#475569;"></div>
    </div>
</div>

<script>
function showModelPreviewModal(title, snapshotSets){
    const modal = document.getElementById('modelPreviewModal'); if(!modal) return;
    document.getElementById('modelPreviewTitle').textContent = title;
    const container = document.getElementById('modelPreviewContainer');
    const metaEl = document.getElementById('modelPreviewMeta');
    // Normalize source sets: prefer provided snapshot, else live Map
    let sets = [];
    if (Array.isArray(snapshotSets) && snapshotSets.length){
        sets = snapshotSets.map((s,i)=>({
            id: s.id || ('S'+i),
            cfg: s.cfg || {},
            table: s.table || '',
            chart: s.chart || { type: (s.cfg && s.cfg.chartType) || 'bar', labels:[], datasets:[] }
        }));
    } else if (typeof analysisSets !== 'undefined' && analysisSets instanceof Map && analysisSets.size){
        analysisSets.forEach((entry,id)=>{
            const tableEl = entry.wrap?.querySelector('table');
            let chartMeta = { type: entry.chart?.config?.type || entry.cfg.chartType || 'bar', labels: entry.chart?.data?.labels||[], datasets: [] };
            try { chartMeta.datasets = (entry.chart?.data?.datasets||[]).map(ds=>({ label: ds.label, data: ds.data, backgroundColor: ds.backgroundColor, borderColor: ds.borderColor })); } catch(e){}
            sets.push({ id, cfg: { ...entry.cfg }, table: tableEl? tableEl.outerHTML : '', chart: chartMeta });
        });
    }
    const setsCount = sets.length;
    if (metaEl) metaEl.textContent = setsCount + ' analysis set' + (setsCount===1?'':'s');
    if (container){
        container.innerHTML = '';
        if (!setsCount){
            container.innerHTML = '<div style="font-size:0.6rem;color:#64748b;">No analysis sets present.</div>';
        } else {
            const renderCharts = ()=> sets.forEach(s=>{
                const { id, cfg, table, chart } = s;
                const groupLabel = cfg?.groupBy || 'group';
                const dateRange = (cfg?.start||cfg?.end)?`(${cfg.start||'...'} to ${cfg.end||'...'})`:'';
                const chartType = cfg?.chartType || chart?.type || 'bar';
                const block = document.createElement('div');
                block.className = `block-${id}`;
                block.style.border='1px solid #e2e8f0';
                block.style.borderRadius='8px';
                block.style.padding='0.6rem';
                block.style.background='#fff';
                block.style.display='flex';
                block.style.flexDirection='column';
                block.style.gap='0.5rem';
                block.innerHTML = `
                   <div style='display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;'>
                      <span style='font-size:0.6rem;font-weight:600;color:#334155;'>Set: ${groupLabel} ${dateRange}</span>
                      <span style='font-size:0.5rem;color:#64748b;'>Chart: ${chartType}</span>
                   </div>
                   <div style='display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;'>
                      <div style='border:1px solid #e2e8f0;border-radius:6px;padding:0.4rem;overflow:auto;max-height:280px;'>
                         <div style='overflow-x:auto;min-width:300px;'>
                            ${table ? table : '<div style="font-size:0.55rem;color:#64748b;">(No table captured)</div>'}
                         </div>
                      </div>
                      <div style='border:1px solid #e2e8f0;border-radius:6px;padding:0.4rem;display:flex;flex-direction:column;min-height:240px;min-width:300px;'>
                          <canvas id='modelPrevChart_${id}' style='width:100%;height:220px;max-width:100%;'></canvas>
                      </div>
                   </div>
                   <style>
                   @media (max-width: 1200px) {
                       .block-${id} > div:last-child {
                           grid-template-columns: 1fr !important;
                       }
                   }
                   </style>`;
                container.appendChild(block);
            });
            // After DOM blocks are inserted, ensure Chart.js loaded then instantiate charts
            const buildAll = ()=>{
                sets.forEach(s=>{
                    try {
                        const { id, cfg, chart } = s;
                        const chartType = cfg?.chartType || chart?.type || 'bar';
                        const canvas = container.querySelector(`#modelPrevChart_${id}`);
                        if (!canvas) return;
                        const ctx = canvas.getContext('2d');
                        
                        // Enhanced datasets with modern colors
                        const enhancedDatasets = ((chart?.datasets)||[]).map((ds, dsIdx) => ({
                            ...ds,
                            backgroundColor: ds.backgroundColor || (dsIdx === 0 ? 'rgba(37, 99, 235, 0.75)' : 'rgba(14, 165, 233, 0.65)'),
                            borderColor: ds.borderColor || (dsIdx === 0 ? '#2563eb' : '#0ea5e9'),
                            borderWidth: 2,
                            borderRadius: 6,
                            hoverBackgroundColor: dsIdx === 0 ? 'rgba(37, 99, 235, 0.9)' : 'rgba(14, 165, 233, 0.85)',
                            hoverBorderColor: dsIdx === 0 ? '#1e40af' : '#0284c7',
                            hoverBorderWidth: 3
                        }));
                        
                        const chartCfg = {
                            type: chart?.type || chartType,
                            data: { labels: (chart?.labels)||[], datasets: enhancedDatasets },
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: false,
                                layout:{ padding:{ left:10, right:10, top:15, bottom:5 }},
                                plugins: { 
                                    legend: { 
                                        display: true,
                                        position: 'top',
                                        labels: { 
                                            font: { size: 11, weight: '600', family: "'Inter', 'Segoe UI', sans-serif" },
                                            color: '#334155',
                                            padding: 10,
                                            usePointStyle: true,
                                            pointStyle: 'rectRounded',
                                            boxWidth: 12
                                        } 
                                    }, 
                                    title: { display: false },
                                    tooltip:{
                                        backgroundColor:'rgba(15, 23, 42, 0.95)',
                                        titleColor:'#fff',
                                        bodyColor:'#e2e8f0',
                                        titleFont:{ size:12, weight:'700' },
                                        bodyFont:{ size:11 },
                                        padding:10,
                                        cornerRadius:8,
                                        displayColors:true,
                                        borderColor:'rgba(148, 163, 184, 0.3)',
                                        borderWidth:1
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { 
                                            font: { size: 10, weight: '500' },
                                            color: '#475569',
                                            maxRotation: 45,
                                            minRotation: 0
                                        },
                                        grid: { display: false },
                                        border: { color: '#cbd5e1', width: 1 }
                                    },
                                    y: { 
                                        ticks: { 
                                            font: { size: 10, weight: '500' },
                                            color: '#475569'
                                        },
                                        grid: { color: 'rgba(203, 213, 225, 0.4)', lineWidth: 1 },
                                        border: { color: '#cbd5e1', width: 1 },
                                        beginAtZero: true
                                    }
                                },
                                animation: {
                                    duration: 700,
                                    easing: 'easeInOutQuart'
                                },
                                interaction: { mode: 'index', intersect: false }
                            }
                        };
                        if (typeof Chart !== 'undefined') new Chart(ctx, chartCfg);
                    } catch(e){ console.warn('preview chart build failed', e); }
                });
            };
            renderCharts();
            if (typeof Chart === 'undefined') {
                try { loadChartJs(buildAll); } catch(e){ console.warn('failed to load Chart.js for preview', e); }
            } else {
                buildAll();
            }
        }
    }
    modal.style.display='block';
    document.body.style.overflow='hidden';
    // Initialize MP report defaults with first model-like context
    try { initMpReportDefaults({ title, start: (sets[0] && sets[0].cfg && sets[0].cfg.start) || '', end: (sets[0] && sets[0].cfg && sets[0].cfg.end) || '' }); } catch(e){ }
}
function closeModelPreviewModal(){
    const modal=document.getElementById('modelPreviewModal'); if(!modal) return;
    modal.style.display='none';
    document.body.style.overflow='auto';
}
// ===== Summary Modal (Exact replication of tables & charts from preview) =====
function openSummaryModal(){ showSummaryModal(); }
function showSummaryModal(){
    try {
        const modal = document.getElementById('summaryModal'); if(!modal) return;
        const container = document.getElementById('summaryModalContainer'); if(!container) return;
        const metaEl = document.getElementById('summaryModalMeta');
        const titleEl = document.getElementById('summaryModalTitle');
        if (titleEl) titleEl.querySelector && (titleEl.querySelector('span') ? null : null); // placeholder (no dynamic span yet)

        // Derive sets exactly as model preview logic
        let sets = [];
        if (window.__lastPreviewSets && Array.isArray(window.__lastPreviewSets) && window.__lastPreviewSets.length){
            sets = JSON.parse(JSON.stringify(window.__lastPreviewSets));
        } else if (typeof analysisSets !== 'undefined' && analysisSets instanceof Map && analysisSets.size){
            analysisSets.forEach((entry,id)=>{
                const tableEl = entry.wrap?.querySelector('table');
                let chartMeta = { type: entry.chart?.config?.type || entry.cfg.chartType || 'bar', labels: entry.chart?.data?.labels||[], datasets: [] };
                try { chartMeta.datasets = (entry.chart?.data?.datasets||[]).map(ds=>({ label: ds.label, data: ds.data, backgroundColor: ds.backgroundColor, borderColor: ds.borderColor })); } catch(e){}
                sets.push({ id, cfg: { ...entry.cfg }, table: tableEl? tableEl.outerHTML : '', chart: chartMeta });
            });
        }
        window.__summarySets = sets;
        if (metaEl) metaEl.textContent = sets.length ? `${sets.length} set${sets.length===1?'':'s'} captured` : 'No sets';
        container.innerHTML='';
        if (!sets.length){
            container.innerHTML = '<div style="font-size:0.6rem;color:#64748b;">No data available to summarize.</div>';
        } else {
            sets.forEach(s=>{
                const { id, cfg, table, chart } = s;
                const groupLabel = cfg?.groupBy || 'group';
                const dateRange = (cfg?.start||cfg?.end)?`(${cfg.start||'...'} to ${cfg.end||'...'})`:'';
                const chartType = cfg?.chartType || chart?.type || 'bar';
                const block = document.createElement('div');
                block.className = `summary-block-${id}`;
                block.style.cssText='border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;background:#fff;display:flex;flex-direction:column;gap:0.5rem;';
                block.innerHTML = `
                   <div style='display:flex;align-items:center;gap:0.5rem;margin-bottom:0.2rem;'>
                      <span style='font-size:0.6rem;font-weight:600;color:#334155;'>Set: ${groupLabel} ${dateRange}</span>
                      <span style='font-size:0.5rem;color:#64748b;'>Chart: ${chartType}</span>
                   </div>
                   <div style='display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;'>
                      <div style='border:1px solid #e2e8f0;border-radius:6px;padding:0.4rem;overflow:auto;max-height:280px;'>
                         <div style='overflow-x:auto;min-width:300px;'>
                            ${table ? table : '<div style="font-size:0.55rem;color:#64748b;">(No table captured)</div>'}
                         </div>
                      </div>
                      <div style='border:1px solid #e2e8f0;border-radius:6px;padding:0.4rem;display:flex;flex-direction:column;min-height:240px;min-width:300px;'>
                          <canvas id='summaryChart_${id}' style='width:100%;height:220px;max-width:100%;'></canvas>
                      </div>
                   </div>
                   <style>
                       @media (max-width: 1200px){ .summary-block-${id} > div:last-child { grid-template-columns:1fr !important; } }
                   </style>`;
                container.appendChild(block);
            });
            const buildCharts = ()=>{
                if (typeof Chart === 'undefined') return;
                sets.forEach(s=>{
                    try {
                        const { id, cfg, chart } = s;
                        const chartType = cfg?.chartType || chart?.type || 'bar';
                        const canvas = container.querySelector(`#summaryChart_${id}`); if(!canvas) return;
                        const ctx = canvas.getContext('2d');
                        new Chart(ctx, {
                            type: chart?.type || chartType,
                            data: { labels: chart?.labels||[], datasets: chart?.datasets||[] },
                            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ font:{ size:10 } } } }, scales:{ x:{ ticks:{ font:{ size:9 } } }, y:{ ticks:{ font:{ size:9 } } } } }
                        });
                    } catch(e){ console.warn('summary chart build failed', e); }
                });
            };
            if (typeof Chart === 'undefined') { try { loadChartJs(buildCharts); } catch(e){ console.warn('Chart.js load failed (summary)', e); } } else { buildCharts(); }
        }
        modal.style.display='block';
        document.body.style.overflow='hidden';
    } catch(e){ console.warn('showSummaryModal failed', e); }
}
function closeSummaryModal(){ const modal=document.getElementById('summaryModal'); if(!modal) return; modal.style.display='none'; document.body.style.overflow='auto'; }
async function exportSummaryPdf(){
    try {
        const status = document.getElementById('summaryModalStatus'); if(status){ status.textContent='Generating PDF...'; status.style.color='#475569'; }
        if (!window.jspdf || !window.jspdf.jsPDF){ throw new Error('jsPDF not loaded'); }
        const { jsPDF } = window.jspdf; const doc = new jsPDF('p','pt','a4');
        const pageHeight = doc.internal.pageSize.getHeight();
        const left = 36; let y = 42;
        doc.setFontSize(14); doc.text('Summary Report', left, y); y += 12;
        const sets = window.__summarySets || [];
        if (!sets.length){ doc.setFontSize(10); doc.text('No data sets available.', left, y+12); }
        const container = document.getElementById('summaryModalContainer');
        function ensurePage(spaceNeeded){
            if (y + spaceNeeded > pageHeight - 36){
                doc.addPage(); y = 42; doc.setFontSize(9); doc.setTextColor(120); doc.text('Continued...', left, y); y += 14; doc.setTextColor(0);
            }
        }
        for (let i=0;i<sets.length;i++){
            const s = sets[i];
            const header = `Set ${i+1}: ${(s.cfg && s.cfg.groupBy)||'Group'}`;
            doc.setFontSize(11); ensurePage(30); doc.text(header, left, y); y += 10;
            // Table (full, not truncated)
            if (s.table){
                try {
                    const tmp = document.createElement('div'); tmp.innerHTML = s.table;
                    const headRow = tmp.querySelector('thead tr');
                    const bodyRows = [...tmp.querySelectorAll('tbody tr')];
                    const headCells = headRow ? [...headRow.children].map(c=>c.textContent.trim()) : [];
                    const body = bodyRows.map(r=>[...r.children].map(c=>c.textContent.trim()));
                    if (doc.autoTable){
                        doc.autoTable({
                            startY: y,
                            head: headCells.length ? [headCells] : [],
                            body,
                            styles: { fontSize:7, cellPadding:2 },
                            headStyles:{ fillColor:[51,65,85], textColor:255 },
                            margin:{ left },
                            didDrawPage: data => { y = data.cursor.y + 12; }
                        });
                    } else {
                        ensurePage(12); doc.setFontSize(9); doc.text('[Table rendering requires autoTable plugin]', left, y); y += 14;
                    }
                } catch(e){ ensurePage(12); doc.setFontSize(9); doc.setTextColor(200,0,0); doc.text('Table parse error', left, y); doc.setTextColor(0); y += 14; }
            }
            // Chart capture (rendered canvas -> image)
            try {
                const canvasEl = container.querySelector(`#summaryChart_${s.id}`);
                if (canvasEl){
                    const dataUrl = canvasEl.toDataURL('image/png', 1.0);
                    const imgWidth = 400; const imgHeight = (canvasEl.height / canvasEl.width) * imgWidth;
                    ensurePage(imgHeight + 20);
                    doc.setFontSize(9); doc.setTextColor(90); doc.text('Chart:', left, y); y += 6; doc.setTextColor(0);
                    doc.addImage(dataUrl, 'PNG', left, y, imgWidth, imgHeight, undefined, 'FAST');
                    y += imgHeight + 16;
                }
            } catch(e){ ensurePage(12); doc.setFontSize(8); doc.setTextColor(200,0,0); doc.text('Chart capture failed', left, y); doc.setTextColor(0); y += 12; }
            if (i < sets.length -1){ ensurePage(18); doc.setDrawColor(230); doc.line(left, y, left+520, y); y += 12; }
        }
        const filename = 'summary-report-'+Date.now()+'.pdf';
        doc.save(filename);
        if(status){ status.textContent='PDF downloaded: '+filename; status.style.color='#16a34a'; }
    } catch(e){ console.warn('exportSummaryPdf failed', e); const status=document.getElementById('summaryModalStatus'); if(status){ status.textContent='PDF error: '+e.message; status.style.color='#b91c1c'; } }
}
// ===== Preview Modal Report Config (MP*) Functions =====
function initMpReportDefaults(model){
    try {
        if (!model) return;
        const start = model.start || '';
        const end = model.end || '';
        const subjEl = document.getElementById('mpReportEmailSubject');
        const msgEl = document.getElementById('mpReportEmailMessage');
        const sInput = document.getElementById('mpReportDateStart');
        const eInput = document.getElementById('mpReportDateEnd');
        if (sInput) sInput.value = start;
        if (eInput) eInput.value = end;
        if (subjEl && !subjEl.value) subjEl.value = (model.title ? (model.title + ' Report') : 'Fuel Distribution Report');
        if (msgEl && !msgEl.value) msgEl.value = 'Attached / linked is the requested distribution analytics report.';
        populateMpRecipients();
    } catch(e){ console.warn('initMpReportDefaults failed', e); }
}
function toggleMpRecipientsDropdown(){
    const menu = document.getElementById('mpRecipientsDropdownMenu'); if(!menu) return;
    menu.style.display = (menu.style.display==='none' || !menu.style.display) ? 'block' : 'none';
}
async function populateMpRecipients(){
    try {
        const menu = document.getElementById('mpRecipientsDropdownMenu'); if(!menu) return;
        menu.innerHTML = '<div style="font-size:0.55rem;color:#64748b;padding:4px;">Loading...</div>';
        if (!firebase || !firebase.database){ menu.innerHTML='<div style="font-size:0.55rem;color:#b91c1c;">Firebase unavailable</div>'; return; }
        // Reuse logic similar to populateReportRecipientsFromUsers: try multiple collection paths
        const tryPaths = ['users','companyUsers'];
        const added = new Set();
        let allUsers = [];
        for (const path of tryPaths){
            try {
                const snap = await firebase.database().ref(path).once('value');
                const val = snap.val() || {};
                Object.values(val).forEach(u=>{ allUsers.push(u); });
            } catch(e) { /* ignore path failures */ }
        }
        // Deduplicate by email using same fields as original
        const opts = [];
        allUsers.forEach(u=>{
            const email=(u.email||u.workEmail||'').trim();
            const name=(u.name||u.fullName||u.displayName||'').trim();
            if (email && !added.has(email)){
                added.add(email);
                opts.push({ email, label: name? `${name} <${email}>` : email });
            }
        });
        if (!opts.length){ menu.innerHTML='<div style="font-size:0.55rem;color:#64748b;">No users found</div>'; return; }
        // Sort alphabetically by label for consistency
        opts.sort((a,b)=> a.label.localeCompare(b.label));
        menu.innerHTML='';
        opts.slice(0,800).forEach(o=>{
            const btn = document.createElement('button');
            btn.type='button';
            btn.style.cssText='display:flex;width:100%;text-align:left;font-size:0.55rem;padding:4px 6px;border:none;background:#fff;gap:6px;align-items:center;border-radius:4px;';
            btn.innerHTML = `<span style='flex:1;'>${o.label}</span>`;
            btn.onmouseenter=()=>{ btn.style.background='#f1f5f9'; };
            btn.onmouseleave=()=>{ btn.style.background='#fff'; };
            btn.onclick=()=>{ addMpRecipient(o.email); };
            menu.appendChild(btn);
        });
    } catch(e){ console.warn('populateMpRecipients failed', e); }
}
function addMpRecipient(email){
    if(!email) return;
    const wrap = document.getElementById('mpRecipientsSelected'); if(!wrap) return;
    // Prevent duplicates
    if ([...wrap.querySelectorAll('span[data-email]')].some(s=>s.getAttribute('data-email')===email)) return;
    const chip = document.createElement('span');
    chip.setAttribute('data-email', email);
    chip.style.cssText='background:#e2e8f0;color:#334155;padding:2px 6px;border-radius:12px;font-size:0.5rem;display:inline-flex;align-items:center;gap:4px;';
    chip.innerHTML = `<span>${email}</span><button type='button' style='background:none;border:none;font-size:0.55rem;cursor:pointer;color:#475569;'></button>`;
    chip.querySelector('button').onclick=()=> chip.remove();
    wrap.appendChild(chip);
}
function collectMpRecipients(){
    const wrap = document.getElementById('mpRecipientsSelected'); if(!wrap) return [];
    return [...wrap.querySelectorAll('span[data-email]')].map(s=>s.getAttribute('data-email'));
}
async function mpScheduleReport(){
    try {
        const status = document.getElementById('mpReportStatus');
        if (status){ status.textContent='Validating schedule...'; status.style.color='#475569'; }
        // Gather inputs
        const recipients = collectMpRecipients();
        const extra = (document.getElementById('mpReportEmails')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const allRecipients = Array.from(new Set([...recipients, ...extra])).filter(Boolean);
        if (!allRecipients.length){ if(status){ status.textContent='Add at least one recipient.'; status.style.color='#b91c1c'; } return; }
        const freq = (document.getElementById('mpReportFrequency')?.value || 'one-time').trim();
        const startOnRaw = document.getElementById('mpReportStartOn')?.value || '';
        const startDate = startOnRaw ? new Date(startOnRaw) : new Date(Date.now()+ 60_000); // default +1 min
        if (isNaN(startDate.getTime())) { if(status){ status.textContent='Invalid start date-time.'; status.style.color='#b91c1c'; } return; }
        // Basic guard: start must be future (>= now - 5s tolerance)
        if (startDate.getTime() < Date.now() - 5000){ if(status){ status.textContent='Start time must be in the future.'; status.style.color='#b91c1c'; } return; }
        const dateStart = document.getElementById('mpReportDateStart')?.value || '';
        const dateEnd = document.getElementById('mpReportDateEnd')?.value || '';
        const subject = document.getElementById('mpReportEmailSubject')?.value || 'Fuel Distribution Report';
        const message = document.getElementById('mpReportEmailMessage')?.value || '';
        // Use last preview model for context
        const model = window.__reportPreviewLastModel || {};
        const title = model.title || 'Fuel Distribution Analytics';
        const category = model.category || model.groupBy || 'day';
        const type = model.type || 'summary';
        // Build schedule payload
        const schedule = {
            title,
            type,
            category,
            dateRange: { start: dateStart, end: dateEnd },
            frequency: freq,
            startOn: startDate.toISOString(),
            recipients: allRecipients,
            subject,
            message,
            createdAt: Date.now(),
            status: 'scheduled',
            source: 'preview-modal'
        };
        // Persist to Firebase under a company-specific path if company id known
        const companyId = (window.companyDataService && window.companyDataService.currentCompany && (window.companyDataService.currentCompany.id || window.companyDataService.currentCompany.companyId)) || 'default';
        if (!window.firebase || !firebase.database){ if(status){ status.textContent='Firebase not available.'; status.style.color='#b91c1c'; } return; }
        const refPath = `scheduledReports/fueldist/${companyId}`;
        const ref = firebase.database().ref(refPath).push();
        schedule.id = ref.key;
        await ref.set(schedule);
        if (status){ status.textContent = `? Schedule saved (${freq}) for ${startDate.toLocaleString()}. Note: Requires backend service to execute automatically.`; status.style.color='#16a34a'; }
    } catch(e){ console.warn('mpScheduleReport failed', e); const status = document.getElementById('mpReportStatus'); if(status){ status.textContent='Schedule error: '+e.message; status.style.color='#b91c1c'; } }
}
async function mpScheduleAndSendReport(){
    try {
        const status = document.getElementById('mpReportStatus');
        if (status){ status.textContent='Sending report now...'; status.style.color='#475569'; }
        // Validate recipients
        const recipients = collectMpRecipients();
        const extra = (document.getElementById('mpReportEmails')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const allRecipients = Array.from(new Set([...recipients, ...extra])).filter(Boolean);
        if (!allRecipients.length){ if(status){ status.textContent='Add at least one recipient.'; status.style.color='#b91c1c'; } return; }
        
        // Send immediately using mpSendReport logic
        await mpSendReport();
        
    } catch(e){ console.warn('mpScheduleAndSendReport failed', e); const status = document.getElementById('mpReportStatus'); if(status){ status.textContent='Send error: '+e.message; status.style.color='#b91c1c'; } }
}
function mpGeneratePdf(){
    try {
        const status = document.getElementById('mpReportStatus');
        if(status){ status.textContent='Opening print preview...'; status.style.color='#475569'; }
        openPrintPreviewFromModel();
    } catch(e){ console.warn('mpGeneratePdf failed', e); const status = document.getElementById('mpReportStatus'); if(status){ status.textContent='PDF generation error: '+e.message; status.style.color='#b91c1c'; } }
}

// Print Preview Modal (lightweight) similar to payroll payslip print
function openPrintPreviewFromModel(){
    // Ensure model preview is open so we have fresh, rendered content
    const previewModal = document.getElementById('modelPreviewModal');
    if(!previewModal || previewModal.style.display==='none'){
        alert('Open the Model Preview first (Preview Model) so content is prepared for printing.');
        return;
    }
    const existing = document.getElementById('printPreviewModal');
    if(existing) existing.remove();

    // Extract pieces
    const title = (document.getElementById('modelPreviewTitle')?.textContent || 'Fuel Distribution Report').trim();
    const meta = (document.getElementById('modelPreviewMeta')?.textContent || '').trim();
    const setsHtmlRaw = document.getElementById('modelPreviewContainer')?.innerHTML || '';
    const reportCfgClone = document.getElementById('modelPreviewReportConfig')?.cloneNode(true);

    if(reportCfgClone){
        // Replace interactive inputs with static spans for clean print
        reportCfgClone.querySelectorAll('input,select,textarea,button').forEach(el=>{
            const span = document.createElement('span');
            span.className = 'pp-field-value';
            const val = (el.value || el.textContent || '').trim();
            span.textContent = val;
            el.replaceWith(span);
        });
    }

    // Build modal container (screen overlay)  inside we simulate A4 pages
    const modal = document.createElement('div');
    modal.id='printPreviewModal';
    modal.setAttribute('role','dialog');
    modal.style.cssText='position:fixed;inset:0;z-index:2400;background:rgba(15,23,42,0.60);backdrop-filter:blur(3px);display:flex;flex-direction:column;';

    // Company name (attempt to derive; fallback generic)
    let companyName = 'Company Name';
    try {
        if (window.companyDataService){
            const c = window.companyDataService.currentCompany || (window.companyDataService.getCurrentCompany?.());
            if(c && (c.name||c.legalName)) companyName = c.name || c.legalName;
        }
    } catch(_){ }

    const generatedOn = new Date();
    const genStr = generatedOn.toLocaleString(undefined,{ day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});

    // Wrap analysis sets in print blocks so we can apply page-break control.
    // We'll lightly transform each top-level .analysis-set (if that class is used) else fallback to generic wrappers.
    const tempWrapper = document.createElement('div');
    tempWrapper.innerHTML = setsHtmlRaw;
    const setBlocks = Array.from(tempWrapper.querySelectorAll('.analysis-set')); // adapt if actual class name differs
    if(!setBlocks.length){
        // If not found, treat direct children as blocks
        Array.from(tempWrapper.children).forEach(ch=>{ ch.classList.add('analysis-print-block'); });
    } else {
        setBlocks.forEach(ch=> ch.classList.add('analysis-print-block'));
    }

    const processedSetsHtml = tempWrapper.innerHTML;

    modal.innerHTML = `
    <div class="pp-toolbar" style="display:flex;align-items:center;gap:.5rem;padding:.55rem .85rem;background:#0f172a;color:#fff;box-shadow:0 2px 6px -2px rgba(0,0,0,0.3);">
        <strong style="font-size:.7rem;letter-spacing:.5px;">PRINT PREVIEW</strong>
        <span style="font-size:.55rem;opacity:.85;">${title}</span>
        <div style="margin-left:auto;display:flex;gap:.4rem;">
            <button type="button" onclick="window.print()" class="pp-btn pp-btn-primary"><i class='fas fa-print'></i><span>Print</span></button>
            <button type="button" onclick="closePrintPreview()" class="pp-btn pp-btn-secondary">Close</button>
        </div>
    </div>
    <div class="pp-scroll" style="flex:1;overflow:auto;padding:1rem;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);">
        <div class="pp-sheet a4" data-page="1">
            <header class="pp-header">
                <div class="pp-header-left">
                    <div class="pp-company">${companyName}</div>
                    <div class="pp-report-title">${title}</div>
                    ${meta ? `<div class='pp-meta-line'>${meta}</div>` : ''}
                </div>
                <div class="pp-header-right">
                    <div class="pp-stamp-label">Generated</div>
                    <div class="pp-stamp-value">${genStr}</div>
                </div>
            </header>
            <main class="pp-body">
                <section class="pp-section">
                    <h4 class="pp-section-title">Report Configuration</h4>
                    <div class="pp-config">${reportCfgClone ? reportCfgClone.outerHTML : '<em style="font-size:.6rem;color:#64748b;">No configuration snapshot</em>'}</div>
                </section>
                <section class="pp-section">
                    <h4 class="pp-section-title">Analysis Sets</h4>
                    <div class="pp-sets-container">${processedSetsHtml}</div>
                </section>
            </main>
            <footer class="pp-footer">
                <div class="pp-footer-left">${companyName}  Confidential</div>
                <div class="pp-footer-right">Page <span class="pp-page-num"></span></div>
            </footer>
        </div>
    </div>`;

    document.body.appendChild(modal);

    // Add styles (scoped within modal for screen + print). We avoid global leakage by prefixing .pp-
    const style = document.createElement('style');
    style.textContent = `
    /* SCREEN TOOLBAR BUTTONS */
    #printPreviewModal .pp-btn { cursor:pointer;border:none;border-radius:4px;display:inline-flex;align-items:center;gap:.35rem;font-size:.55rem;font-weight:600;padding:.45rem .7rem;font-family:inherit; }
    #printPreviewModal .pp-btn-primary{ background:#0ea5e9;color:#fff; }
    #printPreviewModal .pp-btn-primary:hover{ background:#0284c7; }
    #printPreviewModal .pp-btn-secondary{ background:#334155;color:#fff; }
    #printPreviewModal .pp-btn-secondary:hover{ background:#1e293b; }
    #printPreviewModal .pp-scroll{ scrollbar-width:thin; }
    #printPreviewModal .pp-scroll::-webkit-scrollbar{ width:8px; }
    #printPreviewModal .pp-scroll::-webkit-scrollbar-thumb{ background:#334155;border-radius:4px; }

    /* A4 SHEET LAYOUT */
    #printPreviewModal .pp-sheet{ background:#fff; width:210mm; min-height:297mm; margin:0 auto 1rem; box-shadow:0 4px 18px -4px rgba(0,0,0,0.35); border:1px solid #cbd5e1; border-radius:6px; display:flex; flex-direction:column; position:relative; overflow:hidden; }
    #printPreviewModal .pp-header{ display:flex; justify-content:space-between; align-items:flex-start; padding:12mm 14mm 6mm; background:linear-gradient(90deg,#1e293b 0%,#0f172a 100%); color:#f1f5f9; }
    #printPreviewModal .pp-company{ font-size:14px; font-weight:700; letter-spacing:.5px; }
    #printPreviewModal .pp-report-title{ font-size:11px; font-weight:600; margin-top:2px; }
    #printPreviewModal .pp-meta-line{ font-size:9px; opacity:.75; margin-top:2px; }
    #printPreviewModal .pp-header-right{ text-align:right; font-size:9px; }
    #printPreviewModal .pp-stamp-label{ font-weight:600; letter-spacing:.5px; text-transform:uppercase; font-size:8px; opacity:.8; }
    #printPreviewModal .pp-stamp-value{ font-weight:600; margin-top:2px; }
    #printPreviewModal .pp-body{ flex:1; padding:4mm 12mm 10mm; display:flex; flex-direction:column; gap:10mm; font-family:inherit; }
    #printPreviewModal .pp-section-title{ margin:0 0 4mm; font-size:10px; letter-spacing:.5px; font-weight:700; color:#0f172a; text-transform:uppercase; border-bottom:1px solid #e2e8f0; padding-bottom:2mm; }
    #printPreviewModal .pp-config{ font-size:9px; display:grid; gap:2mm 6mm; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); }
    #printPreviewModal .pp-field-value{ display:inline-block; font-size:9px; padding:2px 4px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:3px; color:#0f172a; min-width:40px; }
    #printPreviewModal .pp-sets-container{ display:flex; flex-direction:column; gap:8mm; }
    #printPreviewModal .analysis-print-block, #printPreviewModal .analysis-set{ border:1px solid #e2e8f0; border-radius:4px; padding:4mm 4mm 6mm; page-break-inside:avoid; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    #printPreviewModal .analysis-print-block h4, #printPreviewModal .analysis-set h4{ margin:0 0 3mm; font-size:10px; font-weight:600; color:#0f172a; }
    #printPreviewModal table{ width:100% !important; border-collapse:collapse; font-size:8.5px; } 
    #printPreviewModal table thead th{ background:#1e293b; color:#fff; padding:3px 4px; font-weight:600; border:1px solid #334155; } 
    #printPreviewModal table tbody td, #printPreviewModal table tfoot td{ padding:2px 4px; border:1px solid #cbd5e1; background:#fff; } 
    #printPreviewModal table tfoot td{ background:#f1f5f9; font-weight:600; }
    #printPreviewModal canvas{ max-width:100% !important; height:auto !important; display:block; margin:4mm auto 0; }
    #printPreviewModal .pp-footer{ margin-top:auto; background:#f8fafc; font-size:8px; color:#475569; display:flex; justify-content:space-between; align-items:center; padding:3mm 8mm; border-top:1px solid #e2e8f0; }
    #printPreviewModal .pp-footer-right{ font-weight:600; }
    #printPreviewModal .pp-footer-left{ font-weight:500; }
    #printPreviewModal .pp-page-num::after{ content: counter(ppage); }

    /* PRINT RULES */
    @media print {
        body * { visibility:hidden !important; }
        #printPreviewModal, #printPreviewModal * { visibility:visible !important; }
        #printPreviewModal { position:static !important; inset:auto !important; background:#fff !important; padding:0 !important; }
        #printPreviewModal .pp-toolbar { display:none !important; }
        #printPreviewModal .pp-scroll { background:#fff !important; padding:0 !important; }
        #printPreviewModal .pp-sheet { box-shadow:none !important; margin:0 auto !important; border: none !important; }
        .pp-footer { position:relative; }
    }
    @page { size:A4; margin:10mm 10mm 12mm; }
    `;
    modal.appendChild(style);

    // Optional: simple page counter (single sheet now). If future splitting needed we can extend.
    // Use a manual counter for dynamic multi-sheet scenarios (not implemented yet).

    // Replace cloned (blank) canvases with images captured from original canvases so charts appear.
    // Cloning via innerHTML drops the pixel buffer content of <canvas> elements.
    setTimeout(()=>{
        try {
            const originalCanvases = document.querySelectorAll('#modelPreviewContainer canvas');
            const clonedCanvases = modal.querySelectorAll('.pp-sets-container canvas');
            originalCanvases.forEach((srcCanvas, idx)=>{
                const target = clonedCanvases[idx];
                if(!srcCanvas || !target) return;
                try {
                    // Ensure the source chart is fully rendered
                    const dataUrl = srcCanvas.toDataURL('image/png');
                    if(!dataUrl || dataUrl === 'data:,') return;
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.alt = srcCanvas.getAttribute('data-chart-title') || 'Chart';
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                    img.style.margin = '4mm auto 0';
                    // Carry width/height hints
                    if(srcCanvas.width) img.width = srcCanvas.width;
                    if(srcCanvas.height) img.height = srcCanvas.height;
                    target.replaceWith(img);
                } catch(inner){ console.warn('Chart image conversion failed', inner); }
            });
        } catch(e){ console.warn('Canvas replication for print preview failed', e); }
    }, 30); // slight delay lets any late chart animations finish
}
function closePrintPreview(){ const m=document.getElementById('printPreviewModal'); if(m) m.remove(); }

// New function to generate PDF from the actual preview modal content
async function generatePdfFromPreviewModal(){
    try {
        const modal = document.getElementById('modelPreviewModal');
        const container = document.getElementById('modelPreviewContainer');
        if (!modal || !container) throw new Error('Preview modal not found');
        
        // Ensure modal is visible and content is rendered
        if (modal.style.display === 'none') throw new Error('Modal must be visible to capture content');
        
        // Get modal title and metadata
        const title = document.getElementById('modelPreviewTitle')?.textContent || 'Model Preview Report';
        const meta = document.getElementById('modelPreviewMeta')?.textContent || '';
        
        // Get date range from MP inputs
        const start = document.getElementById('mpReportDateStart')?.value || '';
        const end = document.getElementById('mpReportDateEnd')?.value || '';
        
        // Create PDF document
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // ---- Insert company logo (SVG) + Title ----
        // Helper to convert inline SVG to high-DPI PNG
        async function svgToPng(svgMarkup, targetWidth=120, scale=2){
            return new Promise((resolve, reject)=>{
                try {
                    const blob = new Blob([svgMarkup], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const img = new Image();
                    img.onload = ()=>{
                        try {
                            const w = img.width;
                            const h = img.height;
                            const aspect = h / w;
                            const canvas = document.createElement('canvas');
                            canvas.width = targetWidth * scale;
                            canvas.height = Math.round(targetWidth * aspect * scale);
                            const ctx = canvas.getContext('2d');
                            ctx.setTransform(scale,0,0,scale,0,0);
                            ctx.drawImage(img, 0, 0, targetWidth, targetWidth * aspect);
                            const dataUrl = canvas.toDataURL('image/png');
                            URL.revokeObjectURL(url);
                            resolve({ dataUrl, width: targetWidth, height: targetWidth * aspect });
                        } catch (e){ reject(e); }
                    };
                    img.onerror = reject;
                    img.src = url;
                } catch (e){ reject(e); }
            });
        }

        // NOTE: Replace the path '...PATH_DATA_HERE...' with the FULL actual path data from figure_silhouette.svg
        const svgLogoMarkup = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 231 372'>
  <path d="...PATH_DATA_HERE..." fill="#d0021b" />
</svg>`;

        let yPos = 18; // initial baseline
        try {
            if (!svgLogoMarkup.includes('...PATH_DATA_HERE...')) { // only attempt if user replaced placeholder
                const logo = await svgToPng(svgLogoMarkup, 42, 2); // 42 (approx mm converted to px context) logical width
                // jsPDF default unit is mm; we approximate scaling: treat 1 mm ~ (logo.width / 42) * chosen width
                const logoDisplayW = 22; // mm
                const logoDisplayH = logoDisplayW * (logo.height / logo.width);
                doc.addImage(logo.dataUrl, 'PNG', 20, 10, logoDisplayW, logoDisplayH);
            }
        } catch (logoErr){
            console.warn('Logo render failed (placeholder path or conversion issue):', logoErr);
        }

    // Title + Company Name to the right of logo
        // Derive company name dynamically from loaded company scope if available
        let companyName = 'Company';
        try {
            if (window.companyDataService && window.companyDataService.currentCompany) {
                companyName = window.companyDataService.currentCompany.name || window.companyDataService.currentCompany.legalName || companyName;
            } else if (window.companyDataService && window.companyDataService.getCurrentCompany) {
                const c = window.companyDataService.getCurrentCompany();
                if (c && (c.name || c.legalName)) companyName = c.name || c.legalName;
            }
        } catch(_){ }
    // Left-align company name and title at left margin
    const leftMargin = 20;
    doc.setFontSize(15);
    doc.setFont('helvetica', 'bold');
    doc.text(companyName, leftMargin, 18);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(title, leftMargin, 25);
    yPos = 34; // space after header block
        
        // Metadata (date range only, skip set count)
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        if (start || end) {
            doc.text(`Date Range: ${start || '...'} to ${end || '...'}`, 20, yPos);
            yPos += 10;
        }
        
        yPos += 5; // slight spacing before content
        
        // Find all analysis set blocks in the container
        const analysisBlocks = container.children;
        
        if (analysisBlocks.length === 0) {
            doc.setFontSize(12);
            doc.text('No analysis sets found in preview modal.', 20, yPos);
            yPos += 10;
        }
        
        // We will attempt to fit ALL sets' first table + first chart onto a single A4 page.
        // Strategy:
        // 1. Collect first valid table & chart per block (but cap total blocks processed)
        // 2. Limit table rows per block to keep it compact
        // 3. Use smaller fonts & reduced padding
        // 4. Scale down content at end if it exceeds page height
        const MAX_BLOCKS = 3; // cap number of sets included
        const MAX_ROWS_PER_TABLE = 8; // limit data rows per set
        const BLOCK_SPACING = 4; // vertical spacing between blocks
        let processedBlocks = 0;
        for (let i = 0; i < analysisBlocks.length && processedBlocks < MAX_BLOCKS; i++) {
            const block = analysisBlocks[i];
            processedBlocks++;
            if (yPos > 260) break; // stop if near bottom of page (A4 height ~297mm with margins)
            // Optional small label (commented out to save space)
            // doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.text(`Set ${processedBlocks}`, 20, yPos); yPos += 4;
            
            // Capture table content from rendered DOM
            const tableContainers = block.querySelectorAll('table, .data-table');
            
            let hasTable = false;
            for (const table of tableContainers) {
                try {
                    // Skip if table is not visible or has no content
                    if (!table.offsetParent || table.rows.length === 0) continue;
                    
                    const headers = [];
                    const rows = [];
                    
                    // Extract headers
                    const firstRow = table.rows[0];
                    if (firstRow) {
                        const cells = firstRow.cells;
                        for (let j = 0; j < cells.length && j < 8; j++) { // Limit to 8 columns
                            const cellText = cells[j].textContent.trim();
                            headers.push(cellText || `Col ${j + 1}`);
                        }
                    }
                    
                    // Extract data rows (skip header row)
                    for (let rowIdx = 1; rowIdx < table.rows.length && rows.length < MAX_ROWS_PER_TABLE; rowIdx++) {
                        const tr = table.rows[rowIdx];
                        const rowData = [];
                        const cells = tr.cells;
                        
                        for (let cellIdx = 0; cellIdx < cells.length && cellIdx < 8; cellIdx++) {
                            let cellText = cells[cellIdx].textContent.trim();
                            // Clean up cell text
                            cellText = cellText.replace(/\s+/g, ' ');
                            // Truncate very long text
                            if (cellText.length > 50) {
                                cellText = cellText.substring(0, 47) + '...';
                            }
                            rowData.push(cellText);
                        }
                        
                        if (rowData.some(cell => cell && cell.length > 0)) {
                            rows.push(rowData);
                        }
                    }
                    
                    // Add table to PDF if we have valid data
                    if (headers.length > 0 && rows.length > 0) {
                        doc.autoTable({
                            head: [headers],
                            body: rows,
                            startY: yPos,
                            styles: { 
                                fontSize: 8,
                                cellPadding: 2,
                                overflow: 'linebreak',
                                halign: 'left'
                            },
                            headStyles: { 
                                fillColor: [51, 65, 85],
                                textColor: [255, 255, 255],
                                fontSize: 9,
                                fontStyle: 'bold'
                            },
                            margin: { left: 14, right: 14 },
                            tableWidth: 'auto',
                            showHead: 'everyPage',
                            theme: 'grid'
                        });
                        yPos = doc.lastAutoTable.finalY + 6;
                        hasTable = true;
                        break; // Only process the first valid table per block
                    }
                } catch (e) {
                    console.warn('Failed to extract table data:', e);
                }
            }
            
            if (!hasTable) {
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('(No table data available)', 20, yPos);
                yPos += 10;
                doc.setTextColor(0, 0, 0);
            }
            
            // Capture chart - look for canvas elements
            const canvases = block.querySelectorAll('canvas');
            let hasChart = false;
            
            for (const canvas of canvases) {
                try {
                    // Check if canvas has content and is visible
                    if (!canvas.offsetParent || canvas.width === 0 || canvas.height === 0) continue;

                    // Give chart some time to finalize animations / layout
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Re-render chart at high DPI if possible
                    let chartDataUrl;
                    let targetCanvas = canvas;
                    try {
                        const chartInstance = canvas.__chartjsInstance || canvas._chart || Chart?.instances?.find?.(c => c?.ctx?.canvas === canvas);
                        if (chartInstance) {
                            const origCfg = chartInstance.config;
                            const logicalW = canvas.width;
                            const logicalH = canvas.height;
                            const scale = 4; // increase scale for sharper text and better quality
                            const off = document.createElement('canvas');
                            off.width = logicalW * scale;
                            off.height = logicalH * scale;
                            const offCtx = off.getContext('2d');
                            // Create a clone config without animations for speed
                            const cloned = JSON.parse(JSON.stringify(origCfg));
                            cloned.options = cloned.options || {};
                            cloned.options.animation = false;
                            cloned.options.responsive = false;
                            cloned.options.maintainAspectRatio = false;
                            cloned.options.devicePixelRatio = scale; // for newer Chart.js versions
                            // Force readable font sizes scaling
                            if (!cloned.options.plugins) cloned.options.plugins = {};
                            cloned.options.plugins.legend = cloned.options.plugins.legend || {};
                            cloned.options.plugins.legend.labels = cloned.options.plugins.legend.labels || {};
                            cloned.options.plugins.legend.labels.font = { size: 14 * scale };
                            cloned.options.scales = cloned.options.scales || {};
                            Object.keys(cloned.options.scales).forEach(k=>{
                                const sc = cloned.options.scales[k];
                                sc.ticks = sc.ticks || {};
                                sc.ticks.font = { size: 12 * scale };
                                if (sc.title) {
                                    sc.title.font = { size: 14 * scale };
                                }
                            });

                            const offCtxWrapper = offCtx; // Chart.js expects a 2d context
                            const tmpChart = new Chart(offCtxWrapper, cloned);
                            tmpChart.update();
                            chartDataUrl = off.toDataURL('image/png');
                            tmpChart.destroy();
                            targetCanvas = off;
                        }
                    } catch (highDpiErr) {
                        console.warn('High-DPI redraw failed, falling back:', highDpiErr);
                        try {
                            // Fallback simple 3x scale draw for better quality
                            const scale = 3;
                            const off = document.createElement('canvas');
                            off.width = canvas.width * scale;
                            off.height = canvas.height * scale;
                            const offCtx = off.getContext('2d');
                            offCtx.scale(scale, scale);
                            offCtx.drawImage(canvas, 0, 0);
                            chartDataUrl = off.toDataURL('image/png');
                            targetCanvas = off;
                        } catch (fallbackErr){
                            console.warn('Secondary fallback failed:', fallbackErr);
                        }
                    }

                    if (!chartDataUrl) {
                        // Last resort direct capture
                        chartDataUrl = canvas.toDataURL('image/png');
                        targetCanvas = canvas;
                    }

                    if (chartDataUrl && chartDataUrl.length > 50) {
                        if (yPos > 250) break; // not enough space; skip chart
                        const displayWidth = 160; // wider for better visibility
                        const aspect = targetCanvas.height / targetCanvas.width;
                        let displayHeight = Math.round(displayWidth * aspect);
                        if (displayHeight > 90) displayHeight = 90;
                        doc.addImage(chartDataUrl, 'PNG', 20, yPos, displayWidth, displayHeight);
                        yPos += displayHeight + 4;
                        hasChart = true;
                        break; // Only first chart per block
                    }
                } catch (e) {
                    console.warn('Failed to capture chart:', e);
                }
            }
            yPos += BLOCK_SPACING;
            

        // If content exceeded a single page, scale it down (experimental approach):
        // We detect by checking number of pages (should be 1). If >1, we warn user (since we disabled adding pages, unlikely now).
        if (doc.getNumberOfPages() > 1) {
            console.warn('Content exceeded one page; consider reducing MAX_BLOCKS or MAX_ROWS_PER_TABLE further.');
        }
            if (!hasChart) {
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('(No chart visualization available)', 20, yPos);
                yPos += 10;
                doc.setTextColor(0, 0, 0);
            }
        }
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:\-T]/g, '');
        const filename = `${title.replace(/[^a-z0-9]+/gi, '_')}_${timestamp}.pdf`;
        
        // Get PDF blob
        const pdfBlob = doc.output('blob');
        
        // Save to Firebase if available
        let downloadURL = '';
        try {
            if (firebase && firebase.storage) {
                const storageRef = firebase.storage().ref();
                const path = `reports/fueldist/${filename}`;
                const fileRef = storageRef.child(path);
                await fileRef.put(pdfBlob);
                downloadURL = await fileRef.getDownloadURL();
            }
        } catch (e) {
            console.warn('Upload skipped or failed', e);
        }
        
        // Log to database
        try {
            if (firebase && firebase.database) {
                const meta = {
                    title,
                    type: 'preview_modal',
                    category: 'multi_set',
                    start,
                    end,
                    createdAt: Date.now(),
                    file: filename,
                    url: downloadURL || '',
                    source: 'model_preview',
                    sets: analysisBlocks.length
                };
                await firebase.database().ref('reports/fueldist').push(meta);
            }
        } catch (e) {
            console.warn('DB log skipped', e);
        }
        
        // Store for potential sending
        window.__lastFuelReportBlob = pdfBlob;
        window.__lastFuelReportFilename = filename;
        window.__lastFuelReportDownloadURL = downloadURL || '';
        
        // Auto-download the PDF
        try {
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Auto-download failed:', e);
        }
        
        // Try to refresh generated reports list
        try {
            loadGeneratedReports();
        } catch (e) {
            /* ignore */
        }
        
        return { blob: pdfBlob, filename, downloadURL };
        
    } catch (e) {
        console.error('generatePdfFromPreviewModal failed:', e);
        throw e;
    }
}
async function mpSendReport(){
    const status = document.getElementById('mpReportStatus');
    try {
        if(status){ status.textContent='Checking requirements...'; status.style.color='#475569'; }
        
        // Check recipients
        const recipients = collectMpRecipients();
        const extraRaw = document.getElementById('mpReportEmails')?.value || '';
        const extra = extraRaw.split(',').map(s=>s.trim()).filter(Boolean);
        
        if (!recipients.length && !extra.length){ 
            if(status){ status.textContent='Add at least one recipient.'; status.style.color='#b91c1c'; } 
            return; 
        }
        
        // Check EmailJS availability
        if (!window.emailjs) {
            if(status){ status.textContent='EmailJS library not loaded. Please refresh the page.'; status.style.color='#b91c1c'; }
            return;
        }
        
        if (!window.EMAILJS_PUBLIC_KEY) {
            if(status){ status.textContent='EmailJS not configured. Contact administrator.'; status.style.color='#b91c1c'; }
            return;
        }
        
        // Initialize EmailJS
        try {
            if (!window.__emailjsInitialized) {
                if (!emailjs.init) {
                    if(status){ status.textContent='EmailJS not properly loaded.'; status.style.color='#b91c1c'; }
                    return;
                }
                emailjs.init({ publicKey: window.EMAILJS_PUBLIC_KEY });
                window.__emailjsInitialized = true;
                console.log('EmailJS initialized in send function');
            }
        } catch (initError) {
            console.error('EmailJS init failed:', initError);
            if(status){ status.textContent='Failed to initialize email service.'; status.style.color='#b91c1c'; }
            return;
        }
        
        if(status){ status.textContent='Generating PDF from preview modal...'; status.style.color='#475569'; }
        
        // Generate PDF from preview modal first
        let pdfResult;
        try {
            pdfResult = await generatePdfFromPreviewModal();
        } catch (pdfError) {
            console.error('PDF generation failed:', pdfError);
            if(status){ status.textContent='Failed to generate PDF: ' + (pdfError.message || 'Unknown error'); status.style.color='#b91c1c'; }
            return;
        }
        
        // Get email details (simplified template)
        const subject = document.getElementById('mpReportEmailSubject')?.value || 'Fuel Distribution Report';
        const userMessageRaw = document.getElementById('mpReportEmailMessage')?.value?.trim() || '';
        const title = document.getElementById('modelPreviewTitle')?.textContent?.trim() || 'Fuel Distribution Report';
        const meta = document.getElementById('modelPreviewMeta')?.textContent?.trim() || '';
        const start = document.getElementById('mpReportDateStart')?.value || '';
        const end = document.getElementById('mpReportDateEnd')?.value || '';
        const dynCompany = (window.companyDataService && window.companyDataService.currentCompany && (window.companyDataService.currentCompany.name || window.companyDataService.currentCompany.legalName)) || 'Company';

        // Compose concise lines
        const lines = [];
        if(userMessageRaw) lines.push(userMessageRaw, '');
        lines.push(title);
        if(meta) lines.push(meta);
        if(start || end) lines.push(`Date Range: ${start || '...'} to ${end || '...'}`);
        lines.push(`Generated: ${new Date().toLocaleString()}`);
        lines.push('', 'The report is ready. Use the secure link below to view or download the PDF.', '');
        
        // Prepare recipients
        const allRecipients = [...recipients, ...extra];
        const recipientList = allRecipients.join(', ');
        
        if(status){ status.textContent='Uploading PDF to cloud storage...'; status.style.color='#475569'; }
        
        // Upload PDF to Firebase Storage instead of embedding in email
        let downloadURL;
        try {
            const user = firebase.auth().currentUser;
            if (!user) {
                throw new Error('User not authenticated');
            }
            
            // Create unique filename with timestamp
            const timestamp = Date.now();
            const sanitizedFilename = pdfResult.filename.replace(/[^a-zA-Z0-9.-]/g, '_');
            const storagePath = `reports/${user.uid}/${timestamp}_${sanitizedFilename}`;
            
            // Upload to Firebase Storage
            const storageRef = firebase.storage().ref(storagePath);
            const uploadTask = await storageRef.put(pdfResult.blob, {
                contentType: 'application/pdf',
                customMetadata: {
                    'uploadedBy': user.email || user.uid,
                    'uploadedAt': new Date().toISOString(),
                    'reportType': 'model_preview'
                }
            });
            
            // Get download URL
            downloadURL = await uploadTask.ref.getDownloadURL();
            console.log('PDF uploaded successfully:', downloadURL);
            
        } catch (uploadError) {
            console.error('Firebase upload failed:', uploadError);
            if(status){ status.textContent='Failed to upload PDF: ' + (uploadError.message || 'Unknown error'); status.style.color='#b91c1c'; }
            return;
        }
        
    // Final message with link (simplified)
    const messageWithLink = lines.join('\n') + `\nDownload: ${downloadURL}\n\n-- ${dynCompany} System`;
        
        // Prepare email parameters (without large attachment)
        const emailParams = {
            to_email: allRecipients[0], // Primary recipient
            cc_email: allRecipients.slice(1).join(','), // CC others
            subject: subject,
            message: messageWithLink,
            download_link: downloadURL,
            report_name: pdfResult.filename,
            from_name: ((window.companyDataService && window.companyDataService.currentCompany && (window.companyDataService.currentCompany.name || window.companyDataService.currentCompany.legalName)) ? window.companyDataService.currentCompany.name + ' System' : 'Company System'),
            reply_to: 'no-reply@dreamexdatalab.com'
        };
        
        if(status){ status.textContent=`Sending email to ${recipientList}...`; status.style.color='#475569'; }
        
        // Send email using EmailJS
        try {
            const result = await emailjs.send('service_p2e9swy', 'template_rvo75m5', emailParams);
            console.log('EmailJS send result:', result);
            if(status){ status.textContent=`Report sent successfully to ${recipientList}.`; status.style.color='#16a34a'; }
        } catch (emailError) {
            console.error('EmailJS send failed:', emailError);
            let errorMessage = 'Unknown email error';
            
            if (emailError && emailError.text) {
                errorMessage = emailError.text;
            } else if (emailError && emailError.message) {
                errorMessage = emailError.message;
            } else if (typeof emailError === 'string') {
                errorMessage = emailError;
            } else if (emailError && emailError.status) {
                errorMessage = `Email service error: ${emailError.status}`;
            }
            
            if(status){ status.textContent='Failed to send email: ' + errorMessage; status.style.color='#b91c1c'; }
        }
        
    } catch(e){ 
        console.error('mpSendReport failed:', e);
        let errorMessage = 'Unknown error';
        if (e && e.message) {
            errorMessage = e.message;
        } else if (typeof e === 'string') {
            errorMessage = e;
        }
        if(status){ status.textContent='Failed to send: ' + errorMessage; status.style.color='#b91c1c'; } 
    }
}
// ===== Model Edit Modal Helpers =====
function openModelEditModal(model){
    try {
        const modal = document.getElementById('modelEditModal'); if(!modal) return;
        const titleInput = document.getElementById('modelEditTitle');
        const catInput = document.getElementById('modelEditCategory');
        const startInput = document.getElementById('modelEditStart');
        const endInput = document.getElementById('modelEditEnd');
        if (titleInput) titleInput.value = model?.title || '';
        if (catInput) catInput.value = model?.category || '';
        if (startInput) startInput.value = model?.start || '';
        if (endInput) endInput.value = model?.end || '';
        modal.style.display='block';
        document.body.style.overflow='hidden';
    } catch(e){ console.warn('openModelEditModal failed', e); }
}
function closeModelEditModal(){
    const modal = document.getElementById('modelEditModal'); if(!modal) return;
    modal.style.display='none';
    document.body.style.overflow='auto';
}
</script>
</html>
