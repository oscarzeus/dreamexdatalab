<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>HSE System - Report Incident</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
	<style>
		:root{
			--primary-color:#2c3e50; --secondary-color:#3498db; --text-primary:#333; --border-color:#e0e0e0;
			--sidebar-width:250px; --green:#2ecc71; --red:#e74c3c; --orange:#e67e22; --blue:#3498db;
		}
		*{box-sizing:border-box;margin:0;padding:0}
		body{font-family:Inter,system-ui,Arial,sans-serif;background:#f8f9fa;color:var(--text-primary);font-size:14px}
		.app-container{display:flex;min-height:100vh}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;transition:transform .3s ease;z-index:1000}
		.sidebar.collapsed{transform:translateX(-100%)}
		.logo h2{font-size:1.05rem;text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1)}
		.menu{list-style:none;margin-top:1rem}
		.menu a{color:#fff;text-decoration:none;display:flex;align-items:center;gap:.5rem;font-size:.8rem;border-radius:6px;padding:.5rem .6rem}
		.menu a:hover,.menu a.active{background:var(--secondary-color)}
		/* Match project-list submenu behavior */
		.submenu{list-style:none;margin-left:.75rem;display:none;margin-top:.25rem}
		.menu-dropdown:hover .submenu{display:block}
		.submenu a{font-size:.75rem;padding:.45rem .65rem}
		/* Visibility rules to match project-list feature/role filtering */
		[data-feature]:not(.menu-visible){display:none !important}
		.menu-dropdown:not(.menu-visible){display:none !important}
		/* Hide ALL menu items by default during loading */
		.sidebar.menu-loading .menu-item,
		.sidebar.menu-loading .menu-dropdown,
		.sidebar.menu-loading li[data-feature],
		.sidebar.menu-loading [data-feature]{display:none !important}
		/* Allow menu-visible items to show even during loading */
		.sidebar.menu-loading .menu-visible,
		.sidebar.menu-loading li.menu-visible,
		.sidebar.menu-loading [data-feature].menu-visible{display:block !important}
		.menu-loading [data-feature]{display:none !important}
		.menu-loading .menu-dropdown{display:none !important}
		/* Ensure menu-visible items are always shown */
		.menu-visible{display:block !important}
		li.menu-visible,[data-feature].menu-visible{display:block !important}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.5rem;transition:margin-left .3s ease}
		.main-content.sidebar-collapsed{margin-left:0}
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);position:sticky;top:0;z-index:20}
		.sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;color:#666;padding:.45rem;border-radius:6px}
		#headerCompanyLogo{width:40px;height:40px;border-radius:6px;object-fit:contain;display:none}
		#headerCompanyLogo.visible{display:block}
		#headerCompanyName{font-weight:600;color:var(--primary-color);font-size:.85rem}
		.page-header{background:#fff;color:var(--primary-color);padding:1rem;margin:.75rem 0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.1);border:1px solid var(--border-color);position:sticky;top:60px;z-index:19}
		.page-header h1{margin:0;font-size:1.5rem;display:flex;align-items:center;gap:.75rem;color:var(--primary-color)}
		.btn-add-new{background:var(--primary-color);color:#fff;border:1px solid var(--primary-color);padding:.6rem 1rem;border-radius:6px;text-decoration:none;font-size:.875rem;display:inline-flex;align-items:center;gap:.5rem;font-weight:500;transition:all .2s ease}
		.btn-add-new:hover{background:#1a252f;border-color:#1a252f;transform:translateY(-1px);box-shadow:0 4px 8px rgba(44,62,80,.2)}
		.btn{display:inline-block;padding:.4rem .8rem;border-radius:6px;border:1px solid transparent;font-size:.8rem;cursor:pointer;text-decoration:none}
		.btn-primary{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
		.btn-secondary{background:#6c757d;color:#fff;border-color:#6c757d}
		.btn-outline{background:transparent;color:#fff;border-color:rgba(255,255,255,.6)}
		.form-section{background:#fff;border:1px solid var(--border-color);border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
		.form-section h3{margin-bottom:10px;color:var(--primary-color);font-size:16px;border-bottom:1px solid #eee;padding-bottom:8px}
		.form-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:10px}
		.form-group{flex:1 1 260px}
		label{display:block;margin-bottom:4px;font-weight:600;font-size:.85rem}
		.form-control{width:100%;padding:10px;border:1px solid #ced4da;border-radius:6px;font-size:.9rem}
		textarea.form-control{min-height:90px;resize:vertical}
		select.form-control{cursor:pointer}
		/* Search functionality for assigned to field */
		.search-container{position:relative}
		.search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ced4da;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none}
		.search-result{padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s}
		.search-result:hover{background:#f8f9fa}
		.search-result:last-child{border-bottom:none}
		.search-result .user-name{font-weight:600;color:#333}
		.search-result .user-title{font-size:.8rem;color:#666;margin-top:2px}
		/* Corrective Actions dynamic section */
		.corrective-actions-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
		.corrective-actions-header h4{margin:0;font-size:1rem;color:var(--primary-color)}
		.btn-add-action{background:var(--primary-color);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:6px;transition:background .2s}
		.btn-add-action:hover{background:#1a252f}
		.corrective-action-item{background:#f8f9fa;border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:12px;position:relative}
		.corrective-action-item .action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
		.corrective-action-item .action-number{font-weight:600;color:var(--primary-color);font-size:.9rem}
		.btn-remove-action{background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:4px}
		.btn-remove-action:hover{background:#c0392b}
		.corrective-action-item .form-row{margin-bottom:10px}
		.corrective-action-item .form-group{margin-bottom:0}
		.action-attachments{margin-top:10px}
		.action-attachments input[type="file"]{font-size:.85rem}
		.action-file-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
		.action-file-item{background:#fff;border:1px solid #ddd;padding:6px 10px;border-radius:4px;font-size:.8rem;display:flex;align-items:center;gap:6px}
		.action-file-item .remove-file{color:#e74c3c;cursor:pointer;font-size:.9rem}
		.no-actions-msg{color:#666;font-style:italic;text-align:center;padding:20px}
		/* Checkbox toggle fields */
		.checkbox-toggle{display:flex;align-items:center;gap:8px;margin-bottom:8px}
		.checkbox-toggle input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
		.checkbox-toggle label{font-weight:600;cursor:pointer;margin:0}
		.toggle-fields{display:none;padding:12px;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:6px;margin-top:8px}
		.toggle-fields.visible{display:block}
		.action-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
		.notifications{position:relative}
		/* Notifications (match project-list) */
		.notifications{position:relative;display:flex;align-items:center}
		.notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.2rem;padding:.5rem;display:flex;align-items:center;justify-content:center;color:#555}
		.notification-badge{position:absolute;top:-5px;right:-5px;background:#e74c3c;color:#fff;border-radius:50%;padding:.15rem .45rem;font-size:.7rem;display:none}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:320px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:1000;border:1px solid #e9ecef;max-height:400px;overflow:hidden}
		.notification-dropdown.show{display:block;animation:slideDown .2s ease-out}
		@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
		.notification-header{padding:12px 16px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%);display:flex;justify-content:space-between;align-items:center}
		.notification-header h3{margin:0;color:#333;font-size:14px;font-weight:600}
		.mark-all-read{background:none;border:none;color:#3498db;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px}
		.mark-all-read:hover{background:#e3f2fd;color:#1976d2}
		.notification-list{max-height:320px;overflow-y:auto;padding:0}
		.notification-list::-webkit-scrollbar{width:4px}
		.notification-list::-webkit-scrollbar-track{background:#f1f1f1}
		.notification-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:2px}
		.notification-item{padding:12px 16px;border-bottom:1px solid #f1f1f1;cursor:pointer;transition:background-color .2s ease;position:relative}
		.notification-item:hover{background:#f8f9fa}
		.notification-item.unread{background:#e8f4fd;border-left:3px solid #3498db}
		.notification-empty{padding:40px 20px;text-align:center;color:#999;display:none}
		.notification-empty i{font-size:32px;margin-bottom:12px;color:#ddd}
		.notification-empty-title{font-size:14px;font-weight:500;margin-bottom:4px;color:#666}
		.notification-empty-message{font-size:12px;color:#999}
		.user-profile{position:relative}
		.user-profile img{width:38px;height:38px;border-radius:50%;object-fit:cover}
		/* Match project-list avatar button styling */
		.profile-btn{background:none;border:none;border-radius:50%;overflow:hidden;width:38px;height:38px;cursor:pointer}
		.profile-btn img{width:100%;height:100%;object-fit:cover}
		/* User profile dropdown (match project-list) */
		.profile-dropdown{display:none;position:absolute;right:0;top:110%;background:#fff;border-radius:8px;min-width:200px;box-shadow:0 6px 18px rgba(0,0,0,0.12);overflow:hidden;border:1px solid #e9ecef;z-index:1000}
		.profile-dropdown.show{display:block}
		.profile-dropdown ul{list-style:none;margin:0;padding:0}
		.profile-dropdown li a{display:block;padding:.65rem .85rem;font-size:.72rem;text-decoration:none;color:#1e293b;font-weight:500}
		.profile-dropdown li a:hover{background:#f1f5f9}
		.file-list{list-style:none;margin:10px 0 0;padding:0}
		.file-item{display:flex;align-items:center;gap:10px;background:#f9f9f9;border:1px solid #eee;border-radius:6px;padding:8px 10px;margin-bottom:8px}
		.file-actions button{background:none;border:none;cursor:pointer}
		.file-actions .delete-file{color:#dc3545}
		.tag{display:inline-block;padding:.12rem .5rem;border-radius:999px;font-size:.75rem;color:#fff}
		.tag.low{background:#2ecc71}.tag.medium{background:#f39c12}.tag.high{background:#e74c3c}
		@media (max-width: 900px) { 
			.main-content { 
				margin-left: 0; 
			} 
			.sidebar { 
				transform: translateX(-100%); 
			} 
			.sidebar.open { 
				transform: translateX(0); 
			} 
		}
		@media(max-width:768px){.form-row{flex-direction:column}}
	</style>
</head>
<body>
<div class="app-container">
	<nav class="sidebar menu-loading" id="sidebar">
		<div class="logo"><h2>Dreamex Datalab</h2></div>
		<ul class="menu" id="roleBasedMenu">
			<li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
			<li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
			<!-- Risk Management (separate section) -->
			<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
				<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
			<ul class="submenu">
				<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
				<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
			</ul>
			</li>
			<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
				<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
				<ul class="submenu">
					<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
					<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
					<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
					<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
					<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
					<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
					<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
					<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
					<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
					<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
					<li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
					<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
					<li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
					<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
					<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
					<li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
					<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
					<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
					<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
					<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
					<li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
					<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
					<li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
				</ul>
			</li>
			<!-- Project Management as section button with submenu -->
			<li class="menu-dropdown" data-feature="project_management_section">
				<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
				<ul class="submenu">
					<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
					<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
					<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
					<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
				</ul>
			</li>
			<!-- Inventory Management as section button with submenu -->
			<li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
				<a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
				<ul class="submenu">
					<li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
					<li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
					<li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
					<li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
					<li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
					<li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
				</ul>
			</li>
			<!-- Workspaces: Catering -->
			<li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
				<a href="#"><i class="fas fa-utensils"></i> Workspaces â€” Catering</a>
				<ul class="submenu">
					<li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
					<li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
					<li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
					<li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
					<li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
				</ul>
			</li>
			<li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
			<li class="menu-item" data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
			<li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
					<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
					<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
					<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
					<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
					<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
					<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
					<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
					<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
					<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
	</nav>

	<main class="main-content" id="mainContent">
		<header class="top-nav">
			<div style="display:flex;align-items:center;gap:.7rem">
				<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
				<img id="headerCompanyLogo" alt="Company Logo"/>
				<span id="headerCompanyName"></span>
			</div>
			<div style="display:flex;align-items:center;gap:1rem;position:relative">
				<div class="notifications">
					<button id="notificationBtn" class="notification-btn">
						<i class="fas fa-bell"></i>
						<span class="notification-badge">0</span>
					</button>
					<div class="notification-dropdown">
						<div class="notification-header">
							<h3>Notifications</h3>
							<button class="mark-all-read" type="button">Mark all as read</button>
						</div>
						<div class="notification-list">
							<div class="notification-empty">
								<i class="fas fa-inbox"></i>
								<div class="notification-empty-title">No notifications</div>
								<div class="notification-empty-message">You're all caught up</div>
							</div>
						</div>
					</div>
				</div>
				<div class="user-profile"><button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar"/></button><div class="profile-dropdown"><ul></ul></div></div>
			</div>
		</header>

		<div class="page-header">
			<h1><i class="fas fa-exclamation-triangle"></i> Report Incident</h1>
			<a href="incidentboard.html" class="btn-add-new">
				<i class="fas fa-table-list"></i>
			</a>
		</div>

		<form id="incidentForm">
			<input type="hidden" id="incidentId"/>
			<div class="form-section">
				<h3>Basic Information</h3>
				<div class="form-row">
					<div class="form-group">
						<label for="referenceNumber">Reference</label>
						<input id="referenceNumber" class="form-control" placeholder="Auto-generated" readonly/>
					</div>
					<div class="form-group">
						<label for="incidentTitle">Title *</label>
						<input id="incidentTitle" class="form-control" required placeholder="Brief title"/>
					</div>
					<div class="form-group">
						<label for="severity">Severity *</label>
						<select id="severity" class="form-control" required>
							<option value="">Select Severity</option>
							<option value="low">Low</option>
							<option value="medium">Medium</option>
							<option value="high">High</option>
						</select>
					</div>
					<div class="form-group">
						<label for="eventType">Event Type</label>
						<select id="eventType" class="form-control">
							<option value="">Select Event Type</option>
							<option value="near-miss">Near Miss</option>
							<option value="observation">Observation</option>
							<option value="incident">Incident</option>
						</select>
					</div>
				</div>
				<div class="form-row">
					<div class="form-group">
						<label for="incidentDateTime">Date & Time *</label>
						<input type="datetime-local" id="incidentDateTime" class="form-control" required/>
					</div>
					<div class="form-group">
						<label for="incidentStatus">Status</label>
						<select id="incidentStatus" class="form-control">
							<option value="open">Open</option>
							<option value="in-progress">In Progress</option>
							<option value="closed">Closed</option>
							<option value="draft">Draft</option>
						</select>
					</div>
					<div class="form-group">
						<label for="eventLocation">Location *</label>
						<select id="eventLocation" class="form-control" required>
							<option value="">Select Location</option>
						</select>
					</div>
					<div class="form-group">
						<label for="department">Department *</label>
						<select id="department" class="form-control" required>
							<option value="">Select Department</option>
						</select>
					</div>
					<div class="form-group">
						<label for="assignedTo">Assigned To</label>
						<div class="search-container">
							<input type="text" id="userSearch" class="form-control" placeholder="Type to search employee..." autocomplete="off">
							<input type="hidden" id="assignedTo">
							<div id="searchResults" class="search-dropdown"></div>
						</div>
					</div>
					<div class="form-group">
						<label>Reported By</label>
						<input id="reportedByName" class="form-control" readonly/>
						<input type="hidden" id="reportedById"/>
					</div>
					<div class="form-group">
						<label>Date Reported</label>
						<input id="dateReported" class="form-control" readonly/>
					</div>
				</div>
			</div>

			<div class="form-section" id="eventSpecificSection">
				<h3>Event-specific Details</h3>
				
				<!-- Common fields for all event types -->
				<div id="commonFields">
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="description">Description *</label>
							<textarea id="description" class="form-control" required placeholder="Describe what happened"></textarea>
						</div>
					</div>
				</div>
				
				<!-- Incident-specific common fields (Category, Injury, Property Damage) -->
				<div id="incidentCommonFields" style="display:none">
					<div class="form-row">
						<div class="form-group">
							<label for="incidentCategory">Incident Category</label>
							<select id="incidentCategory" class="form-control">
								<option value="">Select Category</option>
							</select>
						</div>
					</div>
					
					<!-- Injury Checkbox Toggle -->
					<div class="form-group">
						<div class="checkbox-toggle">
							<input type="checkbox" id="hasInjury" onchange="toggleInjuryFields()">
							<label for="hasInjury">Injury Occurred</label>
						</div>
						<div id="injuryFields" class="toggle-fields">
							<div class="form-row">
								<div class="form-group">
									<label for="injuryType">Injury Type *</label>
									<select id="injuryType" class="form-control">
										<option value="">Select Injury Type</option>
									</select>
								</div>
								<div class="form-group">
									<label for="injuredPerson">Injured Person *</label>
									<input id="injuredPerson" class="form-control" placeholder="Name of injured person">
								</div>
								<div class="form-group">
									<label for="injuryBodyPart">Body Part Affected</label>
									<input id="injuryBodyPart" class="form-control" placeholder="e.g., Hand, Back, Head">
								</div>
							</div>
							<div class="form-row">
								<div class="form-group">
									<label for="injuryTreatment">Treatment Provided</label>
									<select id="injuryTreatment" class="form-control">
										<option value="">Select</option>
										<option value="first-aid">First Aid</option>
										<option value="medical-treatment">Medical Treatment</option>
										<option value="hospitalization">Hospitalization</option>
										<option value="none">None Required</option>
									</select>
								</div>
								<div class="form-group">
									<label for="injuryLostTime">Lost Time Injury</label>
									<select id="injuryLostTime" class="form-control" onchange="toggleLostTimeDays()">
										<option value="">Select</option>
										<option value="yes">Yes</option>
										<option value="no">No</option>
									</select>
								</div>
								<div class="form-group" id="daysLostGroup" style="display:none">
									<label for="injuryDaysLost">Days Lost *</label>
									<input type="number" min="0" id="injuryDaysLost" class="form-control" placeholder="0">
								</div>
							</div>
						</div>
					</div>
					
					<!-- Property Damage Checkbox Toggle -->
					<div class="form-group">
						<div class="checkbox-toggle">
							<input type="checkbox" id="hasPropertyDamage" onchange="togglePropertyDamageFields()">
							<label for="hasPropertyDamage">Property Damage Occurred</label>
						</div>
						<div id="propertyDamageFields" class="toggle-fields">
							<div class="form-row">
								<div class="form-group">
									<label for="propertyDamage">Damage Type *</label>
									<select id="propertyDamage" class="form-control">
										<option value="">Select Property Damage</option>
									</select>
								</div>
								<div class="form-group">
									<label for="damagedAsset">Damaged Asset/Equipment *</label>
									<input id="damagedAsset" class="form-control" placeholder="Describe the damaged asset">
								</div>
								<div class="form-group">
									<label for="estimatedCost">Estimated Cost</label>
									<input type="number" min="0" step="0.01" id="estimatedCost" class="form-control" placeholder="0.00">
								</div>
							</div>
							<div class="form-row">
								<div class="form-group" style="flex:1 1 100%">
									<label for="damageDescription">Damage Description</label>
									<textarea id="damageDescription" class="form-control" placeholder="Describe the extent of damage"></textarea>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Actions fields (shown for incidents and near-misses) -->
				<div id="actionsFields" style="display:none">
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="immediateActions">Immediate Actions</label>
							<textarea id="immediateActions" class="form-control" placeholder="Actions taken immediately"></textarea>
						</div>
					</div>
					
					<!-- Corrective Actions Dynamic Section -->
					<div class="corrective-actions-section">
						<div class="corrective-actions-header">
							<h4><i class="fas fa-tasks"></i> Corrective Actions</h4>
							<button type="button" class="btn-add-action" onclick="addCorrectiveAction()">
								<i class="fas fa-plus"></i> Add Action
							</button>
						</div>
					<div id="correctiveActionsList">
						<div class="no-actions-msg">No corrective actions added. Click "Add Action" to create one.</div>
					</div>
				</div>
				
				<div id="dueDateField" class="form-row">
					<div class="form-group">
						<label for="dueDate">Due Date</label>
						<input type="date" id="dueDate" class="form-control"/>
					</div>
				</div>
			</div>				<!-- Near Miss Fields -->
				<div id="nearMissFields" style="display:none">
					<!-- Near miss fields removed as requested -->
				</div>

				<!-- Observation Fields -->
				<div id="observationFields" style="display:none">
					<div class="form-row">
						<div class="form-group">
							<label for="obsType">Observation Type *</label>
							<select id="obsType" class="form-control">
								<option value="">Select</option>
								<option value="safe">Safe</option>
								<option value="at-risk">At-Risk</option>
							</select>
						</div>
						<div class="form-group">
							<label for="obsCategory">Category *</label>
							<select id="obsCategory" class="form-control">
								<option value="">Select</option>
								<option value="behavior">Behavior</option>
								<option value="condition">Condition</option>
							</select>
						</div>
					</div>
					
					<!-- Person Involved Checkbox Toggle -->
					<div class="form-group">
						<div class="checkbox-toggle">
							<input type="checkbox" id="obsHasPersonInvolved" onchange="toggleObsPersonInvolved()">
							<label for="obsHasPersonInvolved">Person Involved</label>
						</div>
						<div id="obsPersonInvolvedFields" class="toggle-fields">
							<div id="obsPersonsList">
								<div class="no-actions-msg">No persons added. Click "Add Person" to add one.</div>
							</div>
							<button type="button" class="btn-add-action" onclick="addObsPerson()" style="margin-top:10px">
								<i class="fas fa-plus"></i> Add Person
							</button>
						</div>
					</div>
					
					<!-- Equipment Involved Checkbox Toggle -->
					<div class="form-group"> 
						<div class="checkbox-toggle">
							<input type="checkbox" id="obsHasEquipmentInvolved" onchange="toggleObsEquipmentInvolved()">
							<label for="obsHasEquipmentInvolved">Equipment Involved</label>
						</div>
						<div id="obsEquipmentInvolvedFields" class="toggle-fields">
							<div id="obsEquipmentList">
								<div class="no-actions-msg">No equipment added. Click "Add Equipment" to add one.</div>
							</div>
							<button type="button" class="btn-add-action" onclick="addObsEquipment()" style="margin-top:10px">
								<i class="fas fa-plus"></i> Add Equipment
							</button>
						</div>
					</div>
					
					<!-- Observation Corrective Actions -->
					<div class="form-group">
						<label style="font-weight:600; margin-bottom:10px; display:block;">Corrective Actions</label>
						<div id="obsCorrectiveActionsList">
							<div class="no-actions-msg">No corrective actions added. Click "Add Corrective Action" to add one.</div>
						</div>
						<button type="button" class="btn-add-action" onclick="addObsCorrectiveAction()" style="margin-top:10px">
							<i class="fas fa-plus"></i> Add Corrective Action
						</button>
					</div>
				</div>

				<!-- Incident-only extra fields -->
				<div id="incidentFields" style="display:none">
					<div class="form-row">
						<div class="form-group">
							<label for="incInjuredPerson">Injured Person</label>
							<input id="incInjuredPerson" class="form-control" placeholder="Name of injured person (if any)" />
						</div>
						<div class="form-group">
							<label for="incLostTime">Lost Time</label>
							<select id="incLostTime" class="form-control">
								<option value="">Select</option>
								<option value="yes">Yes</option>
								<option value="no">No</option>
							</select>
						</div>
						<div class="form-group">
							<label for="incDaysLost">Days Lost</label>
							<input type="number" min="0" id="incDaysLost" class="form-control" placeholder="0" />
						</div>
					</div>
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="incRootCause">Root Cause *</label>
							<textarea id="incRootCause" class="form-control" placeholder="Root cause analysis"></textarea>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="incContributingFactors">Contributing Factors</label>
							<textarea id="incContributingFactors" class="form-control" placeholder="List factors contributing to the incident"></textarea>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="incEquipment">Equipment Involved</label>
							<input id="incEquipment" class="form-control" placeholder="Equipment or asset" />
						</div>
						<div class="form-group">
							<label for="incWitnesses">Witnesses</label>
							<input id="incWitnesses" class="form-control" placeholder="Names of witnesses" />
						</div>
					</div>
				</div>
			</div>

			<div class="form-section">
				<h3>Attachments</h3>
				<div>
					<label class="btn btn-secondary" style="display:inline-flex;align-items:center;gap:.4rem">
						<i class="fas fa-upload"></i> Choose Files
						<input type="file" id="fileUpload" multiple style="display:none"/>
					</label>
					<small style="margin-left:8px;color:#666">Max 5MB each</small>
				</div>
				<ul id="fileList" class="file-list"></ul>
			</div>

			<div class="action-buttons">
				<button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
				<button type="button" id="saveDraftBtn" class="btn btn-secondary">Save Draft</button>
				<button type="submit" id="submitBtn" class="btn btn-primary">Submit Incident</button>
			</div>
		</form>
	</main>
</div>

<!-- Firebase v8 Scripts for Centralized Authentication (match project-list) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script>
// Firebase configuration (match project-list centralized auth)
const firebaseConfig = {
	apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
	authDomain: "users-8be65.firebaseapp.com",
	databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
	projectId: "users-8be65",
	storageBucket: "users-8be65.firebasestorage.app",
	messagingSenderId: "909025468149",
	appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
	measurementId: "G-XHFMRCJQEZ"
};
function initializeFirebase(){
	if(!window.firebase || !window.firebase.apps || window.firebase.apps.length===0){
		window.firebase.initializeApp(firebaseConfig);
	}
	return window.firebase;
}
const firebase = initializeFirebase();
const db = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// Centralized AuthManager (copied to match project-list)
class AuthManager{
	constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; this.init(); }
	getCurrentUser(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch{ return null; } }
	setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
	async init(){ if(!this.currentUser){ window.location.href='login.html'; return; } await this.loadUserCompany(); this.updateCompanyBranding(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); }
	async loadUserCompany(){ if(!this.currentUser) return; try{ const snap=await firebase.database().ref('companies').once('value'); if(!snap.exists()) return; const companies=snap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users){ for(const [uid,u] of Object.entries(comp.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId=cid; this.currentUser.companyName=comp.companyName; this.currentUser.role=u.role||u.userRole||'user'; this.currentCompany=comp; this.setCurrentUser(this.currentUser); return; } } } } }catch(e){} }
	updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ this.showFallbackBranding(); return; } if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
	showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); } }
	getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
	generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
	getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
	getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
	async getUserAvatarUrl(){ if(!this.currentUser) return null; const companyId=this.currentUser.companyId||'default'; const paths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`]; for(const p of paths){ try{ const ref=firebase.storage().ref(p); const url=await ref.getDownloadURL(); return url; }catch(err){ continue; } } return null; }
	async updateUIForAuthenticatedUser(){ const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.currentUser.email||''; let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); }catch(e){} const btnImg=btn.querySelector('img'); if(avatarUrl&&btnImg){ btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }; } else { btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }
		const avatarHtml= avatarUrl? `<img src=\"${avatarUrl}\" alt=\"${displayName} Avatar\" style=\"width:32px;height:32px;border-radius:50%;object-fit:cover;\">` : `<div style=\"width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;\">${this.getUserInitials()}</div>`; list.innerHTML=`<li style=\"border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;\"><div style=\"display:flex;align-items:center;gap:12px;\">${avatarHtml}<div><div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${displayName}</div><div style=\"color:#666;font-size:12px;\">${email}</div></div></div></li><li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`; list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); }); }
	bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click', e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click', e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
	async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; }catch(error){ console.error('Logout error:',error); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } }
}

function bindSidebarToggle(){
	const btn=document.getElementById('sidebarToggle'), sidebar=document.getElementById('sidebar'), main=document.getElementById('mainContent');
	if(!btn||!sidebar||!main)return;
	btn.addEventListener('click',()=>{ 
		const isMobile = window.innerWidth <= 900;
		if (isMobile) {
			sidebar.classList.toggle('open');
		} else {
			sidebar.classList.toggle('collapsed');
			main.classList.toggle('sidebar-collapsed');
		}
	});
}
function svgInitials(name='U'){ const initials=(name.trim().split(/\s+/).slice(0,2).map(p=>p[0]).join('')||'U').toUpperCase(); const svg=`<svg width="38" height="38" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="#3498db"/><text x="20" y="25" text-anchor="middle" fill="#fff" font-size="14" font-weight="600" font-family="Inter, Arial, sans-serif">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
function setBranding(company){ const logo=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=company?.companyName||''; if(logo){ if(company?.logo||company?.logoUrl){ logo.src=company.logo||company.logoUrl; logo.classList.add('visible'); } else { logo.src=svgInitials(company?.companyName||'DX'); logo.classList.add('visible'); } } if(company?.branding){ const root=document.documentElement; if(company.branding.primaryColor) root.style.setProperty('--primary-color',company.branding.primaryColor); if(company.branding.secondaryColor) root.style.setProperty('--secondary-color',company.branding.secondaryColor); } }
// Avatar helpers copied to match project-list behavior
function getUserDisplayName(u){ if(!u) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[u.displayName,u.name,u.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(u.email){ return n(u.email.split('@')[0])||'User'; } return 'User'; }
function getUserInitials(u){ const dn=getUserDisplayName(u); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
async function getUserAvatarUrl(u){ if(!u) return null; const companyId = (await getCompanyIdFor(u.uid)) || 'default'; const possible=[`companies/${companyId}/avatars/${u.uid}/profile.jpg`,`companies/${companyId}/avatars/${u.uid}/profile.png`,`companies/${companyId}/avatars/${u.uid}/profile.jpeg`,`companies/${companyId}/avatars/${u.uid}/avatar.jpg`,`companies/${companyId}/avatars/${u.uid}/avatar.png`,`avatars/${u.uid}/profile.jpg`,`avatars/${u.uid}/profile.png`,`avatars/${u.uid}/avatar.jpg`,`avatars/${u.uid}/avatar.png`,`profiles/${u.uid}/profile.jpg`,`profiles/${u.uid}/profile.png`]; for(const path of possible){ try{ const ref=storage.ref(path); const url=await ref.getDownloadURL(); return url; }catch(e){ /* try next */ } } return null; }
async function getCompanyIdFor(uid){ const snap=await db.ref('users/'+uid).once('value'); const u=snap.val()||{}; return u.companyId||u.companyID||u.company||u.company_id||null; }
async function getCompany(companyId){ if(!companyId) return null; const snap=await db.ref('companies/'+companyId).once('value'); const c=snap.val()||null; if(c) c.companyId=companyId; return c; }
function formatBytes(b){ if(!b) return '0B'; const u=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(2)+' '+u[i]; }

// Ensure filenames are safe for Firebase Storage paths
function sanitizeFileName(name){
	if(!name) return 'file';
	// Remove path components and replace invalid characters # [ ] * ? \ ^ $ { } | < > % ` with '-'
	const base=name.split('/').pop().split('\\').pop();
	const cleaned=base.replace(/[\n\r\t]/g,' ').replace(/[#\[\]*?\\^${}|<>%`]/g,'-');
	// Collapse spaces and trim
	const collapsed=cleaned.replace(/\s+/g,' ').trim();
	// Limit filename length to 80 chars to avoid overly long paths
	return collapsed.slice(0,80) || 'file';
}

// Convert File to data URL for storing in Realtime Database
function fileToDataUrl(file){
	return new Promise((resolve, reject)=>{
		const reader=new FileReader();
		reader.onload=()=>resolve(reader.result);
		reader.onerror=reject;
		reader.readAsDataURL(file);
	});
}

// Helpers for datetime-local input
function toLocalDateTimeInputValue(d){ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function getDateTimeParts(){
	const el=document.getElementById('incidentDateTime');
	const v=el?.value||'';
	if(v){ const [date, timeFull]=v.split('T'); const time=(timeFull||'').slice(0,5); return { date, time, iso:v }; }
	const now=new Date();
	const iso=toLocalDateTimeInputValue(now);
	return { date: iso.slice(0,10), time: iso.slice(11,16), iso };
}

// Remove undefined properties to avoid Firebase update errors
function sanitizeAttachmentFields(obj){
	const allowed=['name','size','contentType','dataUrl','url','path','uploadedAt'];
	const out={};
	for(const k of allowed){ if(obj && obj[k] !== undefined) out[k]=obj[k]; }
	return out;
}

// Utility: compact object by removing undefined, null, and empty-string values
function compactObject(obj){
	if(!obj || typeof obj!== 'object') return obj;
	const out={};
	for(const [k,v] of Object.entries(obj)){
		if(v===undefined || v===null) continue;
		if(typeof v==='string' && v.trim()==='') continue;
		out[k]=v;
	}
	return out;
}

function setRequired(id, required){ const el=document.getElementById(id); if(!el) return; if(required){ el.setAttribute('required','required'); } else { el.removeAttribute('required'); } }
function show(el, on){ if(!el) return; el.style.display=on? 'block':'none'; }

// Injury and Property Damage Toggle Functions
function toggleInjuryFields() {
	const checkbox = document.getElementById('hasInjury');
	const fieldsDiv = document.getElementById('injuryFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
		setRequired('injuryType', true);
		setRequired('injuredPerson', true);
	} else {
		fieldsDiv.classList.remove('visible');
		setRequired('injuryType', false);
		setRequired('injuredPerson', false);
		setRequired('injuryDaysLost', false);
		// Clear fields when unchecked
		document.getElementById('injuryType').value = '';
		document.getElementById('injuredPerson').value = '';
		document.getElementById('injuryBodyPart').value = '';
		document.getElementById('injuryTreatment').value = '';
		document.getElementById('injuryLostTime').value = '';
		document.getElementById('injuryDaysLost').value = '';
		document.getElementById('daysLostGroup').style.display = 'none';
	}
}

function toggleLostTimeDays() {
	const lostTimeSelect = document.getElementById('injuryLostTime');
	const daysLostGroup = document.getElementById('daysLostGroup');
	
	if (lostTimeSelect.value === 'yes') {
		daysLostGroup.style.display = 'block';
		setRequired('injuryDaysLost', true);
	} else {
		daysLostGroup.style.display = 'none';
		setRequired('injuryDaysLost', false);
		document.getElementById('injuryDaysLost').value = '';
	}
}

function togglePropertyDamageFields() {
	const checkbox = document.getElementById('hasPropertyDamage');
	const fieldsDiv = document.getElementById('propertyDamageFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
		setRequired('propertyDamage', true);
		setRequired('damagedAsset', true);
	} else {
		fieldsDiv.classList.remove('visible');
		setRequired('propertyDamage', false);
		setRequired('damagedAsset', false);
		// Clear fields when unchecked
		document.getElementById('propertyDamage').value = '';
		document.getElementById('damagedAsset').value = '';
		document.getElementById('estimatedCost').value = '';
		document.getElementById('damageDescription').value = '';
	}
}

function getInjuryData() {
	if (!document.getElementById('hasInjury').checked) return null;
	return compactObject({
		hasInjury: true,
		injuryType: document.getElementById('injuryType')?.value || '',
		injuredPerson: document.getElementById('injuredPerson')?.value || '',
		bodyPart: document.getElementById('injuryBodyPart')?.value || '',
		treatment: document.getElementById('injuryTreatment')?.value || '',
		lostTime: document.getElementById('injuryLostTime')?.value || '',
		daysLost: document.getElementById('injuryDaysLost')?.value || ''
	});
}

function getPropertyDamageData() {
	if (!document.getElementById('hasPropertyDamage').checked) return null;
	return compactObject({
		hasPropertyDamage: true,
		damageType: document.getElementById('propertyDamage')?.value || '',
		damagedAsset: document.getElementById('damagedAsset')?.value || '',
		estimatedCost: document.getElementById('estimatedCost')?.value || '',
		description: document.getElementById('damageDescription')?.value || ''
	});
}

function loadInjuryData(data) {
	if (!data || !data.hasInjury) return;
	
	document.getElementById('hasInjury').checked = true;
	document.getElementById('injuryFields').classList.add('visible');
	document.getElementById('injuryType').value = data.injuryType || '';
	document.getElementById('injuredPerson').value = data.injuredPerson || '';
	document.getElementById('injuryBodyPart').value = data.bodyPart || '';
	document.getElementById('injuryTreatment').value = data.treatment || '';
	document.getElementById('injuryLostTime').value = data.lostTime || '';
	
	if (data.lostTime === 'yes') {
		document.getElementById('daysLostGroup').style.display = 'block';
		document.getElementById('injuryDaysLost').value = data.daysLost || '';
	}
	
	setRequired('injuryType', true);
	setRequired('injuredPerson', true);
	if (data.lostTime === 'yes') setRequired('injuryDaysLost', true);
}

function loadPropertyDamageData(data) {
	if (!data || !data.hasPropertyDamage) return;
	
	document.getElementById('hasPropertyDamage').checked = true;
	document.getElementById('propertyDamageFields').classList.add('visible');
	document.getElementById('propertyDamage').value = data.damageType || '';
	document.getElementById('damagedAsset').value = data.damagedAsset || '';
	document.getElementById('estimatedCost').value = data.estimatedCost || '';
	document.getElementById('damageDescription').value = data.description || '';
	
	setRequired('propertyDamage', true);
	setRequired('damagedAsset', true);
}

// ===============================
// Observation Person/Equipment Management
// ===============================

let obsPersonsCounter = 0;
let obsEquipmentCounter = 0;

function toggleObsPersonInvolved() {
	const checkbox = document.getElementById('obsHasPersonInvolved');
	const fieldsDiv = document.getElementById('obsPersonInvolvedFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
	} else {
		fieldsDiv.classList.remove('visible');
		// Clear persons list
		document.getElementById('obsPersonsList').innerHTML = '<div class="no-actions-msg">No persons added. Click "Add Person" to add one.</div>';
		obsPersonsCounter = 0;
	}
}

function toggleObsEquipmentInvolved() {
	const checkbox = document.getElementById('obsHasEquipmentInvolved');
	const fieldsDiv = document.getElementById('obsEquipmentInvolvedFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
	} else {
		fieldsDiv.classList.remove('visible');
		// Clear equipment list
		document.getElementById('obsEquipmentList').innerHTML = '<div class="no-actions-msg">No equipment added. Click "Add Equipment" to add one.</div>';
		obsEquipmentCounter = 0;
	}
}

function addObsPerson(data = null) {
	obsPersonsCounter++;
	const personId = obsPersonsCounter;
	
	const container = document.getElementById('obsPersonsList');
	const noMsg = container.querySelector('.no-actions-msg');
	if (noMsg) noMsg.remove();
	
	const personDiv = document.createElement('div');
	personDiv.className = 'corrective-action-item';
	personDiv.id = `obsPerson_${personId}`;
	personDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">Person #${personId}</span>
			<button type="button" class="btn-remove-action" onclick="removeObsPerson(${personId})">
				<i class="fas fa-trash"></i> Remove
			</button>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>Person Name *</label>
				<input type="text" class="form-control obs-person-name" placeholder="Name of person involved" value="${data?.name || ''}" required>
			</div>
			<div class="form-group">
				<label>Role/Position</label>
				<input type="text" class="form-control obs-person-role" placeholder="Their role or position" value="${data?.role || ''}">
			</div>
			<div class="form-group">
				<label>Involvement Type</label>
				<select class="form-control obs-person-involvement">
					<option value="">Select</option>
					<option value="directly-involved" ${data?.involvement === 'directly-involved' ? 'selected' : ''}>Directly Involved</option>
					<option value="witness" ${data?.involvement === 'witness' ? 'selected' : ''}>Witness</option>
					<option value="supervisor" ${data?.involvement === 'supervisor' ? 'selected' : ''}>Supervisor</option>
					<option value="other" ${data?.involvement === 'other' ? 'selected' : ''}>Other</option>
				</select>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex: 1 1 100%">
				<label>Notes</label>
				<textarea class="form-control obs-person-notes" placeholder="Additional details about this person's involvement">${data?.notes || ''}</textarea>
			</div>
		</div>
	`;
	container.appendChild(personDiv);
}

function removeObsPerson(personId) {
	const personDiv = document.getElementById(`obsPerson_${personId}`);
	if (personDiv) {
		personDiv.remove();
		// Check if list is empty
		const container = document.getElementById('obsPersonsList');
		if (container.querySelectorAll('.corrective-action-item').length === 0) {
			container.innerHTML = '<div class="no-actions-msg">No persons added. Click "Add Person" to add one.</div>';
		}
	}
}

function addObsEquipment(data = null) {
	obsEquipmentCounter++;
	const equipId = obsEquipmentCounter;
	
	const container = document.getElementById('obsEquipmentList');
	const noMsg = container.querySelector('.no-actions-msg');
	if (noMsg) noMsg.remove();
	
	const equipDiv = document.createElement('div');
	equipDiv.className = 'corrective-action-item';
	equipDiv.id = `obsEquipment_${equipId}`;
	equipDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">Equipment #${equipId}</span>
			<button type="button" class="btn-remove-action" onclick="removeObsEquipment(${equipId})">
				<i class="fas fa-trash"></i> Remove
			</button>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>Equipment Name/ID *</label>
				<input type="text" class="form-control obs-equip-name" placeholder="Equipment name or ID" value="${data?.name || ''}" required>
			</div>
			<div class="form-group">
				<label>Equipment Type</label>
				<select class="form-control obs-equip-type">
					<option value="">Select</option>
					<option value="vehicle" ${data?.type === 'vehicle' ? 'selected' : ''}>Vehicle</option>
					<option value="machinery" ${data?.type === 'machinery' ? 'selected' : ''}>Machinery</option>
					<option value="tool" ${data?.type === 'tool' ? 'selected' : ''}>Hand Tool</option>
					<option value="power-tool" ${data?.type === 'power-tool' ? 'selected' : ''}>Power Tool</option>
					<option value="ppe" ${data?.type === 'ppe' ? 'selected' : ''}>PPE</option>
					<option value="electrical" ${data?.type === 'electrical' ? 'selected' : ''}>Electrical</option>
					<option value="lifting" ${data?.type === 'lifting' ? 'selected' : ''}>Lifting Equipment</option>
					<option value="other" ${data?.type === 'other' ? 'selected' : ''}>Other</option>
				</select>
			</div>
			<div class="form-group">
				<label>Condition</label>
				<select class="form-control obs-equip-condition">
					<option value="">Select</option>
					<option value="good" ${data?.condition === 'good' ? 'selected' : ''}>Good</option>
					<option value="needs-repair" ${data?.condition === 'needs-repair' ? 'selected' : ''}>Needs Repair</option>
					<option value="damaged" ${data?.condition === 'damaged' ? 'selected' : ''}>Damaged</option>
					<option value="unsafe" ${data?.condition === 'unsafe' ? 'selected' : ''}>Unsafe</option>
				</select>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex: 1 1 100%">
				<label>Notes</label>
				<textarea class="form-control obs-equip-notes" placeholder="Additional details about this equipment">${data?.notes || ''}</textarea>
			</div>
		</div>
	`;
	container.appendChild(equipDiv);
}

function removeObsEquipment(equipId) {
	const equipDiv = document.getElementById(`obsEquipment_${equipId}`);
	if (equipDiv) {
		equipDiv.remove();
		// Check if list is empty
		const container = document.getElementById('obsEquipmentList');
		if (container.querySelectorAll('.corrective-action-item').length === 0) {
			container.innerHTML = '<div class="no-actions-msg">No equipment added. Click "Add Equipment" to add one.</div>';
		}
	}
}

function getObsPersonsData() {
	const persons = [];
	document.querySelectorAll('#obsPersonsList .corrective-action-item').forEach(item => {
		const name = item.querySelector('.obs-person-name')?.value;
		if (name) {
			persons.push({
				name: name,
				role: item.querySelector('.obs-person-role')?.value || '',
				involvement: item.querySelector('.obs-person-involvement')?.value || '',
				notes: item.querySelector('.obs-person-notes')?.value || ''
			});
		}
	});
	return persons.length > 0 ? persons : null;
}

function getObsEquipmentData() {
	const equipment = [];
	document.querySelectorAll('#obsEquipmentList .corrective-action-item').forEach(item => {
		const name = item.querySelector('.obs-equip-name')?.value;
		if (name) {
			equipment.push({
				name: name,
				type: item.querySelector('.obs-equip-type')?.value || '',
				condition: item.querySelector('.obs-equip-condition')?.value || '',
				notes: item.querySelector('.obs-equip-notes')?.value || ''
			});
		}
	});
	return equipment.length > 0 ? equipment : null;
}

function loadObsPersonsData(data) {
	if (!data || data.length === 0) return;
	
	document.getElementById('obsHasPersonInvolved').checked = true;
	document.getElementById('obsPersonInvolvedFields').classList.add('visible');
	
	data.forEach(person => addObsPerson(person));
}

function loadObsEquipmentData(data) {
	if (!data || data.length === 0) return;
	
	document.getElementById('obsHasEquipmentInvolved').checked = true;
	document.getElementById('obsEquipmentInvolvedFields').classList.add('visible');
	
	data.forEach(equip => addObsEquipment(equip));
}

// Observation Corrective Actions Management
let obsCorrectiveActionsCounter = 0;

function addObsCorrectiveAction(data = null) {
	obsCorrectiveActionsCounter++;
	const actionId = obsCorrectiveActionsCounter;
	
	const container = document.getElementById('obsCorrectiveActionsList');
	const noActionsMsg = container.querySelector('.no-actions-msg');
	if (noActionsMsg) noActionsMsg.remove();
	
	const actionDiv = document.createElement('div');
	actionDiv.className = 'corrective-action-item';
	actionDiv.id = `obsCorrectiveAction_${actionId}`;
	actionDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">Action #${actionId}</span>
			<button type="button" class="btn-remove-action" onclick="removeObsCorrectiveAction(${actionId})">
				<i class="fas fa-trash"></i> Remove
			</button>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex:1 1 100%">
				<label>Description *</label>
				<textarea class="form-control obs-action-description" placeholder="Describe the corrective action" required>${data?.description || ''}</textarea>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>Responsible Person *</label>
				<div class="search-container">
					<input type="text" class="form-control obs-action-responsible-search" placeholder="Type to search employee..." autocomplete="off" value="${data?.responsibleName || ''}">
					<input type="hidden" class="obs-action-responsible-id" value="${data?.responsibleId || ''}">
					<div class="search-dropdown obs-action-search-results"></div>
				</div>
			</div>
			<div class="form-group">
				<label>Due Date *</label>
				<input type="date" class="form-control obs-action-due-date" required value="${data?.dueDate || ''}">
			</div>
			<div class="form-group">
				<label>Status *</label>
				<select class="form-control obs-action-status" required>
					<option value="">Select Status</option>
					<option value="pending" ${data?.status === 'pending' ? 'selected' : ''}>Pending</option>
					<option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
					<option value="completed" ${data?.status === 'completed' ? 'selected' : ''}>Completed</option>
					<option value="overdue" ${data?.status === 'overdue' ? 'selected' : ''}>Overdue</option>
				</select>
			</div>
		</div>
	`;
	container.appendChild(actionDiv);
	
	// Initialize search for the responsible person field
	initializeObsActionSearch(actionDiv.querySelector('.obs-action-responsible-search'));
}

function removeObsCorrectiveAction(actionId) {
	const actionDiv = document.getElementById(`obsCorrectiveAction_${actionId}`);
	if (actionDiv) {
		actionDiv.remove();
		// Check if list is empty
		const container = document.getElementById('obsCorrectiveActionsList');
		if (container.querySelectorAll('.corrective-action-item').length === 0) {
			container.innerHTML = '<div class="no-actions-msg">No corrective actions added. Click "Add Corrective Action" to add one.</div>';
		}
	}
}

function initializeObsActionSearch(searchInput) {
	if (!searchInput) return;
	
	let searchTimeout;
	searchInput.addEventListener('input', function() {
		clearTimeout(searchTimeout);
		const query = this.value.trim().toLowerCase();
		const resultsDiv = this.parentElement.querySelector('.obs-action-search-results');
		
		if (query.length < 2) {
			resultsDiv.innerHTML = '';
			resultsDiv.style.display = 'none';
			return;
		}
		
		searchTimeout = setTimeout(() => {
			firebase.database().ref('users').once('value').then(snapshot => {
				const users = snapshot.val();
				if (!users) {
					resultsDiv.innerHTML = '<div class="search-result" style="color:#888">No users found</div>';
					resultsDiv.style.display = 'block';
					return;
				}
				
				const matches = [];
				Object.entries(users).forEach(([uid, user]) => {
					const name = (user.name || user.displayName || '').toLowerCase();
					const email = (user.email || '').toLowerCase();
					if (name.includes(query) || email.includes(query)) {
						matches.push({ uid, name: user.name || user.displayName || email, email: user.email });
					}
				});
				
				if (matches.length === 0) {
					resultsDiv.innerHTML = '<div class="search-result" style="color:#888">No matches found</div>';
				} else {
					resultsDiv.innerHTML = matches.slice(0, 5).map(u => 
						`<div class="search-result" data-uid="${u.uid}" data-name="${u.name}">${u.name} <small style="color:#888">${u.email}</small></div>`
					).join('');
					
					resultsDiv.querySelectorAll('.search-result[data-uid]').forEach(item => {
						item.addEventListener('click', function() {
							const container = this.closest('.search-container');
							container.querySelector('.obs-action-responsible-search').value = this.dataset.name;
							container.querySelector('.obs-action-responsible-id').value = this.dataset.uid;
							resultsDiv.style.display = 'none';
						});
					});
				}
				resultsDiv.style.display = 'block';
			});
		}, 300);
	});
	
	// Hide dropdown on blur
	searchInput.addEventListener('blur', function() {
		setTimeout(() => {
			const resultsDiv = this.parentElement.querySelector('.obs-action-search-results');
			resultsDiv.style.display = 'none';
		}, 200);
	});
}

function getObsCorrectiveActionsData() {
	const actions = [];
	document.querySelectorAll('#obsCorrectiveActionsList .corrective-action-item').forEach(item => {
		const description = item.querySelector('.obs-action-description')?.value;
		if (description) {
			actions.push({
				description: description,
				responsibleId: item.querySelector('.obs-action-responsible-id')?.value || '',
				responsibleName: item.querySelector('.obs-action-responsible-search')?.value || '',
				dueDate: item.querySelector('.obs-action-due-date')?.value || '',
				status: item.querySelector('.obs-action-status')?.value || 'pending'
			});
		}
	});
	return actions.length > 0 ? actions : null;
}

function loadObsCorrectiveActions(data) {
	if (!data || data.length === 0) return;
	data.forEach(action => addObsCorrectiveAction(action));
}

// Corrective Actions Management
let correctiveActionsCounter = 0;
let correctiveActions = [];

function addCorrectiveAction(data = null) {
	correctiveActionsCounter++;
	const actionId = correctiveActionsCounter;
	
	const container = document.getElementById('correctiveActionsList');
	const noActionsMsg = container.querySelector('.no-actions-msg');
	if (noActionsMsg) noActionsMsg.remove();
	
	const actionDiv = document.createElement('div');
	actionDiv.className = 'corrective-action-item';
	actionDiv.id = `correctiveAction_${actionId}`;
	actionDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">Action #${actionId}</span>
			<button type="button" class="btn-remove-action" onclick="removeCorrectiveAction(${actionId})">
				<i class="fas fa-trash"></i> Remove
			</button>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex:1 1 100%">
				<label>Description *</label>
				<textarea class="form-control action-description" placeholder="Describe the corrective action" required>${data?.description || ''}</textarea>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>Responsible Person *</label>
				<div class="search-container">
					<input type="text" class="form-control action-responsible-search" placeholder="Type to search employee..." autocomplete="off" value="${data?.responsibleName || ''}">
					<input type="hidden" class="action-responsible-id" value="${data?.responsibleId || ''}">
					<div class="search-dropdown action-search-results"></div>
				</div>
			</div>
			<div class="form-group">
				<label>Due Date *</label>
				<input type="date" class="form-control action-due-date" required value="${data?.dueDate || ''}">
			</div>
			<div class="form-group">
				<label>Status *</label>
				<select class="form-control action-status" required>
					<option value="">Select Status</option>
					<option value="pending" ${data?.status === 'pending' ? 'selected' : ''}>Pending</option>
					<option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
					<option value="completed" ${data?.status === 'completed' ? 'selected' : ''}>Completed</option>
					<option value="overdue" ${data?.status === 'overdue' ? 'selected' : ''}>Overdue</option>
				</select>
			</div>
		</div>
	`;
	
	container.appendChild(actionDiv);
	
	// Initialize search for responsible person
	initializeActionResponsibleSearch(actionDiv, actionId);
	
	// Store action reference (without files)
	correctiveActions.push({ id: actionId });
	
	// Render existing files if editing
	if (data?.attachments && data.attachments.length > 0) {
		renderActionFiles(actionId);
	}
}

function removeCorrectiveAction(actionId) {
	const actionDiv = document.getElementById(`correctiveAction_${actionId}`);
	if (actionDiv) {
		actionDiv.remove();
		correctiveActions = correctiveActions.filter(a => a.id !== actionId);
		
		// Show "no actions" message if empty
		const container = document.getElementById('correctiveActionsList');
		if (container.children.length === 0) {
			container.innerHTML = '<div class="no-actions-msg">No corrective actions added. Click "Add Action" to create one.</div>';
		}
	}
}

function initializeActionResponsibleSearch(actionDiv, actionId) {
	const searchInput = actionDiv.querySelector('.action-responsible-search');
	const hiddenInput = actionDiv.querySelector('.action-responsible-id');
	const resultsDiv = actionDiv.querySelector('.action-search-results');
	
	searchInput.addEventListener('input', (e) => {
		const query = e.target.value.trim();
		if (query.length >= 2) {
			const results = searchUsers(query);
			showActionSearchResults(results, resultsDiv, searchInput, hiddenInput);
		} else {
			resultsDiv.style.display = 'none';
		}
	});
	
	searchInput.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (query.length >= 2) {
				const results = searchUsers(query);
				if (results.length > 0) {
					selectActionUser(results[0], searchInput, hiddenInput, resultsDiv);
				}
			}
		}
	});
	
	document.addEventListener('click', (e) => {
		if (!actionDiv.contains(e.target)) {
			resultsDiv.style.display = 'none';
		}
	});
}

function showActionSearchResults(users, resultsDiv, searchInput, hiddenInput) {
	resultsDiv.innerHTML = '';
	
	if (users.length === 0) {
		resultsDiv.innerHTML = '<div class="search-result">No users found</div>';
	} else {
		users.forEach(user => {
			const div = document.createElement('div');
			div.className = 'search-result';
			div.innerHTML = `
				<div class="user-name">${user.name}</div>
				${user.title ? `<div class="user-title">${user.title}</div>` : ''}
			`;
			div.onclick = () => selectActionUser(user, searchInput, hiddenInput, resultsDiv);
			resultsDiv.appendChild(div);
		});
	}
	
	resultsDiv.style.display = 'block';
}

function selectActionUser(user, searchInput, hiddenInput, resultsDiv) {
	hiddenInput.value = user.id;
	searchInput.value = user.name + (user.title ? ' - ' + user.title : '');
	resultsDiv.style.display = 'none';
}

function getCorrectiveActionsData() {
	const actions = [];
	correctiveActions.forEach(action => {
		const actionDiv = document.getElementById(`correctiveAction_${action.id}`);
		if (!actionDiv) return;
		
		const description = actionDiv.querySelector('.action-description')?.value || '';
		const responsibleId = actionDiv.querySelector('.action-responsible-id')?.value || '';
		const responsibleName = actionDiv.querySelector('.action-responsible-search')?.value || '';
		const dueDate = actionDiv.querySelector('.action-due-date')?.value || '';
		const status = actionDiv.querySelector('.action-status')?.value || '';
		
		actions.push({
			description,
			responsibleId,
			responsibleName,
			dueDate,
			status
		});
	});
	return actions;
}

function loadCorrectiveActions(actionsData) {
	if (!actionsData || !Array.isArray(actionsData)) return;
	
	// Clear existing actions
	correctiveActions = [];
	correctiveActionsCounter = 0;
	const container = document.getElementById('correctiveActionsList');
	container.innerHTML = '';
	
	// Add each saved action
	actionsData.forEach(actionData => {
		addCorrectiveAction(actionData);
	});
	
	// Show "no actions" message if empty
	if (actionsData.length === 0) {
		container.innerHTML = '<div class="no-actions-msg">No corrective actions added. Click "Add Action" to create one.</div>';
	}
}

function updateEventTypeFields(){
	const type=(document.getElementById('eventType')?.value)||'';
	const nm=document.getElementById('nearMissFields');
	const ob=document.getElementById('observationFields');
	const ic=document.getElementById('incidentFields');
	const incidentCommon=document.getElementById('incidentCommonFields');
	const actionsFields=document.getElementById('actionsFields');
	const dueDateField=document.getElementById('dueDateField');
	
	// Show/hide event-type specific fields
	show(nm, type==='near-miss');
	show(ob, type==='observation');
	show(ic, type==='incident');
	
	// Show incident category, injury type, property damage only for incidents
	show(incidentCommon, type==='incident');
	
	// Show actions fields for incidents and near-misses (not observations)
	show(actionsFields, type==='incident' || type==='near-miss');
	
	// Hide due date field for near-miss events
	show(dueDateField, type==='incident');
	
	// Dynamic requireds
	setRequired('obsType', type==='observation');
	setRequired('obsCategory', type==='observation');
	setRequired('incRootCause', type==='incident');
	updateLostTimeRequirement();
}

function updateLostTimeRequirement(){
	const v=document.getElementById('incLostTime')?.value||'';
	const req = v==='yes' && (document.getElementById('eventType')?.value||'')==='incident';
	setRequired('incDaysLost', req);
}

function getEventDetailsFromForm(){
	const type=(document.getElementById('eventType')?.value)||'';
	const details={ type };
	if(type==='near-miss'){
		details.nearMiss=compactObject({
			// Near miss specific fields removed
		});
	} else if(type==='observation'){
		details.observation=compactObject({
			type: document.getElementById('obsType')?.value||'',
			category: document.getElementById('obsCategory')?.value||'',
			personsInvolved: getObsPersonsData(),
			equipmentInvolved: getObsEquipmentData(),
			correctiveActions: getObsCorrectiveActionsData()
		});
	} else if(type==='incident'){
		details.incident=compactObject({
			injuredPerson: document.getElementById('incInjuredPerson')?.value||'',
			lostTime: document.getElementById('incLostTime')?.value||'',
			daysLost: document.getElementById('incDaysLost')?.value||'',
			rootCause: document.getElementById('incRootCause')?.value||'',
			contributingFactors: document.getElementById('incContributingFactors')?.value||'',
			equipment: document.getElementById('incEquipment')?.value||'',
			witnesses: document.getElementById('incWitnesses')?.value||''
		});
	}
	return compactObject(details);
}

function setEventDetailsFormValues(eventDetails){
	if(!eventDetails || typeof eventDetails!=='object') return;
	// Do not override main eventType select here; trust form value
	if(eventDetails.nearMiss){
		const nm=eventDetails.nearMiss;
		// Near miss fields removed
	}
	if(eventDetails.observation){
		const ob=eventDetails.observation;
		if(ob.type!==undefined) document.getElementById('obsType').value=ob.type;
		if(ob.category!==undefined) document.getElementById('obsCategory').value=ob.category;
		// Load persons involved
		if(ob.personsInvolved) loadObsPersonsData(ob.personsInvolved);
		// Load equipment involved
		if(ob.equipmentInvolved) loadObsEquipmentData(ob.equipmentInvolved);
		// Load corrective actions
		if(ob.correctiveActions) loadObsCorrectiveActions(ob.correctiveActions);
	}
	if(eventDetails.incident){
		const ic=eventDetails.incident;
		if(ic.injuredPerson!==undefined) document.getElementById('incInjuredPerson').value=ic.injuredPerson;
		if(ic.lostTime!==undefined) document.getElementById('incLostTime').value=ic.lostTime;
		if(ic.daysLost!==undefined) document.getElementById('incDaysLost').value=ic.daysLost;
		if(ic.rootCause!==undefined) document.getElementById('incRootCause').value=ic.rootCause;
		if(ic.contributingFactors!==undefined) document.getElementById('incContributingFactors').value=ic.contributingFactors;
		if(ic.equipment!==undefined) document.getElementById('incEquipment').value=ic.equipment;
		if(ic.witnesses!==undefined) document.getElementById('incWitnesses').value=ic.witnesses;
	}
}

const attachedFiles=[];
const fileInput=document.getElementById('fileUpload'), fileList=document.getElementById('fileList');
fileInput.addEventListener('change',()=>{ [...fileInput.files].forEach(f=>{ if(f.size>5*1024*1024){ alert(`File ${f.name} exceeds 5MB`); return; } attachedFiles.push({ file:f, name:f.name, size:formatBytes(f.size) }); }); fileInput.value=''; renderFiles(); });
function renderFiles(){ fileList.innerHTML=''; if(attachedFiles.length===0){ fileList.innerHTML='<li style="color:#888">No files attached</li>'; return; } attachedFiles.forEach((fi,idx)=>{ const li=document.createElement('li'); li.className='file-item'; li.innerHTML=`<i class="fas fa-file"></i><span style="flex:1">${fi.name}</span><span style="color:#666">${fi.size||''}</span><div class="file-actions"><button class="delete-file" data-i="${idx}" title="Remove"><i class="fas fa-trash"></i></button></div>`; li.querySelector('.delete-file').onclick=()=>{ attachedFiles.splice(idx,1); renderFiles(); }; fileList.appendChild(li); }); }

// Serialize attachments into objects with base64 payload for Realtime Database
async function uploadAttachments(prefixIgnored){
	const out=[];
	for(const item of attachedFiles){
		// Keep existing attachments (editing) as-is if they already have url or dataUrl, but strip undefined fields
		if(item.url || item.dataUrl){ out.push(sanitizeAttachmentFields(item)); continue; }
		if(item.file){
			const dataUrl=await fileToDataUrl(item.file);
			out.push({
				name: item.name,
				size: item.size,
				contentType: item.file.type || 'application/octet-stream',
				dataUrl,
				uploadedAt: firebase.database.ServerValue.TIMESTAMP
			});
		}
	}
	return out;
}

async function loadOptions(){
	// injury-type
	const injurySel=document.getElementById('injuryType'); injurySel.length=1;
	const injurySnap=await db.ref('fieldOptions/injury-type').once('value');
	if(injurySnap.exists()) injurySnap.forEach(s=>{ const o=s.val(); if(o?.enabled){ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; injurySel.appendChild(opt); }});
	else ['no-injury','minor','medical','lost-time','fatality'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); injurySel.appendChild(opt); });

	// property-damage
	const propSel=document.getElementById('propertyDamage'); propSel.length=1;
	const propSnap=await db.ref('fieldOptions/property-damage').once('value');
	if(propSnap.exists()) propSnap.forEach(s=>{ const o=s.val(); if(o?.enabled){ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; propSel.appendChild(opt); }});
	else ['none','minor','significant','major','vehicle','equipment','structural'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); propSel.appendChild(opt); });

	// incident-category
	const catSel=document.getElementById('incidentCategory'); catSel.length=1;
	const catSnap=await db.ref('fieldOptions/incident-category').once('value');
	if(catSnap.exists()) catSnap.forEach(s=>{ const o=s.val(); if(o?.enabled){ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; catSel.appendChild(opt); }});
	else ['slip-trip-fall','struck-by','caught-in-between','vehicle-accident','electrical','fire-explosion','chemical-exposure','ergonomic','other'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); catSel.appendChild(opt); });
}

async function loadLocations(companyId){ 
	const sel=document.getElementById('eventLocation'); 
	while(sel.options.length>1) sel.remove(1); 
	
	// First try to load from company's incidentSettings
	if(companyId) {
		const settingsSnap=await db.ref(`companies/${companyId}/incidentSettings/locations`).once('value');
		const locations=settingsSnap.val();
		if(locations && Array.isArray(locations) && locations.length > 0) {
			locations.forEach(n=>{ 
				const o=document.createElement('option'); 
				o.value=n; 
				o.textContent=n; 
				sel.appendChild(o); 
			});
			return;
		}
	}
	
	// Fallback to global locations or defaults
	const snap=await db.ref('locations').once('value'); 
	if(snap.exists()) {
		snap.forEach(s=>{ 
			const o=document.createElement('option'); 
			o.value=s.key; 
			o.textContent=s.val()?.name||s.key; 
			sel.appendChild(o); 
		}); 
	} else {
		['Main Building','Warehouse','Production Floor','Office Area','Loading Dock'].forEach(n=>{ 
			const o=document.createElement('option'); 
			o.value=n.toLowerCase().replace(/\s+/g,'-'); 
			o.textContent=n; 
			sel.appendChild(o); 
		}); 
	}
}
async function loadObservationTypes(companyId){ 
	const sel=document.getElementById('obsType'); 
	if(!sel) return;
	while(sel.options.length>1) sel.remove(1); 
	
	// Try to load from company's incidentSettings
	if(companyId) {
		const settingsSnap=await db.ref(`companies/${companyId}/incidentSettings/observationTypes`).once('value');
		const types=settingsSnap.val();
		if(types && Array.isArray(types) && types.length > 0) {
			types.forEach(t=>{ 
				const o=document.createElement('option'); 
				o.value=t.toLowerCase().replace(/\s+/g,'-'); 
				o.textContent=t; 
				sel.appendChild(o); 
			});
			return;
		}
	}
	
	// Fallback to default options
	['Safe', 'At-Risk'].forEach(t=>{ 
		const o=document.createElement('option'); 
		o.value=t.toLowerCase().replace(/\s+/g,'-'); 
		o.textContent=t; 
		sel.appendChild(o); 
	});
}
async function loadDepartments(companyId){ const sel=document.getElementById('department'); while(sel.options.length>1) sel.remove(1);
	if(companyId){ const snap=await db.ref(`companies/${companyId}/fieldOptions/department`).once('value'); const arr=snap.val(); if(Array.isArray(arr)){ arr.filter(x=>x?.enabled!==false).forEach(x=>{ const o=document.createElement('option'); o.value=x.value||x.key||x.label; o.textContent=x.label||x.value; sel.appendChild(o); }); } }
	if(sel.options.length===1){ const g=await db.ref('fieldOptions/department').once('value'); const v=g.val(); if(v){ (Array.isArray(v)?v:Object.keys(v).map(k=>({value:k,label:v[k]?.label||k}))).forEach(x=>{ const o=document.createElement('option'); o.value=x.value; o.textContent=x.label; sel.appendChild(o); }); } }
	if(sel.options.length===1){ ['Safety','Operations','HR','Finance','IT'].forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
}
async function loadUsers(){ /* Users are now loaded via loadAllUsers for search functionality */ }

let allUsers = [];

async function loadAllUsers() {
	const snap = await db.ref('users').once('value');
	allUsers = [];
	if (snap.exists()) {
		snap.forEach(s => {
			const u = s.val() || {};
			const fullName = (u.firstName && u.lastName) ? `${u.firstName} ${u.lastName}` : (u.name || u.email || s.key);
			const jobTitle = u.jobTitle || u.position || '';
			allUsers.push({
				id: s.key,
				name: fullName,
				title: jobTitle,
				email: u.email || '',
				searchText: `${fullName} ${jobTitle} ${u.email || ''}`.toLowerCase()
			});
		});
	}
}

function searchUsers(query) {
	if (!query || query.length < 2) return [];
	const searchTerm = query.toLowerCase();
	return allUsers.filter(user => user.searchText.includes(searchTerm)).slice(0, 10);
}

function showSearchResults(users) {
	const resultsDiv = document.getElementById('searchResults');
	resultsDiv.innerHTML = '';
	
	if (users.length === 0) {
		resultsDiv.innerHTML = '<div class="search-result">No users found</div>';
	} else {
		users.forEach(user => {
			const div = document.createElement('div');
			div.className = 'search-result';
			div.innerHTML = `
				<div class="user-name">${user.name}</div>
				${user.title ? `<div class="user-title">${user.title}</div>` : ''}
			`;
			div.onclick = () => selectUser(user);
			resultsDiv.appendChild(div);
		});
	}
	
	resultsDiv.style.display = 'block';
}

function selectUser(user) {
	const assignedToInput = document.getElementById('assignedTo');
	const searchInput = document.getElementById('userSearch');
	const resultsDiv = document.getElementById('searchResults');
	
	// Set the hidden input value
	assignedToInput.value = user.id;
	
	// Show selected user in search input
	searchInput.value = user.name + (user.title ? ' - ' + user.title : '');
	resultsDiv.style.display = 'none';
}

function initializeUserSearch() {
	const searchInput = document.getElementById('userSearch');
	const resultsDiv = document.getElementById('searchResults');
	
	if (!searchInput) return;
	
	// Search on input
	searchInput.addEventListener('input', (e) => {
		const query = e.target.value.trim();
		if (query.length >= 2) {
			const results = searchUsers(query);
			showSearchResults(results);
		} else {
			resultsDiv.style.display = 'none';
		}
	});
	
	// Hide results when clicking outside
	document.addEventListener('click', (e) => {
		if (!e.target.closest('.search-container')) {
			resultsDiv.style.display = 'none';
		}
	});
	
	// Handle Enter key
	searchInput.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (query.length >= 2) {
				const results = searchUsers(query);
				if (results.length > 0) {
					selectUser(results[0]); // Select first result
				}
			}
		}
	});
}

async function generateReference(){ const tr=await db.ref('counters/incidents').transaction(v=>(v||0)+1); if(tr.committed){ const n=String(tr.snapshot.val()).padStart(5,'0'); document.getElementById('referenceNumber').value=`INC-${n}`; } else { document.getElementById('referenceNumber').value=`INC-${Date.now()}`; } }

async function loadIncidentIfEditing(companyId){
	const params=new URLSearchParams(location.search); const id=params.get('id'); if(!id) return null;
	try {
		document.getElementById('incidentId').value=id;
		const ref=await db.ref(`companies/${companyId}/incidents/${id}`).once('value');
		if(!ref.exists()) {
			console.error('Incident not found:', id);
			return null;
		}
		const d=ref.val();
		console.log('Loading incident data:', d);
		
		document.title='Edit Incident - HSE System';
		const headerSpan = document.querySelector('.page-header span');
		if(headerSpan) headerSpan.textContent='Edit Incident';
		
		const refNumberEl = document.getElementById('referenceNumber');
		if(refNumberEl) refNumberEl.value=d.referenceNumber||'';
		
		const titleEl = document.getElementById('incidentTitle');
		if(titleEl) titleEl.value=d.title||'';
		
		const severityEl = document.getElementById('severity');
		if(severityEl) severityEl.value=d.severity||'';
		// Set combined Date & Time input from stored date/time or dateTime
		(function setEditDateTime(){ const el=document.getElementById('incidentDateTime'); if(!el) return; let val=''; if(d.dateTime){ const m=d.dateTime.match(/^(\d{4}-\d{2}-\d{2})[T ](\d{2}:\d{2})/); if(m) val=`${m[1]}T${m[2]}`; } if(!val){ const date=(d.date||'').slice(0,10); const time=(d.time||'').slice(0,5); if(date){ val=`${date}T${time||'00:00'}`; } } if(val) el.value=val; })();
		
		const statusEl = document.getElementById('incidentStatus');
		if(statusEl) statusEl.value=d.status||'open';
		
		const locationEl = document.getElementById('eventLocation');
		if(locationEl) locationEl.value=d.location||'';
		
		const deptEl = document.getElementById('department');
		if(deptEl) deptEl.value=d.department||'';
		
		// Load Reported By fields
		const reportedByNameEl = document.getElementById('reportedByName');
		if(reportedByNameEl && d.reportedByName) reportedByNameEl.value=d.reportedByName;
		
		const reportedByIdEl = document.getElementById('reportedById');
		if(reportedByIdEl && d.reportedBy) reportedByIdEl.value=d.reportedBy;
		
		// Load Date Reported
		const dateReportedEl = document.getElementById('dateReported');
		if(dateReportedEl && d.dateReported) dateReportedEl.value=d.dateReported;
		
		const assignedToEl = document.getElementById('assignedTo');
		if(assignedToEl) assignedToEl.value=d.assignedTo||'';
		
		// Populate the user search field with selected user's name
		const userSearchEl = document.getElementById('userSearch');
		if(userSearchEl) {
			if(d.assignedToName){
				// Use stored name if available
				userSearchEl.value = d.assignedToName;
			} else if(d.assignedTo && typeof allUsers !== 'undefined'){
				// Fallback to finding user by ID
				const assignedUser = allUsers.find(u => u.id === d.assignedTo);
				if(assignedUser){
					userSearchEl.value = assignedUser.name + (assignedUser.title ? ' - ' + assignedUser.title : '');
				}
			}
		}
		
		const eventTypeEl = document.getElementById('eventType');
		if(eventTypeEl) eventTypeEl.value=d.eventType||'';
		
		const categoryEl = document.getElementById('incidentCategory');
		if(categoryEl) categoryEl.value=d.incidentCategory||'';
		// Load injury data
		if(d.injuryData){
			loadInjuryData(d.injuryData);
		}
		// Load property damage data
		if(d.propertyDamageData){
			loadPropertyDamageData(d.propertyDamageData);
		}
		
		const descEl = document.getElementById('description');
		if(descEl) descEl.value=d.description||'';
		
		const immediateEl = document.getElementById('immediateActions');
		if(immediateEl) immediateEl.value=d.immediateActions||'';
		
		// Load corrective actions
		if(Array.isArray(d.correctiveActions)){
			loadCorrectiveActions(d.correctiveActions);
		}
		
		const dueDateEl = document.getElementById('dueDate');
		if(dueDateEl) dueDateEl.value=d.dueDate||'';
		// existing attachments
		if(Array.isArray(d.attachments)){
			d.attachments.forEach(a=>attachedFiles.push(sanitizeAttachmentFields(a||{})));
			renderFiles();
		}
		// Populate event-specific fields if present
		if(d.eventDetails){
			setEventDetailsFormValues(d.eventDetails);
		}
		// Ensure visibility/required states align with loaded type
		updateEventTypeFields();
		return d;
	} catch (error) {
		console.error('Error loading incident:', error);
		alert('Error loading incident: ' + error.message);
		return null;
	}
}

document.addEventListener('DOMContentLoaded',()=>{
	bindSidebarToggle();
	const now=new Date();
	const today=now.toISOString().split('T')[0];
	const dtEl=document.getElementById('incidentDateTime'); if(dtEl) dtEl.value=toLocalDateTimeInputValue(now);
	document.getElementById('dateReported').value=today;
	// Notification dropdown toggle
	(function bindNotifications(){
		const btn=document.getElementById('notificationBtn');
		const dropdown=document.querySelector('.notification-dropdown');
		const badge=document.querySelector('.notification-badge');
		if(badge) badge.style.display='none';
		if(btn && dropdown){
			btn.addEventListener('click', (e)=>{ e.stopPropagation(); dropdown.classList.toggle('show'); });
			document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && !btn.contains(e.target)) dropdown.classList.remove('show'); });
		}
		const markAll=document.querySelector('.mark-all-read');
		if(markAll){ markAll.addEventListener('click', ()=>{ dropdown?.classList.remove('show'); if(badge) badge.style.display='none'; }); }
	})();
});

// Use centralized AuthManager
const authManager = new AuthManager();
// Expose for menu authorization system
window.authManager = authManager;
async function waitForCompanyId(timeoutMs=6000){
	const start=Date.now();
	return new Promise(resolve=>{
		const t=setInterval(()=>{
			if(authManager.currentUser && authManager.currentUser.companyId){ clearInterval(t); resolve(); }
			else if(Date.now()-start>timeoutMs){ clearInterval(t); resolve(); }
		},150);
	});
}

(async function initIncidentPage(){
	await waitForCompanyId();
	const user = authManager.currentUser;
	if(!user){ return; }
	const companyId = user.companyId;
	document.getElementById('reportedByName').value = authManager.getUserDisplayName();
	document.getElementById('reportedById').value = user.uid;

	await Promise.all([loadOptions(), loadLocations(companyId), loadDepartments(companyId), loadUsers(), loadAllUsers(), loadObservationTypes(companyId)]);
	const existing=await loadIncidentIfEditing(companyId);
	initializeUserSearch();
	if(!existing) await generateReference();

	// Bind dynamic field logic
	const et=document.getElementById('eventType'); if(et){ et.addEventListener('change', updateEventTypeFields); }
	const lt=document.getElementById('incLostTime'); if(lt){ lt.addEventListener('change', updateLostTimeRequirement); }
	updateEventTypeFields();

	// Initialize sidebar feature/role-based menu authorization
	if (typeof initializeMenuAuthorization === 'function') {
		initializeMenuAuthorization();
	}

	document.getElementById('cancelBtn').onclick=()=>{ if(confirm('Cancel and discard changes?')) location.href='incidentboard.html'; };
	document.getElementById('saveDraftBtn').onclick=async ()=>{
		const id=document.getElementById('incidentId').value;
		const ref=id? db.ref(`companies/${companyId}/incidents/${id}`): db.ref(`companies/${companyId}/incidents`).push();
		const todayStr=new Date().toISOString().split('T')[0];
		const dt=getDateTimeParts();
		const payload={
			referenceNumber: document.getElementById('referenceNumber').value || `INC-${Date.now()}`,
			title: document.getElementById('incidentTitle').value || 'Draft Incident',
			severity: document.getElementById('severity').value || 'low',
			eventType: document.getElementById('eventType').value || 'incident',
			date: dt.date || todayStr,
			time: dt.time || '',
			dateTime: dt.iso,
			status:'draft',
			location: document.getElementById('eventLocation').value||'',
			department: document.getElementById('department').value||'',
			assignedTo: document.getElementById('assignedTo').value||'',
			assignedToName: document.getElementById('userSearch').value||'',
			incidentCategory: document.getElementById('incidentCategory').value||'',
			injuryData: getInjuryData(),
			propertyDamageData: getPropertyDamageData(),
			description: document.getElementById('description').value||'',
			immediateActions: document.getElementById('immediateActions').value||'',
			correctiveActions: getCorrectiveActionsData(),
			dueDate: document.getElementById('dueDate').value||'',
			eventDetails: getEventDetailsFromForm(),
			reportedBy: user.uid, reportedByName: document.getElementById('reportedByName').value, dateReported: document.getElementById('dateReported').value,
			updatedAt: new Date().toISOString(), createdAt: existing?.createdAt || new Date().toISOString()
		};
		// store without uploading files on draft for speed
		await ref.update(payload);
		alert('Draft saved'); location.href='incidentboard.html';
	};

	document.getElementById('incidentForm').addEventListener('submit', async (e)=>{
		e.preventDefault();
		const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.textContent='Submitting...';
		try{
			const id=document.getElementById('incidentId').value;
			const ref=id? db.ref(`companies/${companyId}/incidents/${id}`): db.ref(`companies/${companyId}/incidents`).push();
			// For Realtime Database storage, serialize files as base64 data URLs
			const attachments=await uploadAttachments();
			const dt=getDateTimeParts();
			const payload={
				referenceNumber: document.getElementById('referenceNumber').value,
				title: document.getElementById('incidentTitle').value,
				severity: document.getElementById('severity').value,
				eventType: document.getElementById('eventType').value || 'incident',
				date: dt.date,
				time: dt.time,
				dateTime: dt.iso,
				status: document.getElementById('incidentStatus').value || 'open',
				location: document.getElementById('eventLocation').value,
				department: document.getElementById('department').value,
				assignedTo: document.getElementById('assignedTo').value,
				assignedToName: document.getElementById('userSearch').value,
				incidentCategory: document.getElementById('incidentCategory').value,
				injuryData: getInjuryData(),
				propertyDamageData: getPropertyDamageData(),
				description: document.getElementById('description').value,
				immediateActions: document.getElementById('immediateActions').value,
				correctiveActions: getCorrectiveActionsData(),
				dueDate: document.getElementById('dueDate').value,
				attachments,
				eventDetails: getEventDetailsFromForm(),
				reportedBy: user.uid, reportedByName: document.getElementById('reportedByName').value, dateReported: document.getElementById('dateReported').value,
				updatedAt: new Date().toISOString(),
			};
			if(!id) payload.createdAt=new Date().toISOString(); else { const snap=await ref.once('value'); payload.createdAt=snap.val()?.createdAt||new Date().toISOString(); }
			await ref.update(payload);
			alert(id?'Incident updated':'Incident created');
			location.href='incidentboard.html';
		}catch(err){
			console.error(err);
			alert('Error submitting incident: '+ (err?.message || err));
		}finally{
			btn.disabled=false; btn.textContent='Submit Incident';
		}
	});
})();

// ===== ROLE-BASED MENU AUTHORIZATION SYSTEM (ported from project-list) =====

// Flag to prevent multiple simultaneous executions
let isMenuUpdateInProgress = false;

// Reset all menu items to hidden (preserve core features only when authorized)
function resetMenuVisibility() {
	document.querySelectorAll('[data-feature]').forEach(item => {
		item.classList.remove('menu-visible');
	});
	document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
		dropdown.classList.remove('menu-visible');
	});
}

// Emergency fallback - show basic menu items
function showBasicMenu() {
	console.log('ðŸ”§ Emergency fallback: Showing basic menu items');
	resetMenuVisibility();
	const sidebar = document.querySelector('.sidebar');
	if (sidebar) {
		sidebar.classList.remove('menu-loading');
	}
	const homeItem = document.querySelector('[data-feature="home_view"]');
	if (homeItem) {
		homeItem.classList.add('menu-visible');
	}
}

// Feature-based authorization system that takes priority over role permissions
async function updateMenuWithFeatureAuthorization() {
	if (isMenuUpdateInProgress) {
		console.log('ðŸ”„ Menu update already in progress, skipping...');
		return;
	}
	isMenuUpdateInProgress = true;
	console.log('ðŸŽ¯ Starting feature-based menu authorization for incident.html...');
	try {
		let currentUser = null;
		let companyId = null;
		let userRole = null;

		if (window.authManager && window.authManager.currentUser) {
			currentUser = window.authManager.currentUser;
			companyId = currentUser.companyId;
			userRole = currentUser.role;
			console.log('ðŸ‘¤ Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
		} else if (firebase.auth().currentUser) {
			currentUser = firebase.auth().currentUser;
			console.log('ðŸ‘¤ Using Firebase auth - will search for company and role');
		} else {
			console.log('âŒ No authenticated user found');
			resetMenuVisibility();
			return;
		}

		if (!companyId && currentUser) {
			console.log('ðŸ” Searching for user company and role...');
			const database = firebase.database();
			const companiesRef = database.ref('companies');
			const companiesSnapshot = await companiesRef.once('value');
			if (companiesSnapshot.exists()) {
				const companies = companiesSnapshot.val();
				for (const [cId, company] of Object.entries(companies)) {
					if (company.status !== 'active') continue;
					if (company.users && company.users[currentUser.uid]) {
						companyId = cId;
						userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
						console.log(`âœ… Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
						break;
					}
				}
			}
		}

		if (!companyId) {
			console.error('âŒ No company ID found, cannot determine authorized features');
			resetMenuVisibility();
			return;
		}
		if (!userRole) {
			console.warn('âš ï¸ No user role found, proceeding with company features only');
		}

		// STEP 1: Apply company feature-based authorization
		console.log('ðŸ¢ STEP 1: Applying company feature authorization...');
		const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);

		// STEP 2: Filter by user role permissions within authorized features
		if (userRole) {
			console.log('ðŸ‘¤ STEP 2: Applying role-based filtering within authorized features...');
			await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
		} else {
			console.log('âš ï¸ STEP 2: Skipping role-based filtering (no role found)');
		}
	} catch (error) {
		console.error('âŒ Error in feature-based menu authorization:', error);
		resetMenuVisibility();
	} finally {
		isMenuUpdateInProgress = false;
	}
}

// Apply feature-based menu visibility
async function applyFeatureBasedMenuVisibility(companyId) {
	try {
		console.log('ðŸ”§ Applying feature-based menu visibility for company:', companyId);
		const database = firebase.database();
		const featuresSnapshot = await database.ref('/platformFeatures').once('value');
		if (!featuresSnapshot.exists()) {
			console.log('âš ï¸ No platform features found');
			resetMenuVisibility();
			return [];
		}
		const featuresData = featuresSnapshot.val();
		const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
		const companyData = companySnapshot.val();
		if (!companyData) {
			console.error('âŒ Company data not found');
			resetMenuVisibility();
			return [];
		}
		const subscribedFeatureIds = companyData.selectedFeatures || [];
		console.log('ðŸ¢ Company subscribed features:', subscribedFeatureIds);
		if (subscribedFeatureIds.length === 0) {
			console.log('âš ï¸ Company has no subscribed features');
			resetMenuVisibility();
			return [];
		}
		const authorizedPages = [];
		const featureAlias = (key) => {
			if (!key) return key;
			if (key === 'risk_view') return 'risk_management_section';
			if (key === 'risk_management_section') return 'risk_view';
			return null;
		};
		const normalizeHref = (href) => {
			if (!href) return '';
			try { const u = new URL(href, window.location.origin); return (u.pathname||'').replace(/^\//,''); } catch { return String(href).replace(/^\//,''); }
		};
		const authorizedFeatures = new Set();
		const authorizedHrefs = new Set();
		subscribedFeatureIds.forEach(featureId => {
			const feature = featuresData[featureId];
			if (feature && feature.status === 'active' && feature.authorizedPages) {
				console.log(`ðŸ“¦ Adding pages from feature "${feature.name}":`, feature.authorizedPages);
				authorizedPages.push(...feature.authorizedPages);
			}
		});
		authorizedPages.forEach(pageInfo => {
			if (pageInfo.feature) {
				authorizedFeatures.add(pageInfo.feature);
				const alias = featureAlias(pageInfo.feature);
				if (alias) authorizedFeatures.add(alias);
			}
			if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
			if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
			if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
		});
		console.log('ðŸŽ¯ Authorized features for incident.html:', Array.from(authorizedFeatures));
		console.log('ðŸ”— Authorized hrefs for incident.html:', Array.from(authorizedHrefs));
		resetMenuVisibility();
		const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
		allMenuItems.forEach(menuItem => {
			const featureAttribute = menuItem.getAttribute('data-feature');
			const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
			const anchor = menuItem.querySelector('a[href]');
			const href = anchor ? anchor.getAttribute('href') : '';
			const normalized = href ? href.replace(/^\//,'') : '';
			const featureAuthorized = authorizedFeatures.has(featureAttribute);
			const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
			const isAuthorized = featureAuthorized || hrefAuthorized;
			if (isDropdownContainer) return; // handle after
			if (isAuthorized) menuItem.classList.add('menu-visible'); else menuItem.classList.remove('menu-visible');
		});
		const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
		dropdownMenus.forEach(dropdown => {
			const dropdownFeature = dropdown.getAttribute('data-feature');
			const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
			let hasVisibleChildren = false;
			submenuItems.forEach(submenuItem => { if (submenuItem.classList.contains('menu-visible')) hasVisibleChildren = true; });
			if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) dropdown.classList.add('menu-visible'); else dropdown.classList.remove('menu-visible');
		});
		return authorizedPages;
	} catch (error) {
		console.error('âŒ Error applying feature-based menu visibility:', error);
		resetMenuVisibility();
		return [];
	}
}

// Apply role-based filtering within company authorized features
async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
	try {
		console.log('ðŸ‘¤ Applying role-based filtering for role:', userRole);
		const database = firebase.database();
		const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
		const permissionsSnapshot = await permissionsRef.once('value');
		if (!permissionsSnapshot.exists()) {
			console.log(`âš ï¸ No permissions found for role ${userRole} in company ${companyId}`);
			if (userRole === 'administrator') {
				console.log('ðŸ”‘ ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
				showSidebarAfterAuth();
				return;
			}
			hideItemsRequiringPermissions();
			showSidebarAfterAuth();
			return;
		}
		const permissions = permissionsSnapshot.val();
		filterMenuByPermissions(permissions);
	} catch (error) {
		console.error('âŒ Error applying role-based filtering:', error);
		showSidebarAfterAuth();
	}
}

// Filter currently visible menu items by role permissions
function filterMenuByPermissions(permissions) {
	console.log('ðŸ” Filtering visible menu items by role permissions...');
	if (!permissions) {
		hideItemsRequiringPermissions();
		showSidebarAfterAuth();
		return;
	}
	const permissionAlias = (key) => {
		if (!key) return key;
		if (key === 'risk_view') return 'risk_management_section';
		if (key === 'risk_management_section') return 'risk_view';
		return null;
	};
	const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
	itemsRequiringPermissions.forEach(item => {
		const requiresPermission = item.getAttribute('data-requires-permission');
		const perm = permissions[requiresPermission];
		const aliasKey = permissionAlias(requiresPermission);
		const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
		const hasViewPermission = (p) => p === true || (p && p.view === true);
		const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
		if (allowed) item.classList.add('menu-visible'); else item.classList.remove('menu-visible');
	});
	const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
	dropdownMenus.forEach(dropdown => {
		const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
		const dropdownFeature = dropdown.getAttribute('data-feature');
		const dropdownRequires = dropdown.getAttribute('data-requires-permission');
		if (submenuItems.length === 0) {
			if (dropdownRequires) {
				const perm = permissions[dropdownRequires];
				const aliasKey = permissionAlias(dropdownRequires);
				const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
				const hasViewPermission = (p) => p === true || (p && p.view === true);
				const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
				if (allowed) dropdown.classList.add('menu-visible'); else dropdown.classList.remove('menu-visible');
			} else {
				dropdown.classList.remove('menu-visible');
			}
		}
	});
	ensureHomeIsVisible();
	showSidebarAfterAuth();
}

// Hide menu items that require permissions (for users without role permissions)
function hideItemsRequiringPermissions() {
	console.log('ðŸ”’ Hiding all menu items that require permissions...');
	const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
	itemsRequiringPermissions.forEach(item => { item.classList.remove('menu-visible'); });
	const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
	dropdownMenus.forEach(dropdown => {
		const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
		if (visibleSubmenuItems.length === 0) dropdown.classList.remove('menu-visible');
	});
	ensureHomeIsVisible();
}

// Ensure home menu item is visible as fallback
function ensureHomeIsVisible() {
	const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
	if (homeItem && !homeItem.classList.contains('menu-visible')) {
		homeItem.classList.add('menu-visible');
	}
}

// Show sidebar and remove loading state after authentication and filtering
function showSidebarAfterAuth() {
	const sidebar = document.querySelector('.sidebar');
	if (sidebar) {
		sidebar.classList.remove('menu-loading');
		console.log('âœ… Sidebar loading state removed - menu authorization complete');
	}
}

// Initialize menu authorization system
function initializeMenuAuthorization() {
	console.log('ðŸš€ Initializing menu authorization system...');
	const sidebar = document.querySelector('.sidebar');
	if (sidebar) {
		sidebar.classList.add('menu-loading');
	}
	setTimeout(() => { updateMenuWithFeatureAuthorization(); }, 500);
}

// Make updateMenuWithFeatureAuthorization available globally
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
// ===== END ROLE-BASED MENU AUTHORIZATION SYSTEM =====
</script>
</body>
</html>
