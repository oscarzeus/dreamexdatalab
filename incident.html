<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>HSE System - Report Incident</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
	<style>
		:root{
			--primary-color:#2c3e50; --secondary-color:#3498db; --text-primary:#333; --border-color:#e0e0e0;
			--sidebar-width:250px; --green:#2ecc71; --red:#e74c3c; --orange:#e67e22; --blue:#3498db;
		}
		*{box-sizing:border-box;margin:0;padding:0}
		body{font-family:Inter,system-ui,Arial,sans-serif;background:#f8f9fa;color:var(--text-primary);font-size:14px}
		.app-container{display:flex;min-height:100vh}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;transition:transform .3s ease;z-index:1000}
		.sidebar.collapsed{transform:translateX(-100%)}
		.logo h2{font-size:1.05rem;text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1)}
		.menu{list-style:none;margin-top:1rem}
		.menu a{color:#fff;text-decoration:none;display:flex;align-items:center;gap:.5rem;font-size:.8rem;border-radius:6px;padding:.5rem .6rem}
		.menu a:hover,.menu a.active{background:var(--secondary-color)}
		/* Match project-list submenu behavior */
		.submenu{list-style:none;margin-left:.75rem;display:none;margin-top:.25rem}
		.menu-dropdown:hover .submenu{display:block}
		.submenu a{font-size:.75rem;padding:.45rem .65rem}
		/* Visibility rules to match project-list feature/role filtering */
		/* Hide ALL menu items by default - they stay hidden until authorization adds menu-visible class */
		#roleBasedMenu li{display:none !important}
		#roleBasedMenu li[data-feature]{display:none !important}
		#roleBasedMenu .menu-dropdown{display:none !important}
		#roleBasedMenu .submenu li{display:none !important}
		/* Only show items that have been authorized (menu-visible class added by JS) */
		#roleBasedMenu li.menu-visible{display:block !important}
		#roleBasedMenu .submenu li.menu-visible{display:list-item !important}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.5rem;transition:margin-left .3s ease}
		.main-content.sidebar-collapsed{margin-left:0}
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);position:sticky;top:0;z-index:20}
		.sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;color:#666;padding:.45rem;border-radius:6px}
		#headerCompanyLogo{width:40px;height:40px;border-radius:6px;object-fit:contain;display:none}
		#headerCompanyLogo.visible{display:block}
		#headerCompanyName{font-weight:600;color:var(--primary-color);font-size:.85rem}
		.page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.6rem .75rem;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14)}
		.page-header h1{margin:0;font-size:1.5rem;display:flex;align-items:center;gap:.75rem;color:#fff}
		.btn-add-new{background:var(--primary-color);color:#fff;border:1px solid var(--primary-color);padding:.6rem 1rem;border-radius:6px;text-decoration:none;font-size:.875rem;display:inline-flex;align-items:center;gap:.5rem;font-weight:500;transition:all .2s ease}
		.btn-add-new:hover{background:#1a252f;border-color:#1a252f;transform:translateY(-1px);box-shadow:0 4px 8px rgba(44,62,80,.2)}
		.btn{display:inline-block;padding:.4rem .8rem;border-radius:6px;border:1px solid transparent;font-size:.8rem;cursor:pointer;text-decoration:none}
		.btn-primary{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
		.btn-secondary{background:#6c757d;color:#fff;border-color:#6c757d}
		.btn-outline{background:transparent;color:#fff;border-color:rgba(255,255,255,.6)}
		.form-section{background:#fff;border:1px solid var(--border-color);border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
		.form-section h3{margin-bottom:10px;color:var(--primary-color);font-size:16px;border-bottom:1px solid #eee;padding-bottom:8px}
		.form-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:10px}
		.form-group{flex:1 1 260px}
		label{display:block;margin-bottom:4px;font-weight:600;font-size:.85rem}
		.form-control{width:100%;padding:10px;border:1px solid #ced4da;border-radius:6px;font-size:.9rem}
		textarea.form-control{min-height:90px;resize:vertical}
		select.form-control{cursor:pointer}
		/* Search functionality for assigned to field */
		.search-container{position:relative}
		.search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ced4da;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none}
		.search-result{padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s}
		.search-result:hover{background:#f8f9fa}
		.search-result:last-child{border-bottom:none}
		.search-result .user-name{font-weight:600;color:#333}
		.search-result .user-title{font-size:.8rem;color:#666;margin-top:2px}
		/* Action search results */
		.action-search-results{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ced4da;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none}
		/* Observation action search results */
		.obs-action-search-results{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ced4da;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none}
		.corrective-actions-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
		.corrective-actions-header h4{margin:0;font-size:1rem;color:var(--primary-color)}
		.btn-add-action{background:var(--primary-color);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:6px;transition:background .2s}
		.btn-add-action:hover{background:#1a252f}
		.corrective-action-item{background:#f8f9fa;border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:12px;position:relative}
		.corrective-action-item .action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
		.corrective-action-item .action-number{font-weight:600;color:var(--primary-color);font-size:.9rem}
		.btn-remove-action{background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:4px}
		.btn-remove-action:hover{background:#c0392b}
		.corrective-action-item .form-row{margin-bottom:10px}
		.corrective-action-item .form-group{margin-bottom:0}
		/* Action-only edit mode styles */
		.action-readonly{opacity:0.6;pointer-events:none;background:#f0f0f0 !important;border-color:#ccc !important}
		.action-readonly::before{content:'üîí Read Only';position:absolute;top:8px;right:8px;background:#6b7280;color:#fff;padding:2px 8px;border-radius:4px;font-size:.7rem}
		.action-editable-highlight{border:2px solid #10b981 !important;background:#f0fdf4 !important;box-shadow:0 0 12px rgba(16,185,129,0.3)}
		.action-editable-highlight::before{content:'‚úèÔ∏è Your Action - Editable';position:absolute;top:-12px;left:12px;background:#10b981;color:#fff;padding:2px 10px;border-radius:4px;font-size:.7rem;font-weight:500}
		.readonly-field{background:#f5f5f5 !important;color:#666 !important;cursor:not-allowed}
		.action-attachments{margin-top:10px}
		.action-attachments input[type="file"]{font-size:.85rem}
		.action-file-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
		.action-file-item{background:#fff;border:1px solid #ddd;padding:6px 10px;border-radius:4px;font-size:.8rem;display:flex;align-items:center;gap:6px}
		.action-file-item .remove-file{color:#e74c3c;cursor:pointer;font-size:.9rem}
		.no-actions-msg{color:#666;font-style:italic;text-align:center;padding:20px}
		/* Attachments Table Styles */
		.attachments-table{width:100%;border-collapse:collapse;font-size:.85rem;margin-top:12px}
		.attachments-table th{background:#f3f4f6;color:#374151;font-weight:600;text-align:left;padding:10px 12px;border:1px solid #e5e7eb;font-size:.8rem}
		.attachments-table td{padding:10px 12px;border:1px solid #e5e7eb;color:#1f2937;vertical-align:middle}
		.attachments-table tr:hover{background:#f9fafb}
		.attachments-empty{text-align:center;padding:30px;color:#9ca3af;font-size:.85rem}
		.attachments-empty i{font-size:2rem;margin-bottom:8px;display:block;color:#d1d5db}
		.attachment-preview img{width:40px;height:40px;object-fit:cover;border-radius:4px}
		.attachment-preview i{font-size:1.5rem;color:#64748b}
		.attachment-name-display{flex:1;word-break:break-all}
		.attachment-name-input{flex:1;padding:0.35rem;border:1px solid #d1d5db;border-radius:4px;font-size:.85rem}
		.attachment-name-input.hidden{display:none}
		.attachment-name-display.hidden{display:none}
		.btn-icon{background:none;border:1px solid #e5e7eb;cursor:pointer;padding:0.25rem 0.4rem;border-radius:4px;margin-right:0.25rem}
		.btn-icon:hover{background:#f3f4f6}
		/* Checkbox toggle fields */
		.checkbox-toggle{display:flex;align-items:center;gap:8px;margin-bottom:8px}
		.checkbox-toggle input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
		.checkbox-toggle label{font-weight:600;cursor:pointer;margin:0}
		.toggle-fields{display:none;padding:12px;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:6px;margin-top:8px}
		.toggle-fields.visible{display:block}
		/* Injured Persons Dynamic Section */
		.injured-persons-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
		.injured-persons-header h5{margin:0;font-size:.9rem;color:#374151;font-weight:600}
		.btn-add-injured{background:var(--primary-color);color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:5px;transition:background .2s}
		.btn-add-injured:hover{background:#1a252f}
		.injured-person-item{background:#fff;border:1px solid #d1d5db;border-radius:8px;padding:14px;margin-bottom:10px;position:relative}
		.injured-person-item .person-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
		.injured-person-item .person-number{font-weight:600;color:var(--primary-color);font-size:.85rem}
		.btn-remove-injured{background:#e74c3c;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px}
		.btn-remove-injured:hover{background:#c0392b}
		.injured-person-item .form-row{margin-bottom:8px}
		.injured-person-item .form-group{margin-bottom:0}
		.no-injured-msg{color:#6b7280;font-style:italic;text-align:center;padding:16px;font-size:.85rem}
		/* Property Damage Dynamic Section */
		.property-damage-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
		.property-damage-header h5{margin:0;font-size:.9rem;color:#374151;font-weight:600}
		.btn-add-damage{background:var(--primary-color);color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:5px;transition:background .2s}
		.btn-add-damage:hover{background:#1a252f}
		.property-damage-item{background:#fff;border:1px solid #d1d5db;border-radius:8px;padding:14px;margin-bottom:10px;position:relative}
		.property-damage-item .damage-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
		.property-damage-item .damage-number{font-weight:600;color:var(--primary-color);font-size:.85rem}
		.btn-remove-damage{background:#e74c3c;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px}
		.btn-remove-damage:hover{background:#c0392b}
		.property-damage-item .form-row{margin-bottom:8px}
		.property-damage-item .form-group{margin-bottom:0}
		.no-damage-msg{color:#6b7280;font-style:italic;text-align:center;padding:16px;font-size:.85rem}
		.action-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
		.notifications{position:relative}
		/* Notifications (match project-list) */
		.notifications{position:relative;display:flex;align-items:center}
		.notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.2rem;padding:.5rem;display:flex;align-items:center;justify-content:center;color:#555}
		.notification-badge{position:absolute;top:-5px;right:-5px;background:#e74c3c;color:#fff;border-radius:50%;padding:.15rem .45rem;font-size:.7rem;display:none}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:320px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:1000;border:1px solid #e9ecef;max-height:400px;overflow:hidden}
		.notification-dropdown.show{display:block;animation:slideDown .2s ease-out}
		@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
		.notification-header{padding:12px 16px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%);display:flex;justify-content:space-between;align-items:center}
		.notification-header h3{margin:0;color:#333;font-size:14px;font-weight:600}
		.mark-all-read{background:none;border:none;color:#3498db;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px}
		.mark-all-read:hover{background:#e3f2fd;color:#1976d2}
		.notification-list{max-height:320px;overflow-y:auto;padding:0}
		.notification-list::-webkit-scrollbar{width:4px}
		.notification-list::-webkit-scrollbar-track{background:#f1f1f1}
		.notification-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:2px}
		.notification-item{padding:12px 16px;border-bottom:1px solid #f1f1f1;cursor:pointer;transition:background-color .2s ease;position:relative}
		.notification-item:hover{background:#f8f9fa}
		.notification-item.unread{background:#e8f4fd;border-left:3px solid #3498db}
		.notification-empty{padding:40px 20px;text-align:center;color:#999;display:none}
		.notification-empty i{font-size:32px;margin-bottom:12px;color:#ddd}
		.notification-empty-title{font-size:14px;font-weight:500;margin-bottom:4px;color:#666}
		.notification-empty-message{font-size:12px;color:#999}
		.user-profile{position:relative}
		.user-profile img{width:38px;height:38px;border-radius:50%;object-fit:cover}
		/* Match project-list avatar button styling */
		.profile-btn{background:none;border:none;border-radius:50%;overflow:hidden;width:38px;height:38px;cursor:pointer}
		.profile-btn img{width:100%;height:100%;object-fit:cover}
		/* User profile dropdown (match project-list) */
		.profile-dropdown{display:none;position:absolute;right:0;top:110%;background:#fff;border-radius:8px;min-width:200px;box-shadow:0 6px 18px rgba(0,0,0,0.12);overflow:hidden;border:1px solid #e9ecef;z-index:1000}
		.profile-dropdown.show{display:block}
		.profile-dropdown ul{list-style:none;margin:0;padding:0}
		.profile-dropdown li a{display:block;padding:.65rem .85rem;font-size:.72rem;text-decoration:none;color:#1e293b;font-weight:500}
		.profile-dropdown li a:hover{background:#f1f5f9}
		.file-list{list-style:none;margin:10px 0 0;padding:0}
		.file-item{display:flex;align-items:center;gap:10px;background:#f9f9f9;border:1px solid #eee;border-radius:6px;padding:8px 10px;margin-bottom:8px}
		.file-actions button{background:none;border:none;cursor:pointer}
		.file-actions .delete-file{color:#dc3545}
		.tag{display:inline-block;padding:.12rem .5rem;border-radius:999px;font-size:.75rem;color:#fff}
		.tag.low{background:#2ecc71}.tag.medium{background:#f39c12}.tag.high{background:#e74c3c}
		@media (max-width: 900px) { 
			.main-content { 
				margin-left: 0; 
			} 
			.sidebar { 
				transform: translateX(-100%); 
			} 
			.sidebar.open { 
				transform: translateX(0); 
			} 
		}
		@media(max-width:768px){
			.form-row{flex-direction:column}
			
			/* Mobile app view optimizations */
			body { font-size: 13px; }
			.main-content { padding: 0.25rem !important; }
			
			/* Page header */
			.page-header { 
				padding: 0.5rem 0.75rem; 
				margin: 0.25rem 0;
			}
			.page-header h1 { font-size: 1rem; }
			.btn-add-new { padding: 0.4rem 0.6rem; font-size: 0.75rem; }
			
			/* Top nav */
			.top-nav { padding: 0.4rem 0.5rem; }
			#headerCompanyLogo { width: 32px; height: 32px; }
			#headerCompanyName { font-size: 0.75rem; }
			
			/* Form sections */
			.form-section { 
				padding: 10px; 
				margin-bottom: 8px; 
				border-radius: 6px;
			}
			.form-section h3 { 
				font-size: 0.85rem; 
				margin-bottom: 8px; 
				padding-bottom: 6px;
			}
			
			/* Form rows - stack vertically */
			.form-row { 
				gap: 8px; 
				margin-bottom: 8px;
			}
			.form-group { 
				flex: 1 1 100% !important; 
				margin-bottom: 0;
			}
			
			/* Labels and inputs */
			label { 
				font-size: 0.75rem; 
				margin-bottom: 3px;
			}
			.form-control { 
				padding: 8px; 
				font-size: 0.8rem; 
			}
			textarea.form-control { 
				min-height: 70px; 
			}
			
			/* Action buttons */
			.action-buttons { 
				flex-wrap: wrap; 
				gap: 6px;
				justify-content: stretch;
			}
			.action-buttons .btn { 
				flex: 1 1 calc(50% - 3px); 
				text-align: center;
				font-size: 0.75rem;
				padding: 0.5rem 0.4rem;
			}
			
			/* Corrective actions section */
			.corrective-actions-header { margin-bottom: 8px; }
			.corrective-actions-header h4 { font-size: 0.85rem; }
			.btn-add-action { 
				padding: 6px 10px; 
				font-size: 0.75rem; 
			}
			.corrective-action-item { 
				padding: 10px; 
				margin-bottom: 8px;
			}
			.corrective-action-item .action-header { margin-bottom: 8px; }
			.corrective-action-item .action-number { font-size: 0.8rem; }
			.btn-remove-action { 
				padding: 4px 8px; 
				font-size: 0.7rem; 
			}
			
			/* Injured persons */
			.injured-persons-header h5 { font-size: 0.8rem; }
			.btn-add-injured { 
				padding: 5px 10px; 
				font-size: 0.7rem; 
			}
			.injured-person-item { 
				padding: 10px; 
				margin-bottom: 8px;
			}
			.injured-person-item .person-number { font-size: 0.75rem; }
			.btn-remove-injured { 
				padding: 4px 8px; 
				font-size: 0.65rem; 
			}
			
			/* Property damage */
			.property-damage-header h5 { font-size: 0.8rem; }
			.btn-add-damage { 
				padding: 5px 10px; 
				font-size: 0.7rem; 
			}
			.property-damage-item { 
				padding: 10px; 
				margin-bottom: 8px;
			}
			.property-damage-item .damage-number { font-size: 0.75rem; }
			.btn-remove-damage { 
				padding: 4px 8px; 
				font-size: 0.65rem; 
			}
			
			/* Attachments table */
			.attachments-table { font-size: 0.7rem; }
			.attachments-table th, .attachments-table td { padding: 6px 8px; }
			.attachment-preview img { width: 30px; height: 30px; }
			
			/* Checkbox toggle */
			.checkbox-toggle { gap: 6px; }
			.checkbox-toggle input[type="checkbox"] { width: 16px; height: 16px; }
			.checkbox-toggle label { font-size: 0.75rem; }
			.toggle-fields { padding: 8px; margin-top: 6px; }
			
			/* Search results */
			.search-dropdown, .action-search-results, .obs-action-search-results {
				max-height: 150px;
			}
			.search-result { padding: 8px; }
			.search-result .user-name { font-size: 0.8rem; }
			.search-result .user-title { font-size: 0.7rem; }
			
			/* Notifications */
			.notification-dropdown { 
				width: calc(100vw - 1rem); 
				max-width: 300px; 
				right: -50px;
			}
			
			/* Tags */
			.tag { font-size: 0.65rem; padding: 0.1rem 0.4rem; }
		}
		
		/* Extra small screens */
		@media (max-width: 480px) {
			.main-content { padding: 0.15rem !important; }
			.form-section { padding: 8px; margin-bottom: 6px; }
			.form-section h3 { font-size: 0.8rem; }
			label { font-size: 0.7rem; }
			.form-control { padding: 6px; font-size: 0.75rem; }
			.page-header h1 { font-size: 0.9rem; }
			.action-buttons .btn { 
				flex: 1 1 100%; 
				font-size: 0.7rem;
			}
		}
	</style>
</head>
<body>
<div class="app-container">
	<nav class="sidebar menu-loading" id="sidebar">
		<div class="logo"><h2>Dreamex Datalab</h2></div>
		<ul class="menu" id="roleBasedMenu">
			<li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
			<li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
			<!-- Risk Management (separate section) -->
			<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
				<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
			<ul class="submenu">
				<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
				<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
			</ul>
			</li>
			<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
				<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
				<ul class="submenu">
					<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
					<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
					<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
					<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
					<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
					<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
					<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
					<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
					<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
					<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
					<li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
					<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
					<li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
					<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
					<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
					<li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
					<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
					<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
					<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
					<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
					<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
					<li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
					<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
					<li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
				</ul>
			</li>
			<!-- Project Management as section button with submenu -->
			<li class="menu-dropdown" data-feature="project_management_section">
				<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
				<ul class="submenu">
					<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
					<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
					<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
					<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
				</ul>
			</li>
			<!-- Inventory Management as section button with submenu -->
			<li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
				<a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
				<ul class="submenu">
					<li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
					<li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
					<li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
					<li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
					<li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
					<li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
				</ul>
			</li>
			<!-- Workspaces: Catering -->
			<li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
				<a href="#"><i class="fas fa-utensils"></i> Workspaces ‚Äî Catering</a>
				<ul class="submenu">
					<li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
					<li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
					<li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
					<li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
					<li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
				</ul>
			</li>
			<li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
			<li class="menu-item" data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
			<li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
					<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
					<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
					<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
					<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
					<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
					<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
					<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
					<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
					<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
	</nav>

	<main class="main-content" id="mainContent">
		<header class="top-nav">
			<div style="display:flex;align-items:center;gap:.7rem">
				<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
				<img id="headerCompanyLogo" alt="Company Logo"/>
				<span id="headerCompanyName"></span>
			</div>
			<div style="display:flex;align-items:center;gap:1rem;position:relative">
				<div class="lang-switcher" style="display:flex;align-items:center;gap:.5rem;">
					<button id="langToggleBtn" type="button" title="Language" aria-label="Language"
						style="width:36px;height:36px;border-radius:50%;border:1px solid #e5e7eb;background:#ffffff;color:#111827;display:inline-flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,0.06);cursor:pointer;transition:background .15s,transform .05s;">
						EN
					</button>
					<select id="langSelect" title="Language" style="display:none;">
						<option value="en">English</option>
						<option value="fr">Fran√ßais</option>
					</select>
				</div>
				<div class="notifications">
					<button id="notificationBtn" class="notification-btn">
						<i class="fas fa-bell"></i>
						<span class="notification-badge">0</span>
					</button>
					<div class="notification-dropdown">
						<div class="notification-header">
							<h3>Notifications</h3>
							<button class="mark-all-read" type="button">Mark all as read</button>
						</div>
						<div class="notification-list">
							<div class="notification-empty">
								<i class="fas fa-inbox"></i>
								<div class="notification-empty-title">No notifications</div>
								<div class="notification-empty-message">You're all caught up</div>
							</div>
						</div>
					</div>
				</div>
				<div class="user-profile"><button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar"/></button><div class="profile-dropdown"><ul></ul></div></div>
			</div>
		</header>

		<div class="page-header">
			<h1><i class="fas fa-exclamation-triangle"></i> Report Incident</h1>
			<a href="incidentboard.html" class="btn-add-new">
				<i class="fas fa-table-list"></i>
			</a>
		</div>

		<form id="incidentForm">
			<input type="hidden" id="incidentId"/>
			<div class="form-section">
				<h3>Basic Information</h3>
				<div class="form-row">
					<div class="form-group">
						<label for="referenceNumber">Reference</label>
						<input id="referenceNumber" class="form-control" placeholder="Auto-generated" readonly/>
					</div>
					<div class="form-group">
						<label for="incidentTitle">Title *</label>
						<input id="incidentTitle" class="form-control" required placeholder="Brief title"/>
					</div>
					<div class="form-group">
						<label for="severity">Severity *</label>
						<select id="severity" class="form-control" required>
							<option value="">Select Severity</option>
							<option value="low">Low</option>
							<option value="medium">Medium</option>
							<option value="high">High</option>
						</select>
					</div>
					<div class="form-group">
						<label for="eventType">Event Type</label>
						<select id="eventType" class="form-control">
							<option value="">Select Event Type</option>
							<option value="near-miss">Near Miss</option>
							<option value="observation">Observation</option>
							<option value="incident">Incident</option>
						</select>
					</div>
				</div>
				<div class="form-row">
					<div class="form-group">
						<label for="incidentDateTime">Date & Time *</label>
						<input type="datetime-local" id="incidentDateTime" class="form-control" required/>
					</div>
					<div class="form-group">
						<label for="incidentStatus">Status</label>
						<select id="incidentStatus" class="form-control">
							<option value="open">Open</option>
							<option value="in-progress">In Progress</option>
							<option value="closed">Closed</option>
							<option value="draft">Draft</option>
						</select>
					</div>
					<div class="form-group">
						<label for="eventLocation">Location *</label>
						<select id="eventLocation" class="form-control" required>
							<option value="">Select Location</option>
						</select>
					</div>
					<div class="form-group">
						<label for="department">Department *</label>
						<select id="department" class="form-control" required>
							<option value="">Select Department</option>
						</select>
					</div>
					<div class="form-group">
						<label for="assignedTo">Assigned To</label>
						<div class="search-container">
							<input type="text" id="userSearch" class="form-control" placeholder="Type to search employee..." autocomplete="off">
							<input type="hidden" id="assignedTo">
							<div id="searchResults" class="search-dropdown"></div>
						</div>
					</div>
					<div class="form-group">
						<label>Reported By</label>
						<input id="reportedByName" class="form-control" readonly/>
						<input type="hidden" id="reportedById"/>
					</div>
					<div class="form-group">
						<label>Date Reported</label>
						<input id="dateReported" class="form-control" readonly/>
					</div>
				</div>
			</div>

			<div class="form-section" id="eventSpecificSection">
				<h3>Event-specific Details</h3>
				
				<!-- Common fields for all event types -->
				<div id="commonFields">
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="description">Description *</label>
							<textarea id="description" class="form-control" required placeholder="Describe what happened"></textarea>
						</div>
					</div>
				</div>
				
				<!-- Incident-specific common fields (Category, Injury, Property Damage) -->
				<div id="incidentCommonFields" style="display:none">
					<div class="form-row">
						<div class="form-group">
							<label for="incidentCategory">Incident Category</label>
							<select id="incidentCategory" class="form-control">
								<option value="">Select Category</option>
							</select>
						</div>
					</div>
					
					<!-- Injury Checkbox Toggle -->
					<div class="form-group">
						<div class="checkbox-toggle">
							<input type="checkbox" id="hasInjury" onchange="toggleInjuryFields()">
							<label for="hasInjury">Injury Occurred</label>
						</div>
						<div id="injuryFields" class="toggle-fields">
							<div class="injured-persons-header">
								<h5><i class="fas fa-user-injured"></i> Injured Persons</h5>
								<button type="button" class="btn-add-injured" onclick="addInjuredPerson()">
									<i class="fas fa-plus"></i> Add Person
								</button>
							</div>
							<div id="injuredPersonsList">
								<div class="no-injured-msg">No injured persons added. Click "Add Person" to add one.</div>
							</div>
						</div>
					</div>
					
					<!-- Property Damage Checkbox Toggle -->
					<div class="form-group">
						<div class="checkbox-toggle">
							<input type="checkbox" id="hasPropertyDamage" onchange="togglePropertyDamageFields()">
							<label for="hasPropertyDamage">Property Damage Occurred</label>
						</div>
						<div id="propertyDamageFields" class="toggle-fields">
							<div class="property-damage-header">
								<h5><i class="fas fa-building"></i> Damaged Items</h5>
								<button type="button" class="btn-add-damage" onclick="addPropertyDamageItem()">
									<i class="fas fa-plus"></i> Add Item
								</button>
							</div>
							<div id="propertyDamageList">
								<div class="no-damage-msg">No damaged items added. Click "Add Item" to add one.</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Actions fields (shown for incidents and near-misses) -->
				<div id="actionsFields" style="display:none">
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="immediateActions">Immediate Actions</label>
							<textarea id="immediateActions" class="form-control" placeholder="Actions taken immediately"></textarea>
						</div>
					</div>
					
					<!-- Corrective Actions Dynamic Section -->
					<div class="corrective-actions-section">
						<div class="corrective-actions-header">
							<h4><i class="fas fa-tasks"></i> Corrective Actions</h4>
							<button type="button" class="btn-add-action" onclick="addCorrectiveAction()">
								<i class="fas fa-plus"></i> Add Action
							</button>
						</div>
					<div id="correctiveActionsList">
						<div class="no-actions-msg">No corrective actions added. Click "Add Action" to create one.</div>
					</div>
				</div>
				
				<div id="dueDateField" class="form-row">
					<div class="form-group">
						<label for="dueDate">Due Date</label>
						<input type="date" id="dueDate" class="form-control"/>
					</div>
				</div>
			</div>				<!-- Near Miss Fields -->
				<div id="nearMissFields" style="display:none">
					<!-- Near miss fields removed as requested -->
				</div>

				<!-- Observation Fields -->
				<div id="observationFields" style="display:none">
					<div class="form-row">
						<div class="form-group">
							<label for="obsType">Observation Type *</label>
							<select id="obsType" class="form-control">
								<option value="">Select</option>
								<option value="safe">Safe</option>
								<option value="at-risk">At-Risk</option>
							</select>
						</div>
						<div class="form-group">
							<label for="obsCategory">Category *</label>
							<select id="obsCategory" class="form-control">
								<option value="">Select</option>
								<option value="behavior">Behavior</option>
								<option value="condition">Condition</option>
							</select>
						</div>
					</div>
					
					<!-- Person Involved Checkbox Toggle -->
					<div class="form-group">
						<div class="checkbox-toggle">
							<input type="checkbox" id="obsHasPersonInvolved" onchange="toggleObsPersonInvolved()">
							<label for="obsHasPersonInvolved">Person Involved</label>
						</div>
						<div id="obsPersonInvolvedFields" class="toggle-fields">
							<div id="obsPersonsList">
								<div class="no-actions-msg">No persons added. Click "Add Person" to add one.</div>
							</div>
							<button type="button" class="btn-add-action" onclick="addObsPerson()" style="margin-top:10px">
								<i class="fas fa-plus"></i> Add Person
							</button>
						</div>
					</div>
					
					<!-- Equipment Involved Checkbox Toggle -->
					<div class="form-group"> 
						<div class="checkbox-toggle">
							<input type="checkbox" id="obsHasEquipmentInvolved" onchange="toggleObsEquipmentInvolved()">
							<label for="obsHasEquipmentInvolved">Equipment Involved</label>
						</div>
						<div id="obsEquipmentInvolvedFields" class="toggle-fields">
							<div id="obsEquipmentList">
								<div class="no-actions-msg">No equipment added. Click "Add Equipment" to add one.</div>
							</div>
							<button type="button" class="btn-add-action" onclick="addObsEquipment()" style="margin-top:10px">
								<i class="fas fa-plus"></i> Add Equipment
							</button>
						</div>
					</div>
					
					<!-- Observation Corrective Actions -->
					<div class="form-group">
						<label style="font-weight:600; margin-bottom:10px; display:block;">Corrective Actions</label>
						<div id="obsCorrectiveActionsList">
							<div class="no-actions-msg">No corrective actions added. Click "Add Corrective Action" to add one.</div>
						</div>
						<button type="button" class="btn-add-action" onclick="addObsCorrectiveAction()" style="margin-top:10px">
							<i class="fas fa-plus"></i> Add Corrective Action
						</button>
					</div>
				</div>

				<!-- Incident-only extra fields -->
				<div id="incidentFields" style="display:none">
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="incRootCause">Root Cause *</label>
							<textarea id="incRootCause" class="form-control" placeholder="Root cause analysis"></textarea>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group" style="flex:1 1 100%">
							<label for="incContributingFactors">Contributing Factors</label>
							<textarea id="incContributingFactors" class="form-control" placeholder="List factors contributing to the incident"></textarea>
						</div>
					</div>
				</div>
			</div>

			<div class="form-section">
				<h3 style="display:flex;align-items:center;justify-content:space-between">
					<span><i class="fas fa-paperclip" style="margin-right:8px"></i>Attachments</span>
					<label class="btn btn-secondary" style="display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;padding:6px 12px">
						<i class="fas fa-plus"></i> Add Files
						<input type="file" id="fileUpload" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" style="display:none"/>
					</label>
				</h3>
				<small style="color:#666;display:block;margin-bottom:10px">Max 5MB each. You can rename files before saving.</small>
				<table class="attachments-table" id="attachmentsTable" style="display:none">
					<thead>
						<tr>
							<th style="width:50px">Preview</th>
							<th>File Name</th>
							<th style="width:80px">Type</th>
							<th style="width:80px">Size</th>
							<th style="width:100px">Actions</th>
						</tr>
					</thead>
					<tbody id="attachmentsTableBody"></tbody>
				</table>
				<div id="attachmentsEmpty" class="attachments-empty">
					<i class="fas fa-folder-open"></i>
					<p>No files uploaded yet</p>
				</div>
			</div>

			<div class="action-buttons">
				<button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
				<button type="button" id="saveDraftBtn" class="btn btn-secondary">Save Draft</button>
				<button type="submit" id="submitBtn" class="btn btn-primary">Submit Incident</button>
			</div>
		</form>
	</main>
</div>

<!-- Firebase v8 Scripts for Centralized Authentication (match project-list) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<!-- EmailJS for notifications -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
// Firebase configuration (match project-list centralized auth)
const firebaseConfig = {
	apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
	authDomain: "users-8be65.firebaseapp.com",
	databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
	projectId: "users-8be65",
	storageBucket: "users-8be65.firebasestorage.app",
	messagingSenderId: "909025468149",
	appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
	measurementId: "G-XHFMRCJQEZ"
};
function initializeFirebase(){
	if(!window.firebase || !window.firebase.apps || window.firebase.apps.length===0){
		window.firebase.initializeApp(firebaseConfig);
	}
	return window.firebase;
}
const firebase = initializeFirebase();
const db = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// Centralized AuthManager (copied to match project-list)
class AuthManager{
	constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; this.init(); }
	getCurrentUser(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch{ return null; } }
	setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
	async init(){ if(!this.currentUser){ window.location.href='login.html'; return; } await this.loadUserCompany(); this.updateCompanyBranding(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); }
	async loadUserCompany(){ if(!this.currentUser) return; try{ const snap=await firebase.database().ref('companies').once('value'); if(!snap.exists()) return; const companies=snap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users){ for(const [uid,u] of Object.entries(comp.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId=cid; this.currentUser.companyName=comp.companyName; this.currentUser.role=u.role||u.userRole||'user'; this.currentCompany=comp; this.setCurrentUser(this.currentUser); return; } } } } }catch(e){} }
	updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ this.showFallbackBranding(); return; } if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
	showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); } }
	getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
	generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
	getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
	getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
	async getUserAvatarUrl(){ if(!this.currentUser) return null; const companyId=this.currentUser.companyId||'default'; const paths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`]; for(const p of paths){ try{ const ref=firebase.storage().ref(p); const url=await ref.getDownloadURL(); return url; }catch(err){ continue; } } return null; }
	async updateUIForAuthenticatedUser(){ const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.currentUser.email||''; let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); }catch(e){} const btnImg=btn.querySelector('img'); if(avatarUrl&&btnImg){ btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }; } else { btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }
		const avatarHtml= avatarUrl? `<img src=\"${avatarUrl}\" alt=\"${displayName} Avatar\" style=\"width:32px;height:32px;border-radius:50%;object-fit:cover;\">` : `<div style=\"width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;\">${this.getUserInitials()}</div>`; list.innerHTML=`<li style=\"border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;\"><div style=\"display:flex;align-items:center;gap:12px;\">${avatarHtml}<div><div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${displayName}</div><div style=\"color:#666;font-size:12px;\">${email}</div></div></div></li><li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`; list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); }); }
	bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click', e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click', e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
	async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; }catch(error){ console.error('Logout error:',error); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } }
}

function bindSidebarToggle(){
	const btn=document.getElementById('sidebarToggle'), sidebar=document.getElementById('sidebar'), main=document.getElementById('mainContent');
	if(!btn||!sidebar||!main)return;
	btn.addEventListener('click',()=>{ 
		const isMobile = window.innerWidth <= 900;
		if (isMobile) {
			sidebar.classList.toggle('open');
		} else {
			sidebar.classList.toggle('collapsed');
			main.classList.toggle('sidebar-collapsed');
		}
	});
}
function svgInitials(name='U'){ const initials=(name.trim().split(/\s+/).slice(0,2).map(p=>p[0]).join('')||'U').toUpperCase(); const svg=`<svg width="38" height="38" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="#3498db"/><text x="20" y="25" text-anchor="middle" fill="#fff" font-size="14" font-weight="600" font-family="Inter, Arial, sans-serif">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
function setBranding(company){ const logo=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=company?.companyName||''; if(logo){ if(company?.logo||company?.logoUrl){ logo.src=company.logo||company.logoUrl; logo.classList.add('visible'); } else { logo.src=svgInitials(company?.companyName||'DX'); logo.classList.add('visible'); } } if(company?.branding){ const root=document.documentElement; if(company.branding.primaryColor) root.style.setProperty('--primary-color',company.branding.primaryColor); if(company.branding.secondaryColor) root.style.setProperty('--secondary-color',company.branding.secondaryColor); } }
// Avatar helpers copied to match project-list behavior
function getUserDisplayName(u){ if(!u) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[u.displayName,u.name,u.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(u.email){ return n(u.email.split('@')[0])||'User'; } return 'User'; }
function getUserInitials(u){ const dn=getUserDisplayName(u); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
async function getUserAvatarUrl(u){ if(!u) return null; const companyId = (await getCompanyIdFor(u.uid)) || 'default'; const possible=[`companies/${companyId}/avatars/${u.uid}/profile.jpg`,`companies/${companyId}/avatars/${u.uid}/profile.png`,`companies/${companyId}/avatars/${u.uid}/profile.jpeg`,`companies/${companyId}/avatars/${u.uid}/avatar.jpg`,`companies/${companyId}/avatars/${u.uid}/avatar.png`,`avatars/${u.uid}/profile.jpg`,`avatars/${u.uid}/profile.png`,`avatars/${u.uid}/avatar.jpg`,`avatars/${u.uid}/avatar.png`,`profiles/${u.uid}/profile.jpg`,`profiles/${u.uid}/profile.png`]; for(const path of possible){ try{ const ref=storage.ref(path); const url=await ref.getDownloadURL(); return url; }catch(e){ /* try next */ } } return null; }
async function getCompanyIdFor(uid){ const snap=await db.ref('users/'+uid).once('value'); const u=snap.val()||{}; return u.companyId||u.companyID||u.company||u.company_id||null; }
async function getCompany(companyId){ if(!companyId) return null; const snap=await db.ref('companies/'+companyId).once('value'); const c=snap.val()||null; if(c) c.companyId=companyId; return c; }
function formatBytes(b){ if(!b) return '0B'; const u=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(2)+' '+u[i]; }

// Ensure filenames are safe for Firebase Storage paths
function sanitizeFileName(name){
	if(!name) return 'file';
	// Remove path components and replace invalid characters # [ ] * ? \ ^ $ { } | < > % ` with '-'
	const base=name.split('/').pop().split('\\').pop();
	const cleaned=base.replace(/[\n\r\t]/g,' ').replace(/[#\[\]*?\\^${}|<>%`]/g,'-');
	// Collapse spaces and trim
	const collapsed=cleaned.replace(/\s+/g,' ').trim();
	// Limit filename length to 80 chars to avoid overly long paths
	return collapsed.slice(0,80) || 'file';
}

// Convert File to data URL for storing in Realtime Database
function fileToDataUrl(file){
	return new Promise((resolve, reject)=>{
		const reader=new FileReader();
		reader.onload=()=>resolve(reader.result);
		reader.onerror=reject;
		reader.readAsDataURL(file);
	});
}

// Helpers for datetime-local input
function toLocalDateTimeInputValue(d){ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function getDateTimeParts(){
	const el=document.getElementById('incidentDateTime');
	const v=el?.value||'';
	if(v){ const [date, timeFull]=v.split('T'); const time=(timeFull||'').slice(0,5); return { date, time, iso:v }; }
	const now=new Date();
	const iso=toLocalDateTimeInputValue(now);
	return { date: iso.slice(0,10), time: iso.slice(11,16), iso };
}

// Remove undefined properties to avoid Firebase update errors
function sanitizeAttachmentFields(obj){
	const allowed=['name','size','contentType','dataUrl','url','path','uploadedAt'];
	const out={};
	for(const k of allowed){ if(obj && obj[k] !== undefined) out[k]=obj[k]; }
	return out;
}

// Utility: compact object by removing undefined, null, and empty-string values
function compactObject(obj){
	if(!obj || typeof obj!== 'object') return obj;
	const out={};
	for(const [k,v] of Object.entries(obj)){
		if(v===undefined || v===null) continue;
		if(typeof v==='string' && v.trim()==='') continue;
		out[k]=v;
	}
	return out;
}

function setRequired(id, required){ const el=document.getElementById(id); if(!el) return; if(required){ el.setAttribute('required','required'); } else { el.removeAttribute('required'); } }
function show(el, on){ if(!el) return; el.style.display=on? 'block':'none'; }

// Injury and Property Damage Toggle Functions
let injuredPersonsCounter = 0;
let injuredPersons = [];

function toggleInjuryFields() {
	const checkbox = document.getElementById('hasInjury');
	const fieldsDiv = document.getElementById('injuryFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
	} else {
		fieldsDiv.classList.remove('visible');
		// Clear all injured persons when unchecked
		clearAllInjuredPersons();
	}
}

function addInjuredPerson(data = null) {
	injuredPersonsCounter++;
	const personId = injuredPersonsCounter;
	
	const container = document.getElementById('injuredPersonsList');
	const noMsg = container.querySelector('.no-injured-msg');
	if (noMsg) noMsg.remove();
	
	const personDiv = document.createElement('div');
	personDiv.className = 'injured-person-item';
	personDiv.id = `injuredPerson_${personId}`;
	personDiv.innerHTML = `
		<div class="person-header">
			<span class="person-number"><i class="fas fa-user-injured"></i> ${incidentT('person_number', personId)}</span>
			<button type="button" class="btn-remove-injured" onclick="removeInjuredPerson(${personId})">
				<i class="fas fa-trash"></i> ${incidentT('remove')}
			</button>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('injured_person_label')}</label>
				<input type="text" class="form-control injured-person-name" placeholder="${incidentT('injured_person_placeholder')}" value="${data?.name || ''}" required>
			</div>
			<div class="form-group">
				<label>${incidentT('injury_type_label')}</label>
				<select class="form-control injured-person-type" required>
					<option value="">${incidentT('select_injury_type')}</option>
					${getInjuryTypeOptions(data?.injuryType || '')}
				</select>
			</div>
			<div class="form-group">
				<label>${incidentT('body_part_label')}</label>
				<select class="form-control injured-person-bodypart">
					<option value="">${incidentT('select_body_part')}</option>
					${getBodyPartOptions(data?.bodyPart || '')}
				</select>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('treatment_label')}</label>
				<select class="form-control injured-person-treatment">
					<option value="">${incidentT('select_treatment')}</option>
					${getTreatmentOptions(data?.treatment || '')}
				</select>
			</div>
			<div class="form-group">
				<label>${incidentT('lost_time_label')}</label>
				<select class="form-control injured-person-losttime" onchange="togglePersonLostTimeDays(${personId})">
					<option value="">${incidentT('select')}</option>
					<option value="yes" ${data?.lostTime === 'yes' ? 'selected' : ''}>${incidentT('yes')}</option>
					<option value="no" ${data?.lostTime === 'no' ? 'selected' : ''}>${incidentT('no')}</option>
				</select>
			</div>
			<div class="form-group injured-person-dayslost-group" style="display:${data?.lostTime === 'yes' ? 'block' : 'none'}">
				<label>${incidentT('days_lost_label')}</label>
				<input type="number" min="0" class="form-control injured-person-dayslost" placeholder="${incidentT('days_lost_placeholder')}" value="${data?.daysLost || ''}">
			</div>
		</div>
	`;
	
	container.appendChild(personDiv);
	injuredPersons.push({ id: personId });
}

function getInjuryTypeOptions(selectedValue) {
	const injuryTypeSelect = document.querySelector('#incidentCategory')?.closest('.form-section')?.querySelector('select[id="incidentCategory"]');
	// Get options from settings if loaded
	if (window.injuryTypeOptions && window.injuryTypeOptions.length > 0) {
		return window.injuryTypeOptions.map(opt => 
			`<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`
		).join('');
	}
	return '';
}

function getTreatmentOptions(selectedValue) {
	if (window.treatmentOptions && window.treatmentOptions.length > 0) {
		return window.treatmentOptions.map(opt => 
			`<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`
		).join('');
	}
	// Default options
	const defaults = ['First Aid', 'Medical Treatment', 'Hospitalization', 'None Required'];
	return defaults.map(opt => 
		`<option value="${opt.toLowerCase().replace(/\s+/g, '-')}" ${opt.toLowerCase().replace(/\s+/g, '-') === selectedValue ? 'selected' : ''}>${opt}</option>`
	).join('');
}

function getBodyPartOptions(selectedValue) {
	// Prefer company-configured list if available
	if (window.bodyPartOptions && window.bodyPartOptions.length > 0) {
		return window.bodyPartOptions.map(opt => `
			<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>
		`).join('');
	}
	// Fallback comprehensive default list
	const defaults = [
		'Head','Neck','Shoulder','Arm','Elbow','Wrist','Hand/Fingers','Chest','Upper Back','Lower Back','Abdomen',
		'Hip','Thigh','Knee','Shin','Calf','Ankle','Foot/Toes','Eye','Ear','Nose','Mouth','Spine','Multiple','Other'
	];
	return defaults.map(opt => `
		<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>
	`).join('');
}

function removeInjuredPerson(personId) {
	const personDiv = document.getElementById(`injuredPerson_${personId}`);
	if (personDiv) {
		personDiv.remove();
		injuredPersons = injuredPersons.filter(p => p.id !== personId);
		
		const container = document.getElementById('injuredPersonsList');
		if (container.children.length === 0) {
			container.innerHTML = `<div class="no-injured-msg">${incidentT('no_injured_persons')}</div>`;
		}
	}
}

function clearAllInjuredPersons() {
	const container = document.getElementById('injuredPersonsList');
	if (container) {
		container.innerHTML = `<div class="no-injured-msg">${incidentT('no_injured_persons')}</div>`;
	}
	injuredPersonsCounter = 0;
	injuredPersons = [];
}

function togglePersonLostTimeDays(personId) {
	const personDiv = document.getElementById(`injuredPerson_${personId}`);
	if (!personDiv) return;
	
	const lostTimeSelect = personDiv.querySelector('.injured-person-losttime');
	const daysLostGroup = personDiv.querySelector('.injured-person-dayslost-group');
	const daysLostInput = personDiv.querySelector('.injured-person-dayslost');
	
	if (lostTimeSelect.value === 'yes') {
		daysLostGroup.style.display = 'block';
		daysLostInput.required = true;
	} else {
		daysLostGroup.style.display = 'none';
		daysLostInput.required = false;
		daysLostInput.value = '';
	}
}

function getInjuredPersonsData() {
	const persons = [];
	document.querySelectorAll('#injuredPersonsList .injured-person-item').forEach(item => {
		const lostTimeVal = item.querySelector('.injured-person-losttime')?.value;
		persons.push({
			name: item.querySelector('.injured-person-name')?.value || '',
			injuryType: item.querySelector('.injured-person-type')?.value || '',
			bodyPart: item.querySelector('.injured-person-bodypart')?.value || '',
			treatment: item.querySelector('.injured-person-treatment')?.value || '',
			lostTime: lostTimeVal || '',
			daysLost: lostTimeVal === 'yes' ? (item.querySelector('.injured-person-dayslost')?.value || '0') : ''
		});
	});
	return persons;
}

let propertyDamageCounter = 0;
let propertyDamageItems = [];

function togglePropertyDamageFields() {
	const checkbox = document.getElementById('hasPropertyDamage');
	const fieldsDiv = document.getElementById('propertyDamageFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
	} else {
		fieldsDiv.classList.remove('visible');
		// Clear all property damage items when unchecked
		clearAllPropertyDamageItems();
	}
}

function addPropertyDamageItem(data = null) {
	propertyDamageCounter++;
	const itemId = propertyDamageCounter;
	
	const container = document.getElementById('propertyDamageList');
	const noMsg = container.querySelector('.no-damage-msg');
	if (noMsg) noMsg.remove();
	
	const itemDiv = document.createElement('div');
	itemDiv.className = 'property-damage-item';
	itemDiv.id = `propertyDamage_${itemId}`;
	itemDiv.innerHTML = `
		<div class="damage-header">
			<span class="damage-number"><i class="fas fa-building"></i> ${incidentT('item_number', itemId)}</span>
			<button type="button" class="btn-remove-damage" onclick="removePropertyDamageItem(${itemId})">
				<i class="fas fa-trash"></i> ${incidentT('remove')}
			</button>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('damage_type_label')}</label>
				<select class="form-control damage-type" required>
					<option value="">${incidentT('select_damage_type')}</option>
					${getDamageTypeOptions(data?.damageType || '')}
				</select>
			</div>
			<div class="form-group">
				<label>${incidentT('damaged_asset_label')}</label>
				<input type="text" class="form-control damage-asset" placeholder="${incidentT('damaged_asset_placeholder')}" value="${data?.damagedAsset || ''}" required>
			</div>
			<div class="form-group">
				<label>${incidentT('estimated_cost_label')}</label>
				<input type="number" min="0" step="0.01" class="form-control damage-cost" placeholder="0.00" value="${data?.estimatedCost || ''}">
			</div>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex:1 1 100%">
				<label>${incidentT('damage_description_label')}</label>
				<textarea class="form-control damage-description" placeholder="${incidentT('damage_description_placeholder')}">${data?.description || ''}</textarea>
			</div>
		</div>
	`;
	
	container.appendChild(itemDiv);
	propertyDamageItems.push({ id: itemId });
}

function getDamageTypeOptions(selectedValue) {
	if (window.damageTypeOptions && window.damageTypeOptions.length > 0) {
		return window.damageTypeOptions.map(opt => 
			`<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`
		).join('');
	}
	// Default options
	const defaults = ['None', 'Minor', 'Significant', 'Major', 'Vehicle', 'Equipment', 'Structural'];
	return defaults.map(opt => 
		`<option value="${opt.toLowerCase()}" ${opt.toLowerCase() === selectedValue ? 'selected' : ''}>${opt}</option>`
	).join('');
}

function removePropertyDamageItem(itemId) {
	const itemDiv = document.getElementById(`propertyDamage_${itemId}`);
	if (itemDiv) {
		itemDiv.remove();
		propertyDamageItems = propertyDamageItems.filter(p => p.id !== itemId);
		
		const container = document.getElementById('propertyDamageList');
		if (container.children.length === 0) {
			container.innerHTML = `<div class="no-damage-msg">${incidentT('no_damaged_items')}</div>`;
		}
	}
}

function clearAllPropertyDamageItems() {
	const container = document.getElementById('propertyDamageList');
	if (container) {
		container.innerHTML = `<div class="no-damage-msg">${incidentT('no_damaged_items')}</div>`;
	}
	propertyDamageCounter = 0;
	propertyDamageItems = [];
}

function getPropertyDamageItemsData() {
	const items = [];
	document.querySelectorAll('#propertyDamageList .property-damage-item').forEach(item => {
		items.push({
			damageType: item.querySelector('.damage-type')?.value || '',
			damagedAsset: item.querySelector('.damage-asset')?.value || '',
			estimatedCost: item.querySelector('.damage-cost')?.value || '',
			description: item.querySelector('.damage-description')?.value || ''
		});
	});
	return items;
}

function getInjuryData() {
	if (!document.getElementById('hasInjury').checked) return null;
	const persons = getInjuredPersonsData();
	if (persons.length === 0) return null;
	return compactObject({
		hasInjury: true,
		injuredPersons: persons
	});
}

function getPropertyDamageData() {
	if (!document.getElementById('hasPropertyDamage').checked) return null;
	const items = getPropertyDamageItemsData();
	if (items.length === 0) return null;
	return compactObject({
		hasPropertyDamage: true,
		damagedItems: items
	});
}

function loadInjuryData(data) {
	if (!data || !data.hasInjury) return;
	
	document.getElementById('hasInjury').checked = true;
	document.getElementById('injuryFields').classList.add('visible');
	
	// Load injured persons (new format with array)
	if (data.injuredPersons && Array.isArray(data.injuredPersons)) {
		data.injuredPersons.forEach(person => {
			addInjuredPerson(person);
		});
	} else if (data.injuredPerson) {
		// Legacy format - single person
		addInjuredPerson({
			name: data.injuredPerson,
			injuryType: data.injuryType || '',
			bodyPart: data.bodyPart || '',
			treatment: data.treatment || '',
			lostTime: data.lostTime || '',
			daysLost: data.daysLost || ''
		});
	}
}

function loadPropertyDamageData(data) {
	if (!data || !data.hasPropertyDamage) return;
	
	document.getElementById('hasPropertyDamage').checked = true;
	document.getElementById('propertyDamageFields').classList.add('visible');
	
	// Load damaged items (new format with array)
	if (data.damagedItems && Array.isArray(data.damagedItems)) {
		data.damagedItems.forEach(item => {
			addPropertyDamageItem(item);
		});
	} else if (data.damageType || data.damagedAsset) {
		// Legacy format - single item
		addPropertyDamageItem({
			damageType: data.damageType || '',
			damagedAsset: data.damagedAsset || '',
			estimatedCost: data.estimatedCost || '',
			description: data.description || ''
		});
	}
}

// ===============================
// Observation Person/Equipment Management
// ===============================

let obsPersonsCounter = 0;
let obsEquipmentCounter = 0;

function toggleObsPersonInvolved() {
	const checkbox = document.getElementById('obsHasPersonInvolved');
	const fieldsDiv = document.getElementById('obsPersonInvolvedFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
	} else {
		fieldsDiv.classList.remove('visible');
		// Clear persons list
		document.getElementById('obsPersonsList').innerHTML = '<div class="no-actions-msg">No persons added. Click "Add Person" to add one.</div>';
		obsPersonsCounter = 0;
	}
}

function toggleObsEquipmentInvolved() {
	const checkbox = document.getElementById('obsHasEquipmentInvolved');
	const fieldsDiv = document.getElementById('obsEquipmentInvolvedFields');
	
	if (checkbox.checked) {
		fieldsDiv.classList.add('visible');
	} else {
		fieldsDiv.classList.remove('visible');
		// Clear equipment list
		document.getElementById('obsEquipmentList').innerHTML = `<div class="no-actions-msg">${incidentT('no_obs_equipment')}</div>`;
		obsEquipmentCounter = 0;
	}
}

function addObsPerson(data = null) {
	obsPersonsCounter++;
	const personId = obsPersonsCounter;
	
	const container = document.getElementById('obsPersonsList');
	const noMsg = container.querySelector('.no-actions-msg');
	if (noMsg) noMsg.remove();
	
	const personDiv = document.createElement('div');
	personDiv.className = 'corrective-action-item';
	personDiv.id = `obsPerson_${personId}`;
	personDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">${incidentT('person_number', personId)}</span>
			<button type="button" class="btn-remove-action" onclick="removeObsPerson(${personId})">
				<i class="fas fa-trash"></i> ${incidentT('remove')}
			</button>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('obs_person_name_label')}</label>
				<input type="text" class="form-control obs-person-name" placeholder="${incidentT('obs_person_name_placeholder')}" value="${data?.name || ''}" required>
			</div>
			<div class="form-group">
				<label>${incidentT('obs_person_role_label')}</label>
				<input type="text" class="form-control obs-person-role" placeholder="${incidentT('obs_person_role_placeholder')}" value="${data?.role || ''}">
			</div>
			<div class="form-group">
				<label>${incidentT('obs_person_involvement_label')}</label>
				<select class="form-control obs-person-involvement">
					<option value="">${incidentT('select')}</option>
					<option value="directly-involved" ${data?.involvement === 'directly-involved' ? 'selected' : ''}>${incidentT('involvement_direct')}</option>
					<option value="witness" ${data?.involvement === 'witness' ? 'selected' : ''}>${incidentT('involvement_witness')}</option>
					<option value="supervisor" ${data?.involvement === 'supervisor' ? 'selected' : ''}>${incidentT('involvement_supervisor')}</option>
					<option value="other" ${data?.involvement === 'other' ? 'selected' : ''}>${incidentT('involvement_other')}</option>
				</select>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex: 1 1 100%">
				<label>${incidentT('obs_person_notes_label')}</label>
				<textarea class="form-control obs-person-notes" placeholder="${incidentT('obs_person_notes_placeholder')}">${data?.notes || ''}</textarea>
			</div>
		</div>
	`;
	container.appendChild(personDiv);
}

function removeObsPerson(personId) {
	const personDiv = document.getElementById(`obsPerson_${personId}`);
	if (personDiv) {
		personDiv.remove();
		// Check if list is empty
		const container = document.getElementById('obsPersonsList');
		if (container.querySelectorAll('.corrective-action-item').length === 0) {
			container.innerHTML = `<div class="no-actions-msg">${incidentT('no_obs_persons')}</div>`;
		}
	}
}

function addObsEquipment(data = null) {
	obsEquipmentCounter++;
	const equipId = obsEquipmentCounter;
	
	const container = document.getElementById('obsEquipmentList');
	const noMsg = container.querySelector('.no-actions-msg');
	if (noMsg) noMsg.remove();
	
	const equipDiv = document.createElement('div');
	equipDiv.className = 'corrective-action-item';
	equipDiv.id = `obsEquipment_${equipId}`;
	equipDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">${incidentT('equip_number', equipId)}</span>
			<button type="button" class="btn-remove-action" onclick="removeObsEquipment(${equipId})">
				<i class="fas fa-trash"></i> ${incidentT('remove')}
			</button>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('equip_name_label')}</label>
				<input type="text" class="form-control obs-equip-name" placeholder="${incidentT('equip_name_placeholder')}" value="${data?.name || ''}" required>
			</div>
			<div class="form-group">
				<label>${incidentT('equip_type_label')}</label>
				<select class="form-control obs-equip-type">
					<option value="">${incidentT('select')}</option>
					<option value="vehicle" ${data?.type === 'vehicle' ? 'selected' : ''}>${incidentT('vehicle')}</option>
					<option value="machinery" ${data?.type === 'machinery' ? 'selected' : ''}>${incidentT('machinery')}</option>
					<option value="tool" ${data?.type === 'tool' ? 'selected' : ''}>${incidentT('tool')}</option>
					<option value="power-tool" ${data?.type === 'power-tool' ? 'selected' : ''}>${incidentT('power_tool')}</option>
					<option value="ppe" ${data?.type === 'ppe' ? 'selected' : ''}>${incidentT('ppe')}</option>
					<option value="electrical" ${data?.type === 'electrical' ? 'selected' : ''}>${incidentT('electrical')}</option>
					<option value="lifting" ${data?.type === 'lifting' ? 'selected' : ''}>${incidentT('lifting')}</option>
					<option value="other" ${data?.type === 'other' ? 'selected' : ''}>${incidentT('other')}</option>
				</select>
			</div>
			<div class="form-group">
				<label>${incidentT('condition_label')}</label>
				<select class="form-control obs-equip-condition">
					<option value="">${incidentT('select')}</option>
					<option value="good" ${data?.condition === 'good' ? 'selected' : ''}>${incidentT('good')}</option>
					<option value="needs-repair" ${data?.condition === 'needs-repair' ? 'selected' : ''}>${incidentT('needs_repair')}</option>
					<option value="damaged" ${data?.condition === 'damaged' ? 'selected' : ''}>${incidentT('damaged')}</option>
					<option value="unsafe" ${data?.condition === 'unsafe' ? 'selected' : ''}>${incidentT('unsafe')}</option>
				</select>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex: 1 1 100%">
				<label>${incidentT('equip_notes_label')}</label>
				<textarea class="form-control obs-equip-notes" placeholder="${incidentT('equip_notes_placeholder')}">${data?.notes || ''}</textarea>
			</div>
		</div>
	`;
	container.appendChild(equipDiv);
}

function removeObsEquipment(equipId) {
	const equipDiv = document.getElementById(`obsEquipment_${equipId}`);
	if (equipDiv) {
		equipDiv.remove();
		// Check if list is empty
		const container = document.getElementById('obsEquipmentList');
		if (container.querySelectorAll('.corrective-action-item').length === 0) {
			container.innerHTML = `<div class="no-actions-msg">${incidentT('no_obs_equipment')}</div>`;
		}
	}
}

function getObsPersonsData() {
	const persons = [];
	document.querySelectorAll('#obsPersonsList .corrective-action-item').forEach(item => {
		const name = item.querySelector('.obs-person-name')?.value;
		if (name) {
			persons.push({
				name: name,
				role: item.querySelector('.obs-person-role')?.value || '',
				involvement: item.querySelector('.obs-person-involvement')?.value || '',
				notes: item.querySelector('.obs-person-notes')?.value || ''
			});
		}
	});
	return persons.length > 0 ? persons : null;
}

function getObsEquipmentData() {
	const equipment = [];
	document.querySelectorAll('#obsEquipmentList .corrective-action-item').forEach(item => {
		const name = item.querySelector('.obs-equip-name')?.value;
		if (name) {
			equipment.push({
				name: name,
				type: item.querySelector('.obs-equip-type')?.value || '',
				condition: item.querySelector('.obs-equip-condition')?.value || '',
				notes: item.querySelector('.obs-equip-notes')?.value || ''
			});
		}
	});
	return equipment.length > 0 ? equipment : null;
}

function loadObsPersonsData(data) {
	if (!data || data.length === 0) return;
	
	document.getElementById('obsHasPersonInvolved').checked = true;
	document.getElementById('obsPersonInvolvedFields').classList.add('visible');
	
	data.forEach(person => addObsPerson(person));
}

function loadObsEquipmentData(data) {
	if (!data || data.length === 0) return;
	
	document.getElementById('obsHasEquipmentInvolved').checked = true;
	document.getElementById('obsEquipmentInvolvedFields').classList.add('visible');
	
	data.forEach(equip => addObsEquipment(equip));
}

// Action-only edit mode (when user comes from Action Plan tab to edit only their corrective action)
let actionOnlyEditMode = false;
let actionOnlyEditIndex = -1;

// Observation Corrective Actions Management
let obsCorrectiveActionsCounter = 0;

function addObsCorrectiveAction(data = null) {
	obsCorrectiveActionsCounter++;
	const actionId = obsCorrectiveActionsCounter;
	
	const container = document.getElementById('obsCorrectiveActionsList');
	const noActionsMsg = container.querySelector('.no-actions-msg');
	if (noActionsMsg) noActionsMsg.remove();
	
	const actionDiv = document.createElement('div');
	actionDiv.className = 'corrective-action-item';
	actionDiv.id = `obsCorrectiveAction_${actionId}`;
	actionDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">${incidentT('action_number', actionId)}</span>
			<button type="button" class="btn-remove-action" onclick="removeObsCorrectiveAction(${actionId})">
				<i class="fas fa-trash"></i> ${incidentT('remove')}
			</button>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex:1 1 100%">
				<label>${incidentT('action_description_label')}</label>
				<textarea class="form-control obs-action-description" placeholder="${incidentT('action_description_placeholder')}" required>${data?.description || ''}</textarea>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('responsible_person_label')}</label>
				<div class="search-container">
					<input type="text" class="form-control obs-action-responsible-search" placeholder="${incidentT('type_to_search_employee')}" autocomplete="off" value="${data?.responsibleName || ''}">
					<input type="hidden" class="obs-action-responsible-id" value="${data?.responsibleId || ''}">
					<div class="search-dropdown obs-action-search-results"></div>
				</div>
			</div>
			<div class="form-group">
				<label>${incidentT('due_date_required_label')}</label>
				<input type="date" class="form-control obs-action-due-date" required value="${data?.dueDate || ''}">
			</div>
			<div class="form-group">
				<label>${incidentT('status_required_label')}</label>
				<select class="form-control obs-action-status" required>
					<option value="">${incidentT('select')}</option>
					<option value="pending" ${data?.status === 'pending' ? 'selected' : ''}>${incidentT('status_pending')}</option>
					<option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>${incidentT('status_in_progress')}</option>
					<option value="completed" ${data?.status === 'completed' ? 'selected' : ''}>${incidentT('status_completed')}</option>
					<option value="overdue" ${data?.status === 'overdue' ? 'selected' : ''}>${incidentT('status_overdue')}</option>
				</select>
			</div>
		</div>
	`;
	container.appendChild(actionDiv);
	
	// Initialize search for the responsible person field
	initializeObsActionSearch(actionDiv.querySelector('.obs-action-responsible-search'));
}

function removeObsCorrectiveAction(actionId) {
	const actionDiv = document.getElementById(`obsCorrectiveAction_${actionId}`);
	if (actionDiv) {
		actionDiv.remove();
		// Check if list is empty
		const container = document.getElementById('obsCorrectiveActionsList');
		if (container.querySelectorAll('.corrective-action-item').length === 0) {
			container.innerHTML = `<div class="no-actions-msg">${incidentT('no_obs_corrective_actions')}</div>`;
		}
	}
}

function initializeObsActionSearch(searchInput) {
	if (!searchInput) return;
	
	const hiddenInput = searchInput.parentElement.querySelector('.obs-action-responsible-id');
	const resultsDiv = searchInput.parentElement.querySelector('.obs-action-search-results');
	
	searchInput.addEventListener('input', (e) => {
		const query = e.target.value.trim();
		if (query.length >= 2) {
			const results = searchUsers(query);
			showObsSearchResults(results, resultsDiv, searchInput, hiddenInput);
		} else {
			resultsDiv.style.display = 'none';
		}
	});
	
	searchInput.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (query.length >= 2) {
				const results = searchUsers(query);
				if (results.length > 0) {
					selectObsUser(results[0], searchInput, hiddenInput, resultsDiv);
				}
			}
		}
	});
	
	document.addEventListener('click', (e) => {
		if (!searchInput.parentElement.contains(e.target)) {
			resultsDiv.style.display = 'none';
		}
	});
}

function getObsCorrectiveActionsData() {
	const actions = [];
	document.querySelectorAll('#obsCorrectiveActionsList .corrective-action-item').forEach(item => {
		const description = item.querySelector('.obs-action-description')?.value;
		if (description) {
			actions.push({
				description: description,
				responsibleId: item.querySelector('.obs-action-responsible-id')?.value || '',
				responsibleName: item.querySelector('.obs-action-responsible-search')?.value || '',
				dueDate: item.querySelector('.obs-action-due-date')?.value || '',
				status: item.querySelector('.obs-action-status')?.value || 'pending'
			});
		}
	});
	return actions.length > 0 ? actions : null;
}

function loadObsCorrectiveActions(data) {
	if (!data || data.length === 0) return;
	data.forEach(action => addObsCorrectiveAction(action));
}

// Corrective Actions Management
let correctiveActionsCounter = 0;
let correctiveActions = [];

function addCorrectiveAction(data = null) {
	correctiveActionsCounter++;
	const actionId = correctiveActionsCounter;
	
	const container = document.getElementById('correctiveActionsList');
	const noActionsMsg = container.querySelector('.no-actions-msg');
	if (noActionsMsg) noActionsMsg.remove();
	
	const actionDiv = document.createElement('div');
	actionDiv.className = 'corrective-action-item';
	actionDiv.id = `correctiveAction_${actionId}`;
	actionDiv.innerHTML = `
		<div class="action-header">
			<span class="action-number">${incidentT('action_number', actionId)}</span>
			<button type="button" class="btn-remove-action" onclick="removeCorrectiveAction(${actionId})">
				<i class="fas fa-trash"></i> ${incidentT('remove')}
			</button>
		</div>
		<div class="form-row">
			<div class="form-group" style="flex:1 1 100%">
				<label>${incidentT('action_description_label')}</label>
				<textarea class="form-control action-description" placeholder="${incidentT('action_description_placeholder')}" required>${data?.description || ''}</textarea>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label>${incidentT('responsible_person_label')}</label>
				<div class="search-container">
					<input type="text" class="form-control action-responsible-search" placeholder="${incidentT('type_to_search_employee')}" autocomplete="off" value="${data?.responsibleName || ''}">
					<input type="hidden" class="action-responsible-id" value="${data?.responsibleId || ''}">
					<div class="search-dropdown action-search-results"></div>
				</div>
			</div>
			<div class="form-group">
				<label>${incidentT('due_date_required_label')}</label>
				<input type="date" class="form-control action-due-date" required value="${data?.dueDate || ''}">
			</div>
			<div class="form-group">
				<label>${incidentT('status_required_label')}</label>
				<select class="form-control action-status" required>
					<option value="">${incidentT('select')}</option>
					<option value="pending" ${data?.status === 'pending' ? 'selected' : ''}>${incidentT('status_pending')}</option>
					<option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>${incidentT('status_in_progress')}</option>
					<option value="completed" ${data?.status === 'completed' ? 'selected' : ''}>${incidentT('status_completed')}</option>
					<option value="overdue" ${data?.status === 'overdue' ? 'selected' : ''}>${incidentT('status_overdue')}</option>
				</select>
			</div>
		</div>
	`;
	
	container.appendChild(actionDiv);
	
	// Initialize search for responsible person
	initializeActionResponsibleSearch(actionDiv, actionId);
	
	// Store action reference (without files)
	correctiveActions.push({ id: actionId });
	
	// Render existing files if editing
	if (data?.attachments && data.attachments.length > 0) {
		renderActionFiles(actionId);
	}
}

function removeCorrectiveAction(actionId) {
	const actionDiv = document.getElementById(`correctiveAction_${actionId}`);
	if (actionDiv) {
		actionDiv.remove();
		correctiveActions = correctiveActions.filter(a => a.id !== actionId);
		
		// Show "no actions" message if empty
		const container = document.getElementById('correctiveActionsList');
		if (container.children.length === 0) {
			container.innerHTML = `<div class="no-actions-msg">${incidentT('no_actions_added')}</div>`;
		}
	}
}

function initializeActionResponsibleSearch(actionDiv, actionId) {
	const searchInput = actionDiv.querySelector('.action-responsible-search');
	const hiddenInput = actionDiv.querySelector('.action-responsible-id');
	const resultsDiv = actionDiv.querySelector('.action-search-results');
	
	searchInput.addEventListener('input', (e) => {
		const query = e.target.value.trim();
		if (query.length >= 2) {
			const results = searchUsers(query);
			showActionSearchResults(results, resultsDiv, searchInput, hiddenInput);
		} else {
			resultsDiv.style.display = 'none';
		}
	});
	
	searchInput.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (query.length >= 2) {
				const results = searchUsers(query);
				if (results.length > 0) {
					selectActionUser(results[0], searchInput, hiddenInput, resultsDiv);
				}
			}
		}
	});
	
	document.addEventListener('click', (e) => {
		if (!actionDiv.contains(e.target)) {
			resultsDiv.style.display = 'none';
		}
	});
}

function showActionSearchResults(users, resultsDiv, searchInput, hiddenInput) {
	resultsDiv.innerHTML = '';
	
	if (users.length === 0) {
		resultsDiv.innerHTML = `<div class="search-result">${incidentT('no_users_found')}</div>`;
	} else {
		users.forEach(user => {
			const div = document.createElement('div');
			div.className = 'search-result';
			div.innerHTML = `
				<div class="user-name">${user.name}</div>
				${user.title ? `<div class="user-title">${user.title}</div>` : ''}
			`;
			div.onclick = () => selectActionUser(user, searchInput, hiddenInput, resultsDiv);
			resultsDiv.appendChild(div);
		});
	}
	
	resultsDiv.style.display = 'block';
}

function selectActionUser(user, searchInput, hiddenInput, resultsDiv) {
	hiddenInput.value = user.id;
	searchInput.value = user.name + (user.title ? ` (${user.title})` : '');
	resultsDiv.style.display = 'none';
}

function showObsSearchResults(users, resultsDiv, searchInput, hiddenInput) {
	resultsDiv.innerHTML = '';
	
	if (users.length === 0) {
		resultsDiv.innerHTML = `<div class="search-result">${incidentT('no_users_found')}</div>`;
	} else {
		users.forEach(user => {
			const div = document.createElement('div');
			div.className = 'search-result';
			div.innerHTML = `
				<div class="user-name">${user.name}</div>
				${user.title ? `<div class="user-title">${user.title}</div>` : ''}
			`;
			div.onclick = () => selectObsUser(user, searchInput, hiddenInput, resultsDiv);
			resultsDiv.appendChild(div);
		});
	}
	
	resultsDiv.style.display = 'block';
}

function selectObsUser(user, searchInput, hiddenInput, resultsDiv) {
	hiddenInput.value = user.id;
	searchInput.value = user.name + (user.title ? ` (${user.title})` : '');
	resultsDiv.style.display = 'none';
}

function getCorrectiveActionsData() {
	const actions = [];
	correctiveActions.forEach(action => {
		const actionDiv = document.getElementById(`correctiveAction_${action.id}`);
		if (!actionDiv) return;
		
		const description = actionDiv.querySelector('.action-description')?.value || '';
		const responsibleId = actionDiv.querySelector('.action-responsible-id')?.value || '';
		const responsibleName = actionDiv.querySelector('.action-responsible-search')?.value || '';
		const dueDate = actionDiv.querySelector('.action-due-date')?.value || '';
		const status = actionDiv.querySelector('.action-status')?.value || '';
		
		actions.push({
			description,
			responsibleId,
			responsibleName,
			dueDate,
			status
		});
	});
	return actions;
}

function loadCorrectiveActions(actionsData) {
	if (!actionsData || !Array.isArray(actionsData)) return;
	
	// Clear existing actions
	correctiveActions = [];
	correctiveActionsCounter = 0;
	const container = document.getElementById('correctiveActionsList');
	container.innerHTML = '';
	
	// Add each saved action
	actionsData.forEach((actionData, idx) => {
		addCorrectiveAction(actionData);
		
		// If in action-only mode, disable actions that don't belong to this user
		if (actionOnlyEditMode) {
			const actionId = correctiveActionsCounter;
			const actionDiv = document.getElementById(`correctiveAction_${actionId}`);
			if (actionDiv) {
				if (idx !== actionOnlyEditIndex) {
					// Disable this action - it's not the one user should edit
					actionDiv.classList.add('action-readonly');
					actionDiv.querySelectorAll('input, textarea, select').forEach(el => {
						el.disabled = true;
						el.style.pointerEvents = 'none';
					});
					// Hide remove button
					const removeBtn = actionDiv.querySelector('.btn-remove-action');
					if (removeBtn) removeBtn.style.display = 'none';
				} else {
					// This is the user's action - highlight it
					actionDiv.classList.add('action-editable-highlight');
				}
			}
		}
	});
	
	// Show "no actions" message if empty
	if (actionsData.length === 0) {
		container.innerHTML = '<div class="no-actions-msg">No corrective actions added. Click "Add Action" to create one.</div>';
	}
	
	// If action-only mode, hide add action button and apply form restrictions
	if (actionOnlyEditMode) {
		applyActionOnlyRestrictions();
	}
}

// Apply restrictions when in action-only edit mode
function applyActionOnlyRestrictions() {
	console.log('üîí Applying action-only restrictions...');
	
	// Hide add action buttons
	document.querySelectorAll('.btn-add-action, [onclick*="addCorrectiveAction"], [onclick*="addObsCorrectiveAction"]').forEach(btn => {
		btn.style.display = 'none';
	});
	
	// Disable all form fields except the corrective actions section
	const formSections = document.querySelectorAll('.section-title, .form-section, .form-row, .form-group');
	
	// Get the corrective actions container
	const correctiveActionsSection = document.getElementById('correctiveActionsList')?.closest('.form-section') || 
	                                  document.getElementById('correctiveActionsList')?.parentElement;
	
	// Disable main form fields (not in corrective actions section)
	document.querySelectorAll('#incidentForm input, #incidentForm textarea, #incidentForm select').forEach(el => {
		const isInCorrectiveActions = el.closest('#correctiveActionsList') || el.closest('#obsCorrectiveActionsList');
		const isInEditableAction = el.closest('.action-editable-highlight');
		
		if (!isInCorrectiveActions || (isInCorrectiveActions && !isInEditableAction)) {
			if (!isInEditableAction) {
				el.classList.add('readonly-field');
				if (!isInCorrectiveActions) {
					el.disabled = true;
				}
			}
		}
	});
	
	// Add visual indicator for action-only mode
	const pageHeader = document.querySelector('.page-header');
	if (pageHeader) {
		const badge = document.createElement('span');
		badge.className = 'action-only-badge';
		badge.innerHTML = '<i class="fas fa-lock"></i> Action Edit Only';
		badge.style.cssText = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:4px;font-size:0.75rem;margin-left:12px;font-weight:500;';
		pageHeader.querySelector('h1')?.appendChild(badge);
	}
	
	// Change submit button text
	const submitBtn = document.getElementById('submitBtn');
	if (submitBtn) {
		submitBtn.innerHTML = '<i class="fas fa-save"></i> Update My Action';
	}
	
	// Scroll to the editable action
	setTimeout(() => {
		const editableAction = document.querySelector('.action-editable-highlight');
		if (editableAction) {
			editableAction.scrollIntoView({ behavior: 'smooth', block: 'center' });
		}
	}, 500);
}

function updateEventTypeFields(){
	const type=(document.getElementById('eventType')?.value)||'';
	const nm=document.getElementById('nearMissFields');
	const ob=document.getElementById('observationFields');
	const ic=document.getElementById('incidentFields');
	const incidentCommon=document.getElementById('incidentCommonFields');
	const actionsFields=document.getElementById('actionsFields');
	const dueDateField=document.getElementById('dueDateField');
	
	// Show/hide event-type specific fields
	show(nm, type==='near-miss');
	show(ob, type==='observation');
	show(ic, type==='incident');
	
	// Show incident category, injury type, property damage only for incidents
	show(incidentCommon, type==='incident');
	
	// Show actions fields for incidents and near-misses (not observations)
	show(actionsFields, type==='incident' || type==='near-miss');
	
	// Hide due date field for near-miss events
	show(dueDateField, type==='incident');
	
	// Dynamic requireds
	setRequired('obsType', type==='observation');
	setRequired('obsCategory', type==='observation');
	setRequired('incRootCause', type==='incident');
	// Lost time requirement logic removed with legacy fields
}

function getEventDetailsFromForm(){
	const type=(document.getElementById('eventType')?.value)||'';
	const details={ type };
	if(type==='near-miss'){
		details.nearMiss=compactObject({
			// Near miss specific fields removed
		});
	} else if(type==='observation'){
		details.observation=compactObject({
			type: document.getElementById('obsType')?.value||'',
			category: document.getElementById('obsCategory')?.value||'',
			personsInvolved: getObsPersonsData(),
			equipmentInvolved: getObsEquipmentData(),
			correctiveActions: getObsCorrectiveActionsData()
		});
	} else if(type==='incident'){
		details.incident=compactObject({
			rootCause: document.getElementById('incRootCause')?.value||'',
			contributingFactors: document.getElementById('incContributingFactors')?.value||''
		});
	}
	return compactObject(details);
}

function setEventDetailsFormValues(eventDetails){
	if(!eventDetails || typeof eventDetails!=='object') return;
	// Do not override main eventType select here; trust form value
	if(eventDetails.nearMiss){
		const nm=eventDetails.nearMiss;
		// Near miss fields removed
	}
	if(eventDetails.observation){
		const ob=eventDetails.observation;
		if(ob.type!==undefined) document.getElementById('obsType').value=ob.type;
		if(ob.category!==undefined) document.getElementById('obsCategory').value=ob.category;
		// Load persons involved
		if(ob.personsInvolved) loadObsPersonsData(ob.personsInvolved);
		// Load equipment involved
		if(ob.equipmentInvolved) loadObsEquipmentData(ob.equipmentInvolved);
		// Load corrective actions
		if(ob.correctiveActions) loadObsCorrectiveActions(ob.correctiveActions);
	}
	if(eventDetails.incident){
		const ic=eventDetails.incident;
		if(ic.rootCause!==undefined) document.getElementById('incRootCause').value=ic.rootCause;
		if(ic.contributingFactors!==undefined) document.getElementById('incContributingFactors').value=ic.contributingFactors;
	}
}

const attachedFiles=[];
const fileInput=document.getElementById('fileUpload');
const attachmentsTable=document.getElementById('attachmentsTable');
const attachmentsTableBody=document.getElementById('attachmentsTableBody');
const attachmentsEmpty=document.getElementById('attachmentsEmpty');

fileInput.addEventListener('change',()=>{
	[...fileInput.files].forEach(f=>{
		if(f.size>5*1024*1024){ alert(`File ${f.name} exceeds 5MB`); return; }
		const fileEntry = {
			file: f,
			originalName: f.name,
			name: f.name,
			size: formatBytes(f.size),
			id: Date.now() + Math.random().toString(36).substr(2, 9)
		};
		attachedFiles.push(fileEntry);
		addFileRow(fileEntry);
	});
	fileInput.value='';
	updateAttachmentsVisibility();
});

function addFileRow(fileEntry) {
	const row = document.createElement('tr');
	row.dataset.fileId = fileEntry.id;
	
	// Preview cell
	const previewCell = document.createElement('td');
	previewCell.className = 'attachment-preview';
	if (fileEntry.file && fileEntry.file.type && fileEntry.file.type.startsWith('image/')) {
		const img = document.createElement('img');
		img.src = URL.createObjectURL(fileEntry.file);
		previewCell.appendChild(img);
	} else if (fileEntry.dataUrl && fileEntry.contentType && fileEntry.contentType.startsWith('image/')) {
		const img = document.createElement('img');
		img.src = fileEntry.dataUrl;
		previewCell.appendChild(img);
	} else {
		const ext = (fileEntry.name || '').split('.').pop().toLowerCase();
		const iconMap = { 'pdf': 'fa-file-pdf', 'doc': 'fa-file-word', 'docx': 'fa-file-word', 'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel' };
		const iconClass = iconMap[ext] || 'fa-file';
		previewCell.innerHTML = `<i class="fas ${iconClass}"></i>`;
	}
	row.appendChild(previewCell);
	
	// File name cell with editable input
	const nameCell = document.createElement('td');
	const nameWrapper = document.createElement('div');
	nameWrapper.style.cssText = 'display:flex;align-items:center;gap:0.5rem';
	
	const nameSpan = document.createElement('span');
	nameSpan.className = 'attachment-name-display';
	nameSpan.textContent = fileEntry.name;
	
	const nameInput = document.createElement('input');
	nameInput.type = 'text';
	nameInput.value = fileEntry.name;
	nameInput.className = 'attachment-name-input hidden';
	
	nameWrapper.appendChild(nameSpan);
	nameWrapper.appendChild(nameInput);
	nameCell.appendChild(nameWrapper);
	row.appendChild(nameCell);
	
	// Type cell
	const typeCell = document.createElement('td');
	const extension = (fileEntry.name || '').split('.').pop().toUpperCase();
	typeCell.textContent = extension;
	typeCell.style.color = '#64748b';
	row.appendChild(typeCell);
	
	// Size cell
	const sizeCell = document.createElement('td');
	sizeCell.textContent = fileEntry.size || '';
	sizeCell.style.color = '#64748b';
	row.appendChild(sizeCell);
	
	// Actions cell
	const actionsCell = document.createElement('td');
	actionsCell.innerHTML = `
		<button type="button" class="btn-icon rename-btn" title="Rename">
			<i class="fas fa-edit" style="color:#3b82f6"></i>
		</button>
		<button type="button" class="btn-icon delete-btn" title="Delete">
			<i class="fas fa-trash" style="color:#dc2626"></i>
		</button>
	`;
	
	// Rename button handler
	const renameBtn = actionsCell.querySelector('.rename-btn');
	renameBtn.addEventListener('click', () => {
		const isEditing = !nameInput.classList.contains('hidden');
		if (isEditing) {
			// Save
			fileEntry.name = nameInput.value || fileEntry.originalName;
			nameSpan.textContent = fileEntry.name;
			nameSpan.classList.remove('hidden');
			nameInput.classList.add('hidden');
			renameBtn.innerHTML = '<i class="fas fa-edit" style="color:#3b82f6"></i>';
			renameBtn.title = 'Rename';
		} else {
			// Edit
			nameInput.value = fileEntry.name;
			nameSpan.classList.add('hidden');
			nameInput.classList.remove('hidden');
			nameInput.focus();
			nameInput.select();
			renameBtn.innerHTML = '<i class="fas fa-check" style="color:#059669"></i>';
			renameBtn.title = 'Save';
		}
	});
	
	// Save on Enter key
	nameInput.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			renameBtn.click();
		} else if (e.key === 'Escape') {
			nameInput.value = fileEntry.name;
			nameSpan.classList.remove('hidden');
			nameInput.classList.add('hidden');
			renameBtn.innerHTML = '<i class="fas fa-edit" style="color:#3b82f6"></i>';
			renameBtn.title = 'Rename';
		}
	});
	
	// Delete button handler
	const deleteBtn = actionsCell.querySelector('.delete-btn');
	deleteBtn.addEventListener('click', () => {
		const idx = attachedFiles.findIndex(f => f.id === fileEntry.id);
		if (idx !== -1) attachedFiles.splice(idx, 1);
		row.remove();
		updateAttachmentsVisibility();
	});
	
	row.appendChild(actionsCell);
	attachmentsTableBody.appendChild(row);
}

function updateAttachmentsVisibility() {
	const hasFiles = attachedFiles.length > 0;
	if (attachmentsTable) attachmentsTable.style.display = hasFiles ? 'table' : 'none';
	if (attachmentsEmpty) attachmentsEmpty.style.display = hasFiles ? 'none' : 'block';
}

function renderFiles() {
	// Clear and rebuild table from attachedFiles
	if (attachmentsTableBody) attachmentsTableBody.innerHTML = '';
	attachedFiles.forEach(fileEntry => addFileRow(fileEntry));
	updateAttachmentsVisibility();
}

// Serialize attachments into objects with base64 payload for Realtime Database
async function uploadAttachments(prefixIgnored){
	const out=[];
	for(const item of attachedFiles){
		// Keep existing attachments (editing) as-is if they already have url or dataUrl, but strip undefined fields
		if(item.url || item.dataUrl){ out.push(sanitizeAttachmentFields(item)); continue; }
		if(item.file){
			const dataUrl=await fileToDataUrl(item.file);
			out.push({
				name: item.name,
				size: item.size,
				contentType: item.file.type || 'application/octet-stream',
				dataUrl,
				uploadedAt: firebase.database.ServerValue.TIMESTAMP
			});
		}
	}
	return out;
}

async function loadOptions(companyId){
	// injury-type - store globally for dynamic injured person forms
	window.injuryTypeOptions = [];
	// body-part options for injured person forms
	window.bodyPartOptions = [];
	
	// Try to load from company's incidentSettings first
	if (companyId) {
		const companyInjurySnap = await db.ref(`companies/${companyId}/incidentSettings/injuryTypes`).once('value');
		const companyInjuryTypes = companyInjurySnap.val();
		if (companyInjuryTypes && Array.isArray(companyInjuryTypes) && companyInjuryTypes.length > 0) {
			window.injuryTypeOptions = companyInjuryTypes;
		}
		
		// Load treatment options from company settings
		const companyTreatmentSnap = await db.ref(`companies/${companyId}/incidentSettings/treatmentTypes`).once('value');
		const companyTreatmentTypes = companyTreatmentSnap.val();
		if (companyTreatmentTypes && Array.isArray(companyTreatmentTypes) && companyTreatmentTypes.length > 0) {
			window.treatmentOptions = companyTreatmentTypes;
		} else {
			window.treatmentOptions = ['First Aid', 'Medical Treatment', 'Hospitalization', 'None Required'];
		}
	} else {
		window.treatmentOptions = ['First Aid', 'Medical Treatment', 'Hospitalization', 'None Required'];
	}

	// Load body parts from company settings if available
	if (companyId) {
		const companyBodyPartsSnap = await db.ref(`companies/${companyId}/incidentSettings/bodyParts`).once('value');
		const companyBodyParts = companyBodyPartsSnap.val();
		if (companyBodyParts && Array.isArray(companyBodyParts) && companyBodyParts.length > 0) {
			window.bodyPartOptions = companyBodyParts;
		}
	}
	
	// Fallback to global fieldOptions if no company settings
	if (window.injuryTypeOptions.length === 0) {
		const injurySnap=await db.ref('fieldOptions/injury-type').once('value');
		if(injurySnap.exists()) {
			injurySnap.forEach(s=>{ 
				const o=s.val(); 
				if(o?.enabled) window.injuryTypeOptions.push(o.label || o.value);
			});
		} else {
			window.injuryTypeOptions = ['No Injury', 'Minor', 'Medical', 'Lost Time', 'Fatality'];
		}
	}

	// Fallback to global body-part options
	if (window.bodyPartOptions.length === 0) {
		const bodySnap = await db.ref('fieldOptions/body-part').once('value');
		if (bodySnap.exists()) {
			bodySnap.forEach(s => {
				const o = s.val();
				if (o?.enabled) window.bodyPartOptions.push(o.label || o.value);
			});
		} else {
			window.bodyPartOptions = [
				'Head','Neck','Shoulder','Arm','Elbow','Wrist','Hand/Fingers','Chest','Upper Back','Lower Back','Abdomen',
				'Hip','Thigh','Knee','Shin','Calf','Ankle','Foot/Toes','Eye','Ear','Nose','Mouth','Spine','Multiple','Other'
			];
		}
	}

	// property-damage - store globally for dynamic property damage forms
	window.damageTypeOptions = [];
	
	// Try to load from company's incidentSettings first
	if (companyId) {
		const companyDamageSnap = await db.ref(`companies/${companyId}/incidentSettings/categories`).once('value');
		const companyDamageTypes = companyDamageSnap.val();
		if (companyDamageTypes && Array.isArray(companyDamageTypes) && companyDamageTypes.length > 0) {
			window.damageTypeOptions = companyDamageTypes;
		}
	}
	
	// Fallback to global fieldOptions if no company settings
	if (window.damageTypeOptions.length === 0) {
		const propSnap=await db.ref('fieldOptions/property-damage').once('value');
		if(propSnap.exists()) {
			propSnap.forEach(s=>{ 
				const o=s.val(); 
				if(o?.enabled) window.damageTypeOptions.push(o.label || o.value);
			});
		} else {
			window.damageTypeOptions = ['None', 'Minor', 'Significant', 'Major', 'Vehicle', 'Equipment', 'Structural'];
		}
	}

	// incident-category
	const catSel=document.getElementById('incidentCategory'); catSel.length=1;
	const catSnap=await db.ref('fieldOptions/incident-category').once('value');
	if(catSnap.exists()) catSnap.forEach(s=>{ const o=s.val(); if(o?.enabled){ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; catSel.appendChild(opt); }});
	else ['slip-trip-fall','struck-by','caught-in-between','vehicle-accident','electrical','fire-explosion','chemical-exposure','ergonomic','other'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); catSel.appendChild(opt); });
}

async function loadLocations(companyId){ 
	const sel=document.getElementById('eventLocation'); 
	while(sel.options.length>1) sel.remove(1); 
	
	// First try to load from company's incidentSettings
	if(companyId) {
		const settingsSnap=await db.ref(`companies/${companyId}/incidentSettings/locations`).once('value');
		const locations=settingsSnap.val();
		if(locations && Array.isArray(locations) && locations.length > 0) {
			locations.forEach(n=>{ 
				const o=document.createElement('option'); 
				o.value=n; 
				o.textContent=n; 
				sel.appendChild(o); 
			});
			return;
		}
	}
	
	// Fallback to global locations or defaults
	const snap=await db.ref('locations').once('value'); 
	if(snap.exists()) {
		snap.forEach(s=>{ 
			const o=document.createElement('option'); 
			o.value=s.key; 
			o.textContent=s.val()?.name||s.key; 
			sel.appendChild(o); 
		}); 
	} else {
		['Main Building','Warehouse','Production Floor','Office Area','Loading Dock'].forEach(n=>{ 
			const o=document.createElement('option'); 
			o.value=n.toLowerCase().replace(/\s+/g,'-'); 
			o.textContent=n; 
			sel.appendChild(o); 
		}); 
	}
}
async function loadObservationTypes(companyId){ 
	const sel=document.getElementById('obsType'); 
	if(!sel) return;
	while(sel.options.length>1) sel.remove(1); 
	
	// Try to load from company's incidentSettings
	if(companyId) {
		const settingsSnap=await db.ref(`companies/${companyId}/incidentSettings/observationTypes`).once('value');
		const types=settingsSnap.val();
		if(types && Array.isArray(types) && types.length > 0) {
			types.forEach(t=>{ 
				const o=document.createElement('option'); 
				o.value=t.toLowerCase().replace(/\s+/g,'-'); 
				o.textContent=t; 
				sel.appendChild(o); 
			});
			return;
		}
	}
	
	// Fallback to default options
	['Safe', 'At-Risk'].forEach(t=>{ 
		const o=document.createElement('option'); 
		o.value=t.toLowerCase().replace(/\s+/g,'-'); 
		o.textContent=t; 
		sel.appendChild(o); 
	});
}
async function loadDepartments(companyId){ const sel=document.getElementById('department'); while(sel.options.length>1) sel.remove(1);
	if(companyId){ const snap=await db.ref(`companies/${companyId}/fieldOptions/department`).once('value'); const arr=snap.val(); if(Array.isArray(arr)){ arr.filter(x=>x?.enabled!==false).forEach(x=>{ const o=document.createElement('option'); o.value=x.value||x.key||x.label; o.textContent=x.label||x.value; sel.appendChild(o); }); } }
	if(sel.options.length===1){ const g=await db.ref('fieldOptions/department').once('value'); const v=g.val(); if(v){ (Array.isArray(v)?v:Object.keys(v).map(k=>({value:k,label:v[k]?.label||k}))).forEach(x=>{ const o=document.createElement('option'); o.value=x.value; o.textContent=x.label; sel.appendChild(o); }); } }
	if(sel.options.length===1){ ['Safety','Operations','HR','Finance','IT'].forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
}
async function loadUsers(){ /* Users are now loaded via loadAllUsers for search functionality */ }

let allUsers = [];
let jobTitlesMap = {}; // Map of job title value to label

async function loadJobTitlesMap(companyId) {
	jobTitlesMap = {};
	if (!companyId) return;
	
	try {
		const snapshot = await db.ref(`companies/${companyId}/fieldOptions/job-title`).once('value');
		if (snapshot.exists()) {
			const data = snapshot.val();
			if (Array.isArray(data)) {
				data.forEach(item => {
					if (item && typeof item === 'object' && item.value) {
						jobTitlesMap[item.value] = item.label || item.value;
					} else if (typeof item === 'string') {
						jobTitlesMap[item] = item;
					}
				});
			} else if (typeof data === 'object') {
				Object.values(data).forEach(item => {
					if (item && typeof item === 'object' && item.value) {
						jobTitlesMap[item.value] = item.label || item.value;
					}
				});
			}
		}
		console.log(`‚úÖ Loaded ${Object.keys(jobTitlesMap).length} job titles for lookup`);
	} catch (error) {
		console.error('Error loading job titles map:', error);
	}
}

function resolveJobTitle(userData) {
	// Try multiple fields for job title
	let jobTitle = userData.jobTitleLabel || '';
	
	// If jobTitleLabel is empty, try to resolve from jobTitle value
	if (!jobTitle && userData.jobTitle) {
		// Check if it's a key that needs to be resolved
		jobTitle = jobTitlesMap[userData.jobTitle] || userData.jobTitle;
	}
	
	// Try position field
	if (!jobTitle && userData.position) {
		jobTitle = jobTitlesMap[userData.position] || userData.position;
	}
	
	// Format hyphenated titles to title case
	if (jobTitle && jobTitle.includes('-')) {
		jobTitle = jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
	}
	
	return jobTitle;
}

async function loadAllUsers(companyId) {
	allUsers = [];
	
	if (!companyId) {
		console.warn('‚ö†Ô∏è No company ID available for loading users');
		return;
	}
	
	try {
		// Load job titles map first for proper label resolution
		await loadJobTitlesMap(companyId);
		
		// Load users from company scope only
		const usersRef = db.ref(`companies/${companyId}/users`);
		const snapshot = await usersRef.once('value');
		
		if (snapshot.exists()) {
			const users = snapshot.val();
			Object.entries(users).forEach(([uid, userData]) => {
				// Include all users (both admin and standard) so same person with multiple accounts appears
				
				const displayName = userData.displayName || userData.name || userData.email || 'Unknown';
				const jobTitle = resolveJobTitle(userData);
				
				const department = userData.department || userData.dept || '';
				const employeeId = userData.employeeId || userData.staffId || '';
				const userRole = userData.role || 'standard';
				
				allUsers.push({
					id: uid,
					name: displayName,
					title: jobTitle,
					department: department,
					email: userData.email || '',
					employeeId: employeeId,
					role: userRole,
					companyId: companyId,
					searchText: `${displayName} ${jobTitle} ${department} ${employeeId} ${userData.email || ''}`.toLowerCase()
				});
			});
		}
		
		console.log(`‚úÖ Loaded ${allUsers.length} users from company scope (including all roles)`);
	} catch (error) {
		console.error('‚ùå Error loading users:', error);
		allUsers = [];
	}
}

function searchUsers(query) {
	if (!query || query.length < 2) return [];
	const searchTerm = query.toLowerCase();
	return allUsers.filter(user => user.name.toLowerCase().startsWith(searchTerm)).slice(0, 10);
}

function showSearchResults(users) {
	const resultsDiv = document.getElementById('searchResults');
	resultsDiv.innerHTML = '';
	
	if (users.length === 0) {
		resultsDiv.innerHTML = '<div class="search-result">No users found</div>';
	} else {
		users.forEach(user => {
			const div = document.createElement('div');
			div.className = 'search-result';
			div.innerHTML = `
				<div class="user-name">${user.name}${user.employeeId ? ` <span style="color:#6b7280;font-weight:normal;">(${user.employeeId})</span>` : ''}</div>
				${user.title ? `<div class="user-title">${user.title}</div>` : ''}
			`;
			div.onclick = () => selectUser(user);
			resultsDiv.appendChild(div);
		});
	}
	
	resultsDiv.style.display = 'block';
}

function selectUser(user) {
	const assignedToInput = document.getElementById('assignedTo');
	const searchInput = document.getElementById('userSearch');
	const resultsDiv = document.getElementById('searchResults');
	
	// Set the hidden input value
	assignedToInput.value = user.id;
	
	// Show selected user in search input - display name and employee ID
	searchInput.value = user.name + (user.employeeId ? ` (${user.employeeId})` : '');
	resultsDiv.style.display = 'none';
}

function initializeUserSearch() {
	const searchInput = document.getElementById('userSearch');
	const resultsDiv = document.getElementById('searchResults');
	
	if (!searchInput) return;
	
	// Search on input
	searchInput.addEventListener('input', (e) => {
		const query = e.target.value.trim();
		if (query.length >= 2) {
			const results = searchUsers(query);
			showSearchResults(results);
		} else {
			resultsDiv.style.display = 'none';
		}
	});
	
	// Hide results when clicking outside
	document.addEventListener('click', (e) => {
		if (!e.target.closest('.search-container')) {
			resultsDiv.style.display = 'none';
		}
	});
	
	// Handle Enter key
	searchInput.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (query.length >= 2) {
				const results = searchUsers(query);
				if (results.length > 0) {
					selectUser(results[0]); // Select first result
				}
			}
		}
	});
}

async function generateReference(){ const tr=await db.ref('counters/incidents').transaction(v=>(v||0)+1); if(tr.committed){ const n=String(tr.snapshot.val()).padStart(5,'0'); document.getElementById('referenceNumber').value=`INC-${n}`; } else { document.getElementById('referenceNumber').value=`INC-${Date.now()}`; } }

async function loadIncidentIfEditing(companyId){
	const params=new URLSearchParams(location.search); const id=params.get('id'); if(!id) return null;
	
	// Check if this is an action-only edit mode
	const editActionParam = params.get('editAction');
	if (editActionParam !== null) {
		actionOnlyEditMode = true;
		actionOnlyEditIndex = parseInt(editActionParam, 10);
		console.log('üîí Action-only edit mode enabled for action index:', actionOnlyEditIndex);
	}
	
	try {
		document.getElementById('incidentId').value=id;
		const ref=await db.ref(`companies/${companyId}/incidents/${id}`).once('value');
		if(!ref.exists()) {
			console.error('Incident not found:', id);
			return null;
		}
		const d=ref.val();
		console.log('Loading incident data:', d);
		
		// If action-only mode, update the page title and header
		if (actionOnlyEditMode) {
			document.title='Edit My Action - HSE System';
			const headerSpan = document.querySelector('.page-header span');
			if(headerSpan) headerSpan.textContent='Edit My Corrective Action';
		} else {
			document.title='Edit Incident - HSE System';
			const headerSpan = document.querySelector('.page-header span');
			if(headerSpan) headerSpan.textContent='Edit Incident';
		}
		
		const refNumberEl = document.getElementById('referenceNumber');
		if(refNumberEl) refNumberEl.value=d.referenceNumber||'';
		
		const titleEl = document.getElementById('incidentTitle');
		if(titleEl) titleEl.value=d.title||'';
		
		const severityEl = document.getElementById('severity');
		if(severityEl) severityEl.value=d.severity||'';
		// Set combined Date & Time input from stored date/time or dateTime
		(function setEditDateTime(){ const el=document.getElementById('incidentDateTime'); if(!el) return; let val=''; if(d.dateTime){ const m=d.dateTime.match(/^(\d{4}-\d{2}-\d{2})[T ](\d{2}:\d{2})/); if(m) val=`${m[1]}T${m[2]}`; } if(!val){ const date=(d.date||'').slice(0,10); const time=(d.time||'').slice(0,5); if(date){ val=`${date}T${time||'00:00'}`; } } if(val) el.value=val; })();
		
		const statusEl = document.getElementById('incidentStatus');
		if(statusEl) statusEl.value=d.status||'open';
		
		const locationEl = document.getElementById('eventLocation');
		if(locationEl) locationEl.value=d.location||'';
		
		const deptEl = document.getElementById('department');
		if(deptEl) deptEl.value=d.department||'';
		
		// Load Reported By fields
		const reportedByNameEl = document.getElementById('reportedByName');
		if(reportedByNameEl && d.reportedByName) reportedByNameEl.value=d.reportedByName;
		
		const reportedByIdEl = document.getElementById('reportedById');
		if(reportedByIdEl && d.reportedBy) reportedByIdEl.value=d.reportedBy;
		
		// Load Date Reported
		const dateReportedEl = document.getElementById('dateReported');
		if(dateReportedEl && d.dateReported) dateReportedEl.value=d.dateReported;
		
		const assignedToEl = document.getElementById('assignedTo');
		if(assignedToEl) assignedToEl.value=d.assignedTo||'';
		
		// Populate the user search field with selected user's name
		const userSearchEl = document.getElementById('userSearch');
		if(userSearchEl) {
			if(d.assignedToName){
				// Use stored name if available
				userSearchEl.value = d.assignedToName;
			} else if(d.assignedTo && typeof allUsers !== 'undefined'){
				// Fallback to finding user by ID
				const assignedUser = allUsers.find(u => u.id === d.assignedTo);
				if(assignedUser){
					userSearchEl.value = assignedUser.name + (assignedUser.title ? ' - ' + assignedUser.title : '');
				}
			}
		}
		
		const eventTypeEl = document.getElementById('eventType');
		if(eventTypeEl) eventTypeEl.value=d.eventType||'';
		
		const categoryEl = document.getElementById('incidentCategory');
		if(categoryEl) categoryEl.value=d.incidentCategory||'';
		// Load injury data
		if(d.injuryData){
			loadInjuryData(d.injuryData);
		}
		// Load property damage data
		if(d.propertyDamageData){
			loadPropertyDamageData(d.propertyDamageData);
		}
		
		const descEl = document.getElementById('description');
		if(descEl) descEl.value=d.description||'';
		
		const immediateEl = document.getElementById('immediateActions');
		if(immediateEl) immediateEl.value=d.immediateActions||'';
		
		// Load corrective actions
		if(Array.isArray(d.correctiveActions)){
			loadCorrectiveActions(d.correctiveActions);
		}
		
		const dueDateEl = document.getElementById('dueDate');
		if(dueDateEl) dueDateEl.value=d.dueDate||'';
		// existing attachments
		if(Array.isArray(d.attachments)){
			d.attachments.forEach(a=>{
				const sanitized = sanitizeAttachmentFields(a||{});
				// Assign unique id for table row tracking
				sanitized.id = Date.now() + Math.random().toString(36).substr(2, 9);
				sanitized.originalName = sanitized.name || 'Attachment';
				attachedFiles.push(sanitized);
			});
			renderFiles();
		}
		// Populate event-specific fields if present
		if(d.eventDetails){
			setEventDetailsFormValues(d.eventDetails);
		}
		// Ensure visibility/required states align with loaded type
		updateEventTypeFields();
		return d;
	} catch (error) {
		console.error('Error loading incident:', error);
		alert('Error loading incident: ' + error.message);
		return null;
	}
}

// ===== Incident Page i18n (EN/FR) =====
(function setupIncidentI18nGlobal(){
	const LANG_STORAGE_KEY = 'incidentboard_lang';
	const getLang = () => (localStorage.getItem(LANG_STORAGE_KEY) === 'fr' ? 'fr' : 'en');
	const I18N = {
		en: {
			page_title_report_incident: 'Report Incident',
			basic_information: 'Basic Information',
			reference: 'Reference',
			auto_generated: 'Auto-generated',
			title_label: 'Title *',
			severity: 'Severity *',
			select_severity: 'Select Severity',
			severity_low: 'Low',
			severity_medium: 'Medium',
			severity_high: 'High',
			event_type: 'Event Type',
			select_event_type: 'Select Event Type',
			near_miss: 'Near Miss',
			observation: 'Observation',
			incident: 'Incident',
			date_time: 'Date & Time *',
			status: 'Status',
			status_open: 'Open',
			status_in_progress: 'In Progress',
			status_closed: 'Closed',
			status_draft: 'Draft',
			location: 'Location *',
			select_location: 'Select Location',
			department: 'Department *',
			select_department: 'Select Department',
			assigned_to: 'Assigned To',
			type_to_search_employee: 'Type to search employee...',
			reported_by: 'Reported By',
			date_reported: 'Date Reported',
			event_specific_details: 'Event-specific Details',
			description: 'Description *',
			describe_what_happened: 'Describe what happened',
			incident_category: 'Incident Category',
			select_category: 'Select Category',
			injury_occurred: 'Injury Occurred',
			injured_persons: 'Injured Persons',
			add_person: 'Add Person',
			no_injured_persons: 'No injured persons added. Click "Add Person" to add one.',
			property_damage_occurred: 'Property Damage Occurred',
			damaged_items: 'Damaged Items',
			add_item: 'Add Item',
			no_damaged_items: 'No damaged items added. Click "Add Item" to add one.',
			immediate_actions: 'Immediate Actions',
			actions_taken_immediately: 'Actions taken immediately',
			corrective_actions: 'Corrective Actions',
			add_action: 'Add Action',
			no_actions_added: 'No corrective actions added. Click "Add Action" to create one.',
			due_date: 'Due Date',
			observation_type: 'Observation Type *',
			select: 'Select',
			safe: 'Safe',
			at_risk: 'At-Risk',
			category: 'Category *',
			person_involved: 'Person Involved',
			equipment_involved: 'Equipment Involved',
			add_corrective_action: 'Add Corrective Action',
			root_cause: 'Root Cause *',
			contributing_factors: 'Contributing Factors',
			attachments: 'Attachments',
			add_files: 'Add Files',
			max_5mb: 'Max 5MB each. You can rename files before saving.',
			table_preview: 'Preview',
			table_file_name: 'File Name',
			table_type: 'Type',
			table_size: 'Size',
			table_actions: 'Actions',
			no_files_uploaded: 'No files uploaded yet',
			cancel: 'Cancel',
			save_draft: 'Save Draft',
			submit_incident: 'Submit Incident',
			notifications: 'Notifications',
			mark_all_read: 'Mark all as read',
			no_notifications: 'No notifications',
			youre_all_caught_up: "You're all caught up",
			remove: 'Remove',
			person_number: (n)=>`Person #${n}`,
			injured_person_label: 'Injured Person *',
			injured_person_placeholder: 'Name of injured person',
			injury_type_label: 'Injury Type *',
			select_injury_type: 'Select Injury Type',
			body_part_label: 'Body Part Affected',
			select_body_part: 'Select Body Part',
			treatment_label: 'Treatment Provided',
			select_treatment: 'Select Treatment',
			lost_time_label: 'Lost Time Injury',
			yes: 'Yes',
			no: 'No',
			days_lost_label: 'Days Lost *',
			days_lost_placeholder: '0',
			item_number: (n)=>`Item #${n}`,
			damage_type_label: 'Damage Type *',
			select_damage_type: 'Select Damage Type',
			damaged_asset_label: 'Damaged Asset/Equipment *',
			damaged_asset_placeholder: 'Describe the damaged asset',
			estimated_cost_label: 'Estimated Cost',
			damage_description_label: 'Damage Description',
			damage_description_placeholder: 'Describe the extent of damage',
			obs_person_name_label: 'Person Name *',
			obs_person_name_placeholder: 'Name of person involved',
			obs_person_role_label: 'Role/Position',
			obs_person_role_placeholder: 'Their role or position',
			obs_person_involvement_label: 'Involvement Type',
			involvement_direct: 'Directly Involved',
			involvement_witness: 'Witness',
			involvement_supervisor: 'Supervisor',
			involvement_other: 'Other',
			obs_person_notes_label: 'Notes',
			obs_person_notes_placeholder: "Additional details about this person's involvement",
			equip_number: (n)=>`Equipment #${n}`,
			equip_name_label: 'Equipment Name/ID *',
			equip_name_placeholder: 'Equipment name or ID',
			equip_type_label: 'Equipment Type',
			vehicle: 'Vehicle',
			machinery: 'Machinery',
			tool: 'Hand Tool',
			power_tool: 'Power Tool',
			ppe: 'PPE',
			electrical: 'Electrical',
			lifting: 'Lifting Equipment',
			other: 'Other',
			condition_label: 'Condition',
			good: 'Good',
			needs_repair: 'Needs Repair',
			damaged: 'Damaged',
			unsafe: 'Unsafe',
			equip_notes_label: 'Notes',
			equip_notes_placeholder: 'Additional details about this equipment',
			action_number: (n)=>`Action #${n}`,
			action_description_label: 'Description *',
			action_description_placeholder: 'Describe the corrective action',
			responsible_person_label: 'Responsible Person *',
			due_date_required_label: 'Due Date *',
			status_required_label: 'Status *',
			status_pending: 'Pending',
			status_completed: 'Completed',
			status_overdue: 'Overdue',
			no_users_found: 'No users found',
			no_obs_persons: 'No persons added. Click "Add Person" to add one.',
			no_obs_equipment: 'No equipment added. Click "Add Equipment" to add one.',
			no_obs_corrective_actions: 'No corrective actions added. Click "Add Corrective Action" to add one.',
			rename: 'Rename',
			save: 'Save',
			delete: 'Delete'
		},
		fr: {
			page_title_report_incident: 'D√©clarer un incident',
			basic_information: 'Informations de base',
			reference: 'R√©f√©rence',
			auto_generated: 'G√©n√©r√© automatiquement',
			title_label: 'Titre *',
			severity: 'Gravit√© *',
			select_severity: 'S√©lectionner la gravit√©',
			severity_low: 'Faible',
			severity_medium: 'Moyenne',
			severity_high: '√âlev√©e',
			event_type: "Type d‚Äô√©v√©nement",
			select_event_type: "S√©lectionner le type d‚Äô√©v√©nement",
			near_miss: 'Quasi-accident',
			observation: 'Observation',
			incident: 'Incident',
			date_time: 'Date et heure *',
			status: 'Statut',
			status_open: 'Ouvert',
			status_in_progress: 'En cours',
			status_closed: 'Ferm√©',
			status_draft: 'Brouillon',
			location: 'Lieu *',
			select_location: 'S√©lectionner le lieu',
			department: 'D√©partement *',
			select_department: 'S√©lectionner le d√©partement',
			assigned_to: 'Assign√© √†',
			type_to_search_employee: 'Tapez pour rechercher un employ√©...',
			reported_by: 'D√©clar√© par',
			date_reported: 'Date de d√©claration',
			event_specific_details: "D√©tails sp√©cifiques √† l‚Äô√©v√©nement",
			description: 'Description *',
			describe_what_happened: 'D√©crivez ce qui s‚Äôest pass√©',
			incident_category: "Cat√©gorie d‚Äôincident",
			select_category: 'S√©lectionner la cat√©gorie',
			injury_occurred: 'Blessure survenue',
			injured_persons: 'Personnes bless√©es',
			add_person: 'Ajouter une personne',
			no_injured_persons: 'Aucune personne bless√©e ajout√©e. Cliquez sur ¬´ Ajouter une personne ¬ª pour en ajouter.',
			property_damage_occurred: 'Dommage mat√©riel survenu',
			damaged_items: 'Objets endommag√©s',
			add_item: 'Ajouter un objet',
			no_damaged_items: 'Aucun objet endommag√© ajout√©. Cliquez sur ¬´ Ajouter un objet ¬ª pour en ajouter un.',
			immediate_actions: 'Actions imm√©diates',
			actions_taken_immediately: 'Actions prises imm√©diatement',
			corrective_actions: 'Actions correctives',
			add_action: 'Ajouter une action',
			no_actions_added: 'Aucune action corrective ajout√©e. Cliquez sur ¬´ Ajouter une action ¬ª pour en cr√©er une.',
			due_date: "Date d‚Äô√©ch√©ance",
			observation_type: 'Type d‚Äôobservation *',
			select: 'S√©lectionner',
			safe: 'S√ªr',
			at_risk: '√Ä risque',
			category: 'Cat√©gorie *',
			person_involved: 'Personne impliqu√©e',
			equipment_involved: '√âquipement impliqu√©',
			add_corrective_action: 'Ajouter une action corrective',
			root_cause: 'Cause racine *',
			contributing_factors: 'Facteurs contributifs',
			attachments: 'Pi√®ces jointes',
			add_files: 'Ajouter des fichiers',
			max_5mb: 'Max 5 Mo chacun. Vous pouvez renommer les fichiers avant de les enregistrer.',
			table_preview: 'Aper√ßu',
			table_file_name: 'Nom du fichier',
			table_type: 'Type',
			table_size: 'Taille',
			table_actions: 'Actions',
			no_files_uploaded: 'Aucun fichier t√©l√©vers√©',
			cancel: 'Annuler',
			save_draft: 'Enregistrer le brouillon',
			submit_incident: "Soumettre l‚Äôincident",
			notifications: 'Notifications',
			mark_all_read: 'Tout marquer comme lu',
			no_notifications: 'Aucune notification',
			youre_all_caught_up: 'Vous √™tes √† jour',
			remove: 'Supprimer',
			person_number: (n)=>`Personne #${n}`,
			injured_person_label: 'Personne bless√©e *',
			injured_person_placeholder: 'Nom de la personne bless√©e',
			injury_type_label: 'Type de blessure *',
			select_injury_type: 'S√©lectionner le type de blessure',
			body_part_label: 'Partie du corps affect√©e',
			select_body_part: 'S√©lectionner la partie du corps',
			treatment_label: 'Traitement fourni',
			select_treatment: 'S√©lectionner le traitement',
			lost_time_label: 'Blessure avec arr√™t de travail',
			yes: 'Oui',
			no: 'Non',
			days_lost_label: 'Jours perdus *',
			days_lost_placeholder: '0',
			item_number: (n)=>`√âl√©ment #${n}`,
			damage_type_label: 'Type de dommage *',
			select_damage_type: 'S√©lectionner le type de dommage',
			damaged_asset_label: 'Actif/√©quipement endommag√© *',
			damaged_asset_placeholder: "D√©crivez l‚Äôactif endommag√©",
			estimated_cost_label: 'Co√ªt estim√©',
			damage_description_label: 'Description du dommage',
			damage_description_placeholder: "D√©crivez l‚Äôampleur du dommage",
			obs_person_name_label: 'Nom de la personne *',
			obs_person_name_placeholder: 'Nom de la personne impliqu√©e',
			obs_person_role_label: 'R√¥le/Poste',
			obs_person_role_placeholder: 'Son r√¥le ou poste',
			obs_person_involvement_label: "Type d‚Äôimplication",
			involvement_direct: 'Directement impliqu√©',
			involvement_witness: 'T√©moin',
			involvement_supervisor: 'Superviseur',
			involvement_other: 'Autre',
			obs_person_notes_label: 'Notes',
			obs_person_notes_placeholder: 'D√©tails suppl√©mentaires sur l‚Äôimplication de cette personne',
			equip_number: (n)=>`√âquipement #${n}`,
			equip_name_label: "Nom/ID de l‚Äô√©quipement *",
			equip_name_placeholder: "Nom ou ID de l‚Äô√©quipement",
			equip_type_label: "Type d‚Äô√©quipement",
			vehicle: 'V√©hicule',
			machinery: 'Machinerie',
			tool: 'Outil √† main',
			power_tool: 'Outil √©lectrique',
			ppe: 'EPI',
			electrical: '√âlectrique',
			lifting: '√âquipement de levage',
			other: 'Autre',
			condition_label: '√âtat',
			good: 'Bon',
			needs_repair: '√Ä r√©parer',
			damaged: 'Endommag√©',
			unsafe: 'Dangereux',
			equip_notes_label: 'Notes',
			equip_notes_placeholder: 'D√©tails suppl√©mentaires sur cet √©quipement',
			action_number: (n)=>`Action #${n}`,
			action_description_label: 'Description *',
			action_description_placeholder: "D√©crivez l‚Äôaction corrective",
			responsible_person_label: 'Personne responsable *',
			due_date_required_label: "Date d‚Äô√©ch√©ance *",
			status_required_label: 'Statut *',
			status_pending: 'En attente',
			status_completed: 'Termin√©',
			status_overdue: 'En retard',
			no_users_found: 'Aucun utilisateur trouv√©',
			no_obs_persons: 'Aucune personne ajout√©e. Cliquez sur ¬´ Ajouter une personne ¬ª pour en ajouter une.',
			no_obs_equipment: 'Aucun √©quipement ajout√©. Cliquez sur ¬´ Ajouter un √©quipement ¬ª pour en ajouter un.',
			no_obs_corrective_actions: 'Aucune action corrective ajout√©e. Cliquez sur ¬´ Ajouter une action corrective ¬ª pour en ajouter une.',
			rename: 'Renommer',
			save: 'Enregistrer',
			delete: 'Supprimer'
		}
	};

	function incidentT(key, ...args){
		const lang = getLang();
		const dict = I18N[lang] || I18N.en;
		const val = dict[key];
		const resolved = typeof val === 'function' ? val(...args) : (val ?? (I18N.en[key] ?? key));
		return resolved;
	}
	window.incidentT = incidentT;

	window.applyIncidentI18n = function(){
		const tt = window.incidentT;
		// Header
		const hdr = document.querySelector('.page-header h1');
		if(hdr){ hdr.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${tt('page_title_report_incident')}`; }
		// Notifications texts
		const notifTitle = document.querySelector('.notification-header h3'); if(notifTitle) notifTitle.textContent = tt('notifications');
		const markAll = document.querySelector('.mark-all-read'); if(markAll) markAll.textContent = tt('mark_all_read');
		const emptyTitle = document.querySelector('.notification-empty-title'); if(emptyTitle) emptyTitle.textContent = tt('no_notifications');
		const emptyMsg = document.querySelector('.notification-empty-message'); if(emptyMsg) emptyMsg.textContent = tt('youre_all_caught_up');
		// Sections
		document.querySelectorAll('.form-section h3').forEach(h3 => {
			const txt = h3.textContent.trim();
			if(txt.includes('Basic Information')) h3.textContent = tt('basic_information');
			if(txt.includes('Event-specific Details')) h3.textContent = tt('event_specific_details');
			if(txt.includes('Attachments')){
				const span = h3.querySelector('span'); if(span){ span.innerHTML = `<i class="fas fa-paperclip" style="margin-right:8px"></i>${tt('attachments')}`; }
				const lbl = h3.querySelector('label'); if(lbl){ lbl.firstChild.textContent = ` ${tt('add_files')}`; }
			}
		});
		// Labels and placeholders
		const setLabel = (forId, key)=>{ const el=document.querySelector(`label[for="${forId}"]`); if(el) el.textContent = tt(key); };
		setLabel('referenceNumber','reference'); const refInput = document.getElementById('referenceNumber'); if(refInput) refInput.placeholder = tt('auto_generated');
		setLabel('incidentTitle','title_label'); setLabel('severity','severity'); setLabel('eventType','event_type');
		setLabel('incidentDateTime','date_time'); setLabel('incidentStatus','status'); setLabel('eventLocation','location'); setLabel('department','department');
		setLabel('assignedTo','assigned_to'); const userSearch=document.getElementById('userSearch'); if(userSearch) userSearch.placeholder=tt('type_to_search_employee');
		setLabel('reportedByName','reported_by'); setLabel('dateReported','date_reported');
		setLabel('description','description'); const desc=document.getElementById('description'); if(desc) desc.placeholder=tt('describe_what_happened');
		setLabel('incidentCategory','incident_category'); const catSel=document.getElementById('incidentCategory'); if(catSel && catSel.options.length){ const first=catSel.options[0]; if(first && first.value==='') first.textContent=tt('select_category'); }
		const injLabel=document.querySelector('label[for="hasInjury"]'); if(injLabel) injLabel.textContent=tt('injury_occurred');
		const injHeader=document.querySelector('.injured-persons-header h5'); if(injHeader){ injHeader.innerHTML = `<i class="fas fa-user-injured"></i> ${tt('injured_persons')}`; }
		const addPersonBtn=document.querySelector('.btn-add-injured'); if(addPersonBtn) addPersonBtn.innerHTML = `<i class="fas fa-plus"></i> ${tt('add_person')}`;
		const noInjured=document.querySelector('#injuredPersonsList .no-injured-msg'); if(noInjured) noInjured.textContent=tt('no_injured_persons');
		const pdLabel=document.querySelector('label[for="hasPropertyDamage"]'); if(pdLabel) pdLabel.textContent=tt('property_damage_occurred');
		const pdHeader=document.querySelector('.property-damage-header h5'); if(pdHeader){ pdHeader.innerHTML = `<i class="fas fa-building"></i> ${tt('damaged_items')}`; }
		const addItemBtn=document.querySelector('.btn-add-damage'); if(addItemBtn) addItemBtn.innerHTML = `<i class="fas fa-plus"></i> ${tt('add_item')}`;
		const noDamage=document.querySelector('#propertyDamageList .no-damage-msg'); if(noDamage) noDamage.textContent=tt('no_damaged_items');
		const immLab=document.querySelector('label[for="immediateActions"]'); if(immLab) immLab.textContent=tt('immediate_actions');
		const immInput=document.getElementById('immediateActions'); if(immInput) immInput.placeholder=tt('actions_taken_immediately');
		const corrHeader=document.querySelector('.corrective-actions-header h4'); if(corrHeader) corrHeader.innerHTML = `<i class="fas fa-tasks"></i> ${tt('corrective_actions')}`;
		const addActionBtn=document.querySelector('.corrective-actions-header .btn-add-action'); if(addActionBtn) addActionBtn.innerHTML = `<i class="fas fa-plus"></i> ${tt('add_action')}`;
		const noActions=document.querySelector('#correctiveActionsList .no-actions-msg'); if(noActions) noActions.textContent=tt('no_actions_added');
		setLabel('dueDate','due_date');
		setLabel('obsType','observation_type'); const obsTypeSel=document.getElementById('obsType'); if(obsTypeSel && obsTypeSel.options.length){ obsTypeSel.options[0].textContent=tt('select'); const safeOpt=obsTypeSel.querySelector('option[value="safe"]'); if(safeOpt) safeOpt.textContent=tt('safe'); const atRiskOpt=obsTypeSel.querySelector('option[value="at-risk"]'); if(atRiskOpt) atRiskOpt.textContent=tt('at_risk'); }
		setLabel('obsCategory','category'); const obsCatSel=document.getElementById('obsCategory'); if(obsCatSel && obsCatSel.options.length){ obsCatSel.options[0].textContent=tt('select'); }
		const piLabel=document.querySelector('label[for="obsHasPersonInvolved"]'); if(piLabel) piLabel.textContent=tt('person_involved');
		const eiLabel=document.querySelector('label[for="obsHasEquipmentInvolved"]'); if(eiLabel) eiLabel.textContent=tt('equipment_involved');
		const addObsPerson=document.querySelector('#obsPersonInvolvedFields .btn-add-action'); if(addObsPerson) addObsPerson.innerHTML = `<i class=\"fas fa-plus\"></i> ${tt('add_person')}`;
		const addObsEquip=document.querySelector('#obsEquipmentInvolvedFields .btn-add-action'); if(addObsEquip) addObsEquip.innerHTML = `<i class=\"fas fa-plus\"></i> ${tt('add_item')}`;
		const obsCAHeader=document.querySelector('#observationFields .form-group > label'); if(obsCAHeader && obsCAHeader.textContent.trim().startsWith('Corrective Actions')) obsCAHeader.textContent = tt('corrective_actions');
		const addObsCA=document.querySelector('#observationFields .btn-add-action[onclick*="addObsCorrectiveAction"]'); if(addObsCA) addObsCA.innerHTML = `<i class=\"fas fa-plus\"></i> ${tt('add_corrective_action')}`;
		setLabel('incRootCause','root_cause'); setLabel('incContributingFactors','contributing_factors');
		const infoSmall=document.querySelector('.form-section small'); if(infoSmall) infoSmall.textContent = tt('max_5mb');
		const ths=document.querySelectorAll('#attachmentsTable thead th'); if(ths.length>=5){ ths[0].textContent=tt('table_preview'); ths[1].textContent=tt('table_file_name'); ths[2].textContent=tt('table_type'); ths[3].textContent=tt('table_size'); ths[4].textContent=tt('table_actions'); }
		const emptyFiles=document.querySelector('#attachmentsEmpty p'); if(emptyFiles) emptyFiles.textContent=tt('no_files_uploaded');
		const cancelBtn=document.getElementById('cancelBtn'); if(cancelBtn) cancelBtn.textContent=tt('cancel');
		const saveBtn=document.getElementById('saveDraftBtn'); if(saveBtn) saveBtn.textContent=tt('save_draft');
		const submitBtn=document.getElementById('submitBtn'); if(submitBtn) submitBtn.textContent=tt('submit_incident');
		// Select options texts
		const sevSel=document.getElementById('severity'); if(sevSel){ const opts=sevSel.querySelectorAll('option'); if(opts.length){ opts[0].textContent=tt('select_severity'); const low=sevSel.querySelector('option[value="low"]'); const med=sevSel.querySelector('option[value="medium"]'); const high=sevSel.querySelector('option[value="high"]'); if(low) low.textContent=tt('severity_low'); if(med) med.textContent=tt('severity_medium'); if(high) high.textContent=tt('severity_high'); }}
		const statusSel=document.getElementById('incidentStatus'); if(statusSel){ const open=statusSel.querySelector('option[value="open"]'); const ip=statusSel.querySelector('option[value="in-progress"]'); const closed=statusSel.querySelector('option[value="closed"]'); const draft=statusSel.querySelector('option[value="draft"]'); if(open) open.textContent=incidentT('status_open'); if(ip) ip.textContent=incidentT('status_in_progress'); if(closed) closed.textContent=incidentT('status_closed'); if(draft) draft.textContent=incidentT('status_draft'); }
		const etSel=document.getElementById('eventType'); if(etSel){ const first=etSel.querySelector('option[value=""]'); if(first) first.textContent=incidentT('select_event_type'); const nm=etSel.querySelector('option[value="near-miss"]'); const ob=etSel.querySelector('option[value="observation"]'); const ic=etSel.querySelector('option[value="incident"]'); if(nm) nm.textContent=incidentT('near_miss'); if(ob) ob.textContent=incidentT('observation'); if(ic) ic.textContent=incidentT('incident'); }
	};
})();

document.addEventListener('DOMContentLoaded',()=>{
	bindSidebarToggle();
	const now=new Date();
	const today=now.toISOString().split('T')[0];
	const dtEl=document.getElementById('incidentDateTime'); if(dtEl) dtEl.value=toLocalDateTimeInputValue(now);
	document.getElementById('dateReported').value=today;
	// Notification dropdown toggle
	(function bindNotifications(){
		const btn=document.getElementById('notificationBtn');
		const dropdown=document.querySelector('.notification-dropdown');
		const badge=document.querySelector('.notification-badge');
		if(badge) badge.style.display='none';
		if(btn && dropdown){
			btn.addEventListener('click', (e)=>{ e.stopPropagation(); dropdown.classList.toggle('show'); });
			document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && !btn.contains(e.target)) dropdown.classList.remove('show'); });
		}
		const markAll=document.querySelector('.mark-all-read');
		if(markAll){ markAll.addEventListener('click', ()=>{ dropdown?.classList.remove('show'); if(badge) badge.style.display='none'; }); }
	})();
	// Language toggle initialization (shared with Incident Board)
	(function initLangToggle(){
		const LANG_STORAGE_KEY = 'incidentboard_lang';
		const langBtn = document.getElementById('langToggleBtn');
		const langSelect = document.getElementById('langSelect');
		const getLang = () => {
			const stored = localStorage.getItem(LANG_STORAGE_KEY);
			return stored === 'fr' ? 'fr' : 'en';
		};
		const setLang = (lang) => {
			localStorage.setItem(LANG_STORAGE_KEY, lang);
			document.documentElement.setAttribute('lang', lang);
			if (langBtn) langBtn.textContent = lang === 'fr' ? 'FR' : 'EN';
			if (langSelect) langSelect.value = lang;
		};
		const current = getLang();
		setLang(current);
		if (langBtn){
			langBtn.addEventListener('mouseenter', ()=>{ langBtn.style.background = '#f9fafb'; });
			langBtn.addEventListener('mouseleave', ()=>{ langBtn.style.background = '#ffffff'; });
			langBtn.addEventListener('mousedown', ()=>{ langBtn.style.background = '#f3f4f6'; });
			langBtn.addEventListener('mouseup', ()=>{ langBtn.style.background = '#ffffff'; });
			langBtn.addEventListener('click', ()=>{
				const next = getLang() === 'en' ? 'fr' : 'en';
				setLang(next);
				window.dispatchEvent(new CustomEvent('languageChanged', { detail: { lang: next } }));
			});
		}
	})();

	// Apply i18n on load and when language changes
	if (window.applyIncidentI18n) {
		window.applyIncidentI18n();
		window.addEventListener('languageChanged', ()=> window.applyIncidentI18n());
	}
});

// Use centralized AuthManager
const authManager = new AuthManager();
// Expose for menu authorization system
window.authManager = authManager;
async function waitForCompanyId(timeoutMs=6000){
	const start=Date.now();
	return new Promise(resolve=>{
		const t=setInterval(()=>{
			if(authManager.currentUser && authManager.currentUser.companyId){ clearInterval(t); resolve(); }
			else if(Date.now()-start>timeoutMs){ clearInterval(t); resolve(); }
		},150);
	});
}

// ========== Email Notification Function ==========
const EMAILJS_CONFIG = {
	publicKey: 'fHs6oaqQgkcPoUwpv',
	serviceId: 'service_p2e9swy',
	templateId: 'template_rew55vo'
};

// Initialize EmailJS
if (typeof emailjs !== 'undefined') {
	emailjs.init(EMAILJS_CONFIG.publicKey);
}

// Send incident notification email
async function sendIncidentNotificationEmail(companyId, incident, eventType, isUpdate = false) {
	if (!companyId || !incident) return;
	
	try {
		// Check if notifications are enabled for this event type and action
		const settingsSnap = await db.ref(`companies/${companyId}/incidentSettings/notifications`).once('value');
		const settings = settingsSnap.val() || {};
		
		// Map event types to settings and recipient paths
		const typeConfig = {
			'incident': { onSubmission: 'incidentOnSubmission', onUpdate: 'incidentOnUpdate', recipients: 'incidentRecipients', label: 'Incident' },
			'near-miss': { onSubmission: 'nearMissOnSubmission', onUpdate: 'nearMissOnUpdate', recipients: 'nearMissRecipients', label: 'Near Miss' },
			'observation': { onSubmission: 'observationOnSubmission', onUpdate: 'observationOnUpdate', recipients: 'observationRecipients', label: 'Observation' }
		};
		
		const config = typeConfig[eventType?.toLowerCase()] || typeConfig['incident'];
		
		// Check if notification should be sent based on submission/update setting
		const settingKey = isUpdate ? config.onUpdate : config.onSubmission;
		const isEnabled = isUpdate ? (settings[settingKey] === true) : (settings[settingKey] !== false);
		
		if (!isEnabled) {
			console.log(`Notifications disabled for ${eventType} ${isUpdate ? 'updates' : 'submissions'}`);
			return;
		}
		
		// Get recipients for this event type from notification settings
		const recipients = settings[config.recipients] || {};
		const emails = Object.values(recipients).map(r => r.email).filter(e => e);
		
		// Also add the assigned user (responsible person) to the notification list
		if (incident.assignedTo) {
			try {
				const assignedUserSnap = await db.ref(`companies/${companyId}/users/${incident.assignedTo}`).once('value');
				const assignedUser = assignedUserSnap.val();
				if (assignedUser && assignedUser.email && !emails.includes(assignedUser.email)) {
					emails.push(assignedUser.email);
					console.log('Added assigned user to notification recipients:', assignedUser.email);
				}
			} catch (err) {
				console.warn('Could not fetch assigned user for notification:', err);
			}
		}
		
		if (emails.length === 0) {
			console.log(`No notification recipients configured for ${eventType}`);
			return;
		}
		
		// Get company info
		const companySnap = await db.ref(`companies/${companyId}`).once('value');
		const company = companySnap.val() || {};
		const companyName = company.companyName || 'Company';
		
		if (typeof emailjs === 'undefined') {
			console.warn('EmailJS not loaded, cannot send notification');
			return;
		}
		
		// Send to each recipient individually
		for (const email of emails) {
			try {
				const reporterName = incident.reportedByName || incident.reportedBy || 'HSE System';
				const eventDate = incident.date || incident.incidentDate || new Date().toLocaleDateString();
				const refNumber = incident.referenceNumber || incident.id || 'N/A';
				const severityText = (incident.severity || 'Not specified').charAt(0).toUpperCase() + (incident.severity || 'Not specified').slice(1);
				
				// Determine action text based on submission/update
				const actionText = isUpdate ? 'has been updated' : 'has been reported';
				const subjectPrefix = isUpdate ? 'Updated' : 'New';
				const notificationContext = isUpdate ? 'HSE Event Update Notification' : 'New HSE Event Notification';
				
				// Format message to match Position Approval Request design
				const messageBody = `Dear HSE Team,

${isUpdate ? 'An existing' : 'A new'} ${config.label.toLowerCase()} ${actionText} and requires your attention.

EVENT DETAILS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Event Type: ${config.label}
Title: ${incident.title || 'Untitled'}
Reference Number: ${refNumber}
Date of Event: ${eventDate}
Location: ${incident.location || 'Not specified'}
Severity Level: ${severityText}
Department: ${incident.department || 'Not specified'}
Reported By: ${reporterName}
Status: ${incident.status || (isUpdate ? 'Updated' : 'Open')}

DESCRIPTION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${incident.description || 'No description provided'}

${incident.immediateActions ? `IMMEDIATE ACTIONS TAKEN:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${incident.immediateActions}\n\n` : ''}Please review this ${config.label.toLowerCase()} through the HSE System and take appropriate action.

Review Link: ${window.location.origin}/incidentboard.html

Best regards,
${companyName} HSE System

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
This is an automated notification from the HSE Management System.
If you have questions, please contact your HSE department.`;

				// EmailJS template variables - matching position approval template structure
				const emailData = {
					// Basic email configuration
					to_email: email,
					to_name: 'HSE Team',
					from_name: companyName + ' HSE System',
					subject: `[HSE Alert] ${subjectPrefix} ${config.label}: ${incident.title || 'Untitled'} - ${refNumber}`,
					
					// Main message content
					message: messageBody,
					
					// Position approval template compatible variables
					position_title: `${config.label}: ${incident.title || 'Untitled'}`,
					position_code: refNumber,
					department: incident.department || config.label,
					requesting_manager: reporterName,
					request_date: eventDate,
					
					// Employment/Event details (mapped for template compatibility)
					employment_type: config.label,
					work_location: incident.location || 'Not specified',
					working_hours: eventDate,
					contract_duration: severityText,
					reporting_manager: reporterName,
					budget_code: refNumber,
					
					// Severity as salary fields for visual display
					salary_min: severityText,
					salary_max: incident.status || (isUpdate ? 'Updated' : 'Open'),
					annual_budget_impact: config.label,
					benefits_package: incident.department || 'HSE',
					department_budget: isUpdate ? 'Event Updated' : 'New Event',
					
					// Approval workflow fields
					current_stage: '1',
					total_stages: '1',
					approver_role: 'HSE Reviewer',
					approval_type: 'Review Required',
					notification_context: notificationContext,
					
					// Business justification (event details)
					business_need: incident.description || 'No description provided',
					key_responsibilities: incident.immediateActions || 'Review and take appropriate action',
					required_skills: `Location: ${incident.location || 'Not specified'}`,
					required_experience: `Severity: ${severityText}`,
					priority_level: incident.severity || 'medium',
					
					// Action links
					approval_link: `${window.location.origin}/incidentboard.html`,
					system_link: `${window.location.origin}/incidentboard.html`,
					
					// Company information
					company_name: companyName,
					company_email: 'info@dreamexdatalab.com',
					company_initial: companyName.charAt(0).toUpperCase(),
					
					// Contact information
					hr_email: 'hse@dreamexdatalab.com',
					budget_team_email: 'hse@dreamexdatalab.com',
					
					// System information
					request_id: refNumber,
					generation_timestamp: new Date().toLocaleString(),
					submission_date: eventDate,
					
					// HSE specific variables (for custom templates)
					incident_type: config.label,
					incident_title: incident.title || 'Untitled',
					incident_date: eventDate,
					incident_location: incident.location || 'Not specified',
					incident_severity: severityText,
					incident_description: incident.description || 'No description provided',
					incident_status: incident.status || (isUpdate ? 'Updated' : 'Open'),
					incident_department: incident.department || 'Not specified',
					incident_reporter: reporterName,
					immediate_actions: incident.immediateActions || 'N/A',
					reference_number: refNumber,
					is_update: isUpdate ? 'Yes' : 'No',
					event_action: isUpdate ? 'Updated' : 'New Submission'
				};
				
				const response = await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, emailData);
				console.log('Notification sent to:', email, response);
			} catch (err) {
				console.error('Failed to send notification to:', email, err);
			}
		}
		
		console.log(`Notification emails sent for ${eventType} ${isUpdate ? 'update' : 'submission'}`);
	} catch (error) {
		console.error('Error sending incident notification:', error);
	}
}
// ========== End Email Notification Function ==========

(async function initIncidentPage(){
	await waitForCompanyId();

	// Bind Cancel and Save Draft early so they work even if auth is delayed
	const cancelBtnEarly=document.getElementById('cancelBtn');
	if(cancelBtnEarly){
		cancelBtnEarly.onclick=()=>{ if(confirm('Cancel and discard changes?')) location.href='incidentboard.html'; };
	}
	const saveDraftBtnEarly = document.getElementById('saveDraftBtn');
	if (saveDraftBtnEarly) {
		saveDraftBtnEarly.onclick=async ()=>{
			try {
				console.log('Save draft button clicked (early binding)');
				if (!authManager || !authManager.currentUser) { alert('User not authenticated. Please refresh and try again.'); return; }
				if (!db) { alert('Database connection not available. Please refresh and try again.'); return; }
				const currentUser = authManager.currentUser;
				const currentCompanyId = currentUser.companyId;
				if (!currentCompanyId) { alert('Company ID not found. Please refresh and try again.'); return; }
				const id=document.getElementById('incidentId').value;
				const ref=id? db.ref(`companies/${currentCompanyId}/incidents/${id}`): db.ref(`companies/${currentCompanyId}/incidents`).push();
				const todayStr=new Date().toISOString().split('T')[0];
				const dt=getDateTimeParts();
				// Serialize attachments for draft as well so modal can display them
				const attachments = await uploadAttachments();
				let createdAt = new Date().toISOString();
				if (id) {
					try {
						const existingSnap = await db.ref(`companies/${currentCompanyId}/incidents/${id}`).once('value');
						if (existingSnap.exists()) createdAt = existingSnap.val()?.createdAt || new Date().toISOString();
					} catch (err) { console.warn('Could not get existing createdAt:', err); }
				}
				const payload={
					referenceNumber: document.getElementById('referenceNumber').value || `INC-${Date.now()}`,
					title: document.getElementById('incidentTitle').value || 'Draft Incident',
					severity: document.getElementById('severity').value || 'low',
					eventType: document.getElementById('eventType').value || 'incident',
					date: dt.date || todayStr,
					time: dt.time || '',
					dateTime: dt.iso,
					status:'draft',
					location: document.getElementById('eventLocation').value||'',
					department: document.getElementById('department').value||'',
					assignedTo: document.getElementById('assignedTo').value||'',
					assignedToName: document.getElementById('userSearch').value||'',
					incidentCategory: document.getElementById('incidentCategory').value||'',
					injuryData: getInjuryData(),
					propertyDamageData: getPropertyDamageData(),
					description: document.getElementById('description').value||'',
					immediateActions: document.getElementById('immediateActions').value||'',
					correctiveActions: getCorrectiveActionsData(),
					dueDate: document.getElementById('dueDate').value||'',
					eventDetails: getEventDetailsFromForm(),
					reportedBy: currentUser.uid, reportedByName: document.getElementById('reportedByName').value, dateReported: document.getElementById('dateReported').value,
					attachments,
					updatedAt: new Date().toISOString(), createdAt
				};
				console.log('Saving draft with payload (early binding):', payload);
				await ref.update(payload);
				alert('Draft saved'); location.href='incidentboard.html';
			} catch (error) {
				console.error('Error saving draft (early binding):', error);
				alert('Error saving draft: ' + (error?.message || error));
			}
		};
	}
	const user = authManager.currentUser;
	if(!user){ return; }
	const companyId = user.companyId;
	document.getElementById('reportedByName').value = authManager.getUserDisplayName();
	document.getElementById('reportedById').value = user.uid;

	await Promise.all([loadOptions(companyId), loadLocations(companyId), loadDepartments(companyId), loadUsers(), loadAllUsers(companyId), loadObservationTypes(companyId)]);
	const existing=await loadIncidentIfEditing(companyId);
	initializeUserSearch();
	if(!existing) await generateReference();

	// Bind dynamic field logic
	const et=document.getElementById('eventType'); if(et){ et.addEventListener('change', updateEventTypeFields); }
	updateEventTypeFields();

	// Initialize sidebar feature/role-based menu authorization
	if (typeof initializeMenuAuthorization === 'function') {
		initializeMenuAuthorization();
	}

	document.getElementById('cancelBtn').onclick=()=>{ if(confirm('Cancel and discard changes?')) location.href='incidentboard.html'; };
	
	const saveDraftBtn = document.getElementById('saveDraftBtn');
	if (!saveDraftBtn) {
		console.error('Save Draft button not found!');
		return;
	}
	
	saveDraftBtn.onclick=async ()=>{
		try {
			console.log('Save draft button clicked');
			
			if (!authManager || !authManager.currentUser) {
				alert('User not authenticated. Please refresh and try again.');
				return;
			}
			
			if (!db) {
				alert('Database connection not available. Please refresh and try again.');
				return;
			}
			
			const currentUser = authManager.currentUser;
			const currentCompanyId = currentUser.companyId;
			
			if (!currentCompanyId) {
				alert('Company ID not found. Please refresh and try again.');
				return;
			}
			
			console.log('User and database validated, proceeding with save...');
			
			const id=document.getElementById('incidentId').value;
			const ref=id? db.ref(`companies/${currentCompanyId}/incidents/${id}`): db.ref(`companies/${currentCompanyId}/incidents`).push();
			const todayStr=new Date().toISOString().split('T')[0];
			const dt=getDateTimeParts();
			// Serialize attachments for draft so they appear in modal
			const attachments = await uploadAttachments();
			
			// Get existing record for createdAt if editing
			let createdAt = new Date().toISOString();
			if (id) {
				try {
					const existingSnap = await db.ref(`companies/${currentCompanyId}/incidents/${id}`).once('value');
					if (existingSnap.exists()) {
						createdAt = existingSnap.val()?.createdAt || new Date().toISOString();
					}
				} catch (err) {
					console.warn('Could not get existing createdAt:', err);
				}
			}
			
			const payload={
				referenceNumber: document.getElementById('referenceNumber').value || `INC-${Date.now()}`,
				title: document.getElementById('incidentTitle').value || 'Draft Incident',
				severity: document.getElementById('severity').value || 'low',
				eventType: document.getElementById('eventType').value || 'incident',
				date: dt.date || todayStr,
				time: dt.time || '',
				dateTime: dt.iso,
				status:'draft',
				location: document.getElementById('eventLocation').value||'',
				department: document.getElementById('department').value||'',
				assignedTo: document.getElementById('assignedTo').value||'',
				assignedToName: document.getElementById('userSearch').value||'',
				incidentCategory: document.getElementById('incidentCategory').value||'',
				injuryData: getInjuryData(),
				propertyDamageData: getPropertyDamageData(),
				description: document.getElementById('description').value||'',
				immediateActions: document.getElementById('immediateActions').value||'',
				correctiveActions: getCorrectiveActionsData(),
				dueDate: document.getElementById('dueDate').value||'',
				eventDetails: getEventDetailsFromForm(),
				reportedBy: currentUser.uid, 
				reportedByName: document.getElementById('reportedByName').value, 
				dateReported: document.getElementById('dateReported').value,
				attachments,
				updatedAt: new Date().toISOString(), 
				createdAt
			};
			console.log('Saving draft with payload:', payload);
			await ref.update(payload);
			console.log('Draft saved successfully');
			alert('Draft saved'); 
			location.href='incidentboard.html';
		} catch (error) {
			console.error('Error saving draft:', error);
			alert('Error saving draft: ' + (error?.message || error));
		}
	};

	document.getElementById('incidentForm').addEventListener('submit', async (e)=>{
		e.preventDefault();
		
		// Validate injury and property damage sections
		const hasInjury = document.getElementById('hasInjury').checked;
		const hasPropertyDamage = document.getElementById('hasPropertyDamage').checked;
		
		if (hasInjury) {
			const injuredPersons = getInjuredPersonsData();
			if (injuredPersons.length === 0) {
				const proceed = confirm('No injured persons added. Proceed anyway, or click Cancel to add at least one person?');
				if (!proceed) return;
			}
			
			// Validate required fields for each injured person
			let missingInjuryFields = [];
			for (let i = 0; i < injuredPersons.length; i++) {
				const person = injuredPersons[i];
				const missing = [];
				if (!person.name) missing.push('Name');
				if (!person.injuryType) missing.push('Injury Type');
				if (missing.length) missingInjuryFields.push(`#${i + 1}: ${missing.join(', ')}`);
			}
			if (missingInjuryFields.length) {
				const proceed = confirm('Some injured persons have missing required fields:\n' + missingInjuryFields.join('\n') + '\n\nProceed anyway?');
				if (!proceed) return;
			}
		}
		
		if (hasPropertyDamage) {
			const damageItems = getPropertyDamageItemsData();
			if (damageItems.length === 0) {
				const proceed = confirm('No damaged items added. Proceed anyway, or click Cancel to add at least one item?');
				if (!proceed) return;
			}
			
			// Validate required fields for each damage item
			let missingDamageFields = [];
			for (let i = 0; i < damageItems.length; i++) {
				const item = damageItems[i];
				const missing = [];
				if (!item.damageType) missing.push('Damage Type');
				if (!item.damagedAsset) missing.push('Asset');
				if (missing.length) missingDamageFields.push(`#${i + 1}: ${missing.join(', ')}`);
			}
			if (missingDamageFields.length) {
				const proceed = confirm('Some damaged items have missing required fields:\n' + missingDamageFields.join('\n') + '\n\nProceed anyway?');
				if (!proceed) return;
			}
		}
		
		const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.textContent='Submitting...';
		try{
			const id=document.getElementById('incidentId').value;
			
			// Handle action-only edit mode
			if (actionOnlyEditMode && id) {
				await updateMyActionOnly(companyId, id);
				return;
			}
			
			const ref=id? db.ref(`companies/${companyId}/incidents/${id}`): db.ref(`companies/${companyId}/incidents`).push();
			// For Realtime Database storage, serialize files as base64 data URLs
			const attachments=await uploadAttachments();
			const dt=getDateTimeParts();
			const payload={
				referenceNumber: document.getElementById('referenceNumber').value,
				title: document.getElementById('incidentTitle').value,
				severity: document.getElementById('severity').value,
				eventType: document.getElementById('eventType').value || 'incident',
				date: dt.date,
				time: dt.time,
				dateTime: dt.iso,
				status: document.getElementById('incidentStatus').value || 'open',
				location: document.getElementById('eventLocation').value,
				department: document.getElementById('department').value,
				assignedTo: document.getElementById('assignedTo').value,
				assignedToName: document.getElementById('userSearch').value,
				incidentCategory: document.getElementById('incidentCategory').value,
				injuryData: getInjuryData(),
				propertyDamageData: getPropertyDamageData(),
				description: document.getElementById('description').value,
				immediateActions: document.getElementById('immediateActions').value,
				correctiveActions: getCorrectiveActionsData(),
				dueDate: document.getElementById('dueDate').value,
				attachments,
				eventDetails: getEventDetailsFromForm(),
				reportedBy: user.uid, reportedByName: document.getElementById('reportedByName').value, dateReported: document.getElementById('dateReported').value,
				updatedAt: new Date().toISOString(),
			};
			if(!id) payload.createdAt=new Date().toISOString(); else { const snap=await ref.once('value'); payload.createdAt=snap.val()?.createdAt||new Date().toISOString(); }
			const isUpdate = !!id;
			await ref.update(payload);
			
			// Send notification email
			try {
				await sendIncidentNotificationEmail(companyId, payload, payload.eventType || 'incident', isUpdate);
			} catch (notifErr) {
				console.error('Notification error:', notifErr);
			}
			
			alert(id?'Incident updated':'Incident created');
			location.href='incidentboard.html';
		}catch(err){
			console.error(err);
			alert('Error submitting incident: '+ (err?.message || err));
		}finally{
			btn.disabled=false; btn.textContent='Submit Incident';
		}
	});
})();

// Update only the user's specific corrective action
async function updateMyActionOnly(companyId, incidentId) {
	const btn = document.getElementById('submitBtn');
	try {
		// Get all corrective actions data
		const allActionsData = getCorrectiveActionsData();
		
		// Get the current incident to preserve other actions
		const incRef = db.ref(`companies/${companyId}/incidents/${incidentId}`);
		const snap = await incRef.once('value');
		const currentData = snap.val();
		
		if (!currentData) {
			alert('Incident not found');
			return;
		}
		
		// Get the existing corrective actions
		let existingActions = currentData.correctiveActions || [];
		
		// Find the action we're editing (by index)
		if (actionOnlyEditIndex >= 0 && actionOnlyEditIndex < existingActions.length) {
			// Get the updated data for this action from the form
			// The editable action will be at actionOnlyEditIndex + 1 (since counter starts at 1)
			const editableActionDiv = document.querySelector('.action-editable-highlight');
			if (editableActionDiv) {
				const updatedAction = {
					description: editableActionDiv.querySelector('.action-description')?.value || '',
					responsibleId: editableActionDiv.querySelector('.action-responsible-id')?.value || '',
					responsibleName: editableActionDiv.querySelector('.action-responsible-search')?.value || '',
					dueDate: editableActionDiv.querySelector('.action-due-date')?.value || '',
					status: editableActionDiv.querySelector('.action-status')?.value || 'pending'
				};
				
				// Update only this specific action
				existingActions[actionOnlyEditIndex] = updatedAction;
				
				// Save updated actions
				await incRef.update({
					correctiveActions: existingActions,
					updatedAt: new Date().toISOString()
				});
				
				alert('Your action has been updated successfully');
				location.href = 'incidentboard.html#actionPlan';
			}
		}
	} catch (err) {
		console.error('Error updating action:', err);
		alert('Error updating your action: ' + (err?.message || err));
	} finally {
		btn.disabled = false;
		btn.innerHTML = '<i class="fas fa-save"></i> Update My Action';
	}
}

// ===== ROLE-BASED MENU AUTHORIZATION SYSTEM (ported from project-list) =====

// Flag to prevent multiple simultaneous executions
let isMenuUpdateInProgress = false;

// Reset all menu items to hidden (preserve core features only when authorized)
function resetMenuVisibility() {
	document.querySelectorAll('[data-feature]').forEach(item => {
		item.classList.remove('menu-visible');
	});
	document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
		dropdown.classList.remove('menu-visible');
	});
}

// Emergency fallback - show basic menu items
function showBasicMenu() {
	console.log('üîß Emergency fallback: Showing basic menu items');
	resetMenuVisibility();
	const sidebar = document.querySelector('.sidebar');
	if (sidebar) {
		sidebar.classList.remove('menu-loading');
	}
	const homeItem = document.querySelector('[data-feature="home_view"]');
	if (homeItem) {
		homeItem.classList.add('menu-visible');
	}
}

// Feature-based authorization system that takes priority over role permissions
async function updateMenuWithFeatureAuthorization() {
	if (isMenuUpdateInProgress) {
		console.log('üîÑ Menu update already in progress, skipping...');
		return;
	}
	isMenuUpdateInProgress = true;
	console.log('üéØ Starting feature-based menu authorization for incident.html...');
	try {
		let currentUser = null;
		let companyId = null;
		let userRole = null;

		if (window.authManager && window.authManager.currentUser) {
			currentUser = window.authManager.currentUser;
			companyId = currentUser.companyId;
			userRole = currentUser.role;
			console.log('üë§ Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
		} else if (firebase.auth().currentUser) {
			currentUser = firebase.auth().currentUser;
			console.log('üë§ Using Firebase auth - will search for company and role');
		} else {
			console.log('‚ùå No authenticated user found');
			resetMenuVisibility();
			return;
		}

		if (!companyId && currentUser) {
			console.log('üîç Searching for user company and role...');
			const database = firebase.database();
			const companiesRef = database.ref('companies');
			const companiesSnapshot = await companiesRef.once('value');
			if (companiesSnapshot.exists()) {
				const companies = companiesSnapshot.val();
				for (const [cId, company] of Object.entries(companies)) {
					if (company.status !== 'active') continue;
					if (company.users && company.users[currentUser.uid]) {
						companyId = cId;
						userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
						console.log(`‚úÖ Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
						break;
					}
				}
			}
		}

		if (!companyId) {
			console.error('‚ùå No company ID found, cannot determine authorized features');
			resetMenuVisibility();
			return;
		}
		if (!userRole) {
			console.warn('‚ö†Ô∏è No user role found, proceeding with company features only');
		}

		// STEP 1: Apply company feature-based authorization
		console.log('üè¢ STEP 1: Applying company feature authorization...');
		const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);

		// STEP 2: Filter by user role permissions within authorized features
		if (userRole) {
			console.log('üë§ STEP 2: Applying role-based filtering within authorized features...');
			await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
		} else {
			console.log('‚ö†Ô∏è STEP 2: Skipping role-based filtering (no role found)');
		}
	} catch (error) {
		console.error('‚ùå Error in feature-based menu authorization:', error);
		resetMenuVisibility();
	} finally {
		isMenuUpdateInProgress = false;
	}
}

// Apply feature-based menu visibility
async function applyFeatureBasedMenuVisibility(companyId) {
	try {
		console.log('üîß Applying feature-based menu visibility for company:', companyId);
		const database = firebase.database();
		const featuresSnapshot = await database.ref('/platformFeatures').once('value');
		if (!featuresSnapshot.exists()) {
			console.log('‚ö†Ô∏è No platform features found');
			resetMenuVisibility();
			return [];
		}
		const featuresData = featuresSnapshot.val();
		const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
		const companyData = companySnapshot.val();
		if (!companyData) {
			console.error('‚ùå Company data not found');
			resetMenuVisibility();
			return [];
		}
		const subscribedFeatureIds = companyData.selectedFeatures || [];
		console.log('üè¢ Company subscribed features:', subscribedFeatureIds);
		if (subscribedFeatureIds.length === 0) {
			console.log('‚ö†Ô∏è Company has no subscribed features');
			resetMenuVisibility();
			return [];
		}
		const authorizedPages = [];
		const featureAlias = (key) => {
			if (!key) return key;
			if (key === 'risk_view') return 'risk_management_section';
			if (key === 'risk_management_section') return 'risk_view';
			return null;
		};
		const normalizeHref = (href) => {
			if (!href) return '';
			try { const u = new URL(href, window.location.origin); return (u.pathname||'').replace(/^\//,''); } catch { return String(href).replace(/^\//,''); }
		};
		const authorizedFeatures = new Set();
		const authorizedHrefs = new Set();
		subscribedFeatureIds.forEach(featureId => {
			const feature = featuresData[featureId];
			if (feature && feature.status === 'active' && feature.authorizedPages) {
				console.log(`üì¶ Adding pages from feature "${feature.name}":`, feature.authorizedPages);
				authorizedPages.push(...feature.authorizedPages);
			}
		});
		authorizedPages.forEach(pageInfo => {
			if (pageInfo.feature) {
				authorizedFeatures.add(pageInfo.feature);
				const alias = featureAlias(pageInfo.feature);
				if (alias) authorizedFeatures.add(alias);
			}
			if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
			if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
			if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
		});
		console.log('üéØ Authorized features for incident.html:', Array.from(authorizedFeatures));
		console.log('üîó Authorized hrefs for incident.html:', Array.from(authorizedHrefs));
		resetMenuVisibility();
		const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
		allMenuItems.forEach(menuItem => {
			const featureAttribute = menuItem.getAttribute('data-feature');
			const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
			const anchor = menuItem.querySelector('a[href]');
			const href = anchor ? anchor.getAttribute('href') : '';
			const normalized = href ? href.replace(/^\//,'') : '';
			const featureAuthorized = authorizedFeatures.has(featureAttribute);
			const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
			const isAuthorized = featureAuthorized || hrefAuthorized;
			if (isDropdownContainer) return; // handle after
			if (isAuthorized) menuItem.classList.add('menu-visible'); else menuItem.classList.remove('menu-visible');
		});
		const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
		dropdownMenus.forEach(dropdown => {
			const dropdownFeature = dropdown.getAttribute('data-feature');
			const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
			let hasVisibleChildren = false;
			submenuItems.forEach(submenuItem => { if (submenuItem.classList.contains('menu-visible')) hasVisibleChildren = true; });
			if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) dropdown.classList.add('menu-visible'); else dropdown.classList.remove('menu-visible');
		});
		return authorizedPages;
	} catch (error) {
		console.error('‚ùå Error applying feature-based menu visibility:', error);
		resetMenuVisibility();
		return [];
	}
}

// Apply role-based filtering within company authorized features
async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
	try {
		console.log('üë§ Applying role-based filtering for role:', userRole);
		const database = firebase.database();
		const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
		const permissionsSnapshot = await permissionsRef.once('value');
		if (!permissionsSnapshot.exists()) {
			console.log(`‚ö†Ô∏è No permissions found for role ${userRole} in company ${companyId}`);
			if (userRole === 'administrator') {
				console.log('üîë ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
				showSidebarAfterAuth();
				return;
			}
			hideItemsRequiringPermissions();
			showSidebarAfterAuth();
			return;
		}
		const permissions = permissionsSnapshot.val();
		filterMenuByPermissions(permissions);
	} catch (error) {
		console.error('‚ùå Error applying role-based filtering:', error);
		showSidebarAfterAuth();
	}
}

// Filter currently visible menu items by role permissions
function filterMenuByPermissions(permissions) {
	console.log('üîç Filtering visible menu items by role permissions...');
	if (!permissions) {
		hideItemsRequiringPermissions();
		showSidebarAfterAuth();
		return;
	}
	const permissionAlias = (key) => {
		if (!key) return key;
		if (key === 'risk_view') return 'risk_management_section';
		if (key === 'risk_management_section') return 'risk_view';
		return null;
	};
	const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
	itemsRequiringPermissions.forEach(item => {
		const requiresPermission = item.getAttribute('data-requires-permission');
		const perm = permissions[requiresPermission];
		const aliasKey = permissionAlias(requiresPermission);
		const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
		const hasViewPermission = (p) => p === true || (p && p.view === true);
		const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
		if (allowed) item.classList.add('menu-visible'); else item.classList.remove('menu-visible');
	});
	const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
	dropdownMenus.forEach(dropdown => {
		const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
		const dropdownFeature = dropdown.getAttribute('data-feature');
		const dropdownRequires = dropdown.getAttribute('data-requires-permission');
		if (submenuItems.length === 0) {
			if (dropdownRequires) {
				const perm = permissions[dropdownRequires];
				const aliasKey = permissionAlias(dropdownRequires);
				const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
				const hasViewPermission = (p) => p === true || (p && p.view === true);
				const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
				if (allowed) dropdown.classList.add('menu-visible'); else dropdown.classList.remove('menu-visible');
			} else {
				dropdown.classList.remove('menu-visible');
			}
		}
	});
	ensureHomeIsVisible();
	showSidebarAfterAuth();
}

// Hide menu items that require permissions (for users without role permissions)
function hideItemsRequiringPermissions() {
	console.log('üîí Hiding all menu items that require permissions...');
	const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
	itemsRequiringPermissions.forEach(item => { item.classList.remove('menu-visible'); });
	const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
	dropdownMenus.forEach(dropdown => {
		const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
		if (visibleSubmenuItems.length === 0) dropdown.classList.remove('menu-visible');
	});
	ensureHomeIsVisible();
}

// Ensure home menu item is visible as fallback
function ensureHomeIsVisible() {
	const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
	if (homeItem && !homeItem.classList.contains('menu-visible')) {
		homeItem.classList.add('menu-visible');
	}
}

// Show sidebar and remove loading state after authentication and filtering
function showSidebarAfterAuth() {
	const sidebar = document.querySelector('.sidebar');
	if (sidebar) {
		sidebar.classList.remove('menu-loading');
		console.log('‚úÖ Sidebar loading state removed - menu authorization complete');
	}
}

// Initialize menu authorization system
function initializeMenuAuthorization() {
	console.log('üöÄ Initializing menu authorization system...');
	const sidebar = document.querySelector('.sidebar');
	if (sidebar) {
		sidebar.classList.add('menu-loading');
	}
	setTimeout(() => { updateMenuWithFeatureAuthorization(); }, 500);
}

// Make updateMenuWithFeatureAuthorization available globally
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
// ===== END ROLE-BASED MENU AUTHORIZATION SYSTEM =====
</script>
</body>
</html>
