<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,1.0">
    <title>HSE System - Inspection Request</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="vendor/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Company branding (match project-list.html) */
        .company-branding { display: flex; align-items: center; gap: 0.5rem; }
        #headerCompanyLogo { width: 32px; height: 32px; object-fit: contain; display: none; }
        #headerCompanyName { font-weight: 600; font-size: 0.85rem; }

        .inspection-form-container {
            max-width: 100%;
            margin: 40px auto 0; /* reduced from 90px to tighten header gap */
            padding: 20px;
        }
        /* Staff-style page header (mirrors staff.html) */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color, #2c3e50), var(--secondary-color, #3498db));
            color: #fff;
            padding: 0.55rem 0.75rem;
            border-radius: 0;
            margin: 0.35rem 0 0.8rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }
        .page-header i { font-size: 1rem; }
        .page-actions { display: flex; gap: 0.5rem; }
        .page-header-title { display:flex; align-items:center; gap:0.6rem; font-weight:600; }
        .btn-back-header {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.4rem 0.7rem;
            font-size: 0.7rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            cursor: pointer;
            transition: all .2s ease;
        }
        .btn-back-header:hover { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }
        .inspection-header-description { margin: -0.3rem 0 1.2rem 0; font-size:0.75rem; color:#555; padding:0 0.4rem; }
        
        .form-section {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #3498db;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1 1 300px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .days-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .day-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .day-checkbox label {
            margin: 0;
            font-size: 14px;
        }

        /* Checklist Styles */
        .checkbox-wrapper {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
        }

        .checkbox-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid transparent;
        }

        .checkbox-header label {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 0;
            color: #445;
            cursor: pointer;
            user-select: none;
            flex: 1;
        }

        /* Hide the thick-checkbox completely */
        .thick-checkbox {
            display: none;
        }

        .checkbox-header-icon {
            margin-left: 10px;
            font-size: 16px;
            color: #6c757d;
            transition: transform 0.3s ease;
        }

        .checkbox-wrapper.expanded .checkbox-header-icon {
            transform: rotate(180deg);
            color: #3498db;
        }

        .subelements-container {
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-wrapper.expanded .subelements-container {
            display: block;
        }

        .subelement {
            width: 100%;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #e9ecef;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subelement-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .radio-group {
            display: flex;
            flex-direction: row;
            gap: 15px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            position: relative;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
            width: auto;
            min-width: 80px;
            justify-content: center;
        }

        .radio-option input[type="radio"] {
            margin-right: 5px;
        }

        .radio-option.good label {
            color: #28a745;
        }

        .radio-option.bad label {
            color: #dc3545;
        }

        .radio-option.na label {
            color: #6c757d;
        }

        /* Enhanced Checklist Styles */
        .checklist-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%; /* Changed from max-width to width */
            margin: 0 auto;
        }

        .checkbox-wrapper {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .checkbox-wrapper:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .checkbox-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid transparent;
        }

        .checkbox-wrapper.expanded .checkbox-header {
            background-color: #e9f0f7;
            border-bottom: 1px solid #d1e1f0;
        }

        .checkbox-header label {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 0;
            color: #445;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-header-icon {
            margin-left: auto;
            font-size: 16px;
            color: #6c757d;
            transition: transform 0.3s ease;
        }

        .checkbox-wrapper.expanded .checkbox-header-icon {
            transform: rotate(180deg);
            color: #3498db;
        }

        .thick-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 2px solid #3498db;
            border-radius: 4px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
            background: white;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .thick-checkbox:checked {
            background-color: #3498db;
            border-color: #3498db;
        }

        .thick-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .thick-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        .subelements-container {
            width: 100%;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-wrapper.expanded .subelements-container {
            max-height: 2000px;
            padding: 10px 15px 15px;
        }

        .subelement {
            width: 100%;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #e9ecef;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subelement:hover {
            background: #f1f4f6;
            border-left-color: #3498db;
        }

        .subelement-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .subelement-title::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #3498db;
            border-radius: 50%;
            margin-right: 8px;
        }

        .radio-group {
            width: 100%;
            display: flex;
            flex-direction: row;
            gap: 15px;
            margin-top: 8px;
        }

        .radio-option {
            width: 100%;
            display: flex;
            align-items: center;
            position: relative;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
            width: auto;
            min-width: 80px;
            justify-content: center;
        }

        .radio-option:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .radio-option input[type="radio"] {
            margin-right: 5px;
            cursor: pointer;
        }

        .radio-option.good {
            color: #28a745;
        }

        .radio-option.bad {
            color: #dc3545;
        }

        .radio-option.na {
            color: #6c757d;
        }

        .radio-option.good input[type="radio"]:checked + label {
            font-weight: 600;
        }

        .radio-option.bad input[type="radio"]:checked + label {
            font-weight: 600; 
        }

        .radio-option.na input[type="radio"]:checked + label {
            font-weight: 600;
        }

        .radio-option label {
            margin-bottom: 0;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }
        /* Deferred inspection sections hidden until start date arrives */
    .deferred-section { display: none; }
    .deferred-section.visible { display: block; }
    .deferred-section.type-required:not(.type-enabled) { display: none !important; }

        .category-progress {
            height: 4px;
            width: 100%;
            background-color: #e9ecef;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.5s ease;
        }

        .category-stats {
            display: flex;
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            justify-content: space-between;
        }

        .checklist-progress {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-header h4 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .overall-progress {
            height: 8px;
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .overall-bar {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .status-complete {
            background-color: #d4edda;
            color: #28a745;
        }

        .status-in-progress {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-not-started {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Search and filter controls */
        .checklist-controls {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-checklist {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-checklist input {
            width: 100%;
            padding: 10px 12px 10px 35px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-checklist i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .filter-checklist {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .filter-btn:hover, .filter-btn.active {
            background-color: #e9f0f7;
            border-color: #3498db;
            color: #3498db;
        }

        .filter-btn i {
            font-size: 14px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .checklist-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .checkbox-header {
                padding: 10px;
            }
            
            .checkbox-header label {
                font-size: 14px;
            }
            
            .subelement {
                padding: 10px;
            }
            
            .radio-group {
                flex-wrap: wrap;
            }

            .checklist-controls {
                flex-direction: column;
            }
            
            .filter-checklist {
                overflow-x: auto;
                padding-bottom: 5px;
                flex-wrap: nowrap;
                width: 100%;
            }
        }
        .subelement {
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .subelement:hover {
            transform: translateX(5px);
        }

        .radio-group {
            flex-direction: row;
            gap: 8px;
            margin-top: 8px;
        }

        .radio-option {
            padding: 8px;
            border-radius: 4px;
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        .radio-option:hover {
            background-color: #e9ecef;
        }

        .explanation-field {
            margin-top: 10px;
            width: 100%;
        }

        .explanation-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        /* Team member selection styles */
        .input-with-button {
            display: flex;
            gap: 10px;
        }
        
        .input-with-button select {
            flex: 1;
        }
        
        .input-with-button button {
            padding: 10px 15px;
        }
        
        .selected-team-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-team-member {
            display: flex;
            align-items: center;
            background: #e9f0f7;
            border: 1px solid #c6d7eb;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .team-member-name {
            margin-right: 8px;
        }
        
        .btn-remove-member {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            font-size: 12px;
        }
        
        .btn-remove-member:hover {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu">
                <li data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li data-feature="dashboard_view"><a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown active" data-feature="safety_view">
                    <a href="#" class="active"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view"><a href="inspectionboard.html" class="active">Inspection</a></li>
                        <li data-feature="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
                    </ul>
                </li>
                    <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    	<ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    	</ul>
                    </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li data-feature="logistics_view"><a href="#"><i class="fas fa-truck"></i> Logistics</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companyboard.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html">Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="company-branding">
                    <img id="headerCompanyLogo" alt="Company Logo" />
                    <span id="headerCompanyName"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="assets/default-avatar.svg" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Inspection Form Content -->
            <div class="inspection-form-container">
                <div class="page-header">
                    <h2 id="formTitle" style="display:flex;align-items:center;gap:0.6rem;margin:0;font-weight:600;color:#fff;font-size:0.9rem;">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Request Inspection</span>
                    </h2>
                    <div class="page-actions">
                        <a href="inspectionboard.html" id="backToInspections" class="btn-back-header" title="Back to Inspections">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back</span>
                        </a>
                    </div>
                </div>
                <div class="inspection-header-description">
                    <p id="formDescription" style="margin:0;"></p>
                </div>

                <form id="inspectionForm">
                    <input type="hidden" id="inspectionId">
                    
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="referenceNumber">Reference Number</label>
                                <input type="text" id="referenceNumber" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="inspectionTitle">Title *</label>
                                <input type="text" id="inspectionTitle" class="form-control" placeholder="Brief title describing the inspection" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="inspectionType">Inspection Type *</label>
                                <select id="inspectionType" class="form-control" required>
                                    <option value="">Select Inspection Type</option>
                                    <!-- Inspection types will be loaded from Firebase field options -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inspectionPriority">Priority *</label>
                                <select id="inspectionPriority" class="form-control" required>
                                    <option value="">Select Priority</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="inspectionLocation">Location *</label>
                                <select id="inspectionLocation" class="form-control" required>
                                    <option value="">Select Location</option>
                                    <!-- Locations will be populated from Firebase -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="department">Department *</label>
                                <select id="department" class="form-control" required>
                                    <option value="">Select Department</option>
                                    <!-- Departments will be populated from Firebase -->
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestedBy">Created By *</label>
                                <input type="text" id="requestedBy" class="form-control" readonly>
                                <input type="hidden" id="requestedById">
                            </div>
                        </div>
                    </div>

                    <!-- Assignment Section -->
                    <div class="form-section">
                        <h3>Assignment</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="teamMemberSelect">Team</label>
                                <div class="input-with-button">
                                    <select id="teamMemberSelect" class="form-control">
                                        <option value="">Select team member</option>
                                        <!-- Options will be populated from Firebase -->
                                    </select>
                                    <button type="button" id="addTeamMemberBtn" class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="selectedTeamMembers" class="selected-team-container">
                                    <!-- Selected team members will appear here -->
                                </div>
                                <!-- Hidden input to store selected team member IDs -->
                                <input type="hidden" id="teamMembersInput" name="teamMembers">
                            </div>
                            <div class="form-group">
                                <label for="estimatedDuration">Estimated Duration (hours)</label>
                                <input type="number" id="estimatedDuration" class="form-control" min="0.5" step="0.5" placeholder="e.g. 2.5">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="frequency">Recurrence *</label>
                                <select id="frequency" class="form-control" required>
                                    <option value="one-time">One-Time</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="bi-weekly">Bi-Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="bi-annual">Bi-Annual</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="recurrenceDetails" style="display: none;">
                            <div class="form-group">
                                <label for="startDate">Start Date *</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control">
                                <small class="form-text text-muted">Leave empty for indefinite recurrence</small>
                            </div>
                        </div>
                        <div class="form-row" id="weeklyDetails" style="display: none;">
                            <div class="form-group">
                                <label>Days of Week</label>
                                <div class="days-selection">
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-sun" value="0">
                                        <label for="day-sun">Sun</label>
                                    </div>
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-mon" value="1">
                                        <label for="day-mon">Mon</label>
                                    </div>
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-tue" value="2">
                                        <label for="day-tue">Tue</label>
                                    </div>
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-wed" value="3">
                                        <label for="day-wed">Wed</label>
                                    </div>
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-thu" value="4">
                                        <label for="day-thu">Thu</label>
                                    </div>
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-fri" value="5">
                                        <label for="day-fri">Fri</label>
                                    </div>
                                    <div class="day-checkbox">
                                        <input type="checkbox" id="day-sat" value="6">
                                        <label for="day-sat">Sat</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row" id="timeDetails" style="display: none;">
                            <div class="form-group">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Checklist Section removed as per requirement -->

                    <!-- Audit Checklist Loader (deferred; shown when date reached and type is Inspection/Audit) -->
                    <div class="form-section deferred-section type-required" id="auditChecklistDesigner" data-deferred="audit-checklist">
                        <h3>Audit Checklist</h3>
                        <p class="small" style="margin-top:-6px;color:#555;">Select and load a predefined audit checklist template. Designing new templates is disabled on this screen.</p>
                        <div class="template-bar" style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-bottom:12px;">
                            <div style="flex:2;min-width:240px;">
                                <label style="font-size:12px;font-weight:600;">Load Existing Template</label>
                                <select id="auditTemplateSelect" class="form-control">
                                    <option value="">-- Select Template --</option>
                                </select>
                            </div>
                            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                                <button type="button" id="loadAuditTemplateBtn" class="btn btn-sm" style="background:#6c757d;color:#fff;">Load Template</button>
                                <button type="button" id="refreshAuditTemplatesBtn" class="btn btn-sm" style="background:#5a6268;color:#fff;">Refresh</button>
                            </div>
                            <div id="auditTemplateStatus" style="font-size:12px;color:#007bff;flex:1;min-width:160px;"></div>
                        </div>
                        <div id="auditChecklistItems" class="audit-checklist-items"></div>
                        <template id="auditChecklistItemTemplate">
                            <div class="audit-item" data-index="{{index}}" style="border:1px solid #ddd;padding:10px;border-radius:6px;margin-bottom:10px;position:relative;background:#fafafa;">
                                <div class="form-row">
                                    <div class="form-group" style="flex:2;min-width:220px;">
                                        <label>Item Title</label>
                                        <input type="text" class="form-control audit-item-title">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex:2;min-width:260px;">
                                        <label>Criteria / Description</label>
                                        <textarea class="form-control audit-item-description" rows="2"></textarea>
                                    </div>
                                    <div class="form-group" style="flex:1;min-width:130px;">
                                        <label>Risk Level</label>
                                        <select class="form-control audit-item-risk">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex:1;min-width:130px;">
                                        <label>Weight (%)</label>
                                        <input type="number" class="form-control audit-item-weight">
                                    </div>
                                    <div class="form-group" style="flex:2;min-width:220px;">
                                        <label>Notes</label>
                                        <input type="text" class="form-control audit-item-notes">
                                    </div>
                                </div>
                                <div class="form-row" style="margin-top:6px;">
                                    <div class="form-group" style="flex:2;min-width:240px;">
                                        <label>Attached Document</label>
                                        <div class="audit-item-file-input-wrapper" style="margin-top:4px;display:flex;flex-direction:column;gap:4px;">
                                            <input type="file" class="audit-item-file-input" style="font-size:12px;">
                                            <small style="font-size:11px;color:#777;">Max 5MB. Selecting a file will queue it for upload on submit.</small>
                                        </div>
                                        <div class="audit-item-file-info" style="font-size:12px;color:#555;margin-top:4px;display:none;">None</div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Findings & Corrective Actions (deferred) -->
                    <div class="form-section deferred-section" data-deferred="findings">
                        <h3>Findings and Corrective Actions</h3>
                        <div class="findings-container">
                            <div class="finding-item" id="finding-template">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="finding-description">Finding Description *</label>
                                        <textarea class="form-control finding-description" placeholder="Describe the observation or non-conformity..." rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="corrective-action">Corrective Action *</label>
                                        <textarea class="form-control corrective-action" placeholder="Describe the required corrective action..." rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="responsible-person">Person Responsible *</label>
                                        <select class="form-control responsible-person">
                                            <option value="">Select Person</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="deadline">Target Completion Date *</label>
                                        <input type="date" class="form-control deadline">
                                    </div>
                                    <div class="form-group">
                                        <label for="priority">Priority Level *</label>
                                        <select class="form-control priority">
                                            <option value="">Select Priority</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="status">Status</label>
                                        <select class="form-control status">
                                            <option value="open">Open</option>
                                            <option value="in-progress">In Progress</option>
                                            <option value="completed">Completed</option>
                                            <option value="overdue">Overdue</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="comments">Additional Comments</label>
                                        <textarea class="form-control comments" placeholder="Any additional comments or notes..." rows="2"></textarea>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-danger remove-finding"><i class="fas fa-trash"></i> Remove Finding</button>
                            </div>
                        </div>
                        <button type="button" id="add-finding" class="btn btn-secondary mt-3">
                            <i class="fas fa-plus"></i> Add New Finding
                        </button>
                    </div>

                    <!-- Attachments Section (deferred) -->
                    <div class="form-section deferred-section" data-deferred="attachments">
                        <h3>Attachments</h3>
                        <p>Upload relevant documents, checklists, or reference materials</p>
                        
                        <div class="file-upload-container">
                            <div class="file-input-wrapper">
                                <label class="file-input-label">
                                    <i class="fas fa-upload"></i> Choose Files
                                </label>
                                <input type="file" id="fileUpload" multiple>
                            </div>
                            <small style="display: block; margin-top: 5px; color: #666;">Maximum file size: 5MB</small>
                            
                            <ul class="file-list" id="fileList">
                                <!-- File items will be added here -->
                            </ul>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="saveAsDraftBtn" class="btn btn-outline-primary">Save as Draft</button>
                        <button type="submit" id="submitBtn" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <footer></footer>

        <script src="vendor/firebase/firebase-app-compat.js"></script>
        <script src="vendor/firebase/firebase-database-compat.js"></script>
        <script src="vendor/firebase/firebase-auth-compat.js"></script>
        <script src="vendor/firebase/firebase-storage-compat.js"></script>
        <script>
            (function () {
                function load(src) {
                    var s = document.createElement('script');
                    s.src = src;
                    document.head.appendChild(s);
                }
                function ensureFirebase() {
                    try {
                        if (!(window.firebase && window.firebase.app)) throw new Error('no firebase');
                    } catch (e) {
                        load('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
                        load('https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js');
                        load('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js');
                        load('https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js');
                    }
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', ensureFirebase);
                } else {
                    ensureFirebase();
                }
            })();
        </script>
                <script>
                    // Ensure user avatar shows: use auth photoURL if present, else local default SVG
                    (function(){
                        function setAvatar(){
                            var img = document.querySelector('.profile-btn img');
                            if(!img) return;
                            try {
                                var user = (firebase && firebase.auth && firebase.auth().currentUser) || null;
                                var storedUser = null; try { storedUser = JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){}
                                var photo = (user && (user.photoURL || user.photoUrl)) || (storedUser && (storedUser.photoURL || storedUser.photoUrl));
                                if (photo) img.src = photo; else img.src = 'assets/default-avatar.svg';
                            } catch(e) { img.src = 'assets/default-avatar.svg'; }
                        }
                        function onReady(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
                        function tryRun(n){ try{ if(window.firebase && firebase.apps && firebase.apps.length){ setAvatar(); return; } }catch(e){}
                            if(n>0) setTimeout(function(){ tryRun(n-1); }, 300); }
                        onReady(function(){ tryRun(20); });
                    })();
                </script>
                        <script>
                            // Centralized AuthManager (aligned with incidentboard/project-list)
                            class AuthManager{
                                constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; this.init(); }
                                getCurrentUser(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch{ return null; } }
                                setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
                                async init(){ if(!this.currentUser){ this.bindProfileDropdown(); return; } await this.loadUserCompany(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); }
                                async loadUserCompany(){ if(!this.currentUser) return; try{ const snap=await firebase.database().ref('companies').once('value'); if(!snap.exists()) return; const companies=snap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users){ for(const [uid,u] of Object.entries(comp.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId=cid; this.currentUser.companyName=comp.companyName; this.currentUser.role=u.role||u.userRole||'user'; this.currentCompany=comp; this.setCurrentUser(this.currentUser); return; } } } } }catch(e){} }
                                getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
                                getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
                                async getUserAvatarUrl(){ if(!this.currentUser) return null; const companyId=this.currentUser.companyId||'default'; const paths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`]; for(const p of paths){ try{ const ref=firebase.storage().ref(p); const url=await ref.getDownloadURL(); return url; }catch(err){ /* try next */ } } return null; }
                                async updateUIForAuthenticatedUser(){ const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.currentUser.email||''; let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); }catch(e){}
                                    const btnImg=btn.querySelector('img'); if(avatarUrl&&btnImg){ btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }; } else { /* keep default/avatar initials handled elsewhere */ }
                                    const avatarHtml= avatarUrl? `<img src=\"${avatarUrl}\" alt=\"${displayName} Avatar\" style=\"width:32px;height:32px;border-radius:50%;object-fit:cover;\">` : `<div style=\"width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;\">${this.getUserInitials()}</div>`;
                                    list.innerHTML=`<li style=\"border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;\"><div style=\"display:flex;align-items:center;gap:12px;\">${avatarHtml}<div><div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${displayName}</div><div style=\"color:#666;font-size:12px;\">${email}</div></div></div></li><li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`;
                                    list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); });
                                }
                                bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click', e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click', e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
                                async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; }catch(error){ console.error('Logout error:',error); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } }
                            }
                            // Initialize centralized auth and expose globally
                            (function(){
                                function initWhenReady(attempts){
                                    try{ if(window.firebase && firebase.apps && firebase.apps.length){ window.authManager=new AuthManager(); return; } }catch(e){}
                                    if(attempts>0) setTimeout(()=>initWhenReady(attempts-1),300);
                                }
                                if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',()=>initWhenReady(20)); else initWhenReady(20);
                            })();
                        </script>
                                
                <script>
                    // Load company name and logo into header (based on project-list.html)
                    async function loadCompanyBranding() {
                        try {
                            var headerLogo = document.getElementById('headerCompanyLogo');
                            var headerCompanyName = document.getElementById('headerCompanyName');
                            if (!headerLogo || !headerCompanyName) return;

                            var currentUser = null;
                            try {
                                var storedUser = localStorage.getItem('currentUser');
                                if (storedUser) currentUser = JSON.parse(storedUser);
                            } catch (e) {}

                            if (!currentUser) {
                                headerCompanyName.textContent = '';
                                headerLogo.style.display = 'none';
                                return;
                            }

                            var db = firebase.database();
                            var snap = await db.ref('companies').once('value');
                            if (!snap.exists()) {
                                headerCompanyName.textContent = '';
                                headerLogo.style.display = 'none';
                                return;
                            }

                            var companies = snap.val();
                            var companyId = currentUser.companyId || null;
                            if (!companyId) {
                                for (var cId in companies) {
                                    var company = companies[cId];
                                    if (!company || company.status !== 'active') continue;
                                    if (company.users && (company.users[currentUser.uid] || company.users[currentUser.authUid])) {
                                        companyId = cId;
                                        break;
                                    }
                                }
                            }

                            if (companyId && companies[companyId]) {
                                var c = companies[companyId];
                                var name = c.companyName || c.name || '';
                                var logoUrl = c.logoUrl || c.logo || '';
                                headerCompanyName.textContent = name;
                                if (logoUrl) {
                                    headerLogo.src = logoUrl;
                                    headerLogo.style.display = 'block';
                                } else {
                                    headerLogo.style.display = 'none';
                                }
                            } else {
                                headerCompanyName.textContent = '';
                                headerLogo.style.display = 'none';
                            }
                        } catch (err) {
                            try {
                                var headerLogo = document.getElementById('headerCompanyLogo');
                                var headerCompanyName = document.getElementById('headerCompanyName');
                                if (headerCompanyName) headerCompanyName.textContent = '';
                                if (headerLogo) headerLogo.style.display = 'none';
                            } catch (e) {}
                        }
                    }
                            (function(){
                                function onReady(fn){
                                    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn();
                                }
                                function tryLoad(attempts){
                                    try {
                                        if (window.firebase && firebase.apps && firebase.apps.length) {
                                            loadCompanyBranding();
                                            return;
                                        }
                                    } catch(e) {}
                                    if (attempts > 0) setTimeout(function(){ tryLoad(attempts-1); }, 300);
                                }
                                onReady(function(){ tryLoad(20); });
                            })();
                </script>
    <!-- Header loader script -->
    <script src="js/header-loader.js"></script>
    <script type="module" src="js/task-integration.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        document.addEventListener('DOMContentLoaded', function() {
            // Checklist feature removed: categoryConfig no longer needed.

            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            
            // Store inspection data globally for edit mode
            let currentInspectionData = null;
            
            // Get inspection ID and series information from URL if editing existing inspection
            const urlParams = new URLSearchParams(window.location.search);
            const inspectionId = urlParams.get('id');
            const seriesId = urlParams.get('seriesId');
            const seriesIndex = urlParams.get('seriesIndex');
            
            // Generate reference number for new inspections
            function generateReferenceNumber() {
                return database.ref('counters/inspectionCount').transaction(function(currentCount) {
                    return (currentCount || 0) + 1;
                }).then(function(result) {
                    const currentCount = result.snapshot.val();
                    const formattedNumber = String(currentCount).padStart(3, '0');
                    const refNumber = `INSP-${formattedNumber}`;
                    document.getElementById('referenceNumber').value = refNumber;
                    return refNumber;
                }).catch(function(error) {
                    console.error("Error generating reference number:", error);
                    // Fallback to timestamp-based reference if counter fails
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    const fallbackRef = `INSP-${timestamp}-${random}`;
                    document.getElementById('referenceNumber').value = fallbackRef;
                    return fallbackRef;
                });
            }

            if (inspectionId) {
                // Update form title and description
                document.getElementById('formTitle').textContent = 'Edit Inspection Request';
                document.getElementById('formDescription').textContent = 'Update an existing inspection request';
                document.getElementById('submitBtn').textContent = 'Update Request';
                
                // Set the inspection ID
                document.getElementById('inspectionId').value = inspectionId;
                
                // Load inspection data for editing
                loadInspectionData(inspectionId)
                    .catch(error => {
                        console.error('Error in loadInspectionData:', error);
                        alert('Error loading inspection data. Please try again.');
                        // Optionally redirect back to the board after a delay
                        setTimeout(() => {
                            window.location.href = 'inspectionboard.html';
                        }, 2000);
                    });
            } else {
                // Generate reference number for new inspection
                generateReferenceNumber();
            }
            
            // Check for current user
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    database.ref('users/' + user.uid).once('value')
                        .then(snapshot => {
                            const userData = snapshot.val();
                            if (userData) {
                                document.getElementById('requestedBy').value = userData.firstName && userData.lastName ? 
                                    `${userData.firstName} ${userData.lastName}` : user.email;
                            } else {
                                document.getElementById('requestedBy').value = user.email;
                            }
                            document.getElementById('requestedById').value = user.uid;
                        });
                } else {
                    // No user signed in; allow access without redirect
                    // Leave requester fields empty; user can fill manually.
                }
            });
            
            // Load locations
            loadLocations();
            
            // Load departments
            loadDepartments();
            
            // Load users for assignment
            loadUsers();
            
            // Load inspection types
            loadInspectionTypes();
            
            // File upload handling
            const fileUpload = document.getElementById('fileUpload');
            const fileList = document.getElementById('fileList');
            const attachedFiles = [];
            
            fileUpload.addEventListener('change', function() {
                const files = this.files;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`File ${file.name} is too large. Maximum size is 5MB.`);
                        continue;
                    }
                    
                    // Add file to list
                    const fileItem = {
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: file.type
                    };
                    
                    attachedFiles.push(fileItem);
                    addFileToList(fileItem, attachedFiles.length - 1);
                }
                
                // Clear file input
                this.value = '';
            });
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function addFileToList(fileItem, index) {
                const li = document.createElement('li');
                li.className = 'file-item';
                
                // Determine file icon based on file type
                let iconClass = 'fa-file';
                const fileExt = fileItem.name.split('.').pop().toLowerCase();
                
                if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                    iconClass = 'fa-file-image';
                } else if (fileExt === 'pdf') {
                    iconClass = 'fa-file-pdf';
                } else if (['doc', 'docx'].includes(fileExt)) {
                    iconClass = 'fa-file-word';
                } else if (['xls', 'xlsx'].includes(fileExt)) {
                    iconClass = 'fa-file-excel';
                } else if (['ppt', 'pptx'].includes(fileExt)) {
                    iconClass = 'fa-file-powerpoint';
                } else if (['zip', 'rar'].includes(fileExt)) {
                    iconClass = 'fa-file-archive';
                }
                
                // Prepare file actions based on whether file is existing (has URL) or new
                let downloadButton = '';
                if (fileItem.isExisting && fileItem.url) {
                    downloadButton = `
                        <button type="button" class="download-file" data-url="${fileItem.url}" data-name="${fileItem.name}">
                            <i class="fas fa-download"></i>
                        </button>
                    `;
                }
                
                li.innerHTML = `
                    <i class="fas ${iconClass} file-icon"></i>
                    <span class="file-name">${fileItem.name}</span>
                    <span class="file-size">${fileItem.size}</span>
                    <div class="file-actions">
                        ${downloadButton}
                        <button type="button" class="delete-file" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(li);
                
                // Add event listener for delete button
                li.querySelector('.delete-file').addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    
                    // Remove file from array
                    attachedFiles.splice(index, 1);
                    
                    // Rerender file list
                    renderFileList();
                });
                
                // Add event listener for download button if it exists
                const downloadBtn = li.querySelector('.download-file');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', function() {
                        const url = this.getAttribute('data-url');
                        const fileName = this.getAttribute('data-name');
                        
                        // Create a temporary link element to trigger download
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.target = '_blank';
                        downloadLink.download = fileName;
                        
                        // Append to document, trigger click and remove
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    });
                }
            }
            
            function renderFileList() {
                fileList.innerHTML = '';
                
                if (attachedFiles.length === 0) {
                    fileList.innerHTML = '<li class="no-files">No files attached</li>';
                    return;
                }
                
                attachedFiles.forEach((fileItem, index) => {
                    addFileToList(fileItem, index);
                });
            }
            
            // Load locations (work areas) from company-scoped settings/fieldOptions
            async function loadLocations() {
                const locationSelect = document.getElementById('inspectionLocation');
                // Clear existing options except the first placeholder
                while (locationSelect.options.length > 1) {
                    locationSelect.remove(1);
                }

                try {
                    const companyId = await getCompanyId();
                    const options = await fetchCompanyWorkAreaOptions(companyId || 'default');
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.label || opt.value;
                        locationSelect.appendChild(option);
                    });

                    // If editing an inspection, set the location value after options are loaded
                    if (currentInspectionData && currentInspectionData.location) {
                        locationSelect.value = currentInspectionData.location;
                        if (locationSelect.value !== currentInspectionData.location) {
                            // Ensure selection is preserved even if not present in options
                            const fallback = document.createElement('option');
                            fallback.value = currentInspectionData.location;
                            fallback.textContent = currentInspectionData.location;
                            locationSelect.appendChild(fallback);
                            locationSelect.value = currentInspectionData.location;
                        }
                    }
                } catch (e) {
                    // As a safety net, provide defaults
                    ['Main Building','Warehouse','Production Floor','Office Area','Loading Dock','Laboratory','Outdoor Yard'].forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.toLowerCase().replace(/\s+/g, '-');
                        option.textContent = loc;
                        locationSelect.appendChild(option);
                    });
                }
            }
            
            // Company-scoped department options (from settings/fieldOptions with robust fallbacks)
            async function getCompanyId() {
                // Prefer cached currentUser
                let currentUser = null;
                try { currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch(e) { currentUser = null; }
                if (currentUser && currentUser.companyId) return currentUser.companyId;

                // Fallback: try to infer company by membership
                try {
                    const snap = await database.ref('companies').once('value');
                    if (snap.exists() && currentUser && currentUser.uid) {
                        const companies = snap.val();
                        for (const [cid, comp] of Object.entries(companies)) {
                            if (!comp || comp.status === 'inactive') continue;
                            if (comp.users && (comp.users[currentUser.uid] || (currentUser.authUid && comp.users[currentUser.authUid]))) {
                                // Cache back to localStorage for later use
                                currentUser.companyId = cid;
                                try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch(e) {}
                                return cid;
                            }
                        }
                    }
                } catch (e) {}
                return null;
            }

            function normalizeOptions(raw) {
                const out = [];
                if (!raw) return out;
                const pushOpt = (val, label, enabled) => {
                    if (enabled === false) return; // skip disabled
                    if (!val && !label) return;
                    const value = (val || label || '').toString();
                    const text = (label || val || '').toString();
                    if (!value) return;
                    out.push({ value, label: text });
                };
                if (Array.isArray(raw)) {
                    raw.forEach(item => {
                        if (item == null) return;
                        if (typeof item === 'string') pushOpt(item, item, true);
                        else if (typeof item === 'object') pushOpt(item.value || item.id || item.key || item.label, item.label || item.name || item.value, item.enabled);
                    });
                } else if (typeof raw === 'object') {
                    Object.entries(raw).forEach(([key, item]) => {
                        if (item == null) return;
                        if (typeof item === 'string') pushOpt(key, item, true);
                        else pushOpt(item.value || key, item.label || item.name || key, item.enabled);
                    });
                }
                // Deduplicate by value preserving order
                const seen = new Set();
                return out.filter(o => (o && !seen.has(o.value) && seen.add(o.value)));
            }

            async function fetchCompanyDepartmentOptions(companyId) {
                // Try primary path: companies/{companyId}/fieldOptions/department
                try {
                    const snap = await database.ref(`companies/${companyId}/fieldOptions/department`).once('value');
                    if (snap.exists()) {
                        const options = normalizeOptions(snap.val());
                        if (options.length) return options;
                    }
                } catch (e) {}

                // Fallback path: companies/{companyId}/settings/fieldOptions/department
                try {
                    const snap = await database.ref(`companies/${companyId}/settings/fieldOptions/department`).once('value');
                    if (snap.exists()) {
                        const options = normalizeOptions(snap.val());
                        if (options.length) return options;
                    }
                } catch (e) {}

                // Fallback: localStorage cached field options
                try {
                    const cached = JSON.parse(localStorage.getItem('companyFieldOptions') || 'null');
                    if (cached && cached.department) {
                        const options = normalizeOptions(cached.department);
                        if (options.length) return options;
                    }
                } catch (e) {}

                // Final fallback: sensible defaults
                return normalizeOptions(['Operations', 'Warehouse', 'Manufacturing', 'Logistics', 'Maintenance', 'Administration', 'HR', 'IT']);
            }

            // Work Areas / Locations options
            async function fetchCompanyWorkAreaOptions(companyId) {
                const tryPaths = [
                    `companies/${companyId}/fieldOptions/work-areas`,
                    `companies/${companyId}/fieldOptions/locations`,
                    `companies/${companyId}/fieldOptions/location`,
                    `companies/${companyId}/settings/fieldOptions/work-areas`,
                    `companies/${companyId}/settings/fieldOptions/locations`,
                    `companies/${companyId}/settings/fieldOptions/location`
                ];
                for (const path of tryPaths) {
                    try {
                        const snap = await database.ref(path).once('value');
                        if (snap.exists()) {
                            const opts = normalizeOptions(snap.val());
                            if (opts.length) return opts;
                        }
                    } catch (e) {}
                }
                // LocalStorage fallback
                try {
                    const cached = JSON.parse(localStorage.getItem('companyFieldOptions') || 'null');
                    if (cached) {
                        const candidates = cached['work-areas'] || cached['locations'] || cached['location'];
                        const opts = normalizeOptions(candidates);
                        if (opts.length) return opts;
                    }
                } catch (e) {}
                // Defaults used previously
                return normalizeOptions([
                    'Main Building', 'Warehouse', 'Production Floor', 'Office Area', 'Loading Dock', 'Laboratory', 'Outdoor Yard'
                ]);
            }

            // Load departments from company-scoped settings
            async function loadDepartments() {
                const departmentSelect = document.getElementById('department');
                // Clear existing options except the first one
                while (departmentSelect.options.length > 1) {
                    departmentSelect.remove(1);
                }

                try {
                    const companyId = await getCompanyId();
                    let options = [];
                    if (companyId) {
                        options = await fetchCompanyDepartmentOptions(companyId);
                    } else {
                        // No company context; attempt global fallback for now
                        options = await fetchCompanyDepartmentOptions('default');
                    }

                    // Populate select
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.label || opt.value;
                        departmentSelect.appendChild(option);
                    });

                    // If editing an inspection, set the department value after options are loaded
                    if (currentInspectionData && currentInspectionData.department) {
                        departmentSelect.value = currentInspectionData.department;
                        // If value not found in options, add it to preserve selection
                        if (departmentSelect.value !== currentInspectionData.department) {
                            const fallback = document.createElement('option');
                            fallback.value = currentInspectionData.department;
                            fallback.textContent = currentInspectionData.department;
                            departmentSelect.appendChild(fallback);
                            departmentSelect.value = currentInspectionData.department;
                        }
                    }
                } catch (e) {
                    // As a safety net, add defaults
                    ['Operations','Warehouse','Manufacturing','Logistics','Maintenance','Administration','HR','IT'].forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.toLowerCase();
                        option.textContent = d;
                        departmentSelect.appendChild(option);
                    });
                }
            }
            
            // Load users for assignment
            function loadUsers() {
                const teamSelect = document.getElementById('teamMemberSelect');
                
                // Clear existing options except the first one
                while (teamSelect.options.length > 1) {
                    teamSelect.remove(1);
                }
                
                database.ref('users').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(userSnapshot => {
                                const user = userSnapshot.val();
                                const option = document.createElement('option');
                                option.value = userSnapshot.key;
                                option.textContent = user.firstName && user.lastName ? 
                                    `${user.firstName} ${user.lastName}` : 
                                    user.email || `User ${userSnapshot.key}`;
                                teamSelect.appendChild(option);
                            });
                            
                            // If editing an inspection with team members, set the values
                            if (currentInspectionData && currentInspectionData.team) {
                                // For backward compatibility - handle both string and array
                                const teamValues = Array.isArray(currentInspectionData.team) 
                                    ? currentInspectionData.team 
                                    : [currentInspectionData.team];
                                
                                // Select multiple options based on team values
                                for (let i = 0; i < teamSelect.options.length; i++) {
                                    if (teamValues.includes(teamSelect.options[i].value)) {
                                        teamSelect.options[i].selected = true;
                                    }
                                }
                            } else if (currentInspectionData && currentInspectionData.assignedTo) {
                                // Backward compatibility - migrate old assignedTo field to team
                                for (let i = 0; i < teamSelect.options.length; i++) {
                                    if (teamSelect.options[i].value === currentInspectionData.assignedTo) {
                                        teamSelect.options[i].selected = true;
                                        break;
                                    }
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                    });
            }
            
            // Ensure 'Audit' exists in the inspection type select
            function ensureAuditOption(selectEl) {
                try {
                    const exists = Array.from(selectEl.options).some(opt => (opt.value || '').toLowerCase() === 'audit');
                    if (!exists) {
                        const auditOpt = document.createElement('option');
                        auditOpt.value = 'audit';
                        auditOpt.textContent = 'Audit';
                        selectEl.appendChild(auditOpt);
                    }
                } catch (e) {
                    console.warn('Could not ensure Audit option:', e);
                }
            }

            // Load inspection types from Firebase field options
            function loadInspectionTypes() {
                const inspectionTypeSelect = document.getElementById('inspectionType');
                // helper: block certain options regardless of source
                const isBlockedInspectionType = (value, label) => {
                    const norm = (value || label || '').toString().toLowerCase().trim().replace(/[\s_]+/g,'-');
                    // Blocked tokens (normalized)
                    const blocked = new Set([
                        'random',
                        'post-incident',
                        'post-start-up',
                        'post-startup',
                        'regulator',
                        'regulatory',
                        'pre-start-up',
                        'pre-startup'
                    ]);
                    return blocked.has(norm);
                };
                
                // Clear existing options except the first one
                while (inspectionTypeSelect.options.length > 1) {
                    inspectionTypeSelect.remove(1);
                }
                
                // First try to load from fieldOptions/inspection-type
                database.ref('fieldOptions/inspection-type').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            // Load options from fieldOptions
                            snapshot.forEach(optionSnapshot => {
                                const option = optionSnapshot.val();
                                
                                // Only add enabled options
                                if (option.enabled !== false) {
                                    // Skip blocked items by label or value
                                    if (isBlockedInspectionType(option.value, option.label)) return;
                                    const dropdownOption = document.createElement('option');
                                    dropdownOption.value = option.value;
                                    dropdownOption.textContent = option.label;
                                    inspectionTypeSelect.appendChild(dropdownOption);
                                }
                            });

                            // Always ensure 'Audit' option exists
                            ensureAuditOption(inspectionTypeSelect);
                            
                            // If editing an inspection, set the inspection type value after options are loaded
                            if (currentInspectionData && currentInspectionData.inspectionType) {
                                inspectionTypeSelect.value = currentInspectionData.inspectionType;
                                
                                // If the selected value doesn't exist in the options, add it temporarily
                                if (inspectionTypeSelect.value !== currentInspectionData.inspectionType) {
                                    const tempOption = document.createElement('option');
                                    tempOption.value = currentInspectionData.inspectionType;
                                    tempOption.textContent = currentInspectionData.inspectionType.charAt(0).toUpperCase() + 
                                        currentInspectionData.inspectionType.slice(1).replace(/-/g, ' ');
                                    inspectionTypeSelect.appendChild(tempOption);
                                    inspectionTypeSelect.value = currentInspectionData.inspectionType;
                                }
                            }
                        } else {
                            // If fieldOptions/inspection-type doesn't exist, try inspectionTypes
                            database.ref('inspectionTypes').once('value')
                                .then(snapshot => {
                                    if (snapshot.exists()) {
                                        snapshot.forEach(typeSnapshot => {
                                            const type = typeSnapshot.val();
                                            const value = (type && type.value) || typeSnapshot.key;
                                            const label = (type && type.name) || typeSnapshot.key;
                                            if (isBlockedInspectionType(value, label)) return;
                                            const option = document.createElement('option');
                                            option.value = value;
                                            option.textContent = label;
                                            inspectionTypeSelect.appendChild(option);
                                        });
                                    } else {
                                        // Add default inspection types as a last resort if none exist
                                        const defaultTypes = [
                                            'Routine', 'Planned', 'Follow-up', 'Regulatory', 
                                            'Pre-Operational', 'Safety Walk', 'Housekeeping', 'Equipment-Specific', 'Audit'
                                        ];
                                        
                                        defaultTypes.forEach(type => {
                                            const value = type.toLowerCase().replace(/\s+/g, '-');
                                            const label = type;
                                            if (isBlockedInspectionType(value, label)) return;
                                            const option = document.createElement('option');
                                            option.value = value;
                                            option.textContent = label;
                                            inspectionTypeSelect.appendChild(option);
                                        });
                                    }

                                    // Always ensure 'Audit' option exists
                                    ensureAuditOption(inspectionTypeSelect);
                                    
                                    // If editing an inspection, set the inspection type value after options are loaded
                                    if (currentInspectionData && currentInspectionData.inspectionType) {
                                        inspectionTypeSelect.value = currentInspectionData.inspectionType;
                                    }
                                })
                                .catch(error => {
                                    console.error('Error loading inspection types:', error);
                                });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading inspection types from field options:', error);
                    });
            }

            // Audit Checklist Designer Logic
            (function initAuditChecklistDesigner(){
                const typeSelect = document.getElementById('inspectionType');
                const frequencySelect = document.getElementById('frequency');
                const designerSection = document.getElementById('auditChecklistDesigner');
                const itemsContainer = document.getElementById('auditChecklistItems');
                const template = document.getElementById('auditChecklistItemTemplate');
                const templateSelect = document.getElementById('auditTemplateSelect');
                const loadTemplateBtn = document.getElementById('loadAuditTemplateBtn');
                const refreshTemplatesBtn = document.getElementById('refreshAuditTemplatesBtn');
                const templateStatus = document.getElementById('auditTemplateStatus');

                if(!typeSelect || !designerSection) return; // safety

                let auditItemCounter = 0;
                // Track applied template (for edit/save context)
                let appliedTemplate = { id: null, name: null };

                function setSectionEnabled(section, enabled){
                    if(!section) return;
                    const disabled = !enabled;
                    section.querySelectorAll('input, textarea, select, button').forEach(el => {
                        if(disabled){ el.setAttribute('disabled','disabled'); }
                        else { el.removeAttribute('disabled'); }
                    });
                }

                function enforceAuditRecurringChecklistVisibility(){
                    const rawType = (typeSelect.value || '').toLowerCase();
                    const isAudit = rawType === 'audit';
                    const isInspection = rawType === 'inspection' || rawType === 'scheduled'; // treat 'scheduled' (renamed label) as Inspection
                    const shouldShowForType = isAudit || isInspection; // new requirement: show for inspection or audit

                    // Apply type gating class so deferred date logic can still hide until start date
                    if(shouldShowForType){
                        designerSection.classList.add('type-enabled');
                    } else {
                        designerSection.classList.remove('type-enabled');
                    }

                    // Do NOT force display here; defer to date-based script + type gating.
                    // We simply ensure inputs are enabled only when type matches.
                    setSectionEnabled(designerSection, shouldShowForType);

                    // Legacy general checklist removed; keep safety branch if resurrected later
                    const generalChecklist = document.querySelector('.form-section.deferred-section[data-deferred="checklist"]');
                    if(generalChecklist){
                        if(shouldShowForType){
                            // Hide old checklist if both exist (prevention)
                            generalChecklist.style.display = 'none';
                            setSectionEnabled(generalChecklist, false);
                        } else {
                            generalChecklist.style.display = '';
                        }
                    }

                    if(!shouldShowForType && itemsContainer.children.length > 0) {
                        console.info('[AuditChecklist] items retained but hidden (type neither audit nor inspection). They will not be saved unless type becomes Audit on submit.');
                    }
                }

                function toggleDesigner(){
                    enforceAuditRecurringChecklistVisibility();
                }

                function addAuditItem(prefill){
                    const clone = template.content.firstElementChild.cloneNode(true);
                    const idx = auditItemCounter++;
                    clone.dataset.index = idx;
                    if(prefill){
                        clone.querySelector('.audit-item-title').value = prefill.title || '';
                        clone.querySelector('.audit-item-description').value = prefill.description || '';
                        clone.querySelector('.audit-item-risk').value = prefill.risk || 'medium';
                        clone.querySelector('.audit-item-weight').value = prefill.weight || '';
                        clone.querySelector('.audit-item-notes').value = prefill.notes || '';
                        if (prefill.file && prefill.file.name) {
                            const info = clone.querySelector('.audit-item-file-info');
                            if (info) {
                                info.style.display = 'block';
                                const linkHtml = prefill.file.downloadURL
                                    ? `<a href="${prefill.file.downloadURL}" target="_blank">${prefill.file.name}</a>`
                                    : prefill.file.name;
                                info.innerHTML = `Attached: ${linkHtml}`;
                            }
                            clone.dataset.fileMeta = JSON.stringify(prefill.file);
                        }
                    }
                    // Bind file input change (new on inspection page)
                    const fileInput = clone.querySelector('.audit-item-file-input');
                    const infoEl = clone.querySelector('.audit-item-file-info');
                    if(fileInput){
                        fileInput.addEventListener('change', (e)=>{
                            const file = e.target.files && e.target.files[0];
                            if(!file){
                                if(infoEl){ infoEl.style.display='none'; infoEl.textContent='None'; }
                                delete clone.dataset.fileLocal;
                                return;
                            }
                            if(file.size > 5*1024*1024){
                                alert('File exceeds 5MB limit.');
                                e.target.value='';
                                return;
                            }
                            // Store file in global map for later upload on submit
                            window.__auditItemFiles = window.__auditItemFiles || {};
                            const localKey = `local_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                            window.__auditItemFiles[localKey] = file;
                            clone.dataset.fileLocal = localKey;
                            if(infoEl){
                                infoEl.style.display='block';
                                infoEl.innerHTML = `Selected: ${file.name} <span style="color:#888;">(${(file.size/1024).toFixed(1)} KB)</span>`;
                            }
                        });
                    }
                    // Fields remain editable for audit reporting; no add/remove controls provided intentionally.
                    itemsContainer.appendChild(clone);
                }

                typeSelect.addEventListener('change', toggleDesigner);
                frequencySelect?.addEventListener('change', toggleDesigner);
                // Initial state
                toggleDesigner();

                // Expose a collector for submission
                window.collectAuditChecklist = function(){
                    const t = (typeSelect.value||'').toLowerCase();
                    if(!(t === 'audit' || t === 'inspection' || t === 'scheduled')) return null; // include 'scheduled' (Inspection label)
                    const items = [];
                    Array.from(itemsContainer.querySelectorAll('.audit-item')).forEach(el => {
                        const item = {
                            title: el.querySelector('.audit-item-title')?.value?.trim() || '',
                            description: el.querySelector('.audit-item-description')?.value?.trim() || '',
                            risk: el.querySelector('.audit-item-risk')?.value || 'medium',
                            weight: el.querySelector('.audit-item-weight')?.value || '',
                            notes: el.querySelector('.audit-item-notes')?.value?.trim() || ''
                        };
                        // Only attach file meta if present; avoid undefined which Firebase rejects
                        const meta = el.dataset.fileMeta ? JSON.parse(el.dataset.fileMeta) : null;
                        if(meta){
                            item.file = meta;
                        } else if (el.dataset.fileLocal){
                            // We'll upload later; don't include placeholder to DB now
                            item._pendingFileLocal = el.dataset.fileLocal;
                        }
                        if(item.title || item.description) items.push(item);
                    });
                    return items.length ? items : [];
                }

                // Expose applied template info for submit
                window.getAppliedAuditTemplateInfo = function(){
                    const id = designerSection?.dataset.auditTemplateId || appliedTemplate.id;
                    const name = designerSection?.dataset.auditTemplateName || appliedTemplate.name;
                    return id ? { id, name: name || '' } : null;
                }

                // Allow external code (populateFormFields) to reflect selection by id
                window.setAuditTemplateSelection = function(id, name){
                    if(!id) return;
                    const opt = templateSelect?.querySelector(`option[value="${id}"]`);
                    if(opt && templateSelect){
                        templateSelect.value = id;
                        const label = name || opt.textContent;
                        if(templateStatus) templateStatus.textContent = `Template '${label}' loaded`;
                        appliedTemplate = { id, name: label };
                        if (designerSection){
                            designerSection.dataset.auditTemplateId = id;
                            designerSection.dataset.auditTemplateName = label;
                        }
                    }
                }

                // Expose utilities for edit mode
                window.refreshAuditChecklistVisibility = function(){
                    toggleDesigner();
                }
                window.renderAuditChecklist = function(items){
                    try {
                        itemsContainer.innerHTML = '';
                        (items || []).forEach(prefill => addAuditItem(prefill));
                        designerSection.style.display = 'block';
                    } catch(e){ console.warn('[AuditChecklist] render failed', e); }
                }

                // Template operations
                async function loadAuditTemplates(){
                    templateSelect.innerHTML = '<option value="">-- Select Template --</option>';
                    templateStatus.textContent = 'Loading templates...';
                    try {
                        const storedUserRaw = localStorage.getItem('currentUser');
                        const storedUser = storedUserRaw ? JSON.parse(storedUserRaw) : null;
                        const companyId = storedUser && storedUser.companyId ? storedUser.companyId : null;
                        if(!companyId){
                            templateStatus.textContent = 'No company context';
                            return;
                        }
                        const snap = await database.ref(`companies/${companyId}/auditChecklistTemplates`).once('value');
                        if(snap.exists()){
                            snap.forEach(child => {
                                const tpl = child.val();
                                const opt = document.createElement('option');
                                opt.value = child.key;
                                opt.textContent = tpl.name || child.key;
                                opt.dataset.items = JSON.stringify(tpl.items || []);
                                templateSelect.appendChild(opt);
                            });
                            templateStatus.textContent = 'Templates loaded';
                        } else {
                            templateStatus.textContent = 'No templates yet';
                        }
                    } catch(err){
                        console.error('Load templates error', err);
                        templateStatus.textContent = 'Error loading templates';
                    }
                }
                function applySelectedTemplate(){
                    const selected = templateSelect.value;
                    if(!selected){ alert('Select a template to load.'); return; }
                    const opt = templateSelect.querySelector(`option[value="${selected}"]`);
                    if(!opt){ alert('Template not found.'); return; }
                    try {
                        const items = JSON.parse(opt.dataset.items || '[]');
                        window.renderAuditChecklist(items);
                        // Force type to audit if not already
                        if((typeSelect.value || '').toLowerCase() !== 'audit'){
                            typeSelect.value = 'audit';
                            window.refreshAuditChecklistVisibility?.();
                        }
                        templateStatus.textContent = `Template '${opt.textContent}' loaded`;
                        appliedTemplate = { id: selected, name: opt.textContent };
                        if (designerSection){
                            designerSection.dataset.auditTemplateId = selected;
                            designerSection.dataset.auditTemplateName = opt.textContent;
                        }
                    } catch(e){
                        console.error('Apply template parse error', e);
                        alert('Failed to parse template items');
                    }
                }
                // Event bindings (save disabled in this screen)
                loadTemplateBtn?.addEventListener('click', applySelectedTemplate);
                refreshTemplatesBtn?.addEventListener('click', loadAuditTemplates);
                // Auto load on init
                loadAuditTemplates();
            })();
            
            // Load existing inspection data if editing (company-scoped)
            function loadInspectionData(inspectionId) {
                return new Promise((resolve, reject) => {
                    if (!inspectionId) {
                        reject(new Error('No inspection ID provided'));
                        return;
                    }

                    // Resolve company context from centralized auth/localStorage
                    let storedUser = null;
                    try { storedUser = JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch (e) { storedUser = null; }
                    const companyId = storedUser && storedUser.companyId ? storedUser.companyId : null;
                    if (!companyId) {
                        console.warn('No company context found when loading inspection');
                        alert('Please sign in and select a company to edit inspections.');
                        reject(new Error('Missing company context'));
                        return;
                    }

                    // Show loading state
                    document.getElementById('submitBtn').disabled = true;
                    
                    console.log(`Attempting to load inspection with ID: ${inspectionId}`);
                    
                    database.ref(`companies/${companyId}/inspections/${inspectionId}`).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                console.log('Inspection data retrieved successfully');
                                const inspectionData = snapshot.val();
                                inspectionData.id = inspectionId; // Ensure ID is set

                                // If this is a child inspection (has seriesId), load parent data first
                                if (inspectionData.seriesId && inspectionData.seriesId !== inspectionId) {
                                    console.log(`This is a child inspection with seriesId: ${inspectionData.seriesId}, loading parent data`);
                                    return database.ref(`companies/${companyId}/inspections/${inspectionData.seriesId}`).once('value')
                                        .then(parentSnapshot => {
                                            if (parentSnapshot.exists()) {
                                                const parentData = parentSnapshot.val();
                                                console.log('Parent inspection data loaded successfully');
                                                // Merge parent data with child data, child data takes precedence
                                                const mergedData = {
                                                    ...parentData,
                                                    ...inspectionData,
                                                    // Ensure these fields are from the child
                                                    id: inspectionId,
                                                    seriesId: inspectionData.seriesId,
                                                    requestedDate: inspectionData.requestedDate || parentData.requestedDate,
                                                    status: inspectionData.status || 'pending',
                                                    seriesIndex: inspectionData.seriesIndex,
                                                    seriesOriginalDate: inspectionData.seriesOriginalDate
                                                };

                                                currentInspectionData = mergedData;
                                                populateFormFields(mergedData);
                                                
                                                // Explicitly load findings if they exist
                                                if (mergedData.findings && Array.isArray(mergedData.findings)) {
                                                    console.log(`Populating ${mergedData.findings.length} findings`);
                                                    populateFindings(mergedData.findings);
                                                }
                                                
                                                document.getElementById('submitBtn').disabled = false;
                                                resolve(mergedData);
                                            } else {
                                                // If parent not found, just use child data
                                                console.warn('Parent inspection not found, using only child data');
                                                currentInspectionData = inspectionData;
                                                populateFormFields(inspectionData);
                                                
                                                // Explicitly load findings if they exist
                                                if (inspectionData.findings && Array.isArray(inspectionData.findings)) {
                                                    console.log(`Populating ${inspectionData.findings.length} findings`);
                                                    populateFindings(inspectionData.findings);
                                                }
                                                
                                                document.getElementById('submitBtn').disabled = false;
                                                resolve(inspectionData);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error loading parent inspection:', error);
                                            // Still try to use child data if parent load fails
                                            currentInspectionData = inspectionData;
                                            populateFormFields(inspectionData);
                                            
                                            // Explicitly load findings if they exist
                                            if (inspectionData.findings && Array.isArray(inspectionData.findings)) {
                                                console.log(`Populating ${inspectionData.findings.length} findings`);
                                                populateFindings(inspectionData.findings);
                                            }
                                            
                                            document.getElementById('submitBtn').disabled = false;
                                            resolve(inspectionData);
                                        });
                                } else {
                                    // Not a child inspection, use data as is
                                    console.log('Using inspection data directly (not a child inspection)');
                                    currentInspectionData = inspectionData;
                                    populateFormFields(inspectionData);
                                    
                                    // Explicitly load findings if they exist
                                    if (inspectionData.findings && Array.isArray(inspectionData.findings)) {
                                        console.log(`Populating ${inspectionData.findings.length} findings`);
                                        populateFindings(inspectionData.findings);
                                    }
                                    
                                    document.getElementById('submitBtn').disabled = false;
                                    resolve(inspectionData);
                                }
                            } else {
                                console.error(`Inspection with ID ${inspectionId} not found in database`);
                                document.getElementById('submitBtn').disabled = false;
                                // Show a more specific error message
                                alert(`Inspection with ID ${inspectionId} was not found. It may have been deleted.`);
                                reject(new Error('Inspection not found'));
                            }
                        })
                        .catch(error => {
                            document.getElementById('submitBtn').disabled = false;
                            console.error('Firebase error loading inspection:', error);
                            // Show more helpful error message with details
                            alert(`Error loading inspection data: ${error.message}. Please check your connection and try again.`);
                            reject(error);
                        });
                });
            }

            // Helper function to populate form fields
            function populateFormFields(inspectionData) {
                console.log('Populating form fields with inspection data');
                // List all form field IDs and their corresponding data keys
                const fieldMappings = {
                    'inspectionTitle': 'title',
                    'referenceNumber': 'referenceNumber',
                    'inspectionDescription': 'description',
                    'inspectionArea': 'area',
                    'regulatoryRequirements': 'regulatoryRequirements',
                    'estimatedDuration': 'estimatedDuration',
                    'frequency': 'frequency',
                    'inspectionPriority': 'priority',
                    'inspectionType': 'inspectionType',
                    'inspectionLocation': 'location',
                    'department': 'department',
                    'assignedTo': 'assignedTo'
                };

                // Safely populate each field
                Object.entries(fieldMappings).forEach(([elementId, dataKey]) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = inspectionData[dataKey] || '';
                    }
                });

                // Ensure Audit Checklist Designer is shown and populated when editing an audit
                try {
                    const typeVal = (inspectionData.inspectionType || '').toLowerCase();
                    if (typeof window.refreshAuditChecklistVisibility === 'function') {
                        window.refreshAuditChecklistVisibility();
                    }
                    if (typeVal === 'audit') {
                        if (Array.isArray(inspectionData.auditChecklist) && typeof window.renderAuditChecklist === 'function') {
                            window.renderAuditChecklist(inspectionData.auditChecklist);
                        } else {
                            // If no saved items, still force the section visible
                            const designer = document.getElementById('auditChecklistDesigner');
                            if (designer) designer.style.display = 'block';
                        }
                        // Reflect previously applied template selection (without reloading items)
                        try {
                            if (inspectionData.auditTemplateId && typeof window.setAuditTemplateSelection === 'function') {
                                window.setAuditTemplateSelection(inspectionData.auditTemplateId, inspectionData.auditTemplateName);
                            }
                        } catch(e) { /* non-fatal */ }
                    }
                } catch (e) {
                    console.warn('Audit checklist restore skipped:', e);
                }

                // Checklist removed; no legacy population.

                // Handle recurrence details if it's a recurring inspection
                if (inspectionData.frequency && inspectionData.frequency !== 'one-time') {
                    console.log('Processing recurrence data');
                    const recurrenceDetails = document.getElementById('recurrenceDetails');
                    const weeklyDetails = document.getElementById('weeklyDetails');
                    const timeDetails = document.getElementById('timeDetails');
                    
                    if (recurrenceDetails) recurrenceDetails.style.display = 'flex';
                    if (timeDetails) timeDetails.style.display = 'flex';
                    
                    // Set start and end dates
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');
                    
                    if (startDateInput) {
                        startDateInput.value = inspectionData.recurrenceStartDate || inspectionData.requestedDate || '';
                        startDateInput.setAttribute('required', 'required');
                    }
                    
                    if (endDateInput) {
                        endDateInput.value = inspectionData.recurrenceEndDate || '';
                    }
                    
                    // Handle weekly/bi-weekly specific settings
                    if ((inspectionData.frequency === 'weekly' || inspectionData.frequency === 'bi-weekly') && weeklyDetails) {
                        weeklyDetails.style.display = 'flex';
                        
                        // Set selected days if they exist
                        if (Array.isArray(inspectionData.recurringDays)) {
                            console.log('Setting recurring days:', inspectionData.recurringDays);
                            // Reset all checkboxes first
                            const dayCheckboxes = document.querySelectorAll('.day-checkbox input');
                            if (dayCheckboxes && dayCheckboxes.length > 0) {
                                dayCheckboxes.forEach(cb => {
                                    if (cb) cb.checked = false;
                                });
                                
                                // Check the days that were selected
                                inspectionData.recurringDays.forEach(dayIndex => {
                                    const checkbox = document.querySelector(`.day-checkbox input[value="${dayIndex}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            } else {
                                console.warn('Day checkboxes not found in the DOM');
                            }
                        }
                    }
                    
                    // Set start time if it exists
                    const startTimeInput = document.getElementById('startTime');
                    if (startTimeInput) {
                        startTimeInput.value = inspectionData.recurringTime || '';
                    }
                }

                // If there are attachments, load them into the file list
                if (Array.isArray(inspectionData.attachments)) {
                    console.log(`Processing ${inspectionData.attachments.length} attachments`);
                    inspectionData.attachments.forEach((attachment, index) => {
                        // Mark the attachment as existing
                        attachment.isExisting = true;
                        attachedFiles.push(attachment);
                        addFileToList(attachment, index);
                    });
                }
                
                console.log('Form fields populated successfully');
            }

            // Helper function to populate select fields and ensure options exist
            function populateSelectField(fieldName, value) {
                if (!value) return;
                
                const selectElement = document.getElementById(fieldName === 'inspectionType' ? 'inspectionType' :
                    fieldName === 'location' ? 'inspectionLocation' : 'department');
                
                if (!selectElement) return;

                // If the value doesn't exist in the options, add it
                if (!Array.from(selectElement.options).some(opt => opt.value === value)) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value.charAt(0).toUpperCase() + 
                        value.slice(1).replace(/-/g, ' ');
                    selectElement.appendChild(option);
                }
                
                selectElement.value = value;
            }
            
            // Form submission
            document.getElementById('inspectionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Disable submit button to prevent double submission
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'Submitting...';
                
                try {
                    const inspectionId = document.getElementById('inspectionId').value;
                    const isNewInspection = !inspectionId;
                    
                    // Get reference number - either existing or generate new one
                    const referenceNumber = isNewInspection ? 
                        await generateReferenceNumber() : 
                        document.getElementById('referenceNumber').value;
                    
                    // Prepare inspection data with common fields
                    const inspectionData = {
                        title: document.getElementById('inspectionTitle').value,
                        referenceNumber: referenceNumber,
                        inspectionType: document.getElementById('inspectionType').value,
                        priority: document.getElementById('inspectionPriority').value,
                        location: document.getElementById('inspectionLocation').value,
                        department: document.getElementById('department').value,
                        team: Array.from(document.getElementById('teamMembersInput').value.split(',')),
                        teamNames: Array.from(document.getElementById('selectedTeamMembers').querySelectorAll('.team-member-name')).map(el => el.textContent),
                        estimatedDuration: document.getElementById('estimatedDuration').value,
                        frequency: document.getElementById('frequency').value,
                        requestedBy: document.getElementById('requestedById').value,
                        requestedByName: document.getElementById('requestedBy').value,
                        status: isNewInspection ? 'pending' : (currentInspectionData?.status || 'pending'),
                        updatedAt: new Date().toISOString(),
                        checklist: null, // Checklist removed
                        auditChecklist: (typeof window.collectAuditChecklist === 'function') ? window.collectAuditChecklist() : null,
                        findings: Array.from(document.querySelectorAll('.finding-item')).map(findingElement => {
                            // Skip the template finding
                            if (findingElement.id === 'finding-template' || findingElement.style.display === 'none') {
                                return null;
                            }
                            
                            return {
                                description: findingElement.querySelector('.finding-description')?.value || '',
                                correctiveAction: findingElement.querySelector('.corrective-action')?.value || '',
                                responsiblePerson: findingElement.querySelector('.responsible-person')?.value || '',
                                deadline: findingElement.querySelector('.deadline')?.value || '',
                                priority: findingElement.querySelector('.priority')?.value || '',
                                status: findingElement.querySelector('.status')?.value || 'open',
                                comments: findingElement.querySelector('.comments')?.value || '',
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                        }).filter(finding => finding !== null) // Remove null entries
                    };

                    // Persist the applied audit template reference (if any)
                    const appliedTpl = (typeof window.getAppliedAuditTemplateInfo === 'function') ? window.getAppliedAuditTemplateInfo() : null;
                    if (appliedTpl && appliedTpl.id) {
                        inspectionData.auditTemplateId = appliedTpl.id;
                        inspectionData.auditTemplateName = appliedTpl.name || '';
                    }
                    
                    // Calculate scheduled inspections count based on frequency
                    let scheduledCount = 1; // Default for one-time inspections
                    
                    if (inspectionData.frequency !== 'one-time') {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        
                        if (startDate && endDate) {
                            const start = new Date(startDate);
                            const end = new Date(endDate);
                            
                            // Calculate the number of scheduled inspections based on frequency
                            const days = Math.round((end - start) / (24 * 60 * 60 * 1000));
                            
                            switch(inspectionData.frequency) {
                                case 'daily':
                                    scheduledCount = days + 1; // Include start day
                                    break;
                                case 'weekly':
                                    // Get selected days of week
                                    const selectedDays = [];
                                    document.querySelectorAll('.day-checkbox input:checked').forEach(cb => {
                                        selectedDays.push(parseInt(cb.value));
                                    });
                                    
                                    if (selectedDays.length > 0) {
                                        // Calculate weeks between dates
                                        const weeks = Math.ceil(days / 7);
                                        scheduledCount = weeks * selectedDays.length;
                                    } else {
                                        scheduledCount = Math.ceil(days / 7);
                                    }
                                    break;
                                case 'bi-weekly':
                                    // Get selected days of week
                                    const selectedBiWeekDays = [];
                                    document.querySelectorAll('.day-checkbox input:checked').forEach(cb => {
                                        selectedBiWeekDays.push(parseInt(cb.value));
                                    });
                                    
                                    if (selectedBiWeekDays.length > 0) {
                                        // Calculate bi-weeks between dates
                                        const biWeeks = Math.ceil(days / 14);
                                        scheduledCount = biWeeks * selectedBiWeekDays.length;
                                    } else {
                                        scheduledCount = Math.ceil(days / 14);
                                    }
                                    break;
                                case 'monthly':
                                    scheduledCount = Math.ceil(days / 30);
                                    break;
                                case 'quarterly':
                                    scheduledCount = Math.ceil(days / 90);
                                    break;
                                case 'annually':
                                    scheduledCount = Math.ceil(days / 365);
                                    break;
                            }
                        }
                        
                        // Add recurrence details to the inspection data
                        inspectionData.recurrenceStartDate = document.getElementById('startDate').value;
                        inspectionData.recurrenceEndDate = document.getElementById('endDate').value;
                        inspectionData.recurringTime = document.getElementById('startTime').value;
                        
                        // Add selected days for weekly/bi-weekly recurrence
                        if (inspectionData.frequency === 'weekly' || inspectionData.frequency === 'bi-weekly') {
                            const selectedDays = [];
                            document.querySelectorAll('.day-checkbox input:checked').forEach(cb => {
                                selectedDays.push(parseInt(cb.value));
                            });
                            inspectionData.recurringDays = selectedDays;
                        }
                    }
                    
                    // Store the calculated scheduled count
                    inspectionData.scheduledCount = scheduledCount;
                    
                    // Add creation date for new inspections
                    if (isNewInspection) {
                        inspectionData.createdAt = new Date().toISOString();
                    }
                    
                    // Handle file uploads
                    let fileUploadPromises = [];
                    let newAttachments = [];
                    
                    // Keep track of existing files
                    const existingAttachments = attachedFiles.filter(file => file.isExisting);
                    
                    // Upload new files
                    const newFiles = attachedFiles.filter(file => !file.isExisting);
                    for (const fileItem of newFiles) {
                        if (fileItem.file) {
                            const storageRef = storage.ref(`inspection-attachments/${Date.now()}-${fileItem.name}`);
                            const uploadTask = storageRef.put(fileItem.file);
                            
                            const uploadPromise = uploadTask.then(() => {
                                return storageRef.getDownloadURL().then(downloadURL => {
                                    return {
                                        name: fileItem.name,
                                        url: downloadURL,
                                        size: fileItem.size,
                                        path: `inspection-attachments/${Date.now()}-${fileItem.name}`,
                                        uploadedAt: firebase.database.ServerValue.TIMESTAMP
                                    };
                                });
                            });
                            
                            fileUploadPromises.push(uploadPromise);
                        }
                    }
                    
                    // Wait for all uploads to complete
                    if (fileUploadPromises.length > 0) {
                        newAttachments = await Promise.all(fileUploadPromises);
                    }
                    
                    // Combine existing and new attachments
                    inspectionData.attachments = [...existingAttachments, ...newAttachments];
                    
                    // Add recurrence data if it's not a one-time inspection
                    if (inspectionData.frequency !== 'one-time') {
                        const selectedDays = [];
                        if (inspectionData.frequency === 'weekly' || inspectionData.frequency === 'bi-weekly') {
                            // Get selected days
                            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, index) => {
                                if (document.getElementById(`day-${day}`).checked) {
                                    selectedDays.push(index);
                                }
                            });
                        }

                        inspectionData.recurrence = {
                            startDate: document.getElementById('startDate').value,
                            endDate: document.getElementById('endDate').value || null,
                            pattern: inspectionData.frequency,
                            days: selectedDays,
                            time: document.getElementById('startTime').value || '09:00',
                            nextOccurrence: calculateNextOccurrence(
                                document.getElementById('startDate').value,
                                inspectionData.frequency,
                                selectedDays,
                                document.getElementById('startTime').value || '09:00'
                            )
                        };
                    }
                    
                    // Enhanced calculateNextOccurrence function
                    function calculateNextOccurrence(startDate, frequency, selectedDays = [], startTime = '09:00') {
                        const date = new Date(startDate + 'T' + startTime);
                        
                        switch(frequency) {
                            case 'daily':
                                date.setDate(date.getDate() + 1);
                                break;
                            case 'weekly':
                            case 'bi-weekly':
                                if (selectedDays.length > 0) {
                                    const currentDay = date.getDay();
                                    // Find the next selected day
                                    const nextDay = selectedDays.find(day => day > currentDay) || selectedDays[0];
                                    const daysToAdd = nextDay > currentDay ? 
                                        nextDay - currentDay : 
                                        7 - currentDay + nextDay;
                                    date.setDate(date.getDate() + daysToAdd);
                                    if (frequency === 'bi-weekly' && nextDay <= currentDay) {
                                        date.setDate(date.getDate() + 7); // Add another week for bi-weekly
                                    }
                                } else {
                                    // If no days selected, use simple weekly/bi-weekly calculation
                                    date.setDate(date.getDate() + (frequency === 'weekly' ? 7 : 14));
                                }
                                break;
                            case 'monthly':
                                date.setMonth(date.getMonth() + 1);
                                break;
                            case 'quarterly':
                                date.setMonth(date.getMonth() + 3);
                                break;
                            case 'bi-annual':
                                date.setMonth(date.getMonth() + 6);
                                break;
                            case 'annual':
                                date.setFullYear(date.getFullYear() + 1);
                                break;
                        }
                        return date.toISOString();
                    }
                    
                    // Upload audit checklist item files (if any) BEFORE saving main inspection so we can attach metadata
                    if (Array.isArray(inspectionData.auditChecklist) && inspectionData.auditChecklist.length) {
                        const fileMap = window.__auditItemFiles || {};
                        for (let i = 0; i < inspectionData.auditChecklist.length; i++) {
                            const item = inspectionData.auditChecklist[i];
                            const domItem = document.querySelector(`.audit-item[data-index="${i}"]`);
                            const existingMeta = domItem?.dataset.fileMeta ? JSON.parse(domItem.dataset.fileMeta) : null;
                            if (existingMeta) {
                                // Already had a stored file; preserve and sync
                                item.file = existingMeta;
                                delete item._pendingFileLocal;
                                continue;
                            }
                            const pendingKey = (item && item._pendingFileLocal) || (domItem && domItem.dataset.fileLocal) || null;
                            if (pendingKey && fileMap[pendingKey]) {
                                const rawFile = fileMap[pendingKey];
                                try {
                                    // Resolve company scope for path
                                    const storedUserRaw = localStorage.getItem('currentUser');
                                    const storedUser = storedUserRaw ? JSON.parse(storedUserRaw) : null;
                                    const companyId = storedUser && storedUser.companyId ? storedUser.companyId : 'unknown-company';
                                    const storagePath = `companies/${companyId}/audit-checklists/${referenceNumber}/${Date.now()}-${rawFile.name}`;
                                    const storageRef = firebase.storage().ref(storagePath);
                                    await storageRef.put(rawFile);
                                    const downloadURL = await storageRef.getDownloadURL();
                                    const meta = { name: rawFile.name, path: storagePath, downloadURL };
                                    item.file = meta;
                                    if (domItem){
                                        domItem.dataset.fileMeta = JSON.stringify(meta);
                                        domItem.dataset.fileLocal = '';
                                    }
                                    delete item._pendingFileLocal;
                                    // file status UI removed; show info via file-info element only
                                } catch (uploadErr) {
                                    console.error('Audit checklist file upload failed:', uploadErr);
                                    // file status UI removed; optionally we could surface errors via notifications
                                    item.file = { error: uploadErr.message };
                                    delete item._pendingFileLocal;
                                }
                            } else {
                                // No file selected; ensure we don't keep placeholder props
                                delete item._pendingFileLocal;
                                if (typeof item.file === 'undefined') delete item.file;
                            }
                        }
                    }

                    // Final sanitation: remove any lingering undefined from auditChecklist items
                    if (Array.isArray(inspectionData.auditChecklist)) {
                        inspectionData.auditChecklist = inspectionData.auditChecklist.map(it => {
                            if (typeof it.file === 'undefined') delete it.file;
                            if (typeof it._pendingFileLocal !== 'undefined') delete it._pendingFileLocal;
                            return it;
                        });
                    }

                    // Preserve series information for child inspections
                    if (!isNewInspection && currentInspectionData) {
                        // If this is a child inspection, preserve the series relationship
                        if (currentInspectionData.seriesId && currentInspectionData.seriesId !== inspectionId) {
                            inspectionData.seriesId = currentInspectionData.seriesId;
                            inspectionData.seriesIndex = currentInspectionData.seriesIndex;
                            inspectionData.seriesOriginalDate = currentInspectionData.seriesOriginalDate;
                            // For child inspections, always set frequency to one-time as they are individual occurrences
                            inspectionData.frequency = 'one-time';
                        }
                    }
                    
                    // Resolve company scope
                    const storedUserRaw = localStorage.getItem('currentUser');
                    const storedUser = storedUserRaw ? JSON.parse(storedUserRaw) : null;
                    const companyId = storedUser && storedUser.companyId ? storedUser.companyId : null;
                    if (!companyId) {
                        alert('Please log in to submit an inspection to your company.');
                        // Re-enable submit button
                        document.getElementById('submitBtn').disabled = false;
                        document.getElementById('submitBtn').textContent = document.getElementById('inspectionId').value ? 
                            'Update Request' : 'Submit Request';
                        return;
                    }
                    const basePath = `companies/${companyId}/inspections`;
                    // Save to Firebase under company scope
                    const inspectionRef = isNewInspection ? 
                        database.ref(basePath).push() : 
                        database.ref(`${basePath}/${inspectionId}`);
                    
                    await inspectionRef.set(inspectionData);

                    // After saving, ensure recurring series occurrences are generated (for Weekly/Bi-weekly/Daily at minimum)
                    async function ensureSeriesOccurrences(parentId, inspectionData, companyId, isNew) {
                        try {
                            const freq = (inspectionData.frequency || '').toLowerCase();
                            if (!freq || freq === 'one-time') return; // only for recurring parents

                            // Resolve recurrence inputs
                            const startDateStr = inspectionData.recurrenceStartDate
                                || (inspectionData.recurrence && inspectionData.recurrence.startDate)
                                || inspectionData.requestedDate
                                || '';
                            const endDateStr = inspectionData.recurrenceEndDate
                                || (inspectionData.recurrence && inspectionData.recurrence.endDate)
                                || '';
                            const timeStr = inspectionData.recurringTime
                                || (inspectionData.recurrence && inspectionData.recurrence.time)
                                || '09:00';
                            const selectedDays = Array.isArray(inspectionData.recurringDays)
                                ? inspectionData.recurringDays
                                : (inspectionData.recurrence && Array.isArray(inspectionData.recurrence.days)
                                    ? inspectionData.recurrence.days
                                    : []);

                            if (!startDateStr) return; // nothing to generate without a start

                            const refPath = `companies/${companyId}/inspections`;
                            // Fetch existing children to avoid duplicates
                            const existingSnap = await database.ref(refPath).orderByChild('seriesId').equalTo(parentId).once('value');
                            const existingDates = new Set();
                            if (existingSnap.exists()) {
                                existingSnap.forEach(s => {
                                    const v = s.val();
                                    const dateKey = (v.seriesOriginalDate || v.requestedDate || '').slice(0,10);
                                    if (dateKey) existingDates.add(dateKey);
                                });
                            }

                            // Build desired occurrence dates
                            const start = new Date(startDateStr + 'T' + timeStr);
                            const end = endDateStr ? new Date(endDateStr + 'T' + timeStr) : null;
                            const maxOccurrences = end ? 1000 : 8; // cap when open-ended
                            const parentDateKey = (inspectionData.requestedDate || startDateStr).slice(0,10);

                            const datesToCreate = [];
                            const pushIfNeeded = (d) => {
                                const dk = d.toISOString().slice(0,10);
                                if (dk === parentDateKey) return; // skip parent's own date
                                if (existingDates.has(dk)) return;
                                datesToCreate.push(new Date(d));
                            };

                            if (freq === 'weekly' || freq === 'bi-weekly') {
                                const stepWeeks = (freq === 'weekly') ? 1 : 2;
                                const days = (selectedDays && selectedDays.length ? [...selectedDays] : [start.getDay()]).sort((a,b)=>a-b);
                                let current = new Date(start);
                                let safetyWeeks = 0;
                                while ((end ? current <= end : datesToCreate.length < maxOccurrences) && safetyWeeks < 104) {
                                    const weekStart = new Date(current);
                                    weekStart.setHours(0,0,0,0);
                                    weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // back to Sunday
                                    for (const wd of days) {
                                        const d = new Date(weekStart);
                                        d.setDate(d.getDate() + wd);
                                        d.setHours(start.getHours(), start.getMinutes(), 0, 0);
                                        if (d < start) continue; // forward only
                                        if (end && d > end) continue;
                                        pushIfNeeded(d);
                                        if (!end && datesToCreate.length >= maxOccurrences) break;
                                    }
                                    current.setDate(current.getDate() + 7 * stepWeeks);
                                    safetyWeeks += stepWeeks;
                                }
                            } else if (freq === 'daily') {
                                let d = new Date(start);
                                let safety = 0;
                                while ((end ? d <= end : datesToCreate.length < maxOccurrences) && safety < 365) {
                                    if (d > start) pushIfNeeded(d);
                                    d.setDate(d.getDate() + 1);
                                    safety++;
                                }
                            } else {
                                // Minimal support for other patterns: create next single occurrence
                                const d = new Date(start);
                                switch (freq) {
                                    case 'monthly': d.setMonth(d.getMonth() + 1); break;
                                    case 'quarterly': d.setMonth(d.getMonth() + 3); break;
                                    case 'bi-annual': d.setMonth(d.getMonth() + 6); break;
                                    case 'annual': d.setFullYear(d.getFullYear() + 1); break;
                                    default: break;
                                }
                                if (!end || d <= end) pushIfNeeded(d);
                            }

                            if (!datesToCreate.length) return; // nothing new to create

                            // Create child inspections
                            let index = 1 + existingDates.size; // continue indexing after existing
                            for (const d of datesToCreate) {
                                const childRef = database.ref(refPath).push();
                                const childId = childRef.key;
                                const nextIndex = index++;
                                const baseRef = inspectionData.referenceNumber || '';
                                const childRefNumber = baseRef ? `${baseRef}-${nextIndex}` : `${parentId}-${nextIndex}`;
                                const child = {
                                    ...inspectionData,
                                    id: childId,
                                    status: 'pending',
                                    frequency: 'one-time',
                                    seriesId: parentId,
                                    seriesIndex: nextIndex,
                                    seriesOriginalDate: d.toISOString(),
                                    requestedDate: d.toISOString(),
                                    referenceNumber: childRefNumber,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                // Children shouldn't carry the full recurrence object
                                delete child.recurrence;
                                // Persist child
                                await childRef.set(child);
                            }
                        } catch (e) {
                            console.warn('Failed to generate series occurrences:', e);
                        }
                    }

                    // Determine parent id and generate occurrences if needed
                    const parentId = isNewInspection ? inspectionRef.key : inspectionId;
                    await ensureSeriesOccurrences(parentId, inspectionData, companyId, isNewInspection);

                    // Create notification data
                    const notificationData = {
                        title: isNewInspection ? 'New Inspection Request' : 'Inspection Request Updated',
                        message: `${isNewInspection ? 'A new inspection request' : 'An inspection request'} "${inspectionData.title}" has been ${isNewInspection ? 'created' : 'updated'}.`,
                        type: 'inspection',
                        targetUrl: `inspectionboard.html?id=${isNewInspection ? inspectionRef.key : inspectionId}`,
                        relatedId: isNewInspection ? inspectionRef.key : inspectionId,
                        tag: 'Inspection',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Create notification in the company notifications collection
                    const notificationRef = await database.ref(`companies/${companyId}/notifications`).push(notificationData);
                    const notificationId = notificationRef.key;

                    // Get all users who should be notified
                    const usersToNotify = new Set();
                    
                    // Add the current user (request creator) to notifications
                    const currentUserId = document.getElementById('requestedById').value;
                    usersToNotify.add(currentUserId);
                    
                    // Add all team members to notifications
                    if (inspectionData.team && inspectionData.team.length > 0) {
                        inspectionData.team.forEach(memberId => {
                            if (memberId !== currentUserId) {
                                usersToNotify.add(memberId);
                            }
                        });
                    }
                    
                    // Check for admins or safety managers to notify
                    const usersSnapshot = await database.ref(`companies/${companyId}/users`).once('value');
                    if (usersSnapshot.exists()) {
                        usersSnapshot.forEach(userSnapshot => {
                            const userData = userSnapshot.val();
                            if (userData.role === 'admin' || userData.role === 'safety-manager') {
                                if (userSnapshot.key !== inspectionData.assignedTo && userSnapshot.key !== currentUserId) {
                                    usersToNotify.add(userSnapshot.key);
                                }
                            }
                        });
                    }
                    
                    // Create user-specific notifications
                    const userNotificationUpdates = {};
                    for (const userId of usersToNotify) {
                        userNotificationUpdates[`companies/${companyId}/users/${userId}/userNotifications/${notificationId}`] = {
                            id: notificationId,
                            read: false
                        };
                    }
                    
                    // Apply all updates atomically
                    await database.ref().update(userNotificationUpdates);

                    alert(`Inspection request ${isNewInspection ? 'created' : 'updated'} successfully!`);
                    window.location.href = 'inspectionboard.html';
                    
                } catch (error) {
                    console.error('Error saving inspection request:', error);
                    alert(`Error: ${error.message}`);
                    
                    // Re-enable submit button
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = document.getElementById('inspectionId').value ? 
                        'Update Request' : 'Submit Request';
                }
            });
            
            // Save as draft functionality
            document.getElementById('saveAsDraftBtn').addEventListener('click', function() {
                const inspectionId = document.getElementById('inspectionId').value;
                const isNewInspection = !inspectionId;
                
                // Prepare minimal inspection data
                const inspectionData = {
                    title: document.getElementById('inspectionTitle').value || 'Draft Inspection Request',
                    status: 'draft',
                    requestedBy: document.getElementById('requestedById').value,
                    requestedByName: document.getElementById('requestedBy').value,
                    updatedAt: new Date().toISOString()
                };
                
                // Add any other filled fields
                if (document.getElementById('inspectionType').value) {
                    inspectionData.inspectionType = document.getElementById('inspectionType').value;
                }
                
                if (document.getElementById('inspectionDescription').value) {
                    inspectionData.description = document.getElementById('inspectionDescription').value;
                }
                
                if (document.getElementById('inspectionLocation').value) {
                    inspectionData.location = document.getElementById('inspectionLocation').value;
                }
                
                if (document.getElementById('department').value) {
                    inspectionData.department = document.getElementById('department').value;
                }
                
                // Add creation date for new inspections
                if (isNewInspection) {
                    inspectionData.createdAt = new Date().toISOString();
                }
                
                // Save to Firebase under company scope
                const storedUserRaw = localStorage.getItem('currentUser');
                const storedUser = storedUserRaw ? JSON.parse(storedUserRaw) : null;
                const companyId = storedUser && storedUser.companyId ? storedUser.companyId : null;
                if (!companyId) {
                    alert('Please log in to save this draft to your company.');
                    return;
                }
                const basePath = `companies/${companyId}/inspections`;
                const inspectionRef = isNewInspection ? 
                    database.ref(basePath).push() : 
                    database.ref(`${basePath}/${inspectionId}`);
                
                inspectionRef.set(inspectionData)
                    .then(() => {
                        alert('Inspection request saved as draft.');
                        window.location.href = 'inspectionboard.html';
                    })
                    .catch(error => {
                        console.error('Error saving draft:', error);
                        alert(`Error: ${error.message}`);
                    });
            });
            
            // Cancel button
            document.getElementById('cancelBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                    window.location.href = 'inspectionboard.html';
                }
            });

            // Helper: toggle Findings & Corrective Actions and Attachments sections by frequency value
            function toggleFindingsAndAttachmentsByValue(value) {
                try {
                    const typeSelect = document.getElementById('inspectionType');
                    const rawType = (typeSelect?.value || '').toLowerCase();
                    const normalized = (value || '').toString().trim().toLowerCase().replace(/\s+/g, '-');
                    const isOnTime = normalized === 'on-time' || normalized === 'one-time';
                    // Treat underlying value 'scheduled' (label renamed to Inspection) as an inspection-equivalent
                    const effectiveType = rawType === 'scheduled' ? 'inspection' : rawType;
                    const typeAllows = effectiveType === 'inspection' || effectiveType === 'audit';

                    // Findings & Corrective Actions section
                    const findingsContainer = document.querySelector('.findings-container');
                    const findingsSection = findingsContainer ? (findingsContainer.closest('.form-section') || findingsContainer) : null;

                    // Attachments section
                    const attachmentsContainer = document.querySelector('.file-upload-container');
                    const attachmentsSection = attachmentsContainer ? (attachmentsContainer.closest('.form-section') || attachmentsContainer) : null;

                    // Show if (type is inspection/audit AND date reached via deferred logic) OR original one-time/on-time rule.
                    // Date gating handled by deferred-section classes; here we only decide display override.
                    const shouldShow = typeAllows || isOnTime;

                    if (findingsSection) {
                        findingsSection.classList.toggle('type-enabled', shouldShow);
                        findingsSection.style.display = shouldShow ? '' : 'none';
                    }
                    if (attachmentsSection) {
                        attachmentsSection.classList.toggle('type-enabled', shouldShow);
                        attachmentsSection.style.display = shouldShow ? '' : 'none';
                    }
                } catch (e) { /* no-op */ }
            }

            // Show/hide recurrence details based on frequency selection
            document.getElementById('frequency').addEventListener('change', function() {
                const recurrenceDetails = document.getElementById('recurrenceDetails');
                const weeklyDetails = document.getElementById('weeklyDetails');
                const timeDetails = document.getElementById('timeDetails');
                
                if (this.value === 'one-time') {
                    recurrenceDetails.style.display = 'flex';
                    weeklyDetails.style.display = 'none';
                    timeDetails.style.display = 'flex';  // Show time details for one-time
                    
                    // Show just the start date for one-time
                    document.getElementById('startDate').setAttribute('required', 'required');
                    document.getElementById('endDate').style.display = 'none';
                    document.getElementById('endDate').removeAttribute('required');
                } else if (this.value === 'weekly') {
                    recurrenceDetails.style.display = 'flex';
                    weeklyDetails.style.display = 'block';
                    timeDetails.style.display = 'flex';
                    document.getElementById('endDate').style.display = 'block';
                } else if (this.value !== '') {
                    recurrenceDetails.style.display = 'flex';
                    weeklyDetails.style.display = 'none';
                    timeDetails.style.display = 'flex';
                    document.getElementById('endDate').style.display = 'block';
                } else {
                    recurrenceDetails.style.display = 'none';
                    weeklyDetails.style.display = 'none';
                    timeDetails.style.display = 'none';
                }

                // Toggle visibility of Findings & Attachments for 'on-time' / 'one-time'
                toggleFindingsAndAttachmentsByValue(this.value);
            });

            // Also respond to inspection type changes to show/hide findings & attachments immediately.
            const typeEl = document.getElementById('inspectionType');
            if(typeEl){
                typeEl.addEventListener('change', function(){
                    const freqEl = document.getElementById('frequency');
                    toggleFindingsAndAttachmentsByValue(freqEl ? freqEl.value : '');
                });
            }

            // Apply initial visibility on load (handles pre-selected value/edit mode)
            (function(){
                const freqEl = document.getElementById('frequency');
                if (freqEl) toggleFindingsAndAttachmentsByValue(freqEl.value);
                // Also run once for initial type selection
                const typeEl = document.getElementById('inspectionType');
                if (typeEl) toggleFindingsAndAttachmentsByValue(freqEl ? freqEl.value : '');
            })();

            // Add recurrence data to inspection data object
            const originalFormSubmitHandler = document.getElementById('inspectionForm').onsubmit;
            document.getElementById('inspectionForm').onsubmit = async function(e) {
                e.preventDefault();
                const frequency = document.getElementById('frequency').value;
                
                if (frequency !== 'one-time') {
                    const recurrenceData = {
                        startDate: document.getElementById('startDate').value,
                        endDate: document.getElementById('endDate').value || null,
                        pattern: frequency
                    };
                    
                    // Calculate next occurrence based on pattern
                    const startDate = new Date(recurrenceData.startDate);
                    let nextOccurrence;
                    
                    switch(frequency) {
                        case 'daily':
                            nextOccurrence = new Date(startDate.setDate(startDate.getDate() + 1));
                            break;
                        case 'weekly':
                            nextOccurrence = new Date(startDate.setDate(startDate.getDate() + 7));
                            break;
                        case 'bi-weekly':
                            nextOccurrence = new Date(startDate.setDate(startDate.getDate() + 14));
                            break;
                        case 'monthly':
                            nextOccurrence = new Date(startDate.setMonth(startDate.getMonth() + 1));
                            break;
                        case 'quarterly':
                            nextOccurrence = new Date(startDate.setMonth(startDate.getMonth() + 3));
                            break;
                        case 'bi-annual':
                            nextOccurrence = new Date(startDate.setMonth(startDate.getMonth() + 6));
                            break;
                        case 'annual':
                            nextOccurrence = new Date(startDate.setFullYear(startDate.getFullYear() + 1));
                            break;
                    }
                    
                    recurrenceData.nextOccurrence = nextOccurrence.toISOString();
                    inspectionData.recurrence = recurrenceData;
                }
                
                if (originalFormSubmitHandler) {
                    return originalFormSubmitHandler.call(this, e);
                }
            };

            // Findings and Corrective Actions functionality
            const findingsContainer = document.querySelector('.findings-container');
            const addFindingBtn = document.getElementById('add-finding');
            const findingTemplate = document.getElementById('finding-template');
            
            // Hide the template
            findingTemplate.style.display = 'none';
            
            // Add new finding
            addFindingBtn.addEventListener('click', function() {
                const newFinding = findingTemplate.cloneNode(true);
                newFinding.style.display = 'block';
                newFinding.id = 'finding-' + Date.now();
                
                // Add event listener for remove button
                newFinding.querySelector('.remove-finding').addEventListener('click', function() {
                    if (confirm('Are you sure you want to remove this finding?')) {
                        newFinding.remove();
                    }
                });
                
                // Add the new finding before the template
                findingTemplate.parentNode.insertBefore(newFinding, findingTemplate);
                
                // Populate the responsible person dropdown
                populateResponsiblePersonDropdown(newFinding.querySelector('.responsible-person'));
            });
            
            // Function to populate responsible person dropdown
            function populateResponsiblePersonDropdown(select) {
                // Prefer company-scoped users; fall back to global 'users' if no company context
                let storedUser = null;
                try { storedUser = JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch (e) { storedUser = null; }
                const companyId = storedUser && storedUser.companyId ? storedUser.companyId : null;
                const usersRef = companyId ? database.ref(`companies/${companyId}/users`) : database.ref('users');
                usersRef.once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(userSnapshot => {
                                const user = userSnapshot.val();
                                const option = document.createElement('option');
                                option.value = userSnapshot.key;
                                option.textContent = user.firstName && user.lastName ? 
                                    `${user.firstName} ${user.lastName}` : 
                                    user.email || `User ${userSnapshot.key}`;
                                select.appendChild(option);
                            });
                        }
                    });
            }

            // Modify the form submission to include findings
            const form = document.getElementById('inspectionForm');
            const originalSubmit = form.onsubmit;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                // Get all findings
                const findings = [];
                document.querySelectorAll('.finding-item').forEach(findingElement => {
                    if (findingElement.id !== 'finding-template' && findingElement.style.display !== 'none') {
                        const finding = {
                            description: findingElement.querySelector('.finding-description').value,
                            correctiveAction: findingElement.querySelector('.corrective-action').value,
                            responsiblePerson: findingElement.querySelector('.responsible-person').value,
                            deadline: findingElement.querySelector('.deadline').value,
                            priority: findingElement.querySelector('.priority').value,
                            status: findingElement.querySelector('.status').value,
                            comments: findingElement.querySelector('.comments').value,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        findings.push(finding);
                    }
                });
                
                // Get inspection ID from the URL or form
                const urlParams = new URLSearchParams(window.location.search);
                let inspectionId = document.getElementById('inspectionId').value || urlParams.get('id');
                
                // Check if we're updating the specific inspection with ID -OOvOohj0IGMnA9hWFL1
                const isSpecificInspection = (inspectionId === '-OOvOohj0IGMnA9hWFL1');
                
                try {
                    // If this is the specific inspection we want to update
                    if (isSpecificInspection) {
                        // Update only the findings field at the specified path
                        await database.ref('inspections/-OOvOohj0IGMnA9hWFL1').update({
                            findings: findings,
                            updatedAt: new Date().toISOString()
                        });
                        
                        alert('Findings and corrective actions updated successfully!');
                        window.location.href = 'inspectionboard.html';
                        return;
                    }
                    
                    // If this is a different inspection or a new one, proceed with normal submission
                    // Add findings to inspection data before saving
                    let inspectionData = {
                        findings: findings
                    };
                    
                    // Call the original submit handler for other inspections
                    if (originalSubmit) {
                        return originalSubmit.call(this, e);
                    }
                } catch (error) {
                    console.error('Error saving findings:', error);
                    alert('Error saving findings: ' + error.message);
                }
            };

            // If editing, populate existing findings
            function populateFindings(findings) {
                if (findings && Array.isArray(findings)) {
                    findings.forEach(finding => {
                        const newFinding = findingTemplate.cloneNode(true);
                        newFinding.style.display = 'block';
                        newFinding.id = 'finding-' + Date.now();
                        
                        // Populate the finding fields
                        newFinding.querySelector('.finding-description').value = finding.description || '';
                        newFinding.querySelector('.corrective-action').value = finding.correctiveAction || '';
                        newFinding.querySelector('.deadline').value = finding.deadline || '';
                        newFinding.querySelector('.priority').value = finding.priority || '';
                        newFinding.querySelector('.status').value = finding.status || 'open';
                        newFinding.querySelector('.comments').value = finding.comments || '';
                        
                        // Add remove functionality
                        newFinding.querySelector('.remove-finding').addEventListener('click', function() {
                            if (confirm('Are you sure you want to remove this finding?')) {
                                newFinding.remove();
                            }
                        });
                        
                        // Add the populated finding to the container
                        findingTemplate.parentNode.insertBefore(newFinding, findingTemplate);
                        
                        // Populate and set responsible person
                        const responsibleSelect = newFinding.querySelector('.responsible-person');
                        populateResponsiblePersonDropdown(responsibleSelect);
                        if (finding.responsiblePerson) {
                            // Set timeout to ensure options are populated
                            setTimeout(() => {
                                responsibleSelect.value = finding.responsiblePerson;
                            }, 500);
                        }
                    });
                }
            }

            // Modify the existing loadInspectionData function to include findings
            const originalLoadInspectionData = loadInspectionData;
            loadInspectionData = function(inspectionId) {
                return originalLoadInspectionData(inspectionId).then(data => {
                    if (data.findings) {
                        populateFindings(data.findings);
                    }
                    return data;
                });
            };
        });
        </script>
        <!-- Deferred section visibility logic -->
        <script>
        (function(){
            function parseDate(value){
                if(!value) return null;
                const parts = value.split('-');
                if(parts.length!==3) return null;
                const [y,m,d] = parts.map(p=>parseInt(p,10));
                if(!y||!m||!d) return null;
                return new Date(y, m-1, d);
            }
            function isTodayOrPast(date){
                if(!date) return false;
                const today = new Date();
                const a = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
                const b = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
                return a <= b;
            }
            function toggleDeferred(){
                const startDateInput = document.getElementById('startDate');
                const typeSelect = document.getElementById('inspectionType');
                const frequencySelect = document.getElementById('frequency');
                const dateVal = startDateInput?.value;
                const inspectionDate = parseDate(dateVal);
                const show = isTodayOrPast(inspectionDate);
                const sections = document.querySelectorAll('.deferred-section');
                sections.forEach(sec => {
                    if(show){
                        sec.classList.add('visible');
                    } else {
                        sec.classList.remove('visible');
                    }
                    // Disable/enable interactive controls based on visibility
                    const disabled = !show;
                    sec.querySelectorAll('input, textarea, select, button').forEach(el => {
                        if(disabled){ el.setAttribute('disabled','disabled'); }
                        else { el.removeAttribute('disabled'); }
                    });
                });

                // Override: if Audit + Recurring, hide general inspection checklist and keep audit checklist active
                const isAudit = (typeSelect?.value || '').toLowerCase() === 'audit';
                const freqVal = (frequencySelect?.value || '').toLowerCase();
                const isRecurring = !!freqVal && freqVal !== 'one-time';
                const generalChecklist = document.querySelector('.form-section.deferred-section[data-deferred="checklist"]');
                if(isAudit && isRecurring && generalChecklist){
                    generalChecklist.style.display = 'none';
                    generalChecklist.querySelectorAll('input, textarea, select, button').forEach(el => el.setAttribute('disabled','disabled'));
                } else if (generalChecklist) {
                    // Remove override and let class control visibility
                    generalChecklist.style.display = '';
                }
                // Add banner message if hidden
                let banner = document.getElementById('deferredBanner');
                if(!show){
                    if(!banner){
                        banner = document.createElement('div');
                        banner.id='deferredBanner';
                        banner.style.cssText='margin:20px 0;padding:15px;border:1px dashed #aaa;background:#f8f9fa;border-radius:6px;font-size:14px;color:#555;';
                        banner.innerHTML='<strong>Inspection sections locked:</strong> Checklist, Findings, and Attachments will become available on the inspection start date.';
                        const form = document.getElementById('inspectionForm');
                        form?.insertBefore(banner, form.querySelector('.action-buttons'));
                    }
                } else if(banner){ banner.remove(); }
            }
            function init(){
                toggleDeferred();
                const startDateInput = document.getElementById('startDate');
                if(startDateInput){ startDateInput.addEventListener('change', toggleDeferred); }
            }
            if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
        })();
        </script>
    
    <script>
        // Add CSS styles for download button
        document.addEventListener('DOMContentLoaded', function(){
            document.head.insertAdjacentHTML('beforeend', `
            <style>
                .file-actions button {
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 14px;
                    margin: 0 3px;
                }
                
                .download-file {
                    color: #3498db;
                }
                
                .download-file:hover {
                    color: #2980b9;
                }
                
                .delete-file {
                    color: #dc3545;
                }
                
                .delete-file:hover {
                    color: #c82333;
                }
            </style>
            `);
        });
    </script>
    
    <script>
        // Checklist section and its dynamic behaviors have been removed.
    </script>
    <!-- Removed deprecated checklist category toggle script -->
    <script>
        // Team member selection functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Set up the team member selection input and button
            const teamMemberSelect = document.getElementById('teamMemberSelect');
            const addTeamMemberBtn = document.getElementById('addTeamMemberBtn');
            const selectedTeamMembers = document.getElementById('selectedTeamMembers');
            const teamMembersInput = document.getElementById('teamMembersInput');
            
            // Array to store selected team members
            let selectedMembers = [];
            
            // Add team member when + button is clicked
            addTeamMemberBtn.addEventListener('click', function() {
                const selectedOption = teamMemberSelect.options[teamMemberSelect.selectedIndex];
                const memberId = selectedOption.value;
                const memberName = selectedOption.text;
                
                // Check if a member is selected and not already in the list
                if (memberId && !selectedMembers.includes(memberId)) {
                    // Add to selected members array
                    selectedMembers.push(memberId);
                    
                    // Create the member element
                    const memberElement = document.createElement('div');
                    memberElement.className = 'selected-team-member';
                    memberElement.innerHTML = `
                        <span class="team-member-name">${memberName}</span>
                        <button type="button" class="btn-remove-member" data-id="${memberId}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Add to the container
                    selectedTeamMembers.appendChild(memberElement);
                    
                    // Update the hidden input with selected IDs
                    teamMembersInput.value = selectedMembers.join(',');
                    
                    // Reset the dropdown to default option
                    teamMemberSelect.selectedIndex = 0;
                    
                    // Add event listener for remove button
                    memberElement.querySelector('.btn-remove-member').addEventListener('click', function() {
                        const idToRemove = this.getAttribute('data-id');
                        
                        // Remove from selected members array
                        selectedMembers = selectedMembers.filter(id => id !== idToRemove);
                        
                        // Remove the element
                        this.parentElement.remove();
                        
                        // Update hidden input
                        teamMembersInput.value = selectedMembers.join(',');
                    });
                }
            });
            
            // Function to populate team members from existing data
            function populateSelectedTeamMembers(memberIds, memberNames) {
                if (!memberIds || !memberIds.length) return;
                
                // Clear existing selections
                selectedTeamMembers.innerHTML = '';
                selectedMembers = [];
                
                // Populate with existing team members
                memberIds.forEach((memberId, index) => {
                    if (!memberId) return;
                    
                    // Add to selected members array
                    selectedMembers.push(memberId);
                    
                    // Get name from memberNames array if available, otherwise use ID
                    const memberName = memberNames && memberNames[index] ? memberNames[index] : memberId;
                    
                    // Create the member element
                    const memberElement = document.createElement('div');
                    memberElement.className = 'selected-team-member';
                    memberElement.innerHTML = `
                        <span class="team-member-name">${memberName}</span>
                        <button type="button" class="btn-remove-member" data-id="${memberId}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Add to the container
                    selectedTeamMembers.appendChild(memberElement);
                    
                    // Add event listener for remove button
                    memberElement.querySelector('.btn-remove-member').addEventListener('click', function() {
                        const idToRemove = this.getAttribute('data-id');
                        
                        // Remove from selected members array
                        selectedMembers = selectedMembers.filter(id => id !== idToRemove);
                        
                        // Remove the element
                        this.parentElement.remove();
                        
                        // Update hidden input
                        teamMembersInput.value = selectedMembers.join(',');
                    });
                });
                
                // Update the hidden input with selected IDs
                teamMembersInput.value = selectedMembers.join(',');
            }
            
            // If editing an inspection, populate the team members field
            if (currentInspectionData && currentInspectionData.team) {
                populateSelectedTeamMembers(currentInspectionData.team, currentInspectionData.teamNames);
            }
        });
    </script>
    <script src="js/notifications.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/roles.js"></script>
    <script type="module" src="js/inspection.js"></script>
    <script>
        // Rename 'Scheduled' option label to 'Inspection' in the Inspection Type dropdown
        // This adjusts only the displayed text while preserving the original option value.
        (function(){
            function renameScheduledOption(){
                var sel = document.getElementById('inspectionType');
                if(!sel) return;
                Array.prototype.forEach.call(sel.options || [], function(opt){
                    if(typeof opt.text === 'string' && opt.text.trim().toLowerCase() === 'scheduled'){
                        opt.text = 'Inspection';
                    }
                });
            }

            function onReady(fn){
                if(document.readyState === 'loading'){
                    document.addEventListener('DOMContentLoaded', fn);
                } else { fn(); }
            }

            onReady(function(){
                // Initial pass
                renameScheduledOption();
                // Observe future changes to the dropdown options (async loads)
                var sel = document.getElementById('inspectionType');
                if(!sel || typeof MutationObserver === 'undefined') return;
                var observer = new MutationObserver(function(){ renameScheduledOption(); });
                observer.observe(sel, { childList: true });
            });
        })();
    </script>
</body>
</html>