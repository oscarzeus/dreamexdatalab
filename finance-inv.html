<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoicing - Dreamex Datalab</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Firebase v8 Scripts (for company branding in header) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <style>
    :root { --primary-color:#2c3e50; --secondary-color:#34495e; --sidebar-width:250px; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; z-index:1000; transition:transform .3s ease; }
    .sidebar.collapsed { transform:translateX(-100%); }
    .logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:1.05rem; }
    .menu { list-style:none; margin-top:2rem; }
    .menu li { margin-bottom:0.5rem; }
    .menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.75rem 1rem; border-radius:5px; font-size:0.82rem; font-weight:500; transition:background .25s; }
    .menu a:hover, .menu a.active { background:var(--secondary-color); }
    .submenu { list-style:none; margin-left:2rem; display:none; margin-top:0.5rem; }
    .menu-dropdown:hover .submenu { display:block; }
    .submenu a { font-size:0.75rem; padding:0.45rem 0.65rem; }
    [data-feature]:not(.menu-visible) { display:none !important; }
    .menu-dropdown:not(.menu-visible) { display:none !important; }

    /* Hide ALL menu items by default during loading */
    .sidebar.menu-loading .menu-item,
    .sidebar.menu-loading .menu-dropdown,
    .sidebar.menu-loading li[data-feature],
    .sidebar.menu-loading [data-feature] { display: none !important; }
    /* Allow menu-visible items to show even during loading */
    .sidebar.menu-loading .menu-visible,
    .sidebar.menu-loading li.menu-visible,
    .sidebar.menu-loading [data-feature].menu-visible { display: block !important; }
    .menu-loading [data-feature] { display: none !important; }
    .menu-loading .menu-dropdown { display: none !important; }
    /* Ensure menu-visible items are always shown */
    .menu-visible { display: block !important; }
    li.menu-visible, [data-feature].menu-visible { display: block !important; }

    .main-content { flex:1; margin-left:var(--sidebar-width); padding:0.3rem; padding-top:3.2rem; transition:margin-left .3s ease; min-height:100vh; }
    .main-content.sidebar-collapsed { margin-left:0; }
    .top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
    .sidebar.collapsed ~ .main-content .top-nav { left:0.5rem; }
    .sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
    .top-nav-left { display:flex; align-items:center; gap:0.75rem; }
    .company-branding { display:flex; align-items:center; gap:0.5rem; }
    #headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    #headerCompanyName { font-weight:600; font-size:0.85rem; }
    .top-nav-right { display:flex; align-items:center; gap:1rem; }
    .user-profile { position:relative; }
    .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
    .profile-btn img { width:100%; height:100%; object-fit:cover; }
    .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; z-index:1001; }
    .profile-dropdown.show { display:block; }
    .profile-dropdown ul { list-style:none; }
    .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
    .profile-dropdown li a:hover { background:#f1f5f9; }

    .page-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 0.55rem 0.75rem; margin: 0.35rem 0 0.5rem 0; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); font-size: 0.9rem; }
    .page-header h1 { color:#fff; font-size:0.9rem; display:flex; align-items:center; gap:0.5rem; letter-spacing:0.5px; margin:0; font-weight:600; }
    .page-header i { font-size:1rem; }
    .btn-add-new { background:none; border:none; color:#fff; padding:0.4rem; font-size:1.2rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; text-decoration:none; }
    .btn-add-new:hover { color:rgba(255,255,255,0.8); transform:scale(1.1); }
    .btn-add-new i { font-size:1.2rem; }

    .section { background:#fff; padding:0.6rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.06); margin-bottom:0.5rem; }
    .grid { display:grid; gap:0.5rem; grid-template-columns: repeat(2, 1fr); }
    .field { display:flex; flex-direction:column; gap:0.25rem; }
    label { font-size:0.75rem; color:#64748b; }
    input, select, textarea { padding:0.45rem 0.55rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.85rem; }
    textarea { min-height:72px; resize:vertical; }

    .btn { border:none; border-radius:6px; padding:0.5rem 0.8rem; font-size:0.78rem; font-weight:600; cursor:pointer; background:#2c3e50; color:#fff; }
    .btn.secondary { background:#fff; color:#1e293b; border:1px solid #cbd5e1; }
    .btn.danger { background:#b91c1c; }
    .btn.success { background:#16a34a; }
    .btn-row { display:flex; gap:0.4rem; flex-wrap:wrap; justify-content:flex-end; }
    .btn-add { width:36px; height:36px; border-radius:50%; font-size:1rem; display:inline-flex; align-items:center; justify-content:center; padding:0; }

    table { width:100%; border-collapse:collapse; font-size:0.82rem; }
    th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #eef2f7; vertical-align:middle; }
    th { color:#475569; font-size:0.75rem; font-weight:700; background:#f8fafc; }
    tbody tr:hover { background:#f1f5f9; }
    .items-table input { width:100%; }
    .items-actions { width:1%; white-space:nowrap; }
    .totals { display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
    .totals .line { display:flex; gap:10px; min-width:240px; justify-content:space-between; }
    .muted { color:#64748b; font-size:0.78rem; }
    .pill { display:inline-block; padding:3px 10px; border-radius:999px; font-size:0.72rem; background:#eef2f7; color:#334155; font-weight:600; }
    .pill.estimate { background:#dbeafe; color:#1e40af; }
    .pill.invoice { background:#dcfce7; color:#166534; }
    .pill.receipt { background:#fef9c3; color:#854d0e; }

    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:0.5rem; margin-bottom:0.5rem; flex-wrap:wrap; }
    .toolbar-left { display:flex; gap:0.4rem; align-items:center; }
    .toolbar-right { display:flex; gap:0.4rem; align-items:center; }

    /* Enhanced Modal Styles (matching fleet.html vehicle inspection modal) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease-in-out;
    }
    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .modal {
        background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
      border-radius: 0;
        width: 95%;
        max-width: 1100px;
        max-height: 90vh;
        overflow: hidden;
        position: relative;
        transform: scale(0.7);
        opacity: 0;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
    }
    .modal-overlay.show .modal {
        transform: scale(1);
        opacity: 1;
    }
    .modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.95);
        position: sticky;
        top: 0;
        z-index: 2;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.03);
    }
    .modal-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .modal-header h2::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        width: 40px;
        height: 3px;
        background: #3b82f6;
        border-radius: 2px;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    .modal-close:hover {
        background-color: #f0f0f0;
        color: #333;
        transform: rotate(90deg);
    }
    .modal-body {
        padding: 1.25rem 1.5rem;
        overflow-y: auto;
        flex: 1;
        max-height: calc(90vh - 200px);
        scrollbar-width: thin;
        scrollbar-color: #ddd transparent;
    }
    .modal-body::-webkit-scrollbar {
        width: 6px;
    }
    .modal-body::-webkit-scrollbar-track {
        background: transparent;
    }
    .modal-body::-webkit-scrollbar-thumb {
        background-color: #ddd;
        border-radius: 3px;
    }
    .modal-body::-webkit-scrollbar-thumb:hover {
        background-color: #bbb;
    }
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 0.85rem;
        align-items: center;
        flex-wrap: wrap;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.95);
        position: sticky;
        bottom: 0;
        z-index: 2;
        box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
    }
    .modal-footer-left { display:flex; gap:0.5rem; }
    .modal-footer-right { display:flex; gap:0.5rem; }

    /* Tab Navigation (matching accessboard.html design) */
    .tabs-nav{display:flex;gap:0;border-bottom:2px solid #e5e7eb;margin-bottom:1rem}
    .tab-btn{padding:.6rem 1.2rem;font-size:.85rem;font-weight:500;color:#6b7280;background:transparent;border:none;cursor:pointer;position:relative;transition:color .2s;display:inline-flex;align-items:center;gap:6px}
    .tab-btn:hover{color:#111827}
    .tab-btn.active{color:var(--primary-color);font-weight:600}
    .tab-btn.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--primary-color)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .empty-state { text-align:center; padding:2rem; color:#64748b; }
    .empty-state i { font-size:2.5rem; margin-bottom:0.5rem; opacity:0.5; }

    /* View Details Modal - Investigation Report Style */
    .view-modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:flex-start; justify-content:center; overflow:auto; padding:32px 20px; }
    .view-modal-overlay.show { display:flex; }
    .view-modal { background:#fff; border-radius:0; width:100%; max-width:940px; min-height:60vh; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:visible; }
    .view-modal-btns { position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:10; }
    .view-modal-btns button { border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .view-btn-print { background:#111827; color:#fff; }
    .view-btn-edit { background:#3b82f6; color:#fff; }
    .view-btn-close { background:#fff; border:1px solid #d1d5db; color:#111827; }
    .view-sheet { background:#fff; width:100%; padding:20px 24px 40px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827; }
    .view-header { display:flex; justify-content:space-between; gap:20px; margin-bottom:0; align-items:flex-start; }
    .view-company-block { display:flex; flex-direction:column; align-items:flex-start; gap:8px; }
    .view-logo { width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px; }
    .view-doc-title { font-size:.9rem; font-weight:700; margin:2px 0 0; color:#111827; }
    .view-divider { height:1px; background:#e5e7eb; margin:12px 0 18px; border-radius:1px; }
    .view-section-title { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; font-weight:600; font-size:.75rem; padding:10px 14px; border:none; border-radius:0; display:flex; align-items:center; gap:10px; box-shadow:0 2px 8px rgba(44,62,80,0.15); margin-top:16px; }
    .view-section-title i { font-size:1rem; width:28px; height:28px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .view-info-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px 14px; margin-top:8px; }
    .view-info-item { border:1px solid #e5e7eb; border-radius:6px; background:#fff; padding:10px 12px; display:flex; align-items:flex-start; column-gap:8px; }
    .view-info-item .label { font-size:.74rem; color:#374151; font-weight:700; min-width:100px; white-space:nowrap; }
    .view-info-item .label::after { content:':'; margin-left:4px; }
    .view-info-item .value { font-size:.74rem; color:#111827; line-height:1.35; flex:1; }
    .view-items-table { width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px; }
    .view-items-table th, .view-items-table td { padding:8px 10px; border:1px solid #e5e7eb; text-align:left; }
    .view-items-table th { background:#f8fafc; font-weight:600; color:#374151; }
    .view-items-table td { background:#fff; color:#111827; }
    .view-totals { margin-top:12px; display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
    .view-totals .row { display:flex; gap:20px; min-width:200px; justify-content:space-between; font-size:.75rem; }
    .view-totals .row.grand { border-top:2px solid #e5e7eb; padding-top:6px; font-weight:700; font-size:.85rem; }
    .view-notes { margin-top:16px; padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; font-size:.74rem; color:#374151; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f1f5f9; }

    @media print {
      @page { size:A4; margin:10mm; }
      
      /* Hide everything by default */
      html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
      body * { visibility:hidden !important; }
      
      /* Show printable area and all children */
      #viewDetailsOverlay, 
      #viewDetailsOverlay * { visibility:visible !important; }
      
      /* Position and size the print area */
      #viewDetailsOverlay { 
        position:absolute !important; 
        left:0 !important; 
        top:0 !important; 
        width:100% !important; 
        padding:0 !important; 
        background:transparent !important; 
        display:block !important;
        overflow:visible !important;
      }
      
      .view-modal { 
        box-shadow:none !important; 
        border-radius:0 !important; 
        width:100% !important; 
        max-width:100% !important; 
        min-height:auto !important;
        overflow:visible !important;
      }
      
      .view-sheet { 
        width:100% !important; 
        min-height:auto !important; 
        margin:0 !important; 
        padding:10mm !important; 
        border:none !important; 
        box-shadow:none !important; 
      }
      
      /* Hide buttons */
      .view-modal-btns { display:none !important; }
      
      /* Section title styling for print - matching investigation reports */
      .view-section-title { 
        background: linear-gradient(135deg, #2c3e50, #34495e) !important; 
        color: #fff !important; 
        border: none !important;
        border-radius: 0 !important;
        padding: 10px 12px !important;
        page-break-after:avoid !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .view-section-title i {
        color: #fff !important;
        font-size: 0.9rem !important;
        width: 24px !important;
        height: 24px !important;
        background: rgba(255,255,255,0.2) !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Info grid styling for print */
      .view-info-grid { 
        display:grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap:8px !important; 
        margin-top:8px !important;
      }
      .view-info-item { 
        page-break-inside:avoid !important; 
        break-inside:avoid !important; 
        border:1px solid #e5e7eb !important; 
        background:#fff !important; 
        padding:8px 10px !important;
        border-radius:0 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .view-info-item .label {
        font-weight:700 !important;
        color:#374151 !important;
        font-size:.72rem !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .view-info-item .value {
        color:#111827 !important;
        font-size:.72rem !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Table styling for print - matching investigation reports */
      .view-items-table { 
        width:100% !important; 
        border-collapse:collapse !important;
        page-break-inside:auto !important;
        margin-top:8px !important;
      }
      .view-items-table th { 
        background:#2c3e50 !important; 
        color:#fff !important; 
        font-weight:600 !important;
        font-size:0.68rem !important;
        padding:8px 10px !important;
        border:1px solid #2c3e50 !important;
        -webkit-print-color-adjust:exact !important; 
        print-color-adjust:exact !important; 
      }
      .view-items-table td {
        background:#fff !important;
        color:#111827 !important;
        border:1px solid #e5e7eb !important;
        padding:8px 10px !important;
        font-size:0.7rem !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      .view-items-table tr { 
        page-break-inside:avoid !important; 
      }
      
      /* Totals styling for print */
      .view-totals {
        margin-top:12px !important;
        page-break-inside:avoid !important;
      }
      .view-totals .row {
        font-size:0.72rem !important;
        padding:4px 0 !important;
      }
      .view-totals .row.grand {
        font-size:0.8rem !important;
        font-weight:700 !important;
        border-top:2px solid #2c3e50 !important;
        padding-top:8px !important;
        margin-top:4px !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      /* Notes styling for print */
      .view-notes {
        background:#f9fafb !important;
        border:1px solid #d1d5db !important;
        border-radius:0 !important;
        padding:10px 12px !important;
        font-size:0.72rem !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      /* Header styling for print */
      .view-header {
        page-break-after:avoid !important;
      }
      .view-logo {
        border:1px solid #e5e7eb !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      .view-divider {
        background:#e5e7eb !important;
        height:1px !important;
        margin:12px 0 !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
    }

    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .modal { max-width:98%; }
      .view-info-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <nav class="sidebar menu-loading" id="sidebar">
      <div class="logo"><h2>Dreamex Datalab</h2></div>
        <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view">
      			<a href="#"><i class="fas fa-medkit"></i> Health</a>
      			<ul class="submenu">
      				<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
      				<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
      				<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
      			</ul>
      		</li>
            <!-- Risk Management (separate section) -->
            <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
            <ul class="submenu">
                <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
            </ul>
            </li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
      			<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
      			<ul class="submenu">
      				<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
      				<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
      				<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
      				<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
      				<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
      				<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
      			</ul>
      		</li>
            <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
      			<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
      			<ul class="submenu">
      				<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
      				<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
      				<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
      			</ul>
      		</li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
      			<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
      			<ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
      			</ul>
      		</li>
            <li class="menu-dropdown" data-feature="environment_view">
      			<a href="#"><i class="fas fa-leaf"></i> Environment</a>
      			<ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
      			</ul>
      		</li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
      			<a href="#"><i class="fas fa-lock"></i> Security</a>
      			<ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
      					<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
      					<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
      			</ul>
      		</li>
      		<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
      			<a href="#"><i class="fas fa-truck"></i> Logistics</a>
      			<ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
      			</ul>
      		</li>
      		<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
      			<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
      			<ul class="submenu">
      				<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
      			</ul>
      		</li>
      		<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
      			<a href="#"><i class="fas fa-users"></i> HR</a>
      			<ul class="submenu">
      				<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
      				<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
      				<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
      				<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
      				<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
      				<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
      				<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
      				<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
      				<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
      				<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
      				<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
      			</ul>
      		</li>
            <!-- Project Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="project_management_section">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                </ul>
            </li>
            <!-- Inventory Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                <ul class="submenu">
                    <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                    <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                    <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                    <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                </ul>
            </li>
            <!-- Workspaces: Catering -->
            <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                <a href="#"><i class="fas fa-utensils"></i> Workspaces â€” Catering</a>
                <ul class="submenu">
                    <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                    <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                    <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                    <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                    <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                </ul>
            </li>
            <li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
      			<a href="#"><i class="fas fa-cog"></i> Settings</a>
      			<ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
      			</ul>
      		</li>
      	</ul>
    </nav>

    <main class="main-content" id="mainContent">
      <nav class="top-nav">
        <div class="top-nav-left">
          <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
          <div class="company-branding">
            <img id="headerCompanyLogo" alt="Company Logo" />
            <span id="headerCompanyName"></span>
          </div>
        </div>
        <div class="top-nav-right">
          <div class="user-profile">
            <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
            <div class="profile-dropdown"><ul></ul></div>
          </div>
        </div>
      </nav>

      <section class="page-header">
        <h1><i class="fas fa-file-invoice"></i> Invoicing</h1>
        <button class="btn-add-new" id="btnAddNew" title="Add New"><i class="fas fa-plus"></i></button>
      </section>

      <!-- Tabs Navigation -->
      <div class="tabs-nav">
        <button class="tab-btn active" data-tab="documents"><i class="fas fa-file-invoice"></i> Documents</button>
        <button class="tab-btn" data-tab="customers"><i class="fas fa-users"></i> Customers</button>
        <button class="tab-btn" data-tab="services"><i class="fas fa-boxes"></i> Services & Products</button>
      </div>

      <!-- Documents Tab -->
      <div class="tab-content active" id="documentsTab">
        <div class="section">
        <table id="docsTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Number</th>
              <th>Customer</th>
              <th>Date</th>
              <th style="text-align:right;">Total</th>
              <th style="width:120px;"></th>
            </tr>
          </thead>
          <tbody id="docsBody"></tbody>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">
          <i class="fas fa-file-invoice"></i>
          <div>No documents yet</div>
          <div class="muted">Click the + button to create your first estimate</div>
        </div>
        </div>
      </div>

      <!-- Customers Tab -->
      <div class="tab-content" id="customersTab">
        <div class="section">
          <table id="customersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Company</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Type</th>
                <th>Balance</th>
                <th>Status</th>
                <th style="width:100px;"></th>
              </tr>
            </thead>
            <tbody id="customersBody"></tbody>
          </table>
          <div id="customersEmptyState" class="empty-state" style="display:none;">
            <i class="fas fa-users"></i>
            <div>No customers yet</div>
            <div class="muted">Click "New Customer" to add your first customer</div>
          </div>
        </div>
      </div>

      <!-- Services Tab -->
      <div class="tab-content" id="servicesTab">
        <div class="section">
          <table id="servicesTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>SKU</th>
                <th>Type</th>
                <th>Category</th>
                <th style="text-align:right;">Sales Price</th>
                <th style="text-align:right;">Cost</th>
                <th>Status</th>
                <th style="width:100px;"></th>
              </tr>
            </thead>
            <tbody id="servicesBody"></tbody>
          </table>
          <div id="servicesEmptyState" class="empty-state" style="display:none;">
            <i class="fas fa-boxes"></i>
            <div>No services or products yet</div>
            <div class="muted">Click "New Service/Product" to add your first item</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle"><i class="fas fa-file-alt"></i> <span>New Estimate</span></h2>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Document Information Section -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-file-alt"></i> Document Information</div>
          <div class="form-grid-3">
            <div class="field">
              <label for="docType">Document Type</label>
              <select id="docType">
                <option value="estimate">Estimate</option>
                <option value="invoice">Invoice</option>
                <option value="receipt">Receipt</option>
              </select>
            </div>
            <div class="field">
              <label for="docNumber">Number / Reference</label>
              <input id="docNumber" readonly style="background:#f1f5f9;cursor:not-allowed;" />
            </div>
            <div class="field">
              <label for="issueDate">Issue Date</label>
              <input id="issueDate" type="date" />
            </div>
          </div>
          <div class="form-grid-2" id="dueDateField" style="margin-top:0.5rem;">
            <div class="field">
              <label for="dueDate">Due Date</label>
              <input id="dueDate" type="date" />
            </div>
            <div></div>
          </div>
        </div>

        <!-- Customer Information Section -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-user"></i> Customer Information</div>
          <div class="form-grid-2">
            <div class="field" style="grid-column: span 2;">
              <label for="customerSelect">Select Customer</label>
              <select id="customerSelect" style="width:100%;">
                <option value="">-- Select Existing Customer --</option>
                <option value="__new__">+ Add New Customer</option>
              </select>
            </div>
            <div class="field">
              <label for="customerName">Customer Name *</label>
              <input id="customerName" placeholder="Customer name" />
            </div>
            <div class="field">
              <label for="customerEmail">Customer Email</label>
              <input id="customerEmail" placeholder="customer@email.com" />
            </div>
            <div class="field">
              <label for="customerPhone">Phone</label>
              <input id="customerPhone" placeholder="Phone number" />
            </div>
            <div class="field">
              <label for="customerCompanyField">Company</label>
              <input id="customerCompanyField" placeholder="Company name" />
            </div>
          </div>
          <!-- Customer Address Display (readonly, populated from selection) -->
          <div id="customerAddressBlock" style="display:none; margin-top:0.75rem; padding:0.75rem; background:#f8fafc; border:1px solid #e5e7eb; border-radius:6px;">
            <div style="font-size:0.72rem; font-weight:600; color:#374151; margin-bottom:0.5rem;"><i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>Billing Address</div>
            <div id="customerAddressText" style="font-size:0.75rem; color:#111827; line-height:1.5;"></div>
          </div>
        </div>

        <!-- Line Items Section -->
        <div class="form-section">
          <div class="form-section-title" style="display:flex; justify-content:space-between; align-items:center;">
            <span><i class="fas fa-list"></i> Services / Products</span>
            <button class="btn secondary" id="btnAddItem" type="button" style="font-size:0.72rem;"><i class="fas fa-plus"></i> Add Item</button>
          </div>
          <table class="items-table">
            <thead>
              <tr>
                <th style="width:20%;">Item</th>
                <th>Description</th>
                <th style="width:8%;">Qty</th>
                <th style="width:12%;">Unit Price</th>
                <th style="width:8%;">Tax %</th>
                <th style="width:12%;">Amount</th>
                <th class="items-actions"></th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>

        <!-- Totals Section -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-calculator"></i> Totals</div>
          <div class="totals">
            <div class="line"><span class="muted">Subtotal</span><strong id="subtotal">0.00</strong></div>
            <div class="line"><span class="muted">Tax</span><strong id="taxTotal">0.00</strong></div>
            <div class="line" style="border-top:1px solid #e2e8f0;padding-top:6px;"><span>Total</span><strong id="grandTotal" style="font-size:1rem;">0.00</strong></div>
          </div>
        </div>

        <!-- Notes Section -->
        <div class="form-section" style="border-bottom:none;">
          <div class="form-section-title"><i class="fas fa-sticky-note"></i> Notes</div>
          <div class="field">
            <textarea id="notes" placeholder="Optional notes for the customer" rows="3"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-footer-left">
          <button class="btn danger" id="btnDelete" style="display:none;"><i class="fas fa-trash"></i> Delete</button>
        </div>
        <div class="modal-footer-right">
          <button class="btn success" id="btnConvert" style="display:none;"><i class="fas fa-exchange-alt"></i> Convert to Invoice</button>
          <button class="btn secondary" id="btnCancel">Cancel</button>
          <button class="btn" id="btnSave"><i class="fas fa-save"></i> Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Details Modal (Investigation Report Style) -->
  <div class="view-modal-overlay" id="viewDetailsOverlay">
    <div class="view-modal">
      <div class="view-modal-btns">
        <button class="view-btn-print" id="viewPrintBtn"><i class="fas fa-print"></i> Print / PDF</button>
        <button class="view-btn-edit" id="viewEditBtn"><i class="fas fa-edit"></i> Edit</button>
        <button class="view-btn-close" id="viewCloseBtn">Close</button>
      </div>
      <div class="view-sheet">
        <div class="view-header">
          <div class="view-company-block">
            <img id="viewModalLogo" class="view-logo" src="" alt="Company Logo" style="width:100px; height:100px; object-fit:contain; border:none; border-radius:8px; background:#fff; display:none;">
            <div id="viewModalLogoFallback" class="view-logo" style="width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px;"></div>
            <div>
              <h1 id="viewCompanyName" style="margin:0; font-size:1.1rem; line-height:1.2; font-weight:700;"></h1>
              <h2 class="view-doc-title" id="viewDocTitle">Estimate</h2>
            </div>
          </div>
        </div>
        <div class="view-divider"></div>
        <div style="font-size:.72rem; color:#111827; margin:6px 0 12px;">
          <span style="font-weight:700; color:#374151; margin-right:6px;">Document Number:</span>
          <span id="viewDocNumber"></span>
        </div>
        
        <div class="view-section-title"><i class="fas fa-user"></i><span>Customer Information</span></div>
        <div class="view-info-grid" id="viewCustomerInfo"></div>
        
        <div class="view-section-title"><i class="fas fa-list"></i><span>Line Items</span></div>
        <table class="view-items-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Description</th>
              <th style="text-align:center;">Qty</th>
              <th style="text-align:right;">Unit Price</th>
              <th style="text-align:right;">Tax %</th>
              <th style="text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="viewItemsBody"></tbody>
        </table>
        <div class="view-totals">
          <div class="row"><span>Subtotal</span><span id="viewSubtotal">0.00</span></div>
          <div class="row"><span>Tax</span><span id="viewTaxTotal">0.00</span></div>
          <div class="row grand"><span>Total</span><span id="viewGrandTotal">0.00</span></div>
        </div>
        
        <div id="viewNotesSection" style="display:none;">
          <div class="view-section-title"><i class="fas fa-sticky-note"></i><span>Notes</span></div>
          <div class="view-notes" id="viewNotes"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Service/Product Modal -->
  <div class="modal-overlay" id="serviceModalOverlay">
    <div class="modal" style="max-width:850px;">
      <div class="modal-header">
        <h2 id="serviceModalTitle"><i class="fas fa-box"></i> <span>New Service/Product</span></h2>
        <button class="modal-close" id="serviceModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Basic Information -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-info-circle"></i> Basic Information</div>
          <div class="form-grid-2">
            <div class="field">
              <label for="serviceType">Type *</label>
              <select id="serviceType" required>
                <option value="service">Service</option>
                <option value="product">Product</option>
                <option value="bundle">Bundle / Package</option>
              </select>
            </div>
            <div class="field">
              <label for="serviceName">Name *</label>
              <input id="serviceName" type="text" placeholder="e.g. Consulting Services" required />
            </div>
            <div class="field">
              <label for="serviceSku">SKU / Item Code</label>
              <input id="serviceSku" type="text" placeholder="e.g. SRV-001" />
            </div>
            <div class="field">
              <label for="serviceCategory">Category</label>
              <select id="serviceCategory">
                <option value="">-- Select Category --</option>
                <option value="general">General</option>
                <option value="consulting">Consulting</option>
                <option value="labor">Labor</option>
                <option value="materials">Materials</option>
                <option value="equipment">Equipment</option>
                <option value="travel">Travel & Expenses</option>
                <option value="software">Software</option>
                <option value="maintenance">Maintenance</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-top:0.5rem;">
            <label for="serviceDescription">Description</label>
            <textarea id="serviceDescription" placeholder="Detailed description of the service or product..." rows="2"></textarea>
          </div>
        </div>

        <!-- Pricing Information -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-dollar-sign"></i> Pricing</div>
          <div class="form-grid-3">
            <div class="field">
              <label for="serviceSalesPrice">Sales Price / Rate *</label>
              <input id="serviceSalesPrice" type="number" step="0.01" min="0" placeholder="0.00" required />
            </div>
            <div class="field">
              <label for="serviceCost">Cost / Purchase Price</label>
              <input id="serviceCost" type="number" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div class="field">
              <label for="serviceUnit">Unit of Measure</label>
              <select id="serviceUnit">
                <option value="each">Each</option>
                <option value="hour">Hour</option>
                <option value="day">Day</option>
                <option value="week">Week</option>
                <option value="month">Month</option>
                <option value="unit">Unit</option>
                <option value="piece">Piece</option>
                <option value="box">Box</option>
                <option value="kg">Kilogram (kg)</option>
                <option value="liter">Liter</option>
                <option value="meter">Meter</option>
                <option value="sqm">Square Meter</option>
                <option value="set">Set</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tax Settings -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-percentage"></i> Tax Settings</div>
          <div class="form-grid-3">
            <div class="field">
              <label for="serviceTaxRate">Default Tax Rate (%)</label>
              <input id="serviceTaxRate" type="number" step="0.01" min="0" max="100" placeholder="0" />
            </div>
            <div class="field">
              <label for="serviceTaxCode">Tax Code</label>
              <select id="serviceTaxCode">
                <option value="">-- None --</option>
                <option value="standard">Standard Rate</option>
                <option value="reduced">Reduced Rate</option>
                <option value="zero">Zero Rated</option>
                <option value="exempt">Exempt</option>
              </select>
            </div>
            <div class="field" style="display:flex; align-items:flex-end; padding-bottom:0.5rem;">
              <div class="checkbox-field">
                <input type="checkbox" id="serviceTaxable" checked />
                <label for="serviceTaxable">Taxable</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Inventory (for Products) -->
        <div class="form-section" id="inventorySection">
          <div class="form-section-title"><i class="fas fa-warehouse"></i> Inventory (Products Only)</div>
          <div class="form-grid-4">
            <div class="field">
              <label for="serviceQtyOnHand">Qty on Hand</label>
              <input id="serviceQtyOnHand" type="number" step="1" min="0" placeholder="0" />
            </div>
            <div class="field">
              <label for="serviceReorderPoint">Reorder Point</label>
              <input id="serviceReorderPoint" type="number" step="1" min="0" placeholder="0" />
            </div>
            <div class="field">
              <label for="serviceAsOfDate">As of Date</label>
              <input id="serviceAsOfDate" type="date" />
            </div>
            <div class="field" style="display:flex; align-items:flex-end; padding-bottom:0.5rem;">
              <div class="checkbox-field">
                <input type="checkbox" id="serviceTrackQty" />
                <label for="serviceTrackQty">Track Quantity</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Accounting -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-book"></i> Accounting</div>
          <div class="form-grid-2">
            <div class="field">
              <label for="serviceIncomeAccount">Income Account</label>
              <select id="serviceIncomeAccount">
                <option value="">-- Select Account --</option>
                <option value="sales">Sales Revenue</option>
                <option value="service-income">Service Income</option>
                <option value="consulting-income">Consulting Income</option>
                <option value="other-income">Other Income</option>
              </select>
            </div>
            <div class="field">
              <label for="serviceExpenseAccount">Expense Account</label>
              <select id="serviceExpenseAccount">
                <option value="">-- Select Account --</option>
                <option value="cogs">Cost of Goods Sold</option>
                <option value="direct-costs">Direct Costs</option>
                <option value="materials">Materials & Supplies</option>
                <option value="other-expense">Other Expense</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-cog"></i> Additional Settings</div>
          <div class="form-grid-2">
            <div class="field">
              <label for="serviceVendor">Preferred Vendor</label>
              <input id="serviceVendor" type="text" placeholder="Vendor name" />
            </div>
            <div class="field">
              <label for="serviceStatus">Status</label>
              <select id="serviceStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-top:0.5rem;">
            <label for="serviceNotes">Internal Notes</label>
            <textarea id="serviceNotes" placeholder="Notes for internal reference only..." rows="2"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-footer-left">
          <button class="btn danger" id="btnDeleteService" style="display:none;"><i class="fas fa-trash"></i> Delete</button>
        </div>
        <div class="modal-footer-right">
          <button class="btn secondary" id="btnCancelService">Cancel</button>
          <button class="btn" id="btnSaveService"><i class="fas fa-save"></i> Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Modal -->
  <div class="modal-overlay" id="customerModalOverlay">
    <div class="modal" style="max-width:900px;">
      <div class="modal-header">
        <h2 id="customerModalTitle"><i class="fas fa-user-plus"></i> <span>New Customer</span></h2>
        <button class="modal-close" id="customerModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Basic Information -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-user"></i> Basic Information</div>
          <div class="form-grid-2">
            <div class="field">
              <label for="customerType">Customer Type *</label>
              <select id="customerTypeField" required>
                <option value="individual">Individual</option>
                <option value="business">Business</option>
              </select>
            </div>
            <div class="field">
              <label for="customerTitle">Title</label>
              <select id="customerTitle">
                <option value="">-- Select --</option>
                <option value="Mr.">Mr.</option>
                <option value="Mrs.">Mrs.</option>
                <option value="Ms.">Ms.</option>
                <option value="Dr.">Dr.</option>
              </select>
            </div>
            <div class="field">
              <label for="customerFirstName">First Name *</label>
              <input id="customerFirstName" type="text" placeholder="First name" required />
            </div>
            <div class="field">
              <label for="customerLastName">Last Name</label>
              <input id="customerLastName" type="text" placeholder="Last name" />
            </div>
            <div class="field">
              <label for="customerCompany">Company Name</label>
              <input id="customerCompany" type="text" placeholder="Company name" />
            </div>
            <div class="field">
              <label for="customerDisplayName">Display Name *</label>
              <input id="customerDisplayName" type="text" placeholder="How to display on invoices" required />
            </div>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-address-book"></i> Contact Information</div>
          <div class="form-grid-2">
            <div class="field">
              <label for="customerEmail">Email</label>
              <input id="customerEmailField" type="email" placeholder="customer@email.com" />
            </div>
            <div class="field">
              <label for="customerPhone">Phone</label>
              <input id="customerPhone" type="tel" placeholder="+1 (555) 123-4567" />
            </div>
            <div class="field">
              <label for="customerMobile">Mobile</label>
              <input id="customerMobile" type="tel" placeholder="+1 (555) 987-6543" />
            </div>
            <div class="field">
              <label for="customerFax">Fax</label>
              <input id="customerFax" type="tel" placeholder="+1 (555) 111-2222" />
            </div>
            <div class="field">
              <label for="customerWebsite">Website</label>
              <input id="customerWebsite" type="url" placeholder="https://www.example.com" />
            </div>
          </div>
        </div>

        <!-- Billing Address -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-map-marker-alt"></i> Billing Address</div>
          <div class="form-grid-2">
            <div class="field" style="grid-column: span 2;">
              <label for="customerBillingStreet">Street Address</label>
              <input id="customerBillingStreet" type="text" placeholder="123 Main Street" />
            </div>
            <div class="field">
              <label for="customerBillingCity">City</label>
              <input id="customerBillingCity" type="text" placeholder="City" />
            </div>
            <div class="field">
              <label for="customerBillingState">State / Province</label>
              <input id="customerBillingState" type="text" placeholder="State" />
            </div>
            <div class="field">
              <label for="customerBillingZip">Postal / ZIP Code</label>
              <input id="customerBillingZip" type="text" placeholder="12345" />
            </div>
            <div class="field">
              <label for="customerBillingCountry">Country</label>
              <select id="customerBillingCountry">
                <option value="">-- Select Country --</option>
                <option value="Afghanistan">Afghanistan</option>
                <option value="Albania">Albania</option>
                <option value="Algeria">Algeria</option>
                <option value="Andorra">Andorra</option>
                <option value="Angola">Angola</option>
                <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                <option value="Argentina">Argentina</option>
                <option value="Armenia">Armenia</option>
                <option value="Australia">Australia</option>
                <option value="Austria">Austria</option>
                <option value="Azerbaijan">Azerbaijan</option>
                <option value="Bahamas">Bahamas</option>
                <option value="Bahrain">Bahrain</option>
                <option value="Bangladesh">Bangladesh</option>
                <option value="Barbados">Barbados</option>
                <option value="Belarus">Belarus</option>
                <option value="Belgium">Belgium</option>
                <option value="Belize">Belize</option>
                <option value="Benin">Benin</option>
                <option value="Bhutan">Bhutan</option>
                <option value="Bolivia">Bolivia</option>
                <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                <option value="Botswana">Botswana</option>
                <option value="Brazil">Brazil</option>
                <option value="Brunei">Brunei</option>
                <option value="Bulgaria">Bulgaria</option>
                <option value="Burkina Faso">Burkina Faso</option>
                <option value="Burundi">Burundi</option>
                <option value="Cabo Verde">Cabo Verde</option>
                <option value="Cambodia">Cambodia</option>
                <option value="Cameroon">Cameroon</option>
                <option value="Canada">Canada</option>
                <option value="Central African Republic">Central African Republic</option>
                <option value="Chad">Chad</option>
                <option value="Chile">Chile</option>
                <option value="China">China</option>
                <option value="Colombia">Colombia</option>
                <option value="Comoros">Comoros</option>
                <option value="Congo (Congo-Brazzaville)">Congo (Congo-Brazzaville)</option>
                <option value="Costa Rica">Costa Rica</option>
                <option value="Croatia">Croatia</option>
                <option value="Cuba">Cuba</option>
                <option value="Cyprus">Cyprus</option>
                <option value="Czechia">Czechia</option>
                <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
                <option value="Denmark">Denmark</option>
                <option value="Djibouti">Djibouti</option>
                <option value="Dominica">Dominica</option>
                <option value="Dominican Republic">Dominican Republic</option>
                <option value="Ecuador">Ecuador</option>
                <option value="Egypt">Egypt</option>
                <option value="El Salvador">El Salvador</option>
                <option value="Equatorial Guinea">Equatorial Guinea</option>
                <option value="Eritrea">Eritrea</option>
                <option value="Estonia">Estonia</option>
                <option value="Eswatini">Eswatini</option>
                <option value="Ethiopia">Ethiopia</option>
                <option value="Fiji">Fiji</option>
                <option value="Finland">Finland</option>
                <option value="France">France</option>
                <option value="Gabon">Gabon</option>
                <option value="Gambia">Gambia</option>
                <option value="Georgia">Georgia</option>
                <option value="Germany">Germany</option>
                <option value="Ghana">Ghana</option>
                <option value="Greece">Greece</option>
                <option value="Grenada">Grenada</option>
                <option value="Guatemala">Guatemala</option>
                <option value="Guinea">Guinea</option>
                <option value="Guinea-Bissau">Guinea-Bissau</option>
                <option value="Guyana">Guyana</option>
                <option value="Haiti">Haiti</option>
                <option value="Honduras">Honduras</option>
                <option value="Hungary">Hungary</option>
                <option value="Iceland">Iceland</option>
                <option value="India">India</option>
                <option value="Indonesia">Indonesia</option>
                <option value="Iran">Iran</option>
                <option value="Iraq">Iraq</option>
                <option value="Ireland">Ireland</option>
                <option value="Israel">Israel</option>
                <option value="Italy">Italy</option>
                <option value="Ivory Coast">Ivory Coast</option>
                <option value="Jamaica">Jamaica</option>
                <option value="Japan">Japan</option>
                <option value="Jordan">Jordan</option>
                <option value="Kazakhstan">Kazakhstan</option>
                <option value="Kenya">Kenya</option>
                <option value="Kiribati">Kiribati</option>
                <option value="Kuwait">Kuwait</option>
                <option value="Kyrgyzstan">Kyrgyzstan</option>
                <option value="Laos">Laos</option>
                <option value="Latvia">Latvia</option>
                <option value="Lebanon">Lebanon</option>
                <option value="Lesotho">Lesotho</option>
                <option value="Liberia">Liberia</option>
                <option value="Libya">Libya</option>
                <option value="Liechtenstein">Liechtenstein</option>
                <option value="Lithuania">Lithuania</option>
                <option value="Luxembourg">Luxembourg</option>
                <option value="Madagascar">Madagascar</option>
                <option value="Malawi">Malawi</option>
                <option value="Malaysia">Malaysia</option>
                <option value="Maldives">Maldives</option>
                <option value="Mali">Mali</option>
                <option value="Malta">Malta</option>
                <option value="Marshall Islands">Marshall Islands</option>
                <option value="Mauritania">Mauritania</option>
                <option value="Mauritius">Mauritius</option>
                <option value="Mexico">Mexico</option>
                <option value="Micronesia">Micronesia</option>
                <option value="Moldova">Moldova</option>
                <option value="Monaco">Monaco</option>
                <option value="Mongolia">Mongolia</option>
                <option value="Montenegro">Montenegro</option>
                <option value="Morocco">Morocco</option>
                <option value="Mozambique">Mozambique</option>
                <option value="Myanmar">Myanmar</option>
                <option value="Namibia">Namibia</option>
                <option value="Nauru">Nauru</option>
                <option value="Nepal">Nepal</option>
                <option value="Netherlands">Netherlands</option>
                <option value="New Zealand">New Zealand</option>
                <option value="Nicaragua">Nicaragua</option>
                <option value="Niger">Niger</option>
                <option value="Nigeria">Nigeria</option>
                <option value="North Korea">North Korea</option>
                <option value="North Macedonia">North Macedonia</option>
                <option value="Norway">Norway</option>
                <option value="Oman">Oman</option>
                <option value="Pakistan">Pakistan</option>
                <option value="Palau">Palau</option>
                <option value="Palestine">Palestine</option>
                <option value="Panama">Panama</option>
                <option value="Papua New Guinea">Papua New Guinea</option>
                <option value="Paraguay">Paraguay</option>
                <option value="Peru">Peru</option>
                <option value="Philippines">Philippines</option>
                <option value="Poland">Poland</option>
                <option value="Portugal">Portugal</option>
                <option value="Qatar">Qatar</option>
                <option value="Romania">Romania</option>
                <option value="Russia">Russia</option>
                <option value="Rwanda">Rwanda</option>
                <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                <option value="Saint Lucia">Saint Lucia</option>
                <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
                <option value="Samoa">Samoa</option>
                <option value="San Marino">San Marino</option>
                <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                <option value="Saudi Arabia">Saudi Arabia</option>
                <option value="Senegal">Senegal</option>
                <option value="Serbia">Serbia</option>
                <option value="Seychelles">Seychelles</option>
                <option value="Sierra Leone">Sierra Leone</option>
                <option value="Singapore">Singapore</option>
                <option value="Slovakia">Slovakia</option>
                <option value="Slovenia">Slovenia</option>
                <option value="Solomon Islands">Solomon Islands</option>
                <option value="Somalia">Somalia</option>
                <option value="South Africa">South Africa</option>
                <option value="South Korea">South Korea</option>
                <option value="South Sudan">South Sudan</option>
                <option value="Spain">Spain</option>
                <option value="Sri Lanka">Sri Lanka</option>
                <option value="Sudan">Sudan</option>
                <option value="Suriname">Suriname</option>
                <option value="Sweden">Sweden</option>
                <option value="Switzerland">Switzerland</option>
                <option value="Syria">Syria</option>
                <option value="Taiwan">Taiwan</option>
                <option value="Tajikistan">Tajikistan</option>
                <option value="Tanzania">Tanzania</option>
                <option value="Thailand">Thailand</option>
                <option value="Timor-Leste">Timor-Leste</option>
                <option value="Togo">Togo</option>
                <option value="Tonga">Tonga</option>
                <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                <option value="Tunisia">Tunisia</option>
                <option value="Turkey">Turkey</option>
                <option value="Turkmenistan">Turkmenistan</option>
                <option value="Tuvalu">Tuvalu</option>
                <option value="Uganda">Uganda</option>
                <option value="Ukraine">Ukraine</option>
                <option value="United Arab Emirates">United Arab Emirates</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="United States">United States</option>
                <option value="Uruguay">Uruguay</option>
                <option value="Uzbekistan">Uzbekistan</option>
                <option value="Vanuatu">Vanuatu</option>
                <option value="Vatican City">Vatican City</option>
                <option value="Venezuela">Venezuela</option>
                <option value="Vietnam">Vietnam</option>
                <option value="Yemen">Yemen</option>
                <option value="Zambia">Zambia</option>
                <option value="Zimbabwe">Zimbabwe</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-shipping-fast"></i> Shipping Address</div>
          <div class="checkbox-field" style="margin-bottom:0.5rem;">
            <input type="checkbox" id="customerSameAsBilling" />
            <label for="customerSameAsBilling">Same as billing address</label>
          </div>
          <div id="shippingAddressFields">
            <div class="form-grid-2">
              <div class="field" style="grid-column: span 2;">
                <label for="customerShippingStreet">Street Address</label>
                <input id="customerShippingStreet" type="text" placeholder="123 Main Street" />
              </div>
              <div class="field">
                <label for="customerShippingCity">City</label>
                <input id="customerShippingCity" type="text" placeholder="City" />
              </div>
              <div class="field">
                <label for="customerShippingState">State / Province</label>
                <input id="customerShippingState" type="text" placeholder="State" />
              </div>
              <div class="field">
                <label for="customerShippingZip">Postal / ZIP Code</label>
                <input id="customerShippingZip" type="text" placeholder="12345" />
              </div>
              <div class="field">
                <label for="customerShippingCountry">Country</label>
                <select id="customerShippingCountry">
                  <option value="">-- Select Country --</option>
                  <option value="Afghanistan">Afghanistan</option>
                  <option value="Albania">Albania</option>
                  <option value="Algeria">Algeria</option>
                  <option value="Andorra">Andorra</option>
                  <option value="Angola">Angola</option>
                  <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                  <option value="Argentina">Argentina</option>
                  <option value="Armenia">Armenia</option>
                  <option value="Australia">Australia</option>
                  <option value="Austria">Austria</option>
                  <option value="Azerbaijan">Azerbaijan</option>
                  <option value="Bahamas">Bahamas</option>
                  <option value="Bahrain">Bahrain</option>
                  <option value="Bangladesh">Bangladesh</option>
                  <option value="Barbados">Barbados</option>
                  <option value="Belarus">Belarus</option>
                  <option value="Belgium">Belgium</option>
                  <option value="Belize">Belize</option>
                  <option value="Benin">Benin</option>
                  <option value="Bhutan">Bhutan</option>
                  <option value="Bolivia">Bolivia</option>
                  <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                  <option value="Botswana">Botswana</option>
                  <option value="Brazil">Brazil</option>
                  <option value="Brunei">Brunei</option>
                  <option value="Bulgaria">Bulgaria</option>
                  <option value="Burkina Faso">Burkina Faso</option>
                  <option value="Burundi">Burundi</option>
                  <option value="Cabo Verde">Cabo Verde</option>
                  <option value="Cambodia">Cambodia</option>
                  <option value="Cameroon">Cameroon</option>
                  <option value="Canada">Canada</option>
                  <option value="Central African Republic">Central African Republic</option>
                  <option value="Chad">Chad</option>
                  <option value="Chile">Chile</option>
                  <option value="China">China</option>
                  <option value="Colombia">Colombia</option>
                  <option value="Comoros">Comoros</option>
                  <option value="Congo (Congo-Brazzaville)">Congo (Congo-Brazzaville)</option>
                  <option value="Costa Rica">Costa Rica</option>
                  <option value="Croatia">Croatia</option>
                  <option value="Cuba">Cuba</option>
                  <option value="Cyprus">Cyprus</option>
                  <option value="Czechia">Czechia</option>
                  <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
                  <option value="Denmark">Denmark</option>
                  <option value="Djibouti">Djibouti</option>
                  <option value="Dominica">Dominica</option>
                  <option value="Dominican Republic">Dominican Republic</option>
                  <option value="Ecuador">Ecuador</option>
                  <option value="Egypt">Egypt</option>
                  <option value="El Salvador">El Salvador</option>
                  <option value="Equatorial Guinea">Equatorial Guinea</option>
                  <option value="Eritrea">Eritrea</option>
                  <option value="Estonia">Estonia</option>
                  <option value="Eswatini">Eswatini</option>
                  <option value="Ethiopia">Ethiopia</option>
                  <option value="Fiji">Fiji</option>
                  <option value="Finland">Finland</option>
                  <option value="France">France</option>
                  <option value="Gabon">Gabon</option>
                  <option value="Gambia">Gambia</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Germany">Germany</option>
                  <option value="Ghana">Ghana</option>
                  <option value="Greece">Greece</option>
                  <option value="Grenada">Grenada</option>
                  <option value="Guatemala">Guatemala</option>
                  <option value="Guinea">Guinea</option>
                  <option value="Guinea-Bissau">Guinea-Bissau</option>
                  <option value="Guyana">Guyana</option>
                  <option value="Haiti">Haiti</option>
                  <option value="Honduras">Honduras</option>
                  <option value="Hungary">Hungary</option>
                  <option value="Iceland">Iceland</option>
                  <option value="India">India</option>
                  <option value="Indonesia">Indonesia</option>
                  <option value="Iran">Iran</option>
                  <option value="Iraq">Iraq</option>
                  <option value="Ireland">Ireland</option>
                  <option value="Israel">Israel</option>
                  <option value="Italy">Italy</option>
                  <option value="Ivory Coast">Ivory Coast</option>
                  <option value="Jamaica">Jamaica</option>
                  <option value="Japan">Japan</option>
                  <option value="Jordan">Jordan</option>
                  <option value="Kazakhstan">Kazakhstan</option>
                  <option value="Kenya">Kenya</option>
                  <option value="Kiribati">Kiribati</option>
                  <option value="Kuwait">Kuwait</option>
                  <option value="Kyrgyzstan">Kyrgyzstan</option>
                  <option value="Laos">Laos</option>
                  <option value="Latvia">Latvia</option>
                  <option value="Lebanon">Lebanon</option>
                  <option value="Lesotho">Lesotho</option>
                  <option value="Liberia">Liberia</option>
                  <option value="Libya">Libya</option>
                  <option value="Liechtenstein">Liechtenstein</option>
                  <option value="Lithuania">Lithuania</option>
                  <option value="Luxembourg">Luxembourg</option>
                  <option value="Madagascar">Madagascar</option>
                  <option value="Malawi">Malawi</option>
                  <option value="Malaysia">Malaysia</option>
                  <option value="Maldives">Maldives</option>
                  <option value="Mali">Mali</option>
                  <option value="Malta">Malta</option>
                  <option value="Marshall Islands">Marshall Islands</option>
                  <option value="Mauritania">Mauritania</option>
                  <option value="Mauritius">Mauritius</option>
                  <option value="Mexico">Mexico</option>
                  <option value="Micronesia">Micronesia</option>
                  <option value="Moldova">Moldova</option>
                  <option value="Monaco">Monaco</option>
                  <option value="Mongolia">Mongolia</option>
                  <option value="Montenegro">Montenegro</option>
                  <option value="Morocco">Morocco</option>
                  <option value="Mozambique">Mozambique</option>
                  <option value="Myanmar">Myanmar</option>
                  <option value="Namibia">Namibia</option>
                  <option value="Nauru">Nauru</option>
                  <option value="Nepal">Nepal</option>
                  <option value="Netherlands">Netherlands</option>
                  <option value="New Zealand">New Zealand</option>
                  <option value="Nicaragua">Nicaragua</option>
                  <option value="Niger">Niger</option>
                  <option value="Nigeria">Nigeria</option>
                  <option value="North Korea">North Korea</option>
                  <option value="North Macedonia">North Macedonia</option>
                  <option value="Norway">Norway</option>
                  <option value="Oman">Oman</option>
                  <option value="Pakistan">Pakistan</option>
                  <option value="Palau">Palau</option>
                  <option value="Palestine">Palestine</option>
                  <option value="Panama">Panama</option>
                  <option value="Papua New Guinea">Papua New Guinea</option>
                  <option value="Paraguay">Paraguay</option>
                  <option value="Peru">Peru</option>
                  <option value="Philippines">Philippines</option>
                  <option value="Poland">Poland</option>
                  <option value="Portugal">Portugal</option>
                  <option value="Qatar">Qatar</option>
                  <option value="Romania">Romania</option>
                  <option value="Russia">Russia</option>
                  <option value="Rwanda">Rwanda</option>
                  <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                  <option value="Saint Lucia">Saint Lucia</option>
                  <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
                  <option value="Samoa">Samoa</option>
                  <option value="San Marino">San Marino</option>
                  <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                  <option value="Saudi Arabia">Saudi Arabia</option>
                  <option value="Senegal">Senegal</option>
                  <option value="Serbia">Serbia</option>
                  <option value="Seychelles">Seychelles</option>
                  <option value="Sierra Leone">Sierra Leone</option>
                  <option value="Singapore">Singapore</option>
                  <option value="Slovakia">Slovakia</option>
                  <option value="Slovenia">Slovenia</option>
                  <option value="Solomon Islands">Solomon Islands</option>
                  <option value="Somalia">Somalia</option>
                  <option value="South Africa">South Africa</option>
                  <option value="South Korea">South Korea</option>
                  <option value="South Sudan">South Sudan</option>
                  <option value="Spain">Spain</option>
                  <option value="Sri Lanka">Sri Lanka</option>
                  <option value="Sudan">Sudan</option>
                  <option value="Suriname">Suriname</option>
                  <option value="Sweden">Sweden</option>
                  <option value="Switzerland">Switzerland</option>
                  <option value="Syria">Syria</option>
                  <option value="Taiwan">Taiwan</option>
                  <option value="Tajikistan">Tajikistan</option>
                  <option value="Tanzania">Tanzania</option>
                  <option value="Thailand">Thailand</option>
                  <option value="Timor-Leste">Timor-Leste</option>
                  <option value="Togo">Togo</option>
                  <option value="Tonga">Tonga</option>
                  <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                  <option value="Tunisia">Tunisia</option>
                  <option value="Turkey">Turkey</option>
                  <option value="Turkmenistan">Turkmenistan</option>
                  <option value="Tuvalu">Tuvalu</option>
                  <option value="Uganda">Uganda</option>
                  <option value="Ukraine">Ukraine</option>
                  <option value="United Arab Emirates">United Arab Emirates</option>
                  <option value="United Kingdom">United Kingdom</option>
                  <option value="United States">United States</option>
                  <option value="Uruguay">Uruguay</option>
                  <option value="Uzbekistan">Uzbekistan</option>
                  <option value="Vanuatu">Vanuatu</option>
                  <option value="Vatican City">Vatican City</option>
                  <option value="Venezuela">Venezuela</option>
                  <option value="Vietnam">Vietnam</option>
                  <option value="Yemen">Yemen</option>
                  <option value="Zambia">Zambia</option>
                  <option value="Zimbabwe">Zimbabwe</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment & Tax -->
        <div class="form-section">
          <div class="form-section-title"><i class="fas fa-credit-card"></i> Payment & Tax</div>
          <div class="form-grid-3">
            <div class="field">
              <label for="customerPaymentTerms">Payment Terms</label>
              <select id="customerPaymentTerms">
                <option value="">-- Select --</option>
                <option value="due-on-receipt">Due on Receipt</option>
                <option value="net-15">Net 15</option>
                <option value="net-30">Net 30</option>
                <option value="net-45">Net 45</option>
                <option value="net-60">Net 60</option>
              </select>
            </div>
            <div class="field">
              <label for="customerOpeningBalance">Opening Balance</label>
              <input id="customerOpeningBalance" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div class="field">
              <label for="customerOpeningBalanceDate">As of Date</label>
              <input id="customerOpeningBalanceDate" type="date" />
            </div>
            <div class="field">
              <label for="customerTaxId">Tax ID / VAT Number</label>
              <input id="customerTaxId" type="text" placeholder="Tax ID" />
            </div>
            <div class="field">
              <label for="customerTaxExempt">Tax Exempt</label>
              <select id="customerTaxExempt">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="customerCurrency">Preferred Currency</label>
              <select id="customerCurrency">
                <option value="USD">USD - US Dollar</option>
                <option value="EUR">EUR - Euro</option>
                <option value="GBP">GBP - British Pound</option>
                <option value="GNF">GNF - Guinean Franc</option>
                <option value="CAD">CAD - Canadian Dollar</option>
                <option value="AUD">AUD - Australian Dollar</option>
                <option value="CHF">CHF - Swiss Franc</option>
                <option value="JPY">JPY - Japanese Yen</option>
                <option value="CNY">CNY - Chinese Yuan</option>
                <option value="INR">INR - Indian Rupee</option>
                <option value="ZAR">ZAR - South African Rand</option>
                <option value="NGN">NGN - Nigerian Naira</option>
                <option value="XOF">XOF - West African CFA Franc</option>
                <option value="XAF">XAF - Central African CFA Franc</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section" style="border-bottom:none;">
          <div class="form-section-title"><i class="fas fa-cog"></i> Additional Settings</div>
          <div class="form-grid-2">
            <div class="field">
              <label for="customerStatus">Status</label>
              <select id="customerStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="field">
              <label for="customerPreferredDelivery">Preferred Delivery Method</label>
              <select id="customerPreferredDelivery">
                <option value="email">Email</option>
                <option value="print">Print</option>
                <option value="none">None</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-top:0.5rem;">
            <label for="customerNotes">Notes</label>
            <textarea id="customerNotes" placeholder="Internal notes about this customer..." rows="2"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-footer-left">
          <button class="btn danger" id="btnDeleteCustomer" style="display:none;"><i class="fas fa-trash"></i> Delete</button>
        </div>
        <div class="modal-footer-right">
          <button class="btn secondary" id="btnCancelCustomer">Cancel</button>
          <button class="btn" id="btnSaveCustomer"><i class="fas fa-save"></i> Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration (copied from project-list.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
      authDomain: "users-8be65.firebaseapp.com",
      databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
      projectId: "users-8be65",
      storageBucket: "users-8be65.firebasestorage.app",
      messagingSenderId: "909025468149",
      appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
      measurementId: "G-XHFMRCJQEZ"
    };

    function initializeFirebase() {
      try {
        if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
          window.firebase.initializeApp(firebaseConfig);
        }
        return window.firebase;
      } catch (e) {
        return null;
      }
    }

    // Match project-list.html: create a shared firebase handle
    const firebase = initializeFirebase();

    // AuthManager class for centralized authentication and profile management (copied from project-list.html)
    class AuthManager {
      constructor() {
        this.currentUser = this.getCurrentUser();
        this.currentCompany = null;
        this.init();
      }
      getCurrentUser() {
        try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; }
      }
      setCurrentUser(u) {
        localStorage.setItem('currentUser', JSON.stringify(u));
        localStorage.setItem('user', JSON.stringify(u));
        this.currentUser = u;
      }
      async init() {
        if (!this.currentUser) {
          window.location.href = 'login.html';
          return;
        }
        await this.loadUserCompany();
        this.updateCompanyBranding();
        await this.updateUIForAuthenticatedUser();
        this.bindProfileDropdown();
      }
      async loadUserCompany() {
        if (!this.currentUser || !firebase || !firebase.database) return;
        try {
          const snap = await firebase.database().ref('companies').once('value');
          if (!snap.exists()) return;
          const companies = snap.val();
          for (const [cid, comp] of Object.entries(companies)) {
            if (comp.status !== 'active') continue;
            if (comp.users) {
              for (const [uid, u] of Object.entries(comp.users)) {
                if (u.authUid === this.currentUser.uid || uid === this.currentUser.uid) {
                  this.currentUser.companyId = cid;
                  this.currentUser.companyName = comp.companyName;
                  this.currentUser.role = u.role || u.userRole || 'user';
                  this.currentCompany = comp;
                  this.setCurrentUser(this.currentUser);
                  return;
                }
              }
            }
          }
        } catch (e) { }
      }
      updateCompanyBranding() {
        const logoEl = document.getElementById('headerCompanyLogo');
        const nameEl = document.getElementById('headerCompanyName');
        if (!this.currentCompany) {
          this.showFallbackBranding();
          return;
        }
        if (nameEl) nameEl.textContent = this.currentCompany.companyName || '';
        const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
        if (logoEl) {
          if (logoUrl) {
            logoEl.src = logoUrl;
            logoEl.style.display = 'block';
          } else {
            const svg = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || ''));
            logoEl.src = svg;
            logoEl.style.display = 'block';
          }
        }
        if (this.currentCompany.branding) {
          const root = document.documentElement;
          if (this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
          if (this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
        }
      }
      showFallbackBranding() {
        const logoEl = document.getElementById('headerCompanyLogo');
        if (logoEl) {
          const svg = this.generateCompanyInitialsSVG('DX');
          logoEl.src = svg;
          logoEl.style.display = 'block';
        }
      }
      getCompanyInitials(name) {
        if (!name) return 'CO';
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      generateCompanyInitialsSVG(initials) {
        const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
        return 'data:image/svg+xml;base64,' + btoa(svg);
      }
      getUserDisplayName() {
        if (!this.currentUser) return 'User';
        const n = v => typeof v === 'string' ? v.trim().replace(/\s+/g, ' ') : '';
        const cand = [this.currentUser.displayName, this.currentUser.name, this.currentUser.username];
        for (const c of cand) { const cleaned = n(c); if (cleaned) return cleaned; }
        if (this.currentUser.email) return n(this.currentUser.email.split('@')[0]) || 'User';
        return 'User';
      }
      getUserInitials() {
        const dn = this.getUserDisplayName();
        const parts = dn.split(' ').filter(Boolean);
        if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
        return parts.slice(0, 2).map(p => p[0]).join('').toUpperCase();
      }
      async getUserAvatarUrl() {
        if (!this.currentUser || !firebase || !firebase.storage) return null;
        const companyId = this.currentUser.companyId || 'default';
        const possiblePaths = [
          `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
          `companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
          `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
          `companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
          `companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
          `avatars/${this.currentUser.uid}/profile.jpg`,
          `avatars/${this.currentUser.uid}/profile.png`,
          `avatars/${this.currentUser.uid}/avatar.jpg`,
          `avatars/${this.currentUser.uid}/avatar.png`,
          `profiles/${this.currentUser.uid}/profile.jpg`,
          `profiles/${this.currentUser.uid}/profile.png`
        ];
        for (const path of possiblePaths) {
          try {
            const ref = firebase.storage().ref(path);
            const url = await ref.getDownloadURL();
            return url;
          } catch (err) { continue; }
        }
        return null;
      }
      async updateUIForAuthenticatedUser() {
        const btn = document.getElementById('userProfileBtn');
        const list = document.querySelector('.profile-dropdown ul');
        if (!btn || !list || !this.currentUser) return;
        const displayName = this.getUserDisplayName();
        const email = this.currentUser.email || '';

        let avatarUrl = null;
        try { avatarUrl = await this.getUserAvatarUrl(); } catch (error) { }

        const btnImg = btn.querySelector('img');
        if (avatarUrl && btnImg) {
          btnImg.src = avatarUrl;
          btnImg.alt = displayName + ' Avatar';
          btnImg.style.display = 'block';
          btnImg.onerror = () => {
            btnImg.style.display = 'none';
            btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
          };
        } else {
          btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
        }

        const avatarHtml = avatarUrl
          ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`
          : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
        list.innerHTML = `<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>`;
        list.querySelector('#logoutLink')?.addEventListener('click', e => { e.preventDefault(); this.logout(); });
      }
      bindProfileDropdown() {
        const btn = document.getElementById('userProfileBtn');
        const dd = document.querySelector('.profile-dropdown');
        if (btn && dd) {
          btn.addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('show'); });
          document.addEventListener('click', e => { if (!btn.contains(e.target)) dd.classList.remove('show'); });
        }
      }
      async logout() {
        try {
          if (firebase && firebase.auth) await firebase.auth().signOut();
          localStorage.removeItem('currentUser');
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        } catch (error) {
          localStorage.removeItem('currentUser');
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        }
      }
    }

    function getCompanyInitials(name) {
      if (!name) return 'CO';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    function generateCompanyInitialsSVG(initials) {
      const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
      return 'data:image/svg+xml;base64,' + btoa(svg);
    }

    function setHeaderBranding({ companyName, logoUrl }) {
      const headerLogo = document.getElementById('headerCompanyLogo');
      const headerCompanyName = document.getElementById('headerCompanyName');
      if (!headerLogo || !headerCompanyName) return;

      headerCompanyName.textContent = companyName || '';
      if (logoUrl) {
        headerLogo.src = logoUrl;
        headerLogo.style.display = 'block';
      } else if (companyName) {
        headerLogo.src = generateCompanyInitialsSVG(getCompanyInitials(companyName));
        headerLogo.style.display = 'block';
      } else {
        headerLogo.style.display = 'none';
      }
    }

    // Load company name and logo into header (matches project-list.html behavior)
    async function loadCompanyBranding() {
      try {
        const headerLogo = document.getElementById('headerCompanyLogo');
        const headerCompanyName = document.getElementById('headerCompanyName');
        if (!headerLogo || !headerCompanyName) return;

        if (!window.firebase || !window.firebase.database) {
          headerCompanyName.textContent = '';
          headerLogo.style.display = 'none';
          return;
        }

        // Resolve current user from centralized AuthManager or localStorage fallback
        let currentUser = null;
        if (window.authManager && window.authManager.currentUser) {
          currentUser = window.authManager.currentUser;
        } else {
          const storedUser = localStorage.getItem('currentUser');
          if (storedUser) currentUser = JSON.parse(storedUser);
          if (!currentUser) {
            const legacyUser = localStorage.getItem('user');
            if (legacyUser) currentUser = JSON.parse(legacyUser);
          }
        }

        if (!currentUser) {
          setHeaderBranding({ companyName: '', logoUrl: '' });
          return;
        }

        // If Firebase is unavailable or DB lookup fails, use any cached user/company info
        const cachedCompanyName = currentUser.companyName || currentUser.company || '';
        const cachedLogoUrl = currentUser.logoUrl || currentUser.logo || '';
        if (!window.firebase || !window.firebase.database) {
          setHeaderBranding({ companyName: cachedCompanyName, logoUrl: cachedLogoUrl });
          return;
        }

        const db = firebase.database();
        const companiesSnap = await db.ref('companies').once('value');
        if (!companiesSnap.exists()) {
          setHeaderBranding({ companyName: cachedCompanyName, logoUrl: cachedLogoUrl });
          return;
        }

        const companies = companiesSnap.val();
        let companyId = currentUser.companyId || null;

        // If companyId not provided on user, try to locate by membership
        if (!companyId) {
          for (const [cId, company] of Object.entries(companies)) {
            if (company?.status !== 'active') continue;
            if (company?.users && (company.users[currentUser.uid] || company.users[currentUser.authUid])) {
              companyId = cId;
              break;
            }
          }
        }

        if (companyId && companies[companyId]) {
          const company = companies[companyId];
          const companyName = company.companyName || company.name || '';
          const logoUrl = company.logoUrl || company.logo || '';

          setHeaderBranding({ companyName, logoUrl });

          // Optionally brand the page title
          if (companyName) {
            document.title = document.title.replace('Dreamex Datalab', companyName);
          }
        } else {
          setHeaderBranding({ companyName: cachedCompanyName, logoUrl: cachedLogoUrl });
        }
      } catch (err) {
        console.warn('Failed to load company branding:', err);
        // Try last-resort localStorage fallback
        try {
          const storedUser = localStorage.getItem('currentUser') || localStorage.getItem('user');
          const u = storedUser ? JSON.parse(storedUser) : null;
          setHeaderBranding({ companyName: u?.companyName || '', logoUrl: u?.logoUrl || u?.logo || '' });
        } catch (_) {
          setHeaderBranding({ companyName: '', logoUrl: '' });
        }
      }
    }

  // ===== ROLE-BASED MENU AUTHORIZATION SYSTEM =====
  // Adapted from roles.html to ensure feature filtering by user role

  // Flag to prevent multiple simultaneous executions
  let isMenuUpdateInProgress = false;

  // Reset all menu items to hidden (preserve core features only when authorized)
  function resetMenuVisibility() {
    document.querySelectorAll('[data-feature]').forEach(item => {
      item.classList.remove('menu-visible');
    });
    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
      dropdown.classList.remove('menu-visible');
    });
  }

  // Emergency fallback - show basic menu items
  function showBasicMenu() {
    console.log('ðŸ”§ Emergency fallback: Showing basic menu items');
    resetMenuVisibility();
    
    // Remove loading class

    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.classList.remove('menu-loading');
    }
    
    const homeItem = document.querySelector('[data-feature="home_view"]');
    if (homeItem) {
      homeItem.classList.add('menu-visible');
    }
  }

  // Feature-based authorization system that takes priority over role permissions
  async function updateMenuWithFeatureAuthorization() {
    // Prevent multiple simultaneous executions
    if (isMenuUpdateInProgress) {
      console.log('ðŸ”„ Menu update already in progress, skipping...');
      return;
    }
    
    isMenuUpdateInProgress = true;
    console.log('ðŸŽ¯ Starting feature-based menu authorization for project-list.html...');
    
    try {
      let currentUser = null;
      let companyId = null;
      let userRole = null;
        
      // Get user and company info using authManager first
      if (window.authManager && window.authManager.currentUser) {
        currentUser = window.authManager.currentUser;
        companyId = currentUser.companyId;
        userRole = currentUser.role;
        console.log('ðŸ‘¤ Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
      } else if (firebase.auth().currentUser) {
        currentUser = firebase.auth().currentUser;
        console.log('ðŸ‘¤ Using Firebase auth - will search for company and role');
      } else {
        console.log('âŒ No authenticated user found');
        resetMenuVisibility();
        return;
      }
        
      // If no company ID from authManager, search companies collection
      if (!companyId && currentUser) {
        console.log('ðŸ” Searching for user company and role...');
        const database = firebase.database();
        const companiesRef = database.ref('companies');
        const companiesSnapshot = await companiesRef.once('value');
            
        if (companiesSnapshot.exists()) {
          const companies = companiesSnapshot.val();
                
          for (const [cId, company] of Object.entries(companies)) {
            if (company.status !== 'active') continue;
                    
            if (company.users && company.users[currentUser.uid]) {
              companyId = cId;
              userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
              console.log(`âœ… Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
              break;
            }
          }
        }
      }
        
      if (!companyId) {
        console.error('âŒ No company ID found, cannot determine authorized features');
        resetMenuVisibility();
        return;
      }
        
      if (!userRole) {
        console.warn('âš ï¸ No user role found, proceeding with company features only');
      }
        
      // STEP 1: Apply company feature-based authorization
      console.log('ðŸ¢ STEP 1: Applying company feature authorization...');
      const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
        
      // STEP 2: Filter by user role permissions within authorized features
      if (userRole) {
        console.log('ðŸ‘¤ STEP 2: Applying role-based filtering within authorized features...');
        await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
      } else {
        console.log('âš ï¸ STEP 2: Skipping role-based filtering (no role found)');
      }
        
    } catch (error) {
      console.error('âŒ Error in feature-based menu authorization:', error);
      resetMenuVisibility();
    } finally {
      // Reset the flag to allow future updates
      isMenuUpdateInProgress = false;
    }
  }

  // Apply feature-based menu visibility
  async function applyFeatureBasedMenuVisibility(companyId) {
    try {
      console.log('ðŸ”§ Applying feature-based menu visibility for company:', companyId);
        
      // Get platform features
      const database = firebase.database();
      const featuresSnapshot = await database.ref('/platformFeatures').once('value');
        
      if (!featuresSnapshot.exists()) {
        console.log('âš ï¸ No platform features found');
        resetMenuVisibility();
        return;
      }
        
      const featuresData = featuresSnapshot.val();
        
      // Get company's selected features
      const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
      const companyData = companySnapshot.val();
        
      if (!companyData) {
        console.error('âŒ Company data not found');
        resetMenuVisibility();
        return;
      }
        
      const subscribedFeatureIds = companyData.selectedFeatures || [];
      console.log('ðŸ¢ Company subscribed features:', subscribedFeatureIds);
        
      if (subscribedFeatureIds.length === 0) {
        console.log('âš ï¸ Company has no subscribed features');
        resetMenuVisibility();
        return;
      }
        
      // Collect authorized pages from subscribed features
      const authorizedPages = [];
      subscribedFeatureIds.forEach(featureId => {
        const feature = featuresData[featureId];
        if (feature && feature.status === 'active' && feature.authorizedPages) {
          console.log(`ðŸ“¦ Adding pages from feature "${feature.name}":`, feature.authorizedPages);
          authorizedPages.push(...feature.authorizedPages);
        } else {
          console.log(`âš ï¸ Feature ${featureId} not found or inactive`);
        }
      });
        
      console.log('ðŸ” All authorized pages:', authorizedPages);
        
      // Reset all menu items first
      resetMenuVisibility();
        
      // Create set of authorized features and hrefs (with alias mapping)
      const authorizedFeatures = new Set();
      const authorizedHrefs = new Set();

      const featureAlias = (key) => {
        if (!key) return key;
        // Treat these as aliases of each other
        if (key === 'risk_view') return 'risk_management_section';
        if (key === 'risk_management_section') return 'risk_view';
        return null;
      };
      const normalizeHref = (href) => {
        if (!href) return '';
        // Keep relative path portion only
        try {
          // If absolute, take pathname; else, use as is
          const u = new URL(href, window.location.origin);
          return (u.pathname || '').replace(/^\//, '');
        } catch {
          return String(href).replace(/^\//, '');
        }
      };

      authorizedPages.forEach(pageInfo => {
        if (pageInfo.feature) {
          authorizedFeatures.add(pageInfo.feature);
          const alias = featureAlias(pageInfo.feature);
          if (alias) authorizedFeatures.add(alias);
        }
        if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
        if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
        if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
      });

      console.log('ðŸŽ¯ Authorized features for project-list.html:', Array.from(authorizedFeatures));
      console.log('ðŸ”— Authorized hrefs for project-list.html:', Array.from(authorizedHrefs));
        
      // Apply menu visibility
      const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
      let visibleCount = 0;
        
      allMenuItems.forEach(menuItem => {
        const featureAttribute = menuItem.getAttribute('data-feature');
        const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
        const anchor = menuItem.querySelector('a[href]');
        const href = anchor ? anchor.getAttribute('href') : '';
        const normalized = normalizeHref(href);
        const featureAuthorized = authorizedFeatures.has(featureAttribute);
        const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
        const isAuthorized = featureAuthorized || hrefAuthorized;

        if (isDropdownContainer) {
          return; // Handle dropdowns separately after all items are processed
        }

        if (isAuthorized) {
          menuItem.classList.add('menu-visible');
          visibleCount++;
          console.log(`âœ… Authorized - showing: feature=${featureAttribute} href=${normalized || 'â€”'}`);
        } else {
          menuItem.classList.remove('menu-visible');
          console.log(`âŒ Not authorized - hiding: feature=${featureAttribute} href=${normalized || 'â€”'}`);
        }
      });
        
      // Handle dropdown menus - show if they have visible children
      const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
      dropdownMenus.forEach(dropdown => {
        const dropdownFeature = dropdown.getAttribute('data-feature');
        const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
        let hasVisibleChildren = false;
            
        submenuItems.forEach(submenuItem => {
          if (submenuItem.classList.contains('menu-visible')) {
            hasVisibleChildren = true;
          }
        });
            
        if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
          dropdown.classList.add('menu-visible');
          console.log(`âœ… Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
        } else {
          dropdown.classList.remove('menu-visible');
          console.log(`âŒ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
        }
      });
        
      console.log(`ðŸŽ¯ Company feature authorization completed - ${visibleCount} items initially visible`);
        
      // Return authorized pages for role-based filtering
      return authorizedPages;
        
    } catch (error) {
      console.error('âŒ Error applying feature-based menu visibility:', error);
      resetMenuVisibility();
      return [];
    }
  }

  // Apply role-based filtering within company authorized features
  async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
    try {
      console.log('ðŸ‘¤ Applying role-based filtering for role:', userRole);
        
      // Get user role permissions from company
      const database = firebase.database();
      const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
      const permissionsSnapshot = await permissionsRef.once('value');
        
      if (!permissionsSnapshot.exists()) {
        console.log(`âš ï¸ No permissions found for role ${userRole} in company ${companyId}`);
            
        // Try to get all roles to see what's available
        const allRolesRef = database.ref(`companies/${companyId}/roles`);
        const allRolesSnapshot = await allRolesRef.once('value');
            
        if (allRolesSnapshot.exists()) {
          const allRoles = allRolesSnapshot.val();
          console.log('ðŸ” Available roles in company:', Object.keys(allRoles));
                
          // Enhanced debugging for administrator role
          if (userRole === 'administrator') {
            console.log('ðŸ”‘ ADMINISTRATOR - Full roles data:', allRoles);
            if (allRoles.administrator) {
              console.log('ðŸ”‘ ADMINISTRATOR role found in company:', allRoles.administrator);
              if (allRoles.administrator.permissions) {
                console.log('ðŸ”‘ ADMINISTRATOR permissions found:', allRoles.administrator.permissions);
                filterMenuByPermissions(allRoles.administrator.permissions);
                return;
              }
            }
          }
                
          // Check if the role exists with different casing or format
          const roleKeys = Object.keys(allRoles);
          const matchingRole = roleKeys.find(key => 
            key.toLowerCase() === userRole.toLowerCase() ||
            key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
          );
                
          if (matchingRole && allRoles[matchingRole].permissions) {
            console.log(`âœ… Found matching role: ${matchingRole}`);
            const permissions = allRoles[matchingRole].permissions;
            filterMenuByPermissions(permissions);
            return;
          }
        }
            
        // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
        if (userRole === 'administrator') {
          console.log('ðŸ”‘ ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
          showSidebarAfterAuth();
          return;
        }
            
        // For other roles without permissions, hide all items with permission requirements
        console.log('âŒ No valid permissions found - filtering out items requiring permissions');
        hideItemsRequiringPermissions();
        showSidebarAfterAuth();
        return;
      }
        
      const permissions = permissionsSnapshot.val();
      console.log('âœ… Loaded role permissions:', permissions);
        
      // Apply permission-based filtering
      filterMenuByPermissions(permissions);
        
    } catch (error) {
      console.error('âŒ Error applying role-based filtering:', error);
      // Don't hide everything on error - keep company features visible
      showSidebarAfterAuth();
    }
  }

  // Filter currently visible menu items by role permissions
  function filterMenuByPermissions(permissions) {
    console.log('ðŸ” Filtering visible menu items by role permissions...');
    
    if (!permissions) {
      console.log('âš ï¸ No permissions object provided');
      hideItemsRequiringPermissions();
      showSidebarAfterAuth();
      return;
    }
    const permissionAlias = (key) => {
      if (!key) return key;
      if (key === 'risk_view') return 'risk_management_section';
      if (key === 'risk_management_section') return 'risk_view';
      return null;
    };

    // Evaluate all permission-gated items (allow role permissions to add visibility too)
    const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
    console.log(`ðŸŽ¯ Found ${itemsRequiringPermissions.length} items requiring permissions to check`);

    let hiddenCount = 0;
    let shownByPermission = 0;

    itemsRequiringPermissions.forEach(item => {
      const requiresPermission = item.getAttribute('data-requires-permission');
      const feature = item.getAttribute('data-feature');

      const perm = permissions[requiresPermission];
      const aliasKey = permissionAlias(requiresPermission);
      const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;

      const hasViewPermission = (p) => p === true || (p && p.view === true);
      const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);

      if (allowed) {
        if (!item.classList.contains('menu-visible')) shownByPermission++;
        item.classList.add('menu-visible');
        console.log(`âœ… Showing by permission: ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
      } else {
        if (item.classList.contains('menu-visible')) hiddenCount++;
        item.classList.remove('menu-visible');
        console.log(`âŒ Hiding (no permission): ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
      }
    });

    // Re-check dropdown menus after permission filtering
    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
    dropdownMenus.forEach(dropdown => {
      const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
      const dropdownFeature = dropdown.getAttribute('data-feature');
      const dropdownRequires = dropdown.getAttribute('data-requires-permission');

      if (submenuItems.length === 0) {
        if (dropdownRequires) {
          const perm = permissions[dropdownRequires];
          const aliasKey = permissionAlias(dropdownRequires);
          const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
          const hasViewPermission = (p) => p === true || (p && p.view === true);
          const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
          if (allowed) {
            dropdown.classList.add('menu-visible');
            console.log(`âœ… Showing dropdown by permission: ${dropdownFeature}`);
          } else {
            dropdown.classList.remove('menu-visible');
            hiddenCount++;
            console.log(`âŒ Hiding dropdown (no children and no permission): ${dropdownFeature}`);
          }
        } else {
          dropdown.classList.remove('menu-visible');
          console.log(`âŒ Hiding dropdown (no visible children): ${dropdownFeature}`);
        }
      } else {
        // If any submenu items are visible, the dropdown must be visible even if the
        // dropdown itself doesn't have a dedicated permission flag.
        dropdown.classList.add('menu-visible');
        console.log(`âœ… Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
      }
    });

    console.log(`ðŸŽ¯ Role-based filtering completed - ${hiddenCount} items hidden; ${shownByPermission} items shown by permission`);
    
    // Ensure at least home is visible
    ensureHomeIsVisible();
    
    // Show sidebar after all filtering is complete
    showSidebarAfterAuth();
  }

  // Hide menu items that require permissions (for users without role permissions)
  function hideItemsRequiringPermissions() {
    console.log('ðŸ”’ Hiding all menu items that require permissions...');
    
    const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
    let hiddenCount = 0;
    
    itemsRequiringPermissions.forEach(item => {
      const feature = item.getAttribute('data-feature');
      const requiresPermission = item.getAttribute('data-requires-permission');
        
      item.classList.remove('menu-visible');
      hiddenCount++;
      console.log(`âŒ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
    });
    
    // Hide dropdowns that only contain permission-required items
    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
    dropdownMenus.forEach(dropdown => {
      const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
      if (visibleSubmenuItems.length === 0) {
        dropdown.classList.remove('menu-visible');
        const dropdownFeature = dropdown.getAttribute('data-feature');
        console.log(`âŒ Hiding dropdown (no visible children): ${dropdownFeature}`);
      }
    });
    
    console.log(`ðŸ”’ Hidden ${hiddenCount} items requiring permissions`);
    
    // Ensure at least home is visible
    ensureHomeIsVisible();
  }

  // Ensure home menu item is visible as fallback
  function ensureHomeIsVisible() {
    const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
    if (homeItem && !homeItem.classList.contains('menu-visible')) {
      homeItem.classList.add('menu-visible');
      console.log('âœ… Ensured home menu item is visible as fallback');
    }
  }

  // Show sidebar and remove loading state after authentication and filtering
  function showSidebarAfterAuth() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.classList.remove('menu-loading');
      console.log('âœ… Sidebar loading state removed - menu authorization complete');
    }
  }

  // Initialize menu authorization system
  function initializeMenuAuthorization() {
    console.log('ðŸš€ Initializing menu authorization system...');
    
    // Set sidebar to loading state initially
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.classList.add('menu-loading');
    }
    
    // Wait a moment for Firebase to initialize, then start authorization
    setTimeout(() => {
      updateMenuWithFeatureAuthorization();
    }, 500);
  }

  // Make updateMenuWithFeatureAuthorization available globally
  window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

  // Debug functions for menu visibility
  window.debugMenuState = function() {
    console.log('ðŸ”§ Debug Menu State:');
    const menuItems = document.querySelectorAll('[data-feature]');
    console.log(`Total menu items: ${menuItems.length}`);
    
    menuItems.forEach(item => {
      const feature = item.getAttribute('data-feature');
      const requiresPermission = item.getAttribute('data-requires-permission');
      const isVisible = item.classList.contains('menu-visible');
      console.log(`- ${feature}: requires=${requiresPermission}, visible=${isVisible}`);
    });
  };

  // ===== END ROLE-BASED MENU AUTHORIZATION SYSTEM =====
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize AuthManager (same pattern as project-list.html)
      window.authManager = new AuthManager();

      // Sidebar toggle
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('mainContent');
      document.getElementById('sidebarToggle').addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        main.classList.toggle('sidebar-collapsed');
      });

      // Header company logo + name (same call as project-list.html)
      loadCompanyBranding();

      // Initialize role-based menu authorization (matches project-list.html)
      initializeMenuAuthorization();

      const STORAGE_KEY = 'financeDocs';
      let editingId = null;

      const els = {
        modalOverlay: document.getElementById('modalOverlay'),
        modalTitle: document.getElementById('modalTitle').querySelector('span'),
        modalClose: document.getElementById('modalClose'),
        docType: document.getElementById('docType'),
        docNumber: document.getElementById('docNumber'),
        customerName: document.getElementById('customerName'),
        customerEmail: document.getElementById('customerEmail'),
        issueDate: document.getElementById('issueDate'),
        dueDate: document.getElementById('dueDate'),
        dueDateField: document.getElementById('dueDateField'),
        notes: document.getElementById('notes'),
        itemsBody: document.getElementById('itemsBody'),
        subtotal: document.getElementById('subtotal'),
        taxTotal: document.getElementById('taxTotal'),
        grandTotal: document.getElementById('grandTotal'),
        docsBody: document.getElementById('docsBody'),
        emptyState: document.getElementById('emptyState'),
        docsTable: document.getElementById('docsTable'),
        btnSave: document.getElementById('btnSave'),
        btnCancel: document.getElementById('btnCancel'),
        btnDelete: document.getElementById('btnDelete'),
        btnConvert: document.getElementById('btnConvert'),
        btnAddItem: document.getElementById('btnAddItem'),
        btnAddNew: document.getElementById('btnAddNew'),
        customerSelect: document.getElementById('customerSelect'),
        customerPhone: document.getElementById('customerPhone'),
        customerCompanyField: document.getElementById('customerCompanyField'),
        customerAddressBlock: document.getElementById('customerAddressBlock'),
        customerAddressText: document.getElementById('customerAddressText'),
      };

      // ===== TABS SYSTEM =====
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      let currentTab = 'documents';

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          currentTab = tab;
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(tab + 'Tab').classList.add('active');
          updateAddButton();
        });
      });

      function updateAddButton() {
        const btn = els.btnAddNew;
        if (currentTab === 'documents') {
          btn.title = 'New Estimate';
          btn.onclick = () => openModal(null);
        } else if (currentTab === 'customers') {
          btn.title = 'New Customer';
          btn.onclick = () => openCustomerModal(null);
        } else {
          btn.title = 'New Service/Product';
          btn.onclick = () => openServiceModal(null);
        }
      }
      updateAddButton();

      // ===== CUSTOMERS SYSTEM =====
      const CUSTOMERS_KEY = 'financeCustomers';
      let editingCustomerId = null;

      const customerEls = {
        modalOverlay: document.getElementById('customerModalOverlay'),
        modalTitle: document.getElementById('customerModalTitle').querySelector('span'),
        modalClose: document.getElementById('customerModalClose'),
        type: document.getElementById('customerTypeField'),
        title: document.getElementById('customerTitle'),
        firstName: document.getElementById('customerFirstName'),
        lastName: document.getElementById('customerLastName'),
        company: document.getElementById('customerCompany'),
        displayName: document.getElementById('customerDisplayName'),
        email: document.getElementById('customerEmailField'),
        phone: document.getElementById('customerPhone'),
        mobile: document.getElementById('customerMobile'),
        fax: document.getElementById('customerFax'),
        website: document.getElementById('customerWebsite'),
        billingStreet: document.getElementById('customerBillingStreet'),
        billingCity: document.getElementById('customerBillingCity'),
        billingState: document.getElementById('customerBillingState'),
        billingZip: document.getElementById('customerBillingZip'),
        billingCountry: document.getElementById('customerBillingCountry'),
        sameAsBilling: document.getElementById('customerSameAsBilling'),
        shippingFields: document.getElementById('shippingAddressFields'),
        shippingStreet: document.getElementById('customerShippingStreet'),
        shippingCity: document.getElementById('customerShippingCity'),
        shippingState: document.getElementById('customerShippingState'),
        shippingZip: document.getElementById('customerShippingZip'),
        shippingCountry: document.getElementById('customerShippingCountry'),
        paymentTerms: document.getElementById('customerPaymentTerms'),
        openingBalance: document.getElementById('customerOpeningBalance'),
        openingBalanceDate: document.getElementById('customerOpeningBalanceDate'),
        taxId: document.getElementById('customerTaxId'),
        taxExempt: document.getElementById('customerTaxExempt'),
        currency: document.getElementById('customerCurrency'),
        status: document.getElementById('customerStatus'),
        preferredDelivery: document.getElementById('customerPreferredDelivery'),
        notes: document.getElementById('customerNotes'),
        btnSave: document.getElementById('btnSaveCustomer'),
        btnCancel: document.getElementById('btnCancelCustomer'),
        btnDelete: document.getElementById('btnDeleteCustomer'),
        body: document.getElementById('customersBody'),
        table: document.getElementById('customersTable'),
        emptyState: document.getElementById('customersEmptyState'),
      };

      function loadCustomers() {
        return safeJsonParse(localStorage.getItem(CUSTOMERS_KEY) || '[]', []);
      }

      function saveCustomers(customers) {
        localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(customers));
      }

      function customerUuid() {
        return 'cust_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
      }

      function customerTypePill(type) {
        const labels = { individual: 'Individual', business: 'Business' };
        const cls = type === 'business' ? 'product' : 'service';
        return `<span class="pill ${cls}">${labels[type] || 'Individual'}</span>`;
      }

      function toggleShippingFields() {
        const same = customerEls.sameAsBilling.checked;
        customerEls.shippingFields.style.display = same ? 'none' : '';
      }

      function renderCustomersList() {
        const customers = loadCustomers();
        const filtered = customers;

        if (filtered.length === 0) {
          customerEls.table.style.display = 'none';
          customerEls.emptyState.style.display = '';
        } else {
          customerEls.table.style.display = '';
          customerEls.emptyState.style.display = 'none';
        }

        customerEls.body.innerHTML = filtered
          .sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''))
          .map(c => `
            <tr data-customer-id="${c.id}">
              <td style="font-weight:600;">${c.displayName || 'â€”'}</td>
              <td>${c.company || 'â€”'}</td>
              <td>${c.email || 'â€”'}</td>
              <td>${c.phone || c.mobile || 'â€”'}</td>
              <td>${customerTypePill(c.type)}</td>
              <td style="text-align:right;">${fmtMoney(c.openingBalance || 0)}</td>
              <td>${statusPill(c.status)}</td>
              <td style="text-align:right;">
                <button class="btn secondary" style="padding:0.3rem 0.5rem;" data-action="edit"><i class="fas fa-edit"></i></button>
              </td>
            </tr>
          `).join('');

        customerEls.body.querySelectorAll('tr[data-customer-id]').forEach(row => {
          row.querySelector('[data-action="edit"]').addEventListener('click', (e) => {
            e.stopPropagation();
            const customer = loadCustomers().find(x => x.id === row.dataset.customerId);
            if (customer) openCustomerModal(customer);
          });
        });
      }

      function clearCustomerForm() {
        editingCustomerId = null;
        customerEls.type.value = 'individual';
        customerEls.title.value = '';
        customerEls.firstName.value = '';
        customerEls.lastName.value = '';
        customerEls.company.value = '';
        customerEls.displayName.value = '';
        customerEls.email.value = '';
        customerEls.phone.value = '';
        customerEls.mobile.value = '';
        customerEls.fax.value = '';
        customerEls.website.value = '';
        customerEls.billingStreet.value = '';
        customerEls.billingCity.value = '';
        customerEls.billingState.value = '';
        customerEls.billingZip.value = '';
        customerEls.billingCountry.value = '';
        customerEls.sameAsBilling.checked = false;
        customerEls.shippingStreet.value = '';
        customerEls.shippingCity.value = '';
        customerEls.shippingState.value = '';
        customerEls.shippingZip.value = '';
        customerEls.shippingCountry.value = '';
        customerEls.paymentTerms.value = '';
        customerEls.openingBalance.value = '';
        customerEls.openingBalanceDate.value = '';
        customerEls.taxId.value = '';
        customerEls.taxExempt.value = 'no';
        customerEls.currency.value = 'USD';
        customerEls.status.value = 'active';
        customerEls.preferredDelivery.value = 'email';
        customerEls.notes.value = '';
        customerEls.btnDelete.style.display = 'none';
        customerEls.modalTitle.textContent = 'New Customer';
        toggleShippingFields();
      }

      function loadCustomerIntoForm(customer) {
        editingCustomerId = customer.id;
        customerEls.type.value = customer.type || 'individual';
        customerEls.title.value = customer.title || '';
        customerEls.firstName.value = customer.firstName || '';
        customerEls.lastName.value = customer.lastName || '';
        customerEls.company.value = customer.company || '';
        customerEls.displayName.value = customer.displayName || '';
        customerEls.email.value = customer.email || '';
        customerEls.phone.value = customer.phone || '';
        customerEls.mobile.value = customer.mobile || '';
        customerEls.fax.value = customer.fax || '';
        customerEls.website.value = customer.website || '';
        customerEls.billingStreet.value = customer.billingAddress?.street || '';
        customerEls.billingCity.value = customer.billingAddress?.city || '';
        customerEls.billingState.value = customer.billingAddress?.state || '';
        customerEls.billingZip.value = customer.billingAddress?.zip || '';
        customerEls.billingCountry.value = customer.billingAddress?.country || '';
        customerEls.sameAsBilling.checked = customer.sameAsBilling || false;
        customerEls.shippingStreet.value = customer.shippingAddress?.street || '';
        customerEls.shippingCity.value = customer.shippingAddress?.city || '';
        customerEls.shippingState.value = customer.shippingAddress?.state || '';
        customerEls.shippingZip.value = customer.shippingAddress?.zip || '';
        customerEls.shippingCountry.value = customer.shippingAddress?.country || '';
        customerEls.paymentTerms.value = customer.paymentTerms || '';
        customerEls.openingBalance.value = customer.openingBalance || '';
        customerEls.openingBalanceDate.value = customer.openingBalanceDate || '';
        customerEls.taxId.value = customer.taxId || '';
        customerEls.taxExempt.value = customer.taxExempt || 'no';
        customerEls.currency.value = customer.currency || 'USD';
        customerEls.status.value = customer.status || 'active';
        customerEls.preferredDelivery.value = customer.preferredDelivery || 'email';
        customerEls.notes.value = customer.notes || '';
        customerEls.btnDelete.style.display = '';
        customerEls.modalTitle.textContent = 'Edit Customer';
        toggleShippingFields();
      }

      function buildCustomerFromForm() {
        return {
          id: editingCustomerId || customerUuid(),
          type: customerEls.type.value,
          title: customerEls.title.value,
          firstName: customerEls.firstName.value.trim(),
          lastName: customerEls.lastName.value.trim(),
          company: customerEls.company.value.trim(),
          displayName: customerEls.displayName.value.trim(),
          email: customerEls.email.value.trim(),
          phone: customerEls.phone.value.trim(),
          mobile: customerEls.mobile.value.trim(),
          fax: customerEls.fax.value.trim(),
          website: customerEls.website.value.trim(),
          billingAddress: {
            street: customerEls.billingStreet.value.trim(),
            city: customerEls.billingCity.value.trim(),
            state: customerEls.billingState.value.trim(),
            zip: customerEls.billingZip.value.trim(),
            country: customerEls.billingCountry.value.trim(),
          },
          sameAsBilling: customerEls.sameAsBilling.checked,
          shippingAddress: customerEls.sameAsBilling.checked ? {
            street: customerEls.billingStreet.value.trim(),
            city: customerEls.billingCity.value.trim(),
            state: customerEls.billingState.value.trim(),
            zip: customerEls.billingZip.value.trim(),
            country: customerEls.billingCountry.value.trim(),
          } : {
            street: customerEls.shippingStreet.value.trim(),
            city: customerEls.shippingCity.value.trim(),
            state: customerEls.shippingState.value.trim(),
            zip: customerEls.shippingZip.value.trim(),
            country: customerEls.shippingCountry.value.trim(),
          },
          paymentTerms: customerEls.paymentTerms.value,
          openingBalance: parseFloat(customerEls.openingBalance.value) || 0,
          openingBalanceDate: customerEls.openingBalanceDate.value,
          taxId: customerEls.taxId.value.trim(),
          taxExempt: customerEls.taxExempt.value,
          currency: customerEls.currency.value,
          status: customerEls.status.value,
          preferredDelivery: customerEls.preferredDelivery.value,
          notes: customerEls.notes.value.trim(),
          updatedAt: Date.now(),
        };
      }

      function upsertCustomer(customer) {
        const customers = loadCustomers();
        const idx = customers.findIndex(c => c.id === customer.id);
        if (idx >= 0) {
          customers[idx] = { ...customers[idx], ...customer };
        } else {
          customers.push({ ...customer, createdAt: Date.now() });
        }
        saveCustomers(customers);
      }

      function deleteCustomer(id) {
        saveCustomers(loadCustomers().filter(c => c.id !== id));
      }

      function openCustomerModal(customer) {
        if (customer) {
          loadCustomerIntoForm(customer);
        } else {
          clearCustomerForm();
        }
        customerEls.modalOverlay.classList.add('show');
      }

      function closeCustomerModal() {
        customerEls.modalOverlay.classList.remove('show');
      }

      // Auto-fill display name
      customerEls.firstName.addEventListener('input', updateDisplayNameSuggestion);
      customerEls.lastName.addEventListener('input', updateDisplayNameSuggestion);
      customerEls.company.addEventListener('input', updateDisplayNameSuggestion);

      function updateDisplayNameSuggestion() {
        if (customerEls.displayName.value) return; // Don't overwrite if already filled
        const first = customerEls.firstName.value.trim();
        const last = customerEls.lastName.value.trim();
        const company = customerEls.company.value.trim();
        if (company) {
          customerEls.displayName.value = company;
        } else if (first || last) {
          customerEls.displayName.value = [first, last].filter(Boolean).join(' ');
        }
      }

      // Customer modal events
      customerEls.modalClose.addEventListener('click', closeCustomerModal);
      customerEls.btnCancel.addEventListener('click', closeCustomerModal);
      customerEls.modalOverlay.addEventListener('click', (e) => {
        if (e.target === customerEls.modalOverlay) closeCustomerModal();
      });

      customerEls.sameAsBilling.addEventListener('change', toggleShippingFields);

      customerEls.btnSave.addEventListener('click', () => {
        if (!customerEls.firstName.value.trim()) {
          alert('Please enter a first name.');
          customerEls.firstName.focus();
          return;
        }
        if (!customerEls.displayName.value.trim()) {
          alert('Please enter a display name.');
          customerEls.displayName.focus();
          return;
        }
        const customer = buildCustomerFromForm();
        upsertCustomer(customer);
        closeCustomerModal();
        renderCustomersList();
      });

      customerEls.btnDelete.addEventListener('click', () => {
        if (!editingCustomerId) return;
        if (confirm('Are you sure you want to delete this customer?')) {
          deleteCustomer(editingCustomerId);
          closeCustomerModal();
          renderCustomersList();
        }
      });

      // Initial render
      renderCustomersList();

      // ===== SERVICES SYSTEM =====
      const SERVICES_KEY = 'financeServices';
      let editingServiceId = null;

      const serviceEls = {
        modalOverlay: document.getElementById('serviceModalOverlay'),
        modalTitle: document.getElementById('serviceModalTitle').querySelector('span'),
        modalClose: document.getElementById('serviceModalClose'),
        type: document.getElementById('serviceType'),
        name: document.getElementById('serviceName'),
        sku: document.getElementById('serviceSku'),
        category: document.getElementById('serviceCategory'),
        description: document.getElementById('serviceDescription'),
        salesPrice: document.getElementById('serviceSalesPrice'),
        cost: document.getElementById('serviceCost'),
        unit: document.getElementById('serviceUnit'),
        taxRate: document.getElementById('serviceTaxRate'),
        taxCode: document.getElementById('serviceTaxCode'),
        taxable: document.getElementById('serviceTaxable'),
        qtyOnHand: document.getElementById('serviceQtyOnHand'),
        reorderPoint: document.getElementById('serviceReorderPoint'),
        asOfDate: document.getElementById('serviceAsOfDate'),
        trackQty: document.getElementById('serviceTrackQty'),
        incomeAccount: document.getElementById('serviceIncomeAccount'),
        expenseAccount: document.getElementById('serviceExpenseAccount'),
        vendor: document.getElementById('serviceVendor'),
        status: document.getElementById('serviceStatus'),
        notes: document.getElementById('serviceNotes'),
        inventorySection: document.getElementById('inventorySection'),
        btnSave: document.getElementById('btnSaveService'),
        btnCancel: document.getElementById('btnCancelService'),
        btnDelete: document.getElementById('btnDeleteService'),
        body: document.getElementById('servicesBody'),
        table: document.getElementById('servicesTable'),
        emptyState: document.getElementById('servicesEmptyState'),
      };

      function loadServices() {
        return safeJsonParse(localStorage.getItem(SERVICES_KEY) || '[]', []);
      }

      function saveServices(services) {
        localStorage.setItem(SERVICES_KEY, JSON.stringify(services));
      }

      function serviceUuid() {
        return 'srv_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
      }

      function servicePill(type) {
        const labels = { service: 'Service', product: 'Product', bundle: 'Bundle' };
        return `<span class="pill ${type}">${labels[type] || 'Service'}</span>`;
      }

      function statusPill(status) {
        return `<span class="pill ${status}">${status === 'active' ? 'Active' : 'Inactive'}</span>`;
      }

      function toggleInventorySection() {
        const isProduct = serviceEls.type.value === 'product';
        serviceEls.inventorySection.style.display = isProduct ? '' : 'none';
      }

      function renderServicesList() {
        const services = loadServices();
        const filtered = services;

        if (filtered.length === 0) {
          serviceEls.table.style.display = 'none';
          serviceEls.emptyState.style.display = '';
        } else {
          serviceEls.table.style.display = '';
          serviceEls.emptyState.style.display = 'none';
        }

        serviceEls.body.innerHTML = filtered
          .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
          .map(s => `
            <tr data-service-id="${s.id}">
              <td style="font-weight:600;">${s.name || 'â€”'}</td>
              <td>${s.sku || 'â€”'}</td>
              <td>${servicePill(s.type)}</td>
              <td>${s.category || 'â€”'}</td>
              <td style="text-align:right;">${fmtMoney(s.salesPrice)}</td>
              <td style="text-align:right;">${fmtMoney(s.cost)}</td>
              <td>${statusPill(s.status)}</td>
              <td style="text-align:right;">
                <button class="btn secondary" style="padding:0.3rem 0.5rem;" data-action="edit"><i class="fas fa-edit"></i></button>
              </td>
            </tr>
          `).join('');

        serviceEls.body.querySelectorAll('tr[data-service-id]').forEach(row => {
          row.querySelector('[data-action="edit"]').addEventListener('click', (e) => {
            e.stopPropagation();
            const service = loadServices().find(x => x.id === row.dataset.serviceId);
            if (service) openServiceModal(service);
          });
        });
      }

      function clearServiceForm() {
        editingServiceId = null;
        serviceEls.type.value = 'service';
        serviceEls.name.value = '';
        serviceEls.sku.value = '';
        serviceEls.category.value = '';
        serviceEls.description.value = '';
        serviceEls.salesPrice.value = '';
        serviceEls.cost.value = '';
        serviceEls.unit.value = 'each';
        serviceEls.taxRate.value = '';
        serviceEls.taxCode.value = '';
        serviceEls.taxable.checked = true;
        serviceEls.qtyOnHand.value = '';
        serviceEls.reorderPoint.value = '';
        serviceEls.asOfDate.value = '';
        serviceEls.trackQty.checked = false;
        serviceEls.incomeAccount.value = '';
        serviceEls.expenseAccount.value = '';
        serviceEls.vendor.value = '';
        serviceEls.status.value = 'active';
        serviceEls.notes.value = '';
        serviceEls.btnDelete.style.display = 'none';
        serviceEls.modalTitle.textContent = 'New Service/Product';
        toggleInventorySection();
      }

      function loadServiceIntoForm(service) {
        editingServiceId = service.id;
        serviceEls.type.value = service.type || 'service';
        serviceEls.name.value = service.name || '';
        serviceEls.sku.value = service.sku || '';
        serviceEls.category.value = service.category || '';
        serviceEls.description.value = service.description || '';
        serviceEls.salesPrice.value = service.salesPrice || '';
        serviceEls.cost.value = service.cost || '';
        serviceEls.unit.value = service.unit || 'each';
        serviceEls.taxRate.value = service.taxRate || '';
        serviceEls.taxCode.value = service.taxCode || '';
        serviceEls.taxable.checked = service.taxable !== false;
        serviceEls.qtyOnHand.value = service.qtyOnHand || '';
        serviceEls.reorderPoint.value = service.reorderPoint || '';
        serviceEls.asOfDate.value = service.asOfDate || '';
        serviceEls.trackQty.checked = service.trackQty || false;
        serviceEls.incomeAccount.value = service.incomeAccount || '';
        serviceEls.expenseAccount.value = service.expenseAccount || '';
        serviceEls.vendor.value = service.vendor || '';
        serviceEls.status.value = service.status || 'active';
        serviceEls.notes.value = service.notes || '';
        serviceEls.btnDelete.style.display = '';
        serviceEls.modalTitle.textContent = 'Edit Service/Product';
        toggleInventorySection();
      }

      function buildServiceFromForm() {
        return {
          id: editingServiceId || serviceUuid(),
          type: serviceEls.type.value,
          name: serviceEls.name.value.trim(),
          sku: serviceEls.sku.value.trim(),
          category: serviceEls.category.value,
          description: serviceEls.description.value.trim(),
          salesPrice: parseFloat(serviceEls.salesPrice.value) || 0,
          cost: parseFloat(serviceEls.cost.value) || 0,
          unit: serviceEls.unit.value,
          taxRate: parseFloat(serviceEls.taxRate.value) || 0,
          taxCode: serviceEls.taxCode.value,
          taxable: serviceEls.taxable.checked,
          qtyOnHand: parseInt(serviceEls.qtyOnHand.value) || 0,
          reorderPoint: parseInt(serviceEls.reorderPoint.value) || 0,
          asOfDate: serviceEls.asOfDate.value,
          trackQty: serviceEls.trackQty.checked,
          incomeAccount: serviceEls.incomeAccount.value,
          expenseAccount: serviceEls.expenseAccount.value,
          vendor: serviceEls.vendor.value.trim(),
          status: serviceEls.status.value,
          notes: serviceEls.notes.value.trim(),
          updatedAt: Date.now(),
        };
      }

      function upsertService(service) {
        const services = loadServices();
        const idx = services.findIndex(s => s.id === service.id);
        if (idx >= 0) {
          services[idx] = { ...services[idx], ...service };
        } else {
          services.push({ ...service, createdAt: Date.now() });
        }
        saveServices(services);
      }

      function deleteService(id) {
        saveServices(loadServices().filter(s => s.id !== id));
      }

      function openServiceModal(service) {
        if (service) {
          loadServiceIntoForm(service);
        } else {
          clearServiceForm();
        }
        serviceEls.modalOverlay.classList.add('show');
      }

      function closeServiceModal() {
        serviceEls.modalOverlay.classList.remove('show');
      }

      // Service modal events
      serviceEls.modalClose.addEventListener('click', closeServiceModal);
      serviceEls.btnCancel.addEventListener('click', closeServiceModal);
      serviceEls.modalOverlay.addEventListener('click', (e) => {
        if (e.target === serviceEls.modalOverlay) closeServiceModal();
      });

      serviceEls.type.addEventListener('change', toggleInventorySection);

      serviceEls.btnSave.addEventListener('click', () => {
        if (!serviceEls.name.value.trim()) {
          alert('Please enter a service/product name.');
          serviceEls.name.focus();
          return;
        }
        if (!serviceEls.salesPrice.value) {
          alert('Please enter a sales price.');
          serviceEls.salesPrice.focus();
          return;
        }
        const service = buildServiceFromForm();
        upsertService(service);
        closeServiceModal();
        renderServicesList();
      });

      serviceEls.btnDelete.addEventListener('click', () => {
        if (!editingServiceId) return;
        if (confirm('Are you sure you want to delete this service/product?')) {
          deleteService(editingServiceId);
          closeServiceModal();
          renderServicesList();
        }
      });

      // Initial render
      renderServicesList();

      function safeJsonParse(text, fallback) {
        try { return JSON.parse(text); } catch (_) { return fallback; }
      }

      function loadDocs() {
        return safeJsonParse(localStorage.getItem(STORAGE_KEY) || '[]', []);
      }

      function saveDocs(docs) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
      }

      function uuid() {
        return 'doc_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
      }

      function generateRefNumber(type) {
        const prefixes = { estimate: 'EST', invoice: 'INV', receipt: 'REC' };
        const prefix = prefixes[type] || 'DOC';
        const docs = loadDocs().filter(d => d.type === type);
        const nextNum = docs.length + 1;
        const padded = String(nextNum).padStart(4, '0');
        return `${prefix}-${padded}`;
      }

      function fmtMoney(n) {
        return Number(n || 0).toFixed(2);
      }

      function computeTotals() {
        const rows = Array.from(els.itemsBody.querySelectorAll('tr'));
        let sub = 0, tax = 0;
        rows.forEach(r => {
          const qty = Number(r.querySelector('[data-field="qty"]').value || 0);
          const unit = Number(r.querySelector('[data-field="unit"]').value || 0);
          const taxPct = Number(r.querySelector('[data-field="tax"]').value || 0);
          const amount = qty * unit;
          const t = amount * (taxPct / 100);
          sub += amount;
          tax += t;
          r.querySelector('[data-field="amount"]').value = fmtMoney(amount);
        });
        els.subtotal.textContent = fmtMoney(sub);
        els.taxTotal.textContent = fmtMoney(tax);
        els.grandTotal.textContent = fmtMoney(sub + tax);
      }

      function updateModalTitle() {
        const type = els.docType.value;
        const labels = { estimate: 'Estimate', invoice: 'Invoice', receipt: 'Receipt' };
        const action = editingId ? 'Edit' : 'New';
        els.modalTitle.textContent = `${action} ${labels[type] || 'Document'}`;
        els.dueDateField.style.display = type === 'invoice' ? '' : 'none';
        els.btnConvert.style.display = (type === 'estimate' && editingId) ? '' : 'none';
        // Auto-generate new ref number when type changes for new documents
        if (!editingId) {
          els.docNumber.value = generateRefNumber(type);
        }
      }

      // Populate customer dropdown
      function populateCustomerDropdown(selectedId = '') {
        const customers = loadCustomers().filter(c => c.status === 'active');
        let html = '<option value="">-- Select Existing Customer --</option>';
        html += '<option value="__new__">+ Add New Customer</option>';
        customers.forEach(c => {
          const selected = c.id === selectedId ? 'selected' : '';
          html += `<option value="${c.id}" ${selected} data-name="${(c.displayName || '').replace(/"/g, '&quot;')}" data-email="${(c.email || '').replace(/"/g, '&quot;')}">${c.displayName}${c.company ? ' (' + c.company + ')' : ''}</option>`;
        });
        els.customerSelect.innerHTML = html;
      }

      // Customer select handler
      els.customerSelect.addEventListener('change', () => {
        const val = els.customerSelect.value;
        if (val === '__new__') {
          // Open customer modal, then come back
          closeModal();
          openCustomerModal(null);
        } else if (val) {
          // Find the full customer data from localStorage
          const customer = loadCustomers().find(c => c.id === val);
          if (customer) {
            els.customerName.value = customer.displayName || '';
            els.customerEmail.value = customer.email || '';
            els.customerPhone.value = customer.phone || customer.mobile || '';
            els.customerCompanyField.value = customer.company || '';
            
            // Build address text
            const addr = customer.billingAddress || {};
            const addrParts = [
              addr.street,
              [addr.city, addr.state, addr.zip].filter(Boolean).join(', '),
              addr.country
            ].filter(Boolean);
            
            if (addrParts.length > 0) {
              els.customerAddressText.innerHTML = addrParts.join('<br>');
              els.customerAddressBlock.style.display = '';
            } else {
              els.customerAddressBlock.style.display = 'none';
            }
          }
        } else {
          els.customerName.value = '';
          els.customerEmail.value = '';
          els.customerPhone.value = '';
          els.customerCompanyField.value = '';
          els.customerAddressBlock.style.display = 'none';
        }
      });

      function getServiceOptionsHtml(selectedId = '') {
        const services = loadServices().filter(s => s.status === 'active');
        let html = '<option value="">-- Select Service/Product --</option>';
        html += '<option value="__custom__">+ Custom Item</option>';
        services.forEach(s => {
          const selected = s.id === selectedId ? 'selected' : '';
          const label = s.sku ? `${s.name} (${s.sku})` : s.name;
          html += `<option value="${s.id}" ${selected} data-price="${s.salesPrice || 0}" data-tax="${s.taxRate || 0}" data-desc="${(s.description || '').replace(/"/g, '&quot;')}">${label}</option>`;
        });
        return html;
      }

      function addItemRow(item) {
        const tr = document.createElement('tr');
        const isCustom = item?.item && !item?.serviceId;
        const serviceId = item?.serviceId || (isCustom ? '__custom__' : '');
        
        tr.innerHTML = `
          <td>
            <select data-field="service" style="width:100%; margin-bottom:4px;">
              ${getServiceOptionsHtml(serviceId)}
            </select>
            <input data-field="item" placeholder="Item name" value="${(item?.item || '').replace(/"/g,'&quot;')}" style="${serviceId && serviceId !== '__custom__' ? 'display:none;' : ''}" />
          </td>
          <td><input data-field="desc" placeholder="Description" value="${(item?.desc || '').replace(/"/g,'&quot;')}" /></td>
          <td><input data-field="qty" type="number" step="1" min="0" value="${item?.qty ?? 1}" /></td>
          <td><input data-field="unit" type="number" step="0.01" min="0" value="${item?.unit ?? 0}" /></td>
          <td><input data-field="tax" type="number" step="0.01" min="0" value="${item?.tax ?? 0}" /></td>
          <td><input data-field="amount" disabled value="0.00" /></td>
          <td class="items-actions"><button class="btn secondary" type="button" data-action="remove" title="Remove"><i class="fas fa-times"></i></button></td>
        `;

        const serviceSelect = tr.querySelector('[data-field="service"]');
        const itemInput = tr.querySelector('[data-field="item"]');
        const descInput = tr.querySelector('[data-field="desc"]');
        const unitInput = tr.querySelector('[data-field="unit"]');
        const taxInput = tr.querySelector('[data-field="tax"]');

        serviceSelect.addEventListener('change', () => {
          const val = serviceSelect.value;
          if (val === '__custom__') {
            itemInput.style.display = '';
            itemInput.value = '';
            descInput.value = '';
            unitInput.value = '0';
            taxInput.value = '0';
            itemInput.focus();
          } else if (val) {
            const opt = serviceSelect.selectedOptions[0];
            itemInput.style.display = 'none';
            itemInput.value = opt.textContent;
            descInput.value = opt.dataset.desc || '';
            unitInput.value = opt.dataset.price || '0';
            taxInput.value = opt.dataset.tax || '0';
          } else {
            itemInput.style.display = 'none';
            itemInput.value = '';
            descInput.value = '';
            unitInput.value = '0';
            taxInput.value = '0';
          }
          computeTotals();
        });

        tr.addEventListener('input', () => computeTotals());
        tr.querySelector('[data-action="remove"]').addEventListener('click', () => {
          tr.remove();
          computeTotals();
        });
        els.itemsBody.appendChild(tr);
        computeTotals();
      }

      function clearForm() {
        editingId = null;
        els.docType.value = 'estimate';
        els.docNumber.value = generateRefNumber('estimate');
        populateCustomerDropdown('');
        els.customerSelect.value = '';
        els.customerName.value = '';
        els.customerEmail.value = '';
        els.customerPhone.value = '';
        els.customerCompanyField.value = '';
        els.customerAddressBlock.style.display = 'none';
        els.issueDate.valueAsDate = new Date();
        els.dueDate.value = '';
        els.notes.value = '';
        els.itemsBody.innerHTML = '';
        addItemRow({ qty: 1, unit: 0, tax: 0 });
        els.btnDelete.style.display = 'none';
        updateModalTitle();
      }

      function pill(type) {
        const label = (type || 'estimate').charAt(0).toUpperCase() + (type || 'estimate').slice(1);
        return `<span class="pill ${type || 'estimate'}">${label}</span>`;
      }

      // View Details Modal Elements
      const viewEls = {
        overlay: document.getElementById('viewDetailsOverlay'),
        closeBtn: document.getElementById('viewCloseBtn'),
        printBtn: document.getElementById('viewPrintBtn'),
        editBtn: document.getElementById('viewEditBtn'),
        docTitle: document.getElementById('viewDocTitle'),
        docNumber: document.getElementById('viewDocNumber'),
        customerInfo: document.getElementById('viewCustomerInfo'),
        itemsBody: document.getElementById('viewItemsBody'),
        subtotal: document.getElementById('viewSubtotal'),
        taxTotal: document.getElementById('viewTaxTotal'),
        grandTotal: document.getElementById('viewGrandTotal'),
        notesSection: document.getElementById('viewNotesSection'),
        notes: document.getElementById('viewNotes'),
      };
      let currentViewDocId = null;

      function openViewModal(doc) {
        currentViewDocId = doc.id;
        const typeLabels = { estimate: 'Estimate', invoice: 'Invoice', receipt: 'Receipt' };
        viewEls.docTitle.textContent = typeLabels[doc.type] || 'Document';
        viewEls.docNumber.textContent = doc.number || 'â€”';
        
        // Populate company logo and name (like investigation report modal)
        const headerLogo = document.getElementById('headerCompanyLogo');
        const headerCompanyName = document.getElementById('headerCompanyName');
        const modalLogo = document.getElementById('viewModalLogo');
        const logoFallback = document.getElementById('viewModalLogoFallback');
        const companyNameEl = document.getElementById('viewCompanyName');
        
        const companyName = (headerCompanyName && headerCompanyName.textContent) || 'Company';
        const logoSrc = (headerLogo && headerLogo.src && headerLogo.style.display !== 'none') ? headerLogo.src : '';
        
        // Set company logo
        if (logoSrc) {
          if (modalLogo) { modalLogo.src = logoSrc; modalLogo.style.display = 'block'; }
          if (logoFallback) logoFallback.style.display = 'none';
        } else {
          if (modalLogo) modalLogo.style.display = 'none';
          if (logoFallback) {
            logoFallback.style.display = 'flex';
            logoFallback.textContent = (companyName || 'CN').split(/\s+/).map(w => w[0]).slice(0, 3).join('').toUpperCase();
          }
        }
        
        // Set company name
        if (companyNameEl) companyNameEl.textContent = companyName;
        
        // Build billing address string
        const addr = doc.customer?.billingAddress || {};
        const addrParts = [
          addr.street,
          [addr.city, addr.state, addr.zip].filter(Boolean).join(', '),
          addr.country
        ].filter(Boolean);
        const addressStr = addrParts.length > 0 ? addrParts.join(', ') : 'â€”';
        
        // Customer info
        viewEls.customerInfo.innerHTML = `
          <div class="view-info-item"><span class="label">Customer Name</span><span class="value">${doc.customer?.name || 'â€”'}</span></div>
          <div class="view-info-item"><span class="label">Company</span><span class="value">${doc.customer?.company || 'â€”'}</span></div>
          <div class="view-info-item"><span class="label">Email</span><span class="value">${doc.customer?.email || 'â€”'}</span></div>
          <div class="view-info-item"><span class="label">Phone</span><span class="value">${doc.customer?.phone || 'â€”'}</span></div>
          <div class="view-info-item" style="grid-column: span 2;"><span class="label">Billing Address</span><span class="value">${addressStr}</span></div>
          <div class="view-info-item"><span class="label">Issue Date</span><span class="value">${doc.issueDate || 'â€”'}</span></div>
          ${doc.type === 'invoice' ? `<div class="view-info-item"><span class="label">Due Date</span><span class="value">${doc.dueDate || 'â€”'}</span></div>` : ''}
        `;
        
        // Line items
        viewEls.itemsBody.innerHTML = (doc.items || []).map(item => `
          <tr>
            <td>${item.item || 'â€”'}</td>
            <td>${item.desc || 'â€”'}</td>
            <td style="text-align:center;">${item.qty || 0}</td>
            <td style="text-align:right;">${fmtMoney(item.unit)}</td>
            <td style="text-align:right;">${item.tax || 0}%</td>
            <td style="text-align:right;">${fmtMoney((item.qty || 0) * (item.unit || 0))}</td>
          </tr>
        `).join('');
        
        // Totals
        viewEls.subtotal.textContent = fmtMoney(doc.totals?.subtotal);
        viewEls.taxTotal.textContent = fmtMoney(doc.totals?.taxTotal);
        viewEls.grandTotal.textContent = fmtMoney(doc.totals?.grandTotal);
        
        // Notes
        if (doc.notes) {
          viewEls.notesSection.style.display = '';
          viewEls.notes.textContent = doc.notes;
        } else {
          viewEls.notesSection.style.display = 'none';
        }
        
        viewEls.overlay.classList.add('show');
      }

      function closeViewModal() {
        viewEls.overlay.classList.remove('show');
        currentViewDocId = null;
      }

      // View modal event listeners
      viewEls.closeBtn.addEventListener('click', closeViewModal);
      viewEls.overlay.addEventListener('click', (e) => {
        if (e.target === viewEls.overlay) closeViewModal();
      });
      viewEls.printBtn.addEventListener('click', () => window.print());
      viewEls.editBtn.addEventListener('click', () => {
        const doc = loadDocs().find(d => d.id === currentViewDocId);
        if (doc) {
          closeViewModal();
          openModal(doc);
        }
      });

      function renderList() {
        const docs = loadDocs();
        const filtered = docs;

        if (filtered.length === 0) {
          els.docsTable.style.display = 'none';
          els.emptyState.style.display = '';
        } else {
          els.docsTable.style.display = '';
          els.emptyState.style.display = 'none';
        }

        els.docsBody.innerHTML = filtered
          .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0))
          .map(d => `
            <tr data-doc-id="${d.id}">
              <td>${pill(d.type)}</td>
              <td>${d.number || 'â€”'}</td>
              <td>${d.customer?.name || 'â€”'}</td>
              <td>${d.issueDate || 'â€”'}</td>
              <td style="text-align:right; font-weight:600;">${fmtMoney(d.totals?.grandTotal)}</td>
              <td style="text-align:right;"></td>
            </tr>
          `).join('');

        // Row click opens view modal
        els.docsBody.querySelectorAll('tr[data-doc-id]').forEach(row => {
          row.addEventListener('click', (e) => {
            const doc = loadDocs().find(x => x.id === row.dataset.docId);
            if (doc) openViewModal(doc);
          });
        });
      }

      function buildDocFromForm() {
        const items = Array.from(els.itemsBody.querySelectorAll('tr')).map(r => {
          const serviceSelect = r.querySelector('[data-field="service"]');
          const serviceId = serviceSelect ? serviceSelect.value : '';
          return {
            serviceId: (serviceId && serviceId !== '__custom__') ? serviceId : '',
            item: r.querySelector('[data-field="item"]').value.trim(),
            desc: r.querySelector('[data-field="desc"]').value.trim(),
            qty: Number(r.querySelector('[data-field="qty"]').value || 0),
            unit: Number(r.querySelector('[data-field="unit"]').value || 0),
            tax: Number(r.querySelector('[data-field="tax"]').value || 0),
          };
        });
        computeTotals();
        const type = els.docType.value;
        const customerId = els.customerSelect.value;
        
        // Get full customer data if selected from dropdown
        let customerData = {
          id: (customerId && customerId !== '__new__') ? customerId : '',
          name: els.customerName.value.trim(),
          email: els.customerEmail.value.trim(),
          phone: els.customerPhone.value.trim(),
          company: els.customerCompanyField.value.trim(),
        };
        
        // If customer selected, include their billing address
        if (customerId && customerId !== '__new__') {
          const fullCustomer = loadCustomers().find(c => c.id === customerId);
          if (fullCustomer && fullCustomer.billingAddress) {
            customerData.billingAddress = fullCustomer.billingAddress;
          }
        }
        
        return {
          id: editingId || uuid(),
          type,
          number: els.docNumber.value.trim(),
          issueDate: els.issueDate.value || '',
          dueDate: type === 'invoice' ? (els.dueDate.value || '') : '',
          customer: customerData,
          notes: els.notes.value.trim(),
          items,
          totals: {
            subtotal: parseFloat(els.subtotal.textContent) || 0,
            taxTotal: parseFloat(els.taxTotal.textContent) || 0,
            grandTotal: parseFloat(els.grandTotal.textContent) || 0,
          },
          updatedAt: Date.now(),
        };
      }

      function loadIntoForm(doc) {
        editingId = doc.id;
        els.docType.value = doc.type || 'estimate';
        els.docNumber.value = doc.number || '';
        populateCustomerDropdown(doc.customer?.id || '');
        els.customerSelect.value = doc.customer?.id || '';
        els.customerName.value = doc.customer?.name || '';
        els.customerEmail.value = doc.customer?.email || '';
        els.customerPhone.value = doc.customer?.phone || '';
        els.customerCompanyField.value = doc.customer?.company || '';
        
        // Show billing address if available
        const addr = doc.customer?.billingAddress || {};
        const addrParts = [
          addr.street,
          [addr.city, addr.state, addr.zip].filter(Boolean).join(', '),
          addr.country
        ].filter(Boolean);
        
        if (addrParts.length > 0) {
          els.customerAddressText.innerHTML = addrParts.join('<br>');
          els.customerAddressBlock.style.display = '';
        } else {
          els.customerAddressBlock.style.display = 'none';
        }
        
        els.issueDate.value = doc.issueDate || '';
        els.dueDate.value = doc.dueDate || '';
        els.notes.value = doc.notes || '';
        els.itemsBody.innerHTML = '';
        (doc.items?.length ? doc.items : [{ qty: 1, unit: 0, tax: 0 }]).forEach(addItemRow);
        els.btnDelete.style.display = '';
        updateModalTitle();
      }

      function upsertDoc(doc) {
        const docs = loadDocs();
        const idx = docs.findIndex(d => d.id === doc.id);
        if (idx >= 0) {
          docs[idx] = { ...docs[idx], ...doc };
        } else {
          docs.push({ ...doc, createdAt: Date.now() });
        }
        saveDocs(docs);
      }

      function deleteDoc(id) {
        saveDocs(loadDocs().filter(d => d.id !== id));
      }

      function openModal(doc) {
        if (doc) {
          loadIntoForm(doc);
        } else {
          clearForm();
        }
        els.modalOverlay.classList.add('show');
      }

      function closeModal() {
        els.modalOverlay.classList.remove('show');
      }

      function convertEstimateToInvoice() {
        const current = loadDocs().find(d => d.id === editingId);
        if (!current || current.type !== 'estimate') return;
        const invoice = {
          ...current,
          id: uuid(),
          type: 'invoice',
          number: generateRefNumber('invoice'),
          sourceEstimateId: current.id,
          createdAt: Date.now(),
          updatedAt: Date.now(),
        };
        upsertDoc(invoice);
        loadIntoForm(invoice);
        renderList();
      }

      // Event listeners
      els.modalClose.addEventListener('click', closeModal);
      els.btnCancel.addEventListener('click', closeModal);
      els.modalOverlay.addEventListener('click', (e) => {
        if (e.target === els.modalOverlay) closeModal();
      });

      els.btnAddItem.addEventListener('click', () => addItemRow({ qty: 1, unit: 0, tax: 0 }));

      els.btnSave.addEventListener('click', () => {
        const doc = buildDocFromForm();
        upsertDoc(doc);
        closeModal();
        renderList();
      });

      els.btnDelete.addEventListener('click', () => {
        if (!editingId) return;
        if (confirm('Are you sure you want to delete this document?')) {
          deleteDoc(editingId);
          closeModal();
          renderList();
        }
      });

      els.btnConvert.addEventListener('click', () => convertEstimateToInvoice());
      els.docType.addEventListener('change', updateModalTitle);

      // Keyboard shortcut to close modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (viewEls.overlay.classList.contains('show')) closeViewModal();
          else if (customerEls.modalOverlay.classList.contains('show')) closeCustomerModal();
          else if (serviceEls.modalOverlay.classList.contains('show')) closeServiceModal();
          else if (els.modalOverlay.classList.contains('show')) closeModal();
        }
      });

      // Init
      renderList();
    });
  </script>
</body>
</html>
