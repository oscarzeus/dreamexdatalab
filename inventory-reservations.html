<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Material Reservations - Dreamex Datalab</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Firebase v8 Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <style>
    :root { --primary-color:#2c3e50; --secondary-color:#34495e; --accent-color:#e74c3c; --success-color:#27ae60; --warning-color:#f39c12; --info-color:#3498db; --light-color:#ecf0f1; --dark-color:#2c3e50; --sidebar-width:250px; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; z-index:1000; transition:transform .3s ease; }
    .sidebar.collapsed { transform:translateX(-100%); }
    .main-content { flex:1; margin-left:var(--sidebar-width); padding:0.3rem; padding-top:3.2rem; transition:margin-left .3s ease; }
    .main-content.sidebar-collapsed { margin-left:0; }
    .main-content.sidebar-collapsed .top-nav { left:0.5rem; }
    .logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:1.05rem; }
    .menu { list-style:none; margin-top:2rem; }
    .menu li { margin-bottom:0.45rem; }
    .menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.6rem 0.75rem; border-radius:6px; font-size:0.82rem; font-weight:500; }
    .menu a:hover, .menu a.active { background:rgba(255,255,255,0.12); }
    .submenu { list-style:none; margin-left:0.75rem; display:none; margin-top:0.25rem; }
    .menu-dropdown:hover .submenu { display:block; }
    .submenu a { font-size:0.75rem; padding:0.45rem 0.65rem; }
    [data-feature]:not(.menu-visible) { display:none !important; }
    .menu-dropdown:not(.menu-visible) { display:none !important; }
    .sidebar.menu-loading .menu-item,
    .sidebar.menu-loading .menu-dropdown,
    .sidebar.menu-loading li[data-feature],
    .sidebar.menu-loading [data-feature] { display:none !important; }
    .sidebar.menu-loading .menu-visible,
    .sidebar.menu-loading li.menu-visible,
    .sidebar.menu-loading [data-feature].menu-visible { display:block !important; }
    .menu-visible { display:block !important; }

    .top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
    .sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
    .top-nav-left { display:flex; align-items:center; gap:0.75rem; }
    .company-branding { display:flex; align-items:center; gap:0.5rem; }
    #headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
    #headerCompanyName { font-weight:600; font-size:0.85rem; }
    .top-nav-right { display:flex; align-items:center; gap:1rem; }
    .notifications { position:relative; display:flex; align-items:center; }
    .notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
    .notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; display:none; }
    .notification-dropdown { display:none; position:absolute; right:0; top:100%; width:320px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:1000; border:1px solid #e9ecef; max-height:400px; overflow:hidden; }
    .notification-dropdown.show { display:block; animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
    .notification-header { padding:12px 16px; border-bottom:1px solid #e9ecef; background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%); display:flex; justify-content:space-between; align-items:center; }
    .notification-header h3 { margin:0; color:#333; font-size:14px; font-weight:600; }
    .mark-all-read { background:none; border:none; color:#3498db; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; }
    .mark-all-read:hover { background:#e3f2fd; color:#1976d2; }
    .notification-list { max-height:320px; overflow-y:auto; padding:0; }
    .notification-empty { padding:40px 20px; text-align:center; color:#999; display:none; }
    .notification-empty i { font-size:32px; margin-bottom:12px; color:#ddd; }
    .notification-empty-title { font-size:14px; font-weight:500; margin-bottom:4px; color:#666; }
    .notification-empty-message { font-size:12px; color:#999; }
    .user-profile { position:relative; }
    .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
    .profile-btn img { width:100%; height:100%; object-fit:cover; }
    .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
    .profile-dropdown.show { display:block; }
    .profile-dropdown ul { list-style:none; }
    .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
    .profile-dropdown li a:hover { background:#f1f5f9; }

    .page-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 0.55rem 0.75rem; margin: 0.35rem 0 0.5rem 0; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); font-size: 0.9rem; }
    .page-header h1 { color: #fff; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; letter-spacing: 0.5px; margin: 0; font-weight: 600; }
    .page-header i { font-size: 1rem; }
    .btn-add-new { background: none; border: none; color: #fff; padding: 0.4rem; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; text-decoration: none; }
    .btn-add-new:hover { color: rgba(255,255,255,0.8); transform: scale(1.1); }
    .page-actions { display:flex; gap:0.4rem; flex-wrap:wrap; }

    /* Stats Cards */
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem; margin-bottom:1rem; }
    .stat-card { background:#fff; padding:1rem; border-radius:0; box-shadow:0 2px 5px rgba(0,0,0,0.06); display:flex; align-items:center; gap:0.85rem; transition:transform .2s, box-shadow .2s; }
    .stat-card:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .stat-icon { width:44px; height:44px; border-radius:0; display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
    .stat-icon.blue { background:#dbeafe; color:#2563eb; }
    .stat-icon.green { background:#dcfce7; color:#16a34a; }
    .stat-icon.orange { background:#ffedd5; color:#ea580c; }
    .stat-icon.red { background:#fee2e2; color:#dc2626; }
    .stat-icon.purple { background:#f3e8ff; color:#9333ea; }
    .stat-info h3 { font-size:1.3rem; font-weight:700; color:#1f2937; margin-bottom:0.1rem; }
    .stat-info p { font-size:0.75rem; color:#64748b; margin:0; }

    /* Filters */
    .filters { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
    .filters input, .filters select { padding:0.45rem 0.7rem; font-size:0.8rem; border:1px solid #e2e8f0; border-radius:6px; background:#fff; }
    .filters input:focus, .filters select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1); }

    /* Section */
    .section { background:#fff; padding:1rem; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.06); margin-bottom:1rem; }
    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; padding-bottom:0.75rem; border-bottom:1px solid #f1f5f9; }
    .section-title { font-size:0.9rem; font-weight:700; color:#1f2937; display:flex; align-items:center; gap:0.5rem; }

    /* Table */
    table { width:100%; border-collapse:separate; border-spacing:0; }
    th, td { text-align:left; padding:0.75rem 0.85rem; font-size:0.85rem; }
    thead th { background:#f8fafc; color:#475569; font-weight:600; text-transform:uppercase; font-size:0.7rem; letter-spacing:0.5px; border-bottom:2px solid #e2e8f0; }
    tbody tr { transition:background .2s; }
    tbody tr:hover { background:#f8fafc; }
    tbody td { border-bottom:1px solid #f1f5f9; }
    .right { text-align:right; }

    /* Badges */
    .badge { display:inline-flex; align-items:center; padding:0.25rem 0.6rem; border-radius:999px; font-size:0.7rem; font-weight:600; }
    .badge.pending { background:#fef3c7; color:#d97706; }
    .badge.approved { background:#dcfce7; color:#16a34a; }
    .badge.rejected { background:#fee2e2; color:#dc2626; }
    .badge.completed { background:#dbeafe; color:#2563eb; }
    .badge.cancelled { background:#f1f5f9; color:#64748b; }

    /* Buttons */
    .btn { border:none; border-radius:6px; padding:0.5rem 0.9rem; font-size:0.8rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:0.4rem; transition:all .2s; }
    .btn:hover { transform:translateY(-1px); }
    .btn-primary { background:var(--primary-color); color:#fff; }
    .btn-primary:hover { background:#1f2f3d; }
    .btn-success { background:var(--success-color); color:#fff; }
    .btn-success:hover { background:#1e8449; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-danger:hover { background:#b91c1c; }
    .btn-outline { background:#fff; border:1px solid #e2e8f0; color:#475569; }
    .btn-outline:hover { background:#f8fafc; border-color:#cbd5e1; }
    .btn-sm { padding:0.35rem 0.6rem; font-size:0.75rem; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:flex-start; justify-content:center; padding-top:3vh; z-index:1001; backdrop-filter:blur(2px); overflow-y:auto; }
    .modal-backdrop.show { display:flex; }
    .modal { width:clamp(340px, 1000px, 96vw); background:#fff; border-radius:0; box-shadow:0 20px 50px rgba(0,0,0,0.2); overflow:hidden; animation:modalSlide 0.3s ease; margin-bottom:2rem; }
    @keyframes modalSlide { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
    .modal-header { padding:1rem 1.25rem; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom:1px solid #e2e8f0; }
    .modal-title { font-size:1rem; font-weight:700; color:#1f2937; display:flex; align-items:center; gap:0.5rem; }
    .modal-body { padding:1.25rem; max-height:65vh; overflow-y:auto; }
    .modal-footer { padding:1rem 1.25rem; background:#f8fafc; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:0.5rem; }
    .close-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; color:#94a3b8; transition:color .2s; }
    .close-btn:hover { color:#475569; }

    /* Modal Tabs */
    .modal-tabs { display:flex; gap:0; border-bottom:2px solid #e2e8f0; margin-bottom:1rem; flex-wrap:nowrap; overflow-x:auto; }
    .modal-tab { padding:0.6rem 1rem; font-size:0.78rem; font-weight:600; color:#64748b; background:none; border:none; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all 0.2s; white-space:nowrap; }
    .modal-tab:hover { color:#3b82f6; background:#f8fafc; }
    .modal-tab.active { color:#3b82f6; border-bottom-color:#3b82f6; background:#fff; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:1rem; }
    .form-grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; }
    .form-grid .full { grid-column:1/-1; }
    .form-section-title { font-size:0.85rem; font-weight:700; color:#1f2937; margin:1rem 0 0.75rem 0; padding-bottom:0.5rem; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; gap:0.5rem; }
    .form-section-title:first-child { margin-top:0; }
    .form-section-title i { color:#3b82f6; }

    /* Form */
    .form-group { margin-bottom:1rem; }
    .form-group:last-child { margin-bottom:0; }
    .form-group label { display:block; font-size:0.8rem; font-weight:600; color:#374151; margin-bottom:0.4rem; }
    .form-group input, .form-group select, .form-group textarea { width:100%; padding:0.55rem 0.75rem; border:1px solid #e2e8f0; border-radius:6px; font-size:0.85rem; transition:border-color .2s, box-shadow .2s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1); }
    .form-row { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }

    /* Items List in Modal */
    .items-list { border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; margin-bottom:1rem; }
    .items-list-header { display:grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 0.7fr 40px; gap:0.5rem; padding:0.6rem 0.75rem; background:#f8fafc; font-size:0.7rem; font-weight:600; color:#475569; text-transform:uppercase; }
    .item-row { display:grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 0.7fr 40px; gap:0.5rem; padding:0.6rem 0.75rem; border-top:1px solid #f1f5f9; align-items:center; }
    .item-row select, .item-row input { padding:0.4rem 0.5rem; font-size:0.8rem; border:1px solid #e2e8f0; border-radius:4px; }
    .item-row span { font-size:0.8rem; color:#374151; }
    .item-row .remove-btn { background:#fee2e2; color:#dc2626; border:none; width:28px; height:28px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .item-row .remove-btn:hover { background:#fecaca; }
    .add-item-btn { width:100%; padding:0.6rem; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:0 0 8px 8px; color:#64748b; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.4rem; transition:all .2s; }
    .add-item-btn:hover { background:#f1f5f9; border-color:#94a3b8; color:#475569; }

    /* Employee Section Styles */
    .employee-section { background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:1rem; overflow:hidden; }
    .employee-header { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-bottom:1px solid #e2e8f0; }
    .employee-info { display:flex; align-items:center; gap:0.75rem; }
    .employee-avatar { width:36px; height:36px; border-radius:50%; background:#3b82f6; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.85rem; }
    .employee-name { font-weight:600; color:#1f2937; font-size:0.9rem; }
    .employee-id { font-size:0.75rem; color:#64748b; }
    .employee-actions { display:flex; gap:0.5rem; }
    .employee-items { padding:1rem; }
    .employee-items-header { display:grid; grid-template-columns: 2fr 1fr 0.8fr 0.8fr 0.6fr 40px; gap:0.5rem; padding:0.5rem 0.75rem; background:#fff; font-size:0.7rem; font-weight:600; color:#475569; text-transform:uppercase; border:1px solid #e2e8f0; border-radius:6px 6px 0 0; }
    .employee-item-row { display:grid; grid-template-columns: 2fr 1fr 0.8fr 0.8fr 0.6fr 40px; gap:0.5rem; padding:0.5rem 0.75rem; background:#fff; border:1px solid #e2e8f0; border-top:none; align-items:center; }
    .employee-item-row:last-of-type { border-radius:0 0 6px 6px; }
    .employee-item-row select, .employee-item-row input { padding:0.4rem 0.5rem; font-size:0.8rem; border:1px solid #e2e8f0; border-radius:4px; }
    .employee-item-row span { font-size:0.8rem; color:#374151; }
    .btn-remove-employee { background:#fee2e2; color:#dc2626; border:none; padding:0.4rem 0.6rem; border-radius:4px; cursor:pointer; font-size:0.75rem; display:flex; align-items:center; gap:0.3rem; }
    .btn-remove-employee:hover { background:#fecaca; }
    .add-employee-item-btn { width:100%; padding:0.5rem; background:#fff; border:1px dashed #cbd5e1; border-top:none; border-radius:0 0 6px 6px; color:#64748b; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.4rem; }
    .add-employee-item-btn:hover { background:#f8fafc; border-color:#94a3b8; color:#475569; }

    /* Alerts */
    .alert { padding:0.75rem 1rem; border-radius:8px; font-size:0.85rem; margin-bottom:1rem; display:none; }
    .alert.error { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .alert.success { background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
    .alert.show { display:block; }

    .muted { color:#64748b; font-size:0.85rem; }
    .empty-state { text-align:center; padding:3rem 1rem; color:#94a3b8; }
    .empty-state i { font-size:2.5rem; margin-bottom:0.75rem; display:block; opacity:0.5; }

    /* Page-level Tabs */
    .page-tabs { display:flex; gap:0; background:#fff; border-radius:10px 10px 0 0; margin-bottom:0; box-shadow:0 2px 5px rgba(0,0,0,0.06); overflow:hidden; }
    .page-tab { padding:0.75rem 1.25rem; font-size:0.85rem; font-weight:600; color:#64748b; background:#f8fafc; border:none; cursor:pointer; display:flex; align-items:center; gap:0.5rem; transition:all 0.2s; border-bottom:3px solid transparent; }
    .page-tab:hover { color:#3b82f6; background:#fff; }
    .page-tab.active { color:#3b82f6; background:#fff; border-bottom-color:#3b82f6; }
    .page-tab .badge-count { background:#e2e8f0; color:#64748b; padding:0.15rem 0.5rem; border-radius:999px; font-size:0.7rem; font-weight:700; margin-left:0.3rem; }
    .page-tab.active .badge-count { background:#dbeafe; color:#3b82f6; }
    .page-tab-panel { display:none; }
    .page-tab-panel.active { display:block; }

    /* Reservation Details - Investigation Style */
    .res-detail-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:flex-start; justify-content:center; overflow:auto; padding:32px 20px; }
    .res-detail-overlay.show { display:flex; }
    .res-detail-container { background:#fff; border-radius:12px; width:100%; max-width:940px; min-height:60vh; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:visible; }
    .res-detail-sheet { background:#fff; width:100%; padding:20px 24px 40px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827; }
    .res-detail-header { display:flex; justify-content:space-between; gap:20px; margin-bottom:0; align-items:flex-start; }
    .res-company-block { display:flex; flex-direction:column; align-items:flex-start; gap:8px; }
    .res-company-logo { width:80px; height:80px; object-fit:contain; border:none; border-radius:8px; background:#fff; }
    .res-company-logo-fallback { width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px; }
    .res-doc-title { font-size:.9rem; font-weight:700; margin:2px 0 0; color:#111827; text-align:left; }
    .res-meta { font-size:.63rem; color:#374151; text-align:right; line-height:1.35; min-width:150px; }
    .res-divider { height:1px; background:#e5e7eb; margin:12px 0 18px; border-radius:1px; }
    .res-docmeta-row { font-size:.72rem; color:#111827; margin:6px 0 12px; }
    .res-section-title { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; font-weight:600; font-size:.75rem; padding:10px 14px; border:none; border-radius:0; display:flex; align-items:center; gap:10px; box-shadow:0 2px 8px rgba(44,62,80,0.15); margin-top:16px; }
    .res-section-title:first-of-type { margin-top:0; }
    .res-section-title i { font-size:1rem; width:28px; height:28px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .res-section-title .section-text { flex:1; }
    .res-section-title.request-section i { background:rgba(52,152,219,0.3); }
    .res-section-title.items-section i { background:rgba(155,89,182,0.3); }
    .res-section-title.delivery-section i { background:rgba(46,204,113,0.3); }
    .res-section-title.status-section i { background:rgba(241,196,15,0.3); }
    .res-info-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px 14px; margin-top:8px; }
    .res-info-item { border:none; border-radius:0; background:transparent; padding:4px 0; display:flex; align-items:flex-start; column-gap:8px; }
    .res-info-item .label { font-size:.74rem; color:#374151; font-weight:700; text-transform:none; letter-spacing:.01em; min-width:130px; white-space:nowrap; }
    .res-info-item .label::after { content:':'; margin-left:4px; }
    .res-info-item .value { font-size:.74rem; color:#111827; line-height:1.35; flex:1; }
    .res-info-item.full { grid-column:span 2; }
    .res-info-table { width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px; }
    .res-info-table th { padding:8px 12px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:600; color:#374151; text-align:left; }
    .res-info-table td { padding:8px 12px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; }
    .res-status-badge { display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; font-size:.7rem; font-weight:600; }
    .res-status-badge.pending { background:#fef3c7; color:#d97706; }
    .res-status-badge.approved { background:#dcfce7; color:#16a34a; }
    .res-status-badge.rejected { background:#fee2e2; color:#dc2626; }
    .res-status-badge.completed { background:#dbeafe; color:#2563eb; }
    .res-status-badge.cancelled { background:#f1f5f9; color:#64748b; }
    .res-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; padding-top:16px; border-top:1px solid #e2e8f0; margin-top:16px; }
    .res-print-btn { position:absolute; top:10px; right:10px; background:#111827; color:#fff; border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; z-index:10; }
    .res-close-btn { position:absolute; top:10px; right:100px; background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; z-index:10; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f1f5f9; }
    
    /* Approval Flow Table */
    .res-section-title.approval-section i { background:rgba(231,76,60,0.3); }
    .res-approval-table { width:100%; border-collapse:collapse; font-size:0.72rem; margin-top:8px; }
    .res-approval-table th { background:#2c3e50; font-weight:600; font-size:0.65rem; color:#ffffff; padding:10px 8px; border:1px solid #2c3e50; text-align:left; }
    .res-approval-table td { padding:10px 8px; border:1px solid #e5e7eb; vertical-align:middle; background:#fff; color:#111827; }
    .res-approval-table .status-chip { display:inline-block; font-size:0.65rem; font-weight:600; padding:3px 10px; border-radius:12px; }
    .res-approval-table .status-chip.approved { background:#d1fae5; color:#065f46; }
    .res-approval-table .status-chip.declined { background:#fee2e2; color:#991b1b; }
    .res-approval-table .status-chip.pending { background:#e5e7eb; color:#374151; }
    .res-approval-table .sig-img { max-width:100px; max-height:40px; object-fit:contain; display:block; }
    .res-approval-table .approver-name { font-weight:600; color:#1f2937; }
    .res-approval-table .approver-role { font-size:0.6rem; color:#6b7280; }

    /* Dropdowns */
    .notification-dropdown { position:absolute; top:48px; right:60px; min-width:320px; max-width:400px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); display:none; z-index:999; }
    .notification-dropdown.show { display:block; }
    .profile-dropdown { position:absolute; top:48px; right:12px; min-width:260px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); display:none; z-index:999; }
    .profile-dropdown.show { display:block; }
    .profile-dropdown ul { list-style:none; padding:0; margin:0; }
    .profile-dropdown a { display:flex; align-items:center; gap:0.5rem; padding:0.75rem 1rem; color:#333; text-decoration:none; transition:background .2s; }
    .profile-dropdown a:hover { background:#f8f9fa; }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .res-info-grid { grid-template-columns: 1fr; }
      .res-info-item.full { grid-column:span 1; }
      .page-header { flex-direction:column; gap:1rem; align-items:flex-start; }
      .items-list-header, .item-row { grid-template-columns: 1fr; }
    }

    /* Print Styles - A4 page format matching investigation modal */
    @media print {
      @page { size:A4; margin:10mm; }
      
      /* Hide everything by default */
      html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
      body * { visibility:hidden !important; }
      
      /* Show printable area and all children */
      #viewModal, 
      #viewModal *, 
      #issueDetailModal,
      #issueDetailModal *,
      .res-detail-overlay,
      .res-detail-overlay *,
      .res-detail-container,
      .res-detail-container *,
      .res-detail-sheet,
      .res-detail-sheet * { visibility:visible !important; }
      
      /* Position and size the print area */
      #viewModal,
      #issueDetailModal { 
        position:absolute !important; 
        left:0 !important; 
        top:0 !important; 
        width:100% !important; 
        padding:0 !important; 
        background:transparent !important; 
        display:block !important;
        overflow:visible !important;
      }
      
      .res-detail-overlay {
        position:absolute !important;
        left:0 !important;
        top:0 !important;
        width:100% !important;
        padding:0 !important;
        background:transparent !important;
        display:block !important;
        overflow:visible !important;
      }
      
      .res-detail-container { 
        box-shadow:none !important; 
        border-radius:0 !important; 
        width:100% !important; 
        max-width:100% !important; 
        min-height:auto !important;
        overflow:visible !important;
      }
      
      .res-detail-sheet { 
        width:100% !important; 
        min-height:auto !important; 
        margin:0 !important; 
        padding:10mm !important; 
        border:none !important; 
        box-shadow:none !important; 
      }
      
      /* Hide buttons */
      .res-print-btn, .res-close-btn, #resPrintBtn, #resCloseBtn, #issueDetailPrintBtn, #issueDetailCloseBtn { display:none !important; }
      
      /* Hide action buttons section */
      .res-actions { display:none !important; }
      #resApprovalCommentSection { display:none !important; }
      
      /* Table styling for print */
      .res-info-table { 
        width:100% !important; 
        border-collapse:collapse !important;
        page-break-inside:auto !important;
      }
      
      .res-info-table th { 
        background:#2c3e50 !important; 
        color:#fff !important; 
        -webkit-print-color-adjust:exact !important; 
        print-color-adjust:exact !important; 
      }
      
      .res-info-table td {
        background:#fff !important;
        color:#111827 !important;
        border:1px solid #e5e7eb !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .res-info-table tr { 
        page-break-inside:avoid !important; 
      }
      
      /* Approval table styling for print */
      .res-approval-table { 
        width:100% !important; 
        border-collapse:collapse !important;
        page-break-inside:auto !important;
      }
      
      .res-approval-table th { 
        background:#2c3e50 !important; 
        color:#fff !important; 
        -webkit-print-color-adjust:exact !important; 
        print-color-adjust:exact !important; 
      }
      
      .res-approval-table td {
        background:#fff !important;
        color:#111827 !important;
        border:1px solid #e5e7eb !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .res-approval-table tr { 
        page-break-inside:avoid !important; 
      }
      
      .res-approval-table .sig-img {
        max-width:80px !important;
        max-height:35px !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      /* Section title styling for print */
      .res-section-title { 
        background: linear-gradient(135deg, #2c3e50, #34495e) !important; 
        color: #fff !important; 
        border: none !important;
        border-radius: 0 !important;
        padding: 10px 12px !important;
        page-break-after:avoid !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .res-section-title i {
        color: #fff !important;
        font-size: 0.9rem !important;
        width: 24px !important;
        height: 24px !important;
        background: rgba(255,255,255,0.2) !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Info grid styling for print */
      .res-info-grid { 
        display:grid !important;
        grid-template-columns: repeat(2, minmax(0,1fr)) !important;
        gap:6px 12px !important;
        page-break-inside:avoid !important;
      }
      
      .res-info-item { 
        page-break-inside:avoid !important; 
        break-inside:avoid !important; 
        border:none !important;
        background:transparent !important;
        padding:4px 0 !important;
        display:flex !important;
        align-items:flex-start !important;
        gap:8px !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .res-info-item .label {
        font-weight:700 !important;
        color:#374151 !important;
        min-width:130px !important;
        white-space:nowrap !important;
      }
      
      .res-info-item .value {
        color:#111827 !important;
        flex:1 !important;
      }
      
      .res-info-item.full { 
        grid-column:span 2 !important; 
      }
      
      /* Status badge styling for print */
      .res-status-badge {
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .res-status-badge.pending { background:#fef3c7 !important; color:#d97706 !important; }
      .res-status-badge.approved { background:#dcfce7 !important; color:#16a34a !important; }
      .res-status-badge.rejected { background:#fee2e2 !important; color:#dc2626 !important; }
      .res-status-badge.completed { background:#dbeafe !important; color:#2563eb !important; }
      .res-status-badge.cancelled { background:#f1f5f9 !important; color:#64748b !important; }
      
      /* Approval status chip styling for print */
      .status-chip {
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .status-chip.approved { background:#d1fae5 !important; color:#065f46 !important; }
      .status-chip.declined { background:#fee2e2 !important; color:#991b1b !important; }
      .status-chip.pending { background:#e5e7eb !important; color:#374151 !important; }
      
      /* Header styling for print */
      .res-detail-header { 
        display:flex !important; 
        justify-content:space-between !important; 
        page-break-after:avoid !important; 
      }
      
      .res-company-logo, #resModalLogo { 
        max-width:80px !important; 
        max-height:80px !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .res-company-logo-fallback { display:none !important; }
      
      /* Hide generated timestamp in print */
      #resModalGenerated { display:none !important; }
      
      /* Employee section styling for print */
      .employee-section {
        page-break-inside:avoid !important;
        break-inside:avoid !important;
        background:#f8fafc !important;
        border:1px solid #e2e8f0 !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .employee-header {
        background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      
      .employee-avatar {
        background:#3b82f6 !important;
        color:#fff !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <nav class="sidebar" id="sidebar">
      <div class="logo"><h2>Dreamex Datalab</h2></div>
      <ul class="menu" id="roleBasedMenu">
        <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
        <li class="menu-dropdown" data-feature="health_view">
          <a href="#"><i class="fas fa-medkit"></i> Health</a>
          <ul class="submenu">
            <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
            <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
            <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
          <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
          <ul class="submenu">
            <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
            <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
          <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
          <ul class="submenu">
            <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
            <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
            <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
            <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
            <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
            <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
          <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
          <ul class="submenu">
            <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
            <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
            <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
          <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
          <ul class="submenu">
            <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
            <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
            <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
            <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
            <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
            <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
            <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
            <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="environment_view">
          <a href="#"><i class="fas fa-leaf"></i> Environment</a>
          <ul class="submenu">
            <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
          <a href="#"><i class="fas fa-lock"></i> Security</a>
          <ul class="submenu">
            <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
            <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
            <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
            <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
            <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
            <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
          <a href="#"><i class="fas fa-truck"></i> Logistics</a>
          <ul class="submenu">
            <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
            <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
          <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
          <ul class="submenu">
            <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
            <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
          <a href="#"><i class="fas fa-users"></i> HR</a>
          <ul class="submenu">
            <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
            <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
            <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
            <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
            <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
            <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
            <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
            <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
            <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
            <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
            <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
            <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
            <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
            <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="project_management_section">
          <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
          <ul class="submenu">
            <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
            <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
            <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
            <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
          <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
          <ul class="submenu">
            <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
            <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
            <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
            <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html" class="active"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
          </ul>
        </li>
        <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
          <a href="#"><i class="fas fa-utensils"></i> Workspaces â€” Catering</a>
          <ul class="submenu">
            <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
            <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
            <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
            <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
            <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
          </ul>
        </li>
        <li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
        <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
        <li class="menu-dropdown" data-feature="settings_view">
          <a href="#"><i class="fas fa-cog"></i> Settings</a>
          <ul class="submenu">
            <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
            <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
            <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
            <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
            <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
            <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
            <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
            <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
            <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <main class="main-content" id="mainContent">
        <nav class="top-nav">
            <div class="top-nav-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                <div class="company-branding">
                    <img id="headerCompanyLogo" alt="Company Logo" />
                    <span id="headerCompanyName"></span>
                </div>
            </div>
            <div class="top-nav-right">
                <div class="notifications">
                    <button id="notificationBtn" class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list"></div>
                        <div class="notification-empty">
                            <i class="fas fa-inbox"></i>
                            <div class="notification-empty-title">No notifications</div>
                            <div class="notification-empty-message">You're all caught up</div>
                        </div>
                    </div>
                </div>
                <div class="user-profile" style="position:relative;">
                    <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                    <div class="profile-dropdown"><ul></ul></div>
                </div>
            </div>
        </nav>

      <!-- Page Header -->
      <section class="page-header">
        <h1><i class="fas fa-bookmark"></i> Material Reservations</h1>
        <div class="page-actions">
          <button class="btn-add-new" onclick="openReservationModal()" title="New Reservation"><i class="fas fa-plus"></i></button>
        </div>
      </section>

      <!-- Page Level Tabs -->
      <div class="page-tabs">
        <button type="button" class="page-tab active" data-page-tab="reservations" onclick="switchPageTab('reservations')">
          <i class="fas fa-bookmark"></i> Reservations
        </button>
        <button type="button" class="page-tab" data-page-tab="pending-issue" onclick="switchPageTab('pending-issue')">
          <i class="fas fa-box-open"></i> Pending Issue <span class="badge-count" id="pendingIssueCount">0</span>
        </button>
        <button type="button" class="page-tab" data-page-tab="issued" onclick="switchPageTab('issued')">
          <i class="fas fa-clipboard-check"></i> Issued <span class="badge-count" id="issuedCount">0</span>
        </button>
      </div>

      <!-- Reservations Tab Panel -->
      <div class="page-tab-panel active" id="pageTab-reservations">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue"><i class="fas fa-clipboard-list"></i></div>
            <div class="stat-info">
              <h3 id="totalReservations">0</h3>
              <p>Total Reservations</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
            <div class="stat-info">
              <h3 id="pendingReservations">0</h3>
              <p>Pending</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info">
              <h3 id="approvedReservations">0</h3>
              <p>Approved</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon purple"><i class="fas fa-check-double"></i></div>
            <div class="stat-info">
              <h3 id="completedReservations">0</h3>
              <p>Completed</p>
            </div>
          </div>
        </div>

      <!-- Reservations Table Section -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-list"></i> Reservations List</h2>
          <div class="filters">
            <input type="text" id="searchBox" placeholder="Search reservations..." style="min-width:180px;" />
            <select id="statusFilter">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="completed">Completed</option>
              <option value="rejected">Rejected</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Reservation #</th>
              <th>Requested By</th>
              <th>Project / Purpose</th>
              <th>Items</th>
              <th>Required Date</th>
              <th>Status</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="reservationsTableBody">
            <tr><td colspan="7" class="muted" style="text-align:center;padding:2rem;">Loading reservations...</td></tr>
          </tbody>
        </table>
      </div>
      </div><!-- End Reservations Tab Panel -->

      <!-- Pending Issue Tab Panel -->
      <div class="page-tab-panel" id="pageTab-pending-issue">
        <div class="section">
          <div class="section-header">
            <h2 class="section-title"><i class="fas fa-box-open"></i> Pending Issue - Approved Reservations</h2>
            <div class="filters">
              <input type="text" id="pendingIssueSearch" placeholder="Search..." style="min-width:180px;" />
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Reservation #</th>
                <th>Requested By</th>
                <th>Employee</th>
                <th>Item</th>
                <th>Quantity</th>
                <th>Required Date</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="pendingIssueTableBody">
              <tr><td colspan="7" class="muted" style="text-align:center;padding:2rem;">Loading pending issues...</td></tr>
            </tbody>
          </table>
        </div>
      </div><!-- End Pending Issue Tab Panel -->

      <!-- Issued Tab Panel -->
      <div class="page-tab-panel" id="pageTab-issued">
        <div class="section">
          <div class="section-header">
            <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Issued Items</h2>
            <div class="filters">
              <input type="text" id="issuedSearch" placeholder="Search..." style="min-width:180px;" />
              <input type="date" id="issuedDateFrom" title="From Date" />
              <input type="date" id="issuedDateTo" title="To Date" />
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Issue Date</th>
                <th>Reservation #</th>
                <th>Employee</th>
                <th>Item</th>
                <th>Quantity</th>
                <th>Issued By</th>
              </tr>
            </thead>
            <tbody id="issuedTableBody">
              <tr><td colspan="6" class="muted" style="text-align:center;padding:2rem;">Loading issued items...</td></tr>
            </tbody>
          </table>
        </div>
      </div><!-- End Issued Tab Panel -->

    </main>
  </div>

  <!-- New Reservation Modal -->
  <div class="modal-backdrop" id="reservationModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-bookmark"></i> <span id="modalTitle">New Reservation</span></h3>
        <button class="close-btn" onclick="closeReservationModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="alert error" id="modalError"></div>
        <div class="alert success" id="modalSuccess"></div>

        <!-- Modal Tabs -->
        <div class="modal-tabs">
          <button type="button" class="modal-tab active" data-tab="request" onclick="switchReservationTab('request')"><i class="fas fa-clipboard-list"></i> Request Info</button>
          <button type="button" class="modal-tab" data-tab="items" onclick="switchReservationTab('items')"><i class="fas fa-boxes"></i> Items</button>
          <button type="button" class="modal-tab" data-tab="delivery" onclick="switchReservationTab('delivery')"><i class="fas fa-truck"></i> Delivery</button>
          <button type="button" class="modal-tab" data-tab="additional" onclick="switchReservationTab('additional')"><i class="fas fa-info-circle"></i> Additional</button>
        </div>

        <form id="reservationForm">
          <!-- Request Info Tab -->
          <div class="tab-panel active" id="tab-request">
            <div class="form-section-title"><i class="fas fa-file-alt"></i> Request Details</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="reservationType">Reservation Type *</label>
                <select id="reservationType" required>
                  <option value="">Select Type</option>
                  <option value="project">Project Allocation</option>
                  <option value="maintenance">Maintenance / Repair</option>
                  <option value="production">Production / Manufacturing</option>
                  <option value="construction">Construction</option>
                  <option value="safety">Safety / Emergency</option>
                  <option value="event">Event / Training</option>
                  <option value="research">Research / Testing</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="reservationCostCenter">Cost Center / Department *</label>
                <select id="reservationCostCenter" required>
                  <option value="">Select Cost Center</option>
                </select>
              </div>
            </div>
            
            <div class="form-section-title"><i class="fas fa-calendar-alt"></i> Schedule</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="reservationDate">Required Date *</label>
                <input type="date" id="reservationDate" required />
              </div>
              <div class="form-group">
                <label for="reservationEndDate">End Date (if applicable)</label>
                <input type="date" id="reservationEndDate" />
              </div>
            </div>
            
            <div class="form-section-title"><i class="fas fa-align-left"></i> Justification</div>
            <div class="form-group">
              <label for="reservationPurpose">Purpose / Justification *</label>
              <textarea id="reservationPurpose" rows="3" required placeholder="Describe the purpose and justification for this reservation..."></textarea>
            </div>
          </div>

          <!-- Items Tab -->
          <div class="tab-panel" id="tab-items">
            <div class="form-section-title"><i class="fas fa-users"></i> Employee Reservations</div>
            <p style="font-size:0.8rem; color:#64748b; margin-bottom:1rem;">Add employees and assign items to each employee.</p>
            
            <!-- Add Employee Section -->
            <div class="form-group" style="margin-bottom:1rem;">
              <div style="display:flex; gap:0.5rem; align-items:flex-end;">
                <div style="flex:1;">
                  <label for="employeeSelect">Select Employee</label>
                  <select id="employeeSelect">
                    <option value="">Choose an employee...</option>
                  </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="addEmployeeSection()" style="height:38px;">
                  <i class="fas fa-plus"></i> Add Employee
                </button>
              </div>
            </div>
            
            <!-- Employees Container -->
            <div id="employeesContainer"></div>
            
            <div class="form-section-title" style="margin-top:1.5rem;"><i class="fas fa-sticky-note"></i> Item Notes</div>
            <div class="form-group">
              <label for="itemSpecialInstructions">Special Instructions for Items</label>
              <textarea id="itemSpecialInstructions" rows="2" placeholder="Any special handling, preparation, or packaging requirements..."></textarea>
            </div>
          </div>

          <!-- Delivery Tab -->
          <div class="tab-panel" id="tab-delivery">
            <div class="form-section-title"><i class="fas fa-map-marker-alt"></i> Delivery Information</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="deliveryMethod">Delivery Method *</label>
                <select id="deliveryMethod" required>
                  <option value="pickup">Self Pickup</option>
                  <option value="delivery">Warehouse Delivery</option>
                  <option value="internal">Internal Transfer</option>
                  <option value="courier">External Courier</option>
                </select>
              </div>
              <div class="form-group">
                <label for="deliveryLocation">Delivery Location / Work Area *</label>
                <select id="deliveryLocation" required>
                  <option value="">Select Location</option>
                </select>
              </div>
              <div class="form-group">
                <label for="deliveryRoom">Room / Area</label>
                <input type="text" id="deliveryRoom" placeholder="Room number or area" />
              </div>
              <div class="form-group">
                <label for="deliveryContact">Contact Person</label>
                <input type="text" id="deliveryContact" placeholder="Name of person to receive items" />
              </div>
              <div class="form-group">
                <label for="deliveryPhone">Contact Phone</label>
                <input type="tel" id="deliveryPhone" placeholder="Phone number" />
              </div>
              <div class="form-group">
                <label for="preferredTime">Preferred Delivery Time</label>
                <select id="preferredTime">
                  <option value="">Any Time</option>
                  <option value="morning">Morning (8AM - 12PM)</option>
                  <option value="afternoon">Afternoon (12PM - 5PM)</option>
                  <option value="evening">Evening (5PM - 8PM)</option>
                </select>
              </div>
              <div class="form-group full">
                <label for="deliveryInstructions">Delivery Instructions</label>
                <textarea id="deliveryInstructions" rows="2" placeholder="Special delivery instructions, access requirements, etc."></textarea>
              </div>
            </div>
          </div>

          <!-- Additional Tab -->
          <div class="tab-panel" id="tab-additional">
            <div class="form-section-title"><i class="fas fa-dollar-sign"></i> Budget Information</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="estimatedValue">Estimated Value</label>
                <input type="number" id="estimatedValue" min="0" step="0.01" placeholder="0.00" />
              </div>
            </div>
            <div class="form-section-title"><i class="fas fa-undo"></i> Return Information</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="returnRequired">Return Required?</label>
                <select id="returnRequired">
                  <option value="no">No - Consumable / Permanent Use</option>
                  <option value="yes">Yes - Must Return Items</option>
                  <option value="partial">Partial - Some Items Returnable</option>
                </select>
              </div>
              <div class="form-group">
                <label for="expectedReturnDate">Expected Return Date</label>
                <input type="date" id="expectedReturnDate" />
              </div>
            </div>
            <div class="form-section-title"><i class="fas fa-comment-alt"></i> Additional Notes</div>
            <div class="form-group">
              <label for="reservationNotes">Notes / Comments</label>
              <textarea id="reservationNotes" rows="3" placeholder="Any additional notes, comments, or special requirements..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeReservationModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitReservation()"><i class="fas fa-paper-plane"></i> Submit Reservation</button>
      </div>
    </div>
  </div>

  <!-- View Reservation Modal - Investigation Style -->
  <div class="res-detail-overlay" id="viewModal">
    <div class="res-detail-container">
      <button id="resPrintBtn" class="res-print-btn" onclick="printReservation()"><i class="fas fa-print"></i> Print / PDF</button>
      <button id="resCloseBtn" class="res-close-btn" onclick="closeViewModal()">Close</button>
      
      <div class="res-detail-sheet printable" id="viewModalBody">
        <!-- Header with Company Logo -->
        <div class="res-detail-header">
          <div class="res-company-block">
            <img id="resModalLogo" class="res-company-logo" src="" alt="Company Logo" style="display:none;">
            <div id="resModalLogoFallback" class="res-company-logo-fallback"></div>
            <div>
              <h1 id="resModalCompanyName" style="margin:0; font-size:1.1rem; line-height:1.2; font-weight:700;"></h1>
              <h2 class="res-doc-title">Material Reservation Request</h2>
            </div>
          </div>
          <div class="res-meta">
            <div id="resModalGenerated" style="font-size:.55rem; color:#6b7280; font-weight:500;"></div>
          </div>
        </div>
        
        <div class="res-divider"></div>
        
        <!-- Document Number -->
        <div class="res-docmeta-row">
          <span style="font-weight:700; color:#374151; margin-right:6px;">Document Number:</span>
          <span id="resModalDocNumber"></span>
        </div>
        
        <!-- Sections Container -->
        <div id="resDetailSections"></div>
        
        <!-- Actions -->
        <div class="res-actions" id="resDetailActions" style="display:none; padding-top:12px; border-top:1px solid #e2e8f0; margin-top:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; width:100%;">
            <div style="display:flex; align-items:center; gap:8px;">
              <button type="button" id="resEditBtn" onclick="editReservation()" style="background:#1f2937; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button type="button" id="resDeleteBtn" onclick="deleteReservation()" style="background:#dc2626; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
              <button type="button" id="resDeclineBtn" onclick="declineReservation()" style="background:#ef4444; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                <i class="fas fa-times"></i> Decline
              </button>
              <button type="button" id="resApproveBtn" onclick="approveReservation()" style="background:#10b981; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                <i class="fas fa-check"></i> Approve
              </button>
            </div>
          </div>
          <!-- Comment input for approval/decline -->
          <div id="resApprovalCommentSection" style="display:none; margin-top:10px; width:100%;">
            <label style="font-size:0.7rem; font-weight:600; color:#374151; display:block; margin-bottom:4px;">Comment (optional)</label>
            <textarea id="resApprovalComment" style="width:100%; min-height:60px; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:0.75rem; resize:vertical;" placeholder="Add a comment for your decision..."></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Issue Item Modal -->
  <div class="modal-backdrop" id="issueModal">
    <div class="modal" style="max-width:900px;">
      <div class="modal-header" style="background:linear-gradient(135deg, #10b981, #059669);">
        <h3 class="modal-title" style="color:#fff;"><i class="fas fa-dolly"></i> Issue Items</h3>
        <button class="close-btn" onclick="closeIssueModal()" style="color:#fff;"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="max-height:70vh;">
        <div class="alert error" id="issueModalError"></div>
        <div class="alert success" id="issueModalSuccess"></div>

        <!-- Reservation Info -->
        <div style="display:flex; justify-content:space-between; align-items:center; background:#f8fafc; border:1px solid #e2e8f0; padding:0.75rem 1rem; margin-bottom:1rem;">
          <div>
            <span style="font-size:0.7rem; color:#64748b; text-transform:uppercase; font-weight:600;">Reservation #</span>
            <div style="font-size:1rem; font-weight:700; color:#1f2937;" id="issueReservationNumber">-</div>
          </div>
          <div>
            <span style="font-size:0.7rem; color:#64748b; text-transform:uppercase; font-weight:600;">Requested By</span>
            <div style="font-size:0.9rem; font-weight:600; color:#1f2937;" id="issueRequestedBy">-</div>
          </div>
          <div>
            <span style="font-size:0.7rem; color:#64748b; text-transform:uppercase; font-weight:600;">Required Date</span>
            <div style="font-size:0.9rem; color:#1f2937;" id="issueRequiredDate">-</div>
          </div>
        </div>

        <!-- Items Table -->
        <div class="form-section-title"><i class="fas fa-boxes"></i> Items to Issue</div>
        <div style="border:1px solid #e2e8f0; border-radius:6px; overflow:hidden; margin-bottom:1rem;">
          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="background:#f8fafc;">
                <th style="padding:0.6rem; text-align:center; width:40px; border-bottom:1px solid #e2e8f0;">
                  <input type="checkbox" id="issueSelectAll" onchange="toggleAllIssueItems(this.checked)" title="Select All" />
                </th>
                <th style="padding:0.6rem; text-align:left; border-bottom:1px solid #e2e8f0;">Employee</th>
                <th style="padding:0.6rem; text-align:left; border-bottom:1px solid #e2e8f0;">Item</th>
                <th style="padding:0.6rem; text-align:center; border-bottom:1px solid #e2e8f0; width:80px;">Requested</th>
                <th style="padding:0.6rem; text-align:center; border-bottom:1px solid #e2e8f0; width:80px;">Issued</th>
                <th style="padding:0.6rem; text-align:center; border-bottom:1px solid #e2e8f0; width:80px;">Remaining</th>
                <th style="padding:0.6rem; text-align:center; border-bottom:1px solid #e2e8f0; width:100px;">Qty to Issue</th>
              </tr>
            </thead>
            <tbody id="issueItemsTableBody">
              <tr><td colspan="7" style="text-align:center; padding:2rem; color:#94a3b8;">Loading items...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Issued By Section -->
        <div class="form-section-title"><i class="fas fa-user-check"></i> Issued By</div>
        <div class="form-group">
          <label for="issuedBySelect" style="font-weight:600;">Select Person Issuing *</label>
          <select id="issuedBySelect" required>
            <option value="">Select who is issuing...</option>
          </select>
        </div>

        <!-- Notes Section -->
        <div class="form-group">
          <label for="issueNotes">Notes (optional)</label>
          <textarea id="issueNotes" rows="2" placeholder="Add any notes about this issuance..."></textarea>
        </div>

        <!-- Hidden fields to store context -->
        <input type="hidden" id="issueReservationId" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeIssueModal()">Cancel</button>
        <button type="button" class="btn btn-success" onclick="confirmIssueMultiple()"><i class="fas fa-check"></i> Issue Selected Items</button>
      </div>
    </div>
  </div>

  <!-- Issue Detail View Modal - Investigation Style -->
  <div class="res-detail-overlay" id="issueDetailModal">
    <div class="res-detail-container">
      <button id="issueDetailPrintBtn" class="res-print-btn" onclick="printIssueDetail()"><i class="fas fa-print"></i> Print / PDF</button>
      <button id="issueDetailCloseBtn" class="res-close-btn" onclick="closeIssueDetailModal()">Close</button>
      
      <div class="res-detail-sheet printable" id="issueDetailModalBody">
        <!-- Header with Company Logo -->
        <div class="res-detail-header">
          <div class="res-company-block">
            <img id="issueDetailLogo" class="res-company-logo" src="" alt="Company Logo" style="display:none;">
            <div id="issueDetailLogoFallback" class="res-company-logo-fallback"></div>
            <div>
              <h1 id="issueDetailCompanyName" style="margin:0; font-size:1.1rem; line-height:1.2; font-weight:700;"></h1>
              <h2 class="res-doc-title">Material Issuance Record</h2>
            </div>
          </div>
          <div class="res-meta">
            <div id="issueDetailGenerated" style="font-size:.55rem; color:#6b7280; font-weight:500;"></div>
          </div>
        </div>
        
        <div class="res-divider"></div>
        
        <!-- Document Number -->
        <div class="res-docmeta-row">
          <span style="font-weight:700; color:#374151; margin-right:6px;">Issue ID:</span>
          <span id="issueDetailDocNumber"></span>
        </div>
        
        <!-- Sections Container -->
        <div id="issueDetailSections"></div>
      </div>
    </div>
  </div>

  <script>
    // Normalize job title for display: pick label if object, replace hyphens with spaces, capitalize first letter of each word
    function resolveJobTitle(raw) {
      if (!raw) return '';
      let val = raw;
      if (typeof raw === 'object') {
        val = raw.label || raw.name || raw.value || '';
      }
      if (typeof val !== 'string') return '';
      return val.replace(/-/g, ' ').replace(/\s+/g, ' ').trim()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }
    // Firebase initialization
    function initializeFirebase() {
      if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
        window.firebase.initializeApp({
          apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
          authDomain: "users-8be65.firebaseapp.com",
          databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
          projectId: "users-8be65",
          storageBucket: "users-8be65.firebasestorage.app",
          messagingSenderId: "909025468149",
          appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
          measurementId: "G-XHFMRCJQEZ"
        });
      }
      return window.firebase;
    }
    const firebase = initializeFirebase();
    const db = firebase.database();

    let companyId = null;
    let currentUser = null;
    let reservationsCache = {};
    let itemsCache = {};
    let warehousesCache = {};
    let departmentsCache = {};
    let workAreasCache = {};
    let projectsCache = {};
    let employeesCache = {};
    let issuesCache = {}; // Cache for issued items
    let companyData = {}; // Company information cache
    let viewingReservationId = null;
    let employeeSections = {}; // Track added employee sections
    let pendingReservations = {}; // Track pending item reservations in current modal { itemId: totalQty }

    // Tab switching function (modal tabs)
    function switchReservationTab(tabName) {
      document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.querySelector(`.modal-tab[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Page-level tab switching function
    function switchPageTab(tabName) {
      document.querySelectorAll('.page-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.page-tab-panel').forEach(panel => panel.classList.remove('active'));
      document.querySelector(`.page-tab[data-page-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`pageTab-${tabName}`).classList.add('active');
      
      // Render appropriate content when switching tabs
      if (tabName === 'pending-issue') {
        renderPendingIssue();
      } else if (tabName === 'issued') {
        renderIssuedItems();
      }
    }

    // Render issued items list
    function renderIssuedItems() {
      const tbody = document.getElementById('issuedTableBody');
      const search = (document.getElementById('issuedSearch')?.value || '').toLowerCase();
      const dateFrom = document.getElementById('issuedDateFrom')?.value;
      const dateTo = document.getElementById('issuedDateTo')?.value;

      // Get current user UID
      const currentUserUid = currentUser?.uid || window.authManager?.currentUser?.uid;

      // Get all issued items from cache, filtered by user's reservations
      let issuedItems = Object.entries(issuesCache)
        .map(([id, issue]) => ({ id, ...issue }))
        .filter(issue => {
          // Check if the issue belongs to user's reservation
          const reservation = reservationsCache[issue.reservationId];
          if (reservation?.requestedBy?.uid) {
            return reservation.requestedBy.uid === currentUserUid;
          }
          return false;
        });

      // Apply date filter
      if (dateFrom) {
        const fromTimestamp = new Date(dateFrom).setHours(0, 0, 0, 0);
        issuedItems = issuedItems.filter(item => item.issuedAt >= fromTimestamp);
      }
      if (dateTo) {
        const toTimestamp = new Date(dateTo).setHours(23, 59, 59, 999);
        issuedItems = issuedItems.filter(item => item.issuedAt <= toTimestamp);
      }

      // Apply search filter
      if (search) {
        issuedItems = issuedItems.filter(item =>
          (item.reservationNumber || '').toLowerCase().includes(search) ||
          (item.employeeName || '').toLowerCase().includes(search) ||
          (item.itemName || '').toLowerCase().includes(search) ||
          (item.issuedBy?.name || '').toLowerCase().includes(search)
        );
      }

      // Sort by issue date (newest first)
      issuedItems.sort((a, b) => (b.issuedAt || 0) - (a.issuedAt || 0));

      // Update badge count
      const badgeCount = document.getElementById('issuedCount');
      if (badgeCount) {
        badgeCount.textContent = Object.keys(issuesCache).length;
      }

      if (issuedItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-clipboard-check"></i><p>No issued items found</p></td></tr>';
        return;
      }

      tbody.innerHTML = issuedItems.map(item => {
        const issueDate = item.issuedAt ? new Date(item.issuedAt).toLocaleString() : '-';
        
        // Use saved job title from issue record, fallback to cache lookup (sanitized)
        let employeeJobTitle = resolveJobTitle(item.employeeJobTitle || '');
        if (!employeeJobTitle) {
          const empId = item.employeeId || '';
          if (empId && employeesCache[empId]) {
            const emp = employeesCache[empId];
            employeeJobTitle = resolveJobTitle(emp.jobTitle || emp.position || emp.role || '');
          }
        }
        
        return `
          <tr data-issue-id="${item.id}" style="cursor:pointer;">
            <td>${issueDate}</td>
            <td><strong>${escapeHtml(item.reservationNumber || '-')}</strong></td>
            <td>
              <div style="font-weight:500;">${escapeHtml(item.employeeName || '-')}</div>
              <div style="font-size:0.7rem; color:#64748b;">${escapeHtml(employeeJobTitle || '-')}</div>
            </td>
            <td>${escapeHtml(item.itemName || '-')}</td>
            <td>
              <div style="font-weight:600;">${item.quantityIssued || 0} ${escapeHtml(item.unit || '')}</div>
            </td>
            <td>${escapeHtml(item.issuedBy?.name || '-')}</td>
          </tr>
        `;
      }).join('');

      // Add click event listeners to issued rows
      tbody.querySelectorAll('tr[data-issue-id]').forEach(row => {
        row.addEventListener('click', function() {
          console.log('Row clicked, issue ID:', this.dataset.issueId);
          const issueId = this.dataset.issueId;
          openIssueDetailModal(issueId);
        });
      });
    }

    // Render pending issue list (approved reservations ready for issue)
    function renderPendingIssue() {
      const tbody = document.getElementById('pendingIssueTableBody');
      const search = (document.getElementById('pendingIssueSearch')?.value || '').toLowerCase();

      // Get current user UID
      const currentUserUid = currentUser?.uid || window.authManager?.currentUser?.uid;

      // Get only approved reservations created by current user
      let approvedReservations = Object.entries(reservationsCache)
        .map(([id, r]) => ({ id, ...r }))
        .filter(r => r.status === 'approved' && r.requestedBy?.uid === currentUserUid);

      // Flatten to individual employee items for issue tracking
      let pendingIssueItems = [];
      approvedReservations.forEach(reservation => {
        if (reservation.employeeReservations && Array.isArray(reservation.employeeReservations)) {
          reservation.employeeReservations.forEach(empRes => {
            if (empRes.items && Array.isArray(empRes.items)) {
              empRes.items.forEach((item, itemIdx) => {
                // Check if this item has already been issued
                const issuedQty = item.issuedQuantity || 0;
                const requestedQty = parseInt(item.quantity) || 0;
                const remainingQty = requestedQty - issuedQty;
                
                if (remainingQty > 0) {
                  // Use saved job title from reservation data, fallback to cache lookup (sanitized)
                  let employeeJobTitle = resolveJobTitle(empRes.employeeJobTitle || '');
                  if (!employeeJobTitle) {
                    const empId = empRes.employeeId || empRes.uid || '';
                    if (empId && employeesCache[empId]) {
                      const emp = employeesCache[empId];
                      employeeJobTitle = resolveJobTitle(emp.jobTitle || emp.position || emp.role || '');
                    }
                  }
                  
                  pendingIssueItems.push({
                    reservationId: reservation.id,
                    reservationNumber: reservation.reservationNumber || reservation.id.substring(0, 8),
                    requestedBy: reservation.requestedBy?.name || 'Unknown',
                    employeeName: empRes.employeeName || 'Unknown',
                    employeeJobTitle: employeeJobTitle,
                    employeeId: empRes.employeeId || '-',
                    itemName: item.itemName || item.name || 'Unknown Item',
                    itemId: item.itemId || item.id || '',
                    requestedQuantity: requestedQty,
                    issuedQuantity: issuedQty,
                    remainingQuantity: remainingQty,
                    unit: item.unit || '-',
                    requiredDate: reservation.requiredDate,
                    empIndex: reservation.employeeReservations.indexOf(empRes),
                    itemIndex: itemIdx
                  });
                }
              });
            }
          });
        }
      });

      // Apply search filter
      if (search) {
        pendingIssueItems = pendingIssueItems.filter(item =>
          item.reservationNumber.toLowerCase().includes(search) ||
          item.requestedBy.toLowerCase().includes(search) ||
          item.employeeName.toLowerCase().includes(search) ||
          item.itemName.toLowerCase().includes(search)
        );
      }

      // Update badge count
      const badgeCount = document.getElementById('pendingIssueCount');
      if (badgeCount) {
        badgeCount.textContent = pendingIssueItems.length;
      }

      if (pendingIssueItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-box-open"></i><p>No pending items to issue</p></td></tr>';
        return;
      }

      tbody.innerHTML = pendingIssueItems.map(item => {
        const requiredDate = item.requiredDate ? new Date(item.requiredDate).toLocaleDateString() : '-';
        return `
          <tr>
            <td><strong>${escapeHtml(item.reservationNumber)}</strong></td>
            <td>${escapeHtml(item.requestedBy)}</td>
            <td>
              <div style="font-weight:500;">${escapeHtml(item.employeeName)}</div>
              <div style="font-size:0.7rem; color:#64748b;">${escapeHtml(item.employeeJobTitle || '-')}</div>
            </td>
            <td>${escapeHtml(item.itemName)}</td>
            <td>
              <div style="font-weight:600;">${item.remainingQuantity} ${escapeHtml(item.unit)}</div>
              <div style="font-size:0.65rem; color:#64748b;">of ${item.requestedQuantity} requested</div>
            </td>
            <td>${requiredDate}</td>
            <td class="right">
              <button class="btn btn-sm btn-success" onclick="openIssueModal('${item.reservationId}')" title="Issue Items">
                <i class="fas fa-dolly"></i> Issue
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Open issue modal showing all items for a reservation
    function openIssueModal(reservationId) {
      const reservation = reservationsCache[reservationId];
      if (!reservation) {
        alert('Reservation not found');
        return;
      }

      // Populate reservation info
      document.getElementById('issueReservationNumber').textContent = reservation.reservationNumber || reservationId.substring(0, 8);
      document.getElementById('issueRequestedBy').textContent = reservation.requestedBy?.name || 'Unknown';
      document.getElementById('issueRequiredDate').textContent = reservation.requiredDate ? new Date(reservation.requiredDate).toLocaleDateString() : '-';

      // Build items table
      const tbody = document.getElementById('issueItemsTableBody');
      let tableRows = '';
      let hasItems = false;

      if (reservation.employeeReservations && Array.isArray(reservation.employeeReservations)) {
        reservation.employeeReservations.forEach((empRes, empIndex) => {
          if (empRes.items && Array.isArray(empRes.items)) {
            empRes.items.forEach((item, itemIndex) => {
              const issuedQty = item.issuedQuantity || 0;
              const requestedQty = parseInt(item.quantity) || 0;
              const remainingQty = requestedQty - issuedQty;

              // Only show items that still need to be issued
              if (remainingQty > 0) {
                hasItems = true;
                
                // Use saved job title from reservation data, fallback to cache lookup (sanitized)
                let employeeJobTitle = resolveJobTitle(empRes.employeeJobTitle || '');
                if (!employeeJobTitle) {
                  const empId = empRes.employeeId || empRes.uid || '';
                  if (empId && employeesCache[empId]) {
                    const emp = employeesCache[empId];
                    employeeJobTitle = resolveJobTitle(emp.jobTitle || emp.position || emp.role || '');
                  }
                }

                tableRows += `
                  <tr data-emp-index="${empIndex}" data-item-index="${itemIndex}" data-remaining-qty="${remainingQty}">
                    <td style="padding:0.5rem; text-align:center; border-bottom:1px solid #f1f5f9;">
                      <input type="checkbox" class="issue-item-checkbox" checked />
                    </td>
                    <td style="padding:0.5rem; border-bottom:1px solid #f1f5f9;">
                      <div style="font-weight:500;">${escapeHtml(empRes.employeeName || 'Unknown')}</div>
                      <div style="font-size:0.7rem; color:#64748b;">${escapeHtml(employeeJobTitle || '-')}</div>
                    </td>
                    <td style="padding:0.5rem; border-bottom:1px solid #f1f5f9;">
                      <div style="font-weight:500;">${escapeHtml(item.itemName || item.name || 'Unknown')}</div>
                      <div style="font-size:0.7rem; color:#64748b;">${escapeHtml(item.unit || '-')}</div>
                    </td>
                    <td style="padding:0.5rem; text-align:center; border-bottom:1px solid #f1f5f9; font-weight:600; color:#2563eb;">${requestedQty}</td>
                    <td style="padding:0.5rem; text-align:center; border-bottom:1px solid #f1f5f9; font-weight:600; color:#16a34a;">${issuedQty}</td>
                    <td style="padding:0.5rem; text-align:center; border-bottom:1px solid #f1f5f9; font-weight:600; color:#d97706;">${remainingQty}</td>
                    <td style="padding:0.5rem; text-align:center; border-bottom:1px solid #f1f5f9;">
                      <input type="number" class="issue-qty-input" 
                             value="${remainingQty}" min="1" max="${remainingQty}" 
                             style="width:70px; padding:0.3rem; text-align:center; font-weight:600; border:1px solid #e2e8f0; border-radius:4px;" />
                    </td>
                  </tr>
                `;
              }
            });
          }
        });
      }

      if (!hasItems) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:2rem; color:#94a3b8;"><i class="fas fa-check-circle" style="color:#16a34a; margin-right:0.5rem;"></i>All items have been issued</td></tr>';
      } else {
        tbody.innerHTML = tableRows;
      }

      // Populate "Issued By" dropdown with employees
      const issuedBySelect = document.getElementById('issuedBySelect');
      let employeeOptions = '<option value="">Select who is issuing...</option>';
      
      const employeeList = Object.entries(employeesCache)
        .filter(([id, emp]) => emp && emp.status !== 'inactive')
        .map(([id, emp]) => {
          const name = emp.fullName || emp.displayName || emp.name || emp.email || 'Unknown';
          let jobTitle = emp.jobTitle || emp.position || emp.role || '';
          if (jobTitle && typeof jobTitle === 'object') {
            jobTitle = jobTitle.label || jobTitle.name || jobTitle.value || '';
          }
          return { id, name, jobTitle };
        })
        .sort((a, b) => a.name.localeCompare(b.name));

      employeeList.forEach(emp => {
        const displayText = emp.jobTitle ? `${emp.name} - ${emp.jobTitle}` : emp.name;
        const isCurrentUser = currentUser && (emp.id === currentUser.uid);
        employeeOptions += `<option value="${emp.id}" ${isCurrentUser ? 'selected' : ''}>${escapeHtml(displayText)}</option>`;
      });
      issuedBySelect.innerHTML = employeeOptions;

      // Clear notes
      document.getElementById('issueNotes').value = '';

      // Store reservation ID
      document.getElementById('issueReservationId').value = reservationId;

      // Reset select all checkbox
      const selectAllCheckbox = document.getElementById('issueSelectAll');
      if (selectAllCheckbox) selectAllCheckbox.checked = hasItems;

      // Clear any previous messages
      document.getElementById('issueModalError').classList.remove('show');
      document.getElementById('issueModalSuccess').classList.remove('show');

      // Show modal
      document.getElementById('issueModal').classList.add('show');
    }

    // Toggle all issue item checkboxes
    function toggleAllIssueItems(checked) {
      document.querySelectorAll('.issue-item-checkbox').forEach(cb => {
        cb.checked = checked;
      });
    }

    // Close issue modal
    function closeIssueModal() {
      document.getElementById('issueModal').classList.remove('show');
    }

    // Open Issue Detail Modal
    function openIssueDetailModal(issueId) {
      try {
        console.log('Opening issue detail modal for:', issueId);
        console.log('Issues cache:', issuesCache);
        
        const issue = issuesCache[issueId];
        if (!issue) {
          console.error('Issue not found in cache for ID:', issueId);
          alert('Issue record not found');
          return;
        }

        // Check if modal elements exist
        const modal = document.getElementById('issueDetailModal');
        if (!modal) {
          console.error('Issue detail modal element not found');
          alert('Modal element not found');
          return;
        }

        console.log('Found issue:', issue);

        // Set company info with safe fallbacks
        const companyName = (typeof companyData === 'object' && companyData) ? 
          (companyData.name || companyData.companyName || 'Company') : 'Company';
        const companyNameEl = document.getElementById('issueDetailCompanyName');
        if (companyNameEl) {
          companyNameEl.textContent = companyName;
        }
        
        // Set logo with safe fallbacks
        const logoUrl = (typeof companyData === 'object' && companyData) ? 
          (companyData.logoUrl || companyData.logo || '') : '';
        const logoImg = document.getElementById('issueDetailLogo');
        const logoFallback = document.getElementById('issueDetailLogoFallback');
        if (logoImg && logoFallback) {
          if (logoUrl) {
            logoImg.src = logoUrl;
            logoImg.style.display = 'block';
            logoFallback.style.display = 'none';
          } else {
            logoImg.style.display = 'none';
            logoFallback.style.display = 'flex';
            logoFallback.textContent = companyName.substring(0, 2).toUpperCase();
          }
        }

        // Set generated date
        const generatedEl = document.getElementById('issueDetailGenerated');
        if (generatedEl) {
          generatedEl.innerHTML = `Generated: ${new Date().toLocaleString()}`;
        }

        // Set document number
        const docNumberEl = document.getElementById('issueDetailDocNumber');
        if (docNumberEl) {
          docNumberEl.textContent = issueId.substring(0, 12).toUpperCase();
        }

        // Build sections HTML
        let sectionsHtml = '';

        // Issue Information Section
        const issueDate = issue.issuedAt ? new Date(issue.issuedAt).toLocaleString() : '-';
        sectionsHtml += `
          <div class="res-section-title request-section">
            <i class="fas fa-dolly"></i>
            <span class="section-text">Issue Information</span>
          </div>
          <div class="res-info-grid">
            <div class="res-info-item">
              <span class="label">Issue Date</span>
              <span class="value">${issueDate}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Issued By</span>
              <span class="value">${escapeHtml(issue.issuedBy?.name || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Notes</span>
              <span class="value">${escapeHtml(issue.notes || '-')}</span>
            </div>
          </div>
        `;

        // Employee Information Section
        let employeeJobTitle = resolveJobTitle(issue.employeeJobTitle || '');
        let realEmployeeId = '';
        const empId = issue.employeeId || '';
        if (empId && employeesCache[empId]) {
          const emp = employeesCache[empId];
          if (!employeeJobTitle) {
            employeeJobTitle = resolveJobTitle(emp.jobTitle || emp.position || emp.role || '');
          }
          // Get real employee ID (staff ID / employee number)
          realEmployeeId = emp.employeeId || emp.staffId || emp.employeeNumber || emp.empId || '-';
        }
        sectionsHtml += `
          <div class="res-section-title items-section">
            <i class="fas fa-user"></i>
            <span class="section-text">Recipient Information</span>
          </div>
          <div class="res-info-grid">
            <div class="res-info-item">
              <span class="label">Employee Name</span>
              <span class="value">${escapeHtml(issue.employeeName || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Job Title</span>
              <span class="value">${escapeHtml(employeeJobTitle || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Employee ID</span>
              <span class="value">${escapeHtml(realEmployeeId || '-')}</span>
            </div>
          </div>
        `;

        // Item Details Section
        const itemData = itemsCache[issue.itemId] || {};
        const realItemId = itemData.sku || itemData.itemCode || itemData.code || itemData.productCode || '-';
        sectionsHtml += `
          <div class="res-section-title delivery-section">
            <i class="fas fa-box"></i>
            <span class="section-text">Item Details</span>
          </div>
          <div class="res-info-grid">
            <div class="res-info-item">
              <span class="label">Item Name</span>
              <span class="value">${escapeHtml(issue.itemName || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">SKU / Item Code</span>
              <span class="value">${escapeHtml(realItemId)}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Quantity Issued</span>
              <span class="value" style="font-weight:700; color:#16a34a;">${issue.quantityIssued || 0} ${escapeHtml(issue.unit || '')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Unit</span>
              <span class="value">${escapeHtml(issue.unit || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Category</span>
              <span class="value">${escapeHtml(itemData.category || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Current Stock</span>
              <span class="value">${itemData.currentStock || 0} ${escapeHtml(itemData.unit || '')}</span>
            </div>
          </div>
        `;

        // Reservation Link Section
        const reservation = reservationsCache[issue.reservationId] || {};
        if (reservation.id || issue.reservationId) {
          const resStatus = reservation.status || 'Unknown';
          const statusClass = resStatus.toLowerCase();
          sectionsHtml += `
            <div class="res-section-title status-section">
              <i class="fas fa-clipboard-list"></i>
              <span class="section-text">Related Reservation</span>
            </div>
            <div class="res-info-grid">
              <div class="res-info-item">
                <span class="label">Reservation Number</span>
                <span class="value">${escapeHtml(issue.reservationNumber || issue.reservationId?.substring(0, 8) || '-')}</span>
              </div>
              <div class="res-info-item">
                <span class="label">Reservation Status</span>
                <span class="value"><span class="res-status-badge ${statusClass}">${resStatus.charAt(0).toUpperCase() + resStatus.slice(1)}</span></span>
              </div>
              <div class="res-info-item">
                <span class="label">Requested By</span>
                <span class="value">${escapeHtml(reservation.requestedBy?.name || '-')}</span>
              </div>
              <div class="res-info-item">
                <span class="label">Required Date</span>
                <span class="value">${reservation.requiredDate ? new Date(reservation.requiredDate).toLocaleDateString() : '-'}</span>
              </div>
            </div>
          `;
        }

        const sectionsEl = document.getElementById('issueDetailSections');
        if (sectionsEl) {
          sectionsEl.innerHTML = sectionsHtml;
        }

        // Show modal
        console.log('Showing modal...');
        modal.classList.add('show');
        console.log('Modal should now be visible');
      } catch (error) {
        console.error('Error opening issue detail modal:', error);
        alert('Error opening modal: ' + error.message);
      }
    }

    // Close Issue Detail Modal
    function closeIssueDetailModal() {
      document.getElementById('issueDetailModal').classList.remove('show');
    }

    // Print Issue Detail
    function printIssueDetail() {
      window.print();
    }

    // Confirm issue from modal - multiple items
    async function confirmIssueMultiple() {
      const reservationId = document.getElementById('issueReservationId').value;
      const notes = document.getElementById('issueNotes').value;

      // Get selected issuer
      const issuedBySelect = document.getElementById('issuedBySelect');
      const issuedById = issuedBySelect.value;
      if (!issuedById) {
        document.getElementById('issueModalError').textContent = 'Please select who is issuing the items';
        document.getElementById('issueModalError').classList.add('show');
        return;
      }

      // Get issuer details from cache
      const issuerData = employeesCache[issuedById] || {};
      const issuerName = issuerData.fullName || issuerData.displayName || issuerData.name || issuerData.email || 'Unknown';
      const issuer = { uid: issuedById, name: issuerName };

      // Gather all selected items
      const selectedItems = [];
      document.querySelectorAll('.issue-item-checkbox:checked').forEach(cb => {
        const row = cb.closest('tr');
        const empIndex = parseInt(row.dataset.empIndex);
        const itemIndex = parseInt(row.dataset.itemIndex);
        const remainingQty = parseInt(row.dataset.remainingQty);
        const qtyInput = row.querySelector('.issue-qty-input');
        const qtyToIssue = parseInt(qtyInput.value);

        if (!isNaN(qtyToIssue) && qtyToIssue > 0) {
          if (qtyToIssue > remainingQty) {
            selectedItems.push({ empIndex, itemIndex, qtyToIssue, remainingQty, error: true });
          } else {
            selectedItems.push({ empIndex, itemIndex, qtyToIssue, remainingQty, error: false });
          }
        }
      });

      // Check if any items selected
      if (selectedItems.length === 0) {
        document.getElementById('issueModalError').textContent = 'Please select at least one item and enter a valid quantity';
        document.getElementById('issueModalError').classList.add('show');
        return;
      }

      // Check for errors
      const itemsWithErrors = selectedItems.filter(i => i.error);
      if (itemsWithErrors.length > 0) {
        document.getElementById('issueModalError').textContent = 'One or more items have quantity exceeding the remaining amount';
        document.getElementById('issueModalError').classList.add('show');
        return;
      }

      // Disable buttons during processing
      const issueBtn = document.querySelector('#issueModal .btn-success');
      issueBtn.disabled = true;
      issueBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      // Process each selected item
      try {
        for (const item of selectedItems) {
          await processItemIssue(reservationId, item.empIndex, item.itemIndex, item.qtyToIssue, notes, issuer);
        }
        closeIssueModal();
        showAlert('success', `Successfully issued ${selectedItems.length} item(s)`);
      } catch (error) {
        console.error('Error issuing items:', error);
        document.getElementById('issueModalError').textContent = 'Error issuing items: ' + error.message;
        document.getElementById('issueModalError').classList.add('show');
        issueBtn.disabled = false;
        issueBtn.innerHTML = '<i class="fas fa-check"></i> Issue Selected Items';
      }
    }

    // Process item issue
    async function processItemIssue(reservationId, empIndex, itemIndex, qtyToIssue, notes = '', issuedByData = null) {
      try {
        const reservation = reservationsCache[reservationId];
        const empRes = reservation.employeeReservations[empIndex];
        const item = empRes.items[itemIndex];

        const currentIssuedQty = item.issuedQuantity || 0;
        const newIssuedQty = currentIssuedQty + qtyToIssue;
        const requestedQty = parseInt(item.quantity) || 0;

        // Determine who is issuing (use passed data or fall back to current user)
        const issuer = issuedByData || {
          uid: currentUser?.uid || '',
          name: currentUser?.fullName || currentUser?.displayName || 'Unknown'
        };

        // Update the item's issued quantity
        const updates = {};
        updates[`companies/${companyId}/inventory/reservations/${reservationId}/employeeReservations/${empIndex}/items/${itemIndex}/issuedQuantity`] = newIssuedQty;
        updates[`companies/${companyId}/inventory/reservations/${reservationId}/employeeReservations/${empIndex}/items/${itemIndex}/lastIssuedAt`] = Date.now();
        updates[`companies/${companyId}/inventory/reservations/${reservationId}/employeeReservations/${empIndex}/items/${itemIndex}/lastIssuedBy`] = issuer;

        // Create issue record
        const issueId = db.ref().push().key;
        const issueRecord = {
          reservationId: reservationId,
          reservationNumber: reservation.reservationNumber || reservationId.substring(0, 8),
          employeeId: empRes.employeeId,
          employeeName: empRes.employeeName,
          employeeJobTitle: resolveJobTitle(empRes.employeeJobTitle || ''),
          itemId: item.itemId || item.id,
          itemName: item.itemName || item.name,
          quantityIssued: qtyToIssue,
          unit: item.unit || '-',
          notes: notes || '',
          issuedAt: Date.now(),
          issuedBy: issuer
        };
        updates[`companies/${companyId}/inventory/issues/${issueId}`] = issueRecord;

        // Reduce stock from inventory item if itemId exists
        if (item.itemId && itemsCache[item.itemId]) {
          const currentStock = parseInt(itemsCache[item.itemId].currentStock) || 0;
          const newStock = Math.max(0, currentStock - qtyToIssue);
          updates[`companies/${companyId}/inventory/items/${item.itemId}/currentStock`] = newStock;
        }

        // Check if all items in the reservation are fully issued
        let allItemsFullyIssued = true;
        reservation.employeeReservations.forEach((emp, eIdx) => {
          emp.items?.forEach((itm, iIdx) => {
            if (eIdx === empIndex && iIdx === itemIndex) {
              // Use the new issued quantity for this item
              if (newIssuedQty < requestedQty) {
                allItemsFullyIssued = false;
              }
            } else {
              const itmIssuedQty = itm.issuedQuantity || 0;
              const itmRequestedQty = parseInt(itm.quantity) || 0;
              if (itmIssuedQty < itmRequestedQty) {
                allItemsFullyIssued = false;
              }
            }
          });
        });

        // If all items are fully issued, mark reservation as completed
        if (allItemsFullyIssued) {
          updates[`companies/${companyId}/inventory/reservations/${reservationId}/status`] = 'completed';
          updates[`companies/${companyId}/inventory/reservations/${reservationId}/completedAt`] = Date.now();
        }

        await db.ref().update(updates);

        // Update local cache
        if (!reservationsCache[reservationId].employeeReservations[empIndex].items[itemIndex].issuedQuantity) {
          reservationsCache[reservationId].employeeReservations[empIndex].items[itemIndex].issuedQuantity = 0;
        }
        reservationsCache[reservationId].employeeReservations[empIndex].items[itemIndex].issuedQuantity = newIssuedQty;

        if (allItemsFullyIssued) {
          reservationsCache[reservationId].status = 'completed';
        }

        // Update issues cache with the new issue record
        issuesCache[issueId] = issueRecord;

        // Close the issue modal
        closeIssueModal();

        // Refresh views
        updateStats();
        renderReservations();
        renderPendingIssue();
        updatePendingIssueBadge();
        updateIssuedBadge();

        alert(`Successfully issued ${qtyToIssue} ${item.unit || 'unit(s)'} of "${item.itemName || item.name}" to ${empRes.employeeName}`);
      } catch (err) {
        console.error('Error processing issue:', err);
        // Show error in modal if it's open
        const errorEl = document.getElementById('issueModalError');
        if (errorEl && document.getElementById('issueModal').classList.contains('show')) {
          errorEl.textContent = 'Failed to process issue. Please try again.';
          errorEl.classList.add('show');
        } else {
          alert('Failed to process issue. Please try again.');
        }
      }
    }

    // AuthManager class
    class AuthManager {
      constructor() {
        this.currentUser = this.getCurrentUser();
        this.currentCompany = null;
        this.init();
      }
      getCurrentUser() {
        try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; }
      }
      setCurrentUser(u) {
        localStorage.setItem('currentUser', JSON.stringify(u));
        localStorage.setItem('user', JSON.stringify(u));
        this.currentUser = u;
      }
      async init() {
        if (!this.currentUser) {
          window.location.href = 'login.html';
          return;
        }
        await this.loadUserCompany();
        this.updateCompanyBranding();
        await this.updateUIForAuthenticatedUser();
        this.bindProfileDropdown();
        loadPageData();
      }
      async loadUserCompany() {
        if (!this.currentUser) return;
        try {
          const snap = await firebase.database().ref('companies').once('value');
          if (!snap.exists()) return;
          const companies = snap.val();
          for (const [cid, comp] of Object.entries(companies)) {
            if (comp.status !== 'active') continue;
            if (comp.users) {
              for (const [uid, u] of Object.entries(comp.users)) {
                if (u.authUid === this.currentUser.uid || uid === this.currentUser.uid) {
                  this.currentUser.companyId = cid;
                  this.currentUser.companyName = comp.companyName;
                  this.currentUser.role = u.role || u.userRole || 'user';
                  this.currentCompany = comp;
                  this.setCurrentUser(this.currentUser);
                  companyId = cid;
                  currentUser = this.currentUser;
                  return;
                }
              }
            }
          }
        } catch (e) { console.error('Error loading company:', e); }
      }
      updateCompanyBranding() {
        const logoEl = document.getElementById('headerCompanyLogo');
        const nameEl = document.getElementById('headerCompanyName');
        if (!this.currentCompany) { this.showFallbackBranding(); return; }
        if (nameEl) nameEl.textContent = this.currentCompany.companyName || 'Material Reservations';
        const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
        if (logoEl) {
          if (logoUrl) { logoEl.src = logoUrl; logoEl.style.display = 'block'; }
          else { logoEl.src = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || '')); logoEl.style.display = 'block'; }
        }
      }
      showFallbackBranding() {
        const logoEl = document.getElementById('headerCompanyLogo');
        if (logoEl) { logoEl.src = this.generateCompanyInitialsSVG('DX'); logoEl.style.display = 'block'; }
      }
      getCompanyInitials(name) {
        if (!name) return 'CO';
        const parts = name.trim().split(/\s+/);
        return parts.length === 1 ? parts[0].substring(0, 2).toUpperCase() : (parts[0][0] + parts[1][0]).toUpperCase();
      }
      generateCompanyInitialsSVG(initials) {
        const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
        return 'data:image/svg+xml;base64,' + btoa(svg);
      }
      getUserDisplayName() {
        if (!this.currentUser) return 'User';
        const n = v => typeof v === 'string' ? v.trim() : '';
        const cand = [this.currentUser.displayName, this.currentUser.name, this.currentUser.username];
        for (const c of cand) { if (n(c)) return n(c); }
        return this.currentUser.email ? n(this.currentUser.email.split('@')[0]) || 'User' : 'User';
      }
      getUserInitials() {
        const dn = this.getUserDisplayName();
        const parts = dn.split(' ').filter(Boolean);
        return parts.length === 1 ? parts[0].substring(0, 2).toUpperCase() : parts.slice(0, 2).map(p => p[0]).join('').toUpperCase();
      }
      async updateUIForAuthenticatedUser() {
        const btn = document.getElementById('userProfileBtn');
        const list = document.querySelector('.profile-dropdown ul');
        if (!btn || !list || !this.currentUser) return;
        const displayName = this.getUserDisplayName();
        const email = this.currentUser.email || '';
        btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
        const avatarHtml = `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
        list.innerHTML = `<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>`;
        list.querySelector('#logoutLink')?.addEventListener('click', e => { e.preventDefault(); this.logout(); });
      }
      bindProfileDropdown() {
        const btn = document.getElementById('userProfileBtn');
        const dd = document.querySelector('.profile-dropdown');
        if (btn && dd) {
          btn.addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('show'); });
          document.addEventListener('click', e => { if (!btn.contains(e.target)) dd.classList.remove('show'); });
        }
      }
      async logout() {
        try { await firebase.auth().signOut(); } catch (e) {}
        localStorage.removeItem('currentUser');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      window.authManager = new AuthManager();

      document.getElementById('sidebarToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('sidebar-collapsed');
      });

      document.getElementById('notificationBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelector('.notification-dropdown').classList.toggle('show');
      });

      document.addEventListener('click', () => {
        document.querySelector('.notification-dropdown')?.classList.remove('show');
      });

      // Filters
      document.getElementById('searchBox').addEventListener('input', renderReservations);
      document.getElementById('statusFilter').addEventListener('change', renderReservations);
      document.getElementById('pendingIssueSearch').addEventListener('input', renderPendingIssue);
      document.getElementById('issuedSearch').addEventListener('input', renderIssuedItems);
      document.getElementById('issuedDateFrom').addEventListener('change', renderIssuedItems);
      document.getElementById('issuedDateTo').addEventListener('change', renderIssuedItems);

      // Set default date
      document.getElementById('reservationDate').valueAsDate = new Date();
    });

    // Load page data
    async function loadPageData() {
      if (!companyId) { setTimeout(loadPageData, 500); return; }

      try {
        const [reservationsSnap, itemsSnap, warehousesSnap, departmentsSnap, workAreasSnap, employeesSnap, issuesSnap] = await Promise.all([
          db.ref(`companies/${companyId}/inventory/reservations`).once('value'),
          db.ref(`companies/${companyId}/inventory/items`).once('value'),
          db.ref(`companies/${companyId}/inventory/warehouses`).once('value'),
          db.ref(`companies/${companyId}/settings/fieldOptions/department`).once('value'),
          db.ref(`companies/${companyId}/settings/fieldOptions/area`).once('value'),
          db.ref(`companies/${companyId}/users`).once('value'),
          db.ref(`companies/${companyId}/inventory/issues`).once('value')
        ]);

        reservationsCache = reservationsSnap.val() || {};
        itemsCache = itemsSnap.val() || {};
        warehousesCache = warehousesSnap.val() || {};
        departmentsCache = departmentsSnap.val() || {};
        workAreasCache = workAreasSnap.val() || {};
        employeesCache = employeesSnap.val() || {};
        issuesCache = issuesSnap.val() || {};

        // Fallback: try alternative path for work areas if empty
        if (!workAreasCache || Object.keys(workAreasCache).length === 0) {
          const altWorkAreasSnap = await db.ref(`companies/${companyId}/fieldOptions/area`).once('value');
          workAreasCache = altWorkAreasSnap.val() || {};
        }
        
        // Fallback: try alternative path for departments if empty
        if (!departmentsCache || Object.keys(departmentsCache).length === 0) {
          const altDepartmentsSnap = await db.ref(`companies/${companyId}/fieldOptions/department`).once('value');
          departmentsCache = altDepartmentsSnap.val() || {};
        }

        updateStats();
        renderReservations();
        updatePendingIssueBadge(); // Update pending issue count badge
        updateIssuedBadge(); // Update issued count badge
        updateDropdowns();
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    // Update all dropdown options
    function updateDropdowns() {
      // Cost Center / Department dropdown
      const costCenterSelect = document.getElementById('reservationCostCenter');
      let departments = [];
      // Normalize departments which may be arrays or maps with label/name/value
      if (Array.isArray(departmentsCache)) {
        departments = departmentsCache
          .filter(d => d)
          .map(d => typeof d === 'string' ? d : (d.label || d.name || d.value || ''))
          .filter(v => v);
      } else if (departmentsCache && typeof departmentsCache === 'object') {
        departments = Object.values(departmentsCache)
          .filter(d => d)
          .map(d => typeof d === 'string' ? d : (d.label || d.name || d.value || ''))
          .filter(v => v);
      } else {
        // Fallback to localStorage where settings may have cached options
        try {
          const lsKeyCompany = companyId ? `fieldOptions_${companyId}_department` : null;
          const lsKeyGlobal = `fieldOptions_department`;
          const raw = (lsKeyCompany && localStorage.getItem(lsKeyCompany)) || localStorage.getItem(lsKeyGlobal);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              departments = parsed.map(d => typeof d === 'string' ? d : (d.label || d.name || d.value || ''))
                                  .filter(v => v);
            }
          }
        } catch {}
      }
      costCenterSelect.innerHTML = '<option value="">Select Cost Center</option>' + 
        departments.map(d => `<option value="${d}">${escapeHtml(d)}</option>`).join('');

      // Delivery Location / Work Area dropdown
      const deliveryLocationSelect = document.getElementById('deliveryLocation');
      let areas = [];
      // Normalize workAreasCache which may be an array of strings/objects or an object map
      if (Array.isArray(workAreasCache)) {
        areas = workAreasCache
          .filter(a => a)
          .map(a => typeof a === 'string' ? a : (a.label || a.name || a.value || ''))
          .filter(v => v);
      } else if (workAreasCache && typeof workAreasCache === 'object') {
        areas = Object.values(workAreasCache)
          .filter(a => a)
          .map(a => typeof a === 'string' ? a : (a.label || a.name || a.value || ''))
          .filter(v => v);
      } else {
        // Fallback to localStorage where settings may have cached options
        try {
          const lsKeyCompany = companyId ? `fieldOptions_${companyId}_area` : null;
          const lsKeyGlobal = `fieldOptions_area`;
          const raw = (lsKeyCompany && localStorage.getItem(lsKeyCompany)) || localStorage.getItem(lsKeyGlobal);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              areas = parsed.map(a => typeof a === 'string' ? a : (a.label || a.name || a.value || ''))
                            .filter(v => v);
            }
          }
        } catch {}
      }
      deliveryLocationSelect.innerHTML = '<option value="">Select Location</option>' + 
        areas.map(a => `<option value="${a}">${escapeHtml(a)}</option>`).join('');

      // Employee dropdown
      const employeeSelect = document.getElementById('employeeSelect');
      if (employeeSelect) {
        let employees = [];
        if (employeesCache && typeof employeesCache === 'object') {
          employees = Object.entries(employeesCache)
            .filter(([id, emp]) => emp && emp.status !== 'inactive')
            .map(([id, emp]) => ({
              id,
              name: emp.displayName || emp.name || emp.firstName && emp.lastName ? `${emp.firstName} ${emp.lastName}` : emp.email || 'Unknown',
              email: emp.email || '',
              department: emp.department || '',
              employeeId: emp.employeeId || emp.staffId || '',
              jobTitle: emp.jobTitle || emp.position || ''
            }))
            .sort((a, b) => a.name.localeCompare(b.name));
        }
        employeeSelect.innerHTML = '<option value="">Choose an employee...</option>' + 
          employees.map(e => `<option value="${e.id}" data-name="${escapeHtml(e.name)}" data-email="${escapeHtml(e.email)}" data-empid="${escapeHtml(e.employeeId)}" data-jobtitle="${escapeHtml(e.jobTitle)}">${escapeHtml(e.name)}${e.employeeId ? ` (${e.employeeId})` : ''}</option>`).join('');
      }
    }

    // Update stats
    function updateStats() {
      const allReservations = Object.values(reservationsCache);
      
      // Filter to show only user's reservations in stats
      const currentUserUid = currentUser?.uid || window.authManager?.currentUser?.uid;
      const reservations = allReservations.filter(r => {
        if (r.requestedBy?.uid) {
          return r.requestedBy.uid === currentUserUid;
        }
        return false;
      });

      const pending = reservations.filter(r => r.status === 'pending').length;
      const approved = reservations.filter(r => r.status === 'approved').length;
      const completed = reservations.filter(r => r.status === 'completed').length;

      document.getElementById('totalReservations').textContent = reservations.length;
      document.getElementById('pendingReservations').textContent = pending;
      document.getElementById('approvedReservations').textContent = approved;
      document.getElementById('completedReservations').textContent = completed;
    }

    // Update pending issue badge count
    function updatePendingIssueBadge() {
      let pendingIssueCount = 0;
      
      // Get current user UID
      const currentUserUid = currentUser?.uid || window.authManager?.currentUser?.uid;
      
      // Get only approved reservations created by current user
      const approvedReservations = Object.values(reservationsCache).filter(r => 
        r.status === 'approved' && r.requestedBy?.uid === currentUserUid
      );
      
      approvedReservations.forEach(reservation => {
        if (reservation.employeeReservations && Array.isArray(reservation.employeeReservations)) {
          reservation.employeeReservations.forEach(empRes => {
            if (empRes.items && Array.isArray(empRes.items)) {
              empRes.items.forEach(item => {
                const issuedQty = item.issuedQuantity || 0;
                const requestedQty = parseInt(item.quantity) || 0;
                if (requestedQty > issuedQty) {
                  pendingIssueCount++;
                }
              });
            }
          });
        }
      });
      
      const badgeCount = document.getElementById('pendingIssueCount');
      if (badgeCount) {
        badgeCount.textContent = pendingIssueCount;
      }
    }

    // Update issued badge count
    function updateIssuedBadge() {
      // Get current user UID
      const currentUserUid = currentUser?.uid || window.authManager?.currentUser?.uid;
      
      // Count only issues from user's reservations
      const userIssuesCount = Object.values(issuesCache).filter(issue => {
        const reservation = reservationsCache[issue.reservationId];
        return reservation?.requestedBy?.uid === currentUserUid;
      }).length;
      
      const badgeCount = document.getElementById('issuedCount');
      if (badgeCount) {
        badgeCount.textContent = userIssuesCount;
      }
    }

    // Render reservations table
    function renderReservations() {
      const tbody = document.getElementById('reservationsTableBody');
      const search = (document.getElementById('searchBox').value || '').toLowerCase();
      const status = document.getElementById('statusFilter').value;

      // Get current user UID
      const currentUserUid = currentUser?.uid || window.authManager?.currentUser?.uid;
      
      // Filter to show only reservations created by the current user
      let reservations = Object.entries(reservationsCache)
        .map(([id, r]) => ({ id, ...r }))
        .filter(r => {
          // Check if requestedBy.uid matches current user
          if (r.requestedBy?.uid) {
            return r.requestedBy.uid === currentUserUid;
          }
          return false; // Hide reservations without requestedBy (legacy data)
        });

      // Filter by search
      if (search) {
        reservations = reservations.filter(r =>
          (r.reservationNumber || '').toLowerCase().includes(search) ||
          (r.project || '').toLowerCase().includes(search) ||
          (r.purpose || '').toLowerCase().includes(search) ||
          (r.requestedBy?.name || '').toLowerCase().includes(search)
        );
      }
      if (status !== 'all') {
        reservations = reservations.filter(r => r.status === status);
      }

      // Sort by date (newest first)
      reservations.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

      if (reservations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-clipboard-list"></i><p>No reservations found</p></td></tr>';
        return;
      }

      tbody.innerHTML = reservations.map(r => {
        const itemCount = r.employeeReservations?.reduce((sum, emp) => sum + (emp.items?.length || 0), 0) || r.items?.length || 0;
        const requiredDate = r.requiredDate ? new Date(r.requiredDate).toLocaleDateString() : '-';
        const statusClass = r.status || 'pending';

        return `
          <tr onclick="viewReservation('${r.id}')">
            <td><strong>${escapeHtml(r.reservationNumber || r.id.substring(0, 8))}</strong></td>
            <td>${escapeHtml(r.requestedBy?.name || 'Unknown')}</td>
            <td>${escapeHtml(r.costCenter || r.purpose?.substring(0, 30) || '-')}</td>
            <td>${itemCount} item(s)</td>
            <td>${requiredDate}</td>
            <td><span class="badge ${statusClass}">${capitalize(r.status || 'pending')}</span></td>
            <td class="right">
              <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewReservation('${r.id}')" title="View">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Open reservation modal
    function openReservationModal(isEditing = false) {
      const modal = document.getElementById('reservationModal');
      document.getElementById('reservationForm').reset();
      document.getElementById('modalError').classList.remove('show');
      document.getElementById('modalSuccess').classList.remove('show');
      document.getElementById('employeesContainer').innerHTML = '';
      document.getElementById('reservationDate').valueAsDate = new Date();
      employeeSections = {}; // Reset employee sections
      pendingReservations = {}; // Reset pending reservations tracking
      
      // Update modal title based on mode
      const modalTitle = modal.querySelector('.modal-title');
      if (modalTitle) {
        modalTitle.innerHTML = isEditing ? '<i class="fas fa-edit"></i> Edit Reservation' : '<i class="fas fa-plus-circle"></i> New Reservation';
      }
      
      // Update submit button text
      const submitBtn = modal.querySelector('.modal-footer .btn-primary');
      if (submitBtn) {
        submitBtn.innerHTML = isEditing ? '<i class="fas fa-save"></i> Update Reservation' : '<i class="fas fa-paper-plane"></i> Submit Reservation';
      }
      
      // Reset to first tab
      switchReservationTab('request');

      modal.classList.add('show');
    }

    // Close reservation modal
    function closeReservationModal() {
      document.getElementById('reservationModal').classList.remove('show');
      employeeSections = {}; // Reset employee sections
      window.editingReservationId = null; // Reset editing flag
    }

    // Get employee initials
    function getEmployeeInitials(name) {
      if (!name) return '??';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    // Add employee section
    function addEmployeeSection() {
      const employeeSelect = document.getElementById('employeeSelect');
      const selectedOption = employeeSelect.selectedOptions[0];
      
      if (!selectedOption || !selectedOption.value) {
        alert('Please select an employee first.');
        return;
      }

      const employeeId = selectedOption.value;
      const employeeName = selectedOption.dataset.name || selectedOption.textContent;
      const employeeEmail = selectedOption.dataset.email || '';
      const employeeEmpId = selectedOption.dataset.empid || '';
      const employeeJobTitle = resolveJobTitle(selectedOption.dataset.jobtitle || '');

      // Check if employee already added
      if (employeeSections[employeeId]) {
        alert('This employee has already been added.');
        return;
      }

      const sectionId = `emp-section-${employeeId}`;
      employeeSections[employeeId] = { name: employeeName, email: employeeEmail, empId: employeeEmpId, jobTitle: employeeJobTitle, items: [] };

      const container = document.getElementById('employeesContainer');
      const section = document.createElement('div');
      section.className = 'employee-section';
      section.id = sectionId;
      section.innerHTML = `
        <div class="employee-header">
          <div class="employee-info">
            <div class="employee-avatar">${getEmployeeInitials(employeeName)}</div>
            <div>
              <div class="employee-name">${escapeHtml(employeeName)}${employeeJobTitle ? ` <span style="font-weight:400; color:#64748b; font-size:0.8rem;">- ${escapeHtml(employeeJobTitle)}</span>` : ''}</div>
              <div class="employee-id">${employeeEmpId ? `ID: ${escapeHtml(employeeEmpId)}` : employeeEmail}</div>
            </div>
          </div>
          <div class="employee-actions">
            <button type="button" class="btn-remove-employee" onclick="removeEmployeeSection('${employeeId}')">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        </div>
        <div class="employee-items">
          <div class="employee-items-header">
            <span>Item</span>
            <span>Warehouse</span>
            <span>Available</span>
            <span>Quantity</span>
            <span>UOM</span>
            <span></span>
          </div>
          <div id="items-${employeeId}"></div>
          <button type="button" class="add-employee-item-btn" onclick="addEmployeeItemRow('${employeeId}')">
            <i class="fas fa-plus"></i> Add Item for ${escapeHtml(employeeName.split(' ')[0])}
          </button>
        </div>
      `;
      container.appendChild(section);

      // Add first item row for this employee
      addEmployeeItemRow(employeeId);

      // Reset the select
      employeeSelect.value = '';
    }

    // Add employee section with specific data (for editing)
    function addEmployeeSectionWithData(employeeId, employeeName, employeeEmail, employeeEmpId, employeeJobTitle = '') {
      // Check if employee already added
      if (employeeSections[employeeId]) {
        return;
      }

      // Try to get job title from cache if not provided
      if (!employeeJobTitle && employeesCache[employeeId]) {
        const emp = employeesCache[employeeId];
        employeeJobTitle = resolveJobTitle(emp.jobTitle || emp.position || '');
      }
      employeeJobTitle = resolveJobTitle(employeeJobTitle);

      const sectionId = `emp-section-${employeeId}`;
      employeeSections[employeeId] = { name: employeeName, email: employeeEmail, empId: employeeEmpId, jobTitle: employeeJobTitle, items: [] };

      const container = document.getElementById('employeesContainer');
      const section = document.createElement('div');
      section.className = 'employee-section';
      section.id = sectionId;
      section.innerHTML = `
        <div class="employee-header">
          <div class="employee-info">
            <div class="employee-avatar">${getEmployeeInitials(employeeName)}</div>
            <div>
              <div class="employee-name">${escapeHtml(employeeName)}${employeeJobTitle ? ` <span style="font-weight:400; color:#64748b; font-size:0.8rem;">- ${escapeHtml(employeeJobTitle)}</span>` : ''}</div>
              <div class="employee-id">${employeeEmpId ? `ID: ${escapeHtml(employeeEmpId)}` : employeeEmail}</div>
            </div>
          </div>
          <div class="employee-actions">
            <button type="button" class="btn-remove-employee" onclick="removeEmployeeSection('${employeeId}')">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        </div>
        <div class="employee-items">
          <div class="employee-items-header">
            <span>Item</span>
            <span>Warehouse</span>
            <span>Available</span>
            <span>Quantity</span>
            <span>UOM</span>
            <span></span>
          </div>
          <div id="items-${employeeId}"></div>
          <button type="button" class="add-employee-item-btn" onclick="addEmployeeItemRow('${employeeId}')">
            <i class="fas fa-plus"></i> Add Item for ${escapeHtml(employeeName.split(' ')[0])}
          </button>
        </div>
      `;
      container.appendChild(section);
    }

    // Remove employee section
    function removeEmployeeSection(employeeId) {
      const section = document.getElementById(`emp-section-${employeeId}`);
      if (section) {
        section.remove();
        delete employeeSections[employeeId];
      }
    }

    // Add item row for an employee
    function addEmployeeItemRow(employeeId) {
      const container = document.getElementById(`items-${employeeId}`);
      if (!container) return;

      const rowId = Date.now();

      const itemsOptions = Object.entries(itemsCache).map(([id, item]) =>
        `<option value="${id}" data-stock="${item.currentStock || 0}" data-uom="${item.uom || 'EA'}" data-warehouse="${item.warehouseId || ''}">${escapeHtml(item.name)} (${item.sku || 'N/A'})</option>`
      ).join('');

      const warehouseOptions = Object.entries(warehousesCache).map(([id, wh]) =>
        `<option value="${id}">${escapeHtml(wh.name || 'Warehouse')}</option>`
      ).join('');

      const row = document.createElement('div');
      row.className = 'employee-item-row';
      row.id = `emp-item-${employeeId}-${rowId}`;
      row.innerHTML = `
        <select onchange="updateEmployeeItemDetails('${employeeId}', ${rowId}, this)">
          <option value="">Select item...</option>
          ${itemsOptions}
        </select>
        <select id="emp-wh-${employeeId}-${rowId}">
          <option value="">Any</option>
          ${warehouseOptions}
        </select>
        <span id="emp-avail-${employeeId}-${rowId}">-</span>
        <input type="number" id="emp-qty-${employeeId}-${rowId}" min="1" value="1" placeholder="Qty" style="width:70px;" oninput="onItemQuantityChange()" />
        <span id="emp-uom-${employeeId}-${rowId}">-</span>
        <button type="button" class="remove-btn" onclick="removeEmployeeItemRow('${employeeId}', ${rowId})" style="background:#fee2e2; color:#dc2626; border:none; width:28px; height:28px; border-radius:4px; cursor:pointer;">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(row);
    }

    // Update employee item details
    function updateEmployeeItemDetails(employeeId, rowId, select) {
      const option = select.selectedOptions[0];
      const itemId = option && option.value ? option.value : null;
      const stock = option && option.value ? parseInt(option.dataset.stock) || 0 : 0;
      const uom = option && option.value ? option.dataset.uom : '-';
      const warehouse = option && option.value ? option.dataset.warehouse : '';
      
      // Calculate available after pending reservations
      const pendingQty = itemId ? (pendingReservations[itemId] || 0) : 0;
      const availableQty = itemId ? Math.max(0, stock - pendingQty) : '-';
      
      document.getElementById(`emp-avail-${employeeId}-${rowId}`).textContent = availableQty;
      document.getElementById(`emp-uom-${employeeId}-${rowId}`).textContent = uom;
      
      if (warehouse) {
        document.getElementById(`emp-wh-${employeeId}-${rowId}`).value = warehouse;
      }
      
      // Recalculate pending reservations and update all available displays
      recalculatePendingReservations();
    }

    // Recalculate all pending reservations in the modal
    function recalculatePendingReservations() {
      pendingReservations = {};
      
      // Go through all employee item rows and sum up quantities per item
      const allItemRows = document.querySelectorAll('.employee-item-row');
      allItemRows.forEach(row => {
        const select = row.querySelector('select');
        const itemId = select ? select.value : null;
        if (!itemId) return;
        
        const qtyInput = row.querySelector('input[type="number"]');
        const qty = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
        
        if (!pendingReservations[itemId]) {
          pendingReservations[itemId] = 0;
        }
        pendingReservations[itemId] += qty;
      });
      
      // Update all available displays
      updateAllAvailableDisplays();
    }

    // Update all available quantity displays in the modal
    function updateAllAvailableDisplays() {
      const allItemRows = document.querySelectorAll('.employee-item-row');
      allItemRows.forEach(row => {
        const select = row.querySelector('select');
        const itemId = select ? select.value : null;
        if (!itemId) return;
        
        const option = select.selectedOptions[0];
        const stock = option ? parseInt(option.dataset.stock) || 0 : 0;
        const pendingQty = pendingReservations[itemId] || 0;
        const availableQty = Math.max(0, stock - pendingQty);
        
        // Find the available span in this row
        const availSpan = row.querySelector('span[id^="emp-avail-"]');
        if (availSpan) {
          availSpan.textContent = availableQty;
          // Highlight if not enough stock
          if (availableQty < 0 || (pendingQty > stock)) {
            availSpan.style.color = '#dc2626';
            availSpan.style.fontWeight = '700';
          } else {
            availSpan.style.color = '';
            availSpan.style.fontWeight = '';
          }
        }
      });
    }

    // Handle quantity change in item rows
    function onItemQuantityChange() {
      recalculatePendingReservations();
    }

    // Remove employee item row
    function removeEmployeeItemRow(employeeId, rowId) {
      const row = document.getElementById(`emp-item-${employeeId}-${rowId}`);
      if (row) row.remove();
      // Recalculate after removing item
      recalculatePendingReservations();
    }

    // Add item to employee with existing data (for editing)
    function addItemToEmployee(employeeId, itemData) {
      const container = document.getElementById(`items-${employeeId}`);
      if (!container) return;

      const rowId = Date.now() + Math.floor(Math.random() * 1000);

      const itemsOptions = Object.entries(itemsCache).map(([id, item]) =>
        `<option value="${id}" data-stock="${item.currentStock || 0}" data-uom="${item.uom || 'EA'}" data-warehouse="${item.warehouseId || ''}" ${id === itemData.itemId ? 'selected' : ''}>${escapeHtml(item.name)} (${item.sku || 'N/A'})</option>`
      ).join('');

      const warehouseOptions = Object.entries(warehousesCache).map(([id, wh]) =>
        `<option value="${id}" ${id === itemData.warehouseId ? 'selected' : ''}>${escapeHtml(wh.name || 'Warehouse')}</option>`
      ).join('');

      const row = document.createElement('div');
      row.className = 'employee-item-row';
      row.id = `emp-item-${employeeId}-${rowId}`;
      row.innerHTML = `
        <select onchange="updateEmployeeItemDetails('${employeeId}', ${rowId}, this)">
          <option value="">Select item...</option>
          ${itemsOptions}
        </select>
        <select id="emp-wh-${employeeId}-${rowId}">
          <option value="">Any</option>
          ${warehouseOptions}
        </select>
        <span id="emp-avail-${employeeId}-${rowId}">${itemData.available || '-'}</span>
        <input type="number" id="emp-qty-${employeeId}-${rowId}" min="1" value="${itemData.quantity || 1}" placeholder="Qty" style="width:70px;" oninput="onItemQuantityChange()" />
        <span id="emp-uom-${employeeId}-${rowId}">${itemData.uom || '-'}</span>
        <button type="button" class="remove-btn" onclick="removeEmployeeItemRow('${employeeId}', ${rowId})" style="background:#fee2e2; color:#dc2626; border:none; width:28px; height:28px; border-radius:4px; cursor:pointer;">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(row);
      
      // Recalculate after adding item
      recalculatePendingReservations();
    }

    // Submit reservation
    async function submitReservation() {
      const errorEl = document.getElementById('modalError');
      const successEl = document.getElementById('modalSuccess');
      errorEl.classList.remove('show');
      successEl.classList.remove('show');

      // Request Info Tab
      const reservationType = document.getElementById('reservationType').value;
      const costCenter = document.getElementById('reservationCostCenter').value;
      const requiredDate = document.getElementById('reservationDate').value;
      const endDate = document.getElementById('reservationEndDate').value;
      const purpose = document.getElementById('reservationPurpose').value.trim();

      // Delivery Tab
      const deliveryMethod = document.getElementById('deliveryMethod').value;
      const deliveryLocation = document.getElementById('deliveryLocation').value;
      const deliveryRoom = document.getElementById('deliveryRoom').value.trim();
      const deliveryContact = document.getElementById('deliveryContact').value.trim();
      const deliveryPhone = document.getElementById('deliveryPhone').value.trim();
      const preferredTime = document.getElementById('preferredTime').value;
      const deliveryInstructions = document.getElementById('deliveryInstructions').value.trim();

      // Additional Tab
      const estimatedValue = Number(document.getElementById('estimatedValue').value) || 0;
      const returnRequired = document.getElementById('returnRequired').value;
      const expectedReturnDate = document.getElementById('expectedReturnDate').value;
      const notes = document.getElementById('reservationNotes').value.trim();
      const itemSpecialInstructions = document.getElementById('itemSpecialInstructions').value.trim();

      // Validations
      if (!reservationType) {
        errorEl.textContent = 'Reservation type is required.';
        errorEl.classList.add('show');
        switchReservationTab('request');
        return;
      }
      if (!costCenter) {
        errorEl.textContent = 'Cost center / department is required.';
        errorEl.classList.add('show');
        switchReservationTab('request');
        return;
      }
      if (!requiredDate) {
        errorEl.textContent = 'Required date is required.';
        errorEl.classList.add('show');
        switchReservationTab('request');
        return;
      }
      if (!purpose) {
        errorEl.textContent = 'Purpose / justification is required.';
        errorEl.classList.add('show');
        switchReservationTab('request');
        return;
      }
      if (!deliveryLocation) {
        errorEl.textContent = 'Delivery location is required.';
        errorEl.classList.add('show');
        switchReservationTab('delivery');
        return;
      }

      // Collect items by employee
      const employeeReservations = [];
      const employeeIds = Object.keys(employeeSections);
      
      if (employeeIds.length === 0) {
        errorEl.textContent = 'Please add at least one employee.';
        errorEl.classList.add('show');
        switchReservationTab('items');
        return;
      }

      for (const employeeId of employeeIds) {
        const empData = employeeSections[employeeId];
        const itemsContainer = document.getElementById(`items-${employeeId}`);
        if (!itemsContainer) continue;

        const itemRows = itemsContainer.querySelectorAll('.employee-item-row');
        const items = [];

        for (const row of itemRows) {
          const selects = row.querySelectorAll('select');
          const itemSelect = selects[0];
          const warehouseSelect = selects[1];
          const qtyInput = row.querySelector('input[type="number"]');
          
          if (itemSelect && itemSelect.value && qtyInput && qtyInput.value) {
            const itemId = itemSelect.value;
            const qty = Number(qtyInput.value);
            const item = itemsCache[itemId];
            if (item && qty > 0) {
              items.push({
                itemId,
                itemName: item.name,
                itemSku: item.sku,
                quantity: qty,
                available: item.currentStock || 0,
                uom: item.uom || 'EA',
                warehouseId: warehouseSelect?.value || item.warehouseId || '',
                warehouseName: warehouseSelect?.value ? (warehousesCache[warehouseSelect.value]?.name || '') : ''
              });
            }
          }
        }

        if (items.length > 0) {
          employeeReservations.push({
            employeeId,
            employeeName: empData.name,
            employeeEmail: empData.email,
            employeeEmpId: empData.empId,
            employeeJobTitle: resolveJobTitle(empData.jobTitle || ''),
            items
          });
        }
      }

      if (employeeReservations.length === 0) {
        errorEl.textContent = 'Please add at least one item for an employee.';
        errorEl.classList.add('show');
        switchReservationTab('items');
        return;
      }

      try {
        const isEditing = !!window.editingReservationId;
        const reservationId = isEditing ? window.editingReservationId : db.ref().push().key;
        
        // Get existing reservation data if editing
        let existingData = {};
        if (isEditing && reservationsCache[reservationId]) {
          existingData = reservationsCache[reservationId];
        }
        
        const reservationNumber = existingData.reservationNumber || `RES-${Date.now().toString(36).toUpperCase()}`;

        // Flatten all items for backward compatibility
        const allItems = employeeReservations.flatMap(er => er.items);

        const reservationData = {
          id: reservationId,
          reservationNumber,
          
          // Request Info
          reservationType,
          costCenter,
          requiredDate,
          endDate,
          purpose,
          
          // Employee Reservations (items grouped by employee)
          employeeReservations,
          // Items (flattened for backward compatibility)
          items: allItems,
          itemSpecialInstructions,
          
          // Delivery
          delivery: {
            method: deliveryMethod,
            location: deliveryLocation,
            room: deliveryRoom,
            contact: deliveryContact,
            phone: deliveryPhone,
            preferredTime,
            instructions: deliveryInstructions
          },
          
          // Additional
          budget: {
            estimatedValue
          },
          returnInfo: {
            required: returnRequired,
            expectedDate: expectedReturnDate
          },
          notes,
          
          // Status & Metadata - preserve existing status and history when editing
          status: isEditing ? (existingData.status || 'pending') : 'pending',
          approvalHistory: isEditing ? (existingData.approvalHistory || []) : [],
          requestedBy: isEditing ? existingData.requestedBy : {
            uid: currentUser?.uid,
            email: currentUser?.email,
            name: window.authManager?.getUserDisplayName() || 'Unknown'
          },
          createdAt: isEditing ? existingData.createdAt : Date.now(),
          updatedAt: isEditing ? Date.now() : null,
          updatedBy: isEditing ? {
            uid: currentUser?.uid,
            email: currentUser?.email,
            name: window.authManager?.getUserDisplayName() || 'Unknown'
          } : null
        };

        await db.ref(`companies/${companyId}/inventory/reservations/${reservationId}`).set(reservationData);

        // Create approval request only for new reservations
        if (!isEditing) {
          const approvalId = db.ref().push().key;
          await db.ref(`companies/${companyId}/inventory/approvals/${approvalId}`).set({
            id: approvalId,
            type: 'reservation',
            referenceId: reservationId,
            referenceNumber: reservationNumber,
            description: `${reservationType} reservation: ${purpose.substring(0, 50)}`,
            status: 'pending',
            requestedBy: reservationData.requestedBy,
            createdAt: Date.now()
          });
        }

        successEl.textContent = isEditing ? 'Reservation updated successfully!' : 'Reservation submitted successfully!';
        successEl.classList.add('show');

        // Reset editing flag
        window.editingReservationId = null;

        await loadPageData();
        setTimeout(() => closeReservationModal(), 1500);
      } catch (err) {
        console.error('Error submitting reservation:', err);
        errorEl.textContent = 'Failed to submit reservation. Please try again.';
        errorEl.classList.add('show');
      }
    }

    // View reservation - Investigation Style Modal
    async function viewReservation(reservationId) {
      viewingReservationId = reservationId;
      const r = reservationsCache[reservationId];
      if (!r) return;

      const modal = document.getElementById('viewModal');
      const sectionsContainer = document.getElementById('resDetailSections');
      const actionsDiv = document.getElementById('resDetailActions');
      const cancelBtn = document.getElementById('resCancelBtn');

      // Show loading state
      sectionsContainer.innerHTML = '<div style="padding:40px; text-align:center; color:#64748b;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
      modal.classList.add('show');

      // Fetch approval flow configuration from approval-settings
      let approvalFlowData = null;
      try {
        const approvalFlowSnap = await db.ref(`companies/${companyId}/approvalFlows/reservation`).once('value');
        if (approvalFlowSnap.exists()) {
          approvalFlowData = approvalFlowSnap.val();
        }
      } catch (err) {
        console.warn('Error loading approval flow:', err);
      }

      // Resolve L+1 (Line Manager) for the requester
      let lineManagerDisplay = '';
      let lineManagerJobTitle = '';
      try {
        // Get requester identifier (UID or email)
        // Prefer UID if available; otherwise email; then fallbacks
        const creatorIdentifier = r.requestedBy?.uid || r.requestedBy?.email || r.createdBy || r.createdByEmail;
        
        console.log('Resolving L+1 for creator:', creatorIdentifier, 'from reservation:', r.requestedBy);
        
        if (creatorIdentifier) {
          // Resolve creator employee record
          const creatorEmp = await resolveEmployeeRecord(creatorIdentifier, companyId);
          console.log('Found creator employee record:', creatorEmp);
          
          if (creatorEmp) {
            const lineManagerRef = creatorEmp.lineManagerId || creatorEmp.lineManager || creatorEmp.lineManagerUID || creatorEmp.managerUid || creatorEmp.managerUID || creatorEmp.reportsTo || creatorEmp.supervisorUid || creatorEmp.supervisorUID || creatorEmp.supervisorEmail || creatorEmp.managerEmail;
            console.log('Line manager reference found:', lineManagerRef);
            
            if (lineManagerRef) {
              const managerInfo = await resolveLineManagerInfo(lineManagerRef, companyId);
              lineManagerDisplay = managerInfo.name || '';
              lineManagerJobTitle = managerInfo.jobTitle || '';
              console.log('Resolved L+1 Line Manager:', { name: lineManagerDisplay, jobTitle: lineManagerJobTitle, managerInfo });
            } else {
              console.log('No line manager reference in employee record');
            }
          } else {
            console.log('Creator employee record not found');
          }
        } else {
          console.log('No creator identifier found');
        }
      } catch (e) {
        console.error('Error resolving line manager:', e);
      }

      // Store resolved line manager for approval button matching
      window._currentResolvedLineManager = lineManagerDisplay;
      window._currentResolvedLineManagerJobTitle = lineManagerJobTitle;

      // Set company branding
      const companyName = window.authManager?.currentCompany?.companyName || 'Company';
      const companyLogo = window.authManager?.currentCompany?.logo || window.authManager?.currentCompany?.logoUrl;
      document.getElementById('resModalCompanyName').textContent = companyName;
      document.getElementById('resModalGenerated').textContent = `Generated: ${new Date().toLocaleString()}`;
      document.getElementById('resModalDocNumber').textContent = r.reservationNumber || r.id;

      const logoEl = document.getElementById('resModalLogo');
      const logoFallback = document.getElementById('resModalLogoFallback');
      if (companyLogo) {
        logoEl.src = companyLogo;
        logoEl.style.display = 'block';
        logoFallback.style.display = 'none';
      } else {
        logoEl.style.display = 'none';
        logoFallback.style.display = 'flex';
        logoFallback.textContent = getCompanyInitials(companyName);
      }

      // Build sections HTML
      let html = '';

      // Request Info Section
      html += `
        <div class="res-section-title request-section"><i class="fas fa-clipboard-list"></i><span class="section-text">Request Information</span></div>
        <div class="res-info-grid">
          <div class="res-info-item">
            <span class="label">Reservation Type</span>
            <span class="value">${capitalize(r.reservationType || '-')}</span>
          </div>
          <div class="res-info-item">
            <span class="label">Cost Center</span>
            <span class="value">${escapeHtml(r.costCenter || '-')}</span>
          </div>
          <div class="res-info-item">
            <span class="label">Required Date</span>
            <span class="value">${r.requiredDate ? new Date(r.requiredDate).toLocaleDateString() : '-'}</span>
          </div>
          <div class="res-info-item">
            <span class="label">End Date</span>
            <span class="value">${r.endDate ? new Date(r.endDate).toLocaleDateString() : '-'}</span>
          </div>
          <div class="res-info-item">
            <span class="label">Requested By</span>
            <span class="value">${escapeHtml(r.requestedBy?.name || 'Unknown')}</span>
          </div>
          <div class="res-info-item">
            <span class="label">Request Date</span>
            <span class="value">${r.createdAt ? new Date(r.createdAt).toLocaleString() : '-'}</span>
          </div>
          <div class="res-info-item full">
            <span class="label">Purpose / Justification</span>
            <span class="value">${escapeHtml(r.purpose || '-')}</span>
          </div>
        </div>
      `;

      // Items Section - By Employee
      html += `<div class="res-section-title items-section"><i class="fas fa-boxes"></i><span class="section-text">Reserved Items</span></div>`;
      
      if (r.employeeReservations && r.employeeReservations.length > 0) {
        // New format with employee reservations
        r.employeeReservations.forEach(emp => {
          const empIdDisplay = emp.employeeEmpId || emp.employeeEmail || '';
          // Prefer saved job title on the reservation; fallback to employees cache lookup
          let jobTitleDisplay = resolveJobTitle(emp.employeeJobTitle || emp.jobTitle || '');
          if (!jobTitleDisplay) {
            const empId = emp.employeeId || '';
            if (empId && employeesCache[empId]) {
              const rec = employeesCache[empId];
              jobTitleDisplay = resolveJobTitle(rec.jobTitle || rec.position || rec.role || '');
            }
          }
          html += `
            <div style="margin-top:12px; padding:10px; background:#f8fafc; border-radius:6px; border:1px solid #e2e8f0;">
              <div style="font-weight:600; font-size:.8rem; color:#1f2937; margin-bottom:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                <span>${escapeHtml(emp.employeeName)}</span>
                ${jobTitleDisplay ? `<span style="font-weight:400; color:#64748b;">- ${escapeHtml(jobTitleDisplay)}</span>` : ''}
                ${empIdDisplay ? `<span style="font-size:.7rem; color:#64748b; font-weight:400;">(${escapeHtml(empIdDisplay)})</span>` : ''}
              </div>
              <table class="res-info-table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>SKU</th>
                    <th>Warehouse</th>
                    <th>Qty</th>
                    <th>UOM</th>
                  </tr>
                </thead>
                <tbody>
                  ${emp.items?.map(item => `
                    <tr>
                      <td>${escapeHtml(item.itemName || '-')}</td>
                      <td>${escapeHtml(item.itemSku || '-')}</td>
                      <td>${escapeHtml(item.warehouseName || '-')}</td>
                      <td>${item.quantity || 0}</td>
                      <td>${escapeHtml(item.uom || 'EA')}</td>
                    </tr>
                  `).join('') || '<tr><td colspan="5" style="text-align:center; color:#64748b;">No items</td></tr>'}
                </tbody>
              </table>
            </div>
          `;
        });
      } else if (r.items && r.items.length > 0) {
        // Old format with direct items array
        html += `
          <table class="res-info-table" style="margin-top:8px;">
            <thead>
              <tr>
                <th>Item</th>
                <th>SKU</th>
                <th>Warehouse</th>
                <th>Qty</th>
                <th>Available</th>
                <th>UOM</th>
              </tr>
            </thead>
            <tbody>
              ${r.items.map(item => `
                <tr>
                  <td>${escapeHtml(item.itemName || '-')}</td>
                  <td>${escapeHtml(item.itemSku || '-')}</td>
                  <td>${escapeHtml(item.warehouseName || '-')}</td>
                  <td>${item.quantity || 0}</td>
                  <td>${item.available || 0}</td>
                  <td>${escapeHtml(item.uom || 'EA')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else {
        html += `<div style="margin-top:8px; padding:16px; text-align:center; color:#64748b; font-size:.8rem;">No items in this reservation</div>`;
      }

      if (r.itemSpecialInstructions) {
        html += `
          <div class="res-info-grid" style="margin-top:8px;">
            <div class="res-info-item full">
              <span class="label">Special Instructions</span>
              <span class="value">${escapeHtml(r.itemSpecialInstructions)}</span>
            </div>
          </div>
        `;
      }

      // Delivery Section
      if (r.delivery) {
        html += `
          <div class="res-section-title delivery-section"><i class="fas fa-truck"></i><span class="section-text">Delivery Information</span></div>
          <div class="res-info-grid">
            <div class="res-info-item">
              <span class="label">Delivery Method</span>
              <span class="value">${capitalize(r.delivery.method || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Location</span>
              <span class="value">${escapeHtml(r.delivery.location || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Room / Area</span>
              <span class="value">${escapeHtml(r.delivery.room || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Contact Person</span>
              <span class="value">${escapeHtml(r.delivery.contact || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Contact Phone</span>
              <span class="value">${escapeHtml(r.delivery.phone || '-')}</span>
            </div>
            <div class="res-info-item">
              <span class="label">Preferred Time</span>
              <span class="value">${escapeHtml(r.delivery.preferredTime || '-')}</span>
            </div>
            ${r.delivery.instructions ? `
              <div class="res-info-item full">
                <span class="label">Delivery Instructions</span>
                <span class="value">${escapeHtml(r.delivery.instructions)}</span>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Status Section
      html += `
        <div class="res-section-title status-section"><i class="fas fa-info-circle"></i><span class="section-text">Status & Additional Info</span></div>
        <div class="res-info-grid">
          <div class="res-info-item">
            <span class="label">Status</span>
            <span class="value"><span class="res-status-badge ${r.status || 'pending'}">${capitalize(r.status || 'pending')}</span></span>
          </div>
          ${r.budget?.code ? `
            <div class="res-info-item">
              <span class="label">Budget Code</span>
              <span class="value">${escapeHtml(r.budget.code)}</span>
            </div>
          ` : ''}
          ${r.budget?.estimatedValue ? `
            <div class="res-info-item">
              <span class="label">Estimated Value</span>
              <span class="value">$${Number(r.budget.estimatedValue).toLocaleString()}</span>
            </div>
          ` : ''}
          ${r.returnInfo?.required === 'yes' ? `
            <div class="res-info-item">
              <span class="label">Return Required</span>
              <span class="value">Yes${r.returnInfo.expectedDate ? ` - by ${new Date(r.returnInfo.expectedDate).toLocaleDateString()}` : ''}</span>
            </div>
          ` : ''}
          ${r.notes ? `
            <div class="res-info-item full">
              <span class="label">Notes</span>
              <span class="value">${escapeHtml(r.notes)}</span>
            </div>
          ` : ''}
        </div>
      `;

      // Approval Flow Section
      html += `
        <div class="res-section-title approval-section"><i class="fas fa-stamp"></i><span class="section-text">Approval Flow</span></div>
      `;
      
      // Build approval flow table
      const approvalHistory = r.approvalHistory || [];
      
      // Build approval levels from approval-settings configuration
      let approvalLevels = [];
      window._currentApprovalLevels = [];
      if (approvalFlowData && approvalFlowData.selectedRoles) {
        // Load approval flow from approval-settings.html configuration
        const sortedKeys = Object.keys(approvalFlowData.selectedRoles)
          .filter(k => k.startsWith('level'))
          .sort((a, b) => parseInt(a.replace('level', '')) - parseInt(b.replace('level', '')));
        
        sortedKeys.forEach(key => {
          const levelNum = parseInt(key.replace('level', ''));
          const levelData = approvalFlowData.selectedRoles[key];
          if (Array.isArray(levelData)) {
            levelData.forEach(ap => {
              let displayName = ap.text || ap.value || 'Approver';
              const isL1Token = String(displayName).toLowerCase() === 'l+1' || String(ap.value).toLowerCase() === 'l+1';
              
              // Replace L+1 with actual line manager name
              if (isL1Token) {
                if (lineManagerDisplay) {
                  displayName = lineManagerDisplay;
                } else {
                  displayName = 'Line Manager (Not Assigned)';
                }
              }
              
              approvalLevels.push({
                level: levelNum,
                name: displayName,
                role: ap.role || (isL1Token && lineManagerJobTitle ? lineManagerJobTitle : ''),
                isL1: isL1Token,
                identifier: ap.uid || ap.value || ap.text || ''
              });
            });
          }
        });
      } else if (r.approvalFlow && r.approvalFlow.selectedRoles) {
        // Fallback to stored approval flow in reservation data
        const sortedKeys = Object.keys(r.approvalFlow.selectedRoles)
          .filter(k => k.startsWith('level'))
          .sort((a, b) => parseInt(a.replace('level', '')) - parseInt(b.replace('level', '')));
        
        sortedKeys.forEach(key => {
          const levelNum = parseInt(key.replace('level', ''));
          const levelData = r.approvalFlow.selectedRoles[key];
          if (Array.isArray(levelData)) {
            levelData.forEach(ap => {
              let displayName = ap.text || ap.value || 'Approver';
              const isL1Token = String(displayName).toLowerCase() === 'l+1' || String(ap.value).toLowerCase() === 'l+1';
              
              // Replace L+1 with actual line manager name
              if (isL1Token) {
                if (lineManagerDisplay) {
                  displayName = lineManagerDisplay;
                } else {
                  displayName = 'Line Manager (Not Assigned)';
                }
              }
              
              approvalLevels.push({
                level: levelNum,
                name: displayName,
                role: ap.role || (isL1Token && lineManagerJobTitle ? lineManagerJobTitle : ''),
                isL1: isL1Token,
                identifier: ap.uid || ap.value || ap.text || ''
              });
            });
          }
        });
      }
      
      // If no custom flow, use default single-level approval
      if (approvalLevels.length === 0) {
        approvalLevels = [
          { level: 1, name: 'Warehouse Manager', role: 'Inventory Approval' }
        ];
      }
      // Store globally for approve/decline functions
      window._currentApprovalLevels = approvalLevels;
      
      // Build table rows
      let approvalRows = '';
      // Helper to resolve job title for approver
      async function resolveJobTitleForApprover(identifier, name) {
        try {
          // If identifier looks like UID, try direct
          if (identifier && typeof identifier === 'string' && !identifier.includes('@') && !identifier.includes(' ')) {
            const snap = await db.ref(`companies/${companyId}/users/${identifier}`).once('value');
            if (snap.exists()) return snap.val().jobTitle || '';
          }
          // If identifier is email, search users by email
          const emailToFind = (identifier && String(identifier).includes('@')) ? String(identifier).toLowerCase() : '';
          const usersSnap = await db.ref(`companies/${companyId}/users`).once('value');
          if (usersSnap.exists()) {
            const users = usersSnap.val();
            for (const [uid, user] of Object.entries(users)) {
              const userName = user.name || user.displayName || `${user.firstName || ''} ${user.lastName || ''}`.trim();
              if (emailToFind && (user.email || '').toLowerCase() === emailToFind) return user.jobTitle || '';
              if (name && userName && userName.toLowerCase() === String(name).toLowerCase()) return user.jobTitle || '';
            }
          }
        } catch (e) { console.warn('resolveJobTitleForApprover error:', e); }
        return '';
      }

      // Helper to get signature URL for a user by UID or email
      async function getSignatureUrlForUserId(userIdOrEmail) {
        try {
          const isEmail = String(userIdOrEmail).includes('@');
          const uid = isEmail ? null : userIdOrEmail;
          const email = isEmail ? userIdOrEmail : '';
          
          // Try company users path first
          if (uid) {
            const u1 = await db.ref(`companies/${companyId}/users/${uid}/signatureUrl`).once('value');
            if (u1.exists() && u1.val()) return String(u1.val());
            const u2 = await db.ref(`companies/${companyId}/users/${uid}/signature`).once('value');
            if (u2.exists() && u2.val()) return String(u2.val());
            const u3 = await db.ref(`companies/${companyId}/users/${uid}/security/signatureUrl`).once('value');
            if (u3.exists() && u3.val()) return String(u3.val());
            const u4 = await db.ref(`companies/${companyId}/users/${uid}/security/signature`).once('value');
            if (u4.exists() && u4.val()) return String(u4.val());
          }
          // Try company employees by uid
          if (uid) {
            const e1 = await db.ref(`companies/${companyId}/employees/${uid}/signatureUrl`).once('value');
            if (e1.exists() && e1.val()) return String(e1.val());
            const e2 = await db.ref(`companies/${companyId}/employees/${uid}/security/signatureUrl`).once('value');
            if (e2.exists() && e2.val()) return String(e2.val());
            const e3 = await db.ref(`companies/${companyId}/employees/${uid}/security/signature`).once('value');
            if (e3.exists() && e3.val()) return String(e3.val());
          }
          // Try company profiles path
          if (uid) {
            const p1 = await db.ref(`companies/${companyId}/profiles/${uid}/security/signatureUrl`).once('value');
            if (p1.exists() && p1.val()) return String(p1.val());
            const p2 = await db.ref(`companies/${companyId}/profiles/${uid}/security/signature`).once('value');
            if (p2.exists() && p2.val()) return String(p2.val());
          }
          // Try email-based
          if (email) {
            const emailKey = email.replace(/[@.]/g, '_');
            const em1 = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/signatureUrl`).once('value');
            if (em1.exists() && em1.val()) return String(em1.val());
            const em2 = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/security/signatureUrl`).once('value');
            if (em2.exists() && em2.val()) return String(em2.val());
          }
        } catch (e) { /* ignore */ }
        return '';
      }

      for (const level of approvalLevels) {
        const historyEntry = approvalHistory.find(h => h.level === level.level) || null;
        
        let statusText = 'Pending';
        let statusClass = 'pending';
        let timestamp = '-';
        let signature = '';
        let approverDisplay = level.name;
        
        if (historyEntry) {
          const status = (historyEntry.status || '').toLowerCase();
          if (status === 'approved') {
            statusText = 'Approved';
            statusClass = 'approved';
            approverDisplay = historyEntry.userName || level.name;
            // Get signature from history or lookup by userId
            signature = historyEntry.signatureUrl || historyEntry.signature || '';
            if (!signature && historyEntry.userId) {
              signature = await getSignatureUrlForUserId(historyEntry.userId);
            }
            if (!signature && historyEntry.userEmail) {
              signature = await getSignatureUrlForUserId(historyEntry.userEmail);
            }
          } else if (status === 'rejected' || status === 'declined') {
            statusText = 'Declined';
            statusClass = 'declined';
            approverDisplay = historyEntry.userName || level.name;
          }
          timestamp = historyEntry.submittedAt ? new Date(historyEntry.submittedAt).toLocaleString() : '-';
        }
        
        // Check overall reservation status for simple cases
        if (approvalHistory.length === 0) {
          if (r.status === 'approved') {
            statusText = 'Approved';
            statusClass = 'approved';
            timestamp = r.approvedAt ? new Date(r.approvedAt).toLocaleString() : '-';
            approverDisplay = r.approvedBy || level.name;
          } else if (r.status === 'rejected' || r.status === 'declined') {
            statusText = 'Declined';
            statusClass = 'declined';
            timestamp = r.rejectedAt ? new Date(r.rejectedAt).toLocaleString() : '-';
            approverDisplay = r.rejectedBy || level.name;
          }
        }
        
        // Determine job title to display
        let jobTitleDisplay = level.role || '';
        if (!jobTitleDisplay) {
          jobTitleDisplay = await resolveJobTitleForApprover(level.identifier, level.name);
        }

        approvalRows += `
          <tr>
            <td>
              <div class="approver-name">${escapeHtml(approverDisplay)}</div>
              ${jobTitleDisplay ? `<div class="approver-role">${escapeHtml(jobTitleDisplay)}</div>` : ''}
            </td>
            <td><span class="status-chip ${statusClass}">${statusText}</span></td>
            <td>${timestamp}</td>
            <td>${signature ? `<img src="${signature}" alt="Signature" class="sig-img"/>` : '<span style="color:#9ca3af;">-</span>'}</td>
          </tr>
        `;
      }
      
      html += `
        <table class="res-approval-table">
          <thead>
            <tr>
              <th>Approver</th>
              <th style="width:90px;">Status</th>
              <th style="width:150px;">Timestamp</th>
              <th style="width:120px;">Signature</th>
            </tr>
          </thead>
          <tbody>
            ${approvalRows}
          </tbody>
        </table>
      `;

      sectionsContainer.innerHTML = html;

      // Show/hide action buttons based on user role and status
      const editBtn = document.getElementById('resEditBtn');
      const deleteBtn = document.getElementById('resDeleteBtn');
      const approveBtn = document.getElementById('resApproveBtn');
      const declineBtn = document.getElementById('resDeclineBtn');
      const commentSection = document.getElementById('resApprovalCommentSection');
      
      // Debug: button elements presence
      // console.log('Buttons:', { editBtn: !!editBtn, deleteBtn: !!deleteBtn, approveBtn: !!approveBtn, declineBtn: !!declineBtn, commentSection: !!commentSection, actionsDiv: !!actionsDiv });
      
      // Hide all by default
      actionsDiv.style.display = 'none';
      if (editBtn) editBtn.style.display = 'none';
      if (deleteBtn) deleteBtn.style.display = 'none';
      if (approveBtn) approveBtn.style.display = 'none';
      if (declineBtn) declineBtn.style.display = 'none';
      if (commentSection) commentSection.style.display = 'none';
      
      const user = currentUser;
      if (!user) {
        // No user: keep actions hidden
        modal.classList.add('show');
        return;
      }
      
      const userRole = (user.role || '').toLowerCase().trim();
      const userJobTitle = (user.jobTitle || '').toLowerCase().trim();
      const userName = (user.displayName || user.name || '').toLowerCase().trim();
      const userEmail = (user.email || '').toLowerCase().trim();
      const reservationStatus = (r.status || 'pending').toLowerCase();
      // Robust creator check: match uid, email, and common name variants
      const reqBy = r.requestedBy || {};
      const reqUid = (reqBy.uid || r.createdBy || '').toString();
      const reqEmail = (reqBy.email || r.createdByEmail || '').toLowerCase().trim();
      const reqName = (reqBy.name || '').toLowerCase().trim();
      const userNameVariants = [
        userName,
        (user.displayName || '').toLowerCase().trim(),
        (user.name || '').toLowerCase().trim(),
        `${(user.firstName || '')} ${(user.lastName || '')}`.toLowerCase().trim(),
        (userEmail || '').split('@')[0]
      ].filter(v => v && v.length > 0);
      let isCreator = false;
      if (reqUid && user.uid && reqUid === user.uid) isCreator = true;
      if (reqEmail && userEmail && reqEmail === userEmail) isCreator = true;
      if (!isCreator && reqName && userNameVariants.some(v => v === reqName)) isCreator = true;
      const isAdmin = ['admin', 'super user', 'superuser'].includes(userRole);
      const isPending = reservationStatus === 'pending' || reservationStatus === 'submitted';
      const isDraft = reservationStatus === 'draft';
      
      // Check if user can approve based on approval flow (sequential)
      let canApprove = false;
      let isCurrentLevelApprover = false;
      let currentPendingLevel = null;
      if (isPending && Array.isArray(approvalLevels) && approvalLevels.length > 0) {
        // Determine the next level that requires approval
        const approvedLevels = (r.approvalHistory || []).filter(h => (h.status || '').toLowerCase() === 'approved').map(h => h.level);
        // The first level in approvalLevels whose level is not in approvedLevels is the current pending level
        currentPendingLevel = approvalLevels.find(l => !approvedLevels.includes(l.level)) || null;

        if (currentPendingLevel) {
          const approverName = String(currentPendingLevel.name || '').toLowerCase().trim();
          const approverIdentifier = String(currentPendingLevel.identifier || '').toLowerCase().trim();
          const candidates = [...userNameVariants];
          if (userEmail) candidates.push(userEmail);
          if (user.uid) candidates.push(String(user.uid).toLowerCase());

          // Match by name, email or UID
          isCurrentLevelApprover = candidates.some(n => n === approverName || n === approverIdentifier);
          canApprove = isCurrentLevelApprover;
        }
      }
      
      // Admins can approve only if they are the current pending level approver
      if (isAdmin && isPending && currentPendingLevel) {
        const approverName = String(currentPendingLevel.name || '').toLowerCase().trim();
        const approverIdentifier = String(currentPendingLevel.identifier || '').toLowerCase().trim();
        const candidates = [...userNameVariants];
        if (userEmail) candidates.push(userEmail);
        if (user.uid) candidates.push(String(user.uid).toLowerCase());
        if (candidates.some(n => n === approverName || n === approverIdentifier)) {
          canApprove = true;
        }
      }
      
      // Determine button visibility
      let showActions = false;
      
      // Creator/requester: can edit drafts or pending/submitted; can delete drafts and pending
      if (isCreator) {
        if ((isDraft || isPending) && editBtn) {
          editBtn.style.display = 'inline-flex';
          showActions = true;
        }
        if ((isDraft || isPending) && deleteBtn) {
          deleteBtn.style.display = 'inline-flex';
          showActions = true;
        }
      }
      
      // Admin: can edit any non-approved; can delete any
      if (isAdmin) {
        if (reservationStatus !== 'approved' && editBtn) {
          editBtn.style.display = 'inline-flex';
          showActions = true;
        }
        if (deleteBtn) {
          deleteBtn.style.display = 'inline-flex';
          showActions = true;
        }
      }
      
      // Approvers: show approve/decline only if pending and not the creator
      if (canApprove && isPending && !isCreator) {
        if (approveBtn) approveBtn.style.display = 'inline-flex';
        if (declineBtn) declineBtn.style.display = 'inline-flex';
        if (commentSection) commentSection.style.display = 'block';
        showActions = true;
      }
      
      actionsDiv.style.display = showActions ? 'flex' : 'none';
      actionsDiv.style.flexDirection = 'column';

      modal.classList.add('show');
    }

    // Get company initials
    function getCompanyInitials(name) {
      if (!name) return 'CO';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    // Print reservation
    function printReservation() {
      window.print();
    }

    // Close view modal
    function closeViewModal() {
      document.getElementById('viewModal').classList.remove('show');
      viewingReservationId = null;
    }

    // Close modal when clicking overlay
    document.addEventListener('click', function(e) {
      const overlay = document.getElementById('viewModal');
      if (e.target === overlay) {
        closeViewModal();
      }
    });

    // Cancel reservation
    async function cancelReservation() {
      if (!viewingReservationId) return;
      if (!confirm('Are you sure you want to cancel this reservation?')) return;

      try {
        await db.ref(`companies/${companyId}/inventory/reservations/${viewingReservationId}/status`).set('cancelled');

        // Update related approval
        const approvalsSnap = await db.ref(`companies/${companyId}/inventory/approvals`).orderByChild('referenceId').equalTo(viewingReservationId).once('value');
        if (approvalsSnap.exists()) {
          const approvals = approvalsSnap.val();
          for (const [aid] of Object.entries(approvals)) {
            await db.ref(`companies/${companyId}/inventory/approvals/${aid}/status`).set('cancelled');
          }
        }

        await loadPageData();
        closeViewModal();
      } catch (err) {
        console.error('Error cancelling reservation:', err);
        alert('Failed to cancel reservation.');
      }
    }

    // Edit reservation - opens reservation in edit mode
    function editReservation() {
      console.log('Edit button clicked, viewingReservationId:', viewingReservationId);
      
      if (!viewingReservationId) {
        alert('Error: No reservation selected for editing.');
        return;
      }
      
      const r = reservationsCache[viewingReservationId];
      if (!r) {
        alert('Error: Reservation data not found.');
        console.error('Reservation not in cache:', viewingReservationId, Object.keys(reservationsCache));
        return;
      }

      try {
        // Set a flag to indicate we're editing BEFORE opening modal
        window.editingReservationId = viewingReservationId;
        console.log('Set editing flag for reservation:', viewingReservationId);

        // Close view modal
        closeViewModal();

        // Open the reservation modal in edit mode
        openReservationModal(true);
        console.log('Opened reservation modal in edit mode');

        // Populate form fields
        setTimeout(() => {
          try {
            console.log('Populating form fields with data:', r);
            
            // Request Info - use correct field IDs
            const setField = (id, value) => {
              const el = document.getElementById(id);
              if (el) {
                el.value = value || '';
              } else {
                console.warn('Field not found:', id);
              }
            };
            
            setField('reservationType', r.reservationType);
            setField('reservationCostCenter', r.costCenter);
            setField('reservationDate', r.requiredDate);
            setField('reservationEndDate', r.endDate);
            setField('reservationPurpose', r.purpose);

            // Delivery Info
            setField('deliveryMethod', r.delivery?.method || 'pickup');
            setField('deliveryLocation', r.delivery?.location);
            setField('deliveryRoom', r.delivery?.room);
            setField('deliveryContact', r.delivery?.contact);
            setField('deliveryPhone', r.delivery?.phone);
            setField('preferredTime', r.delivery?.preferredTime);
            setField('deliveryInstructions', r.delivery?.instructions);

            // Additional Info
            setField('estimatedValue', r.budget?.estimatedValue);
            setField('returnRequired', r.returnInfo?.required || 'no');
            setField('expectedReturnDate', r.returnInfo?.expectedDate);
            setField('reservationNotes', r.notes);
            setField('itemSpecialInstructions', r.itemSpecialInstructions);

            console.log('Form fields populated successfully');

            // Restore employee reservations
            if (r.employeeReservations && r.employeeReservations.length > 0) {
              console.log('Restoring employee reservations:', r.employeeReservations.length);
              r.employeeReservations.forEach((emp, idx) => {
                // Add employee section directly with their data
                addEmployeeSectionWithData(emp.employeeId, emp.employeeName, emp.employeeEmail || '', emp.employeeEmpId || '', emp.employeeJobTitle || '');
                
                // Find the section that was just added and add items
                setTimeout(() => {
                  if (emp.items && emp.items.length > 0) {
                    // Remove the default empty item row first
                    const container = document.getElementById(`items-${emp.employeeId}`);
                    if (container) container.innerHTML = '';
                    
                    emp.items.forEach(item => {
                      addItemToEmployee(emp.employeeId, item);
                    });
                  }
                }, 50 * (idx + 1));
              });
            }
            
            console.log('Edit form setup completed');
          } catch (err) {
            console.error('Error populating edit form:', err);
            alert('Error loading reservation data for editing: ' + (err.message || err));
          }
        }, 100);
      } catch (err) {
        console.error('Error in editReservation:', err);
        alert('Error opening edit form: ' + (err.message || err));
      }
    }

    // Delete reservation
    async function deleteReservation() {
      console.log('Delete button clicked, viewingReservationId:', viewingReservationId);
      
      if (!viewingReservationId) {
        alert('Error: No reservation selected for deletion.');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this reservation? This action cannot be undone.')) return;

      try {
        console.log('Deleting reservation:', viewingReservationId);
        await db.ref(`companies/${companyId}/inventory/reservations/${viewingReservationId}`).remove();
        console.log('Reservation deleted from database');

        // Delete related approvals
        const approvalsSnap = await db.ref(`companies/${companyId}/inventory/approvals`).orderByChild('referenceId').equalTo(viewingReservationId).once('value');
        if (approvalsSnap.exists()) {
          const approvals = approvalsSnap.val();
          console.log('Deleting related approvals:', Object.keys(approvals));
          for (const [aid] of Object.entries(approvals)) {
            await db.ref(`companies/${companyId}/inventory/approvals/${aid}`).remove();
          }
        }

        await loadPageData();
        closeViewModal();
        alert('Reservation deleted successfully.');
      } catch (err) {
        console.error('Error deleting reservation:', err);
        alert('Failed to delete reservation: ' + (err.message || err));
      }
    }

    // Approve reservation
    async function approveReservation() {
      console.log('Approve button clicked, viewingReservationId:', viewingReservationId);
      
      if (!viewingReservationId) {
        alert('Error: No reservation selected for approval.');
        return;
      }
      
      if (!confirm('Are you sure you want to approve this reservation?')) return;

      const comment = document.getElementById('resApprovalComment')?.value || '';
      const user = currentUser;
      
      if (!user) {
        alert('Error: User not logged in.');
        return;
      }

      try {
        console.log('Approving reservation:', viewingReservationId);
        const r = reservationsCache[viewingReservationId];
        if (!r) {
          alert('Error: Reservation data not found.');
          return;
        }
        
        const approvalHistory = r.approvalHistory || [];
        // Determine next pending level based on existing approvals
        const approvedLevels = approvalHistory.filter(h => (h.status || '').toLowerCase() === 'approved').map(h => h.level);
        const nextLevel = (approvedLevels.length || 0) + 1;
        
        // Get user's signature if available
        let signatureUrl = '';
        try {
          const userSnap = await db.ref(`companies/${companyId}/users/${user.uid}/signature`).once('value');
          if (userSnap.exists()) {
            signatureUrl = userSnap.val();
          }
        } catch (e) {
          console.warn('Could not fetch signature:', e);
        }

        // Add to approval history
        const newApproval = {
          level: nextLevel,
          status: 'approved',
          userId: user.uid,
          userName: user.displayName || user.name || user.email,
          userEmail: user.email,
          userJobTitle: user.jobTitle || '',
          comment: comment,
          submittedAt: new Date().toISOString(),
          signatureUrl: signatureUrl
        };

        approvalHistory.push(newApproval);

        // Check if all levels are approved
        const totalLevels = (window._currentApprovalLevels || []).length || 1;
        const newApprovedCount = approvalHistory.filter(h => (h.status || '').toLowerCase() === 'approved').length;
        const allApproved = newApprovedCount >= totalLevels;

        // Update reservation
        const updateData = {
          approvalHistory: approvalHistory
        };

        // Only set status to approved when all levels are approved
        if (allApproved) {
          updateData.status = 'approved';
          updateData.approvedAt = new Date().toISOString();
          updateData.approvedBy = user.displayName || user.name || user.email;
          updateData.approvedByUid = user.uid;
        } else {
          // Keep status as pending if not all levels approved
          updateData.status = 'pending';
        }

        await db.ref(`companies/${companyId}/inventory/reservations/${viewingReservationId}`).update(updateData);

        await loadPageData();
        closeViewModal();
        alert('Reservation approved successfully.');
      } catch (err) {
        console.error('Error approving reservation:', err);
        alert('Failed to approve reservation.');
      }
    }

    // Decline reservation
    async function declineReservation() {
      console.log('Decline button clicked, viewingReservationId:', viewingReservationId);
      
      if (!viewingReservationId) {
        alert('Error: No reservation selected for decline.');
        return;
      }
      
      const comment = document.getElementById('resApprovalComment')?.value || '';
      if (!comment) {
        alert('Please provide a reason for declining this reservation.');
        document.getElementById('resApprovalComment')?.focus();
        return;
      }
      
      if (!confirm('Are you sure you want to decline this reservation?')) return;

      const user = currentUser;
      
      if (!user) {
        alert('Error: User not logged in.');
        return;
      }

      try {
        console.log('Declining reservation:', viewingReservationId);
        const r = reservationsCache[viewingReservationId];
        if (!r) {
          alert('Error: Reservation data not found.');
          return;
        }
        
        const approvalHistory = r.approvalHistory || [];
        // Determine next pending level based on existing approvals
        const approvedLevels = approvalHistory.filter(h => (h.status || '').toLowerCase() === 'approved').map(h => h.level);
        const nextLevel = (approvedLevels.length || 0) + 1;

        // Add to approval history
        const newDecline = {
          level: nextLevel,
          status: 'rejected',
          userId: user.uid,
          userName: user.displayName || user.name || user.email,
          userEmail: user.email,
          userJobTitle: user.jobTitle || '',
          comment: comment,
          submittedAt: new Date().toISOString()
        };

        approvalHistory.push(newDecline);

        // Update reservation
        await db.ref(`companies/${companyId}/inventory/reservations/${viewingReservationId}`).update({
          status: 'rejected',
          approvalHistory: approvalHistory,
          rejectedAt: new Date().toISOString(),
          rejectedBy: user.displayName || user.name || user.email,
          rejectedByUid: user.uid,
          rejectionReason: comment
        });

        await loadPageData();
        closeViewModal();
        alert('Reservation declined.');
      } catch (err) {
        console.error('Error declining reservation:', err);
        alert('Failed to decline reservation.');
      }
    }

    // Helpers
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] || c));
    }

    function capitalize(str) {
      return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }

    // Resolve employee record by UID or email
    async function resolveEmployeeRecord(identifier, companyIdVal) {
      if (!identifier || !companyIdVal) return null;
      console.log('resolveEmployeeRecord called with:', identifier, 'company:', companyIdVal);
      
      try {
        // First try users collection (this is where companymanagement.html stores users)
        const userSnap = await db.ref(`companies/${companyIdVal}/users/${identifier}`).once('value');
        if (userSnap.exists()) {
          console.log('Found in users collection:', userSnap.val());
          return { ...userSnap.val(), uid: identifier };
        }
        
        // Try companies/{companyId}/employees/{uid}
        const empSnap = await db.ref(`companies/${companyIdVal}/employees/${identifier}`).once('value');
        if (empSnap.exists()) {
          console.log('Found in employees collection:', empSnap.val());
          return { ...empSnap.val(), uid: identifier };
        }
        
        // If identifier looks like email, search all users by email
        if (String(identifier).includes('@')) {
          console.log('Searching by email:', identifier);
          
          // Search in users collection
          const allUsersSnap = await db.ref(`companies/${companyIdVal}/users`).once('value');
          if (allUsersSnap.exists()) {
            const users = allUsersSnap.val();
            for (const [uid, user] of Object.entries(users)) {
              if (user && user.email && user.email.toLowerCase() === identifier.toLowerCase()) {
                console.log('Found user by email in users collection:', user);
                return { ...user, uid };
              }
            }
          }
          
          // Search in employees collection
          const allEmpsSnap = await db.ref(`companies/${companyIdVal}/employees`).once('value');
          if (allEmpsSnap.exists()) {
            const emps = allEmpsSnap.val();
            for (const [uid, emp] of Object.entries(emps)) {
              if (emp && emp.email && emp.email.toLowerCase() === identifier.toLowerCase()) {
                console.log('Found employee by email in employees collection:', emp);
                return { ...emp, uid };
              }
            }
          }
        }
        
        console.log('Employee record not found for:', identifier);
      } catch (e) { 
        console.error('resolveEmployeeRecord error:', e); 
      }
      return null;
    }

    // Resolve line manager info (name + jobTitle) by manager id or name
    async function resolveLineManagerInfo(managerIdentifier, companyIdVal) {
      if (!managerIdentifier) return { name: '', jobTitle: '' };
      console.log('resolveLineManagerInfo called with:', managerIdentifier);
      
      // If managerIdentifier looks like a full name (has spaces), return as name directly
      if (typeof managerIdentifier === 'string' && managerIdentifier.includes(' ')) {
        console.log('Manager identifier looks like a name:', managerIdentifier);
        // It's already a name, try to find job title by searching users
        try {
          const usersSnap = await db.ref(`companies/${companyIdVal}/users`).once('value');
          if (usersSnap.exists()) {
            const users = usersSnap.val();
            for (const [uid, user] of Object.entries(users)) {
              const userName = user.name || user.displayName || `${user.firstName || ''} ${user.lastName || ''}`.trim();
              if (userName.toLowerCase() === managerIdentifier.toLowerCase()) {
                console.log('Found manager by name:', user);
                return { name: managerIdentifier, jobTitle: user.jobTitle || '' };
              }
            }
          }
        } catch (e) { console.log('Error searching by name:', e); }
        return { name: managerIdentifier, jobTitle: '' };
      }
      
      // If identifier looks like an email, search users by email first
      if (typeof managerIdentifier === 'string' && managerIdentifier.includes('@')) {
        try {
          const usersSnap = await db.ref(`companies/${companyIdVal}/users`).once('value');
          if (usersSnap.exists()) {
            const users = usersSnap.val();
            for (const [uid, user] of Object.entries(users)) {
              if ((user.email || '').toLowerCase() === String(managerIdentifier).toLowerCase()) {
                const name = user.displayName || user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                return { name, jobTitle: user.jobTitle || '' };
              }
            }
          }
        } catch (e) { console.log('Error searching manager by email:', e); }
      }

      // Try to resolve by UID using resolveEmployeeRecord
      console.log('Trying to resolve manager by UID:', managerIdentifier);
      const emp = await resolveEmployeeRecord(managerIdentifier, companyIdVal);
      if (emp) {
        const name = emp.displayName || emp.name || `${emp.firstName || ''} ${emp.lastName || ''}`.trim() || emp.email || String(managerIdentifier);
        console.log('Resolved manager by UID:', { name, jobTitle: emp.jobTitle || emp.position || '' });
        return { name, jobTitle: emp.jobTitle || emp.position || '' };
      }
      
      console.log('Manager not found, returning identifier as name');
      return { name: String(managerIdentifier), jobTitle: '' };
    }

    // ===== ROLE-BASED MENU AUTHORIZATION SYSTEM =====
    let isMenuUpdateInProgress = false;

    function resetMenuVisibility() {
      document.querySelectorAll('[data-feature]').forEach(item => item.classList.remove('menu-visible'));
      document.querySelectorAll('.menu-dropdown').forEach(dropdown => dropdown.classList.remove('menu-visible'));
    }

    function showBasicMenu() {
      resetMenuVisibility();
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.remove('menu-loading');
      const homeItem = document.querySelector('[data-feature="home_view"]');
      if (homeItem) homeItem.classList.add('menu-visible');
    }

    async function updateMenuWithFeatureAuthorization() {
      if (isMenuUpdateInProgress) return;
      isMenuUpdateInProgress = true;
      try {
        let currentUserData = null;
        let companyIdVal = null;
        let userRole = null;
        if (window.authManager && window.authManager.currentUser) {
          currentUserData = window.authManager.currentUser;
          companyIdVal = currentUserData.companyId;
          userRole = currentUserData.role;
        } else if (firebase.auth().currentUser) {
          currentUserData = firebase.auth().currentUser;
        } else {
          resetMenuVisibility();
          return;
        }
        if (!companyIdVal && currentUserData) {
          const companiesSnapshot = await firebase.database().ref('companies').once('value');
          if (companiesSnapshot.exists()) {
            const companies = companiesSnapshot.val();
            for (const [cId, company] of Object.entries(companies)) {
              if (company.status !== 'active') continue;
              if (company.users && company.users[currentUserData.uid]) {
                companyIdVal = cId;
                userRole = company.users[currentUserData.uid].role || company.users[currentUserData.uid].userRole;
                break;
              }
            }
          }
        }
        if (!companyIdVal) { resetMenuVisibility(); return; }
        const authorizedPages = await applyFeatureBasedMenuVisibility(companyIdVal);
        if (userRole) await applyRoleBasedFiltering(companyIdVal, userRole, authorizedPages);
      } catch (error) {
        console.error('Menu authorization error:', error);
        resetMenuVisibility();
      } finally {
        isMenuUpdateInProgress = false;
      }
    }

    async function applyFeatureBasedMenuVisibility(companyIdVal) {
      try {
        const database = firebase.database();
        const featuresSnapshot = await database.ref('/platformFeatures').once('value');
        if (!featuresSnapshot.exists()) { resetMenuVisibility(); return; }
        const featuresData = featuresSnapshot.val();
        const companySnapshot = await database.ref(`/companies/${companyIdVal}`).once('value');
        const companyDataLocal = companySnapshot.val();
        if (!companyDataLocal) { resetMenuVisibility(); return; }
        
        // Store company data globally for use in modals
        companyData = companyDataLocal;
        
        const subscribedFeatureIds = companyDataLocal.selectedFeatures || [];
        if (subscribedFeatureIds.length === 0) { resetMenuVisibility(); return; }
        if (subscribedFeatureIds.length === 0) { resetMenuVisibility(); return; }
        const authorizedPages = [];
        subscribedFeatureIds.forEach(featureId => {
          const feature = featuresData[featureId];
          if (feature && feature.status === 'active' && feature.authorizedPages) {
            authorizedPages.push(...feature.authorizedPages);
          }
        });
        resetMenuVisibility();
        const authorizedFeatures = new Set();
        const authorizedHrefs = new Set();
        const featureAlias = (key) => {
          if (!key) return key;
          if (key === 'risk_view') return 'risk_management_section';
          if (key === 'risk_management_section') return 'risk_view';
          return null;
        };
        const normalizeHref = (href) => {
          if (!href) return '';
          try { const u = new URL(href, window.location.origin); return (u.pathname || '').replace(/^\//, ''); } catch { return String(href).replace(/^\//, ''); }
        };
        authorizedPages.forEach(pageInfo => {
          if (pageInfo.feature) { authorizedFeatures.add(pageInfo.feature); const alias = featureAlias(pageInfo.feature); if (alias) authorizedFeatures.add(alias); }
          if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
          if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
          if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
        });
        const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
        allMenuItems.forEach(menuItem => {
          const featureAttribute = menuItem.getAttribute('data-feature');
          const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
          const anchor = menuItem.querySelector('a[href]');
          const href = anchor ? anchor.getAttribute('href') : '';
          const normalized = normalizeHref(href);
          const featureAuthorized = authorizedFeatures.has(featureAttribute);
          const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
          const isAuthorized = featureAuthorized || hrefAuthorized;
          if (isDropdownContainer) return;
          if (isAuthorized) menuItem.classList.add('menu-visible');
          else menuItem.classList.remove('menu-visible');
        });
        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
          const dropdownFeature = dropdown.getAttribute('data-feature');
          const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
          let hasVisibleChildren = false;
          submenuItems.forEach(submenuItem => { if (submenuItem.classList.contains('menu-visible')) hasVisibleChildren = true; });
          if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) dropdown.classList.add('menu-visible');
          else dropdown.classList.remove('menu-visible');
        });
        return authorizedPages;
      } catch (error) {
        console.error('Feature menu error:', error);
        resetMenuVisibility();
        return [];
      }
    }

    async function applyRoleBasedFiltering(companyIdVal, userRole, authorizedPages) {
      try {
        const database = firebase.database();
        const permissionsRef = database.ref(`companies/${companyIdVal}/roles/${userRole}/permissions`);
        const permissionsSnapshot = await permissionsRef.once('value');
        if (!permissionsSnapshot.exists()) {
          if (userRole === 'administrator') { showSidebarAfterAuth(); return; }
          hideItemsRequiringPermissions();
          showSidebarAfterAuth();
          return;
        }
        const permissions = permissionsSnapshot.val();
        filterMenuByPermissions(permissions);
      } catch (error) {
        console.error('Role filtering error:', error);
        showSidebarAfterAuth();
      }
    }

    function filterMenuByPermissions(permissions) {
      if (!permissions) { hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
      const permissionAlias = (key) => {
        if (!key) return key;
        if (key === 'risk_view') return 'risk_management_section';
        if (key === 'risk_management_section') return 'risk_view';
        return null;
      };
      const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
      itemsRequiringPermissions.forEach(item => {
        const requiresPermission = item.getAttribute('data-requires-permission');
        const perm = permissions[requiresPermission];
        const aliasKey = permissionAlias(requiresPermission);
        const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
        const hasViewPermission = (p) => p === true || (p && p.view === true);
        const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
        if (allowed) item.classList.add('menu-visible');
        else item.classList.remove('menu-visible');
      });
      const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
      dropdownMenus.forEach(dropdown => {
        const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        const dropdownRequires = dropdown.getAttribute('data-requires-permission');
        if (submenuItems.length === 0) {
          if (dropdownRequires) {
            const perm = permissions[dropdownRequires];
            const aliasKey = permissionAlias(dropdownRequires);
            const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
            const hasViewPermission = (p) => p === true || (p && p.view === true);
            const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
            if (allowed) dropdown.classList.add('menu-visible');
            else dropdown.classList.remove('menu-visible');
          } else {
            dropdown.classList.remove('menu-visible');
          }
        }
      });
      ensureHomeIsVisible();
      showSidebarAfterAuth();
    }

    function hideItemsRequiringPermissions() {
      const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
      itemsRequiringPermissions.forEach(item => item.classList.remove('menu-visible'));
      const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
      dropdownMenus.forEach(dropdown => {
        const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (visibleSubmenuItems.length === 0) dropdown.classList.remove('menu-visible');
      });
      ensureHomeIsVisible();
    }

    function ensureHomeIsVisible() {
      const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
      if (homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
    }

    function showSidebarAfterAuth() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.remove('menu-loading');
    }

    function initializeMenuAuthorization() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.add('menu-loading');
      setTimeout(() => updateMenuWithFeatureAuthorization(), 500);
    }

    window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

    // Initialize menu authorization after authManager loads
    const origInit = AuthManager.prototype.init;
    AuthManager.prototype.init = async function() {
      await origInit.call(this);
      initializeMenuAuthorization();
    };
    // ===== END ROLE-BASED MENU AUTHORIZATION SYSTEM =====
  </script>
</body>
</html>
