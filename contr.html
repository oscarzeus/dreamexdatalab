<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Contracts - Dreamex Datalab HSE Management System" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Contracts - Dreamex Datalab</title>

  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.onerror=null; console.warn('Font Awesome failed to load');" />
  <link rel="stylesheet" href="css/styles.css" onerror="this.onerror=null; console.warn('styles.css failed to load');" />
  <link rel="stylesheet" href="css/forms.css" onerror="this.onerror=null; console.warn('forms.css failed to load');" />

  <!-- Preconnects -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="preconnect" href="https://www.gstatic.com" />

  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --bg-color: #f5f6fa;
      --text-color: #333;
      --border-color: #e0e0e0;
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: var(--bg-color); color: var(--text-color); }
    .app-container { display: flex; min-height: 100vh; }
    .sidebar { width: 250px; background: #2c3e50; color: #fff; padding: 1rem; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; }
    .sidebar .logo h2 { text-align: center; padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; }
    .menu { list-style: none; padding: 0; margin: 0; }
    .menu a { color: #fff; text-decoration: none; display: flex; align-items: center; gap: .75rem; padding: .7rem 1rem; border-radius: 6px; }
    .menu a:hover { background: rgba(255,255,255,.08); }
    .menu .submenu { list-style: none; padding-left: 1.5rem; display: none; }
    .menu-dropdown:hover .submenu { display: block; }

    .main-content { flex: 1; margin-left: 250px; padding: 1rem; }
    .top-nav { background: #fff; padding: .5rem .75rem; box-shadow: 0 2px 5px rgba(0,0,0,.1); display: flex; align-items: center; justify-content: space-between; height: 50px; }
    .top-nav-left { display: flex; align-items: center; gap: 1rem; }
    .sidebar-toggle-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #333; padding: .5rem; border-radius: 6px; }
    .sidebar-toggle-btn:hover { background: rgba(0,0,0,0.07); }
    .header-company-logo { width: 32px; height: 32px; border-radius: 6px; object-fit: contain; display: none; }
    .header-company-logo.visible { display: block; }
    .header-logo-placeholder { width: 40px; height: 40px; border-radius: 8px; background: #f8f9fa; border: 2px dashed #ced4da; display: none; align-items: center; justify-content: center; color: #6c757d; }
    .company-name-header { font-weight: 600; color: #2c3e50; font-size: 1.05rem; }

    .user-profile { position:relative; }
    .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
    .profile-btn img { width:100%; height:100%; object-fit:cover; }
    .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; z-index:1000; }
    .profile-dropdown.show { display:block; }
    .profile-dropdown ul { list-style:none; margin:0; padding:0; }
    .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
    .profile-dropdown li a:hover { background:#f1f5f9; }

  /* Menu Visibility Styles - hide items until authorized */
  #roleBasedMenu [data-feature]:not(.menu-visible) { display: none !important; }
  #roleBasedMenu .menu-dropdown:not(.menu-visible) { display: none !important; }

    .content { background: #fff; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .page-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: .6rem 1rem; margin-bottom: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,.12); }
  .page-header h2 { margin: 0; }
  .page-actions { display:flex; gap:.5rem; }
  .btn-add-new { background:none; border:none; color:#fff; padding:.4rem; font-size:1.2rem; font-weight:600; cursor:pointer; transition:all .2s ease; display:flex; align-items:center; justify-content:center; text-decoration:none; }
  .btn-add-new:hover { color: rgba(255,255,255,0.85); transform: scale(1.08); }

    .toolbar { display:flex; gap:.5rem; align-items:center; justify-content: space-between; margin-bottom: .75rem; }
    .search-box input { padding: .5rem .65rem; border: 1px solid var(--border-color); border-radius: 6px; min-width: 220px; }
    .status-badge { display: inline-flex; align-items:center; gap:.4rem; padding: .25rem .5rem; border-radius: 999px; font-size: .75rem; }
    .status-draft { background:#fff7e6; color:#ad6800; }
    .status-active { background:#e6fffb; color:#006d75; }
    .status-completed { background:#f6ffed; color:#237804; }

    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 10px; background: #f8f9fa; color: #495057; border-bottom: 1px solid #e9ecef; white-space: nowrap; }
    tbody td { padding: 10px; border-bottom: 1px solid #f1f3f5; color: #343a40; vertical-align: middle; }
    tbody tr:hover { background: #f8f9ff; }
    .muted { color:#6c757d; }
    .success-banner { display:none; background:#d4edda; color:#155724; border:1px solid #c3e6cb; padding:.6rem .8rem; border-radius:6px; margin-bottom:.75rem; }
  </style>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="github-pages-fix.js" onerror="console.warn('GitHub Pages Fix not found');"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar (copied structure from project-list via contractsub) -->
    <nav class="sidebar menu-loading" id="sidebar">
      <div class="logo"><h2>Dreamex Datalab</h2></div>
    <ul class="menu" id="roleBasedMenu">
    <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
    </li>
    <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
      <a href="#"><i class="fas fa-medkit"></i> Health</a>
      <ul class="submenu">
        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
          <a href="health-assessment.html">Assessment</a>
        </li>
        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
          <a href="health-consultation.html">Consultation</a>
        </li>
        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
          <a href="medical-folder.html">Medical Folder</a>
        </li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
      <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
      <ul class="submenu">
        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
      <!-- Risk Management (separate section) -->
<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
<ul class="submenu">
<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
</ul>
</li></ul>
    </li>
    <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
    	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
    	<ul class="submenu">
        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
    	</ul>
    </li>
    <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
      <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
      <ul class="submenu">
        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
      </ul>
    </li>
    <!-- Workspaces: Catering -->
    <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
      <a href="#"><i class="fas fa-utensils"></i> Workspaces ï¿½ Catering</a>
      <ul class="submenu">
        <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
        <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
        <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
        <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
        <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
      <a href="#"><i class="fas fa-leaf"></i> Environment</a>
      <ul class="submenu">
        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
      <a href="#"><i class="fas fa-lock"></i> Security</a>
      <ul class="submenu">
        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
        <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
        <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
      <a href="#"><i class="fas fa-truck"></i> Logistics</a>
      <ul class="submenu">
        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
      <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
      <ul class="submenu">
        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
      <a href="#"><i class="fas fa-users"></i> HR</a>
      <ul class="submenu">
        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
        <li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
      </ul>
    </li>
    <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
      <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
      <ul class="submenu">
        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
      </ul>
    </li>
    <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
    <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
      <a href="#"><i class="fas fa-cog"></i> Settings</a>
      <ul class="submenu">
        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
      </ul>
    </li>
    </ul>
    </nav>

    <main class="main-content">
      <header class="top-nav">
        <div class="top-nav-left">
          <button id="sidebarToggle" class="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>
          <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo" />
          <div id="headerLogoPlaceholder" class="header-logo-placeholder"><i class="fas fa-building"></i></div>
          <span id="headerCompanyName" class="company-name-header"></span>
        </div>
        <div class="top-nav-right">
          <div class="user-profile">
            <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
            <div class="profile-dropdown"><ul></ul></div>
          </div>
        </div>
      </header>

      <div class="content">
        <div class="page-header" style="display:flex; align-items:center; justify-content:space-between;">
          <div style="display:flex; align-items:center; gap:.6rem;"><i class="fas fa-file-signature"></i><h2 style="font-size:1.05rem;">Contracts</h2></div>
          <div class="page-actions">
            <a href="contractsub.html" class="btn-add-new" title="New Contract"><i class="fas fa-plus"></i></a>
          </div>
        </div>

        <div id="successBanner" class="success-banner"><i class="fas fa-check-circle"></i> Contract created successfully.</div>

        <div class="toolbar">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by employee name or ID..." />
          </div>
          <div></div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Employee ID</th>
                <th>Job Title</th>
                <th>Band</th>
                <th>Salary</th>
                <th>Location</th>
                <th>Start Date</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contractsTableBody"></tbody>
          </table>
          <div id="emptyState" class="muted" style="padding:1rem; display:none;">No contracts found.</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Firebase Config (same as contractsub.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
      authDomain: "users-8be65.firebaseapp.com",
      databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
      projectId: "users-8be65",
      storageBucket: "users-8be65.firebasestorage.app",
      messagingSenderId: "829083030831",
      appId: "1:829083030831:web:36a370e62691e560bc3dda"
    };

  let database = null;
  let currentUser = null;
  let currentCompanyId = null;
  let currentUserRole = null;
    let allContracts = [];
  let isMenuUpdateInProgress = false;

    function initFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();
      } catch (e) { console.error('Firebase init failed', e); }
    }

    function qs(sel){return document.querySelector(sel);}    

    function loadCompanyHeader() {
      const companyData = JSON.parse(localStorage.getItem('currentCompany') || '{}');
      const logo = qs('#headerCompanyLogo');
      const logoPh = qs('#headerLogoPlaceholder');
      const nameEl = qs('#headerCompanyName');
      if (nameEl) nameEl.textContent = companyData.companyName || 'Dreamex Datalab HSE';
      if (companyData.logoUrl || companyData.logo) {
        if (logo) { logo.src = companyData.logoUrl || companyData.logo; logo.classList.add('visible'); logo.style.display='block'; }
        if (logoPh) logoPh.style.display = 'none';
      } else {
        if (logo) logo.style.display = 'none';
        if (logoPh) logoPh.style.display = 'flex';
      }
    }

    async function loadUserCompanyData(user) {
      try {
        const snap = await database.ref(`users/${user.uid}`).once('value');
        const userData = snap.val() || {};
        if (userData.companyId) {
          currentCompanyId = userData.companyId;
          // Cache company details for header
          const csnap = await database.ref(`companies/${currentCompanyId}`).once('value');
          const cdata = csnap.val() || {};
          localStorage.setItem('currentCompany', JSON.stringify({ companyId: currentCompanyId, companyName: cdata.companyName, ...cdata }));
          // Try to get the user's role within the company
          try {
            const usrSnap = await database.ref(`companies/${currentCompanyId}/users/${user.uid}`).once('value');
            const u = usrSnap.val() || {};
            currentUserRole = u.role || u.userRole || null;
          } catch (e) { currentUserRole = null; }
          loadCompanyHeader();
        } else {
          loadCompanyHeader();
        }
      } catch(err){ console.error('loadUserCompanyData error', err); loadCompanyHeader(); }
    }

    function resetMenuVisibilityClasses() {
      document.querySelectorAll('#roleBasedMenu li').forEach(li => li.classList.remove('menu-visible'));
    }

    async function updateMenuWithFeatureAuthorization() {
      if (isMenuUpdateInProgress) return;
      isMenuUpdateInProgress = true;
      try {
        let user = firebase.auth().currentUser;
        let companyId = currentCompanyId;
        let userRole = currentUserRole;
        if (!user) { resetMenuVisibilityClasses(); return; }
        if (!companyId) {
          // fallback: discover company by membership
          const companiesSnapshot = await database.ref('companies').once('value');
          if (companiesSnapshot.exists()) {
            const companies = companiesSnapshot.val();
            for (const [cId, company] of Object.entries(companies)) {
              if (company.status !== 'active') continue;
              if (company.users && company.users[user.uid]) {
                companyId = currentCompanyId = cId;
                userRole = currentUserRole = company.users[user.uid].role || company.users[user.uid].userRole;
                // also cache header data
                const cdata = company;
                localStorage.setItem('currentCompany', JSON.stringify({ companyId: cId, companyName: cdata.companyName, ...cdata }));
                break;
              }
            }
          }
        }
        if (!companyId) { resetMenuVisibilityClasses(); return; }
        const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
        if (userRole) await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
      } catch (e) {
        console.error('Menu authorization error:', e);
        resetMenuVisibilityClasses();
      } finally {
        isMenuUpdateInProgress = false;
      }
    }

    async function applyFeatureBasedMenuVisibility(companyId) {
      try {
        const featuresSnapshot = await database.ref('/platformFeatures').once('value');
        if (!featuresSnapshot.exists()) { resetMenuVisibilityClasses(); return []; }
        const featuresData = featuresSnapshot.val();
        const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
        const companyData = companySnapshot.val();
        if (!companyData) { resetMenuVisibilityClasses(); return []; }
        const subscribedFeatureIds = companyData.selectedFeatures || [];
        if (subscribedFeatureIds.length === 0) { resetMenuVisibilityClasses(); return []; }

        const authorizedPages = [];
        subscribedFeatureIds.forEach(featureId => {
          const feature = featuresData[featureId];
          if (feature && feature.status === 'active' && feature.authorizedPages) authorizedPages.push(...feature.authorizedPages);
        });

        resetMenuVisibilityClasses();
        const authorizedFeatures = new Set();
        authorizedPages.forEach(p => { if (p.feature) authorizedFeatures.add(p.feature); });

        const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
        allMenuItems.forEach(menuItem => {
          const featureAttribute = menuItem.getAttribute('data-feature');
          const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
          if (isDropdownContainer) return;
          if (authorizedFeatures.has(featureAttribute)) menuItem.classList.add('menu-visible');
        });

        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
          const dropdownFeature = dropdown.getAttribute('data-feature');
          const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
          let hasVisibleChildren = false;
          submenuItems.forEach(si => { if (si.classList.contains('menu-visible')) hasVisibleChildren = true; });
          if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) dropdown.classList.add('menu-visible');
        });
        ensureHomeIsVisible();
        showSidebarAfterAuth();
        return authorizedPages;
      } catch (e) {
        console.error('Feature-based visibility error:', e);
        resetMenuVisibilityClasses();
        showSidebarAfterAuth();
        return [];
      }
    }

    async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
      try {
        const permissionsSnapshot = await database.ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
        if (!permissionsSnapshot.exists()) { hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
        const permissions = permissionsSnapshot.val();
        filterMenuByPermissions(permissions);
      } catch (e) {
        console.error('Role-based filtering error:', e);
        showSidebarAfterAuth();
      }
    }

    function filterMenuByPermissions(permissions) {
      if (!permissions) { hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
      const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
      visibleMenuItems.forEach(item => {
        const requiresPermission = item.getAttribute('data-requires-permission');
        const hasPermission = permissions[requiresPermission];
        const hasViewPermission = hasPermission === true || (hasPermission && hasPermission.view === true);
        if (!hasViewPermission) item.classList.remove('menu-visible');
      });
      const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
      dropdownMenus.forEach(dropdown => {
        const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (submenuItems.length === 0) dropdown.classList.remove('menu-visible');
      });
      ensureHomeIsVisible();
    }

    function hideItemsRequiringPermissions() {
      const items = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
      items.forEach(item => item.classList.remove('menu-visible'));
      const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
      dropdownMenus.forEach(dropdown => {
        const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (submenuItems.length === 0) dropdown.classList.remove('menu-visible');
      });
      ensureHomeIsVisible();
    }

    function ensureHomeIsVisible() {
      const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
      if (homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
    }

    function showSidebarAfterAuth() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.remove('menu-loading');
    }

    function initializeMenuAuthorization() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.add('menu-loading');
      setTimeout(() => {
        if (firebase && firebase.database) updateMenuWithFeatureAuthorization();
        else {
          // fallback: show all
          document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li => li.classList.add('menu-visible'));
          showSidebarAfterAuth();
        }
      }, 300);
    }

    function statusBadge(status){
      const s = (status||'').toLowerCase();
      if (s === 'active') return '<span class="status-badge status-active"><i class="fas fa-play"></i> Active</span>';
      if (s === 'completed' || s === 'closed') return '<span class="status-badge status-completed"><i class="fas fa-check"></i> Completed</span>';
      return '<span class="status-badge status-draft"><i class="fas fa-pen"></i> Draft</span>';
    }

    function renderContracts(list){
      const tbody = qs('#contractsTableBody');
      const empty = qs('#emptyState');
      tbody.innerHTML = '';
      if (!list || !list.length) { empty.style.display='block'; return; } else { empty.style.display='none'; }
      const term = (qs('#searchInput').value || '').toLowerCase();
      const filtered = term ? list.filter(c => (c.employeeName||'').toLowerCase().includes(term) || (c.employeeId||'').toLowerCase().includes(term)) : list;
      filtered.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
      tbody.innerHTML = filtered.map(c => `
        <tr data-id="${c.contractId||''}">
          <td>${c.employeeName||'-'}</td>
          <td class="muted">${c.employeeId||'-'}</td>
          <td>${c.jobTitle||c.positionTitle||c.position||'-'}</td>
          <td>${c.compGrade||c.band||c.bandName||c.gradeBand||c.gradeLabel||'-'}</td>
          <td>${
            (function(){
              const cur = c.gradeCurrency || c.currency || '';
              let val = null;
              if (c.salaryAmount!=null) val = Number(c.salaryAmount);
              else if (c.basicSalary!=null) val = Number(c.basicSalary);
              else if (c.compGradeItemValue!=null) val = Number(c.compGradeItemValue);
              if (val==null || !isFinite(val)) return '-';
              try { return (cur ? (cur + ' ') : '') + val.toLocaleString(); } catch(_) { return (cur ? (cur + ' ') : '') + val; }
            })()
          }</td>
          <td>${c.location||c.workLocation||'-'}</td>
          <td>${c.startDate||'-'}</td>
          <td>${statusBadge(c.status)}</td>
          <td class="muted">${((c.createdAt||c.updatedAt)||'').replace('T',' ').replace('Z','')}</td>
          <td>
            <a href="contractsub.html?edit=1&id=${encodeURIComponent(c.contractId||'')}&cid=${encodeURIComponent(c.companyId||currentCompanyId||'')}&tab=employeeDetails" 
               title="Edit" style="text-decoration:none; padding:.3rem .5rem; border:1px solid #dee2e6; border-radius:6px; color:#495057;">
               <i class="fas fa-pen"></i>
            </a>
            <button type="button" 
                    title="Delete" 
                    data-delete-contract="${c.contractId||''}"
                    style="margin-left:.4rem; padding:.3rem .5rem; border:1px solid #f1c2c2; background:#fff5f5; color:#c0392b; border-radius:6px; cursor:pointer;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>`).join('');
    }

    function attachContractsListener(){
      const path = currentCompanyId ? `companies/${currentCompanyId}/contracts` : 'contracts';
      database.ref(path).on('value', snap => {
        const val = snap.val() || {};
        allContracts = Object.keys(val).map(k => ({ contractId: k, ...val[k] }));
        renderContracts(allContracts);
        highlightCreatedIfAny();
      }, err => console.error('contracts listener error', err));
    }

    function highlightCreatedIfAny(){
      const url = new URL(window.location.href);
      const created = url.searchParams.get('created');
      const updated = url.searchParams.get('updated');
      const id = url.searchParams.get('id');
      const banner = qs('#successBanner');
      if (!banner) return;
      if (created === '1' || updated === '1') {
        // Set banner message
        banner.innerHTML = (updated === '1')
          ? '<i class="fas fa-check-circle"></i> Contract updated successfully.'
          : '<i class="fas fa-check-circle"></i> Contract created successfully.';
        banner.style.display = 'block';
        if (id) {
          const row = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
          if (row) { row.style.outline = '2px solid #52c41a'; row.scrollIntoView({behavior:'smooth', block:'center'}); }
        }
        // Clear the query params to prevent repeated banner on refresh
        setTimeout(()=>{
          const clean = new URL(window.location.href);
          clean.searchParams.delete('created');
          clean.searchParams.delete('updated');
          history.replaceState(null, '', clean.toString());
        }, 1500);
      }
    }

    function setupUI(){
      qs('#sidebarToggle')?.addEventListener('click', ()=>{
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.querySelector('.main-content').classList.toggle('expanded');
      });
      qs('#searchInput')?.addEventListener('input', ()=> renderContracts(allContracts));
      setupProfileDropdown();
      bindContractActions();
    }

    function setupProfileDropdown() {
      const btn = qs('#userProfileBtn');
      const dd = qs('.profile-dropdown');
      if (btn && dd) {
        btn.addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('show'); });
        document.addEventListener('click', e => { if (!btn.contains(e.target)) dd.classList.remove('show'); });
      }
    }

    async function getUserAvatarUrl(user) {
      if (!user) return null;
      const companyId = currentCompanyId || 'default';
      const possiblePaths = [
        `companies/${companyId}/avatars/${user.uid}/profile.jpg`,
        `companies/${companyId}/avatars/${user.uid}/profile.png`,
        `companies/${companyId}/avatars/${user.uid}/profile.jpeg`,
        `companies/${companyId}/avatars/${user.uid}/avatar.jpg`,
        `companies/${companyId}/avatars/${user.uid}/avatar.png`,
        `avatars/${user.uid}/profile.jpg`,
        `avatars/${user.uid}/profile.png`,
        `avatars/${user.uid}/avatar.jpg`,
        `avatars/${user.uid}/avatar.png`,
        `profiles/${user.uid}/profile.jpg`,
        `profiles/${user.uid}/profile.png`
      ];
      for (const path of possiblePaths) {
        try {
          const ref = firebase.storage().ref(path);
          const url = await ref.getDownloadURL();
          return url;
        } catch (err) { continue; }
      }
      return user.photoURL || null;
    }

    async function updateUserProfile(user) {
      const btn = qs('#userProfileBtn');
      const list = qs('.profile-dropdown ul');
      if (!btn || !list || !user) return;
      
      const displayName = user.displayName || user.email || 'User';
      const email = user.email || '';
      
      // Try to get custom avatar URL from Firebase Storage
      let avatarUrl = null;
      try { avatarUrl = await getUserAvatarUrl(user); } catch (error) { }
      
      // Update button avatar
      if (avatarUrl) {
        btn.innerHTML = `<img src="${avatarUrl}" alt="User Avatar" />`;
      } else {
        // Show initials
        const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${initials}</div>`;
      }
      
      // Update dropdown content
      const avatarHtml = avatarUrl ? 
        `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : 
        `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}</div>`;
      
      list.innerHTML = `
        <li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;">
          <div style="display:flex;align-items:center;gap:12px;">
            ${avatarHtml}
            <div>
              <div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div>
              <div style="color:#666;font-size:12px;">${email}</div>
            </div>
          </div>
        </li>
        <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
        <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
        <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
      `;
      
      // Bind logout
      list.querySelector('#logoutLink')?.addEventListener('click', e => {
        e.preventDefault();
        firebase.auth().signOut().then(() => {
          localStorage.removeItem('currentUser');
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        }).catch(err => {
          console.error('Logout error:', err);
          window.location.href = 'login.html';
        });
      });
    }

    function showBanner(message){
      const banner = qs('#successBanner');
      if(!banner) return;
      banner.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      banner.style.display = 'block';
      setTimeout(()=>{ banner.style.display='none'; }, 1500);
    }

    function bindContractActions(){
      const tbody = qs('#contractsTableBody');
      if(!tbody || tbody.__actionsBound) return;
      tbody.__actionsBound = true;
      tbody.addEventListener('click', async (e)=>{
        const delBtn = e.target.closest('[data-delete-contract]');
        if(!delBtn) return;
        const id = delBtn.getAttribute('data-delete-contract');
        if(!id) return;
        const contract = (allContracts||[]).find(x=> (x.contractId===id));
        const label = contract?.employeeName || contract?.employeeId || id;
        const ok = confirm(`Delete contract for ${label}? This action cannot be undone.`);
        if(!ok) return;
        try{
          const path = currentCompanyId ? `companies/${currentCompanyId}/contracts/${id}` : `contracts/${id}`;
          await database.ref(path).remove();
          showBanner('Contract deleted successfully.');
        }catch(err){
          console.error('Failed to delete contract', err);
          alert('Failed to delete contract. Please check the console for details.');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      setupUI();
      firebase.auth().onAuthStateChanged(async (user)=>{
        currentUser = user;
        if (user) {
          await loadUserCompanyData(user);
          updateUserProfile(user);
          attachContractsListener();
          initializeMenuAuthorization();
        } else {
          // Not logged in: still try to render header and global contracts
          loadCompanyHeader();
          attachContractsListener();
          initializeMenuAuthorization();
        }
      });
    });
  </script>
</body>
</html>
