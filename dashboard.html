<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Data Analysis Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        
        main {
            width: 100%;
            box-sizing: border-box;
            padding: 0;
        }

        /* Dashboard specific styles */
        .dashboard-container {
            width: 100%;
            max-width: none;
            margin: 80px 0 20px 0;
            padding: 15px;
            box-sizing: border-box;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dashboard-title h2 {
            margin: 0;
            color: #34495e;
        }

        .dashboard-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .dashboard-actions {
            display: flex;
            gap: 10px;
        }

        .dashboard-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .refresh-btn {
            background-color: #3498db;
            color: white;
        }

        .refresh-btn:hover {
            background-color: #2980b9;
        }

        .dashboard-search {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .dashboard-search input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .dashboard-search button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* User table styles */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .user-table th,
        .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
        }

        .user-table tbody tr:hover {
            background-color: #f5f7fa;
        }

        .user-avatar-cell {
            width: 60px;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-initial-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background-color: #f5f5f5;
        }

        .pagination-btn.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard stats styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Menu bar styles */
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }

        /* User Avatar Styles */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            min-width: 150px;
            display: none;
            z-index: 1000;
        }
        
        .user-avatar-container:hover .user-dropdown {
            display: block;
        }
        
        .user-dropdown .user-email {
            padding: 5px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        
        .user-dropdown a {
            display: block;
            padding: 5px 0;
            color: #34495e;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s ease;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.25s, opacity 0.25s;
        }
        
        .modal-visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        
        .modal-container {
            background-color: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #34495e;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 22px;
            color: #7f8c8d;
        }
        
        .modal-form .form-group {
            margin-bottom: 20px;
        }
        
        .modal-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .modal-form .form-row {
            display: flex;
            gap: 15px;
        }
        
        .modal-form .form-row > div {
            flex: 1;
        }
        
        .modal-form .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .modal-form .has-error input {
            border-color: #e74c3c;
        }
        
        .modal-form .has-error .error-message {
            display: block;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .modal-cancel {
            background-color: #f1f2f6;
            color: #333;
        }
        
        .modal-save {
            background-color: #3498db;
            color: white;
        }
        
        .modal-save:hover {
            background-color: #2980b9;
        }
        
        .modal-cancel:hover {
            background-color: #e8e8e8;
        }
        
        /* Button to create user */
        .create-user-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .create-user-btn:hover {
            background-color: #27ae60;
        }
        
        /* Clickable table rows */
        .user-table tbody tr {
            cursor: pointer;
        }

        .modal-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .modal-delete:hover {
            background-color: #c0392b;
        }
        
        .restricted-user {
            opacity: 0.7;
            cursor: not-allowed !important;
        }
        
        .dashboard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Add styles for permissions display if not already present */
        .permissions-container {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 12px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 10px;
            background-color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        
        .permission-item:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }
        
        .permission-checkbox {
            margin-right: 10px;
        }
        
        .permission-label {
            flex: 1;
            font-size: 14px;
        }
        
        .permissions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .permissions-title {
            font-weight: 600;
            color: #34495e;
            font-size: 15px;
        }
        
        .reset-permissions {
            background-color: #f1f2f6;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .reset-permissions:hover {
            background-color: #e8e8e8;
        }

        /* Add styles for the permissions note */
        .permissions-note {
            padding: 10px;
            margin-bottom: 15px;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            font-size: 13px;
            color: #856404;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 10px;
            background-color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        
        /* Highlight independent permissions with different styling */
        .permission-item.independent {
            border-left: 3px solid #3498db;
        }

        /* Add style for permission denied message */
        .permission-denied-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
            font-size: 14px;
        }
        
        /* Style for disabled buttons due to permissions */
        .disabled-by-permission {
            opacity: 0.5;
            cursor: not-allowed !important;
            position: relative;
        }
        
        .disabled-by-permission::after {
            content: 'ðŸ”’';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
        }

        /* Add styles for restricted view banner */
        .restricted-view-banner {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .restricted-view-banner .banner-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .restricted-view-banner .banner-message {
            flex-grow: 1;
        }
        
        .restricted-view-banner .banner-actions button {
            background-color: #ffc107;
            color: #212529;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .restricted-view-banner .banner-actions button:hover {
            background-color: #e0a800;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Add notification styles */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            background-color: white;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out forwards;
            position: relative;
            max-width: 100%;
        }
        
        .notification.success {
            border-left-color: #2ecc71;
        }
        
        .notification.warning {
            border-left-color: #f39c12;
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .notification-title {
            font-weight: bold;
            margin: 0;
            padding-right: 20px;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
        }
        
        .notification-body {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .notification-time {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Notification bell styles */
        .notification-bell-container {
            position: relative;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .notification-bell {
            font-size: 20px;
            color: #ecf0f1;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }
        
        .notification-bell:hover {
            color: #f1c40f;
        }
        
        .notification-counter {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            box-sizing: border-box;
            border: 1px solid #34495e;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 320px;
            z-index: 1001;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-bell-container:hover .notification-dropdown,
        .notification-bell-container.active .notification-dropdown {
            display: block;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #34495e;
        }
        
        .notification-header-actions {
            display: flex;
            gap: 10px;
        }
        
        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
        }
        
        .notification-header-actions button:hover {
            text-decoration: underline;
        }
        
        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .notification-list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        
        .notification-list-item:last-child {
            border-bottom: none;
        }
        
        .notification-list-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-list-item.unread {
            background-color: rgba(52, 152, 219, 0.05);
            position: relative;
        }
        
        .notification-list-item.unread:before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: #3498db;
            border-radius: 50%;
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .notification-icon {
            margin-right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .notification-icon.warning {
            background-color: #f39c12;
        }
        
        .notification-icon.error {
            background-color: #e74c3c;
        }
        
        .notification-icon.success {
            background-color: #2ecc71;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .notification-message {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #7f8c8d;
        }
        
        .notification-time {
            font-size: 11px;
            color: #95a5a6;
        }
        
        .notification-empty {
            padding: 30px 15px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        
        /* Make notification bell and user avatar aligned */
        .menu-bar ul.menu-right {
            display: flex;
            align-items: center;
        }

        /* Enhanced Notification Bell Styles */
        .notification-bell-container {
            position: relative;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .notification-bell {
            font-size: 22px;
            color: #ecf0f1;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 50%;
            width: 24px;
            height: 24px;
        }
        
        .notification-bell:hover {
            color: #f1c40f;
            transform: scale(1.1);
        }
        
        @keyframes bellShake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            92% { transform: rotate(1deg); }
            100% { transform: rotate(0); }
        }
        
        .notification-bell.has-new {
            animation: bellShake 2s cubic-bezier(.36,.07,.19,.97) infinite;
            animation-delay: 2s;
        }
        
        .notification-counter {
            position: absolute;
            top: 3px;
            right: 3px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            box-sizing: border-box;
            border: 2px solid #34495e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transform: scale(1);
            transition: transform 0.2s ease;
        }
        
        .notification-bell:hover .notification-counter {
            transform: scale(1.1);
        }
        
        .notification-dropdown {
            position: absolute;
            top: 48px;
            right: -10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            width: 350px;
            z-index: 1001;
            display: none;
            max-height: 450px;
            overflow-y: auto;
            animation: dropdownFadeIn 0.3s ease-out;
            border: 1px solid rgba(0,0,0,0.08);
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-bell-container:hover .notification-dropdown,
        .notification-bell-container.active .notification-dropdown {
            display: block;
        }
        
        /* Triangle pointer for dropdown */
        .notification-dropdown::before {
            content: '';
            position: absolute;
            top: -10px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid white;
            filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.1));
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 12px 12px 0 0;
            z-index: 5;
        }
        
        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .notification-header-actions {
            display: flex;
            gap: 15px;
        }
        
        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 0;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .notification-header-actions button:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        .notification-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 #f5f5f5;
        }
        
        .notification-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .notification-list::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        
        .notification-list::-webkit-scrollbar-thumb {
            background-color: #bdc3c7;
            border-radius: 6px;
        }
        
        .notification-list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .notification-list-item:last-child {
            border-bottom: none;
            border-radius: 0 0 12px 12px;
        }
        
        .notification-list-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-list-item.unread {
            background-color: rgba(52, 152, 219, 0.05);
            position: relative;
        }
        
        .notification-list-item.unread:before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background-color: #3498db;
            border-radius: 50%;
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .notification-icon {
            margin-right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }
        
        .notification-icon.warning {
            background-color: #f39c12;
            box-shadow: 0 2px 5px rgba(243, 156, 18, 0.3);
        }
        
        .notification-icon.error {
            background-color: #e74c3c;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }
        
        .notification-icon.success {
            background-color: #2ecc71;
            box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            line-height: 1.3;
        }
        
        .notification-message {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .notification-time {
            font-size: 11px;
            color: #95a5a6;
            font-style: italic;
        }
        
        .notification-empty {
            padding: 40px 15px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23ecf0f1" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>');
            background-position: center 30px;
            background-repeat: no-repeat;
            background-size: 60px;
            padding-top: 100px;
        }
        
        /* Make notification bell and user avatar aligned */
        .menu-bar ul.menu-right {
            display: flex;
            align-items: center;
        }
        
        /* Bell icon using SVG for better quality */
        .bell-icon-svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        /* Pulse animation for new notifications */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Add hover states for notification items */
        .notification-list-item:hover .notification-icon {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        /* Mark as read button within each notification */
        .notification-mark-read {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: none;
            transition: all 0.2s ease;
        }
        
        .notification-list-item:hover .notification-mark-read {
            display: block;
        }
        
        .notification-mark-read:hover {
            color: #7f8c8d;
            background-color: rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li class=""><a href="index.html">Home</a></li>
                <li><a href="riskassessment.html">Risk Assessment</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="account.html">Account</a></li>
                <li><a href="log.html">Log</a></li>
                <li><a href="evnt.html">Event</a></li>
                <li><a href="eventboard.html">Event Board</a></li>
            </ul>
            <ul class="menu-right">
                <!-- Enhanced Notification Bell -->
                <li class="notification-bell-container" id="notificationBellContainer">
                    <div class="notification-bell" id="notificationBell">
                        <svg class="bell-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-counter" id="notificationCounter" style="display: none;">0</span>
                    </div>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h4>Notifications</h4>
                            <div class="notification-header-actions">
                                <button id="markAllReadBtn">Mark all read</button>
                                <button id="clearAllBtn">Clear all</button>
                            </div>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">No notifications to display</div>
                        </div>
                    </div>
                </li>
                
                <!-- User Avatar/Login Button -->
                <li class="user-avatar-container">
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar">
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">user@example.com</div>
                        <a href="profile.html">My Profile</a>
                        <a href="account.html">Account Settings</a>
                        <a href="#" id="logoutButton">Log Out</a>
                        <a href="login.html" id="loginButton" style="display: none;">Log In</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <main>
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h2>User Dashboard</h2>
                    <p>Manage and monitor all registered users in real-time</p>
                </div>
                <div class="dashboard-actions">
                    <button class="dashboard-btn create-user-btn" id="createUserBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        Create User
                    </button>
                    <button class="dashboard-btn refresh-btn" id="refreshBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Add restricted view banner -->
            <div class="restricted-view-banner" id="restrictedViewBanner" style="display: none;">
                <div class="banner-icon">ðŸ”’</div>
                <div class="banner-message">
                    <strong>Restricted view:</strong> You can only see your own user profile because you don't have permission to view other users.
                </div>
                <div class="banner-actions">
                    <button id="dismissBannerBtn">Dismiss</button>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsersCount">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsersCount">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="withPhotoCount">0</div>
                    <div class="stat-label">With Profile Photo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="withPermissionsCount">0</div>
                    <div class="stat-label">Custom Permissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="newUsersCount">0</div>
                    <div class="stat-label">New Users (7 days)</div>
                </div>
            </div>

            <div class="dashboard-search">
                <input type="text" id="searchInput" placeholder="Search by name or email...">
                <button id="searchBtn">Search</button>
            </div>

            <table class="user-table">
                <thead>
                    <tr>
                        <th class="user-avatar-cell">Avatar</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Created</th>
                        <th>Last Updated</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- User rows will be inserted here dynamically -->
                </tbody>
            </table>

            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be inserted here dynamically -->
            </div>
        </div>
    </main>

    <!-- Add notification container -->
    <div class="notification-container" id="notificationContainer">
        <!-- Notifications will be added here dynamically -->
    </div>

    <!-- User Create Modal -->
    <div id="createUserModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="modal-close" id="closeCreateModal">&times;</button>
            </div>
            <form id="createUserForm" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="createFirstName">First Name</label>
                        <input type="text" id="createFirstName" name="firstName" required>
                        <div class="error-message">Please enter a first name</div>
                    </div>
                    <div class="form-group">
                        <label for="createLastName">Last Name</label>
                        <input type="text" id="createLastName" name="lastName" required>
                        <div class="error-message">Please enter a last name</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="createEmail">Email</label>
                    <input type="email" id="createEmail" name="email" required>
                    <div class="error-message">Please enter a valid email address</div>
                </div>
                <div class="form-group">
                    <label for="createPassword">Password</label>
                    <input type="password" id="createPassword" name="password" required minlength="6">
                    <div class="error-message">Password must be at least 6 characters</div>
                </div>
                <div class="form-group">
                    <label for="createStatus">Status</label>
                    <select id="createStatus" name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="createRole">Role</label>
                    <select id="createRole" name="role">
                        <option value="user">User</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                
                <!-- Add permissions display section -->
                <div class="form-group" id="createPermissionsDisplay">
                    <div class="permissions-header">
                        <div class="permissions-title">User Permissions</div>
                        <button type="button" class="reset-permissions" id="createResetPermissionsBtn">Apply Role Defaults</button>
                    </div>
                    <div class="permissions-container" id="createPermissionsContainer">
                        <!-- Permissions will be displayed here -->
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-cancel" id="cancelCreateUser">Cancel</button>
                    <button type="submit" class="modal-btn modal-save">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <form id="editUserForm" class="modal-form">
                <input type="hidden" id="editUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFirstName">First Name</label>
                        <input type="text" id="editFirstName" name="firstName" required>
                        <div class="error-message">Please enter a first name</div>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name</label>
                        <input type="text" id="editLastName" name="lastName" required>
                        <div class="error-message">Please enter a last name</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" name="email" required>
                    <div class="error-message">Please enter a valid email address</div>
                </div>
                <div class="form-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus" name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editProfileImage">Profile Image URL (optional)</label>
                    <input type="url" id="editProfileImage" name="profileImage">
                </div>
                <div class="form-group">
                    <label for="editRole">Role</label>
                    <select id="editRole" name="role">
                        <option value="user">User</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                
                <!-- Add permissions display section -->
                <div class="form-group" id="editPermissionsDisplay">
                    <div class="permissions-header">
                        <div class="permissions-title">User Permissions</div>
                        <button type="button" class="reset-permissions" id="editResetPermissionsBtn">Apply Role Defaults</button>
                    </div>
                    <div class="permissions-container" id="editPermissionsContainer">
                        <!-- Permissions will be displayed here -->
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-delete" id="deleteUserBtn">Delete User</button>
                    <div class="modal-right-buttons">
                        <button type="button" class="modal-btn modal-cancel" id="cancelEditUser">Cancel</button>
                        <button type="submit" class="modal-btn modal-save">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Confirm Action</h3>
                <button class="modal-close" id="closeConfirmationModal">&times;</button>
            </div>
            <div style="padding: 10px 0 20px;">
                <p id="confirmationMessage">Are you sure you want to delete this user? This action cannot be undone.</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelConfirmation">Cancel</button>
                <button class="modal-btn modal-delete" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.appspot.com",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Global variables
        let allUsers = [];
        let currentUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        let searchTerm = '';
        
        // Add variables to track permissions for both forms
        let createFormPermissions = {};
        let editFormPermissions = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Check if user is authenticated with Firebase
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in
                        console.log("User is authenticated:", user.email);
                        initializeDashboard(user);
                    } else {
                        // User is not signed in, redirect to login
                        console.log("User not authenticated, redirecting to login");
                        window.location.href = "login.html";
                    }
                });
                
                // Get DOM elements
                const userTableBody = document.getElementById('userTableBody');
                const searchInput = document.getElementById('searchInput');
                const searchBtn = document.getElementById('searchBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                const pagination = document.getElementById('pagination');
                const loadingOverlay = document.getElementById('loadingOverlay');
                
                // Set up event listeners
                searchBtn.addEventListener('click', handleSearch);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') handleSearch();
                });
                refreshBtn.addEventListener('click', refreshUsers);
                
                // Create User Modal Elements
                const createUserBtn = document.getElementById('createUserBtn');
                const createUserModal = document.getElementById('createUserModal');
                const closeCreateModal = document.getElementById('closeCreateModal');
                const cancelCreateUser = document.getElementById('cancelCreateUser');
                const createUserForm = document.getElementById('createUserForm');
                
                // Edit User Modal Elements
                const editUserModal = document.getElementById('editUserModal');
                const closeEditModal = document.getElementById('closeEditModal');
                const cancelEditUser = document.getElementById('cancelEditUser');
                const editUserForm = document.getElementById('editUserForm');
                
                // Confirmation Modal Elements
                const confirmationModal = document.getElementById('confirmationModal');
                const closeConfirmationModal = document.getElementById('closeConfirmationModal');
                const cancelConfirmation = document.getElementById('cancelConfirmation');
                const confirmAction = document.getElementById('confirmAction');
                const deleteUserBtn = document.getElementById('deleteUserBtn');
                
                // Create User Modal Handlers
                createUserBtn.addEventListener('click', () => {
                    createUserModal.classList.add('modal-visible');
                    createUserForm.reset();
                    
                    // Initialize permissions based on default role (user)
                    updateCreatePermissionsDisplay('user');
                });
                
                closeCreateModal.addEventListener('click', () => {
                    createUserModal.classList.remove('modal-visible');
                });
                
                cancelCreateUser.addEventListener('click', () => {
                    createUserModal.classList.remove('modal-visible');
                });
                
                // Add event listener for role dropdown change in create form
                document.getElementById('createRole').addEventListener('change', function() {
                    // When role changes, update permissions
                    updateCreatePermissionsDisplay(this.value);
                });
                
                // Add event listener for reset permissions button in create form
                document.getElementById('createResetPermissionsBtn').addEventListener('click', function() {
                    const role = document.getElementById('createRole').value;
                    // Reset to role defaults
                    updateCreatePermissionsDisplay(role, true);
                });
                
                // Create User Form Submit - updated to include permissions
                createUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const firstName = document.getElementById('createFirstName').value.trim();
                    const lastName = document.getElementById('createLastName').value.trim();
                    const email = document.getElementById('createEmail').value.trim();
                    const password = document.getElementById('createPassword').value;
                    const status = document.getElementById('createStatus').value;
                    const role = document.getElementById('createRole').value;
                    
                    // Basic validation
                    let isValid = true;
                    if (!firstName) {
                        document.getElementById('createFirstName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('createFirstName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!lastName) {
                        document.getElementById('createLastName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('createLastName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!email || !email.includes('@')) {
                        document.getElementById('createEmail').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('createEmail').parentNode.classList.remove('has-error');
                    }
                    
                    if (!password || password.length < 6) {
                        document.getElementById('createPassword').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('createPassword').parentNode.classList.remove('has-error');
                    }
                    
                    if (isValid) {
                        showLoading();
                        
                        // Create user with Firebase Authentication
                        auth.createUserWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                // Get the newly created user's UID
                                const userId = userCredential.user.uid;
                                
                                // Create user data in the database including permissions
                                return database.ref(`users/${userId}`).set({
                                    firstName: firstName,
                                    lastName: lastName,
                                    email: email,
                                    status: status,
                                    role: role,
                                    permissions: createFormPermissions, // Add permissions to user data
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                                });
                            })
                            .then(() => {
                                hideLoading();
                                createUserModal.classList.remove('modal-visible');
                                alert('User created successfully!');
                                
                                // Refresh the user list
                                refreshUsers();
                            })
                            .catch((error) => {
                                hideLoading();
                                alert(`Error creating user: ${error.message}`);
                                console.error("Error creating user:", error);
                            });
                    }
                });
                
                // Edit User Form Submit
                editUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('editUserId').value;
                    const firstName = document.getElementById('editFirstName').value.trim();
                    const lastName = document.getElementById('editLastName').value.trim();
                    const email = document.getElementById('editEmail').value.trim();
                    const status = document.getElementById('editStatus').value;
                    const role = document.getElementById('editRole').value;
                    const profileImage = document.getElementById('editProfileImage').value.trim();
                    
                    // Basic validation
                    let isValid = true;
                    if (!firstName) {
                        document.getElementById('editFirstName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editFirstName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!lastName) {
                        document.getElementById('editLastName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editLastName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!email || !email.includes('@')) {
                        document.getElementById('editEmail').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editEmail').parentNode.classList.remove('has-error');
                    }
                    
                    if (isValid) {
                        showLoading();
                        
                        // Update user data in the database
                        const updates = {
                            firstName: firstName,
                            lastName: lastName,
                            email: email,
                            status: status,
                            role: role, // Add role to updates
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        
                        // Only add profileImage if provided
                        if (profileImage) {
                            updates.profileImage = profileImage;
                        }
                        
                        database.ref(`users/${userId}`).update(updates)
                            .then(() => {
                                hideLoading();
                                editUserModal.classList.remove('modal-visible');
                                alert('User updated successfully!');
                                
                                // Refresh the user list
                                refreshUsers();
                            })
                            .catch((error) => {
                                hideLoading();
                                alert(`Error updating user: ${error.message}`);
                                console.error("Error updating user:", error);
                            });
                    }
                });
                
                // Delete User Button Handler
                deleteUserBtn.addEventListener('click', function() {
                    const userId = document.getElementById('editUserId').value;
                    const userName = `${document.getElementById('editFirstName').value} ${document.getElementById('editLastName').value}`;
                    
                    // Check if current user is admin
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUserRole !== 'admin') {
                        alert('You need administrator privileges to delete users');
                        return;
                    }
                    
                    // Update confirmation message with user name
                    document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete ${userName}? This action cannot be undone.`;
                    
                    // Hide edit modal and show confirmation modal
                    editUserModal.classList.remove('modal-visible');
                    confirmationModal.classList.add('modal-visible');
                    
                    // Set up confirmation action
                    confirmAction.onclick = function() {
                        deleteUser(userId);
                    };
                });
                
                // Confirmation Modal Handlers
                closeConfirmationModal.addEventListener('click', () => {
                    confirmationModal.classList.remove('modal-visible');
                    editUserModal.classList.add('modal-visible'); // Return to edit modal
                });
                
                cancelConfirmation.addEventListener('click', () => {
                    confirmationModal.classList.remove('modal-visible');
                    editUserModal.classList.add('modal-visible'); // Return to edit modal
                });
                
                // Setup logout handler using Firebase Auth
                document.getElementById('logoutButton').addEventListener('click', function(e) {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        console.log("User signed out");
                        window.location.href = "login.html";
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                    });
                });
                
                // Function to initialize dashboard after authentication
                function initializeDashboard(user) {
                    // Setup user avatar with authenticated user
                    setupUserAvatar(user);
                    
                    // Check user permissions
                    checkPermissions();
                    
                    // Load users from Firebase
                    setupRealTimeUserListener();
                    
                    // Setup notifications listener
                    setupEventNotifications();
                }
                
                // Function to handle search
                function handleSearch() {
                    searchTerm = searchInput.value.trim().toLowerCase();
                    filterUsers();
                }
                
                // Function to refresh users - enhanced to properly update UI with permissions
                function refreshUsers() {
                    showLoading();
                    
                    // Get a fresh copy of user data instead of relying on listener
                    database.ref('users').once('value')
                        .then((snapshot) => {
                            allUsers = [];
                            let activeCount = 0;
                            let photoCount = 0;
                            let newUserCount = 0;
                            let usersWithPermissions = 0;
                            
                            const sevenDaysAgo = new Date();
                            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                            
                            const currentUser = auth.currentUser;
                            const hasViewUsersPermission = canPerformAction('view_users');
                            
                            // Process user data
                            snapshot.forEach(function(childSnapshot) {
                                const userId = childSnapshot.key;
                                const userData = childSnapshot.val();
                                
                                // Add user to array with all properties
                                const user = {
                                    id: userId,
                                    ...userData
                                };
                                
                                allUsers.push(user);
                                
                                // Only calculate stats for visible users based on permission
                                if (hasViewUsersPermission || (currentUser && userId === currentUser.uid)) {
                                    // Calculate stats
                                    if (userData.lastLogin && new Date(userData.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                                        activeCount++;
                                    }
                                    
                                    if (userData.profileImage) {
                                        photoCount++;
                                    }
                                    
                                    if (userData.createdAt && new Date(userData.createdAt) > sevenDaysAgo) {
                                        newUserCount++;
                                    }
                                    
                                    // Count users with custom permissions
                                    if (userData.permissions && Object.keys(userData.permissions).length > 0) {
                                        usersWithPermissions++;
                                    }
                                }
                            });
                            
                            // Update stats display (based on permission level)
                            if (!hasViewUsersPermission && currentUser) {
                                // If restricted, only show stats for current user (which is 1)
                                document.getElementById('totalUsersCount').textContent = '1';
                            } else {
                                document.getElementById('totalUsersCount').textContent = allUsers.length;
                            }
                            
                            document.getElementById('activeUsersCount').textContent = activeCount;
                            document.getElementById('withPhotoCount').textContent = photoCount;
                            document.getElementById('newUsersCount').textContent = newUserCount;
                            
                            // Add permissions stat if element exists
                            if (document.getElementById('withPermissionsCount')) {
                                document.getElementById('withPermissionsCount').textContent = usersWithPermissions;
                            }
                            
                            // Apply current search filter and update UI
                            filterUsers();
                            
                            // Also refresh current user's permissions
                            checkPermissions();
                            
                            hideLoading();
                            console.log(`Refreshed ${allUsers.length} users from Firebase`);
                        })
                        .catch(error => {
                            console.error("Error refreshing users:", error);
                            hideLoading();
                            alert("Failed to refresh user data. Please try again.");
                        });
                }
                
                // Function to set up real-time listener for users
                function setupRealTimeUserListener() {
                    showLoading();
                    
                    // Reference to users
                    const usersRef = database.ref('users');
                    
                    // Listen for changes
                    usersRef.on('value', function(snapshot) {
                        allUsers = [];
                        let activeCount = 0;
                        let photoCount = 0;
                        let newUserCount = 0;
                        let usersWithPermissions = 0;
                        
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        
                        const currentUser = auth.currentUser;
                        const hasViewUsersPermission = canPerformAction('view_users');
                        
                        // Process user data
                        snapshot.forEach(function(childSnapshot) {
                            const userId = childSnapshot.key;
                            const userData = childSnapshot.val();
                            
                            // Add user to array
                            const user = {
                                id: userId,
                                ...userData
                            };
                            
                            allUsers.push(user);
                            
                            // Only calculate stats for visible users based on permission
                            if (hasViewUsersPermission || (currentUser && userId === currentUser.uid)) {
                                // Calculate stats
                                if (userData.lastLogin && new Date(userData.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                                    activeCount++;
                                }
                                
                                if (userData.profileImage) {
                                    photoCount++;
                                }
                                
                                if (userData.createdAt && new Date(userData.createdAt) > sevenDaysAgo) {
                                    newUserCount++;
                                }
                                
                                // Count users with custom permissions
                                if (userData.permissions && Object.keys(userData.permissions).length > 0) {
                                    usersWithPermissions++;
                                }
                            }
                        });
                        
                        // Update stats display (based on permission level)
                        if (!hasViewUsersPermission && currentUser) {
                            // If restricted, only show stats for current user (which is 1)
                            document.getElementById('totalUsersCount').textContent = '1';
                        } else {
                            document.getElementById('totalUsersCount').textContent = allUsers.length;
                        }
                        
                        document.getElementById('activeUsersCount').textContent = activeCount;
                        document.getElementById('withPhotoCount').textContent = photoCount;
                        document.getElementById('newUsersCount').textContent = newUserCount;
                        document.getElementById('withPermissionsCount').textContent = usersWithPermissions;
                        
                        // Apply any current search filter
                        filterUsers();
                        hideLoading();
                        
                        console.log(`Loaded ${allUsers.length} users from Firebase`);
                    }, function(error) {
                        console.error("Error fetching users:", error);
                        hideLoading();
                    });
                }
                
                // Function to filter users based on search term
                function filterUsers() {
                    const currentUser = auth.currentUser;
                    const hasViewUsersPermission = canPerformAction('view_users');
                    
                    // First filter by search term
                    let filteredUsers = [];
                    if (searchTerm === '') {
                        filteredUsers = [...allUsers];
                    } else {
                        filteredUsers = allUsers.filter(user => {
                            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                            const email = (user.email || '').toLowerCase();
                            return fullName.includes(searchTerm) || email.includes(searchTerm);
                        });
                    }
                    
                    // Then filter by permission if needed
                    if (!hasViewUsersPermission && currentUser) {
                        filteredUsers = filteredUsers.filter(user => user.id === currentUser.uid);
                        
                        // Show restricted view banner
                        document.getElementById('restrictedViewBanner').style.display = 'flex';
                    } else {
                        // Hide restricted view banner
                        document.getElementById('restrictedViewBanner').style.display = 'none';
                    }
                    
                    // Sort by most recently updated
                    filteredUsers.sort((a, b) => {
                        const dateA = new Date(a.updatedAt || a.createdAt || 0);
                        const dateB = new Date(b.updatedAt || b.createdAt || 0);
                        return dateB - dateA;
                    });
                    
                    // Update current users array
                    currentUsers = filteredUsers;
                    
                    // Reset to first page and update display
                    currentPage = 1;
                    renderUserTable();
                    renderPagination();
                }
                
                // Function to render user table
                function renderUserTable() {
                    // Clear table
                    userTableBody.innerHTML = '';
                    
                    // Get users for current page
                    const startIndex = (currentPage - 1) * usersPerPage;
                    const endIndex = startIndex + usersPerPage;
                    const usersToShow = currentUsers.slice(startIndex, endIndex);
                    
                    // Check if we have users to display
                    if (usersToShow.length === 0) {
                        userTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">
                                    No users found ${searchTerm ? 'matching your search.' : '.'}
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Update table header to include Role column
                    const tableHeader = document.querySelector('.user-table thead tr');
                    if (!tableHeader.querySelector('th:nth-child(7)')) {
                        const roleHeader = document.createElement('th');
                        roleHeader.textContent = 'Role';
                        tableHeader.appendChild(roleHeader);
                    }
                    
                    // Render each user
                    usersToShow.forEach(user => {
                        // Format dates
                        const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                        const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString() : createdAt;
                        
                        // Determine user status
                        const isActive = user.status === 'active' || (user.lastLogin && (new Date(user.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)));
                        const statusClass = isActive ? 'status-active' : 'status-inactive';
                        const statusText = isActive ? 'Active' : 'Inactive';
                        
                        // Create avatar cell
                        let avatarHTML;
                        if (user.profileImage) {
                            avatarHTML = `
                                <img src="${user.profileImage}" alt="Avatar" class="user-avatar-sm" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="user-initial-sm" style="display:none;">
                                    ${getInitials(user)}
                                </div>
                            `;
                        } else {
                            avatarHTML = `<div class="user-initial-sm">${getInitials(user)}</div>`;
                        }
                        
                        // Format role display
                        const roleDisplay = (user.role || 'user').charAt(0).toUpperCase() + (user.role || 'user').slice(1);
                        
                        // Create table row
                        const row = document.createElement('tr');
                        
                        // Check if current user has permission to edit this user
                        let clickable = true;
                        if (currentUserRole !== 'admin' && user.role === 'admin' && auth.currentUser.uid !== user.id) {
                            clickable = false;
                            row.classList.add('restricted-user');
                        }
                        
                        row.innerHTML = `
                            <td class="user-avatar-cell">${avatarHTML}</td>
                            <td>${user.firstName || ''} ${user.lastName || ''}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${createdAt}</td>
                            <td>${updatedAt}</td>
                            <td><span class="user-status ${statusClass}">${statusText}</span></td>
                            <td>${roleDisplay}</td>
                        `;
                        
                        // Make the row clickable to edit user if permissions allow
                        if (clickable) {
                            row.addEventListener('click', function() {
                                openEditUserModal(user);
                            });
                        } else {
                            row.title = "You don't have permission to edit administrators";
                        }
                        
                        userTableBody.appendChild(row);
                    });
                }
                
                // Function to open edit user modal - updated to include permissions
                function openEditUserModal(user) {
                    // Check if user has permission to edit users
                    if (!canPerformAction('edit_user') && auth.currentUser.uid !== user.id) {
                        // Don't allow editing other users unless you have permission
                        showPermissionDeniedMessage("You don't have permission to edit other users");
                        return;
                    }
                    
                    // Set form values
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editFirstName').value = user.firstName || '';
                    document.getElementById('editLastName').value = user.lastName || '';
                    document.getElementById('editEmail').value = user.email || '';
                    document.getElementById('editStatus').value = user.status || 'inactive';
                    document.getElementById('editProfileImage').value = user.profileImage || '';
                    document.getElementById('editRole').value = user.role || 'user';
                    
                    // Initialize permissions for edit form based on user's saved permissions
                    editFormPermissions = user.permissions || {};
                    updateEditPermissionsDisplay(user.role || 'user', false, user.permissions);
                    
                    // Show delete button only if admin or if editing self
                    const currentUser = auth.currentUser;
                    if (canPerformAction('delete_user') || (currentUser && currentUser.uid === user.id)) {
                        deleteUserBtn.style.display = 'block';
                    } else {
                        deleteUserBtn.style.display = 'none';
                    }
                    
                    // Show the modal
                    editUserModal.classList.add('modal-visible');
                }
                
                // Function to render pagination
                function renderPagination() {
                    // Clear pagination
                    pagination.innerHTML = '';
                    
                    // Calculate total pages
                    const totalPages = Math.ceil(currentUsers.length / usersPerPage);
                    
                    if (totalPages <= 1) {
                        pagination.style.display = 'none';
                        return;
                    }
                    
                    pagination.style.display = 'flex';
                    
                    // Add previous button
                    const prevBtn = document.createElement('button');
                    prevBtn.className = `pagination-btn ${currentPage === 1 ? 'disabled' : ''}`;
                    prevBtn.innerHTML = '&laquo; Previous';
                    prevBtn.disabled = currentPage === 1;
                    prevBtn.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderUserTable();
                            renderPagination();
                        }
                    });
                    pagination.appendChild(prevBtn);
                    
                    // Add page buttons (show max 5 pages)
                    const maxButtons = 5;
                    let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
                    let endPage = Math.min(totalPages, startPage + maxButtons - 1);
                    
                    if (endPage - startPage + 1 < maxButtons) {
                        startPage = Math.max(1, endPage - maxButtons + 1);
                    }
                    
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                        pageBtn.textContent = i;
                        pageBtn.addEventListener('click', () => {
                            currentPage = i;
                            renderUserTable();
                            renderPagination();
                        });
                        pagination.appendChild(pageBtn);
                    }
                    
                    // Add next button
                    const nextBtn = document.createElement('button');
                    nextBtn.className = `pagination-btn ${currentPage === totalPages ? 'disabled' : ''}`;
                    nextBtn.innerHTML = 'Next &raquo;';
                    nextBtn.disabled = currentPage === totalPages;
                    nextBtn.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderUserTable();
                            renderPagination();
                        }
                    });
                    pagination.appendChild(nextBtn);
                }
                
                // Function to get user initials
                function getInitials(user) {
                    if (user.firstName && user.firstName.length > 0) {
                        return user.firstName.charAt(0).toUpperCase();
                    }
                    if (user.email && user.email.length > 0) {
                        return user.email.charAt(0).toUpperCase();
                    }
                    return '?';
                }
                
                // Function to show loading overlay
                function showLoading() {
                    loadingOverlay.style.display = 'flex';
                }
                
                // Function to hide loading overlay
                function hideLoading() {
                    loadingOverlay.style.display = 'none';
                }
                
                // Global variable to store current user's role
                let currentUserRole = 'user';
                
                // Function to check user permissions
                function checkPermissions() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Get previous permission state from session storage
                    let previousPermissions = {};
                    try {
                        previousPermissions = JSON.parse(sessionStorage.getItem('userPermissions')) || {};
                    } catch (e) {
                        previousPermissions = {};
                    }
                    
                    // Previous view_users permission state - store this in a variable with wider scope
                    const previousViewUsersPermission = hasPermission(
                        previousPermissions, 
                        'view_users', 
                        ['admin', 'editor'].includes(sessionStorage.getItem('userRole') || 'user')
                    );
                    
                    // Fetch current user's role and permissions
                    database.ref(`users/${currentUser.uid}`).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val() || {};
                            currentUserRole = userData.role || 'user';
                            
                            // Store user permissions for access checks
                            const userPermissions = userData.permissions || {};
                            
                            // Store permissions globally for access throughout the application
                            window.userPermissions = userPermissions;
                            
                            // Check specific permissions for UI controls
                            const canCreateUsers = hasPermission(userPermissions, 'create_users', currentUserRole === 'admin');
                            const canEditUsers = hasPermission(userPermissions, 'edit_users', currentUserRole === 'admin');
                            const canDeleteUsers = hasPermission(userPermissions, 'delete_users', currentUserRole === 'admin');
                            const canViewUsers = hasPermission(userPermissions, 'view_users', ['admin', 'editor'].includes(currentUserRole));
                            
                            // Apply UI restrictions based on specific permissions
                            
                            // Create user button
                            if (!canCreateUsers) {
                                createUserBtn.disabled = true;
                                createUserBtn.style.opacity = '0.5';
                                createUserBtn.title = "You don't have permission to create users";
                            } else {
                                createUserBtn.disabled = false;
                                createUserBtn.style.opacity = '1';
                                createUserBtn.title = "Create a new user";
                            }
                            
                            // Store permissions in session storage for persistence
                            sessionStorage.setItem('userPermissions', JSON.stringify(userPermissions));
                            sessionStorage.setItem('userRole', currentUserRole);
                            
                            // Check if view_users permission has changed and update UI if needed
                            if (previousViewUsersPermission !== canViewUsers) {
                                console.log('View users permission changed, refreshing user list');
                                // Use setTimeout to avoid potential circular function calls
                                setTimeout(() => filterUsers(), 0); 
                            }
                            
                            console.log(`User role: ${currentUserRole}, Permissions loaded:`, userPermissions);
                        }).catch(error => {
                            // Add error handling to prevent page from breaking
                            console.error("Error checking permissions:", error);
                        });
                }
                
                // Function to delete a user
                function deleteUser(userId) {
                    showLoading();
                    
                    // Prevent deleting self
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUser.uid === userId) {
                        hideLoading();
                        confirmationModal.classList.remove('modal-visible');
                        alert("You cannot delete your own account while logged in.");
                        return;
                    }
                    
                    // Get user data before deleting (for email lookup)
                    database.ref(`users/${userId}`).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (!userData) {
                                throw new Error('User not found');
                            }
                            
                            // First delete from database
                            return database.ref(`users/${userId}`).remove()
                                .then(() => {
                                    // Try to delete the auth user if it's not the current admin
                                    if (currentUser && currentUser.uid !== userId) {
                                        // This operation requires special privileges and might not work in all contexts
                                        console.log("Note: Deleting auth users from client requires Firebase Admin SDK");
                                        
                                        // In a real app, you would use a server function with Firebase Admin SDK
                                        console.log(`Auth user deletion would be triggered for: ${userData.email}`);
                                    }
                                });
                        })
                        .then(() => {
                            hideLoading();
                            confirmationModal.classList.remove('modal-visible');
                            alert('User deleted successfully!');
                            
                            // Refresh the user list
                            refreshUsers();
                        })
                        .catch((error) => {
                            hideLoading();
                            confirmationModal.classList.remove('modal-visible');
                            alert(`Error deleting user: ${error.message}`);
                            console.error("Error deleting user:", error);
                        });
                }
                
                // Function to update permissions display on create form based on role
                function updateCreatePermissionsDisplay(role, resetToDefaults = false) {
                    const permissionsContainer = document.getElementById('createPermissionsContainer');
                    
                    // Define available permissions with sensible defaults
                    // These are no longer strictly tied to roles but serve as suggestions
                    const availablePermissions = {
                        'view_events': { label: 'View events', default: true },
                        'submit_events': { label: 'Submit events', default: true },
                        'edit_own_events': { label: 'Edit own events', default: true },
                        'approve_events': { label: 'Approve events', default: false },
                        'view_users': { label: 'View other users', default: false },
                        'create_users': { label: 'Create users', default: false },
                        'edit_users': { label: 'Edit users', default: false },
                        'delete_users': { label: 'Delete users', default: false },
                        'access_admin': { label: 'Access admin functions', default: false }
                    };
                    
                    // For suggested defaults based on role selection (only used for initialization or reset)
                    const roleSuggestions = {
                        'admin': ['view_events', 'submit_events', 'edit_own_events', 'approve_events', 
                                 'view_users', 'create_users', 'edit_users', 'delete_users', 'access_admin'],
                        'editor': ['view_events', 'submit_events', 'edit_own_events', 'approve_events', 'view_users'],
                        'user': ['view_events', 'submit_events', 'edit_own_events']
                    };
                    
                    // Initialize or reset permissions object if requested
                    if (resetToDefaults || Object.keys(createFormPermissions).length === 0) {
                        createFormPermissions = {};
                        
                        // Apply suggested defaults for the selected role
                        if (roleSuggestions[role]) {
                            Object.keys(availablePermissions).forEach(permId => {
                                createFormPermissions[permId] = roleSuggestions[role].includes(permId);
                            });
                        }
                    }
                    
                    // Clear previous permissions
                    permissionsContainer.innerHTML = '';
                    
                    // Add a note about permissions being independent of role
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'permissions-note';
                    noteDiv.innerHTML = '<strong>Note:</strong> Permissions are independent of role and take precedence over role defaults.';
                    permissionsContainer.appendChild(noteDiv);
                    
                    // Add all available permissions with checkboxes
                    Object.entries(availablePermissions).forEach(([permId, permData]) => {
                        // Use existing permission value if available, otherwise use suggested default
                        let isChecked = permId in createFormPermissions 
                            ? createFormPermissions[permId] 
                            : permData.default;
                        
                        // Store the value in our tracking object
                        createFormPermissions[permId] = isChecked;
                        
                        const permissionItem = document.createElement('div');
                        permissionItem.className = 'permission-item';
                        
                        // Create checkbox for toggling permission
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'permission-checkbox';
                        checkbox.id = `create_perm_${permId}`;
                        checkbox.name = `create_permission[${permId}]`;
                        checkbox.checked = isChecked;
                        checkbox.value = 'true';
                        
                        // Add change event to update createFormPermissions when checkbox changes
                        checkbox.addEventListener('change', function() {
                            createFormPermissions[permId] = this.checked;
                        });
                        
                        // Create label for permission
                        const label = document.createElement('label');
                        label.htmlFor = `create_perm_${permId}`;
                        label.className = 'permission-label';
                        label.textContent = permData.label;
                        
                        // Add elements to the item container
                        permissionItem.appendChild(checkbox);
                        permissionItem.appendChild(label);
                        
                        permissionsContainer.appendChild(permissionItem);
                    });
                }
                
                // Add event listener for role dropdown change in edit form
                document.getElementById('editRole').addEventListener('change', function() {
                    // When role changes, update permissions
                    updateEditPermissionsDisplay(this.value);
                });
                
                // Add event listener for reset permissions button in edit form
                document.getElementById('editResetPermissionsBtn').addEventListener('click', function() {
                    const role = document.getElementById('editRole').value;
                    // Reset to role defaults
                    updateEditPermissionsDisplay(role, true);
                });
                
                // Function to update permissions display on edit form based on role
                function updateEditPermissionsDisplay(role, resetToDefaults = false, existingPermissions = null) {
                    const permissionsContainer = document.getElementById('editPermissionsContainer');
                    if (!permissionsContainer) return; // Guard clause if container doesn't exist
                    
                    // Define available permissions with sensible defaults
                    // These are no longer strictly tied to roles but serve as suggestions
                    const availablePermissions = {
                        'view_events': { label: 'View events', default: true },
                        'submit_events': { label: 'Submit events', default: true },
                        'edit_own_events': { label: 'Edit own events', default: true },
                        'approve_events': { label: 'Approve events', default: false },
                        'view_users': { label: 'View other users', default: false },
                        'create_users': { label: 'Create users', default: false },
                        'edit_users': { label: 'Edit users', default: false },
                        'delete_users': { label: 'Delete users', default: false },
                        'access_admin': { label: 'Access admin functions', default: false }
                    };
                    
                    // For suggested defaults based on role selection (only used for initialization or reset)
                    const roleSuggestions = {
                        'admin': ['view_events', 'submit_events', 'edit_own_events', 'approve_events', 
                                 'view_users', 'create_users', 'edit_users', 'delete_users', 'access_admin'],
                        'editor': ['view_events', 'submit_events', 'edit_own_events', 'approve_events', 'view_users'],
                        'user': ['view_events', 'submit_events', 'edit_own_events']
                    };
                    
                    // Initialize or reset permissions object if requested
                    if (resetToDefaults) {
                        editFormPermissions = {};
                        
                        // Apply suggested defaults for the selected role
                        if (roleSuggestions[role]) {
                            Object.keys(availablePermissions).forEach(permId => {
                                editFormPermissions[permId] = roleSuggestions[role].includes(permId);
                            });
                        }
                    } else if (existingPermissions) {
                        // Use provided permissions (from user data)
                        editFormPermissions = {...existingPermissions};
                    }
                    
                    // Clear previous permissions
                    permissionsContainer.innerHTML = '';
                    
                    // Add a note about permissions being independent of role
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'permissions-note';
                    noteDiv.innerHTML = '<strong>Note:</strong> Permissions are independent of role and take precedence over role defaults.';
                    permissionsContainer.appendChild(noteDiv);
                    
                    // Add all available permissions with checkboxes
                    Object.entries(availablePermissions).forEach(([permId, permData]) => {
                        // Use existing permission value if available, otherwise use suggested default
                        let isChecked = permId in editFormPermissions 
                            ? editFormPermissions[permId] 
                            : permData.default;
                        
                        // Store the value in our tracking object
                        editFormPermissions[permId] = isChecked;
                        
                        const permissionItem = document.createElement('div');
                        permissionItem.className = 'permission-item';
                        
                        // Create checkbox for toggling permission
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'permission-checkbox';
                        checkbox.id = `edit_perm_${permId}`;
                        checkbox.name = `edit_permission[${permId}]`;
                        checkbox.checked = isChecked;
                        checkbox.value = 'true';
                        
                        // Add change event to update editFormPermissions when checkbox changes
                        checkbox.addEventListener('change', function() {
                            editFormPermissions[permId] = this.checked;
                        });
                        
                        // Create label for permission
                        const label = document.createElement('label');
                        label.htmlFor = `edit_perm_${permId}`;
                        label.className = 'permission-label';
                        label.textContent = permData.label;
                        
                        // Add elements to the item container
                        permissionItem.appendChild(checkbox);
                        permissionItem.appendChild(label);
                        
                        permissionsContainer.appendChild(permissionItem);
                    });
                }
                
                // Edit User Form Submit - updated to include permission check
                editUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('editUserId').value;
                    
                    // Check if current user has permission to edit users
                    if (!canPerformAction('edit_user') && auth.currentUser.uid !== userId) {
                        showPermissionDeniedMessage("You don't have permission to edit other users");
                        return;
                    }
                    
                    const firstName = document.getElementById('editFirstName').value.trim();
                    const lastName = document.getElementById('editLastName').value.trim();
                    const email = document.getElementById('editEmail').value.trim();
                    const status = document.getElementById('editStatus').value;
                    const role = document.getElementById('editRole').value;
                    const profileImage = document.getElementById('editProfileImage').value.trim();
                    
                    // Basic validation
                    let isValid = true;
                    if (!firstName) {
                        document.getElementById('editFirstName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editFirstName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!lastName) {
                        document.getElementById('editLastName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editLastName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!email || !email.includes('@')) {
                        document.getElementById('editEmail').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editEmail').parentNode.classList.remove('has-error');
                    }
                    
                    if (isValid) {
                        showLoading();
                        
                        // Update user data in the database with permissions
                        const updates = {
                            firstName: firstName,
                            lastName: lastName,
                            email: email,
                            status: status,
                            role: role,
                            permissions: editFormPermissions, // Add permissions to updates
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        
                        // Only add profileImage if provided
                        if (profileImage) {
                            updates.profileImage = profileImage;
                        }
                        
                        database.ref(`users/${userId}`).update(updates)
                            .then(() => {
                                hideLoading();
                                editUserModal.classList.remove('modal-visible');
                                alert('User updated successfully!');
                                
                                // Refresh the user list
                                refreshUsers();
                            })
                            .catch((error) => {
                                hideLoading();
                                alert(`Error updating user: ${error.message}`);
                                console.error("Error updating user:", error);
                            });
                    }
                });
                
                // Fix: Make sure the cancel button has the correct event listener and properly closes the modal
                closeEditModal.addEventListener('click', closeEditModalFunction);
                cancelEditUser.addEventListener('click', closeEditModalFunction);
                
                // Fix: Create a proper function to close the edit modal to ensure consistency
                function closeEditModalFunction() {
                    editUserModal.classList.remove('modal-visible');
                    console.log("Edit user modal closed");
                }
                
                // Function to check user permissions - enhanced to verify specific permissions
                function checkPermissions() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Fetch current user's role and permissions
                    database.ref(`users/${currentUser.uid}`).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val() || {};
                            currentUserRole = userData.role || 'user';
                            
                            // Store user permissions for access checks
                            const userPermissions = userData.permissions || {};
                            
                            // Store permissions globally for access throughout the application
                            window.userPermissions = userPermissions;
                            
                            // Check specific permissions for UI controls
                            const canCreateUsers = hasPermission(userPermissions, 'create_users', currentUserRole === 'admin');
                            const canEditUsers = hasPermission(userPermissions, 'edit_users', currentUserRole === 'admin');
                            const canDeleteUsers = hasPermission(userPermissions, 'delete_users', currentUserRole === 'admin');
                            const canViewUsers = hasPermission(userPermissions, 'view_users', ['admin', 'editor'].includes(currentUserRole));
                            
                            // Apply UI restrictions based on specific permissions
                            
                            // Create user button
                            if (!canCreateUsers) {
                                createUserBtn.disabled = true;
                                createUserBtn.style.opacity = '0.5';
                                createUserBtn.title = "You don't have permission to create users";
                            } else {
                                createUserBtn.disabled = false;
                                createUserBtn.style.opacity = '1';
                                createUserBtn.title = "Create a new user";
                            }
                            
                            // Store permissions in session storage for persistence
                            sessionStorage.setItem('userPermissions', JSON.stringify(userPermissions));
                            sessionStorage.setItem('userRole', currentUserRole);
                            
                            // Check if view_users permission has changed and update UI if needed
                            if (previousViewUsersPermission !== canViewUsers) {
                                console.log('View users permission changed, refreshing user list');
                                filterUsers(); // Re-filter users based on new permissions
                            }
                            
                            console.log(`User role: ${currentUserRole}, Permissions loaded:`, userPermissions);
                        });
                }
                
                // Function to check if the current user can perform a specific action
                function canPerformAction(action) {
                    // Get permissions from session storage to avoid multiple database calls
                    let permissions;
                    try {
                        permissions = JSON.parse(sessionStorage.getItem('userPermissions')) || {};
                    } catch (e) {
                        permissions = {};
                    }
                    
                    const userRole = sessionStorage.getItem('userRole') || 'user';
                    
                    switch(action) {
                        case 'create_user':
                            return hasPermission(permissions, 'create_users', userRole === 'admin');
                        case 'edit_user':
                            return hasPermission(permissions, 'edit_users', userRole === 'admin');
                        case 'delete_user':
                            return hasPermission(permissions, 'delete_users', userRole === 'admin');
                        case 'view_users':
                            return hasPermission(permissions, 'view_users', ['admin', 'editor'].includes(userRole));
                        default:
                            return false;
                    }
                }
                
                // Function to show permission denied message
                function showPermissionDeniedMessage(message) {
                    alert(message || "Permission denied");
                }
                
                // Function to render user table - updated with permission checks
                function renderUserTable() {
                    // Clear table
                    userTableBody.innerHTML = '';
                    
                    // Get users for current page
                    const startIndex = (currentPage - 1) * usersPerPage;
                    const endIndex = startIndex + usersPerPage;
                    const usersToShow = currentUsers.slice(startIndex, endIndex);
                    
                    // Check if we have users to display
                    if (usersToShow.length === 0) {
                        userTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">
                                    No users found ${searchTerm ? 'matching your search.' : '.'}
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Update table header to include Role column
                    const tableHeader = document.querySelector('.user-table thead tr');
                    if (!tableHeader.querySelector('th:nth-child(7)')) {
                        const roleHeader = document.createElement('th');
                        roleHeader.textContent = 'Role';
                        tableHeader.appendChild(roleHeader);
                    }
                    
                    // Render each user
                    usersToShow.forEach(user => {
                        // Format dates
                        const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                        const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString() : createdAt;
                        
                        // Determine user status
                        const isActive = user.status === 'active' || (user.lastLogin && (new Date(user.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)));
                        const statusClass = isActive ? 'status-active' : 'status-inactive';
                        const statusText = isActive ? 'Active' : 'Inactive';
                        
                        // Create avatar cell
                        let avatarHTML;
                        if (user.profileImage) {
                            avatarHTML = `
                                <img src="${user.profileImage}" alt="Avatar" class="user-avatar-sm" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="user-initial-sm" style="display:none;">
                                    ${getInitials(user)}
                                </div>
                            `;
                        } else {
                            avatarHTML = `<div class="user-initial-sm">${getInitials(user)}</div>`;
                        }
                        
                        // Format role display
                        const roleDisplay = (user.role || 'user').charAt(0).toUpperCase() + (user.role || 'user').slice(1);
                        
                        // Create table row
                        const row = document.createElement('tr');
                        
                        // Check if current user has permission to edit this user
                        let clickable = true;
                        const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
                        
                        // Cannot edit other admin users unless you're an admin with edit permission
                        if (user.role === 'admin' && currentUserId !== user.id && 
                            (!canPerformAction('edit_user') || currentUserRole !== 'admin')) {
                            clickable = false;
                            row.classList.add('restricted-user');
                        }
                        
                        // Cannot edit any users if you don't have edit_users permission (unless it's yourself)
                        if (!canPerformAction('edit_user') && currentUserId !== user.id) {
                            clickable = false;
                            row.classList.add('restricted-user');
                        }
                        
                        row.innerHTML = `
                            <td class="user-avatar-cell">${avatarHTML}</td>
                            <td>${user.firstName || ''} ${user.lastName || ''}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${createdAt}</td>
                            <td>${updatedAt}</td>
                            <td><span class="user-status ${statusClass}">${statusText}</span></td>
                            <td>${roleDisplay}</td>
                        `;
                        
                        // Make the row clickable to edit user if permissions allow
                        if (clickable) {
                            row.addEventListener('click', function() {
                                openEditUserModal(user);
                            });
                        } else {
                            const restrictionReason = user.role === 'admin' ? 
                                "You don't have permission to edit administrators" : 
                                "You don't have permission to edit other users";
                            row.title = restrictionReason;
                        }
                        
                        userTableBody.appendChild(row);
                    });
                }
                
                // Add event listener for the dismiss banner button
                document.getElementById('dismissBannerBtn').addEventListener('click', function() {
                    document.getElementById('restrictedViewBanner').style.display = 'none';
                });

                // Function to set up notifications for events - updated to populate the dropdown
                function setupEventNotifications() {
                    // Reference to the events in Firebase
                    const eventsRef = database.ref('events');
                    
                    // Get the current user
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Get the last event check timestamp or use current time
                    let lastCheckTime = Date.now() - (24 * 60 * 60 * 1000); // Default to last 24 hours
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // First, listen for new notifications to display immediately
                    userNotificationsRef.orderByChild('time').limitToLast(50).on('child_added', function(snapshot) {
                        const notification = snapshot.val();
                        notification.id = snapshot.key;
                        
                        // Update UI with this notification
                        updateNotificationUI();
                        
                        // Show toast for recent notifications (less than 1 minute old)
                        if (notification.time > Date.now() - 60000 && !notification.read) {
                            showToastNotification(notification);
                        }
                    });
                    
                    // Listen for changes to notifications (e.g., marked as read)
                    userNotificationsRef.on('child_changed', function(snapshot) {
                        updateNotificationUI();
                    });
                    
                    // Listen for new events that were created after the last check
                    eventsRef.orderByChild('createdAt').startAt(lastCheckTime)
                        .on('child_added', function(snapshot) {
                            const eventData = snapshot.val();
                            const eventId = snapshot.key;
                            
                            // Only notify for new events, not the initial data load
                            if (eventData.createdAt > lastCheckTime) {
                                // Create notification object
                                const notification = {
                                    title: 'New Event Submitted',
                                    message: `${eventData.title || 'Unnamed event'} has been submitted by ${eventData.submitter || 'a user'}`,
                                    type: 'info',
                                    time: Date.now(),
                                    read: false,
                                    eventId: eventId
                                };
                                
                                // Add to notifications in Firebase
                                addNotification(notification);
                            }
                        });
                    
                    // Also check for updated events
                    eventsRef.orderByChild('updatedAt').startAt(lastCheckTime)
                        .on('child_changed', function(snapshot) {
                            const eventData = snapshot.val();
                            const eventId = snapshot.key;
                            
                            // Only notify for events updated after the last check
                            if (eventData.updatedAt > lastCheckTime) {
                                // Create notification object
                                const notification = {
                                    title: 'Event Updated',
                                    message: `${eventData.title || 'Unnamed event'} has been updated`,
                                    type: 'warning',
                                    time: Date.now(),
                                    read: false,
                                    eventId: eventId
                                };
                                
                                // Add to notifications in Firebase
                                addNotification(notification);
                            }
                        });
                    
                    // Load existing notifications
                    loadNotifications();
                }
                
                // Function to add a notification to Firebase and update UI
                function addNotification(notification) {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // Push new notification to Firebase
                    userNotificationsRef.push(notification)
                        .then(() => {
                            // Update the UI happens via the 'child_added' listener
                            console.log('Notification added to Firebase');
                        })
                        .catch(error => {
                            console.error('Error adding notification to Firebase:', error);
                        });
                }
                
                // Function to load notifications from Firebase and update UI
                function loadNotifications() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Clear the list first
                    const notificationList = document.getElementById('notificationList');
                    notificationList.innerHTML = '<div class="notification-empty">Loading notifications...</div>';
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // Get notifications ordered by time (newest first)
                    userNotificationsRef.orderByChild('time').limitToLast(50).once('value')
                        .then(snapshot => {
                            // Clear the list
                            notificationList.innerHTML = '';
                            
                            // Convert to array and sort by time descending
                            const notifications = [];
                            snapshot.forEach(childSnapshot => {
                                const notification = childSnapshot.val();
                                notification.id = childSnapshot.key;
                                notifications.push(notification);
                            });
                            
                            // Sort by time descending
                            notifications.sort((a, b) => b.time - a.time);
                            
                            if (notifications.length === 0) {
                                notificationList.innerHTML = '<div class="notification-empty">No notifications to display</div>';
                                return;
                            }
                            
                            // Add each notification to the list
                            notifications.forEach(notification => {
                                addNotificationToUI(notification);
                            });
                            
                            // Update the counter
                            updateNotificationCounter();
                        })
                        .catch(error => {
                            console.error('Error loading notifications from Firebase:', error);
                            notificationList.innerHTML = '<div class="notification-empty">Error loading notifications</div>';
                        });
                }
                
                // Function to add a notification to the UI - unchanged except for event listener
                function addNotificationToUI(notification) {
                    const notificationList = document.getElementById('notificationList');
                    
                    // Remove empty message if present
                    const emptyMessage = notificationList.querySelector('.notification-empty');
                    if (emptyMessage) {
                        emptyMessage.remove();
                    }
                    
                    // Create notification element
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-list-item ${notification.read ? '' : 'unread'}`;
                    notificationItem.dataset.id = notification.id;
                    
                    // Get icon based on type
                    let iconContent = 'ðŸ“¢';
                    if (notification.type === 'warning') iconContent = 'âš ï¸';
                    if (notification.type === 'error') iconContent = 'âŒ';
                    if (notification.type === 'success') iconContent = 'âœ…';
                    
                    // Format time
                    const notificationTime = new Date(notification.time);
                    const timeAgo = getTimeAgo(notificationTime);
                    
                    // Set inner HTML
                    notificationItem.innerHTML = `
                        <div class="notification-icon ${notification.type}">
                            ${iconContent}
                        </div>
                        <div class="notification-content">
                            <h4 class="notification-title">${notification.title}</h4>
                            <p class="notification-message">${notification.message}</p>
                            <span class="notification-time">${timeAgo}</span>
                        </div>
                    `;
                    
                    // Add click event to mark as read
                    notificationItem.addEventListener('click', function() {
                        markNotificationAsRead(notification.id);
                        
                        // Navigate to related resource if applicable
                        if (notification.eventId) {
                            window.location.href = `evnt.html?id=${notification.eventId}`;
                        }
                    });
                    
                    // Add to the list
                    notificationList.prepend(notificationItem);
                }
                
                // Function to update notification UI
                function updateNotificationUI() {
                    // Load notifications from Firebase
                    loadNotifications();
                }
                
                // Function to update notification counter
                function updateNotificationCounter() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // Count unread notifications
                    userNotificationsRef.orderByChild('read').equalTo(false).once('value')
                        .then(snapshot => {
                            const unreadCount = snapshot.numChildren();
                            const counter = document.getElementById('notificationCounter');
                            
                            if (unreadCount > 0) {
                                counter.textContent = unreadCount > 99 ? '99+' : unreadCount;
                                counter.style.display = 'flex';
                                
                                // Add has-new class to bell for animation
                                document.getElementById('notificationBell').classList.add('has-new');
                            } else {
                                counter.style.display = 'none';
                                
                                // Remove has-new class from bell
                                document.getElementById('notificationBell').classList.remove('has-new');
                            }
                        })
                        .catch(error => {
                            console.error('Error counting unread notifications:', error);
                        });
                }
                
                // Function to mark a notification as read
                function markNotificationAsRead(notificationId) {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Update the notification in Firebase
                    database.ref(`userNotifications/${currentUser.uid}/${notificationId}`).update({
                        read: true
                    }).then(() => {
                        // UI update will happen via the 'child_changed' listener
                        console.log('Notification marked as read in Firebase');
                        
                        // Update the UI element immediately for better UX
                        const notificationItem = document.querySelector(`.notification-list-item[data-id="${notificationId}"]`);
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                        }
                        
                        // Update counter
                        updateNotificationCounter();
                    }).catch(error => {
                        console.error('Error marking notification as read:', error);
                    });
                }
                
                // Function to mark all notifications as read
                function markNotificationsAsRead() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Get all unread notifications
                    database.ref(`userNotifications/${currentUser.uid}`).orderByChild('read').equalTo(false).once('value')
                        .then(snapshot => {
                            const updates = {};
                            
                            // Create batch update object
                            snapshot.forEach(childSnapshot => {
                                updates[`${childSnapshot.key}/read`] = true;
                            });
                            
                            // Apply updates if there are any
                            if (Object.keys(updates).length > 0) {
                                return database.ref(`userNotifications/${currentUser.uid}`).update(updates);
                            }
                            
                            return null;
                        })
                        .then(() => {
                            // UI update will happen via the 'child_changed' listener
                            console.log('All notifications marked as read');
                            
                            // Update the UI elements immediately for better UX
                            document.querySelectorAll('.notification-list-item').forEach(item => {
                                item.classList.remove('unread');
                            });
                            
                            // Update counter
                            updateNotificationCounter();
                        })
                        .catch(error => {
                            console.error('Error marking all notifications as read:', error);
                        });
                }
                
                // Function to clear all notifications
                function clearAllNotifications() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Remove all notifications
                    database.ref(`userNotifications/${currentUser.uid}`).remove()
                        .then(() => {
                            console.log('All notifications cleared');
                            
                            // Update the UI
                            const notificationList = document.getElementById('notificationList');
                            notificationList.innerHTML = '<div class="notification-empty">No notifications to display</div>';
                            
                            // Update the counter
                            updateNotificationCounter();
                        })
                        .catch(error => {
                            console.error('Error clearing notifications:', error);
                        });
                }
                
                // Function to show toast notification (the floating notifications)
                function showToastNotification(notification) {
                    showNotification({
                        title: notification.title,
                        message: notification.message,
                        type: notification.type,
                        duration: notification.type === 'error' ? 10000 : 5000
                    });
                }
                
                // Helper function to format time ago - unchanged
                function getTimeAgo(date) {
                    const seconds = Math.floor((new Date() - date) / 1000);
                    
                    let interval = Math.floor(seconds / 31536000);
                    if (interval >= 1) {
                        return interval + " year" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 2592000);
                    if (interval >= 1) {
                        return interval + " month" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 86400);
                    if (interval >= 1) {
                        return interval + " day" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 3600);
                    if (interval >= 1) {
                        return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 60);
                    if (interval >= 1) {
                        return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    return "just now";
                }

                // Function to show a notification - keep existing
                function showNotification(options) {
                    // ...existing code...
                }
                
                // Add the closeNotification function to the global scope - keep existing
                window.closeNotification = function(id) {
                    // ...existing code...
                };

                // ...existing code...
            } catch (error) {
                // ...existing code...
            }
        });
        
        // Function to setup user avatar in navigation
        function setupUserAvatar(authUser) {
            const userId = authUser.uid;
            const userEmail = authUser.email || "user@example.com";
            document.getElementById('userEmail').textContent = userEmail;
            
            // Get user data from Firebase
            database.ref(`users/${userId}`).once('value').then((snapshot) => {
                const userData = snapshot.val() || {};
                const avatarContainer = document.getElementById('userAvatarContainer');
                
                // If user doesn't exist in the database yet, create entry
                if (!userData.email) {
                    // Create basic user profile if not exists
                    database.ref(`users/${userId}`).update({
                        email: userEmail,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Update last login time
                    database.ref(`users/${userId}`).update({
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                if (userData.profileImage) {
                    // Add cache buster
                    const cacheBuster = `?t=${new Date().getTime()}`;
                    
                    // Create image element with error handling
                    avatarContainer.innerHTML = `
                        <img src="${userData.profileImage}${cacheBuster}" 
                            alt="Profile" 
                            class="user-avatar" 
                            onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'user-initial\'>${getUserInitial(userData, userEmail)}</div>';">
                    `;
                } else {
                    // No profile image, show initial
                    avatarContainer.innerHTML = `<div class="user-initial">${getUserInitial(userData, userEmail)}</div>`;
                }
            }).catch(error => {
                console.error("Error fetching user data:", error);
                // Show default initial based on email
                const avatarContainer = document.getElementById('userAvatarContainer');
                avatarContainer.innerHTML = `<div class="user-initial">${userEmail.charAt(0).toUpperCase()}</div>`;
            });
            
            function getUserInitial(userData, email) {
                const firstName = userData.firstName;
                
                if (firstName && firstName.length > 0) {
                    return firstName.charAt(0).toUpperCase();
                }
                
                if (email && email.length > 0) {
                    return email.charAt(0).toUpperCase();
                }
                
                return "?";
            }
        }

        // Make sure hasPermission is properly defined
        function hasPermission(permissions, permissionName, roleFallback = false) {
            // If the permission is explicitly set, use that value
            if (permissions && permissionName in permissions) {
                return permissions[permissionName] === true;
            }
            
            // Otherwise, fall back to role-based permission
            return roleFallback;
        }

        // Add a basic error handler to catch any uncaught errors
        window.addEventListener('error', function(event) {
            console.error('Caught unhandled error:', event.error);
            // Prevent the dashboard from completely failing
            hideLoading();
            
            // Display an error message to the user
            if (document.getElementById('userTableBody')) {
                document.getElementById('userTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #721c24; background-color: #f8d7da;">
                            An error occurred while loading the dashboard. Please try refreshing the page.
                        </td>
                    </tr>
                `;
            }
            
            return true; // Prevents the default error handler
        });
    </script>
</body>
</html>
