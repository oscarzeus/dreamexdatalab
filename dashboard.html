<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- All external dependencies embedded below -->
    <style>
        /* Font Awesome Icons - Embedded Core Icons */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
        
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 3.2rem; /* Reduced to align with project-list header height */
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem; /* Compact like project-list */
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.3rem; /* Compact spacing */
            position: fixed;
            top: 0.25rem; /* Match project-list */
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            height: 50px; /* Explicit height for consistency */
            min-height: 50px;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Header company logo - ensure no background box is visible */
        .header-company-logo {
            height: 32px;
            width: auto;
            object-fit: contain;
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Mobile responsive adjustments for header branding */
        @media (max-width: 768px) {
            .top-nav {
                padding: 0.75rem 1rem;
                border-radius: 0;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            /* Keep compact placeholder size on mobile, don't force image into a square */
            .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }
        }

        /* Notification Styles */
        .notifications { 
            position: relative; 
            display: flex; 
            align-items: center; 
        }

        .notification-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            position: relative; 
            font-size: 1.2rem; 
            padding: 0.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .notification-badge { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background-color: var(--accent-color); 
            color: white; 
            border-radius: 50%; 
            padding: 0.2rem 0.5rem; 
            font-size: 0.7rem; 
            display: none; 
        }

        .notification-dropdown { 
            display: none; 
            position: absolute; 
            right: 0; 
            top: 100%; 
            width: 320px; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
            z-index: 1000; 
            border: 1px solid #e9ecef; 
            max-height: 400px; 
            overflow: hidden; 
        }

        .notification-dropdown.show { 
            display: block; 
            animation: slideDown 0.2s ease-out; 
        }

        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .notification-header { 
            padding: 12px 16px; 
            border-bottom: 1px solid #e9ecef; 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .notification-header h3 { 
            margin: 0; 
            color: #333; 
            font-size: 14px; 
            font-weight: 600; 
        }

        .mark-all-read { 
            background: none; 
            border: none; 
            color: #3498db; 
            cursor: pointer; 
            font-size: 12px; 
            padding: 4px 8px; 
            border-radius: 4px; 
            transition: all .2s ease; 
        }

        .mark-all-read:hover { 
            background: #e3f2fd; 
            color: #1976d2; 
        }

        .clear-all-notifications { 
            background: none; 
            border: none; 
            color: #e74c3c; 
            cursor: pointer; 
            font-size: 12px; 
            padding: 4px 8px; 
            border-radius: 4px; 
            transition: all .2s ease; 
            margin-left: 8px; 
        }

        .clear-all-notifications:hover { 
            background: #fdf2f2; 
            color: #c0392b; 
        }

        .notification-list { 
            max-height: 320px; 
            overflow-y: auto; 
            padding: 0; 
        }

        .notification-list::-webkit-scrollbar { 
            width: 4px; 
        }

        .notification-list::-webkit-scrollbar-track { 
            background: #f1f1f1; 
        }

        .notification-list::-webkit-scrollbar-thumb { 
            background: #c1c1c1; 
            border-radius: 2px; 
        }

        .notification-item { 
            padding: 12px 16px; 
            border-bottom: 1px solid #f1f1f1; 
            cursor: pointer; 
            transition: background-color .2s ease; 
            position: relative; 
        }

        .notification-item:hover { 
            background: #f8f9fa; 
        }

        .notification-item.unread { 
            background: #e8f4fd; 
            border-left: 3px solid #3498db; 
        }

        .notification-dot { 
            position: absolute; 
            top: 16px; 
            right: 16px; 
            width: 8px; 
            height: 8px; 
            background: #3498db; 
            border-radius: 50%; 
        }

        .notification-actions { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            display: none; 
            gap: 4px; 
        }

        .notification-item:hover .notification-actions { 
            display: flex; 
        }

        .mark-read-btn, .delete-notification-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            padding: 4px; 
            border-radius: 3px; 
            transition: all .2s ease; 
            font-size: 12px; 
        }

        .mark-read-btn { 
            color: #3498db; 
        }

        .mark-read-btn:hover { 
            background: #e3f2fd; 
            color: #1976d2; 
        }

        .delete-notification-btn { 
            color: #e74c3c; 
        }

        .delete-notification-btn:hover { 
            background: #fdf2f2; 
            color: #c0392b; 
        }

        .notification-empty { 
            padding: 40px 20px; 
            text-align: center; 
            color: #999; 
            display: none; 
        }

        .notification-empty i { 
            font-size: 32px; 
            margin-bottom: 12px; 
            color: #ddd; 
        }

        .notification-empty-title { 
            font-size: 14px; 
            font-weight: 500; 
            margin-bottom: 4px; 
            color: #666; 
        }

        .notification-empty-message { 
            font-size: 12px; 
            color: #999; 
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .content-header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin: 0;
        }

        /* Button Styles */
        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-edit:hover {
            background-color: #2980b9;
        }

        .btn-mini {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }

        /* Dashboard chart height reduction */
        #incidentChart,
        #trainingChart,
        #riskChart,
        #environmentalChart,
        #safetyObservationsChart {
            height: 32px !important;
            max-height: 32px !important;
        }
        
        /* Ensure parent containers don't interfere */
        .kpi-card canvas {
            height: 32px !important;
            max-height: 32px !important;
        }
        
        .kpi-card.wide canvas {
            height: 32px !important;
            max-height: 32px !important;
        }
        
        /* Enhanced KPI Card Design */
        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.75rem;
            min-height: 80px;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12, #e74c3c);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .kpi-card:hover::before {
            opacity: 1;
        }
        
        .kpi-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            padding: 0.15rem 0;
        }
        
        .kpi-header i {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .kpi-header h3 {
            color: #2d3748;
            font-weight: 600;
            font-size: inherit;
            margin: 0;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .kpi-trend {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .kpi-trend.positive {
            color: #16a085;
        }
        
        .kpi-trend.negative {
            color: #e74c3c;
        }
        
        .kpi-trend i {
            margin-right: 0.5rem;
            background: none !important;
            color: inherit !important;
            width: auto !important;
            height: auto !important;
            box-shadow: none !important;
        }
        
        /* Enhanced wide cards */
        .kpi-card.wide {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
            min-height: 100px;
        }
        
        .kpi-card.wide .kpi-header i {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }
        
        /* Chart container enhancements */
        .kpi-card canvas {
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Animate chart container on hover */
        .kpi-card:hover canvas {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Loading animation for charts */
        @keyframes chartPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .chart-loading {
            animation: chartPulse 2s infinite;
        }
        
        /* Enhanced dashboard layout */
        .kpi-dashboard {
            background: transparent;
        }
        
        .kpi-row {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        /* Fleet summary mini stats */
        .mini-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0.4rem;
            margin-top: 0.2rem;
        }

        .mini-stat {
            background: linear-gradient(135deg, #f8f9fa, #eef2f7);
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mini-stat i {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            background: var(--secondary-color);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .mini-stat .label {
            font-size: inherit;
            color: #6b7280;
            line-height: 1.1;
        }

        .mini-stat .value {
            font-size: inherit;
            font-weight: 700;
            color: #111827;
        }
        
        .kpi-row:first-child {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        
        .kpi-row:not(:first-child) {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        /* Uniform text size across content (exclude top header and sidebar) */
        .main-content, .main-content *,
        .news-modal-content, .news-modal-content * {
            font-size: 12px !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .kpi-row {
                grid-template-columns: 1fr;
            }
            
            .kpi-value {
                font-size: 2rem;
            }
            
            .kpi-header h3 {
                font-size: 0.9rem;
            }
        }
        
        /* Special styling for specific KPI types */
        .kpi-card:nth-child(1) .kpi-header i {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }
        
        .kpi-card:nth-child(2) .kpi-header i {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .kpi-card:nth-child(3) .kpi-header i {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
        }

        /* Settings Navigation Styles */
        .settings-navigation {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        .settings-nav-item {
            background: white;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .settings-nav-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .settings-nav-item a {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1.5rem;
            text-decoration: none;
            color: inherit;
            height: 100%;
        }

        .settings-nav-item i {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .settings-nav-item span {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .settings-description {
            font-size: 0.9rem;
            color: #666;
            margin: 0;
        }

    /* (Removed: Task Badge Styles) */

        /* Company News Section Styles */
        .company-news {
            background: transparent;
            color: white;
            padding: 0;
            margin-bottom: 1rem;
            margin-top: 2rem;
            border-radius: 0;
            box-shadow: none;
            position: relative;
            overflow: visible;
            min-height: auto;
            z-index: 1;
        }

        .news-carousel {
            position: relative;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .news-slides {
            display: flex;
            transition: transform 0.5s ease-in-out;
            height: 100%;
        }

        .news-slide {
            min-width: calc(33.333% - 1rem);
            margin-right: 1.5rem;
            position: relative;
            display: flex;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 12px;
            overflow: hidden;
            min-height: 180px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            margin-bottom: 1rem;
        }

        .news-slide:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        .news-slide-image {
            position: relative;
            height: 130px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
        }

        .news-slide-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);
            z-index: 1;
        }

        .news-slide-overlay-content {
            position: absolute;
            top: 1rem;
            left: 1rem;
            right: 1rem;
            z-index: 2;
            color: white;
        }

        .news-slide-text {
            background: white;
            padding: 1rem;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .news-slide-text-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .news-slide-text-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .news-slide-text-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #2c3e50;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .news-slide-text-subtitle {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .news-slide-text-description {
            font-size: 0.85rem;
            color: #5a6c7d;
            line-height: 1.4;
            margin-bottom: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-slide-read-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .news-slide-read-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f639a);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .news-slide-read-btn i {
            font-size: 0.7rem;
        }

        .news-priority-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 5;
            backdrop-filter: blur(10px);
        }

        .news-priority-badge.high {
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }

        .news-priority-badge.medium {
            background: rgba(241, 196, 15, 0.9);
            color: white;
        }

        .news-priority-badge.low {
            background: rgba(46, 204, 113, 0.9);
            color: white;
        }

        .news-controls {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            z-index: 5;
            pointer-events: none;
        }

        .news-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            opacity: 0.7;
            margin: 0 1rem;
        }

        .news-nav-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
            opacity: 1;
        }

        .news-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .news-nav-btn:disabled:hover {
            transform: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .news-indicators {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Hide indicators for grid layout */
            gap: 0.5rem;
            z-index: 5;
        }

        .news-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-indicator.active {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.2);
        }

        .news-time-stamp {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.6);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            z-index: 5;
            backdrop-filter: blur(10px);
        }

        .news-auto-play {
            position: absolute;
            top: 20px;
            right: 50%;
            transform: translateX(50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 5;
            display: none; /* Hide auto-play for grid layout */
        }

        .news-auto-play:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Responsive adjustments for 3-column layout */
        @media (max-width: 1200px) {
            .news-slide {
                min-width: calc(50% - 0.75rem);
            }
            
            .news-slide-image {
                height: 180px;
            }
            
            .news-slide-text-title {
                font-size: 1rem;
            }
            
            .news-slide-text-subtitle {
                font-size: 0.85rem;
            }
            
            .news-slide-text-description {
                font-size: 0.8rem;
            }
            
            .news-slide-read-btn {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .company-news {
                padding: 0;
            }
            
            .news-slide {
                min-width: calc(100% - 0.5rem);
            }
            
            .news-slide-image {
                height: 160px;
            }
            
            .news-slide-text {
                padding: 0.75rem;
            }
            
            .news-slide-text-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .news-slide-text-content {
                order: 1;
            }
            
            .news-slide-read-btn {
                order: 2;
                align-self: flex-start;
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
            
            .news-slide-text-title {
                font-size: 0.95rem;
                white-space: normal;
            }
            
            .news-slide-text-subtitle {
                font-size: 0.8rem;
                white-space: normal;
            }
            
            .news-slide-text-description {
                font-size: 0.75rem;
            }
            
            .news-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Hide all menu items while loading to prevent flicker; menu will be shown after auth and filtering */
        .menu-loading [data-feature],
        .menu-loading .menu-dropdown {
            display: none !important;
        }

        .news-auto-play {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 3;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .news-auto-play:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
            
            .top-nav {
                left: calc(200px + 0.5rem);
            }
        }

        /* Mobile App Design - Slide-in Sidebar */
        @media (max-width: 768px) {
            /* Prevent horizontal scrolling */
            body, html {
                overflow-x: hidden;
                max-width: 100vw;
            }
            
            .app-container {
                overflow-x: hidden;
                max-width: 100vw;
            }
            
            .main-content {
                overflow-x: hidden;
                max-width: 100vw;
            }
            
            /* Sidebar becomes slide-in overlay on mobile */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100%;
                z-index: 9999;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: none;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            /* Show sidebar when active */
            .sidebar.mobile-active {
                transform: translateX(0);
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
            }
            
            /* Backdrop overlay */
            .mobile-sidebar-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9998;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .mobile-sidebar-backdrop.active {
                display: block;
                opacity: 1;
            }
            
            /* Mobile hamburger menu button */
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                background: transparent;
                color: var(--text-color);
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1.2rem;
                transition: all 0.3s ease;
                box-shadow: none;
            }
            
            .mobile-menu-btn:hover {
                background: rgba(0, 0, 0, 0.05);
                transform: scale(1.05);
            }
            
            .mobile-menu-btn:active {
                transform: scale(0.95);
            }
            
            /* Hide desktop sidebar toggle on mobile */
            .sidebar-toggle-btn {
                display: none;
            }
            
            /* Main content takes full width on mobile */
            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 5rem;
            }
            
            .top-nav {
                left: 0.5rem;
                right: 0.5rem;
            }
            
            /* Adjust grid layouts for mobile */
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
                width: 100%;
            }
            
            .mini-stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem;
                width: 100%;
            }
            
            /* Ensure all cards fit within mobile viewport */
            .stat-card, .info-card, .dashboard-section {
                max-width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            
            /* Tables responsive */
            table {
                max-width: 100%;
                overflow-x: auto;
                display: block;
            }
            
            /* Images responsive */
            img {
                max-width: 100%;
                height: auto;
            }
            
            /* Company news adjustments */
            .company-news {
                height: 300px;
            }
            
            .news-slide-title {
                font-size: 1.8rem;
            }
            
            .news-slide-subtitle {
                font-size: 1rem;
            }
            
            .news-slide-description {
                font-size: 0.9rem;
            }
            
            .news-slide-content {
                padding: 1rem;
            }
            
            /* Touch-friendly card sizing */
            .stat-card, .info-card {
                padding: 1.25rem;
            }
            
            /* Improve readability on small screens */
            .dashboard-section h2 {
                font-size: 1.3rem;
            }
            
            /* Stack charts vertically */
            .chart-container {
                margin-bottom: 1.5rem;
            }
            
            .settings-navigation {
                grid-template-columns: 1fr;
            }
        }

        /* News Modal Styles */
        .news-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .news-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .news-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .news-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .news-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .news-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .news-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .news-modal-body {
            padding: 2rem;
        }

        .news-modal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .news-modal-priority {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .news-modal-priority.high {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .news-modal-priority.medium {
            background: rgba(241, 196, 15, 0.1);
            color: #f1c40f;
            border: 1px solid #f1c40f;
        }

        .news-modal-priority.low {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }

        .news-modal-timestamp {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        .news-modal-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .news-modal-description {
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 2rem;
        }

        .news-modal-image {
            margin-bottom: 2rem;
        }

        .news-modal-image img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .news-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }

        .news-modal-author,
        .news-modal-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .news-modal-author i,
        .news-modal-date i {
            color: #3498db;
        }

        /* Responsive modal */
        @media (max-width: 768px) {
            .news-modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .news-modal-header {
                padding: 1rem 1.5rem;
            }

            .news-modal-header h2 {
                font-size: 1.3rem;
            }

            .news-modal-body {
                padding: 1.5rem;
            }

            .news-modal-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .news-modal-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
        
        /* Hide mobile menu button on desktop */
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
            
            .mobile-sidebar-backdrop {
                display: none !important;
            }
        }
    </style>
    
    <!-- Chart.js Library Embedded -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Embedded Authentication Manager -->
    <script>
        // Firebase v8 configuration for domain compatibility
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully');
            }
            return window.firebase;
        }

        // Authentication functions using Firebase v8
        function loginWithEmail(email, password) {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        resolve(userCredential.user);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }

        function logoutUser() {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.signOut()
                    .then(() => {
                        resolve(true);
                    })
                    .catch((error) => {
                        console.error('Logout error:', error);
                        resolve(false);
                    });
            });
        }

        // Database functions using Firebase v8
        function getDatabase() {
            const firebase = initializeFirebase();
            return firebase.database();
        }

        function ref(database, path) {
            return database.ref(path);
        }

        function get(reference) {
            return reference.once('value');
        }

        function set(reference, value) {
            return reference.set(value);
        }

        function update(reference, values) {
            return reference.update(values);
        }

        function onValue(reference, callback, options = {}) {
            if (options.onlyOnce) {
                return reference.once('value', callback);
            } else {
                return reference.on('value', callback);
            }
        }

        // Authentication Manager Class
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = getDatabase();
                this.currentCompany = null;
                
                // Debug log
                console.log('🔐 AuthManager initialized');
                console.log('Current user:', this.currentUser);
                
                this.initializeAuth();
            }

            initializeAuth() {
                // Check if user is logged in
                if (!this.currentUser) {
                    // Check if this is a redirect from login
                    if (window.location.pathname.includes('dashboard.html')) {
                        window.location.href = 'login.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                    return;
                }
                
                console.log('✅ User authenticated successfully');
                
                // Show authentication status indicator briefly
                const authStatus = document.getElementById('authStatus');
                if (authStatus) {
                    authStatus.style.display = 'block';
                    setTimeout(() => {
                        authStatus.style.transition = 'opacity 0.5s ease-out';
                        authStatus.style.opacity = '0';
                        setTimeout(() => {
                            authStatus.style.display = 'none';
                        }, 500);
                    }, 2000);
                }
                
                // Load user data and update UI
                this.loadUserRole(this.currentUser);
                this.loadUserCompany();
                this.updateUIForAuthenticatedUser();
                this.updateMenuVisibility();

                // Add event listeners for user profile dropdown
                const userProfileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown');
                
                if (userProfileBtn && profileDropdown) {
                    userProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!userProfileBtn.contains(e.target)) {
                            profileDropdown.classList.remove('show');
                        }
                    });
                }

                // Handle logout
                const logoutBtn = document.querySelector('.profile-dropdown a[data-action="logout"]') || document.querySelector('.profile-dropdown a[href="#"]');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            }

            getCurrentUser() {
                try {
                    return JSON.parse(localStorage.getItem('currentUser') || 'null');
                } catch (error) {
                    console.error('Error parsing current user:', error);
                    return null;
                }
            }

            setCurrentUser(userData) {
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('user', JSON.stringify(userData));
                this.currentUser = userData;
            }

            async logout() {
                const success = await logoutUser();
                if (success) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    window.location.href = 'index.html';
                }
            }

            // Menu visibility methods
            resetMenuVisibility() {
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                });
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
            }

            async updateMenuVisibility() {
                console.log('🔧 Starting menu visibility update...');
                
                // NOTE: do NOT remove the loading class here - keep sidebar hidden until
                // feature-based and role-based filtering complete. showSidebarAfterAuth()
                // will remove the loading class once authorization finishes.
                
                try {
                    if (!this.currentUser) {
                        console.log('❌ No authenticated user found');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    // Get user's company ID and role
                    const companyId = this.currentUser.companyId;
                    const userRole = this.currentUser.role;
                    
                    if (!companyId || !userRole) {
                        console.log('❌ Missing company ID or user role');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                    
                    // Get company role permissions
                    const permissionsRef = ref(this.db, `companies/${companyId}/roles/${userRole}/permissions`);
                    console.log(`🔍 Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                    
                    const permissionsSnapshot = await get(permissionsRef);
                    
                    if (!permissionsSnapshot.exists()) {
                        console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                        
                        // Try to get all roles to see what's available
                        const allRolesRef = ref(this.db, `companies/${companyId}/roles`);
                        const allRolesSnapshot = await get(allRolesRef);
                        
                        if (allRolesSnapshot.exists()) {
                            const allRoles = allRolesSnapshot.val();
                            console.log('🔍 Available roles in company:', Object.keys(allRoles));
                            
                            // Check if the role exists with different casing or format
                            const roleKeys = Object.keys(allRoles);
                            const matchingRole = roleKeys.find(key => 
                                key.toLowerCase() === userRole.toLowerCase() ||
                                key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                            );
                            
                            if (matchingRole && allRoles[matchingRole].permissions) {
                                console.log(`✅ Found matching role: ${matchingRole}`);
                                const permissions = allRoles[matchingRole].permissions;
                                this.updateMenuWithPermissions(permissions);
                                return;
                            }
                        }
                        
                        console.log('❌ No valid permissions found - hiding all menu items');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const permissions = permissionsSnapshot.val();
                    console.log('✅ Loaded permissions:', permissions);
                    this.updateMenuWithPermissions(permissions);
                    
                } catch (error) {
                    console.error('❌ Error updating menu visibility:', error);
                    this.resetMenuVisibility();
                }
            }

            updateMenuWithPermissions(permissions) {
                console.log('🎯 Updating menu with permissions...');
                console.log('🎯 Permissions object:', permissions);
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!permissions) {
                    console.log('⚠️ No permissions object provided');
                    return;
                }
                
                // Update menu visibility based on permissions
                const menuItems = document.querySelectorAll('[data-feature]');
                console.log(`🎯 Found ${menuItems.length} menu items to check`);
                let visibleCount = 0;
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const isSubmenuItem = item.closest('.submenu') !== null;
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    const parentDropdown = item.closest('.menu-dropdown');
                    const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                    
                    console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                        return;
                    }
                    
                    // If item doesn't require permission, show it
                    if (!requiresPermission) {
                        // Check if user has permission for this feature
                        if (feature && permissions[feature]) {
                            const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                            if (hasViewPermission) {
                                item.classList.add('menu-visible');
                                visibleCount++;
                                console.log(`✅ Showing menu item: ${feature}`);
                            } else {
                                console.log(`❌ No view permission for: ${feature}`);
                            }
                        } else {
                            console.log(`⚪ Feature not found in permissions: ${feature}`);
                        }
                        return;
                    }
                    
                    // If item requires permission, check if user has it
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature}`);
                        } else {
                            console.log(`❌ No view permission for: ${feature}`);
                        }
                    } else {
                        console.log(`⚪ Feature not found in permissions: ${feature}`);
                    }
                });
                
                // Handle parent dropdowns - show only if they have visible children
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                    } else {
                        console.log(`❌ Hiding parent dropdown ${dropdownFeature} (no visible children)`);
                    }
                });
                
                console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
                
                // If no items are visible, show at least home (only if user has home permission)
                if (visibleCount === 0) {
                    const homeItem = document.querySelector('[data-feature="home_view"]');
                    if (homeItem && permissions && permissions.home_view && 
                        (permissions.home_view.view === true || permissions.home_view === true)) {
                        homeItem.classList.add('menu-visible');
                        console.log('⚠️ No permissions found - showing home as fallback');
                    }
                }
            }

            async loadUserRole(userData) {
                // Load user role from Firebase if not available
                if (!userData.role && userData.uid) {
                    try {
                        const userRef = ref(this.db, `users/${userData.uid}`);
                        const userSnapshot = await get(userRef);
                        if (userSnapshot.exists()) {
                            const userRole = userSnapshot.val().role || 'user';
                            userData.role = userRole;
                            this.setCurrentUser(userData);
                        }
                    } catch (error) {
                        console.error('Error loading user role:', error);
                    }
                }
            }

            async loadUserCompany() {
                if (!this.currentUser) return;

                try {
                    const companiesRef = ref(this.db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            this.updateCompanyBranding();
                        }
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }

            updateCompanyBranding() {
                console.log('🏢 Updating company branding in dashboard header...');

                // Elements
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const companyNameHeader = document.getElementById('headerCompanyName');

                // Company name
                const companyName = this.currentCompany?.companyName || this.currentUser?.companyName || 'Company';

                // Prefer either 'logo' or 'logoUrl' if available
                const logoUrl = (this.currentCompany?.logo || this.currentCompany?.logoUrl || '').trim();

                if (headerLogo) {
                    // Always ensure the logo element has no unintended styling background
                    headerLogo.style.background = 'transparent';
                    headerLogo.style.border = 'none';
                }

                if (logoUrl) {
                    if (headerLogo) {
                        // Prepare load/error handlers to toggle placeholder correctly
                        headerLogo.onload = () => {
                            headerLogo.classList.add('visible');
                            headerLogo.style.display = 'block';
                            if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'none';
                            console.log('✅ Company logo displayed in dashboard header');
                        };
                        headerLogo.onerror = () => {
                            headerLogo.classList.remove('visible');
                            headerLogo.style.display = 'none';
                            if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'flex';
                            console.warn('⚠️ Failed to load company logo, showing placeholder');
                        };

                        // Assign src only if changed to avoid reloading unnecessarily
                        if (headerLogo.src !== logoUrl) {
                            headerLogo.src = logoUrl;
                        }

                        // If the image may already be cached/loaded
                        if (headerLogo.complete && headerLogo.naturalWidth > 0) {
                            headerLogo.onload?.();
                        } else {
                            // While loading, hide placeholder to avoid appearing "behind" the logo
                            if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'none';
                        }
                    }
                } else {
                    // No logo URL - show placeholder
                    if (headerLogo) {
                        headerLogo.classList.remove('visible');
                        headerLogo.style.display = 'none';
                        headerLogo.removeAttribute('src');
                    }
                    if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'flex';
                    console.log('✅ Company logo placeholder displayed in dashboard header');
                }

                // Update company name
                if (companyNameHeader) {
                    companyNameHeader.textContent = companyName;
                    companyNameHeader.style.display = 'inline-block';
                    console.log('✅ Company name updated in dashboard header:', companyName);
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab HSE')) {
                    document.title = title.replace('Dreamex Datalab HSE', `${companyName} HSE`);
                }

                // Apply company branding colors if available
                if (this.currentCompany && this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) {
                        root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    }
                    if (this.currentCompany.branding.secondaryColor) {
                        root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                    }
                }
                
                console.log('🏢 Dashboard company branding update completed');
            }

            async updateUIForAuthenticatedUser() {
                const profileBtn = document.querySelector('.profile-btn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();
                        
                        // Preload avatar URL to avoid showing initials first
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        // Update profile image - now show the correct image immediately
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Create avatar for dropdown (either real avatar or initials)
                        let dropdownAvatarHtml;
                        if (avatarUrl) {
                            dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                        }
                        
                        // Update profile dropdown with user info
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${dropdownAvatarHtml}
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="profile.html"><i class="fas fa-id-badge"></i> Profile</a></li>
                            <li><a href="#" data-action="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        `;
                        
                        profileDropdown.innerHTML = userInfoHtml;
                        
                        // Re-attach logout event listener
                        const logoutBtn = profileDropdown.querySelector('a[data-action="logout"]') || profileDropdown.querySelector('a[href="#"]');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                this.logout();
                            });
                        }
                        
                        // Update menu visibility based on user permissions
                        await this.updateMenuVisibility();
                    }
                }
            }

            // Get user display name
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return '';
                    return name.trim().replace(/\s+/g, ' ');
                };
                
                const potentialNames = [
                    this.currentUser.displayName,
                    this.currentUser.name,
                    this.currentUser.username
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            }
        }

        // Initialize Firebase when this script loads
        initializeFirebase();
    </script>
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Mobile sidebar backdrop -->
        <div id="mobileSidebarBackdrop" class="mobile-sidebar-backdrop"></div>
        
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="settings.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <!-- Mobile menu button (visible only on mobile) -->
                    <button id="mobileMenuToggle" class="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- Desktop sidebar toggle (hidden on mobile via existing CSS) -->
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header">Loading...</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                            <div class="notification-empty">
                                <i class="fas fa-inbox"></i>
                                <div class="notification-empty-title">No notifications</div>
                                <div class="notification-empty-message">You're all caught up</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="profile.html"><i class="fas fa-id-badge"></i> Profile</a></li>
                                <li><a href="#" data-action="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Company News Section -->
            <div class="company-news" id="companyNews">
                <div class="news-carousel">
                    <div class="news-slides" id="newsSlides">
                        <!-- News slides will be dynamically generated by JavaScript -->
                    </div>
                    
                    <!-- Navigation Controls -->
                    <div class="news-controls">
                        <button class="news-nav-btn" id="prevBtn" onclick="changeSlide(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="news-nav-btn" id="nextBtn" onclick="changeSlide(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Slide Indicators -->
                    <div class="news-indicators" id="newsIndicators">
                        <!-- Indicators will be dynamically generated by JavaScript -->
                    </div>
                    
                    <!-- Auto-play Control -->
                    <button class="news-auto-play" id="autoPlayBtn" onclick="toggleAutoPlay()">
                        <i class="fas fa-pause"></i> Auto-play
                    </button>
                </div>
            </div>

            <!-- Page Content -->
            <div class="content">
                <div class="content-header">
                    <h1>Welcome to Dreamex Datalab HSE</h1>
                </div>

                <!-- HSE KPI Dashboard -->
                <div class="kpi-dashboard">
                    <div class="kpi-row">
                        <!-- Incident Rate KPI -->
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>Incident Rate</h3>
                            </div>
                            <div class="kpi-value">0.5</div>
                            <div class="kpi-trend positive">
                                <i class="fas fa-arrow-down"></i>
                                <span>-15% vs last month</span>
                            </div>
                            <canvas id="incidentChart"></canvas>
                        </div>

                        <!-- Training Compliance KPI -->
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <i class="fas fa-graduation-cap"></i>
                                <h3>Training Compliance</h3>
                            </div>
                            <div class="kpi-value">92%</div>
                            <div class="kpi-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+5% vs target</span>
                            </div>
                            <canvas id="trainingChart"></canvas>
                        </div>

                        <!-- Risk Assessment KPI -->
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <i class="fas fa-clipboard-check"></i>
                                <h3>Risk Assessments</h3>
                            </div>
                            <div class="kpi-value">45</div>
                            <div class="kpi-trend">
                                <span>This Month</span>
                            </div>
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>

                    <!-- Fleet Summary (from Fleet page stats) -->
                    <div class="kpi-row" id="fleetSummaryRow" style="display:none;">
                        <div class="kpi-card wide">
                            <div class="kpi-header">
                                <h3>Fleet Summary</h3>
                            </div>
                            <div class="mini-stats">
                                <div class="mini-stat">
                                    <i class="fas fa-truck"></i>
                                    <div>
                                        <div class="label">Total Vehicles</div>
                                        <div class="value" id="fleetTotalVehicles">0</div>
                                    </div>
                                </div>
                                <div class="mini-stat">
                                    <i class="fas fa-check-circle" style="background:#16a34a"></i>
                                    <div>
                                        <div class="label">Active</div>
                                        <div class="value" id="fleetActiveVehicles">0</div>
                                    </div>
                                </div>
                                <div class="mini-stat">
                                    <i class="fas fa-tools" style="background:#f59e0b"></i>
                                    <div>
                                        <div class="label">In Maintenance</div>
                                        <div class="value" id="fleetMaintenanceVehicles">0</div>
                                    </div>
                                </div>
                                <div class="mini-stat">
                                    <i class="fas fa-ban" style="background:#ef4444"></i>
                                    <div>
                                        <div class="label">Inactive</div>
                                        <div class="value" id="fleetInactiveVehicles">0</div>
                                    </div>
                                </div>
                                <div class="mini-stat">
                                    <i class="fas fa-building" style="background:#06b6d4"></i>
                                    <div>
                                        <div class="label">Departments</div>
                                        <div class="value" id="fleetUniqueDepartments">0</div>
                                    </div>
                                </div>
                                <div class="mini-stat">
                                    <i class="fas fa-map-marker-alt" style="background:#8b5cf6"></i>
                                    <div>
                                        <div class="label">Sites</div>
                                        <div class="value" id="fleetUniqueSites">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    
                </div>

                
            </div>
        </main>
    </div>

    <!-- News Details Modal -->
    <div id="newsModal" class="news-modal">
        <div class="news-modal-content">
            <div class="news-modal-header">
                <h2 id="newsModalTitle"></h2>
                <button class="news-modal-close" onclick="closeNewsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="news-modal-body">
                <div class="news-modal-meta">
                    <div class="news-modal-priority" id="newsModalPriority"></div>
                    <div class="news-modal-timestamp" id="newsModalTimestamp"></div>
                </div>
                <div class="news-modal-subtitle" id="newsModalSubtitle"></div>
                <div class="news-modal-description" id="newsModalDescription"></div>
                <div class="news-modal-image" id="newsModalImage"></div>
                <div class="news-modal-footer">
                    <div class="news-modal-author">
                        <i class="fas fa-user"></i>
                        <span id="newsModalAuthor"></span>
                    </div>
                    <div class="news-modal-date">
                        <i class="fas fa-calendar"></i>
                        <span id="newsModalDate"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== NOTIFICATION SYSTEM FUNCTIONS (from project-list.html) =====
        
        function getAuthUser() {
            if (window.authManager && window.authManager.currentUser) return window.authManager.currentUser;
            try {
                const stored = localStorage.getItem('currentUser');
                return stored ? JSON.parse(stored) : null;
            } catch { return null; }
        }

        async function loadNotificationsOnce() {
            const user = getAuthUser();
            if (!user) return [];
            const db = firebase.database();
            const snap = await db.ref(`notifications/${user.uid}`).once('value');
            if (!snap.exists()) return [];
            const list = Object.entries(snap.val()).map(([id, v]) => ({ id, ...v }));
            list.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
            return list;
        }

        async function markAllNotificationsAsRead() {
            const user = getAuthUser();
            if (!user) return;
            const db = firebase.database();
            const ref = db.ref(`notifications/${user.uid}`);
            const snap = await ref.once('value');
            if (!snap.exists()) return;
            const updates = {};
            Object.keys(snap.val()).forEach(k => { updates[`${k}/read`] = true; });
            await ref.update(updates);
            updateNotificationBadgeCount([]); // will hide; refreshed on next open
        }

        async function markNotificationAsRead(notificationId) {
            const user = getAuthUser();
            if (!user || !notificationId) return;
            await firebase.database().ref(`notifications/${user.uid}/${notificationId}/read`).set(true);
        }

        async function deleteNotificationWithConfirm(notificationId) {
            if (!confirm('Delete this notification?')) return;
            const user = getAuthUser();
            if (!user || !notificationId) return;
            await firebase.database().ref(`notifications/${user.uid}/${notificationId}`).remove();
            const notifications = await loadNotificationsOnce();
            populateNotificationDropdown(notifications);
        }

        async function clearAllNotifications() {
            if (!confirm('Delete all notifications? This cannot be undone.')) return;
            const user = getAuthUser();
            if (!user) return;
            await firebase.database().ref(`notifications/${user.uid}`).remove();
        }

        function formatTimeAgo(ts) {
            if (!ts) return 'Just now';
            const diff = Date.now() - ts;
            const m = Math.floor(diff/60000); const h = Math.floor(diff/3600000); const d = Math.floor(diff/86400000);
            if (m < 1) return 'Just now';
            if (m < 60) return `${m}m ago`; if (h < 24) return `${h}h ago`; return `${d}d ago`;
        }

        function updateNotificationBadgeCount(notifications) {
            const badge = document.querySelector('.notification-badge');
            if (!badge) return;
            const unread = notifications.filter(n => !n.read).length;
            if (unread > 0) { badge.textContent = unread > 99 ? '99+' : String(unread); badge.style.display = 'block'; }
            else { badge.style.display = 'none'; }
        }

        function populateNotificationDropdown(notifications) {
            const listEl = document.querySelector('.notification-list');
            const emptyEl = document.querySelector('.notification-empty');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (!notifications || notifications.length === 0) {
                if (emptyEl) emptyEl.style.display = 'block';
                updateNotificationBadgeCount([]);
                return;
            }
            if (emptyEl) emptyEl.style.display = 'none';
            notifications.slice(0,10).forEach(n => {
                const div = document.createElement('div');
                div.className = `notification-item ${n.read ? 'read' : 'unread'}`;
                div.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-title">${escapeHtml(n.title || 'New Notification')}</div>
                        <div class="notification-message">${escapeHtml(n.message || '')}</div>
                        <div class="notification-time">${formatTimeAgo(n.timestamp)}</div>
                    </div>
                    <div class="notification-actions">
                        ${!n.read ? `<button class="mark-read-btn" title="Mark as read" onclick="markNotificationAsRead('${n.id}')"><i class=\"fas fa-check\"></i></button>` : `<button class="mark-read-btn" title="Already read" disabled><i class=\"fas fa-check\"></i></button>`}
                        <button class="delete-notification-btn" title="Delete notification" onclick="deleteNotificationWithConfirm('${n.id}')"><i class=\"fas fa-trash\"></i></button>
                    </div>
                    ${!n.read ? '<div class="notification-dot"></div>' : ''}
                `;
                listEl.appendChild(div);
            });
            updateNotificationBadgeCount(notifications);
        }

        function wireNotificationUI() {
            const btn = document.getElementById('notificationBtn');
            const dropdown = document.querySelector('.notification-dropdown');
            const profileDropdown = document.querySelector('.profile-dropdown');
            if (!btn || !dropdown) return;
            // Header actions (mark all + clear all)
            const header = dropdown.querySelector('.notification-header');
            if (header && !header.querySelector('.clear-all-notifications')) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'clear-all-notifications';
                clearBtn.textContent = 'Clear all';
                clearBtn.addEventListener('click', async () => {
                    await clearAllNotifications();
                    const list = await loadNotificationsOnce();
                    populateNotificationDropdown(list);
                });
                header.appendChild(clearBtn);
                const markBtn = header.querySelector('.mark-all-read');
                if (markBtn) markBtn.addEventListener('click', async () => {
                    await markAllNotificationsAsRead();
                    const list = await loadNotificationsOnce();
                    populateNotificationDropdown(list);
                });
            }
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
                if (profileDropdown) profileDropdown.classList.remove('show');
                if (dropdown.classList.contains('show')) {
                    const list = await loadNotificationsOnce();
                    populateNotificationDropdown(list);
                }
            });
            document.addEventListener('click', (e) => {
                if (!btn.contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.remove('show');
            });
        }

        function subscribeNotifications() {
            try {
                const user = getAuthUser();
                if (!user) return;
                const ref = firebase.database().ref(`notifications/${user.uid}`);
                ref.on('value', (snap) => {
                    if (!snap.exists()) { updateNotificationBadgeCount([]); return; }
                    const list = Object.values(snap.val());
                    updateNotificationBadgeCount(list);
                });
            } catch (e) { /* noop */ }
        }

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"]+/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }

        // ===== END NOTIFICATION SYSTEM FUNCTIONS =====

        // Initialize authentication manager
        let authManager;

        // Initialize charts when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize authentication manager
            authManager = new AuthManager();
            window.authManager = authManager;
            
            // Wait for authentication to complete before updating branding
            setTimeout(() => {
                if (authManager && authManager.updateCompanyBranding) {
                    authManager.updateCompanyBranding();
                    console.log('✅ Dashboard company branding updated after initialization');
                }
            }, 1000);
            
            // Initialize visual elements in parallel (don't wait for each other)
            initializeCharts();
            setupDropdowns();
            
            // Initialize notification system
            wireNotificationUI();
            subscribeNotifications();
            
            // Initialize other components (this will handle profile loading async)
            await initializeComponents();
        });

        // Chart initialization
        function initializeCharts() {
            // Incident Chart
            const incidentCtx = document.getElementById('incidentChart');
            if (incidentCtx) {
                new Chart(incidentCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Incidents',
                            data: [1.2, 0.8, 1.0, 0.6, 0.4, 0.5],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                display: false
                            },
                            x: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Training Chart
            const trainingCtx = document.getElementById('trainingChart');
            if (trainingCtx) {
                new Chart(trainingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Training %',
                            data: [85, 88, 90, 87, 92, 92],
                            backgroundColor: '#2ecc71',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                display: false
                            },
                            x: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Risk Chart
            const riskCtx = document.getElementById('riskChart');
            if (riskCtx) {
                new Chart(riskCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [45, 15],
                            backgroundColor: ['#3498db', '#ecf0f1'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        cutout: '70%'
                    }
                });
            }

            // (Removed: Environmental and Safety Observations charts)
        }

        // Setup dropdown functionality
        function setupDropdowns() {
            // Profile dropdown only (notifications handled by wireNotificationUI)
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                    // Close notification dropdown if open
                    const notificationDropdown = document.querySelector('.notification-dropdown');
                    if (notificationDropdown) {
                        notificationDropdown.classList.remove('show');
                    }
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                if (profileDropdown) {
                    profileDropdown.classList.remove('show');
                }
            });
        }

        // Initialize other components
        async function initializeComponents() {
            // Start both profile loading and news loading in parallel
            const profilePromise = loadUserProfile();
            
            // Initialize company news immediately (not waiting for profile)
            initializeNews();
            
            // Wait for profile loading to complete
            await profilePromise;
            
            // Mock notification count
            const notificationBadge = document.querySelector('.notification-badge');
            if (notificationBadge) {
                notificationBadge.textContent = '3';
            }

            // (Removed: Pending Tasks mock data, population, and nav badge)

            // Initialize Fleet summary KPIs if user can view Fleet
            initializeFleetSummaryWidget();
        }

        // Fleet Summary Loader
        async function initializeFleetSummaryWidget() {
            if (window.__fleetSummaryInit) return;
            try {
                // Gate by menu visibility or feature
                const fleetMenuItem = document.querySelector('[data-feature="fleet_view"]');
                const hasFleetAccess = !!(fleetMenuItem && fleetMenuItem.classList.contains('menu-visible'));

                if (!hasFleetAccess) {
                    // Try feature-based authorization if menu not yet processed
                    try { await updateMenuWithFeatureAuthorization(); } catch { /* noop */ }
                }

                const fleetAuthorized = !!(document.querySelector('[data-feature="fleet_view"].menu-visible'));
                const row = document.getElementById('fleetSummaryRow');
                if (!row) return;

                if (!fleetAuthorized) {
                    row.style.display = 'none';
                    return;
                }

                // Show the row and load data
                row.style.display = '';
                window.__fleetSummaryInit = true;

                if (!authManager || !authManager.currentUser || !authManager.currentUser.companyId) return;
                const companyId = authManager.currentUser.companyId;
                const db = getDatabase();
                const vehiclesRef = ref(db, `companies/${companyId}/vehicles`);

                // One-time load and a light listener for updates
                const snap = await get(vehiclesRef);
                const data = snap.exists() ? snap.val() : {};
                const vehicles = Object.values(data || {});
                renderFleetSummary(vehicles);

                // Listen for future updates to keep KPIs fresh
                if (!window.__fleetSummaryListenerAttached) {
                    onValue(vehiclesRef, (s) => {
                        const d = s.exists() ? s.val() : {};
                        renderFleetSummary(Object.values(d || {}));
                    });
                    window.__fleetSummaryListenerAttached = true;
                }
            } catch (e) {
                console.warn('Fleet summary init failed:', e);
            }
        }

        function renderFleetSummary(vehicles) {
            try {
                const total = vehicles.length;
                const byStatus = { active: 0, maintenance: 0, inactive: 0 };
                const deptSet = new Set();
                const siteSet = new Set();

                vehicles.forEach(v => {
                    const status = (v.vehicleStatus || v.status || '').toLowerCase();
                    if (status.includes('maint')) byStatus.maintenance++;
                    else if (status === 'inactive') byStatus.inactive++;
                    else if (status === 'active') byStatus.active++;

                    const dept = v.assignmentDept || v.assignmentDepartment || v.department;
                    const site = v.siteAssignment || v.workArea || v.site;
                    if (dept) deptSet.add(String(dept));
                    if (site) siteSet.add(String(site));
                });

                setText('fleetTotalVehicles', total);
                setText('fleetActiveVehicles', byStatus.active);
                setText('fleetMaintenanceVehicles', byStatus.maintenance);
                setText('fleetInactiveVehicles', byStatus.inactive);
                setText('fleetUniqueDepartments', deptSet.size);
                setText('fleetUniqueSites', siteSet.size);
            } catch (e) {
                console.warn('Render fleet summary failed:', e);
            }
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = String(value ?? '0');
        }

        // Load user profile information
        async function loadUserProfile() {
            if (!authManager || !authManager.currentUser) return;
            
            const userData = authManager.currentUser;
            const userAvatar = document.getElementById('userAvatar');
            
            if (userData && userAvatar) {
                // Use AuthManager methods to get user info
                const displayName = authManager.getUserDisplayName();
                const email = authManager.getUserEmail();
                
                // Preload avatar URL to avoid showing initials first
                const avatarUrl = await authManager.getUserAvatarUrl();
                
                // Check if user has a profile picture
                if (avatarUrl) {
                    userAvatar.src = avatarUrl;
                    userAvatar.alt = displayName || 'User Avatar';
                } else if (userData.profilePicture) {
                    userAvatar.src = userData.profilePicture;
                    userAvatar.alt = displayName || 'User Avatar';
                } else if (userData.photoURL) {
                    userAvatar.src = userData.photoURL;
                    userAvatar.alt = displayName || 'User Avatar';
                } else {
                    // Generate initials avatar using AuthManager
                    authManager.generateInitialsAvatar(displayName, userAvatar);
                }
                
                // Update the welcome message
                const welcomeHeader = document.querySelector('.content-header h1');
                if (welcomeHeader && displayName && displayName !== 'User') {
                    welcomeHeader.textContent = `Welcome back, ${displayName}!`;
                }
            }
        }

        // Update profile dropdown with user information
        function updateProfileDropdown(userData) {
            // This function is now handled by AuthManager.updateUIForAuthenticatedUser()
            // Keep for backward compatibility but functionality moved to AuthManager
        }

        // Check authentication status (handled by AuthManager)
        function checkAuthStatus() {
            return authManager && authManager.currentUser;
        }

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize authentication manager
            authManager = new AuthManager();
            window.authManager = authManager;
            
            // Initialize visual elements in parallel (don't wait for each other)
            initializeCharts();
            setupDropdowns();
            
            // Initialize other components (this will handle profile loading async)
            await initializeComponents();
        });

        // Listen for storage changes (when user logs in/out in another tab)
        window.addEventListener('storage', function(e) {
            if (e.key === 'currentUser') {
                if (e.newValue) {
                    // User logged in, reload page to reinitialize AuthManager
                    window.location.reload();
                } else {
                    // User logged out, redirect to login
                    window.location.href = 'index.html';
                }
            }
        });

        // Company News Carousel Functionality (with navigation)
        let newsData = [];
        let currentSlide = 0;
        let totalSlides = 0;
        let visibleSlides = 3;

        function initializeNewsCarousel() {
            // Load company news from Firebase immediately
            loadCompanyNews();
            
            // Also try again after 1 second if auth wasn't ready the first time
            setTimeout(() => {
                if (authManager && authManager.currentUser && authManager.currentUser.companyId) {
                    console.log('News initialization retry - auth now ready');
                    loadCompanyNews();
                }
            }, 1000);
        }

        function changeSlide(direction) {
            if (totalSlides <= visibleSlides) return; // No navigation needed if all slides are visible
            
            const slides = document.getElementById('newsSlides');
            const slideWidth = 100 / visibleSlides; // Each slide takes 33.333% width
            
            currentSlide += direction;
            
            // Handle boundaries
            const maxSlide = totalSlides - visibleSlides;
            if (currentSlide > maxSlide) {
                currentSlide = maxSlide;
            } else if (currentSlide < 0) {
                currentSlide = 0;
            }
            
            // Update slide position
            const translateX = -(currentSlide * slideWidth);
            slides.style.transform = `translateX(${translateX}%)`;
            
            // Update navigation buttons
            updateNavButtons();
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn && nextBtn) {
                const maxSlide = totalSlides - visibleSlides;
                
                // Hide buttons if all slides are visible
                if (totalSlides <= visibleSlides) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                    
                    // Enable/disable buttons based on current slide
                    prevBtn.disabled = currentSlide === 0;
                    nextBtn.disabled = currentSlide >= maxSlide;
                }
            }
        }

        // Initialize news data
        function initializeNews() {
            // Initialize the news carousel
            initializeNewsCarousel();
        }

        // Load company news from Firebase
        async function loadCompanyNews() {
            try {
                if (!authManager || !authManager.currentUser) {
                    console.log('No authenticated user found');
                    return;
                }
                
                const companyId = authManager.currentUser.companyId;
                if (!companyId) {
                    console.log('No company ID found');
                    return;
                }
                
                console.log(`Loading news for company: ${companyId}`);
                
                const db = getDatabase();
                const newsRef = ref(db, `companies/${companyId}/news`);
                
                // Set up real-time listener for news updates
                onValue(newsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const newsData = snapshot.val();
                        
                        // Convert to array and sort by creation date (newest first)
                        const newsArray = Object.values(newsData)
                            .filter(news => news && news.status === 'published') // Only show published news
                            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        
                        console.log(`Found ${newsArray.length} published news items for company ${companyId}`);
                        
                        // Update news carousel with latest news
                        updateNewsCarousel(newsArray);
                        
                        console.log('Company news loaded successfully:', newsArray);
                    } else {
                        console.log(`No news found for company ${companyId}`);
                        // Show default news or empty state
                        showDefaultNews();
                    }
                }, (error) => {
                    console.error('Error loading company news:', error);
                    // Keep the default news if there's an error
                    showDefaultNews();
                });
                
            } catch (error) {
                console.error('Error setting up news listener:', error);
                // Keep the default news if there's an error
                showDefaultNews();
            }
        }

        // Show default news when no company news is available
        function showDefaultNews() {
            const defaultNews = [
                {
                    id: 'default-1',
                    title: 'Welcome to Enterprise News',
                    subtitle: 'Stay updated with company announcements',
                    description: 'This is where you will see important company news and updates. News created in the Enterprise News Management section will appear here.',
                    priority: 'medium',
                    createdAt: new Date().toISOString(),
                    createdBy: { name: 'System', email: 'system@company.com' }
                }
            ];
            
            updateNewsCarousel(defaultNews);
        }

        // Refresh news manually (for debugging)
        function refreshNews() {
            console.log('Manually refreshing news...');
            if (authManager && authManager.currentUser) {
                const companyId = authManager.currentUser.companyId;
                console.log(`Current company ID: ${companyId}`);
                console.log(`Firebase path: companies/${companyId}/news`);
                loadCompanyNews();
            } else {
                console.log('No authenticated user or company ID');
            }
        }

        // Debug function to check Firebase connection
        function debugFirebaseConnection() {
            console.log('=== Firebase Debug Info ===');
            console.log('Firebase app:', firebase.app());
            console.log('Auth manager:', authManager);
            console.log('Current user:', authManager?.currentUser);
            console.log('Company ID:', authManager?.currentUser?.companyId);
            
            if (authManager?.currentUser?.companyId) {
                const companyId = authManager.currentUser.companyId;
                const db = getDatabase();
                const newsRef = ref(db, `companies/${companyId}/news`);
                console.log('News reference:', newsRef);
                console.log(`Full Firebase path: https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/news`);
            }
        }

        // Make functions available globally for debugging
        window.refreshNews = refreshNews;
        window.debugFirebaseConnection = debugFirebaseConnection;

        // Update news carousel with dynamic content
        function updateNewsCarousel(newsArray) {
            const newsSlides = document.getElementById('newsSlides');
            
            if (!newsSlides) {
                console.error('News carousel container not found');
                return;
            }
            
            // Clear existing slides
            newsSlides.innerHTML = '';
            
            // If no news, show default message
            if (newsArray.length === 0) {
                showDefaultNews();
                return;
            }
            
            // Store news data
            newsData = newsArray;
            totalSlides = newsArray.length;
            currentSlide = 0;
            
            console.log(`Creating ${newsArray.length} news slides`);
            
            // Create slides for each news item
            newsArray.forEach((news, index) => {
                // Create slide/card container
                const slide = document.createElement('div');
                slide.className = 'news-slide';
                
                // Create image section
                const slideImage = document.createElement('div');
                slideImage.className = 'news-slide-image';
                slideImage.style.cursor = 'pointer';
                
                // Add click event to image to open modal
                slideImage.addEventListener('click', () => openNewsModal(news));
                
                // Generate background gradient based on priority
                const gradientColors = {
                    high: ['#e74c3c', '#c0392b'],
                    medium: ['#f39c12', '#e67e22'],
                    low: ['#2ecc71', '#27ae60']
                };
                
                const colors = gradientColors[news.priority] || ['#3498db', '#2980b9'];
                
                // Set background image or gradient
                if (news.imageUrl) {
                    slideImage.style.backgroundImage = `url('${news.imageUrl}')`;
                } else {
                    slideImage.style.background = `linear-gradient(135deg, ${colors[0]}, ${colors[1]})`;
                }
                
                // Calculate time ago
                const timeAgo = getTimeAgo(news.createdAt);
                
                // Create overlay content for image
                const overlayContent = document.createElement('div');
                overlayContent.className = 'news-slide-overlay-content';
                overlayContent.innerHTML = `
                    <div class="news-time-stamp">${timeAgo}</div>
                    <div class="news-priority-badge ${news.priority}">${news.priority.charAt(0).toUpperCase() + news.priority.slice(1)} Priority</div>
                `;
                
                slideImage.appendChild(overlayContent);
                
                // Create text section
                const slideText = document.createElement('div');
                slideText.className = 'news-slide-text';
                
                // Truncate description for preview
                const description = news.description || '';
                const shortDescription = description.length > 80 ? description.substring(0, 80) + '...' : description;
                
                slideText.innerHTML = `
                    <div class="news-slide-text-header">
                        <div class="news-slide-text-content">
                            <h3 class="news-slide-text-title">${escapeHtml(news.title)}</h3>
                            <p class="news-slide-text-subtitle">${escapeHtml(news.subtitle || '')}</p>
                        </div>
                        <button class="news-slide-read-btn" data-news-index="${index}">
                            <i class="fas fa-book-open"></i>
                            Read More
                        </button>
                    </div>
                    <p class="news-slide-text-description">${escapeHtml(shortDescription)}</p>
                `;
                
                // Add click event to read more button
                const readBtn = slideText.querySelector('.news-slide-read-btn');
                readBtn.addEventListener('click', () => openNewsModal(news));
                
                // Append both sections to slide
                slide.appendChild(slideImage);
                slide.appendChild(slideText);
                
                newsSlides.appendChild(slide);
            });
            
            // Reset carousel position
            newsSlides.style.transform = 'translateX(0%)';
            
            // Update navigation buttons
            updateNavButtons();
        }

        // Helper function to escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to calculate time ago
        function getTimeAgo(dateString) {
            const now = new Date();
            const createdDate = new Date(dateString);
            const diffInMs = now - createdDate;
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInHours / 24);
            
            if (diffInDays > 7) {
                return createdDate.toLocaleDateString();
            } else if (diffInDays > 0) {
                return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
            } else if (diffInHours > 0) {
                return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
            } else {
                return 'Just now';
            }
        }

    // (Removed: populateTasksWidget helper)

        // Logout function (handled by AuthManager)
        function logout() {
            if (authManager) {
                authManager.logout();
            } else {
                // Fallback logout
                localStorage.removeItem('currentUser');
                localStorage.removeItem('user');
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Error handling for missing resources
        window.addEventListener('error', function(e) {
            console.error('Resource loading error:', e.target.src || e.target.href);
        });

        // News Modal Functions
        function openNewsModal(news) {
            const modal = document.getElementById('newsModal');
            const modalTitle = document.getElementById('newsModalTitle');
            const modalPriority = document.getElementById('newsModalPriority');
            const modalTimestamp = document.getElementById('newsModalTimestamp');
            const modalSubtitle = document.getElementById('newsModalSubtitle');
            const modalDescription = document.getElementById('newsModalDescription');
            const modalImage = document.getElementById('newsModalImage');
            const modalAuthor = document.getElementById('newsModalAuthor');
            const modalDate = document.getElementById('newsModalDate');

            // Populate modal content
            modalTitle.textContent = news.title;
            modalPriority.textContent = news.priority.charAt(0).toUpperCase() + news.priority.slice(1) + ' Priority';
            modalPriority.className = `news-modal-priority ${news.priority}`;
            modalTimestamp.textContent = getTimeAgo(news.createdAt);
            modalSubtitle.textContent = news.subtitle || '';
            modalDescription.textContent = news.description;

            // Handle image
            if (news.imageUrl) {
                modalImage.innerHTML = `<img src="${news.imageUrl}" alt="${news.title}">`;
            } else {
                modalImage.innerHTML = '';
            }

            // Handle author and date
            if (news.createdBy) {
                modalAuthor.textContent = news.createdBy.name || news.createdBy.email || 'Unknown';
            } else {
                modalAuthor.textContent = 'System';
            }

            const createdDate = new Date(news.createdAt);
            modalDate.textContent = createdDate.toLocaleDateString() + ' at ' + createdDate.toLocaleTimeString();

            // Show modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeNewsModal() {
            const modal = document.getElementById('newsModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto'; // Re-enable background scrolling
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('newsModal');
            if (e.target === modal) {
                closeNewsModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeNewsModal();
            }
        });

        // Make modal functions globally available
        window.openNewsModal = openNewsModal;
        window.closeNewsModal = closeNewsModal;

        // Debug function to test dashboard header branding
        window.testDashboardHeaderBranding = function() {
            console.log('🧪 Testing dashboard header branding elements...');
            
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const companyNameHeader = document.getElementById('headerCompanyName');
            
            console.log('Header Logo:', headerLogo ? 'Found' : 'NOT FOUND');
            console.log('Header Logo Placeholder:', headerLogoPlaceholder ? 'Found' : 'NOT FOUND');
            console.log('Company Name Header:', companyNameHeader ? 'Found' : 'NOT FOUND');
            
            if (headerLogoPlaceholder) {
                headerLogoPlaceholder.style.display = 'flex';
                headerLogoPlaceholder.style.background = '#00ff00'; // Green background for testing
                console.log('✅ Placeholder made visible with green background');
            }
            
            if (companyNameHeader) {
                companyNameHeader.style.display = 'inline-block';
                companyNameHeader.textContent = 'DASHBOARD TEST COMPANY';
                companyNameHeader.style.color = '#00ff00'; // Green text for testing
                console.log('✅ Company name updated with green text');
            }
            
            // Force call updateCompanyBranding on AuthManager
            if (window.authManager && window.authManager.updateCompanyBranding) {
                try {
                    window.authManager.updateCompanyBranding();
                    console.log('✅ Called updateCompanyBranding on Dashboard AuthManager');
                } catch (error) {
                    console.error('❌ Error calling Dashboard AuthManager.updateCompanyBranding:', error);
                }
            }
            
            console.log('🧪 Dashboard header branding test completed');
        };

        // ============================================
        // FEATURE-BASED MENU AUTHORIZATION SYSTEM
        // ============================================
        // Enhanced menu visibility system based on roles.html template
        
        // Reset all menu items to hidden
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Show only essential menu items (no permission-gated features)
            const essentialFeatures = [
                'home_view'
            ];
            
            essentialFeatures.forEach(feature => {
                const menuItem = document.querySelector(`[data-feature="${feature}"]`);
                if (menuItem) {
                    menuItem.classList.add('menu-visible');
                    console.log(`✅ Showing essential menu item: ${feature}`);
                }
            });
            
            // Do not show any permission-gated dropdowns in fallback mode
        }

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            // Prevent multiple simultaneous executions
            if (window.isMenuUpdateInProgress) {
                console.log('🔄 Menu update already in progress, skipping...');
                return;
            }
            
            window.isMenuUpdateInProgress = true;
            console.log('🎯 Starting feature-based menu authorization for dashboard.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company and role');
                } else {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company and role...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                                console.log(`✅ Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                if (!userRole) {
                    console.warn('⚠️ No user role found, proceeding with company features only');
                }
                
                // STEP 1: Apply company feature-based authorization
                console.log('🏢 STEP 1: Applying company feature authorization...');
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                
                // STEP 2: Filter by user role permissions within authorized features
                if (userRole) {
                    console.log('👤 STEP 2: Applying role-based filtering within authorized features...');
                    await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                } else {
                    console.log('⚠️ STEP 2: Skipping role-based filtering (no role found)');
                    showSidebarAfterAuth();
                }
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            } finally {
                // Reset the flag to allow future updates
                window.isMenuUpdateInProgress = false;
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('🔐 All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                // Add essential features that should always be available (only non-permission-gated ones)
                const essentialFeatures = [
                    'home_view'
                ];
                
                essentialFeatures.forEach(feature => {
                    authorizedFeatures.add(feature);
                });
                
                console.log('🔐 All authorized features (including essential):', Array.from(authorizedFeatures));
                
                console.log('🎯 Authorized features for dashboard.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu authorization completed for dashboard.html - ${visibleCount} items visible`);
                
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Apply role-based filtering within company authorized features
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log('👤 Applying role-based filtering for role:', userRole);
                
                // Get user role permissions from company
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                
                if (!permissionsSnapshot.exists()) {
                    console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
                    
                    // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                    if (userRole === 'administrator') {
                        console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                        showSidebarAfterAuth();
                        return;
                    }
                    
                    // For other roles without permissions, hide all items with permission requirements
                    console.log('❌ No valid permissions found - filtering out items requiring permissions');
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log('✅ Loaded role permissions:', permissions);
                
                // Apply permission-based filtering
                filterMenuByPermissions(permissions);
                
            } catch (error) {
                console.error('❌ Error applying role-based filtering:', error);
                // Don't hide everything on error - keep company features visible
                showSidebarAfterAuth();
            }
        }

        // Filter currently visible menu items by role permissions
        function filterMenuByPermissions(permissions) {
            console.log('🔍 Filtering visible menu items by role permissions...');
            
            if (!permissions) {
                console.log('⚠️ No permissions object provided');
                hideItemsRequiringPermissions();
                showSidebarAfterAuth();
                return;
            }
            
            // Only check items that are already visible from company features
            const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            console.log(`🎯 Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
            
            let hiddenCount = 0;
            
            visibleMenuItems.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const feature = item.getAttribute('data-feature');
                
                if (requiresPermission) {
                    const hasPermission = permissions[requiresPermission];
                    const hasViewPermission = hasPermission === true || 
                                             (hasPermission && hasPermission.view === true);
                    
                    if (!hasViewPermission) {
                        item.classList.remove('menu-visible');
                        hiddenCount++;
                        console.log(`❌ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
                    } else {
                        console.log(`✅ Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
                    }
                }
            });
            
            // Re-check dropdown menus after permission filtering
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const dropdownFeature = dropdown.getAttribute('data-feature');
                
                if (submenuItems.length === 0) {
                    dropdown.classList.remove('menu-visible');
                    console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
                } else {
                    console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
                }
            });
            
            console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
            
            // Show sidebar after all filtering is complete
            showSidebarAfterAuth();
        }

        // Hide menu items that require permissions (for users without role permissions)
        function hideItemsRequiringPermissions() {
            console.log('🔒 Hiding all menu items that require permissions...');
            
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            let hiddenCount = 0;
            
            itemsRequiringPermissions.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                item.classList.remove('menu-visible');
                hiddenCount++;
                console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
            });
            
            console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
        }

        // Show sidebar and remove loading state after authentication and filtering
        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
                console.log('✅ Sidebar loading state removed - menu authorization complete');
            }
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

        // Enhanced initialization - use feature-based authorization by default
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sidebar toggle (desktop)
            initializeSidebarToggle();
            
            // Initialize mobile menu
            initializeMobileMenu();
            
            // Wait for auth manager to be ready
            setTimeout(async () => {
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error('❌ Error initializing feature-based menu:', error);
                    showBasicMenu();
                }
            }, 1500);
        });

        // Sidebar toggle functionality
        function initializeSidebarToggle() {
            const sidebarToggle = document.querySelector('#sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Restore sidebar state from localStorage
            restoreSidebarState();
        }
        
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                
                // Store sidebar state in localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }
        
        // Mobile menu toggle functionality
        function initializeMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.getElementById('mobileSidebarBackdrop');
            
            if (!mobileMenuToggle || !sidebar || !backdrop) return;
            
            // Open mobile menu
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.add('mobile-active');
                backdrop.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            // Close mobile menu when clicking backdrop
            backdrop.addEventListener('click', function() {
                closeMobileMenu();
            });
            
            // Close mobile menu only when clicking actual navigation links (not dropdown toggles)
            const menuLinks = sidebar.querySelectorAll('a');
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // Only close on mobile (screen width <= 768px)
                    if (window.innerWidth <= 768) {
                        // Check if this is a parent menu item with submenu
                        const parentLi = link.closest('li');
                        const hasSubmenu = parentLi && (parentLi.classList.contains('menu-dropdown') || parentLi.querySelector('.submenu'));
                        
                        // If it has a submenu, don't close - let the submenu toggle
                        if (hasSubmenu && link.getAttribute('href') === '#') {
                            return; // Don't close, allow submenu to open
                        }
                        
                        // If it's an actual link (not just a dropdown toggle), close the menu
                        if (link.getAttribute('href') && link.getAttribute('href') !== '#') {
                            closeMobileMenu();
                        }
                    }
                });
            });
            
            // Close mobile menu on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebar.classList.contains('mobile-active')) {
                    closeMobileMenu();
                }
            });
            
            // Handle window resize - close mobile menu if resizing to desktop
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (window.innerWidth > 768 && sidebar.classList.contains('mobile-active')) {
                        closeMobileMenu();
                    }
                }, 250);
            });
        }
        
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.getElementById('mobileSidebarBackdrop');
            
            if (sidebar) sidebar.classList.remove('mobile-active');
            if (backdrop) backdrop.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function restoreSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (isCollapsed && sidebar && mainContent) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
            }
        }
    </script>
</body>
</html>
