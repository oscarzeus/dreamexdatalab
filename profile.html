<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-color: #2c3e50;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 4rem; /* match smaller fixed header height */
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px; /* reduce header height similar to staff.html */
            min-height: 50px;
            padding: 0 0.75rem; /* compact paddings */
            background-color: #fff;
            border-radius: 0; /* remove rounded corners */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #headerCompanyName {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--primary-color);
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Menu Visibility Styles */
        .menu-item {
            display: block;
        }

        .menu-item.hidden {
            display: none !important;
        }

        /* Essential Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Submenu item visibility */
        .submenu li:not(.menu-visible) {
            display: none !important;
        }

        /* Hide menu items during loading until permissions are applied */
        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .submenu li {
            display: none !important;
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        /* Match accessdaily header logo + name styling */
        #headerCompanyLogo {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            object-fit: cover;
            display: none;
            /* travel.html: logo without background/border/shadow */
            background: transparent;
            border: none;
            box-shadow: none;
        }
        #headerCompanyLogo.visible { display: block; }
        #headerCompanyName {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--primary-color);
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .clear-all-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .clear-all-btn:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* User Profile Styles */
        .user-profile { position: relative; display: flex; align-items: center; }

        /* Match travel.html: button + avatar */
        .profile-btn { background:none; border:none; cursor:pointer; padding:0; display:flex; align-items:center; }
        .profile-btn img { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#eee; }

        /* Match travel.html: dropdown container */
        .profile-dropdown { position:absolute; top:100%; right:0; background:#fff; border:1px solid #ddd; border-radius:6px; padding:0; display:none; min-width:220px; box-shadow:0 4px 12px rgba(0,0,0,0.12); z-index:1000; }
        .profile-dropdown.show { display:block; }
        .profile-dropdown ul { list-style:none; margin:0; padding:0; }
        .profile-dropdown li a { display:flex; align-items:center; gap:8px; padding:10px 14px; text-decoration:none; color:#333; font-size:0.8rem; }
        .profile-dropdown li a:hover { background:#f5f5f5; }

        .profile-dropdown ul li.profile-header .profile-info {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .profile-dropdown ul li.profile-header .profile-info strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .profile-dropdown ul li.profile-header .profile-info small {
            display: block;
            color: #666;
            font-size: 12px;
        }
        
        .user-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Content Styles */
        .content {
            padding: 1rem;
            background-color: var(--bg-secondary);
            min-height: calc(100vh - 6rem);
            border-radius: 10px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .content-header h1 {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .profile-header {
            background: white;
            padding: 1.25rem; /* reduced from 2rem */
            border-radius: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.25rem; /* reduced spacing */
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .profile-header-content {
            display: flex;
            align-items: flex-start; /* align avatar and text to same top axis */
            gap: 1rem; /* tightened gap */
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
        }

        .profile-info-section {
            flex: 1;
            display: flex;              /* vertically center name/role next to avatar */
            flex-direction: column;
            justify-content: center;
            min-height: 64px;           /* match avatar height so centers correctly */
        }
        
        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .profile-avatar {
            width: 64px;  /* reduced from 80px */
            height: 64px; /* reduced from 80px */
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3); /* slimmer border */
            object-fit: cover;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; /* reduced from 32px */
            font-weight: bold;
            color: white;
            position: relative; /* for overlay button positioning */
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-upload-btn {
            position: absolute;
            right: -4px;
            bottom: -4px;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
            border: 2px solid rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.55);
            color: #ffffff;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: background-color 0.2s ease, transform 0.1s ease;
            z-index: 2;
        }

        .avatar-upload-btn i {
            font-size: 14px;
            line-height: 1;
        }

        .avatar-upload-btn:hover {
            background: rgba(0, 0, 0, 0.70);
            transform: translateY(-1px);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.4rem; /* reduced from 1.8rem */
            line-height: 1.2;  /* tighter line height */
            font-weight: 600;
            margin-bottom: 0.25rem; /* tighter spacing */
            color: white;
            white-space: nowrap;        /* keep to one line */
            overflow: hidden;           /* hide overflow */
            text-overflow: ellipsis;    /* show ellipsis for long names */
            max-width: 100%;
        }
        
        .profile-email {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .profile-role {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        /* Name + Role on one line */
        .profile-name-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }
        .profile-name-row .profile-name {
            margin-bottom: 0;
            flex: 1 1 auto;
            min-width: 0; /* allow ellipsis */
        }
        
        /* Tab Styles */
        .profile-tabs {
            background: transparent;
            margin-bottom: 20px;
        }

        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin: 0 0 1rem 0;
            background: white;
            padding: 0.5rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            flex: 1;
            justify-content: center;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .tab-nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* Content tabs wrapper styling to match staff.html */
        .content-tabs {
            margin: 0;
            width: 100%;
            box-shadow: 0 32px 96px rgba(0,0,0,0.35), 0 20px 48px rgba(0,0,0,0.25), 0 10px 24px rgba(0,0,0,0.18);
            border-radius: 0;
            transition: box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .content-tabs:hover {
            box-shadow: 0 40px 120px rgba(0,0,0,0.42), 0 26px 60px rgba(0,0,0,0.32), 0 14px 32px rgba(0,0,0,0.22);
        }

        /* Tab content area */
        .tab-content {
            display: block;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Card Styles for tab content */
        .tab-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .tab-card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .tab-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-card-body {
            padding: 1rem;
        }

        /* Compact Timesheet & Modal Styles */
        /* Make tables, inputs and modal more compact for denser UI */
        .profile-card table th, .profile-card table td {
            padding: 0.4rem 0.6rem !important;
            font-size: 0.85rem;
        }

        #timesheetModal .timesheet-modal-content {
            width: 920px;
            max-width: 95%;
        }

        #timesheetModal input[type="time"],
        #timesheetModal input[type="number"],
        #timesheetModal input[type="text"],
        #timesheetModal select,
        #timesheetModal textarea,
        #timesheetModal input[type="month"] {
            padding: 0.35rem 0.45rem;
            font-size: 0.85rem;
            height: 30px;
        }

        #tsDaysContainer > div {
            padding: 6px 6px !important;
            gap: 6px !important;
        }

        /* Responsive modal: ensure modal fits viewport on small screens */
        #timesheetModal {
            padding: 12px;
        }

        .timesheet-modal-content {
            max-height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .timesheet-modal-header {
            flex: 0 0 auto;
        }

        .timesheet-modal-body {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* keep outer overflow hidden so inner container scrolls */
        }

        .timesheet-modal-body {
            padding: 20px;
        }

        /* Ensure the form uses full modal body space */
        #timesheetForm {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #tsDaysContainer {
            flex: 1 1 auto;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .timesheet-modal-footer {
            flex: 0 0 auto;
            padding: 10px 16px;
            border-top: 1px solid #eee;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #555;
            gap: 12px;
        }

        .timesheet-modal-footer .footer-actions {
            display: flex;
            gap: 8px;
        }

        /* Icon-only button styles matching staff.html */
        .timesheet-modal-footer .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .timesheet-modal-footer .btn i {
            font-size: 0.875rem;
        }

        .footer-actions .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .footer-actions .btn i {
            font-size: 0.875rem;
        }

        /* View modal approval actions button styles */
        #approvalActions .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        #approvalActions .btn i {
            font-size: 0.875rem;
        }

        /* Secondary button styling matching staff.html */
        .btn-secondary {
            background-color: transparent !important;
            color: #6b7280 !important;
            border: none !important;
            box-shadow: none !important;
        }

        .btn-secondary:hover {
            background-color: rgba(107, 114, 128, 0.1) !important;
            color: #374151 !important;
        }

        /* Submitted timesheet row highlight */
        tr.submitted-row {
            background: linear-gradient(90deg, rgba(230,240,255,0.6), rgba(245,245,245,0.4));
        }

        .profile-content {
            /* Container for tabbed content */
            margin-top: 20px;
        }
        
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e1e8ed;
        }
        
        .profile-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #34495e;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea,
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Readonly field styling */
        .form-group input[readonly],
        .form-group select[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .form-group input[readonly]:focus,
        .form-group select[disabled]:focus {
            border-color: #e9ecef;
            box-shadow: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Approval Button Styles */
        .btn-approve {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-approve:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
        }
        
        .btn-decline {
            background: linear-gradient(135deg, #e74c3c 0%, #dc3545 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-decline:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
            background: linear-gradient(135deg, #be123c 0%, #9f1239 100%);
        }
        
        /* Icon-only overrides inside modals (remove background behind icons) */
        .timesheet-modal-footer .footer-actions button,
        #approvalActions button {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0.4rem !important;
            width: 2.25rem !important;
            height: 2.25rem !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            gap: 0 !important;
        }

        .timesheet-modal-footer .footer-actions button:hover,
        #approvalActions button:hover {
            background-color: rgba(0,0,0,0.05) !important;
            transform: translateY(-1px);
        }

        /* Color cues without fill backgrounds */
        #approvalActions .btn-approve { color: #16a34a !important; }
        #approvalActions .btn-decline { color: #dc2626 !important; }
        #approvalActions .btn-delete  { color: #e11d48 !important; }

        /* Footer icon button colors (neutral like staff.html) */
        .timesheet-modal-footer .footer-actions .btn-primary { color: #6b7280 !important; }
        .timesheet-modal-footer .footer-actions .btn-primary:hover { color: #374151 !important; }
        
        /* Approval Actions Container */
        .approval-actions {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
            margin-top: 16px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .tab-pane h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e1e8ed;
            padding-bottom: 10px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: background-color 0.3s ease;
        }

        .activity-item:hover {
            background: #e9ecef;
        }

        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #6c757d;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e1e8ed;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .password-requirements {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
        }
        
        .password-requirements ul {
            list-style-type: none;
            padding: 0;
        }
        
        .password-requirements li {
            padding: 2px 0;
        }
        
        .password-requirements li.valid {
            color: #28a745;
        }
        
        .password-requirements li.invalid {
            color: #dc3545;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        
        /* Responsive Design */
        @media (max-width: 1600px) {
            .main-content {
                width: calc(100vw - var(--sidebar-width));
                max-width: calc(100vw - var(--sidebar-width));
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
            }
            
            .top-nav {
                left: 0.5rem;
            }
            
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .profile-header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        .notification-success {
            background: #28a745;
        }
        
        .notification-error {
            background: #dc3545;
        }

        /* Tooltip Styles */
        .form-group {
            position: relative;
        }

        .error-tooltip {
            position: absolute;
            bottom: -35px;
            left: 0;
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .error-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .error-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 15px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #dc3545;
        }

        .form-group.has-error input {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        /* Password Toggle Styles */
        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .password-toggle:hover {
            color: #495057;
        }

        .password-toggle:focus {
            outline: none;
            color: var(--primary-color);
        }

        .password-input-container input {
            padding-right: 45px;
        }

        /* Activity Tab Styles */
        .activity-loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .activity-loading i {
            margin-right: 0.5rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background-color: #f8f9fa;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
        }

        .activity-icon.login {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .activity-icon.profile {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .activity-icon.request {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .activity-icon.security {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .activity-icon.system {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .activity-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .activity-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Activity Grouping Styles */
        .activity-date-group {
            margin-bottom: 1.5rem;
        }

        .activity-date-header {
            font-weight: 600;
            color: var(--primary-color);
            background: linear-gradient(135deg, rgba(103, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 4px solid var(--primary-color);
        }

        .activity-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-style: italic;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-specific {
            font-weight: 500;
            color: var(--primary-color);
        }

        .time-relative {
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsiveness for Tabs */
        @media (max-width: 768px) {
            .tab-nav-btn {
                flex: none;
                min-width: 100px;
                padding: 12px 15px;
                font-size: 13px;
            }

            .tab-navigation {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-content {
                padding: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .activity-item {
                padding: 12px;
            }

            .profile-container {
                margin: 0;
            }
        }

        /* Approval Flow (Timesheet) minimal styles */
        .approval-flow-display { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
        .approval-flow-list { display: grid; gap: 8px; }
        .approval-stage { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; border: 1px dashed #e5e7eb; background: #fff; }
        .approval-stage.approved { border-color: #c6f6d5; background: #f0fff4; }
        .approval-stage.current { border-color: #bee3f8; background: #ebf8ff; }
        .approval-stage.pending { border-color: #e2e8f0; background: #ffffff; }
        .approval-stage .badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: #edf2f7; color: #4a5568; }
        .approval-stage.approved .badge { background: #c6f6d5; color: #22543d; }
        .approval-stage.current .badge { background: #bee3f8; color: #2a4365; }
        .approval-meta { color: #64748b; font-size: 12px; }
    </style>
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view">
                            <a href="trainingboard.html">Training</a>
                        </li>
                        <li data-feature="risk_view" data-requires-permission="risk_view">
                            <a href="riskboard.html">Risk Management</a>
                        </li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view">
                            <a href="jsaboard.html">Job Safety Analysis</a>
                        </li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view">
                            <a href="ptwboard.html">Permit to Work</a>
                        </li>
                        <li data-feature="incident_view" data-requires-permission="incident_view">
                            <a href="incidentboard.html">Incident Reports</a>
                        </li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view">
                            <a href="inspectionboard.html">Inspection</a>
                        </li>
                        <li data-feature="audit_view" data-requires-permission="audit_view">
                            <a href="auditboard.html">Audit</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view">
                            <a href="fleet.html">Fleet Management</a>
                        </li>
                        <li data-feature="camp_view" data-requires-permission="camp_view">
                            <a href="camp.html">Camp Management</a>
                        </li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view">
                            <a href="campset.html">Camp Settings</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view">
                            <a href="human-hr.html">Human HR</a>
                        </li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view">
                            <a href="staff.html">Staffing</a>
                        </li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view">
                            <a href="recruit.html">Authority to Recruit</a>
                        </li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view">
                            <a href="jobpost.html">Job Advertising</a>
                        </li>
                        <li data-feature="screening_view" data-requires-permission="screening_view">
                            <a href="jobscreen.html">Screening</a>
                        </li>
                        <li data-feature="interview_view" data-requires-permission="interview_view">
                            <a href="interview.html">Interview</a>
                        </li>
                        <li data-feature="offer_view" data-requires-permission="offer_view">
                            <a href="offer.html">Offer Management</a>
                        </li>
                        <li data-feature="contract_view" data-requires-permission="contract_view">
                            <a href="contract.html">Contract Management</a>
                        </li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view">
                            <a href="salary.html">Salary Management</a>
                        </li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view">
                            <a href="onboard.html">Onboarding</a>
                        </li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view">
                            <a href="kpi.html">KPI</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li class="menu-item" data-feature="communication_view" data-requires-permission="communication_view">
                    <a href="info.html"><i class="fas fa-comments"></i> Communication</a>
                </li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li class="menu-item">
                            <a href="account.html">Account Settings</a>
                        </li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view">
                            <a href="companymanagement.html">Company Management</a>
                        </li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view">
                            <a href="approval-settings.html">Approval Flow Settings</a>
                        </li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view">
                            <a href="fieldsetup.html">Field Setup</a>
                        </li>
                        <li class="menu-item">
                            <a href="preferences.html">Preferences</a>
                        </li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view">
                            <a href="notification-settings.html">Notification Settings</a>
                        </li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view">
                            <a href="auditlog.html">Audit Log</a>
                        </li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view">
                            <a href="users.html">User & Role Management</a>
                        </li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view">
                            <a href="roles.html">Role Permissions</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationCount">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="clear-all-btn" id="clearAllNotifications">Clear All</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <p style="padding: 1rem; text-align: center; color: #666;">No new notifications</p>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li class="profile-header">
                                    <div class="profile-info" style="padding: 1rem; border-bottom: 1px solid #e0e0e0;">
                                        <strong id="profileDropdownName">User</strong>
                                        <small id="profileDropdownEmail" style="display: block; color: #666;">user@example.com</small>
                                    </div>
                                </li>
                                <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
                                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-header-content">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar" id="profileAvatar">
                            <div id="profileInitials">U</div>
                            <button class="avatar-upload-btn" title="Change Photo" onclick="document.getElementById('avatarUpload').click()">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="profile-info-section">
                        <div class="profile-name-row">
                            <h2 class="profile-name" id="profileDisplayName">Loading...</h2>
                            <div class="profile-role" id="profileDisplayRole">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Tab Navigation -->
                <div class="profile-tabs content-tabs">
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" data-tab="personal">
                            <i class="fas fa-user"></i>
                            Personal Info
                        </button>
                        <button class="tab-nav-btn" data-tab="security">
                            <i class="fas fa-shield-alt"></i>
                            Security
                        </button>
                        <button class="tab-nav-btn" data-tab="activity">
                            <i class="fas fa-history"></i>
                            Activity
                        </button>
                        <button class="tab-nav-btn" data-tab="preferences">
                            <i class="fas fa-cog"></i>
                            Preferences
                        </button>
                        <button class="tab-nav-btn" data-tab="timesheet">
                            <i class="fas fa-clock"></i>
                            Timesheets
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane active" id="personal">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <form id="personalInfoForm">
                                <div class="form-group">
                                    <label for="displayName">Full Name</label>
                                    <input type="text" id="displayName" name="displayName" readonly required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="department">Department</label>
                                    <input type="text" id="department" name="department" placeholder="Department assigned by company" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="position">Position</label>
                                    <input type="text" id="position" name="position" placeholder="e.g., Software Engineer, Manager, Analyst" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="bio">Bio</label>
                                    <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Bio
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>

                        <!-- Security Settings Tab -->
                        <div class="tab-pane" id="security">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <form id="securityForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <div class="password-input-container">
                                        <input type="password" id="currentPassword" name="currentPassword">
                                        <button type="button" class="password-toggle" onclick="profileManager.togglePassword('currentPassword')">
                                            <i class="fas fa-eye" id="currentPasswordIcon"></i>
                                        </button>
                                    </div>
                                    <div class="error-tooltip" id="currentPasswordTooltip">Incorrect password. Please try again.</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <div class="password-input-container">
                                        <input type="password" id="newPassword" name="newPassword">
                                        <button type="button" class="password-toggle" onclick="profileManager.togglePassword('newPassword')">
                                            <i class="fas fa-eye" id="newPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm New Password</label>
                                    <div class="password-input-container">
                                        <input type="password" id="confirmPassword" name="confirmPassword">
                                        <button type="button" class="password-toggle" onclick="profileManager.togglePassword('confirmPassword')">
                                            <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="password-requirements" id="passwordRequirements">
                                    <strong>Password Requirements:</strong>
                                    <ul>
                                        <li id="req-length">At least 8 characters</li>
                                        <li id="req-uppercase">At least one uppercase letter</li>
                                        <li id="req-lowercase">At least one lowercase letter</li>
                                        <li id="req-number">At least one number</li>
                                        <li id="req-special">At least one special character</li>
                                    </ul>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-lock"></i> Update Password
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity Tab -->
                        <div class="tab-pane" id="activity">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div id="recentActivity">
                                        <div class="activity-loading">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Loading recent activities...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane" id="preferences">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <form id="preferencesForm">
                                <div class="form-group">
                                    <label for="timezone">Timezone</label>
                                    <select id="timezone" name="timezone">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">Eastern Time</option>
                                        <option value="America/Chicago">Central Time</option>
                                        <option value="America/Denver">Mountain Time</option>
                                        <option value="America/Los_Angeles">Pacific Time</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="language">Language</label>
                                    <select id="language" name="language">
                                        <option value="en">English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Preferences
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>
                        <!-- Timesheet Tab -->
                        <div class="tab-pane" id="timesheet">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Your Timesheets</strong>
                                            <div style="color:#6c757d; font-size:0.9rem;">Create and submit timesheets for approval</div>
                                        </div>
                                        <div>
                                            <button id="createTimesheetBtn" class="btn-primary" aria-label="New Timesheet" title="New Timesheet">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="profile-card">
                                        <table style="width:100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="text-align:left; border-bottom:1px solid #e9ecef;">
                                                    <th>Period</th>
                                                    <th>Total Hours</th>
                                                    <th>Status</th>
                                                    <th>Submitted By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="timesheetTableBody">
                                                <tr><td colspan="5" style="padding:16px; color:#6c757d;">No timesheets yet.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Firebase Configuration and Scripts -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Profile Management Class
        class ProfileManager {
            constructor() {
                this.currentUser = null;
                this.userStats = {};
                this._nameCache = {}; // cache userId -> displayName
                this.initialize();
            }

            initialize() {
                this.loadCurrentUser();
                this.setupEventListeners();
                // Load company info first, then user profile
                setTimeout(async () => {
                    await this.loadCompanyInfo(); // Load company info first
                    await this.loadUserCompany(); // Load user's company association
                    if (this.currentCompany && (this.currentCompany.companyName || this.currentCompany.name)) {
                        this.updateHeaderBranding();
                    }
                    await this.loadUserProfile(); // Then load user profile to get company-scoped data
                    await this.loadUserStats();
                    await this.loadUserTimesheets();
                    await this.loadRecentActivity(); // Load activity data
                    await this.updateMenuVisibility(); // Apply menu permissions
                    // Ensure dropdown content is populated similar to travel.html
                    this.populateUserProfileDropdown();
                }, 100);
            }

            loadCurrentUser() {
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.currentUser = JSON.parse(storedUser);
                
                // Also check Firebase auth state
                auth.onAuthStateChanged((user) => {
                    if (!user) {
                        console.warn('Firebase auth state: No user authenticated');
                        // Don't redirect immediately, but log for debugging
                    } else {
                        console.log('Firebase auth state: User authenticated:', user.email);
                    }
                });
                
                this.updateProfileHeader();
            }

            async updateProfileHeader() {
                if (!this.currentUser) return;

                const displayName = this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0];
                const email = this.currentUser.email;
                const role = this.currentUser.role || 'User';

                // Update header elements
                document.getElementById('profileDisplayName').textContent = displayName;
                const emailEl = document.getElementById('profileDisplayEmail');
                if (emailEl) emailEl.textContent = email;
                document.getElementById('profileDisplayRole').textContent = this.formatRole(role);

                // Update profile dropdown
                document.getElementById('profileDropdownName').textContent = displayName;
                document.getElementById('profileDropdownEmail').textContent = email;

                // Update avatar
                this.updateAvatar(displayName);
                
                // Try to load profile image
                await this.loadProfileImage();
            }

            updateAvatar(displayName) {
                const initials = this.getInitials(displayName);
                const profileInitials = document.getElementById('profileInitials');
                
                if (profileInitials) {
                    profileInitials.textContent = initials;
                }
                
                // Update header avatar
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && !userAvatar.querySelector('img[src*="data:image"]')) {
                    // Only update if no profile image is loaded
                    this.generateInitialsAvatar(displayName, userAvatar);
                }
            }

            getInitials(name) {
                if (!name) return 'U';
                const words = name.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            formatRole(role) {
                if (!role) return 'User';
                
                // Handle specific role IDs and convert them to readable names
                const roleMap = {
                    'Guest_mdc6i4y9': 'Guest',
                    'admin': 'Administrator',
                    'manager': 'Manager',
                    'supervisor': 'Supervisor',
                    'employee': 'Employee',
                    'guest': 'Guest',
                    'user': 'User'
                };
                
                // Check if it's a mapped role ID
                const lowerRole = role.toLowerCase();
                if (roleMap[role] || roleMap[lowerRole]) {
                    return roleMap[role] || roleMap[lowerRole];
                }
                
                // If role contains underscore followed by random characters, extract the base role
                if (role.includes('_')) {
                    const baseRole = role.split('_')[0];
                    if (roleMap[baseRole.toLowerCase()]) {
                        return roleMap[baseRole.toLowerCase()];
                    }
                    // Return just the base role name, capitalized
                    return baseRole.charAt(0).toUpperCase() + baseRole.slice(1).toLowerCase();
                }
                
                // Default formatting for other roles (capitalize and replace hyphens with spaces)
                return role.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            generateInitialsAvatar(displayName, imgElement) {
                if (!imgElement || !displayName) return;
                
                const initials = this.getInitials(displayName);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 40;
                
                canvas.width = size;
                canvas.height = size;
                
                // Background circle
                ctx.beginPath();
                ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#3498db';
                ctx.fill();
                
                // Text
                ctx.fillStyle = '#ffffff';
                ctx.font = `${size / 2.5}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, size / 2, size / 2);
                
                imgElement.src = canvas.toDataURL();
                imgElement.alt = `${displayName} Avatar`;
            }

            async loadProfileImage() {
                if (!this.currentUser) return;

                // Get company ID for scoped path
                const companyId = this.currentUser.companyId || 'default';
                console.log(' Loading profile image for company:', companyId);

                // Try company-scoped path first, then fallback to global
                const possiblePaths = [
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
                    `avatars/${this.currentUser.uid}/profile.jpg`, // Global fallback
                    `avatars/${this.currentUser.uid}/profile.png`,
                    `avatars/${this.currentUser.uid}/profile.jpeg`
                ];

                for (const imagePath of possiblePaths) {
                    try {
                        const imageRef = storage.ref(imagePath);
                        const imageUrl = await imageRef.getDownloadURL();
                        
                        console.log(` Found profile image at: ${imagePath}`);
                        
                        // Update profile avatar
                        const profileAvatar = document.getElementById('profileAvatar');
                        const userAvatar = document.getElementById('userAvatar');
                        
                        if (profileAvatar) {
                            profileAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile Photo">`;
                        }
                        
                        if (userAvatar) {
                            userAvatar.src = imageUrl;
                        }
                        
                        return; // Success, exit the loop
                    } catch (error) {
                        console.log(` No profile image at: ${imagePath}`);
                        continue; // Try next path
                    }
                }

                // No image found, use initials
                console.log('No profile image found, using initials');
                // Generate initials avatar for header
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && this.currentUser) {
                    const displayName = this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0];
                    this.generateInitialsAvatar(displayName, userAvatar);
                }
            }

            // Resolve a user ID to a display name with a small cache to avoid repeated DB reads
            async getUserDisplayNameById(uid) {
                if (!uid) return '';
                if (this._nameCache[uid]) return this._nameCache[uid];
                try {
                    // Try global users node first
                    const userSnap = await db.ref(`users/${uid}`).once('value');
                    if (userSnap.exists()) {
                        const u = userSnap.val();
                        const name = u.name || u.displayName || u.email || uid;
                        this._nameCache[uid] = name;
                        return name;
                    }

                    // Try company-scoped users if currentCompany available
                    const companyId = this.currentCompany && this.currentCompany.id ? this.currentCompany.id : (this.currentUser && this.currentUser.companyId ? this.currentUser.companyId : null);
                    if (companyId) {
                        const cSnap = await db.ref(`companies/${companyId}/users/${uid}`).once('value');
                        if (cSnap.exists()) {
                            const cu = cSnap.val();
                            const cname = cu.name || cu.displayName || cu.email || uid;
                            this._nameCache[uid] = cname;
                            return cname;
                        }
                    }

                    // Fallback: use the uid itself
                    this._nameCache[uid] = uid;
                    return uid;
                } catch (err) {
                    console.warn('getUserDisplayNameById error', err);
                    this._nameCache[uid] = uid;
                    return uid;
                }
            }

            // Resolve user by email to display name with caching
            async getUserDisplayNameByEmail(email) {
                if (!email) return '';
                const cacheKey = `email:${email}`;
                if (this._nameCache[cacheKey]) return this._nameCache[cacheKey];
                
                try {
                    const companyId = this.currentCompany && this.currentCompany.id ? this.currentCompany.id : (this.currentUser && this.currentUser.companyId ? this.currentUser.companyId : null);
                    
                    // Try global users first - query by email
                    const globalUsersSnap = await db.ref('users').orderByChild('email').equalTo(email).once('value');
                    if (globalUsersSnap.exists()) {
                        const users = globalUsersSnap.val();
                        const userData = Object.values(users)[0]; // Take first match
                        const name = userData.name || userData.displayName || email;
                        this._nameCache[cacheKey] = name;
                        return name;
                    }

                    // Try company users - query by email
                    if (companyId) {
                        const companyUsersSnap = await db.ref(`companies/${companyId}/users`).orderByChild('email').equalTo(email).once('value');
                        if (companyUsersSnap.exists()) {
                            const users = companyUsersSnap.val();
                            const userData = Object.values(users)[0]; // Take first match
                            const name = userData.name || userData.displayName || email;
                            this._nameCache[cacheKey] = name;
                            return name;
                        }
                    }

                    this._nameCache[cacheKey] = email;
                    return email;
                } catch (e) {
                    console.warn('Error resolving user name for email', email, e);
                    this._nameCache[cacheKey] = email;
                    return email;
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return;

                try {
                    // Load user data from global users path first
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();

                    console.log('Loading user profile data from global path:', userData);

                    // Also try to load user data from company scope if we have company info
                    let companyUserData = null;
                    if (this.currentCompany?.id) {
                        console.log(' Loading user data from company scope...');
                        console.log(' Company ID:', this.currentCompany.id);
                        console.log(' User UID:', this.currentUser.uid);
                        const companyUserRef = db.ref(`companies/${this.currentCompany.id}/users/${this.currentUser.uid}`);
                        const companySnapshot = await companyUserRef.once('value');
                        companyUserData = companySnapshot.val();
                        console.log(' Company user data:', companyUserData);
                        
                        if (!companyUserData) {
                            console.log(' No user data found in company scope - user may not be added to company yet');
                            console.log(' Trying to find user in any company...');
                            
                            // Try to find the user in any company
                            const companiesRef = db.ref('companies');
                            const companiesSnapshot = await companiesRef.once('value');
                            const companiesData = companiesSnapshot.val();
                            
                            if (companiesData) {
                                for (const [companyId, company] of Object.entries(companiesData)) {
                                    if (company.users && company.users[this.currentUser.uid]) {
                                        companyUserData = company.users[this.currentUser.uid];
                                        console.log(` Found user data in company: ${company.companyName || companyId}`);
                                        console.log(' User data from company:', companyUserData);
                                        break;
                                    }
                                }
                            }
                            
                            if (!companyUserData) {
                                console.log(' User not found in any company - using global user data only');
                            }
                        }
                    } else {
                        console.log(' No company information available - cannot load company-scoped user data');
                    }

                    // Merge data with company data taking precedence for department and position
                    const mergedData = {
                        ...(userData || {}),
                        ...(companyUserData && {
                            department: companyUserData.department,
                            position: companyUserData.jobTitle || companyUserData.position,
                            // Include other company-specific fields if needed
                            phone: companyUserData.phone || userData?.phone,
                            name: companyUserData.name || userData?.name
                        })
                    };

                    console.log(' Merged user data:', mergedData);

                    if (mergedData && Object.keys(mergedData).length > 0) {
                        // Populate form fields with error checking
                        const displayNameField = document.getElementById('displayName');
                        const emailField = document.getElementById('email');
                        const phoneField = document.getElementById('phone');
                        const departmentField = document.getElementById('department');
                        const positionField = document.getElementById('position');
                        const bioField = document.getElementById('bio');
                        
                        if (displayNameField) displayNameField.value = mergedData.name || mergedData.displayName || '';
                        if (emailField) emailField.value = mergedData.email || this.currentUser.email;
                        if (phoneField) phoneField.value = mergedData.phone || '';
                        if (departmentField) {
                            departmentField.value = mergedData.department || '';
                            console.log(' Department field populated with:', mergedData.department || 'No department assigned');
                        }
                        if (positionField) positionField.value = mergedData.position || '';
                        if (bioField) bioField.value = mergedData.bio || '';
                        
                        console.log('Populated fields:', {
                            department: mergedData.department || 'No department data',
                            position: mergedData.position || 'No position data'
                        });
                        
                        // Populate preferences (these come from global user data)
                        const timezoneField = document.getElementById('timezone');
                        const languageField = document.getElementById('language');
                        
                        if (timezoneField) timezoneField.value = userData?.timezone || 'UTC';
                        if (languageField) languageField.value = userData?.language || 'en';
                    } else {
                        console.log('No user data found in database - creating default profile');
                        // Create default profile data
                        const defaultData = {
                            name: this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0],
                            email: this.currentUser.email,
                            phone: '',
                            department: '',
                            position: '',
                            bio: '',
                            timezone: 'UTC',
                            language: 'en',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Save default data to database
                        await db.ref(`users/${this.currentUser.uid}`).set(defaultData);
                        
                        // Set default values in form
                        const displayNameField = document.getElementById('displayName');
                        const emailField = document.getElementById('email');
                        
                        if (displayNameField) displayNameField.value = defaultData.name;
                        if (emailField) emailField.value = defaultData.email;
                        
                        console.log('Default profile created and populated');
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    this.showNotification('Error loading profile data', 'error');
                }
            }

            async loadUserStats() {
                if (!this.currentUser) return;

                try {
                    // Load training requests count
                    const trainingRef = db.ref('trainingRequests');
                    const trainingSnapshot = await trainingRef.orderByChild('submittedBy').equalTo(this.currentUser.uid).once('value');
                    const trainingCount = trainingSnapshot.exists() ? Object.keys(trainingSnapshot.val()).length : 0;
                    
                    // Load access requests count
                    const accessRef = db.ref('access');
                    const accessSnapshot = await accessRef.orderByChild('submittedBy').equalTo(this.currentUser.uid).once('value');
                    const accessCount = accessSnapshot.exists() ? Object.keys(accessSnapshot.val()).length : 0;
                    
                    // Calculate account age
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    const accountAge = userData?.createdAt ? 
                        Math.floor((Date.now() - new Date(userData.createdAt).getTime()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Calculate days since last login
                    const lastLogin = userData?.lastLogin ? 
                        Math.floor((Date.now() - new Date(userData.lastLogin).getTime()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Update stats display
                    document.getElementById('statTrainingRequests').textContent = trainingCount;
                    document.getElementById('statAccessRequests').textContent = accessCount;
                    document.getElementById('statLastLoginDays').textContent = lastLogin;
                    document.getElementById('statAccountAge').textContent = accountAge;
                    
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            /* Timesheet Management */
            async loadUserTimesheets() {
                if (!this.currentUser) return;
                try {
                    const userId = this.currentUser.uid;
                    const userEmail = this.currentUser.email;
                    
                    // Load user's own timesheets
                    const tsRef = db.ref('timesheets').orderByChild('submittedBy').equalTo(userId);
                    const snapshot = await tsRef.once('value');
                    const ownTimesheets = snapshot.exists() ? Object.values(snapshot.val() || {}) : [];
                    
                    // Load timesheets where user is an approver (for submitted ones)
                    const allTimesheetsRef = db.ref('timesheets');
                    const allSnapshot = await allTimesheetsRef.once('value');
                    const allTimesheets = allSnapshot.exists() ? Object.values(allSnapshot.val() || {}) : [];
                    
                    // Filter timesheets where current user can approve or has approved
                    const approverTimesheets = [];
                    for (const ts of allTimesheets) {
                        // Skip if it's user's own timesheet (already included above)
                        if (ts.submittedBy === userId) continue;
                        
                        // Include submitted/pending timesheets where user can approve
                        if (ts.status === 'submitted' || ts.status === 'pending') {
                            const canApprove = await this.checkIfUserCanApproveTimesheet(ts);
                            if (canApprove) {
                                approverTimesheets.push(ts);
                            }
                            continue;
                        }
                        
                        // Include approved/rejected timesheets where user was involved in approval
                        if (ts.status === 'approved' || ts.status === 'rejected') {
                            const wasInvolved = await this.checkIfUserWasInvolvedInApproval(ts);
                            if (wasInvolved) {
                                approverTimesheets.push(ts);
                            }
                        }
                    }
                    
                    // Combine own timesheets with approver timesheets
                    this.timesheets = [...ownTimesheets, ...approverTimesheets]
                        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
                        
                    console.log(` Loaded ${ownTimesheets.length} own timesheets + ${approverTimesheets.length} for approval`);
                    this.renderTimesheets();
                } catch (error) {
                    console.error('Error loading timesheets:', error);
                }
            }

            async checkIfUserCanApproveTimesheet(timesheet) {
                try {
                    // Get the approval flow for this timesheet
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const flat = detailed.flat || [];
                    
                    if (flat.length === 0) {
                        // No flow configured, use general role check
                        return this.checkUserCanApprove(timesheet);
                    }
                    
                    // Find current step based on approval history
                    const hist = Array.isArray(timesheet.approvalHistory) ? timesheet.approvalHistory : [];
                    const approvalsByStep = new Map();
                    hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                    
                    let currentStepIndex = 0;
                    for (let i = 0; i < flat.length; i++) {
                        const e = approvalsByStep.get(i);
                        if (!e || (e.status||'').toLowerCase() !== 'approved') { 
                            currentStepIndex = i; 
                            break; 
                        }
                        if (i === flat.length - 1) currentStepIndex = flat.length; // all approved
                    }
                    
                    // If all steps are approved, no one can approve further
                    if (currentStepIndex >= flat.length) {
                        return false;
                    }
                    
                    // Check if current user can approve this specific step
                    return await this.checkUserCanApproveStep(currentStepIndex);
                    
                } catch (error) {
                    console.warn('Error checking timesheet approval permissions:', error);
                    return false;
                }
            }

            async checkIfUserWasInvolvedInApproval(timesheet) {
                try {
                    const currentUserId = this.currentUser.uid;
                    const currentUserEmail = this.currentUser.email;
                    
                    // Check approval history for user's involvement
                    const hist = Array.isArray(timesheet.approvalHistory) ? timesheet.approvalHistory : [];
                    for (const entry of hist) {
                        if (entry.submittedBy === currentUserId || entry.submittedByEmail === currentUserEmail) {
                            return true; // User approved/rejected this timesheet
                        }
                    }
                    
                    // Check if user could have approved based on approval flow
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const flat = detailed.flat || [];
                    
                    if (flat.length === 0) {
                        // No flow configured, use general role check
                        return this.checkUserCanApprove(timesheet);
                    }
                    
                    // Check if user matches any step in the approval flow
                    for (let stepIndex = 0; stepIndex < flat.length; stepIndex++) {
                        const canApproveStep = await this.checkUserCanApproveStep(stepIndex);
                        if (canApproveStep) {
                            return true; // User is/was an approver in the flow
                        }
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.warn('Error checking user involvement in approval:', error);
                    return false;
                }
            }

            renderTimesheets() {
                const tbody = document.getElementById('timesheetTableBody');
                if (!tbody) return;
                if (!this.timesheets || this.timesheets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:16px; color:#6c757d;">No timesheets yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = this.timesheets.map(ts => {
                    const isSubmitted = ts.status === 'submitted' || ts.status === 'pending' || ts.status === 'approved' || ts.status === 'rejected';
                    const rowClass = isSubmitted ? 'submitted-row' : '';
                    const isOwnTimesheet = ts.submittedBy === this.currentUser?.uid;
                    const submitterDisplay = isOwnTimesheet ? 'You' : (ts.submittedByEmail || ts.submittedBy || 'Unknown');
                    
                    return `
                    <tr data-id="${ts.id}" class="${rowClass}" style="border-bottom:1px solid #f1f1f1; cursor:${isSubmitted ? 'pointer' : 'default'};">
                        <td style="padding:12px;">${ts.month || ts.period || ''}</td>
                        <td style="padding:12px;">${ts.totalHours != null ? ts.totalHours : (ts.totalHours === 0 ? 0 : '')}</td>
                        <td style="padding:12px;">${ts.status || 'draft'}</td>
                        <td style="padding:12px;">${submitterDisplay}</td>
                        <td style="padding:12px;">
                            ${isSubmitted ? '' : `<button class="btn-primary editTimesheetBtn" data-id="${ts.id}" style="padding:6px 10px; font-size:0.85rem;">Edit</button>`}
                        </td>
                    </tr>
                `}).join('');

                // Wire up edit buttons and row click for submitted
                setTimeout(() => {
                    const editBtns = document.querySelectorAll('.editTimesheetBtn');
                    editBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = btn.dataset.id;
                            if (id) this.openEditTimesheetModal(id);
                        });
                    });

                    const rows = tbody.querySelectorAll('tr[data-id]');
                    rows.forEach(r => {
                        r.addEventListener('click', (e) => {
                            const id = r.getAttribute('data-id');
                            const ts = this.timesheets.find(x => x.id === id);
                            if (!ts) return;
                            const isSubmitted = ts.status === 'submitted' || ts.status === 'pending' || ts.status === 'approved' || ts.status === 'rejected';
                            if (isSubmitted) {
                                this.openViewTimesheetModal(id);
                            }
                        });
                    });
                }, 20);
            }

            generateMonthDays(monthValue) {
                // monthValue format: YYYY-MM
                const container = document.getElementById('tsDaysContainer');
                const totalField = document.getElementById('tsTotalHours');
                if (!container) return;
                container.innerHTML = '';

                if (!monthValue) {
                    totalField.value = '';
                    return;
                }

                const [yearStr, monthStr] = monthValue.split('-');
                const year = parseInt(yearStr, 10);
                const month = parseInt(monthStr, 10) - 1; // zero-based

                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const fragment = document.createDocumentFragment();

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const row = document.createElement('div');
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '2fr 1fr 1fr 0.8fr 2fr 0.8fr';
                    row.style.gap = '8px';
                    row.style.padding = '6px 8px';
                    row.style.borderBottom = '1px solid #f5f5f5';

                    const label = document.createElement('div');
                    label.textContent = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });

                    // start time
                    const startInput = document.createElement('input');
                    startInput.type = 'time';
                    startInput.style.width = '100%';
                    startInput.dataset.date = date.toISOString();

                    // end time
                    const endInput = document.createElement('input');
                    endInput.type = 'time';
                    endInput.style.width = '100%';
                    endInput.dataset.date = date.toISOString();

                    // break hours
                    const breakInput = document.createElement('input');
                    breakInput.type = 'number';
                    breakInput.min = '0';
                    breakInput.step = '0.25';
                    breakInput.placeholder = '0';
                    breakInput.style.width = '80px';
                    breakInput.dataset.date = date.toISOString();

                    // comment
                    const commentInput = document.createElement('input');
                    commentInput.type = 'text';
                    commentInput.placeholder = 'Comment';
                    commentInput.style.width = '100%';
                    commentInput.dataset.date = date.toISOString();

                    // computed hours display
                    const hoursDisplay = document.createElement('div');
                    hoursDisplay.textContent = '';
                    hoursDisplay.style.padding = '6px 8px';
                    hoursDisplay.style.textAlign = 'right';
                    hoursDisplay.dataset.date = date.toISOString();

                    function recalc() {
                        const start = startInput.value;
                        const end = endInput.value;
                        const br = parseFloat(breakInput.value) || 0;
                        let hrs = 0;
                        if (start && end) {
                            const s = new Date(`${date.toISOString().slice(0,10)}T${start}`);
                            const e = new Date(`${date.toISOString().slice(0,10)}T${end}`);
                            hrs = (e - s) / (1000 * 60 * 60);
                            if (hrs < 0) {
                                // cross-midnight: add 24
                                hrs += 24;
                            }
                        }
                        hrs = Math.max(0, hrs - br);
                        hrs = Math.round((hrs + Number.EPSILON) * 100) / 100;
                        hoursDisplay.textContent = hrs ? hrs.toString() : '';
                        // update total
                        const total = this.computeTotalHoursFromDays();
                        if (totalField) totalField.value = total;
                    }

                    // wire up listeners
                    startInput.addEventListener('change', recalc.bind(this));
                    endInput.addEventListener('change', recalc.bind(this));
                    breakInput.addEventListener('input', recalc.bind(this));

                    row.appendChild(label);
                    row.appendChild(startInput);
                    row.appendChild(endInput);
                    row.appendChild(breakInput);
                    row.appendChild(commentInput);
                    row.appendChild(hoursDisplay);

                    fragment.appendChild(row);
                }

                container.appendChild(fragment);

                // reset total
                if (totalField) totalField.value = '0';

                // After generating days, adjust modal sizing so it fits the screen
                setTimeout(() => this.adjustTimesheetModalSize(), 50);
            }

            adjustTimesheetModalSize() {
                const modalContent = document.querySelector('.timesheet-modal-content');
                const header = modalContent ? modalContent.querySelector('.timesheet-modal-header') : null;
                const body = modalContent ? modalContent.querySelector('.timesheet-modal-body') : null;
                const days = document.getElementById('tsDaysContainer');
                if (!modalContent || !body || !days) return;

                // Compute available height within viewport for the days container
                const viewportHeight = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
                const headerHeight = header ? header.getBoundingClientRect().height : 0;
                // Compute available space by measuring the distance from the days container
                // top to the bottom of the viewport. This avoids under/over-estimating
                // footer heights and ensures the container never extends under the footer.
                const daysRect = days.getBoundingClientRect();
                const topY = daysRect.top; // distance from viewport top
                const bottomMargin = 24; // leave small margin for buttons/padding
                const available = Math.max(120, viewportHeight - topY - bottomMargin);
                // Account for footer height if present
                const footer = modalContent.querySelector('.timesheet-modal-footer');
                const footerHeight = footer ? footer.getBoundingClientRect().height : 0;
                const finalAvailable = Math.max(120, available - footerHeight - 8);

                // Set explicit height so inner scrolling reaches all rows reliably
                days.style.height = finalAvailable + 'px';
                days.style.maxHeight = available + 'px';
            }

            computeTotalHoursFromDays() {
                const container = document.getElementById('tsDaysContainer');
                if (!container) return 0;
                // Prefer computed hours displays per row
                const hoursDisplays = container.querySelectorAll('div[data-date]');
                let total = 0;

                if (hoursDisplays && hoursDisplays.length > 0) {
                    hoursDisplays.forEach(h => {
                        const v = parseFloat(h.textContent);
                        if (!isNaN(v) && v > 0) total += v;
                    });
                } else {
                    const inputs = container.querySelectorAll('input[data-date]');
                    inputs.forEach(inp => {
                        const v = parseFloat(inp.value);
                        if (!isNaN(v) && v > 0) total += v;
                    });
                }
                // round to 2 decimals
                return Math.round((total + Number.EPSILON) * 100) / 100;
            }

            // ----- Approval Flow Helpers (Timesheets) -----
            // New detailed fetch that preserves level groupings
            async fetchTimesheetApprovalFlowDetailed() {
                const result = { levels: [], flat: [] };
                try {
                    const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId);
                    if (!companyId) return result;

                    // Prefer company-scoped timesheet flow
                    const tsFlowSnap = await db.ref(`companies/${companyId}/approvalFlows/timesheet`).once('value');
                    if (tsFlowSnap.exists()) {
                        const raw = tsFlowSnap.val();
                        return this.normalizeApprovalFlow(raw);
                    }

                    // Fallback to general approval settings
                    const settingsSnap = await db.ref(`companies/${companyId}/approvalSettings/approvalFlow`).once('value');
                    if (settingsSnap.exists()) {
                        return this.normalizeApprovalFlow(settingsSnap.val());
                    }
                } catch (e) {
                    console.warn('fetchTimesheetApprovalFlowDetailed error:', e);
                }
                return result;
            }

            normalizeApprovalFlow(raw) {
                const normalized = { levels: [], flat: [] };
                if (!raw) return normalized;

                // If raw has 'levels'
                if (raw.levels) {
                    const levelsArr = Array.isArray(raw.levels)
                        ? raw.levels
                        : Object.values(raw.levels);
                    levelsArr.forEach((lvl, idx) => {
                        // level may have approvers array or be array itself
                        let approvers = [];
                        if (Array.isArray(lvl)) {
                            approvers = lvl;
                        } else if (lvl && Array.isArray(lvl.approvers)) {
                            approvers = lvl.approvers;
                        } else if (lvl && typeof lvl.approvers === 'object') {
                            approvers = Object.values(lvl.approvers);
                        } else {
                            // Support approval-settings schema where each level is a single selector
                            // Try to resolve from selectedRoles using the explicit level number
                            const levelNumber = (typeof lvl.level === 'number' && lvl.level > 0) ? lvl.level : (idx + 1);
                            const sr = raw.selectedRoles && raw.selectedRoles[`level${levelNumber}`]
                                ? raw.selectedRoles[`level${levelNumber}`][0]
                                : null;
                            if (sr && sr.value) {
                                const val = String(sr.value);
                                if (val.startsWith('user_')) {
                                    approvers = [{ userId: val.replace('user_',''), label: sr.text || null }];
                                } else if (val.startsWith('function_')) {
                                    // Function (job title) based approver  use clean text as label/role
                                    approvers = [{ role: sr.text || val.replace('function_',''), label: sr.text || null }];
                                } else {
                                    // Level-based (e.g., L+1) or unknown  use value/text as label
                                    approvers = [{ label: sr.text || val }];
                                }
                            } else if (lvl && (lvl.approverType || lvl.value)) {
                                // Fallback: build from level object fields
                                const val2 = String(lvl.value || '');
                                if (val2.startsWith('user_')) {
                                    approvers = [{ userId: val2.replace('user_',''), label: lvl.label || null }];
                                } else if (val2.startsWith('function_')) {
                                    approvers = [{ role: lvl.label || val2.replace('function_',''), label: lvl.label || null }];
                                } else if (val2) {
                                    approvers = [{ label: lvl.label || val2 }];
                                }
                            }
                        }

                        const normApprovers = (approvers || []).map(a => ({
                            userId: a.userId || a.uid || a.user || a.approverId || null,
                            role: a.role || a.roleName || a.position || a.approver || null,
                            label: a.label || a.name || a.title || a.displayName || null,
                            email: a.email || a.approverEmail || null
                        }));
                        normalized.levels.push(normApprovers);
                    });
                } else {
                    // Otherwise treat steps/array/object as a single level
                    let steps = [];
                    if (Array.isArray(raw)) steps = raw;
                    else if (raw.steps && Array.isArray(raw.steps)) steps = raw.steps;
                    else if (typeof raw === 'object') steps = Object.values(raw);

                    const norm = steps.map(s => ({
                        userId: s.userId || s.uid || s.user || s.approverId || null,
                        role: s.role || s.roleName || s.position || s.approver || null,
                        label: s.label || s.name || s.title || s.displayName || null,
                        email: s.email || s.approverEmail || null
                    }));
                    normalized.levels.push(norm);
                }

                // Build flat steps with level metadata
                normalized.levels.forEach((lvl, levelIdx) => {
                    lvl.forEach((step, idxInLevel) => {
                        normalized.flat.push({ ...step, levelIndex: levelIdx, indexInLevel: idxInLevel });
                    });
                });

                return normalized;
            }

            // Backward-compatible simple fetch returning flat steps only
            async fetchTimesheetApprovalFlow() {
                try {
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    return detailed.flat;
                } catch (e) {
                    console.warn('fetchTimesheetApprovalFlow error:', e);
                    return [];
                }
            }

            normalizeFlowSteps(raw) {
                if (!raw) return [];
                let steps = [];
                if (Array.isArray(raw)) {
                    steps = raw;
                } else if (raw.steps && Array.isArray(raw.steps)) {
                    steps = raw.steps;
                } else if (typeof raw === 'object') {
                    steps = Object.values(raw);
                }
                return steps.map(s => ({
                    userId: s.userId || s.uid || s.user || s.approverId || null,
                    role: s.role || s.roleName || s.position || s.approver || null,
                    label: s.label || s.name || s.title || s.displayName || null,
                    email: s.email || s.approverEmail || null
                })).filter(Boolean);
            }

            async renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx, containerId = 'tsApprovalFlowContent') {
                const container = document.getElementById(containerId);
                if (!container) return;
                if (!levels || levels.length === 0) {
                    container.innerHTML = '<div class="approval-meta">No approval flow configured for timesheets.</div>';
                    return;
                }

                // Build per-approver status based on currentFlatIdx
                let globalIdx = 0;
                const html = [];
                for (let lvlIndex = 0; lvlIndex < levels.length; lvlIndex++) {
                    const approvers = levels[lvlIndex] || [];
                    const levelItems = await Promise.all(approvers.map(async (step, idxInLevel) => {
                        let who = '';
                        if (step.userId) {
                            try { who = await this.getUserDisplayNameById(step.userId); } catch { who = step.userId; }
                        } else if (step.email) {
                            try { who = await this.getUserDisplayNameByEmail(step.email); } catch { who = step.email; }
                        } else if (step.label) { who = step.label; }
                        else if (step.role) { who = step.role; }
                        else { who = 'Unassigned'; }
                        const statusClass = globalIdx < currentFlatIdx ? 'approved' : (globalIdx === currentFlatIdx ? 'current' : 'pending');
                        const statusText = globalIdx < currentFlatIdx ? 'Approved' : (globalIdx === currentFlatIdx ? 'Current' : 'Pending');
                        const meta = step.role && (!step.label || step.label !== who) ? `  ${step.role}` : '';
                        const item = `
                            <div class="approval-stage ${statusClass}">
                                <span class="badge">Level ${lvlIndex+1}  ${statusText}</span>
                                <div style="display:flex; flex-direction:column;">
                                    <div style="font-weight:600; color:#1f2937;">${who}</div>
                                    <div class="approval-meta">${step.label && step.label !== who ? step.label : ''}${meta}</div>
                                </div>
                            </div>`;
                        globalIdx++;
                        return item;
                    }));
                    // Group: a divider or caption could be added; keep concise
                    html.push(...levelItems);
                }
                container.innerHTML = html.join('');
            }

            openNewTimesheetModal() {
                // Reset form
                const form = document.getElementById('timesheetForm');
                if (form) form.reset();

                const monthInput = document.getElementById('tsMonth');
                if (monthInput) monthInput.value = '';

                const tsIdField = document.getElementById('tsId');
                if (tsIdField) tsIdField.value = '';

                const totalField = document.getElementById('tsTotalHours');
                if (totalField) totalField.value = '';

                const notesField = document.getElementById('tsNotes');
                if (notesField) notesField.value = '';

                const daysContainer = document.getElementById('tsDaysContainer');
                if (daysContainer) daysContainer.innerHTML = '';

                const modal = document.getElementById('timesheetModal');
                if (modal) {
                    modal.style.display = 'flex';
                    // focus month picker for convenience
                    if (monthInput) monthInput.focus();
                    // Show next approver based on approval-settings flow
                    this.updateTimesheetApproverDisplay({ approvalHistory: [] });
                    // Hide approval buttons for new timesheet creation
                    this.updateApprovalButtonVisibility({ status: 'draft' });
                    // ensure sizing fits the viewport
                    setTimeout(() => this.adjustTimesheetModalSize(), 60);
                }
            }

            closeTimesheetModal() {
                const modal = document.getElementById('timesheetModal');
                if (modal) modal.style.display = 'none';
            }

            async saveTimesheet(submit=false) {
                if (!this.currentUser) return this.showNotification('User not authenticated', 'error');
                const month = document.getElementById('tsMonth').value; // YYYY-MM
                const totalHours = parseFloat(document.getElementById('tsTotalHours').value) || 0;
                const notes = document.getElementById('tsNotes').value.trim();

                if (!month) return this.showNotification('Please select a month for the timesheet', 'error');

                // collect per-day hours
                const daysContainer = document.getElementById('tsDaysContainer');
                const days = [];
                if (daysContainer) {
                    // Rows are grid children; read per-row inputs by data-date
                    const rows = Array.from(daysContainer.children);
                    for (const row of rows) {
                        const date = row.querySelector('input[type="time"]')?.dataset.date || row.querySelector('input[data-date]')?.dataset.date;
                        if (!date) continue;
                        const start = row.querySelector('input[type="time"]') ? row.querySelectorAll('input[type="time"]')[0].value : '';
                        const end = row.querySelector('input[type="time"]') ? row.querySelectorAll('input[type="time"]')[1].value : '';
                        const br = row.querySelector('input[type="number"]') ? parseFloat(row.querySelector('input[type="number"]').value) || 0 : 0;
                        const comment = row.querySelector('input[type="text"]') ? row.querySelector('input[type="text"]').value : '';
                        const hoursDisplay = row.querySelector('div[data-date]');
                        const hours = hoursDisplay ? parseFloat(hoursDisplay.textContent) || 0 : 0;

                        days.push({ date, start, end, break: br, comment, hours });
                    }
                }

                // compute total from days to ensure consistency
                const computedTotal = this.computeTotalHoursFromDays();
                const finalTotal = Math.round((computedTotal + Number.EPSILON) * 100) / 100;


                try {
                    this.showLoading(true);
                    const now = Date.now();

                    // Check if editing an existing timesheet
                    const existingId = document.getElementById('tsId') ? document.getElementById('tsId').value : '';
                    let timesheetObj;
                    if (existingId) {
                        // Load existing to preserve createdAt
                        const existingSnap = await db.ref(`timesheets/${existingId}`).once('value');
                        const existing = existingSnap.exists() ? existingSnap.val() : null;
                        timesheetObj = {
                            id: existingId,
                            month,
                            days,
                            totalHours: finalTotal,
                            notes,
                            createdAt: existing ? (existing.createdAt || now) : now,
                            updatedAt: now,
                            submittedBy: this.currentUser.uid,
                            submittedByEmail: this.currentUser.email,
                            status: submit ? 'submitted' : (existing ? (existing.status || 'draft') : 'draft')
                        };

                        // Update existing record
                        await db.ref(`timesheets/${existingId}`).set(timesheetObj);
                    } else {
                        const newId = `TS-${this.currentUser.uid}-${now}`;
                        timesheetObj = {
                            id: newId,
                            month,
                            days,
                            totalHours: finalTotal,
                            notes,
                            createdAt: now,
                            updatedAt: now,
                            submittedBy: this.currentUser.uid,
                            submittedByEmail: this.currentUser.email,
                            status: submit ? 'submitted' : 'draft'
                        };

                        // Save new record
                        await db.ref(`timesheets/${newId}`).set(timesheetObj);
                    }

                    // Refresh local list
                    await this.loadUserTimesheets();

                    if (submit) {
                        await this.submitTimesheetForApproval(timesheetObj);
                        this.showNotification('Timesheet submitted for approval', 'success');
                    } else {
                        this.showNotification('Timesheet saved', 'success');
                    }

                    // clear editing id
                    const tsIdField = document.getElementById('tsId');
                    if (tsIdField) tsIdField.value = '';

                    this.closeTimesheetModal();
                } catch (error) {
                    console.error('Error saving timesheet:', error);
                    this.showNotification('Failed to save timesheet', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async submitTimesheetForApproval(timesheetObj) {
                try {
                    // Build a basic approval entry format similar to other modules
                    const approvalEntry = {
                        id: `APP-TS-${timesheetObj.id}`,
                        sourceId: timesheetObj.id,
                        sourceType: 'timesheet',
                        submittedAt: Date.now(),
                        submittedBy: timesheetObj.submittedBy,
                        submittedByEmail: timesheetObj.submittedByEmail,
                        status: 'submitted'
                    };

                    // Attach approvalHistory to the timesheet
                    await db.ref(`timesheets/${timesheetObj.id}/approvalHistory`).set([approvalEntry]);

                    // Send email notification using existing service if available
                    if (window.emailNotificationService && typeof window.emailNotificationService.sendApprovalNotificationEmails === 'function') {
                        try {
                            await window.emailNotificationService.sendApprovalNotificationEmails({
                                id: approvalEntry.id,
                                sourceType: approvalEntry.sourceType,
                                sourceId: approvalEntry.sourceId
                            }, timesheetObj.id, false);
                            console.log('Approval notification sent for timesheet', timesheetObj.id);
                        } catch (emailErr) {
                            console.warn('Failed to send approval notification email for timesheet', emailErr);
                        }
                    }
                } catch (error) {
                    console.error('Error submitting timesheet for approval:', error);
                }
            }

            async loadRecentActivity() {
                if (!this.currentUser) return;

                try {
                    const activities = [];
                    const userId = this.currentUser.uid;

                    // Load login activities from user record
                    const userRef = db.ref(`users/${userId}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();

                    if (userData?.lastLogin) {
                        activities.push({
                            type: 'login',
                            title: 'Logged in',
                            timestamp: userData.lastLogin,
                            icon: 'fas fa-sign-in-alt',
                            iconClass: 'login'
                        });
                    }

                    if (userData?.updatedAt && userData?.updatedAt !== userData?.createdAt) {
                        activities.push({
                            type: 'profile',
                            title: 'Updated profile information',
                            timestamp: userData.updatedAt,
                            icon: 'fas fa-user-edit',
                            iconClass: 'profile'
                        });
                    }

                    if (userData?.createdAt) {
                        activities.push({
                            type: 'account',
                            title: 'Account created',
                            timestamp: userData.createdAt,
                            icon: 'fas fa-user-plus',
                            iconClass: 'profile'
                        });
                    }

                    // Load all training requests (not limited)
                    const trainingRef = db.ref('trainingRequests');
                    const trainingSnapshot = await trainingRef.orderByChild('submittedBy').equalTo(userId).once('value');
                    
                    if (trainingSnapshot.exists()) {
                        const trainingData = trainingSnapshot.val();
                        Object.values(trainingData).forEach(request => {
                            activities.push({
                                type: 'training',
                                title: `Submitted training request: ${request.trainingType || 'Training'}`,
                                timestamp: request.submittedAt || request.createdAt,
                                icon: 'fas fa-graduation-cap',
                                iconClass: 'request',
                                details: `Status: ${request.status || 'Pending'}`
                            });
                        });
                    }

                    // Load all access requests (not limited)
                    const accessRef = db.ref('access');
                    const accessSnapshot = await accessRef.orderByChild('submittedBy').equalTo(userId).once('value');
                    
                    if (accessSnapshot.exists()) {
                        const accessData = accessSnapshot.val();
                        Object.values(accessData).forEach(request => {
                            activities.push({
                                type: 'access',
                                title: `Requested access to ${request.location || 'area'}`,
                                timestamp: request.submittedAt || request.createdAt,
                                icon: 'fas fa-key',
                                iconClass: 'security',
                                details: `Status: ${request.status || 'Pending'}`
                            });
                        });
                    }

                    // Load password updates (if we track them)
                    if (userData?.passwordUpdatedAt) {
                        activities.push({
                            type: 'security',
                            title: 'Updated password',
                            timestamp: userData.passwordUpdatedAt,
                            icon: 'fas fa-lock',
                            iconClass: 'security'
                        });
                    }

                    // Add avatar upload activity if tracked
                    if (userData?.profileImage && userData?.updatedAt) {
                        activities.push({
                            type: 'profile',
                            title: 'Updated profile photo',
                            timestamp: userData.updatedAt,
                            icon: 'fas fa-camera',
                            iconClass: 'profile'
                        });
                    }

                    // Sort activities by timestamp (most recent first)
                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Show all activities (no limit)
                    this.renderActivityList(activities);

                } catch (error) {
                    console.error('Error loading recent activity:', error);
                    this.renderActivityError();
                }
            }

            renderActivityList(activities) {
                const activityContainer = document.getElementById('recentActivity');
                
                if (!activities || activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="activity-empty">
                            <i class="fas fa-clock"></i>
                            <div>No activity found</div>
                            <small>Your activities will appear here as you use the system</small>
                        </div>
                    `;
                    return;
                }

                // Group activities by date for better organization
                const groupedActivities = this.groupActivitiesByDate(activities);
                
                let activityHTML = '';
                
                Object.entries(groupedActivities).forEach(([dateGroup, dayActivities]) => {
                    activityHTML += `
                        <div class="activity-date-group">
                            <div class="activity-date-header">${dateGroup}</div>
                            <div class="activity-list">
                    `;
                    
                    dayActivities.forEach(activity => {
                        const timeAgo = this.formatTimeAgo(activity.timestamp);
                        const userTimezone = this.currentUser?.timezone || 'UTC';
                        let timeOnly;
                        
                        try {
                            timeOnly = new Date(activity.timestamp).toLocaleTimeString([], {
                                hour: '2-digit', 
                                minute: '2-digit',
                                timeZone: userTimezone
                            });
                        } catch (error) {
                            timeOnly = new Date(activity.timestamp).toLocaleTimeString([], {
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                        }
                        
                        activityHTML += `
                            <div class="activity-item">
                                <div class="activity-icon ${activity.iconClass}">
                                    <i class="${activity.icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.title}</div>
                                    ${activity.details ? `<div class="activity-details">${activity.details}</div>` : ''}
                                    <div class="activity-time">
                                        <span class="time-specific">${timeOnly}</span>
                                        <span class="time-relative">${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    activityHTML += `
                            </div>
                        </div>
                    `;
                });

                activityContainer.innerHTML = activityHTML;
            }

            groupActivitiesByDate(activities) {
                const grouped = {};
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                activities.forEach(activity => {
                    const activityDate = new Date(activity.timestamp);
                    let dateKey;
                    
                    if (this.isSameDay(activityDate, today)) {
                        dateKey = 'Today';
                    } else if (this.isSameDay(activityDate, yesterday)) {
                        dateKey = 'Yesterday';
                    } else {
                        dateKey = activityDate.toLocaleDateString([], {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = [];
                    }
                    grouped[dateKey].push(activity);
                });
                
                return grouped;
            }

            isSameDay(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }

            renderActivityError() {
                const activityContainer = document.getElementById('recentActivity');
                activityContainer.innerHTML = `
                    <div class="activity-empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Failed to load activities</div>
                        <small>Please try refreshing the page</small>
                    </div>
                `;
            }

            formatTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                
                const now = new Date();
                const activityTime = new Date(timestamp);
                const diffInSeconds = Math.floor((now - activityTime) / 1000);

                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 604800) {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `${days} day${days !== 1 ? 's' : ''} ago`;
                } else {
                    // Use user's timezone preference if available
                    const userTimezone = this.currentUser?.timezone || 'UTC';
                    try {
                        return activityTime.toLocaleDateString('en-US', {
                            timeZone: userTimezone
                        });
                    } catch (error) {
                        return activityTime.toLocaleDateString();
                    }
                }
            }

            async loadCompanyInfo() {
                try {
                    console.log(' Loading company information...');
                    // Prefer companyId from authManager or stored currentUser
                    let companyId = null;
                    if (window.authManager?.currentUser?.companyId) {
                        companyId = window.authManager.currentUser.companyId;
                        console.log(' Using companyId from authManager:', companyId);
                    } else if (this.currentUser?.companyId) {
                        companyId = this.currentUser.companyId;
                        console.log(' Using companyId from currentUser:', companyId);
                    }

                    if (companyId) {
                        const companyRefById = db.ref(`companies/${companyId}`);
                        const snap = await companyRefById.once('value');
                        if (snap.exists()) {
                            const companyData = snap.val();
                            this.currentCompany = { id: companyId, ...companyData };
                            console.log(' Company (by ID) loaded:', this.currentCompany);
                            this.updateHeaderBranding();
                            return;
                        } else {
                            console.warn(' Company not found by ID, will scan companies');
                        }
                    }

                    // Fallback: scan companies to locate the user's membership
                    const companyRef = db.ref('companies');
                    console.log(' Scanning all companies for membership...');
                    const snapshot = await companyRef.once('value');
                    const companiesData = snapshot.val();
                    if (companiesData) {
                        const entries = Object.entries(companiesData);
                        let found = null;
                        for (const [cid, comp] of entries) {
                            if (comp?.status && comp.status !== 'active') continue;
                            if (comp?.users && this.currentUser?.uid && (comp.users[this.currentUser.uid] || Object.values(comp.users).some(u => u?.authUid === this.currentUser.uid))) {
                                found = { id: cid, ...comp };
                                break;
                            }
                        }
                        if (found) {
                            this.currentCompany = found;
                            console.log(' Company (by membership) loaded:', this.currentCompany);
                            // Persist on currentUser for later
                            this.currentUser.companyId = found.id;
                            this.currentUser.companyName = found.companyName || found.name || '';
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                            this.updateHeaderBranding();
                        } else {
                            console.log(' No matching company found for user');
                            this.showFallbackBranding();
                        }
                    } else {
                        console.log(' No company data available');
                        this.showFallbackBranding();
                    }
                } catch (error) {
                    console.error(' Error loading company info:', error);
                    this.showFallbackBranding();
                }
            }

            updateHeaderBranding() {
                if (!this.currentCompany) {
                    console.log(' updateHeaderBranding called but no company data available');
                    this.showFallbackBranding();
                    return;
                }

                console.log(' updateHeaderBranding() called with company:', this.currentCompany.companyName);

                // Update header branding elements
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerName = document.getElementById('headerCompanyName');

                console.log(' Header elements found:');
                console.log('- headerLogo:', headerLogo ? '' : '');
                console.log('- headerLogoPlaceholder:', headerLogoPlaceholder ? '' : '');
                console.log('- headerName:', headerName ? '' : '');

                // Update company name first (support companyName or name)
                // Debug logging for company name update
                console.log(' Found headerName element?', !!headerName);
                console.log(' Current company name:', this.currentCompany.companyName || this.currentCompany.name);
                
                const resolvedName = this.currentCompany.companyName || this.currentCompany.name || '';
                if (headerName && resolvedName) {
                    headerName.textContent = resolvedName;
                    headerName.style.display = 'block'; // Ensure it's visible
                    console.log(' Company name updated in header:', resolvedName);
                } else {
                    console.warn(' Could not update company name - headerName:', !!headerName, 'companyName:', !!resolvedName);
                }

                // Check if company has a logo (try both 'logo' and 'logoUrl' properties)
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoUrl && logoUrl.trim() !== '') {
                    console.log(' Company has logo URL:', logoUrl);
                    // Show the logo and hide placeholder
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log(' Company logo displayed');
                    }
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'none';
                    }
                } else {
                    console.log(' No logo URL available, showing placeholder');
                    // Hide logo and show placeholder
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        headerLogo.classList.remove('visible');
                    }
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                }

                // Apply company branding colors if available
                if (this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) {
                        root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    }
                    if (this.currentCompany.branding.secondaryColor) {
                        root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                    }
                }
            }

            showFallbackBranding() {
                console.log(' showFallbackBranding() called - clearing branding');
                
                // First reset all header branding elements to ensure clean state
                this.resetHeaderBranding();
                
                const headerCompanyName = document.getElementById('headerCompanyName');
                
                // Clear company name
                if (headerCompanyName) {
                    headerCompanyName.textContent = '';
                    console.log(' Fallback company name cleared');
                }
            }

            resetHeaderBranding() {
                console.log(' resetHeaderBranding() - clearing all branding elements');
                
                const headerCompanyLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');
                
                // Hide/reset all elements
                if (headerCompanyLogo) {
                    headerCompanyLogo.style.display = 'none';
                    headerCompanyLogo.classList.remove('visible');
                    headerCompanyLogo.src = '';
                }
                
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'flex';
                }
                
                if (headerCompanyName) {
                    headerCompanyName.textContent = '';
                }
            }

            // Feature-based menu authorization system
            async updateMenuVisibility() {
                console.log(' Starting feature authorization update...');
                
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error(' Error in feature authorization:', error);
                    showBasicMenu();
                }
            }

            async loadUserCompany() {
                console.log(' loadUserCompany() called');
                console.log(' currentUser:', this.currentUser);
                
                if (!this.currentUser) {
                    console.warn(' No currentUser available for loadUserCompany');
                    return;
                }

                try {
                    const companiesRef = db.ref('companies');
                    console.log(' Fetching companies from Firebase...');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        console.log(' Companies data received:', Object.keys(companies).length, 'companies');
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        console.log(' Found user in company:', company.companyName, '(ID:', companyId, ')');
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            console.log(' Setting currentCompany:', foundCompany);
                            
                            // Update localStorage with company info
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        } else {
                            console.log(' User not found in any active company');
                        }
                    } else {
                        console.log(' No companies found in database');
                    }
                } catch (error) {
                    console.error(' Error loading user company:', error);
                }
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-nav-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabName = button.getAttribute('data-tab');
                        this.switchTab(tabName);
                    });
                });

                // Avatar upload
                document.getElementById('avatarUpload').addEventListener('change', (e) => {
                    this.handleAvatarUpload(e);
                });

                // Personal info form
                document.getElementById('personalInfoForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePersonalInfo();
                });

                // Security form
                document.getElementById('securityForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updatePassword();
                });

                // Preferences form
                document.getElementById('preferencesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePreferences();
                });

                // Password validation
                document.getElementById('newPassword').addEventListener('input', (e) => {
                    this.validatePassword(e.target.value);
                });

                // Hide password tooltip when user starts typing
                document.getElementById('currentPassword').addEventListener('input', () => {
                    this.hidePasswordTooltip();
                });

                // Language and timezone instant updates
                document.getElementById('language').addEventListener('change', (e) => {
                    this.updateLanguagePreference(e.target.value);
                });

                document.getElementById('timezone').addEventListener('change', (e) => {
                    this.updateTimezonePreference(e.target.value);
                });

                // Password toggle keyboard accessibility
                document.querySelectorAll('.password-toggle').forEach(button => {
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            button.click();
                        }
                    });
                });

                // Profile dropdown functionality
                this.setupProfileDropdown();

                // Timesheet handlers
                const createBtn = document.getElementById('createTimesheetBtn');
                if (createBtn) {
                    createBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.openNewTimesheetModal();
                    });
                }

                const closeModalBtn = document.getElementById('closeTimesheetModal');
                if (closeModalBtn) closeModalBtn.addEventListener('click', () => this.closeTimesheetModal());

                const saveBtn = document.getElementById('saveTimesheetBtn');
                if (saveBtn) saveBtn.addEventListener('click', () => this.saveTimesheet(false));

                const submitBtn = document.getElementById('submitTimesheetBtn');
                if (submitBtn) submitBtn.addEventListener('click', () => this.saveTimesheet(true));

                // Month picker change -> generate day rows
                const monthPicker = document.getElementById('tsMonth');
                if (monthPicker) {
                    monthPicker.addEventListener('change', (e) => {
                        this.generateMonthDays(e.target.value);
                        // adjust modal sizing after month selection
                        setTimeout(() => this.adjustTimesheetModalSize(), 50);
                    });
                }

                const closeFooterBtn = document.getElementById('closeTimesheetFooterBtn');
                if (closeFooterBtn) closeFooterBtn.addEventListener('click', () => this.closeTimesheetModal());

                // Footer Save and Submit buttons
                const footerSaveBtn = document.getElementById('footerSaveBtn');
                if (footerSaveBtn) footerSaveBtn.addEventListener('click', () => this.saveTimesheet(false));

                const footerSubmitBtn = document.getElementById('footerSubmitBtn');
                if (footerSubmitBtn) footerSubmitBtn.addEventListener('click', () => this.saveTimesheet(true));

                // Approval buttons for timesheet modal
                const approveTimesheetBtn = document.getElementById('approveTimesheetBtn');
                if (approveTimesheetBtn) approveTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('approve'));

                const declineTimesheetBtn = document.getElementById('declineTimesheetBtn');
                if (declineTimesheetBtn) declineTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('decline'));

                const deleteTimesheetBtn = document.getElementById('deleteTimesheetBtn');
                if (deleteTimesheetBtn) deleteTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('delete'));

                // Approval buttons for view timesheet modal
                const viewApproveTimesheetBtn = document.getElementById('viewApproveTimesheetBtn');
                if (viewApproveTimesheetBtn) viewApproveTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('approve'));

                const viewDeclineTimesheetBtn = document.getElementById('viewDeclineTimesheetBtn');
                if (viewDeclineTimesheetBtn) viewDeclineTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('decline'));

                const viewDeleteTimesheetBtn = document.getElementById('viewDeleteTimesheetBtn');
                if (viewDeleteTimesheetBtn) viewDeleteTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('delete'));

                // Adjust modal sizing on window resize while modal is open
                window.addEventListener('resize', () => {
                    const modal = document.getElementById('timesheetModal');
                    if (modal && modal.style.display !== 'none') {
                        this.adjustTimesheetModalSize();
                    }
                });

                // Toggle Approval Flow visibility in Timesheet modal
                const showFlowBtn = document.getElementById('showApprovalFlowBtnTs');
                const flowDisplay = document.getElementById('tsApprovalFlowDisplay');
                if (showFlowBtn && flowDisplay) {
                    showFlowBtn.addEventListener('click', () => {
                        const isHidden = flowDisplay.style.display === 'none' || flowDisplay.style.display === '';
                        flowDisplay.style.display = isHidden ? 'block' : 'none';
                        showFlowBtn.innerHTML = isHidden
                            ? '<i class="fas fa-diagram-project"></i> Hide Approval Flow'
                            : '<i class="fas fa-diagram-project"></i> Show Approval Flow';
                        if (isHidden) setTimeout(() => this.adjustTimesheetModalSize(), 30);
                    });
                }
            }

            switchTab(tabName) {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                
                // Add active class to clicked button and corresponding pane
                const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
                const activePane = document.getElementById(tabName);
                
                if (activeButton) activeButton.classList.add('active');
                if (activePane) activePane.classList.add('active');
                
                // Load specific content based on tab
                switch(tabName) {
                    case 'activity':
                        this.loadRecentActivity();
                        break;
                    case 'personal':
                        // Personal info is already loaded
                        break;
                    case 'security':
                        // Security form is static
                        break;
                    case 'preferences':
                        // Preferences might need loading
                        break;
                }
            }

            setupProfileDropdown() {
                const userProfileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown');
                
                if (userProfileBtn && profileDropdown) {
                    userProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });

                    // Close only when clicking outside both button and dropdown (as in travel.html)
                    document.addEventListener('click', (e) => {
                        const clickedOutsideBtn = !userProfileBtn.contains(e.target);
                        const clickedOutsideDropdown = !profileDropdown.contains(e.target);
                        if (clickedOutsideBtn && clickedOutsideDropdown) {
                            profileDropdown.classList.remove('show');
                        }
                    });

                    // Optional: close on Escape for UX consistency
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            profileDropdown.classList.remove('show');
                        }
                    });
                }
            }

            populateUserProfileDropdown() {
                try {
                    const btn = document.getElementById('userProfileBtn');
                    const dropdownUl = document.querySelector('.profile-dropdown ul');
                    if (!btn || !dropdownUl || !this.currentUser) return;

                    const img = btn.querySelector('img');
                    const displayName = this.currentUser.displayName || this.currentUser.name || (this.currentUser.email ? this.currentUser.email.split('@')[0] : 'User');

                    // If avatar not set yet, generate initials avatar background like travel
                    if (img && (!img.src || img.src.startsWith('data:image/svg+xml'))) {
                        const initials = (displayName.split(' ').map(p=>p[0]).join('').substring(0,2) || 'U').toUpperCase();
                        const palette = ['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12'];
                        const bg = palette[initials.charCodeAt(0)%palette.length];
                        const svg = `<svg width="40" height="40" xmlns='http://www.w3.org/2000/svg'><rect width='40' height='40' rx='20' fill='${bg}'/><text x='20' y='24' font-size='14' font-family='Arial' fill='#fff' text-anchor='middle' font-weight='600'>${initials}</text></svg>`;
                        img.src = 'data:image/svg+xml;base64,' + btoa(svg);
                    }

                    // Populate dropdown header and links similar to travel
                    const initials = (displayName.split(' ').map(p=>p[0]).join('').substring(0,2) || 'U').toUpperCase();
                    const badge = `<div style='width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:600;'>${initials}</div>`;
                    const email = this.currentUser.email || '';
                    dropdownUl.innerHTML = `
                        <li style='padding:10px 14px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;'>
                            <div style='width:32px;height:32px;border-radius:50%;overflow:hidden;'>${badge}</div>
                            <div style='display:flex;flex-direction:column;'>
                                <strong style='font-size:12px;'>${displayName}</strong>
                                <span style='font-size:10px;color:#666;'>${email}</span>
                            </div>
                        </li>
                        <li><a href='profile.html'><i class='fas fa-user'></i> Profile</a></li>
                        <li><a href='account.html'><i class='fas fa-cog'></i> Account Settings</a></li>
                        <li><a href='#' id='logoutLink'><i class='fas fa-sign-out-alt'></i> Logout</a></li>
                    `;

                    const logoutLink = document.getElementById('logoutLink');
                    if (logoutLink) {
                        logoutLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            localStorage.removeItem('currentUser');
                            localStorage.removeItem('user');
                            window.location.href = 'index.html';
                        });
                    }
                } catch (err) {
                    console.warn('populateUserProfileDropdown skipped:', err);
                }
            }

            async handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Please select a valid image file', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    this.showNotification('Image size must be less than 5MB', 'error');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Get company ID for scoped upload path
                    const companyId = this.currentUser.companyId || 'default';
                    console.log(' Uploading profile image for company:', companyId);
                    
                    // Upload to company-scoped Firebase Storage path
                    const imageRef = storage.ref(`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`);
                    const snapshot = await imageRef.put(file);
                    const imageUrl = await snapshot.ref.getDownloadURL();
                    
                    console.log(' Profile image uploaded to:', imageRef.fullPath);
                    
                    // Update profile avatar immediately
                    const profileAvatar = document.getElementById('profileAvatar');
                    const userAvatar = document.getElementById('userAvatar');
                    
                    if (profileAvatar) {
                        profileAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile Photo">`;
                    }
                    
                    if (userAvatar) {
                        userAvatar.src = imageUrl;
                    }
                    
                    // Update user record
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        profileImage: imageUrl,
                        updatedAt: new Date().toISOString()
                    });
                    
                    this.showNotification('Profile photo updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    this.showNotification('Error uploading photo. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async savePersonalInfo() {
                // Only save the bio field since other fields are readonly
                const formData = {
                    bio: document.getElementById('bio').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    this.showLoading(true);
                    
                    await db.ref(`users/${this.currentUser.uid}`).update(formData);
                    
                    // Update current user in localStorage
                    this.currentUser = { ...this.currentUser, ...formData };
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    this.showNotification('Bio updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving bio:', error);
                    this.showNotification('Error saving bio. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async updatePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    this.showNotification('Please fill in all password fields', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    this.showNotification('New passwords do not match', 'error');
                    return;
                }

                if (!this.isValidPassword(newPassword)) {
                    this.showNotification('Password does not meet requirements', 'error');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Check if user is authenticated with Firebase
                    const user = auth.currentUser;
                    if (!user) {
                        console.error('No authenticated user found');
                        this.showNotification('User not authenticated. Please log in again.', 'error');
                        return;
                    }

                    console.log('Current user:', user.email);
                    console.log('Attempting to re-authenticate user...');
                    
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        user.email, // Use the current user's email from Firebase
                        currentPassword
                    );
                    
                    await user.reauthenticateWithCredential(credential);
                    console.log('Re-authentication successful');
                    
                    console.log('Updating password...');
                    await user.updatePassword(newPassword);
                    console.log('Password update successful');
                    
                    // Clear form and hide any error tooltips
                    document.getElementById('securityForm').reset();
                    this.hidePasswordTooltip();
                    
                    this.showNotification('Password updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Detailed error updating password:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    if (error.code === 'auth/wrong-password') {
                        this.showPasswordTooltip('Current password is incorrect');
                        this.showNotification('Current password is incorrect', 'error');
                    } else if (error.code === 'auth/weak-password') {
                        this.showNotification('New password is too weak. Please choose a stronger password.', 'error');
                    } else if (error.code === 'auth/requires-recent-login') {
                        this.showNotification('Please log out and log back in, then try updating your password.', 'error');
                    } else if (error.code === 'auth/user-not-found') {
                        this.showNotification('User account not found. Please log in again.', 'error');
                    } else if (error.code === 'auth/too-many-requests') {
                        this.showNotification('Too many failed attempts. Please try again later.', 'error');
                    } else {
                        this.hidePasswordTooltip();
                        this.showNotification(`Error updating password: ${error.message}`, 'error');
                    }
                } finally {
                    this.showLoading(false);
                }
            }

            async savePreferences() {
                const preferences = {
                    timezone: document.getElementById('timezone').value,
                    language: document.getElementById('language').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    this.showLoading(true);
                    
                    await db.ref(`users/${this.currentUser.uid}`).update(preferences);
                    
                    this.showNotification('Preferences saved successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving preferences:', error);
                    this.showNotification('Error saving preferences. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async updateLanguagePreference(language) {
                try {
                    // Update database
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        language: language,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    this.currentUser.language = language;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    // Apply language change immediately (if you have internationalization)
                    this.applyLanguageSettings(language);
                    
                    this.showNotification(`Language changed to ${this.getLanguageName(language)}`, 'success');
                    
                } catch (error) {
                    console.error('Error updating language preference:', error);
                    this.showNotification('Error updating language preference', 'error');
                }
            }

            async updateTimezonePreference(timezone) {
                try {
                    // Update database
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        timezone: timezone,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    this.currentUser.timezone = timezone;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    // Apply timezone change immediately
                    this.applyTimezoneSettings(timezone);
                    
                    this.showNotification(`Timezone changed to ${this.getTimezoneName(timezone)}`, 'success');
                    
                } catch (error) {
                    console.error('Error updating timezone preference:', error);
                    this.showNotification('Error updating timezone preference', 'error');
                }
            }

            applyLanguageSettings(language) {
                // Store language preference for future use
                document.documentElement.lang = language;
                
                // You can add more language-specific logic here
                console.log(`Language preference applied: ${language}`);
            }

            applyTimezoneSettings(timezone) {
                // Store timezone preference for future use
                // This can be used for displaying times in user's preferred timezone
                console.log(`Timezone preference applied: ${timezone}`);
                
                // Refresh activity times if the activity tab is currently active
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'activity') {
                    this.loadRecentActivity();
                }
            }

            getLanguageName(languageCode) {
                const languageNames = {
                    'en': 'English',
                    'es': 'Spanish',
                    'fr': 'French',
                    'de': 'German'
                };
                return languageNames[languageCode] || languageCode;
            }

            getTimezoneName(timezone) {
                const timezoneNames = {
                    'UTC': 'UTC',
                    'America/New_York': 'Eastern Time',
                    'America/Chicago': 'Central Time',
                    'America/Denver': 'Mountain Time',
                    'America/Los_Angeles': 'Pacific Time'
                };
                return timezoneNames[timezone] || timezone;
            }

            validatePassword(password) {
                const requirements = {
                    'req-length': password.length >= 8,
                    'req-uppercase': /[A-Z]/.test(password),
                    'req-lowercase': /[a-z]/.test(password),
                    'req-number': /\d/.test(password),
                    'req-special': /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                Object.entries(requirements).forEach(([id, valid]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.className = valid ? 'valid' : 'invalid';
                    }
                });

                return Object.values(requirements).every(valid => valid);
            }

            isValidPassword(password) {
                return password.length >= 8 &&
                       /[A-Z]/.test(password) &&
                       /[a-z]/.test(password) &&
                       /\d/.test(password) &&
                       /[!@#$%^&*(),.?":{}|<>]/.test(password);
            }

            showPasswordTooltip(message) {
                const tooltip = document.getElementById('currentPasswordTooltip');
                const formGroup = document.getElementById('currentPassword').parentElement.parentElement;
                
                if (tooltip && formGroup) {
                    if (message) {
                        tooltip.textContent = message;
                    }
                    
                    // Add error styling to form group and show tooltip
                    formGroup.classList.add('has-error');
                    tooltip.classList.add('show');
                    
                    // Auto-hide tooltip after 5 seconds
                    setTimeout(() => {
                        this.hidePasswordTooltip();
                    }, 5000);
                }
            }

            hidePasswordTooltip() {
                const tooltip = document.getElementById('currentPasswordTooltip');
                const formGroup = document.getElementById('currentPassword').parentElement.parentElement;
                
                if (tooltip && formGroup) {
                    formGroup.classList.remove('has-error');
                    tooltip.classList.remove('show');
                }
            }

            togglePassword(fieldId) {
                const passwordField = document.getElementById(fieldId);
                const icon = document.getElementById(fieldId + 'Icon');
                
                if (!passwordField || !icon) return;
                
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordField.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }

            checkAuthenticationStatus() {
                console.log('=== Authentication Status Check ===');
                console.log('localStorage currentUser:', this.currentUser);
                console.log('Firebase currentUser:', auth.currentUser);
                
                if (auth.currentUser) {
                    console.log('Firebase user email:', auth.currentUser.email);
                    console.log('Firebase user emailVerified:', auth.currentUser.emailVerified);
                    console.log('Firebase user uid:', auth.currentUser.uid);
                } else {
                    console.log('No Firebase currentUser found');
                }
                
                return auth.currentUser !== null;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification-toast notification-${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            showLoading(show) {
                let overlay = document.getElementById('loadingOverlay');
                
                if (show) {
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'loadingOverlay';
                        overlay.className = 'loading-overlay';
                        overlay.innerHTML = `
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Please wait...</p>
                            </div>
                        `;
                        document.body.appendChild(overlay);
                    }
                    overlay.style.display = 'flex';
                } else {
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                }
            }
        }

        // Global logout function
        async function logout() {
            try {
                await auth.signOut();
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Reset all menu items to hidden (exactly as in dashboard.html)
        function resetMenuVisibility() {
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items (exactly as in dashboard.html)
        function showBasicMenu() {
            console.log(' Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Feature-based authorization system that takes priority over role permissions (exactly as in dashboard.html)
        async function updateMenuWithFeatureAuthorization() {
            console.log(' Starting feature-based menu authorization for profile.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role || null;
                    console.log(' Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log(' Using Firebase auth - will search for company');
                } else {
                    console.log(' No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log(' Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(` Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error(' No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                // If role is not available from authManager snapshot, fetch from users collection
                if (!userRole && currentUser && currentUser.uid) {
                    try {
                        const userSnap = await firebase.database().ref(`users/${currentUser.uid}`).once('value');
                        if (userSnap.exists()) {
                            const u = userSnap.val();
                            userRole = u.role || null;
                        }
                    } catch (e) {
                        console.warn(' Could not fetch user role from DB:', e);
                    }
                }

                // 1) Apply feature-based authorization (company subscribed features)
                await applyFeatureBasedMenuVisibility(companyId);

                // 2) Apply role-based filtering within authorized features (as in riskboard.html)
                if (userRole) {
                    await applyRolePermissionFiltering(companyId, userRole);
                } else {
                    console.log(' No user role found; skipping role-based filtering');
                }
                
            } catch (error) {
                console.error(' Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            }
        }

        // Apply feature-based menu visibility (exactly as in dashboard.html)
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log(' Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log(' No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error(' Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log(' Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log(' Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(` Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(` Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log(' All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log(' Authorized features for profile.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(` Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(` Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(` Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(` Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(` Feature-based menu authorization completed for profile.html - ${visibleCount} items visible`);
                
            } catch (error) {
                console.error(' Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Intersect menu visibility with role permissions (mirrors riskboard.html logic)
        async function applyRolePermissionFiltering(companyId, userRole) {
            try {
                const db = firebase.database();
                const permSnap = await db.ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
                if (!permSnap.exists()) {
                    console.log(` No permissions found for role ${userRole} in company ${companyId}. Skipping role filter.`);
                    return;
                }

                const permissions = permSnap.val() || {};
                console.log(' Loaded role permissions:', Object.keys(permissions));

                // Pass 1: Hide any currently-visible items that the role cannot view
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                allMenuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const canView = !!(permissions[feature] && (permissions[feature].view === true));
                    // Only enforce for items that were made visible by feature auth
                    if (!canView && item.classList.contains('menu-visible')) {
                        item.classList.remove('menu-visible');
                        // console.log(` Role filter hiding: ${feature}`);
                    }
                });

                // Pass 2: Re-evaluate dropdown visibility: show if has any visible child OR the dropdown feature itself is viewable
                const dropdowns = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdowns.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    submenuItems.forEach(subItem => {
                        if (subItem.classList.contains('menu-visible')) hasVisibleChildren = true;
                    });

                    const dropdownCanView = !!(permissions[dropdownFeature] && (permissions[dropdownFeature].view === true));
                    if (hasVisibleChildren || dropdownCanView) {
                        dropdown.classList.add('menu-visible');
                    } else {
                        dropdown.classList.remove('menu-visible');
                    }
                });

                const visibleCount = document.querySelectorAll('#roleBasedMenu [data-feature].menu-visible').length;
                console.log(` Role-based menu filtering applied - ${visibleCount} items visible`);
            } catch (err) {
                console.error(' Error applying role-based permission filtering:', err);
            }
        }

        // Initialize Profile Manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.profileManager = new ProfileManager();
            
            // Initialize feature authorization (exactly as in dashboard.html)
            // Wait for auth manager to be ready
            setTimeout(async () => {
                try {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) sidebar.classList.add('menu-loading');
                    await updateMenuWithFeatureAuthorization();
                    if (sidebar) sidebar.classList.remove('menu-loading');
                } catch (error) {
                    console.error(' Error initializing feature-based menu:', error);
                    showBasicMenu();
                }
            }, 1500);
            
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
            
            // Notification dropdown functionality
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (notificationDropdown && !notificationBtn.contains(e.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });
        });
    </script>
    <!-- Timesheet Modal -->
    <div id="timesheetModal" class="timesheet-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; align-items:center; justify-content:center; z-index:2000;">
        <div class="timesheet-modal-content" style="background:white; width:920px; max-width:95%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15);">
            <div class="timesheet-modal-header" style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:1.1rem;">Create Timesheet</h3>
                <button id="closeTimesheetModal" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div class="timesheet-modal-body">
                <form id="timesheetForm">
                    <div class="form-group">
                        <label for="tsMonth">Month</label>
                        <input type="month" id="tsMonth" name="tsMonth" required>
                    </div>

                    <input type="hidden" id="tsId" name="tsId" value="">

                    <div class="form-group">
                        <label>Next Approver</label>
                        <div id="tsNextApproverDisplay" style="padding:8px; background:#f9fafb; border:1px solid #eee; border-radius:6px; color:#333; min-height:36px; display:flex; align-items:center;">Loading approver...</div>
                    </div>

                    <div class="form-group">
                        <label>Approval Flow</label>
                        <div id="tsApprovalFlowDisplay" class="approval-flow-display" style="display:block; margin-top:8px;">
                            <div id="tsApprovalFlowContent" class="approval-flow-list">Loading flow...</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Days</label>
                        <div id="tsDaysContainer" style="border:1px solid #eee; border-radius:8px; padding:8px;"></div>
                    </div>

                    <div class="form-group">
                        <label for="tsTotalHours">Total Hours</label>
                        <input type="number" id="tsTotalHours" name="tsTotalHours" step="0.1" readonly>
                    </div>

                    <div class="form-group">
                        <label for="tsNotes">Notes</label>
                        <textarea id="tsNotes" name="tsNotes" rows="3"></textarea>
                    </div>
                    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                        <button type="button" id="saveTimesheetBtn" class="btn-primary">Save</button>
                        <button type="button" id="submitTimesheetBtn" class="btn-primary">Save & Submit</button>
                    </div>
                </form>
            </div>
            <div class="timesheet-modal-footer">
                <div class="footer-note">Tip: Use the month picker to generate days, then enter start/end times. The grid scrolls if necessary.</div>
                <div class="footer-actions">
                    <button type="button" class="btn-primary" id="footerSaveBtn" title="Save">
                        <i class="fas fa-save"></i>
                    </button>
                    <button type="button" class="btn-primary" id="footerSubmitBtn" title="Save & Submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button type="button" class="btn-secondary" id="closeTimesheetFooterBtn" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Open and prefill an existing timesheet for editing
        ProfileManager.prototype.openEditTimesheetModal = async function(timesheetId) {
            if (!timesheetId) return;
            try {
                this.showLoading(true);
                const snapshot = await db.ref(`timesheets/${timesheetId}`).once('value');
                const ts = snapshot.exists() ? snapshot.val() : null;
                if (!ts) return this.showNotification('Timesheet not found', 'error');

                // Prefill form
                const form = document.getElementById('timesheetForm');
                if (form) form.reset();

                document.getElementById('tsId').value = ts.id || '';
                document.getElementById('tsMonth').value = ts.month || '';
                document.getElementById('tsNotes').value = ts.notes || '';
                document.getElementById('tsTotalHours').value = ts.totalHours != null ? ts.totalHours : '';

                // Generate days and fill per-day inputs
                this.generateMonthDays(ts.month);

                // After generating, populate rows
                setTimeout(() => {
                    const daysContainer = document.getElementById('tsDaysContainer');
                    if (!daysContainer || !ts.days) return;
                    // Map days by date for quick lookup
                    const dayMap = {};
                    ts.days.forEach(d => { dayMap[d.date] = d; });

                    const rows = Array.from(daysContainer.children);
                    rows.forEach(row => {
                        const date = row.querySelector('input[type="time"]')?.dataset.date;
                        if (!date) return;
                        const data = dayMap[date];
                        if (!data) return;
                        const timeInputs = row.querySelectorAll('input[type="time"]');
                        if (timeInputs && timeInputs.length >= 2) {
                            timeInputs[0].value = data.start || '';
                            timeInputs[1].value = data.end || '';
                        }
                        const brInput = row.querySelector('input[type="number"]');
                        if (brInput) brInput.value = data.break || '';
                        const commentInput = row.querySelector('input[type="text"]');
                        if (commentInput) commentInput.value = data.comment || '';
                        const hoursDisplay = row.querySelector('div[data-date]');
                        if (hoursDisplay) hoursDisplay.textContent = data.hours != null ? data.hours : '';
                    });

                    // Recompute total just in case
                    const totalField = document.getElementById('tsTotalHours');
                    if (totalField) totalField.value = this.computeTotalHoursFromDays();

                    // Show modal
                    const modal = document.getElementById('timesheetModal');
                    if (modal) modal.style.display = 'flex';
                    // Update next approver display for this timesheet based on flow and history
                    this.updateTimesheetApproverDisplay(ts);
                    // Update approval button visibility
                    this.updateApprovalButtonVisibility(ts);
                    setTimeout(() => this.adjustTimesheetModalSize(), 60);
                }, 80);

            } catch (error) {
                console.error('Error opening timesheet for edit', error);
                this.showNotification('Failed to load timesheet', 'error');
            } finally {
                this.showLoading(false);
            }
        };
    </script>
    <script>
        // Show next approver and full flow (grouped by levels) in the timesheet modal
        ProfileManager.prototype.updateTimesheetApproverDisplay = async function(ts) {
            try {
                const el = document.getElementById('tsNextApproverDisplay');
                if (!el) return;
                el.textContent = 'Loading approver...';

                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const levels = detailed.levels || [];
                const flat = detailed.flat || [];
                if (!flat.length) {
                    el.textContent = 'No approval flow configured';
                    await this.renderTimesheetApprovalFlowGrouped(levels, flat, 0);
                    return;
                }

                const hist = (ts && Array.isArray(ts.approvalHistory)) ? ts.approvalHistory : [];
                const approvalsByStep = new Map();
                hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                let currentFlatIdx = 0;
                for (let i = 0; i < flat.length; i++) {
                    const e = approvalsByStep.get(i);
                    if (!e || (e.status||'').toLowerCase() !== 'approved') { currentFlatIdx = i; break; }
                    if (i === flat.length - 1) currentFlatIdx = flat.length;
                }

                if (currentFlatIdx >= flat.length) {
                    el.textContent = 'All approvals complete';
                } else {
                    const step = flat[currentFlatIdx];
                    let who = '';
                    if (step.userId) {
                        try { who = await this.getUserDisplayNameById(step.userId); } catch { who = step.userId; }
                    } else if (step.email) {
                        try { who = await this.getUserDisplayNameByEmail(step.email); } catch { who = step.email; }
                    } else if (step.label) {
                        who = step.label;
                    } else if (step.role) {
                        who = step.role;
                    } else {
                        who = 'Unassigned approver';
                    }
                    const meta = step.role || step.label ? ` (${step.role || step.label})` : '';
                    el.textContent = `Next: ${who}${meta}`;
                }

                await this.renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx);
            } catch (err) {
                const el = document.getElementById('tsNextApproverDisplay');
                if (el) el.textContent = '';
                console.warn('Failed to update next approver display', err);
            }
        };
    </script>
    <!-- View Submitted Timesheet Modal -->
    <div id="viewTimesheetModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; align-items:center; justify-content:center; z-index:2100;">
        <div style="background:white; width:920px; max-width:95%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15);">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="viewTsTitle" style="margin:0; font-size:1.1rem;">Timesheet Details</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="exportViewTimesheetPdfBtn" class="btn-secondary" title="Export to PDF" style="background:none; border:none; font-size:1rem; cursor:pointer;">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button id="closeViewTimesheetModal" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
                </div>
            </div>
            <div style="padding:16px; max-height:70vh; overflow:auto;">
                <div id="viewTsMeta" style="margin-bottom:12px; color:#444;"></div>
                <div id="viewTsDays" style="border:1px solid #eee; border-radius:8px; padding:8px; margin-bottom:12px;"></div>
                <div id="viewTsNotes" style="margin-bottom:12px; color:#333;"></div>
                <div id="viewApprovalSection" style="border-top:1px solid #f1f1f1; padding-top:12px;">
                    <h4 style="margin:0 0 8px 0;">Approval</h4>
                    <div class="form-group" style="margin-bottom:8px;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Approval Flow</label>
                        <div id="viewTsApprovalFlowDisplay" class="approval-flow-display" style="display:block;">
                            <div id="viewTsApprovalFlowContent" class="approval-flow-list">Loading flow...</div>
                        </div>
                    </div>
                    <div id="approvalHistory" style="margin-bottom:8px; color:#555;"></div>
                        <div id="approvalActions" style="display:flex; gap:8px; align-items:center;">
                            <div id="viewApproverInfo" style="margin-right:12px; align-self:center; color:#666;"></div>
                        <button type="button" class="btn-approve" id="viewApproveTimesheetBtn" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button type="button" class="btn-decline" id="viewDeclineTimesheetBtn" title="Decline">
                            <i class="fas fa-times"></i>
                        </button>
                        <button type="button" class="btn-delete" id="viewDeleteTimesheetBtn" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- PDF libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        ProfileManager.prototype.openViewTimesheetModal = async function(timesheetId) {
            if (!timesheetId) return;
            
            // Store the current timesheet ID for approval actions
            this.currentViewTimesheetId = timesheetId;
            
            try {
                this.showLoading(true);
                const snap = await db.ref(`timesheets/${timesheetId}`).once('value');
                const ts = snap.exists() ? snap.val() : null;
                if (!ts) return this.showNotification('Timesheet not found', 'error');

                document.getElementById('viewTsTitle').textContent = `Timesheet: ${ts.month || ''}  ${ts.status || ''}`;
                document.getElementById('viewTsMeta').innerHTML = `<strong>Submitted by:</strong> ${ts.submittedByEmail || ts.submittedBy} <br><strong>Submitted At:</strong> ${ts.submittedAt ? new Date(ts.submittedAt).toLocaleString() : ''}`;

                // Render days table
                const daysContainer = document.getElementById('viewTsDays');
                daysContainer.innerHTML = '';
                let daysArr = [];
                if (Array.isArray(ts.days)) {
                    daysArr = ts.days.slice();
                } else if (ts.days && typeof ts.days === 'object') {
                    daysArr = Object.values(ts.days);
                }
                if (daysArr.length) {
                    // sort by date if present
                    daysArr.sort((a,b) => {
                        const ad = a && a.date ? new Date(a.date).getTime() : 0;
                        const bd = b && b.date ? new Date(b.date).getTime() : 0;
                        return ad - bd;
                    });
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    const thead = document.createElement('thead');
                    thead.innerHTML = `<tr style='text-align:left; border-bottom:1px solid #eee;'><th>Date</th><th>Start</th><th>End</th><th>Break</th><th>Hours</th><th>Comment</th></tr>`;
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    daysArr.forEach(d => {
                        const dateStr = d && d.date ? new Date(d.date).toLocaleDateString() : '';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style='padding:6px;'>${dateStr}</td><td style='padding:6px;'>${(d && d.start) || ''}</td><td style='padding:6px;'>${(d && d.end) || ''}</td><td style='padding:6px;'>${(d && d.break) || ''}</td><td style='padding:6px;'>${(d && d.hours)!=null?d.hours:''}</td><td style='padding:6px;'>${(d && d.comment) || ''}</td>`;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    daysContainer.appendChild(table);
                } else {
                    daysContainer.innerHTML = '<div style="padding:8px; color:#666;">No day entries</div>';
                }

                document.getElementById('viewTsNotes').textContent = ts.notes || '';

                // Load detailed company approval flow (levels preserved)
                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const levels = detailed.levels || [];
                const flat = detailed.flat || [];
                const hist = Array.isArray(ts.approvalHistory) ? ts.approvalHistory : [];
                const approvalsByStepView = new Map();
                hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStepView.set(h.stepIndex, h); });
                const approvedCountView = Array.from(approvalsByStepView.values()).filter(h => (h.status||'').toLowerCase()==='approved').length;
                const currentFlatIdx = Math.min(approvedCountView, flat.length);
                await this.renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx, 'viewTsApprovalFlowContent');

                // Approval history
                
                const histEl = document.getElementById('approvalHistory');
                histEl.innerHTML = '';

                // Render approval history entries only (avoid duplicating flow display)
                if (hist.length) {
                    histEl.innerHTML = '';
                    let visibleCount = 0;
                    for (let i = 0; i < hist.length; i++) {
                        const h = hist[i];
                        const statusLower = (h.status || '').toLowerCase();
                        // Only show approved/rejected events; hide pending entries
                        if (!(statusLower === 'approved' || statusLower === 'rejected')) {
                            continue;
                        }

                        const entryDiv = document.createElement('div');
                        entryDiv.style.padding = '6px 0';
                        entryDiv.style.borderBottom = '1px dashed #eee';
                        const whoRaw = h.submittedByEmail || h.submittedBy || '';
                        entryDiv.textContent = `${h.status} by ${whoRaw} on ${h.submittedAt ? new Date(h.submittedAt).toLocaleString() : ''}`;
                        if (h.comment) {
                            const c = document.createElement('div');
                            c.style.color = '#666';
                            c.textContent = h.comment;
                            entryDiv.appendChild(c);
                        }
                        histEl.appendChild(entryDiv);
                        visibleCount++;

                        // If submittedBy looks like a UID, try to resolve name
                        if (!h.submittedByEmail && h.submittedBy && typeof h.submittedBy === 'string') {
                            this.getUserDisplayNameById(h.submittedBy).then(name => {
                                entryDiv.textContent = `${h.status} by ${name} on ${h.submittedAt ? new Date(h.submittedAt).toLocaleString() : ''}`;
                                if (h.comment) {
                                    const c = document.createElement('div');
                                    c.style.color = '#666';
                                    c.textContent = h.comment;
                                    entryDiv.appendChild(c);
                                }
                            }).catch(()=>{});
                        }
                    }

                    if (visibleCount === 0) {
                        histEl.innerHTML = '<div style="color:#666;">No approval history</div>';
                    }
                } else {
                    histEl.innerHTML = '<div style="color:#666;">No approval history</div>';
                }

                // Actions (determine next approver from flow if available)
                const actionsEl = document.getElementById('approvalActions');
                const approverInfoEl = document.getElementById('viewApproverInfo');
                if (approverInfoEl) approverInfoEl.textContent = '';

                // Determine next pending step index
                let nextStepIndex = null;
                if (flat && Array.isArray(flat) && flat.length > 0) {
                    for (let i = 0; i < flat.length; i++) {
                        const e = approvalsByStepView.get(i);
                        if (!e || (e.status||'').toLowerCase() !== 'approved') { nextStepIndex = i; break; }
                    }
                    if (nextStepIndex === null) nextStepIndex = flat.length; // all approved
                }

                // Determine whether current user can approve this next step
                let canApprove = false;
                let approverLabel = null;
                if (flat && Array.isArray(flat) && nextStepIndex !== null && nextStepIndex < flat.length) {
                    const step = flat[nextStepIndex];
                    // step may be object like { role: 'manager' } or { userId: 'uid' } or { approver: 'manager' }
                    const stepRole = step.role || step.approver || null;
                    const stepUser = step.userId || step.user || step.uid || null;
                    const stepEmail = step.email || null;
                    const stepLabel = step.label || null;
                    approverLabel = stepLabel || stepRole || stepUser || stepEmail || JSON.stringify(step);

                    if (stepUser && this.currentUser && this.currentUser.uid === stepUser) canApprove = true;
                    if (stepRole && this.currentUser && this.currentUser.role && this.currentUser.role.toLowerCase().includes(String(stepRole).toLowerCase())) canApprove = true;
                } else {
                    // fallback simple permission: managers/supervisors/admins can approve if there is at least one pending
                    const role = (this.currentUser && this.currentUser.role) ? this.currentUser.role.toLowerCase() : '';
                    if ((role.includes('manager') || role.includes('supervisor') || role.includes('admin')) && ts.status === 'submitted') canApprove = true;
                }

                // Update approver info text; do not remove the static buttons
                if (approverInfoEl) {
                    approverInfoEl.textContent = approverLabel ? `Approver: ${approverLabel}` : '';
                    if (approverLabel && typeof approverLabel === 'string' && approverLabel.length > 8 && !approverLabel.includes(' ')) {
                        if (approverLabel.includes('@')) {
                            this.getUserDisplayNameByEmail(approverLabel).then(name => {
                                approverInfoEl.textContent = `Approver: ${name}`;
                            }).catch(()=>{});
                        } else {
                            this.getUserDisplayNameById(approverLabel).then(name => {
                                approverInfoEl.textContent = `Approver: ${name}`;
                            }).catch(()=>{});
                        }
                    }
                }

                // Store next step index for later approval actions from static buttons
                this.currentViewTimesheetNextStepIndex = (typeof nextStepIndex === 'number') ? nextStepIndex : null;

                // Keep full timesheet data for export
                this.currentViewTimesheetData = {
                    ...ts,
                    id: timesheetId,
                    month: ts.month || '',
                    status: ts.status || '',
                    submittedBy: ts.submittedByEmail || ts.submittedBy || ''
                };

                // Show/hide approval buttons based on permissions and timesheet status
                this.updateApprovalButtonVisibility(ts);

                // Show modal
                const modal = document.getElementById('viewTimesheetModal');
                if (modal) modal.style.display = 'flex';

            } catch (error) {
                console.error('Error opening view modal', error);
                this.showNotification('Failed to load timesheet', 'error');
            } finally {
                this.showLoading(false);
            }
        };

        // Export the current view timesheet modal content to PDF (professional travel.html style)
        ProfileManager.prototype.exportViewTimesheetToPdf = async function() {
            try {
                const timesheet = this.currentViewTimesheetData;
                if (!timesheet) {
                    this.showNotification('Nothing to export', 'warning');
                    return;
                }

                // Gather company branding
                const companyNameEl = document.getElementById('headerCompanyName');
                const companyLogoEl = document.getElementById('headerCompanyLogo');
                const companyName = (companyNameEl && companyNameEl.textContent || '').trim() || 'Company Name';
                const companyLogoSrc = (companyLogoEl && companyLogoEl.src && companyLogoEl.src.length > 0) ? companyLogoEl.src : null;

                // Create PDF with professional styling
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                
                // Professional color scheme (matching travel.html)
                const primaryColor = [45, 55, 72]; // Dark gray
                const secondaryColor = [113, 128, 150]; // Medium gray
                const lightGray = [247, 250, 252]; // Very light gray

                // Gather employee metadata (submitter) with safe fallbacks
                const submitterUid = (timesheet.submittedBy && typeof timesheet.submittedBy === 'string' && !String(timesheet.submittedBy).includes('@'))
                    ? timesheet.submittedBy
                    : null;
                const submitterEmail = timesheet.submittedByEmail
                    || (timesheet.submittedBy && String(timesheet.submittedBy).includes('@') ? timesheet.submittedBy : '')
                    || '';
                let employeeMeta = {
                    name: timesheet.employeeName || '',
                    email: submitterEmail || '',
                    role: timesheet.employeeRole || '',
                    department: timesheet.department || '',
                    employeeId: timesheet.employeeId || timesheet.employeeID || ''
                };
                try {
                    if (typeof db !== 'undefined' && db && db.ref) {
                        let userSnap = null;
                        if (submitterUid) {
                            userSnap = await db.ref(`users/${submitterUid}`).once('value');
                        } else if (submitterEmail) {
                            const q = await db.ref('users').orderByChild('email').equalTo(submitterEmail).once('value');
                            const val = q && q.val ? q.val() : null;
                            if (val && typeof val === 'object') {
                                const firstKey = Object.keys(val)[0];
                                if (firstKey) {
                                    userSnap = { exists: () => true, val: () => val[firstKey] };
                                }
                            }
                        }
                        if (userSnap && userSnap.exists && userSnap.exists()) {
                            const u = userSnap.val();
                            employeeMeta.name = employeeMeta.name || u.name || u.displayName || u.fullName || '';
                            employeeMeta.email = employeeMeta.email || u.email || '';
                            employeeMeta.role = employeeMeta.role || u.role || '';
                            employeeMeta.department = employeeMeta.department || u.department || u.dept || '';
                            employeeMeta.employeeId = employeeMeta.employeeId || u.employeeId || u.employeeID || u.staffId || '';
                        }
                    }
                } catch (empErr) {
                    console.warn('Could not enrich employee metadata for PDF:', empErr);
                }

                let yPosition = 25;
                const leftColumn = 20;
                const pageWidth = pdf.internal.pageSize.getWidth();

                // Company logo if available (no initials fallback by request)
                if (companyLogoSrc) {
                    try {
                        const logoImg = await new Promise((resolve, reject) => {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = () => resolve(img);
                            img.onerror = () => reject(new Error('Logo load failed'));
                            img.src = companyLogoSrc;
                        });
                        const maxLogoH = 20; // pt
                        const maxLogoW = 60; // pt
                        const ratio = Math.min(maxLogoW / logoImg.width, maxLogoH / logoImg.height);
                        const drawW = Math.max(1, logoImg.width * ratio);
                        const drawH = Math.max(1, logoImg.height * ratio);
                        pdf.addImage(logoImg, 'PNG', leftColumn, 15, drawW, drawH, undefined, 'FAST');
                    } catch (e) {
                        // Intentionally do nothing; no initials fallback
                    }
                }

                // Company name and title
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(companyName, leftColumn, 45);
                
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'normal');
                pdf.text('TIMESHEET DOCUMENT', leftColumn, 60);
                
                yPosition = 85;

                // Timesheet Information Section
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('TIMESHEET INFORMATION', leftColumn, yPosition);
                yPosition += 15;

                // Timesheet details
                pdf.setFontSize(10);

                pdf.setFont('helvetica', 'bold');
                pdf.text('Employee:', leftColumn, yPosition);
                pdf.setFont('helvetica', 'normal');
                pdf.text((employeeMeta.name || employeeMeta.email || timesheet.submittedBy || ''), leftColumn + 70, yPosition);
                yPosition += 12;

                if (employeeMeta.email) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Email:', leftColumn, yPosition);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(employeeMeta.email, leftColumn + 70, yPosition);
                    yPosition += 12;
                }

                // Role field removed by request

                if (employeeMeta.department) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Department:', leftColumn, yPosition);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(String(employeeMeta.department), leftColumn + 70, yPosition);
                    yPosition += 12;
                }

                if (employeeMeta.employeeId) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Employee ID:', leftColumn, yPosition);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(String(employeeMeta.employeeId), leftColumn + 70, yPosition);
                    yPosition += 12;
                }

                pdf.setFont('helvetica', 'bold');
                pdf.text('Month/Period:', leftColumn, yPosition);
                pdf.setFont('helvetica', 'normal');
                pdf.text(timesheet.month || '', leftColumn + 70, yPosition);
                yPosition += 12;

                pdf.setFont('helvetica', 'bold');
                pdf.text('Status:', leftColumn, yPosition);
                pdf.setFont('helvetica', 'normal');
                pdf.text((timesheet.status || 'draft').toUpperCase(), leftColumn + 70, yPosition);
                yPosition += 12;

                // Submitted date removed by request

                yPosition += 8;

                // Time Entries Section
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('TIME ENTRIES', leftColumn, yPosition);
                yPosition += 15;

                // Table headers
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'bold');
                const colWidths = [60, 60, 60, 60, 80, 120];
                const headers = ['Date', 'Start', 'End', 'Break', 'Hours', 'Notes'];
                let xPos = leftColumn;
                
                // Header background (light gray)
                pdf.setFillColor(...lightGray);
                pdf.rect(leftColumn - 2, yPosition - 8, pageWidth - 40, 12, 'F');
                
                // Header text
                pdf.setTextColor(...primaryColor);
                headers.forEach((header, i) => {
                    pdf.text(header, xPos, yPosition);
                    xPos += colWidths[i];
                });
                yPosition += 15;

                // Helpers for time parsing and formatting
                const parseTimeToMinutes = (s) => {
                    if (!s || s === '') return null;
                    const str = String(s).trim();
                    // Handle HH:MM[:SS] with optional AM/PM
                    let m = str.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i);
                    if (m) {
                        let hh = parseInt(m[1], 10);
                        const mm = parseInt(m[2], 10) || 0;
                        const ap = m[4] ? m[4].toUpperCase() : null;
                        if (ap) {
                            if (ap === 'PM' && hh < 12) hh += 12;
                            if (ap === 'AM' && hh === 12) hh = 0;
                        }
                        return hh * 60 + mm;
                    }
                    // Handle plain numbers as hours (e.g., 8.5)
                    if (!isNaN(Number(str))) {
                        return Math.round(Number(str) * 60);
                    }
                    return null;
                };
                const parseBreakToMinutes = (s) => {
                    if (s == null) return 0;
                    const str = String(s).trim();
                    if (str.includes(':')) {
                        const parts = str.split(':');
                        const hh = parseInt(parts[0], 10) || 0;
                        const mm = parseInt(parts[1], 10) || 0;
                        return hh * 60 + mm;
                    }
                    if (!isNaN(Number(str))) return Math.max(0, Math.round(Number(str)));
                    return 0;
                };
                const parseHoursToMinutes = (s) => {
                    if (!s) return 0;
                    const str = String(s).trim();
                    if (str.includes(':')) {
                        const parts = str.split(':');
                        const hh = parseInt(parts[0], 10) || 0;
                        const mm = parseInt(parts[1], 10) || 0;
                        return hh * 60 + mm;
                    }
                    if (!isNaN(Number(str))) return Math.round(Number(str) * 60);
                    return 0;
                };
                const minutesToHoursFixed = (mins) => (mins > 0 ? (mins / 60).toFixed(2) : '0');

                // Table rows - Show full month (all days 1-31)
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                console.log('Timesheet data for PDF:', timesheet); // Debug log
                
                // Derive YYYY-MM for the month; fall back to first entry
                const monthYear = (() => {
                    const m = (timesheet.month || '').trim();
                    if (/^\d{4}-\d{2}$/.test(m)) return m;
                    if (timesheet.days) {
                        try {
                            if (Array.isArray(timesheet.days)) {
                                const d0 = timesheet.days.find(x => x && x.date && !isNaN(new Date(x.date).getTime()));
                                if (d0) return new Date(d0.date).toISOString().slice(0, 7);
                            } else if (typeof timesheet.days === 'object') {
                                const keys = Object.keys(timesheet.days);
                                const k = keys.find(k => /^\d{4}-\d{2}-\d{2}$/.test(k)) || keys[0];
                                if (k && !isNaN(new Date(k).getTime())) return new Date(k).toISOString().slice(0, 7);
                            }
                        } catch (_) {}
                    }
                    return new Date().toISOString().slice(0, 7);
                })();
                let entriesCount = 0;
                let monthlyTotalMinutes = 0;
                
                for (let day = 1; day <= 31; day++) {
                    const dayStr = day.toString().padStart(2, '0');
                    const dateKey = `${monthYear}-${dayStr}`;
                    
                    // Try multiple data structure patterns
                    let entry = null;
                    let startTime = '', endTime = '', breakTime = '0', totalHours = '0', notes = '';
                    
                    // Pattern A: timesheet.days as object keyed by YYYY-MM-DD
                    if (timesheet.days && !Array.isArray(timesheet.days) && timesheet.days[dateKey]) {
                        entry = timesheet.days[dateKey] || null;
                    }
                    // Pattern B: timesheet.days as array with entry.date
                    if (!entry && timesheet.days && Array.isArray(timesheet.days)) {
                        const match = timesheet.days.find(d => d && d.date && !isNaN(new Date(d.date).getTime()) && new Date(d.date).toISOString().slice(0,10) === dateKey);
                        if (match) entry = match;
                    }
                    // Normalize field names from entry
                    if (entry) {
                        startTime = entry.start || entry.startTime || entry.clockIn || '';
                        endTime = entry.end || entry.endTime || entry.clockOut || '';
                        breakTime = (entry.break != null ? entry.break : (entry.breakTime != null ? entry.breakTime : (entry.breakMinutes != null ? entry.breakMinutes : '0'))).toString();
                        totalHours = (entry.hours != null ? entry.hours : (entry.totalHours != null ? entry.totalHours : '0')).toString();
                        notes = entry.comment || entry.notes || '';
                    } else {
                        // Pattern C: individual day fields (day01Start, day01End, etc.)
                        const startKey = `day${dayStr}Start`;
                        const endKey = `day${dayStr}End`;
                        const breakKey = `day${dayStr}Break`;
                        const hoursKey = `day${dayStr}Hours`;
                        const notesKey = `day${dayStr}Notes`;
                        if (timesheet[startKey] || timesheet[endKey]) {
                            startTime = timesheet[startKey] || '';
                            endTime = timesheet[endKey] || '';
                            breakTime = (timesheet[breakKey] != null ? timesheet[breakKey] : '0').toString();
                            totalHours = (timesheet[hoursKey] != null ? timesheet[hoursKey] : '0').toString();
                            notes = timesheet[notesKey] || '';
                        }
                    }
                    
                    // Count non-empty entries
                    if (startTime !== '' || endTime !== '') {
                        entriesCount++;
                    }
                    
                    // Create date for display
                    const currentDate = new Date(monthYear + '-' + dayStr);
                    const isValidDate = !isNaN(currentDate.getTime()) && currentDate.getDate() == day;
                    
                    // Only show valid dates for the month
                    if (isValidDate) {
                        xPos = leftColumn;
                        // Compute per-day hours if not provided
                        let minutesForDay = 0;
                        const startMins = parseTimeToMinutes(startTime);
                        const endMins = parseTimeToMinutes(endTime);
                        const breakMins = parseBreakToMinutes(breakTime);
                        if (startMins != null && endMins != null) {
                            minutesForDay = Math.max(0, endMins - startMins - (breakMins || 0));
                        } else if (totalHours && totalHours !== '0') {
                            minutesForDay = parseHoursToMinutes(totalHours);
                        }
                        monthlyTotalMinutes += minutesForDay;
                        const hoursDisplay = (totalHours && totalHours !== '0') ? totalHours : minutesToHoursFixed(minutesForDay);
                        
                        // Row data
                        const rowData = [
                            currentDate.toLocaleDateString(),
                            startTime,
                            endTime,
                            breakTime,
                            hoursDisplay,
                            notes.length > 15 ? notes.substring(0, 15) + '...' : notes
                        ];
                        
                        // Alternate row background for better readability
                        if (day % 2 === 0) {
                            pdf.setFillColor(250, 250, 250);
                            pdf.rect(leftColumn - 2, yPosition - 8, pageWidth - 40, 10, 'F');
                        }
                        
                        // Set text color based on whether there's data
                        if (startTime !== '' || endTime !== '') {
                            pdf.setTextColor(0, 0, 0); // Black for entries with data
                        } else {
                            pdf.setTextColor(...secondaryColor); // Gray for empty entries
                        }
                        
                        rowData.forEach((data, i) => {
                            pdf.text(data.toString(), xPos, yPosition);
                            xPos += colWidths[i];
                        });
                        yPosition += 10;
                        
                        // Check if we need a page break (basic pagination)
                        if (yPosition > pdf.internal.pageSize.getHeight() - 100) {
                            pdf.addPage();
                            yPosition = 50;
                            
                            // Repeat headers on new page
                            pdf.setFillColor(...lightGray);
                            pdf.rect(leftColumn - 2, yPosition - 8, pageWidth - 40, 12, 'F');
                            
                            pdf.setTextColor(...primaryColor);
                            pdf.setFont('helvetica', 'bold');
                            xPos = leftColumn;
                            headers.forEach((header, i) => {
                                pdf.text(header, xPos, yPosition);
                                xPos += colWidths[i];
                            });
                            yPosition += 15;
                            pdf.setFont('helvetica', 'normal');
                        }
                    }
                }
                
                // Add summary line
                yPosition += 5;
                pdf.setTextColor(...primaryColor);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`Summary: ${entriesCount} days with time entries recorded`, leftColumn, yPosition);
                yPosition += 10;

                yPosition += 10;

                // Totals section
                if (timesheet.totalHours) {
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('TOTAL HOURS:', leftColumn, yPosition);
                    pdf.text(timesheet.totalHours.toString(), leftColumn + 80, yPosition);
                    yPosition += 15;
                } else {
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('TOTAL HOURS:', leftColumn, yPosition);
                    pdf.text(minutesToHoursFixed(monthlyTotalMinutes), leftColumn + 80, yPosition);
                    yPosition += 15;
                }

                // Notes section (if any)
                if (timesheet.notes) {
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('NOTES', leftColumn, yPosition);
                    yPosition += 15;
                    
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    const splitNotes = pdf.splitTextToSize(timesheet.notes, pageWidth - 60);
                    pdf.text(splitNotes, leftColumn, yPosition);
                    yPosition += splitNotes.length * 12;
                }

                // Approval status section removed by request

                // Footer
                const footerY = pdf.internal.pageSize.getHeight() - 30;
                pdf.setDrawColor(225);
                pdf.setLineWidth(0.5);
                pdf.line(leftColumn, footerY - 10, pageWidth - 20, footerY - 10);
                
                pdf.setTextColor(...secondaryColor);
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, leftColumn, footerY);
                pdf.text(`Page 1 of 1`, pageWidth - 60, footerY);

                // Save with professional filename
                const safe = (s) => (s || '').toString().replace(/[^a-z0-9-_]+/gi, '_');
                const filename = `Timesheet_${safe(timesheet.month)}_${safe(timesheet.submittedBy)}_${safe(timesheet.id || Date.now())}.pdf`;
                pdf.save(filename);

                this.showNotification('Professional timesheet PDF exported successfully', 'success');
            } catch (err) {
                console.error('Export PDF failed', err);
                this.showNotification('Export failed. Please try again.', 'error');
            }
        };

        ProfileManager.prototype.checkUserCanApprove = function(timesheet, nextStepIndex = null) {
            // Check if user can approve this specific timesheet step
            console.log(' Checking user approval permissions for timesheet...');
            
            try {
                if (!this.currentUser) {
                    console.log(' No current user found');
                    return false;
                }

                // Prevent self-approval
                if (timesheet && (timesheet.submittedBy === this.currentUser.email || timesheet.submittedBy === this.currentUser.uid)) {
                    console.log(' Cannot approve own timesheet');
                    return false;
                }

                // If no specific step provided, use general role-based check
                if (nextStepIndex === null || nextStepIndex === undefined) {
                    const userRole = this.currentUser.role ? this.currentUser.role.toLowerCase() : '';
                    const canApproveGeneral = userRole.includes('manager') || userRole.includes('supervisor') || userRole.includes('admin');
                    console.log(' General role check:', userRole, '', canApproveGeneral);
                    return canApproveGeneral;
                }

                // Check against approval flow for specific step
                return this.checkUserCanApproveStep(nextStepIndex);
                
            } catch (error) {
                console.warn(' Error checking approval permissions:', error);
                return false;
            }
        };

        ProfileManager.prototype.checkUserCanApproveStep = async function(stepIndex) {
            try {
                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const flat = detailed.flat || [];
                
                if (stepIndex >= flat.length || stepIndex < 0) {
                    console.log(' Step index out of range:', stepIndex);
                    return false;
                }

                const step = flat[stepIndex];
                if (!step) {
                    console.log(' No step found at index:', stepIndex);
                    return false;
                }

                const currentUserId = this.currentUser.uid;
                const currentUserEmail = this.currentUser.email;
                const currentUserRole = this.currentUser.role ? this.currentUser.role.toLowerCase() : '';

                // Check if user matches step requirements
                if (step.userId && step.userId === currentUserId) {
                    console.log(' User matches step userId:', step.userId);
                    return true;
                }

                if (step.email && step.email === currentUserEmail) {
                    console.log(' User matches step email:', step.email);
                    return true;
                }

                if (step.role) {
                    const stepRole = step.role.toLowerCase();
                    if (currentUserRole.includes(stepRole) || stepRole.includes(currentUserRole)) {
                        console.log(' User role matches step role:', currentUserRole, '', stepRole);
                        return true;
                    }
                }

                console.log(' User does not match step requirements:', {
                    stepUserId: step.userId,
                    stepEmail: step.email, 
                    stepRole: step.role,
                    currentUserId,
                    currentUserEmail,
                    currentUserRole
                });
                return false;

            } catch (error) {
                console.warn(' Error checking step approval permissions:', error);
                return false;
            }
        };

        ProfileManager.prototype.updateApprovalButtonVisibility = async function(timesheet) {
            console.log(' Updating approval button visibility...');
            console.log(' Timesheet data:', timesheet);
            
            const tsStatus = (timesheet && timesheet.status ? String(timesheet.status).toLowerCase() : '');
            const isSubmittedStatus = tsStatus === 'submitted' || tsStatus === 'pending';
            console.log(' Is submitted status:', isSubmittedStatus, '(status:', timesheet ? timesheet.status : 'none', ')');
            
            // Get approval buttons for both modals
            const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
            const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
            const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
            const approvalActions = document.getElementById('timesheetApprovalActions');
            
            console.log(' Found buttons:', {
                viewApproveBtn: !!viewApproveBtn,
                viewDeclineBtn: !!viewDeclineBtn,
                viewDeleteBtn: !!viewDeleteBtn,
                approvalActions: !!approvalActions
            });
            
            // If fully approved, force-hide all approval controls
            if (tsStatus === 'approved') {
                if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                if (viewDeleteBtn) viewDeleteBtn.style.display = 'none';
                if (approvalActions) approvalActions.style.display = 'none';
                console.log(' Timesheet approved: hiding all approval actions');
                return;
            }

            // Check if current user has already approved this timesheet
            if (timesheet && this.currentUser) {
                const currentUserId = this.currentUser.uid;
                const currentUserEmail = this.currentUser.email;
                let hist = [];
                if (Array.isArray(timesheet.approvalHistory)) hist = timesheet.approvalHistory;
                else if (timesheet.approvalHistory && typeof timesheet.approvalHistory === 'object') hist = Object.values(timesheet.approvalHistory);
                
                const userAlreadyApproved = hist.some(entry => {
                    if (!entry) return false;
                    const eStatus = (entry.status ? String(entry.status).toLowerCase() : '');
                    const acted = eStatus === 'approved' || eStatus === 'rejected';
                    const uidMatch = [entry.submittedBy, entry.userId, entry.uid, entry.approverId, entry.approverUid]
                        .some(v => v && String(v) === currentUserId);
                    const emailMatch = [entry.submittedByEmail, entry.email, entry.approverEmail, entry.approvedByEmail]
                        .some(v => v && String(v).toLowerCase() === currentUserEmail.toLowerCase());
                    return acted && (uidMatch || emailMatch);
                });
                
                if (userAlreadyApproved) {
                    if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                    if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                    if (viewDeleteBtn) viewDeleteBtn.style.display = 'none';
                    if (approvalActions) approvalActions.style.display = 'none';
                    console.log(' User already approved/rejected this timesheet: hiding all approval actions');
                    return;
                }
            }

            // Check if user can approve this timesheet at the current step
            let canApprove = false;
            if (isSubmittedStatus) {
                // For step-specific approval, use the stored next step index
                if (typeof this.currentViewTimesheetNextStepIndex === 'number') {
                    canApprove = await this.checkUserCanApproveStep(this.currentViewTimesheetNextStepIndex);
                } else {
                    // Fallback to general approval check
                    canApprove = this.checkUserCanApprove(timesheet);
                }
            }
            
            console.log(' Can approve:', canApprove);
            console.log(' Next step index:', this.currentViewTimesheetNextStepIndex);
            
            // Show/hide buttons based on approval permissions and timesheet status
            const showButtons = canApprove && isSubmittedStatus;
            console.log(' Show buttons decision:', showButtons);
            
            // Update view modal buttons
            if (viewApproveBtn) viewApproveBtn.style.display = showButtons ? 'inline-flex' : 'none';
            if (viewDeclineBtn) viewDeclineBtn.style.display = showButtons ? 'inline-flex' : 'none';
            if (viewDeleteBtn) viewDeleteBtn.style.display = showButtons ? 'inline-flex' : 'none';

            // Update edit modal (footer) actions 
            if (approvalActions) {
                approvalActions.style.display = showButtons ? 'flex' : 'none';
                console.log(' Set approvalActions display to:', showButtons ? 'flex' : 'none');
            }
        };

    ProfileManager.prototype.handleTimesheetApproval = async function(action) {
            // Get the current timesheet ID from either modal
            let timesheetId = null;
            
            // Check if edit modal is open
            const editModal = document.getElementById('timesheetModal');
            if (editModal && editModal.style.display !== 'none') {
                const tsIdField = document.getElementById('tsId');
                timesheetId = tsIdField ? tsIdField.value : null;
            }
            
            // Check if view modal is open
            const viewModal = document.getElementById('viewTimesheetModal');
            if (viewModal && viewModal.style.display !== 'none') {
                // Get ID from the currently viewed timesheet (stored in a data attribute or global var)
                timesheetId = this.currentViewTimesheetId;
            }
            
            if (!timesheetId) {
                this.showNotification('No timesheet selected', 'error');
                return;
            }
            
            let confirmed = false;
            let comment = '';
            
            switch (action) {
                case 'approve':
                    confirmed = confirm('Are you sure you want to approve this timesheet?');
                    if (confirmed) {
                        comment = prompt('Approval comment (optional):') || '';
                        const stepIdx = (typeof this.currentViewTimesheetNextStepIndex === 'number') ? this.currentViewTimesheetNextStepIndex : null;
                        await this.approveTimesheet(timesheetId, 'approved', comment, stepIdx);
                        
                        // Hide action buttons immediately after approval with debugging
                        console.log(' DEBUG: About to hide approval buttons after approval action');
                        const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
                        const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
                        const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
                        const approvalActions = document.getElementById('timesheetApprovalActions');
                        
                        console.log(' DEBUG: Button elements found:', {
                            viewApproveBtn: !!viewApproveBtn,
                            viewDeclineBtn: !!viewDeclineBtn,
                            viewDeleteBtn: !!viewDeleteBtn,
                            approvalActions: !!approvalActions
                        });
                        
                        if (viewApproveBtn) {
                            viewApproveBtn.style.display = 'none';
                            console.log(' DEBUG: Set viewApproveBtn display to none');
                        }
                        if (viewDeclineBtn) {
                            viewDeclineBtn.style.display = 'none';
                            console.log(' DEBUG: Set viewDeclineBtn display to none');
                        }
                        if (viewDeleteBtn) {
                            viewDeleteBtn.style.display = 'none';
                            console.log(' DEBUG: Set viewDeleteBtn display to none');
                        }
                        if (approvalActions) {
                            approvalActions.style.display = 'none';
                            console.log(' DEBUG: Set approvalActions display to none');
                        }
                        
                        // Update current timesheet data status to prevent re-showing
                        if (this.currentViewTimesheetData) {
                            this.currentViewTimesheetData.status = 'approved';
                            console.log(' DEBUG: Updated currentViewTimesheetData status to approved');
                        }
                    }
                    break;
                    
                case 'decline':
                    comment = prompt('Please provide a reason for declining this timesheet:');
                    if (comment !== null) { // User didn't cancel
                        const stepIdx = (typeof this.currentViewTimesheetNextStepIndex === 'number') ? this.currentViewTimesheetNextStepIndex : null;
                        await this.approveTimesheet(timesheetId, 'rejected', comment, stepIdx);
                        confirmed = true; // Set for modal close logic
                        
                        // Hide action buttons immediately after decline
                        const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
                        const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
                        const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
                        const approvalActions = document.getElementById('timesheetApprovalActions');
                        if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                        if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                        if (viewDeleteBtn) viewDeleteBtn.style.display = 'none';
                        if (approvalActions) approvalActions.style.display = 'none';
                    }
                    break;
                    
                case 'delete':
                    confirmed = confirm('Are you sure you want to delete this timesheet? This action cannot be undone.');
                    if (confirmed) {
                        await this.deleteTimesheet(timesheetId);
                    }
                    break;
            }
            
            // Refresh the modal or close it
            if (confirmed || action === 'decline') {
                // Close the modal after action
                this.closeTimesheetModal();
                const viewModal = document.getElementById('viewTimesheetModal');
                if (viewModal) viewModal.style.display = 'none';
                
                // Refresh the timesheet list
                await this.loadUserTimesheets();
            }
        };

        ProfileManager.prototype.deleteTimesheet = async function(timesheetId) {
            if (!timesheetId) return;
            
            try {
                this.showLoading(true);
                await db.ref(`timesheets/${timesheetId}`).remove();
                this.showNotification('Timesheet deleted successfully', 'success');
                await this.loadUserTimesheets();
            } catch (error) {
                console.error('Error deleting timesheet:', error);
                this.showNotification('Failed to delete timesheet', 'error');
            } finally {
                this.showLoading(false);
            }
        };

        ProfileManager.prototype.approveTimesheet = async function(timesheetId, status, comment, stepIndex = null) {
            if (!timesheetId) return;
            try {
                this.showLoading(true);
                const now = Date.now();
                const entry = {
                    id: `APP-TS-${timesheetId}-${now}`,
                    sourceId: timesheetId,
                    sourceType: 'timesheet',
                    submittedAt: now,
                    submittedBy: this.currentUser ? this.currentUser.uid : 'unknown',
                    submittedByEmail: this.currentUser ? this.currentUser.email : '',
                    status,
                    comment: comment || '',
                    stepIndex: (stepIndex !== null) ? stepIndex : null
                };

                // Append or set into approvalHistory array
                const histRef = db.ref(`timesheets/${timesheetId}/approvalHistory`);
                const existingSnap = await histRef.once('value');
                const existing = existingSnap.exists() ? existingSnap.val() : [];
                let newHist = Array.isArray(existing) ? existing.slice() : [];
                if (stepIndex !== null) {
                    newHist[stepIndex] = entry;
                } else {
                    newHist.push(entry);
                }
                await histRef.set(newHist);

                // Compute new timesheet status based on flow length and approval result
                let newStatus = status;
                if (status === 'rejected') {
                    newStatus = 'rejected';
                } else if (status === 'approved') {
                    // try to determine company approval flow length
                    let companyFlowLen = null;
                    try {
                        const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                        companyFlowLen = (detailed && detailed.flat) ? detailed.flat.length : null;
                    } catch (fErr) {
                        console.warn('could not read company flow length', fErr);
                    }

                    const appliedIndex = (entry.stepIndex !== null) ? entry.stepIndex : (newHist.length - 1);
                    if (companyFlowLen === null) {
                        newStatus = 'approved';
                    } else if (appliedIndex + 1 >= companyFlowLen) {
                        newStatus = 'approved';
                    } else {
                        newStatus = 'pending';
                    }
                }

                // Update timesheet status
                await db.ref(`timesheets/${timesheetId}/status`).set(newStatus);

                this.showNotification(`Timesheet ${newStatus}`, 'success');
                await this.loadUserTimesheets();
            } catch (error) {
                console.error('Error approving timesheet', error);
                this.showNotification('Failed to update approval', 'error');
            } finally {
                this.showLoading(false);
            }
        };

        // Close view modal wiring (explicit button handler)
        const closeViewBtn = document.getElementById('closeViewTimesheetModal');
        if (closeViewBtn) {
            closeViewBtn.addEventListener('click', () => {
                const modal = document.getElementById('viewTimesheetModal');
                if (modal) modal.style.display = 'none';
            });
        }
        const exportPdfBtn = document.getElementById('exportViewTimesheetPdfBtn');
        if (exportPdfBtn) {
            exportPdfBtn.addEventListener('click', () => {
                if (window.profileManager && typeof window.profileManager.exportViewTimesheetToPdf === 'function') {
                    window.profileManager.exportViewTimesheetToPdf();
                }
            });
        }
    </script>
</body>
</html>
