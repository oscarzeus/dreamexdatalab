<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-color: #2c3e50;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Menu Visibility Styles */
        .menu-item {
            display: block;
        }

        .menu-item.hidden {
            display: none !important;
        }

        /* Essential Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Submenu item visibility */
        .submenu li:not(.menu-visible) {
            display: none !important;
        }

        /* Hide menu items during loading until permissions are applied */
        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .submenu li {
            display: none !important;
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .clear-all-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .clear-all-btn:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e0e0e0;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            margin: 0;
            padding: 0.5rem 0;
        }

        .profile-dropdown ul li {
            margin: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li.profile-header .profile-info {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .profile-dropdown ul li.profile-header .profile-info strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .profile-dropdown ul li.profile-header .profile-info small {
            display: block;
            color: #666;
            font-size: 12px;
        }
        
        .user-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Content Styles */
        .content {
            padding: 1rem;
            background-color: var(--bg-secondary);
            min-height: calc(100vh - 6rem);
            border-radius: 10px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .content-header h1 {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .profile-header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .profile-header-content {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
        }

        .profile-info-section {
            flex: 1;
        }
        
        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-upload-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            margin-top: 10px;
        }
        
        .avatar-upload-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .profile-email {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .profile-role {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        /* Tab Styles */
        .profile-tabs {
            background: transparent;
            margin-bottom: 20px;
        }

        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-btn {
            padding: 1rem 2rem;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            flex: 1;
            justify-content: center;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .tab-nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Card Styles for tab content */
        .tab-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .tab-card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .tab-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-card-body {
            padding: 2rem;
        }

        .profile-content {
            /* Container for tabbed content */
            margin-top: 20px;
        }
        
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e1e8ed;
        }
        
        .profile-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #34495e;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea,
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Readonly field styling */
        .form-group input[readonly],
        .form-group select[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .form-group input[readonly]:focus,
        .form-group select[disabled]:focus {
            border-color: #e9ecef;
            box-shadow: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .tab-pane h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e1e8ed;
            padding-bottom: 10px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: background-color 0.3s ease;
        }

        .activity-item:hover {
            background: #e9ecef;
        }

        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #6c757d;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e1e8ed;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .password-requirements {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
        }
        
        .password-requirements ul {
            list-style-type: none;
            padding: 0;
        }
        
        .password-requirements li {
            padding: 2px 0;
        }
        
        .password-requirements li.valid {
            color: #28a745;
        }
        
        .password-requirements li.invalid {
            color: #dc3545;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        
        /* Responsive Design */
        @media (max-width: 1600px) {
            .main-content {
                width: calc(100vw - var(--sidebar-width));
                max-width: calc(100vw - var(--sidebar-width));
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
            }
            
            .top-nav {
                left: 0.5rem;
            }
            
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .profile-header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        .notification-success {
            background: #28a745;
        }
        
        .notification-error {
            background: #dc3545;
        }

        /* Tooltip Styles */
        .form-group {
            position: relative;
        }

        .error-tooltip {
            position: absolute;
            bottom: -35px;
            left: 0;
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .error-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .error-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 15px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #dc3545;
        }

        .form-group.has-error input {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        /* Password Toggle Styles */
        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .password-toggle:hover {
            color: #495057;
        }

        .password-toggle:focus {
            outline: none;
            color: var(--primary-color);
        }

        .password-input-container input {
            padding-right: 45px;
        }

        /* Activity Tab Styles */
        .activity-loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .activity-loading i {
            margin-right: 0.5rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background-color: #f8f9fa;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
        }

        .activity-icon.login {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .activity-icon.profile {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .activity-icon.request {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .activity-icon.security {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .activity-icon.system {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .activity-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .activity-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Activity Grouping Styles */
        .activity-date-group {
            margin-bottom: 1.5rem;
        }

        .activity-date-header {
            font-weight: 600;
            color: var(--primary-color);
            background: linear-gradient(135deg, rgba(103, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 4px solid var(--primary-color);
        }

        .activity-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-style: italic;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-specific {
            font-weight: 500;
            color: var(--primary-color);
        }

        .time-relative {
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsiveness for Tabs */
        @media (max-width: 768px) {
            .tab-nav-btn {
                flex: none;
                min-width: 100px;
                padding: 12px 15px;
                font-size: 13px;
            }

            .tab-navigation {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-content {
                padding: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .activity-item {
                padding: 12px;
            }

            .profile-container {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view">
                            <a href="trainingboard.html">Training</a>
                        </li>
                        <li data-feature="risk_view" data-requires-permission="risk_view">
                            <a href="riskboard.html">Risk Management</a>
                        </li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view">
                            <a href="jsaboard.html">Job Safety Analysis</a>
                        </li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view">
                            <a href="ptwboard.html">Permit to Work</a>
                        </li>
                        <li data-feature="incident_view" data-requires-permission="incident_view">
                            <a href="incidentboard.html">Incident Reports</a>
                        </li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view">
                            <a href="inspectionboard.html">Inspection</a>
                        </li>
                        <li data-feature="audit_view" data-requires-permission="audit_view">
                            <a href="auditboard.html">Audit</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view">
                            <a href="fleet.html">Fleet Management</a>
                        </li>
                        <li data-feature="camp_view" data-requires-permission="camp_view">
                            <a href="camp.html">Camp Management</a>
                        </li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view">
                            <a href="campset.html">Camp Settings</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view">
                            <a href="human-hr.html">Human HR</a>
                        </li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view">
                            <a href="staff.html">Staffing</a>
                        </li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view">
                            <a href="recruit.html">Authority to Recruit</a>
                        </li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view">
                            <a href="jobpost.html">Job Advertising</a>
                        </li>
                        <li data-feature="screening_view" data-requires-permission="screening_view">
                            <a href="jobscreen.html">Screening</a>
                        </li>
                        <li data-feature="interview_view" data-requires-permission="interview_view">
                            <a href="interview.html">Interview</a>
                        </li>
                        <li data-feature="offer_view" data-requires-permission="offer_view">
                            <a href="offer.html">Offer Management</a>
                        </li>
                        <li data-feature="contract_view" data-requires-permission="contract_view">
                            <a href="contract.html">Contract Management</a>
                        </li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view">
                            <a href="onboard.html">Onboarding</a>
                        </li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view">
                            <a href="kpi.html">KPI</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-item" data-feature="communication_view" data-requires-permission="communication_view">
                    <a href="info.html"><i class="fas fa-comments"></i> Communication</a>
                </li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li class="menu-item">
                            <a href="account.html">Account Settings</a>
                        </li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view">
                            <a href="companymanagement.html">Company Management</a>
                        </li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view">
                            <a href="approval-settings.html">Approval Flow Settings</a>
                        </li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view">
                            <a href="fieldsetup.html">Field Setup</a>
                        </li>
                        <li class="menu-item">
                            <a href="preferences.html">Preferences</a>
                        </li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view">
                            <a href="notification-settings.html">Notification Settings</a>
                        </li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view">
                            <a href="auditlog.html">Audit Log</a>
                        </li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view">
                            <a href="users.html">User & Role Management</a>
                        </li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view">
                            <a href="roles.html">Role Permissions</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationCount">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="clear-all-btn" id="clearAllNotifications">Clear All</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <p style="padding: 1rem; text-align: center; color: #666;">No new notifications</p>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li class="profile-header">
                                    <div class="profile-info" style="padding: 1rem; border-bottom: 1px solid #e0e0e0;">
                                        <strong id="profileDropdownName">User</strong>
                                        <small id="profileDropdownEmail" style="display: block; color: #666;">user@example.com</small>
                                    </div>
                                </li>
                                <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
                                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-header-content">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar" id="profileAvatar">
                            <div id="profileInitials">U</div>
                        </div>
                        <button class="avatar-upload-btn" onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-camera"></i> Change Photo
                        </button>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    </div>
                    <div class="profile-info-section">
                        <h2 class="profile-name" id="profileDisplayName">Loading...</h2>
                        <p class="profile-email" id="profileDisplayEmail">loading@example.com</p>
                        <div class="profile-role" id="profileDisplayRole">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Tab Navigation -->
                <div class="profile-tabs">
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" data-tab="personal">
                            <i class="fas fa-user"></i>
                            Personal Info
                        </button>
                        <button class="tab-nav-btn" data-tab="security">
                            <i class="fas fa-shield-alt"></i>
                            Security
                        </button>
                        <button class="tab-nav-btn" data-tab="activity">
                            <i class="fas fa-history"></i>
                            Activity
                        </button>
                        <button class="tab-nav-btn" data-tab="preferences">
                            <i class="fas fa-cog"></i>
                            Preferences
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane active" id="personal">
                            <div class="tab-card">
                                <div class="tab-card-header">
                                    <h3 class="tab-card-title">
                                        <i class="fas fa-user"></i>
                                        Personal Information
                                    </h3>
                                </div>
                                <div class="tab-card-body">
                                    <form id="personalInfoForm">
                                <div class="form-group">
                                    <label for="displayName">Full Name</label>
                                    <input type="text" id="displayName" name="displayName" readonly required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="department">Department</label>
                                    <input type="text" id="department" name="department" placeholder="Department assigned by company" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="position">Position</label>
                                    <input type="text" id="position" name="position" placeholder="e.g., Software Engineer, Manager, Analyst" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="bio">Bio</label>
                                    <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Bio
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>

                        <!-- Security Settings Tab -->
                        <div class="tab-pane" id="security">
                            <div class="tab-card">
                                <div class="tab-card-header">
                                    <h3 class="tab-card-title">
                                        <i class="fas fa-shield-alt"></i>
                                        Security Settings
                                    </h3>
                                </div>
                                <div class="tab-card-body">
                                    <form id="securityForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <div class="password-input-container">
                                        <input type="password" id="currentPassword" name="currentPassword">
                                        <button type="button" class="password-toggle" onclick="profileManager.togglePassword('currentPassword')">
                                            <i class="fas fa-eye" id="currentPasswordIcon"></i>
                                        </button>
                                    </div>
                                    <div class="error-tooltip" id="currentPasswordTooltip">Incorrect password. Please try again.</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <div class="password-input-container">
                                        <input type="password" id="newPassword" name="newPassword">
                                        <button type="button" class="password-toggle" onclick="profileManager.togglePassword('newPassword')">
                                            <i class="fas fa-eye" id="newPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm New Password</label>
                                    <div class="password-input-container">
                                        <input type="password" id="confirmPassword" name="confirmPassword">
                                        <button type="button" class="password-toggle" onclick="profileManager.togglePassword('confirmPassword')">
                                            <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="password-requirements" id="passwordRequirements">
                                    <strong>Password Requirements:</strong>
                                    <ul>
                                        <li id="req-length">At least 8 characters</li>
                                        <li id="req-uppercase">At least one uppercase letter</li>
                                        <li id="req-lowercase">At least one lowercase letter</li>
                                        <li id="req-number">At least one number</li>
                                        <li id="req-special">At least one special character</li>
                                    </ul>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-lock"></i> Update Password
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity Tab -->
                        <div class="tab-pane" id="activity">
                            <div class="tab-card">
                                <div class="tab-card-header">
                                    <h3 class="tab-card-title">
                                        <i class="fas fa-history"></i>
                                        Recent Activity
                                    </h3>
                                </div>
                                <div class="tab-card-body">
                                    <div id="recentActivity">
                                        <div class="activity-loading">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Loading recent activities...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane" id="preferences">
                            <div class="tab-card">
                                <div class="tab-card-header">
                                    <h3 class="tab-card-title">
                                        <i class="fas fa-cog"></i>
                                        Preferences
                                    </h3>
                                </div>
                                <div class="tab-card-body">
                                    <form id="preferencesForm">
                                <div class="form-group">
                                    <label for="timezone">Timezone</label>
                                    <select id="timezone" name="timezone">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">Eastern Time</option>
                                        <option value="America/Chicago">Central Time</option>
                                        <option value="America/Denver">Mountain Time</option>
                                        <option value="America/Los_Angeles">Pacific Time</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="language">Language</label>
                                    <select id="language" name="language">
                                        <option value="en">English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Preferences
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Firebase Configuration and Scripts -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Profile Management Class
        class ProfileManager {
            constructor() {
                this.currentUser = null;
                this.userStats = {};
                this.initialize();
            }

            initialize() {
                this.loadCurrentUser();
                this.setupEventListeners();
                // Load company info first, then user profile
                setTimeout(async () => {
                    await this.loadCompanyInfo(); // Load company info first
                    await this.loadUserCompany(); // Load user's company association
                    await this.loadUserProfile(); // Then load user profile to get company-scoped data
                    await this.loadUserStats();
                    await this.loadRecentActivity(); // Load activity data
                    await this.updateMenuVisibility(); // Apply menu permissions
                }, 100);
            }

            loadCurrentUser() {
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.currentUser = JSON.parse(storedUser);
                
                // Also check Firebase auth state
                auth.onAuthStateChanged((user) => {
                    if (!user) {
                        console.warn('Firebase auth state: No user authenticated');
                        // Don't redirect immediately, but log for debugging
                    } else {
                        console.log('Firebase auth state: User authenticated:', user.email);
                    }
                });
                
                this.updateProfileHeader();
            }

            async updateProfileHeader() {
                if (!this.currentUser) return;

                const displayName = this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0];
                const email = this.currentUser.email;
                const role = this.currentUser.role || 'User';

                // Update header elements
                document.getElementById('profileDisplayName').textContent = displayName;
                document.getElementById('profileDisplayEmail').textContent = email;
                document.getElementById('profileDisplayRole').textContent = this.formatRole(role);

                // Update profile dropdown
                document.getElementById('profileDropdownName').textContent = displayName;
                document.getElementById('profileDropdownEmail').textContent = email;

                // Update avatar
                this.updateAvatar(displayName);
                
                // Try to load profile image
                await this.loadProfileImage();
            }

            updateAvatar(displayName) {
                const initials = this.getInitials(displayName);
                const profileInitials = document.getElementById('profileInitials');
                
                if (profileInitials) {
                    profileInitials.textContent = initials;
                }
                
                // Update header avatar
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && !userAvatar.querySelector('img[src*="data:image"]')) {
                    // Only update if no profile image is loaded
                    this.generateInitialsAvatar(displayName, userAvatar);
                }
            }

            getInitials(name) {
                if (!name) return 'U';
                const words = name.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            formatRole(role) {
                if (!role) return 'User';
                
                // Handle specific role IDs and convert them to readable names
                const roleMap = {
                    'Guest_mdc6i4y9': 'Guest',
                    'admin': 'Administrator',
                    'manager': 'Manager',
                    'supervisor': 'Supervisor',
                    'employee': 'Employee',
                    'guest': 'Guest',
                    'user': 'User'
                };
                
                // Check if it's a mapped role ID
                const lowerRole = role.toLowerCase();
                if (roleMap[role] || roleMap[lowerRole]) {
                    return roleMap[role] || roleMap[lowerRole];
                }
                
                // If role contains underscore followed by random characters, extract the base role
                if (role.includes('_')) {
                    const baseRole = role.split('_')[0];
                    if (roleMap[baseRole.toLowerCase()]) {
                        return roleMap[baseRole.toLowerCase()];
                    }
                    // Return just the base role name, capitalized
                    return baseRole.charAt(0).toUpperCase() + baseRole.slice(1).toLowerCase();
                }
                
                // Default formatting for other roles (capitalize and replace hyphens with spaces)
                return role.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            generateInitialsAvatar(displayName, imgElement) {
                if (!imgElement || !displayName) return;
                
                const initials = this.getInitials(displayName);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 40;
                
                canvas.width = size;
                canvas.height = size;
                
                // Background circle
                ctx.beginPath();
                ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#3498db';
                ctx.fill();
                
                // Text
                ctx.fillStyle = '#ffffff';
                ctx.font = `${size / 2.5}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, size / 2, size / 2);
                
                imgElement.src = canvas.toDataURL();
                imgElement.alt = `${displayName} Avatar`;
            }

            async loadProfileImage() {
                if (!this.currentUser) return;

                // Get company ID for scoped path
                const companyId = this.currentUser.companyId || 'default';
                console.log(' Loading profile image for company:', companyId);

                // Try company-scoped path first, then fallback to global
                const possiblePaths = [
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
                    `avatars/${this.currentUser.uid}/profile.jpg`, // Global fallback
                    `avatars/${this.currentUser.uid}/profile.png`,
                    `avatars/${this.currentUser.uid}/profile.jpeg`
                ];

                for (const imagePath of possiblePaths) {
                    try {
                        const imageRef = storage.ref(imagePath);
                        const imageUrl = await imageRef.getDownloadURL();
                        
                        console.log(` Found profile image at: ${imagePath}`);
                        
                        // Update profile avatar
                        const profileAvatar = document.getElementById('profileAvatar');
                        const userAvatar = document.getElementById('userAvatar');
                        
                        if (profileAvatar) {
                            profileAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile Photo">`;
                        }
                        
                        if (userAvatar) {
                            userAvatar.src = imageUrl;
                        }
                        
                        return; // Success, exit the loop
                    } catch (error) {
                        console.log(` No profile image at: ${imagePath}`);
                        continue; // Try next path
                    }
                }

                // No image found, use initials
                console.log('No profile image found, using initials');
                // Generate initials avatar for header
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && this.currentUser) {
                    const displayName = this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0];
                    this.generateInitialsAvatar(displayName, userAvatar);
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return;

                try {
                    // Load user data from global users path first
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();

                    console.log('Loading user profile data from global path:', userData);

                    // Also try to load user data from company scope if we have company info
                    let companyUserData = null;
                    if (this.currentCompany?.id) {
                        console.log(' Loading user data from company scope...');
                        console.log(' Company ID:', this.currentCompany.id);
                        console.log(' User UID:', this.currentUser.uid);
                        const companyUserRef = db.ref(`companies/${this.currentCompany.id}/users/${this.currentUser.uid}`);
                        const companySnapshot = await companyUserRef.once('value');
                        companyUserData = companySnapshot.val();
                        console.log(' Company user data:', companyUserData);
                        
                        if (!companyUserData) {
                            console.log(' No user data found in company scope - user may not be added to company yet');
                            console.log(' Trying to find user in any company...');
                            
                            // Try to find the user in any company
                            const companiesRef = db.ref('companies');
                            const companiesSnapshot = await companiesRef.once('value');
                            const companiesData = companiesSnapshot.val();
                            
                            if (companiesData) {
                                for (const [companyId, company] of Object.entries(companiesData)) {
                                    if (company.users && company.users[this.currentUser.uid]) {
                                        companyUserData = company.users[this.currentUser.uid];
                                        console.log(` Found user data in company: ${company.companyName || companyId}`);
                                        console.log(' User data from company:', companyUserData);
                                        break;
                                    }
                                }
                            }
                            
                            if (!companyUserData) {
                                console.log(' User not found in any company - using global user data only');
                            }
                        }
                    } else {
                        console.log(' No company information available - cannot load company-scoped user data');
                    }

                    // Merge data with company data taking precedence for department and position
                    const mergedData = {
                        ...(userData || {}),
                        ...(companyUserData && {
                            department: companyUserData.department,
                            position: companyUserData.jobTitle || companyUserData.position,
                            // Include other company-specific fields if needed
                            phone: companyUserData.phone || userData?.phone,
                            name: companyUserData.name || userData?.name
                        })
                    };

                    console.log(' Merged user data:', mergedData);

                    if (mergedData && Object.keys(mergedData).length > 0) {
                        // Populate form fields with error checking
                        const displayNameField = document.getElementById('displayName');
                        const emailField = document.getElementById('email');
                        const phoneField = document.getElementById('phone');
                        const departmentField = document.getElementById('department');
                        const positionField = document.getElementById('position');
                        const bioField = document.getElementById('bio');
                        
                        if (displayNameField) displayNameField.value = mergedData.name || mergedData.displayName || '';
                        if (emailField) emailField.value = mergedData.email || this.currentUser.email;
                        if (phoneField) phoneField.value = mergedData.phone || '';
                        if (departmentField) {
                            departmentField.value = mergedData.department || '';
                            console.log(' Department field populated with:', mergedData.department || 'No department assigned');
                        }
                        if (positionField) positionField.value = mergedData.position || '';
                        if (bioField) bioField.value = mergedData.bio || '';
                        
                        console.log('Populated fields:', {
                            department: mergedData.department || 'No department data',
                            position: mergedData.position || 'No position data'
                        });
                        
                        // Populate preferences (these come from global user data)
                        const timezoneField = document.getElementById('timezone');
                        const languageField = document.getElementById('language');
                        
                        if (timezoneField) timezoneField.value = userData?.timezone || 'UTC';
                        if (languageField) languageField.value = userData?.language || 'en';
                    } else {
                        console.log('No user data found in database - creating default profile');
                        // Create default profile data
                        const defaultData = {
                            name: this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0],
                            email: this.currentUser.email,
                            phone: '',
                            department: '',
                            position: '',
                            bio: '',
                            timezone: 'UTC',
                            language: 'en',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Save default data to database
                        await db.ref(`users/${this.currentUser.uid}`).set(defaultData);
                        
                        // Set default values in form
                        const displayNameField = document.getElementById('displayName');
                        const emailField = document.getElementById('email');
                        
                        if (displayNameField) displayNameField.value = defaultData.name;
                        if (emailField) emailField.value = defaultData.email;
                        
                        console.log('Default profile created and populated');
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    this.showNotification('Error loading profile data', 'error');
                }
            }

            async loadUserStats() {
                if (!this.currentUser) return;

                try {
                    // Load training requests count
                    const trainingRef = db.ref('trainingRequests');
                    const trainingSnapshot = await trainingRef.orderByChild('submittedBy').equalTo(this.currentUser.uid).once('value');
                    const trainingCount = trainingSnapshot.exists() ? Object.keys(trainingSnapshot.val()).length : 0;
                    
                    // Load access requests count
                    const accessRef = db.ref('access');
                    const accessSnapshot = await accessRef.orderByChild('submittedBy').equalTo(this.currentUser.uid).once('value');
                    const accessCount = accessSnapshot.exists() ? Object.keys(accessSnapshot.val()).length : 0;
                    
                    // Calculate account age
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    const accountAge = userData?.createdAt ? 
                        Math.floor((Date.now() - new Date(userData.createdAt).getTime()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Calculate days since last login
                    const lastLogin = userData?.lastLogin ? 
                        Math.floor((Date.now() - new Date(userData.lastLogin).getTime()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Update stats display
                    document.getElementById('statTrainingRequests').textContent = trainingCount;
                    document.getElementById('statAccessRequests').textContent = accessCount;
                    document.getElementById('statLastLoginDays').textContent = lastLogin;
                    document.getElementById('statAccountAge').textContent = accountAge;
                    
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            async loadRecentActivity() {
                if (!this.currentUser) return;

                try {
                    const activities = [];
                    const userId = this.currentUser.uid;

                    // Load login activities from user record
                    const userRef = db.ref(`users/${userId}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();

                    if (userData?.lastLogin) {
                        activities.push({
                            type: 'login',
                            title: 'Logged in',
                            timestamp: userData.lastLogin,
                            icon: 'fas fa-sign-in-alt',
                            iconClass: 'login'
                        });
                    }

                    if (userData?.updatedAt && userData?.updatedAt !== userData?.createdAt) {
                        activities.push({
                            type: 'profile',
                            title: 'Updated profile information',
                            timestamp: userData.updatedAt,
                            icon: 'fas fa-user-edit',
                            iconClass: 'profile'
                        });
                    }

                    if (userData?.createdAt) {
                        activities.push({
                            type: 'account',
                            title: 'Account created',
                            timestamp: userData.createdAt,
                            icon: 'fas fa-user-plus',
                            iconClass: 'profile'
                        });
                    }

                    // Load all training requests (not limited)
                    const trainingRef = db.ref('trainingRequests');
                    const trainingSnapshot = await trainingRef.orderByChild('submittedBy').equalTo(userId).once('value');
                    
                    if (trainingSnapshot.exists()) {
                        const trainingData = trainingSnapshot.val();
                        Object.values(trainingData).forEach(request => {
                            activities.push({
                                type: 'training',
                                title: `Submitted training request: ${request.trainingType || 'Training'}`,
                                timestamp: request.submittedAt || request.createdAt,
                                icon: 'fas fa-graduation-cap',
                                iconClass: 'request',
                                details: `Status: ${request.status || 'Pending'}`
                            });
                        });
                    }

                    // Load all access requests (not limited)
                    const accessRef = db.ref('access');
                    const accessSnapshot = await accessRef.orderByChild('submittedBy').equalTo(userId).once('value');
                    
                    if (accessSnapshot.exists()) {
                        const accessData = accessSnapshot.val();
                        Object.values(accessData).forEach(request => {
                            activities.push({
                                type: 'access',
                                title: `Requested access to ${request.location || 'area'}`,
                                timestamp: request.submittedAt || request.createdAt,
                                icon: 'fas fa-key',
                                iconClass: 'security',
                                details: `Status: ${request.status || 'Pending'}`
                            });
                        });
                    }

                    // Load password updates (if we track them)
                    if (userData?.passwordUpdatedAt) {
                        activities.push({
                            type: 'security',
                            title: 'Updated password',
                            timestamp: userData.passwordUpdatedAt,
                            icon: 'fas fa-lock',
                            iconClass: 'security'
                        });
                    }

                    // Add avatar upload activity if tracked
                    if (userData?.profileImage && userData?.updatedAt) {
                        activities.push({
                            type: 'profile',
                            title: 'Updated profile photo',
                            timestamp: userData.updatedAt,
                            icon: 'fas fa-camera',
                            iconClass: 'profile'
                        });
                    }

                    // Sort activities by timestamp (most recent first)
                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Show all activities (no limit)
                    this.renderActivityList(activities);

                } catch (error) {
                    console.error('Error loading recent activity:', error);
                    this.renderActivityError();
                }
            }

            renderActivityList(activities) {
                const activityContainer = document.getElementById('recentActivity');
                
                if (!activities || activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="activity-empty">
                            <i class="fas fa-clock"></i>
                            <div>No activity found</div>
                            <small>Your activities will appear here as you use the system</small>
                        </div>
                    `;
                    return;
                }

                // Group activities by date for better organization
                const groupedActivities = this.groupActivitiesByDate(activities);
                
                let activityHTML = '';
                
                Object.entries(groupedActivities).forEach(([dateGroup, dayActivities]) => {
                    activityHTML += `
                        <div class="activity-date-group">
                            <div class="activity-date-header">${dateGroup}</div>
                            <div class="activity-list">
                    `;
                    
                    dayActivities.forEach(activity => {
                        const timeAgo = this.formatTimeAgo(activity.timestamp);
                        const userTimezone = this.currentUser?.timezone || 'UTC';
                        let timeOnly;
                        
                        try {
                            timeOnly = new Date(activity.timestamp).toLocaleTimeString([], {
                                hour: '2-digit', 
                                minute: '2-digit',
                                timeZone: userTimezone
                            });
                        } catch (error) {
                            timeOnly = new Date(activity.timestamp).toLocaleTimeString([], {
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                        }
                        
                        activityHTML += `
                            <div class="activity-item">
                                <div class="activity-icon ${activity.iconClass}">
                                    <i class="${activity.icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.title}</div>
                                    ${activity.details ? `<div class="activity-details">${activity.details}</div>` : ''}
                                    <div class="activity-time">
                                        <span class="time-specific">${timeOnly}</span>
                                        <span class="time-relative">${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    activityHTML += `
                            </div>
                        </div>
                    `;
                });

                activityContainer.innerHTML = activityHTML;
            }

            groupActivitiesByDate(activities) {
                const grouped = {};
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                activities.forEach(activity => {
                    const activityDate = new Date(activity.timestamp);
                    let dateKey;
                    
                    if (this.isSameDay(activityDate, today)) {
                        dateKey = 'Today';
                    } else if (this.isSameDay(activityDate, yesterday)) {
                        dateKey = 'Yesterday';
                    } else {
                        dateKey = activityDate.toLocaleDateString([], {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = [];
                    }
                    grouped[dateKey].push(activity);
                });
                
                return grouped;
            }

            isSameDay(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }

            renderActivityError() {
                const activityContainer = document.getElementById('recentActivity');
                activityContainer.innerHTML = `
                    <div class="activity-empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Failed to load activities</div>
                        <small>Please try refreshing the page</small>
                    </div>
                `;
            }

            formatTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                
                const now = new Date();
                const activityTime = new Date(timestamp);
                const diffInSeconds = Math.floor((now - activityTime) / 1000);

                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 604800) {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `${days} day${days !== 1 ? 's' : ''} ago`;
                } else {
                    // Use user's timezone preference if available
                    const userTimezone = this.currentUser?.timezone || 'UTC';
                    try {
                        return activityTime.toLocaleDateString('en-US', {
                            timeZone: userTimezone
                        });
                    } catch (error) {
                        return activityTime.toLocaleDateString();
                    }
                }
            }

            async loadCompanyInfo() {
                try {
                    console.log(' Loading company information...');
                    const companyRef = db.ref('companies');
                    const snapshot = await companyRef.once('value');
                    const companiesData = snapshot.val();
                    
                    if (companiesData) {
                        // Get the first company or find the active one
                        const companyKeys = Object.keys(companiesData);
                        if (companyKeys.length > 0) {
                            const companyKey = companyKeys[0]; // Use first company for now
                            this.currentCompany = {
                                id: companyKey,
                                ...companiesData[companyKey]
                            };
                            console.log(' Company data loaded:', this.currentCompany);
                            this.updateHeaderBranding();
                        } else {
                            console.log(' No companies found');
                            this.showFallbackBranding();
                        }
                    } else {
                        console.log(' No company data available');
                        this.showFallbackBranding();
                    }
                } catch (error) {
                    console.error(' Error loading company info:', error);
                    this.showFallbackBranding();
                }
            }

            updateHeaderBranding() {
                if (!this.currentCompany) {
                    console.log(' updateHeaderBranding called but no company data available');
                    this.showFallbackBranding();
                    return;
                }

                console.log(' updateHeaderBranding() called with company:', this.currentCompany.companyName);

                // Update header branding elements
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerName = document.getElementById('headerCompanyName');

                console.log(' Header elements found:');
                console.log('- headerLogo:', headerLogo ? '' : '');
                console.log('- headerLogoPlaceholder:', headerLogoPlaceholder ? '' : '');
                console.log('- headerName:', headerName ? '' : '');

                // Update company name first
                if (headerName && this.currentCompany.companyName) {
                    headerName.textContent = this.currentCompany.companyName;
                    console.log(' Company name updated in header:', this.currentCompany.companyName);
                }

                // Check if company has a logo (try both 'logo' and 'logoUrl' properties)
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoUrl && logoUrl.trim() !== '') {
                    console.log(' Company has logo URL:', logoUrl);
                    // Show the logo and hide placeholder
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log(' Company logo displayed');
                    }
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'none';
                    }
                } else {
                    console.log(' No logo URL available, showing placeholder');
                    // Hide logo and show placeholder
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        headerLogo.classList.remove('visible');
                    }
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                }

                // Apply company branding colors if available
                if (this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) {
                        root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    }
                    if (this.currentCompany.branding.secondaryColor) {
                        root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                    }
                }
            }

            showFallbackBranding() {
                console.log(' showFallbackBranding() called - clearing branding');
                
                // First reset all header branding elements to ensure clean state
                this.resetHeaderBranding();
                
                const headerCompanyName = document.getElementById('headerCompanyName');
                
                // Clear company name
                if (headerCompanyName) {
                    headerCompanyName.textContent = '';
                    console.log(' Fallback company name cleared');
                }
            }

            resetHeaderBranding() {
                console.log(' resetHeaderBranding() - clearing all branding elements');
                
                const headerCompanyLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');
                
                // Hide/reset all elements
                if (headerCompanyLogo) {
                    headerCompanyLogo.style.display = 'none';
                    headerCompanyLogo.classList.remove('visible');
                    headerCompanyLogo.src = '';
                }
                
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'flex';
                }
                
                if (headerCompanyName) {
                    headerCompanyName.textContent = '';
                }
            }

            // Feature-based menu authorization system
            async updateMenuVisibility() {
                console.log(' Starting feature authorization update...');
                
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error(' Error in feature authorization:', error);
                    showBasicMenu();
                }
            }

            async loadUserCompany() {
                console.log(' loadUserCompany() called');
                console.log(' currentUser:', this.currentUser);
                
                if (!this.currentUser) {
                    console.warn(' No currentUser available for loadUserCompany');
                    return;
                }

                try {
                    const companiesRef = db.ref('companies');
                    console.log(' Fetching companies from Firebase...');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        console.log(' Companies data received:', Object.keys(companies).length, 'companies');
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        console.log(' Found user in company:', company.companyName, '(ID:', companyId, ')');
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            console.log(' Setting currentCompany:', foundCompany);
                            
                            // Update localStorage with company info
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        } else {
                            console.log(' User not found in any active company');
                        }
                    } else {
                        console.log(' No companies found in database');
                    }
                } catch (error) {
                    console.error(' Error loading user company:', error);
                }
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-nav-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabName = button.getAttribute('data-tab');
                        this.switchTab(tabName);
                    });
                });

                // Avatar upload
                document.getElementById('avatarUpload').addEventListener('change', (e) => {
                    this.handleAvatarUpload(e);
                });

                // Personal info form
                document.getElementById('personalInfoForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePersonalInfo();
                });

                // Security form
                document.getElementById('securityForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updatePassword();
                });

                // Preferences form
                document.getElementById('preferencesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePreferences();
                });

                // Password validation
                document.getElementById('newPassword').addEventListener('input', (e) => {
                    this.validatePassword(e.target.value);
                });

                // Hide password tooltip when user starts typing
                document.getElementById('currentPassword').addEventListener('input', () => {
                    this.hidePasswordTooltip();
                });

                // Language and timezone instant updates
                document.getElementById('language').addEventListener('change', (e) => {
                    this.updateLanguagePreference(e.target.value);
                });

                document.getElementById('timezone').addEventListener('change', (e) => {
                    this.updateTimezonePreference(e.target.value);
                });

                // Password toggle keyboard accessibility
                document.querySelectorAll('.password-toggle').forEach(button => {
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            button.click();
                        }
                    });
                });

                // Profile dropdown functionality
                this.setupProfileDropdown();
            }

            switchTab(tabName) {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                
                // Add active class to clicked button and corresponding pane
                const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
                const activePane = document.getElementById(tabName);
                
                if (activeButton) activeButton.classList.add('active');
                if (activePane) activePane.classList.add('active');
                
                // Load specific content based on tab
                switch(tabName) {
                    case 'activity':
                        this.loadRecentActivity();
                        break;
                    case 'personal':
                        // Personal info is already loaded
                        break;
                    case 'security':
                        // Security form is static
                        break;
                    case 'preferences':
                        // Preferences might need loading
                        break;
                }
            }

            setupProfileDropdown() {
                const userProfileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown');
                
                if (userProfileBtn && profileDropdown) {
                    userProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });

                    document.addEventListener('click', (e) => {
                        if (!userProfileBtn.contains(e.target)) {
                            profileDropdown.classList.remove('show');
                        }
                    });
                }
            }

            async handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Please select a valid image file', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    this.showNotification('Image size must be less than 5MB', 'error');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Get company ID for scoped upload path
                    const companyId = this.currentUser.companyId || 'default';
                    console.log(' Uploading profile image for company:', companyId);
                    
                    // Upload to company-scoped Firebase Storage path
                    const imageRef = storage.ref(`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`);
                    const snapshot = await imageRef.put(file);
                    const imageUrl = await snapshot.ref.getDownloadURL();
                    
                    console.log(' Profile image uploaded to:', imageRef.fullPath);
                    
                    // Update profile avatar immediately
                    const profileAvatar = document.getElementById('profileAvatar');
                    const userAvatar = document.getElementById('userAvatar');
                    
                    if (profileAvatar) {
                        profileAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile Photo">`;
                    }
                    
                    if (userAvatar) {
                        userAvatar.src = imageUrl;
                    }
                    
                    // Update user record
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        profileImage: imageUrl,
                        updatedAt: new Date().toISOString()
                    });
                    
                    this.showNotification('Profile photo updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    this.showNotification('Error uploading photo. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async savePersonalInfo() {
                // Only save the bio field since other fields are readonly
                const formData = {
                    bio: document.getElementById('bio').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    this.showLoading(true);
                    
                    await db.ref(`users/${this.currentUser.uid}`).update(formData);
                    
                    // Update current user in localStorage
                    this.currentUser = { ...this.currentUser, ...formData };
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    this.showNotification('Bio updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving bio:', error);
                    this.showNotification('Error saving bio. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async updatePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    this.showNotification('Please fill in all password fields', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    this.showNotification('New passwords do not match', 'error');
                    return;
                }

                if (!this.isValidPassword(newPassword)) {
                    this.showNotification('Password does not meet requirements', 'error');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Check if user is authenticated with Firebase
                    const user = auth.currentUser;
                    if (!user) {
                        console.error('No authenticated user found');
                        this.showNotification('User not authenticated. Please log in again.', 'error');
                        return;
                    }

                    console.log('Current user:', user.email);
                    console.log('Attempting to re-authenticate user...');
                    
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        user.email, // Use the current user's email from Firebase
                        currentPassword
                    );
                    
                    await user.reauthenticateWithCredential(credential);
                    console.log('Re-authentication successful');
                    
                    console.log('Updating password...');
                    await user.updatePassword(newPassword);
                    console.log('Password update successful');
                    
                    // Clear form and hide any error tooltips
                    document.getElementById('securityForm').reset();
                    this.hidePasswordTooltip();
                    
                    this.showNotification('Password updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Detailed error updating password:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    if (error.code === 'auth/wrong-password') {
                        this.showPasswordTooltip('Current password is incorrect');
                        this.showNotification('Current password is incorrect', 'error');
                    } else if (error.code === 'auth/weak-password') {
                        this.showNotification('New password is too weak. Please choose a stronger password.', 'error');
                    } else if (error.code === 'auth/requires-recent-login') {
                        this.showNotification('Please log out and log back in, then try updating your password.', 'error');
                    } else if (error.code === 'auth/user-not-found') {
                        this.showNotification('User account not found. Please log in again.', 'error');
                    } else if (error.code === 'auth/too-many-requests') {
                        this.showNotification('Too many failed attempts. Please try again later.', 'error');
                    } else {
                        this.hidePasswordTooltip();
                        this.showNotification(`Error updating password: ${error.message}`, 'error');
                    }
                } finally {
                    this.showLoading(false);
                }
            }

            async savePreferences() {
                const preferences = {
                    timezone: document.getElementById('timezone').value,
                    language: document.getElementById('language').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    this.showLoading(true);
                    
                    await db.ref(`users/${this.currentUser.uid}`).update(preferences);
                    
                    this.showNotification('Preferences saved successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving preferences:', error);
                    this.showNotification('Error saving preferences. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async updateLanguagePreference(language) {
                try {
                    // Update database
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        language: language,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    this.currentUser.language = language;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    // Apply language change immediately (if you have internationalization)
                    this.applyLanguageSettings(language);
                    
                    this.showNotification(`Language changed to ${this.getLanguageName(language)}`, 'success');
                    
                } catch (error) {
                    console.error('Error updating language preference:', error);
                    this.showNotification('Error updating language preference', 'error');
                }
            }

            async updateTimezonePreference(timezone) {
                try {
                    // Update database
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        timezone: timezone,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    this.currentUser.timezone = timezone;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    // Apply timezone change immediately
                    this.applyTimezoneSettings(timezone);
                    
                    this.showNotification(`Timezone changed to ${this.getTimezoneName(timezone)}`, 'success');
                    
                } catch (error) {
                    console.error('Error updating timezone preference:', error);
                    this.showNotification('Error updating timezone preference', 'error');
                }
            }

            applyLanguageSettings(language) {
                // Store language preference for future use
                document.documentElement.lang = language;
                
                // You can add more language-specific logic here
                console.log(`Language preference applied: ${language}`);
            }

            applyTimezoneSettings(timezone) {
                // Store timezone preference for future use
                // This can be used for displaying times in user's preferred timezone
                console.log(`Timezone preference applied: ${timezone}`);
                
                // Refresh activity times if the activity tab is currently active
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'activity') {
                    this.loadRecentActivity();
                }
            }

            getLanguageName(languageCode) {
                const languageNames = {
                    'en': 'English',
                    'es': 'Spanish',
                    'fr': 'French',
                    'de': 'German'
                };
                return languageNames[languageCode] || languageCode;
            }

            getTimezoneName(timezone) {
                const timezoneNames = {
                    'UTC': 'UTC',
                    'America/New_York': 'Eastern Time',
                    'America/Chicago': 'Central Time',
                    'America/Denver': 'Mountain Time',
                    'America/Los_Angeles': 'Pacific Time'
                };
                return timezoneNames[timezone] || timezone;
            }

            validatePassword(password) {
                const requirements = {
                    'req-length': password.length >= 8,
                    'req-uppercase': /[A-Z]/.test(password),
                    'req-lowercase': /[a-z]/.test(password),
                    'req-number': /\d/.test(password),
                    'req-special': /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                Object.entries(requirements).forEach(([id, valid]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.className = valid ? 'valid' : 'invalid';
                    }
                });

                return Object.values(requirements).every(valid => valid);
            }

            isValidPassword(password) {
                return password.length >= 8 &&
                       /[A-Z]/.test(password) &&
                       /[a-z]/.test(password) &&
                       /\d/.test(password) &&
                       /[!@#$%^&*(),.?":{}|<>]/.test(password);
            }

            showPasswordTooltip(message) {
                const tooltip = document.getElementById('currentPasswordTooltip');
                const formGroup = document.getElementById('currentPassword').parentElement.parentElement;
                
                if (tooltip && formGroup) {
                    if (message) {
                        tooltip.textContent = message;
                    }
                    
                    // Add error styling to form group and show tooltip
                    formGroup.classList.add('has-error');
                    tooltip.classList.add('show');
                    
                    // Auto-hide tooltip after 5 seconds
                    setTimeout(() => {
                        this.hidePasswordTooltip();
                    }, 5000);
                }
            }

            hidePasswordTooltip() {
                const tooltip = document.getElementById('currentPasswordTooltip');
                const formGroup = document.getElementById('currentPassword').parentElement.parentElement;
                
                if (tooltip && formGroup) {
                    formGroup.classList.remove('has-error');
                    tooltip.classList.remove('show');
                }
            }

            togglePassword(fieldId) {
                const passwordField = document.getElementById(fieldId);
                const icon = document.getElementById(fieldId + 'Icon');
                
                if (!passwordField || !icon) return;
                
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordField.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }

            checkAuthenticationStatus() {
                console.log('=== Authentication Status Check ===');
                console.log('localStorage currentUser:', this.currentUser);
                console.log('Firebase currentUser:', auth.currentUser);
                
                if (auth.currentUser) {
                    console.log('Firebase user email:', auth.currentUser.email);
                    console.log('Firebase user emailVerified:', auth.currentUser.emailVerified);
                    console.log('Firebase user uid:', auth.currentUser.uid);
                } else {
                    console.log('No Firebase currentUser found');
                }
                
                return auth.currentUser !== null;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification-toast notification-${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            showLoading(show) {
                let overlay = document.getElementById('loadingOverlay');
                
                if (show) {
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'loadingOverlay';
                        overlay.className = 'loading-overlay';
                        overlay.innerHTML = `
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Please wait...</p>
                            </div>
                        `;
                        document.body.appendChild(overlay);
                    }
                    overlay.style.display = 'flex';
                } else {
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                }
            }
        }

        // Global logout function
        async function logout() {
            try {
                await auth.signOut();
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Reset all menu items to hidden (exactly as in dashboard.html)
        function resetMenuVisibility() {
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items (exactly as in dashboard.html)
        function showBasicMenu() {
            console.log(' Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Feature-based authorization system that takes priority over role permissions (exactly as in dashboard.html)
        async function updateMenuWithFeatureAuthorization() {
            console.log(' Starting feature-based menu authorization for profile.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log(' Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log(' Using Firebase auth - will search for company');
                } else {
                    console.log(' No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log(' Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(` Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error(' No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId);
                
            } catch (error) {
                console.error(' Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            }
        }

        // Apply feature-based menu visibility (exactly as in dashboard.html)
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log(' Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log(' No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error(' Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log(' Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log(' Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(` Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(` Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log(' All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log(' Authorized features for profile.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(` Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(` Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(` Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(` Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(` Feature-based menu authorization completed for profile.html - ${visibleCount} items visible`);
                
            } catch (error) {
                console.error(' Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Initialize Profile Manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.profileManager = new ProfileManager();
            
            // Initialize feature authorization (exactly as in dashboard.html)
            // Wait for auth manager to be ready
            setTimeout(async () => {
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error(' Error initializing feature-based menu:', error);
                    showBasicMenu();
                }
            }, 1500);
            
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
            
            // Notification dropdown functionality
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (notificationDropdown && !notificationBtn.contains(e.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
