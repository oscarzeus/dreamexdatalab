<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- PDF.js for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- PDF-lib for PDF modification -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-color: #2c3e50;
            --border-color: #e0e0e0;
        }

        * {
            padding: 0;
            box-sizing: border-box;
        }
        html {
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 4rem; /* match smaller fixed header height */
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px; /* reduce header height similar to staff.html */
            min-height: 50px;
            padding: 0 0.75rem; /* compact paddings */
            background-color: #fff;
            border-radius: 0; /* remove rounded corners */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #headerCompanyName {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--primary-color);
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Menu Visibility Styles */
        .menu-item {
            display: block;
        }

        .menu-item.hidden {
            display: none !important;
        }

        /* Essential Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Submenu item visibility */
        .submenu li:not(.menu-visible) {
            display: none !important;
        }

        /* Hide menu items during loading until permissions are applied */
        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .submenu li {
            display: none !important;
        }

        /* Prevent header/user dropdown flicker until hydrated */
        .top-nav.header-loading .top-nav-right { visibility: hidden; }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }
        
        .company-branding { display:flex; align-items:center; gap:0.5rem; }

        /* Match project-list.html header logo + name styling */
        #headerCompanyLogo {
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: none;
            border-radius: 6px;
            display: none;
            /* travel.html: logo without background/border/shadow */
            background: transparent;
            border: none;
            box-shadow: none;
        }
        #headerCompanyLogo.visible { display: block; }
        #headerCompanyName {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--primary-color);
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 320px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            border: 1px solid #e9ecef;
            max-height: 400px;
            overflow: hidden;
        }

        .notification-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }

        .notification-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all .2s ease;
        }
        
        .mark-all-read:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
            display: none;
        }
        
        .notification-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            color: #ddd;
        }
        
        .notification-empty-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #666;
        }
        
        .notification-empty-message {
            font-size: 12px;
            color: #999;
        }

        /* User Profile Styles - match project-list.html exactly */
        .user-profile { position:relative; }
        .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
        .profile-btn img { width:100%; height:100%; object-fit:cover; }
        .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
        .profile-dropdown.show { display:block; }
        .profile-dropdown ul { list-style:none; margin:0; padding:0; }
        .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
        .profile-dropdown li a:hover { background:#f1f5f9; }
        .profile-dropdown li a i { margin-right: 8px; }
        
        .user-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Content Styles */
        .content {
            padding: 1rem;
            background-color: var(--bg-secondary);
            min-height: calc(100vh - 6rem);
            border-radius: 10px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .content-header h1 {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .profile-header {
            background: white;
            padding: 1.25rem; /* reduced from 2rem */
            border-radius: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.25rem; /* reduced spacing */
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .profile-header-content {
            display: flex;
            align-items: flex-start; /* align avatar and text to same top axis */
            gap: 1rem; /* tightened gap */
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
        }

        .profile-info-section {
            flex: 1;
            display: flex;              /* vertically center name/role next to avatar */
            flex-direction: column;
            justify-content: center;
            min-height: 64px;           /* match avatar height so centers correctly */
        }
        
        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .profile-avatar {
            width: 64px;  /* reduced from 80px */
            height: 64px; /* reduced from 80px */
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3); /* slimmer border */
            object-fit: cover;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; /* reduced from 32px */
            font-weight: bold;
            color: white;
            position: relative; /* for overlay button positioning */
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* When an avatar photo is present, hide initials + camera overlay (match header behavior) */
        .profile-avatar.has-photo #profileInitials { display: none; }
        .profile-avatar.has-photo .avatar-upload-btn { display: none; }
        
        .avatar-upload-btn {
            position: absolute;
            right: -4px;
            bottom: -4px;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
            border: 2px solid rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.55);
            color: #ffffff;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: background-color 0.2s ease, transform 0.1s ease;
            z-index: 2;
        }

        .avatar-upload-btn i {
            font-size: 14px;
            line-height: 1;
        }

        .avatar-upload-btn:hover {
            background: rgba(0, 0, 0, 0.70);
            transform: translateY(-1px);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.4rem; /* reduced from 1.8rem */
            line-height: 1.2;  /* tighter line height */
            font-weight: 600;
            margin-bottom: 0.25rem; /* tighter spacing */
            color: white;
            white-space: nowrap;        /* keep to one line */
            overflow: hidden;           /* hide overflow */
            text-overflow: ellipsis;    /* show ellipsis for long names */
            max-width: 100%;
        }
        
        .profile-email {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .profile-role {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        /* Name + Role on one line */
        .profile-name-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }
        .profile-name-row .profile-name {
            margin-bottom: 0;
            flex: 1 1 auto;
            min-width: 0; /* allow ellipsis */
        }
        
        /* Tab Styles */
        .profile-tabs {
            background: transparent;
            margin-bottom: 20px;
        }

        /* Tab Navigation Styles - matching travel.html */
        .tab-navigation {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            background: transparent;
        }

        .tab-nav-btn {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            display: none; /* Hidden by default until authorization */
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Show tabs after authorization check */
        .tab-nav-btn.tab-authorized {
            display: flex;
        }

        .tab-nav-btn:hover {
            color: #334155;
            background: #f8fafc;
        }

        .tab-nav-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }

        /* Content tabs wrapper */
        .content-tabs {
            margin: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Tab content area */
        .tab-content {
            display: block;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: none; /* Hidden by default, shown after auth */
        }
        
        /* Show active tab pane after authorization */
        .tab-pane.active.pane-authorized {
            display: block;
        }

        /* Card Styles for tab content */
        .tab-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .tab-card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .tab-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-card-body {
            padding: 1rem;
        }

        /* Compact Timesheet & Modal Styles */
        /* Make tables, inputs and modal more compact for denser UI */
        .profile-card table th, .profile-card table td {
            padding: 0.4rem 0.6rem !important;
            font-size: 0.85rem;
        }

        #timesheetModal .timesheet-modal-content {
            width: 920px;
            max-width: 100%;
        }

        #timesheetModal input[type="time"],
        #timesheetModal input[type="number"],
        #timesheetModal input[type="text"],
        #timesheetModal select,
        #timesheetModal textarea,
        #timesheetModal input[type="month"] {
            padding: 0.35rem 0.45rem;
            font-size: 0.85rem;
            height: 30px;
        }

        #tsDaysContainer > div {
            padding: 4px 6px !important;
            gap: 6px !important;
            font-size: 0.8rem;
        }

        /* Responsive modal: ensure modal fits viewport on small screens */
        #timesheetModal {
            padding: 20px;
        }
        
        .timesheet-modal-content {
            max-height: calc(100vh - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .timesheet-modal-header {
            flex: 0 0 auto;
        }

        .timesheet-modal-body {
            flex: 1 1 auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Form group compact styling for timesheet modal */
        #timesheetModal .form-group {
            margin-bottom: 12px;
        }
        
        #timesheetModal .form-group label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }

    /* timesheet modal body styles continue */

        /* Ensure the form uses full modal body space */
        #timesheetForm {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #tsDaysContainer {
            flex: 1 1 auto;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .timesheet-modal-footer {
            flex: 0 0 auto;
            padding: 10px 16px;
            border-top: 1px solid #eee;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            gap: 12px;
        }

        .timesheet-modal-footer .footer-actions {
            display: flex;
            gap: 8px;
        }

        /* Icon-only button styles matching staff.html */
        .timesheet-modal-footer .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .timesheet-modal-footer .btn i {
            font-size: 0.875rem;
        }

        .footer-actions .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .footer-actions .btn i {
            font-size: 0.875rem;
        }
        .timesheet-modal-footer .footer-actions .btn-primary span { font-size: 0.8rem; }

        /* View modal approval actions button styles */
        #approvalActions .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        #approvalActions .btn i {
            font-size: 0.875rem;
        }

        /* Secondary button styling matching staff.html */
        .btn-secondary {
            background-color: transparent !important;
            color: #6b7280 !important;
            border: none !important;
            box-shadow: none !important;
        }

        .btn-secondary:hover {
            background-color: rgba(107, 114, 128, 0.1) !important;
            color: #374151 !important;
        }

        /* Submitted timesheet row highlight */
        tr.submitted-row {
            background: linear-gradient(90deg, rgba(230,240,255,0.6), rgba(245,245,245,0.4));
        }

        .profile-content {
            /* Container for tabbed content */
            margin-top: 20px;
        }
        
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e1e8ed;
        }
        
        .profile-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #34495e;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea,
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Readonly field styling */
        .form-group input[readonly],
        .form-group select[disabled] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .form-group input[readonly]:focus,
        .form-group select[disabled]:focus {
            border-color: #e9ecef;
            box-shadow: none;
        }
        
        /* Inline row layout for Personal Info fields */
        .form-row-inline {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
            align-items: end;
        }
        @media (max-width: 1200px) { .form-row-inline { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        @media (max-width: 640px)  { .form-row-inline { grid-template-columns: 1fr; } }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Approval Button Styles */
        .btn-approve {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-approve:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
        }
        
        .btn-decline {
            background: linear-gradient(135deg, #e74c3c 0%, #dc3545 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-decline:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
            background: linear-gradient(135deg, #be123c 0%, #9f1239 100%);
        }
        
        /* Icon-only overrides inside modals (remove background behind icons) */
        .timesheet-modal-footer .footer-actions button,
        #approvalActions button {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0.4rem !important;
            width: 2.25rem !important;
            height: 2.25rem !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            gap: 0 !important;
        }

        .timesheet-modal-footer .footer-actions button:hover,
        #approvalActions button:hover {
            background-color: rgba(0,0,0,0.05) !important;
            transform: translateY(-1px);
        }

        /* Color cues without fill backgrounds */
        #approvalActions .btn-approve { color: #16a34a !important; }
        #approvalActions .btn-decline { color: #dc2626 !important; }
        #approvalActions .btn-delete  { color: #e11d48 !important; }

        /* Footer icon button colors (neutral like staff.html) */
        .timesheet-modal-footer .footer-actions .btn-primary { color: #6b7280 !important; }
        .timesheet-modal-footer .footer-actions .btn-primary:hover { color: #374151 !important; }
        
        /* Approval Actions Container */
        .approval-actions {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
            margin-top: 16px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .tab-pane h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e1e8ed;
            padding-bottom: 10px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: background-color 0.3s ease;
        }

        .activity-item:hover {
            background: #e9ecef;
        }

        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #6c757d;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e1e8ed;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .password-requirements {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .password-requirements ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
        }
        
        .password-requirements li {
            padding: 0;
            white-space: nowrap;
        }

        .password-requirements strong { white-space: nowrap; }
        
        .password-requirements li.valid {
            color: #28a745;
        }
        
        .password-requirements li.invalid {
            color: #dc3545;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        
        /* Responsive Design */
        @media (max-width: 1600px) {
            .main-content {
                width: calc(100vw - var(--sidebar-width));
                max-width: calc(100vw - var(--sidebar-width));
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
            }
            
            .top-nav {
                left: 0.5rem;
            }
            
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .profile-header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        .notification-success {
            background: #28a745;
        }
        
        .notification-error {
            background: #dc3545;
        }

        /* Tooltip Styles */
        .form-group {
            position: relative;
        }

        .error-tooltip {
            position: absolute;
            bottom: -35px;
            left: 0;
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .error-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .error-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 15px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #dc3545;
        }

        .form-group.has-error input {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        /* Password Toggle Styles */
        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .password-toggle:hover {
            color: #495057;
        }

        .password-toggle:focus {
            outline: none;
            color: var(--primary-color);
        }

        .password-input-container input {
            padding-right: 45px;
        }

        /* Security Password Row Layout */
        .password-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .password-row .form-group {
            flex: 1;
            min-width: 240px;
            margin-bottom: 0; /* rely on row gap instead */
        }
        .password-row .password-action-group {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-width: 180px;
        }
        .password-row .password-action-group .password-update-btn {
            width: 100%;
            margin-top: 4px;
        }
        /* Preserve label space to align button with input fields */
        .password-row .password-action-group label {visibility:hidden; height:auto; padding:0; margin:0 0 4px;}
        /* Ensure all password form groups align on same vertical axis */
        .password-row {align-items:flex-start;}
        .password-row .password-action-group {justify-content:flex-start;}
        .password-row .password-action-group .password-update-btn {margin-top:0;}

        /* Activity Tab Styles */
        .activity-loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .activity-loading i {
            margin-right: 0.5rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background-color: #f8f9fa;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
        }

        .activity-icon.login {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .activity-icon.profile {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .activity-icon.request {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .activity-icon.security {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .activity-icon.system {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .activity-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .activity-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Activity Grouping Styles */
        .activity-date-group {
            margin-bottom: 1.5rem;
        }

        .activity-date-header {
            font-weight: 600;
            color: var(--primary-color);
            background: linear-gradient(135deg, rgba(103, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 4px solid var(--primary-color);
        }

        .activity-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-style: italic;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-specific {
            font-weight: 500;
            color: var(--primary-color);
        }

        .time-relative {
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsiveness for Tabs */
        @media (max-width: 768px) {
            .tab-nav-btn {
                flex: none;
                min-width: 100px;
                padding: 12px 15px;
                font-size: 13px;
            }

            .tab-navigation {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-content {
                padding: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .activity-item {
                padding: 12px;
            }

            .profile-container {
                margin: 0;
            }
        }

        /* Approval Flow (Timesheet) minimal styles */
        .approval-flow-display { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
        .approval-flow-list { display: grid; gap: 8px; }
        .approval-stage { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; border: 1px dashed #e5e7eb; background: #fff; }
        .approval-stage.approved { border-color: #c6f6d5; background: #f0fff4; }
        .approval-stage.current { border-color: #bee3f8; background: #ebf8ff; }
        .approval-stage.pending { border-color: #e2e8f0; background: #ffffff; }
        .approval-stage .badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: #edf2f7; color: #4a5568; }
        .approval-stage.approved .badge { background: #c6f6d5; color: #22543d; }
        .approval-stage.current .badge { background: #bee3f8; color: #2a4365; }
        .approval-meta { color: #64748b; font-size: 12px; }

        /* Sign Documents Tab Styles */
        .pdf-drop-zone:hover, .pdf-drop-zone.drag-over { border-color: #3b82f6; background: #eff6ff; }
        .btn-outline-sm { background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.4rem 0.65rem; font-size: 0.72rem; cursor: pointer; transition: all 0.2s; }
        .btn-outline-sm:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-primary-sm { background: #3b82f6; color: #fff; border: none; border-radius: 6px; padding: 0.4rem 0.65rem; font-size: 0.72rem; cursor: pointer; transition: all 0.2s; }
        .btn-primary-sm:hover { background: #2563eb; }
        
        /* Signature/Stamp elements on PDF */
        .sign-element { position: absolute; cursor: move; border: 2px dashed transparent; padding: 2px; transition: border-color 0.2s; user-select: none; }
        .sign-element:hover, .sign-element.selected { border-color: #3b82f6; }
        .sign-element img { 
            pointer-events: none; 
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: bicubic;
        }
        .sign-element .element-controls { position: absolute; top: -28px; right: 0; display: none; gap: 2px; background: #fff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 2px; }
        .sign-element:hover .element-controls, .sign-element.selected .element-controls { display: flex; }
        .sign-element .element-controls button { background: none; border: none; cursor: pointer; padding: 4px 6px; font-size: 0.7rem; color: #64748b; }
        .sign-element .element-controls button:hover { color: #334155; background: #f1f5f9; border-radius: 3px; }
        .sign-element .element-controls button.delete-el:hover { color: #dc2626; }
        .sign-element .resize-handle { position: absolute; bottom: -4px; right: -4px; width: 10px; height: 10px; background: #3b82f6; border-radius: 2px; cursor: nwse-resize; display: none; }
        .sign-element:hover .resize-handle, .sign-element.selected .resize-handle { display: block; }
        
        /* Stamp selector modal */
        .stamp-selector-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .stamp-selector-modal.show { opacity: 1; visibility: visible; }
        .stamp-selector-content { background: #fff; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .stamp-selector-header { padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .stamp-selector-header h3 { margin: 0; font-size: 0.95rem; }
        .stamp-selector-body { padding: 1rem; overflow-y: auto; flex: 1; }
        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; }
        .stamp-item { border: 2px solid #e2e8f0; border-radius: 8px; padding: 0.5rem; cursor: pointer; transition: all 0.2s; text-align: center; }
        .stamp-item:hover { border-color: #3b82f6; background: #f8fafc; }
        .stamp-item.selected { border-color: #3b82f6; background: #eff6ff; }
        .stamp-item img { width: 100%; height: 80px; object-fit: contain; }
        .stamp-item-name { font-size: 0.7rem; color: #475569; margin-top: 0.35rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Signature draw modal */
        .signature-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .signature-modal.show { opacity: 1; visibility: visible; }
        .signature-modal-content { background: #fff; border-radius: 12px; width: 90%; max-width: 500px; overflow: hidden; }
        .signature-modal-header { padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .signature-modal-header h3 { margin: 0; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
        .signature-modal-body { padding: 1rem; }
        .signature-canvas-wrap { border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; }
        #signatureDrawCanvas { width: 100%; height: 200px; cursor: crosshair; }
        .signature-modal-footer { padding: 1rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; gap: 0.5rem; }
        
        /* Text input modal */
        .text-input-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .text-input-modal.show { opacity: 1; visibility: visible; }

        /* View Timesheet A4 Document Styles */
        .ts-a4-scroll { padding:16px; max-height:70vh; overflow:auto; }
        .ts-a4-doc { background:#fff; width:190mm; max-width:100%; margin:0 auto; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.04); padding:14px 16px 18px; box-sizing:border-box; color:#111827; }
        .ts-a4-header { display:flex; align-items:center; gap:4px; margin-bottom:6px; }
        .ts-a4-logo { width:56px; height:56px; border-radius:8px; object-fit:contain; background:#fff; border:1px solid #e5e7eb; display:none; }
        .ts-a4-company { display:flex; flex-direction:column; }
        .ts-a4-company h1 { margin:0; font-size:1.05rem; font-weight:700; color:#111827; }
        .ts-a4-company small { font-size:.65rem; color:#6b7280; }
        .ts-a4-title { font-size:.9rem; font-weight:700; margin:6px 0 2px; color:#111827; }
        .ts-a4-generated { font-size:.6rem; color:#6b7280; margin:0 0 10px; }
        .ts-a4-section { margin:8px 0 6px; }
        .ts-a4-section h2 { font-size:.75rem; font-weight:700; margin:0 0 8px; color:#111827; }
        .ts-a4-meta { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:8px; }
        .ts-a4-meta .item { background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:8px 10px; display:grid; grid-template-columns:max-content 1fr; column-gap:8px; row-gap:2px; }
        .ts-a4-meta .item label { font-size:.58rem; font-weight:700; color:#6b7280; }
        .ts-a4-meta .item label::after { content:':'; margin-left:4px; color:#9ca3af; }
        .ts-a4-meta .item span { font-size:.72rem; color:#111827; }
        .ts-a4-notes { background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:10px; font-size:.72rem; color:#111827; white-space:pre-wrap; }
        .ts-a4-table-area table { width:100%; border-collapse:collapse; font-size:.7rem; }
        .ts-a4-table-area thead th { background:var(--primary-color); color:#fff; font-weight:600; padding:6px; text-align:left; border:1px solid var(--primary-color); }
        .ts-a4-table-area tbody td { padding:6px; border:1px solid #e5e7eb; }
        .ts-a4-table-area tfoot td { padding:6px; border:1px solid #e5e7eb; font-weight:600; background:#f9fafb; }
        .ts-a4-approval h3 { font-size:.75rem; font-weight:700; margin:0 0 8px; color:#111827; }

        /* Print-specific adjustments: minimize top gap on PDF/print */
        @media print {
            @page { size: A4; margin: 6mm 10mm; }
            html, body { margin: 0 !important; padding: 0 !important; }
            .ts-a4-scroll { padding: 0 !important; max-height: unset !important; overflow: visible !important; }
            .ts-a4-doc { padding-top: 2mm !important; margin-top: 0 !important; border: none !important; box-shadow: none !important; }
            /* Tighter section spacing specifically for print */
            .ts-a4-section { margin: 4px 0 4px !important; }
            .ts-a4-section h2 { margin: 0 0 4px !important; }
            /* Smaller font for Time Entries table in print */
            .ts-a4-table-area table { font-size: .65rem !important; }
            /* Hide only the Employee Information header (assumed first section) */
            .ts-a4-doc .ts-a4-section:first-of-type > h2 { display: none !important; }
            .ts-a4-doc .ts-a4-section:first-of-type { margin-top: 0 !important; }
        }

        /* Access Control (Settings) - expandable rows similar to fleet */
        #profileAccessControlTableBody tr.ac-row { cursor: pointer; }
        #profileAccessControlTableBody tr.ac-row:hover { background: #f8fafc; }
        #profileAccessControlTableBody .ac-caret { margin-right: 6px; color:#64748b; transition: transform .18s ease; }
        #profileAccessControlTableBody tr.ac-row.expanded .ac-caret { transform: rotate(90deg); }
        #profileAccessControlTableBody tr.ac-details td { background:#f9fafb; border-top: none; border-bottom: 1px solid #e2e8f0; padding: .8rem 1rem; }
        .ac-group-title { font-size:.65rem; font-weight:700; color:#334155; text-transform:uppercase; letter-spacing:.5px; margin: .25rem 0 .4rem; }
        .ac-grid { display:grid; grid-template-columns: repeat(2, minmax(160px, 1fr)); gap:.4rem .8rem; font-size:.7rem; }
        .ac-grid label { display:flex; align-items:center; gap:6px; }
        @media (max-width: 640px) { .ac-grid { grid-template-columns: 1fr; } }

        /* Assigned Courses Tab Styles */
        .assignments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .assignment-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
        }

        .assignment-card:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15) !important;
        }

        .assignment-section {
            margin-bottom: 2rem;
        }

        .assignment-section h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .assignments-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .assignment-card {
                padding: 1rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view">
                            <a href="trainingboard.html">Training</a>
                        </li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view">
                            <a href="jsaboard.html">Job Safety Analysis</a>
                        </li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view">
                            <a href="ptwboard.html">Permit to Work</a>
                        </li>
                        <li data-feature="incident_view" data-requires-permission="incident_view">
                            <a href="incidentboard.html">Incident Reports</a>
                        </li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view">
                            <a href="inspectionboard.html">Inspection</a>
                        </li>
                        <li data-feature="audit_view" data-requires-permission="audit_view">
                            <a href="auditboard.html">Audit</a>
                        </li>
                    </ul>
                </li>
                <!-- Investigation (separate section - matching project-list.html) -->
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    <ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view">
                            <a href="riskboard.html">Risk Management</a>
                        </li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view">
                            <a href="riskreg.html">Risk Register</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                        <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view">
                            <a href="fleet.html">Fleet Management</a>
                        </li>
                        <li data-feature="travel_view" data-requires-permission="travel_view">
                            <a href="travel.html">Travel Requests</a>
                        </li>
                        <li data-feature="camp_view" data-requires-permission="camp_view">
                            <a href="camp.html">Camp Management</a>
                        </li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view">
                            <a href="campset.html">Camp Settings</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view">
                            <a href="human-hr.html">Human HR</a>
                        </li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view">
                            <a href="staff.html">Staffing</a>
                        </li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view">
                            <a href="recruit.html">Authority to Recruit</a>
                        </li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view">
                            <a href="jobpost.html">Job Advertising</a>
                        </li>
                        <li data-feature="screening_view" data-requires-permission="screening_view">
                            <a href="jobscreen.html">Screening</a>
                        </li>
                        <li data-feature="interview_view" data-requires-permission="interview_view">
                            <a href="interview.html">Interview</a>
                        </li>
                        <li data-feature="offer_view" data-requires-permission="offer_view">
                            <a href="offer.html">Offer Management</a>
                        </li>
                        <li data-feature="contract_view" data-requires-permission="contract_view">
                            <a href="contract.html">Contract Management</a>
                        </li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view">
                            <a href="salary.html">Salary Management</a>
                        </li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view">
                            <a href="onboard.html">Onboarding</a>
                        </li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view">
                            <a href="kpi.html">KPI</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li class="menu-item" data-feature="communication_view" data-requires-permission="communication_view">
                    <a href="info.html"><i class="fas fa-comments"></i> Communication</a>
                </li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li class="menu-item">
                            <a href="account.html">Account Settings</a>
                        </li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view">
                            <a href="companymanagement.html">Company Management</a>
                        </li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view">
                            <a href="approval-settings.html">Approval Flow Settings</a>
                        </li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view">
                            <a href="fieldsetup.html">Field Setup</a>
                        </li>
                        <li class="menu-item">
                            <a href="preferences.html">Preferences</a>
                        </li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view">
                            <a href="notification-settings.html">Notification Settings</a>
                        </li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view">
                            <a href="auditlog.html">Audit Log</a>
                        </li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view">
                            <a href="users.html">User & Role Management</a>
                        </li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view">
                            <a href="roles.html">Role Permissions</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                            <div class="notification-empty">
                                <i class="fas fa-inbox"></i>
                                <div class="notification-empty-title">No notifications</div>
                                <div class="notification-empty-message">You're all caught up</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" style="position:relative;">
                        <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                        <div class="profile-dropdown"><ul></ul></div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-header-content">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar" id="profileAvatar">
                            <div id="profileInitials">U</div>
                            <button class="avatar-upload-btn" title="Change Photo" onclick="document.getElementById('avatarUpload').click()">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="profile-info-section">
                        <div class="profile-name-row">
                            <h2 class="profile-name" id="profileDisplayName">Loading...</h2>
                            <div class="profile-role" id="profileDisplayRole">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Player Modal -->
            <div id="coursePlayerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:flex-start; justify-content:center; overflow:auto; padding:3vh 1rem;">
                <div style="width: min(1200px, 96vw); background:#f9fafb; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.25);">
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; border-bottom:1px solid #e5e7eb; background:#fff; border-top-left-radius:12px; border-top-right-radius:12px;">
                        <div style="display:flex; align-items:center; gap:.5rem;">
                            <i class="fas fa-graduation-cap" style="color:#3b82f6;"></i>
                            <h3 id="coursePlayerTitle" style="margin:0; font-size:1.05rem;">Course</h3>
                        </div>
                        <div style="display:flex; gap:.5rem;">
                            <button type="button" class="btn-secondary" onclick="profileManager.closeCoursePlayer()"><i class="fas fa-times"></i> Close</button>
                        </div>
                    </div>
                    <div id="coursePlayerBody" style="padding:1rem;"></div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Tab Navigation -->
                <div class="profile-tabs content-tabs">
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" data-tab="personal" title="Personal Info">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="security" title="Security">
                            <i class="fas fa-shield-alt"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="activity" title="Activity">
                            <i class="fas fa-history"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="preferences" title="Preferences">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="timesheet" title="Timesheets">
                            <i class="fas fa-clock"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="payslip" title="Payslips">
                            <i class="fas fa-money-check-alt"></i>
                        </button>
                        <button class="tab-nav-btn" id="atrTabBtn" title="Authority to Recruit">
                            <i class="fas fa-user-plus"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="leave" title="Leave">
                            <i class="fas fa-plane-departure"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="work-schedule" title="Work Schedule">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="course" title="Courses">
                            <i class="fas fa-graduation-cap"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="settings" title="Settings">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                        <button class="tab-nav-btn" data-tab="sign" title="Sign Documents">
                            <i class="fas fa-file-signature"></i>
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane active" id="personal">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <form id="personalInfoForm">
                                <div class="form-row-inline">
                                    <div class="form-group">
                                        <label for="displayName">Full Name</label>
                                        <input type="text" id="displayName" name="displayName" readonly required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="email">Email Address</label>
                                        <input type="email" id="email" name="email" readonly>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="phone">Phone Number</label>
                                        <input type="tel" id="phone" name="phone" readonly>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="department">Department</label>
                                        <input type="text" id="department" name="department" placeholder="Department assigned by company" readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="jobTitle">Job Title</label>
                                    <input type="text" id="jobTitle" name="jobTitle" placeholder="Company-defined job title" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="bio">Bio</label>
                                    <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Bio
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>

                        <!-- Security Settings Tab -->
                        <div class="tab-pane" id="security">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <form id="securityForm">
                                <div class="password-row">
                                    <div class="form-group">
                                        <label for="currentPassword">Current Password</label>
                                        <div class="password-input-container">
                                            <input type="password" id="currentPassword" name="currentPassword">
                                            <button type="button" class="password-toggle" onclick="profileManager.togglePassword('currentPassword')">
                                                <i class="fas fa-eye" id="currentPasswordIcon"></i>
                                            </button>
                                        </div>
                                        <div class="error-tooltip" id="currentPasswordTooltip">Incorrect password. Please try again.</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="newPassword">New Password</label>
                                        <div class="password-input-container">
                                            <input type="password" id="newPassword" name="newPassword">
                                            <button type="button" class="password-toggle" onclick="profileManager.togglePassword('newPassword')">
                                                <i class="fas fa-eye" id="newPasswordIcon"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmPassword">Confirm New Password</label>
                                        <div class="password-input-container">
                                            <input type="password" id="confirmPassword" name="confirmPassword">
                                            <button type="button" class="password-toggle" onclick="profileManager.togglePassword('confirmPassword')">
                                                <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group password-action-group">
                                        <label>&nbsp;</label>
                                        <button type="submit" class="btn-primary password-update-btn">
                                            <i class="fas fa-lock"></i> Update Password
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="password-requirements" id="passwordRequirements">
                                    <strong>Password Requirements:</strong>
                                    <ul>
                                        <li id="req-length">8+ characters</li>
                                        <li id="req-uppercase">One uppercase letter</li>
                                        <li id="req-lowercase">One lowercase letter</li>
                                        <li id="req-number">One number</li>
                                        <li id="req-special">One special character</li>
                                    </ul>
                                </div>
                                
                            </form>
                                </div>
                            </div>
                        
                            <!-- Digital Signature Section -->
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <h3 style="margin:0 0 10px; font-size:0.95rem;">Digital Signature</h3>
                                    <p style="margin:0 0 12px; color:#6b7280; font-size:0.8rem;">Create your signature to use on approvals and documents.</p>

                                    <!-- Creation controls moved to modal -->
                                    
                                    <div style="margin-top:10px;">
                                        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
                                            <div style="font-size:0.8rem; color:#6b7280;">Created signatures (table)</div>
                                            <button id="sigAddBtn" type="button" title="Add new signature" style="padding:6px 10px; font-size:0.8rem; border:none; background:#111827; color:#fff; border-radius:6px; display:inline-flex; align-items:center; gap:6px;">
                                                <span style="font-size:1rem; line-height:1;">+</span>
                                                <span>New</span>
                                            </button>
                                        </div>
                                        <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
                                            <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                                                <thead style="background:#f8fafc;">
                                                    <tr>
                                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Default</th>
                                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Preview</th>
                                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Created</th>
                                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="signatureTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity Tab -->
                        <div class="tab-pane" id="activity">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div id="recentActivity">
                                        <div class="activity-loading">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Loading recent activities...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane" id="preferences">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <form id="preferencesForm">
                                <div class="form-group">
                                    <label for="timezone">Timezone</label>
                                    <select id="timezone" name="timezone">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">Eastern Time</option>
                                        <option value="America/Chicago">Central Time</option>
                                        <option value="America/Denver">Mountain Time</option>
                                        <option value="America/Los_Angeles">Pacific Time</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="language">Language</label>
                                    <select id="language" name="language">
                                        <option value="en">English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Preferences
                                </button>
                            </form>
                                </div>
                            </div>
                        </div>
                        <!-- Timesheet Tab -->
                        <div class="tab-pane" id="timesheet">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Your Timesheets</strong>
                                            <div style="color:#6c757d; font-size:0.9rem;">Create and submit timesheets for approval</div>
                                        </div>
                                        <div>
                                            <button id="createTimesheetBtn" class="btn-primary" aria-label="New Timesheet" title="New Timesheet">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="profile-card">
                                        <table style="width:100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="text-align:left; border-bottom:1px solid #e9ecef;">
                                                    <th>Period</th>
                                                    <th>Total Hours</th>
                                                    <th>Status</th>
                                                    <th>Submitted By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="timesheetTableBody">
                                                <tr><td colspan="5" style="padding:16px; color:#6c757d;">No timesheets yet.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Payslip Tab -->
                        <div class="tab-pane" id="payslip">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Your Payslips</strong>
                                            <div style="color:#6c757d; font-size:0.9rem;">Posted payroll runs that include you</div>
                                        </div>
                                        <div style="display:flex; gap:8px;">
                                            <select id="payslipPeriodFilter" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:0.75rem;">
                                                <option value="">All Periods</option>
                                            </select>
                                            <button id="refreshPayslipsBtn" class="btn-primary" style="font-size:0.7rem; display:inline-flex; align-items:center; gap:4px;">
                                                <i class="fas fa-rotate"></i> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <div class="profile-card" style="overflow:auto;">
                                        <table style="width:100%; border-collapse: collapse; min-width:760px;">
                                            <thead>
                                                <tr style="text-align:left; border-bottom:1px solid #e9ecef;">
                                                    <th>Period</th>
                                                    <th>Basic</th>
                                                    <th>Earnings</th>
                                                    <th>Deductions</th>
                                                    <th>Gross</th>
                                                    <th>Tax</th>
                                                    <th>Net</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="payslipTableBody">
                                                <tr><td colspan="8" style="padding:16px; color:#6c757d;">No payslips yet.</td></tr>
                                            </tbody>
                                            <tfoot id="payslipTableTotals"></tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Tab -->
                        <div class="tab-pane" id="course">
                            <div class="tab-card">
                                <div class="tab-card-header" style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                                    <h3 class="tab-card-title" style="margin:0;">
                                        <i class="fas fa-graduation-cap"></i>
                                        Learning & Certifications
                                    </h3>
                                    <div style="display:flex; align-items:center; gap:.5rem;">
                                        <select id="courseStatusFilter" class="form-control" style="max-width:200px; height:32px; padding:.25rem .5rem;">
                                            <option value="all">All</option>
                                            <option value="active">Active</option>
                                            <option value="overdue">Overdue</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                        <button id="refreshCoursesBtn" class="btn-primary" type="button" style="height:32px; padding:.25rem .75rem; display:inline-flex; align-items:center; gap:.5rem;">
                                            <i class="fas fa-rotate"></i><span>Refresh</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="tab-card-body">
                                    <div id="courseStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:.75rem; margin-bottom:1rem;">
                                        <div class="stat-card" style="padding:.75rem; text-align:center;">
                                            <div class="stat-number" id="statActive">0</div>
                                            <div class="stat-label">Active</div>
                                        </div>
                                        <div class="stat-card" style="padding:.75rem; text-align:center;">
                                            <div class="stat-number" id="statOverdue">0</div>
                                            <div class="stat-label">Overdue</div>
                                        </div>
                                        <div class="stat-card" style="padding:.75rem; text-align:center;">
                                            <div class="stat-number" id="statCompleted">0</div>
                                            <div class="stat-label">Completed</div>
                                        </div>
                                        <div class="stat-card" style="padding:.75rem; text-align:center;">
                                            <div class="stat-number" id="statCertificates" style="color:#f59e0b;">0</div>
                                            <div class="stat-label"><i class="fas fa-certificate" style="color:#f59e0b; margin-right:.25rem;"></i>Certificates</div>
                                        </div>
                                    </div>
                                    <div id="assignedCoursesList">
                                        <div style="text-align: center; padding: 3rem; color: #6c757d;">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                            <p>Loading your assigned courses...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Leave Request Tab (Table + Modal trigger) -->
                        <div class="tab-pane" id="leave">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Your Leave Requests</strong>
                                            <div style="color:#6c757d; font-size:0.9rem;">Submit new leave and track progress & approvals</div>
                                        </div>
                                        <div>
                                            <button id="createLeaveBtn" class="btn-primary" aria-label="New Leave Request" title="New Leave Request">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="profile-card" style="overflow:auto;">
                                        <table style="width:100%; border-collapse: collapse; min-width:600px;">
                                            <thead>
                                                <tr style="text-align:left; border-bottom:1px solid #e9ecef;">
                                                    <th>Type</th>
                                                    <th>Start</th>
                                                    <th>End</th>
                                                    <th>Days</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="leaveRequestsTableBody">
                                                <tr><td colspan="5" style="padding:16px; color:#6c757d;">No leave requests yet.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        <!-- Work Schedule Tab (Duplicated from Leave Tab) -->
                        <div class="tab-pane" id="work-schedule">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Your Work Schedule Entries</strong>
                                            <div style="color:#6c757d; font-size:0.9rem;">Submit new schedule items and track status</div>
                                        </div>
                                        <div>
                                            <button id="createWorkScheduleBtn" class="btn-primary" aria-label="New Work Schedule Entry" title="New Work Schedule Entry">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="profile-card" style="overflow:auto;">
                                        <table style="width:100%; border-collapse: collapse; min-width:600px;">
                                            <thead>
                                                <tr style="text-align:left; border-bottom:1px solid #e9ecef;">
                                                    <th>Type</th>
                                                    <th>Start</th>
                                                    <th>End</th>
                                                    <th>Hours</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="workScheduleTableBody">
                                                <tr><td colspan="5" style="padding:16px; color:#6c757d;">No work schedule entries yet.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Settings Tab (adapted from fleet.html) -->
                        <div class="tab-pane" id="settings">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Settings</strong>
                                            <div style="color:#6c757d; font-size:0.9rem;">Manage locations and access</div>
                                        </div>
                                        <div>
                                            <button id="profileSettingsRefreshBtn" class="btn-primary" style="font-size:0.7rem; display:inline-flex; align-items:center; gap:4px;">
                                                <i class="fas fa-rotate"></i> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Fleet Access Control (UI only) -->
                                    <div class="profile-card" style="margin-bottom:1rem;">
                                        <div class="card-header" style="display:flex;align-items:center;gap:.75rem;padding:0.75rem 1rem;border-bottom:1px solid #e9ecef;">
                                            <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:.5rem;font-size:.9rem;margin:0;">
                                                <i class="fas fa-user-shield"></i>
                                                Access Control
                                            </h3>
                                            <button type="button" id="profileAccessAddBtn" class="btn-primary" title="Add user permissions" style="font-size:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:4px;">
                                                <i class="fas fa-plus"></i>
                                                Add
                                            </button>
                                        </div>
                                        <div class="card-body" style="padding:0;">
                                            <div class="table-wrapper" style="padding:1rem;">
                                                <table class="users-table" id="profileAccessControlTable" style="width:100%;font-size:.65rem;">
                                                    <thead>
                                                        <tr>
                                                            <th style="width:220px;">User</th>
                                                            <th>Email</th>
                                                            <th>Job Title</th>
                                                            <th style="white-space:nowrap;">Permissions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="profileAccessControlTableBody"></tbody>
                                                </table>
                                                <div id="profileAccessControlEmpty" style="display:block;text-align:center;color:#64748b;padding:.75rem;font-size:.65rem;">No entries yet. Use Add to create user-specific settings.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Work Schedule Configuration -->
                                    <div class="profile-card" style="margin-bottom:1rem;">
                                        <div class="card-header" style="display:flex;align-items:center;gap:.75rem;padding:0.75rem 1rem;border-bottom:1px solid #e9ecef;">
                                            <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:.5rem;font-size:.9rem;margin:0;">
                                                <i class="fas fa-calendar-alt"></i>
                                                Work Schedule
                                            </h3>
                                            <button type="button" id="workScheduleAddBtn" class="btn-primary" title="Create work schedule" style="font-size:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:4px;">
                                                <i class="fas fa-plus"></i>
                                                Add
                                            </button>
                                        </div>
                                        <div class="card-body" style="padding:0;">
                                            <div class="table-wrapper" style="padding:1rem;">
                                                <table id="workScheduleConfigTable" style="width:100%;font-size:.65rem;">
                                                    <thead>
                                                        <tr>
                                                            <th style="width:200px;">Name</th>
                                                            <th>Type</th>
                                                            <th>Pattern</th>
                                                            <th>Days / Rotation</th>
                                                            <th style="white-space:nowrap;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="workScheduleConfigTableBody"></tbody>
                                                </table>
                                                <div id="workScheduleConfigEmpty" style="display:block;text-align:center;color:#64748b;padding:.75rem;font-size:.65rem;">No schedules yet. Use Add to define work schedules.</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>

                        <!-- Sign Documents Tab -->
                        <div class="tab-pane" id="sign">
                            <div class="tab-card">
                                <div class="tab-card-body">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <div>
                                            <strong>Sign Documents</strong>
                                            <div style="color:#6c757d; font-size:0.85rem;">Upload PDF files, add signatures and stamps, then download</div>
                                        </div>
                                    </div>
                                    
                                    <!-- PDF Upload moved into sidebar -->
                                    
                                    <!-- PDF Viewer and Signing Area -->
                                    <div id="signWorkspace" style="display:block;">
                                        <div class="sign-layout" style="display:flex; gap:12px; align-items:stretch;">
                                            <!-- Left Tools Sidebar -->
                                            <aside class="sign-sidebar" style="width:260px; min-width:240px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:10px;">
                                                <div class="panel" style="border:none;">
                                                    <div class="panel-header" style="background:#eef2f7; border-bottom:1px solid #e2e8f0; border-radius:6px;">
                                                        <h2 style="font-size:0.8rem; margin:0; color:#334155;">Upload PDF</h2>
                                                    </div>
                                                    <div class="panel-body" style="padding:0.5rem; display:flex; flex-direction:column; gap:8px; align-items:center;">
                                                        <div class="pdf-drop-zone" id="pdfDropZone" style="border:2px dashed #cbd5e1; border-radius:12px; padding:0.75rem; text-align:center; cursor:pointer; transition:all 0.2s; background:#f8fafc; display:inline-flex; flex-direction:column; align-items:center; max-width:240px; width:100%; box-sizing:border-box;">
                                                            <i class="fas fa-file-pdf" style="font-size:1.6rem; color:#dc2626; margin-bottom:0.5rem;"></i>
                                                            <div style="font-weight:600; margin-bottom:0.25rem;">Drop PDF or click</div>
                                                            <div style="color:#64748b; font-size:0.78rem;">Supported: PDF</div>
                                                            <input type="file" id="pdfFileInput" accept=".pdf,application/pdf" style="display:none;">
                                                        </div>
                                                        <div id="pdfFileInfo" style="display:none; width:100%; padding:0.6rem; background:#f1f5f9; border-radius:8px; font-size:0.8rem; display:flex; align-items:center; justify-content:space-between;">
                                                            <span id="pdfFileName"></span>
                                                            <button type="button" id="removePdfBtn" style="margin-left:0.5rem; background:none; border:none; color:#dc2626; cursor:pointer;"><i class="fas fa-times"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="panel" style="border:none;">
                                                    <div class="panel-header" style="background:#eef2f7; border-bottom:1px solid #e2e8f0; border-radius:6px;">
                                                        <h2 style="font-size:0.8rem; margin:0; color:#334155;">Navigation</h2>
                                                    </div>
                                                    <div class="panel-body" style="padding:0.5rem;">
                                                        <div style="display:flex; gap:0.4rem; align-items:center; justify-content:space-between;">
                                                            <button type="button" id="prevPageBtn" class="btn-outline-sm" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
                                                            <span style="font-size:0.75rem; min-width:80px; text-align:center;"><span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                                                            <button type="button" id="nextPageBtn" class="btn-outline-sm" title="Next Page"><i class="fas fa-chevron-right"></i></button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="panel" style="border:none;">
                                                    <div class="panel-header" style="background:#eef2f7; border-bottom:1px solid #e2e8f0; border-radius:6px;">
                                                        <h2 style="font-size:0.8rem; margin:0; color:#334155;">Zoom</h2>
                                                    </div>
                                                    <div class="panel-body" style="padding:0.5rem;">
                                                        <div style="display:flex; gap:0.4rem; align-items:center; justify-content:space-between;">
                                                            <button type="button" id="zoomOutBtn" class="btn-outline-sm" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                                                            <span id="zoomLevel" style="font-size:0.75rem; min-width:50px; text-align:center;">100%</span>
                                                            <button type="button" id="zoomInBtn" class="btn-outline-sm" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="panel" style="border:none;">
                                                    <div class="panel-header" style="background:#eef2f7; border-bottom:1px solid #e2e8f0; border-radius:6px;">
                                                        <h2 style="font-size:0.8rem; margin:0; color:#334155;">Add Elements</h2>
                                                    </div>
                                                    <div class="panel-body" style="padding:0.5rem; display:flex; flex-direction:column; gap:6px;">
                                                        <button type="button" id="addSignatureBtn" class="btn-primary-sm" style="display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-signature"></i> Add Signature</button>
                                                        <button type="button" id="addStampBtn" class="btn-primary-sm" style="display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-stamp"></i> Add Stamp</button>
                                                        <button type="button" id="uploadImageBtn" class="btn-primary-sm" style="display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-image"></i> Upload Image</button>
                                                        <input type="file" id="stampImageInput" accept="image/*" style="display:none;">
                                                        <button type="button" id="addTextBtn" class="btn-outline-sm" style="display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-font"></i> Add Text</button>
                                                        <button type="button" id="addDateBtn" class="btn-outline-sm" style="display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-calendar"></i> Add Date</button>
                                                    </div>
                                                </div>

                                                <div class="panel" style="border:none;">
                                                    <div class="panel-header" style="background:#eef2f7; border-bottom:1px solid #e2e8f0; border-radius:6px;">
                                                        <h2 style="font-size:0.8rem; margin:0; color:#334155;">Actions</h2>
                                                    </div>
                                                    <div class="panel-body" style="padding:0.5rem; display:flex; flex-direction:column; gap:6px;">
                                                        <div style="display:flex; gap:6px;">
                                                            <button type="button" id="undoSignBtn" class="btn-outline-sm" title="Undo Last"><i class="fas fa-undo"></i></button>
                                                            <button type="button" id="clearAllBtn" class="btn-outline-sm" style="color:#dc2626;" title="Clear All"><i class="fas fa-trash-alt"></i></button>
                                                        </div>
                                                        <button type="button" id="downloadSignedPdfBtn" class="btn-primary" style="display:inline-flex; align-items:center; gap:6px; justify-content:center;">
                                                            <i class="fas fa-download"></i> Download Signed PDF
                                                        </button>
                                                    </div>
                                                </div>
                                            </aside>

                                            <!-- Right Viewer Area -->
                                            <section class="sign-viewer" style="flex:1; border:1px solid #e2e8f0; border-radius:8px; overflow:auto; background:#525659; max-height:600px;">
                                                <div id="pdfViewerContainer" style="position:relative;">
                                                    <div id="pdfCanvasWrapper" style="position:relative; display:inline-block; margin:20px;">
                                                        <canvas id="pdfCanvas"></canvas>
                                                        <div id="signatureOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>
                                                    </div>
                                                </div>
                                            </section>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

            <!-- Signature Draw Modal -->
            <div class="signature-modal" id="signatureDrawModal">
                <div class="signature-modal-content">
                    <div class="signature-modal-header">
                        <h3><i class="fas fa-signature"></i> Draw Signature</h3>
                        <button type="button" id="closeSignatureModal" style="background:none; border:none; font-size:1.1rem; cursor:pointer; color:#64748b;">&times;</button>
                    </div>
                    <div class="signature-modal-body">
                        <div style="margin-bottom:0.75rem; display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
                            <div style="display:flex; align-items:center; gap:0.35rem;">
                                <label style="font-size:0.72rem; font-weight:600;">Color:</label>
                                <input type="color" id="signatureColor" value="#000080" style="width:32px; height:28px; border:none; cursor:pointer;">
                            </div>
                            <div style="display:flex; align-items:center; gap:0.35rem;">
                                <label style="font-size:0.72rem; font-weight:600;">Size:</label>
                                <input type="range" id="signatureSize" min="1" max="8" value="3" style="width:80px;">
                            </div>
                            <button type="button" id="clearSignatureCanvas" class="btn-outline-sm"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="signature-canvas-wrap">
                            <canvas id="signatureDrawCanvas"></canvas>
                        </div>
                        <div style="font-size:0.7rem; color:#64748b; margin-top:0.5rem; text-align:center;">Draw your signature above using mouse or touch</div>
                    </div>
                    <div class="signature-modal-footer">
                        <button type="button" id="cancelSignatureBtn" class="btn-outline-sm">Cancel</button>
                        <button type="button" id="useSignatureBtn" class="btn-primary-sm"><i class="fas fa-check"></i> Use Signature</button>
                    </div>
                </div>
            </div>

            <!-- Stamp Selector Modal -->
            <div class="stamp-selector-modal" id="stampSelectorModal">
                <div class="stamp-selector-content">
                    <div class="stamp-selector-header">
                        <h3><i class="fas fa-stamp"></i> Select Stamp</h3>
                        <button type="button" id="closeStampSelectorModal" style="background:none; border:none; font-size:1.1rem; cursor:pointer; color:#64748b;">&times;</button>
                    </div>
                    <div class="stamp-selector-body">
                        <div class="stamp-grid" id="stampGrid">
                            <div style="grid-column:1/-1; text-align:center; color:#64748b; padding:2rem;">
                                <i class="fas fa-spinner fa-spin" style="font-size:1.5rem; margin-bottom:0.5rem;"></i>
                                <div>Loading stamps...</div>
                            </div>
                        </div>
                    </div>
                    <div style="padding:1rem; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:0.5rem;">
                        <button type="button" id="cancelStampBtn" class="btn-outline-sm">Cancel</button>
                        <button type="button" id="useStampBtn" class="btn-primary-sm" disabled><i class="fas fa-check"></i> Use Stamp</button>
                    </div>
                </div>
            </div>

            <!-- Text Input Modal -->
            <div class="text-input-modal" id="textInputModal">
                <div style="background:#fff; border-radius:12px; width:90%; max-width:400px; overflow:hidden;">
                    <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; font-size:0.95rem; display:flex; align-items:center; gap:0.5rem;"><i class="fas fa-font"></i> Add Text</h3>
                        <button type="button" id="closeTextInputModal" style="background:none; border:none; font-size:1.1rem; cursor:pointer; color:#64748b;">&times;</button>
                    </div>
                    <div style="padding:1rem;">
                        <div style="margin-bottom:0.75rem;">
                            <label style="font-size:0.72rem; font-weight:600; display:block; margin-bottom:0.35rem;">Text</label>
                            <input type="text" id="textInputField" placeholder="Enter text..." style="width:100%; padding:0.5rem; border:1px solid #e2e8f0; border-radius:6px; font-size:0.85rem;">
                        </div>
                        <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                            <div style="flex:1; min-width:100px;">
                                <label style="font-size:0.72rem; font-weight:600; display:block; margin-bottom:0.35rem;">Font Size</label>
                                <select id="textFontSize" style="width:100%; padding:0.4rem; border:1px solid #e2e8f0; border-radius:6px; font-size:0.8rem;">
                                    <option value="12">12px</option>
                                    <option value="14">14px</option>
                                    <option value="16" selected>16px</option>
                                    <option value="18">18px</option>
                                    <option value="20">20px</option>
                                    <option value="24">24px</option>
                                </select>
                            </div>
                            <div style="flex:1; min-width:100px;">
                                <label style="font-size:0.72rem; font-weight:600; display:block; margin-bottom:0.35rem;">Color</label>
                                <input type="color" id="textInputColor" value="#000000" style="width:100%; height:32px; border:1px solid #e2e8f0; border-radius:6px; cursor:pointer;">
                            </div>
                        </div>
                    </div>
                    <div style="padding:1rem; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:0.5rem;">
                        <button type="button" id="cancelTextInputBtn" class="btn-outline-sm">Cancel</button>
                        <button type="button" id="addTextToDocBtn" class="btn-primary-sm"><i class="fas fa-plus"></i> Add Text</button>
                    </div>
                </div>
            </div>

            <!-- Leave Request Modal -->
            <div id="leaveRequestModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                <div style="background:#ffffff; width:100%; max-width:560px; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.18); display:flex; flex-direction:column; max-height:90vh;">
                    <div style="padding:16px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:600; display:flex; align-items:center; gap:6px; font-size:0.9rem;"><i class="fas fa-plane-departure"></i> New Leave Request</div>
                        <button type="button" onclick="profileManager.closeLeaveModal()" style="background:none; border:none; cursor:pointer; font-size:1rem; color:#64748b;" aria-label="Close leave request modal"></button>
                    </div>
                    <form id="leaveModalForm" style="padding:20px; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px;">
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="leaveTypeModal" style="font-size:0.7rem; font-weight:600;">Leave Type <span style="color:#dc3545;">*</span></label>
                            <select id="leaveTypeModal" required style="padding:6px 8px; font-size:0.75rem; border:1px solid #e2e8f0; border-radius:6px;">
                                <option value="">Select type</option>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="casual">Casual Leave</option>
                                <option value="maternity">Maternity Leave</option>
                                <option value="paternity">Paternity Leave</option>
                                <option value="bereavement">Bereavement Leave</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="leaveStartModal" style="font-size:0.7rem; font-weight:600;">Start Date <span style="color:#dc3545;">*</span></label>
                            <input type="date" id="leaveStartModal" required style="padding:6px 8px; font-size:0.75rem; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="leaveEndModal" style="font-size:0.7rem; font-weight:600;">End Date <span style="color:#dc3545;">*</span></label>
                            <input type="date" id="leaveEndModal" required style="padding:6px 8px; font-size:0.75rem; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div class="form-group" style="grid-column:1/-1; display:flex; flex-direction:column; gap:4px;">
                            <label for="leaveReasonModal" style="font-size:0.7rem; font-weight:600;">Reason / Notes</label>
                            <textarea id="leaveReasonModal" rows="3" placeholder="Provide a short reason or any notes..." style="padding:6px 8px; font-size:0.75rem; border:1px solid #e2e8f0; border-radius:6px; resize:vertical;"></textarea>
                        </div>
                        <div style="grid-column:1/-1; display:flex; gap:12px; align-items:center;">
                            <button type="submit" class="btn-primary" style="display:inline-flex; align-items:center; gap:6px; font-size:0.7rem; padding:6px 12px;">
                                <i class="fas fa-paper-plane"></i> Submit Request
                            </button>
                            <div id="leaveFormFeedback" style="font-size:0.7rem; color:#64748b;"></div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- View Leave Details Modal -->
            <div id="viewLeaveModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2100; align-items:center; justify-content:center; padding:20px;">
                <div style="background:#ffffff; width:100%; max-width:560px; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.18); display:flex; flex-direction:column; max-height:90vh;">
                    <div style="padding:16px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:600; display:flex; align-items:center; gap:6px; font-size:0.9rem;"><i class="fas fa-file-alt"></i> Leave Details</div>
                        <button type="button" id="closeViewLeaveModal" onclick="profileManager.closeLeaveDetailsModal()" style="background:none; border:none; cursor:pointer; font-size:1rem; color:#64748b;" aria-label="Close leave details modal"></button>
                    </div>
                    <div style="padding:18px 20px; overflow:auto; display:flex; flex-direction:column; gap:16px; font-size:0.75rem;">
                        <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px;">
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Type</div>
                                <div id="viewLeaveType" style="font-weight:500;"></div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Period</div>
                                <div id="viewLeaveDates" style="font-weight:500;"></div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Total Days</div>
                                <div id="viewLeaveDays" style="font-weight:500;"></div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Status</div>
                                <div id="viewLeaveStatus" style="font-weight:500;"></div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Submitter</div>
                                <div id="viewLeaveSubmitterName" style="font-weight:500;">-</div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Job Title</div>
                                <div id="viewLeaveSubmitterJob" style="font-weight:500;">-</div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Department</div>
                                <div id="viewLeaveSubmitterDept" style="font-weight:500;">-</div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Line Manager</div>
                                <div id="viewLeaveLineManager" style="font-weight:500;">-</div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; color:#64748b;">Reason / Notes</div>
                            <div id="viewLeaveReason" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:10px; min-height:46px; white-space:pre-wrap;"></div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600;">Approval Flow</div>
                                <button type="button" onclick="profileManager.renderLeaveApprovalFlowForModal()" style="background:#2563eb; color:#fff; border:none; font-size:0.6rem; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px;"><i class="fas fa-rotate"></i> Refresh</button>
                            </div>
                            <div id="viewLeaveApproversList" style="display:grid; gap:10px;"></div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600;">Approval History</div>
                                <button type="button" onclick="profileManager.renderLeaveApprovalHistoryForModal()" style="background:#2563eb; color:#fff; border:none; font-size:0.6rem; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px;"><i class="fas fa-rotate"></i> Refresh</button>
                            </div>
                            <div id="viewLeaveHistoryList" style="display:grid; gap:10px;"></div>
                        </div>
                        <div id="viewLeaveActions" style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding-top:8px; border-top:1px solid #e2e8f0;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button type="button" id="leavePreviewBtn" onclick="profileManager.openLeavePreview()" style="background:#1f2937; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer;">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button type="button" id="leaveDeleteBtn" onclick="profileManager.deleteCurrentLeave()" style="background:#dc2626; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            <button type="button" id="leaveDeclineBtn" onclick="profileManager.declineCurrentLeave()" style="background:#ef4444; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                <i class="fas fa-times"></i> Decline
                            </button>
                            <button type="button" id="leaveApproveBtn" onclick="profileManager.approveCurrentLeave()" style="background:#10b981; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Work Schedule Modal -->
            <div id="workScheduleModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2100; align-items:center; justify-content:center; padding:20px;">
                <div style="background:#ffffff; width:100%; max-width:640px; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,0.18); display:flex; flex-direction:column; max-height:92vh;">
                    <div style="padding:16px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <div id="workScheduleModalTitle" style="font-weight:600; display:flex; align-items:center; gap:6px; font-size:0.85rem;"><i class="fas fa-calendar-plus"></i> New Work Schedule</div>
                        <button type="button" onclick="workScheduleManager.closeModal()" style="background:none; border:none; cursor:pointer; font-size:1rem; color:#64748b;" aria-label="Close work schedule modal"></button>
                    </div>
                    <form id="workScheduleForm" style="padding:18px 20px; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; font-size:0.7rem;">
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="wsName" style="font-weight:600;">Schedule Name <span style="color:#dc3545;">*</span></label>
                            <input id="wsName" required placeholder="e.g. Day Shift 7-19" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="wsType" style="font-weight:600;">Schedule Type <span style="color:#dc3545;">*</span></label>
                            <select id="wsType" required style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;">
                                <option value="">Select type</option>
                                <option value="fixed-shift">Fixed Shift (Start/End)</option>
                                <option value="weekly-pattern">Weekly Pattern (Days)</option>
                                <option value="rotation">Rotation (Days On/Off)</option>
                            </select>
                        </div>
                        <div id="wsShiftFields" style="display:none; grid-column:1/-1; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px;">
                            <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                                <label for="wsStart" style="font-weight:600;">Start Time <span style="color:#dc3545;">*</span></label>
                                <input type="time" id="wsStart" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                            </div>
                            <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                                <label for="wsEnd" style="font-weight:600;">End Time <span style="color:#dc3545;">*</span></label>
                                <input type="time" id="wsEnd" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                            </div>
                        </div>
                        <div id="wsWeeklyFields" style="display:none; grid-column:1/-1;">
                            <label style="font-weight:600; display:block; margin-bottom:4px;">Working Days (Optional per-day hours)</label>
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Mon" class="wsDay"/> Mon</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Mon start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Mon end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Tue" class="wsDay"/> Tue</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Tue start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Tue end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Wed" class="wsDay"/> Wed</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Wed start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Wed end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Thu" class="wsDay"/> Thu</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Thu start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Thu end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Fri" class="wsDay"/> Fri</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Fri start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Fri end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Sat" class="wsDay"/> Sat</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Sat start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Sat end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                                <div class="ws-day-item" style="display:flex;align-items:center;gap:8px;font-size:.65rem;flex-wrap:wrap;">
                                    <label style="display:flex;align-items:center;gap:4px;"><input type="checkbox" value="Sun" class="wsDay"/> Sun</label>
                                    <div class="ws-day-hours" style="display:none;align-items:center;gap:4px;">
                                        <input type="time" class="wsDayStart" aria-label="Sun start" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        <span style="font-size:.55rem;color:#64748b;">to</span>
                                        <input type="time" class="wsDayEnd" aria-label="Sun end" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="wsRotationFields" style="display:none; grid-column:1/-1; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px;">
                            <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                                <label for="wsDaysOn" style="font-weight:600;">Days On <span style="color:#dc3545;">*</span></label>
                                <input type="number" min="1" id="wsDaysOn" placeholder="e.g. 4" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                            </div>
                            <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                                <label for="wsDaysOff" style="font-weight:600;">Days Off <span style="color:#dc3545;">*</span></label>
                                <input type="number" min="1" id="wsDaysOff" placeholder="e.g. 4" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                            </div>
                            <div class="form-group" style="grid-column:1/-1; display:flex; flex-direction:column; gap:8px;">
                                <label style="font-weight:600;">Rotation Pattern (4-day groups)</label>
                                <div id="wsRotationBlocks" style="display:flex; flex-direction:column; gap:8px;"></div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <button type="button" id="addRotationBlockBtn" class="btn-primary" style="font-size:.65rem; padding:.35rem .6rem; display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-plus"></i> Add Block</button>
                                    <small style="color:#64748b;">Each block covers 4 consecutive days in order.</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="wsEffective" style="font-weight:600;">Effective From</label>
                            <input type="date" id="wsEffective" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="wsEndDate" style="font-weight:600;">End Date</label>
                            <input type="date" id="wsEndDate" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div class="form-group" style="grid-column:1/-1; display:flex; flex-direction:column; gap:4px;">
                            <label for="wsNotes" style="font-weight:600;">Notes / Description</label>
                            <textarea id="wsNotes" rows="3" placeholder="Optional: describe intent or constraints..." style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; resize:vertical;"></textarea>
                        </div>
                        <div style="grid-column:1/-1; display:flex; gap:12px; align-items:center;">
                            <button type="submit" class="btn-primary" style="display:inline-flex; align-items:center; gap:6px; font-size:0.7rem; padding:6px 12px;">
                                <i class="fas fa-save"></i> Save Schedule
                            </button>
                            <div id="wsFormFeedback" style="font-size:0.65rem; color:#64748b;"></div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Profile: Add Location Modal -->
            <div id="profileLocationModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2100; align-items:center; justify-content:center; padding:20px;">
                <div style="background:#ffffff; width:100%; max-width:520px; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.18); display:flex; flex-direction:column; max-height:90vh;">
                    <div style="padding:16px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:600; display:flex; align-items:center; gap:6px; font-size:0.9rem;"><i class="fas fa-map-marker-alt"></i> Add Location</div>
                        <button type="button" onclick="profileManager.closeProfileLocationModal()" style="background:none; border:none; cursor:pointer; font-size:1rem; color:#64748b;" aria-label="Close location modal"></button>
                    </div>
                    <form id="profileLocationForm" onsubmit="return false;" style="padding:16px 20px; display:grid; grid-template-columns:1fr; gap:12px;">
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="profileLocationArea" style="font-size:0.7rem; font-weight:600;">Work Area</label>
                            <input id="profileLocationArea" type="text" placeholder="e.g. Operations" style="padding:6px 8px; font-size:0.75rem; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div class="form-group" style="display:flex; flex-direction:column; gap:4px;">
                            <label for="profileLocationName" style="font-size:0.7rem; font-weight:600;">Location Name</label>
                            <input id="profileLocationName" type="text" placeholder="e.g. North Gate" style="padding:6px 8px; font-size:0.75rem; border:1px solid #e2e8f0; border-radius:6px;" />
                        </div>
                        <div id="profileLocationStatus" style="font-size:0.75rem; color:#64748b; display:none;"></div>
                        <div style="display:flex; justify-content:flex-end; gap:8px; padding-top:8px;">
                            <button type="button" class="btn-primary" style="background:#f1f3f5;color:#495057;border:1px solid #ced4da;" onclick="profileManager.closeProfileLocationModal()">Cancel</button>
                            <button type="button" class="btn-primary" onclick="profileManager.submitProfileLocation()">Save</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Profile: Access Control Modal (adapted from fleet.html) -->
            <div id="profileAccessControlModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2100; align-items:center; justify-content:center; padding:20px;">
                <div style="background:#ffffff; width:100%; max-width:640px; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.18); display:flex; flex-direction:column; max-height:90vh;">
                    <div style="padding:12px 16px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:600; display:flex; align-items:center; gap:6px; font-size:0.9rem;"><i class="fas fa-user-shield"></i> Add Access Control User</div>
                        <button type="button" onclick="profileManager.closeProfileAccessControlModal()" style="background:none; border:none; cursor:pointer; font-size:1rem; color:#64748b;" aria-label="Close access control modal"></button>
                    </div>
                    <div style="padding:14px 16px; overflow:auto; display:flex; flex-direction:column; gap:12px;">
                        <div style="display:flex; flex-direction:column; gap:6px;">
                            <label style="font-size:.65rem; font-weight:600;">User</label>
                            <div style="display:flex; gap:.5rem; align-items:stretch; flex-wrap:wrap;">
                                <input id="profileAcUserSearch" type="text" placeholder="Search by name or job title" style="flex:0 0 40%; min-width:160px; padding:.4rem .55rem; border:1px solid #ced4da; border-radius:6px; font-size:.7rem;"/>
                                <select id="profileAcUserSelect" style="flex:1 1 auto; min-width:220px; padding:.45rem .6rem; border:1px solid #ced4da; border-radius:6px; font-size:.7rem;"></select>
                            </div>
                            <small style="font-size:.55rem; color:#64748b;">Type to filter. Only users not already added will appear.</small>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div>
                                <h4 style="margin:0 0 .4rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Tab Visibility</h4>
                            <script>
                            // Work Schedule Manager
                            window.workScheduleManager = (function(){
                                const SCHEDULE_PATH = (companyId)=>`companies/${companyId}/workSchedules`;
                                let schedules = [];
                                let cachedCompanyId = null; // cache to avoid repeated lookups
                                let editingId = null; // current editing schedule id

                                function getCompanyId(){
                                    // Return cached if previously resolved
                                    if(cachedCompanyId) return cachedCompanyId;
                                    let cid = null;
                                    try {
                                        if (window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                                            cid = window.companyDataService.getCurrentCompanyId();
                                        }
                                    } catch(e) { console.warn('CompanyDataService companyId lookup failed', e); }
                                    if(!cid){
                                        // profileManager currentUser.companyId
                                        try { cid = window.profileManager?.currentUser?.companyId || null; } catch(e){ console.warn('profileManager currentUser companyId lookup failed', e); }
                                    }
                                    if(!cid){
                                        // profileManager.companyId (if any)
                                        try { cid = window.profileManager?.companyId || null; } catch(e){ /* ignore */ }
                                    }
                                    if(!cid){
                                        // DOM data attribute
                                        const el = document.querySelector('[data-company-id]');
                                        if(el){ cid = el.getAttribute('data-company-id') || null; }
                                    }
                                    if(!cid){
                                        // LocalStorage explicit key
                                        try { cid = localStorage.getItem('currentCompanyId') || null; } catch(e){ /* ignore */ }
                                    }
                                    if(!cid){
                                        // LocalStorage user object
                                        try {
                                            const cu = localStorage.getItem('currentUser');
                                            if(cu){ cid = JSON.parse(cu)?.companyId || null; }
                                        } catch(e){ console.warn('localStorage currentUser parse failed', e); }
                                    }
                                    if(cid){
                                        cachedCompanyId = cid;
                                        console.debug('[WorkScheduleManager] Resolved companyId:', cid);
                                    } else {
                                        console.warn('[WorkScheduleManager] companyId unresolved after fallbacks');
                                    }
                                    return cid;
                                }

                                function openModal(){
                                    const m = document.getElementById('workScheduleModal');
                                    if(!m) return; m.style.display='flex';
                                    m.querySelector('#workScheduleForm')?.reset();
                                    hideAllTypeSections();
                                    document.getElementById('wsFormFeedback').textContent='';
                                    // Reset per-day hour visibility
                                    document.querySelectorAll('#wsWeeklyFields .ws-day-hours').forEach(h=>{ h.style.display='none'; });
                                    // Reset weekly checkboxes
                                    document.querySelectorAll('#wsWeeklyFields .wsDay').forEach(cb=>{ cb.checked=false; });
                                    // Reset editing state and title
                                    editingId = null;
                                    const title = document.getElementById('workScheduleModalTitle');
                                    if(title){ title.innerHTML = '<i class="fas fa-calendar-plus"></i> New Work Schedule'; }
                                    // Reset rotation blocks
                                    populateRotationBlocks([]);
                                }
                                function closeModal(){
                                    const m = document.getElementById('workScheduleModal');
                                    if(m) m.style.display='none';
                                }

                                function hideAllTypeSections(){
                                    ['wsShiftFields','wsWeeklyFields','wsRotationFields'].forEach(id=>{ const el = document.getElementById(id); if(el){ el.style.display='none'; }});
                                }
                                function handleTypeChange(){
                                    const type = document.getElementById('wsType').value;
                                    hideAllTypeSections();
                                    if(type==='fixed-shift') document.getElementById('wsShiftFields').style.display='grid';
                                    if(type==='fixed-shift' || type==='weekly-pattern') document.getElementById('wsWeeklyFields').style.display='block';
                                    if(type==='rotation'){
                                        document.getElementById('wsRotationFields').style.display='grid';
                                        const cont = document.getElementById('wsRotationBlocks');
                                        if(cont && cont.children.length===0){ populateRotationBlocks([]); }
                                    }
                                }

                                function bindDayHourToggles(){
                                    document.querySelectorAll('#wsWeeklyFields .wsDay').forEach(cb=>{
                                        cb.addEventListener('change', ()=>{
                                            const wrap = cb.closest('.ws-day-item');
                                            const hours = wrap?.querySelector('.ws-day-hours');
                                            if(!hours) return;
                                            if(cb.checked){ hours.style.display='flex'; }
                                            else {
                                                hours.style.display='none';
                                                const s = hours.querySelector('.wsDayStart');
                                                const e = hours.querySelector('.wsDayEnd');
                                                if(s) s.value='';
                                                if(e) e.value='';
                                            }
                                        });
                                    });
                                }

                                function makeRotationBlockEl(idx, block){
                                    const type = (block && block.type) || 'shift';
                                    const start = (block && block.start) || '';
                                    const end = (block && block.end) || '';
                                    const el = document.createElement('div');
                                    el.className = 'ws-rot-block';
                                    el.style.display = 'flex';
                                    el.style.alignItems = 'center';
                                    el.style.gap = '8px';
                                    el.style.flexWrap = 'wrap';
                                    el.innerHTML = `
                                        <span style="font-weight:600; font-size:.65rem;">Block ${idx+1}</span>
                                        <select class="wsRotType" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;">
                                            <option value="shift" ${type==='shift'?'selected':''}>Shift</option>
                                            <option value="off" ${type==='off'?'selected':''}>Off</option>
                                        </select>
                                        <div class="wsRotHours" style="display:${type==='shift'?'inline-flex':'none'}; align-items:center; gap:4px;">
                                            <input type="time" class="wsRotStart" value="${start}" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                            <span style="font-size:.55rem;color:#64748b;">to</span>
                                            <input type="time" class="wsRotEnd" value="${end}" style="padding:4px 6px; border:1px solid #e2e8f0; border-radius:4px;" />
                                        </div>
                                        <button type="button" class="wsRotRemoveBtn" title="Remove block" style="font-size:.55rem; padding:.25rem .45rem; border:1px solid #e2e8f0; border-radius:4px; background:#f8fafc;">Remove</button>
                                    `;
                                    return el;
                                }

                                function resetRotationBlocks(){
                                    const cont = document.getElementById('wsRotationBlocks');
                                    if(cont) cont.innerHTML = '';
                                }

                                function addRotationBlock(block){
                                    const cont = document.getElementById('wsRotationBlocks');
                                    if(!cont) return;
                                    const idx = cont.children.length;
                                    const el = makeRotationBlockEl(idx, block);
                                    cont.appendChild(el);
                                }

                                function populateRotationBlocks(blocks){
                                    resetRotationBlocks();
                                    const arr = Array.isArray(blocks) && blocks.length ? blocks : [];
                                    if(!arr.length){
                                        // Provide a friendly default: Shift + Off sequence
                                        addRotationBlock({type:'shift'});
                                        addRotationBlock({type:'off'});
                                    } else {
                                        arr.forEach((b)=> addRotationBlock(b));
                                    }
                                }

                                function collectRotationBlocks(){
                                    const cont = document.getElementById('wsRotationBlocks');
                                    if(!cont) return [];
                                    const blocks = [];
                                    Array.from(cont.children).forEach(child=>{
                                        const typeSel = child.querySelector('.wsRotType');
                                        const type = typeSel ? typeSel.value : 'shift';
                                        if(type==='off'){
                                            blocks.push({ type:'off' });
                                        } else {
                                            const s = child.querySelector('.wsRotStart')?.value || '';
                                            const e = child.querySelector('.wsRotEnd')?.value || '';
                                            blocks.push({ type:'shift', start:s, end:e });
                                        }
                                    });
                                    return blocks;
                                }

                                async function loadSchedules(){
                                    const companyId = getCompanyId();
                                    if(!companyId || !window.firebase || !firebase.database){ return; }
                                    const ref = firebase.database().ref(SCHEDULE_PATH(companyId));
                                    ref.on('value', snap => {
                                        schedules = [];
                                        if(snap.exists()){
                                            const val = snap.val();
                                            Object.entries(val).forEach(([id, data])=>{
                                                schedules.push(Object.assign({id}, data));
                                            });
                                        }
                                        renderTable();
                                    });
                                }

                                function summarizeSchedule(s){
                                    if(s.dayHours && Object.keys(s.dayHours).length){
                                        const ordered = Array.isArray(s.daysOfWeek) ? s.daysOfWeek : Object.keys(s.dayHours);
                                        return ordered.map(d=>{
                                            const h = s.dayHours[d]||{}; return `${d} ${(h.start||'?')}-${(h.end||'?')}`;
                                        }).join(' / ');
                                    }
                                    if(s.type==='rotation' && Array.isArray(s.rotationPattern) && s.rotationPattern.length){
                                        const blk = s.rotation?.blockSize || 4;
                                        return s.rotationPattern.map(b=> b.type==='off' ? `${blk}d Off` : `${blk}d ${(b.start||'?')}-${(b.end||'?')}`).join(', ');
                                    }
                                    if(s.type==='fixed-shift') return `${s.startTime||'?'}-${s.endTime||'?'} ${Array.isArray(s.daysOfWeek)?s.daysOfWeek.join('/'):'Days?'}`;
                                    if(s.type==='weekly-pattern') return Array.isArray(s.daysOfWeek)?s.daysOfWeek.join(', '):'No days';
                                    if(s.type==='rotation') return `${s.rotation?.daysOn||'?'} on / ${s.rotation?.daysOff||'?'} off`;
                                    return 'N/A';
                                }

                                function renderTable(){
                                    const tbody = document.getElementById('workScheduleConfigTableBody');
                                    const empty = document.getElementById('workScheduleConfigEmpty');
                                    if(!tbody) return;
                                    tbody.innerHTML='';
                                    if(!schedules.length){ if(empty) empty.style.display='block'; return; } else if(empty) empty.style.display='none';
                                    schedules.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                                    schedules.forEach(s=>{
                                        const tr = document.createElement('tr');
                                        tr.innerHTML = `
                                            <td><strong>${escapeHtml(s.name||'')}</strong></td>
                                            <td style="text-transform:capitalize;">${(s.type||'').replace('-', ' ') || 'N/A'}</td>
                                            <td>${escapeHtml(summarizeSchedule(s))}</td>
                                            <td>${s.type==='rotation' ? `${s.rotation?.daysOn||'?'} / ${s.rotation?.daysOff||'?'} days` : (Array.isArray(s.daysOfWeek)? s.daysOfWeek.join('/') : '-')}</td>
                                            <td style="white-space:nowrap;">
                                                <button class="btn-primary" style="font-size:.55rem;padding:.3rem .5rem;" title="Edit" data-edit="${s.id}"><i class="fas fa-edit"></i></button>
                                                <button class="btn-primary" style="font-size:.55rem;padding:.3rem .5rem;" title="Delete" data-del="${s.id}"><i class="fas fa-trash"></i></button>
                                            </td>`;
                                        tbody.appendChild(tr);
                                    });
                                }

                                function escapeHtml(str){
                                    return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
                                }

                                function setWeeklyDayState(day, checked, startVal, endVal){
                                    const items = Array.from(document.querySelectorAll('#wsWeeklyFields .ws-day-item'));
                                    const item = items.find(w => w.querySelector('.wsDay')?.value === day);
                                    if(!item) return;
                                    const cb = item.querySelector('.wsDay');
                                    const hours = item.querySelector('.ws-day-hours');
                                    const s = item.querySelector('.wsDayStart');
                                    const e = item.querySelector('.wsDayEnd');
                                    cb.checked = !!checked;
                                    if(cb.checked){
                                        if(hours) hours.style.display='flex';
                                        if(s && startVal) s.value = startVal;
                                        if(e && endVal) e.value = endVal;
                                    } else {
                                        if(hours) hours.style.display='none';
                                        if(s) s.value='';
                                        if(e) e.value='';
                                    }
                                }

                                function editSchedule(id){
                                    const s = schedules.find(x=>x.id===id);
                                    if(!s) return;
                                    const m = document.getElementById('workScheduleModal');
                                    if(!m) return;
                                    editingId = id;
                                    m.style.display='flex';
                                    const title = document.getElementById('workScheduleModalTitle');
                                    if(title){ title.innerHTML = '<i class="fas fa-edit"></i> Edit Work Schedule'; }
                                    // Reset form
                                    m.querySelector('#workScheduleForm')?.reset();
                                    document.getElementById('wsFormFeedback').textContent='';
                                    // Populate values
                                    document.getElementById('wsName').value = s.name || '';
                                    const typeSel = document.getElementById('wsType');
                                    typeSel.value = s.type || '';
                                    handleTypeChange();
                                    // Reset weekly UI
                                    document.querySelectorAll('#wsWeeklyFields .wsDay').forEach(cb=>{ cb.checked=false; });
                                    document.querySelectorAll('#wsWeeklyFields .ws-day-hours').forEach(h=>{ h.style.display='none'; });
                                    // Fixed shift times
                                    if(s.type==='fixed-shift'){
                                        const wsStart = document.getElementById('wsStart');
                                        const wsEnd = document.getElementById('wsEnd');
                                        if(wsStart) wsStart.value = s.startTime || '';
                                        if(wsEnd) wsEnd.value = s.endTime || '';
                                    }
                                    // Days & per-day hours
                                    const dayList = Array.isArray(s.daysOfWeek) ? s.daysOfWeek : [];
                                    const hoursMap = s.dayHours || {};
                                    const allDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                                    allDays.forEach(d=>{
                                        const hasDay = dayList.includes(d) || (hoursMap && hoursMap[d]);
                                        const h = hoursMap[d] || {};
                                        setWeeklyDayState(d, hasDay, h.start || '', h.end || '');
                                    });
                                    // Rotation
                                    if(s.type==='rotation'){
                                        const on = document.getElementById('wsDaysOn');
                                        const off = document.getElementById('wsDaysOff');
                                        if(on) on.value = s.rotation?.daysOn || '';
                                        if(off) off.value = s.rotation?.daysOff || '';
                                        populateRotationBlocks(Array.isArray(s.rotationPattern)? s.rotationPattern : []);
                                    }
                                    // Dates & notes
                                    const eff = document.getElementById('wsEffective');
                                    const to = document.getElementById('wsEndDate');
                                    const notes = document.getElementById('wsNotes');
                                    if(eff) eff.value = s.effectiveFrom || '';
                                    if(to) to.value = s.effectiveTo || '';
                                    if(notes) notes.value = s.notes || '';
                                }

                                async function saveSchedule(e){
                                    e.preventDefault();
                                    const feedback = document.getElementById('wsFormFeedback');
                                    feedback.textContent='';
                                    const name = document.getElementById('wsName').value.trim();
                                    const type = document.getElementById('wsType').value;
                                    if(!name || !type){ feedback.textContent='Please complete required fields.'; return; }
                                    const companyId = getCompanyId();
                                    if(!companyId){
                                        feedback.textContent='Cannot resolve company context. Please reload profile.';
                                        feedback.style.color='#dc2626';
                                        return;
                                    }
                                    if(!window.firebase || !firebase.database){
                                        feedback.textContent='Firebase not initialized.';
                                        feedback.style.color='#dc2626';
                                        return;
                                    }
                                    const start = document.getElementById('wsStart').value;
                                    const end = document.getElementById('wsEnd').value;
                                    const days = Array.from(document.querySelectorAll('.wsDay:checked')).map(cb=>cb.value);
                                    // Collect per-day hours if provided
                                    const dayHours = {};
                                    days.forEach(d=>{
                                        const wrapper = Array.from(document.querySelectorAll('#wsWeeklyFields .ws-day-item')).find(w=> w.querySelector('.wsDay')?.value===d);
                                        if(wrapper){
                                            const startI = wrapper.querySelector('.wsDayStart');
                                            const endI = wrapper.querySelector('.wsDayEnd');
                                            if(startI?.value && endI?.value){
                                                dayHours[d] = { start: startI.value, end: endI.value };
                                            }
                                        }
                                    });
                                    const daysOn = document.getElementById('wsDaysOn').value;
                                    const daysOff = document.getElementById('wsDaysOff').value;
                                    const effective = document.getElementById('wsEffective').value;
                                    const endDate = document.getElementById('wsEndDate') ? document.getElementById('wsEndDate').value : '';
                                    const notes = document.getElementById('wsNotes').value.trim();

                                    // Validation by type
                                    if(type==='fixed-shift'){ if(!start || !end || !days.length){ feedback.textContent='Provide start/end times and at least one day.'; return; } }
                                    if(type==='weekly-pattern'){ if(!days.length){ feedback.textContent='Select working days.'; return; } }
                                    if(effective && endDate){
                                        const sD = new Date(effective);
                                        const eD = new Date(endDate);
                                        if(eD < sD){
                                            feedback.textContent='End date cannot be before start date.';
                                            feedback.style.color='#dc2626';
                                            return;
                                        }
                                    }
                                    if(type==='rotation'){
                                        if(!daysOn || !daysOff){ feedback.textContent='Provide days on and days off.'; return; }
                                        const rotBlocks = collectRotationBlocks();
                                        if(!rotBlocks.length){ feedback.textContent='Add at least one rotation block.'; return; }
                                        for(const b of rotBlocks){
                                            if(b.type==='shift' && (!b.start || !b.end)){
                                                feedback.textContent='Provide start/end times for shift blocks.'; return;
                                            }
                                        }
                                    }

                                    const existing = editingId ? schedules.find(x=>x.id===editingId) : null;
                                    const id = editingId || `ws_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;
                                    const rotBlocksToSave = (type==='rotation') ? collectRotationBlocks() : null;
                                    const data = {
                                        id,
                                        name,
                                        type,
                                        startTime: type==='fixed-shift'? start : '',
                                        endTime: type==='fixed-shift'? end : '',
                                        daysOfWeek: (type==='fixed-shift' || type==='weekly-pattern') ? days : [],
                                        rotation: type==='rotation' ? { daysOn: Number(daysOn), daysOff: Number(daysOff), blockSize: 4 } : null,
                                        rotationPattern: rotBlocksToSave,
                                        dayHours: Object.keys(dayHours).length ? dayHours : null,
                                        effectiveFrom: effective || null,
                                        effectiveTo: endDate || null,
                                        notes: notes || '',
                                        createdAt: existing?.createdAt || new Date().toISOString(),
                                        createdBy: existing?.createdBy || (window.profileManager?.currentUserId) || 'unknown',
                                        updatedAt: existing ? new Date().toISOString() : null
                                    };
                                    try {
                                        await firebase.database().ref(SCHEDULE_PATH(companyId)).child(id).set(data);
                                        feedback.style.color='#059669';
                                        feedback.textContent='Saved successfully.';
                                        setTimeout(()=>{ closeModal(); }, 600);
                                        editingId = null;
                                    } catch(err){
                                        console.error('Failed to save schedule', err);
                                        feedback.style.color='#dc2626';
                                        feedback.textContent='Save failed.';
                                    }
                                }

                                async function deleteSchedule(id){
                                    const companyId = getCompanyId();
                                    if(!companyId || !window.firebase || !firebase.database) return;
                                    if(!confirm('Delete this work schedule?')) return;
                                    try {
                                        await firebase.database().ref(SCHEDULE_PATH(companyId)).child(id).remove();
                                    } catch(err){ console.error('Delete failed', err); }
                                }

                                function wireEvents(){
                                    const addBtn = document.getElementById('workScheduleAddBtn');
                                    if(addBtn) addBtn.addEventListener('click', openModal);
                                    const form = document.getElementById('workScheduleForm');
                                    if(form) form.addEventListener('submit', saveSchedule);
                                    const typeSelect = document.getElementById('wsType');
                                    if(typeSelect) typeSelect.addEventListener('change', handleTypeChange);
                                    const addRotBtn = document.getElementById('addRotationBlockBtn');
                                    if(addRotBtn) addRotBtn.addEventListener('click', ()=> addRotationBlock({type:'shift'}));
                                    const rotCont = document.getElementById('wsRotationBlocks');
                                    if(rotCont){
                                        rotCont.addEventListener('click', (e)=>{
                                            const rm = e.target.closest('.wsRotRemoveBtn');
                                            if(rm){
                                                const item = e.target.closest('.ws-rot-block');
                                                if(item && item.parentElement){ item.parentElement.removeChild(item); }
                                                // Reindex labels
                                                Array.from(rotCont.children).forEach((child, i)=>{
                                                    const label = child.querySelector('span');
                                                    if(label) label.textContent = `Block ${i+1}`;
                                                });
                                            }
                                        });
                                        rotCont.addEventListener('change', (e)=>{
                                            const typeSel = e.target.closest('.wsRotType');
                                            if(typeSel){
                                                const item = e.target.closest('.ws-rot-block');
                                                const hours = item?.querySelector('.wsRotHours');
                                                if(hours){ hours.style.display = (typeSel.value==='shift') ? 'inline-flex' : 'none'; }
                                            }
                                        });
                                    }
                                    const tbody = document.getElementById('workScheduleConfigTableBody');
                                    if(tbody) tbody.addEventListener('click', e=>{
                                        const delBtn = e.target.closest('button[data-del]');
                                        if(delBtn){ deleteSchedule(delBtn.getAttribute('data-del')); return; }
                                        const editBtn = e.target.closest('button[data-edit]');
                                        if(editBtn){ editSchedule(editBtn.getAttribute('data-edit')); return; }
                                    });
                                    bindDayHourToggles();
                                }

                                document.addEventListener('DOMContentLoaded', ()=>{
                                    wireEvents();
                                    loadSchedules();
                                });

                                return { openModal, closeModal };
                            })();
                            </script>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; font-size:.6rem;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabPersonal" checked> Personal Info</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabSecurity" checked> Security</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabActivity" checked> Activity</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabPreferences" checked> Preferences</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabTimesheet" checked> Timesheets</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabPayslip" checked> Payslips</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabLeave" checked> Leave</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabSettings" checked> Settings</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTabSign" checked> Sign Documents</label>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin:0 0 .4rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Profile Actions</h4>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; font-size:.6rem;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcProfileEditBio" checked> Edit Bio</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcProfileChangePassword" checked> Change Password</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcProfileUploadAvatar" checked> Upload Avatar</label>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin:0 0 .4rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Timesheet Actions</h4>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; font-size:.6rem;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTimesheetCreate" checked> Create/Edit</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTimesheetSubmit" checked> Submit</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTimesheetApprove" checked> Approve</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcTimesheetDecline" checked> Decline</label>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin:0 0 .4rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Leave Actions</h4>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; font-size:.6rem;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcLeaveCreate" checked> Create</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcLeaveApprove" checked> Approve</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcLeaveDecline" checked> Decline</label>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin:0 0 .4rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Payslip Actions</h4>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; font-size:.6rem;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcPayslipView" checked> View</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="profileAcPayslipExport" checked> Export</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="padding:12px 16px; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:.5rem;">
                        <button type="button" class="btn-primary" style="background:#f1f3f5;color:#495057;border:1px solid #ced4da;" onclick="profileManager.closeProfileAccessControlModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="profileManager.saveProfileAccessControlFromModal()" style="display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>
            </div>
    <!-- Firebase Configuration and Scripts -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Profile Management Class
        class ProfileManager {
            constructor() {
                this.currentUser = null;
                this.userStats = {};
                this._nameCache = {}; // cache userId -> displayName
                this.leaveApprovalFlow = null; // cache of leave_request approval flow
                this.companyFieldOptions = {}; // cache for company-scoped field options (e.g., department)
                // Signature state
                this._sig = { inited: false, mode: 'draw', drawing: false, hasSaved: false };
                this.initialize();
            }

            // Normalize and prettify job/role/department titles for display
            prettifyTitle(s) {
                return String(s || '')
                    .replace(/[-_\u2010\u2011\u2012\u2013\u2014\u2015]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .replace(/\b([a-z])/g, (m, c) => c.toUpperCase());
            }

            initialize() {
                this.loadCurrentUser();
                this.setupEventListeners();
                // Prepare signature UI
                this.initSignatureSection();
                // Load company info first, then populate header immediately (like project-list.html)
                this.initHeaderAndProfile();
            }
            
            async initHeaderAndProfile() {
                try {
                    // Apply tab visibility FIRST so all tabs appear at once (no flash)
                    try { await this.applyProfileTabVisibilityFromDb(); } catch {}
                    
                    // Load profile image immediately (for the avatar above tabs)
                    try { await this.loadProfileImage(); } catch {}
                    
                    await this.loadCompanyInfo(); // Load company info first
                    await this.loadUserCompany(); // Load user's company association
                    if (this.currentCompany && (this.currentCompany.companyName || this.currentCompany.name)) {
                        this.updateHeaderBranding();
                    }
                    // Populate user profile dropdown immediately after company loads (like project-list.html)
                    this.populateUserProfileDropdown();
                    
                    // Then load other data
                    await this.loadUserProfile(); // Then load user profile to get company-scoped data
                    await this.loadUserStats();
                    await this.loadUserTimesheets();
                    await this.loadRecentActivity(); // Load activity data
                    await this.updateMenuVisibility(); // Apply menu permissions
                    // Pre-load leave approval flow & history
                    this.loadLeaveApprovalFlow();
                    this.loadRecentLeaveRequests();
                    this.setupLeaveFeature();
                    // Setup settings tab UI and load data
                    this.setupProfileSettingsUI();
                    this.loadProfileLocations();
                    this.loadProfileAccessControl();
                    // Load saved signature preview if available
                    try { await this.loadSavedSignaturePreview(); } catch {}
                } catch (err) {
                    console.error('Error initializing header and profile:', err);
                }
            }

            loadCurrentUser() {
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.currentUser = JSON.parse(storedUser);
                
                // Also check Firebase auth state
                auth.onAuthStateChanged((user) => {
                    if (!user) {
                        console.warn('Firebase auth state: No user authenticated');
                        // Don't redirect immediately, but log for debugging
                    } else {
                        console.log('Firebase auth state: User authenticated:', user.email);
                    }
                });
                
                this.updateProfileHeader();
            }

            // ---- Leave Request Feature ----
            async loadLeaveApprovalFlow() {
                try {
                    if (!this.currentUser || !this.currentUser.companyId) return;
                    const flowSnap = await db.ref(`companies/${this.currentUser.companyId}/approvalFlows/leave_request`).once('value');
                    if (flowSnap.exists()) {
                        this.leaveApprovalFlow = flowSnap.val();
                        console.log('Leave approval flow loaded:', this.leaveApprovalFlow);
                    } else {
                        console.warn('No leave_request approval flow configured');
                        this.leaveApprovalFlow = null;
                    }
                } catch (e) {
                    console.error('Failed to load leave approval flow', e);
                }
            }

            setupLeaveFeature() {
                // Modal open button
                const createBtn = document.getElementById('createLeaveBtn');
                if (createBtn) {
                    createBtn.addEventListener('click', () => this.openLeaveModal());
                }
                // Refresh approvals
                const refreshBtn = document.getElementById('refreshLeaveApprovalsBtn');
                if (refreshBtn) refreshBtn.addEventListener('click', () => this.refreshLeaveApprovalsUI());
                // Form submit inside modal
                const modalForm = document.getElementById('leaveModalForm');
                if (modalForm) {
                    modalForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.submitLeaveRequest();
                    });
                }
                // Close view leave modal
                const closeViewLeaveBtn = document.getElementById('closeViewLeaveModal');
                if (closeViewLeaveBtn) closeViewLeaveBtn.addEventListener('click', () => this.closeLeaveDetailsModal());
            }

            openLeaveModal() {
                const modal = document.getElementById('leaveRequestModal');
                if (!modal) return;
                modal.style.display = 'flex';
                // reset form
                const form = document.getElementById('leaveModalForm');
                if (form) form.reset();
                this.setLeaveFeedback('', false);
            }

            closeLeaveModal() {
                const modal = document.getElementById('leaveRequestModal');
                if (modal) modal.style.display = 'none';
            }

            async submitLeaveRequest() {
                if (!this.currentUser || !this.currentUser.companyId) {
                    this.setLeaveFeedback('Missing company context; cannot submit.', true);
                    return;
                }
                const typeEl = document.getElementById('leaveTypeModal');
                const startEl = document.getElementById('leaveStartModal');
                const endEl = document.getElementById('leaveEndModal');
                const reasonEl = document.getElementById('leaveReasonModal');
                if (!typeEl.value || !startEl.value || !endEl.value) {
                    this.setLeaveFeedback('Please fill required fields (type, start, end).', true);
                    return;
                }
                const startDate = new Date(startEl.value);
                const endDate = new Date(endEl.value);
                if (endDate < startDate) {
                    this.setLeaveFeedback('End date cannot be before start date.', true);
                    return;
                }
                const days = Math.ceil((endDate - startDate) / (1000*60*60*24)) + 1; // inclusive

                // Build approvers list from approval flow (prefer selectedRoles for correct prefixes)
                const approvers = [];
                if (this.leaveApprovalFlow) {
                    const selectedRoles = this.leaveApprovalFlow.selectedRoles || {};
                    const availableRoles = this.leaveApprovalFlow.availableRoles || [];
                    const levelsArr = this.leaveApprovalFlow.levels || [];
                    const hasSelected = Object.keys(selectedRoles).length > 0;
                    const slugify = (s) => String(s||'').trim().toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-');
                    if (hasSelected) {
                        const levelKeys = Object.keys(selectedRoles).sort((a,b) => {
                            const na = parseInt(a.replace(/[^0-9]/g,''))||0; const nb = parseInt(b.replace(/[^0-9]/g,''))||0; return na-nb;
                        });
                        for (const key of levelKeys) {
                            const lvlNum = parseInt(key.replace(/[^0-9]/g,''))||0;
                            const arr = Array.isArray(selectedRoles[key]) ? selectedRoles[key] : [];
                            for (const ap of arr) {
                                const val = ap.value || ap.function || ap.role || '';
                                const text = ap.text || ap.label || ap.name || val;
                                approvers.push({
                                    level: lvlNum,
                                    roleFunction: val,
                                    roleName: text,
                                    status: 'waiting',
                                    decidedAt: null,
                                    decidedBy: null
                                });
                            }
                        }
                    } else if (Array.isArray(levelsArr) && levelsArr.length) {
                        // Legacy fallback: levels only (prefix function roles)
                        for (const lvl of levelsArr) {
                            let roleFunc = lvl.value;
                            let prefixed = roleFunc;
                            if (prefixed && !prefixed.startsWith('user_') && !prefixed.startsWith('function_')) {
                                prefixed = 'function_' + slugify(prefixed);
                            }
                            const roleEntry = availableRoles.find(r => r.function === roleFunc) || null;
                            approvers.push({
                                level: lvl.level,
                                roleFunction: prefixed,
                                roleName: roleEntry ? roleEntry.text : roleFunc,
                                status: 'waiting',
                                decidedAt: null,
                                decidedBy: null
                            });
                        }
                    }
                }

                const newRef = db.ref(`companies/${this.currentUser.companyId}/leaveRequests`).push();
                const leaveData = {
                    id: newRef.key,
                    type: typeEl.value,
                    startDate: startEl.value,
                    endDate: endEl.value,
                    totalDays: days,
                    reason: reasonEl.value || '',
                    status: 'pending',
                    approvers,
                    createdAt: new Date().toISOString(),
                    createdBy: this.currentUser.uid || this.currentUser.userId,
                    employeeId: this.currentUser.uid || this.currentUser.userId,
                };
                try {
                    await newRef.set(leaveData);
                    this.setLeaveFeedback('Leave request submitted.', false);
                    // Close modal and refresh list; hide approval flow section (removed)
                    this.closeLeaveModal();
                    await this.loadRecentLeaveRequests();

                } catch (e) {
                    console.error('Failed to submit leave request', e);
                    this.setLeaveFeedback('Failed to submit request. Try again.', true);
                }
            }

            setLeaveFeedback(msg, isError) {
                const fb = document.getElementById('leaveFormFeedback');
                if (fb) {
                    fb.textContent = msg;
                    fb.style.color = isError ? '#dc3545' : '#28a745';
                }
            }

            renderApprovalFlow(leaveData) {
                const list = document.getElementById('leaveApproversList');
                if (!list) return;
                list.innerHTML = '';
                if (!leaveData.approvers || leaveData.approvers.length === 0) {
                    list.innerHTML = '<div style="color:#6c757d; font-size:0.75rem;">No approval flow configured.</div>';
                    return;
                }
                leaveData.approvers.sort((a,b) => a.level - b.level).forEach(ap => {
                    const card = document.createElement('div');
                    card.style.border = '1px solid #e2e8f0';
                    card.style.borderRadius = '6px';
                    card.style.padding = '10px';
                    card.style.background = '#f9fafb';
                    card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:0.75rem; font-weight:600;">Level ${ap.level}: ${ap.roleName}</div>
                        <span style="font-size:0.7rem; padding:2px 6px; border-radius:4px; background:${ap.status==='approved' ? '#d1fae5' : ap.status==='rejected' ? '#fee2e2' : '#f3f4f6'}; color:${ap.status==='approved' ? '#065f46' : ap.status==='rejected' ? '#991b1b' : '#374151'};">${ap.status}</span>
                    </div>`;
                    list.appendChild(card);
                });
            }

            async refreshLeaveApprovalsUI() {
                if (!this.currentUser || !this.currentUser.companyId) return;
                // Find latest pending request (for simplicity)
                const snap = await db.ref(`companies/${this.currentUser.companyId}/leaveRequests`).orderByChild('createdAt').limitToLast(50).once('value');
                let latest = null; snap.forEach(c => latest = c.val());
                if (latest) {
                    this.renderApprovalFlow(latest);
                    this.setLeaveFeedback('Approval flow refreshed.', false);
                } else {
                    this.setLeaveFeedback('No leave request found to refresh.', true);
                }
            }

            // Determine if current user is allowed to view the given leave request
            // Rules:
            // - Submitter can view
            // - Any approver listed on the leave.approvers can view
            // - Additionally: if the user's name, role/function, or level approver appears in the configured
            //   approval flow (as shown in the modal), they can view submitted leaves too.
            async canUserViewLeave(leave) {
                try {
                    if (!leave || !this.currentUser) return false;
                    const meIds = new Set([this.currentUser.uid, this.currentUser.userId, this.currentUser.id, this.currentUser.employeeId].filter(Boolean));
                    if (meIds.has(leave.createdBy) || meIds.has(leave.employeeId)) return true; // submitter

                    const slugify = (s) => String(s||'')
                        .normalize('NFD')
                        .replace(/\p{Diacritic}+/gu,'')
                        .trim()
                        .toLowerCase()
                        .replace(/[^a-z0-9\s-]/g,'')
                        .replace(/\s+/g,'-');
                    const norm = (s) => String(s||'')
                        .normalize('NFD')
                        .replace(/\p{Diacritic}+/gu,'')
                        .trim()
                        .toLowerCase();
                    // Resolve current user's job title with DB fallback once per session
                    let myJobSlug = this._cachedCurrentUserJobTitleSlug || '';
                    let myJobTitle = this._cachedCurrentUserJobTitle || '';
                    if (!myJobSlug) {
                        const rawJob = (this.currentUser.jobTitle || this.currentUser.title || this.currentUser.designation || this.currentUser.role || '');
                        myJobTitle = rawJob;
                        myJobSlug = slugify(rawJob);
                        try {
                            if (!myJobSlug && this.currentUser.companyId) {
                                const uid = this.currentUser.uid || this.currentUser.userId || this.currentUser.id || '';
                                if (uid) {
                                    let uSnap = await db.ref(`companies/${this.currentUser.companyId}/users/${uid}`).once('value');
                                    let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                    if (!u) {
                                        const allSnap = await db.ref(`companies/${this.currentUser.companyId}/users`).once('value');
                                        if (allSnap.exists()) {
                                            const all = allSnap.val()||{};
                                            for (const [k,v] of Object.entries(all)) {
                                                if (!v) continue;
                                                const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                                if (ids.has(String(uid))) { u = v; break; }
                                            }
                                        }
                                    }
                                    if (u) {
                                        const cand = u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '';
                                        myJobTitle = cand;
                                        myJobSlug = slugify(cand);
                                        this._cachedCurrentUserJobTitleSlug = myJobSlug;
                                        this._cachedCurrentUserJobTitle = myJobTitle;
                                    }
                                }
                            }
                        } catch {}
                        if (!this._cachedCurrentUserJobTitleSlug && myJobSlug) this._cachedCurrentUserJobTitleSlug = myJobSlug;
                        if (!this._cachedCurrentUserJobTitle && myJobTitle) this._cachedCurrentUserJobTitle = myJobTitle;
                    }
                    const myName = norm(this.currentUser.displayName || this.currentUser.name || this.currentUser.email || '');

                    // Check explicit approvers on the leave item (backward compatible)
                    const approvers = Array.isArray(leave.approvers) ? leave.approvers : [];
                    for (const ap of approvers) {
                        const func = String(ap.roleFunction||'').trim();
                        if (!func) continue;
                        if (func.startsWith('user_')) {
                            const uid = func.substring(5);
                            if (meIds.has(uid)) return true;
                        } else if (func.startsWith('function_')) {
                            const fslug = func.substring(9);
                            if (myJobSlug && fslug === myJobSlug) return true;
                        } else {
                            // Legacy: plain job title slug or raw user id
                            const legacySlug = slugify(func);
                            if (legacySlug && myJobSlug && legacySlug === myJobSlug) return true;
                            if (meIds.has(func)) return true;
                        }
                    }

                    // Also allow viewers who match the configured approval flow by job title/function at any status
                    const status = String(leave.status || 'pending').toLowerCase();
                    {
                        const companyId = this.currentUser.companyId;
                        if (companyId) {
                            // Cache the approval flow to avoid repeated fetches per page load
                            if (!this._cachedLeaveApprovalFlow || this._cachedLeaveApprovalFlow.companyId !== companyId) {
                                try {
                                    const flowSnap = await db.ref(`companies/${companyId}/approvalFlows/leave_request`).once('value');
                                    this._cachedLeaveApprovalFlow = {
                                        companyId,
                                        flow: flowSnap.exists() ? (flowSnap.val() || {}) : {}
                                    };
                                } catch(e) {
                                    this._cachedLeaveApprovalFlow = { companyId, flow: {} };
                                }
                            }
                            const flow = this._cachedLeaveApprovalFlow.flow || {};
                            const selectedRoles = flow.selectedRoles || {};
                            const availableLevels = Array.isArray(flow.levels) ? flow.levels : [];
                            const availableRoles = Array.isArray(flow.availableRoles) ? flow.availableRoles : [];
                            const mapRoleValueToText = (val) => {
                                if (!val) return '';
                                const m = availableRoles.find(r => r.function === val);
                                return (m && (m.text || m.name)) || String(val);
                            };

                            // Resolve submitter's line manager (for L+1 handling)
                            let lmId = null, lmNameLower = '';
                            try {
                                const submitterId = leave.employeeId || leave.createdBy || '';
                                if (submitterId) {
                                    let uSnap = await db.ref(`companies/${companyId}/users/${submitterId}`).once('value');
                                    let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                    if (!u) {
                                        const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                        if (allSnap.exists()) {
                                            const all = allSnap.val()||{};
                                            for (const [k,v] of Object.entries(all)) {
                                                if (!v) continue;
                                                const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                                if (ids.has(String(submitterId))) { u = v; break; }
                                            }
                                        }
                                    }
                                    if (u) {
                                        lmId = u.lineManagerId || u.lineManagerUID || u.managerId || u.managerUID || u.supervisorId || u.supervisorUID || null;
                                        lmNameLower = String(u.lineManager || u.lineManagerName || u.managerName || u.supervisorName || '').trim().toLowerCase();
                                    }
                                }
                            } catch {}

                            // Build matching tokens from the flow
                            const myTokens = new Set();
                            // id based token
                            const myUid = this.currentUser.uid || this.currentUser.userId || this.currentUser.id || '';
                            if (myUid) myTokens.add(`user_${myUid}`);
                            // role/function tokens
                            if (myJobSlug) {
                                myTokens.add(`function_${myJobSlug}`);
                                myTokens.add(myJobSlug);
                            }

                            // Check selectedRoles (newer config with explicit approvers per level)
                            const levelKeys = Object.keys(selectedRoles);
                            if (levelKeys.length > 0) {
                                for (const key of levelKeys) {
                                    const approverList = Array.isArray(selectedRoles[key]) ? selectedRoles[key] : [];
                                    // Name-based set for this level
                                    const nameSet = new Set(approverList.map(ap => norm(ap.text)).filter(Boolean));
                                    if (myName && nameSet.has(myName)) return true;
                                    
                                    // Check each approver in this level
                                    for (const ap of approverList) {
                                        const val = String(ap.value || ap.text || '').trim();
                                        if (!val) continue;
                                        
                                        const valLower = val.toLowerCase();
                                        
                                        // User ID token match
                                        if (valLower.startsWith('user_') && myTokens.has(valLower)) return true;
                                        
                                        // Function token match
                                        if (valLower.startsWith('function_') || valLower.startsWith('function-')) {
                                            const base = val.replace(/^function[-_]/i, '');
                                            const baseSlug = slugify(base);
                                            if (myJobSlug && baseSlug === myJobSlug) return true;
                                        }
                                        
                                        // Direct job title match (case-insensitive)
                                        if (myJobTitle && valLower === myJobTitle.toLowerCase()) return true;
                                        
                                        // Slugified comparison
                                        const valSlug = slugify(val);
                                        if (myJobSlug && valSlug === myJobSlug) return true;
                                        
                                        // Try mapping via availableRoles
                                        const mapped = mapRoleValueToText(val);
                                        if (mapped && mapped !== val) {
                                            if (myJobTitle && mapped.toLowerCase() === myJobTitle.toLowerCase()) return true;
                                            const mappedSlug = slugify(mapped);
                                            if (myJobSlug && mappedSlug === myJobSlug) return true;
                                        }
                                    }
                                    // L+1 / Line Manager special-case
                                    const isL1Token = (s)=>{ const v=String(s||'').trim().toLowerCase(); if(!v) return false; return (/^l\+?1$/.test(v) || /^level\+?1$/.test(v) || /^level\s*1$/.test(v) || v==='line manager' || v==='linemanager'); };
                                    const requiresL1 = approverList.some(ap => isL1Token(ap.value) || isL1Token(ap.text));
                                    if (requiresL1) {
                                        if ((lmId && String(lmId) === String(myUid)) || (lmNameLower && lmNameLower === myName)) return true;
                                    }
                                }
                            } else if (availableLevels.length > 0) {
                                // Legacy levels array with role values per level
                                for (const lvl of availableLevels) {
                                    const v = String(lvl?.value || '').trim();
                                    if (!v) continue;
                                    
                                    if (v.startsWith('function_')) {
                                        const bare = v.substring(9);
                                        const bareSlug = slugify(bare);
                                        if (myJobSlug && (v === `function_${myJobSlug}` || bareSlug === myJobSlug)) return true;
                                    } else {
                                        const vv = v.toLowerCase();
                                        if (/^l\+?1$/.test(vv) || /^level\+?1$/.test(vv) || /^level\s*1$/.test(vv) || vv === 'line manager' || vv === 'linemanager') {
                                            if ((lmId && String(lmId) === String(myUid)) || (lmNameLower && lmNameLower === myName)) return true;
                                        }
                                        
                                        // Direct job title match (case-insensitive)
                                        if (myJobTitle && vv === myJobTitle.toLowerCase()) return true;
                                        
                                        // Slugified match
                                        const vSlug = slugify(v);
                                        if (myJobSlug && vSlug === myJobSlug) return true;
                                        
                                        // Try mapping via availableRoles
                                        const mapped = mapRoleValueToText(v);
                                        if (mapped && mapped !== v) {
                                            if (myJobTitle && mapped.toLowerCase() === myJobTitle.toLowerCase()) return true;
                                            const mappedSlug = slugify(mapped);
                                            if (myJobSlug && mappedSlug === myJobSlug) return true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Fallback: if user has a job title that appears anywhere in the flow, allow viewing
                    if (myJobTitle && myJobSlug) {
                        try {
                            // Check if job title appears in any form in the flow configuration
                            const flowStr = JSON.stringify(flow).toLowerCase();
                            const jobTitleLower = myJobTitle.toLowerCase();
                            const jobTitleNorm = norm(myJobTitle);
                            
                            // Multiple matching strategies for maximum compatibility
                            if (flowStr.includes(jobTitleLower) || 
                                flowStr.includes(myJobSlug) || 
                                flowStr.includes(jobTitleNorm) ||
                                flowStr.includes(`"${jobTitleLower}"`) ||
                                flowStr.includes(`"${myJobSlug}"`) ||
                                flowStr.includes(`function_${myJobSlug}`) ||
                                flowStr.includes(`function-${myJobSlug}`)) {
                                return true;
                            }
                            
                            // Also check if any availableRoles text matches our job title
                            if (availableRoles.length > 0) {
                                for (const role of availableRoles) {
                                    const roleText = String(role.text || role.name || '').trim();
                                    if (roleText) {
                                        const roleTextLower = roleText.toLowerCase();
                                        const roleTextNorm = norm(roleText);
                                        const roleTextSlug = slugify(roleText);
                                        if (roleTextLower === jobTitleLower || 
                                            roleTextNorm === jobTitleNorm ||
                                            roleTextSlug === myJobSlug) {
                                            return true;
                                        }
                                    }
                                }
                            }
                        } catch {}
                    }
                    
                    return false;
                } catch(e) { console.warn('canUserViewLeave check failed', e); return false; }
            }

            async loadRecentLeaveRequests() {
                if (!this.currentUser || !this.currentUser.companyId) return;
                try {
                    const tbody = document.getElementById('leaveRequestsTableBody');
                    if (!tbody) return;
                    tbody.innerHTML = '<tr><td colspan="5" style="font-size:0.75rem; color:#6c757d;">Loading...</td></tr>';
                    // Load all company leave requests and filter client-side by visibility rules (submitter or assigned approver)
                    // Note: consider adding server-side pagination if dataset grows large
                    const snap = await db.ref(`companies/${this.currentUser.companyId}/leaveRequests`).once('value');
                    const rows = [];
                    snap.forEach(child => { rows.push({ id: child.key, ...(child.val()||{}) }); });
                    // Evaluate visibility asynchronously (includes approval flow lookups)
                    const checks = await Promise.all(rows.map(r => this.canUserViewLeave(r)));
                    const items = rows.filter((r, i) => !!checks[i]);
                    const toTs = (v) => {
                        if (typeof v === 'number') return v;
                        if (!v) return 0;
                        const n = Number(v);
                        if (!isNaN(n)) return n;
                        const t = Date.parse(String(v));
                        return isNaN(t) ? 0 : t;
                    };
                    items.sort((a,b) => toTs(b.createdAt) - toTs(a.createdAt));
                    tbody.innerHTML = '';
                    if (items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="font-size:0.75rem; color:#6c757d;">No leave requests yet.</td></tr>';
                        return;
                    }
                    items.forEach(r => {
                        const tr = document.createElement('tr');
                        const statusBadge = `<span style="display:inline-block; padding:2px 8px; border-radius:12px; font-size:0.65rem; background:${r.status==='approved'?'#d1fae5':r.status==='rejected'?'#fee2e2':'#f3f4f6'}; color:${r.status==='approved'?'#065f46':r.status==='rejected'?'#991b1b':'#374151'}">${r.status||'pending'}</span>`;
                        tr.innerHTML = `
                            <td style="font-size:0.7rem;">${r.type||'-'}</td>
                            <td style="font-size:0.7rem;">${r.startDate||'?'} </td>
                            <td style="font-size:0.7rem;">${r.endDate||'?'} </td>
                            <td style="font-size:0.7rem; text-align:center;">${r.totalDays||'0'}</td>
                            <td style="font-size:0.7rem;">${statusBadge}</td>
                        `;
                        tr.style.cursor = 'pointer';
                        tr.setAttribute('data-leave-id', r.id);
                        tr.addEventListener('click', () => {
                            if (r.id) this.openLeaveDetailsModal(r.id);
                        });
                        tbody.appendChild(tr);
                    });
                } catch (e) {
                    console.error('Failed to load recent leave requests', e);
                }
            }
            // ---- End Leave Feature ----

            async updateProfileHeader() {
                if (!this.currentUser) return;

                const displayName = this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0];
                const email = this.currentUser.email;
                const role = this.currentUser.role || 'User';

                // Update header elements
                document.getElementById('profileDisplayName').textContent = displayName;
                const emailEl = document.getElementById('profileDisplayEmail');
                if (emailEl) emailEl.textContent = email;
                document.getElementById('profileDisplayRole').textContent = this.formatRole(role);

                // Update profile dropdown
                document.getElementById('profileDropdownName').textContent = displayName;
                document.getElementById('profileDropdownEmail').textContent = email;

                // Update avatar
                this.updateAvatar(displayName);
                
                // Try to load profile image
                await this.loadProfileImage();

                // Reveal header section once hydrated
                const topNav = document.querySelector('.top-nav');
                if (topNav) topNav.classList.remove('header-loading');
            }

            updateAvatar(displayName) {
                const initials = this.getInitials(displayName);
                const profileInitials = document.getElementById('profileInitials');
                
                if (profileInitials) {
                    profileInitials.textContent = initials;
                }
                
                // Update header avatar
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && !userAvatar.querySelector('img[src*="data:image"]')) {
                    // Only update if no profile image is loaded
                    this.generateInitialsAvatar(displayName, userAvatar);
                }
            }

            getInitials(name) {
                if (!name) return 'U';
                const words = name.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            formatRole(role) {
                if (!role) return 'User';
                
                // Handle specific role IDs and convert them to readable names
                const roleMap = {
                    'Guest_mdc6i4y9': 'Guest',
                    'admin': 'Administrator',
                    'manager': 'Manager',
                    'supervisor': 'Supervisor',
                    'employee': 'Employee',
                    'guest': 'Guest',
                    'user': 'User'
                };
                
                // Check if it's a mapped role ID
                const lowerRole = role.toLowerCase();
                if (roleMap[role] || roleMap[lowerRole]) {
                    return roleMap[role] || roleMap[lowerRole];
                }
                
                // If role contains underscore followed by random characters, extract the base role
                if (role.includes('_')) {
                    const baseRole = role.split('_')[0];
                    if (roleMap[baseRole.toLowerCase()]) {
                        return roleMap[baseRole.toLowerCase()];
                    }
                    // Return just the base role name, capitalized
                    return baseRole.charAt(0).toUpperCase() + baseRole.slice(1).toLowerCase();
                }
                
                // Default formatting for other roles (capitalize and replace hyphens with spaces)
                return role.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            generateInitialsAvatar(displayName, imgElement) {
                if (!imgElement || !displayName) return;
                
                const initials = this.getInitials(displayName);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 40;
                
                canvas.width = size;
                canvas.height = size;
                
                // Background circle
                ctx.beginPath();
                ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#3498db';
                ctx.fill();
                
                // Text
                ctx.fillStyle = '#ffffff';
                ctx.font = `${size / 2.5}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, size / 2, size / 2);
                
                imgElement.src = canvas.toDataURL();
                imgElement.alt = `${displayName} Avatar`;
            }

            async loadProfileImage() {
                if (!this.currentUser) return;

                try {
                    // Use the same getUserAvatarUrl method as the header for consistency
                    const imageUrl = await this.getUserAvatarUrl();

                    const profileAvatar = document.getElementById('profileAvatar');
                    const headerBtn = document.getElementById('userProfileBtn');
                    const headerImg = headerBtn ? headerBtn.querySelector('img') : null;

                    if (imageUrl) {
                        // Update profile avatar (keep structure, just show photo + hide overlays)
                        if (profileAvatar) {
                            profileAvatar.classList.add('has-photo');

                            const initialsDiv = document.getElementById('profileInitials');
                            if (initialsDiv) initialsDiv.style.display = 'none';

                            let img = profileAvatar.querySelector('img');
                            if (!img) {
                                img = document.createElement('img');
                                profileAvatar.insertBefore(img, profileAvatar.firstChild);
                            }
                            img.src = imageUrl;
                            img.alt = 'Profile Photo';
                        }

                        // Ensure header uses the same image (real-time)
                        if (headerImg) {
                            headerImg.src = imageUrl;
                            headerImg.alt = (this.currentUser.displayName || this.currentUser.name || 'User') + ' Avatar';
                            headerImg.style.display = 'block';
                        }

                        return;
                    }

                    // No image found: ensure photo mode is off and initials remain
                    if (profileAvatar) profileAvatar.classList.remove('has-photo');
                } catch (e) {
                    console.warn('loadProfileImage failed:', e);
                }
            }

            // Resolve a user ID to a display name with a small cache to avoid repeated DB reads
            async getUserDisplayNameById(uid) {
                if (!uid) return '';
                if (this._nameCache[uid]) return this._nameCache[uid];
                try {
                    // Try global users node first
                    const userSnap = await db.ref(`users/${uid}`).once('value');
                    if (userSnap.exists()) {
                        const u = userSnap.val();
                        const name = u.name || u.displayName || u.email || uid;
                        this._nameCache[uid] = name;
                        return name;
                    }

                    // Try company-scoped users if currentCompany available
                    const companyId = this.currentCompany && this.currentCompany.id ? this.currentCompany.id : (this.currentUser && this.currentUser.companyId ? this.currentUser.companyId : null);
                    if (companyId) {
                        const cSnap = await db.ref(`companies/${companyId}/users/${uid}`).once('value');
                        if (cSnap.exists()) {
                            const cu = cSnap.val();
                            const cname = cu.name || cu.displayName || cu.email || uid;
                            this._nameCache[uid] = cname;
                            return cname;
                        }
                    }

                    // Fallback: use the uid itself
                    this._nameCache[uid] = uid;
                    return uid;
                } catch (err) {
                    console.warn('getUserDisplayNameById error', err);
                    this._nameCache[uid] = uid;
                    return uid;
                }
            }

            // Resolve user by email to display name with caching
            async getUserDisplayNameByEmail(email) {
                if (!email) return '';
                const cacheKey = `email:${email}`;
                if (this._nameCache[cacheKey]) return this._nameCache[cacheKey];
                
                try {
                    const companyId = this.currentCompany && this.currentCompany.id ? this.currentCompany.id : (this.currentUser && this.currentUser.companyId ? this.currentUser.companyId : null);
                    
                    // Try global users first - query by email
                    const globalUsersSnap = await db.ref('users').orderByChild('email').equalTo(email).once('value');
                    if (globalUsersSnap.exists()) {
                        const users = globalUsersSnap.val();
                        const userData = Object.values(users)[0]; // Take first match
                        const name = userData.name || userData.displayName || email;
                        this._nameCache[cacheKey] = name;
                        return name;
                    }

                    // Try company users - query by email
                    if (companyId) {
                        const companyUsersSnap = await db.ref(`companies/${companyId}/users`).orderByChild('email').equalTo(email).once('value');
                        if (companyUsersSnap.exists()) {
                            const users = companyUsersSnap.val();
                            const userData = Object.values(users)[0]; // Take first match
                            const name = userData.name || userData.displayName || email;
                            this._nameCache[cacheKey] = name;
                            return name;
                        }
                    }

                    this._nameCache[cacheKey] = email;
                    return email;
                } catch (e) {
                    console.warn('Error resolving user name for email', email, e);
                    this._nameCache[cacheKey] = email;
                    return email;
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return;

                try {
                    // Load user data from global users path first
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();

                    console.log('Loading user profile data from global path:', userData);

                    // Also try to load user data from company scope if we have company info
                    let companyUserData = null;
                    if (this.currentCompany?.id) {
                        console.log(' Loading user data from company scope...');
                        console.log(' Company ID:', this.currentCompany.id);
                        console.log(' User UID:', this.currentUser.uid);
                        const companyUserRef = db.ref(`companies/${this.currentCompany.id}/users/${this.currentUser.uid}`);
                        const companySnapshot = await companyUserRef.once('value');
                        companyUserData = companySnapshot.val();
                        console.log(' Company user data:', companyUserData);
                        
                        if (!companyUserData) {
                            console.log(' No user data found in company scope - user may not be added to company yet');
                            console.log(' Trying to find user in any company...');
                            
                            // Try to find the user in any company
                            const companiesRef = db.ref('companies');
                            const companiesSnapshot = await companiesRef.once('value');
                            const companiesData = companiesSnapshot.val();
                            
                            if (companiesData) {
                                for (const [companyId, company] of Object.entries(companiesData)) {
                                    if (company.users && company.users[this.currentUser.uid]) {
                                        companyUserData = company.users[this.currentUser.uid];
                                        console.log(` Found user data in company: ${company.companyName || companyId}`);
                                        console.log(' User data from company:', companyUserData);
                                        break;
                                    }
                                }
                            }
                            
                            if (!companyUserData) {
                                console.log(' User not found in any company - using global user data only');
                            }
                        }
                    } else {
                        console.log(' No company information available - cannot load company-scoped user data');
                    }

                    // Merge data with company data taking precedence for department and position
                    const mergedData = {
                        ...(userData || {}),
                        ...(companyUserData && {
                            department: companyUserData.department,
                            // Prefer company job title; also expose raw jobTitle separately
                            jobTitle: companyUserData.jobTitle || userData?.jobTitle,
                            position: companyUserData.jobTitle || companyUserData.position,
                            // Include other company-specific fields if needed
                            phone: companyUserData.phone || userData?.phone,
                            name: companyUserData.name || userData?.name
                        })
                    };

                    console.log(' Merged user data:', mergedData);

                    if (mergedData && Object.keys(mergedData).length > 0) {
                        // Populate form fields with error checking
                        const displayNameField = document.getElementById('displayName');
                        const emailField = document.getElementById('email');
                        const phoneField = document.getElementById('phone');
                        const departmentField = document.getElementById('department');
                        const jobTitleField = document.getElementById('jobTitle');
                        const positionField = document.getElementById('position');
                        const bioField = document.getElementById('bio');
                        
                        if (displayNameField) displayNameField.value = mergedData.name || mergedData.displayName || '';
                        if (emailField) emailField.value = mergedData.email || this.currentUser.email;
                        if (phoneField) phoneField.value = mergedData.phone || '';
                        if (departmentField) {
                            // Resolve department against company-scoped field options to show the configured label
                            try {
                                const deptOptions = await this.loadCompanyFieldOptions('department');
                                const resolvedDept = this.resolveOptionLabel(deptOptions, mergedData.department);
                                departmentField.value = resolvedDept || mergedData.department || '';
                                console.log(' Department field populated with:', departmentField.value || 'No department assigned');
                            } catch (e) {
                                // Fallback to raw value
                                departmentField.value = mergedData.department || '';
                                console.warn(' Failed to resolve department label, using raw value', e);
                            }
                        }
                        if (positionField || jobTitleField) {
                            const source = mergedData.jobTitle || mergedData.position || '';
                            try {
                                const jobOptions = await this.loadCompanyFieldOptions('job-title');
                                const jobLabel = this.resolveOptionLabel(jobOptions, source);
                                if (positionField) positionField.value = jobLabel || source || '';
                                if (jobTitleField) jobTitleField.value = jobLabel || source || '';
                            } catch (e) {
                                if (positionField) positionField.value = source || '';
                                if (jobTitleField) jobTitleField.value = source || '';
                            }
                        }
                        if (bioField) bioField.value = mergedData.bio || '';
                        
                        console.log('Populated fields:', {
                            department: mergedData.department || 'No department data',
                            position: mergedData.position || 'No position data'
                        });
                        
                        // Populate preferences (these come from global user data)
                        const timezoneField = document.getElementById('timezone');
                        const languageField = document.getElementById('language');
                        
                        if (timezoneField) timezoneField.value = userData?.timezone || 'UTC';
                        if (languageField) languageField.value = userData?.language || 'en';
                    } else {
                        console.log('No user data found in database - creating default profile');
                        // Create default profile data
                        const defaultData = {
                            name: this.currentUser.name || this.currentUser.displayName || this.currentUser.email.split('@')[0],
                            email: this.currentUser.email,
                            phone: '',
                            department: '',
                            jobTitle: '',
                            position: '',
                            bio: '',
                            timezone: 'UTC',
                            language: 'en',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Save default data to database
                        await db.ref(`users/${this.currentUser.uid}`).set(defaultData);
                        
                        // Set default values in form
                        const displayNameField = document.getElementById('displayName');
                        const emailField = document.getElementById('email');
                        
                        if (displayNameField) displayNameField.value = defaultData.name;
                        if (emailField) emailField.value = defaultData.email;
                        
                        console.log('Default profile created and populated');
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    this.showNotification('Error loading profile data', 'error');
                }
            }

            // Load company-scoped field options (e.g., department) with caching
            async loadCompanyFieldOptions(fieldType) {
                if (!fieldType) return [];
                // Return from cache if available
                if (this.companyFieldOptions && this.companyFieldOptions[fieldType]) {
                    return this.companyFieldOptions[fieldType];
                }

                const companyId = this.currentCompany?.id || this.currentUser?.companyId || window.authManager?.currentUser?.companyId;
                if (!companyId || typeof db?.ref !== 'function') {
                    return [];
                }

                try {
                    // Try primary path first
                    const primaryRef = db.ref(`companies/${companyId}/fieldOptions/${fieldType}`);
                    let snap = await primaryRef.once('value');
                    if (!snap.exists()) {
                        // Fallback to legacy settings path
                        const legacyRef = db.ref(`companies/${companyId}/settings/fieldOptions/${fieldType}`);
                        snap = await legacyRef.once('value');
                    }

                    let options = [];
                    if (snap.exists()) {
                        const val = snap.val();
                        if (Array.isArray(val)) {
                            options = val.filter(o => o && (o.enabled === undefined || o.enabled === true));
                        }
                    }

                    // Cache and return
                    if (!this.companyFieldOptions) this.companyFieldOptions = {};
                    this.companyFieldOptions[fieldType] = options;
                    return options;
                } catch (e) {
                    console.warn(`Failed to load company field options for ${fieldType}:`, e);
                    return [];
                }
            }

            // Resolve a stored value/label to the configured option label
            resolveOptionLabel(options, valueOrLabel) {
                if (!valueOrLabel) return '';
                const norm = (s) => String(s || '')
                    .trim()
                    .toLowerCase()
                    // normalize spaces, underscores, and various dash characters to single hyphen
                    .replace(/[\s\-_\u2010\u2011\u2012\u2013\u2014\u2015]+/g, '-')
                    ;
                const needle = String(valueOrLabel).trim().toLowerCase();
                const needleNorm = norm(valueOrLabel);
                const match = (options || []).find(opt => {
                    const v = (opt.value || opt.text || '').toString().toLowerCase();
                    const l = (opt.label || opt.text || '').toString().toLowerCase();
                    if (v === needle || l === needle) return true;
                    // Also compare normalized slug forms to handle hyphens/underscores/spaces differences
                    const vn = norm(opt.value || opt.text || '');
                    const ln = norm(opt.label || opt.text || '');
                    return vn === needleNorm || ln === needleNorm;
                });
                return match ? (match.label || match.value || '') : valueOrLabel;
            }

            async loadUserStats() {
                if (!this.currentUser) return;

                try {
                    // Load training requests count
                    const trainingRef = db.ref('trainingRequests');
                    const trainingSnapshot = await trainingRef.orderByChild('submittedBy').equalTo(this.currentUser.uid).once('value');
                    const trainingCount = trainingSnapshot.exists() ? Object.keys(trainingSnapshot.val()).length : 0;
                    
                    // Load access requests count
                    const accessRef = db.ref('access');
                    const accessSnapshot = await accessRef.orderByChild('submittedBy').equalTo(this.currentUser.uid).once('value');
                    const accessCount = accessSnapshot.exists() ? Object.keys(accessSnapshot.val()).length : 0;
                    
                    // Calculate account age
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    const accountAge = userData?.createdAt ? 
                        Math.floor((Date.now() - new Date(userData.createdAt).getTime()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Calculate days since last login
                    const lastLogin = userData?.lastLogin ? 
                        Math.floor((Date.now() - new Date(userData.lastLogin).getTime()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Update stats display
                    document.getElementById('statTrainingRequests').textContent = trainingCount;
                    document.getElementById('statAccessRequests').textContent = accessCount;
                    document.getElementById('statLastLoginDays').textContent = lastLogin;
                    document.getElementById('statAccountAge').textContent = accountAge;
                    
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            /* Timesheet Management */
            async loadUserTimesheets() {
                if (!this.currentUser) return;
                try {
                    const userId = this.currentUser.uid;

                    // Load all timesheets and preserve IDs
                    const allSnap = await db.ref('timesheets').once('value');
                    const rows = [];
                    if (allSnap && allSnap.exists()) {
                        allSnap.forEach(child => {
                            const val = child.val() || {};
                            rows.push({ id: child.key, ...val });
                        });
                    }

                    // Evaluate visibility using the same rules as leave tab
                    console.log(' DEBUG: Evaluating timesheet visibility for', rows.length, 'timesheets');
                    const checks = await Promise.all(rows.map(r => this.canUserViewTimesheet(r)));
                    const items = rows.filter((r, i) => {
                        const canView = !!checks[i];
                        console.log(' DEBUG Timesheet visibility:', r.id, 'status:', r.status, 'canView:', canView);
                        return canView;
                    });

                    const toTs = (v) => {
                        if (typeof v === 'number') return v;
                        if (!v) return 0;
                        const n = Number(v);
                        if (!isNaN(n)) return n;
                        const t = Date.parse(String(v));
                        return isNaN(t) ? 0 : t;
                    };
                    items.sort((a,b) => toTs(b.createdAt) - toTs(a.createdAt));
                    this.timesheets = items;

                    console.log(` Loaded ${items.length} visible timesheets for user`);
                    this.renderTimesheets();
                } catch (error) {
                    console.error('Error loading timesheets:', error);
                }
            }

            async checkIfUserCanApproveTimesheet(timesheet) {
                try {
                    // Get the approval flow for this timesheet
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const flat = detailed.flat || [];
                    
                    if (flat.length === 0) {
                        // No flow configured, use general role check
                        return this.checkUserCanApprove(timesheet);
                    }
                    
                    // Find current step based on approval history
                    const hist = Array.isArray(timesheet.approvalHistory) ? timesheet.approvalHistory : [];
                    const approvalsByStep = new Map();
                    hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                    
                    let currentStepIndex = 0;
                    for (let i = 0; i < flat.length; i++) {
                        const e = approvalsByStep.get(i);
                        if (!e || (e.status||'').toLowerCase() !== 'approved') { 
                            currentStepIndex = i; 
                            break; 
                        }
                        if (i === flat.length - 1) currentStepIndex = flat.length; // all approved
                    }
                    
                    // If all steps are approved, no one can approve further
                    if (currentStepIndex >= flat.length) {
                        return false;
                    }
                    
                    // Check if current user can approve this specific step
                    return await this.checkUserCanApproveStep(currentStepIndex);
                    
                } catch (error) {
                    console.warn('Error checking timesheet approval permissions:', error);
                    return false;
                }
            }

            async checkIfUserWasInvolvedInApproval(timesheet) {
                try {
                    const currentUserId = this.currentUser.uid;
                    const currentUserEmail = this.currentUser.email;
                    
                    // Check approval history for user's involvement
                    const hist = Array.isArray(timesheet.approvalHistory) ? timesheet.approvalHistory : [];
                    for (const entry of hist) {
                        if (entry.submittedBy === currentUserId || entry.submittedByEmail === currentUserEmail) {
                            return true; // User approved/rejected this timesheet
                        }
                    }
                    
                    // Check if user could have approved based on approval flow
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const flat = detailed.flat || [];
                    
                    if (flat.length === 0) {
                        // No flow configured, use general role check
                        return this.checkUserCanApprove(timesheet);
                    }
                    
                    // Check if user matches any step in the approval flow
                    for (let stepIndex = 0; stepIndex < flat.length; stepIndex++) {
                        const canApproveStep = await this.checkUserCanApproveStep(stepIndex);
                        if (canApproveStep) {
                            return true; // User is/was an approver in the flow
                        }
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.warn('Error checking user involvement in approval:', error);
                    return false;
                }
            }

            // Apply the exact leave-tab style visibility rules to timesheets
            // Rules:
            // - Submitter can view
            // - Any explicit approver listed on the item can view (if present)
            // - Additionally: if the user's name, role/function, or L+1 appears in the configured
            //   timesheet approval flow, they can view submitted timesheets too.
            async canUserViewTimesheet(ts) {
                try {
                    if (!ts || !this.currentUser) return false;
                    const meIds = new Set([this.currentUser.uid, this.currentUser.userId, this.currentUser.id, this.currentUser.employeeId].filter(Boolean));
                    const slugify = (s) => String(s||'')
                        .normalize('NFD')
                        .replace(/\p{Diacritic}+/gu,'')
                        .trim()
                        .toLowerCase()
                        .replace(/[^a-z0-9\s-]/g,'')
                        .replace(/\s+/g,'-');
                    const norm = (s) => String(s||'')
                        .normalize('NFD')
                        .replace(/\p{Diacritic}+/gu,'')
                        .trim()
                        .toLowerCase();
                    const stripParen = (s) => String(s||'').replace(/\([^)]*\)/g, ' ').replace(/\s+/g, ' ').trim();
                    const acronym = (s) => (String(s||'')
                        .split(/\s+/)
                        .map(w => w.replace(/[^A-Za-z]/g,'').charAt(0))
                        .join('')
                        .toLowerCase());

                    // Submitter check (cover common fields used around the codebase)
                    const submitterFields = [ts.submittedBy, ts.userId, ts.ownerId, ts.createdBy, ts.creatorId, ts.employeeId];
                    if (submitterFields.some(v => v && meIds.has(String(v)))) return true;

                    // Resolve current user's job title once (reuse cache populated by leave tab)
                    let myJobSlug = this._cachedCurrentUserJobTitleSlug || '';
                    let myJobTitle = this._cachedCurrentUserJobTitle || '';
                    if (!myJobSlug) {
                        const rawJob = (this.currentUser.jobTitle || this.currentUser.title || this.currentUser.designation || this.currentUser.role || '');
                        myJobTitle = rawJob;
                        myJobSlug = slugify(rawJob);
                        try {
                            if (!myJobSlug && this.currentUser.companyId) {
                                const uid = this.currentUser.uid || this.currentUser.userId || this.currentUser.id || '';
                                if (uid) {
                                    let uSnap = await db.ref(`companies/${this.currentUser.companyId}/users/${uid}`).once('value');
                                    let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                    if (!u) {
                                        const allSnap = await db.ref(`companies/${this.currentUser.companyId}/users`).once('value');
                                        if (allSnap.exists()) {
                                            const all = allSnap.val()||{};
                                            for (const [k,v] of Object.entries(all)) {
                                                if (!v) continue;
                                                const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                                if (ids.has(String(uid))) { u = v; break; }
                                            }
                                        }
                                    }
                                    if (u) {
                                        const cand = u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '';
                                        myJobTitle = cand;
                                        myJobSlug = slugify(cand);
                                        this._cachedCurrentUserJobTitleSlug = myJobSlug;
                                        this._cachedCurrentUserJobTitle = myJobTitle;
                                    }
                                }
                            }
                        } catch {}
                        if (!this._cachedCurrentUserJobTitleSlug && myJobSlug) this._cachedCurrentUserJobTitleSlug = myJobSlug;
                        if (!this._cachedCurrentUserJobTitle && myJobTitle) this._cachedCurrentUserJobTitle = myJobTitle;
                    }
                    const myJobTitleClean = stripParen(myJobTitle);
                    const myJobSlugClean = slugify(myJobTitleClean);
                    const myAcr = acronym(myJobTitleClean);
                    const myName = norm(this.currentUser.displayName || this.currentUser.name || this.currentUser.email || '');

                    // Explicit approvers array if present (backward compatible)
                    const approvers = Array.isArray(ts.approvers) ? ts.approvers : [];
                    for (const ap of approvers) {
                        const func = String(ap.roleFunction||'').trim();
                        if (!func) continue;
                        if (func.startsWith('user_')) {
                            const uid = func.substring(5);
                            if (meIds.has(uid)) return true;
                        } else if (func.startsWith('function_')) {
                            const fslug = func.substring(9);
                            if (myJobSlug && fslug === myJobSlug) return true;
                        } else {
                            const legacySlug = slugify(func);
                            if (legacySlug && myJobSlug && legacySlug === myJobSlug) return true;
                            if (meIds.has(func)) return true;
                        }
                    }

                    // Direct function-approver match across full timesheet flow (exact requirement)
                    // If the user's job title slug matches ANY step's function/role label in the modal flow, allow viewing.
                    console.log(' DEBUG: Checking function approver match for timesheet:', ts.id, { myJobSlug, myJobTitle });
                    const functionApproverMatch = await this.isUserFunctionApproverInTimesheetFlow(ts, myJobSlug, myJobTitle);
                    console.log(' DEBUG: Function approver match result:', functionApproverMatch);
                    if (functionApproverMatch) {
                        console.log(' DEBUG: Allowing timesheet view due to function approver match');
                        return true;
                    }

                    // Flow-based visibility (timesheet flow)
                    const companyId = this.currentUser.companyId;
                    if (companyId) {
                        // Cache timesheet flow similar to leave flow
                        if (!this._cachedTimesheetApprovalFlow || this._cachedTimesheetApprovalFlow.companyId !== companyId) {
                            try {
                                // Primary: dedicated timesheet flow
                                const flowSnap = await db.ref(`companies/${companyId}/approvalFlows/timesheet`).once('value');
                                let flowObj = flowSnap.exists() ? (flowSnap.val() || {}) : {};
                                // Fallback: generic approvalSettings/approvalFlow if primary empty
                                if (!flowSnap.exists() || Object.keys(flowObj).length === 0) {
                                    try {
                                        const settingsSnap = await db.ref(`companies/${companyId}/approvalSettings/approvalFlow`).once('value');
                                        if (settingsSnap.exists()) {
                                            flowObj = settingsSnap.val() || {};
                                        }
                                    } catch {}
                                }
                                this._cachedTimesheetApprovalFlow = { companyId, flow: flowObj };
                            } catch(e) {
                                this._cachedTimesheetApprovalFlow = { companyId, flow: {} };
                            }
                        }
                        const flow = this._cachedTimesheetApprovalFlow.flow || {};
                        const selectedRoles = flow.selectedRoles || {};
                        const availableLevels = Array.isArray(flow.levels) ? flow.levels : [];
                        const availableRoles = Array.isArray(flow.availableRoles) ? flow.availableRoles : [];
                        const mapRoleValueToText = (val) => {
                            if (!val) return '';
                            const m = availableRoles.find(r => r.function === val);
                            return (m && (m.text || m.name)) || String(val);
                        };

                        // Resolve submitter's line manager for L+1 resolution
                        let lmId = null, lmNameLower = '';
                        try {
                            const ownerFields = [ts.employeeId, ts.userId, ts.ownerId, ts.createdBy, ts.submittedBy, ts.creatorId].filter(Boolean);
                            let submitterId = ownerFields.length ? String(ownerFields[0]) : '';
                            if (submitterId) {
                                let uSnap = await db.ref(`companies/${companyId}/users/${submitterId}`).once('value');
                                let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                if (!u) {
                                    const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                    if (allSnap.exists()) {
                                        const all = allSnap.val()||{};
                                        for (const [k,v] of Object.entries(all)) {
                                            if (!v) continue;
                                            const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                            if (ids.has(String(submitterId))) { u = v; break; }
                                        }
                                    }
                                }
                                if (u) {
                                    lmId = u.lineManagerId || u.lineManagerUID || u.managerId || u.managerUID || u.supervisorId || u.supervisorUID || null;
                                    lmNameLower = String(u.lineManager || u.lineManagerName || u.managerName || u.supervisorName || '').trim().toLowerCase();
                                }
                            }
                        } catch {}

                        // Matching tokens
                        const myTokens = new Set();
                        const myUid = this.currentUser.uid || this.currentUser.userId || this.currentUser.id || '';
                        if (myUid) myTokens.add(`user_${myUid}`);
                        if (myJobSlug) {
                            myTokens.add(`function_${myJobSlug}`);
                            myTokens.add(myJobSlug);
                        }

                        // Selected roles (new config)
                        const levelKeys = Object.keys(selectedRoles);
                        if (levelKeys.length > 0) {
                            for (const key of levelKeys) {
                                const approverList = Array.isArray(selectedRoles[key]) ? selectedRoles[key] : [];
                                const nameSet = new Set(approverList.map(ap => norm(ap.text)).filter(Boolean));
                                if (myName && nameSet.has(myName)) return true;

                                for (const ap of approverList) {
                                    const val = String(ap.value || ap.text || '').trim();
                                    if (!val) continue;
                                    const valLower = val.toLowerCase();
                                    if (valLower.startsWith('user_') && myTokens.has(valLower)) return true;
                                    if (valLower.startsWith('function_') || valLower.startsWith('function-')) {
                                        const base = val.replace(/^function[-_]/i, '');
                                        const baseSlug = slugify(base);
                                        if ((myJobSlug && baseSlug === myJobSlug) || (myJobSlugClean && baseSlug === myJobSlugClean)) return true;
                                    }
                                    if (myJobTitle && valLower === myJobTitle.toLowerCase()) return true;
                                    const valSlug = slugify(val);
                                    const valSlugClean = slugify(stripParen(val));
                                    if ((myJobSlug && valSlug === myJobSlug) || (myJobSlugClean && valSlug === myJobSlugClean) || (myJobSlugClean && valSlugClean === myJobSlugClean)) return true;
                                    if (myAcr && valSlug === myAcr) return true;
                                    const mapped = mapRoleValueToText(val);
                                    if (mapped && mapped !== val) {
                                        if (myJobTitle && mapped.toLowerCase() === myJobTitle.toLowerCase()) return true;
                                        const mappedSlug = slugify(mapped);
                                        const mappedSlugClean = slugify(stripParen(mapped));
                                        if ((myJobSlug && mappedSlug === myJobSlug) || (myJobSlugClean && mappedSlug === myJobSlugClean) || (myJobSlugClean && mappedSlugClean === myJobSlugClean)) return true;
                                        if (myAcr && mappedSlug === myAcr) return true;
                                    }
                                }
                                const isL1Token = (s)=>{ const v=String(s||'').trim().toLowerCase(); if(!v) return false; return (/^l\+?1$/.test(v) || /^level\+?1$/.test(v) || /^level\s*1$/.test(v) || v==='line manager' || v==='linemanager'); };
                                const requiresL1 = approverList.some(ap => isL1Token(ap.value) || isL1Token(ap.text));
                                if (requiresL1) {
                                    if ((lmId && String(lmId) === String(myUid)) || (lmNameLower && lmNameLower === myName)) return true;
                                }
                            }
                        } else if (availableLevels.length > 0) {
                            // Legacy levels array
                            for (const lvl of availableLevels) {
                                const v = String(lvl?.value || '').trim();
                                if (!v) continue;
                                if (v.startsWith('function_')) {
                                    const bare = v.substring(9);
                                    const bareSlug = slugify(bare);
                                    if ((myJobSlug && (v === `function_${myJobSlug}` || bareSlug === myJobSlug)) || (myJobSlugClean && (v === `function_${myJobSlugClean}` || bareSlug === myJobSlugClean))) return true;
                                } else {
                                    const vv = v.toLowerCase();
                                    if (/^l\+?1$/.test(vv) || /^level\+?1$/.test(vv) || /^level\s*1$/.test(vv) || vv === 'line manager' || vv === 'linemanager') {
                                        if ((lmId && String(lmId) === String(myUid)) || (lmNameLower && lmNameLower === myName)) return true;
                                    }
                                    if (myJobTitle && vv === myJobTitle.toLowerCase()) return true;
                                    const vSlug = slugify(v);
                                    const vSlugClean = slugify(stripParen(v));
                                    if ((myJobSlug && vSlug === myJobSlug) || (myJobSlugClean && vSlug === myJobSlugClean) || (myJobSlugClean && vSlugClean === myJobSlugClean)) return true;
                                    if (myAcr && vSlug === myAcr) return true;
                                    const mapped = mapRoleValueToText(v);
                                    if (mapped && mapped !== v) {
                                        if (myJobTitle && mapped.toLowerCase() === myJobTitle.toLowerCase()) return true;
                                        const mappedSlug = slugify(mapped);
                                        const mappedSlugClean = slugify(stripParen(mapped));
                                        if ((myJobSlug && mappedSlug === myJobSlug) || (myJobSlugClean && mappedSlug === myJobSlugClean) || (myJobSlugClean && mappedSlugClean === myJobSlugClean)) return true;
                                        if (myAcr && mappedSlug === myAcr) return true;
                                    }
                                }
                            }
                        }

                        // Fallback string-contains match as in leave tab
                        if (myJobTitle && myJobSlug) {
                            try {
                                const flowStr = JSON.stringify(flow).toLowerCase();
                                const jobTitleLower = myJobTitle.toLowerCase();
                                const jobTitleNorm = norm(myJobTitle);
                                if (flowStr.includes(jobTitleLower) ||
                                    flowStr.includes(myJobSlug) ||
                                    flowStr.includes(myJobSlugClean) ||
                                    flowStr.includes(jobTitleNorm) ||
                                    flowStr.includes(`"${jobTitleLower}"`) ||
                                    flowStr.includes(`"${myJobSlug}"`) ||
                                    flowStr.includes(`"${myJobSlugClean}"`) ||
                                    flowStr.includes(`function_${myJobSlug}`) ||
                                    flowStr.includes(`function-${myJobSlug}`) ||
                                    flowStr.includes(`function_${myJobSlugClean}`) ||
                                    flowStr.includes(`function-${myJobSlugClean}`)) {
                                    return true;
                                }
                                if (availableRoles.length > 0) {
                                    for (const role of availableRoles) {
                                        const roleText = String(role.text || role.name || '').trim();
                                        if (roleText) {
                                            const roleTextLower = roleText.toLowerCase();
                                            const roleTextNorm = norm(roleText);
                                            const roleTextSlug = slugify(roleText);
                                            const roleTextSlugClean = slugify(stripParen(roleText));
                                            if (roleTextLower === jobTitleLower ||
                                                roleTextNorm === jobTitleNorm ||
                                                roleTextSlug === myJobSlug ||
                                                roleTextSlug === myJobSlugClean ||
                                                roleTextSlugClean === myJobSlugClean) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            } catch {}
                        }
                    }

                    return false;
                } catch(e) { console.warn('canUserViewTimesheet check failed', e); return false; }
            }

            renderTimesheets() {
                const tbody = document.getElementById('timesheetTableBody');
                if (!tbody) return;
                if (!this.timesheets || this.timesheets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:16px; color:#6c757d;">No timesheets yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = this.timesheets.map(ts => {
                    const isSubmitted = ts.status === 'submitted' || ts.status === 'pending' || ts.status === 'approved' || ts.status === 'rejected';
                    const rowClass = isSubmitted ? 'submitted-row' : '';
                    const isOwnTimesheet = ts.submittedBy === this.currentUser?.uid;
                    const submitterDisplay = isOwnTimesheet ? 'You' : (ts.submittedByEmail || ts.submittedBy || 'Unknown');
                    
                    return `
                    <tr data-id="${ts.id}" class="${rowClass}" style="border-bottom:1px solid #f1f1f1; cursor:${isSubmitted ? 'pointer' : 'default'};">
                        <td style="padding:12px;">${ts.month || ts.period || ''}</td>
                        <td style="padding:12px;">${ts.totalHours != null ? ts.totalHours : (ts.totalHours === 0 ? 0 : '')}</td>
                        <td style="padding:12px;">${ts.status || 'draft'}</td>
                        <td style="padding:12px;">${submitterDisplay}</td>
                        <td style="padding:12px;">
                            ${isSubmitted ? '' : `<button class="btn-primary editTimesheetBtn" data-id="${ts.id}" style="padding:6px 10px; font-size:0.85rem;">Edit</button>`}
                        </td>
                    </tr>
                `}).join('');

                // Wire up edit buttons and row click for submitted
                setTimeout(async () => {
                    const editBtns = document.querySelectorAll('.editTimesheetBtn');
                    editBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = btn.dataset.id;
                            if (id) this.openEditTimesheetModal(id);
                        });
                    });

                    const rows = tbody.querySelectorAll('tr[data-id]');
                    rows.forEach(r => {
                        r.addEventListener('click', (e) => {
                            const id = r.getAttribute('data-id');
                            const ts = this.timesheets.find(x => x.id === id);
                            if (!ts) return;
                            const isSubmitted = ts.status === 'submitted' || ts.status === 'pending' || ts.status === 'approved' || ts.status === 'rejected';
                            if (isSubmitted) {
                                this.openViewTimesheetModal(id);
                            }
                        });
                    });
                }, 20);
            }

            generateMonthDays(monthValue) {
                // monthValue format: YYYY-MM
                const container = document.getElementById('tsDaysContainer');
                const totalField = document.getElementById('tsTotalHours');
                if (!container) return;
                container.innerHTML = '';

                if (!monthValue) {
                    totalField.value = '';
                    return;
                }

                const [yearStr, monthStr] = monthValue.split('-');
                const year = parseInt(yearStr, 10);
                const month = parseInt(monthStr, 10) - 1; // zero-based

                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const fragment = document.createDocumentFragment();

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const row = document.createElement('div');
                    row.style.display = 'grid';
                    // Add an extra column for Overtime
                    row.style.gridTemplateColumns = '2fr 1fr 1fr 0.8fr 2fr 0.8fr 0.8fr';
                    row.style.gap = '8px';
                    row.style.padding = '6px 8px';
                    row.style.borderBottom = '1px solid #f5f5f5';

                    const label = document.createElement('div');
                    label.textContent = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });

                    // start time
                    const startInput = document.createElement('input');
                    startInput.type = 'time';
                    startInput.style.width = '100%';
                    startInput.dataset.date = date.toISOString();

                    // end time
                    const endInput = document.createElement('input');
                    endInput.type = 'time';
                    endInput.style.width = '100%';
                    endInput.dataset.date = date.toISOString();

                    // break hours
                    const breakInput = document.createElement('input');
                    breakInput.type = 'number';
                    breakInput.min = '0';
                    breakInput.step = '0.25';
                    breakInput.placeholder = '0';
                    breakInput.style.width = '80px';
                    breakInput.dataset.date = date.toISOString();

                    // comment
                    const commentInput = document.createElement('input');
                    commentInput.type = 'text';
                    commentInput.placeholder = 'Comment';
                    commentInput.style.width = '100%';
                    commentInput.dataset.date = date.toISOString();

                    // computed hours display
                    const hoursDisplay = document.createElement('div');
                    hoursDisplay.textContent = '';
                    hoursDisplay.style.padding = '6px 8px';
                    hoursDisplay.style.textAlign = 'right';
                    hoursDisplay.dataset.date = date.toISOString();

                    // per-day overtime display
                    const otDisplay = document.createElement('div');
                    otDisplay.textContent = '';
                    otDisplay.style.padding = '6px 8px';
                    otDisplay.style.textAlign = 'right';
                    otDisplay.setAttribute('data-ot-for', date.toISOString());

                    function recalc() {
                        const start = startInput.value;
                        const end = endInput.value;
                        const br = parseFloat(breakInput.value) || 0;
                        let hrs = 0;
                        if (start && end) {
                            const s = new Date(`${date.toISOString().slice(0,10)}T${start}`);
                            const e = new Date(`${date.toISOString().slice(0,10)}T${end}`);
                            hrs = (e - s) / (1000 * 60 * 60);
                            if (hrs < 0) {
                                // cross-midnight: add 24
                                hrs += 24;
                            }
                        }
                        hrs = Math.max(0, hrs - br);
                        hrs = Math.round((hrs + Number.EPSILON) * 100) / 100;
                        hoursDisplay.textContent = hrs ? hrs.toString() : '';
                        // compute per-day overtime if working hours/day is available
                        try {
                            const std = (typeof this._tsWorkingHoursPerDay === 'number' && this._tsWorkingHoursPerDay > 0) ? this._tsWorkingHoursPerDay : 8;
                            const ot = hrs > 0 ? Math.max(0, hrs - std) : 0;
                            const otRounded = Math.round((ot + Number.EPSILON) * 100) / 100;
                            otDisplay.textContent = otRounded ? otRounded.toString() : '0';
                        } catch (_) {
                            otDisplay.textContent = '';
                        }
                        // update total
                        const total = this.computeTotalHoursFromDays();
                        if (totalField) totalField.value = total;
                        // update overtime display relative to allocated weekly hours
                        if (typeof this.updateTimesheetOvertimeDisplay === 'function') {
                            this.updateTimesheetOvertimeDisplay();
                        }
                    }

                    // wire up listeners
                    startInput.addEventListener('change', recalc.bind(this));
                    endInput.addEventListener('change', recalc.bind(this));
                    breakInput.addEventListener('input', recalc.bind(this));

                    row.appendChild(label);
                    row.appendChild(startInput);
                    row.appendChild(endInput);
                    row.appendChild(breakInput);
                    row.appendChild(commentInput);
                    row.appendChild(hoursDisplay);
                    row.appendChild(otDisplay);

                    fragment.appendChild(row);
                }

                container.appendChild(fragment);

                // reset total
                if (totalField) totalField.value = '0';

                // After generating days, adjust modal sizing so it fits the screen
                setTimeout(() => this.adjustTimesheetModalSize(), 50);
            }

            adjustTimesheetModalSize() {
                const modalContent = document.querySelector('.timesheet-modal-content');
                const days = document.getElementById('tsDaysContainer');
                if (!modalContent || !days) return;

                // With the new flex layout, the days container should auto-size
                // Just ensure it has reasonable min/max constraints
                const viewportHeight = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
                const minHeight = Math.min(200, viewportHeight * 0.2);
                const maxHeight = Math.min(400, viewportHeight * 0.4);
                
                days.style.minHeight = minHeight + 'px';
                days.style.maxHeight = maxHeight + 'px';
                
                // Let flexbox handle the rest of the sizing
            }

            computeTotalHoursFromDays() {
                const container = document.getElementById('tsDaysContainer');
                if (!container) return 0;
                // Prefer computed hours displays per row
                const hoursDisplays = container.querySelectorAll('div[data-date]');
                let total = 0;

                if (hoursDisplays && hoursDisplays.length > 0) {
                    hoursDisplays.forEach(h => {
                        const v = parseFloat(h.textContent);
                        if (!isNaN(v) && v > 0) total += v;
                    });
                } else {
                    const inputs = container.querySelectorAll('input[data-date]');
                    inputs.forEach(inp => {
                        const v = parseFloat(inp.value);
                        if (!isNaN(v) && v > 0) total += v;
                    });
                }
                // round to 2 decimals
                return Math.round((total + Number.EPSILON) * 100) / 100;
            }

            // ----- Approval Flow Helpers (Timesheets) -----
            // New detailed fetch that preserves level groupings
            async fetchTimesheetApprovalFlowDetailed() {
                const result = { levels: [], flat: [] };
                try {
                    const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId);
                    if (!companyId) {
                        console.log(' DEBUG: No companyId for flow fetch');
                        return result;
                    }

                    console.log(' DEBUG: Fetching timesheet approval flow for company:', companyId);

                    // Prefer company-scoped timesheet flow
                    const tsFlowSnap = await db.ref(`companies/${companyId}/approvalFlows/timesheet`).once('value');
                    console.log(' DEBUG: Timesheet flow snap exists:', tsFlowSnap.exists());
                    
                    if (tsFlowSnap.exists()) {
                        const raw = tsFlowSnap.val();
                        console.log(' DEBUG: Raw timesheet flow data:', raw);
                        const normalized = this.normalizeApprovalFlow(raw);
                        console.log(' DEBUG: Normalized timesheet flow:', normalized);
                        return normalized;
                    }

                    // Fallbacks to approval settings (timesheet-specific and generic)
                    console.log(' DEBUG: Falling back to approval settings');
                    const fallbackPaths = [
                        `companies/${companyId}/approvalSettings/timesheet`,
                        `companies/${companyId}/approvalSettings/timesheet_request`,
                        `companies/${companyId}/approvalSettings/timesheet-request`,
                        `companies/${companyId}/approvalSettings/approvalFlow`
                    ];
                    for (const p of fallbackPaths) {
                        const snap = await db.ref(p).once('value');
                        console.log(' DEBUG: Fallback path check', p, 'exists:', snap.exists());
                        if (snap.exists()) {
                            const raw = snap.val();
                            console.log(' DEBUG: Raw settings flow data from', p, ':', raw);
                            const normalized = this.normalizeApprovalFlow(raw);
                            console.log(' DEBUG: Normalized settings flow:', normalized);
                            return normalized;
                        }
                    }

                    console.log(' DEBUG: No flow data found');
                    return result;
                } catch (e) {
                    console.warn('fetchTimesheetApprovalFlowDetailed error:', e);
                }
                return result;
            }

            normalizeApprovalFlow(raw) {
                const normalized = { levels: [], flat: [] };
                if (!raw) return normalized;

                // If raw has 'levels'
                if (raw.levels) {
                    const levelsArr = Array.isArray(raw.levels)
                        ? raw.levels
                        : Object.values(raw.levels);
                    levelsArr.forEach((lvl, idx) => {
                        // level may have approvers array or be array itself
                        let approvers = [];
                        if (Array.isArray(lvl)) {
                            approvers = lvl;
                        } else if (lvl && Array.isArray(lvl.approvers)) {
                            approvers = lvl.approvers;
                        } else if (lvl && typeof lvl.approvers === 'object') {
                            approvers = Object.values(lvl.approvers);
                        } else {
                            // Support approval-settings schema where each level is a single selector
                            // Try to resolve from selectedRoles using the explicit level number
                            const levelNumber = (typeof lvl.level === 'number' && lvl.level > 0) ? lvl.level : (idx + 1);
                            const sr = raw.selectedRoles && raw.selectedRoles[`level${levelNumber}`]
                                ? raw.selectedRoles[`level${levelNumber}`][0]
                                : null;
                            if (sr && sr.value) {
                                const val = String(sr.value);
                                if (val.startsWith('user_')) {
                                    approvers = [{ userId: val.replace('user_',''), label: sr.text || null }];
                                } else if (val.startsWith('function_')) {
                                    // Function (job title) based approver  use clean text as label/role
                                    approvers = [{ role: sr.text || val.replace('function_',''), label: sr.text || null }];
                                } else {
                                    // Level-based (e.g., L+1) or unknown  use value/text as label
                                    approvers = [{ label: sr.text || val }];
                                }
                            } else if (lvl && (lvl.approverType || lvl.value)) {
                                // Fallback: build from level object fields
                                const val2 = String(lvl.value || '');
                                if (val2.startsWith('user_')) {
                                    approvers = [{ userId: val2.replace('user_',''), label: lvl.label || null }];
                                } else if (val2.startsWith('function_')) {
                                    approvers = [{ role: lvl.label || val2.replace('function_',''), label: lvl.label || null }];
                                } else if (val2) {
                                    approvers = [{ label: lvl.label || val2 }];
                                }
                            }
                        }

                        let normApprovers = (approvers || []).map(a => ({
                            userId: a.userId || a.uid || a.user || a.approverId || null,
                            role: a.role || a.roleName || a.position || a.approver || null,
                            label: a.label || a.name || a.title || a.displayName || null,
                            email: a.email || a.approverEmail || null
                        }));

                        // L+1 rule: if this is first level (index 0) and any approver has label/value like 'L+1' or 'L1'
                        // substitute with current user's direct line manager if available.
                        if (idx === 0 && normApprovers.length === 1) {
                            const la = (normApprovers[0].label || '').toUpperCase();
                            if (/^L\+?1$/.test(la.replace(/\s+/g,''))) {
                                try {
                                    const currentUser = (this.currentUser) || (window.authManager && window.authManager.currentUser) || null;
                                    const lmId = currentUser && (currentUser.lineManagerId || currentUser.lineManagerUID || currentUser.managerId || null);
                                    const lmName = currentUser && (currentUser.lineManager || currentUser.lineManagerName || currentUser.managerName || null);
                                    if (lmId || lmName) {
                                        normApprovers = [{
                                            userId: lmId || null,
                                            role: null,
                                            label: lmName || 'Line Manager',
                                            email: null,
                                            substitutedFrom: normApprovers[0].label || 'L+1'
                                        }];
                                    }
                                } catch(e) { /* swallow substitution errors */ }
                            }
                        }
                        normalized.levels.push(normApprovers);
                    });
                } else {
                    // Otherwise treat steps/array/object as a single level
                    let steps = [];
                    if (Array.isArray(raw)) steps = raw;
                    else if (raw.steps && Array.isArray(raw.steps)) steps = raw.steps;
                    else if (typeof raw === 'object') steps = Object.values(raw);

                    const norm = steps.map(s => ({
                        userId: s.userId || s.uid || s.user || s.approverId || null,
                        role: s.role || s.roleName || s.position || s.approver || null,
                        label: s.label || s.name || s.title || s.displayName || null,
                        email: s.email || s.approverEmail || null
                    }));
                    normalized.levels.push(norm);
                }

                // Build flat steps with level metadata
                normalized.levels.forEach((lvl, levelIdx) => {
                    lvl.forEach((step, idxInLevel) => {
                        normalized.flat.push({ ...step, levelIndex: levelIdx, indexInLevel: idxInLevel });
                    });
                });

                // Preserve availableRoles for better value-to-text mapping downstream
                if (Array.isArray(raw.availableRoles)) {
                    normalized.availableRoles = raw.availableRoles;
                }

                return normalized;
            }

            // Determine if current user is explicitly the next approver (strict check)
            async isCurrentUserActiveApprover(timesheet) {
                try {
                    if (!timesheet || !this.currentUser) return false;
                    const currentUid = this.currentUser.uid;
                    const currentEmail = (this.currentUser.email||'').toLowerCase();
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const flat = detailed.flat || [];
                    if (!flat.length) return false;
                    // Build map of approved steps
                    let hist = [];
                    if (Array.isArray(timesheet.approvalHistory)) hist = timesheet.approvalHistory;
                    else if (timesheet.approvalHistory && typeof timesheet.approvalHistory === 'object') hist = Object.values(timesheet.approvalHistory);
                    const approvalsByStep = new Map();
                    hist.forEach(h => { if (h && typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                    // Find current step index
                    let currentIdx = 0;
                    for (let i=0;i<flat.length;i++) {
                        const entry = approvalsByStep.get(i);
                        if (!entry || (String(entry.status||'').toLowerCase() !== 'approved')) { currentIdx = i; break; }
                        if (i === flat.length-1) currentIdx = flat.length; // all approved
                    }
                    if (currentIdx >= flat.length) return false; // no active step
                    const step = flat[currentIdx];
                    // Direct userId match
                    if (step.userId && step.userId === currentUid) return true;
                    // Email match
                    if (step.email && step.email.toLowerCase() === currentEmail) return true;
                    // Role match (simple contains or equality)
                    if (step.role) {
                        const userRole = (this.currentUser.role||'').toLowerCase();
                        const stepRole = step.role.toLowerCase();
                        if (userRole && (userRole === stepRole || userRole.includes(stepRole) || stepRole.includes(userRole))) return true;
                    }
                    // L+1 special case: verify line manager relationship
                    const rawLabel = (step.label || step.role || '').toUpperCase().replace(/\s+/g,'');
                    const isL1 = step.substitutedFrom === 'L+1' || /^L\+?1$|^LEVEL\+?1$/.test(rawLabel) || (step.label && step.label.toLowerCase() === 'line manager');
                    if (isL1) {
                        // Identify timesheet owner
                        const ownerFields = ['userId','ownerId','createdBy','submittedBy','creatorId','employeeId'];
                        let ownerId = null;
                        for (const f of ownerFields) { if (timesheet[f]) { ownerId = timesheet[f]; break; } }
                        if (!ownerId && hist.length) {
                            const sub = hist.find(h => h && h.action === 'submitted' && h.userId);
                            if (sub) ownerId = sub.userId;
                        }
                        if (ownerId) {
                            const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId) || null;
                            if (companyId) {
                                try {
                                    const ownerSnap = await db.ref(`companies/${companyId}/users/${ownerId}`).once('value');
                                    if (ownerSnap.exists()) {
                                        const ownerData = ownerSnap.val();
                                        const lmId = ownerData.lineManagerId || ownerData.lineManagerUID || null;
                                        const lmName = (ownerData.lineManager || ownerData.lineManagerName || '').toLowerCase();
                                        const currentName = (this.currentUser.name || this.currentUser.displayName || '').toLowerCase();
                                        if (lmId && lmId === currentUid) return true;
                                        if (!lmId && lmName && currentName && (lmName === currentName || lmName.includes(currentName) || currentName.includes(lmName))) return true;
                                        // Fallback: no line manager defined; allow self-approval by submitter if they own the timesheet
                                        if (!lmId && !lmName && ownerId === currentUid) {
                                            return true;
                                        }
                                    }
                                } catch {}
                            }
                        } else {
                            // No ownerId discovered; if current user submitted (look through history) and step unassigned treat as approver
                            const submittedByEntry = hist.find(h => h && h.action === 'submitted' && (h.userId === currentUid || (h.email && h.email.toLowerCase() === currentEmail)));
                            if (submittedByEntry && !step.userId && !step.email && !step.role) {
                                return true;
                            }
                        }
                    }
                    return false;
                } catch (e) {
                    console.warn('isCurrentUserActiveApprover error', e);
                    return false;
                }
            }

            // Backward-compatible simple fetch returning flat steps only
            async fetchTimesheetApprovalFlow() {
                try {
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    return detailed.flat;
                } catch (e) {
                    console.warn('fetchTimesheetApprovalFlow error:', e);
                    return [];
                }
            }

            normalizeFlowSteps(raw) {
                if (!raw) return [];
                let steps = [];
                if (Array.isArray(raw)) {
                    steps = raw;
                } else if (raw.steps && Array.isArray(raw.steps)) {
                    steps = raw.steps;
                } else if (typeof raw === 'object') {
                    steps = Object.values(raw);
                }
                return steps.map(s => ({
                    userId: s.userId || s.uid || s.user || s.approverId || null,
                    role: s.role || s.roleName || s.position || s.approver || null,
                    label: s.label || s.name || s.title || s.displayName || null,
                    email: s.email || s.approverEmail || null
                })).filter(Boolean);
            }

            async renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx, containerId = 'tsApprovalFlowContent') {
                const container = document.getElementById(containerId);
                if (!container) return;
                if (!levels || levels.length === 0) {
                    container.innerHTML = '<div class="approval-meta">No approval flow configured for timesheets.</div>';
                    return;
                }

                // Build per-approver status based on currentFlatIdx
                let globalIdx = 0;
                const html = [];
                for (let lvlIndex = 0; lvlIndex < levels.length; lvlIndex++) {
                    const approvers = levels[lvlIndex] || [];
                    const levelItems = await Promise.all(approvers.map(async (step, idxInLevel) => {
                        let who = '';
                        // L+1 enhancement: ensure we attach line manager userId & name if missing
                        if (lvlIndex === 0 && step.substitutedFrom) {
                            try {
                                const currentUser = this.currentUser || (window.authManager && window.authManager.currentUser) || null;
                                if (currentUser) {
                                    const lmId = currentUser.lineManagerId || currentUser.lineManagerUID || null;
                                    const lmName = currentUser.lineManager || currentUser.lineManagerName || null;
                                    if (!step.userId && lmId) {
                                        step.userId = lmId; // allow proper name resolution via getUserDisplayNameById
                                    }
                                    // If we still won't resolve (no userId), set label to full name now
                                    if (!step.userId && lmName) {
                                        step.label = lmName;
                                    }
                                }
                            } catch {}
                        }
                        // Additional L+1 resolution if not already substitutedFrom but placeholder still present
                        if (lvlIndex === 0 && !step.substitutedFrom) {
                            const rawToken = (step.label || step.role || '').toUpperCase().replace(/\s+/g,'');
                            if (/^L\+?1$|^LEVEL\+?1$/.test(rawToken)) {
                                try {
                                    const currentUser = this.currentUser || (window.authManager && window.authManager.currentUser) || null;
                                    const companyId = (this.currentCompany && this.currentCompany.id) || (currentUser && currentUser.companyId) || null;
                                    if (currentUser && companyId) {
                                        // Fetch lineManager name from company-scoped path if not already on currentUser object
                                        let lmName = currentUser.lineManager || currentUser.lineManagerName || null;
                                        let lmId = currentUser.lineManagerId || currentUser.lineManagerUID || null;
                                        if (!lmName) {
                                            try {
                                                const lmSnap = await db.ref(`companies/${companyId}/users/${currentUser.uid || currentUser.userId}/lineManager`).once('value');
                                                if (lmSnap.exists()) lmName = lmSnap.val();
                                            } catch {}
                                        }
                                        if (!lmId) {
                                            try {
                                                const lmIdSnap = await db.ref(`companies/${companyId}/users/${currentUser.uid || currentUser.userId}/lineManagerId`).once('value');
                                                if (lmIdSnap.exists()) lmId = lmIdSnap.val();
                                            } catch {}
                                        }
                                        if (lmId && !step.userId) step.userId = lmId;
                                        if (lmName) {
                                            who = lmName; // directly set display name
                                            step.label = 'Line Manager';
                                            step.substitutedFrom = 'L+1';
                                        }
                                    }
                                } catch {}
                            }
                        }
                        if (step.userId) {
                            try { who = await this.getUserDisplayNameById(step.userId); } catch { who = step.userId; }
                        } else if (step.email) {
                            try { who = await this.getUserDisplayNameByEmail(step.email); } catch { who = step.email; }
                        } else if (step.label) { who = step.label; }
                        else if (step.role) { who = step.role; }
                        else { who = 'Unassigned'; }

                        // If this step originated from L+1 placeholder substitution, augment with job title if possible
                        let extraMeta = '';
                        if (lvlIndex === 0 && step.substitutedFrom) {
                            // Try to fetch user data for job title/role
                            try {
                                if (step.userId) {
                                    const snap = await db.ref(`users/${step.userId}`).once('value');
                                    if (snap.exists()) {
                                        const u = snap.val();
                                        const jobTitle = u.jobTitle || u.position || u.role || '';
                                        if (jobTitle) {
                                            extraMeta = ` (${jobTitle})`;
                                        }
                                    }
                                } else if (this.currentUser && (this.currentUser.lineManagerId || this.currentUser.lineManager)) {
                                    // fallback to line manager info stored on currentUser if userId not present
                                    const jobTitle = this.currentUser.lineManagerJobTitle || this.currentUser.lineManagerRole || this.currentUser.lineManagerPosition || '';
                                    if (jobTitle) extraMeta = ` (${jobTitle})`;
                                }
                            } catch {}
                        }
                        const statusClass = globalIdx < currentFlatIdx ? 'approved' : (globalIdx === currentFlatIdx ? 'current' : 'pending');
                        const statusText = globalIdx < currentFlatIdx ? 'Approved' : (globalIdx === currentFlatIdx ? 'Current' : 'Pending');
                        const meta = step.role && (!step.label || step.label !== who) ? `  ${step.role}` : '';
                        const l1Tag = (lvlIndex === 0 && step.substitutedFrom) ? `<span style="background:#e0f2fe; color:#0369a1; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:6px;">L+1</span>` : '';
                        const item = `
                            <div class="approval-stage ${statusClass}">
                                <span class="badge">Level ${lvlIndex+1}  ${statusText}</span>
                                <div style="display:flex; flex-direction:column;">
                                    <div style="font-weight:600; color:#1f2937;">${who}${extraMeta} ${l1Tag}</div>
                                    <div class="approval-meta">${step.label && step.label !== who ? step.label : (step.substitutedFrom ? 'Line Manager' : '')}${meta}</div>
                                </div>
                            </div>`;
                        globalIdx++;
                        return item;
                    }));
                    // Group: a divider or caption could be added; keep concise
                    html.push(...levelItems);
                }
                container.innerHTML = html.join('');
            }

            async openNewTimesheetModal() {
                // Reset form
                const form = document.getElementById('timesheetForm');
                if (form) form.reset();

                const monthInput = document.getElementById('tsMonth');
                if (monthInput) monthInput.value = '';

                const tsIdField = document.getElementById('tsId');
                if (tsIdField) tsIdField.value = '';

                const totalField = document.getElementById('tsTotalHours');
                if (totalField) totalField.value = '';

                const notesField = document.getElementById('tsNotes');
                if (notesField) notesField.value = '';

                const daysContainer = document.getElementById('tsDaysContainer');
                if (daysContainer) daysContainer.innerHTML = '';

                const modal = document.getElementById('timesheetModal');
                if (modal) {
                    modal.style.display = 'flex';
                    // focus month picker for convenience
                    if (monthInput) monthInput.focus();
                    // Show next approver based on approval-settings flow
                    this.updateTimesheetApproverDisplay({ approvalHistory: [] });
                    // Hide approval buttons for new timesheet creation
                    this.updateApprovalButtonVisibility({ status: 'draft' });
                    // ensure sizing fits the viewport
                    setTimeout(() => this.adjustTimesheetModalSize(), 60);
                }

                // Fetch allocated weekly hours from employee contract and display it
                try {
                    const email = (this.currentUser && this.currentUser.email) ? this.currentUser.email : '';
                    const wh = await this.fetchWorkingHoursForUserEmail(email);
                    this._tsAllocatedWeeklyHours = wh;
                    const span = document.getElementById('tsAllocatedWeeklyHours');
                    if (span) span.textContent = String(wh);
                    // Also fetch working hours per day for per-day overtime column
                    try {
                        const whDay = await this.fetchWorkingHoursPerDayForUserEmail(email);
                        this._tsWorkingHoursPerDay = (typeof whDay === 'number' && whDay > 0) ? whDay : 8;
                    } catch (e) {
                        this._tsWorkingHoursPerDay = 8;
                    }
                    // Initial overtime display
                    if (typeof this.updateTimesheetOvertimeDisplay === 'function') {
                        this.updateTimesheetOvertimeDisplay();
                    }
                } catch (e) {
                    console.warn('Unable to fetch allocated weekly hours:', e);
                }
            }

            closeTimesheetModal() {
                const modal = document.getElementById('timesheetModal');
                if (modal) modal.style.display = 'none';
            }

            async saveTimesheet(submit=false) {
                if (!this.currentUser) return this.showNotification('User not authenticated', 'error');
                const month = document.getElementById('tsMonth').value; // YYYY-MM
                const totalHours = parseFloat(document.getElementById('tsTotalHours').value) || 0;
                const notes = document.getElementById('tsNotes').value.trim();

                if (!month) return this.showNotification('Please select a month for the timesheet', 'error');

                // collect per-day hours
                const daysContainer = document.getElementById('tsDaysContainer');
                const days = [];
                if (daysContainer) {
                    // Rows are grid children; read per-row inputs by data-date
                    const rows = Array.from(daysContainer.children);
                    for (const row of rows) {
                        const date = row.querySelector('input[type="time"]')?.dataset.date || row.querySelector('input[data-date]')?.dataset.date;
                        if (!date) continue;
                        const start = row.querySelector('input[type="time"]') ? row.querySelectorAll('input[type="time"]')[0].value : '';
                        const end = row.querySelector('input[type="time"]') ? row.querySelectorAll('input[type="time"]')[1].value : '';
                        const br = row.querySelector('input[type="number"]') ? parseFloat(row.querySelector('input[type="number"]').value) || 0 : 0;
                        const comment = row.querySelector('input[type="text"]') ? row.querySelector('input[type="text"]').value : '';
                        const hoursDisplay = row.querySelector('div[data-date]');
                        const hours = hoursDisplay ? parseFloat(hoursDisplay.textContent) || 0 : 0;

                        days.push({ date, start, end, break: br, comment, hours });
                    }
                }

                // compute total from days to ensure consistency
                const computedTotal = this.computeTotalHoursFromDays();
                const finalTotal = Math.round((computedTotal + Number.EPSILON) * 100) / 100;
                // compute overtime against allocated weekly hours
                const alloc = this._tsAllocatedWeeklyHours || 40;
                const overtimeHours = (typeof this.computeMonthlyOvertimeFromGrid === 'function') ? this.computeMonthlyOvertimeFromGrid(alloc) : 0;


                try {
                    this.showLoading(true);
                    const now = Date.now();

                    // Check if editing an existing timesheet
                    const existingId = document.getElementById('tsId') ? document.getElementById('tsId').value : '';
                    let timesheetObj;
                    if (existingId) {
                        // Load existing to preserve createdAt
                        const existingSnap = await db.ref(`timesheets/${existingId}`).once('value');
                        const existing = existingSnap.exists() ? existingSnap.val() : null;
                        timesheetObj = {
                            id: existingId,
                            month,
                            days,
                            totalHours: finalTotal,
                            allocatedWeeklyHours: alloc,
                            overtimeHours: overtimeHours,
                            notes,
                            createdAt: existing ? (existing.createdAt || now) : now,
                            updatedAt: now,
                            submittedBy: this.currentUser.uid,
                            submittedByEmail: this.currentUser.email,
                            status: submit ? 'submitted' : (existing ? (existing.status || 'draft') : 'draft')
                        };

                        // Update existing record
                        await db.ref(`timesheets/${existingId}`).set(timesheetObj);
                        // Company-scoped mirror
                        try { const companyId=this.currentUser?.companyId; if(companyId){ await db.ref(`companies/${companyId}/timesheets/${existingId}`).set(timesheetObj); } } catch(e){ console.warn('Company timesheet mirror update failed', e); }
                    } else {
                        const newId = `TS-${this.currentUser.uid}-${now}`;
                        timesheetObj = {
                            id: newId,
                            month,
                            days,
                            totalHours: finalTotal,
                            allocatedWeeklyHours: alloc,
                            overtimeHours: overtimeHours,
                            notes,
                            createdAt: now,
                            updatedAt: now,
                            submittedBy: this.currentUser.uid,
                            submittedByEmail: this.currentUser.email,
                            status: submit ? 'submitted' : 'draft'
                        };

                        // Save new record
                        await db.ref(`timesheets/${newId}`).set(timesheetObj);
                        // Company-scoped mirror
                        try { const companyId=this.currentUser?.companyId; if(companyId){ await db.ref(`companies/${companyId}/timesheets/${newId}`).set(timesheetObj); } } catch(e){ console.warn('Company timesheet mirror create failed', e); }
                    }

                    // Refresh local list
                    await this.loadUserTimesheets();

                    if (submit) {
                        await this.submitTimesheetForApproval(timesheetObj);
                        this.showNotification('Timesheet submitted for approval', 'success');
                    } else {
                        this.showNotification('Timesheet saved', 'success');
                    }

                    // clear editing id
                    const tsIdField = document.getElementById('tsId');
                    if (tsIdField) tsIdField.value = '';

                    this.closeTimesheetModal();
                } catch (error) {
                    console.error('Error saving timesheet:', error);
                    this.showNotification('Failed to save timesheet', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async submitTimesheetForApproval(timesheetObj) {
                try {
                    // Build a basic approval entry format similar to other modules
                    const approvalEntry = {
                        id: `APP-TS-${timesheetObj.id}`,
                        sourceId: timesheetObj.id,
                        sourceType: 'timesheet',
                        submittedAt: Date.now(),
                        submittedBy: timesheetObj.submittedBy,
                        submittedByEmail: timesheetObj.submittedByEmail,
                        status: 'submitted'
                    };

                    // Attach approvalHistory to the timesheet
                    await db.ref(`timesheets/${timesheetObj.id}/approvalHistory`).set([approvalEntry]);
                    try { const companyId=this.currentUser?.companyId; if(companyId){ await db.ref(`companies/${companyId}/timesheets/${timesheetObj.id}/approvalHistory`).set([approvalEntry]); } } catch(e){ console.warn('Company approvalHistory mirror failed', e); }

                    // Send email notification using existing service if available
                    if (window.emailNotificationService && typeof window.emailNotificationService.sendApprovalNotificationEmails === 'function') {
                        try {
                            await window.emailNotificationService.sendApprovalNotificationEmails({
                                id: approvalEntry.id,
                                sourceType: approvalEntry.sourceType,
                                sourceId: approvalEntry.sourceId
                            }, timesheetObj.id, false);
                            console.log('Approval notification sent for timesheet', timesheetObj.id);
                        } catch (emailErr) {
                            console.warn('Failed to send approval notification email for timesheet', emailErr);
                        }
                    }
                } catch (error) {
                    console.error('Error submitting timesheet for approval:', error);
                }
            }

            async loadRecentActivity() {
                if (!this.currentUser) return;

                try {
                    const activities = [];
                    const userId = this.currentUser.uid;

                    // Load login activities from user record
                    const userRef = db.ref(`users/${userId}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();

                    if (userData?.lastLogin) {
                        activities.push({
                            type: 'login',
                            title: 'Logged in',
                            timestamp: userData.lastLogin,
                            icon: 'fas fa-sign-in-alt',
                            iconClass: 'login'
                        });
                    }

                    if (userData?.updatedAt && userData?.updatedAt !== userData?.createdAt) {
                        activities.push({
                            type: 'profile',
                            title: 'Updated profile information',
                            timestamp: userData.updatedAt,
                            icon: 'fas fa-user-edit',
                            iconClass: 'profile'
                        });
                    }

                    if (userData?.createdAt) {
                        activities.push({
                            type: 'account',
                            title: 'Account created',
                            timestamp: userData.createdAt,
                            icon: 'fas fa-user-plus',
                            iconClass: 'profile'
                        });
                    }

                    // Load all training requests (not limited)
                    const trainingRef = db.ref('trainingRequests');
                    const trainingSnapshot = await trainingRef.orderByChild('submittedBy').equalTo(userId).once('value');
                    
                    if (trainingSnapshot.exists()) {
                        const trainingData = trainingSnapshot.val();
                        Object.values(trainingData).forEach(request => {
                            activities.push({
                                type: 'training',
                                title: `Submitted training request: ${request.trainingType || 'Training'}`,
                                timestamp: request.submittedAt || request.createdAt,
                                icon: 'fas fa-graduation-cap',
                                iconClass: 'request',
                                details: `Status: ${request.status || 'Pending'}`
                            });
                        });
                    }

                    // Load all access requests (not limited)
                    const accessRef = db.ref('access');
                    const accessSnapshot = await accessRef.orderByChild('submittedBy').equalTo(userId).once('value');
                    
                    if (accessSnapshot.exists()) {
                        const accessData = accessSnapshot.val();
                        Object.values(accessData).forEach(request => {
                            activities.push({
                                type: 'access',
                                title: `Requested access to ${request.location || 'area'}`,
                                timestamp: request.submittedAt || request.createdAt,
                                icon: 'fas fa-key',
                                iconClass: 'security',
                                details: `Status: ${request.status || 'Pending'}`
                            });
                        });
                    }

                    // Load password updates (if we track them)
                    if (userData?.passwordUpdatedAt) {
                        activities.push({
                            type: 'security',
                            title: 'Updated password',
                            timestamp: userData.passwordUpdatedAt,
                            icon: 'fas fa-lock',
                            iconClass: 'security'
                        });
                    }

                    // Add avatar upload activity if tracked
                    if (userData?.profileImage && userData?.updatedAt) {
                        activities.push({
                            type: 'profile',
                            title: 'Updated profile photo',
                            timestamp: userData.updatedAt,
                            icon: 'fas fa-camera',
                            iconClass: 'profile'
                        });
                    }

                    // Sort activities by timestamp (most recent first)
                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Show all activities (no limit)
                    this.renderActivityList(activities);

                } catch (error) {
                    console.error('Error loading recent activity:', error);
                    this.renderActivityError();
                }
            }

            renderActivityList(activities) {
                const activityContainer = document.getElementById('recentActivity');
                
                if (!activities || activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="activity-empty">
                            <i class="fas fa-clock"></i>
                            <div>No activity found</div>
                            <small>Your activities will appear here as you use the system</small>
                        </div>
                    `;
                    return;
                }

                // Group activities by date for better organization
                const groupedActivities = this.groupActivitiesByDate(activities);
                
                let activityHTML = '';
                
                Object.entries(groupedActivities).forEach(([dateGroup, dayActivities]) => {
                    activityHTML += `
                        <div class="activity-date-group">
                            <div class="activity-date-header">${dateGroup}</div>
                            <div class="activity-list">
                    `;
                    
                    dayActivities.forEach(activity => {
                        const timeAgo = this.formatTimeAgo(activity.timestamp);
                        const userTimezone = this.currentUser?.timezone || 'UTC';
                        let timeOnly;
                        
                        try {
                            timeOnly = new Date(activity.timestamp).toLocaleTimeString([], {
                                hour: '2-digit', 
                                minute: '2-digit',
                                timeZone: userTimezone
                            });
                        } catch (error) {
                            timeOnly = new Date(activity.timestamp).toLocaleTimeString([], {
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                        }
                        
                        activityHTML += `
                            <div class="activity-item">
                                <div class="activity-icon ${activity.iconClass}">
                                    <i class="${activity.icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.title}</div>
                                    ${activity.details ? `<div class="activity-details">${activity.details}</div>` : ''}
                                    <div class="activity-time">
                                        <span class="time-specific">${timeOnly}</span>
                                        <span class="time-relative">${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    activityHTML += `
                            </div>
                        </div>
                    `;
                });

                activityContainer.innerHTML = activityHTML;
            }

            groupActivitiesByDate(activities) {
                const grouped = {};
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                activities.forEach(activity => {
                    const activityDate = new Date(activity.timestamp);
                    let dateKey;
                    
                    if (this.isSameDay(activityDate, today)) {
                        dateKey = 'Today';
                    } else if (this.isSameDay(activityDate, yesterday)) {
                        dateKey = 'Yesterday';
                    } else {
                        dateKey = activityDate.toLocaleDateString([], {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = [];
                    }
                    grouped[dateKey].push(activity);
                });
                
                return grouped;
            }

            isSameDay(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }

            renderActivityError() {
                const activityContainer = document.getElementById('recentActivity');
                activityContainer.innerHTML = `
                    <div class="activity-empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Failed to load activities</div>
                        <small>Please try refreshing the page</small>
                    </div>
                `;
            }

            formatTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                
                const now = new Date();
                const activityTime = new Date(timestamp);
                const diffInSeconds = Math.floor((now - activityTime) / 1000);

                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 604800) {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `${days} day${days !== 1 ? 's' : ''} ago`;
                } else {
                    // Use user's timezone preference if available
                    const userTimezone = this.currentUser?.timezone || 'UTC';
                    try {
                        return activityTime.toLocaleDateString('en-US', {
                            timeZone: userTimezone
                        });
                    } catch (error) {
                        return activityTime.toLocaleDateString();
                    }
                }
            }

            async loadCompanyInfo() {
                try {
                    console.log(' Loading company information...');
                    // Prefer companyId from authManager or stored currentUser
                    let companyId = null;
                    if (window.authManager?.currentUser?.companyId) {
                        companyId = window.authManager.currentUser.companyId;
                        console.log(' Using companyId from authManager:', companyId);
                    } else if (this.currentUser?.companyId) {
                        companyId = this.currentUser.companyId;
                        console.log(' Using companyId from currentUser:', companyId);
                    }

                    if (companyId) {
                        const companyRefById = db.ref(`companies/${companyId}`);
                        const snap = await companyRefById.once('value');
                        if (snap.exists()) {
                            const companyData = snap.val();
                            this.currentCompany = { id: companyId, ...companyData };
                            console.log(' Company (by ID) loaded:', this.currentCompany);
                            this.updateHeaderBranding();
                            return;
                        } else {
                            console.warn(' Company not found by ID, will scan companies');
                        }
                    }

                    // Fallback: scan companies to locate the user's membership
                    const companyRef = db.ref('companies');
                    console.log(' Scanning all companies for membership...');
                    const snapshot = await companyRef.once('value');
                    const companiesData = snapshot.val();
                    if (companiesData) {
                        const entries = Object.entries(companiesData);
                        let found = null;
                        for (const [cid, comp] of entries) {
                            if (comp?.status && comp.status !== 'active') continue;
                            if (comp?.users && this.currentUser?.uid && (comp.users[this.currentUser.uid] || Object.values(comp.users).some(u => u?.authUid === this.currentUser.uid))) {
                                found = { id: cid, ...comp };
                                break;
                            }
                        }
                        if (found) {
                            this.currentCompany = found;
                            console.log(' Company (by membership) loaded:', this.currentCompany);
                            // Persist on currentUser for later
                            this.currentUser.companyId = found.id;
                            this.currentUser.companyName = found.companyName || found.name || '';
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                            this.updateHeaderBranding();
                        } else {
                            console.log(' No matching company found for user');
                            this.showFallbackBranding();
                        }
                    } else {
                        console.log(' No company data available');
                        this.showFallbackBranding();
                    }
                } catch (error) {
                    console.error(' Error loading company info:', error);
                    this.showFallbackBranding();
                }
            }

            updateHeaderBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                const nameEl = document.getElementById('headerCompanyName');
                if (!this.currentCompany) { 
                    this.showFallbackBranding(); 
                    return; 
                }
                if (nameEl) nameEl.textContent = this.currentCompany.companyName || this.currentCompany.name || '';
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoEl) {
                    if (logoUrl) {
                        logoEl.src = logoUrl;
                        logoEl.classList.add('visible');
                    } else {
                        const svg = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || this.currentCompany.name || ''));
                        logoEl.src = svg;
                        logoEl.classList.add('visible');
                    }
                }
                if (this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    if (this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                }
            }
            
            getCompanyInitials(name) {
                if (!name) return 'CO';
                const parts = name.trim().split(/\s+/);
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            
            generateCompanyInitialsSVG(initials) {
                const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
                return 'data:image/svg+xml;base64,' + btoa(svg);
            }

            showFallbackBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                if (logoEl) {
                    const svg = this.generateCompanyInitialsSVG('DX');
                    logoEl.src = svg;
                    logoEl.classList.add('visible');
                }
            }

            resetHeaderBranding() {
                console.log(' resetHeaderBranding() - clearing all branding elements');
                
                const headerCompanyLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');
                
                // Hide/reset all elements
                if (headerCompanyLogo) {
                    headerCompanyLogo.style.display = 'none';
                    headerCompanyLogo.classList.remove('visible');
                    headerCompanyLogo.src = '';
                }
                
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'flex';
                }
                
                if (headerCompanyName) {
                    headerCompanyName.textContent = '';
                }
            }

            // Feature-based menu authorization system
            async updateMenuVisibility() {
                console.log(' Starting feature authorization update...');
                
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error(' Error in feature authorization:', error);
                    showBasicMenu();
                }
            }

            async loadUserCompany() {
                console.log(' loadUserCompany() called');
                console.log(' currentUser:', this.currentUser);
                
                if (!this.currentUser) {
                    console.warn(' No currentUser available for loadUserCompany');
                    return;
                }

                try {
                    const companiesRef = db.ref('companies');
                    console.log(' Fetching companies from Firebase...');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        console.log(' Companies data received:', Object.keys(companies).length, 'companies');
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        console.log(' Found user in company:', company.companyName, '(ID:', companyId, ')');
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            console.log(' Setting currentCompany:', foundCompany);
                            
                            // Update localStorage with company info
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        } else {
                            console.log(' User not found in any active company');
                        }
                    } else {
                        console.log(' No companies found in database');
                    }
                } catch (error) {
                    console.error(' Error loading user company:', error);
                }
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-nav-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabName = button.getAttribute('data-tab');
                        this.switchTab(tabName);
                    });
                });

                // Avatar upload
                document.getElementById('avatarUpload').addEventListener('change', (e) => {
                    this.handleAvatarUpload(e);
                });

                // Personal info form
                document.getElementById('personalInfoForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePersonalInfo();
                });

                // Security form
                document.getElementById('securityForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updatePassword();
                });

                // Preferences form
                document.getElementById('preferencesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePreferences();
                });

                // Password validation
                document.getElementById('newPassword').addEventListener('input', (e) => {
                    this.validatePassword(e.target.value);
                });

                // Hide password tooltip when user starts typing
                document.getElementById('currentPassword').addEventListener('input', () => {
                    this.hidePasswordTooltip();
                });

                // Language and timezone instant updates
                document.getElementById('language').addEventListener('change', (e) => {
                    this.updateLanguagePreference(e.target.value);
                });

                document.getElementById('timezone').addEventListener('change', (e) => {
                    this.updateTimezonePreference(e.target.value);
                });

                // Password toggle keyboard accessibility
                document.querySelectorAll('.password-toggle').forEach(button => {
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            button.click();
                        }
                    });
                });

                // Profile dropdown functionality
                this.setupProfileDropdown();

                // Timesheet handlers
                const createBtn = document.getElementById('createTimesheetBtn');
                if (createBtn) {
                    createBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.openNewTimesheetModal();
                    });
                }

                const closeModalBtn = document.getElementById('closeTimesheetModal');
                if (closeModalBtn) closeModalBtn.addEventListener('click', () => this.closeTimesheetModal());

                const saveBtn = document.getElementById('saveTimesheetBtn');
                if (saveBtn) saveBtn.addEventListener('click', () => this.saveTimesheet(false));

                const submitBtn = document.getElementById('submitTimesheetBtn');
                if (submitBtn) submitBtn.addEventListener('click', () => this.saveTimesheet(true));

                // Month picker change -> generate day rows
                const monthPicker = document.getElementById('tsMonth');
                if (monthPicker) {
                    monthPicker.addEventListener('change', (e) => {
                        this.generateMonthDays(e.target.value);
                        // adjust modal sizing after month selection
                        setTimeout(() => this.adjustTimesheetModalSize(), 50);
                    });
                }

                const closeFooterBtn = document.getElementById('closeTimesheetFooterBtn');
                if (closeFooterBtn) closeFooterBtn.addEventListener('click', () => this.closeTimesheetModal());

                // Footer Save and Submit buttons
                const footerSaveBtn = document.getElementById('footerSaveBtn');
                if (footerSaveBtn) footerSaveBtn.addEventListener('click', () => this.saveTimesheet(false));

                const footerSubmitBtn = document.getElementById('footerSubmitBtn');
                if (footerSubmitBtn) footerSubmitBtn.addEventListener('click', () => this.saveTimesheet(true));

                // Approval buttons for timesheet modal
                const approveTimesheetBtn = document.getElementById('approveTimesheetBtn');
                if (approveTimesheetBtn) approveTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('approve'));

                const declineTimesheetBtn = document.getElementById('declineTimesheetBtn');
                if (declineTimesheetBtn) declineTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('decline'));

                const deleteTimesheetBtn = document.getElementById('deleteTimesheetBtn');
                if (deleteTimesheetBtn) deleteTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('delete'));

                // Approval buttons for view timesheet modal
                const viewApproveTimesheetBtn = document.getElementById('viewApproveTimesheetBtn');
                if (viewApproveTimesheetBtn) viewApproveTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('approve'));

                const viewDeclineTimesheetBtn = document.getElementById('viewDeclineTimesheetBtn');
                if (viewDeclineTimesheetBtn) viewDeclineTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('decline'));

                const viewDeleteTimesheetBtn = document.getElementById('viewDeleteTimesheetBtn');
                if (viewDeleteTimesheetBtn) viewDeleteTimesheetBtn.addEventListener('click', () => this.handleTimesheetApproval('delete'));

                // Payslip refresh
                const refreshPayslipsBtn = document.getElementById('refreshPayslipsBtn');
                if (refreshPayslipsBtn) refreshPayslipsBtn.addEventListener('click', ()=> this.loadPayslips());

                // Listen for external payroll run changes (e.g., deletion in payroll-runs.html)
                window.addEventListener('payroll:runs:changed', (ev)=>{
                    // Only refresh if payslip tab is visible or cache exists
                    const activeTabBtn = document.querySelector('.tab-nav-btn.active');
                    if(activeTabBtn && activeTabBtn.getAttribute('data-tab')==='payslip'){
                        this.loadPayslips();
                    } else {
                        // Invalidate cache so next open refreshes
                        this._cachedPayslips = null;
                    }
                });

                // Adjust modal sizing on window resize while modal is open
                window.addEventListener('resize', () => {
                    const modal = document.getElementById('timesheetModal');
                    if (modal && modal.style.display !== 'none') {
                        this.adjustTimesheetModalSize();
                    }
                });

                // Toggle Approval Flow visibility in Timesheet modal
                const showFlowBtn = document.getElementById('showApprovalFlowBtnTs');
                const flowDisplay = document.getElementById('tsApprovalFlowDisplay');
                if (showFlowBtn && flowDisplay) {
                    showFlowBtn.addEventListener('click', () => {
                        const isHidden = flowDisplay.style.display === 'none' || flowDisplay.style.display === '';
                        flowDisplay.style.display = isHidden ? 'block' : 'none';
                        showFlowBtn.innerHTML = isHidden
                            ? '<i class="fas fa-diagram-project"></i> Hide Approval Flow'
                            : '<i class="fas fa-diagram-project"></i> Show Approval Flow';
                        if (isHidden) setTimeout(() => this.adjustTimesheetModalSize(), 30);
                    });
                }

                // Signature: open create modal
                const sigAddBtn = document.getElementById('sigAddBtn');
                if (sigAddBtn) sigAddBtn.addEventListener('click', () => this.openSignatureCreateModal());
            }

            // ---- Digital Signature (Security tab) ----
            initSignatureSection() {
                try {
                    const canvas = document.getElementById('signatureCanvas');
                    const drawBtn = document.getElementById('sigModeDraw');
                    const typeBtn = document.getElementById('sigModeType');
                    const typeControls = document.getElementById('sigTypeControls');
                    const typedInput = document.getElementById('typedSignatureInput');
                    const typedFont = document.getElementById('typedSignatureFont');
                    const clearBtn = document.getElementById('sigClearBtn');
                    const saveBtn = document.getElementById('sigSaveBtn');
                    const dlBtn = document.getElementById('sigDownloadBtn');
                    const delBtn = document.getElementById('sigDeleteBtn');
                    const preview = document.getElementById('signaturePreview');
                    const empty = document.getElementById('signatureEmpty');
                    const gallery = document.getElementById('signatureGallery');
                    const tableBody = document.getElementById('signatureTableBody');

                    this._sig = this._sig || {};
                    this._sig.previewEl = preview || null;
                    this._sig.emptyEl = empty || null;
                    this._sig.deleteBtn = delBtn || null;
                    this._sig.galleryEl = gallery || null;
                    this._sig.tableBodyEl = tableBody || null;
                    this._sig.inited = true;

                    // If creation controls exist in-section, wire them; otherwise rely on modal
                    if (canvas && drawBtn && typeBtn) {
                        const ctx = canvas.getContext('2d');
                        ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#111827';
                        this._sig.canvas = canvas; this._sig.ctx = ctx; this._sig.mode = 'draw';

                        const setModeUI = (mode) => {
                            this._sig.mode = mode;
                            if (mode === 'draw') {
                                if (drawBtn){ drawBtn.style.background = '#111827'; drawBtn.style.color = '#fff'; }
                                if (typeBtn){ typeBtn.style.background = '#fff'; typeBtn.style.color = '#111827'; }
                                if (typeControls) typeControls.style.display = 'none';
                            } else {
                                if (typeBtn){ typeBtn.style.background = '#111827'; typeBtn.style.color = '#fff'; }
                                if (drawBtn){ drawBtn.style.background = '#fff'; drawBtn.style.color = '#111827'; }
                                if (typeControls) typeControls.style.display = 'inline-flex';
                                this.renderTypedSignature();
                            }
                        };

                        const getPos = (e) => { const rect = canvas.getBoundingClientRect(); if (e.touches && e.touches[0]) return { x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top }; return { x:e.clientX-rect.left, y:e.clientY-rect.top }; };
                        const start = (e) => { if (this._sig.mode!=='draw') return; this._sig.drawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
                        const move  = (e) => { if (!this._sig.drawing || this._sig.mode!=='draw') return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
                        const end   = () => { this._sig.drawing=false; };
                        canvas.addEventListener('mousedown', start);
                        canvas.addEventListener('mousemove', move);
                        window.addEventListener('mouseup', end);
                        canvas.addEventListener('touchstart', start, { passive:false });
                        canvas.addEventListener('touchmove', move, { passive:false });
                        window.addEventListener('touchend', end);

                        // Mode switching
                        if (drawBtn) drawBtn.addEventListener('click', () => setModeUI('draw'));
                        if (typeBtn) typeBtn.addEventListener('click', () => setModeUI('type'));
                        if (typedInput) typedInput.addEventListener('input', () => this.renderTypedSignature());
                        if (typedFont) typedFont.addEventListener('change', () => this.renderTypedSignature());
                        if (clearBtn) clearBtn.addEventListener('click', () => { ctx.clearRect(0,0,canvas.width,canvas.height); if (this._sig.mode==='type') this.renderTypedSignature(); });
                        if (saveBtn) saveBtn.addEventListener('click', () => this.saveSignature());
                        if (dlBtn) dlBtn.addEventListener('click', () => { const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='signature.png'; document.body.appendChild(a); a.click(); a.remove(); });
                        if (delBtn) delBtn.addEventListener('click', () => this.deleteSignature());

                        setModeUI('draw');
                    }
                } catch (e) { console.warn('Signature init failed', e); }
            }

            renderTypedSignature() {
                const canvas = this._sig?.canvas; const ctx = this._sig?.ctx; if (!canvas || !ctx) return;
                const typedInput = document.getElementById('typedSignatureInput');
                const typedFont = document.getElementById('typedSignatureFont');
                const text = (typedInput?.value || '').trim() || 'Your Name';
                const font = typedFont?.value || "'Brush Script MT', cursive";
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.fillStyle = '#111827';
                ctx.font = `64px ${font}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, canvas.width / 2, canvas.height / 2);
                ctx.restore();
            }

            async loadSavedSignaturePreview() {
                try {
                    const cid = this.currentUser?.companyId; const uid = this.currentUser?.uid;
                    if (!cid || !uid) return;
                    const userBase = `companies/${cid}/users/${uid}`;
                    const [urlSnap, listSnap, defSnap] = await Promise.all([
                        db.ref(`${userBase}/signatureUrl`).once('value'),
                        db.ref(`${userBase}/signatures`).once('value'),
                        db.ref(`${userBase}/defaultSignatureId`).once('value'),
                    ]);
                    const legacyUrl = urlSnap.val();
                    const signatures = listSnap.val() || {};
                    const defaultId = defSnap.val() || null;
                    this.renderSignatureGallery(signatures, defaultId);
                    this.renderSignatureTable(signatures, defaultId);

                    const prev = this._sig?.previewEl; const empty = this._sig?.emptyEl; const del = this._sig?.deleteBtn;
                    const ids = Object.keys(signatures);
                    let useId = defaultId && signatures[defaultId] ? defaultId : (ids.length ? ids.sort((a,b)=> (signatures[b].createdAt||0)-(signatures[a].createdAt||0))[0] : null);
                    let url = useId ? signatures[useId].url : legacyUrl;
                    this._sig.selectedId = useId || null;
                    if (url && prev) {
                        prev.src = url; prev.style.display = 'inline-block';
                        if (empty) empty.style.display = 'none';
                        if (del) del.style.display = useId ? 'inline-block' : (legacyUrl ? 'inline-block' : 'none');
                        this._sig.hasSaved = true;
                    } else {
                        if (prev) { prev.removeAttribute('src'); prev.style.display = 'none'; }
                        if (empty) empty.style.display = 'inline';
                        if (del) del.style.display = 'none';
                        this._sig.hasSaved = false;
                    }
                } catch (e) { console.warn('Load signature preview failed', e); }
            }

            renderSignatureGallery(signatures, defaultId){
                try {
                    const gallery = this._sig?.galleryEl; if (!gallery) return;
                    gallery.innerHTML = '';
                    const ids = Object.keys(signatures||{}).sort((a,b)=> (signatures[b].createdAt||0)-(signatures[a].createdAt||0));
                    if (!ids.length) return;
                    ids.forEach(id => {
                        const item = signatures[id];
                        const wrap = document.createElement('div');
                        wrap.style.cssText = 'border:1px solid #e5e7eb; border-radius:8px; padding:8px; background:#fff; display:flex; flex-direction:column; align-items:center; gap:6px; width:160px;';
                        const img = document.createElement('img');
                        img.src = item.url; img.alt = 'Signature';
                        img.style.cssText = 'max-width:100%; max-height:64px; object-fit:contain; background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:4px; cursor:pointer;';
                        img.addEventListener('click', ()=> this.selectSignature(id, item.url));
                        const btnRow = document.createElement('div');
                        btnRow.style.cssText = 'display:flex; gap:6px;';
                        const useBtn = document.createElement('button');
                        useBtn.type = 'button'; useBtn.textContent = 'Use';
                        useBtn.className = 'btn-secondary';
                        useBtn.style.cssText = 'padding:4px 8px; font-size:.75rem; border:1px solid #e5e7eb; background:#fff; border-radius:6px;';
                        useBtn.addEventListener('click', ()=> this.selectSignature(id, item.url));
                        const delBtn = document.createElement('button');
                        delBtn.type = 'button'; delBtn.textContent = 'Delete';
                        delBtn.className = 'btn-danger';
                        delBtn.style.cssText = 'padding:4px 8px; font-size:.75rem; border:1px solid #fecaca; background:#fef2f2; color:#991b1b; border-radius:6px;';
                        delBtn.addEventListener('click', ()=> this.deleteSignature(id));
                        const defBtn = document.createElement('button');
                        defBtn.type = 'button';
                        defBtn.textContent = defaultId === id ? 'Default ' : 'Set Default';
                        defBtn.className = 'btn-secondary';
                        defBtn.style.cssText = 'padding:4px 8px; font-size:.75rem; border:1px solid #e5e7eb; background:#fff; border-radius:6px;';
                        defBtn.addEventListener('click', async ()=> { await this.setDefaultSignature(id); });
                        btnRow.appendChild(useBtn); btnRow.appendChild(delBtn); btnRow.appendChild(defBtn);
                        wrap.appendChild(img); wrap.appendChild(btnRow);
                        if (defaultId === id) wrap.style.boxShadow = '0 0 0 2px #111827 inset';
                        gallery.appendChild(wrap);
                    });
                } catch(e){ console.warn('Render signature gallery failed', e); }
            }

            renderSignatureTable(signatures, defaultId){
                try{
                    const body = this._sig?.tableBodyEl; if(!body) return;
                    body.innerHTML = '';
                    const ids = Object.keys(signatures||{}).sort((a,b)=> (signatures[b].createdAt||0)-(signatures[a].createdAt||0));
                    if (!ids.length){
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="4" style="padding:10px; color:#9ca3af;">No signatures saved</td>`;
                        body.appendChild(tr);
                        return;
                    }
                    ids.forEach(id => {
                        const item = signatures[id] || {};
                        const created = item.createdAt ? new Date(item.createdAt).toLocaleString() : '-';
                        const isDefault = defaultId === id;
                        const tr = document.createElement('tr');
                        tr.style.cssText = 'cursor:pointer; transition:background 0.15s;';
                        tr.addEventListener('mouseenter', () => tr.style.background = '#f8fafc');
                        tr.addEventListener('mouseleave', () => tr.style.background = '');
                        tr.innerHTML = `
                            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${isDefault ? '' : ''}</td>
                            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">
                                <img src="${item.url||''}" alt="Signature" style="height:38px; max-width:180px; object-fit:contain; background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:3px;"/>
                            </td>
                            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${created}</td>
                            <td style="padding:8px; border-bottom:1px solid #e5e7eb;" onclick="event.stopPropagation();">
                                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                    <button type="button" class="btn-secondary" style="padding:4px 8px; font-size:.75rem; border:1px solid #e5e7eb; background:#fff; border-radius:6px;">Use</button>
                                    <button type="button" class="btn-secondary" style="padding:4px 8px; font-size:.75rem; border:1px solid #e5e7eb; background:#fff; border-radius:6px;">${isDefault ? 'Default ' : 'Set Default'}</button>
                                    <button type="button" class="btn-secondary" style="padding:4px 8px; font-size:.75rem; border:1px solid #3b82f6; background:#eff6ff; color:#1d4ed8; border-radius:6px;">Edit</button>
                                    <button type="button" class="btn-danger" style="padding:4px 8px; font-size:.75rem; border:1px solid #fecaca; background:#fef2f2; color:#991b1b; border-radius:6px;">Delete</button>
                                    <button type="button" class="btn-secondary" style="padding:4px 8px; font-size:.75rem; border:1px solid #e5e7eb; background:#fff; border-radius:6px;">Download</button>
                                </div>
                            </td>
                        `;
                        // Row click opens selection modal
                        tr.addEventListener('click', () => this.openSignatureSelectModal());
                        const [useBtn, defBtn, editBtn, delBtn, dlBtn] = tr.querySelectorAll('button');
                        if (useBtn) useBtn.addEventListener('click', ()=> this.selectSignature(id, item.url||''));
                        if (defBtn) defBtn.addEventListener('click', async ()=> { await this.setDefaultSignature(id); });
                        if (editBtn) editBtn.addEventListener('click', ()=> this.openSignatureCreateModal(id, item.url||''));
                        if (delBtn) delBtn.addEventListener('click', ()=> this.deleteSignature(id));
                        if (dlBtn) dlBtn.addEventListener('click', ()=> { try{ const a=document.createElement('a'); a.href=item.url||'#'; a.download = `signature-${id}.png`; document.body.appendChild(a); a.click(); a.remove(); }catch{} });
                        body.appendChild(tr);
                    });
                } catch(e){ console.warn('Render signature table failed', e); }
            }

            selectSignature(id, url){
                try{
                    this._sig.selectedId = id;
                    if (this._sig?.previewEl){ this._sig.previewEl.src = url; this._sig.previewEl.style.display='inline-block'; }
                    if (this._sig?.emptyEl){ this._sig.emptyEl.style.display='none'; }
                    if (this._sig?.deleteBtn){ this._sig.deleteBtn.style.display='inline-block'; }
                } catch(e){ console.warn('Select signature failed', e); }
            }

            async setDefaultSignature(id){
                try{
                    const cid = this.currentUser?.companyId; const uid = this.currentUser?.uid;
                    if (!cid || !uid || !id) return;
                    const path = `companies/${cid}/users/${uid}`;
                    const item = (await db.ref(`${path}/signatures/${id}`).once('value')).val();
                    await db.ref(path).update({ defaultSignatureId: id, signatureUrl: item?.url || null });
                    this.showNotification && this.showNotification('Default signature updated', 'success');
                    await this.loadSavedSignaturePreview();
                } catch(e){ console.error('Set default signature failed', e); this.showNotification && this.showNotification('Failed to set default', 'error'); }
            }
            async saveSignature() {
                try {
                    const cid = this.currentUser?.companyId; const uid = this.currentUser?.uid;
                    if (!cid || !uid) { this.showNotification && this.showNotification('Not signed in', 'warning'); return; }
                    const canvas = this._sig?.canvas; if (!canvas) return;
                    const dataUrl = canvas.toDataURL('image/png');
                    const id = db.ref().push().key;
                    const path = `companies/${cid}/signatures/${uid}/${id}.png`;
                    const ref = storage.ref(path);
                    await ref.putString(dataUrl, 'data_url');
                    const downloadURL = await ref.getDownloadURL();
                    const userPath = `companies/${cid}/users/${uid}`;
                    const createdAt = Date.now();
                    await db.ref(`${userPath}/signatures/${id}`).set({ url: downloadURL, imageData: dataUrl, createdAt });
                    // maintain legacy field and set as default latest
                    await db.ref(userPath).update({ signatureUrl: downloadURL, defaultSignatureId: id });
                    this.showNotification && this.showNotification('Signature saved', 'success');
                    await this.loadSavedSignaturePreview();
                } catch (e) {
                    console.error('Save signature failed', e);
                    this.showNotification && this.showNotification('Failed to save signature', 'error');
                }
            }

            async deleteSignature(idParam) {
                // Confirmation prompt before irreversible deletion
                try {
                    const confirmed = window.confirm('Are you sure you want to delete this signature? This action cannot be undone.');
                    if (!confirmed) return; // abort if user cancels
                } catch(_) { /* fallback silently if confirm unavailable */ }
                try {
                    const cid = this.currentUser?.companyId; const uid = this.currentUser?.uid;
                    if (!cid || !uid) return;
                    const userBase = `companies/${cid}/users/${uid}`;
                    let id = idParam || this._sig?.selectedId || null;
                    if (id) {
                        const itemSnap = await db.ref(`${userBase}/signatures/${id}`).once('value');
                        const item = itemSnap.val();
                        if (item?.url) {
                            try { const sref = storage.refFromURL(item.url); await sref.delete(); } catch {}
                        }
                        await db.ref(`${userBase}/signatures/${id}`).remove();
                        const defSnap = await db.ref(`${userBase}/defaultSignatureId`).once('value');
                        const wasDefault = defSnap.val() === id;
                        if (wasDefault) {
                            await db.ref(`${userBase}/defaultSignatureId`).remove();
                            // Choose a new default if any signatures remain
                            const remainingSnap = await db.ref(`${userBase}/signatures`).once('value');
                            const remaining = remainingSnap.val() || {};
                            const keys = Object.keys(remaining);
                            if (keys.length) {
                                const newId = keys.sort((a,b)=> (remaining[b].createdAt||0)-(remaining[a].createdAt||0))[0];
                                const newUrl = remaining[newId]?.url || null;
                                await db.ref(userBase).update({ defaultSignatureId: newId, signatureUrl: newUrl });
                            } else {
                                // No signatures left; clear legacy field
                                await db.ref(userBase).update({ signatureUrl: null });
                            }
                        }
                    } else {
                        // legacy single-field delete
                        const url = (await db.ref(`${userBase}/signatureUrl`).once('value')).val();
                        if (url) { try { const ref = storage.refFromURL(url); await ref.delete(); } catch {} }
                        await db.ref(`${userBase}/signatureUrl`).remove();
                        await db.ref(`${userBase}/defaultSignatureId`).remove();
                    }
                    this.showNotification && this.showNotification('Signature deleted', 'success');
                    await this.loadSavedSignaturePreview();
                } catch (e) {
                    console.error('Delete signature failed', e);
                    this.showNotification && this.showNotification('Failed to delete signature', 'error');
                }
            }

            // ---- Signature Create Modal ----
            openSignatureCreateModal(editId = null, editUrl = null){
                try{
                    const modal = document.getElementById('signatureCreateModal');
                    if (!modal) return;
                    modal.style.display = 'flex';

                    // Store edit mode data
                    this._sigEditMode = editId ? { id: editId, url: editUrl } : null;

                    // Update modal title based on mode
                    const modalTitle = document.getElementById('sigCreateModalTitle');
                    if (modalTitle) {
                        modalTitle.textContent = editId ? 'Edit Signature' : 'Create Signature';
                    }

                    // Cache controls
                    const canvas = document.getElementById('signatureCreateCanvas');
                    const drawBtn = document.getElementById('sigCreateModeDraw');
                    const typeBtn = document.getElementById('sigCreateModeType');
                    const uploadBtn = document.getElementById('sigCreateModeUpload');
                    const typeControls = document.getElementById('sigCreateTypeControls');
                    const uploadControls = document.getElementById('sigCreateUploadControls');
                    const typedInput = document.getElementById('typedSignatureCreateInput');
                    const typedFont = document.getElementById('typedSignatureCreateFont');
                    const uploadInput = document.getElementById('signatureUploadInput');
                    const clearBtn = document.getElementById('sigCreateClearBtn');
                    const saveBtn = document.getElementById('sigCreateSaveBtn');
                    const cancelBtn = document.getElementById('sigCreateCancelBtn');

                    const ctx = canvas.getContext('2d');
                    ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#111827';

                    const S = this._sigCreate = this._sigCreate || { };
                    S.canvas = canvas; S.ctx = ctx; S.mode = 'draw'; S.drawing = false;
                    
                    // Reset unique signature ID for new signatures (will be generated when rendering)
                    S.signatureUniqueId = null;

                    // Clear canvas first
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    const setModeUI = (mode) => {
                        S.mode = mode;
                        S.activeTab = mode; // Track active tab for saving metadata
                        // Reset all buttons to default style
                        if (drawBtn){ drawBtn.style.background = '#fff'; drawBtn.style.color = '#111827'; }
                        if (typeBtn){ typeBtn.style.background = '#fff'; typeBtn.style.color = '#111827'; }
                        if (uploadBtn){ uploadBtn.style.background = '#fff'; uploadBtn.style.color = '#111827'; }
                        
                        // Hide all controls
                        if (typeControls) typeControls.style.display = 'none';
                        if (uploadControls) uploadControls.style.display = 'none';
                        
                        if (mode === 'draw') {
                            if (drawBtn){ drawBtn.style.background = '#111827'; drawBtn.style.color = '#fff'; }
                        } else if (mode === 'type') {
                            if (typeBtn){ typeBtn.style.background = '#111827'; typeBtn.style.color = '#fff'; }
                            if (typeControls) typeControls.style.display = 'inline-flex';
                            this.renderTypedSignatureCreate();
                        } else if (mode === 'upload') {
                            if (uploadBtn){ uploadBtn.style.background = '#111827'; uploadBtn.style.color = '#fff'; }
                            if (uploadControls) uploadControls.style.display = 'inline-flex';
                        }
                    };

                    const getPos = (e) => { const r = canvas.getBoundingClientRect(); if (e.touches && e.touches[0]) return { x: e.touches[0].clientX-r.left, y: e.touches[0].clientY-r.top }; return { x: e.clientX-r.left, y: e.clientY-r.top }; };
                    const start = (e) => { if (S.mode!=='draw') return; S.drawing = true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
                    const move  = (e) => { if (!S.drawing || S.mode!=='draw') return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
                    const end   = () => { S.drawing = false; };
                    // Attach and store so we can detach on close
                    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
                    canvas.addEventListener('touchstart', start, { passive:false }); canvas.addEventListener('touchmove', move, { passive:false }); window.addEventListener('touchend', end);
                    S._handlers = { start, move, end };

                    if (drawBtn) drawBtn.onclick = () => setModeUI('draw');
                    if (typeBtn) typeBtn.onclick = () => setModeUI('type');
                    if (uploadBtn) uploadBtn.onclick = () => setModeUI('upload');
                    if (typedInput) typedInput.oninput = () => this.renderTypedSignatureCreate();
                    if (typedFont) typedFont.onchange = () => this.renderTypedSignatureCreate();
                    
                    // Add handlers for new style and color controls
                    const typedStyle = document.getElementById('typedSignatureCreateStyle');
                    const typedColor = document.getElementById('typedSignatureCreateColor');
                    if (typedStyle) typedStyle.onchange = () => this.renderTypedSignatureCreate();
                    if (typedColor) typedColor.onchange = () => this.renderTypedSignatureCreate();
                    
                    if (uploadInput) uploadInput.onchange = (e) => this.loadUploadedSignatureImage(e);
                    if (clearBtn) clearBtn.onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); if (S.mode==='type') this.renderTypedSignatureCreate(); };
                    if (saveBtn) saveBtn.onclick = () => this.saveSignatureFromModal();
                    if (cancelBtn) cancelBtn.onclick = () => this.closeSignatureCreateModal();
                    
                    // Insert button: add signature to PDF without saving to database
                    const insertBtn = document.getElementById('sigCreateInsertBtn');
                    if (insertBtn) insertBtn.onclick = () => this.insertSignatureToPage();

                    // Set initial mode UI first (before loading image if editing)
                    setModeUI('draw');

                    // If editing, load existing signature onto canvas
                    if (editId && editUrl) {
                        // Show loading state
                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '14px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Loading signature...', canvas.width/2, canvas.height/2);
                        
                        // Helper function to draw image on canvas
                        const drawImageOnCanvas = (img) => {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            const canvasRatio = canvas.width / canvas.height;
                            const imageRatio = img.width / img.height;
                            let drawWidth, drawHeight, x, y;
                            if (imageRatio > canvasRatio) {
                                drawWidth = canvas.width;
                                drawHeight = canvas.width / imageRatio;
                                x = 0;
                                y = (canvas.height - drawHeight) / 2;
                            } else {
                                drawHeight = canvas.height;
                                drawWidth = canvas.height * imageRatio;
                                x = (canvas.width - drawWidth) / 2;
                                y = 0;
                            }
                            ctx.drawImage(img, x, y, drawWidth, drawHeight);
                        };
                        
                        // Try loading directly first (without crossOrigin for Firebase URLs)
                        const img = new Image();
                        let loaded = false;
                        
                        img.onload = () => {
                            if (loaded) return;
                            loaded = true;
                            drawImageOnCanvas(img);
                        };
                        
                        img.onerror = () => {
                            if (loaded) return;
                            console.warn('Direct load failed, trying with crossOrigin...');
                            
                            // Try with crossOrigin
                            const img2 = new Image();
                            img2.crossOrigin = 'anonymous';
                            img2.onload = () => {
                                if (loaded) return;
                                loaded = true;
                                drawImageOnCanvas(img2);
                            };
                            img2.onerror = () => {
                                if (loaded) return;
                                console.warn('crossOrigin load failed, trying fetch...');
                                
                                // Try fetching with fetch API as final fallback
                                fetch(editUrl, { mode: 'cors' })
                                    .then(res => {
                                        if (!res.ok) throw new Error('Fetch failed');
                                        return res.blob();
                                    })
                                    .then(blob => {
                                        if (loaded) return;
                                        const objectUrl = URL.createObjectURL(blob);
                                        const img3 = new Image();
                                        img3.onload = () => {
                                            if (loaded) return;
                                            loaded = true;
                                            drawImageOnCanvas(img3);
                                            URL.revokeObjectURL(objectUrl);
                                        };
                                        img3.onerror = () => {
                                            if (loaded) return;
                                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                                            ctx.fillStyle = '#ef4444';
                                            ctx.font = '14px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.fillText('Failed to load signature', canvas.width/2, canvas.height/2);
                                            URL.revokeObjectURL(objectUrl);
                                        };
                                        img3.src = objectUrl;
                                    })
                                    .catch(() => {
                                        if (loaded) return;
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.fillStyle = '#ef4444';
                                        ctx.font = '14px Arial';
                                        ctx.textAlign = 'center';
                                        ctx.fillText('Failed to load signature', canvas.width/2, canvas.height/2);
                                    });
                            };
                            img2.src = editUrl;
                        };
                        
                        img.src = editUrl;
                    }
                } catch(e){ console.warn('Open signature create modal failed', e); }
            }

            // Insert signature to PDF page without saving to database
            insertSignatureToPage(){
                try {
                    const S = this._sigCreate;
                    if (!S || !S.canvas) return;
                    
                    const dataUrl = S.canvas.toDataURL('image/png');
                    
                    // Check if Sign tab is active with a PDF loaded
                    const signWorkspace = document.getElementById('signWorkspace');
                    const pdfCanvas = document.getElementById('pdfCanvas');
                    if (!signWorkspace || !pdfCanvas || signWorkspace.style.display === 'none') {
                        this.showNotification && this.showNotification('Please upload a PDF first in the Sign Documents tab', 'warning');
                        return;
                    }
                    
                    // Close modal and start placement mode
                    this.closeSignatureCreateModal();
                    
                    // Use the global placement function
                    if (typeof window.startSignaturePlacement === 'function') {
                        window.startSignaturePlacement(dataUrl, 200, 80);
                    } else if (typeof window.addElementToOverlay === 'function') {
                        window.addElementToOverlay('signature', dataUrl, 200, 80);
                    }
                } catch(e) {
                    console.warn('Insert signature to page failed', e);
                    this.showNotification && this.showNotification('Failed to insert signature', 'error');
                }
            }

            closeSignatureCreateModal(){
                try{
                    const modal = document.getElementById('signatureCreateModal');
                    if (modal) modal.style.display = 'none';
                    
                    // Clear edit mode
                    this._sigEditMode = null;
                    
                    const S = this._sigCreate; if (!S) return;
                    const canvas = S.canvas;
                    if (S._handlers && canvas){
                        canvas.removeEventListener('mousedown', S._handlers.start);
                        canvas.removeEventListener('mousemove', S._handlers.move);
                        window.removeEventListener('mouseup', S._handlers.end);
                        canvas.removeEventListener('touchstart', S._handlers.start);
                        canvas.removeEventListener('touchmove', S._handlers.move);
                        window.removeEventListener('touchend', S._handlers.end);
                    }
                } catch(e){ console.warn('Close signature create modal failed', e); }
            }

            async openSignatureSelectModal(){
                try{
                    const modal = document.getElementById('signatureSelectModal');
                    if (!modal) return;
                    modal.style.display = 'flex';

                    const cid = this.currentUser?.companyId; const uid = this.currentUser?.uid;
                    if (!cid || !uid) return;

                    const grid = document.getElementById('signatureSelectGrid');
                    const empty = document.getElementById('signatureSelectEmpty');
                    const cancelBtn = document.getElementById('sigSelectCancelBtn');
                    const closeBtn = document.getElementById('sigSelectCloseBtn');
                    const newBtn = document.getElementById('sigSelectNewBtn');
                    const createBtn = document.getElementById('sigSelectCreateBtn');

                    // Wire up buttons
                    if (cancelBtn) cancelBtn.onclick = () => this.closeSignatureSelectModal();
                    if (closeBtn) closeBtn.onclick = () => this.closeSignatureSelectModal();
                    if (newBtn) newBtn.onclick = () => { this.closeSignatureSelectModal(); this.openSignatureCreateModal(); };
                    if (createBtn) createBtn.onclick = () => { this.closeSignatureSelectModal(); this.openSignatureCreateModal(); };

                    // Load signatures
                    const userBase = `companies/${cid}/users/${uid}`;
                    const [listSnap, defSnap] = await Promise.all([
                        db.ref(`${userBase}/signatures`).once('value'),
                        db.ref(`${userBase}/defaultSignatureId`).once('value'),
                    ]);
                    const signatures = listSnap.val() || {};
                    const defaultId = defSnap.val() || null;
                    const ids = Object.keys(signatures).sort((a,b)=> (signatures[b].createdAt||0)-(signatures[a].createdAt||0));

                    if (grid) grid.innerHTML = '';
                    
                    if (!ids.length) {
                        if (grid) grid.style.display = 'none';
                        if (empty) empty.style.display = 'block';
                        return;
                    }

                    if (grid) grid.style.display = 'grid';
                    if (empty) empty.style.display = 'none';

                    ids.forEach(id => {
                        const item = signatures[id] || {};
                        const isDefault = defaultId === id;
                        const created = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '';
                        
                        const card = document.createElement('div');
                        card.style.cssText = `border:2px solid ${isDefault ? '#111827' : '#e5e7eb'}; border-radius:10px; padding:12px; background:#fff; cursor:pointer; transition:all 0.15s; display:flex; flex-direction:column; align-items:center; gap:8px;`;
                        card.addEventListener('mouseenter', () => { if (!isDefault) card.style.borderColor = '#9ca3af'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; });
                        card.addEventListener('mouseleave', () => { card.style.borderColor = isDefault ? '#111827' : '#e5e7eb'; card.style.boxShadow = ''; });
                        
                        card.innerHTML = `
                            <div style="position:relative; width:100%;">
                                ${isDefault ? '<span style="position:absolute; top:-4px; right:-4px; background:#111827; color:#fff; font-size:0.65rem; padding:2px 6px; border-radius:4px;">Default</span>' : ''}
                                <img src="${item.url||''}" alt="Signature" style="width:100%; height:80px; object-fit:contain; background:#f8fafc; border:1px solid #e5e7eb; border-radius:6px; padding:4px;"/>
                            </div>
                            <div style="font-size:0.75rem; color:#6b7280;">${created}</div>
                            <div style="display:flex; gap:6px; width:100%;">
                                <button type="button" class="sig-select-use-btn" style="flex:1; padding:6px 8px; font-size:0.75rem; border:none; background:#111827; color:#fff; border-radius:6px;">Select</button>
                                <button type="button" class="sig-select-edit-btn" style="padding:6px 8px; font-size:0.75rem; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:6px;" title="Edit"><i class="fas fa-pen"></i></button>
                            </div>
                        `;

                        // Select button
                        const useBtn = card.querySelector('.sig-select-use-btn');
                        if (useBtn) useBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            await this.setDefaultSignature(id);
                            this.closeSignatureSelectModal();
                        });

                        // Edit button
                        const editBtn = card.querySelector('.sig-select-edit-btn');
                        if (editBtn) editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.closeSignatureSelectModal();
                            this.openSignatureCreateModal(id, item.url||'');
                        });

                        // Card click also selects
                        card.addEventListener('click', async () => {
                            await this.setDefaultSignature(id);
                            this.closeSignatureSelectModal();
                        });

                        if (grid) grid.appendChild(card);
                    });

                } catch(e){ console.warn('Open signature select modal failed', e); }
            }

            closeSignatureSelectModal(){
                try{
                    const modal = document.getElementById('signatureSelectModal');
                    if (modal) modal.style.display = 'none';
                } catch(e){ console.warn('Close signature select modal failed', e); }
            }

            renderTypedSignatureCreate(){
                try{
                    const S = this._sigCreate; if (!S) return;
                    const canvas = S.canvas; const ctx = S.ctx; if(!canvas||!ctx) return;
                    const typedInput = document.getElementById('typedSignatureCreateInput');
                    const typedFont = document.getElementById('typedSignatureCreateFont');
                    const typedStyle = document.getElementById('typedSignatureCreateStyle');
                    const typedColor = document.getElementById('typedSignatureCreateColor');
                    
                    const text = (typedInput?.value||'').trim() || 'Your Name';
                    const font = typedFont?.value || "'Brush Script MT', cursive";
                    const style = typedStyle?.value || 'normal';
                    const color = typedColor?.value || '#111827';
                    
                    // Generate or reuse unique signature ID (like DocuSign)
                    if (!S.signatureUniqueId) {
                        const timestamp = Date.now().toString(36).toUpperCase();
                        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
                        S.signatureUniqueId = `SIG-${timestamp}-${random}`;
                    }
                    
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    ctx.save();
                    ctx.fillStyle = color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Build font string with style
                    let fontWeight = 'normal';
                    let fontStyle = 'normal';
                    let underline = false;
                    
                    if (style === 'bold' || style === 'bold-italic') fontWeight = 'bold';
                    if (style === 'italic' || style === 'bold-italic') fontStyle = 'italic';
                    if (style === 'underline') underline = true;
                    
                    // Auto-scale font size to fit text within canvas
                    const maxWidth = canvas.width - 40; // padding
                    const maxHeight = canvas.height - 60; // Leave space for ID at bottom
                    let fontSize = 80; // Start with larger font
                    const minFontSize = 24;
                    
                    // Find optimal font size
                    do {
                        ctx.font = `${fontStyle} ${fontWeight} ${fontSize}px ${font}`;
                        const metrics = ctx.measureText(text);
                        const textWidth = metrics.width;
                        const textHeight = fontSize; // Approximate height
                        
                        if (textWidth <= maxWidth && textHeight <= maxHeight) {
                            break;
                        }
                        fontSize -= 2;
                    } while (fontSize > minFontSize);
                    
                    ctx.font = `${fontStyle} ${fontWeight} ${fontSize}px ${font}`;
                    
                    // Draw main signature text (slightly above center to make room for ID)
                    const textY = canvas.height / 2 - 15;
                    ctx.fillText(text, canvas.width/2, textY);
                    
                    // Draw underline if selected
                    if (underline) {
                        const textMetrics = ctx.measureText(text);
                        const textWidth = textMetrics.width;
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(canvas.width/2 - textWidth/2, textY + fontSize * 0.35);
                        ctx.lineTo(canvas.width/2 + textWidth/2, textY + fontSize * 0.35);
                        ctx.stroke();
                    }
                    
                    // Draw decorative line above ID
                    ctx.strokeStyle = '#d1d5db';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(canvas.width/2 - 200, canvas.height - 70);
                    ctx.lineTo(canvas.width/2 + 200, canvas.height - 70);
                    ctx.stroke();
                    
                    // Draw unique signature ID at bottom (like DocuSign) - larger and more visible
                    ctx.font = 'bold 22px "Courier New", monospace';
                    ctx.fillStyle = '#1f2937';
                    ctx.textAlign = 'center';
                    ctx.fillText(S.signatureUniqueId, canvas.width/2, canvas.height - 40);
                    
                    // Draw timestamp - larger and more visible
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    ctx.font = '18px Arial, sans-serif';
                    ctx.fillStyle = '#4b5563';
                    ctx.fillText(dateStr, canvas.width/2, canvas.height - 14);
                    
                    ctx.restore();
                } catch(e){ console.warn('Render typed signature (modal) failed', e); }
            }

            loadUploadedSignatureImage(event){
                try{
                    const S = this._sigCreate; if (!S || !S.canvas || !S.ctx) return;
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        this.showNotification && this.showNotification('Please select an image file', 'warning');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            S.ctx.clearRect(0, 0, S.canvas.width, S.canvas.height);
                            
                            // Calculate dimensions to fit image in canvas while maintaining aspect ratio
                            const canvasRatio = S.canvas.width / S.canvas.height;
                            const imageRatio = img.width / img.height;
                            
                            let drawWidth, drawHeight, x, y;
                            
                            if (imageRatio > canvasRatio) {
                                // Image is wider than canvas ratio
                                drawWidth = S.canvas.width;
                                drawHeight = S.canvas.width / imageRatio;
                                x = 0;
                                y = (S.canvas.height - drawHeight) / 2;
                            } else {
                                // Image is taller than canvas ratio
                                drawHeight = S.canvas.height;
                                drawWidth = S.canvas.height * imageRatio;
                                x = (S.canvas.width - drawWidth) / 2;
                                y = 0;
                            }
                            
                            S.ctx.drawImage(img, x, y, drawWidth, drawHeight);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } catch(e){ console.warn('Load uploaded signature image failed', e); }
            }

            async saveSignatureFromModal(){
                try{
                    const S = this._sigCreate; if (!S || !S.canvas) return;
                    const cid = this.currentUser?.companyId; const uid = this.currentUser?.uid;
                    if (!cid || !uid) { this.showNotification && this.showNotification('Not signed in', 'warning'); return; }
                    
                    const dataUrl = S.canvas.toDataURL('image/png');
                    const editMode = this._sigEditMode;
                    
                    // Get signature metadata
                    const typedStyle = document.getElementById('typedSignatureCreateStyle');
                    const typedColor = document.getElementById('typedSignatureCreateColor');
                    const typedFont = document.getElementById('typedSignatureCreateFont');
                    const typedInput = document.getElementById('typedSignatureCreateInput');
                    
                    // If editing, delete old storage file first
                    if (editMode && editMode.id) {
                        try {
                            const oldItem = (await db.ref(`companies/${cid}/users/${uid}/signatures/${editMode.id}`).once('value')).val();
                            if (oldItem?.url) {
                                try { const oldRef = storage.refFromURL(oldItem.url); await oldRef.delete(); } catch {}
                            }
                            await db.ref(`companies/${cid}/users/${uid}/signatures/${editMode.id}`).remove();
                        } catch(e) { console.warn('Failed to clean up old signature', e); }
                    }
                    
                    const id = db.ref().push().key;
                    const path = `companies/${cid}/signatures/${uid}/${id}.png`;
                    const ref = storage.ref(path);
                    await ref.putString(dataUrl, 'data_url');
                    const downloadURL = await ref.getDownloadURL();
                    const userPath = `companies/${cid}/users/${uid}`;
                    const createdAt = Date.now();
                    
                    // Build signature data with unique ID and metadata
                    const signatureData = { 
                        url: downloadURL, 
                        imageData: dataUrl,
                        createdAt,
                        signatureUniqueId: S.signatureUniqueId || null,
                        style: typedStyle?.value || null,
                        color: typedColor?.value || null,
                        font: typedFont?.value || null,
                        typedName: typedInput?.value || null,
                        mode: S.activeTab || 'draw' // draw, type, or upload
                    };
                    
                    await db.ref(`${userPath}/signatures/${id}`).set(signatureData);
                    await db.ref(userPath).update({ signatureUrl: downloadURL, defaultSignatureId: id });
                    
                    // Clear edit mode and unique ID
                    this._sigEditMode = null;
                    if (S) S.signatureUniqueId = null;
                    
                    // Broadcast signature update to other tabs/pages (e.g. travel.html modal)
                    try {
                        localStorage.setItem('signatureUpdated', JSON.stringify({ uid, signatureUrl: downloadURL, timestamp: Date.now() }));
                        localStorage.removeItem('signatureUpdated'); // Trigger storage event in other tabs
                    } catch(e) { /* ignore */ }
                    
                    this.showNotification && this.showNotification(editMode ? 'Signature updated' : 'Signature saved', 'success');
                    this.closeSignatureCreateModal();
                    await this.loadSavedSignaturePreview();

                    // If Sign tab is active, enable click-to-place signature on the PDF
                    try {
                        const signWorkspace = document.getElementById('signWorkspace');
                        const pdfCanvas = document.getElementById('pdfCanvas');
                        if (signWorkspace && pdfCanvas && signWorkspace.style.display !== 'none') {
                            const imgData = signatureData.imageData || downloadURL;
                            if (typeof window.startSignaturePlacement === 'function') {
                                window.startSignaturePlacement(imgData, 200, 80);
                            }
                        }
                    } catch (_) { /* ignore placement errors */ }
                } catch(e){ console.error('Save signature (modal) failed', e); this.showNotification && this.showNotification('Failed to save signature', 'error'); }
            }

            // ---- Profile Settings (adapted) ----
            setupProfileSettingsUI() {
                // Access Control Add button -> open modal
                const acAdd = document.getElementById('profileAccessAddBtn');
                if (acAdd) {
                    // Remove any existing listeners by cloning
                    const newAcAdd = acAdd.cloneNode(true);
                    acAdd.parentNode.replaceChild(newAcAdd, acAdd);
                    newAcAdd.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.openProfileAccessControlModal();
                    });
                }
                // Locations add button
                const addLoc = document.getElementById('profileAddLocationBtn');
                if (addLoc) addLoc.addEventListener('click', () => this.openProfileLocationModal());
                // Refresh button
                const refreshBtn = document.getElementById('profileSettingsRefreshBtn');
                if (refreshBtn) refreshBtn.addEventListener('click', () => { this.loadProfileLocations(); this.loadProfileAccessControl(); });
            }

            // ---- Access Control (profile) ----
            async openProfileAccessControlModal(){
                try {
                    const cid = this.currentUser?.companyId;
                    if(!cid) {
                        console.warn('No companyId found for current user');
                        this.showNotification && this.showNotification('User company not found', 'warning');
                        return;
                    }
                    const [usersSnap, permsSnap] = await Promise.all([
                        db.ref(`companies/${cid}/users`).once('value'),
                        db.ref(`companies/${cid}/profileAccessControl/tabVisibility`).once('value')
                    ]);
                    this._acUsers = usersSnap.val() || {};
                    this._acPerms = permsSnap.val() || {};
                    this.populateProfileAccessControlModalOptions('');
                    
                    // Default only Personal, Security, Activity tabs checked
                    // Other tabs and permissions unchecked by default
                    const defaultChecked = [
                        'profileAcTabPersonal','profileAcTabSecurity','profileAcTabActivity'
                    ];
                    const allCheckboxes = [
                        'profileAcTabPersonal','profileAcTabSecurity','profileAcTabActivity','profileAcTabPreferences','profileAcTabTimesheet','profileAcTabPayslip','profileAcTabLeave','profileAcTabSettings','profileAcTabSign',
                        'profileAcProfileEditBio','profileAcProfileChangePassword','profileAcProfileUploadAvatar',
                        'profileAcTimesheetCreate','profileAcTimesheetSubmit','profileAcTimesheetApprove','profileAcTimesheetDecline',
                        'profileAcLeaveCreate','profileAcLeaveApprove','profileAcLeaveDecline',
                        'profileAcPayslipView','profileAcPayslipExport'
                    ];
                    allCheckboxes.forEach(id => { 
                        const el = document.getElementById(id); 
                        if(el) el.checked = defaultChecked.includes(id); 
                    });
                    
                    const modal = document.getElementById('profileAccessControlModal');
                    if (modal) {
                        modal.style.display = 'flex';
                    } else {
                        console.warn('profileAccessControlModal not found in DOM');
                    }
                    const search = document.getElementById('profileAcUserSearch');
                    if (search) {
                        search.value = '';
                        search.oninput = () => this.populateProfileAccessControlModalOptions(search.value||'');
                    }
                } catch (e){ 
                    console.error('Open profile AC modal failed', e); 
                    this.showNotification && this.showNotification('Failed to open access control modal', 'error');
                }
            }

            closeProfileAccessControlModal(){ const modal=document.getElementById('profileAccessControlModal'); if(modal) modal.style.display='none'; }

            populateProfileAccessControlModalOptions(searchTerm){
                try {
                    const select = document.getElementById('profileAcUserSelect');
                    if(!select) return;
                    const existing = new Set(Object.keys(this._acPerms||{}));
                    select.innerHTML = '<option value="">-- Choose user --</option>';
                    Object.entries(this._acUsers||{}).forEach(([uid, u]) => {
                        if(existing.has(uid)) return;
                        const name = (u.displayName||u.name||`${u.firstName||''} ${u.lastName||''}`.trim()||'(No name)').trim();
                        const jobTitle = (u.jobTitle||u.positionTitle||u.position||u.role||'').trim();
                        const filter = (searchTerm||'').toLowerCase();
                        if(filter){ const hay=(name+' '+jobTitle).toLowerCase(); if(!hay.includes(filter)) return; }
                        const opt = document.createElement('option');
                        opt.value = uid; opt.textContent = jobTitle ? `${name} - ${jobTitle}` : name;
                        select.appendChild(opt);
                    });
                } catch(e){ console.warn('Populate AC options failed', e); }
            }

            async saveProfileAccessControlFromModal(){
                try {
                    const cid = this.currentUser?.companyId; if(!cid) return;
                    const uid = document.getElementById('profileAcUserSelect')?.value || '';
                    if(!uid){ this.showNotification && this.showNotification('Choose a user', 'warning'); return; }
                    const cfg = {
                        // Tab visibility
                        showPersonal: !!document.getElementById('profileAcTabPersonal')?.checked,
                        showSecurity: !!document.getElementById('profileAcTabSecurity')?.checked,
                        showActivity: !!document.getElementById('profileAcTabActivity')?.checked,
                        showPreferences: !!document.getElementById('profileAcTabPreferences')?.checked,
                        showTimesheet: !!document.getElementById('profileAcTabTimesheet')?.checked,
                        showPayslip: !!document.getElementById('profileAcTabPayslip')?.checked,
                        showLeave: !!document.getElementById('profileAcTabLeave')?.checked,
                        showSettings: !!document.getElementById('profileAcTabSettings')?.checked,
                        showSign: !!document.getElementById('profileAcTabSign')?.checked,
                        // Profile actions
                        canEditBio: !!document.getElementById('profileAcProfileEditBio')?.checked,
                        canChangePassword: !!document.getElementById('profileAcProfileChangePassword')?.checked,
                        canUploadAvatar: !!document.getElementById('profileAcProfileUploadAvatar')?.checked,
                        // Timesheet actions
                        canCreateTimesheet: !!document.getElementById('profileAcTimesheetCreate')?.checked,
                        canSubmitTimesheet: !!document.getElementById('profileAcTimesheetSubmit')?.checked,
                        canApproveTimesheet: !!document.getElementById('profileAcTimesheetApprove')?.checked,
                        canDeclineTimesheet: !!document.getElementById('profileAcTimesheetDecline')?.checked,
                        // Leave actions
                        canCreateLeave: !!document.getElementById('profileAcLeaveCreate')?.checked,
                        canApproveLeave: !!document.getElementById('profileAcLeaveApprove')?.checked,
                        canDeclineLeave: !!document.getElementById('profileAcLeaveDecline')?.checked,
                        // Payslip actions
                        canViewPayslip: !!document.getElementById('profileAcPayslipView')?.checked,
                        canExportPayslip: !!document.getElementById('profileAcPayslipExport')?.checked,
                    };
                    await db.ref(`companies/${cid}/profileAccessControl/tabVisibility/${uid}`).set(cfg);
                    // If the saved user is the current user, apply tab visibility immediately
                    const me = (this.currentUser?.uid || this.currentUser?.userId || this.currentUser?.id);
                    if(me && uid === String(me)){
                        this.applyProfileTabVisibility(cfg);
                    }
                    await this.loadProfileAccessControl();
                    this.closeProfileAccessControlModal();
                    this.showNotification && this.showNotification('Access control added', 'success');
                } catch (e){ console.error('Save profile AC failed', e); this.showNotification && this.showNotification('Save failed', 'error'); }
            }

            async loadProfileAccessControl(){
                try{
                    const cid = this.currentUser?.companyId; if(!cid) return;
                    const [usersSnap, acSnap] = await Promise.all([
                        db.ref(`companies/${cid}/users`).once('value'),
                        db.ref(`companies/${cid}/profileAccessControl/tabVisibility`).once('value')
                    ]);
                    const users = usersSnap.val() || {};
                    const acMap = acSnap.val() || {};
                    this.renderProfileAccessControlTable(acMap, users);
                    // If current user has a record, apply it to tabs immediately
                    const me = (this.currentUser?.uid || this.currentUser?.userId || this.currentUser?.id);
                    if(me && acMap && acMap[me]){
                        this.applyProfileTabVisibility(acMap[me]);
                    }
                }catch(e){ console.warn('Load profile access control failed', e); }
            }

            renderProfileAccessControlTable(acMap, users){
                const tbody = document.getElementById('profileAccessControlTableBody');
                const empty = document.getElementById('profileAccessControlEmpty');
                if(!tbody){ return; }
                this._profileAcMap = acMap || {};
                this._profileUsers = users || {};
                const entries = Object.entries(this._profileAcMap);
                if(entries.length === 0){
                    tbody.innerHTML = '';
                    if(empty) empty.style.display = 'block';
                    return;
                }
                if(empty) empty.style.display = 'none';
                const getName = (u) => {
                    if(!u) return '(Unknown)';
                    const name = (u.displayName||u.name||`${u.firstName||''} ${u.lastName||''}`.trim()).trim();
                    return name || '(No name)';
                };
                const getJob = (u) => (u?.jobTitle||u?.positionTitle||u?.position||u?.role||'').trim();
                const getEmail = (u) => (u?.email||u?.workEmail||u?.personalEmail||'').trim();
                const rows = entries.map(([uid, cfg]) => {
                    const u = users[uid] || {};
                    return `
                        <tr class="ac-row" data-uid="${uid}">
                            <td><i class="fas fa-chevron-right ac-caret"></i>${getName(u)}</td>
                            <td>${getEmail(u) || '-'}</td>
                            <td>${getJob(u) || '-'}</td>
                            <td><span style="color:#64748b; font-size:.7rem;">Click row to view/edit</span></td>
                        </tr>
                    `;
                }).join('');
                tbody.innerHTML = rows;

                // Attach click handler for expand/collapse (event delegation)
                if(!this._profileAcDelegated){
                    this._profileAcDelegated = true;
                    tbody.addEventListener('click', (e)=>{
                        const tr = e.target.closest('tr.ac-row');
                        if(!tr) return;
                        const uid = tr.getAttribute('data-uid');
                        this.toggleProfileAcDetails(uid, tr);
                    });
                    tbody.addEventListener('change', async (e)=>{
                        const input = e.target;
                        if(!(input instanceof HTMLInputElement)) return;
                        const key = input.getAttribute('data-key');
                        const uid = input.getAttribute('data-uid');
                        if(!key || !uid) return;
                        try{
                            await this.updateProfileAccessToggle(uid, key, !!input.checked);
                            // Update local map for immediate UI consistency
                            if(!this._profileAcMap[uid]) this._profileAcMap[uid] = {};
                            this._profileAcMap[uid][key] = !!input.checked;
                        }catch(err){
                            console.warn('AC toggle save failed', err);
                            // revert UI state on failure
                            input.checked = !input.checked;
                            this.showNotification && this.showNotification('Failed to save change', 'error');
                        }
                    });
                }
            }

            toggleProfileAcDetails(uid, tr){
                if(!tr) return;
                const tbody = tr.parentElement;
                const isExpanded = tr.classList.contains('expanded');
                // Collapse any existing details for this row
                const next = tr.nextElementSibling;
                if(isExpanded && next && next.classList.contains('ac-details')){
                    next.remove();
                    tr.classList.remove('expanded');
                    return;
                }
                // If there was a different details row directly after, remove it
                if(next && next.classList.contains('ac-details')) next.remove();
                tr.classList.add('expanded');
                const cfg = this._profileAcMap?.[uid] || {};
                const detailsHtml = this.buildProfileAcDetails(uid, cfg);
                const detailsTr = document.createElement('tr');
                detailsTr.className = 'ac-details';
                detailsTr.setAttribute('data-uid', uid);
                const td = document.createElement('td');
                td.colSpan = 4;
                td.innerHTML = detailsHtml;
                detailsTr.appendChild(td);
                tr.insertAdjacentElement('afterend', detailsTr);
            }

            buildProfileAcDetails(uid, cfg){
                const mk = (key, label) => `
                    <label><input type="checkbox" data-uid="${uid}" data-key="${key}" ${cfg[key] ? 'checked' : ''}/> ${label}</label>
                `;
                return `
                    <div>
                        <div class="ac-group">
                            <div class="ac-group-title">Tab Visibility</div>
                            <div class="ac-grid">
                                ${mk('showPersonal','Personal Info')}
                                ${mk('showSecurity','Security')}
                                ${mk('showActivity','Activity')}
                                ${mk('showPreferences','Preferences')}
                                ${mk('showTimesheet','Timesheets')}
                                ${mk('showPayslip','Payslips')}
                                ${mk('showLeave','Leave')}
                                ${mk('showSettings','Settings')}
                                ${mk('showSign','Sign Documents')}
                            </div>
                        </div>
                        <div class="ac-group" style="margin-top:.6rem;">
                            <div class="ac-group-title">Profile Actions</div>
                            <div class="ac-grid">
                                ${mk('canEditBio','Edit Bio')}
                                ${mk('canChangePassword','Change Password')}
                                ${mk('canUploadAvatar','Upload Avatar')}
                            </div>
                        </div>
                        <div class="ac-group" style="margin-top:.6rem;">
                            <div class="ac-group-title">Timesheet Actions</div>
                            <div class="ac-grid">
                                ${mk('canCreateTimesheet','Create/Edit')}
                                ${mk('canSubmitTimesheet','Submit')}
                                ${mk('canApproveTimesheet','Approve')}
                                ${mk('canDeclineTimesheet','Decline')}
                            </div>
                        </div>
                        <div class="ac-group" style="margin-top:.6rem;">
                            <div class="ac-group-title">Leave Actions</div>
                            <div class="ac-grid">
                                ${mk('canCreateLeave','Create')}
                                ${mk('canApproveLeave','Approve')}
                                ${mk('canDeclineLeave','Decline')}
                            </div>
                        </div>
                        <div class="ac-group" style="margin-top:.6rem;">
                            <div class="ac-group-title">Payslip Actions</div>
                            <div class="ac-grid">
                                ${mk('canViewPayslip','View')}
                                ${mk('canExportPayslip','Export')}
                            </div>
                        </div>
                    </div>
                `;
            }

            async updateProfileAccessToggle(uid, key, value){
                const cid = this.currentUser?.companyId; if(!cid) throw new Error('No company');
                await db.ref(`companies/${cid}/profileAccessControl/tabVisibility/${uid}/${key}`).set(!!value);
                // If the toggled row is for the current user, re-apply tab visibility immediately
                const me = (this.currentUser?.uid || this.currentUser?.userId || this.currentUser?.id);
                if(me && uid === String(me)){
                    const cfg = Object.assign({}, this._profileAcMap?.[uid]||{});
                    cfg[key] = !!value;
                    this.applyProfileTabVisibility(cfg);
                }
            }

            async applyProfileTabVisibilityFromDb(){
                const cid = this.currentUser?.companyId; if(!cid) return;
                const me = (this.currentUser?.uid || this.currentUser?.userId || this.currentUser?.id);
                if(!me) return;
                const snap = await db.ref(`companies/${cid}/profileAccessControl/tabVisibility/${me}`).once('value');
                const cfg = snap.val();
                this.applyProfileTabVisibility(cfg || null);
            }

            applyProfileTabVisibility(cfg){
                // Map of tab keys to DOM identifiers
                const map = [
                    { key: 'showPersonal', tab: 'personal' },
                    { key: 'showSecurity', tab: 'security' },
                    { key: 'showActivity', tab: 'activity' },
                    { key: 'showPreferences', tab: 'preferences' },
                    { key: 'showTimesheet', tab: 'timesheet' },
                    { key: 'showPayslip', tab: 'payslip' },
                    { key: 'showLeave', tab: 'leave' },
                    { key: 'showSettings', tab: 'settings' },
                    { key: 'showSign', tab: 'sign' },
                ];
                
                // Default tabs visible without explicit permission: personal, security, activity, sign
                const defaultVisibleTabs = ['showPersonal', 'showSecurity', 'showActivity', 'showSign'];
                const noConfig = !cfg || Object.keys(cfg).length === 0;
                
                // Apply visibility to buttons and panes without disturbing current active if still visible
                map.forEach(({key, tab}) => {
                    const btn = document.querySelector(`.tab-nav-btn[data-tab="${tab}"]`);
                    const pane = document.getElementById(tab);
                    
                    // If no config exists, only show default tabs (personal, security, activity)
                    // If config exists, show tab only if explicitly set to true
                    let visible;
                    if (noConfig) {
                        visible = defaultVisibleTabs.includes(key);
                    } else {
                        // If config exists, check if explicitly set to true
                        visible = cfg[key] === true;
                    }
                    
                    if(btn){ 
                        if (visible) {
                            btn.classList.add('tab-authorized');
                        } else {
                            btn.classList.remove('tab-authorized');
                        }
                    }
                    if(pane){
                        if (visible) {
                            pane.classList.add('pane-authorized');
                        } else {
                            pane.classList.remove('pane-authorized');
                            pane.classList.remove('active');
                        }
                    }
                });
                // Ensure there is an active visible tab; keep current active if still visible
                const activeBtn = document.querySelector('.tab-nav-btn.active');
                const activeTab = activeBtn ? activeBtn.getAttribute('data-tab') : null;
                const activeVisible = activeBtn && activeBtn.classList.contains('tab-authorized');
                if(!activeVisible){
                    const firstVisibleBtn = Array.from(document.querySelectorAll('.tab-nav-btn')).find(b => b.classList.contains('tab-authorized'));
                    if(firstVisibleBtn){
                        const tabName = firstVisibleBtn.getAttribute('data-tab');
                        this.switchTab(tabName);
                    }
                } else if (activeTab) {
                    // Ensure the active pane is properly shown
                    const pane = document.getElementById(activeTab);
                    if(pane){ 
                        pane.classList.add('active', 'pane-authorized');
                    }
                }
            }

            openProfileLocationModal() {
                const modal = document.getElementById('profileLocationModal');
                if (!modal) return;
                // reset form
                const f = document.getElementById('profileLocationForm');
                if (f) f.reset();
                const status = document.getElementById('profileLocationStatus');
                if (status) { status.style.display = 'none'; status.textContent = ''; }
                modal.style.display = 'flex';
            }

            closeProfileLocationModal() {
                const modal = document.getElementById('profileLocationModal');
                if (modal) modal.style.display = 'none';
            }

            async loadProfileLocations() {
                try {
                    const cid = this.currentUser?.companyId;
                    if (!cid) return this.renderProfileLocationsTable([]);
                    const snap = await db.ref(`companies/${cid}/workAreaLocations`).once('value');
                    const items = [];
                    if (snap.exists()) {
                        const val = snap.val() || {};
                        for (const [id, obj] of Object.entries(val)) {
                            items.push({ id, ...(obj||{}) });
                        }
                    }
                    items.sort((a,b) => (a.area||'').localeCompare(b.area||''));
                    this.renderProfileLocationsTable(items);
                } catch (e) {
                    console.warn('Load locations failed', e);
                    this.renderProfileLocationsTable([]);
                }
            }

            renderProfileLocationsTable(items) {
                const tbody = document.getElementById('profileLocationsTableBody');
                const empty = document.getElementById('profileLocationsEmpty');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!Array.isArray(items) || items.length === 0) {
                    if (empty) empty.style.display = 'block';
                    return;
                }
                if (empty) empty.style.display = 'none';
                let i=0;
                items.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${++i}</td>
                        <td>${row.area || '-'}</td>
                        <td>${row.name || '-'}</td>
                        <td>
                            <button type="button" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:.7rem;cursor:pointer;" data-id="${row.id}" class="profile-del-loc">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                tbody.querySelectorAll('.profile-del-loc').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        await this.deleteProfileLocation(id);
                        await this.loadProfileLocations();
                    });
                });
            }

            async submitProfileLocation() {
                try {
                    const cid = this.currentUser?.companyId; if (!cid) return;
                    const area = (document.getElementById('profileLocationArea')?.value || '').trim();
                    const name = (document.getElementById('profileLocationName')?.value || '').trim();
                    const status = document.getElementById('profileLocationStatus');
                    if (!area || !name) {
                        if (status) { status.style.display='block'; status.style.color='#dc2626'; status.textContent='Please provide both Work Area and Location Name.'; }
                        return;
                    }
                    const ref = db.ref(`companies/${cid}/workAreaLocations`).push();
                    await ref.set({ area, name, createdAt: Date.now() });
                    if (status) { status.style.display='block'; status.style.color='#065f46'; status.textContent='Location saved.'; }
                    setTimeout(() => this.closeProfileLocationModal(), 300);
                    await this.loadProfileLocations();
                } catch (e) {
                    console.error('Save location failed', e);
                    const status = document.getElementById('profileLocationStatus');
                    if (status) { status.style.display='block'; status.style.color='#dc2626'; status.textContent='Failed to save location.'; }
                }
            }

            async deleteProfileLocation(id) {
                try {
                    const cid = this.currentUser?.companyId; if (!cid || !id) return;
                    await db.ref(`companies/${cid}/workAreaLocations/${id}`).remove();
                    this.showNotification && this.showNotification('Location deleted', 'success');
                } catch (e) {
                    console.warn('Delete location failed', e);
                }
            }
            // ---- End Profile Settings ----

            // ---- View Leave Details Modal ----
            async openLeaveDetailsModal(leaveId) {
                if (!this.currentUser || !this.currentUser.companyId) return;
                try {
                    const snap = await db.ref(`companies/${this.currentUser.companyId}/leaveRequests/${leaveId}`).once('value');
                    if (!snap.exists()) {
                        this.showNotification && this.showNotification('Leave request not found', 'warning');
                        return;
                    }
                    const data = snap.val();
                    // Enforce visibility: only submitter, assigned approver, or approver from configured flow can view
                    if (!(await this.canUserViewLeave(data))) {
                        this.showNotification && this.showNotification('You are not authorized to view this leave request', 'warning');
                        return;
                    }
                    const modal = document.getElementById('viewLeaveModal');
                    if (!modal) return;
                    const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
                    const capFirst = (s)=> (s && typeof s === 'string') ? (s.charAt(0).toUpperCase() + s.slice(1)) : s;
                    setText('viewLeaveType', capFirst(data.type || '-'));
                    setText('viewLeaveDates', capFirst(`from ${data.startDate || '?'} to ${data.endDate || '?'}`));
                    setText('viewLeaveDays', `${data.totalDays || '0'} day(s)`);
                    setText('viewLeaveStatus', data.status || 'pending');
                    setText('viewLeaveReason', data.reason || '(none)');
                    // Resolve and display submitter information
                    try {
                        const companyId = this.currentUser.companyId;
                        const submitterId = data.employeeId || data.createdBy || '';
                        let name='-', job='-', dept='-';
                        let lmDisplay='-';
                        if (companyId && submitterId) {
                            const userPath = `companies/${companyId}/users/${submitterId}`;
                            let userSnap = await db.ref(userPath).once('value');
                            let user = userSnap.exists() ? (userSnap.val() || {}) : null;
                            if (!user) {
                                // Fallback: scan users to match on nested id properties when keying differs
                                const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                if (allSnap.exists()) {
                                    const all = allSnap.val() || {};
                                    for (const [k, u] of Object.entries(all)) {
                                        if (!u) continue;
                                        const ids = new Set([u.uid, u.userId, u.id, u.employeeId].filter(Boolean).map(String));
                                        if (ids.has(String(submitterId))) { user = u; break; }
                                    }
                                }
                            }
                            if (user) {
                                name = user.displayName || user.name || user.email || String(submitterId);
                                job  = user.jobTitle || user.title || user.designation || user.role || '-';
                                // common department fields
                                dept = user.department || user.dept || (user.workInfo && (user.workInfo.department || user.workInfo.dept)) || '-';

                                // Resolve submitter's line manager name + job title
                                try {
                                    const lmId = user.lineManagerId || user.lineManagerUID || user.managerId || user.managerUID || user.supervisorId || user.supervisorUID || null;
                                    let lmName = user.lineManager || user.lineManagerName || user.managerName || user.supervisorName || null;
                                    let lmJob = null;
                                    if (lmId) {
                                        let lmSnap = await db.ref(`companies/${companyId}/users/${lmId}`).once('value');
                                        let lm = lmSnap.exists() ? (lmSnap.val()||{}) : null;
                                        if (!lm) {
                                            const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                            if (allSnap.exists()) {
                                                const all = allSnap.val()||{};
                                                for (const [k,v] of Object.entries(all)) {
                                                    if (!v) continue;
                                                    const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                                    if (ids.has(String(lmId))) { lm = v; break; }
                                                }
                                            }
                                        }
                                        if (lm) {
                                            lmName = lm.displayName || lm.name || lm.email || lmName || String(lmId);
                                            lmJob  = lm.jobTitle || lm.title || lm.designation || lm.role || null;
                                        }
                                    }
                                    if (lmName && lmJob) {
                                        lmDisplay = `${lmName}  ${this.prettifyTitle(lmJob)}`;
                                    }
                                    else if (lmName) lmDisplay = lmName;
                                    else if (lmJob) lmDisplay = this.prettifyTitle(lmJob);
                                } catch {}
                            }
                        }
                        setText('viewLeaveSubmitterName', name);
                        // Display submitter job title using Settings label (no hyphens),
                        // matching how Department is shown via company field options
                        try {
                            const jobOptions = await this.loadCompanyFieldOptions('job-title');
                            const jobLabel = this.resolveOptionLabel(jobOptions, job);
                            setText('viewLeaveSubmitterJob', jobLabel || this.prettifyTitle(job) || '-');
                        } catch {
                            setText('viewLeaveSubmitterJob', this.prettifyTitle(job) || '-');
                        }
                        // Resolve department to company-configured label for consistency with settings
                        try {
                            const deptOptions = await this.loadCompanyFieldOptions('department');
                            const deptLabel = this.resolveOptionLabel(deptOptions, dept);
                            setText('viewLeaveSubmitterDept', deptLabel || dept || '-');
                        } catch {
                            setText('viewLeaveSubmitterDept', dept || '-');
                        }
                        setText('viewLeaveLineManager', lmDisplay);
                    } catch(e) { /* ignore submitter info failure */ }
                    // Cache current leave data for potential refresh
                    window._currentLeaveData = { ...data };
                    // Update action buttons immediately, then render flow (which will update again)
                    try { await this.updateLeaveActionButtonsVisibility(window._currentLeaveData); } catch(e) { /* no-op */ }
                    await this.renderLeaveApprovalFlowForModal();
                    // Inline history is rendered inside the flow; hide separate history section
                    try {
                        const histList = document.getElementById('viewLeaveHistoryList');
                        if (histList && histList.parentElement) {
                            histList.parentElement.style.display = 'none';
                        }
                    } catch {}
                    modal.style.display = 'flex';
                } catch (e) {
                    console.error('Failed to open leave details modal', e);
                }
            }

            closeLeaveDetailsModal() {
                const modal = document.getElementById('viewLeaveModal');
                if (modal) modal.style.display = 'none';
            }

            async renderLeaveApprovalFlowForModal() {
                const list = document.getElementById('viewLeaveApproversList');
                if (!list) return;
                list.innerHTML = '';
                // Reset the current approver name set for this leave view
                this._currentLeaveApproverNameSet = new Set();
                try {
                    const companyId = this.currentUser?.companyId;
                    if (!companyId) {
                        list.innerHTML = '<div style="color:#6c757d; font-size:0.75rem;">No company context.</div>';
                        return;
                    }
                    const flowSnap = await db.ref(`companies/${companyId}/approvalFlows/leave_request`).once('value');
                    if (!flowSnap.exists()) {
                        list.innerHTML = '<div style="color:#6c757d; font-size:0.75rem;">No approval flow configured.</div>';
                        return;
                    }
                    const flow = flowSnap.val() || {};
                    const levels = Array.isArray(flow.levels) ? flow.levels.slice() : [];
                    const availableRoles = Array.isArray(flow.availableRoles) ? flow.availableRoles : [];
                    const selectedRoles = flow.selectedRoles || {};

                    // Prepare inline history mapping
                    const data = window._currentLeaveData || {};
                    const hist = Array.isArray(data.approvalHistory) ? data.approvalHistory.slice() : [];
                    hist.sort((a,b)=> (a.submittedAt||0) - (b.submittedAt||0));
                    const levelAssignments = new Map(); // levelNum -> array of history entries
                    const takeNextHist = () => hist.length ? hist.shift() : null;
                    const pushForLevel = (lvl, entry) => {
                        if (!entry) return;
                        if (!levelAssignments.has(lvl)) levelAssignments.set(lvl, []);
                        levelAssignments.get(lvl).push(entry);
                    };

                    if ((!levels || levels.length === 0) && Object.keys(selectedRoles).length === 0) {
                        list.innerHTML = '<div style="color:#6c757d; font-size:0.75rem;">No approval levels configured.</div>';
                        return;
                    }

                    const getRoleText = (funcVal) => {
                        const match = availableRoles.find(r => r.function === funcVal);
                        const t = match?.text || funcVal || '';
                        return this.prettifyTitle(t);
                    };

                    if (selectedRoles && Object.keys(selectedRoles).length > 0) {
                        const levelKeys = Object.keys(selectedRoles).sort((a,b) => {
                            const na = parseInt(a.replace(/[^0-9]/g, '')) || 0;
                            const nb = parseInt(b.replace(/[^0-9]/g, '')) || 0;
                            return na - nb;
                        });
                        levelKeys.forEach(key => {
                            const levelNum = parseInt(key.replace(/[^0-9]/g, '')) || 0;
                            const approvers = selectedRoles[key] || [];
                            const names = approvers.map(ap => this.prettifyTitle(ap.text || getRoleText(ap.value)));
                            // Collect names into the approver set for button visibility logic
                            names.forEach(n => { if(n) this._currentLeaveApproverNameSet.add(String(n).trim().toLowerCase()); });

                            // Assign history entries to this level sequentially (one per approver slot)
                            approvers.forEach(() => { const h = takeNextHist(); if (h) pushForLevel(levelNum, h); });

                            const card = document.createElement('div');
                            card.classList.add('leave-approval-flow-level');
                            card.style.border = '1px solid #e2e8f0';
                            card.style.borderRadius = '6px';
                            card.style.padding = '10px';
                            card.style.background = '#f9fafb';
                            const headerHtml = `<div style=\"display:flex; justify-content:space-between; align-items:center;\">
                                <div style="font-size:0.7rem; font-weight:600;">Level ${levelNum}</div>
                                <div style="display:flex; flex-wrap:wrap; gap:6px;">${names.map(n => `<span class=\"approver-name\" style=\"font-size:0.65rem; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3;\">${n}</span>`).join('')}</div>
                            </div>`;

                            const actions = levelAssignments.get(levelNum) || [];
                            let actionsHtml = '';
                            if (actions.length) {
                                actionsHtml = `<div style=\"margin-top:8px; display:flex; flex-direction:column; gap:6px;\">` + actions.map(h => {
                                    const status = String(h.status||'').toLowerCase();
                                    const when = h.submittedAt ? new Date(h.submittedAt).toLocaleString() : '';
                                    const bg = status==='approved' ? '#d1fae5' : status==='rejected' ? '#fee2e2' : '#e5e7eb';
                                    const fg = status==='approved' ? '#065f46' : status==='rejected' ? '#991b1b' : '#374151';
                                    const name = h.userName || h.userId || 'User';
                                    const comment = h.comment ? `<div style=\"margin-top:4px; font-size:0.68rem; color:#374151; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:6px;\">${h.comment}</div>` : '';
                                    return `<div class=\"inline-history-entry\" data-user-id=\"${h.userId||''}\" style=\"padding:8px; background:#fff; border:1px solid #e5e7eb; border-radius:6px;\">
                                                <div style=\"display:flex; justify-content:space-between; align-items:center; gap:8px;\">
                                                    <div class=\"history-approver-name\" style=\"font-weight:600; font-size:0.72rem;\">${name}</div>
                                                    <div style=\"display:flex; align-items:center; gap:8px;\">
                                                        <span class=\"history-timestamp\" style=\"font-size:0.65rem; color:#6b7280;\">${when}</span>
                                                        <span class=\"history-status\" style=\"font-size:0.65rem; padding:2px 8px; border-radius:12px; background:${bg}; color:${fg}; text-transform:capitalize;\">${status||'-'}</span>
                                                    </div>
                                                </div>
                                                ${comment}
                                            </div>`;
                                }).join('') + `</div>`;
                            } else {
                                actionsHtml = `<div style=\"margin-top:8px; font-size:0.68rem; color:#6b7280;\">No action yet</div>`;
                            }

                            card.innerHTML = headerHtml + actionsHtml;
                            list.appendChild(card);
                        });
                    } else {
                        levels.sort((a,b) => (a.level||0) - (b.level||0)).forEach(lvl => {
                            const roleText = getRoleText(lvl.value);
                            if (roleText) this._currentLeaveApproverNameSet.add(String(roleText).trim().toLowerCase());
                            const card = document.createElement('div');
                            card.classList.add('leave-approval-flow-level');
                            card.style.border = '1px solid #e2e8f0';
                            card.style.borderRadius = '6px';
                            card.style.padding = '10px';
                            card.style.background = '#f9fafb';
                            const headerHtml = `<div style=\"display:flex; justify-content:space-between; align-items:center;\">
                                <div style="font-size:0.7rem; font-weight:600;">Level ${lvl.level}</div>
                                <span class="approver-name" style="font-size:0.65rem; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3;">${roleText}</span>
                            </div>`;

                            // Assign one history entry per legacy level
                            const h = takeNextHist();
                            let actionsHtml = '';
                            if (h) {
                                const status = String(h.status||'').toLowerCase();
                                const when = h.submittedAt ? new Date(h.submittedAt).toLocaleString() : '';
                                const bg = status==='approved' ? '#d1fae5' : status==='rejected' ? '#fee2e2' : '#e5e7eb';
                                const fg = status==='approved' ? '#065f46' : status==='rejected' ? '#991b1b' : '#374151';
                                const name = h.userName || h.userId || 'User';
                                const comment = h.comment ? `<div style=\"margin-top:4px; font-size:0.68rem; color:#374151; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:6px;\">${h.comment}</div>` : '';
                                actionsHtml = `<div style=\"margin-top:8px;\"><div class=\"inline-history-entry\" data-user-id=\"${h.userId||''}\" style=\"padding:8px; background:#fff; border:1px solid #e5e7eb; border-radius:6px;\">
                                                <div style=\"display:flex; justify-content:space-between; align-items:center; gap:8px;\">
                                                    <div class=\"history-approver-name\" style=\"font-weight:600; font-size:0.72rem;\">${name}</div>
                                                    <div style=\"display:flex; align-items:center; gap:8px;\">
                                                        <span class=\"history-timestamp\" style=\"font-size:0.65rem; color:#6b7280;\">${when}</span>
                                                        <span class=\"history-status\" style=\"font-size:0.65rem; padding:2px 8px; border-radius:12px; background:${bg}; color:${fg}; text-transform:capitalize;\">${status||'-'}</span>
                                                    </div>
                                                </div>
                                                ${comment}
                                            </div></div>`;
                            } else {
                                actionsHtml = `<div style=\"margin-top:8px; font-size:0.68rem; color:#6b7280;\">No action yet</div>`;
                            }

                            card.innerHTML = headerHtml + actionsHtml;
                            list.appendChild(card);
                        });
                    }

                    // After rendering the flow, update action button visibility
                    try { await this.updateLeaveActionButtonsVisibility(window._currentLeaveData || {}); } catch(e) { /* no-op */ }
                } catch (err) {
                    console.error('Failed to render approval flow in modal', err);
                    list.innerHTML = '<div style="color:#dc3545; font-size:0.75rem;">Failed to load approval flow.</div>';
                }
            }
            
            async renderLeaveApprovalHistoryForModal() {
                const list = document.getElementById('viewLeaveHistoryList');
                if (!list) return;
                list.innerHTML = '';
                try {
                    const data = window._currentLeaveData || {};
                    const history = Array.isArray(data.approvalHistory) ? data.approvalHistory.slice() : [];
                    if (!history.length) {
                        list.innerHTML = '<div style="color:#6c757d; font-size:0.75rem;">No approval actions yet.</div>';
                        return;
                    }
                    // Sort ascending by submittedAt
                    history.sort((a,b)=> (a.submittedAt||0) - (b.submittedAt||0));
                    for (const h of history) {
                        const name = (h.userName || h.userId || 'User');
                        const status = String(h.status||'').toLowerCase();
                        const when = h.submittedAt ? new Date(h.submittedAt).toLocaleString() : '';
                        const comment = h.comment || '';
                        const bg = status==='approved' ? '#d1fae5' : status==='rejected' ? '#fee2e2' : '#f3f4f6';
                        const fg = status==='approved' ? '#065f46' : status==='rejected' ? '#991b1b' : '#374151';
                        const card = document.createElement('div');
                        card.style.border = '1px solid #e2e8f0';
                        card.style.borderRadius = '6px';
                        card.style.padding = '10px';
                        card.style.background = '#ffffff';
                        card.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                                <div style="display:flex; flex-direction:column;">
                                    <div style="font-weight:600; font-size:0.75rem;">${name}</div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span style="font-size:0.65rem; color:#6b7280;">${when}</span>
                                    <span style="font-size:0.65rem; padding:2px 8px; border-radius:12px; background:${bg}; color:${fg}; text-transform:capitalize;">${status || '-'}</span>
                                </div>
                            </div>
                            ${comment ? `<div style="margin-top:6px; font-size:0.7rem; color:#374151; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:8px;">${comment}</div>` : ''}
                        `;
                        list.appendChild(card);
                    }
                } catch (e) {
                    console.error('Failed to render approval history', e);
                    list.innerHTML = '<div style="color:#dc3545; font-size:0.75rem;">Failed to load approval history.</div>';
                }
            }
            // ---- End View Leave Details Modal ----

            // ---- Leave Approval Actions ----
            async updateLeaveActionButtonsVisibility(data) {
                const approveBtn = document.getElementById('leaveApproveBtn');
                const declineBtn = document.getElementById('leaveDeclineBtn');
                const deleteBtn = document.getElementById('leaveDeleteBtn');
                if (!approveBtn || !declineBtn) return;

                const status = String(data?.status || 'pending').toLowerCase();
                const role = String(this.currentUser?.role || '').toLowerCase();
                const isManagerial = role.includes('manager') || role.includes('supervisor') || role.includes('admin');
                const statusAllows = (status === 'pending' || status === 'submitted');

                // Sequential flow gating: only allow next level approvers to act
                let canActByLevel = false;
                let hasSequential = false;
                // New: if assigned by function anywhere in the flow, allow action visibility
                let assignedByFunctionAnywhere = false;
                try {
                    const companyId = this.currentUser?.companyId;
                    if (companyId && statusAllows) {
                        const flowSnap = await db.ref(`companies/${companyId}/approvalFlows/leave_request`).once('value');
                        const flow = flowSnap.exists() ? (flowSnap.val() || {}) : {};
                        const selectedRoles = flow.selectedRoles || {};
                        const levelKeys = Object.keys(selectedRoles).sort((a,b) => {
                            const na = parseInt(a.replace(/[^0-9]/g, '')) || 0;
                            const nb = parseInt(b.replace(/[^0-9]/g, '')) || 0;
                            return na - nb;
                        });
                        const approvals = Array.isArray(data?.approvalHistory) ? data.approvalHistory.filter(h => String(h.status||'').toLowerCase()==='approved') : [];
                        const approvedCount = approvals.length;
                        const uid = this.currentUser?.uid || this.currentUser?.userId || this.currentUser?.id || '';
                        const myName = (this.currentUser?.displayName || this.currentUser?.name || this.currentUser?.email || '').trim().toLowerCase();
                        let jobTitle = (this.currentUser?.jobTitle || this.currentUser?.title || this.currentUser?.designation || this.currentUser?.positionTitle || this.currentUser?.position || this.currentUser?.role || '').trim();
                        const slug = (s)=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
                        // Fallback to DB if job title not set locally
                        if (!jobTitle && companyId && uid) {
                            try {
                                let uSnap = await db.ref(`companies/${companyId}/users/${uid}`).once('value');
                                let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                if (!u) {
                                    const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                    if (allSnap.exists()) {
                                        const all = allSnap.val()||{};
                                        for (const [k,v] of Object.entries(all)) {
                                            if (!v) continue;
                                            const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                            if (ids.has(String(uid))) { u = v; break; }
                                        }
                                    }
                                }
                                if (u) jobTitle = (u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '').trim();
                            } catch {}
                        }
                        const jobTitleSlug = jobTitle ? slug(jobTitle) : '';
                        const myTokens = new Set([
                            uid ? `user_${uid}` : '',
                            jobTitle ? `function_${jobTitleSlug}` : '',
                            jobTitle ? `function-${jobTitleSlug}` : '',
                            jobTitleSlug,
                        ].filter(Boolean));

                        if (levelKeys.length > 0) {
                            hasSequential = true;
                            const totalLevels = levelKeys.length;
                            if (approvedCount < totalLevels) {
                                const nextLevelKey = levelKeys[approvedCount]; // strictly next level
                                const nextLevelApprovers = (selectedRoles[nextLevelKey] || []);
                                // Also allow by display name presence in ONLY this level
                                const levelNameSet = new Set(nextLevelApprovers.map(ap => String(ap.text||'').trim().toLowerCase()).filter(Boolean));
                                const matchesToken = (raw) => {
                                    const val = String(raw||'').trim().toLowerCase();
                                    if (!val) return false;
                                    if (val.startsWith('user_')) {
                                        return myTokens.has(val);
                                    }
                                    if (val.startsWith('function_') || val.startsWith('function-')) {
                                        const base = val.replace(/^function[-_]/, '');
                                        const baseSlug = slug(base);
                                        return !!(jobTitleSlug && baseSlug && baseSlug === jobTitleSlug);
                                    }
                                    // bare role slug/text - check both original text and slugified version
                                    const valSlug = slug(val);
                                    return !!(jobTitleSlug && (valSlug === jobTitleSlug || val === jobTitle));
                                };
                                canActByLevel = nextLevelApprovers.some(ap => matchesToken(ap.value) || matchesToken(ap.text)) || (myName && levelNameSet.has(myName));

                                // L+1 / Line Manager special-case for selectedRoles
                                if (!canActByLevel) {
                                    const isL1Token = (s)=>{
                                        const v = String(s||'').trim().toLowerCase();
                                        if (!v) return false;
                                        return (/^l\+?1$/.test(v) || /^level\+?1$/.test(v) || /^level\s*1$/.test(v) || v === 'line manager' || v === 'linemanager');
                                    };
                                    const requiresL1 = nextLevelApprovers.some(ap => isL1Token(ap.value) || isL1Token(ap.text));
                                    if (requiresL1) {
                                        try {
                                            const submitterId = data?.employeeId || data?.createdBy || '';
                                            if (companyId && submitterId) {
                                                let uSnap = await db.ref(`companies/${companyId}/users/${submitterId}`).once('value');
                                                let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                                if (!u) {
                                                    const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                                    if (allSnap.exists()) {
                                                        const all = allSnap.val()||{};
                                                        for (const [k,v] of Object.entries(all)) {
                                                            if (!v) continue;
                                                            const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                                            if (ids.has(String(submitterId))) { u = v; break; }
                                                        }
                                                    }
                                                }
                                                if (u) {
                                                    const lmId = u.lineManagerId || u.lineManagerUID || u.managerId || u.managerUID || u.supervisorId || u.supervisorUID || null;
                                                    const lmName = (u.lineManager || u.lineManagerName || u.managerName || u.supervisorName || '').trim().toLowerCase();
                                                    if ((lmId && String(lmId) === String(uid)) || (lmName && lmName === myName)) {
                                                        canActByLevel = true;
                                                    }
                                                }
                                            }
                                        } catch {}
                                    }
                                }
                                // Also, if any level (not just next) contains a function_* equal to my job, allow action visibility
                                try {
                                    const slug = (s)=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
                                    const jobTitle = (this.currentUser?.jobTitle || this.currentUser?.title || this.currentUser?.designation || this.currentUser?.positionTitle || this.currentUser?.position || this.currentUser?.role || '').trim();
                                    let jobTitleSlug = jobTitle ? slug(jobTitle) : '';
                                    if (!jobTitleSlug && companyId && uid) {
                                        try {
                                            let uSnap = await db.ref(`companies/${companyId}/users/${uid}`).once('value');
                                            let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                            if (!u) {
                                                const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                                if (allSnap.exists()) {
                                                    const all = allSnap.val()||{};
                                                    for (const [k,v] of Object.entries(all)) {
                                                        if (!v) continue;
                                                        const ids = new Set([v.uid, v.userId, v.id, v.employeeId].filter(Boolean).map(String));
                                                        if (ids.has(String(uid))) { u = v; break; }
                                                    }
                                                }
                                            }
                                            if (u) jobTitleSlug = slug(u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '');
                                        } catch {}
                                    }
                                    if (jobTitleSlug) {
                                        // check all selectedRoles for any matching function
                                        for (const k of levelKeys) {
                                            const arr = selectedRoles[k] || [];
                                            for (const ap of arr) {
                                                const rawV = String(ap.value||ap.text||'').trim().toLowerCase();
                                                if (!rawV) continue;
                                                if (rawV.startsWith('function_') || rawV.startsWith('function-')) {
                                                    const base = rawV.replace(/^function[-_]/, '');
                                                    const baseSlug = slug(base);
                                                    if (baseSlug === jobTitleSlug) { assignedByFunctionAnywhere = true; break; }
                                                } else {
                                                    const vSlug = slug(rawV);
                                                    if (vSlug === jobTitleSlug) { assignedByFunctionAnywhere = true; break; }
                                                }
                                            }
                                            if (assignedByFunctionAnywhere) break;
                                        }
                                    }
                                } catch {}
                            } else {
                                canActByLevel = false; // all required levels approved
                            }
                        } else {
                            // Legacy levels array with role values per level
                            const availableLevels = Array.isArray(flow.levels) ? flow.levels.slice() : [];
                            if (availableLevels.length > 0) {
                                hasSequential = true;
                                const sorted = availableLevels.sort((a,b)=> (a.level||0) - (b.level||0));
                                const totalLevels = sorted.length;
                                if (approvedCount < totalLevels) {
                                    const nextLevel = sorted[approvedCount];
                                    const v = String(nextLevel?.value || '').trim();
                                    if (v) {
                                        if (v.startsWith('function_') || v.startsWith('function-')) {
                                            const bare = v.replace(/^function[-_]/, '');
                                            const bareSlug = slug(bare);
                                            canActByLevel = !!(jobTitleSlug && bareSlug && bareSlug === jobTitleSlug);
                                        } else {
                                            const vv = v.toLowerCase();
                                            if (/^l\+?1$/.test(vv) || /^level\+?1$/.test(vv) || /^level\s*1$/.test(vv) || vv === 'line manager' || vv === 'linemanager') {
                                                try {
                                                    const submitterId = data?.employeeId || data?.createdBy || '';
                                                    if (companyId && submitterId) {
                                                        let uSnap = await db.ref(`companies/${companyId}/users/${submitterId}`).once('value');
                                                        let u = uSnap.exists() ? (uSnap.val()||{}) : null;
                                                        if (!u) {
                                                            const allSnap = await db.ref(`companies/${companyId}/users`).once('value');
                                                            if (allSnap.exists()) {
                                                                const all = allSnap.val()||{};
                                                                for (const [k,vx] of Object.entries(all)) {
                                                                    if (!vx) continue;
                                                                    const ids = new Set([vx.uid, vx.userId, vx.id, vx.employeeId].filter(Boolean).map(String));
                                                                    if (ids.has(String(submitterId))) { u = vx; break; }
                                                                }
                                                            }
                                                        }
                                                        if (u) {
                                                            const lmId = u.lineManagerId || u.lineManagerUID || u.managerId || u.managerUID || u.supervisorId || u.supervisorUID || null;
                                                            const lmName = (u.lineManager || u.lineManagerName || u.managerName || u.supervisorName || '').trim().toLowerCase();
                                                            canActByLevel = !!((lmId && String(lmId) === String(uid)) || (lmName && lmName === myName));
                                                        }
                                                    }
                                                } catch {}
                                            } else {
                                                const vSlug = slug(v);
                                                canActByLevel = !!(jobTitleSlug && (vSlug === jobTitleSlug || v.toLowerCase() === jobTitle.toLowerCase()));
                                            }
                                        }
                                    }
                                    // Legacy override: any level with function/job match allows action visibility
                                    try {
                                        if (jobTitleSlug) {
                                            for (const lvl of sorted) {
                                                const raw = String(lvl?.value||'').trim().toLowerCase();
                                                if (!raw) continue;
                                                if (raw.startsWith('function_') || raw.startsWith('function-')) {
                                                    const base = raw.replace(/^function[-_]/, '');
                                                    const baseSlug = slug(base);
                                                    if (baseSlug === jobTitleSlug) { assignedByFunctionAnywhere = true; break; }
                                                } else {
                                                    const rawSlug = slug(raw);
                                                    if (rawSlug === jobTitleSlug) { assignedByFunctionAnywhere = true; break; }
                                                }
                                            }
                                        }
                                    } catch {}
                                } else {
                                    canActByLevel = false;
                                }
                            }
                        }
                    }
                } catch {}

                // Name-based ANY-level fallback only when there's no sequential config
                const myNameAny = (this.currentUser?.displayName || this.currentUser?.name || this.currentUser?.email || '').trim().toLowerCase();
                const nameListedAny = !!(this._currentLeaveApproverNameSet && myNameAny && this._currentLeaveApproverNameSet.has(myNameAny));
                // If user already acted on this leave, hide buttons regardless of overrides
                const meIds = new Set([this.currentUser?.uid, this.currentUser?.userId, this.currentUser?.id, this.currentUser?.employeeId].filter(Boolean).map(String));
                const alreadyActed = Array.isArray(data?.approvalHistory) && data.approvalHistory.some(h => meIds.has(String(h.userId||'')));
                // Final decision: enforce sequential strictly when configured, and prevent repeat actions
                const baseCanAct = statusAllows && ((hasSequential ? (canActByLevel || assignedByFunctionAnywhere) : (canActByLevel || nameListedAny || assignedByFunctionAnywhere)) || isManagerial);
                const canAct = baseCanAct && !alreadyActed;

                approveBtn.style.display = canAct ? 'inline-flex' : 'none';
                declineBtn.style.display = canAct ? 'inline-flex' : 'none';

                // Submitter-only delete button visibility (allowed for pending/submitted)
                if (deleteBtn) {
                    const submitterIdSet = new Set([
                        data?.employeeId,
                        data?.createdBy,
                        data?.submitterId,
                        data?.userId,
                        data?.ownerId
                    ].filter(Boolean).map(String));
                    const meIds = new Set([this.currentUser?.uid, this.currentUser?.userId, this.currentUser?.id, this.currentUser?.employeeId].filter(Boolean).map(String));
                    let isSubmitter = false;
                    for (const id of meIds) { if (submitterIdSet.has(String(id))) { isSubmitter = true; break; } }
                    const canDelete = isSubmitter && statusAllows;
                    deleteBtn.style.display = canDelete ? 'inline-flex' : 'none';
                }
            }

            async approveCurrentLeave() {
                try {
                    const data = window._currentLeaveData || null;
                    if (!data || !data.id || !this.currentUser?.companyId) return;

                    const companyId = this.currentUser.companyId;
                    const refPath = `companies/${companyId}/leaveRequests/${data.id}`;

                    // Fetch latest to avoid stale writes
                    const snap = await db.ref(refPath).once('value');
                    if (!snap.exists()) return;
                    const current = snap.val() || {};

                    // Compute approval history
                    let hist = Array.isArray(current.approvalHistory) ? current.approvalHistory.slice() : [];

                    // Determine flow length (required approvals)
                    let totalRequired = 0;
                    try {
                        const flowSnap = await db.ref(`companies/${companyId}/approvalFlows/leave_request`).once('value');
                        if (flowSnap.exists()) {
                            const flow = flowSnap.val() || {};
                            if (flow.selectedRoles && Object.keys(flow.selectedRoles).length > 0) {
                                totalRequired = Object.values(flow.selectedRoles).reduce((acc, arr) => acc + (Array.isArray(arr) ? arr.length : 0), 0);
                            } else if (Array.isArray(flow.levels)) {
                                totalRequired = flow.levels.length;
                            }
                        }
                    } catch {}
                    if (!totalRequired) totalRequired = 1;

                    // Add this approval entry
                    const entry = {
                        action: 'approved',
                        status: 'approved',
                        userId: this.currentUser.uid || this.currentUser.userId,
                        userName: this.currentUser.displayName || this.currentUser.name || this.currentUser.email || 'User',
                        role: this.currentUser.role || '',
                        submittedAt: Date.now(),
                    };
                    hist.push(entry);

                    // Count approvals
                    const approvedCount = hist.filter(h => String(h.status||'').toLowerCase() === 'approved').length;
                    const newStatus = approvedCount >= totalRequired ? 'approved' : 'pending';

                    await db.ref(refPath).update({
                        approvalHistory: hist,
                        status: newStatus
                    });

                    // Update cached and UI
                    window._currentLeaveData = { ...(current||{}), approvalHistory: hist, status: newStatus };
                    const statusEl = document.getElementById('viewLeaveStatus');
                    if (statusEl) statusEl.textContent = newStatus;
                    await this.updateLeaveActionButtonsVisibility(window._currentLeaveData);
                    // Re-render flow to reflect inline history changes
                    try { await this.renderLeaveApprovalFlowForModal(); } catch {}
                    this.showNotification && this.showNotification(`Leave ${newStatus === 'approved' ? 'approved' : 'moved to next step'}`, 'success');
                    try { await this.loadRecentLeaveRequests(); } catch {}
                } catch (e) {
                    console.error('Failed to approve leave', e);
                    this.showNotification && this.showNotification('Failed to approve leave', 'error');
                }
            }

            async declineCurrentLeave() {
                try {
                    const data = window._currentLeaveData || null;
                    if (!data || !data.id || !this.currentUser?.companyId) return;

                    const reason = window.prompt('Please provide a reason for declining (optional):', '') || '';

                    const companyId = this.currentUser.companyId;
                    const refPath = `companies/${companyId}/leaveRequests/${data.id}`;
                    const snap = await db.ref(refPath).once('value');
                    if (!snap.exists()) return;
                    const current = snap.val() || {};

                    let hist = Array.isArray(current.approvalHistory) ? current.approvalHistory.slice() : [];
                    hist.push({
                        action: 'rejected',
                        status: 'rejected',
                        comment: reason,
                        userId: this.currentUser.uid || this.currentUser.userId,
                        userName: this.currentUser.displayName || this.currentUser.name || this.currentUser.email || 'User',
                        role: this.currentUser.role || '',
                        submittedAt: Date.now(),
                    });

                    await db.ref(refPath).update({
                        approvalHistory: hist,
                        status: 'rejected'
                    });

                    window._currentLeaveData = { ...(current||{}), approvalHistory: hist, status: 'rejected' };
                    const statusEl = document.getElementById('viewLeaveStatus');
                    if (statusEl) statusEl.textContent = 'rejected';
                    await this.updateLeaveActionButtonsVisibility(window._currentLeaveData);
                    // Re-render flow to reflect inline history changes
                    try { await this.renderLeaveApprovalFlowForModal(); } catch {}
                    this.showNotification && this.showNotification('Leave rejected', 'success');
                    try { await this.loadRecentLeaveRequests(); } catch {}
                } catch (e) {
                    console.error('Failed to decline leave', e);
                    this.showNotification && this.showNotification('Failed to decline leave', 'error');
                }
            }
            
            async deleteCurrentLeave() {
                try {
                    const data = window._currentLeaveData || null;
                    if (!data || !data.id || !this.currentUser?.companyId) return;

                    // Only submitter can delete, and only when pending/submitted
                    const status = String(data?.status || 'pending').toLowerCase();
                    const statusAllows = (status === 'pending' || status === 'submitted');
                    const submitterIdSet = new Set([
                        data?.employeeId,
                        data?.createdBy,
                        data?.submitterId,
                        data?.userId,
                        data?.ownerId
                    ].filter(Boolean).map(String));
                    const meIds = new Set([this.currentUser?.uid, this.currentUser?.userId, this.currentUser?.id, this.currentUser?.employeeId].filter(Boolean).map(String));
                    let isSubmitter = false;
                    for (const id of meIds) { if (submitterIdSet.has(String(id))) { isSubmitter = true; break; } }
                    if (!isSubmitter || !statusAllows) {
                        this.showNotification && this.showNotification('Deletion not allowed for this request', 'warning');
                        return;
                    }

                    const confirmed = window.confirm('Delete this leave request? This action cannot be undone.');
                    if (!confirmed) return;

                    const companyId = this.currentUser.companyId;
                    const refPath = `companies/${companyId}/leaveRequests/${data.id}`;
                    await db.ref(refPath).remove();

                    this.showNotification && this.showNotification('Leave request deleted', 'success');
                    try { await this.loadRecentLeaveRequests(); } catch {}
                    this.closeLeaveDetailsModal();
                } catch (e) {
                    console.error('Failed to delete leave', e);
                    this.showNotification && this.showNotification('Failed to delete leave', 'error');
                }
            }
            // ---- End Leave Approval Actions ----

            // ---- Leave Preview (printable) ----
            async openLeavePreview() {
                try {
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:4000;display:flex;align-items:flex-start;justify-content:center;overflow:auto;padding:32px 20px;';
                    const modal = document.createElement('div');
                    modal.style.cssText = 'background:#fff;border-radius:12px;width:100%;max-width:940px;min-height:60vh;box-shadow:0 18px 42px rgba(0,0,0,0.22);position:relative;overflow:hidden;';

                    const companyName = (this.currentCompany && (this.currentCompany.companyName || this.currentCompany.name)) || '';
                    const logoEl = document.getElementById('headerCompanyLogo');
                    const logoSrc = (logoEl && logoEl.src && logoEl.style.display !== 'none') ? logoEl.src : '';
                    // HR stamp from company profile (if available)
                    const hrStampUrl = (this.currentCompany && this.currentCompany.hrStamp && String(this.currentCompany.hrStamp).trim() && String(this.currentCompany.hrStamp).trim().toLowerCase() !== 'null') ? this.currentCompany.hrStamp : '';
                    const type = document.getElementById('viewLeaveType')?.textContent?.trim() || '';
                    const dates = document.getElementById('viewLeaveDates')?.textContent?.trim() || '';
                    const days = document.getElementById('viewLeaveDays')?.textContent?.trim() || '';
                    const status = document.getElementById('viewLeaveStatus')?.textContent?.trim() || '';
                    const submitter = document.getElementById('viewLeaveSubmitterName')?.textContent?.trim() || '';
                    const job = document.getElementById('viewLeaveSubmitterJob')?.textContent?.trim() || '';
                    const dept = document.getElementById('viewLeaveSubmitterDept')?.textContent?.trim() || '';
                    const lm = document.getElementById('viewLeaveLineManager')?.textContent?.trim() || '';
                    const reasonHtml = document.getElementById('viewLeaveReason')?.innerHTML || '';
                    const flowContainer = document.getElementById('viewLeaveApproversList');
                    const flowHtml = flowContainer ? flowContainer.innerHTML : '';
                    const now = new Date();
                    const dd = String(now.getDate()).padStart(2,'0');
                    const mmm = now.toLocaleString('en-GB', { month: 'short' });
                    const yyyy = now.getFullYear();
                    const hh = String(now.getHours()).padStart(2,'0');
                    const mm = String(now.getMinutes()).padStart(2,'0');
                    const generatedStr = `${dd} ${mmm} ${yyyy}, ${hh}:${mm}`;
                    // Build an automatic document number per leave request (sequential, persisted)
                    const leaveCtxForDoc = (window._currentLeaveData || {});
                    const leaveIdForDoc = leaveCtxForDoc.id || leaveCtxForDoc.leaveId || '';
                    const month2 = String(now.getMonth()+1).padStart(2,'0');
                    const companyIdForDoc = this.currentUser?.companyId || null;
                    let docNumber = leaveCtxForDoc.documentNumber || '';
                    if (!docNumber) {
                        try {
                            // Use a company-scoped counter with a transaction for uniqueness
                            const counterRef = db.ref(`companies/${companyIdForDoc}/counters/leaveDocumentNumber`);
                            const txn = await counterRef.transaction(curr => (curr || 0) + 1);
                            let seqVal = null;
                            if (txn && txn.committed && txn.snapshot) {
                                seqVal = txn.snapshot.val();
                            }
                            if (typeof seqVal !== 'number') {
                                // Fallback to localStorage-based sequence if DB transaction fails
                                const lsKey = `leave.docNumber.seq.${companyIdForDoc || 'global'}`;
                                let localSeq = parseInt(localStorage.getItem(lsKey) || '0', 10);
                                localSeq = isNaN(localSeq) ? 0 : localSeq;
                                localSeq += 1;
                                localStorage.setItem(lsKey, String(localSeq));
                                seqVal = localSeq;
                            }
                            const seqStr = String(seqVal).padStart(6, '0');
                            docNumber = `LR-${yyyy}${month2}${dd}-${seqStr}`;
                            // Persist the generated document number on the leave for future consistency
                            if (companyIdForDoc && leaveIdForDoc) {
                                try { await db.ref(`companies/${companyIdForDoc}/leaveRequests/${leaveIdForDoc}/documentNumber`).set(docNumber); } catch {}
                            }
                        } catch (_) {
                            // Last-resort fallback: localStorage sequence
                            const lsKey = `leave.docNumber.seq.${companyIdForDoc || 'global'}`;
                            let localSeq = parseInt(localStorage.getItem(lsKey) || '0', 10);
                            localSeq = isNaN(localSeq) ? 0 : localSeq;
                            localSeq += 1;
                            localStorage.setItem(lsKey, String(localSeq));
                            const seqStr = String(localSeq).padStart(6, '0');
                            docNumber = `LR-${yyyy}${month2}${dd}-${seqStr}`;
                        }
                    }

                    // Resolve job title to display label (no hyphens), with fallback prettify
                    let jobDisplay = job;
                    try {
                        const jobOptions = await this.loadCompanyFieldOptions('job-title');
                        const resolvedJob = this.resolveOptionLabel(jobOptions, job);
                        jobDisplay = resolvedJob ? resolvedJob : this.prettifyTitle(job);
                    } catch {
                        jobDisplay = this.prettifyTitle(job);
                    }

                    const wrapper = document.createElement('div');
                    wrapper.className = 'leave-preview-container';
                    wrapper.innerHTML = `
                        <style>
                        @page { size: A4; margin: 0mm 10mm 10mm 10mm; }
                        .leave-preview-container{width:100%;display:flex;justify-content:center;}
                        /* Adjusted for proper A4 fit: width <= printable area (210mm - 2*10mm margins = 190mm) */
                        /* Reduced horizontal padding for wider content area */
                        /* Further reduced horizontal padding for maximum content width */
                        .leave-sheet{background:#fff;width:190mm;min-height:auto;padding:2mm 2mm 18mm;box-sizing:border-box;border:none;border-radius:0;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin:0 auto;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;position:relative;line-height:1.4;color:#111827;}
                        .doc-title{font-size:.9rem;font-weight:700;margin:2px 0 0;color:#111827;text-align:left;}
                        .doc-subtitle{font-size:.65rem;color:#6b7280;margin:0 0 6px;font-weight:500;text-align:left;}
                        .generated-stamp{display:block;font-size:.55rem;color:#6b7280;margin-top:2px;font-weight:500;}
                        .docmeta-row{font-size:.72rem;color:#111827;margin:6px 0 6px;}
                        .docmeta-label{font-weight:700;color:#374151;margin-right:6px;}
                        .divider{height:1px;background:#e5e7eb;margin:12px 0 18px;border-radius:1px;}
                        .leave-header{display:flex;justify-content:space-between;gap:20px;margin-bottom:0;page-break-inside:avoid;align-items:flex-start;}
                        .company-block{display:flex;flex-direction:column;align-items:flex-start;gap:8px;}
                        .leave-logo{width:100px;height:100px;object-fit:contain;border:none;border-radius:8px;background:#fff;}
                        .leave-company h1{margin:0;font-size:1.1rem;line-height:1.2;font-weight:700;}
                        .leave-company small{display:block;font-size:.6rem;color:#6b7280;margin-top:4px;font-weight:500;}
                        .leave-meta{font-size:.63rem;color:#374151;text-align:right;line-height:1.35;min-width:150px;}
                        .section{margin-bottom:18px;page-break-inside:avoid;}
                        .section h2{font-size:.75rem;text-transform:none;letter-spacing:.01em;font-weight:700;color:#111827;margin:0 0 8px;}
                        .section h2 .ld-icon{width:.8rem;height:.8rem;margin-right:6px;vertical-align:-1px;fill:currentColor;display:inline-block;}
                        .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;}
                        .info-item{display:grid;grid-template-columns:max-content 1fr;align-items:baseline;column-gap:10px;row-gap:3px;background:#fff;border:1px solid #e5e7eb;padding:8px 12px;border-radius:6px;}
                        .info-item.full-width{grid-column:1 / -1;}
                        .info-item label{font-size:.58rem;font-weight:700;letter-spacing:.03em;color:#6b7280;text-transform:none;white-space:nowrap;line-height:1.2;}
                        .info-item label::after{content: ':';margin:0 4px;color:#9ca3af;}
                        .info-item span{font-size:.72rem;color:#111827;font-weight:400;word-break:break-word;line-height:1.25;}
                        /* Ensure uniform text size in Employee Information section */
                        #previewEmployeeInfo .info-item label,
                        #previewEmployeeInfo .info-item span{font-size:.72rem;}
                        /* Remove box container styling for Employee Information fields */
                        #previewEmployeeInfo .info-item{background:transparent;border:none;padding:0;border-radius:0;}
                        /* Ensure uniform text size in Leave Details section */
                        #previewLeaveInfo .info-item label,
                        #previewLeaveInfo .info-item span{font-size:.72rem;}
                        /* Remove box container styling for Leave Details fields */
                        #previewLeaveInfo .info-item{background:transparent;border:none;padding:0;border-radius:0;}
                        .reason-box{background:#fff;border:1px solid #e5e7eb;padding:10px 12px;border-radius:6px;font-size:.72rem;min-height:64px;}
                        .approval-section table{width:100%;border-collapse:collapse;font-size:.66rem;}
                        .approval-section th{background:var(--primary-color);font-weight:600;text-transform:none;font-size:.58rem;letter-spacing:.01em;color:#ffffff;padding:6px;border:1px solid var(--primary-color);text-align:left;}                        
                        .approval-section td{padding:6px;border:1px solid #e5e7eb;vertical-align:top;background:#fff;color:#111827;}
                        .approval-section td.ts-cell, .approval-section td.ts-cell div{ white-space: nowrap; }
                        .status-chip{display:inline-block;font-size:.55rem;font-weight:600;letter-spacing:.02em;color:#374151;background:transparent;border:none;padding:0;border-radius:0;}
                        /* Employee Information table styled like approval table */
                        .emp-info-table{width:100%;border-collapse:collapse;font-size:.66rem;}
                        .emp-info-table th{background:var(--primary-color);font-weight:600;text-transform:none;font-size:.58rem;letter-spacing:.01em;color:#ffffff;padding:6px;border:1px solid var(--primary-color);text-align:left;}
                        .emp-info-table td{padding:6px;border:1px solid #e5e7eb;vertical-align:top;background:#fff;color:#111827;}
                        .emp-info-table td:first-child{width:180px;white-space:nowrap;}
                        .status-chip.approved{color:#166534;}
                        .status-chip.declined{color:#991b1b;}
                        .status-chip.pending{color:#92400e;}
                        .sig-img{max-width:150px;max-height:75px;object-fit:contain;display:block;}
                        .sig-stack{display:flex;flex-direction:column;gap:4px;}
                        .approver-job{font-size:.55rem;color:#6b7280;display:inline-block;}
                        .approver-fullname{font-size:.58rem;color:#1f2937;display:inline-block;font-weight:600;}
                        .policy-section{font-size:.6rem;color:#6b7280;border-top:1px solid #e5e7eb;padding-top:8px;margin-top:8px;}
                        .policy-section .hr-stamp{ text-align:right; margin-top:8px; }
                        .policy-section .hr-stamp img{ max-width:120px; max-height:120px; object-fit:contain; }
                        .policy-title{font-size:.62rem;font-weight:700;color:#374151;margin-bottom:6px;}
                        .policy-list{margin:0;padding-left:16px;}
                        .policy-list li{margin:2px 0;}
                        .sign-line{margin-top:6px;display:flex;flex-direction:column;gap:4px;}
                        .sign-line .line{height:1px;background:#9ca3af;width:100%;}
                        .sign-line span{font-size:.55rem;color:#6b7280;}
                        .doc-footer{position:absolute;left:0;right:0;bottom:0;font-size:.55rem;color:#6b7280;text-align:center;letter-spacing:.03em;white-space:pre-line;}
                        .print-btn{position:absolute;top:10px;right:10px;background:#111827;color:#fff;border:none;border-radius:6px;padding:7px 10px;font-size:.7rem;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
                        .close-btn{position:absolute;top:10px;right:120px;background:#fff;border:1px solid #d1d5db;color:#111827;border-radius:6px;padding:7px 10px;font-size:.7rem;cursor:pointer;}
                        @media print {
                            html, body { margin:0 !important; padding:0 !important; }
                            body * { visibility:hidden !important; }
                            .printable, .printable * { visibility:visible !important; }
                            .printable { position:static !important; margin:0 !important; box-shadow:none !important; border:none !important; width:auto !important; }
                            /* Ensure printed sheet fits inside A4 content box (190mm wide) including padding via border-box */
                            .leave-sheet { width:190mm !important; min-height:auto !important; margin:0 auto !important; padding:2mm 2mm 22mm !important; border:none !important; box-shadow:none !important; }
                            .print-btn, .close-btn { display:none !important; }
                            /* Pin footer to the physical page bottom within margins */
                            .doc-footer { position: fixed !important; left: 10mm !important; right: 10mm !important; bottom: 6mm !important; }
                            -webkit-print-color-adjust: exact; print-color-adjust: exact;
                        }
                        .emp-section h2.emp-header{background:var(--primary-color);color:#fff;padding:6px 10px;border-radius:0;margin:0 0 8px;}
                        @media print {
                            .emp-section h2.emp-header{background:var(--primary-color) !important;color:#fff !important;-webkit-print-color-adjust: exact; print-color-adjust: exact;}
                            /* Ensure divider shows up in PDF/print */
                            .divider{background:none !important;border-top:1px solid #e5e7eb !important;height:0 !important;}
                            /* Ensure Employee Information table header uses sidebar color in print/PDF */
                            .emp-info-table th{background:var(--primary-color) !important; color:#fff !important; border-color: var(--primary-color) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
                        }
                        </style>
                        <div class='leave-sheet printable'>
                            <button class='print-btn' id='leavePrintBtn'>Print / PDF</button>
                            <button class='close-btn' onclick='this.closest(".leave-preview-container").parentElement.parentElement.remove()'>Close</button>
                            <div class='leave-header'>
                                <div class='company-block'>
                                    ${logoSrc?`<img class='leave-logo' src='${logoSrc}' alt='${companyName} logo'/>`:`<div class='leave-logo' style="display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;color:#444;">${(companyName||'CN').split(/\s+/).map(w=>w[0]).slice(0,3).join('').toUpperCase()}</div>`}
                                    <div class='leave-company'>
                                        <h1 style='margin:0;font-size:1.1rem;'>${companyName || 'Company'}</h1>
                                        <h2 class='doc-title'>Leave Request Document</h2>
                                    </div>
                                </div>
                                
                            </div>
                            <div class='divider'></div>
                            <div class='docmeta-row'><span class='docmeta-label'>Document Number:</span><span class='docmeta-value'>${docNumber}</span></div>
                            <div class='section emp-section'>
                                <table id='previewEmployeeTable' class='emp-info-table'>
                                    <thead>
                                        <tr>
                                            <th colspan='2'>Employee Information</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class='divider'></div>
                            <div class='section'>
                                <h2><svg class='ld-icon' viewBox='0 0 24 24' focusable='false' aria-hidden='true'><path d='M7 2v2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7zm12 7H5v10h14V9z'></path></svg>Leave Details</h2>
                                <div class='info-grid' id='previewLeaveInfo'></div>
                            </div>
                            <div class='divider'></div>
                            <div class='section approval-section'>
                                <h2><svg class='ld-icon' viewBox='0 0 24 24' focusable='false' aria-hidden='true'><path d='M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm-9 10l-3-3 1.41-1.41L10 9.17l5.59-5.59L17 5l-7 8z'/></svg>Approval Flow & History</h2>
                                <table id='previewApprovalTable'>
                                    <thead>
                                        <tr>
                                            <th>Approver(s)</th>
                                            <th style='width:90px;'>Status</th>
                                            <th style='width:110px;'>Timestamp</th>
                                            <th style='width:160px;'>Signature</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class='section policy-section'>
                                <div class='policy-title'>Leave Policy</div>
                                <ul class='policy-list'>
                                    <li>Leave approvals follow company policy and manager discretion.</li>
                                    <li>Ensure available leave balance before submitting a request.</li>
                                    <li>Unauthorised leave may be unpaid and subject to review.</li>
                                    <li>For clarification, please contact HR.</li>
                                </ul>
                                ${hrStampUrl ? `<div class='hr-stamp'><img src='${hrStampUrl}' alt='HR Stamp'/></div>` : ''}
                            </div>
                            <div class='doc-footer'></div>
                        </div>
                    `;

                    // Inject company footer text from Company Profile (if available)
                    try {
                        const footerText = (this.currentCompany && this.currentCompany.footer)
                            ? String(this.currentCompany.footer).trim()
                            : '';
                        const footerEl = wrapper.querySelector('.doc-footer');
                        if (footerEl) footerEl.textContent = footerText || '';
                    } catch(_) { /* ignore footer injection failures */ }

                    // Build employee info blocks
                    const leaveCtx = (window._currentLeaveData || {});
                    // Resolve canonical Employee ID from Company Management (users directory)
                    let empIdVal = leaveCtx.employeeId || leaveCtx.employeeID || leaveCtx.staffId || leaveCtx.code || '';
                    try {
                        const companyIdForEmp = this.currentUser?.companyId;
                        if (companyIdForEmp && window.firebase) {
                            const submitterId = leaveCtx.createdBy || leaveCtx.submittedBy || leaveCtx.ownerId || leaveCtx.userId || leaveCtx.employeeUid || '';
                            const submitterNameLc = (submitter || '').trim().toLowerCase();
                            const usersSnap = await db.ref(`companies/${companyIdForEmp}/users`).once('value');
                            const usersVal = usersSnap.val() || {};
                            let rec = null;
                            if (submitterId && usersVal[submitterId]) {
                                rec = usersVal[submitterId];
                            } else if (submitterNameLc) {
                                for (const u of Object.values(usersVal)) {
                                    const nm = (u?.displayName || u?.name || u?.fullName || u?.email || '').trim().toLowerCase();
                                    if (nm && nm === submitterNameLc) { rec = u; break; }
                                }
                            }
                            if (rec) {
                                const canonicalId = rec.employeeId || rec.employeeID || rec.staffId || rec.code || '';
                                if (canonicalId) empIdVal = canonicalId;
                            }
                        }
                    } catch(e) { /* noop if lookup fails */ }
                    const empInfo = [
                        {label:'ID',value:empIdVal||'-'},
                        {label:'Employee Name',value:submitter||'-'},
                        {label:'Job Title',value:jobDisplay||'-'},
                        {label:'Department',value:dept||'-'},
                        {label:'Line Manager',value:lm||'-'}
                    ];
                    const empTbody = wrapper.querySelector('#previewEmployeeTable tbody');
                    if (empTbody) {
                        empInfo.forEach(b => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td style='font-weight:700;color:#374151;'>${b.label}</td><td>${b.value}</td>`;
                            empTbody.appendChild(tr);
                        });
                    }

                    // Leave detail blocks: include Type, Range, Days, and Reason/Notes
                    const leaveInfo=[
                        {label:'Type', value:type||'-'},
                        {label:'Period', value:dates||'-'},
                        {label:'Days', value:days||'-'},
                        {label:'Reason / Notes', value:reasonHtml || '<em>No reason provided.</em>'}
                    ];
                    const leaveWrap = wrapper.querySelector('#previewLeaveInfo');
                    const leaveGroup = document.createElement('div');
                    leaveGroup.className = 'info-item full-width';
                    leaveGroup.innerHTML = leaveInfo.map(b => `<label>${b.label}</label><span>${b.value}</span>`).join('');
                    leaveWrap.appendChild(leaveGroup);

                    // Approval table: build rows from configured approval flow ensuring all levels appear
                    const tbody = wrapper.querySelector('#previewApprovalTable tbody');
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = flowHtml;
                    const levelEls = Array.from(tempDiv.querySelectorAll('.leave-approval-flow-level'));

                    // Map existing DOM levels -> data
                    const existingLevelData = new Map(); // levelNumber -> {approverNames, historyEntries}
                    levelEls.forEach((lvl, idx) => {
                        const approverNames = Array.from(lvl.querySelectorAll('.approver-name')).map(a => a.textContent.trim()).filter(Boolean);
                        const historyEntries = Array.from(lvl.querySelectorAll('.inline-history-entry'));
                        existingLevelData.set(idx + 1, { approverNames, historyEntries });
                    });

                    // Determine configured levels from leaveApprovalFlow (selectedRoles preferred)
                    const flowCfg = this.leaveApprovalFlow || {};
                    const availableRoles = Array.isArray(flowCfg.availableRoles) ? flowCfg.availableRoles : [];
                    const mapRoleValueToText = (val) => {
                        if (!val) return '';
                        const m = availableRoles.find(r => r.function === val);
                        return (m && (m.text || m.name)) || String(val);
                    };
                    let configuredLevels = [];
                    if (flowCfg.selectedRoles && Object.keys(flowCfg.selectedRoles).length) {
                        const sortedKeys = Object.keys(flowCfg.selectedRoles).sort((a,b)=>{
                            const na = parseInt(a.replace(/[^0-9]/g,''))||0; const nb = parseInt(b.replace(/[^0-9]/g,''))||0; return na-nb;
                        });
                        configuredLevels = sortedKeys.map((k,i)=>({number:(parseInt(k.replace(/[^0-9]/g,''))|| (i+1)), selected: flowCfg.selectedRoles[k]}));
                    } else if (Array.isArray(flowCfg.levels) && flowCfg.levels.length) {
                        configuredLevels = flowCfg.levels.map((lvl,i)=>({number:i+1, selected:lvl}));
                    } else {
                        // Fallback to existing levels or single level
                        const count = levelEls.length || 1;
                        configuredLevels = Array.from({length:count}, (_,i)=>({number:i+1}));
                    }

                    // Normalize configured level count (handle duplicate numbers)
                    const seenNums = new Set();
                    configuredLevels = configuredLevels.filter(l => {
                        if (seenNums.has(l.number)) return false; seenNums.add(l.number); return true;
                    }).sort((a,b)=> a.number - b.number);

                    // Render each configured level row
                    // Build signature & job title lookup maps
                    // name(lowercased) -> signatureUrl, userId -> signatureUrl, userId -> jobTitle, name(lowercased) -> jobTitle
                    let signatureMap = {}; let signatureMapById = {}; let jobTitleById = {}; let jobTitleByName = {}; let fullNameById = {}; let fullNameByName = {};
                    try {
                        const companyIdForSig = this.currentUser?.companyId;
                        if (companyIdForSig && window.firebase) {
                            const usersSnap = await db.ref(`companies/${companyIdForSig}/users`).once('value');
                            const usersVal = usersSnap.val() || {};
                            Object.entries(usersVal).forEach(([uid,u]) => {
                                if (!u) return;
                                const nm = (u.displayName || u.name || u.fullName || u.email || '').trim();
                                const sig = u.signatureUrl || null;
                                const rawJob = (u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '').trim();
                                const prettyJob = rawJob ? this.prettifyTitle(rawJob) : '';
                                if (uid && nm) fullNameById[uid] = nm;
                                if (nm) fullNameByName[nm.toLowerCase()] = nm;
                                if (nm && sig) signatureMap[nm.toLowerCase()] = sig;
                                if (uid && sig) signatureMapById[uid] = sig;
                                if (uid && prettyJob) jobTitleById[uid] = prettyJob;
                                if (nm && prettyJob) jobTitleByName[nm.toLowerCase()] = prettyJob;
                            });
                        }
                    } catch(e){ console.warn('Signature map build failed', e); }

                    configuredLevels.forEach(cfg => {
                        const levelNum = cfg.number;
                        const existing = existingLevelData.get(levelNum) || { approverNames: [], historyEntries: [] };
                        let approverNames = Array.isArray(existing.approverNames) ? existing.approverNames.slice() : [];
                        // Fallback approver names from configured flow (selectedRoles/levels)
                        if ((!approverNames || approverNames.length === 0) && cfg.selected) {
                            const sel = cfg.selected;
                            if (Array.isArray(sel)) {
                                approverNames = sel.map(r => r.text || r.roleName || r.name || r.displayName || r.functionName || mapRoleValueToText(r.value || r.function || r.func || r.id)).filter(Boolean);
                            } else if (typeof sel === 'object') {
                                const nameFromObj = sel.text || sel.roleName || sel.name || sel.displayName || sel.functionName || mapRoleValueToText(sel.value || sel.function || sel.func || sel.id);
                                if (nameFromObj) approverNames = [nameFromObj];
                            }
                        }
                        // Legacy: if still no names and flow levels are objects with value
                        if ((!approverNames || approverNames.length === 0) && typeof cfg.selected === 'undefined') {
                            // Try to infer from legacy levels array using availableRoles mapping via existing DOM fallback already empty
                            const lvlFromFlow = (Array.isArray(flowCfg.levels) ? flowCfg.levels[cfg.number-1] : null);
                            if (lvlFromFlow && (lvlFromFlow.text || lvlFromFlow.value)) {
                                const nm = lvlFromFlow.text || mapRoleValueToText(lvlFromFlow.value);
                                if (nm) approverNames = [nm];
                            }
                        }
                        if (!approverNames || approverNames.length === 0) approverNames = ['-'];

                        const historyEntries = existing.historyEntries || [];
                        // Build per-approver status/timestamp by pairing entries by index order
                        const statuses = [];
                        const timestamps = [];
                        const statusClasses = [];
                        for (let i = 0; i < approverNames.length; i++) {
                            const entry = historyEntries[i] || null;
                            if (entry) {
                                const sText = (entry.querySelector('.history-status')?.textContent || '').trim();
                                const tText = (entry.querySelector('.history-timestamp')?.textContent || '').trim();
                                const sEff = sText || 'Pending';
                                statuses.push(sEff);
                                timestamps.push(tText || '-');
                                statusClasses.push(/Approved/i.test(sEff)?'approved':(/Declined|Rejected/i.test(sEff)?'declined':'pending'));
                            } else {
                                statuses.push('Pending');
                                timestamps.push('-');
                                statusClasses.push('pending');
                            }
                        }

                        // Compose stacked cells so each approver aligns with status/timestamp
                        // Build approver HTML with job title where status approved
                        const approverHtml = approverNames.map((n,idx)=>{
                            const entry = existing.historyEntries[idx];
                            const uid = entry?.getAttribute('data-user-id')?.trim();
                            const isApproved = statusClasses[idx] === 'approved';
                            // Detect L+1 tokens and synonyms
                            const isL1Token = (s)=>{ const v=String(s||'').trim().toLowerCase(); if(!v) return false; return (/^l\+?1$/.test(v) || /^level\+?1$/.test(v) || /^level\s*1$/.test(v) || v==='line manager' || v==='linemanager'); };
                            let jobTitle = '';
                            if (isApproved) {
                                if (uid && jobTitleById[uid]) jobTitle = jobTitleById[uid]; else if (jobTitleByName[n.toLowerCase()]) jobTitle = jobTitleByName[n.toLowerCase()];
                            }
                            let fullName = '';
                            if (uid && fullNameById[uid]) fullName = fullNameById[uid]; else if (fullNameByName[n.toLowerCase()]) fullName = fullNameByName[n.toLowerCase()];
                            // If approved and token is L+1, suppress the token and use the actual approver name
                            const mainText = (isApproved && isL1Token(n)) ? (fullName || '') : n;
                            const parts = [];
                            if (mainText) parts.push(mainText);
                            // Avoid duplicating fullName on next line if it's already the main text
                            if (fullName && (!mainText || fullName.trim().toLowerCase() !== String(mainText).trim().toLowerCase())) {
                                parts.push(`<span class='approver-fullname'>${fullName}</span>`);
                            }
                            if (jobTitle) parts.push(`<span class='approver-job'>${jobTitle}</span>`);
                            return `<div>${parts.join('<br>')}</div>`;
                        }).join('');
                        const statusHtml = statuses.map((s,idx)=>{ const cap = s ? s.charAt(0).toUpperCase()+s.slice(1) : s; return `<div><span class='status-chip ${statusClasses[idx]}'>${cap}</span></div>`; }).join('');
                        const tsHtml = timestamps.map(t=>{ const tNorm = String(t||'').replace(/\s*\n\s*/g,' ').replace(/\s{2,}/g,' ').trim(); return `<div>${tNorm}</div>`; }).join('');
                        // Build signature cell: show default signature image for each approver with Approved status
                        const signatureBlocks = approverNames.map((n,idx)=>{
                            const statusClass = statusClasses[idx];
                            if (statusClass === 'approved') {
                                // Attempt to get userId from corresponding history entry
                                const entry = existing.historyEntries[idx];
                                const uid = entry?.getAttribute('data-user-id')?.trim();
                                let sigUrl = '';
                                if (uid && signatureMapById[uid]) {
                                    sigUrl = signatureMapById[uid];
                                } else {
                                    sigUrl = signatureMap[n.toLowerCase()] || '';
                                }
                                if (sigUrl) return `<div><img src='${sigUrl}' alt='${n} signature' class='sig-img'/></div>`;
                            }
                            // Pending or other non-approved statuses: leave empty (keep minimal spacer for layout)
                            return `<div style='height:14px;'></div>`;
                        }).join('');
                        // Always render stack; do not show placeholder lines/names when pending
                        const signatureCellHtml = `<div class='sig-stack'>${signatureBlocks}</div>`;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${approverHtml}</td><td>${statusHtml}</td><td class='ts-cell'>${tsHtml}</td><td>${signatureCellHtml}</td>`;
                        tbody.appendChild(tr);
                    });

                    // Apply dynamic header color (sidebar primary) for modal and print
                    try {
                        const primaryColor = (getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '').trim() || '#2c3e50';
                        const ths = wrapper.querySelectorAll('.approval-section th');
                        ths.forEach(th => th.classList.add('approval-dark-header'));
                        const dynStyle = document.createElement('style');
                        dynStyle.textContent = `
                            .approval-section th.approval-dark-header { background:${primaryColor} !important; color:#fff !important; }
                            @media print { .approval-section th.approval-dark-header { background:${primaryColor} !important; color:#fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        `;
                        wrapper.querySelector('.leave-sheet').prepend(dynStyle);
                        const printBtn = wrapper.querySelector('#leavePrintBtn');
                        if (printBtn) {
                            printBtn.addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
                        }
                    } catch(e){ console.warn('Dynamic print header color failed', e); }

                    // Wire safe close behavior to avoid leaving overlay behind
                    const closeBtn = wrapper.querySelector('.close-btn');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            try { overlay.remove(); } catch {}
                        });
                    }
                    // Click outside to close
                    modal.addEventListener('click', (e) => e.stopPropagation());
                    overlay.addEventListener('click', () => { try { overlay.remove(); } catch {} });

                    modal.appendChild(wrapper);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);
                } catch(e){
                    console.error('Failed to open leave preview', e);
                }
            }
            // ---- End Leave Preview ----

            async switchTab(tabName) {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                
                // Add active class to clicked button and corresponding pane
                const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
                const activePane = document.getElementById(tabName);
                
                if (activeButton) activeButton.classList.add('active');
                if (activePane) {
                    activePane.classList.add('active');
                    // Ensure pane-authorized is set for visibility
                    activePane.classList.add('pane-authorized');
                }
                
                // Load specific content based on tab
                switch(tabName) {
                    case 'activity':
                        this.loadRecentActivity();
                        break;
                    case 'personal':
                        // Refresh personal info to reflect latest company job title
                        try { await this.loadUserProfile(); } catch(e) { console.warn('Failed to refresh personal info', e); }
                        break;
                    case 'security':
                        // Ensure signature preview is up to date
                        this.loadSavedSignaturePreview();
                        break;
                    case 'preferences':
                        // Preferences might need loading
                        break;
                    case 'payslip':
                        this.loadPayslips();
                        break;
                    case 'course':
                        this.loadAssignedCourses();
                        break;
                    case 'settings':
                        this.loadProfileAccessControl();
                        this.loadProfileLocations();
                        break;
                    case 'sign':
                        // Sign tab is handled by its own script
                        break;
                }
            }

            async loadAssignedCourses() {
                const container = document.getElementById('assignedCoursesList');
                if (!container) return;
                
                try {
                    // Resolve company/user context similar to lms.html
                    let companyId = null; let userId = null;
                    try {
                        const ctx = await (window.resolveCompanyContext ? window.resolveCompanyContext() : (async()=>{ throw new Error('Context resolver missing'); })());
                        companyId = ctx.companyId; userId = ctx.userId;
                    } catch(e){
                        console.warn('resolveCompanyContext failed', e);
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #6c757d;">
                                <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p>Please sign in to view your assigned courses.</p>
                            </div>
                        `;
                        return;
                    }
                    if(!companyId || !userId){
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #6c757d;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p>Unable to resolve company context.</p>
                            </div>
                        `;
                        return;
                    }

                    // Load assignments for the current user
                    const assignmentsSnap = await firebase.database().ref(`companies/${companyId}/lms/assignments`).once('value');
                    const assignmentsData = assignmentsSnap.val() || {};

                    // Filter assignments for current user
                    const userAssignments = Object.keys(assignmentsData)
                        .map(key => ({ id: key, ...assignmentsData[key] }))
                        .filter(assignment => assignment.employeeId === userId);

                    if (userAssignments.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #6c757d;">
                                <i class="fas fa-book-open" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <h4 style="margin-bottom: 0.5rem;">No Assigned Courses</h4>
                                <p>You don't have any assigned courses at the moment.</p>
                            </div>
                        `;
                        return;
                    }

                    // Load course details for each assignment
                    const coursesSnap = await firebase.database().ref(`companies/${companyId}/lms/courses`).once('value');
                    const coursesData = coursesSnap.val() || {};

                    // Group assignments by status
                    const activeAssignments = [];
                    const completedAssignments = [];
                    const overdueAssignments = [];
                    const certificates = [];

                    userAssignments.forEach(assignment => {
                        const course = coursesData[assignment.courseId];
                        if (course) {
                            const assignmentWithCourse = {
                                ...assignment,
                                course: course
                            };
                            
                            // Check if assignment is completed (100% progress)
                            const isCompleted = assignment.status === 'completed' || Number(assignment.progress || 0) >= 100;
                            
                            // Check if assignment is overdue
                            if (assignment.dueDate) {
                                const dueDate = new Date(assignment.dueDate);
                                const now = new Date();
                                if (dueDate < now && !isCompleted) {
                                    overdueAssignments.push(assignmentWithCourse);
                                } else if (isCompleted) {
                                    completedAssignments.push(assignmentWithCourse);
                                } else {
                                    activeAssignments.push(assignmentWithCourse);
                                }
                            } else {
                                if (isCompleted) {
                                    completedAssignments.push(assignmentWithCourse);
                                } else {
                                    activeAssignments.push(assignmentWithCourse);
                                }
                            }
                            
                            // Add to certificates if completed
                            if (isCompleted) {
                                const cert = {
                                    courseId: assignment.courseId,
                                    assignmentId: assignment.id,
                                    courseTitle: course.title || 'Untitled Course',
                                    completedAt: assignment.completedAt || assignment.updatedAt || assignment.assignedAt || null,
                                    certificateUrl: assignment.certificateUrl || assignment.certificate?.url || null,
                                    certificateName: assignment.certificateName || assignment.certificate?.name || null,
                                    certificateId: assignment.certificateId || assignment.certificate?.id || assignment.id || null
                                };
                                certificates.push(cert);
                            }
                        }
                    });

                    // Update stats
                    const statActive = document.getElementById('statActive');
                    const statOverdue = document.getElementById('statOverdue');
                    const statCompleted = document.getElementById('statCompleted');
                    if (statActive) statActive.textContent = String(activeAssignments.length);
                    if (statOverdue) statOverdue.textContent = String(overdueAssignments.length);
                    if (statCompleted) statCompleted.textContent = String(completedAssignments.length);

                    // Render the assignments grouped by status
                    let html = '';

                    // Overdue assignments (priority)
                    if (overdueAssignments.length > 0) {
                        html += `
                            <div class="assignment-section overdue-section" style="margin-bottom: 2rem;">
                                <h4 style="color: #dc3545; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Overdue Assignments (${overdueAssignments.length})
                                </h4>
                                <div class="assignments-grid">
                                    ${this.renderAssignmentCards(overdueAssignments, 'overdue')}
                                </div>
                            </div>
                        `;
                    }

                    // Active assignments
                    if (activeAssignments.length > 0) {
                        html += `
                            <div class="assignment-section active-section" style="margin-bottom: 2rem;">
                                <h4 style="color: #0066cc; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-clock"></i>
                                    Active Assignments (${activeAssignments.length})
                                </h4>
                                <div class="assignments-grid">
                                    ${this.renderAssignmentCards(activeAssignments, 'active')}
                                </div>
                            </div>
                        `;
                    }

                    // Completed assignments
                    if (completedAssignments.length > 0) {
                        html += `
                            <div class="assignment-section completed-section" style="margin-bottom: 1rem;">
                                <h4 style="color: #28a745; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-check-circle"></i>
                                    Completed Assignments (${completedAssignments.length})
                                </h4>
                                <div class="assignments-grid">
                                    ${this.renderAssignmentCards(completedAssignments, 'completed')}
                                </div>
                            </div>
                        `;
                    }

                    // Apply filter if present
                    const filterSel = document.getElementById('courseStatusFilter');
                    const applyFilter = (val)=>{
                        let filteredHtml = '';
                        if (val === 'active') {
                            filteredHtml += html.match(/Active Assignments/) ? html.split('Completed Assignments')[0] : html;
                            container.innerHTML = filteredHtml || '<div style="text-align: center; padding: 2rem; color: #6c757d;">No active assignments.</div>';
                        } else if (val === 'overdue') {
                            const overBlock = html.includes('Overdue Assignments') ? html.split('Active Assignments')[0] : '';
                            container.innerHTML = overBlock || '<div style="text-align: center; padding: 2rem; color: #6c757d;">No overdue assignments.</div>';
                        } else if (val === 'completed') {
                            const cBlock = html.includes('Completed Assignments') ? html.substring(html.indexOf('Completed Assignments') - 60) : '';
                            container.innerHTML = cBlock || '<div style="text-align: center; padding: 2rem; color: #6c757d;">No completed assignments.</div>';
                        } else {
                            container.innerHTML = html || '<div style="text-align: center; padding: 2rem; color: #6c757d;">No course assignments found.</div>';
                        }
                    };
                    if (filterSel) {
                        applyFilter(filterSel.value || 'all');
                        filterSel.onchange = (e)=> applyFilter(e.target.value);
                    } else {
                        container.innerHTML = html || '<div style="text-align: center; padding: 2rem; color: #6c757d;">No course assignments found.</div>';
                    }

                    // Wire refresh button to reload
                    const refreshBtn = document.getElementById('refreshCoursesBtn');
                    if (refreshBtn) { refreshBtn.onclick = () => this.loadAssignedCourses(); }

                    // Real-time updates: reflect add/remove and progress changes
                    if (!this._assignmentsListener) {
                        const ref = firebase.database().ref(`companies/${companyId}/lms/assignments`);
                        this._assignmentsListener = (snap) => {
                            // Re-render on any change
                            this.loadAssignedCourses();
                        };
                        ref.on('value', this._assignmentsListener);
                    }

                    // Update certificates stat
                    const statCertificates = document.getElementById('statCertificates');
                    if (statCertificates) statCertificates.textContent = String(certificates.length);

                } catch (error) {
                    console.error('Error loading assigned courses:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #dc3545;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Error loading your assigned courses. Please try again later.</p>
                        </div>
                    `;
                }
            }

            renderAssignmentCards(assignments, status) {
                return assignments.map(assignment => {
                    const course = assignment.course;
                    const progressPct = Number(assignment.progress || 0);
                    const assignedDate = assignment.assignedAt ? new Date(assignment.assignedAt).toLocaleDateString() : 'N/A';
                    const dueDate = assignment.dueDate ? new Date(assignment.dueDate).toLocaleDateString() : 'No due date';
                    const completedDate = assignment.completedAt ? new Date(assignment.completedAt).toLocaleDateString() : null;
                    
                    let statusClass = '';
                    let statusIcon = '';
                    let statusText = '';
                    
                    switch (status) {
                        case 'overdue':
                            statusClass = 'border-left: 4px solid #dc3545;';
                            statusIcon = '<i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>';
                            statusText = `<span style="color: #dc3545; font-weight: 600;">Overdue</span>`;
                            break;
                        case 'active':
                            statusClass = 'border-left: 4px solid #0066cc;';
                            statusIcon = '<i class="fas fa-clock" style="color: #0066cc;"></i>';
                            statusText = `<span style="color: #0066cc; font-weight: 600;">In Progress</span>`;
                            break;
                        case 'completed':
                            statusClass = 'border-left: 4px solid #f59e0b;';
                            statusIcon = '<i class="fas fa-certificate" style="color: #f59e0b;"></i>';
                            statusText = `<span style="color: #28a745; font-weight: 600;">Completed</span> <span style="background:#fef3c7; color:#92400e; padding:0.15rem 0.5rem; border-radius:12px; font-size:0.7rem; font-weight:600; margin-left:0.5rem;"><i class="fas fa-award" style="margin-right:0.25rem;"></i>Certificate Earned</span>`;
                            break;
                    }
                    
                    return `
                        <div class="assignment-card" style="
                            background: ${status === 'completed' ? 'linear-gradient(135deg, #fffbeb 0%, #ffffff 100%)' : 'white'};
                            border-radius: 8px;
                            padding: 1.5rem;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            ${statusClass}
                            margin-bottom: 1rem;
                            transition: transform 0.2s ease, box-shadow 0.2s ease;
                            position: relative;
                            overflow: hidden;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">
                            ${status === 'completed' ? `<div style="position:absolute; top:-15px; right:-15px; width:80px; height:80px; opacity:0.1;"><i class="fas fa-certificate" style="font-size:80px; color:#f59e0b;"></i></div>` : ''}
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #2c3e50; font-size: 1.1rem; font-weight: 600;">
                                        ${course.title || 'Untitled Course'}
                                    </h5>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            ${statusIcon}
                                            ${statusText}
                                            ${status === 'completed' ? `
                                                <span style="color: #6c757d; font-size: 0.75rem; margin-left: 0.5rem;">
                                                     Assigned: ${assignedDate}  Completed: ${completedDate || 'N/A'}
                                                </span>
                                            ` : ''}
                                        </div>
                                        ${status === 'completed' ? `
                                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                <button 
                                                    onclick="profileManager.viewCertificate('${assignment.courseId}', '${assignment.id}')" 
                                                    style="
                                                        background: transparent;
                                                        color: #6b7280;
                                                        border: 1px solid #e5e7eb;
                                                        padding: 0.35rem 0.75rem;
                                                        border-radius: 6px;
                                                        font-size: 0.75rem;
                                                        cursor: pointer;
                                                        transition: all 0.2s ease;
                                                    "
                                                    onmouseover="this.style.borderColor='#9ca3af'; this.style.color='#374151'" 
                                                    onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280'"
                                                >
                                                    <i class="fas fa-eye" style="margin-right: 0.25rem;"></i>
                                                    Preview
                                                </button>
                                                <button 
                                                    onclick="profileManager.downloadCertificate('${assignment.courseId}', '${assignment.id}')" 
                                                    style="
                                                        background: linear-gradient(135deg, #f59e0b, #d97706);
                                                        color: white;
                                                        border: none;
                                                        padding: 0.35rem 0.75rem;
                                                        border-radius: 6px;
                                                        font-size: 0.75rem;
                                                        font-weight: 500;
                                                        cursor: pointer;
                                                        transition: all 0.2s ease;
                                                        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                                                    "
                                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)'" 
                                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(245, 158, 11, 0.3)'"
                                                >
                                                    <i class="fas fa-certificate" style="margin-right: 0.25rem;"></i>
                                                    Download
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${status !== 'completed' ? `
                                    <div style="margin:.25rem 0 .75rem;">
                                        <div style="display:flex; justify-content:space-between; font-size:.75rem; color:#6b7280; margin-bottom:.25rem;">
                                            <span>Progress</span><span>${progressPct}%</span>
                                        </div>
                                        <div style="height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden;">
                                            <div style="height:6px; width:${progressPct}%; background:#3b82f6; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${status !== 'completed' ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <small style="color: #6c757d; font-weight: 600;">Assigned:</small><br>
                                    <span style="font-size: 0.9rem;">${assignedDate}</span>
                                </div>
                                <div>
                                    <small style="color: #6c757d; font-weight: 600;">Due:</small><br>
                                    <span style="font-size: 0.9rem;">${dueDate}</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${assignment.notes ? `
                                <div style="background: #f8f9fa; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
                                    <small style="color: #6c757d; font-weight: 600;">Notes:</small><br>
                                    <span style="font-size: 0.9rem; color: #495057;">${assignment.notes}</span>
                                </div>
                            ` : ''}
                            
                            ${status === 'active' ? `
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button 
                                        onclick="profileManager.startCourse('${assignment.courseId}')" 
                                        style="
                                            background: linear-gradient(135deg, #0066cc, #004499);
                                            color: white;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 6px;
                                            font-size: 0.85rem;
                                            font-weight: 500;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                        "
                                        onmouseover="this.style.background='linear-gradient(135deg, #004499, #003366)'" 
                                        onmouseout="this.style.background='linear-gradient(135deg, #0066cc, #004499)'"
                                    >
                                        <i class="fas fa-play" style="margin-right: 0.5rem;"></i>
                                        Start Course
                                    </button>
                                </div>
                            ` : status === 'overdue' ? `
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <span style="color: #dc3545; font-size: 0.85rem; font-style: italic;">
                                        <i class="fas fa-lock" style="margin-right: 0.5rem;"></i>
                                        Course access expired
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            startCourse(courseId) {
                // Open in-profile course player modal
                this.openCoursePlayer(courseId);
            }

            // Shared function to generate certificate HTML for both preview and download
            async generateCertificateHTML(course, assignment, userName, courseId, assignmentId, companyId, isForDownload = false) {
                // Fetch certificate template for this course (if exists)
                const certTemplatesSnap = await firebase.database().ref(`companies/${companyId}/lms/certificateTemplates`).once('value');
                const templates = certTemplatesSnap.val() || {};
                
                // Find template assigned to this course or use first template or default
                let template = null;
                Object.values(templates).forEach(t => {
                    if(t.courseId === courseId) template = t;
                });
                if(!template && Object.keys(templates).length > 0) {
                    template = Object.values(templates)[0];
                }
                
                // Generate certificate HTML
                const completedDate = assignment?.completedAt ? new Date(assignment.completedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const certId = `CERT-${courseId.substring(0,6).toUpperCase()}-${assignmentId.substring(0,6).toUpperCase()}`;
                
                // Template settings (use defaults if no template)
                const bgColor1 = template?.bgColor1 || '#1e3a5f';
                const bgColor2 = template?.bgColor2 || '#2d5a87';
                const borderColor = template?.borderColor || '#c9a227';
                const titleColor = template?.titleColor || '#1e3a5f';
                const courseColor = template?.courseColor || '#1e3a5f';
                const titleFont = template?.titleFont || 'Georgia';
                const courseFont = template?.courseFont || 'Georgia';
                const certTitle = template?.title || 'Certificate of Completion';
                const subtitle = template?.subtitle || 'This is to certify that';
                const sig1Name = template?.sig1Name || '';
                const sig1Title = template?.sig1Title || '';
                const sig2Name = template?.sig2Name || '';
                const sig2Title = template?.sig2Title || '';
                const showDate = template?.showDate !== false;
                const showCertId = template?.showCertId !== false;
                const showSeal = template?.showSeal !== false;
                const logoUrl = template?.logoUrl || '';
                const logoSize = template?.logoSize || 80;
                
                // Adjust dimensions for download vs preview
                const width = isForDownload ? 1056 : 792;
                const height = isForDownload ? 816 : 612;
                const scale = isForDownload ? 1 : 0.85;
                const borderInset = isForDownload ? 15 : 12;
                const borderInset2 = isForDownload ? 25 : 20;
                const cornerSize = isForDownload ? 28 : 22;
                const topOffset = isForDownload ? 50 : 40;
                const contentPadding = isForDownload ? '50px 40px 40px' : '50px 30px 30px';
                const logoSizeAdjusted = isForDownload ? logoSize : logoSize * 0.75;
                
                return `
                    <div style="
                        width: ${width}px;
                        height: ${height}px;
                        background: linear-gradient(135deg, ${bgColor1}, ${bgColor2});
                        position: relative;
                        font-family: ${titleFont}, serif;
                        color: #333;
                        overflow: hidden;
                        border-radius: 4px;
                        ${isForDownload ? '' : 'box-shadow: 0 8px 30px rgba(0,0,0,0.3); transform: scale(' + scale + '); transform-origin: top center;'}
                    ">
                        <!-- Decorative border -->
                        <div style="position: absolute; inset: ${borderInset}px; border: 3px solid ${borderColor}; border-radius: 4px;"></div>
                        <div style="position: absolute; inset: ${borderInset2}px; border: 1px solid ${borderColor}; border-radius: 4px;"></div>
                        
                        <!-- Corner ornaments -->
                        <div style="position:absolute; top:${borderInset2 + 8}px; left:${borderInset2 + 8}px; font-size:${cornerSize}px; color:${borderColor};"></div>
                        <div style="position:absolute; top:${borderInset2 + 8}px; right:${borderInset2 + 8}px; font-size:${cornerSize}px; color:${borderColor};"></div>
                        <div style="position:absolute; bottom:${borderInset2 + 8}px; left:${borderInset2 + 8}px; font-size:${cornerSize}px; color:${borderColor};"></div>
                        <div style="position:absolute; bottom:${borderInset2 + 8}px; right:${borderInset2 + 8}px; font-size:${cornerSize}px; color:${borderColor};"></div>
                        
                        ${logoUrl ? `<img src="${logoUrl}" style="position:absolute; top:${topOffset}px; left:50%; transform:translateX(-50%); width:${logoSizeAdjusted}px; height:auto; object-fit:contain;">` : ''}
                        
                        <!-- Content area -->
                        <div style="position: absolute; inset: ${topOffset + 10}px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: ${logoUrl ? contentPadding : '30px'};">
                            <h1 style="font-size: 32px; font-weight: 700; color: ${titleColor}; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 3px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${certTitle}</h1>
                            
                            <div style="width:150px; height:2px; background:linear-gradient(90deg, transparent, ${borderColor}, transparent); margin:12px 0;"></div>
                            
                            <p style="font-size:14px; color:#555; margin:15px 0 8px; font-style:italic;">${subtitle}</p>
                            
                            <h2 style="font-size: 28px; font-weight: 600; color: ${courseColor}; margin: 8px 0 20px 0; font-family: ${courseFont}, serif;">${userName}</h2>
                            
                            <p style="font-size:13px; color:#555; margin:0 0 8px;">has successfully completed the course</p>
                            
                            <h3 style="font-size: 22px; font-weight: 600; color: ${titleColor}; margin: 8px 0 24px 0; font-family: ${courseFont}, serif;">${course.title || 'Untitled Course'}</h3>
                            
                            <div style="display:flex; gap:50px; margin-top:15px;">
                                ${showDate ? `<div style="text-align:center;">
                                    <p style="font-size:10px; color:#777; margin:0 0 4px; text-transform:uppercase; letter-spacing:1px;">Date of Completion</p>
                                    <p style="font-size:13px; color:#333; margin:0; font-weight:500;">${completedDate}</p>
                                </div>` : ''}
                                ${showCertId ? `<div style="text-align:center;">
                                    <p style="font-size:10px; color:#777; margin:0 0 4px; text-transform:uppercase; letter-spacing:1px;">Certificate ID</p>
                                    <p style="font-size:13px; color:#333; margin:0; font-weight:500;">${certId}</p>
                                </div>` : ''}
                            </div>
                            
                            <div style="display:flex; gap:80px; margin-top:30px;">
                                ${sig1Name ? `<div style="text-align:center;">
                                    <div style="width:140px; border-top:2px solid #333; margin-bottom:6px;"></div>
                                    <p style="font-size:13px; color:#333; margin:0; font-weight:600;">${sig1Name}</p>
                                    <p style="font-size:10px; color:#666; margin:3px 0 0;">${sig1Title}</p>
                                </div>` : ''}
                                ${sig2Name ? `<div style="text-align:center;">
                                    <div style="width:140px; border-top:2px solid #333; margin-bottom:6px;"></div>
                                    <p style="font-size:13px; color:#333; margin:0; font-weight:600;">${sig2Name}</p>
                                    <p style="font-size:10px; color:#666; margin:3px 0 0;">${sig2Title}</p>
                                </div>` : ''}
                            </div>
                        </div>
                        
                        ${showSeal ? `<div style="
                            position: absolute;
                            bottom: ${topOffset + 5}px;
                            right: ${topOffset + 20}px;
                            width: 75px;
                            height: 75px;
                            border: 3px solid ${borderColor};
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: rgba(255,255,255,0.9);
                        ">
                            <div style="
                                width: 60px;
                                height: 60px;
                                border: 2px solid ${borderColor};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 9px;
                                font-weight: 700;
                                color: ${borderColor};
                                text-align: center;
                                text-transform: uppercase;
                            ">Official<br>Seal</div>
                        </div>` : ''}
                    </div>
                `;
            }

            async downloadCertificate(courseId, assignmentId) {
                try {
                    const { companyId, userId } = await resolveCompanyContext();
                    
                    // Fetch course details
                    const courseSnap = await firebase.database().ref(`companies/${companyId}/lms/courses/${courseId}`).once('value');
                    if(!courseSnap.exists()) throw new Error('Course not found');
                    const course = courseSnap.val();
                    
                    // Fetch assignment details
                    const assignSnap = await firebase.database().ref(`companies/${companyId}/lms/assignments/${assignmentId}`).once('value');
                    const assignment = assignSnap.val();
                    
                    // Check if course is completed (status = completed OR progress >= 100)
                    const isCompleted = assignment && (assignment.status === 'completed' || Number(assignment.progress || 0) >= 100);
                    if(!isCompleted) {
                        alert('This course is not completed yet. Please complete the course to download the certificate.');
                        return;
                    }
                    
                    // Fetch user details (try employees first, then users)
                    let user = {};
                    const empSnap = await firebase.database().ref(`companies/${companyId}/employees/${userId}`).once('value');
                    if(empSnap.exists()) {
                        user = empSnap.val();
                    } else {
                        const userSnap = await firebase.database().ref(`users/${userId}`).once('value');
                        user = userSnap.val() || {};
                    }
                    const userName = user.name || user.displayName || user.email || 'Student';
                    
                    // Fetch certificate template for this course (if exists)
                    const certTemplatesSnap = await firebase.database().ref(`companies/${companyId}/lms/certificateTemplates`).once('value');
                    const templates = certTemplatesSnap.val() || {};
                    
                    // Find template assigned to this course or use first template or default
                    let template = null;
                    Object.values(templates).forEach(t => {
                        if(t.courseId === courseId) template = t;
                    });
                    if(!template && Object.keys(templates).length > 0) {
                        template = Object.values(templates)[0];
                    }
                    
                    // Generate certificate HTML
                    const completedDate = assignment.completedAt ? new Date(assignment.completedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const certId = `CERT-${courseId.substring(0,6).toUpperCase()}-${assignmentId.substring(0,6).toUpperCase()}`;
                    
                    // Template settings (use defaults if no template)
                    const bgColor1 = template?.bgColor1 || '#1e3a5f';
                    const bgColor2 = template?.bgColor2 || '#2d5a87';
                    const borderColor = template?.borderColor || '#c9a227';
                    const titleColor = template?.titleColor || '#1e3a5f';
                    const courseColor = template?.courseColor || '#1e3a5f';
                    const titleFont = template?.titleFont || 'Georgia';
                    const courseFont = template?.courseFont || 'Georgia';
                    const certTitle = template?.title || 'Certificate of Completion';
                    const subtitle = template?.subtitle || 'This is to certify that';
                    const sig1Name = template?.sig1Name || '';
                    const sig1Title = template?.sig1Title || '';
                    const sig2Name = template?.sig2Name || '';
                    const sig2Title = template?.sig2Title || '';
                    const showDate = template?.showDate !== false;
                    const showCertId = template?.showCertId !== false;
                    const showSeal = template?.showSeal !== false;
                    const logoUrl = template?.logoUrl || '';
                    const logoSize = template?.logoSize || 80;
                    
                    // Create certificate content
                    const certHtml = `
                        <div id="certificateContent" style="
                            width: 1056px;
                            height: 816px;
                            background: linear-gradient(135deg, ${bgColor1}, ${bgColor2});
                            position: relative;
                            font-family: ${titleFont}, serif;
                            color: #333;
                            overflow: hidden;
                        ">
                            <!-- Decorative border -->
                            <div style="
                                position: absolute;
                                inset: 15px;
                                border: 3px solid ${borderColor};
                                border-radius: 4px;
                            "></div>
                            <div style="
                                position: absolute;
                                inset: 25px;
                                border: 1px solid ${borderColor};
                                border-radius: 4px;
                            "></div>
                            
                            <!-- Corner ornaments -->
                            <div style="position:absolute; top:35px; left:35px; font-size:28px; color:${borderColor};"></div>
                            <div style="position:absolute; top:35px; right:35px; font-size:28px; color:${borderColor};"></div>
                            <div style="position:absolute; bottom:35px; left:35px; font-size:28px; color:${borderColor};"></div>
                            <div style="position:absolute; bottom:35px; right:35px; font-size:28px; color:${borderColor};"></div>
                            
                            <!-- Logo -->
                            ${logoUrl ? `<img src="${logoUrl}" style="position:absolute; top:50px; left:50%; transform:translateX(-50%); width:${logoSize}px; height:auto; object-fit:contain;">` : ''}
                            
                            <!-- Content area -->
                            <div style="
                                position: absolute;
                                inset: 60px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                text-align: center;
                                padding: ${logoUrl ? '60px 40px 40px' : '40px'};
                            ">
                                <!-- Title -->
                                <h1 style="
                                    font-size: 42px;
                                    font-weight: 700;
                                    color: ${titleColor};
                                    margin: 0 0 10px 0;
                                    text-transform: uppercase;
                                    letter-spacing: 4px;
                                    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                                ">${certTitle}</h1>
                                
                                <!-- Decorative line -->
                                <div style="width:200px; height:2px; background:linear-gradient(90deg, transparent, ${borderColor}, transparent); margin:15px 0;"></div>
                                
                                <!-- Subtitle -->
                                <p style="font-size:18px; color:#555; margin:20px 0 10px; font-style:italic;">${subtitle}</p>
                                
                                <!-- Student Name -->
                                <h2 style="
                                    font-size: 36px;
                                    font-weight: 600;
                                    color: ${courseColor};
                                    margin: 10px 0 25px 0;
                                    font-family: ${courseFont}, serif;
                                ">${userName}</h2>
                                
                                <!-- Has successfully completed -->
                                <p style="font-size:16px; color:#555; margin:0 0 10px;">has successfully completed the course</p>
                                
                                <!-- Course Title -->
                                <h3 style="
                                    font-size: 28px;
                                    font-weight: 600;
                                    color: ${titleColor};
                                    margin: 10px 0 30px 0;
                                    font-family: ${courseFont}, serif;
                                ">${course.title || 'Untitled Course'}</h3>
                                
                                <!-- Date and Certificate ID -->
                                <div style="display:flex; gap:60px; margin-top:20px;">
                                    ${showDate ? `<div style="text-align:center;">
                                        <p style="font-size:12px; color:#777; margin:0 0 5px; text-transform:uppercase; letter-spacing:1px;">Date of Completion</p>
                                        <p style="font-size:16px; color:#333; margin:0; font-weight:500;">${completedDate}</p>
                                    </div>` : ''}
                                    ${showCertId ? `<div style="text-align:center;">
                                        <p style="font-size:12px; color:#777; margin:0 0 5px; text-transform:uppercase; letter-spacing:1px;">Certificate ID</p>
                                        <p style="font-size:16px; color:#333; margin:0; font-weight:500;">${certId}</p>
                                    </div>` : ''}
                                </div>
                                
                                <!-- Signatures -->
                                <div style="display:flex; gap:120px; margin-top:40px;">
                                    ${sig1Name ? `<div style="text-align:center;">
                                        <div style="width:180px; border-top:2px solid #333; margin-bottom:8px;"></div>
                                        <p style="font-size:16px; color:#333; margin:0; font-weight:600;">${sig1Name}</p>
                                        <p style="font-size:12px; color:#666; margin:4px 0 0;">${sig1Title}</p>
                                    </div>` : ''}
                                    ${sig2Name ? `<div style="text-align:center;">
                                        <div style="width:180px; border-top:2px solid #333; margin-bottom:8px;"></div>
                                        <p style="font-size:16px; color:#333; margin:0; font-weight:600;">${sig2Name}</p>
                                        <p style="font-size:12px; color:#666; margin:4px 0 0;">${sig2Title}</p>
                                    </div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Seal -->
                            ${showSeal ? `<div style="
                                position: absolute;
                                bottom: 60px;
                                right: 80px;
                                width: 100px;
                                height: 100px;
                                border: 3px solid ${borderColor};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: rgba(255,255,255,0.9);
                            ">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    border: 2px solid ${borderColor};
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 11px;
                                    font-weight: 700;
                                    color: ${borderColor};
                                    text-align: center;
                                    text-transform: uppercase;
                                ">Official<br>Seal</div>
                            </div>` : ''}
                        </div>
                    `;
                    
                    // Create temporary container for rendering
                    const container = document.createElement('div');
                    container.style.cssText = 'position:fixed; left:-9999px; top:0;';
                    container.innerHTML = certHtml;
                    document.body.appendChild(container);
                    
                    // Use html2canvas and jsPDF to generate PDF
                    const certElement = container.querySelector('#certificateContent');
                    
                    const canvas = await html2canvas(certElement, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: null
                    });
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'px',
                        format: [1056, 816]
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 0, 0, 1056, 816);
                    
                    // Download the PDF
                    const fileName = `Certificate_${course.title?.replace(/[^a-zA-Z0-9]/g, '_') || 'Course'}_${userName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                    pdf.save(fileName);
                    
                    // Cleanup
                    document.body.removeChild(container);
                    
                } catch(error) {
                    console.error('Error generating certificate:', error);
                    alert('Failed to generate certificate. Please try again.');
                }
            }

            async viewCertificate(courseId, assignmentId) {
                try {
                    const { companyId, userId } = await resolveCompanyContext();
                    
                    // Fetch course details
                    const courseSnap = await firebase.database().ref(`companies/${companyId}/lms/courses/${courseId}`).once('value');
                    if(!courseSnap.exists()) throw new Error('Course not found');
                    const course = courseSnap.val();
                    
                    // Fetch assignment details
                    const assignSnap = await firebase.database().ref(`companies/${companyId}/lms/assignments/${assignmentId}`).once('value');
                    const assignment = assignSnap.val();
                    
                    // Fetch user details (try employees first, then users)
                    let user = {};
                    const empSnap = await firebase.database().ref(`companies/${companyId}/employees/${userId}`).once('value');
                    if(empSnap.exists()) {
                        user = empSnap.val();
                    } else {
                        const userSnap = await firebase.database().ref(`users/${userId}`).once('value');
                        user = userSnap.val() || {};
                    }
                    const userName = user.name || user.displayName || user.email || 'Student';
                    
                    // Get certificate HTML using shared function
                    const certHtml = await this.generateCertificateHTML(course, assignment, userName, courseId, assignmentId, companyId, false);
                    
                    // Create preview modal
                    const existingModal = document.getElementById('certificatePreviewModal');
                    if (existingModal) existingModal.remove();
                    
                    const modalHtml = `
                        <div id="certificatePreviewModal" style="
                            display: flex;
                            position: fixed;
                            inset: 0;
                            background: rgba(0,0,0,0.8);
                            z-index: 3000;
                            align-items: center;
                            justify-content: center;
                            padding: 1rem;
                        ">
                            <div style="
                                background: #1f2937;
                                border-radius: 12px;
                                max-width: 95vw;
                                max-height: 95vh;
                                overflow: auto;
                                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                            ">
                                <div style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    padding: 1rem 1.5rem;
                                    border-bottom: 1px solid #374151;
                                ">
                                    <h3 style="margin: 0; color: #f9fafb; font-size: 1.1rem; display: flex; align-items: center; gap: .5rem;">
                                        <i class="fas fa-certificate" style="color: #f59e0b;"></i>
                                        Certificate Preview
                                    </h3>
                                    <div style="display: flex; gap: .5rem;">
                                        <button onclick="profileManager.downloadCertificate('${courseId}', '${assignmentId}')" style="
                                            background: linear-gradient(135deg, #f59e0b, #d97706);
                                            color: white;
                                            border: none;
                                            padding: .5rem 1rem;
                                            border-radius: 6px;
                                            font-size: .85rem;
                                            cursor: pointer;
                                            display: flex;
                                            align-items: center;
                                            gap: .5rem;
                                        "><i class="fas fa-download"></i> Download PDF</button>
                                        <button onclick="document.getElementById('certificatePreviewModal').remove()" style="
                                            background: transparent;
                                            color: #9ca3af;
                                            border: 1px solid #4b5563;
                                            padding: .5rem 1rem;
                                            border-radius: 6px;
                                            font-size: .85rem;
                                            cursor: pointer;
                                        "><i class="fas fa-times"></i> Close</button>
                                    </div>
                                </div>
                                <div style="padding: 1.5rem; display: flex; justify-content: center;">
                                    ${certHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Close on backdrop click
                    document.getElementById('certificatePreviewModal').addEventListener('click', (e) => {
                        if (e.target.id === 'certificatePreviewModal') {
                            document.getElementById('certificatePreviewModal').remove();
                        }
                    });
                    
                } catch(error) {
                    console.error('Error previewing certificate:', error);
                    alert('Failed to preview certificate. Please try again.');
                }
            }

            async openCoursePlayer(courseId) {
                try {
                    const { companyId, userId } = await resolveCompanyContext();
                    // Fetch course details
                    const courseSnap = await firebase.database().ref(`companies/${companyId}/lms/courses/${courseId}`).once('value');
                    if(!courseSnap.exists()) throw new Error('Course not found');
                    const course = courseSnap.val();

                    // Fetch current assignment for user and this course (for progress)
                    const assignmentsSnap = await firebase.database().ref(`companies/${companyId}/lms/assignments`).orderByChild('courseId').equalTo(courseId).once('value');
                    const assignmentsVal = assignmentsSnap.val() || {};
                    let myAssignment = null;
                    Object.entries(assignmentsVal).forEach(([key, val]) => {
                        if (val && val.employeeId === userId) {
                            myAssignment = { id: key, ...val };
                        }
                    });
                    const progress = Number(myAssignment?.progress || 0);

                    // Build modal content
                    const modal = document.getElementById('coursePlayerModal');
                    const body = document.getElementById('coursePlayerBody');
                    const titleEl = document.getElementById('coursePlayerTitle');
                    if(!modal || !body || !titleEl) return;

                    titleEl.textContent = course.title || 'Course';

                    const modules = Array.isArray(course.content) ? course.content : [];
                    // cache course context for item playback
                    // Load completed lessons from assignment progress data
                    const completedLessons = new Set();
                    if (myAssignment && myAssignment.completedLessons) {
                        myAssignment.completedLessons.forEach(idx => completedLessons.add(idx));
                    }
                    this._currentCourseCtx = { companyId, userId, courseId, course, assignment: myAssignment, modules, currentStep: 0, completedLessons };
                    
                    // Build flat list of all items for step navigation
                    const allItems = [];
                    modules.forEach((m, mi) => {
                        const items = Array.isArray(m.items) ? m.items : [];
                        items.forEach((it, ii) => {
                            allItems.push({
                                moduleIndex: mi,
                                itemIndex: ii,
                                moduleTitle: m.title || `Module ${mi + 1}`,
                                item: it
                            });
                        });
                    });
                    this._currentCourseCtx.allItems = allItems;
                    const totalItems = allItems.length;

                    const description = (course.description || course.summary || '').trim();
                    const objectives = Array.isArray(course.objectives) ? course.objectives : [];
                    const prerequisites = Array.isArray(course.prerequisites) ? course.prerequisites : [];
                    const audience = Array.isArray(course.audience) ? course.audience : [];
                    const tags = Array.isArray(course.tags) ? course.tags : (typeof course.tags === 'string' ? course.tags.split(',').map(t=>t.trim()).filter(Boolean) : []);

                    const metaCard = `
                        <div class="tab-card" style="margin-bottom:1rem;">
                            <div class="tab-card-header" style="display:flex; justify-content:space-between; align-items:center;">
                                <h4 class="tab-card-title" style="font-size:1rem;"><i class="fas fa-info-circle"></i> Course Details</h4>
                                ${course.level ? `<span style=\"font-size:.8rem; color:#6b7280;\">Level: ${course.level}</span>` : ''}
                            </div>
                            <div class="tab-card-body" style="display:grid; gap:.75rem;">
                                <div>
                                    <div style="font-weight:600; color:#111827; margin-bottom:.25rem;">Description</div>
                                    <div style="color:#111827; line-height:1.6;">${description || '<em style=\"color:#6b7280;\">No description provided</em>'}</div>
                                </div>
                                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:.75rem;">
                                    <div>
                                        <div style="font-weight:600; color:#111827; margin-bottom:.25rem;">Objectives</div>
                                        <ul style="margin:0; padding-left:1rem; color:#374151;">
                                            ${(objectives.length? objectives.map(o=>`<li>${o}</li>`).join('') : '<li style=\"color:#6b7280;\">No objectives</li>')}
                                        </ul>
                                    </div>
                                    <div>
                                        <div style="font-weight:600; color:#111827; margin-bottom:.25rem;">Prerequisites</div>
                                        <ul style="margin:0; padding-left:1rem; color:#374151;">
                                            ${(prerequisites.length? prerequisites.map(p=>`<li>${p}</li>`).join('') : '<li style=\"color:#6b7280;\">None</li>')}
                                        </ul>
                                    </div>
                                    <div>
                                        <div style="font-weight:600; color:#111827; margin-bottom:.25rem;">Audience</div>
                                        <ul style="margin:0; padding-left:1rem; color:#374151;">
                                            ${(audience.length? audience.map(a=>`<li>${a}</li>`).join('') : '<li style=\"color:#6b7280;\">General</li>')}
                                        </ul>
                                    </div>
                                </div>
                                ${tags.length? `<div style=\"display:flex; flex-wrap:wrap; gap:.4rem; align-items:center;\"><span style=\"font-weight:600; color:#111827;\">Tags:</span> ${tags.map(t=>`<span style=\"font-size:.75rem; background:#eef2ff; color:#3b82f6; border:1px solid #dbeafe; padding:.2rem .5rem; border-radius:999px;\">${t}</span>`).join('')}</div>` : ''}
                                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:.75rem;">
                                    ${course.duration ? `<div><div style=\"font-weight:600; color:#111827;\">Duration</div><div style=\"color:#374151;\">${course.duration} min</div></div>`:''}
                                    ${course.language ? `<div><div style=\"font-weight:600; color:#111827;\">Language</div><div style=\"color:#374151;\">${course.language}</div></div>`:''}
                                    ${course.category ? `<div><div style=\"font-weight:600; color:#111827;\">Category</div><div style=\"color:#374151;\">${course.category}</div></div>`:''}
                                </div>
                            </div>
                        </div>`;

                    const progressBar = `
                        <div style="padding:0 .75rem .75rem;">
                            <div style="display:flex; justify-content:space-between; font-size:.75rem; color:#6b7280; margin-bottom:.25rem;">
                                <span>Progress</span><span id="courseProgressText">${progress}%</span>
                            </div>
                            <div style="height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden;">
                                <div id="courseProgressBar" style="height:6px; width:${progress}%; background:#3b82f6; transition: width 0.3s ease;"></div>
                            </div>
                        </div>`;

                    // Build sidebar lesson list
                    const sidebarLessons = modules.map((m, mi) => {
                        const items = Array.isArray(m.items) ? m.items : [];
                        const itemsHtml = items.map((it, ii) => {
                            const globalIdx = allItems.findIndex(a => a.moduleIndex === mi && a.itemIndex === ii);
                            const type = (it.type || 'content').toLowerCase();
                            const icon = type === 'exam' ? 'fa-clipboard-question' : type === 'quiz' ? 'fa-question-circle' : type === 'video' ? 'fa-video' : type === 'pdf' ? 'fa-file-pdf' : 'fa-file-alt';
                            return `
                                <div id="sidebarLesson_${globalIdx}" class="sidebar-lesson-item" onclick="profileManager.goToStep(${globalIdx})" 
                                     style="padding:.5rem .75rem; margin:0 .5rem .25rem; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:.5rem; font-size:.85rem; color:#374151; transition:all 0.15s; background:#fff; border:1px solid transparent;">
                                    <span id="lessonCheck_${globalIdx}" style="display:none; color:#10b981; font-size:.75rem;"><i class="fas fa-check-circle"></i></span>
                                    <i class="fas ${icon} lesson-type-icon" style="color:#6b7280; width:16px; text-align:center;"></i>
                                    <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${it.title || 'Lesson ' + (ii + 1)}</span>
                                    ${it.duration ? `<span style="font-size:.7rem; color:#9ca3af;">${it.duration}m</span>` : ''}
                                </div>
                            `;
                        }).join('');
                        
                        return `
                            <div style="margin-bottom:.5rem;">
                                <div style="padding:.5rem .75rem; font-weight:600; color:#111827; font-size:.8rem; display:flex; align-items:center; gap:.5rem; background:#f1f5f9;">
                                    <i class="fas fa-folder" style="color:#3b82f6;"></i>
                                    <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.title || 'Module ' + (mi + 1)}</span>
                                    <span style="font-size:.7rem; color:#6b7280; background:#e2e8f0; padding:.1rem .4rem; border-radius:10px;">${items.length}</span>
                                </div>
                                ${itemsHtml}
                            </div>
                        `;
                    }).join('');

                    // Lesson content area (right side)
                    const lessonContent = `
                        <div id="lessonContentArea" style="height:100%; display:flex; flex-direction:column;">
                            <div style="padding:.75rem 1rem; border-bottom:1px solid #e5e7eb; background:#fff; display:flex; justify-content:space-between; align-items:center;">
                                <h4 id="lessonTitle" style="margin:0; font-size:1rem; font-weight:600; color:#111827; display:flex; align-items:center; gap:.5rem;">
                                    <i class="fas fa-book-open"></i> <span>Select a lesson</span>
                                </h4>
                                <span id="lessonModuleBadge" style="font-size:.75rem; padding:.25rem .5rem; background:#e0e7ff; color:#4f46e5; border-radius:4px;"></span>
                            </div>
                            <div id="lessonContentBody" style="flex:1; padding:1rem; overflow-y:auto;">
                                <div style="text-align:center; padding:3rem 1rem; color:#6b7280;">
                                    <i class="fas fa-graduation-cap" style="font-size:4rem; margin-bottom:1rem; color:#d1d5db;"></i>
                                    <h3 style="margin:0 0 .5rem; color:#374151;">Welcome to the Course!</h3>
                                    <p style="margin:0; font-size:.9rem;">Select a lesson from the sidebar to begin learning.</p>
                                </div>
                            </div>
                            <div style="padding:.75rem 1rem; border-top:1px solid #e5e7eb; background:#f8fafc; display:flex; justify-content:space-between; align-items:center; gap:.5rem;">
                                <button id="prevLessonBtn" class="btn-secondary" onclick="profileManager.prevStep()" style="display:flex; align-items:center; gap:.4rem; font-size:.85rem;" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <div style="display:flex; align-items:center; gap:.75rem;">
                                    <span id="stepIndicatorText" style="font-size:.8rem; color:#6b7280;">
                                        ${allItems.length} lessons
                                    </span>
                                    <button id="completeLessonBtn" class="btn-primary" onclick="profileManager.markLessonComplete()" style="display:none; align-items:center; gap:.4rem; font-size:.85rem; background:#10b981; border-color:#10b981;">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                    <button id="saveProgressBtn" class="btn-primary" onclick="profileManager.saveProgress()" style="display:flex; align-items:center; gap:.4rem; font-size:.85rem; background:#f59e0b; border-color:#f59e0b;">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                </div>
                                <button id="nextLessonBtn" class="btn-primary" onclick="profileManager.nextStep()" style="display:flex; align-items:center; gap:.4rem; font-size:.85rem;" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    const commentsHtml = `
                        <div style="border-top:1px solid #e5e7eb; padding:.75rem;">
                            <div style="font-weight:600; color:#111827; font-size:.85rem; margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem;">
                                <i class="fas fa-comments" style="color:#3b82f6;"></i> Comments
                            </div>
                            <div id="courseCommentsList" style="max-height:120px; overflow-y:auto; margin-bottom:.5rem;"></div>
                            <div style="display:flex; gap:.5rem;">
                                <input id="courseCommentInput" type="text" class="form-control" placeholder="Write a comment" style="flex:1; height:32px; font-size:.85rem;">
                                <button id="courseCommentSend" class="btn-primary" type="button" style="height:32px; padding:0 .75rem; font-size:.8rem;"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>`;

                    body.innerHTML = `
                        <div style="display:grid; grid-template-columns:280px 1fr; height:70vh; max-height:600px; gap:0; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; background:#fff;">
                            <!-- Left Sidebar -->
                            <div style="background:#f8fafc; border-right:1px solid #e5e7eb; display:flex; flex-direction:column; overflow:hidden;">
                                <div style="padding:.75rem; border-bottom:1px solid #e5e7eb; background:#fff;">
                                    <div style="font-weight:600; color:#111827; font-size:.9rem; margin-bottom:.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${course.title || 'Course'}">
                                        ${course.title || 'Course'}
                                    </div>
                                    <div style="font-size:.75rem; color:#6b7280;">${totalItems} lessons  ${modules.length} modules</div>
                                </div>
                                ${progressBar}
                                <div style="flex:1; overflow-y:auto;">
                                    ${sidebarLessons || '<div style="padding:1rem; color:#6b7280; text-align:center;">No lessons available</div>'}
                                </div>
                                ${commentsHtml}
                            </div>
                            <!-- Right Content Area -->
                            <div style="display:flex; flex-direction:column; overflow:hidden; background:#fff;">
                                ${lessonContent}
                            </div>
                        </div>`;

                    // Add hover styles for sidebar items
                    setTimeout(() => {
                        document.querySelectorAll('.sidebar-lesson-item').forEach(item => {
                            item.addEventListener('mouseenter', function() {
                                if (!this.classList.contains('active')) {
                                    this.style.background = '#f1f5f9';
                                    this.style.borderColor = '#e2e8f0';
                                }
                            });
                            item.addEventListener('mouseleave', function() {
                                if (!this.classList.contains('active')) {
                                    this.style.background = '#fff';
                                    this.style.borderColor = 'transparent';
                                }
                            });
                        });
                        
                        // Show checkmarks for already completed lessons
                        if (completedLessons.size > 0) {
                            completedLessons.forEach(completedIdx => {
                                const checkEl = document.getElementById(`lessonCheck_${completedIdx}`);
                                if (checkEl) checkEl.style.display = 'inline';
                            });
                        }
                    }, 100);

                    // Load comments (simple path under assignments/<id>/comments)
                    if(myAssignment && myAssignment.id){
                        const listEl = document.getElementById('courseCommentsList');
                        const sendBtn = document.getElementById('courseCommentSend');
                        const inputEl = document.getElementById('courseCommentInput');
                        const commentsRef = firebase.database().ref(`companies/${companyId}/lms/assignments/${myAssignment.id}/comments`);
                        commentsRef.on('value', (snap)=>{
                            const val = snap.val()||{}; const entries = Object.entries(val);
                            if(entries.length===0){ listEl.innerHTML = '<div style="color:#6b7280;">No comments yet.</div>'; return; }
                            entries.sort((a,b)=> (a[1].timestamp||0) - (b[1].timestamp||0));
                            listEl.innerHTML = entries.map(([cid,c])=> `
                                <div style="padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
                                    <div style="font-size:.85rem; color:#111827;">${c.text||''}</div>
                                    <small style="color:#6b7280;">${new Date(c.timestamp||Date.now()).toLocaleString()}</small>
                                </div>`).join('');
                        });
                        if(sendBtn){
                            sendBtn.onclick = async ()=>{
                                const text = (inputEl?.value||'').trim(); if(!text) return;
                                const key = firebase.database().ref().push().key;
                                await commentsRef.child(key).set({ text, userId, timestamp: firebase.database.ServerValue.TIMESTAMP });
                                inputEl.value='';
                            };
                        }
                    }

                    // Show modal
                    modal.style.display = 'flex';

                } catch(e){
                    console.error('Open course player failed', e);
                    alert(e.message||'Failed to open course');
                }
            }

            // Step navigation functions for tab-based course player
            goToStep(stepIndex) {
                const ctx = this._currentCourseCtx;
                if (!ctx || !ctx.allItems || stepIndex < 0 || stepIndex >= ctx.allItems.length) return;
                // Prevent jumping forward if previous step not completed
                const prevIndex = stepIndex - 1;
                if (prevIndex >= 0) {
                    const prevCompleted = ctx.completedLessons && ctx.completedLessons.has(prevIndex);
                    if (!prevCompleted) {
                        showToast('Please complete the previous lesson first.', 'warning');
                        return;
                    }
                }
                
                ctx.currentStep = stepIndex;
                const stepData = ctx.allItems[stepIndex];
                const item = stepData.item;
                
                // Update sidebar lesson items
                document.querySelectorAll('.sidebar-lesson-item').forEach((el, idx) => {
                    if (idx === stepIndex) {
                        el.style.background = '#3b82f6';
                        el.style.color = '#fff';
                        el.style.borderColor = '#3b82f6';
                        el.classList.add('active');
                        el.querySelector('i').style.color = '#fff';
                        // Scroll into view
                        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        el.style.background = '#fff';
                        el.style.color = '#374151';
                        el.style.borderColor = 'transparent';
                        el.classList.remove('active');
                        el.querySelector('i').style.color = '#6b7280';
                    }
                });
                
                // Update step indicator text
                const indicatorText = document.getElementById('stepIndicatorText');
                if (indicatorText) {
                    indicatorText.textContent = `Lesson ${stepIndex + 1} of ${ctx.allItems.length}`;
                }
                
                // Update navigation buttons
                const prevBtn = document.getElementById('prevLessonBtn');
                const nextBtn = document.getElementById('nextLessonBtn');
                
                if (prevBtn) {
                    prevBtn.disabled = stepIndex === 0;
                    prevBtn.style.opacity = stepIndex === 0 ? '0.5' : '1';
                }
                if (nextBtn) {
                    const isLast = stepIndex >= ctx.allItems.length - 1;
                    const canAdvance = !isLast && ctx.completedLessons && ctx.completedLessons.has(stepIndex);
                    nextBtn.disabled = !canAdvance;
                    nextBtn.style.opacity = !canAdvance ? '0.5' : '1';
                }
                
                // Update lesson title and module badge
                const lessonTitle = document.getElementById('lessonTitle');
                const moduleBadge = document.getElementById('lessonModuleBadge');
                const type = (item.type || 'content').toLowerCase();
                const icon = type === 'exam' ? 'fa-clipboard-question' : type === 'quiz' ? 'fa-question-circle' : type === 'video' ? 'fa-video' : type === 'pdf' ? 'fa-file-pdf' : 'fa-file-alt';
                
                if (lessonTitle) {
                    lessonTitle.innerHTML = `<i class="fas ${icon}"></i> <span>${item.title || 'Lesson ' + (stepIndex + 1)}</span>`;
                }
                if (moduleBadge) {
                    moduleBadge.textContent = stepData.moduleTitle;
                }
                
                // Show/hide Complete button based on lesson completion status
                const completeBtn = document.getElementById('completeLessonBtn');
                if (completeBtn) {
                    const isCompleted = ctx.completedLessons && ctx.completedLessons.has(stepIndex);
                    completeBtn.style.display = isCompleted ? 'none' : 'flex';
                }
                
                // Update checkmarks in sidebar for all completed lessons
                ctx.completedLessons && ctx.completedLessons.forEach(completedIdx => {
                    const checkEl = document.getElementById(`lessonCheck_${completedIdx}`);
                    if (checkEl) checkEl.style.display = 'inline';
                });
                
                // Render lesson content
                this.renderLessonContent(stepData, ctx.courseId);
            }
            
            // Mark current lesson as complete
            async markLessonComplete() {
                const ctx = this._currentCourseCtx;
                if (!ctx) return;
                
                const stepIndex = ctx.currentStep;
                
                // Add to completed lessons set
                if (!ctx.completedLessons) ctx.completedLessons = new Set();
                ctx.completedLessons.add(stepIndex);
                
                // Update checkmark in sidebar
                const checkEl = document.getElementById(`lessonCheck_${stepIndex}`);
                if (checkEl) checkEl.style.display = 'inline';
                
                // Hide the complete button for this lesson
                const completeBtn = document.getElementById('completeLessonBtn');
                if (completeBtn) completeBtn.style.display = 'none';
                
                // Calculate progress percentage
                const totalLessons = ctx.allItems.length;
                const completedCount = ctx.completedLessons.size;
                const progressPercent = Math.round((completedCount / totalLessons) * 100);
                
                // Update progress bar if exists
                const progressBar = document.getElementById('courseProgressBar');
                const progressText = document.getElementById('courseProgressText');
                if (progressBar) progressBar.style.width = `${progressPercent}%`;
                if (progressText) progressText.textContent = `${progressPercent}%`;
                
                // Save to Firebase
                try {
                    if (ctx.assignment && ctx.assignment.id) {
                        const assignmentRef = firebase.database().ref(`companies/${ctx.companyId}/lms/assignments/${ctx.assignment.id}`);
                        await assignmentRef.update({
                            progress: progressPercent,
                            completedLessons: Array.from(ctx.completedLessons),
                            lastUpdated: Date.now()
                        });
                    }
                    // Show success feedback
                    showToast('Lesson completed!', 'success');
                    
                    // Auto-advance to next lesson after short delay if not last lesson
                    if (stepIndex < ctx.allItems.length - 1) {
                        setTimeout(() => this.goToStep(stepIndex + 1), 800);
                    }
                } catch (err) {
                    console.error('Failed to save progress:', err);
                    showToast('Failed to save progress', 'error');
                }
            }
            
            // Save progress manually
            async saveProgress() {
                const ctx = this._currentCourseCtx;
                if (!ctx) {
                    showToast('No course loaded', 'error');
                    return;
                }
                
                const saveBtn = document.getElementById('saveProgressBtn');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                }
                
                try {
                    // Calculate progress percentage
                    const totalLessons = ctx.allItems ? ctx.allItems.length : 0;
                    const completedCount = ctx.completedLessons ? ctx.completedLessons.size : 0;
                    const progressPercent = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
                    
                    if (ctx.assignment && ctx.assignment.id) {
                        const assignmentRef = firebase.database().ref(`companies/${ctx.companyId}/lms/assignments/${ctx.assignment.id}`);
                        await assignmentRef.update({
                            progress: progressPercent,
                            completedLessons: Array.from(ctx.completedLessons || []),
                            currentStep: ctx.currentStep || 0,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        });
                        showToast('Progress saved successfully!', 'success');
                    } else {
                        showToast('No assignment found to save', 'warning');
                    }
                } catch (err) {
                    console.error('Failed to save progress:', err);
                    showToast('Failed to save progress', 'error');
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                    }
                }
            }
            
            nextStep() {
                const ctx = this._currentCourseCtx;
                if (!ctx || ctx.currentStep >= ctx.allItems.length - 1) return;
                // Require current lesson completion before advancing
                const currentCompleted = ctx.completedLessons && ctx.completedLessons.has(ctx.currentStep);
                if (!currentCompleted) {
                    showToast('Complete the current lesson to continue.', 'warning');
                    return;
                }
                this.goToStep(ctx.currentStep + 1);
            }
            
            prevStep() {
                const ctx = this._currentCourseCtx;
                if (!ctx || ctx.currentStep <= 0) return;
                this.goToStep(ctx.currentStep - 1);
            }
            
            renderLessonContent(stepData, courseId) {
                const contentBody = document.getElementById('lessonContentBody');
                if (!contentBody) return;
                
                const item = stepData.item;
                const moduleIndex = stepData.moduleIndex;
                const itemIndex = stepData.itemIndex;
                const type = (item.type || 'content').toLowerCase();
                
                // Check if this is an exam
                if (type === 'exam') {
                    this.renderExamContent(contentBody, item, courseId, moduleIndex, itemIndex);
                    return;
                }
                
                // Render regular lesson content
                const notes = item.notes || item.remark || item.comments || '';
                const url = item.url || '';
                const attachments = Array.isArray(item.attachments) ? item.attachments : [];
                
                let contentHtml = '';
                
                // Video embed
                if (url && (url.includes('youtube') || url.includes('youtu.be') || url.includes('vimeo'))) {
                    let embedUrl = url;
                    if (url.includes('youtube.com/watch')) {
                        const videoId = new URL(url).searchParams.get('v');
                        embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    } else if (url.includes('youtu.be')) {
                        const videoId = url.split('/').pop();
                        embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    }
                    contentHtml += `
                        <div style="margin-bottom:1rem;">
                            <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px;">
                                <iframe src="${embedUrl}" style="position:absolute; top:0; left:0; width:100%; height:100%; border:none;" allowfullscreen></iframe>
                            </div>
                        </div>
                    `;
                } else if (url && (url.endsWith('.pdf'))) {
                    contentHtml += `
                        <div style="margin-bottom:1rem;">
                            <a href="${url}" target="_blank" class="btn-primary" style="display:inline-flex; align-items:center; gap:.5rem;">
                                <i class="fas fa-file-pdf"></i> Open PDF Document
                            </a>
                        </div>
                    `;
                } else if (url) {
                    contentHtml += `
                        <div style="margin-bottom:1rem;">
                            <a href="${url}" target="_blank" class="btn-secondary" style="display:inline-flex; align-items:center; gap:.5rem;">
                                <i class="fas fa-external-link-alt"></i> Open Resource
                            </a>
                        </div>
                    `;
                }
                
                // Notes section
                contentHtml += `
                    <div style="margin-bottom:1rem;">
                        <div style="font-weight:600; color:#111827; margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem;">
                            <i class="fas fa-note-sticky" style="color:#3b82f6;"></i> Lesson Notes
                        </div>
                        <div style="background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:1rem; line-height:1.6; color:#374151; min-height:150px; max-height:400px; overflow-y:auto;">
                            ${notes && notes.trim().length ? notes : '<em style="color:#6b7280;">No notes available for this lesson.</em>'}
                        </div>
                    </div>
                `;
                
                // Attachments
                if (attachments.length > 0) {
                    contentHtml += `
                        <div>
                            <div style="font-weight:600; color:#111827; margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem;">
                                <i class="fas fa-paperclip" style="color:#3b82f6;"></i> Attachments
                            </div>
                            <div style="display:grid; gap:.5rem;">
                                ${attachments.map((a, i) => {
                                    const name = a.name || `Attachment ${i + 1}`;
                                    const url = a.url || '';
                                    return `<a href="${url}" target="_blank" style="display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; background:#f8fafc; border:1px solid #e5e7eb; border-radius:6px; color:#3b82f6; text-decoration:none; font-size:.9rem;">
                                        <i class="fas fa-download"></i> ${name}
                                    </a>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                contentBody.innerHTML = contentHtml;
            }
            
            renderExamContent(contentBody, item, courseId, moduleIndex, itemIndex) {
                // Handle missing questions
                let questions = item.questions;
                if (!Array.isArray(questions) || questions.length === 0) {
                    questions = [{
                        text: "This is a sample question. Please contact your instructor to add proper exam questions.",
                        options: ["Option A", "Option B", "Option C", "Option D"],
                        answerIndex: 0
                    }];
                }
                
                const examId = `exam-${moduleIndex}-${itemIndex}`;
                const timeLimitMin = Number(item.timeLimit || item.duration || this._currentCourseCtx?.course?.duration || 0);
                const passMark = Number(item.passMark || 70);
                const attemptsAllowed = Number(item.attempts || 1);
                const totalQuestions = questions.length;
                const examData = {
                    questions: questions,
                    answers: {},
                    started: false,
                    startTime: null,
                    timeLimitMin: timeLimitMin,
                    submitted: false
                };
                
                this._examSessions = this._examSessions || {};
                this._examSessions[examId] = examData;
                
                const questionsHtml = questions.map((q, qi) => {
                    const optionsHtml = q.options.map((option, oi) => `
                        <label style="display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; transition:all 0.2s; background:#fff;" 
                               onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='#fff'">
                            <input type="radio" name="question_${examId}_${qi}" value="${oi}" style="margin:0;" onchange="profileManager.updateExamAnswer('${examId}', ${qi}, ${oi})">
                            <span style="font-size:.9rem; color:#374151;">${option}</span>
                        </label>
                    `).join('');
                    
                    return `
                        <div style="margin-bottom:1.25rem; padding:1rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
                            <div style="font-weight:600; color:#111827; margin-bottom:.75rem; font-size:.95rem;">Question ${qi + 1} of ${questions.length}</div>
                            <div style="color:#374151; margin-bottom:1rem; line-height:1.6; font-size:.95rem;">${q.text}</div>
                            <div style="display:grid; gap:.5rem;">
                                ${optionsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                contentBody.innerHTML = `
                    <div id="examInstructions_${examId}" style="background:#f0f9ff; border:1px solid #0ea5e9; border-radius:8px; padding:.75rem; margin-bottom:1rem;">
                        <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem;">
                            <i class="fas fa-info-circle" style="color:#0ea5e9;"></i>
                            <strong style="color:#0c4a6e; font-size:.9rem;">Exam Instructions</strong>
                        </div>
                        <ul style="margin:0; padding-left:1.2rem; color:#0c4a6e; font-size:.85rem; line-height:1.6;">
                            <li><strong>Total Questions:</strong> ${totalQuestions}</li>
                            ${timeLimitMin ? `<li><strong>Allocated Time:</strong> ${timeLimitMin} minutes</li>` : ''}
                            <li><strong>Passing Score:</strong> ${passMark}%</li>
                            <li><strong>Attempts Allowed:</strong> ${attemptsAllowed}</li>
                            <li>Read each question carefully and select the best answer.</li>
                            <li>You can change your answers before submitting.</li>
                            <li>Click "Submit Exam" when you're ready to finish.</li>
                        </ul>
                    </div>
                    <div id="examQuestions_${examId}" style="max-height:450px; overflow-y:auto; margin-bottom:1rem; display:none;">
                        ${questionsHtml}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:.75rem; background:#f8f9fa; border-radius:8px; border:1px solid #e5e7eb;">
                        <div style="color:#6b7280; font-size:.85rem; display:flex; align-items:center; gap:.5rem;">
                            <i class="fas fa-clock"></i> Time: <span id="examTimer_${examId}">00:00</span>
                            ${timeLimitMin ? `<span style="color:#374151; font-size:.8rem;">/ ${timeLimitMin} min</span>` : ''}
                        </div>
                        <div style="display:flex; gap:.5rem;">
                            <button id="startExamBtn_${examId}" class="btn-primary" style="padding:.5rem 1rem; background:#10b981; border-color:#10b981;" onclick="profileManager.beginExam('${examId}', '${courseId}', ${moduleIndex}, ${itemIndex})">
                                <i class="fas fa-play"></i> Start Exam
                            </button>
                            <button id="submitExamBtn_${examId}" class="btn-primary" style="padding:.5rem 1rem;" onclick="profileManager.submitExam('${examId}', '${courseId}', ${moduleIndex}, ${itemIndex})" disabled>
                                <i class="fas fa-check"></i> Submit Exam
                            </button>
                        </div>
                    </div>
                `;
                
                // Disable answering until started
                document.querySelectorAll(`[name^="question_${examId}_"]`).forEach(inp => { inp.disabled = true; });
            }

            async playCourseItem(courseId, moduleIndex, itemIndex){
                // Legacy function - redirect to new step-based system
                const ctx = this._currentCourseCtx;
                if(!ctx || ctx.courseId !== courseId) return;
                
                // Find the step index for this module/item
                const stepIndex = ctx.allItems?.findIndex(a => a.moduleIndex === moduleIndex && a.itemIndex === itemIndex);
                if (stepIndex >= 0) {
                    this.goToStep(stepIndex);
                }
            }

            showExamInterface(viewer, titleEl, notesEl, item, courseId, moduleIndex, itemIndex){
                titleEl.innerHTML = `<i class="fas fa-clipboard-question"></i> ${item.title || 'Exam'}`;
                
                // Handle missing questions by creating default ones or showing a message
                let questions = item.questions;
                if(!Array.isArray(questions) || questions.length === 0){
                    // Generate default questions if none exist
                    questions = [
                        {
                            text: "This is a sample question. Please contact your instructor to add proper exam questions.",
                            options: ["Option A", "Option B", "Option C", "Option D"],
                            answerIndex: 0
                        }
                    ];
                }
                
                // Create exam interface
                const examId = `exam-${moduleIndex}-${itemIndex}`;
                const timeLimitMin = Number(item.timeLimit || item.duration || this._currentCourseCtx?.course?.duration || 0);
                const passMark = Number(item.passMark || 70);
                const attemptsAllowed = Number(item.attempts || 1);
                const totalQuestions = questions.length;
                const examData = {
                    questions: questions,
                    answers: {},
                    started: false,
                    startTime: null,
                    timeLimitMin: timeLimitMin,
                    submitted: false
                };
                
                // Store exam data for this session
                this._examSessions = this._examSessions || {};
                this._examSessions[examId] = examData;
                
                const questionsHtml = questions.map((q, qi) => {
                    const optionsHtml = q.options.map((option, oi) => `
                        <label style="display:flex; align-items:center; gap:.5rem; padding:.4rem; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; transition:all 0.2s; background:#fff;" 
                               onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='#fff'">
                            <input type="radio" name="question_${examId}_${qi}" value="${oi}" style="margin:0;" onchange="profileManager.updateExamAnswer('${examId}', ${qi}, ${oi})">
                            <span style="font-size:.9rem; color:#374151;">${option}</span>
                        </label>
                    `).join('');
                    
                    return `
                        <div style="margin-bottom:1.5rem; padding:1rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
                            <div style="font-weight:600; color:#111827; margin-bottom:.75rem; font-size:.95rem;">Question ${qi + 1}</div>
                            <div style="color:#374151; margin-bottom:1rem; line-height:1.5; font-size:.9rem;">${q.text}</div>
                            <div style="display:grid; gap:.5rem;">
                                ${optionsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                notesEl.innerHTML = `
                    <div id="examInstructions_${examId}" style="background:#f0f9ff; border:1px solid #0ea5e9; border-radius:8px; padding:.75rem; margin-bottom:1rem;">
                        <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem;">
                            <i class="fas fa-info-circle" style="color:#0ea5e9;"></i>
                            <strong style="color:#0c4a6e; font-size:.9rem;">Exam Instructions</strong>
                        </div>
                        <ul style="margin:0; padding-left:1.2rem; color:#0c4a6e; font-size:.85rem; line-height:1.6;">
                            <li><strong>Total Questions:</strong> ${totalQuestions}</li>
                            ${timeLimitMin ? `<li><strong>Allocated Time:</strong> ${timeLimitMin} minutes</li>` : ''}
                            <li><strong>Passing Score:</strong> ${passMark}%</li>
                            <li><strong>Attempts Allowed:</strong> ${attemptsAllowed}</li>
                            <li>Read each question carefully and select the best answer.</li>
                            <li>You can change your answers before submitting.</li>
                            <li>Click "Submit Exam" when you're ready to finish.</li>
                        </ul>
                    </div>
                    <div id="examQuestions_${examId}" style="max-height:400px; overflow-y:auto; margin-bottom:1rem; display:none;">
                        ${questionsHtml}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:.75rem; background:#f8f9fa; border-radius:8px; border:1px solid #e5e7eb;">
                        <div style="color:#6b7280; font-size:.85rem; display:flex; align-items:center; gap:.5rem;">
                            <i class="fas fa-clock"></i> Time: <span id="examTimer_${examId}">00:00</span>
                            ${timeLimitMin ? `<span style="color:#374151; font-size:.8rem;">/ ${timeLimitMin} min</span>` : ''}
                        </div>
                        <div style="display:flex; gap:.5rem;">
                            <button id="startExamBtn_${examId}" class="btn-primary" style="padding:.5rem 1rem; background:#10b981; border-color:#10b981;" onclick="profileManager.beginExam('${examId}', '${courseId}', ${moduleIndex}, ${itemIndex})">
                                <i class="fas fa-play"></i> Start Exam
                            </button>
                            <button id="submitExamBtn_${examId}" class="btn-primary" style="padding:.5rem 1rem;" onclick="profileManager.submitExam('${examId}', '${courseId}', ${moduleIndex}, ${itemIndex})" disabled>
                                <i class="fas fa-check"></i> Submit Exam
                            </button>
                        </div>
                    </div>
                `;
                
                viewer.style.display = 'block';
                
                // Disable answering until started
                document.querySelectorAll(`[name^="question_${examId}_"]`).forEach(inp => { inp.disabled = true; });
            }
            
            updateExamAnswer(examId, questionIndex, answerIndex){
                if(!this._examSessions || !this._examSessions[examId]) return;
                this._examSessions[examId].answers[questionIndex] = answerIndex;
            }
            
            startExamTimer(examId){
                const timerElement = document.getElementById(`examTimer_${examId}`);
                if(!timerElement || !this._examSessions || !this._examSessions[examId]) return;
                
                const examData = this._examSessions[examId];
                if(!examData.started || !examData.startTime) return; // do not run until started
                const startTime = examData.startTime;
                const timeLimitMs = (examData.timeLimitMin || 0) * 60000;
                
                const updateTimer = () => {
                    if(examData.submitted) return;
                    
                    const elapsed = Date.now() - startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    if(timerElement){
                        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                    
                    // Auto-submit if time limit reached
                    if(timeLimitMs && elapsed >= timeLimitMs){
                        const btn = document.getElementById(`submitExamBtn_${examId}`);
                        if(btn) btn.disabled = false;
                        this.submitExam(examId, this._currentCourseCtx.courseId, 0, 0);
                        return;
                    }
                    
                    if(!examData.submitted){
                        setTimeout(updateTimer, 1000);
                    }
                };
                
                updateTimer();
            }

            // Begin exam: enable questions, start timer, enable submit
            beginExam(examId){
                if(!this._examSessions || !this._examSessions[examId]) return;
                const data = this._examSessions[examId];
                if(data.started) return;
                data.started = true;
                data.startTime = Date.now();
                const questionsWrap = document.getElementById(`examQuestions_${examId}`);
                if(questionsWrap) questionsWrap.style.display = 'block';
                const instr = document.getElementById(`examInstructions_${examId}`);
                if(instr) instr.style.display = 'none';
                document.querySelectorAll(`[name^="question_${examId}_"]`).forEach(inp => { inp.disabled = false; });
                const startBtn = document.getElementById(`startExamBtn_${examId}`);
                if(startBtn){ startBtn.disabled = true; startBtn.innerHTML = '<i class="fas fa-play"></i> Started'; }
                const submitBtn = document.getElementById(`submitExamBtn_${examId}`);
                if(submitBtn) submitBtn.disabled = false;
                this.startExamTimer(examId);
            }
            
            async submitExam(examId, courseId, moduleIndex, itemIndex){
                if(!this._examSessions || !this._examSessions[examId]) return;
                
                const examData = this._examSessions[examId];
                const questions = examData.questions;
                const answers = examData.answers;
                
                // Check if all questions are answered
                const unanswered = [];
                for(let i = 0; i < questions.length; i++){
                    if(answers[i] === undefined){
                        unanswered.push(i + 1);
                    }
                }
                
                if(unanswered.length > 0){
                    if(!confirm(`You have ${unanswered.length} unanswered question(s): ${unanswered.join(', ')}. Submit anyway?`)){
                        return;
                    }
                }
                
                // Calculate score
                let correct = 0;
                const results = [];
                
                for(let i = 0; i < questions.length; i++){
                    const question = questions[i];
                    const userAnswer = answers[i];
                    const correctAnswer = question.answerIndex;
                    const isCorrect = userAnswer === correctAnswer;
                    
                    if(isCorrect) correct++;
                    
                    results.push({
                        question: question.text,
                        userAnswer: userAnswer !== undefined ? question.options[userAnswer] : 'Not answered',
                        correctAnswer: question.options[correctAnswer],
                        isCorrect
                    });
                }
                
                const score = Math.round((correct / questions.length) * 100);
                const passed = score >= 70; // 70% passing grade
                
                examData.submitted = true;
                examData.endTime = Date.now();
                examData.score = score;
                examData.passed = passed;
                examData.results = results;
                
                // Show results
                this.showExamResults(examId, examData);
                
                // Store exam result in Firebase
                try {
                    const companyId = await this.resolveCompanyContext();
                    const userId = firebase.auth().currentUser?.uid;
                    if(userId && companyId){
                        const resultData = {
                            courseId,
                            moduleIndex,
                            itemIndex,
                            score,
                            passed,
                            completedAt: Date.now(),
                            duration: examData.endTime - examData.startTime,
                            results
                        };
                        
                        await firebase.database().ref(`companies/${companyId}/examResults/${userId}/${courseId}_${moduleIndex}_${itemIndex}`).set(resultData);
                    }
                } catch(e){
                    console.error('Failed to save exam result:', e);
                }
            }
            
            showExamResults(examId, examData){
                const timerElement = document.getElementById(`examTimer_${examId}`);
                const questionsContainer = document.getElementById(`examQuestions_${examId}`);
                const submitBtn = document.getElementById(`submitExamBtn_${examId}`);
                
                if(timerElement){
                    const duration = Math.round((examData.endTime - examData.startTime) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} (Final)`;
                }
                
                if(submitBtn){
                    submitBtn.style.display = 'none';
                }
                
                const scoreColor = examData.passed ? '#059669' : '#dc2626';
                const statusIcon = examData.passed ? 'fa-check-circle' : 'fa-times-circle';
                const statusText = examData.passed ? 'PASSED' : 'FAILED';
                
                const resultsHtml = `
                    <div style="background:${examData.passed ? '#f0fdf4' : '#fef2f2'}; border:2px solid ${scoreColor}; border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; text-align:center;">
                        <i class="fas ${statusIcon}" style="font-size:2rem; color:${scoreColor}; margin-bottom:.5rem;"></i>
                        <div style="font-size:1.5rem; font-weight:700; color:${scoreColor}; margin-bottom:.25rem;">${examData.score}%</div>
                        <div style="font-size:.9rem; font-weight:600; color:${scoreColor};">${statusText}</div>
                        <div style="font-size:.8rem; color:#6b7280; margin-top:.5rem;">
                            ${examData.results.filter(r => r.isCorrect).length} out of ${examData.results.length} correct
                        </div>
                    </div>
                    <div style="font-weight:600; margin-bottom:.75rem; color:#111827;">Question Review:</div>
                    ${examData.results.map((result, i) => `
                        <div style="margin-bottom:1rem; padding:.75rem; border:1px solid ${result.isCorrect ? '#d1fae5' : '#fee2e2'}; border-radius:8px; background:${result.isCorrect ? '#f0fdf4' : '#fef2f2'};">
                            <div style="font-weight:600; color:#111827; margin-bottom:.5rem; font-size:.9rem;">Question ${i + 1}</div>
                            <div style="color:#374151; margin-bottom:.5rem; font-size:.85rem;">${result.question}</div>
                            <div style="font-size:.8rem; line-height:1.4;">
                                <div style="color:#6b7280;">Your answer: <span style="color:#374151; font-weight:500;">${result.userAnswer}</span></div>
                                <div style="color:#6b7280;">Correct answer: <span style="color:#059669; font-weight:500;">${result.correctAnswer}</span></div>
                            </div>
                        </div>
                    `).join('')}
                `;
                
                if(questionsContainer){
                    questionsContainer.innerHTML = resultsHtml;
                }
            }

            closeItemViewer(moduleIndex = null, itemIndex = null){
                if(moduleIndex !== null && itemIndex !== null) {
                    const viewer = document.getElementById(`courseItemViewer-${moduleIndex}-${itemIndex}`);
                    if(viewer){ viewer.style.display = 'none'; }
                } else {
                    // Close all viewers
                    document.querySelectorAll('.course-item-viewer').forEach(v => v.style.display = 'none');
                }
            }

            async submitQuiz(moduleIndex, itemIndex){
                // simple scoring: first option assumed correct if not provided
                const ctx = this._currentCourseCtx; if(!ctx) return;
                const module = ctx.modules[moduleIndex];
                const item = (module && Array.isArray(module.items)) ? module.items[itemIndex] : null;
                const questions = Array.isArray(item?.questions)? item.questions: [];
                let correct = 0;
                questions.forEach((q, qi)=>{
                    const chosen = document.querySelector(`input[name="q${qi}"]:checked`);
                    const ansIndex = typeof q.answerIndex === 'number'? q.answerIndex: 0;
                    if(chosen && Number(chosen.value) === ansIndex) correct++;
                });
                const score = questions.length? Math.round((correct/questions.length)*100): 0;
                alert(`Quiz submitted. Score: ${score}%`);
                // Future: write score/progress to assignment
            }

            closeCoursePlayer(){
                const modal = document.getElementById('coursePlayerModal');
                if(modal){ modal.style.display = 'none'; }
                // Optional: detach any realtime listeners if added
            }

            renderCertificates(certs) {
                if (!certs || certs.length === 0) {
                    return '<div style="text-align:center; padding:2rem; color:#6b7280;"><i class="fas fa-certificate" style="font-size:2rem; opacity:0.3; margin-bottom:1rem; display:block;"></i>No certificates earned yet. Complete your courses to earn certificates!</div>';
                }
                return certs.map(c => {
                    const completed = c.completedAt ? new Date(c.completedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                    const certId = `CERT-${(c.courseId || '').substring(0,6).toUpperCase()}-${(c.assignmentId || c.certificateId || '').substring(0,6).toUpperCase()}`;
                    return `
                        <div class="assignment-card" style="background:#fff; border-radius:12px; padding:1.25rem; box-shadow:0 2px 12px rgba(0,0,0,0.08); border-left:4px solid #f59e0b; position:relative; overflow:hidden;">
                            <div style="position:absolute; top:0; right:0; width:80px; height:80px; opacity:0.1;">
                                <i class="fas fa-certificate" style="font-size:80px; color:#f59e0b;"></i>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                                <div style="flex:1; min-width:0;">
                                    <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem;">
                                        <i class="fas fa-award" style="color:#f59e0b; font-size:1.25rem;"></i>
                                        <h5 style="margin:0; font-size:1.05rem; font-weight:600; color:#111827; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${c.courseTitle}</h5>
                                    </div>
                                    <div style="display:flex; flex-direction:column; gap:.25rem;">
                                        <div style="color:#059669; font-size:.85rem; font-weight:500;">
                                            <i class="fas fa-check-circle" style="margin-right:.25rem;"></i> Course Completed
                                        </div>
                                        <div style="color:#6b7280; font-size:.8rem;">
                                            <i class="fas fa-calendar-check" style="margin-right:.25rem;"></i> ${completed}
                                        </div>
                                        <div style="color:#9ca3af; font-size:.75rem;">
                                            <i class="fas fa-fingerprint" style="margin-right:.25rem;"></i> ${certId}
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; flex-direction:column; gap:.5rem;">
                                    <button onclick="profileManager.downloadCertificate('${c.courseId}', '${c.assignmentId || c.certificateId}')" style="
                                        background: linear-gradient(135deg, #f59e0b, #d97706);
                                        color: #fff;
                                        border: none;
                                        padding: .6rem 1rem;
                                        border-radius: 8px;
                                        font-size: .85rem;
                                        font-weight: 500;
                                        cursor: pointer;
                                        display: inline-flex;
                                        align-items: center;
                                        gap: .5rem;
                                        transition: all 0.2s ease;
                                        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(245, 158, 11, 0.3)';">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                    <button onclick="profileManager.viewCertificate('${c.courseId}', '${c.assignmentId || c.certificateId}')" style="
                                        background: transparent;
                                        color: #6b7280;
                                        border: 1px solid #e5e7eb;
                                        padding: .5rem .75rem;
                                        border-radius: 8px;
                                        font-size: .8rem;
                                        cursor: pointer;
                                        display: inline-flex;
                                        align-items: center;
                                        gap: .5rem;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.borderColor='#9ca3af'; this.style.color='#374151';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280';">
                                        <i class="fas fa-eye"></i> Preview
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async loadPayslips(){
                try{
                    const body=document.getElementById('payslipTableBody');
                    const totalsFoot=document.getElementById('payslipTableTotals');
                    if(!body) return;
                    const runs=JSON.parse(localStorage.getItem('payroll.runs')||'{}').items||[];
                    if(!this.currentUser){ body.innerHTML='<tr><td colspan="8" style="padding:16px;">Not signed in.</td></tr>'; return; }
                    const meName=(this.currentUser.displayName||this.currentUser.name||'').trim().toLowerCase();
                    const userIds=new Set([this.currentUser.uid,this.currentUser.id,this.currentUser.userId,this.currentUser.employeeId].filter(Boolean));
                    const myRows=[];
                    const periodOptions=new Set();
                    // Resolve companyId & fetch remote templates (company scope)
                    let companyId=null; try { companyId = (JSON.parse(localStorage.getItem('currentUser')||'null')||{}).companyId; } catch {}
                    let remoteTemplates=[]; if(window.firebase && companyId){
                        try { const snap = await window.firebase.database().ref(`companies/${companyId}/payroll/payslipTemplates`).once('value'); if(snap.exists()){ const val=snap.val(); remoteTemplates = Object.values(val).filter(Boolean); } } catch(e){ console.warn('Template fetch failed', e); }
                    }
                    const templateMap=new Map(); remoteTemplates.forEach(t=>{ if(!t) return; if(t.category) templateMap.set(String(t.category), t); if(t.id) templateMap.set(String(t.id), t); });
                    for(const run of runs.filter(r=>r.posted)){
                        for(const emp of (run.employees||[])){
                            const empName=(emp.employee||'').trim().toLowerCase();
                            const idMatch=userIds.has(emp.employeeId)||userIds.has(emp.id)||userIds.has(emp.uid);
                            const nameMatch= empName && meName && (empName===meName);
                            if(idMatch||nameMatch){
                                const period=`${run.period.month}/${run.period.year}`;
                                periodOptions.add(period);
                                // Determine category and enforce template-only lines if category template exists
                                // Fetch remote payslipCategory if not embedded in run employee object
                                let category = emp.payslipCategory || emp.payslipModelId || emp.category || emp.modelId || null;
                                if(!category && window.firebase && companyId){
                                    const possibleIds = [emp.employeeId, emp.code, emp.employee].filter(Boolean);
                                    for(const pid of possibleIds){
                                        try { const csnap = await window.firebase.database().ref(`companies/${companyId}/payroll/employees/${pid}/employment/payslipCategory`).once('value'); if(csnap.exists()){ category = csnap.val(); break; } } catch(e){ /* ignore */ }
                                    }
                                }
                                let earningsLines = Array.isArray(emp.earnings)? JSON.parse(JSON.stringify(emp.earnings)) : [];
                                let deductionLines = Array.isArray(emp.deductions)? JSON.parse(JSON.stringify(emp.deductions)) : [];
                                if(category && templateMap.has(String(category))){
                                    const tpl = templateMap.get(String(category));
                                    if(tpl){
                                        const tplEarnIds = new Set(Array.isArray(tpl.earnings)? tpl.earnings.map(String): []);
                                        const tplDedIds  = new Set(Array.isArray(tpl.deductions)? tpl.deductions.map(String): []);
                                        // Build pay element index once outside loops (cache in closure)
                                        if(!this._payElementIndex){
                                            try { const storedPE = JSON.parse(localStorage.getItem('pay-elements')||'[]'); const m=new Map(); storedPE.forEach(pe=>{ if(!pe) return; const code=(pe.code||pe.name||'').toString().trim().toLowerCase(); if(code) m.set(code, pe); }); this._payElementIndex=m; } catch { this._payElementIndex=new Map(); }
                                        }
                                        const idx = this._payElementIndex;
                                        const norm = v=> (v||'').toString().trim().toLowerCase();
                                        if(tplEarnIds.size){
                                            earningsLines = earningsLines.filter(line=>{
                                                if(line.id && tplEarnIds.has(String(line.id))) return true;
                                                const code=norm(line.code||line.name||'');
                                                const pe=idx.get(code);
                                                return pe && tplEarnIds.has(String(pe.id));
                                            });
                                        } else earningsLines=[];
                                        if(tplDedIds.size){
                                            deductionLines = deductionLines.filter(line=>{
                                                if(line.id && tplDedIds.has(String(line.id))) return true;
                                                const code=norm(line.code||line.name||'');
                                                const pe=idx.get(code);
                                                return pe && tplDedIds.has(String(pe.id));
                                            });
                                        } else deductionLines=[];
                                    }
                                }
                                // Recompute amounts totals strictly from remaining lines
                                const earningsSum = earningsLines.reduce((s,e)=>s+Number(e.amount||0),0);
                                const deductionSum = deductionLines.reduce((s,d)=>s+Number(d.amount||0),0);
                                const basicVal = Number(emp.basic||0);
                                const grossVal = basicVal + earningsSum; // recomputed to align with template enforcement
                                const taxVal = Number(emp.tax||0);
                                const netVal = grossVal - deductionSum - taxVal;
                                myRows.push({
                                    period,
                                    basic:basicVal,
                                    earnings:earningsSum,
                                    deductions:deductionSum,
                                    gross:grossVal,
                                    tax:taxVal,
                                    net:netVal,
                                    category: category,
                                    lines:{earnings:earningsLines, deductions:deductionLines}
                                });
                            }
                        }
                    }

                    // Period filter populate (do once per load for now)
                    const filter=document.getElementById('payslipPeriodFilter');
                    if(filter && filter.options.length<=1){
                        Array.from(periodOptions).sort((a,b)=>{
                            const [am,ay]=a.split('/').map(Number); const [bm,by]=b.split('/').map(Number);
                            return by-ay || bm-am; // desc
                        }).forEach(p=>{ const opt=document.createElement('option'); opt.value=p; opt.textContent=p; filter.appendChild(opt); });
                        filter.addEventListener('change',()=>this.renderPayslipRows());
                    }
                    this._cachedPayslips=myRows;
                    this.renderPayslipRows();
                }catch(e){ console.error('Payslip load error',e); }
            }

            renderPayslipRows(){
                const body=document.getElementById('payslipTableBody');
                const totalsFoot=document.getElementById('payslipTableTotals');
                const filter=document.getElementById('payslipPeriodFilter');
                if(!body) return;
                const rows=(this._cachedPayslips||[]).filter(r=>!filter||!filter.value||r.period===filter.value);
                if(!rows.length){
                    body.innerHTML='<tr><td colspan="8" style="padding:16px; color:#6c757d;">No payslips found for selection.</td></tr>';
                    if(totalsFoot) totalsFoot.innerHTML='';
                    return;
                }
                let grossT=0,taxT=0,netT=0,basicT=0,earnT=0,dedT=0;
                body.innerHTML=rows.map((r,i)=>{
                    grossT+=r.gross; taxT+=r.tax; netT+=r.net; basicT+=r.basic; earnT+=r.earnings; dedT+=r.deductions;
                    return `<tr data-row="${i}">
                        <td>${r.period}</td>
                        <td>${this.formatCurrency(r.basic)}</td>
                        <td>${this.formatCurrency(r.earnings)}</td>
                        <td>${this.formatCurrency(r.deductions)}</td>
                        <td>${this.formatCurrency(r.gross)}</td>
                        <td>${this.formatCurrency(r.tax)}</td>
                        <td>${this.formatCurrency(r.net)}</td>
                        <td><button class="btn-sm" style="background:#eef2f6;border-radius:6px;padding:4px 8px;font-size:0.65rem;" data-view-paylines="${i}"><i class="fas fa-list"></i></button></td>
                    </tr>`;}).join('');
                if(totalsFoot){
                    totalsFoot.innerHTML=`<tr style="font-weight:600;background:#f8fafc"><td>Total</td><td>${this.formatCurrency(basicT)}</td><td>${this.formatCurrency(earnT)}</td><td>${this.formatCurrency(dedT)}</td><td>${this.formatCurrency(grossT)}</td><td>${this.formatCurrency(taxT)}</td><td>${this.formatCurrency(netT)}</td><td></td></tr>`;
                }
                // detail toggle
                body.querySelectorAll('[data-view-paylines]').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        const idx=Number(btn.getAttribute('data-view-paylines'));
                        const r=rows[idx]; if(!r) return;
                        const existing=btn.closest('tr').nextElementSibling;
                        if(existing && existing.classList.contains('paylines-row')) { existing.remove(); return; }
                        const detail=document.createElement('tr');
                        detail.className='paylines-row';
                        const earnLines = r.lines.earnings.map(l=>`<div style=\"display:flex;justify-content:space-between;\"><span>${l.name||l.type||'Earning'}</span><span>${this.formatCurrency(l.amount||0)}</span></div>`).join('')||'<em style="color:#64748b;font-size:0.7rem;">No earnings lines</em>';
                        const dedLines = r.lines.deductions.map(l=>`<div style=\"display:flex;justify-content:space-between;\"><span>${l.name||l.type||'Deduction'}</span><span>${this.formatCurrency(l.amount||0)}</span></div>`).join('')||'<em style="color:#64748b;font-size:0.7rem;">No deduction lines</em>';
                        detail.innerHTML=`<td colspan="8" style="background:#f1f5f9;padding:10px 14px;">
                            <div style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
                                <div><strong style="font-size:0.7rem;letter-spacing:.5px;color:#334155;">EARNINGS</strong><div style="margin-top:6px;display:flex;flex-direction:column;gap:4px;">${earnLines}</div></div>
                                <div><strong style="font-size:0.7rem;letter-spacing:.5px;color:#334155;">DEDUCTIONS</strong><div style="margin-top:6px;display:flex;flex-direction:column;gap:4px;">${dedLines}</div></div>
                            </div>
                        </td>`;
                        btn.closest('tr').after(detail);
                    });
                });
            }

            formatCurrency(v){
                try{const settings=JSON.parse(localStorage.getItem('payroll.settings')||'{}');const c=settings.currency||'USD';return new Intl.NumberFormat(undefined,{style:'currency',currency:c}).format(Number(v||0));}catch{return v;}
            }

            setupProfileDropdown() {
                const userProfileBtn = document.getElementById('userProfileBtn');
                const dropdowns = document.querySelectorAll('.profile-dropdown');
                const profileDropdown = dropdowns[dropdowns.length - 1] || null; // always use the last container
                
                // remove any duplicate earlier containers to prevent double dropdowns
                if (dropdowns.length > 1) {
                    for (let i = 0; i < dropdowns.length - 1; i++) {
                        dropdowns[i].remove();
                    }
                }

                if (userProfileBtn && profileDropdown) {
                    userProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });

                    // Close only when clicking outside both button and dropdown (as in travel.html)
                    document.addEventListener('click', (e) => {
                        const clickedOutsideBtn = !userProfileBtn.contains(e.target);
                        const clickedOutsideDropdown = !profileDropdown.contains(e.target);
                        if (clickedOutsideBtn && clickedOutsideDropdown) {
                            profileDropdown.classList.remove('show');
                        }
                    });

                    // Optional: close on Escape for UX consistency
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            profileDropdown.classList.remove('show');
                        }
                    });
                }
            }

            populateUserProfileDropdown() {
                // Call async version
                this.populateUserProfileDropdownAsync();
            }
            
            async populateUserProfileDropdownAsync() {
                try {
                    const btn = document.getElementById('userProfileBtn');
                    let dropdowns = document.querySelectorAll('.profile-dropdown');
                    // Keep only the last dropdown container
                    if (dropdowns.length > 1) {
                        for (let i = 0; i < dropdowns.length - 1; i++) {
                            dropdowns[i].remove();
                        }
                        dropdowns = document.querySelectorAll('.profile-dropdown');
                    }
                    const container = dropdowns[dropdowns.length - 1] || null;
                    const dropdownUl = container ? container.querySelector('ul') : null;
                    if (!btn || !dropdownUl || !this.currentUser) return;

                    // Idempotency: skip if already hydrated
                    if (container && container.dataset.hydrated === 'true') return;

                    const displayName = this.currentUser.displayName || this.currentUser.name || (this.currentUser.email ? this.currentUser.email.split('@')[0] : 'User');
                    const email = this.currentUser.email || '';
                    const initials = (displayName.split(' ').map(p=>p[0]).join('').substring(0,2) || 'U').toUpperCase();
                    
                    // Try to get avatar URL from Firebase Storage (like project-list.html)
                    let avatarUrl = null;
                    try { avatarUrl = await this.getUserAvatarUrl(); } catch (e) { }
                    
                    // Set the profile button image
                    const btnImg = btn.querySelector('img');
                    if (avatarUrl && btnImg) {
                        btnImg.src = avatarUrl;
                        btnImg.alt = displayName + ' Avatar';
                        btnImg.style.display = 'block';
                        btnImg.onerror = () => {
                            // If avatar fails to load, show initials
                            btnImg.style.display = 'none';
                            btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${initials}</div>`;
                        };
                    } else {
                        // No avatar, show initials
                        btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${initials}</div>`;
                    }
                    
                    // Build dropdown with avatar or initials
                    const avatarHtml = avatarUrl 
                        ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` 
                        : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${initials}</div>`;
                    
                    dropdownUl.innerHTML = `
                        <li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div>
                                    <div style="color:#666;font-size:12px;">${email}</div>
                                </div>
                            </div>
                        </li>
                        <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                        <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
                    `;

                    const logoutLink = document.getElementById('logoutLink');
                    if (logoutLink) {
                        logoutLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            localStorage.removeItem('currentUser');
                            localStorage.removeItem('user');
                            window.location.href = 'login.html';
                        });
                    }

                    if (container) container.dataset.hydrated = 'true';
                } catch (err) {
                    console.warn('populateUserProfileDropdown skipped:', err);
                }
            }
            
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                const companyId = this.currentUser.companyId || 'default';
                const uid = this.currentUser.uid || this.currentUser.userId || this.currentUser.id;
                if (!uid) return null;
                const possiblePaths = [
                    `companies/${companyId}/avatars/${uid}/profile.jpg`,
                    `companies/${companyId}/avatars/${uid}/profile.png`,
                    `companies/${companyId}/avatars/${uid}/profile.jpeg`,
                    `companies/${companyId}/avatars/${uid}/avatar.jpg`,
                    `companies/${companyId}/avatars/${uid}/avatar.png`,
                    `avatars/${uid}/profile.jpg`,
                    `avatars/${uid}/profile.png`,
                    `avatars/${uid}/avatar.jpg`,
                    `avatars/${uid}/avatar.png`,
                    `profiles/${uid}/profile.jpg`,
                    `profiles/${uid}/profile.png`
                ];
                for (const path of possiblePaths) {
                    try {
                        const ref = storage.ref(path);
                        const url = await ref.getDownloadURL();
                        return url;
                    } catch (err) { continue; }
                }
                return null;
            }

            async handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Please select a valid image file', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    this.showNotification('Image size must be less than 5MB', 'error');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Get company ID for scoped upload path
                    const companyId = this.currentUser.companyId || 'default';
                    console.log(' Uploading profile image for company:', companyId);
                    
                    // Upload to company-scoped Firebase Storage path
                    const imageRef = storage.ref(`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`);
                    const snapshot = await imageRef.put(file);
                    const imageUrl = await snapshot.ref.getDownloadURL();
                    
                    console.log(' Profile image uploaded to:', imageRef.fullPath);
                    
                    // Update profile avatar immediately (match header image, hide overlays)
                    const profileAvatar = document.getElementById('profileAvatar');
                    if (profileAvatar) {
                        profileAvatar.classList.add('has-photo');

                        const initialsDiv = document.getElementById('profileInitials');
                        if (initialsDiv) initialsDiv.style.display = 'none';

                        let img = profileAvatar.querySelector('img');
                        if (!img) {
                            img = document.createElement('img');
                            profileAvatar.insertBefore(img, profileAvatar.firstChild);
                        }
                        img.src = imageUrl;
                        img.alt = 'Profile Photo';
                    }

                    // Update header profile button image immediately
                    const headerBtn = document.getElementById('userProfileBtn');
                    const headerImg = headerBtn ? headerBtn.querySelector('img') : null;
                    if (headerImg) {
                        headerImg.src = imageUrl;
                        headerImg.style.display = 'block';
                    }
                    
                    // Update user record
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        profileImage: imageUrl,
                        updatedAt: new Date().toISOString()
                    });
                    
                    this.showNotification('Profile photo updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    this.showNotification('Error uploading photo. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async savePersonalInfo() {
                // Only save the bio field since other fields are readonly
                const formData = {
                    bio: document.getElementById('bio').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    this.showLoading(true);
                    
                    await db.ref(`users/${this.currentUser.uid}`).update(formData);
                    
                    // Update current user in localStorage
                    this.currentUser = { ...this.currentUser, ...formData };
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    this.showNotification('Bio updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving bio:', error);
                    this.showNotification('Error saving bio. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async updatePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    this.showNotification('Please fill in all password fields', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    this.showNotification('New passwords do not match', 'error');
                    return;
                }

                if (!this.isValidPassword(newPassword)) {
                    this.showNotification('Password does not meet requirements', 'error');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Check if user is authenticated with Firebase
                    const user = auth.currentUser;
                    if (!user) {
                        console.error('No authenticated user found');
                        this.showNotification('User not authenticated. Please log in again.', 'error');
                        return;
                    }

                    console.log('Current user:', user.email);
                    console.log('Attempting to re-authenticate user...');
                    
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        user.email, // Use the current user's email from Firebase
                        currentPassword
                    );
                    
                    await user.reauthenticateWithCredential(credential);
                    console.log('Re-authentication successful');
                    
                    console.log('Updating password...');
                    await user.updatePassword(newPassword);
                    console.log('Password update successful');
                    
                    // Clear form and hide any error tooltips
                    document.getElementById('securityForm').reset();
                    this.hidePasswordTooltip();
                    
                    this.showNotification('Password updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Detailed error updating password:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    if (error.code === 'auth/wrong-password') {
                        this.showPasswordTooltip('Current password is incorrect');
                        this.showNotification('Current password is incorrect', 'error');
                    } else if (error.code === 'auth/weak-password') {
                        this.showNotification('New password is too weak. Please choose a stronger password.', 'error');
                    } else if (error.code === 'auth/requires-recent-login') {
                        this.showNotification('Please log out and log back in, then try updating your password.', 'error');
                    } else if (error.code === 'auth/user-not-found') {
                        this.showNotification('User account not found. Please log in again.', 'error');
                    } else if (error.code === 'auth/too-many-requests') {
                        this.showNotification('Too many failed attempts. Please try again later.', 'error');
                    } else {
                        this.hidePasswordTooltip();
                        this.showNotification(`Error updating password: ${error.message}`, 'error');
                    }
                } finally {
                    this.showLoading(false);
                }
            }

            async savePreferences() {
                const preferences = {
                    timezone: document.getElementById('timezone').value,
                    language: document.getElementById('language').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    this.showLoading(true);
                    
                    await db.ref(`users/${this.currentUser.uid}`).update(preferences);
                    
                    this.showNotification('Preferences saved successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving preferences:', error);
                    this.showNotification('Error saving preferences. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async updateLanguagePreference(language) {
                try {
                    // Update database
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        language: language,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    this.currentUser.language = language;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    // Apply language change immediately (if you have internationalization)
                    this.applyLanguageSettings(language);
                    
                    this.showNotification(`Language changed to ${this.getLanguageName(language)}`, 'success');
                    
                } catch (error) {
                    console.error('Error updating language preference:', error);
                    this.showNotification('Error updating language preference', 'error');
                }
            }

            async updateTimezonePreference(timezone) {
                try {
                    // Update database
                    await db.ref(`users/${this.currentUser.uid}`).update({
                        timezone: timezone,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update localStorage
                    this.currentUser.timezone = timezone;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    // Apply timezone change immediately
                    this.applyTimezoneSettings(timezone);
                    
                    this.showNotification(`Timezone changed to ${this.getTimezoneName(timezone)}`, 'success');
                    
                } catch (error) {
                    console.error('Error updating timezone preference:', error);
                    this.showNotification('Error updating timezone preference', 'error');
                }
            }

            applyLanguageSettings(language) {
                // Store language preference for future use
                document.documentElement.lang = language;
                
                // You can add more language-specific logic here
                console.log(`Language preference applied: ${language}`);
            }

            applyTimezoneSettings(timezone) {
                // Store timezone preference for future use
                // This can be used for displaying times in user's preferred timezone
                console.log(`Timezone preference applied: ${timezone}`);
                
                // Refresh activity times if the activity tab is currently active
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'activity') {
                    this.loadRecentActivity();
                }
            }

            getLanguageName(languageCode) {
                const languageNames = {
                    'en': 'English',
                    'es': 'Spanish',
                    'fr': 'French',
                    'de': 'German'
                };
                return languageNames[languageCode] || languageCode;
            }

            getTimezoneName(timezone) {
                const timezoneNames = {
                    'UTC': 'UTC',
                    'America/New_York': 'Eastern Time',
                    'America/Chicago': 'Central Time',
                    'America/Denver': 'Mountain Time',
                    'America/Los_Angeles': 'Pacific Time'
                };
                return timezoneNames[timezone] || timezone;
            }

            validatePassword(password) {
                const requirements = {
                    'req-length': password.length >= 8,
                    'req-uppercase': /[A-Z]/.test(password),
                    'req-lowercase': /[a-z]/.test(password),
                    'req-number': /\d/.test(password),
                    'req-special': /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                Object.entries(requirements).forEach(([id, valid]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.className = valid ? 'valid' : 'invalid';
                    }
                });

                return Object.values(requirements).every(valid => valid);
            }

            isValidPassword(password) {
                return password.length >= 8 &&
                       /[A-Z]/.test(password) &&
                       /[a-z]/.test(password) &&
                       /\d/.test(password) &&
                       /[!@#$%^&*(),.?":{}|<>]/.test(password);
            }

            showPasswordTooltip(message) {
                const tooltip = document.getElementById('currentPasswordTooltip');
                const formGroup = document.getElementById('currentPassword').parentElement.parentElement;
                
                if (tooltip && formGroup) {
                    if (message) {
                        tooltip.textContent = message;
                    }
                    
                    // Add error styling to form group and show tooltip
                    formGroup.classList.add('has-error');
                    tooltip.classList.add('show');
                    
                    // Auto-hide tooltip after 5 seconds
                    setTimeout(() => {
                        this.hidePasswordTooltip();
                    }, 5000);
                }
            }

            hidePasswordTooltip() {
                const tooltip = document.getElementById('currentPasswordTooltip');
                const formGroup = document.getElementById('currentPassword').parentElement.parentElement;
                
                if (tooltip && formGroup) {
                    formGroup.classList.remove('has-error');
                    tooltip.classList.remove('show');
                }
            }

            togglePassword(fieldId) {
                const passwordField = document.getElementById(fieldId);
                const icon = document.getElementById(fieldId + 'Icon');
                
                if (!passwordField || !icon) return;
                
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordField.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }

            checkAuthenticationStatus() {
                console.log('=== Authentication Status Check ===');
                console.log('localStorage currentUser:', this.currentUser);
                console.log('Firebase currentUser:', auth.currentUser);
                
                if (auth.currentUser) {
                    console.log('Firebase user email:', auth.currentUser.email);
                    console.log('Firebase user emailVerified:', auth.currentUser.emailVerified);
                    console.log('Firebase user uid:', auth.currentUser.uid);
                } else {
                    console.log('No Firebase currentUser found');
                }
                
                return auth.currentUser !== null;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification-toast notification-${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            showLoading(show) {
                let overlay = document.getElementById('loadingOverlay');
                
                if (show) {
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'loadingOverlay';
                        overlay.className = 'loading-overlay';
                        overlay.innerHTML = `
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Please wait...</p>
                            </div>
                        `;
                        document.body.appendChild(overlay);
                    }
                    overlay.style.display = 'flex';
                } else {
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                }
            }
        }

        // Global logout function
        async function logout() {
            try {
                await auth.signOut();
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Resolve company and user context (aligned with lms.html)
        async function resolveCompanyContext(){
            const authUser = (window.authManager && window.authManager.currentUser) || (firebase.auth ? firebase.auth().currentUser : null) || JSON.parse(localStorage.getItem('currentUser')||'null');
            if(!authUser){ throw new Error('Not signed in'); }
            const uid = authUser.uid || authUser.authUid || authUser.id || authUser.userId || null;
            if(authUser.companyId){ return { companyId: authUser.companyId, userId: uid }; }
            const snap = await firebase.database().ref('companies').once('value');
            if(!snap.exists()) throw new Error('No companies found');
            const companies = snap.val();
            for(const [cid, comp] of Object.entries(companies)){
                if(comp.status && comp.status!=='active') continue;
                if(comp.users && uid && comp.users[uid]){ return { companyId: cid, userId: uid }; }
            }
            throw new Error('Company not found for user');
        }

        // Reset all menu items to hidden (align with project-list: do not touch loading state here)
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items (remove loading state like project-list)
        function showBasicMenu() {
            console.log(' Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Flag to prevent multiple simultaneous menu updates
        let isMenuUpdateInProgress = false;

        // Feature-based authorization system that takes priority over role permissions (exactly as in project-list.html)
        async function updateMenuWithFeatureAuthorization() {
            // Prevent multiple simultaneous executions
            if (isMenuUpdateInProgress) {
                console.log(' Menu update already in progress, skipping...');
                return;
            }
            
            isMenuUpdateInProgress = true;
            console.log(' Starting feature-based menu authorization for profile.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log(' Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log(' Using Firebase auth - will search for company and role');
                } else {
                    console.log(' No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log(' Searching for user company and role...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                                console.log(` Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error(' No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                if (!userRole) {
                    console.warn(' No user role found, proceeding with company features only');
                }
                
                // STEP 1: Apply company feature-based authorization
                console.log(' STEP 1: Applying company feature authorization...');
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                
                // STEP 2: Filter by user role permissions within authorized features
                if (userRole) {
                    console.log(' STEP 2: Applying role-based filtering within authorized features...');
                    await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                } else {
                    console.log(' STEP 2: Skipping role-based filtering (no role found)');
                }
                
            } catch (error) {
                console.error(' Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            } finally {
                isMenuUpdateInProgress = false;
            }
        }

        // Apply feature-based menu visibility (with alias + href support)
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log(' Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log(' No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error(' Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log(' Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log(' Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(` Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(` Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log(' All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Build authorized sets (features + hrefs) with alias support
                const authorizedFeatures = new Set();
                const authorizedHrefs = new Set();
                const featureAlias = (k) => {
                    if (!k) return k;
                    if (k === 'risk_view') return 'risk_management_section';
                    if (k === 'risk_management_section') return 'risk_view';
                    return null;
                };
                const normalizeHref = (href) => {
                    if (!href) return '';
                    try { const u = new URL(href, window.location.origin); return (u.pathname || '').replace(/^\//,''); } catch { return String(href).replace(/^\//,''); }
                };
                authorizedPages.forEach(info => {
                    if (info.feature) { authorizedFeatures.add(info.feature); const a = featureAlias(info.feature); if (a) authorizedFeatures.add(a); }
                    if (info.href) authorizedHrefs.add(normalizeHref(info.href));
                    if (info.page) authorizedHrefs.add(normalizeHref(info.page));
                    if (info.url) authorizedHrefs.add(normalizeHref(info.url));
                });

                console.log(' Authorized features for profile.html:', Array.from(authorizedFeatures));
                console.log(' Authorized hrefs for profile.html:', Array.from(authorizedHrefs));

                // Apply menu visibility (feature or href-based)
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    const anchor = menuItem.querySelector('a[href]');
                    const href = anchor ? anchor.getAttribute('href') : '';
                    const normalized = normalizeHref(href);
                    const isAuthorized = authorizedFeatures.has(featureAttribute) || (normalized && authorizedHrefs.has(normalized));

                    if (isDropdownContainer) return; // process after
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(` Authorized - showing: feature=${featureAttribute} href=${normalized||''}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(` Not authorized - hiding: feature=${featureAttribute} href=${normalized||''}`);
                    }
                });

                // Handle dropdown menus - show if they have visible children or dropdown feature is authorized
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const hasVisibleChildren = dropdown.querySelectorAll('.submenu li[data-feature].menu-visible').length > 0;
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(` Showing dropdown menu: ${dropdownFeature} (children or feature authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(` Hiding dropdown menu: ${dropdownFeature} (no children and not authorized)`);
                    }
                });

                console.log(` Feature-based menu authorization completed for profile.html - ${visibleCount} items visible`);
                
            } catch (error) {
                console.error(' Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Apply role-based filtering within authorized features (exactly as in project-list.html)
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log(' Applying role-based filtering for role:', userRole);
                
                // Get user role permissions from company
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                
                if (!permissionsSnapshot.exists()) {
                    console.log(` No permissions found for role ${userRole} in company ${companyId}`);
                    
                    // Try to get all roles to see what's available
                    const allRolesRef = database.ref(`companies/${companyId}/roles`);
                    const allRolesSnapshot = await allRolesRef.once('value');
                    
                    if (allRolesSnapshot.exists()) {
                        const allRoles = allRolesSnapshot.val();
                        console.log(' Available roles in company:', Object.keys(allRoles));
                        
                        // Enhanced debugging for administrator role
                        if (userRole === 'administrator') {
                            console.log(' ADMINISTRATOR - Full roles data:', allRoles);
                            if (allRoles.administrator) {
                                console.log(' ADMINISTRATOR role found in company:', allRoles.administrator);
                                if (allRoles.administrator.permissions) {
                                    console.log(' ADMINISTRATOR permissions found:', allRoles.administrator.permissions);
                                    filterMenuByPermissions(allRoles.administrator.permissions);
                                    return;
                                }
                            }
                        }
                        
                        // Check if the role exists with different casing or format
                        const roleKeys = Object.keys(allRoles);
                        const matchingRole = roleKeys.find(key => 
                            key.toLowerCase() === userRole.toLowerCase() ||
                            key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                        );
                        
                        if (matchingRole && allRoles[matchingRole].permissions) {
                            console.log(` Found matching role: ${matchingRole}`);
                            const permissions = allRoles[matchingRole].permissions;
                            filterMenuByPermissions(permissions);
                            return;
                        }
                    }
                    
                    // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                    if (userRole === 'administrator') {
                        console.log(' ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                        showSidebarAfterAuth();
                        return;
                    }
                    
                    // For other roles without permissions, hide all items with permission requirements
                    console.log(' No valid permissions found - filtering out items requiring permissions');
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log(' Loaded role permissions:', permissions);
                
                // Apply permission-based filtering
                filterMenuByPermissions(permissions);
                
            } catch (error) {
                console.error(' Error applying role-based filtering:', error);
                // Don't hide everything on error - keep company features visible
                showSidebarAfterAuth();
            }
        }

        // Filter currently visible menu items by role permissions
        function filterMenuByPermissions(permissions) {
            console.log(' Filtering visible menu items by role permissions...');
            
            if (!permissions) {
                console.log(' No permissions object provided');
                hideItemsRequiringPermissions();
                showSidebarAfterAuth();
                return;
            }
            const permissionAlias = (key) => {
                if (!key) return key;
                if (key === 'risk_view') return 'risk_management_section';
                if (key === 'risk_management_section') return 'risk_view';
                return null;
            };

            // Evaluate all permission-gated items (allow role permissions to add visibility too)
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
            console.log(` Found ${itemsRequiringPermissions.length} items requiring permissions to check`);

            let hiddenCount = 0;
            let shownByPermission = 0;

            itemsRequiringPermissions.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const feature = item.getAttribute('data-feature');

                const perm = permissions[requiresPermission];
                const aliasKey = permissionAlias(requiresPermission);
                const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;

                const hasViewPermission = (p) => p === true || (p && p.view === true);
                const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);

                if (allowed) {
                    if (!item.classList.contains('menu-visible')) shownByPermission++;
                    item.classList.add('menu-visible');
                    console.log(` Showing by permission: ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
                } else {
                    if (item.classList.contains('menu-visible')) hiddenCount++;
                    item.classList.remove('menu-visible');
                    console.log(` Hiding (no permission): ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
                }
            });

            // Re-check dropdown menus after permission filtering
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const dropdownRequires = dropdown.getAttribute('data-requires-permission');

                if (submenuItems.length === 0) {
                    if (dropdownRequires) {
                        const perm = permissions[dropdownRequires];
                        const aliasKey = permissionAlias(dropdownRequires);
                        const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
                        const hasViewPermission = (p) => p === true || (p && p.view === true);
                        const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
                        if (allowed) {
                            dropdown.classList.add('menu-visible');
                            console.log(` Showing dropdown by permission: ${dropdownFeature}`);
                        } else {
                            dropdown.classList.remove('menu-visible');
                            hiddenCount++;
                            console.log(` Hiding dropdown (no children and no permission): ${dropdownFeature}`);
                        }
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(` Hiding dropdown (no visible children): ${dropdownFeature}`);
                    }
                } else {
                    console.log(` Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
                }
            });

            console.log(` Role-based filtering completed - ${hiddenCount} items hidden; ${shownByPermission} items shown by permission`);
            
            // Ensure at least home is visible
            ensureHomeIsVisible();
            
            // Show sidebar after all filtering is complete
            showSidebarAfterAuth();
        }

        // Hide menu items that require permissions (for users without role permissions)
        function hideItemsRequiringPermissions() {
            console.log(' Hiding all menu items that require permissions...');
            
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            let hiddenCount = 0;
            
            itemsRequiringPermissions.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                item.classList.remove('menu-visible');
                hiddenCount++;
                console.log(` Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
            });
            
            // Hide dropdowns that only contain permission-required items
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length === 0) {
                    dropdown.classList.remove('menu-visible');
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    console.log(` Hiding dropdown (no visible children): ${dropdownFeature}`);
                }
            });
            
            console.log(` Hidden ${hiddenCount} items requiring permissions`);
            
            // Ensure at least home is visible
            ensureHomeIsVisible();
        }

        // Ensure home menu item is visible as fallback
        function ensureHomeIsVisible() {
            const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
            if (homeItem && !homeItem.classList.contains('menu-visible')) {
                homeItem.classList.add('menu-visible');
                console.log(' Ensured home menu item is visible as fallback');
            }
        }

        // Show sidebar and remove loading state after authentication and filtering
        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
                console.log(' Sidebar loading state removed - menu authorization complete');
            }
        }

        // Initialize Profile Manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.profileManager = new ProfileManager();
            
            // Initialize feature authorization (exactly as in project-list.html)
            // Wait for auth manager to be ready
            setTimeout(async () => {
                try {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) sidebar.classList.add('menu-loading');
                    await updateMenuWithFeatureAuthorization();
                    // Note: showSidebarAfterAuth() is called internally but as fallback we ensure it's removed
                    if (sidebar && sidebar.classList.contains('menu-loading')) {
                        sidebar.classList.remove('menu-loading');
                    }
                    // Header is hydrated by now (user + company branding);
                    // remove header-loading to reveal the right side without flicker
                    const topNav = document.querySelector('.top-nav');
                    if (topNav) topNav.classList.remove('header-loading');
                } catch (error) {
                    console.error(' Error initializing feature-based menu:', error);
                    showBasicMenu();
                }
            }, 500);
            
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
            
            // Notification dropdown functionality
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (notificationDropdown && !notificationBtn.contains(e.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });
        });
    </script>
    <!-- Signature Create Modal -->
    <div id="signatureCreateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2200; align-items:center; justify-content:center; padding:20px;">
        <div style="background:#fff; width:760px; max-width:95%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15);">
            <div style="padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div id="sigCreateModalTitle" style="font-weight:600;">Create Signature</div>
                <button id="sigCreateCancelBtn" type="button" style="background:transparent; border:none; font-size:1.1rem; cursor:pointer; line-height:1;"></button>
            </div>
            <div style="padding:14px 16px;">
                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                    <div role="group" aria-label="Signature mode" style="display:inline-flex; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
                        <button id="sigCreateModeDraw" type="button" style="padding:6px 10px; background:#111827; color:#fff; border:none; font-size:0.8rem;">Draw</button>
                        <button id="sigCreateModeType" type="button" style="padding:6px 10px; background:#fff; color:#111827; border:none; border-left:1px solid #e5e7eb; font-size:0.8rem;">Type</button>
                        <button id="sigCreateModeUpload" type="button" style="padding:6px 10px; background:#fff; color:#111827; border:none; border-left:1px solid #e5e7eb; font-size:0.8rem;">Upload</button>
                    </div>
                    <div id="sigCreateTypeControls" style="display:none; align-items:center; gap:8px; flex-wrap:wrap;">
                        <input id="typedSignatureCreateInput" type="text" placeholder="Type your name" style="padding:6px 8px; font-size:0.85rem; border:1px solid #e5e7eb; border-radius:6px; min-width:180px;"/>
                        <select id="typedSignatureCreateFont" style="padding:6px 8px; font-size:0.85rem; border:1px solid #e5e7eb; border-radius:6px;">
                            <option value="'Brush Script MT', 'Segoe Script', cursive">Brush Script</option>
                            <option value="'Segoe Script', cursive">Segoe Script</option>
                            <option value="'Lucida Handwriting', cursive">Lucida Handwriting</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans</option>
                            <option value="'Monotype Corsiva', 'Apple Chancery', cursive">Corsiva</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="'Palatino Linotype', 'Book Antiqua', Palatino, serif">Palatino</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet</option>
                            <option value="Verdana, Geneva, sans-serif">Verdana</option>
                            <option value="Impact, Charcoal, sans-serif">Impact</option>
                            <option value="'Courier New', Courier, monospace">Courier</option>
                        </select>
                        <select id="typedSignatureCreateStyle" style="padding:6px 8px; font-size:0.85rem; border:1px solid #e5e7eb; border-radius:6px;">
                            <option value="normal">Normal</option>
                            <option value="italic">Italic</option>
                            <option value="bold">Bold</option>
                            <option value="bold-italic">Bold Italic</option>
                            <option value="underline">Underlined</option>
                        </select>
                        <select id="typedSignatureCreateColor" style="padding:6px 8px; font-size:0.85rem; border:1px solid #e5e7eb; border-radius:6px;">
                            <option value="#111827">Black</option>
                            <option value="#1e40af">Navy Blue</option>
                            <option value="#0369a1">Blue</option>
                            <option value="#166534">Green</option>
                            <option value="#7c2d12">Brown</option>
                            <option value="#6b21a8">Purple</option>
                        </select>
                    </div>
                    <div id="sigCreateUploadControls" style="display:none; align-items:center; gap:8px;">
                        <input id="signatureUploadInput" type="file" accept="image/*" style="padding:6px 8px; font-size:0.85rem; border:1px solid #e5e7eb; border-radius:6px;"/>
                        <span style="font-size:0.8rem; color:#6b7280;">Choose an image file to use as signature</span>
                    </div>
                </div>
                <div style="border:1px dashed #cbd5e1; background:#f8fafc; border-radius:8px; padding:10px;">
                    <canvas id="signatureCreateCanvas" width="720" height="220" style="width:100%; height:auto; background:#fff; border:1px solid #e5e7eb; border-radius:6px;"></canvas>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                        <button id="sigCreateClearBtn" type="button" class="btn-secondary" style="padding:6px 10px; font-size:0.8rem; border:1px solid #e5e7eb; background:#fff; border-radius:6px;">Clear</button>
                        <button id="sigCreateInsertBtn" type="button" class="btn-primary" style="padding:6px 10px; font-size:0.8rem; border:none; background:#2563eb; color:#fff; border-radius:6px;"><i class="fas fa-file-import" style="margin-right:4px;"></i>Insert</button>
                        <button id="sigCreateSaveBtn" type="button" class="btn-primary" style="padding:6px 10px; font-size:0.8rem; border:none; background:#111827; color:#fff; border-radius:6px;">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Signature Selection Modal -->
    <div id="signatureSelectModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2200; align-items:center; justify-content:center; padding:20px;">
        <div style="background:#fff; width:600px; max-width:95%; max-height:85vh; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15); display:flex; flex-direction:column;">
            <div style="padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; flex-shrink:0;">
                <div style="font-weight:600;">Select Signature</div>
                <button id="sigSelectCancelBtn" type="button" style="background:transparent; border:none; font-size:1.1rem; cursor:pointer; line-height:1;"></button>
            </div>
            <div style="padding:14px 16px; overflow-y:auto; flex:1;">
                <p style="margin:0 0 12px; color:#6b7280; font-size:0.85rem;">Click on a signature to select it as your default.</p>
                <div id="signatureSelectGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:12px;"></div>
                <div id="signatureSelectEmpty" style="display:none; text-align:center; padding:30px; color:#9ca3af;">
                    <i class="fas fa-signature" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                    <p>No signatures saved yet.</p>
                    <button id="sigSelectCreateBtn" type="button" style="margin-top:10px; padding:8px 16px; font-size:0.85rem; border:none; background:#111827; color:#fff; border-radius:6px;">Create Signature</button>
                </div>
            </div>
            <div style="padding:12px 16px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:8px; flex-shrink:0;">
                <button id="sigSelectNewBtn" type="button" style="padding:8px 14px; font-size:0.85rem; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:6px;">+ Create New</button>
                <button id="sigSelectCloseBtn" type="button" style="padding:8px 14px; font-size:0.85rem; border:none; background:#111827; color:#fff; border-radius:6px;">Close</button>
            </div>
        </div>
    </div>
    <!-- Timesheet Modal -->
    <div id="timesheetModal" class="timesheet-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; align-items:center; justify-content:center; z-index:2000; padding:20px;">
        <div class="timesheet-modal-content" style="background:white; width:920px; max-width:100%; height:calc(100vh - 40px); max-height:90vh; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15); display:flex; flex-direction:column;">
            <div class="timesheet-modal-header" style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-shrink:0;">
                <h3 style="margin:0; font-size:1.1rem;">Create Timesheet</h3>
                <div style="display:flex; align-items:center; gap:10px; margin-left:auto;">
                    <div style="font-size:0.85rem; color:#6b7280;">
                        <strong style="color:#374151;">Next Approver:</strong>
                        <span id="tsNextApproverDisplay"></span>
                    </div>
                    <button type="button" id="showApprovalFlowBtnTs" class="btn-secondary" title="Show Approval Flow" style="display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:6px; border:1px solid #e5e7eb; background:#fff; color:#374151; font-size:0.8rem;">
                        <i class="fas fa-diagram-project"></i>
                        <span>Flow</span>
                    </button>
                    <button id="closeTimesheetModal" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
                </div>
            </div>
            <div class="timesheet-modal-body" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
                <form id="timesheetForm" style="height:100%; display:flex; flex-direction:column;">
                    <!-- Top Section: Month and Flow -->
                    <div style="padding:16px 20px 0; flex-shrink:0;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="tsMonth" style="font-size:0.8rem; margin-bottom:4px;">Month</label>
                                <input type="month" id="tsMonth" name="tsMonth" required style="width:100%;">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="tsTotalHours" style="font-size:0.8rem; margin-bottom:4px;">Total Hours</label>
                                <input type="number" id="tsTotalHours" name="tsTotalHours" step="0.1" readonly style="width:100%;">
                            </div>
                        </div>
                        
                        <input type="hidden" id="tsId" name="tsId" value="">
                        
                        <div class="form-group" style="margin-bottom:12px;">
                            <div id="tsApprovalFlowDisplay" class="approval-flow-display" style="display:none; margin-top:8px;">
                                <div id="tsApprovalFlowContent" class="approval-flow-list">Loading flow...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Section: Scrollable Days -->
                    <div style="padding:0 20px; flex:1; min-height:0; display:flex; flex-direction:column;">
                        <div class="form-group" style="flex:1; display:flex; flex-direction:column; margin-bottom:0;">
                            <label style="font-size:0.8rem; margin-bottom:8px; font-weight:600;">Daily Hours</label>
                            <div id="tsDaysContainer" style="border:1px solid #eee; border-radius:8px; padding:8px; flex:1; overflow-y:auto; min-height:200px; max-height:300px;"></div>
                        </div>
                    </div>

                    <!-- Bottom Section: Summary and Notes -->
                    <div style="padding:12px 20px 0; flex-shrink:0;">
                        <div class="form-group" style="margin-bottom:12px;">
                            <label style="font-size:0.8rem; margin-bottom:4px; font-weight:600;">Allocation & Overtime</label>
                            <div style="display:flex; gap:16px; flex-wrap:wrap; color:#444; font-size:0.8rem; padding:8px; background:#f8f9fa; border-radius:6px;">
                                <div>Weekly: <strong id="tsAllocatedWeeklyHours">--</strong> hrs</div>
                                <div>Overtime: <strong id="tsComputedOvertime">0</strong> hrs</div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom:16px;">
                            <label for="tsNotes" style="font-size:0.8rem; margin-bottom:4px;">Notes</label>
                            <textarea id="tsNotes" name="tsNotes" rows="2" style="width:100%; resize:vertical; min-height:40px;"></textarea>
                        </div>

                        <div style="display:flex; gap:8px; justify-content:flex-end; padding-bottom:8px;">
                            <button type="button" id="saveTimesheetBtn" class="btn-primary" style="padding:8px 16px; font-size:0.85rem;">Save</button>
                            <button type="button" id="submitTimesheetBtn" class="btn-primary" style="padding:8px 16px; font-size:0.85rem;">Save & Submit</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="timesheet-modal-footer">
                <div class="footer-note">Tip: Use the month picker to generate days, then enter start/end times. The grid scrolls if necessary.</div>
                <div class="footer-actions">
                    <button type="button" class="btn-primary" id="footerSaveBtn" title="Save" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px;">
                        <i class="fas fa-save"></i><span>Save</span>
                    </button>
                    <button type="button" class="btn-primary" id="footerSubmitBtn" title="Save & Submit" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px;">
                        <i class="fas fa-paper-plane"></i><span>Save & Submit</span>
                    </button>
                    <button type="button" class="btn-secondary" id="closeTimesheetFooterBtn" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Open and prefill an existing timesheet for editing
        ProfileManager.prototype.openEditTimesheetModal = async function(timesheetId) {
            if (!timesheetId) return;
            try {
                this.showLoading(true);
                const snapshot = await db.ref(`timesheets/${timesheetId}`).once('value');
                const ts = snapshot.exists() ? snapshot.val() : null;
                if (!ts) return this.showNotification('Timesheet not found', 'error');

                // Prefill form
                const form = document.getElementById('timesheetForm');
                if (form) form.reset();

                document.getElementById('tsId').value = ts.id || '';
                document.getElementById('tsMonth').value = ts.month || '';
                document.getElementById('tsNotes').value = ts.notes || '';
                document.getElementById('tsTotalHours').value = ts.totalHours != null ? ts.totalHours : '';

                // Generate days and fill per-day inputs
                this.generateMonthDays(ts.month);

                // After generating, populate rows
                setTimeout(async () => {
                    // Fetch and store working hours per day for overtime column
                    try {
                        const emailOwner = ts.submittedByEmail || (this.currentUser && this.currentUser.email) || '';
                        const whDay = await this.fetchWorkingHoursPerDayForUserEmail(emailOwner);
                        this._tsWorkingHoursPerDay = (typeof whDay === 'number' && whDay > 0) ? whDay : 8;
                    } catch (e) {
                        console.warn('Unable to fetch working hours per day for edit modal:', e);
                        this._tsWorkingHoursPerDay = 8;
                    }
                    const daysContainer = document.getElementById('tsDaysContainer');
                    if (!daysContainer || !ts.days) return;
                    // Map days by date for quick lookup
                    const dayMap = {};
                    ts.days.forEach(d => { dayMap[d.date] = d; });

                    const rows = Array.from(daysContainer.children);
                    rows.forEach(row => {
                        const date = row.querySelector('input[type="time"]')?.dataset.date;
                        if (!date) return;
                        const data = dayMap[date];
                        if (!data) return;
                        const timeInputs = row.querySelectorAll('input[type="time"]');
                        if (timeInputs && timeInputs.length >= 2) {
                            timeInputs[0].value = data.start || '';
                            timeInputs[1].value = data.end || '';
                        }
                        const brInput = row.querySelector('input[type="number"]');
                        if (brInput) brInput.value = data.break || '';
                        const commentInput = row.querySelector('input[type="text"]');
                        if (commentInput) commentInput.value = data.comment || '';
                        const hoursDisplay = row.querySelector('div[data-date]');
                        if (hoursDisplay) hoursDisplay.textContent = data.hours != null ? data.hours : '';
                        // Set daily overtime display based on saved hours
                        try {
                            const otEl = row.querySelector('div[data-ot-for]');
                            if (otEl) {
                                const std = (typeof this._tsWorkingHoursPerDay === 'number' && this._tsWorkingHoursPerDay > 0) ? this._tsWorkingHoursPerDay : 8;
                                const hrs = parseFloat(data.hours) || 0;
                                const ot = hrs > 0 ? Math.max(0, hrs - std) : 0;
                                const otRounded = Math.round((ot + Number.EPSILON) * 100) / 100;
                                otEl.textContent = otRounded ? otRounded.toString() : '0';
                            }
                        } catch (_) {}
                    });

                    // Recompute total just in case
                    const totalField = document.getElementById('tsTotalHours');
                    if (totalField) totalField.value = this.computeTotalHoursFromDays();

                    // Show modal
                    const modal = document.getElementById('timesheetModal');
                    if (modal) modal.style.display = 'flex';
                    // Next approver field removed; still render grouped flow without relying on element
                    if (document.getElementById('tsNextApproverDisplay')) {
                        this.updateTimesheetApproverDisplay(ts);
                    } else {
                        // Directly render approval flow highlighting current step without next approver element
                        this.fetchTimesheetApprovalFlowDetailed()
                            .then(detailed => {
                                const levels = detailed.levels || [];
                                const flat = detailed.flat || [];
                                const hist = (ts && Array.isArray(ts.approvalHistory)) ? ts.approvalHistory : [];
                                const approvalsByStep = new Map();
                                hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                                let currentFlatIdx = 0;
                                for (let i = 0; i < flat.length; i++) {
                                    const e = approvalsByStep.get(i);
                                    if (!e || (e.status||'').toLowerCase() !== 'approved') { currentFlatIdx = i; break; }
                                    if (i === flat.length - 1) currentFlatIdx = flat.length;
                                }
                                return this.renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx);
                            })
                            .catch(()=>{});
                    }
                    // Update approval button visibility
                    this.updateApprovalButtonVisibility(ts);
                    setTimeout(() => this.adjustTimesheetModalSize(), 60);

                    // Fetch and display allocated weekly hours for the timesheet owner
                    try {
                        const email = ts.submittedByEmail || (this.currentUser && this.currentUser.email) || '';
                        const wh = await this.fetchWorkingHoursForUserEmail(email);
                        this._tsAllocatedWeeklyHours = wh;
                        const span = document.getElementById('tsAllocatedWeeklyHours');
                        if (span) span.textContent = String(wh);
                        if (typeof this.updateTimesheetOvertimeDisplay === 'function') {
                            this.updateTimesheetOvertimeDisplay();
                        }
                    } catch (e) {
                        console.warn('Unable to fetch allocated weekly hours for edit modal:', e);
                    }
                }, 80);

            } catch (error) {
                console.error('Error opening timesheet for edit', error);
                this.showNotification('Failed to load timesheet', 'error');
            } finally {
                this.showLoading(false);
            }
        };
    </script>
    <script>
        // Show next approver and full flow (grouped by levels) in the timesheet modal
        ProfileManager.prototype.updateTimesheetApproverDisplay = async function(ts) {
            try {
                const el = document.getElementById('tsNextApproverDisplay');
                if (!el) return;
                el.textContent = 'Loading approver...';

                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const levels = detailed.levels || [];
                const flat = detailed.flat || [];
                if (!flat.length) {
                    el.textContent = 'No approval flow configured';
                    await this.renderTimesheetApprovalFlowGrouped(levels, flat, 0);
                    return;
                }

                const hist = (ts && Array.isArray(ts.approvalHistory)) ? ts.approvalHistory : [];
                const approvalsByStep = new Map();
                hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                let currentFlatIdx = 0;
                for (let i = 0; i < flat.length; i++) {
                    const e = approvalsByStep.get(i);
                    if (!e || (e.status||'').toLowerCase() !== 'approved') { currentFlatIdx = i; break; }
                    if (i === flat.length - 1) currentFlatIdx = flat.length;
                }

                if (currentFlatIdx >= flat.length) {
                    el.textContent = 'All approvals complete';
                } else {
                    const step = flat[currentFlatIdx];
                    let who = '';
                    if (step.userId) {
                        try { who = await this.getUserDisplayNameById(step.userId); } catch { who = step.userId; }
                    } else if (step.email) {
                        try { who = await this.getUserDisplayNameByEmail(step.email); } catch { who = step.email; }
                    } else if (step.label) {
                        who = step.label;
                    } else if (step.role) {
                        who = step.role;
                    } else {
                        who = 'Unassigned approver';
                    }
                    const meta = step.role || step.label ? ` (${step.role || step.label})` : '';
                    el.textContent = `Next: ${who}${meta}`;
                }

                await this.renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx);
            } catch (err) {
                const el = document.getElementById('tsNextApproverDisplay');
                if (el) el.textContent = '';
                console.warn('Failed to update next approver display', err);
            }
        };
    </script>
    <script>
        // Fetch the weekly working hours from the employee's contract by email
        ProfileManager.prototype.fetchWorkingHoursForUserEmail = async function(email) {
            try {
                const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId) || null;
                const pickLatest = (obj) => {
                    const arr = obj ? Object.values(obj) : [];
                    if (!arr.length) return null;
                    arr.sort((a,b) => {
                        const at = new Date(a.updatedAt || a.createdAt || 0).getTime();
                        const bt = new Date(b.updatedAt || b.createdAt || 0).getTime();
                        return bt - at;
                    });
                    return arr[0];
                };

                // Prefer company-scoped contracts
                if (companyId && email) {
                    try {
                        const snap = await db.ref(`companies/${companyId}/contracts`).orderByChild('employeeEmail').equalTo(email).once('value');
                        if (snap.exists()) {
                            const latest = pickLatest(snap.val());
                            const wh = parseInt(latest && latest.workingHours);
                            if (Number.isFinite(wh) && wh > 0) return wh;
                        }
                    } catch (e) {
                        console.warn('Company-scoped contracts lookup failed:', e);
                    }
                }

                // Fallback to global contracts
                if (email) {
                    try {
                        const snap2 = await db.ref('contracts').orderByChild('employeeEmail').equalTo(email).once('value');
                        if (snap2.exists()) {
                            const latest2 = pickLatest(snap2.val());
                            const wh2 = parseInt(latest2 && latest2.workingHours);
                            if (Number.isFinite(wh2) && wh2 > 0) return wh2;
                        }
                    } catch (e2) {
                        console.warn('Global contracts lookup failed:', e2);
                    }
                }
            } catch (e) {
                console.warn('fetchWorkingHoursForUserEmail error:', e);
            }
            return 40; // default
        };

        // Fetch the working hours per day from the employee's contract by email
        ProfileManager.prototype.fetchWorkingHoursPerDayForUserEmail = async function(email) {
            try {
                const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId) || null;
                const pickLatest = (obj) => {
                    const arr = obj ? Object.values(obj) : [];
                    if (!arr.length) return null;
                    arr.sort((a,b) => {
                        const at = new Date(a.updatedAt || a.createdAt || 0).getTime();
                        const bt = new Date(b.updatedAt || b.createdAt || 0).getTime();
                        return bt - at;
                    });
                    return arr[0];
                };

                if (companyId && email) {
                    try {
                        const snap = await db.ref(`companies/${companyId}/contracts`).orderByChild('employeeEmail').equalTo(email).once('value');
                        if (snap.exists()) {
                            const latest = pickLatest(snap.val());
                            const v = parseFloat(latest && latest.workingHoursPerDay);
                            if (Number.isFinite(v) && v > 0) return v;
                        }
                    } catch (e) {
                        console.warn('Company-scoped contracts lookup (per day) failed:', e);
                    }
                }

                if (email) {
                    try {
                        const snap2 = await db.ref('contracts').orderByChild('employeeEmail').equalTo(email).once('value');
                        if (snap2.exists()) {
                            const latest2 = pickLatest(snap2.val());
                            const v2 = parseFloat(latest2 && latest2.workingHoursPerDay);
                            if (Number.isFinite(v2) && v2 > 0) return v2;
                        }
                    } catch (e2) {
                        console.warn('Global contracts lookup (per day) failed:', e2);
                    }
                }
            } catch (e) {
                console.warn('fetchWorkingHoursPerDayForUserEmail error:', e);
            }
            return 8; // default
        };

        // Compute monthly overtime from the current grid vs allocated weekly hours
        ProfileManager.prototype.computeMonthlyOvertimeFromGrid = function(allocatedWeeklyHours) {
            try {
                const container = document.getElementById('tsDaysContainer');
                if (!container) return 0;
                const rows = Array.from(container.children || []);
                const weekly = {};
                rows.forEach(row => {
                    const hoursDisplay = row.querySelector('div[data-date]');
                    const dateIso = hoursDisplay ? hoursDisplay.getAttribute('data-date') : null;
                    if (!dateIso) return;
                    const h = parseFloat(hoursDisplay.textContent) || 0;
                    if (!h) return;
                    const d = new Date(dateIso);
                    const wn = this.getWeekNumber(d);
                    weekly[wn] = (weekly[wn] || 0) + h;
                });
                let overtime = 0;
                const alloc = Number.isFinite(allocatedWeeklyHours) && allocatedWeeklyHours > 0 ? allocatedWeeklyHours : 40;
                Object.values(weekly).forEach(sum => { if (sum > alloc) overtime += (sum - alloc); });
                return Math.round((overtime + Number.EPSILON) * 100) / 100;
            } catch (e) {
                return 0;
            }
        };

        // Update overtime display in the modal
        ProfileManager.prototype.updateTimesheetOvertimeDisplay = function() {
            try {
                const allocEl = document.getElementById('tsAllocatedWeeklyHours');
                const otEl = document.getElementById('tsComputedOvertime');
                const alloc = this._tsAllocatedWeeklyHours || 40;
                if (allocEl) allocEl.textContent = String(alloc);
                if (otEl) {
                    const ot = this.computeMonthlyOvertimeFromGrid(alloc);
                    otEl.textContent = String(ot);
                }
            } catch (_) {}
        };
    </script>
    <!-- View Submitted Timesheet Modal -->
    <div id="viewTimesheetModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; align-items:center; justify-content:center; z-index:2100;">
        <div style="background:white; width:920px; max-width:95%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15);">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="viewTsTitle" style="margin:0; font-size:1.1rem;">Timesheet Details</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="printViewTimesheetBtn" class="btn-secondary" title="Print / PDF" style="background:none; border:none; font-size:1rem; cursor:pointer;">
                        <i class="fas fa-print"></i>
                    </button>
                    <button id="exportViewTimesheetPdfBtn" class="btn-secondary" title="Export to PDF" style="background:none; border:none; font-size:1rem; cursor:pointer;">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button id="closeViewTimesheetModal" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
                </div>
            </div>
            <div class="ts-a4-scroll">
                <div class="ts-a4-doc" id="viewTsDocument">
                    <div class="ts-a4-header">
                        <img id="viewTsCompanyLogo" class="ts-a4-logo" alt="Company logo"/>
                        <div class="ts-a4-company">
                            <h1 id="viewTsCompanyName">Company</h1>
                            <div class="ts-a4-title">Timesheet Document</div>
                            <div class="ts-a4-generated">Generated: <span id="viewTsGeneratedAt"></span></div>
                        </div>
                    </div>
                    <div class="ts-a4-section">
                        <h2>Summary</h2>
                        <div class="ts-a4-meta">
                            <div class="item"><label>Submitted By</label><span id="viewTsMeta"></span></div>
                            <div class="item"><label>Working Hours/Day</label><span><strong id="viewTsWorkingHoursDay">--</strong> hrs</span></div>
                        </div>
                    </div>
                    <div class="ts-a4-section ts-a4-table-area">
                        <h2>Timesheet Details</h2>
                        <div id="viewTsDays"></div>
                    </div>
                    <div class="ts-a4-section">
                        <h2>Notes</h2>
                        <div id="viewTsNotes" class="ts-a4-notes"></div>
                    </div>
                    <div class="ts-a4-section ts-a4-approval">
                        <h3>Approval Flow & History</h3>
                        <div class="form-group" style="margin-bottom:8px;">
                            <label style="display:block; font-weight:600; margin-bottom:4px;">Approval Flow</label>
                            <div id="viewTsApprovalFlowDisplay" class="approval-flow-display" style="display:block;">
                                <div id="viewTsApprovalFlowContent" class="approval-flow-list">Loading flow...</div>
                            </div>
                        </div>
                        <div id="approvalHistory" style="margin-bottom:8px; color:#555;"></div>
                        <div id="approvalActions" style="display:flex; gap:8px; align-items:center;">
                            <div id="viewApproverInfo" style="margin-right:12px; align-self:center; color:#666;"></div>
                            <button type="button" class="btn-approve" id="viewApproveTimesheetBtn" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button type="button" class="btn-decline" id="viewDeclineTimesheetBtn" title="Decline">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn-delete" id="viewDeleteTimesheetBtn" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- PDF libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        ProfileManager.prototype.openViewTimesheetModal = async function(timesheetId) {
            if (!timesheetId) return;
            
            // Store the current timesheet ID for approval actions
            this.currentViewTimesheetId = timesheetId;
            
            try {
                this.showLoading(true);
                const snap = await db.ref(`timesheets/${timesheetId}`).once('value');
                const ts = snap.exists() ? snap.val() : null;
                if (!ts) return this.showNotification('Timesheet not found', 'error');

                document.getElementById('viewTsTitle').textContent = `Timesheet: ${ts.month || ''}  ${ts.status || ''}`;
                const metaStr = `<strong>Submitted by:</strong> ${ts.submittedByEmail || ts.submittedBy || ''} <br><strong>Submitted At:</strong> ${ts.submittedAt ? new Date(ts.submittedAt).toLocaleString() : ''}`;
                document.getElementById('viewTsMeta').innerHTML = metaStr;
                const genAt = document.getElementById('viewTsGeneratedAt');
                if (genAt) genAt.textContent = new Date().toLocaleString();
                const hdrLogo = document.getElementById('headerCompanyLogo');
                const vLogo = document.getElementById('viewTsCompanyLogo');
                if (hdrLogo && vLogo) {
                    if (hdrLogo.src) { vLogo.src = hdrLogo.src; vLogo.style.display = (hdrLogo.style.display !== 'none') ? 'block' : 'none'; }
                }
                const hdrName = document.getElementById('headerCompanyName');
                const vName = document.getElementById('viewTsCompanyName');
                if (vName) vName.textContent = (hdrName && hdrName.textContent) ? hdrName.textContent.trim() : (this.currentCompany?.companyName || this.currentCompany?.name || 'Company');

                // Fetch and display Working Hours/Day from the employee's contract
                let dailyStandardHours = null;
                try {
                    const email = ts.submittedByEmail || '';
                    let whDay = null;
                    if (email) {
                        whDay = await this.fetchWorkingHoursPerDayForUserEmail(email);
                    }
                    // Fallback: if email missing or not found, leave as default
                    const whDayEl = document.getElementById('viewTsWorkingHoursDay');
                    if (whDayEl) {
                        const v = (typeof whDay === 'number' && whDay > 0) ? whDay : '--';
                        whDayEl.textContent = v;
                    }
                    if (typeof whDay === 'number' && whDay > 0) dailyStandardHours = whDay; else dailyStandardHours = 8;
                } catch (e) {
                    const whDayEl = document.getElementById('viewTsWorkingHoursDay');
                    if (whDayEl) whDayEl.textContent = '--';
                    dailyStandardHours = 8;
                }

                // Render days table
                const daysContainer = document.getElementById('viewTsDays');
                daysContainer.innerHTML = '';
                let daysArr = [];
                if (Array.isArray(ts.days)) {
                    daysArr = ts.days.slice();
                } else if (ts.days && typeof ts.days === 'object') {
                    daysArr = Object.values(ts.days);
                }
                if (daysArr.length) {
                    // sort by date if present
                    daysArr.sort((a,b) => {
                        const ad = a && a.date ? new Date(a.date).getTime() : 0;
                        const bd = b && b.date ? new Date(b.date).getTime() : 0;
                        return ad - bd;
                    });
                    const table = document.createElement('table');
                    table.className = 'ts-a4-table';
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    const thead = document.createElement('thead');
                    thead.innerHTML = `<tr><th>Date</th><th>Start</th><th>End</th><th>Break</th><th>Hours</th><th>Overtime</th><th>Comment</th></tr>`;
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    let totalHours = 0;
                    let totalOvertime = 0;
                    daysArr.forEach(d => {
                        const dateStr = d && d.date ? new Date(d.date).toLocaleDateString() : '';
                        const hrs = (d && typeof d.hours !== 'undefined') ? parseFloat(d.hours) || 0 : 0;
                        const std = (typeof dailyStandardHours === 'number' && dailyStandardHours > 0) ? dailyStandardHours : 8;
                        const ot = hrs > 0 ? Math.max(0, hrs - std) : 0;
                        const otRounded = Math.round((ot + Number.EPSILON) * 100) / 100;
                        totalHours += (Number.isFinite(hrs) ? hrs : 0);
                        totalOvertime += otRounded;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style='padding:6px;'>${dateStr}</td><td style='padding:6px;'>${(d && d.start) || ''}</td><td style='padding:6px;'>${(d && d.end) || ''}</td><td style='padding:6px;'>${(d && d.break) || ''}</td><td style='padding:6px;'>${(d && d.hours)!=null?d.hours:''}</td><td style='padding:6px; text-align:right;'>${otRounded ? otRounded : 0}</td><td style='padding:6px;'>${(d && d.comment) || ''}</td>`;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    // Totals row in table footer
                    const tfoot = document.createElement('tfoot');
                    const trTot = document.createElement('tr');
                    trTot.style.borderTop = '1px solid #eee';
                    const hoursTot = Math.round((totalHours + Number.EPSILON) * 100) / 100;
                    const otTot = Math.round((totalOvertime + Number.EPSILON) * 100) / 100;
                    trTot.innerHTML = `<td colspan="4" style="padding:6px; font-weight:600;">Total</td>`+
                                      `<td style="padding:6px; font-weight:600; text-align:right;">${hoursTot}</td>`+
                                      `<td style="padding:6px; font-weight:600; text-align:right;">${otTot}</td>`+
                                      `<td style="padding:6px;"></td>`;
                    tfoot.appendChild(trTot);
                    table.appendChild(tfoot);
                    daysContainer.appendChild(table);
                } else {
                    daysContainer.innerHTML = '<div style="padding:8px; color:#666;">No day entries</div>';
                }

                document.getElementById('viewTsNotes').textContent = ts.notes || '';

                // Load detailed company approval flow (levels preserved)
                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const levels = detailed.levels || [];
                const flat = detailed.flat || [];
                const hist = Array.isArray(ts.approvalHistory) ? ts.approvalHistory : [];
                const approvalsByStepView = new Map();
                hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStepView.set(h.stepIndex, h); });
                const approvedCountView = Array.from(approvalsByStepView.values()).filter(h => (h.status||'').toLowerCase()==='approved').length;
                const currentFlatIdx = Math.min(approvedCountView, flat.length);
                await this.renderTimesheetApprovalFlowGrouped(levels, flat, currentFlatIdx, 'viewTsApprovalFlowContent');

                // Approval history
                
                const histEl = document.getElementById('approvalHistory');
                histEl.innerHTML = '';

                // Render approval history entries only (avoid duplicating flow display)
                if (hist.length) {
                    histEl.innerHTML = '';
                    let visibleCount = 0;
                    for (let i = 0; i < hist.length; i++) {
                        const h = hist[i];
                        const statusLower = (h.status || '').toLowerCase();
                        // Only show approved/rejected events; hide pending entries
                        if (!(statusLower === 'approved' || statusLower === 'rejected')) {
                            continue;
                        }

                        const entryDiv = document.createElement('div');
                        entryDiv.style.padding = '6px 0';
                        entryDiv.style.borderBottom = '1px dashed #eee';
                        const whoRaw = h.submittedByEmail || h.submittedBy || '';
                        entryDiv.textContent = `${h.status} by ${whoRaw} on ${h.submittedAt ? new Date(h.submittedAt).toLocaleString() : ''}`;
                        if (h.comment) {
                            const c = document.createElement('div');
                            c.style.color = '#666';
                            c.textContent = h.comment;
                            entryDiv.appendChild(c);
                        }
                        histEl.appendChild(entryDiv);
                        visibleCount++;

                        // If submittedBy looks like a UID, try to resolve name
                        if (!h.submittedByEmail && h.submittedBy && typeof h.submittedBy === 'string') {
                            this.getUserDisplayNameById(h.submittedBy).then(name => {
                                entryDiv.textContent = `${h.status} by ${name} on ${h.submittedAt ? new Date(h.submittedAt).toLocaleString() : ''}`;
                                if (h.comment) {
                                    const c = document.createElement('div');
                                    c.style.color = '#666';
                                    c.textContent = h.comment;
                                    entryDiv.appendChild(c);
                                }
                            }).catch(()=>{});
                        }
                    }

                    if (visibleCount === 0) {
                        histEl.innerHTML = '<div style="color:#666;">No approval history</div>';
                    }
                } else {
                    histEl.innerHTML = '<div style="color:#666;">No approval history</div>';
                }

                // Actions (determine next approver from flow if available)
                const actionsEl = document.getElementById('approvalActions');
                const approverInfoEl = document.getElementById('viewApproverInfo');
                if (approverInfoEl) approverInfoEl.textContent = '';

                // Determine next pending step index
                let nextStepIndex = null;
                if (flat && Array.isArray(flat) && flat.length > 0) {
                    for (let i = 0; i < flat.length; i++) {
                        const e = approvalsByStepView.get(i);
                        if (!e || (e.status||'').toLowerCase() !== 'approved') { nextStepIndex = i; break; }
                    }
                    if (nextStepIndex === null) nextStepIndex = flat.length; // all approved
                }

                // Determine whether current user can approve this next step
                let canApprove = false;
                let approverLabel = null;
                if (flat && Array.isArray(flat) && nextStepIndex !== null && nextStepIndex < flat.length) {
                    const step = flat[nextStepIndex];
                    // step may be object like { role: 'manager' } or { userId: 'uid' } or { approver: 'manager' }
                    const stepRole = step.role || step.approver || null;
                    const stepUser = step.userId || step.user || step.uid || null;
                    const stepEmail = step.email || null;
                    const stepLabel = step.label || null;
                    approverLabel = stepLabel || stepRole || stepUser || stepEmail || JSON.stringify(step);

                    if (stepUser && this.currentUser && this.currentUser.uid === stepUser) canApprove = true;
                    if (stepRole && this.currentUser && this.currentUser.role && this.currentUser.role.toLowerCase().includes(String(stepRole).toLowerCase())) canApprove = true;
                } else {
                    // fallback simple permission: managers/supervisors/admins can approve if there is at least one pending
                    const role = (this.currentUser && this.currentUser.role) ? this.currentUser.role.toLowerCase() : '';
                    if ((role.includes('manager') || role.includes('supervisor') || role.includes('admin')) && ts.status === 'submitted') canApprove = true;
                }

                // Update approver info text; do not remove the static buttons
                if (approverInfoEl) {
                    approverInfoEl.textContent = approverLabel ? `Approver: ${approverLabel}` : '';
                    if (approverLabel && typeof approverLabel === 'string' && approverLabel.length > 8 && !approverLabel.includes(' ')) {
                        if (approverLabel.includes('@')) {
                            this.getUserDisplayNameByEmail(approverLabel).then(name => {
                                approverInfoEl.textContent = `Approver: ${name}`;
                            }).catch(()=>{});
                        } else {
                            this.getUserDisplayNameById(approverLabel).then(name => {
                                approverInfoEl.textContent = `Approver: ${name}`;
                            }).catch(()=>{});
                        }
                    }
                }

                // Store next step index for later approval actions from static buttons
                this.currentViewTimesheetNextStepIndex = (typeof nextStepIndex === 'number') ? nextStepIndex : null;

                // Keep full timesheet data for export
                this.currentViewTimesheetData = {
                    ...ts,
                    id: timesheetId,
                    month: ts.month || '',
                    status: ts.status || '',
                    submittedBy: ts.submittedByEmail || ts.submittedBy || ''
                };

                // Show/hide approval buttons based on permissions and timesheet status
                this.updateApprovalButtonVisibility(ts);

                // Show modal
                const modal = document.getElementById('viewTimesheetModal');
                if (modal) modal.style.display = 'flex';

            } catch (error) {
                console.error('Error opening view modal', error);
                this.showNotification('Failed to load timesheet', 'error');
            } finally {
                this.showLoading(false);
            }
        };

        // Export the current view timesheet modal content to PDF (professional travel.html style)
        ProfileManager.prototype.exportViewTimesheetToPdf = async function() {
            try {
                const timesheet = this.currentViewTimesheetData;
                if (!timesheet) {
                    this.showNotification('Nothing to export', 'warning');
                    return;
                }

                // Gather company branding
                const companyNameEl = document.getElementById('headerCompanyName');
                const companyLogoEl = document.getElementById('headerCompanyLogo');
                const companyName = (companyNameEl && companyNameEl.textContent || '').trim() || 'Company Name';
                const companyLogoSrc = (companyLogoEl && companyLogoEl.src && companyLogoEl.src.length > 0) ? companyLogoEl.src : null;

                // Create PDF with professional styling
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                
                // Professional color scheme (matching travel.html)
                const primaryColor = [45, 55, 72]; // Dark gray
                const secondaryColor = [113, 128, 150]; // Medium gray
                const lightGray = [247, 250, 252]; // Very light gray

                // Gather employee metadata (submitter) with safe fallbacks
                const submitterUid = (timesheet.submittedBy && typeof timesheet.submittedBy === 'string' && !String(timesheet.submittedBy).includes('@'))
                    ? timesheet.submittedBy
                    : null;
                const submitterEmail = timesheet.submittedByEmail
                    || (timesheet.submittedBy && String(timesheet.submittedBy).includes('@') ? timesheet.submittedBy : '')
                    || '';
                let employeeMeta = {
                    name: timesheet.employeeName || '',
                    email: submitterEmail || '',
                    role: timesheet.employeeRole || '',
                    department: timesheet.department || '',
                    employeeId: timesheet.employeeId || timesheet.employeeID || ''
                };
                try {
                    if (typeof db !== 'undefined' && db && db.ref) {
                        let userSnap = null;
                        if (submitterUid) {
                            userSnap = await db.ref(`users/${submitterUid}`).once('value');
                        } else if (submitterEmail) {
                            const q = await db.ref('users').orderByChild('email').equalTo(submitterEmail).once('value');
                            const val = q && q.val ? q.val() : null;
                            if (val && typeof val === 'object') {
                                const firstKey = Object.keys(val)[0];
                                if (firstKey) {
                                    userSnap = { exists: () => true, val: () => val[firstKey] };
                                }
                            }
                        }
                        if (userSnap && userSnap.exists && userSnap.exists()) {
                            const u = userSnap.val();
                            employeeMeta.name = employeeMeta.name || u.name || u.displayName || u.fullName || '';
                            employeeMeta.email = employeeMeta.email || u.email || '';
                            employeeMeta.role = employeeMeta.role || u.role || '';
                            employeeMeta.department = employeeMeta.department || u.department || u.dept || '';
                            employeeMeta.employeeId = employeeMeta.employeeId || u.employeeId || u.employeeID || u.staffId || '';
                        }
                    }
                } catch (empErr) {
                    console.warn('Could not enrich employee metadata for PDF:', empErr);
                }

                let yPosition = 25;
                const leftColumn = 20;
                const pageWidth = pdf.internal.pageSize.getWidth();

                // Company logo if available (no initials fallback by request)
                if (companyLogoSrc) {
                    try {
                        const logoImg = await new Promise((resolve, reject) => {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = () => resolve(img);
                            img.onerror = () => reject(new Error('Logo load failed'));
                            img.src = companyLogoSrc;
                        });
                        // Enlarge logo to better match leave preview hierarchy
                        const maxLogoH = 28; // pt (was 20)
                        const maxLogoW = 100; // pt (was 60)
                        const ratio = Math.min(maxLogoW / logoImg.width, maxLogoH / logoImg.height);
                        const drawW = Math.max(1, logoImg.width * ratio);
                        const drawH = Math.max(1, logoImg.height * ratio);
                        pdf.addImage(logoImg, 'PNG', leftColumn, 15, drawW, drawH, undefined, 'FAST');
                    } catch (e) {
                        // Intentionally do nothing; no initials fallback
                    }
                }

                // Company name and title
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(companyName, leftColumn, 45);
                
                // Make document title smaller than company name (parity with Leave)
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Timesheet Document', leftColumn, 60);
                
                yPosition = 85;

                // Timesheet Information Section
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('TIMESHEET INFORMATION', leftColumn, yPosition);
                yPosition += 15;

                // Timesheet details
                pdf.setFontSize(10);

                pdf.setFont('helvetica', 'bold');
                pdf.text('Employee:', leftColumn, yPosition);
                pdf.setFont('helvetica', 'normal');
                pdf.text((employeeMeta.name || employeeMeta.email || timesheet.submittedBy || ''), leftColumn + 70, yPosition);
                yPosition += 12;

                if (employeeMeta.email) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Email:', leftColumn, yPosition);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(employeeMeta.email, leftColumn + 70, yPosition);
                    yPosition += 12;
                }

                // Role field removed by request

                if (employeeMeta.department) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Department:', leftColumn, yPosition);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(String(employeeMeta.department), leftColumn + 70, yPosition);
                    yPosition += 12;
                }

                if (employeeMeta.employeeId) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Employee ID:', leftColumn, yPosition);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(String(employeeMeta.employeeId), leftColumn + 70, yPosition);
                    yPosition += 12;
                }

                pdf.setFont('helvetica', 'bold');
                pdf.text('Month/Period:', leftColumn, yPosition);
                pdf.setFont('helvetica', 'normal');
                pdf.text(timesheet.month || '', leftColumn + 70, yPosition);
                yPosition += 12;

                pdf.setFont('helvetica', 'bold');
                pdf.text('Status:', leftColumn, yPosition);
                pdf.setFont('helvetica', 'normal');
                pdf.text((timesheet.status || 'draft').toUpperCase(), leftColumn + 70, yPosition);
                yPosition += 12;

                // Submitted date removed by request

                yPosition += 8;

                // Time Entries table (heading removed by request)

                // Table headers
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'bold');
                const colWidths = [60, 60, 60, 60, 60, 60, 80];
                const headers = ['Date', 'Start', 'End', 'Break', 'Hours', 'Overtime', 'Notes'];
                let xPos = leftColumn;
                
                // Header background (light gray)
                pdf.setFillColor(...lightGray);
                pdf.rect(leftColumn - 2, yPosition - 8, pageWidth - 40, 12, 'F');
                
                // Header text
                pdf.setTextColor(...primaryColor);
                headers.forEach((header, i) => {
                    pdf.text(header, xPos, yPosition);
                    xPos += colWidths[i];
                });
                yPosition += 15;

                // Helpers for time parsing and formatting
                const parseTimeToMinutes = (s) => {
                    if (!s || s === '') return null;
                    const str = String(s).trim();
                    // Handle HH:MM[:SS] with optional AM/PM
                    let m = str.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i);
                    if (m) {
                        let hh = parseInt(m[1], 10);
                        const mm = parseInt(m[2], 10) || 0;
                        const ap = m[4] ? m[4].toUpperCase() : null;
                        if (ap) {
                            if (ap === 'PM' && hh < 12) hh += 12;
                            if (ap === 'AM' && hh === 12) hh = 0;
                        }
                        return hh * 60 + mm;
                    }
                    // Handle plain numbers as hours (e.g., 8.5)
                    if (!isNaN(Number(str))) {
                        return Math.round(Number(str) * 60);
                    }
                    return null;
                };
                const parseBreakToMinutes = (s) => {
                    if (s == null) return 0;
                    const str = String(s).trim();
                    if (str.includes(':')) {
                        const parts = str.split(':');
                        const hh = parseInt(parts[0], 10) || 0;
                        const mm = parseInt(parts[1], 10) || 0;
                        return hh * 60 + mm;
                    }
                    if (!isNaN(Number(str))) return Math.max(0, Math.round(Number(str)));
                    return 0;
                };
                const parseHoursToMinutes = (s) => {
                    if (!s) return 0;
                    const str = String(s).trim();
                    if (str.includes(':')) {
                        const parts = str.split(':');
                        const hh = parseInt(parts[0], 10) || 0;
                        const mm = parseInt(parts[1], 10) || 0;
                        return hh * 60 + mm;
                    }
                    if (!isNaN(Number(str))) return Math.round(Number(str) * 60);
                    return 0;
                };
                const minutesToHoursFixed = (mins) => (mins > 0 ? (mins / 60).toFixed(2) : '0');

                // Table rows - Show full month (all days 1-31)
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                console.log('Timesheet data for PDF:', timesheet); // Debug log
                
                // Derive YYYY-MM for the month; fall back to first entry
                const monthYear = (() => {
                    const m = (timesheet.month || '').trim();
                    if (/^\d{4}-\d{2}$/.test(m)) return m;
                    if (timesheet.days) {
                        try {
                            if (Array.isArray(timesheet.days)) {
                                const d0 = timesheet.days.find(x => x && x.date && !isNaN(new Date(x.date).getTime()));
                                if (d0) return new Date(d0.date).toISOString().slice(0, 7);
                            } else if (typeof timesheet.days === 'object') {
                                const keys = Object.keys(timesheet.days);
                                const k = keys.find(k => /^\d{4}-\d{2}-\d{2}$/.test(k)) || keys[0];
                                if (k && !isNaN(new Date(k).getTime())) return new Date(k).toISOString().slice(0, 7);
                            }
                        } catch (_) {}
                    }
                    return new Date().toISOString().slice(0, 7);
                })();
                let entriesCount = 0;
                let monthlyTotalMinutes = 0;
                
                for (let day = 1; day <= 31; day++) {
                    const dayStr = day.toString().padStart(2, '0');
                    const dateKey = `${monthYear}-${dayStr}`;
                    
                    // Try multiple data structure patterns
                    let entry = null;
                    let startTime = '', endTime = '', breakTime = '0', totalHours = '0', overtime = '', notes = '';
                    
                    // Pattern A: timesheet.days as object keyed by YYYY-MM-DD
                    if (timesheet.days && !Array.isArray(timesheet.days) && timesheet.days[dateKey]) {
                        entry = timesheet.days[dateKey] || null;
                    }
                    // Pattern B: timesheet.days as array with entry.date
                    if (!entry && timesheet.days && Array.isArray(timesheet.days)) {
                        const match = timesheet.days.find(d => d && d.date && !isNaN(new Date(d.date).getTime()) && new Date(d.date).toISOString().slice(0,10) === dateKey);
                        if (match) entry = match;
                    }
                    // Normalize field names from entry
                    if (entry) {
                        startTime = entry.start || entry.startTime || entry.clockIn || '';
                        endTime = entry.end || entry.endTime || entry.clockOut || '';
                        breakTime = (entry.break != null ? entry.break : (entry.breakTime != null ? entry.breakTime : (entry.breakMinutes != null ? entry.breakMinutes : '0'))).toString();
                        totalHours = (entry.hours != null ? entry.hours : (entry.totalHours != null ? entry.totalHours : '0')).toString();
                        overtime = (entry.overtime ?? entry.overTime ?? entry.ot ?? entry.overtimeHours ?? entry.otHours ?? '').toString();
                        notes = entry.comment || entry.notes || '';
                    } else {
                        // Pattern C: individual day fields (day01Start, day01End, etc.)
                        const startKey = `day${dayStr}Start`;
                        const endKey = `day${dayStr}End`;
                        const breakKey = `day${dayStr}Break`;
                        const hoursKey = `day${dayStr}Hours`;
                            const notesKey = `day${dayStr}Notes`;
                            const otKey = `day${dayStr}Overtime`;
                        if (timesheet[startKey] || timesheet[endKey]) {
                            startTime = timesheet[startKey] || '';
                            endTime = timesheet[endKey] || '';
                            breakTime = (timesheet[breakKey] != null ? timesheet[breakKey] : '0').toString();
                            totalHours = (timesheet[hoursKey] != null ? timesheet[hoursKey] : '0').toString();
                                overtime = (timesheet[otKey] != null ? timesheet[otKey] : '').toString();
                            notes = timesheet[notesKey] || '';
                        }
                    }
                    
                    // Count non-empty entries
                    if (startTime !== '' || endTime !== '') {
                        entriesCount++;
                    }
                    
                    // Create date for display
                    const currentDate = new Date(monthYear + '-' + dayStr);
                    const isValidDate = !isNaN(currentDate.getTime()) && currentDate.getDate() == day;
                    
                    // Only show valid dates for the month
                    if (isValidDate) {
                        xPos = leftColumn;
                        // Compute per-day hours if not provided
                        let minutesForDay = 0;
                        const startMins = parseTimeToMinutes(startTime);
                        const endMins = parseTimeToMinutes(endTime);
                        const breakMins = parseBreakToMinutes(breakTime);
                        if (startMins != null && endMins != null) {
                            minutesForDay = Math.max(0, endMins - startMins - (breakMins || 0));
                        } else if (totalHours && totalHours !== '0') {
                            minutesForDay = parseHoursToMinutes(totalHours);
                        }
                        monthlyTotalMinutes += minutesForDay;
                        const hoursDisplay = (totalHours && totalHours !== '0') ? totalHours : minutesToHoursFixed(minutesForDay);
                        
                        // Row data
                        const rowData = [
                            currentDate.toLocaleDateString(),
                            startTime,
                            endTime,
                            breakTime,
                            hoursDisplay,
                            (overtime || ''),
                            notes.length > 15 ? notes.substring(0, 15) + '...' : notes
                        ];
                        
                        // Alternate row background for better readability
                        if (day % 2 === 0) {
                            pdf.setFillColor(250, 250, 250);
                            pdf.rect(leftColumn - 2, yPosition - 8, pageWidth - 40, 10, 'F');
                        }
                        
                        // Set text color based on whether there's data
                        if (startTime !== '' || endTime !== '') {
                            pdf.setTextColor(0, 0, 0); // Black for entries with data
                        } else {
                            pdf.setTextColor(...secondaryColor); // Gray for empty entries
                        }
                        
                        rowData.forEach((data, i) => {
                            pdf.text(data.toString(), xPos, yPosition);
                            xPos += colWidths[i];
                        });
                        yPosition += 10;
                        
                        // Check if we need a page break (basic pagination)
                        if (yPosition > pdf.internal.pageSize.getHeight() - 100) {
                            pdf.addPage();
                            yPosition = 50;
                            
                            // Repeat headers on new page
                            pdf.setFillColor(...lightGray);
                            pdf.rect(leftColumn - 2, yPosition - 8, pageWidth - 40, 12, 'F');
                            
                            pdf.setTextColor(...primaryColor);
                            pdf.setFont('helvetica', 'bold');
                            xPos = leftColumn;
                            headers.forEach((header, i) => {
                                pdf.text(header, xPos, yPosition);
                                xPos += colWidths[i];
                            });
                            yPosition += 15;
                            pdf.setFont('helvetica', 'normal');
                        }
                    }
                }
                
                // Add summary line
                yPosition += 5;
                pdf.setTextColor(...primaryColor);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`Summary: ${entriesCount} days with time entries recorded`, leftColumn, yPosition);
                yPosition += 10;

                yPosition += 10;

                // Totals section
                if (timesheet.totalHours) {
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('TOTAL HOURS:', leftColumn, yPosition);
                    pdf.text(timesheet.totalHours.toString(), leftColumn + 80, yPosition);
                    yPosition += 15;
                } else {
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('TOTAL HOURS:', leftColumn, yPosition);
                    pdf.text(minutesToHoursFixed(monthlyTotalMinutes), leftColumn + 80, yPosition);
                    yPosition += 15;
                }

                // Notes section (if any)
                if (timesheet.notes) {
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('NOTES', leftColumn, yPosition);
                    yPosition += 15;
                    
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    const splitNotes = pdf.splitTextToSize(timesheet.notes, pageWidth - 60);
                    pdf.text(splitNotes, leftColumn, yPosition);
                    yPosition += splitNotes.length * 12;
                }

                // Approval status section removed by request

                // Footer
                const footerY = pdf.internal.pageSize.getHeight() - 30;
                pdf.setDrawColor(225);
                pdf.setLineWidth(0.5);
                pdf.line(leftColumn, footerY - 10, pageWidth - 20, footerY - 10);
                
                pdf.setTextColor(...secondaryColor);
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'normal');
                // Inject company footer text centered above generated timestamp if available
                try {
                    const companyFooter = (this.currentCompany && this.currentCompany.footer)
                        ? String(this.currentCompany.footer).trim()
                        : '';
                    if (companyFooter) {
                        // place just above the generated line
                        pdf.text(companyFooter, pageWidth / 2, footerY - 12, { align: 'center', maxWidth: pageWidth - 40 });
                    }
                } catch (_) { /* ignore footer text issues */ }
                pdf.text(`Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, leftColumn, footerY);
                pdf.text(`Page 1 of 1`, pageWidth - 60, footerY);

                // Save with professional filename
                const safe = (s) => (s || '').toString().replace(/[^a-z0-9-_]+/gi, '_');
                const filename = `Timesheet_${safe(timesheet.month)}_${safe(timesheet.submittedBy)}_${safe(timesheet.id || Date.now())}.pdf`;
                pdf.save(filename);

                this.showNotification('Professional timesheet PDF exported successfully', 'success');
            } catch (err) {
                console.error('Export PDF failed', err);
                this.showNotification('Export failed. Please try again.', 'error');
            }
        };

        // Open printable Timesheet preview (same design as Leave preview)
        ProfileManager.prototype.openTimesheetPreview = async function() {
            try {
                const ts = this.currentViewTimesheetData || null;
                if (!ts) { this.showNotification && this.showNotification('Nothing to print', 'warning'); return; }

                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:4000;display:flex;align-items:flex-start;justify-content:center;overflow:auto;padding:32px 20px;';
                const modal = document.createElement('div');
                modal.style.cssText = 'background:#fff;border-radius:12px;width:100%;max-width:940px;min-height:60vh;box-shadow:0 18px 42px rgba(0,0,0,0.22);position:relative;overflow:hidden;';

                const companyName = (this.currentCompany && (this.currentCompany.companyName || this.currentCompany.name)) || '';
                const logoEl = document.getElementById('headerCompanyLogo');
                const logoSrc = (logoEl && logoEl.src && logoEl.style.display !== 'none') ? logoEl.src : '';
                const hrStampUrl = (this.currentCompany && this.currentCompany.hrStamp && String(this.currentCompany.hrStamp).trim() && String(this.currentCompany.hrStamp).trim().toLowerCase() !== 'null') ? this.currentCompany.hrStamp : '';

                // Compute totals and resolve metadata
                const days = Array.isArray(ts.days) ? ts.days : (ts.days && typeof ts.days === 'object' ? Object.values(ts.days) : []);
                let totalHours = 0;
                try { days.forEach(d => { const h = parseFloat(d?.hours); if (!isNaN(h)) totalHours += h; }); totalHours = Math.round((totalHours + Number.EPSILON) * 100) / 100; } catch {}

                // Resolve submitter metadata (name, jobTitle, department, line manager)
                let empMeta = { id: '', name: '', email: '', jobTitle: '', department: '', lineManager: '' };
                try {
                    empMeta.email = ts.submittedByEmail || '';
                    const submitterNameLc = (ts.submittedBy || '').toString().trim().toLowerCase();
                    const companyId = this.currentUser?.companyId;
                    if (companyId && window.firebase) {
                        const usersSnap = await db.ref(`companies/${companyId}/users`).once('value');
                        const users = usersSnap.val() || {};
                        for (const [uid, u] of Object.entries(users)) {
                            if (!u) continue;
                            const nm = (u.displayName || u.name || u.fullName || u.email || '').toString().trim().toLowerCase();
                            const email = (u.email || '').toString().trim().toLowerCase();
                            if ((submitterNameLc && nm === submitterNameLc) || (empMeta.email && email === empMeta.email.toLowerCase())) {
                                empMeta.id = u.employeeId || u.employeeID || u.staffId || u.code || uid;
                                empMeta.name = u.displayName || u.name || u.fullName || ts.submittedBy || '';
                                empMeta.email = u.email || empMeta.email || '';
                                empMeta.jobTitle = u.jobTitle || u.positionTitle || u.position || u.role || '';
                                empMeta.department = u.department || u.orgUnit || '';
                                empMeta.lineManager = u.lineManager || u.lineManagerName || '';
                                break;
                            }
                        }
                    }
                } catch {}

                // Build or fetch a persistent document number for this timesheet
                let tsDocNumber = ts?.documentNumber || '';
                try {
                    if (!tsDocNumber) {
                        const now = new Date();
                        const dd = String(now.getDate()).padStart(2,'0');
                        const month2 = String(now.getMonth()+1).padStart(2,'0');
                        const yyyy = now.getFullYear();
                        const companyIdForDoc = this.currentUser?.companyId || null;
                        const tsIdForDoc = ts?.id || this.currentViewTimesheetId || '';
                        let seqVal = null;
                        if (companyIdForDoc && window.firebase) {
                            try {
                                const counterRef = db.ref(`companies/${companyIdForDoc}/counters/timesheetDocumentNumber`);
                                const txn = await counterRef.transaction(curr => (curr || 0) + 1);
                                if (txn && txn.committed && txn.snapshot) seqVal = txn.snapshot.val();
                            } catch {}
                        }
                        if (typeof seqVal !== 'number') {
                            const lsKey = `timesheet.docNumber.seq.${this.currentUser?.companyId || 'global'}`;
                            let localSeq = parseInt(localStorage.getItem(lsKey) || '0', 10);
                            localSeq = isNaN(localSeq) ? 0 : localSeq;
                            localSeq += 1;
                            localStorage.setItem(lsKey, String(localSeq));
                            seqVal = localSeq;
                        }
                        const seqStr = String(seqVal).padStart(6, '0');
                        tsDocNumber = `TS-${yyyy}${month2}${dd}-${seqStr}`;
                        // Persist on primary and company mirrors when possible
                        try { if (tsIdForDoc) await db.ref(`timesheets/${tsIdForDoc}/documentNumber`).set(tsDocNumber); } catch {}
                        try { if (companyIdForDoc && tsIdForDoc) await db.ref(`companies/${companyIdForDoc}/timesheets/${tsIdForDoc}/documentNumber`).set(tsDocNumber); } catch {}
                    }
                } catch {}

                const wrapper = document.createElement('div');
                wrapper.className = 'timesheet-preview-container';
                wrapper.innerHTML = `
                    <style>
                    @page { size: A4; margin: 0mm 10mm 10mm 10mm; }
                    .timesheet-preview-container{width:100%;display:flex;justify-content:center;}
                    .timesheet-sheet{background:#fff;width:190mm;min-height:auto;padding:0mm 2mm 18mm;box-sizing:border-box;border:none;border-radius:0;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin:0 auto;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;position:relative;line-height:1.35;color:#111827;font-size:.6rem;}
                    .doc-title{font-size:.8rem;font-weight:700;margin:2px 0 0;color:#111827;text-align:left;}
                    .doc-subtitle{font-size:.65rem;color:#6b7280;margin:0 0 6px;font-weight:500;text-align:left;}
                    .generated-stamp{display:block;font-size:.55rem;color:#6b7280;margin-top:2px;font-weight:500;}
                    .docmeta-row{font-size:.66rem;color:#111827;margin:4px 0 6px;}
                    .docmeta-label{font-weight:700;color:#374151;margin-right:6px;}
                    .divider{height:1px;background:#e5e7eb;margin:6px 0 8px;border-radius:1px;}
                    .ts-header{display:flex;justify-content:space-between;gap:20px;margin-bottom:0;page-break-inside:avoid;align-items:flex-start;}
                    .company-block{display:flex;flex-direction:column;align-items:flex-start;gap:0px;}
                    .ts-logo{width:100px;height:100px;object-fit:contain;border:none;border-radius:8px;background:#fff;}
                    .ts-company h1{margin:0;font-size:1.1rem;line-height:1.2;font-weight:700;}
                    .ts-company small{display:block;font-size:.6rem;color:#6b7280;margin-top:4px;font-weight:500;}
                    .section{margin-bottom:0;page-break-inside:avoid;}
                    .details-section{margin-bottom:8px;}
                    .time-entries-section{margin-top:0;}
                    /* Link tables by aligning borders */
                    .emp-info-table tbody tr:last-child td{ border-bottom:0 !important; }
                    .time-entries-table tfoot td{ border-bottom:0 !important; }
                    .section h2{font-size:.64rem;text-transform:none;letter-spacing:.01em;font-weight:700;color:#111827;margin:0 0 6px;}
                    .section h2 .ld-icon{width:.8rem;height:.8rem;margin-right:6px;vertical-align:-1px;fill:currentColor;display:inline-block;}
                    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;}
                    .info-item{display:grid;grid-template-columns:max-content 1fr;align-items:baseline;column-gap:10px;row-gap:3px;background:#fff;border:1px solid #e5e7eb;padding:8px 12px;border-radius:6px;}
                    .info-item.full-width{grid-column:1 / -1;}
                    .info-item label{font-size:.52rem;font-weight:700;letter-spacing:.03em;color:#6b7280;text-transform:none;white-space:nowrap;line-height:1.15;}
                    .info-item label::after{content: ':';margin:0 4px;color:#9ca3af;}
                    .info-item span{font-size:.62rem;color:#111827;font-weight:400;word-break:break-word;line-height:1.2;}
                    .approval-section table{width:100%;border-collapse:collapse;font-size:.58rem;}
                    .approval-section th{background:var(--primary-color);font-weight:600;text-transform:none;font-size:.5rem;letter-spacing:.01em;color:#ffffff;padding:5px;border:1px solid var(--primary-color);text-align:left;}
                    .approval-section td{padding:5px;border:1px solid #e5e7eb;vertical-align:top;background:#fff;color:#111827;font-size:.56rem;}
                    .approval-section td.ts-cell, .approval-section td.ts-cell div{ white-space: nowrap; }
                    .status-chip{display:inline-block;font-size:.48rem;font-weight:600;letter-spacing:.02em;color:#374151;background:transparent;border:none;padding:0;border-radius:0;}
                    .status-chip.approved{color:#166534;}
                    .status-chip.declined{color:#991b1b;}
                    .status-chip.pending{color:#92400e;}
                    .sig-img{max-width:150px;max-height:75px;object-fit:contain;display:block;}
                    .sig-stack{display:flex;flex-direction:column;gap:4px;}
                    .approver-job{font-size:.48rem;color:#6b7280;display:inline-block;}
                    .approver-fullname{font-size:.5rem;color:#1f2937;display:inline-block;font-weight:600;}
                    .doc-footer{position:absolute;left:0;right:0;bottom:0;font-size:.5rem;color:#6b7280;text-align:center;letter-spacing:.03em;white-space:pre-line;z-index:10;}
                    .hr-stamp-section{ text-align:right; }
                    .print-btn{position:absolute;top:10px;right:10px;background:#111827;color:#fff;border:none;border-radius:6px;padding:7px 10px;font-size:.7rem;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
                    .close-btn{position:absolute;top:10px;right:120px;background:#fff;border:1px solid #d1d5db;color:#111827;border-radius:6px;padding:7px 10px;font-size:.7rem;cursor:pointer;}
                    .time-entries-table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:.58rem;}
                    .time-entries-table th,.time-entries-table td{padding:4px;border:1px solid #e5e7eb;vertical-align:top;box-sizing:border-box;}
                    .time-entries-table th{background:var(--primary-color);color:#fff;border:1px solid var(--primary-color);text-align:left;font-size:.5rem;letter-spacing:.01em;}
                    .time-entries-table td.comment{white-space:normal;word-break:break-word;}
                    .time-entries-section thead{display:table-header-group;}
                    .time-entries-section tfoot{display:table-footer-group;}
                    .time-entries-section tbody tr{page-break-inside:avoid;}
                    @media print { html, body { margin:0 !important; padding:0 !important; } body * { visibility:hidden !important; } .printable, .printable * { visibility:visible !important; } .printable { position:static !important; margin:0 !important; box-shadow:none !important; border:none !important; width:auto !important; } .timesheet-sheet { width:190mm !important; min-height:auto !important; margin:0 auto !important; padding:0mm 2mm 12mm !important; border:none !important; box-shadow:none !important; font-size:.55rem !important; } .print-btn, .close-btn { display:none !important; } .doc-footer { position: fixed !important; left: 10mm !important; right: 10mm !important; bottom: 2mm !important; z-index: 2147483647 !important; } .hr-stamp-section{ margin-bottom: 14mm !important; } .time-entries-table th{ -webkit-print-color-adjust: exact; print-color-adjust: exact; } .time-entries-table{ font-size:.55rem !important; } .time-entries-table th{ font-size:.48rem !important; } .time-entries-table th, .time-entries-table td{ padding:3px !important; } .approval-section table{ font-size:.55rem !important; } .approval-section th{ font-size:.48rem !important; padding:4px !important; } .approval-section td{ font-size:.52rem !important; padding:4px !important; } }
                    </style>
                    <div class='timesheet-sheet printable'>
                        <button class='print-btn' id='timesheetPrintBtn'>Print / PDF</button>
                        <button class='close-btn' onclick='this.closest(".timesheet-preview-container").parentElement.parentElement.remove()'>Close</button>
                        <div class='ts-header'>
                            <div class='company-block'>
                                ${logoSrc?`<img class='ts-logo' src='${logoSrc}' alt='${companyName} logo'/>`:`<div class='ts-logo' style="display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;color:#444;">${(companyName||'CN').split(/\s+/).map(w=>w[0]).slice(0,3).join('').toUpperCase()}</div>`}
                                <div class='ts-company'>
                                    <h1 style='margin:0;font-size:1.1rem;'>${companyName || 'Company'}</h1>
                                    <h2 class='doc-title'>Timesheet Document</h2>
                                </div>
                            </div>
                        </div>
                        <div class='divider' style='margin:4px 0 6px;'></div>
                        <div class='docmeta-row'><span class='docmeta-label'>Document Number:</span><span class='docmeta-value'>${tsDocNumber || '-'}</span></div>
                        <div class='section emp-section'>
                            <table class='emp-info-table' style='width:100%;border-collapse:collapse;font-size:.66rem;'>
                                <tbody>
                                    <tr>
                                        <td style='font-weight:700;color:#374151;border:1px solid #e5e7eb;padding:6px;'>ID</td>
                                        <td style='border:1px solid #e5e7eb;padding:6px;'>${empMeta.id || '-'}</td>
                                        <td style='font-weight:700;color:#374151;border:1px solid #e5e7eb;padding:6px;'>Employee Name</td>
                                        <td style='border:1px solid #e5e7eb;padding:6px;'>${empMeta.name || ts.submittedBy || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style='font-weight:700;color:#374151;border:1px solid #e5e7eb;padding:6px;'>Job Title</td>
                                        <td style='border:1px solid #e5e7eb;padding:6px;'>${empMeta.jobTitle || '-'}</td>
                                        <td style='font-weight:700;color:#374151;border:1px solid #e5e7eb;padding:6px;'>Department</td>
                                        <td style='border:1px solid #e5e7eb;padding:6px;'>${empMeta.department || '-'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class='section time-entries-section'>
                            <table class='time-entries-table' style='width:100%; border-collapse:collapse; font-size:.64rem;'>
                                <colgroup>
                                    <col style='width:26mm;'>
                                    <col style='width:16mm;'>
                                    <col style='width:16mm;'>
                                    <col style='width:14mm;'>
                                    <col style='width:14mm;'>
                                    <col style='width:16mm;'>
                                    <col>
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>Date</th>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>Start</th>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>End</th>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>Break</th>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>Hours</th>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>Overtime</th>
                                        <th class='entries-dark-header' style='background:var(--primary-color);color:#fff;padding:6px;border:1px solid var(--primary-color);text-align:left;'>Comment</th>
                                    </tr>
                                </thead>
                                <tbody id='tsPreviewDaysBody'></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan='4' style='border:1px solid #e5e7eb; padding:6px; text-align:right; font-weight:700; color:#374151;'>Total Hours</td>
                                        <td id='tsPreviewDaysTotalCell' style='border:1px solid #e5e7eb; padding:6px; text-align:right; font-weight:700; color:#111827;'></td>
                                        <td id='tsPreviewDaysTotalOTCell' style='border:1px solid #e5e7eb; padding:6px; text-align:right; font-weight:700; color:#111827;'></td>
                                        <td style='border:1px solid #e5e7eb; padding:6px;'></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class='section approval-section'>
                            <table id='tsPreviewApprovalTable'>
                                <thead>
                                    <tr>
                                        <th>Approver(s)</th>
                                        <th style='width:90px;'>Status</th>
                                        <th style='width:110px;'>Timestamp</th>
                                        <th style='width:160px;'>Signature</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        ${hrStampUrl ? `<div class='section hr-stamp-section'><img src='${hrStampUrl}' alt='HR Stamp' style='max-width:120px; max-height:120px; object-fit:contain;'/></div>` : ''}
                        <div class='doc-footer'></div>
                    </div>
                `;

                // Inject company footer if present
                try {
                    const footerText = (this.currentCompany && this.currentCompany.footer) ? String(this.currentCompany.footer).trim() : '';
                    const footerEl = wrapper.querySelector('.doc-footer');
                    if (footerEl) footerEl.textContent = footerText || '';
                } catch {}

                // Populate time entries table from timesheet days
                try {
                    const tbody = wrapper.querySelector('#tsPreviewDaysBody');
                    const totalCell = wrapper.querySelector('#tsPreviewDaysTotalCell');
                    const totalOTCell = wrapper.querySelector('#tsPreviewDaysTotalOTCell');
                    if (tbody) {
                        const pad = v => (v!=null && v!=='') ? v : '';
                        const fmtDate = (val) => {
                            try {
                                if (!val) return '-';
                                if (val instanceof Date) return val.toLocaleDateString();
                                if (typeof val === 'number') return new Date(val).toLocaleDateString();
                                if (typeof val === 'string') {
                                    const d = new Date(val);
                                    if (!isNaN(d)) return d.toLocaleDateString();
                                    // Fallback: already a label
                                    return val;
                                }
                            } catch {}
                            return '-';
                        };

                        let total = 0;
                        let totalOT = 0;
                        days.forEach((d) => {
                            const tr = document.createElement('tr');
                            const dateVal = d?.date ?? d?.day ?? d?.label ?? '';
                            const startVal = d?.start ?? d?.startTime ?? '';
                            const endVal = d?.end ?? d?.endTime ?? '';
                            const breakVal = (d?.break ?? d?.breakHours ?? d?.breakDuration ?? '');
                            const hoursVal = (typeof d?.hours === 'number') ? d.hours : parseFloat(d?.hours) || '';
                            const overtimeValRaw = d?.overtime ?? d?.overTime ?? d?.ot ?? d?.overtimeHours ?? d?.otHours ?? '';
                            const overtimeVal = (typeof overtimeValRaw === 'number') ? overtimeValRaw : (parseFloat(overtimeValRaw) || '');
                            if (typeof hoursVal === 'number') total += hoursVal;
                            if (typeof overtimeVal === 'number') totalOT += overtimeVal;

                            tr.innerHTML = `
                                <td style='border:1px solid #e5e7eb; padding:6px;'>${fmtDate(dateVal)}</td>
                                <td style='border:1px solid #e5e7eb; padding:6px;'>${pad(startVal)}</td>
                                <td style='border:1px solid #e5e7eb; padding:6px;'>${pad(endVal)}</td>
                                <td style='border:1px solid #e5e7eb; padding:6px;'>${pad(breakVal)}</td>
                                <td style='border:1px solid #e5e7eb; padding:6px; text-align:right;'>${hoursVal!==''? hoursVal : ''}</td>
                                <td style='border:1px solid #e5e7eb; padding:6px; text-align:right;'>${overtimeVal!==''? overtimeVal : ''}</td>
                                <td style='border:1px solid #e5e7eb; padding:6px;'>${pad(d?.comment)}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                        if (totalCell) totalCell.textContent = (typeof ts.totalHours !== 'undefined' ? ts.totalHours : (Math.round((total + Number.EPSILON) * 100) / 100)).toString();
                        if (totalOTCell) totalOTCell.textContent = (Math.round((totalOT + Number.EPSILON) * 100) / 100).toString();
                    }
                } catch (err) { console.warn('Failed to populate time entries in print preview', err); }

                // Build Approval table from configured levels and history
                try {
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const levels = detailed.levels || [];
                    const flat = detailed.flat || [];
                    const hist = Array.isArray(ts.approvalHistory) ? ts.approvalHistory : [];
                    const approvalsByStep = new Map();
                    hist.forEach(h => { if (typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });
                    let approvedCount = 0; flat.forEach((_, idx) => { const e = approvalsByStep.get(idx); if (e && (e.status||'').toLowerCase()==='approved') approvedCount++; });
                    const currentFlatIdx = Math.min(approvedCount, flat.length);

                    // Build maps for signatures and job titles
                    let signatureMap = {}; let signatureMapById = {}; let jobTitleById = {}; let jobTitleByName = {}; let fullNameById = {}; let fullNameByName = {};
                    try {
                        const companyIdForSig = this.currentUser?.companyId;
                        if (companyIdForSig && window.firebase) {
                            const usersSnap = await db.ref(`companies/${companyIdForSig}/users`).once('value');
                            const usersVal = usersSnap.val() || {};
                            Object.entries(usersVal).forEach(([uid,u]) => {
                                if (!u) return;
                                const nm = (u.displayName || u.name || u.fullName || u.email || '').trim();
                                const sig = u.signatureUrl || null;
                                const prettyJob = (u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '') || '';
                                if (uid && nm) fullNameById[uid] = nm;
                                if (nm) fullNameByName[nm.toLowerCase()] = nm;
                                if (nm && sig) signatureMap[nm.toLowerCase()] = sig;
                                if (uid && sig) signatureMapById[uid] = sig;
                                if (uid && prettyJob) jobTitleById[uid] = prettyJob;
                                if (nm && prettyJob) jobTitleByName[nm.toLowerCase()] = prettyJob;
                            });
                        }
                    } catch {}

                    const tbody = wrapper.querySelector('#tsPreviewApprovalTable tbody');
                    let globalIdx = 0;
                    for (let lvlIndex = 0; lvlIndex < levels.length; lvlIndex++) {
                        const approvers = levels[lvlIndex] || [];
                        // Resolve names for this level
                        const approverNames = [];
                        const statuses = [];
                        const timestamps = [];
                        const statusClasses = [];
                        const stepUserIds = [];
                        for (let i = 0; i < approvers.length; i++) {
                            const step = approvers[i] || {};
                            let who = '';
                            if (step.userId) { try { who = await this.getUserDisplayNameById(step.userId); } catch { who = step.userId; } }
                            else if (step.email) { try { who = await this.getUserDisplayNameByEmail(step.email); } catch { who = step.email; } }
                            else if (step.label) who = step.label; else if (step.role) who = step.role; else who = 'Unassigned';
                            approverNames.push(who);
                            stepUserIds.push(step.userId || null);

                            // Determine status by global index vs currentFlatIdx
                            const thisFlatIdx = globalIdx;
                            const histEntry = approvalsByStep.get(thisFlatIdx) || null;
                            if (thisFlatIdx < currentFlatIdx && histEntry) {
                                const sText = (histEntry.status || 'Approved');
                                const tText = histEntry.submittedAt ? new Date(histEntry.submittedAt).toLocaleString() : '-';
                                statuses.push(sText);
                                timestamps.push(tText);
                                statusClasses.push('approved');
                            } else {
                                statuses.push('Pending');
                                timestamps.push('-');
                                statusClasses.push('pending');
                            }
                            globalIdx++;
                        }

                        // Compose cells
                        const approverHtml = approverNames.map((n, idx) => {
                            const uid = stepUserIds[idx];
                            const isApproved = statusClasses[idx] === 'approved';
                            const jobTitle = isApproved ? (uid ? (jobTitleById[uid] || '') : (jobTitleByName[n.toLowerCase()] || '')) : '';
                            const fullName = uid ? (fullNameById[uid] || '') : (fullNameByName[n.toLowerCase()] || '');
                            const parts = [];
                            if (n) parts.push(n);
                            if (fullName && fullName.trim().toLowerCase() !== String(n).trim().toLowerCase()) parts.push(`<span class='approver-fullname'>${fullName}</span>`);
                            if (jobTitle) parts.push(`<span class='approver-job'>${jobTitle}</span>`);
                            return `<div>${parts.join('<br>')}</div>`;
                        }).join('');
                        const statusHtml = statuses.map((s,idx)=>{ const cap = s ? s.charAt(0).toUpperCase()+s.slice(1) : s; return `<div><span class='status-chip ${statusClasses[idx]}'>${cap}</span></div>`; }).join('');
                        const tsHtml = timestamps.map(t=>{ const tNorm = String(t||'').replace(/\s*\n\s*/g,' ').replace(/\s{2,}/g,' ').trim(); return `<div>${tNorm}</div>`; }).join('');
                        const signatureBlocks = approverNames.map((n,idx)=>{
                            const isApproved = statusClasses[idx] === 'approved';
                            if (!isApproved) return `<div style='height:14px;'></div>`;
                            const uid = stepUserIds[idx];
                            let sigUrl = '';
                            if (uid && signatureMapById[uid]) sigUrl = signatureMapById[uid]; else sigUrl = signatureMap[n.toLowerCase()] || '';
                            return sigUrl ? `<div><img src='${sigUrl}' alt='${n} signature' class='sig-img'/></div>` : `<div style='height:14px;'></div>`;
                        }).join('');
                        const signatureCellHtml = `<div class='sig-stack'>${signatureBlocks}</div>`;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${approverHtml}</td><td>${statusHtml}</td><td class='ts-cell'>${tsHtml}</td><td>${signatureCellHtml}</td>`;
                        tbody.appendChild(tr);
                    }
                } catch (err) { console.warn('Failed to build approval table for print', err); }

                // Apply dynamic header color for print table headers
                try {
                    const primaryColor = (getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '').trim() || '#2c3e50';
                    const ths = wrapper.querySelectorAll('.approval-section th');
                    ths.forEach(th => th.classList.add('approval-dark-header'));
                    const entriesThs = wrapper.querySelectorAll('.time-entries-table th');
                    entriesThs.forEach(th => th.classList.add('entries-dark-header'));
                    const dynStyle = document.createElement('style');
                    dynStyle.textContent = `
                        .approval-section th.approval-dark-header, .time-entries-table th.entries-dark-header { background:${primaryColor} !important; color:#fff !important; }
                        @media print { .approval-section th.approval-dark-header, .time-entries-table th.entries-dark-header { background:${primaryColor} !important; color:#fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                    `;
                    wrapper.querySelector('.timesheet-sheet').prepend(dynStyle);
                    const printBtn = wrapper.querySelector('#timesheetPrintBtn');
                    if (printBtn) printBtn.addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
                } catch {}

                // Wire close behavior
                const closeBtn = wrapper.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); try { overlay.remove(); } catch {} });
                }
                modal.addEventListener('click', (e) => e.stopPropagation());
                overlay.addEventListener('click', () => { try { overlay.remove(); } catch {} });

                modal.appendChild(wrapper);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
            } catch (e) {
                console.error('Failed to open timesheet preview', e);
                this.showNotification && this.showNotification('Failed to open timesheet print preview', 'error');
            }
        };

        ProfileManager.prototype.checkUserCanApprove = function(timesheet, nextStepIndex = null) {
            // Check if user can approve this specific timesheet step
            console.log(' Checking user approval permissions for timesheet...');
            
            try {
                if (!this.currentUser) {
                    console.log(' No current user found');
                    return false;
                }

                // Prevent self-approval
                if (timesheet && (timesheet.submittedBy === this.currentUser.email || timesheet.submittedBy === this.currentUser.uid)) {
                    console.log(' Cannot approve own timesheet');
                    return false;
                }

                // If no specific step provided, use general role-based check
                if (nextStepIndex === null || nextStepIndex === undefined) {
                    const userRole = this.currentUser.role ? this.currentUser.role.toLowerCase() : '';
                    const canApproveGeneral = userRole.includes('manager') || userRole.includes('supervisor') || userRole.includes('admin');
                    console.log(' General role check:', userRole, '', canApproveGeneral);
                    return canApproveGeneral;
                }

                // Check against approval flow for specific step
                return this.checkUserCanApproveStep(nextStepIndex);
                
            } catch (error) {
                console.warn(' Error checking approval permissions:', error);
                return false;
            }
        };

        ProfileManager.prototype.checkUserCanApproveStep = async function(stepIndex) {
            try {
                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const flat = detailed.flat || [];
                
                if (stepIndex >= flat.length || stepIndex < 0) {
                    console.log(' Step index out of range:', stepIndex);
                    return false;
                }

                const step = flat[stepIndex];
                if (!step) {
                    console.log(' No step found at index:', stepIndex);
                    return false;
                }

                const currentUserId = this.currentUser.uid;
                const currentUserEmail = this.currentUser.email;
                const currentUserRole = this.currentUser.role ? this.currentUser.role.toLowerCase() : '';

                // Check if user matches step requirements
                if (step.userId && step.userId === currentUserId) {
                    console.log(' User matches step userId:', step.userId);
                    return true;
                }

                if (step.email && step.email === currentUserEmail) {
                    console.log(' User matches step email:', step.email);
                    return true;
                }

                if (step.role) {
                    const stepRole = step.role.toLowerCase();
                    if (currentUserRole.includes(stepRole) || stepRole.includes(currentUserRole)) {
                        console.log(' User role matches step role:', currentUserRole, '', stepRole);
                        return true;
                    }
                }

                console.log(' User does not match step requirements:', {
                    stepUserId: step.userId,
                    stepEmail: step.email, 
                    stepRole: step.role,
                    currentUserId,
                    currentUserEmail,
                    currentUserRole
                });
                return false;

            } catch (error) {
                console.warn(' Error checking step approval permissions:', error);
                return false;
            }
        };

        ProfileManager.prototype.updateApprovalButtonVisibility = async function(timesheet) {
            console.log(' Updating approval button visibility...');
            console.log(' Timesheet data:', timesheet);
            
            const tsStatus = (timesheet && timesheet.status ? String(timesheet.status).toLowerCase() : '');
            const isSubmittedStatus = tsStatus === 'submitted' || tsStatus === 'pending';
            console.log(' Is submitted status:', isSubmittedStatus, '(status:', timesheet ? timesheet.status : 'none', ')');
            
            // CRITICAL: Prevent submitters from seeing approval buttons, even if they're named in the flow
            // This must come before any other permission checks to ensure submitters never approve their own work
            if (timesheet && this.currentUser) {
                const currentUserId = this.currentUser.uid;
                const currentUserEmail = (this.currentUser.email || '').toLowerCase();
                
                // Check multiple fields that could identify the submitter
                const submitterIdentifiers = [
                    timesheet.submittedBy,
                    timesheet.submittedByEmail,
                    timesheet.createdBy,
                    timesheet.userId,
                    timesheet.ownerId,
                    timesheet.employeeId
                ];
                
                const isSubmitter = submitterIdentifiers.some(id => {
                    if (!id) return false;
                    // UID match
                    if (String(id) === currentUserId) return true;
                    // Email match (case insensitive)
                    if (String(id).toLowerCase() === currentUserEmail) return true;
                    return false;
                });
                
                // Also check approval history for original submission
                if (!isSubmitter && Array.isArray(timesheet.approvalHistory)) {
                    const submissionEntry = timesheet.approvalHistory.find(h => 
                        h && h.action === 'submitted' && (
                            h.userId === currentUserId || 
                            h.submittedBy === currentUserId ||
                            (h.email && h.email.toLowerCase() === currentUserEmail) ||
                            (h.submittedByEmail && h.submittedByEmail.toLowerCase() === currentUserEmail)
                        )
                    );
                    if (submissionEntry) isSubmitter = true;
                }
                
                if (isSubmitter) {
                    const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
                    const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
                    const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
                    const approvalActions = document.getElementById('approvalActions');
                    
                    // Hide approval/decline buttons from submitters
                    if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                    if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                    if (approvalActions) approvalActions.style.display = 'none';
                    
                    // Allow submitters to see delete button for their own timesheets
                    if (viewDeleteBtn) viewDeleteBtn.style.display = 'inline-flex';
                    
                    console.log(' SUBMITTER BLOCKED: Hiding approval/decline actions - user is the timesheet submitter');
                    console.log(' SUBMITTER ALLOWED: Showing delete button - user can delete their own timesheet');
                    return; // Exit early - submitters only see delete button
                }
            }
            
            // Get approval buttons for both modals
            const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
            const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
            const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
            const approvalActions = document.getElementById('approvalActions');
            
            console.log(' Found buttons:', {
                viewApproveBtn: !!viewApproveBtn,
                viewDeclineBtn: !!viewDeclineBtn,
                viewDeleteBtn: !!viewDeleteBtn,
                approvalActions: !!approvalActions
            });
            
            // If fully approved, force-hide approval controls but allow delete for submitters
            if (tsStatus === 'approved') {
                if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                if (approvalActions) approvalActions.style.display = 'none';
                
                // Check if current user is the submitter - allow delete button for them
                let isCurrentUserSubmitter = false;
                if (timesheet && this.currentUser) {
                    const currentUserId = this.currentUser.uid;
                    const currentUserEmail = (this.currentUser.email || '').toLowerCase();
                    const submitterIdentifiers = [
                        timesheet.submittedBy,
                        timesheet.submittedByEmail,
                        timesheet.createdBy,
                        timesheet.userId,
                        timesheet.ownerId,
                        timesheet.employeeId
                    ];
                    
                    isCurrentUserSubmitter = submitterIdentifiers.some(id => {
                        if (!id) return false;
                        if (String(id) === currentUserId) return true;
                        if (String(id).toLowerCase() === currentUserEmail) return true;
                        return false;
                    });
                }
                
                if (viewDeleteBtn) {
                    viewDeleteBtn.style.display = isCurrentUserSubmitter ? 'inline-flex' : 'none';
                }
                
                console.log(' Timesheet approved: hiding approval actions', isCurrentUserSubmitter ? '(keeping delete for submitter)' : '');
                return;
            }

            // Check if current user has already approved this timesheet
            if (timesheet && this.currentUser) {
                const currentUserId = this.currentUser.uid;
                const currentUserEmail = this.currentUser.email;
                let hist = [];
                if (Array.isArray(timesheet.approvalHistory)) hist = timesheet.approvalHistory;
                else if (timesheet.approvalHistory && typeof timesheet.approvalHistory === 'object') hist = Object.values(timesheet.approvalHistory);
                
                const userAlreadyApproved = hist.some(entry => {
                    if (!entry) return false;
                    const eStatus = (entry.status ? String(entry.status).toLowerCase() : '');
                    const acted = eStatus === 'approved' || eStatus === 'rejected';
                    const uidMatch = [entry.submittedBy, entry.userId, entry.uid, entry.approverId, entry.approverUid]
                        .some(v => v && String(v) === currentUserId);
                    const emailMatch = [entry.submittedByEmail, entry.email, entry.approverEmail, entry.approvedByEmail]
                        .some(v => v && String(v).toLowerCase() === currentUserEmail.toLowerCase());
                    return acted && (uidMatch || emailMatch);
                });
                
                if (userAlreadyApproved) {
                    if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                    if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                    if (approvalActions) approvalActions.style.display = 'none';
                    
                    // Check if user is also the submitter - if so, allow delete button
                    const currentUserId = this.currentUser.uid;
                    const currentUserEmail = (this.currentUser.email || '').toLowerCase();
                    const submitterIdentifiers = [
                        timesheet.submittedBy,
                        timesheet.submittedByEmail,
                        timesheet.createdBy,
                        timesheet.userId,
                        timesheet.ownerId,
                        timesheet.employeeId
                    ];
                    
                    const isAlsoSubmitter = submitterIdentifiers.some(id => {
                        if (!id) return false;
                        if (String(id) === currentUserId) return true;
                        if (String(id).toLowerCase() === currentUserEmail) return true;
                        return false;
                    });
                    
                    if (viewDeleteBtn) {
                        viewDeleteBtn.style.display = isAlsoSubmitter ? 'inline-flex' : 'none';
                    }
                    
                    console.log(' User already approved/rejected this timesheet: hiding approval actions');
                    if (isAlsoSubmitter) {
                        console.log(' User is submitter: allowing delete button');
                    }
                    return;
                }
            }

            // Check if user can approve this timesheet at the current step
            let canApprove = false;
            if (isSubmittedStatus) {
                // For step-specific approval, use the stored next step index
                if (typeof this.currentViewTimesheetNextStepIndex === 'number') {
                    canApprove = await this.checkUserCanApproveStep(this.currentViewTimesheetNextStepIndex);
                } else {
                    // Fallback to general approval check
                    canApprove = this.checkUserCanApprove(timesheet);
                }
            }
            
            console.log(' Can approve:', canApprove);
            console.log(' Next step index:', this.currentViewTimesheetNextStepIndex);
            
            // Show/hide buttons based on approval permissions and timesheet status
            let showButtons = canApprove && isSubmittedStatus;

            // Additional restriction: for level-based flows with L+1 (line manager) current step, only the submitter's line manager may approve
            if (showButtons && typeof this.currentViewTimesheetNextStepIndex === 'number') {
                try {
                    const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                    const flat = detailed.flat || [];
                    const currentIdx = this.currentViewTimesheetNextStepIndex;
                    const step = flat[currentIdx];
                    if (step) {
                        const rawLabel = (step.label || step.role || '').toUpperCase().replace(/\s+/g,'');
                        const isL1 = step.substitutedFrom === 'L+1' || /^L\+?1$|^LEVEL\+?1$/.test(rawLabel) || (step.label && step.label.toLowerCase() === 'line manager');
                        if (isL1 && this.currentUser && timesheet) {
                            // Determine timesheet owner ID from potential fields
                            const ownerIdCandidates = ['userId','ownerId','createdBy','submittedBy','creatorId','employeeId'];
                            let ownerId = null;
                            for (const k of ownerIdCandidates) {
                                if (timesheet[k]) { ownerId = timesheet[k]; break; }
                            }
                            // If history has an original submit entry with userId, prefer that
                            if (!ownerId && Array.isArray(timesheet.approvalHistory)) {
                                const subEntry = timesheet.approvalHistory.find(h => h && h.action === 'submitted' && h.userId);
                                if (subEntry) ownerId = subEntry.userId;
                            }
                            // Fetch owner user record to get their line manager
                            if (ownerId) {
                                const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId) || null;
                                let submitterLineManagerId = null;
                                let submitterLineManagerName = null;
                                if (companyId) {
                                    try {
                                        const ownerSnap = await db.ref(`companies/${companyId}/users/${ownerId}`).once('value');
                                        if (ownerSnap.exists()) {
                                            const ownerData = ownerSnap.val();
                                            submitterLineManagerId = ownerData.lineManagerId || ownerData.lineManagerUID || null;
                                            submitterLineManagerName = ownerData.lineManager || ownerData.lineManagerName || null;
                                        }
                                    } catch {}
                                }
                                const currentUid = this.currentUser.uid;
                                const currentName = (this.currentUser.name || this.currentUser.displayName || '').toLowerCase();
                                let allowed = false;
                                if (submitterLineManagerId && submitterLineManagerId === currentUid) allowed = true;
                                else if (!submitterLineManagerId && submitterLineManagerName) {
                                    const lmLower = submitterLineManagerName.toLowerCase();
                                    if (lmLower && currentName && (lmLower === currentName || lmLower.includes(currentName) || currentName.includes(lmLower))) allowed = true;
                                }
                                if (!allowed) {
                                    showButtons = false; // restrict visibility
                                    console.log(' Hiding buttons: current user is not the submitter\'s line manager for L+1 step');
                                } else {
                                    console.log(' Current user confirmed as submitter\'s line manager for L+1 step');
                                }
                            } else {
                                // If we cannot determine owner, be conservative and hide
                                showButtons = false;
                                console.log(' Could not determine timesheet owner; hiding approval buttons for safety');
                            }
                        }
                    }
                } catch (e) {
                    console.warn(' Error applying L+1 line manager restriction:', e);
                }
            }

            // Final strict verification: ensure current user is exactly the active approver
            if (showButtons) {
                const strictOk = await this.isCurrentUserActiveApprover(timesheet);
                if (!strictOk) {
                    showButtons = false;
                    console.log(' Strict approver check failed: hiding buttons');
                } else {
                    console.log(' Strict approver check passed');
                }
            }

            // Additional restriction: only show if the current user's NAME appears in the approval flow
            // (parity with Leave tab requirement)
            if (showButtons) {
                try {
                    const pendingNames = await this.getPendingApproverNamesForTimesheet(timesheet, this.currentViewTimesheetNextStepIndex);
                    const myName = (this.currentUser && (this.currentUser.displayName || this.currentUser.name)) ? (this.currentUser.displayName || this.currentUser.name).trim().toLowerCase() : '';
                    const nameMatch = pendingNames.some(n => String(n||'').trim().toLowerCase() === myName);
                    if (!nameMatch) {
                        showButtons = false;
                        console.log(' User name not listed in approval flow for current step; hiding approval buttons');
                    } else {
                        console.log(' User name is listed in approval flow for current step');
                    }
                } catch (e) {
                    console.warn(' Could not resolve approver names from flow; hiding for safety', e);
                    showButtons = false;
                }
            }

            console.log(' Show buttons decision (after L+1 restriction & strict check):', showButtons);
            
            // Check if current user is the submitter for delete button logic
            let isCurrentUserSubmitter = false;
            if (timesheet && this.currentUser) {
                const currentUserId = this.currentUser.uid;
                const currentUserEmail = (this.currentUser.email || '').toLowerCase();
                const submitterIdentifiers = [
                    timesheet.submittedBy,
                    timesheet.submittedByEmail,
                    timesheet.createdBy,
                    timesheet.userId,
                    timesheet.ownerId,
                    timesheet.employeeId
                ];
                
                isCurrentUserSubmitter = submitterIdentifiers.some(id => {
                    if (!id) return false;
                    if (String(id) === currentUserId) return true;
                    if (String(id).toLowerCase() === currentUserEmail) return true;
                    return false;
                });
            }
            
            // Update view modal buttons
            if (viewApproveBtn) viewApproveBtn.style.display = showButtons ? 'inline-flex' : 'none';
            if (viewDeclineBtn) viewDeclineBtn.style.display = showButtons ? 'inline-flex' : 'none';
            
            // Delete button: show for approvers OR submitters (but not for fully approved timesheets)
            if (viewDeleteBtn) {
                const showDeleteButton = (showButtons || isCurrentUserSubmitter) && tsStatus !== 'approved';
                viewDeleteBtn.style.display = showDeleteButton ? 'inline-flex' : 'none';
                console.log(' Delete button visibility:', showDeleteButton, '(approver:', showButtons, 'submitter:', isCurrentUserSubmitter, 'status:', tsStatus, ')');
            }

            // Update edit modal (footer) actions 
            if (approvalActions) {
                approvalActions.style.display = showButtons ? 'flex' : 'none';
                console.log(' Set approvalActions display to:', showButtons ? 'flex' : 'none');
            }
        };

        // Determine the human name(s) for the current pending approver step
        // Returns an array of names to compare against the current user's displayName/name
        ProfileManager.prototype.getPendingApproverNamesForTimesheet = async function(timesheet, stepIndex = null) {
            try {
                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const flat = detailed.flat || [];
                if (!flat.length) return [];

                // Build approvals map by step
                let hist = [];
                if (Array.isArray(timesheet.approvalHistory)) hist = timesheet.approvalHistory;
                else if (timesheet.approvalHistory && typeof timesheet.approvalHistory === 'object') hist = Object.values(timesheet.approvalHistory);
                const approvalsByStep = new Map();
                hist.forEach(h => { if (h && typeof h.stepIndex === 'number') approvalsByStep.set(h.stepIndex, h); });

                // Determine current step index if not provided
                let currentIdx = 0;
                if (typeof stepIndex === 'number') {
                    currentIdx = stepIndex;
                } else {
                    for (let i = 0; i < flat.length; i++) {
                        const entry = approvalsByStep.get(i);
                        if (!entry || (String(entry.status||'').toLowerCase() !== 'approved')) { currentIdx = i; break; }
                        if (i === flat.length - 1) currentIdx = flat.length; // all approved
                    }
                }
                if (currentIdx >= flat.length) return [];

                const step = flat[currentIdx];

                // Helper: resolve L+1 (Line Manager) to the timesheet owner's line manager name
                const resolveLineManagerName = async () => {
                    try {
                        const ownerFields = ['userId','ownerId','createdBy','submittedBy','creatorId','employeeId'];
                        let ownerId = null;
                        for (const f of ownerFields) { if (timesheet && timesheet[f]) { ownerId = timesheet[f]; break; } }
                        if (!ownerId && hist.length) {
                            const sub = hist.find(h => h && h.action === 'submitted' && h.userId);
                            if (sub) ownerId = sub.userId;
                        }
                        const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId) || null;
                        if (companyId && ownerId) {
                            const ownerSnap = await db.ref(`companies/${companyId}/users/${ownerId}`).once('value');
                            if (ownerSnap.exists()) {
                                const owner = ownerSnap.val();
                                const lmName = owner.lineManager || owner.lineManagerName || '';
                                if (lmName) return lmName;
                            }
                        }
                    } catch {}
                    return '';
                };

                // Resolve a single step to a display name
                const resolveStepName = async (st) => {
                    if (!st) return '';
                    if (st.userId) {
                        try { return await this.getUserDisplayNameById(st.userId); } catch { /* fall through */ }
                    }
                    if (st.email) {
                        try { return await this.getUserDisplayNameByEmail(st.email); } catch { /* fall through */ }
                    }
                    const rawLabel = (st.label || st.role || '').toString().trim();
                    const token = rawLabel.toUpperCase().replace(/\s+/g,'');
                    if (/^L\+?1$|^LEVEL\+?1$/.test(token) || rawLabel.toLowerCase() === 'line manager') {
                        const lm = await resolveLineManagerName();
                        return lm || '';
                    }
                    // If a label looks like a person name, return it; otherwise return blank to enforce name-only policy
                    return rawLabel || '';
                };

                const name = await resolveStepName(step);
                return name ? [name] : [];
            } catch (e) {
                console.warn('getPendingApproverNamesForTimesheet error', e);
                return [];
            }
        };

        // Determine if the current user's NAME appears anywhere in the timesheet approval flow
        // Resolves each step to a human name (including L+1) and compares to current user's display name
        ProfileManager.prototype.isUserNameInTimesheetApprovalFlow = async function(timesheet) {
            try {
                if (!this.currentUser) return false;
                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const flat = detailed.flat || [];
                if (!flat.length) return false;

                // Build approval history for owner resolution fallback
                let hist = [];
                if (Array.isArray(timesheet?.approvalHistory)) hist = timesheet.approvalHistory;
                else if (timesheet?.approvalHistory && typeof timesheet.approvalHistory === 'object') hist = Object.values(timesheet.approvalHistory);

                // Helper: resolve submitter/owner id to find their line manager name
                const resolveLineManagerName = async () => {
                    try {
                        const ownerFields = ['userId','ownerId','createdBy','submittedBy','creatorId','employeeId'];
                        let ownerId = null;
                        for (const f of ownerFields) { if (timesheet && timesheet[f]) { ownerId = timesheet[f]; break; } }
                        if (!ownerId && hist.length) {
                            const sub = hist.find(h => h && h.action === 'submitted' && h.userId);
                            if (sub) ownerId = sub.userId;
                        }
                        const companyId = (this.currentCompany && this.currentCompany.id) || (this.currentUser && this.currentUser.companyId) || null;
                        if (companyId && ownerId) {
                            const ownerSnap = await db.ref(`companies/${companyId}/users/${ownerId}`).once('value');
                            if (ownerSnap.exists()) {
                                const owner = ownerSnap.val();
                                const lmName = owner.lineManager || owner.lineManagerName || '';
                                if (lmName) return lmName;
                            }
                        }
                    } catch {}
                    return '';
                };

                const resolveStepName = async (st) => {
                    if (!st) return '';
                    if (st.userId) {
                        try { return await this.getUserDisplayNameById(st.userId); } catch {}
                    }
                    if (st.email) {
                        try { return await this.getUserDisplayNameByEmail(st.email); } catch {}
                    }
                    const rawLabel = (st.label || st.role || '').toString().trim();
                    const token = rawLabel.toUpperCase().replace(/\s+/g,'');
                    if (/^L\+?1$|^LEVEL\+?1$/.test(token) || rawLabel.toLowerCase() === 'line manager') {
                        const lm = await resolveLineManagerName();
                        return lm || '';
                    }
                    return rawLabel || '';
                };

                const myName = (this.currentUser.displayName || this.currentUser.name || '').trim().toLowerCase();
                if (!myName) return false;

                for (let i = 0; i < flat.length; i++) {
                    try {
                        const nm = (await resolveStepName(flat[i]) || '').trim().toLowerCase();
                        if (nm && nm === myName) return true;
                    } catch {}
                }
                return false;
            } catch (e) {
                console.warn('isUserNameInTimesheetApprovalFlow error', e);
                return false;
            }
        };

        // Determine if the current user's job title slug (or raw title) matches ANY function/role step in the timesheet flow
        ProfileManager.prototype.isUserFunctionApproverInTimesheetFlow = async function(timesheet, cachedSlug = null, cachedTitle = null) {
            try {
                if (!this.currentUser) {
                    console.log(' DEBUG: No current user for function approver check');
                    return false;
                }
                
                const slugify = (s) => String(s||'')
                    .normalize('NFD')
                    .replace(/\p{Diacritic}+/gu,'')
                    .trim()
                    .toLowerCase()
                    .replace(/[^a-z0-9\s-]/g,'')
                    .replace(/\s+/g,'-');
                const stripParen = (s) => String(s||'').replace(/\([^)]*\)/g, ' ').replace(/\s+/g, ' ').trim();
                const words = (s) => slugify(s).split('-').filter(w => w.length > 1);
                const acronym = (s) => (String(s||'')
                    .split(/\s+/)
                    .map(w => w.replace(/[^A-Za-z]/g,'').charAt(0))
                    .join('')
                    .toLowerCase());
                    
                let mySlug = cachedSlug || this._cachedCurrentUserJobTitleSlug || '';
                let myTitle = cachedTitle || this._cachedCurrentUserJobTitle || '';
                if (!mySlug) {
                    const rawJob = (this.currentUser.jobTitle || this.currentUser.title || this.currentUser.designation || this.currentUser.role || '');
                    myTitle = rawJob;
                    mySlug = slugify(rawJob);
                }
                const myTitleClean = stripParen(myTitle);
                const mySlugClean = slugify(myTitleClean);
                const myAcr = acronym(myTitleClean);
                
                console.log(' DEBUG Function Approver Check:', {
                    myTitle: myTitle,
                    mySlug: mySlug,
                    myTitleClean: myTitleClean,
                    mySlugClean: mySlugClean,
                    myAcronym: myAcr,
                    userFields: {
                        jobTitle: this.currentUser.jobTitle,
                        title: this.currentUser.title,
                        designation: this.currentUser.designation,
                        role: this.currentUser.role
                    }
                });
                
                if (!mySlug && !myTitle) {
                    console.log(' DEBUG: No job title/slug found for user');
                    return false;
                }

                const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                const flat = detailed.flat || [];
                
                console.log(' DEBUG Flow Details:', {
                    flatLength: flat.length,
                    detailed: detailed,
                    flat: flat
                });
                
                if (!flat.length) {
                    console.log(' DEBUG: No flat approval flow steps found');
                    return false;
                }

                const normalizeToken = (v) => slugify(stripParen(v)).toLowerCase();
                const tokenOverlap = (a, b) => {
                    const aw = new Set(words(a));
                    const bw = new Set(words(b));
                    if (aw.size === 0 || bw.size === 0) return false;
                    let common = 0;
                    aw.forEach(w => { if (bw.has(w)) common++; });
                    const ratio = common / Math.min(aw.size, bw.size);
                    return ratio >= 0.67; // require >= 2/3 word overlap
                };

                for (let i = 0; i < flat.length; i++) {
                    const step = flat[i];
                    if (!step) continue;
                    
                    const raw = step.label || step.role || step.function || step.text || '';
                    const rawClean = stripParen(raw);
                    console.log(` DEBUG Step ${i}:`, {
                        step: step,
                        raw: raw,
                        rawClean: rawClean,
                        stepFields: {
                            label: step.label,
                            role: step.role,
                            function: step.function,
                            text: step.text
                        }
                    });
                    
                    if (!raw) continue;
                    
                    const token = normalizeToken(raw);
                    console.log(` DEBUG Step ${i} Comparison:`, {
                        raw: raw,
                        token: token,
                        mySlug: mySlug,
                        mySlugClean: mySlugClean,
                        myTitle: myTitle,
                        myTitleClean: myTitleClean,
                        myAcronym: myAcr,
                        slugMatch: mySlug && token === mySlug,
                        slugCleanMatch: mySlugClean && token === mySlugClean,
                        titleMatch: myTitle && raw.trim().toLowerCase() === myTitle.trim().toLowerCase(),
                        functionSlugMatch: mySlug && (token === `function_${mySlug}` || token === `function-${mySlug}` || token === `function_${mySlugClean}` || token === `function-${mySlugClean}`),
                        overlapMatch: tokenOverlap(token, mySlugClean),
                        acronymMatch: !!myAcr && (token === myAcr)
                    });
                    
                    if (!token) continue;
                    if (mySlug && token === mySlug) {
                        console.log(' DEBUG: Slug match found!', { token, mySlug });
                        return true;
                    }
                    if (mySlugClean && token === mySlugClean) {
                        console.log(' DEBUG: Clean slug match found!', { token, mySlugClean });
                        return true;
                    }
                    // Also allow direct raw title lowercase match for edge cases
                    if (myTitle && raw.trim().toLowerCase() === myTitle.trim().toLowerCase()) {
                        console.log(' DEBUG: Title match found!', { raw: raw.trim().toLowerCase(), myTitle: myTitle.trim().toLowerCase() });
                        return true;
                    }
                    // Accept patterns like function_<slug>
                    if (mySlug && (token === `function_${mySlug}` || token === `function-${mySlug}` || token === `function_${mySlugClean}` || token === `function-${mySlugClean}`)) {
                        console.log(' DEBUG: Function slug match found!', { token, mySlug });
                        return true;
                    }
                    // Word overlap match (handles titles with extra words or parenthetical acronyms)
                    if (mySlugClean && tokenOverlap(token, mySlugClean)) {
                        console.log(' DEBUG: Word-overlap match found!', { token, mySlugClean });
                        return true;
                    }
                    // Acronym match (e.g., CEO for Chief Executive Officer)
                    if (myAcr && token === myAcr) {
                        console.log(' DEBUG: Acronym match found!', { token, myAcr });
                        return true;
                    }
                }
                
                console.log(' DEBUG: No matches found in approval flow');
                return false;
            } catch (e) {
                console.warn('isUserFunctionApproverInTimesheetFlow error', e);
                return false;
            }
        };

    ProfileManager.prototype.handleTimesheetApproval = async function(action) {
            // Get the current timesheet ID from either modal
            let timesheetId = null;
            
            // Check if edit modal is open
            const editModal = document.getElementById('timesheetModal');
            if (editModal && editModal.style.display !== 'none') {
                const tsIdField = document.getElementById('tsId');
                timesheetId = tsIdField ? tsIdField.value : null;
            }
            
            // Check if view modal is open
            const viewModal = document.getElementById('viewTimesheetModal');
            if (viewModal && viewModal.style.display !== 'none') {
                // Get ID from the currently viewed timesheet (stored in a data attribute or global var)
                timesheetId = this.currentViewTimesheetId;
            }
            
            if (!timesheetId) {
                this.showNotification('No timesheet selected', 'error');
                return;
            }
            
            let confirmed = false;
            let comment = '';
            
            switch (action) {
                case 'approve':
                    confirmed = confirm('Are you sure you want to approve this timesheet?');
                    if (confirmed) {
                        comment = prompt('Approval comment (optional):') || '';
                        const stepIdx = (typeof this.currentViewTimesheetNextStepIndex === 'number') ? this.currentViewTimesheetNextStepIndex : null;
                        await this.approveTimesheet(timesheetId, 'approved', comment, stepIdx);
                        
                        // Hide action buttons immediately after approval with debugging
                        console.log(' DEBUG: About to hide approval buttons after approval action');
                        const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
                        const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
                        const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
                        const approvalActions = document.getElementById('approvalActions');
                        
                        console.log(' DEBUG: Button elements found:', {
                            viewApproveBtn: !!viewApproveBtn,
                            viewDeclineBtn: !!viewDeclineBtn,
                            viewDeleteBtn: !!viewDeleteBtn,
                            approvalActions: !!approvalActions
                        });
                        
                        if (viewApproveBtn) {
                            viewApproveBtn.style.display = 'none';
                            console.log(' DEBUG: Set viewApproveBtn display to none');
                        }
                        if (viewDeclineBtn) {
                            viewDeclineBtn.style.display = 'none';
                            console.log(' DEBUG: Set viewDeclineBtn display to none');
                        }
                        if (viewDeleteBtn) {
                            viewDeleteBtn.style.display = 'none';
                            console.log(' DEBUG: Set viewDeleteBtn display to none');
                        }
                        if (approvalActions) {
                            approvalActions.style.display = 'none';
                            console.log(' DEBUG: Set approvalActions display to none');
                        }
                        
                        // Update current timesheet data status to prevent re-showing
                        if (this.currentViewTimesheetData) {
                            this.currentViewTimesheetData.status = 'approved';
                            console.log(' DEBUG: Updated currentViewTimesheetData status to approved');
                        }
                    }
                    break;
                    
                case 'decline':
                    comment = prompt('Please provide a reason for declining this timesheet:');
                    if (comment !== null) { // User didn't cancel
                        const stepIdx = (typeof this.currentViewTimesheetNextStepIndex === 'number') ? this.currentViewTimesheetNextStepIndex : null;
                        await this.approveTimesheet(timesheetId, 'rejected', comment, stepIdx);
                        confirmed = true; // Set for modal close logic
                        
                        // Hide action buttons immediately after decline
                        const viewApproveBtn = document.getElementById('viewApproveTimesheetBtn');
                        const viewDeclineBtn = document.getElementById('viewDeclineTimesheetBtn');
                        const viewDeleteBtn = document.getElementById('viewDeleteTimesheetBtn');
                        const approvalActions = document.getElementById('approvalActions');
                        if (viewApproveBtn) viewApproveBtn.style.display = 'none';
                        if (viewDeclineBtn) viewDeclineBtn.style.display = 'none';
                        if (viewDeleteBtn) viewDeleteBtn.style.display = 'none';
                        if (approvalActions) approvalActions.style.display = 'none';
                    }
                    break;
                    
                case 'delete':
                    confirmed = confirm('Are you sure you want to delete this timesheet? This action cannot be undone.');
                    if (confirmed) {
                        await this.deleteTimesheet(timesheetId);
                    }
                    break;
            }
            
            // Refresh the modal or close it
            if (confirmed || action === 'decline') {
                // Close the modal after action
                this.closeTimesheetModal();
                const viewModal = document.getElementById('viewTimesheetModal');
                if (viewModal) viewModal.style.display = 'none';
                
                // Refresh the timesheet list
                await this.loadUserTimesheets();
            }
        };

        ProfileManager.prototype.deleteTimesheet = async function(timesheetId) {
            if (!timesheetId) return;
            
            try {
                this.showLoading(true);
                await db.ref(`timesheets/${timesheetId}`).remove();
                
                // Also remove from payroll system if it exists there
                try {
                    this.removeTimesheetFromPayroll(timesheetId);
                    console.log(' Timesheet removed from payroll system');
                } catch (syncError) {
                    console.warn(' Failed to remove timesheet from payroll:', syncError);
                }
                
                this.showNotification('Timesheet deleted successfully', 'success');
                await this.loadUserTimesheets();
            } catch (error) {
                console.error('Error deleting timesheet:', error);
                this.showNotification('Failed to delete timesheet', 'error');
            } finally {
                this.showLoading(false);
            }
        };

        /**
         * Synchronize approved timesheet to payroll system (localStorage)
         * This enables the payroll pages to process the approved hours
         */
        ProfileManager.prototype.syncTimesheetToPayroll = async function(timesheetId) {
            if (!timesheetId) return;

            try {
                // Fetch the timesheet data from Firebase
                const tsSnap = await db.ref(`timesheets/${timesheetId}`).once('value');
                if (!tsSnap.exists()) {
                    console.warn('Timesheet not found:', timesheetId);
                    return;
                }

                const timesheet = tsSnap.val();
                
                // Only sync if status is approved
                if (timesheet.status !== 'approved') {
                    console.log(' Skipping sync - timesheet not fully approved:', timesheet.status);
                    return;
                }

                // Parse month (format: YYYY-MM)
                const monthParts = (timesheet.month || '').split('-');
                const year = monthParts[0] ? parseInt(monthParts[0]) : new Date().getFullYear();
                const month = monthParts[1] ? parseInt(monthParts[1]) : new Date().getMonth() + 1;

                // Calculate total hours and overtime hours
                let totalRegularHours = 0;
                let totalOvertimeHours = 0;
                const standardDailyHours = 8; // Standard 8-hour workday
                // Prefer the timesheet's allocatedWeeklyHours; otherwise fetch from contract; fallback to 40
                const allocatedWeeklyHours = (typeof timesheet.allocatedWeeklyHours === 'number' && timesheet.allocatedWeeklyHours > 0)
                    ? timesheet.allocatedWeeklyHours
                    : await this.fetchWorkingHoursForUserEmail(timesheet.submittedByEmail || (this.currentUser && this.currentUser.email) || '');
                const standardWeeklyHours = allocatedWeeklyHours || 40; // Standard weekly hours based on contract

                if (Array.isArray(timesheet.days)) {
                    // First pass: calculate total hours
                    const weeklyHours = {}; // Track hours per week for overtime calculation
                    
                    timesheet.days.forEach(day => {
                        const hours = parseFloat(day.hours) || 0;
                        totalRegularHours += hours;
                        
                        // Get week number for overtime calculation
                        const dayDate = new Date(day.date);
                        const weekNum = this.getWeekNumber(dayDate);
                        weeklyHours[weekNum] = (weeklyHours[weekNum] || 0) + hours;
                    });

                    // Calculate overtime (hours over 40 per week)
                    Object.values(weeklyHours).forEach(weekHours => {
                        if (weekHours > standardWeeklyHours) {
                            const overtime = weekHours - standardWeeklyHours;
                            totalOvertimeHours += overtime;
                            totalRegularHours -= overtime; // Remove from regular hours
                        }
                    });
                }

                // Get employee identifier (email or name)
                let employeeName = timesheet.submittedByEmail || timesheet.submittedBy || 'Unknown';
                
                // Try to get actual employee name from user data
                if (this.currentUser && timesheet.submittedBy === this.currentUser.uid) {
                    employeeName = this.currentUser.name || this.currentUser.displayName || employeeName;
                } else if (this.currentCompany && this.currentCompany.users) {
                    // Look up employee name from company users
                    const employeeData = Object.values(this.currentCompany.users).find(u => 
                        u.authUid === timesheet.submittedBy || u.uid === timesheet.submittedBy
                    );
                    if (employeeData) {
                        employeeName = employeeData.name || employeeData.displayName || employeeName;
                    }
                }

                // Get or create payroll.timesheets in localStorage
                let payrollTimesheets;
                try {
                    const stored = localStorage.getItem('payroll.timesheets');
                    payrollTimesheets = stored ? JSON.parse(stored) : { entries: [] };
                    if (!payrollTimesheets.entries) payrollTimesheets.entries = [];
                } catch (e) {
                    payrollTimesheets = { entries: [] };
                }

                // Check if this timesheet already exists in payroll
                const existingIndex = payrollTimesheets.entries.findIndex(entry => 
                    entry.id === timesheetId || 
                    (entry.employee === employeeName && entry.month === month && entry.year === year)
                );

                // Create payroll timesheet entry
                const payrollEntry = {
                    id: timesheetId,
                    employee: employeeName,
                    employeeId: timesheet.submittedBy,
                    month: month,
                    year: year,
                    hours: Math.round(totalRegularHours * 100) / 100,
                    otHours: Math.round(totalOvertimeHours * 100) / 100,
                    status: 'approved',
                    syncedAt: Date.now(),
                    syncedFrom: 'profile.html',
                    notes: timesheet.notes || '',
                    days: timesheet.days || []
                };

                // Update or add the entry
                if (existingIndex >= 0) {
                    payrollTimesheets.entries[existingIndex] = payrollEntry;
                    console.log(' Updated existing payroll timesheet entry');
                } else {
                    payrollTimesheets.entries.push(payrollEntry);
                    console.log(' Added new payroll timesheet entry');
                }

                // Save back to localStorage
                localStorage.setItem('payroll.timesheets', JSON.stringify(payrollTimesheets));
                
                console.log(' Timesheet synced to payroll:', {
                    id: timesheetId,
                    employee: employeeName,
                    month: `${year}-${month}`,
                    regularHours: totalRegularHours,
                    overtimeHours: totalOvertimeHours
                });

            } catch (error) {
                console.error(' Error syncing timesheet to payroll:', error);
                throw error;
            }
        };

        /**
         * Remove timesheet from payroll system
         */
        ProfileManager.prototype.removeTimesheetFromPayroll = function(timesheetId) {
            try {
                const stored = localStorage.getItem('payroll.timesheets');
                if (!stored) return;
                
                const payrollTimesheets = JSON.parse(stored);
                if (!payrollTimesheets.entries || !Array.isArray(payrollTimesheets.entries)) return;

                // Filter out the deleted timesheet
                payrollTimesheets.entries = payrollTimesheets.entries.filter(entry => entry.id !== timesheetId);
                
                // Save back to localStorage
                localStorage.setItem('payroll.timesheets', JSON.stringify(payrollTimesheets));
                
                console.log(' Timesheet removed from payroll system:', timesheetId);
            } catch (error) {
                console.error(' Error removing timesheet from payroll:', error);
            }
        };

        /**
         * Helper function to get ISO week number
         */
        ProfileManager.prototype.getWeekNumber = function(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        ProfileManager.prototype.approveTimesheet = async function(timesheetId, status, comment, stepIndex = null) {
            if (!timesheetId) return;
            try {
                this.showLoading(true);
                const now = Date.now();
                const entry = {
                    id: `APP-TS-${timesheetId}-${now}`,
                    sourceId: timesheetId,
                    sourceType: 'timesheet',
                    submittedAt: now,
                    submittedBy: this.currentUser ? this.currentUser.uid : 'unknown',
                    submittedByEmail: this.currentUser ? this.currentUser.email : '',
                    status,
                    comment: comment || '',
                    stepIndex: (stepIndex !== null) ? stepIndex : null
                };

                // Append or set into approvalHistory array
                const histRef = db.ref(`timesheets/${timesheetId}/approvalHistory`);
                const existingSnap = await histRef.once('value');
                const existing = existingSnap.exists() ? existingSnap.val() : [];
                let newHist = Array.isArray(existing) ? existing.slice() : [];
                if (stepIndex !== null) {
                    newHist[stepIndex] = entry;
                } else {
                    newHist.push(entry);
                }
                await histRef.set(newHist);

                // Compute new timesheet status based on flow length and approval result
                let newStatus = status;
                if (status === 'rejected') {
                    newStatus = 'rejected';
                } else if (status === 'approved') {
                    // try to determine company approval flow length
                    let companyFlowLen = null;
                    try {
                        const detailed = await this.fetchTimesheetApprovalFlowDetailed();
                        companyFlowLen = (detailed && detailed.flat) ? detailed.flat.length : null;
                    } catch (fErr) {
                        console.warn('could not read company flow length', fErr);
                    }

                    const appliedIndex = (entry.stepIndex !== null) ? entry.stepIndex : (newHist.length - 1);
                    if (companyFlowLen === null) {
                        newStatus = 'approved';
                    } else if (appliedIndex + 1 >= companyFlowLen) {
                        newStatus = 'approved';
                    } else {
                        newStatus = 'pending';
                    }
                }

                // Update timesheet status
                await db.ref(`timesheets/${timesheetId}/status`).set(newStatus);

                //  SYNC TO PAYROLL SYSTEM: If fully approved, synchronize with payroll localStorage
                if (newStatus === 'approved') {
                    try {
                        await this.syncTimesheetToPayroll(timesheetId);
                        console.log(' Timesheet synchronized to payroll system');
                    } catch (syncError) {
                        console.warn(' Failed to sync timesheet to payroll:', syncError);
                        // Don't fail the whole approval process if sync fails
                    }
                }

                this.showNotification(`Timesheet ${newStatus}`, 'success');
                await this.loadUserTimesheets();
            } catch (error) {
                console.error('Error approving timesheet', error);
                this.showNotification('Failed to update approval', 'error');
            } finally {
                this.showLoading(false);
            }
        };

        // Close view modal wiring (explicit button handler)
        const closeViewBtn = document.getElementById('closeViewTimesheetModal');
        if (closeViewBtn) {
            closeViewBtn.addEventListener('click', () => {
                const modal = document.getElementById('viewTimesheetModal');
                if (modal) modal.style.display = 'none';
            });
        }
        const exportPdfBtn = document.getElementById('exportViewTimesheetPdfBtn');
        if (exportPdfBtn) {
            exportPdfBtn.addEventListener('click', () => {
                if (window.profileManager && typeof window.profileManager.exportViewTimesheetToPdf === 'function') {
                    window.profileManager.exportViewTimesheetToPdf();
                }
            });
        }
        // Wire the View Timesheet modal Print/PDF button to open printable preview and trigger print
        const printViewBtn = document.getElementById('printViewTimesheetBtn');
        if (printViewBtn) {
            printViewBtn.addEventListener('click', async () => {
                try {
                    if (window.profileManager && typeof window.profileManager.openTimesheetPreview === 'function') {
                        await window.profileManager.openTimesheetPreview();
                        // Small delay ensures the overlay is in the DOM before invoking print
                        setTimeout(() => { try { window.print(); } catch {} }, 50);
                    }
                } catch (e) { console.warn('Failed to open print preview', e); }
            });
        }
    </script>
    <!-- Payslip Preview Modal -->
    <div id="payslipPreviewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2500; align-items:center; justify-content:center; padding:20px;">
        <div style="background:#fff; width:840px; max-width:100%; max-height:95vh; overflow:auto; border-radius:14px; box-shadow:0 10px 34px -4px rgba(0,0,0,0.25); position:relative;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0; font-size:0.95rem; display:flex; gap:8px; align-items:center;">
                    <i class="fas fa-file-invoice-dollar" style="color:#2563eb"></i>
                    <span id="payslipPreviewTitle">Payslip Preview</span>
                </h3>
                <div style="display:flex; gap:6px; align-items:center;">
                    <button id="downloadPayslipPdfBtn" class="btn-primary" style="font-size:0.65rem; display:inline-flex; gap:6px; align-items:center; padding:6px 10px;"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button id="closePayslipPreviewBtn" class="btn-primary" style="background:#e2e8f0; color:#334155; font-size:0.65rem; padding:6px 10px;">Close</button>
                </div>
            </div>
            <div id="payslipPreviewBody" style="padding:18px 20px 26px 20px; font-size:0.75rem; line-height:1.25;">
                <div style="text-align:center; color:#64748b;">Select a payslip to preview.</div>
            </div>
        </div>
    </div>
    <script>
    // Payslip preview generation based on templates & category
    (function(){
        function readJSON(k,d){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d;}catch{return d;} }
        function fmt(n,c){ try{const settings=readJSON('payroll.settings',{currency:'USD'});return new Intl.NumberFormat(undefined,{style:'currency',currency:settings.currency||c||'USD'}).format(Number(n||0));}catch{return n;}}
        function findTemplate(category){
            if(!category) return null;
            // Local templates store: category property is the grouping we need (not id)
            const raw=readJSON('payroll.payslipTemplates',{templates:[],items:[]});
            const arr=Array.isArray(raw.templates)?raw.templates:(Array.isArray(raw.items)?raw.items:[]);
            const norm = v=> String(v||'').trim().toLowerCase();
            return arr.find(t=> norm(t.category) === norm(category));
        }

        function buildPreviewHTML(ps, template){
            // Start from existing lines (already filtered earlier when listing in table)
            let earnings = (ps.lines?.earnings||[]).map(e=>({id:e.id, label:e.name||e.type, code:e.code, amount:Number(e.amount||0)}));
            let deductions = (ps.lines?.deductions||[]).map(d=>({id:d.id, label:d.name||d.type, code:d.code, amount:Number(d.amount||0)}));
            // If template is present with ID arrays, do a strict filter pass
            if(ps.category && template){
                const tplEarnIds = new Set(Array.isArray(template.earnings)? template.earnings.map(x=>String(x)): []);
                const tplDedIds  = new Set(Array.isArray(template.deductions)? template.deductions.map(x=>String(x)): []);
                if(tplEarnIds.size){ earnings = earnings.filter(l=> l.id && tplEarnIds.has(String(l.id))); }
                if(tplDedIds.size){ deductions = deductions.filter(l=> l.id && tplDedIds.has(String(l.id))); }
            }
            // Defensive: remove any undefined/NaN amounts
            earnings = earnings.filter(e=>!isNaN(e.amount));
            deductions = deductions.filter(d=>!isNaN(d.amount));
            const earnSum = earnings.reduce((s,e)=>s+e.amount,0);
            const dedSum = deductions.reduce((s,e)=>s+e.amount,0);
            const gross = Number(ps.basic||0)+earnSum; // recompute gross from template-only lines
            const tax = Number(ps.tax||0);
            const net = gross - dedSum - tax;
            const earnRows = earnings.length? earnings.map(e=>`<tr><td>${e.label||e.code||''}</td><td style=\"text-align:right\">${fmt(e.amount)}</td></tr>`).join('') : '<tr><td colspan="2" style="color:#64748b;font-size:.65rem;">No earnings</td></tr>';
            const dedRows = deductions.length? deductions.map(d=>`<tr><td>${d.label||d.code||''}</td><td style=\"text-align:right\">${fmt(d.amount)}</td></tr>`).join('') : '<tr><td colspan="2" style="color:#64748b;font-size:.65rem;">No deductions</td></tr>';
            return `
                <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:14px;margin-bottom:18px;">
                    <div>
                        <div style="font-weight:600;font-size:.8rem;">${ps.employee||'Employee'}</div>
                        <div style="color:#64748b;font-size:.65rem;">Period: ${ps.period}</div>
                        ${ps.category?`<div style=\"margin-top:4px;font-size:.6rem;background:#f1f5f9;display:inline-block;padding:2px 8px;border-radius:12px;letter-spacing:.5px;\">Category: ${ps.category}${(ps.category && !template)?' (no template)':''} </div>`:''}
                    </div>
                    <div style="text-align:right;font-size:.65rem;color:#475569;">Generated: ${new Date().toLocaleString()}</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;">
                    <div style="border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;">
                        <div style="background:#f8fafc;padding:8px 10px;font-weight:600;font-size:.65rem;letter-spacing:.5px;">EARNINGS</div>
                        <table style="width:100%;border-collapse:collapse;font-size:.7rem;">
                            <tbody>${earnRows}</tbody>
                            <tfoot><tr style=\"font-weight:600;border-top:1px solid #e2e8f0;\"><td>Total Earnings</td><td style=\"text-align:right\">${fmt(earnSum)}</td></tr></tfoot>
                        </table>
                    </div>
                    <div style="border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;">
                        <div style="background:#f8fafc;padding:8px 10px;font-weight:600;font-size:.65rem;letter-spacing:.5px;">DEDUCTIONS</div>
                        <table style="width:100%;border-collapse:collapse;font-size:.7rem;">
                            <tbody>${dedRows}</tbody>
                            <tfoot><tr style=\"font-weight:600;border-top:1px solid #e2e8f0;\"><td>Total Deductions</td><td style=\"text-align:right\">${fmt(dedSum)}</td></tr></tfoot>
                        </table>
                    </div>
                </div>
                <div style="margin-top:22px;display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
                    <div style="background:#f1f5f9;padding:10px 12px;border-radius:10px;font-size:.65rem;">
                        <div style="color:#64748b;letter-spacing:.5px;font-weight:600;">BASIC PAY</div>
                        <div style="font-size:.9rem;font-weight:600;margin-top:4px;">${fmt(ps.basic||0)}</div>
                    </div>
                    <div style="background:#f1f5f9;padding:10px 12px;border-radius:10px;font-size:.65rem;">
                        <div style="color:#64748b;letter-spacing:.5px;font-weight:600;">GROSS</div>
                        <div style="font-size:.9rem;font-weight:600;margin-top:4px;">${fmt(gross)}</div>
                    </div>
                    <div style="background:#f1f5f9;padding:10px 12px;border-radius:10px;font-size:.65rem;">
                        <div style="color:#64748b;letter-spacing:.5px;font-weight:600;">TAX</div>
                        <div style="font-size:.9rem;font-weight:600;margin-top:4px;">${fmt(tax)}</div>
                    </div>
                    <div style="background:#f1f5f9;padding:10px 12px;border-radius:10px;font-size:.65rem;">
                        <div style="color:#64748b;letter-spacing:.5px;font-weight:600;">NET PAY</div>
                        <div style="font-size:.95rem;font-weight:700;margin-top:4px;color:#065f46;">${fmt(net)}</div>
                    </div>
                </div>
            `;
        }

        function attachRowClicks(){
            const body=document.getElementById('payslipTableBody');
            if(!body) return;
            body.querySelectorAll('tr[data-row]').forEach(tr=>{
                tr.addEventListener('click', (e)=>{
                    if(e.target.closest('button[data-view-paylines]')) return; // ignore detail toggle button
                    const idx=tr.getAttribute('data-row');
                    const pm=window.profileManager; if(!pm || !pm._cachedPayslips) return;
                    const row = (pm._cachedPayslips||[])[idx]; if(!row) return;
                    // prepare payslip object for preview
                    const payslipObj={
                        employee: (pm.currentUser && (pm.currentUser.displayName||pm.currentUser.name))||'Employee',
                        period: row.period,
                        basic: row.basic,
                        lines: row.lines,
                        tax: row.tax,
                        category: row.category
                    };
                    const template=findTemplate(row.category);
                    const modal=document.getElementById('payslipPreviewModal');
                    const title=document.getElementById('payslipPreviewTitle');
                    const bodyEl=document.getElementById('payslipPreviewBody');
                    if(title) title.textContent = `Payslip ${row.period}`;
                    if(bodyEl) bodyEl.innerHTML = buildPreviewHTML(payslipObj, template);
                    if(modal){ modal.style.display='flex'; }
                });
            });
        }

        // Re-attach after each payslip rendering
        const origRender = ProfileManager.prototype.renderPayslipRows;
        if(typeof origRender === 'function'){
            ProfileManager.prototype.renderPayslipRows = function(){
                const r = origRender.apply(this, arguments);
                setTimeout(attachRowClicks, 10);
                return r;
            };
        }

        document.addEventListener('click', (e)=>{
            if(e.target.id==='closePayslipPreviewBtn'){
                const m=document.getElementById('payslipPreviewModal'); if(m) m.style.display='none';
            }
            if(e.target.id==='payslipPreviewModal'){
                e.target.style.display='none';
            }
        });
    })();
    </script>
    <script>
    // ATR tab redirects to recruitboard.html instead of in-page tab
    document.addEventListener('DOMContentLoaded', () => {
        const atrBtn = document.getElementById('atrTabBtn');
        if (atrBtn) {
            atrBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'recruitboard.html';
            });
        }
    });
    </script>

    <!-- Sign Documents Functionality -->
    <script>
    (function() {
        // PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // State
        const signState = {
            pdfDoc: null,
            pdfBytes: null,
            currentPage: 1,
            totalPages: 1,
            scale: 1.0,
            elements: [], // { type, data, x, y, width, height, page }
            selectedElement: null,
            selectedStamp: null,
            isDragging: false,
            dragOffset: { x: 0, y: 0 },
            initialized: false // Track if already initialized
        };

        // DOM Elements
        const $ = id => document.getElementById(id);

        // Initialize when tab is shown
        function initSignTab() {
            // Prevent duplicate initialization
            if (signState.initialized) return;
            
            const dropZone = $('pdfDropZone');
            const fileInput = $('pdfFileInput');

            if (!dropZone || !fileInput) return;
            
            signState.initialized = true;

            // Drop zone click
            dropZone.addEventListener('click', () => fileInput.click());

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePdfFile(e.target.files[0]);
                }
            });

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handlePdfFile(e.dataTransfer.files[0]);
                }
            });

            // Remove PDF button
            $('removePdfBtn')?.addEventListener('click', resetPdfViewer);

            // Navigation buttons
            $('prevPageBtn')?.addEventListener('click', () => goToPage(signState.currentPage - 1));
            $('nextPageBtn')?.addEventListener('click', () => goToPage(signState.currentPage + 1));

            // Zoom buttons
            $('zoomOutBtn')?.addEventListener('click', () => setZoom(signState.scale - 0.25));
            $('zoomInBtn')?.addEventListener('click', () => setZoom(signState.scale + 0.25));

            // Add signature button - open DocuSign-like create modal (draw/type/upload)
            $('addSignatureBtn')?.addEventListener('click', () => {
                if (window.profileManager && typeof window.profileManager.openSignatureCreateModal === 'function') {
                    window.profileManager.openSignatureCreateModal();
                } else {
                    // Fallback to basic draw modal if profile manager is not ready
                    openSignatureModal();
                }
            });

            // Add stamp button
            $('addStampBtn')?.addEventListener('click', openStampSelector);

            // Upload image button
            $('uploadImageBtn')?.addEventListener('click', () => $('stampImageInput')?.click());
            $('stampImageInput')?.addEventListener('change', handleImageUpload);

            // Add text button
            $('addTextBtn')?.addEventListener('click', openTextInput);

            // Add date button
            $('addDateBtn')?.addEventListener('click', addDateElement);

            // Undo button
            $('undoSignBtn')?.addEventListener('click', undoLastElement);

            // Clear all button
            $('clearAllBtn')?.addEventListener('click', clearAllElements);

            // Download button
            $('downloadSignedPdfBtn')?.addEventListener('click', downloadSignedPdf);

            // Signature modal events
            initSignatureCanvas();

            // Stamp selector events
            $('closeStampSelectorModal')?.addEventListener('click', closeStampSelector);
            $('cancelStampBtn')?.addEventListener('click', closeStampSelector);
            $('useStampBtn')?.addEventListener('click', useSelectedStamp);
            $('stampSelectorModal')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('stamp-selector-modal')) closeStampSelector();
            });

            // Text input events
            $('closeTextInputModal')?.addEventListener('click', closeTextInput);
            $('cancelTextInputBtn')?.addEventListener('click', closeTextInput);
            $('addTextToDocBtn')?.addEventListener('click', addTextElement);
            $('textInputModal')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('text-input-modal')) closeTextInput();
            });
        }

        // Handle PDF file upload
        async function handlePdfFile(file) {
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                // Store a copy of the original PDF bytes for later use with PDF-lib
                signState.pdfBytes = new Uint8Array(arrayBuffer.slice(0));
                // Create a separate copy for PDF.js rendering
                const pdfJsBytes = new Uint8Array(arrayBuffer.slice(0));
                signState.pdfDoc = await pdfjsLib.getDocument({ data: pdfJsBytes }).promise;
                signState.totalPages = signState.pdfDoc.numPages;
                signState.currentPage = 1;
                signState.scale = 1.0;
                signState.elements = [];
                // Store the original file name
                signState.fileName = file.name;

                // Update UI
                $('pdfFileName').textContent = file.name;
                $('pdfFileInfo').style.display = 'flex';
                $('signWorkspace').style.display = 'block';
                $('totalPages').textContent = signState.totalPages;
                $('zoomLevel').textContent = '100%';

                await renderPage(signState.currentPage);
            } catch (error) {
                console.error('Error loading PDF:', error);
                alert('Error loading PDF file. Please try again.');
            }
        }

        // Render PDF page
        async function renderPage(pageNum) {
            if (!signState.pdfDoc) return;

            const page = await signState.pdfDoc.getPage(pageNum);
            const canvas = $('pdfCanvas');
            const ctx = canvas.getContext('2d');

            const viewport = page.getViewport({ scale: signState.scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            $('currentPage').textContent = pageNum;
            signState.currentPage = pageNum;

            // Update overlay size
            const overlay = $('signatureOverlay');
            if (overlay) {
                overlay.style.width = canvas.width + 'px';
                overlay.style.height = canvas.height + 'px';
            }

            // Re-render elements for current page
            renderElements();
        }

        // Go to page
        function goToPage(pageNum) {
            if (pageNum < 1 || pageNum > signState.totalPages) return;
            renderPage(pageNum);
        }

        // Set zoom
        function setZoom(scale) {
            if (scale < 0.5 || scale > 3) return;
            signState.scale = scale;
            $('zoomLevel').textContent = Math.round(scale * 100) + '%';
            renderPage(signState.currentPage);
        }

        // Reset PDF viewer
        function resetPdfViewer() {
            signState.pdfDoc = null;
            signState.pdfBytes = null;
            signState.elements = [];
            signState.currentPage = 1;
            $('pdfFileInput').value = '';
            $('pdfFileInfo').style.display = 'none';
            $('signWorkspace').style.display = 'block';
            $('signatureOverlay').innerHTML = '';
        }

        // === Signature Canvas ===
        let sigCanvas, sigCtx, isDrawing = false;

        function initSignatureCanvas() {
            sigCanvas = $('signatureDrawCanvas');
            if (!sigCanvas) return;

            sigCtx = sigCanvas.getContext('2d');

            // Set canvas size
            const resizeCanvas = () => {
                const rect = sigCanvas.getBoundingClientRect();
                sigCanvas.width = rect.width;
                sigCanvas.height = 200;
                sigCtx.lineCap = 'round';
                sigCtx.lineJoin = 'round';
            };

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Drawing events
            const getPos = (e) => {
                const rect = sigCanvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            };

            sigCanvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const pos = getPos(e);
                sigCtx.beginPath();
                sigCtx.moveTo(pos.x, pos.y);
            });

            sigCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                sigCtx.strokeStyle = $('signatureColor')?.value || '#000080';
                sigCtx.lineWidth = parseInt($('signatureSize')?.value || 3);
                sigCtx.lineTo(pos.x, pos.y);
                sigCtx.stroke();
            });

            sigCanvas.addEventListener('mouseup', () => isDrawing = false);
            sigCanvas.addEventListener('mouseout', () => isDrawing = false);

            // Touch events
            sigCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                sigCtx.beginPath();
                sigCtx.moveTo(pos.x, pos.y);
            });

            sigCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const pos = getPos(e);
                sigCtx.strokeStyle = $('signatureColor')?.value || '#000080';
                sigCtx.lineWidth = parseInt($('signatureSize')?.value || 3);
                sigCtx.lineTo(pos.x, pos.y);
                sigCtx.stroke();
            });

            sigCanvas.addEventListener('touchend', () => isDrawing = false);

            // Clear button
            $('clearSignatureCanvas')?.addEventListener('click', () => {
                sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
            });

            // Modal events
            $('closeSignatureModal')?.addEventListener('click', closeSignatureModal);
            $('cancelSignatureBtn')?.addEventListener('click', closeSignatureModal);
            $('useSignatureBtn')?.addEventListener('click', useSignature);
            $('signatureDrawModal')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('signature-modal')) closeSignatureModal();
            });
        }

        // Add user's saved signature directly to document
        async function addUserSignature() {
            try {
                const signatureUrl = await getUserDefaultSignature();
                
                if (!signatureUrl) {
                    // No signature found - prompt user to create one
                    if (confirm('No signature found. Would you like to draw one now?')) {
                        openSignatureModal();
                    }
                    return;
                }
                
                // Convert URL to base64 for reliable embedding in PDF
                let signatureData = signatureUrl;
                if (!signatureUrl.startsWith('data:')) {
                    try {
                        signatureData = await convertUrlToBase64(signatureUrl);
                    } catch (e) {
                        console.warn('Could not convert signature URL to base64:', e);
                        signatureData = signatureUrl; // Fallback to URL
                    }
                }
                
                // Add signature directly to the document overlay
                addElementToOverlay('signature', signatureData, 200, 80);
                
            } catch (error) {
                console.error('Error adding signature:', error);
                // Fallback to modal if there's an error
                openSignatureModal();
            }
        }
        
        // Helper function to convert URL to base64
        async function convertUrlToBase64(url) {
            return new Promise((resolve, reject) => {
                const fetchAsDataUrl = () => {
                    fetch(url)
                        .then(res => {
                            if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
                            return res.blob();
                        })
                        .then(blob => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        })
                        .catch(reject);
                };

                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        // Can throw SecurityError if canvas is tainted by cross-origin image
                        resolve(canvas.toDataURL('image/png', 1.0));
                    } catch (e) {
                        // Fallback to fetch if canvas is tainted or toDataURL fails
                        fetchAsDataUrl();
                    }
                };
                img.onerror = () => {
                    // Try fetch as fallback
                    fetchAsDataUrl();
                };
                img.src = url;
            });
        }

        // Get user's default signature URL
        async function getUserDefaultSignature() {
            const companyId = await getCompanyId();
            if (!companyId) return null;

            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const uid = user.uid || firebase.auth().currentUser?.uid;
            if (!uid) return null;

            const userPath = `companies/${companyId}/users/${uid}`;
            
            // Get default signature ID and signatures
            const [defSnap, sigSnap] = await Promise.all([
                firebase.database().ref(`${userPath}/defaultSignatureId`).once('value'),
                firebase.database().ref(`${userPath}/signatures`).once('value')
            ]);
            
            const defaultId = defSnap.val();
            const signatures = sigSnap.val() || {};
            
            let signatureData = null;

            const pickSignatureValue = (sig) => sig?.imageData || sig?.url || null;

            if (defaultId && signatures[defaultId]) {
                signatureData = pickSignatureValue(signatures[defaultId]);
            } else {
                // No default set, try to get the most recent signature
                const ids = Object.keys(signatures);
                if (ids.length > 0) {
                    // Sort by createdAt descending
                    ids.sort((a, b) => (signatures[b].createdAt || 0) - (signatures[a].createdAt || 0));
                    signatureData = pickSignatureValue(signatures[ids[0]]);
                } else {
                    // Try legacy signatureUrl
                    const legacySnap = await firebase.database().ref(`${userPath}/signatureUrl`).once('value');
                    signatureData = legacySnap.val();
                }
            }

            return signatureData;
        }

        async function openSignatureModal() {
            const modal = $('signatureDrawModal');
            if (modal) {
                modal.classList.add('show');
                // Clear canvas first
                if (sigCtx && sigCanvas) {
                    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
                }
                
                // Load user's default signature
                await loadDefaultSignatureToCanvas();
            }
        }

        // Load user's default signature onto the canvas (for modal)
        async function loadDefaultSignatureToCanvas() {
            try {
                const signatureUrl = await getUserDefaultSignature();
                
                if (signatureUrl && sigCanvas && sigCtx) {
                    // Draw signature onto canvas
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
                        
                        // Calculate dimensions to fit and center
                        const canvasWidth = sigCanvas.width;
                        const canvasHeight = sigCanvas.height;
                        let drawWidth = img.width;
                        let drawHeight = img.height;
                        
                        // Scale down if needed while maintaining aspect ratio
                        const scaleX = (canvasWidth * 0.8) / drawWidth;
                        const scaleY = (canvasHeight * 0.8) / drawHeight;
                        const scale = Math.min(scaleX, scaleY, 1);
                        
                        drawWidth *= scale;
                        drawHeight *= scale;
                        
                        // Center the image
                        const x = (canvasWidth - drawWidth) / 2;
                        const y = (canvasHeight - drawHeight) / 2;
                        
                        sigCtx.drawImage(img, x, y, drawWidth, drawHeight);
                    };
                    img.onerror = () => {
                        console.warn('Failed to load default signature image');
                    };
                    img.src = signatureUrl;
                }
            } catch (error) {
                console.warn('Error loading default signature:', error);
            }
        }

        function closeSignatureModal() {
            const modal = $('signatureDrawModal');
            if (modal) modal.classList.remove('show');
        }

        function useSignature() {
            if (!sigCanvas) return;

            const dataUrl = sigCanvas.toDataURL('image/png');

            // Check if canvas has content
            const blank = document.createElement('canvas');
            blank.width = sigCanvas.width;
            blank.height = sigCanvas.height;
            if (sigCanvas.toDataURL() === blank.toDataURL()) {
                alert('Please draw a signature first');
                return;
            }

            addElementToOverlay('signature', dataUrl, 150, 60);
            closeSignatureModal();
        }

        // === Stamp Selector ===
        async function openStampSelector() {
            const modal = $('stampSelectorModal');
            const grid = $('stampGrid');
            if (!modal || !grid) return;

            modal.classList.add('show');
            signState.selectedStamp = null;
            $('useStampBtn').disabled = true;

            // Load stamps from Firebase
            try {
                const companyId = await getCompanyId();
                if (!companyId) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#64748b; padding:2rem;">No company found. Please log in.</div>';
                    return;
                }

                const snapshot = await firebase.database().ref(`companies/${companyId}/stamps`).once('value');

                if (!snapshot.exists()) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#64748b; padding:2rem;"><i class="fas fa-stamp" style="font-size:2rem; margin-bottom:0.5rem; display:block;"></i>No stamps found. Create stamps in Stamp Designer.</div>';
                    return;
                }

                const stamps = snapshot.val();
                grid.innerHTML = '';

                Object.entries(stamps).forEach(([id, stamp]) => {
                    const item = document.createElement('div');
                    item.className = 'stamp-item';
                    item.dataset.stampId = id;
                    // Use high-res image for preview if available
                    const previewSrc = stamp.imageData || stamp.thumbnail || '';
                    const hasHighRes = !!stamp.imageData;
                    const qualityBadge = !hasHighRes ? '<span style="position:absolute; top:2px; right:2px; background:#f59e0b; color:#fff; font-size:0.55rem; padding:1px 4px; border-radius:3px;" title="Re-save in Stamp Designer for better quality">Low Res</span>' : '';
                    item.innerHTML = `
                        <div style="position:relative;">
                            ${qualityBadge}
                            <img src="${previewSrc}" alt="${stamp.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23f1f5f9%22 width=%22100%22 height=%22100%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2210%22>No Preview</text></svg>'">
                        </div>
                        <div class="stamp-item-name">${stamp.name}</div>
                    `;
                    item.addEventListener('click', () => {
                        grid.querySelectorAll('.stamp-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        // Store full stamp with high-res imageData
                        signState.selectedStamp = {
                            ...stamp,
                            stampId: id,
                            hasHighRes: hasHighRes,
                            highResImage: stamp.imageData || stamp.thumbnail
                        };
                        $('useStampBtn').disabled = false;
                    });
                    grid.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading stamps:', error);
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#dc2626; padding:2rem;">Error loading stamps</div>';
            }
        }

        function closeStampSelector() {
            const modal = $('stampSelectorModal');
            if (modal) modal.classList.remove('show');
            signState.selectedStamp = null;
        }

        async function useSelectedStamp() {
            if (!signState.selectedStamp) return;
            
            // Use high-resolution image for better quality
            let stampImage = signState.selectedStamp.highResImage || signState.selectedStamp.imageData || signState.selectedStamp.thumbnail;
            if (!stampImage) return;
            
            // If we only have low-res thumbnail, upscale it for better quality
            if (!signState.selectedStamp.imageData && signState.selectedStamp.thumbnail) {
                stampImage = await upscaleImage(signState.selectedStamp.thumbnail, 600, 600);
            }
            
            // Ensure we have base64 data (not URL) for reliable PDF embedding
            if (stampImage && !stampImage.startsWith('data:')) {
                try {
                    stampImage = await convertUrlToBase64(stampImage);
                } catch (e) {
                    console.warn('Could not convert stamp URL to base64:', e);
                }
            }
            
            // Use larger default size for better quality display (200x200)
            addElementToOverlay('stamp', stampImage, 200, 200);
            closeStampSelector();
        }

        // Upscale low-resolution images for better quality
        async function upscaleImage(src, targetWidth, targetHeight) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    const ctx = canvas.getContext('2d');
                    
                    // Enable high-quality image smoothing
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Draw scaled up image
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                    
                    resolve(canvas.toDataURL('image/png', 1.0));
                };
                img.onerror = () => {
                    // Return original if upscale fails
                    resolve(src);
                };
                img.src = src;
            });
        }

        // === Text Input ===
        function openTextInput() {
            const modal = $('textInputModal');
            if (modal) {
                modal.classList.add('show');
                $('textInputField').value = '';
                $('textInputField').focus();
            }
        }

        function closeTextInput() {
            const modal = $('textInputModal');
            if (modal) modal.classList.remove('show');
        }

        function addTextElement() {
            const text = $('textInputField')?.value.trim();
            if (!text) {
                alert('Please enter some text');
                return;
            }

            const fontSize = parseInt($('textFontSize')?.value || 16);
            const color = $('textInputColor')?.value || '#000000';

            addElementToOverlay('text', { text, fontSize, color }, text.length * fontSize * 0.6, fontSize + 10);
            closeTextInput();
        }

        // === Date Element ===
        function addDateElement() {
            const today = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            addElementToOverlay('text', { text: today, fontSize: 14, color: '#000000' }, 150, 24);
        }

        // === Upload Image as Stamp ===
        function handleImageUpload(e) {
            const file = e.target.files?.[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (PNG, JPG, etc.)');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image file is too large. Maximum size is 5MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // Calculate dimensions maintaining aspect ratio
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 200;

                    if (width > height) {
                        if (width > maxSize) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }

                    // Create high-quality canvas for the image
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0);

                    // Convert to PNG for transparency support
                    const imageData = canvas.toDataURL('image/png', 1.0);
                    addElementToOverlay('stamp', imageData, width, height);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);

            // Reset input so same file can be uploaded again
            e.target.value = '';
        }

        // === Add Element to Overlay ===
        // Optionally pass x,y in overlay units (pre-scale) to position explicitly
        function addElementToOverlay(type, data, width, height, xOverride = null, yOverride = null) {
            const overlay = $('signatureOverlay');
            if (!overlay) return;

            const canvas = $('pdfCanvas');
            const element = {
                id: Date.now(),
                type,
                data,
                x: (xOverride !== null ? xOverride : (canvas.width / 2 - width / 2) / signState.scale),
                y: (yOverride !== null ? yOverride : (canvas.height / 2 - height / 2) / signState.scale),
                width: width / signState.scale,
                height: height / signState.scale,
                page: signState.currentPage
            };

            // If image element, normalize to data URL and precompute bytes for reliable embedding
            if ((type === 'signature' || type === 'stamp') && data) {
                const ensureDataUrl = async (src) => {
                    if (typeof src === 'string' && src.startsWith('data:')) return src;
                    try { return await convertUrlToBase64(src); } catch { return src; }
                };

                // Normalize to data URL (prefer PNG)
                // Note: this function is async; however addElementToOverlay is used from async flows already
                // We push element now and update bytes when ready
                (async () => {
                    element.data = await ensureDataUrl(element.data);
                    try {
                        const base64 = (element.data || '').split(',')[1] || '';
                        if (base64) {
                            element.bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                            element.mime = (element.data.includes('image/png')) ? 'image/png'
                                : (element.data.includes('image/jpeg') || element.data.includes('image/jpg')) ? 'image/jpeg'
                                : 'image/png';
                        }
                    } catch (_) { /* leave bytes undefined; export will try fallback */ }
                })();
            }

            signState.elements.push(element);
            renderElements();
        }
        // Expose to global scope for cross-script access
        window.addElementToOverlay = addElementToOverlay;

        // === Signature Placement Mode ===
        function startSignaturePlacement(imageData, defaultWidth = 200, defaultHeight = 80) {
            const wrapper = $('pdfCanvasWrapper');
            const overlay = $('signatureOverlay');
            const canvas = $('pdfCanvas');
            if (!wrapper || !overlay || !canvas) return;

            // Store placement state
            signState.placingElement = { type: 'signature', data: imageData, width: defaultWidth, height: defaultHeight };

            // Create ghost preview element
            let ghost = document.getElementById('signaturePlacementGhost');
            if (!ghost) {
                ghost = document.createElement('div');
                ghost.id = 'signaturePlacementGhost';
                ghost.style.position = 'absolute';
                ghost.style.pointerEvents = 'none';
                ghost.style.opacity = '0.7';
                ghost.style.zIndex = '10';
                overlay.appendChild(ghost);
            }
            ghost.innerHTML = '';
            const img = document.createElement('img');
            img.src = imageData;
            img.style.objectFit = 'contain';
            img.style.width = (defaultWidth * signState.scale) + 'px';
            img.style.height = (defaultHeight * signState.scale) + 'px';
            ghost.appendChild(img);

            const moveHandler = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches?.[0]?.clientX ?? e.clientX;
                const clientY = e.touches?.[0]?.clientY ?? e.clientY;
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                ghost.style.left = (x - (defaultWidth * signState.scale) / 2) + 'px';
                ghost.style.top = (y - (defaultHeight * signState.scale) / 2) + 'px';
            };
            const clickHandler = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches?.[0]?.clientX ?? e.clientX;
                const clientY = e.touches?.[0]?.clientY ?? e.clientY;
                const xPx = clientX - rect.left;
                const yPx = clientY - rect.top;
                const xOverlay = (xPx - signState.placingElement.width / 2) / signState.scale;
                const yOverlay = (yPx - signState.placingElement.height / 2) / signState.scale;
                addElementToOverlay('signature', imageData, signState.placingElement.width, signState.placingElement.height, xOverlay, yOverlay);
                cancelSignaturePlacement();
            };
            const escHandler = (e) => { if (e.key === 'Escape') cancelSignaturePlacement(); };

            // Attach listeners
            wrapper.addEventListener('mousemove', moveHandler);
            wrapper.addEventListener('touchmove', moveHandler, { passive: true });
            wrapper.addEventListener('click', clickHandler);
            document.addEventListener('keydown', escHandler);

            // Keep references to remove later
            signState._placeHandlers = { moveHandler, clickHandler, escHandler };
        }
        // Expose to global scope for cross-script access
        window.startSignaturePlacement = startSignaturePlacement;

        function cancelSignaturePlacement() {
            const wrapper = $('pdfCanvasWrapper');
            const ghost = document.getElementById('signaturePlacementGhost');
            if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
            if (signState._placeHandlers && wrapper) {
                wrapper.removeEventListener('mousemove', signState._placeHandlers.moveHandler);
                wrapper.removeEventListener('touchmove', signState._placeHandlers.moveHandler);
                wrapper.removeEventListener('click', signState._placeHandlers.clickHandler);
                document.removeEventListener('keydown', signState._placeHandlers.escHandler);
            }
            signState._placeHandlers = null;
            signState.placingElement = null;
        }

        // Ensure all overlay images are normalized to embeddable bytes before export
        async function normalizeElementsForExport() {
            const promises = [];
            for (const element of signState.elements) {
                if (element.type === 'signature' || element.type === 'stamp') {
                    if (element.bytes && element.bytes.length) continue;

                    promises.push((async () => {
                        try {
                            let dataUrl = element.data;
                            if (!dataUrl) return;
                            if (typeof dataUrl === 'string' && !dataUrl.startsWith('data:')) {
                                try {
                                    dataUrl = await convertUrlToBase64(dataUrl);
                                    element.data = dataUrl;
                                } catch (_) {
                                    // Leave as-is; export will handle signature-specific fallback/alert
                                }
                            }
                            if (typeof dataUrl === 'string' && dataUrl.startsWith('data:')) {
                                const base64 = dataUrl.split(',')[1] || '';
                                if (base64) {
                                    element.bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                                    element.mime = (dataUrl.includes('image/png')) ? 'image/png'
                                        : (dataUrl.includes('image/jpeg') || dataUrl.includes('image/jpg')) ? 'image/jpeg'
                                        : 'image/png';
                                }
                            }
                        } catch (_) {
                            // Swallow errors here; we'll handle hard failures during export
                        }
                    })());
                }
            }
            if (promises.length) {
                try { await Promise.all(promises); } catch (_) { /* ignore */ }
            }
        }

        // Render elements on overlay
        function renderElements() {
            const overlay = $('signatureOverlay');
            if (!overlay) return;

            overlay.innerHTML = '';

            signState.elements.forEach(el => {
                if (el.page !== signState.currentPage) return;

                const div = document.createElement('div');
                div.className = 'sign-element';
                div.dataset.id = el.id;
                div.style.left = (el.x * signState.scale) + 'px';
                div.style.top = (el.y * signState.scale) + 'px';
                div.style.pointerEvents = 'auto';

                if (el.type === 'signature' || el.type === 'stamp') {
                    const img = document.createElement('img');
                    img.src = el.data;
                    img.style.width = (el.width * signState.scale) + 'px';
                    img.style.height = (el.height * signState.scale) + 'px';
                    // High quality image rendering
                    img.style.imageRendering = 'high-quality';
                    img.style.objectFit = 'contain';
                    img.draggable = false;
                    div.appendChild(img);
                } else if (el.type === 'text') {
                    div.style.fontSize = (el.data.fontSize * signState.scale) + 'px';
                    div.style.color = el.data.color;
                    div.style.fontFamily = 'Arial, sans-serif';
                    div.style.whiteSpace = 'nowrap';
                    div.textContent = el.data.text;
                }

                // Controls
                const controls = document.createElement('div');
                controls.className = 'element-controls';
                controls.innerHTML = `
                    <button type="button" class="delete-el" title="Delete"><i class="fas fa-trash-alt"></i></button>
                `;
                controls.querySelector('.delete-el').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteElement(el.id);
                });
                div.appendChild(controls);

                // Resize handle
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                div.appendChild(resizeHandle);

                // Make draggable
                makeDraggable(div, el);
                makeResizable(div, el, resizeHandle);

                overlay.appendChild(div);
            });
        }

        // Make element draggable
        function makeDraggable(div, element) {
            let startX, startY, startLeft, startTop;

            const onMouseDown = (e) => {
                if (e.target.closest('.element-controls') || e.target.classList.contains('resize-handle')) return;
                e.preventDefault();
                signState.isDragging = true;
                div.classList.add('selected');

                startX = e.clientX || e.touches?.[0]?.clientX;
                startY = e.clientY || e.touches?.[0]?.clientY;
                startLeft = element.x * signState.scale;
                startTop = element.y * signState.scale;

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.addEventListener('touchmove', onMouseMove);
                document.addEventListener('touchend', onMouseUp);
            };

            const onMouseMove = (e) => {
                if (!signState.isDragging) return;
                const clientX = e.clientX || e.touches?.[0]?.clientX;
                const clientY = e.clientY || e.touches?.[0]?.clientY;

                const dx = clientX - startX;
                const dy = clientY - startY;

                element.x = (startLeft + dx) / signState.scale;
                element.y = (startTop + dy) / signState.scale;

                div.style.left = (startLeft + dx) + 'px';
                div.style.top = (startTop + dy) + 'px';
            };

            const onMouseUp = () => {
                signState.isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
            };

            div.addEventListener('mousedown', onMouseDown);
            div.addEventListener('touchstart', onMouseDown);
        }

        // Make element resizable
        function makeResizable(div, element, handle) {
            let startX, startY, startWidth, startHeight;

            const onMouseDown = (e) => {
                e.preventDefault();
                e.stopPropagation();

                startX = e.clientX || e.touches?.[0]?.clientX;
                startY = e.clientY || e.touches?.[0]?.clientY;
                startWidth = element.width * signState.scale;
                startHeight = element.height * signState.scale;

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.addEventListener('touchmove', onMouseMove);
                document.addEventListener('touchend', onMouseUp);
            };

            const onMouseMove = (e) => {
                const clientX = e.clientX || e.touches?.[0]?.clientX;
                const clientY = e.clientY || e.touches?.[0]?.clientY;

                const dx = clientX - startX;
                const dy = clientY - startY;

                const newWidth = Math.max(30, startWidth + dx);
                const newHeight = Math.max(20, startHeight + dy);

                element.width = newWidth / signState.scale;
                element.height = newHeight / signState.scale;

                const img = div.querySelector('img');
                if (img) {
                    img.style.width = newWidth + 'px';
                    img.style.height = newHeight + 'px';
                }
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
            };

            handle.addEventListener('mousedown', onMouseDown);
            handle.addEventListener('touchstart', onMouseDown);
        }

        // Delete element
        function deleteElement(id) {
            signState.elements = signState.elements.filter(el => el.id !== id);
            renderElements();
        }

        // Undo last element
        function undoLastElement() {
            signState.elements.pop();
            renderElements();
        }

        // Clear all elements
        function clearAllElements() {
            if (signState.elements.length === 0) return;
            if (confirm('Clear all signatures and stamps?')) {
                signState.elements = [];
                renderElements();
            }
        }

        // Get company ID helper
        async function getCompanyId() {
            // Try localStorage
            let user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (user.companyId) return user.companyId;

            // Try profileManager
            if (window.profileManager?.currentUser?.companyId) return window.profileManager.currentUser.companyId;

            // Search in Firebase
            const uid = user.uid || firebase.auth().currentUser?.uid;
            if (!uid) return null;

            try {
                const snapshot = await firebase.database().ref('companies').once('value');
                if (!snapshot.exists()) return null;

                for (const [cid, company] of Object.entries(snapshot.val())) {
                    if (company.users && company.users[uid]) {
                        return cid;
                    }
                }
            } catch (e) {
                console.error('Error finding company:', e);
            }
            return null;
        }

        // Download signed PDF using PDF-lib
        async function downloadSignedPdf() {
            if (!signState.pdfBytes || signState.elements.length === 0) {
                alert('No signatures or stamps to save');
                return;
            }

            // Normalize elements to embeddable bytes to avoid race conditions
            await normalizeElementsForExport();

            // Check if PDF-lib is available
            if (typeof PDFLib === 'undefined') {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            // Validate PDF bytes
            if (!(signState.pdfBytes instanceof Uint8Array) || signState.pdfBytes.length < 100) {
                alert('Invalid PDF data. Please re-upload the PDF file.');
                return;
            }

            // Check for PDF header
            const header = String.fromCharCode(...signState.pdfBytes.slice(0, 8));
            if (!header.startsWith('%PDF')) {
                console.error('Invalid PDF header:', header);
                alert('The uploaded file does not appear to be a valid PDF. Please re-upload.');
                return;
            }

            try {
                const { PDFDocument } = PDFLib;
                // Create a fresh copy of the bytes for PDF-lib
                const pdfBytesToLoad = new Uint8Array(signState.pdfBytes);
                const pdfDoc = await PDFDocument.load(pdfBytesToLoad, { ignoreEncryption: true });
                const pages = pdfDoc.getPages();

                for (const element of signState.elements) {
                    const page = pages[element.page - 1];
                    if (!page) continue;

                    const { width: pageWidth, height: pageHeight } = page.getSize();

                    // Convert coordinates (PDF origin is bottom-left)
                    const canvas = $('pdfCanvas');
                    // Map overlay CSS pixels to PDF points directly
                    const scaleX = pageWidth / canvas.width;
                    const scaleY = pageHeight / canvas.height;

                    const x = element.x * scaleX;
                    const y = pageHeight - (element.y * scaleY) - (element.height * scaleY);
                    const width = element.width * scaleX;
                    const height = element.height * scaleY;

                    if (element.type === 'signature' || element.type === 'stamp') {
                        try {
                            // Prefer precomputed bytes if available
                            if (element.bytes && element.bytes.length) {
                                let image;
                                // Assume PNG by default
                                const isPng = (element.mime || '').includes('png');
                                try {
                                    image = isPng ? await pdfDoc.embedPng(element.bytes) : await pdfDoc.embedJpg(element.bytes);
                                } catch {
                                    // Fallback to trying the other format
                                    try {
                                        image = isPng ? await pdfDoc.embedJpg(element.bytes) : await pdfDoc.embedPng(element.bytes);
                                    } catch {
                                        image = null;
                                    }
                                }
                                if (image) {
                                    // Preserve aspect ratio within bounds
                                    const imgAspect = image.width / image.height;
                                    const elemAspect = width / height;
                                    let drawWidth = width, drawHeight = height, drawX = x, drawY = y;
                                    if (imgAspect > elemAspect) {
                                        drawHeight = width / imgAspect;
                                        drawY = y + (height - drawHeight) / 2;
                                    } else {
                                        drawWidth = height * imgAspect;
                                        drawX = x + (width - drawWidth) / 2;
                                    }
                                    page.drawImage(image, { x: drawX, y: drawY, width: drawWidth, height: drawHeight });
                                    continue; // done embedding this element
                                }
                                // If bytes exist but embedding failed, and this is a signature, give guidance
                                if (element.type === 'signature') {
                                    throw new Error('Signature could not be embedded from bytes. Please re-save your signature via Profile  Security  Edit Signature, then try again.');
                                }
                            }

                            let imageData = element.data;
                            
                            // If it's a URL (not base64), fetch it and convert to base64
                            if (imageData && !imageData.startsWith('data:')) {
                                try {
                                    // Try Image loading first (works better for Firebase URLs)
                                    imageData = await new Promise((resolve, reject) => {
                                        const img = new Image();
                                        img.crossOrigin = 'anonymous';
                                        img.onload = () => {
                                            const canvas = document.createElement('canvas');
                                            canvas.width = img.naturalWidth;
                                            canvas.height = img.naturalHeight;
                                            const ctx = canvas.getContext('2d');
                                            ctx.drawImage(img, 0, 0);
                                            resolve(canvas.toDataURL('image/png', 1.0));
                                        };
                                        img.onerror = reject;
                                        img.src = imageData;
                                    }).catch(async () => {
                                        // Fallback to fetch
                                        const response = await fetch(imageData);
                                        const blob = await response.blob();
                                        return new Promise((resolve) => {
                                            const reader = new FileReader();
                                            reader.onloadend = () => resolve(reader.result);
                                            reader.readAsDataURL(blob);
                                        });
                                    });
                                } catch (fetchErr) {
                                    console.warn('Could not fetch image URL:', fetchErr);
                                    if (element.type === 'signature') {
                                        throw new Error('Signature could not be embedded. This usually happens because the signature is stored as a Firebase Storage URL without CORS access for download/reading. Please open Profile  Security  Edit Signature  Save once (this will store an embedded imageData), then download again.');
                                    }
                                    // For stamps/images: skip instead of failing the whole export
                                    continue;
                                }
                            }
                            
                            if (!imageData || !imageData.startsWith('data:')) {
                                console.warn('Invalid image data, skipping element');
                                continue;
                            }
                            
                            let image;
                            const base64Part = imageData.split(',')[1];
                            if (!base64Part) {
                                console.warn('No base64 data found, skipping element');
                                continue;
                            }
                            
                            const bytes = Uint8Array.from(atob(base64Part), c => c.charCodeAt(0));
                            
                            // Try PNG first, then JPG
                            if (imageData.includes('image/png')) {
                                image = await pdfDoc.embedPng(bytes);
                            } else if (imageData.includes('image/jpeg') || imageData.includes('image/jpg')) {
                                image = await pdfDoc.embedJpg(bytes);
                            } else {
                                // Try PNG first for unknown formats
                                try {
                                    image = await pdfDoc.embedPng(bytes);
                                } catch {
                                    try {
                                        image = await pdfDoc.embedJpg(bytes);
                                    } catch {
                                        console.warn('Could not embed image, skipping');
                                        if (element.type === 'signature') {
                                            throw new Error('Signature could not be embedded. Please re-save your signature via Profile  Security  Edit Signature and try again.');
                                        } else {
                                            continue;
                                        }
                                    }
                                }
                            }

                            if (image) {
                                // Calculate dimensions preserving aspect ratio
                                const imgAspect = image.width / image.height;
                                const elemAspect = width / height;
                                
                                let drawWidth = width;
                                let drawHeight = height;
                                let drawX = x;
                                let drawY = y;
                                
                                // Fit image within element bounds while preserving aspect ratio
                                if (imgAspect > elemAspect) {
                                    // Image is wider - fit to width
                                    drawHeight = width / imgAspect;
                                    drawY = y + (height - drawHeight) / 2;
                                } else {
                                    // Image is taller - fit to height
                                    drawWidth = height * imgAspect;
                                    drawX = x + (width - drawWidth) / 2;
                                }
                                
                                page.drawImage(image, {
                                    x: drawX,
                                    y: drawY,
                                    width: drawWidth,
                                    height: drawHeight
                                });
                            }
                        } catch (imgError) {
                            console.error('Error embedding image:', imgError);
                            // Continue with other elements instead of failing completely
                        }
                    } else if (element.type === 'text') {
                        try {
                            const { rgb } = PDFLib;
                            const hexToRgb = (hex) => {
                                const r = parseInt(hex.slice(1, 3), 16) / 255;
                                const g = parseInt(hex.slice(3, 5), 16) / 255;
                                const b = parseInt(hex.slice(5, 7), 16) / 255;
                                return rgb(r, g, b);
                            };

                            page.drawText(element.data.text, {
                                x,
                                y: y + height * 0.3,
                                size: element.data.fontSize * scaleY,
                                color: hexToRgb(element.data.color)
                            });
                        } catch (textError) {
                            console.error('Error adding text:', textError);
                        }
                    }
                }

                const pdfBytesModified = await pdfDoc.save();
                const blob = new Blob([pdfBytesModified], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = 'signed_document.pdf';
                link.click();

                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error creating signed PDF:', error);
                alert('Error creating signed PDF: ' + (error.message || 'Unknown error'));
            }
        }

        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initSignTab);

        // Also init when sign tab is shown
        const origSwitchTab = ProfileManager.prototype.switchTab;
        if (typeof origSwitchTab === 'function') {
            ProfileManager.prototype.switchTab = async function(tabName) {
                await origSwitchTab.call(this, tabName);
                if (tabName === 'sign') {
                    initSignTab();
                }
            };
        }
    })();
    </script>
</body>
</html>
