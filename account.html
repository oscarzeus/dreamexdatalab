<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Data Analysis Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Profile page specific styles */
        .account-container {
            max-width: 100%; /* Changed from 800px to 100% to fill full width */
            margin: 80px 0 0 0; /* Added 80px top margin (4x standard margin) */
            padding: 0;
            background-color: #ffffff;
            border-radius: 0; /* Removed border radius for full-width look */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .account-header {
            display: flex;
            align-items: center;
            padding: 40px;
            background: linear-gradient(120deg, #2c3e50, #3498db);
            color: #ffffff;
            position: relative;
            overflow: hidden;
            text-align: left; /* Ensure left alignment */
        }

        .account-header::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.1), transparent 70%);
            z-index: 1;
        }

        .profile-avatar {
            position: relative;
            margin-right: 30px;
            z-index: 2;
        }

        .profile-initial {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 600;
            border: 5px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .profile-image {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .avatar-edit-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 3;
        }

        .avatar-edit-btn:hover {
            background-color: #f8f9fa;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
        }
        
        .avatar-edit-btn svg {
            stroke: #2c3e50;
            transition: stroke 0.3s ease;
        }

        .avatar-edit-btn:hover svg {
            stroke: #3498db;
        }

        /* Hide the file input */
        #profileImageUpload {
            display: none;
        }

        .account-title {
            z-index: 2;
            text-align: left; /* Ensure left alignment */
        }

        .account-title h2 {
            margin: 0;
            color: #ffffff;
            font-size: 30px;
            font-weight: 700;
            text-align: left; /* Ensure left alignment */
        }

        .account-title p {
            margin: 8px 0 0;
            color: rgba(255, 255, 255, 0.85);
            font-size: 16px;
            text-align: left; /* Ensure left alignment */
        }

        .account-body {
            padding: 30px 40px 40px;
            text-align: left; /* Ensure left alignment */
        }

        .section-title {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 700;
            margin: 35px 0 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(52, 152, 219, 0.2);
            letter-spacing: 0.5px;
            text-align: left; /* Ensure left alignment */
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .account-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Form fields - each on its own line */
        .form-group {
            width: 100%;
            margin-bottom: 8px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #34495e;
            font-size: 15px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
            color: #333;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            background-color: #ffffff;
        }

        .form-group input::placeholder {
            color: #aab2bd;
        }

        .form-actions {
            display: flex;
            justify-content: flex-start; /* Changed from flex-end to align buttons to left */
            gap: 16px;
            margin-top: 20px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            letter-spacing: 0.5px;
        }

        .btn-save {
            background-color: #3498db;
            color: white;
        }

        .btn-save:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-cancel {
            background-color: #f8f9fa;
            color: #34495e;
            border: 1px solid #ddd;
        }

        .btn-cancel:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .success-message, .error-message {
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 8px;
            display: none;
            font-weight: 500;
            text-align: left; /* Ensure left alignment */
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        /* Loading spinner styles */
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @media (max-width: 768px) {
            .account-header {
                flex-direction: column;
                text-align: center;
                padding: 30px 20px;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 20px;
            }

            .account-body {
                padding: 25px 20px;
            }
            
            .form-actions {
                flex-direction: column-reverse;
                gap: 12px;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* User Avatar Styles (from index.html) */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            min-width: 150px;
            display: none;
            z-index: 1000;
        }
        
        .user-avatar-container:hover .user-dropdown {
            display: block;
        }
        
        .user-dropdown .user-email {
            padding: 5px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        
        .user-dropdown a {
            display: block;
            padding: 5px 0;
            color: #34495e;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s ease;
        }
        
        .user-dropdown a:hover {
            color: #e74c3c;
        }
        
        /* Styles for displaying user initials in avatar */
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-initial:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background-color: #2980b9;
        }

        /* Basic menu bar styles */
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .account-header {
                flex-direction: column;
                text-align: center;
                padding: 25px 20px;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 20px;
            }

            .account-body {
                padding: 25px 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .form-actions {
                flex-direction: column-reverse;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* Loading spinner styles */
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Dropdown styles for Risk Assessment menu - Added to match index.html */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%); /* positions the dropdown below the button */
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li class=""><a href="index.html">Home</a></li>
                <li><a href="riskassessment.html">Risk Assessment</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="account.html">Account</a></li>
                <li><a href="log.html">Log</a></li>
                <li><a href="evnt.html">Event</a></li>
                <li><a href="eventboard.html">Event Board</a></li>
            </ul>
            <ul class="menu-right">
                <!-- User Avatar/Login Button -->
                <li class="user-avatar-container">
                    <!-- This will be replaced by user initial when logged in -->
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar">
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">user@example.com</div>
                        <a href="profile.html">My Profile</a>
                        <a href="account.html">Account Settings</a>
                        <a href="#" id="logoutButton">Log Out</a>
                        <a href="login.html" id="loginButton" style="display: none;">Log In</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main style="width: 100%; padding: 0; margin: 0;">
        <div class="account-container">
            <div class="account-header">
                <div class="profile-avatar">
                    <div class="profile-initial" id="profileInitial">A</div>
                    <!-- File input for profile image upload -->
                    <input type="file" id="profileImageUpload" accept="image/*">
                    <div class="avatar-edit-btn" id="avatarEditBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                </div>
                <div class="account-title">
                    <h2>Account Settings</h2>
                    <p>Manage your profile and account preferences</p>
                </div>
            </div>

            <div class="account-body">
                <div class="success-message" id="successMessage">Your account information has been updated successfully.</div>
                <div class="error-message" id="errorMessage">There was an error updating your account information.</div>

                <form id="accountForm" class="account-form">
                    <h3 class="section-title">Personal Information</h3>
                    
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" placeholder="Enter your first name">
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" placeholder="Enter your last name">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" placeholder="Enter your phone number">
                    </div>
                    
                    <div class="form-group">
                        <label for="userIdNumber">ID Number</label>
                        <input type="text" id="userIdNumber" name="userIdNumber" placeholder="Enter your ID number">
                    </div>

                    <h3 class="section-title">Company Information</h3>
                    
                    <div class="form-group">
                        <label for="companyName">Company Name</label>
                        <input type="text" id="companyName" name="companyName" placeholder="Enter your company name">
                    </div>
                    
                    <div class="form-group">
                        <label for="position">Position</label>
                        <input type="text" id="position" name="position" placeholder="Enter your position">
                    </div>
                    
                    <div class="form-group">
                        <label for="lineManager">Line Manager</label>
                        <select id="lineManager" name="lineManager">
                            <option value="">Select Line Manager</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <h3 class="section-title">Security</h3>
                    
                    <div class="form-group">
                        <label for="password">New Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter new password">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" id="cancelButton">Cancel</button>
                        <button type="submit" class="btn btn-save">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
        authDomain: "users-8be65.firebaseapp.com",
        databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
        projectId: "users-8be65",
        storageBucket: "users-8be65.appspot.com",
        messagingSenderId: "829083030831",
        appId: "1:829083030831:web:36a370e62691e560bc3dda"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Get references to Firebase services
    const storage = firebase.storage();
    const database = firebase.database();
    
    // Global reference to DOM elements we'll need throughout the code
    let successMessage, errorMessage, profileInitial, profileImageUpload;

    document.addEventListener("DOMContentLoaded", function() {
        // Get references to DOM elements
        const accountForm = document.getElementById('accountForm');
        successMessage = document.getElementById('successMessage');
        errorMessage = document.getElementById('errorMessage');
        const cancelButton = document.getElementById('cancelButton');
        profileInitial = document.getElementById('profileInitial');
        const avatarEditBtn = document.getElementById('avatarEditBtn');
        profileImageUpload = document.getElementById('profileImageUpload');
        
        // Check if user is logged in
        const userId = localStorage.getItem("userId");
        if (!userId) {
            window.location.href = "login.html";
            return;
        }
        
        // Load user data from Firebase
        loadUserData(userId);
        
        // Load site users for line manager dropdown
        loadSiteUsers();
        
        // Setup form submission
        accountForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Save user data
            saveUserData(userId);
        });
        
        // Handle cancel button
        cancelButton.addEventListener('click', function() {
            window.location.href = "index.html";
        });
        
        // Handle avatar edit button click
        avatarEditBtn.addEventListener('click', function() {
            profileImageUpload.click();
        });
        
        // Handle file selection - SINGLE EVENT HANDLER
        profileImageUpload.addEventListener('change', handleFileSelection);
        
        // User Avatar in navigation
        updateUserAvatar(userId);
        
        // Setup real-time profile listener
        setupProfileListener(userId);
    });
    
    // Handle file selection
    function handleFileSelection(e) {
        console.log("File selection triggered");
        if (this.files && this.files[0]) {
            const file = this.files[0];
            
            // Validate file type
            if (!file.type.match('image.*')) {
                errorMessage.textContent = "Please select a valid image file.";
                errorMessage.style.display = 'block';
                return;
            }
            
            // File size check (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
                errorMessage.textContent = "File size too large. Please select an image under 5MB.";
                errorMessage.style.display = 'block';
                return;
            }
            
            // Get user ID
            const userId = localStorage.getItem("userId");
            if (!userId) {
                errorMessage.textContent = "User not authenticated. Please log in again.";
                errorMessage.style.display = 'block';
                return;
            }
            
            console.log("Starting image upload process");
            
            // Show loading spinner
            showLoadingSpinner();
            
            // Clear any previous error messages
            errorMessage.style.display = 'none';
            
            // Show upload message
            successMessage.textContent = "Preparing to upload...";
            successMessage.style.display = 'block';
            
            // Upload the file
            uploadUserPhoto(file, userId);
        }
    }

    // Function to show loading spinner
    function showLoadingSpinner() {
        // Hide the initial
        profileInitial.style.display = 'none';
        
        // Remove existing profile image if any
        const existingImage = document.querySelector('.profile-image');
        if (existingImage) {
            existingImage.remove();
        }
        
        // Remove any existing spinner
        const existingSpinner = document.querySelector('.loading-spinner');
        if (existingSpinner) {
            existingSpinner.remove();
        }
        
        // Create and add loading spinner
        const profileAvatarContainer = document.querySelector('.profile-avatar');
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'loading-spinner';
        
        // Add loading spinner to container
        profileAvatarContainer.appendChild(loadingSpinner);
    }
    
    // Function to remove loading spinner
    function removeLoadingSpinner() {
        const loadingSpinner = document.querySelector('.loading-spinner');
        if (loadingSpinner) {
            loadingSpinner.remove();
        }
    }
    
    // Function to upload profile image to Firebase
    function uploadUserPhoto(file, userId) {
        console.log("uploadUserPhoto called with", file.name, "for user", userId);
        
        if (!file || !userId) {
            console.error("Missing file or userId");
            errorMessage.textContent = "Missing file or user information";
            errorMessage.style.display = 'block';
            removeLoadingSpinner();
            return;
        }
        
        try {
            // First update user profile with upload status
            database.ref(`users/${userId}`).update({
                profileImageStatus: 'uploading',
                lastImageUpdate: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Create a storage reference
            const storageRef = storage.ref();
            const timestamp = Date.now();
            const fileRef = storageRef.child(`profile_images/${userId}/profile_${timestamp}.jpg`);
            
            console.log("Uploading to:", fileRef.fullPath);
            
            // Upload the file
            const uploadTask = fileRef.put(file);
            
            // Listen for state changes
            uploadTask.on('state_changed', 
                // Progress function
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload progress: ' + progress + '% done');
                    
                    // Update progress in real-time database
                    database.ref(`users/${userId}`).update({
                        profileImageProgress: Math.round(progress)
                    });
                    
                    successMessage.textContent = `Uploading: ${Math.round(progress)}%`;
                },
                // Error function
                (error) => {
                    console.error('Upload failed:', error);
                    
                    // Update database with error status
                    database.ref(`users/${userId}`).update({
                        profileImageStatus: 'error',
                        profileImageError: error.message
                    });
                    
                    removeLoadingSpinner();
                    errorMessage.textContent = `Upload failed: ${error.message}`;
                    errorMessage.style.display = 'block';
                    successMessage.style.display = 'none';
                    profileInitial.style.display = 'flex';
                },
                // Success function
                () => {
                    console.log('Upload successful');
                    
                    // Get download URL
                    uploadTask.snapshot.ref.getDownloadURL()
                        .then((downloadURL) => {
                            console.log('File available at', downloadURL);
                            
                            // Store the complete data in the Realtime Database
                            const updates = {
                                profileImage: downloadURL,
                                photoURL: downloadURL, // For compatibility
                                profileImageStatus: 'complete',
                                profileImageTimestamp: firebase.database.ServerValue.TIMESTAMP,
                                profileImageMetadata: {
                                    contentType: file.type,
                                    size: file.size,
                                    lastModified: file.lastModified,
                                    name: file.name,
                                    storagePath: fileRef.fullPath
                                }
                            };
                            
                            // Update database with complete image data
                            return database.ref(`users/${userId}`).update(updates);
                        })
                        .then(() => {
                            console.log('Profile image URL saved to database');
                            removeLoadingSpinner();
                            successMessage.textContent = "Profile picture updated successfully!";
                            successMessage.style.display = 'block';
                            
                            // Add a listener for real-time changes to the user profile
                            const userRef = database.ref(`users/${userId}`);
                            userRef.once('value')
                                .then(snapshot => {
                                    const userData = snapshot.val();
                                    
                                    // Update UI with the latest data
                                    if (userData && userData.profileImage) {
                                        updateProfileImage(userData.profileImage);
                                        updateUserAvatar(userId);
                                    }
                                    
                                    // Add a short delay before page reload for UI updates to complete
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                });
                        })
                        .catch((error) => {
                            console.error('Error saving to database:', error);
                            
                            // Update database with error status
                            database.ref(`users/${userId}`).update({
                                profileImageStatus: 'error',
                                profileImageError: error.message
                            });
                            
                            removeLoadingSpinner();
                            errorMessage.textContent = `Error: ${error.message}`;
                            errorMessage.style.display = 'block';
                            successMessage.style.display = 'none';
                        });
                }
            );
        } catch (error) {
            console.error("Exception during upload:", error);
            
            // Update database with error status
            database.ref(`users/${userId}`).update({
                profileImageStatus: 'error',
                profileImageError: error.message
            });
            
            removeLoadingSpinner();
            errorMessage.textContent = `Upload error: ${error.message}`;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }
    }

    // Function to validate form
    function validateForm() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Reset messages
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        
        // Validate email
        if (!email || !email.includes('@')) {
            errorMessage.textContent = "Please enter a valid email address.";
            errorMessage.style.display = 'block';
            return false;
        }
        
        // Check if passwords match (if provided)
        if (password && password !== confirmPassword) {
            errorMessage.textContent = "Passwords do not match.";
            errorMessage.style.display = 'block';
            return false;
        }
        
        return true;
    }
    
    // Load user data from Firebase
    function loadUserData(userId) {
        console.log("Loading user data for:", userId);
        
        database.ref(`users/${userId}`).once('value')
            .then((snapshot) => {
                const userData = snapshot.val() || {};
                console.log("User data loaded:", userData);
                
                // Populate form fields
                document.getElementById('firstName').value = userData.firstName || '';
                document.getElementById('lastName').value = userData.lastName || '';
                document.getElementById('email').value = userData.email || localStorage.getItem('userEmail') || '';
                document.getElementById('phone').value = userData.phone || ''; // Added phone field
                
                // Populate other fields
                document.getElementById('userIdNumber').value = userData.userIdNumber || '';
                document.getElementById('position').value = userData.position || '';
                document.getElementById('companyName').value = userData.companyName || '';
                
                // Set line manager if available
                if (userData.lineManager) {
                    document.getElementById('lineManager').value = userData.lineManager;
                }
                
                // Store basic user info in localStorage for quick access
                localStorage.setItem('userFirstName', userData.firstName || '');
                localStorage.setItem('userLastName', userData.lastName || '');
                
                // Update profile avatar
                if (userData.profileImage) {
                    console.log("Profile image found in user data:", userData.profileImage);
                    updateProfileImage(userData.profileImage);
                } else {
                    console.log("No profile image found for user");
                    updateProfileImage(null);
                }
            })
            .catch((error) => {
                console.error("Error loading user data:", error);
                errorMessage.textContent = "Error loading user data: " + error.message;
                errorMessage.style.display = 'block';
            });
    }
    
    // Update profile image or show initial - SIMPLIFIED AND FIXED
    function updateProfileImage(imageUrl) {
        if (!imageUrl) {
            console.log("No image URL provided");
            profileInitial.style.display = 'flex';
            return;
        }
        
        console.log("Setting image:", imageUrl);
        
        const firstName = document.getElementById('firstName').value;
        const email = document.getElementById('email').value;
        
        // Get profile avatar container
        const profileAvatarContainer = document.querySelector('.profile-avatar');
        
        // Remove existing image if any
        const existingImage = profileAvatarContainer.querySelector('.profile-image');
        if (existingImage) {
            profileAvatarContainer.removeChild(existingImage);
        }
        
        // Hide the initial
        profileInitial.style.display = 'none';
        
        // Create direct image element
        const imgElement = document.createElement('img');
        
        // Add cache buster to force fresh image
        const cacheBuster = `?t=${new Date().getTime()}`;
        imgElement.src = `${imageUrl}${cacheBuster}`;
        imgElement.alt = "Profile";
        imgElement.className = "profile-image";
        
        // Handle load success
        imgElement.onload = function() {
            console.log("Image loaded successfully");
        };
        
        // Handle load error
        imgElement.onerror = function(e) {
            console.error("Failed to load image:", e);
            imgElement.style.display = 'none';
            profileInitial.style.display = 'flex';
            
            // Set initial text
            let initial = "?";
            if (firstName && firstName.length > 0) {
                initial = firstName.charAt(0).toUpperCase();
            } else if (email && email.length > 0) {
                initial = email.charAt(0).toUpperCase();
            }
            profileInitial.textContent = initial;
        };
        
        // Add image to container
        profileAvatarContainer.insertBefore(imgElement, profileImageUpload);
    }
    
    // Save user data to Firebase
    function saveUserData(userId) {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value; // Added phone field
        const password = document.getElementById('password').value;
        const lineManager = document.getElementById('lineManager').value;
        const userIdNumber = document.getElementById('userIdNumber').value;
        const position = document.getElementById('position').value;
        const companyName = document.getElementById('companyName').value;
        
        // Prepare user data
        const userData = {
            firstName,
            lastName,
            email,
            phone, // Added phone field
            lineManager,
            userIdNumber,
            position,
            companyName,
            updatedAt: new Date().toISOString()
        };
        
        // Only update password if provided
        if (password) {
            // In a real app, this would involve proper authentication
            // For this example, we'll just store it directly
            userData.password = password;
        }
        
        // Update the database
        database.ref(`users/${userId}`).update(userData)
            .then(() => {
                // Update localStorage for basic info
                localStorage.setItem('userFirstName', firstName);
                localStorage.setItem('userLastName', lastName);
                localStorage.setItem('userEmail', email);
                
                // Show success message
                successMessage.textContent = "Your account information has been updated successfully.";
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                
                // Update avatar
                updateUserAvatar(userId);
                
                // Scroll to top to show the success message
                window.scrollTo(0, 0);
            })
            .catch((error) => {
                console.error("Error updating user data:", error);
                errorMessage.textContent = "Error: " + error.message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            });
    }
    
    // Update user avatar in navigation - SIMPLIFIED
    function updateUserAvatar(userId) {
        console.log("Updating navigation avatar");
        
        // Get references
        const avatarContainer = document.getElementById('userAvatarContainer');
        const userEmail = localStorage.getItem("userEmail") || "user@example.com";
        const userFirstName = localStorage.getItem("userFirstName") || "";
        
        // Update email in dropdown
        document.getElementById('userEmail').textContent = userEmail;
        
        // Get fresh data from Firebase
        database.ref(`users/${userId}`).once('value')
            .then((snapshot) => {
                const userData = snapshot.val() || {};
                const profileUrl = userData.profileImage;
                
                if (profileUrl) {
                    // Force fresh image with cache buster
                    const cacheBuster = `?t=${new Date().getTime()}`;
                    
                    // Create direct image element
                    const imgElement = document.createElement('img');
                    imgElement.src = `${profileUrl}${cacheBuster}`;
                    imgElement.alt = "Profile";
                    imgElement.className = "user-avatar";
                    
                    // Handle success
                    imgElement.onload = function() {
                        console.log("Avatar loaded successfully");
                        
                        // Replace current content
                        avatarContainer.innerHTML = '';
                        avatarContainer.appendChild(imgElement);
                    };
                    
                    // Handle error
                    imgElement.onerror = function() {
                        console.error("Failed to load avatar");
                        
                        // Show initials instead
                        let initial = userFirstName ? 
                            userFirstName.charAt(0).toUpperCase() : 
                            userEmail.charAt(0).toUpperCase();
                        
                        avatarContainer.innerHTML = `<div class="user-initial">${initial}</div>`;
                    };
                    
                    // Start loading the image
                    imgElement.src = `${profileUrl}${cacheBuster}`;
                } else {
                    // No image, use initials
                    let initial = userFirstName ? 
                        userFirstName.charAt(0).toUpperCase() : 
                        userEmail.charAt(0).toUpperCase();
                    
                    avatarContainer.innerHTML = `<div class="user-initial">${initial}</div>`;
                }
            })
            .catch((error) => {
                console.error("Error fetching user data:", error);
                
                // Fallback to initials
                let initial = userFirstName ? 
                    userFirstName.charAt(0).toUpperCase() : 
                    userEmail.charAt(0).toUpperCase();
                
                avatarContainer.innerHTML = `<div class="user-initial">${initial}</div>`;
            });
    }

    // Add a real-time listener for user profile changes
    function setupProfileListener(userId) {
        if (!userId) return;
        
        const userRef = database.ref(`users/${userId}`);
        userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            if (!userData) return;
            
            // Update profile progress if uploading
            if (userData.profileImageStatus === 'uploading' && userData.profileImageProgress) {
                successMessage.textContent = `Uploading: ${userData.profileImageProgress}%`;
                successMessage.style.display = 'block';
            }
            
            // Update profile image if available
            if (userData.profileImage) {
                updateProfileImage(userData.profileImage);
            }
        });
        
        // Clean up listener on page unload
        window.addEventListener('beforeunload', () => {
            userRef.off();
        });
    }
    
    // Function to load site users for the line manager dropdown
    function loadSiteUsers() {
        const lineManagerSelect = document.getElementById('lineManager');
        
        // Get current user ID to exclude from the list (you can't be your own manager)
        const currentUserId = localStorage.getItem("userId");
        
        // Reference to users in Firebase
        const usersRef = database.ref('users');
        
        // Fetch all users
        usersRef.once('value')
            .then((snapshot) => {
                const users = snapshot.val();
                
                // Clear existing options except the first default one
                while (lineManagerSelect.options.length > 1) {
                    lineManagerSelect.remove(1);
                }
                
                // Add users as options
                for (const userId in users) {
                    if (userId === currentUserId) continue; // Skip current user
                    
                    const user = users[userId];
                    const displayName = user.firstName && user.lastName ? 
                                        `${user.firstName} ${user.lastName}` : 
                                        user.email || 'Unknown User';
                    
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = displayName;
                    lineManagerSelect.appendChild(option);
                }
            })
            .catch((error) => {
                console.error("Error loading site users:", error);
            });
    }
</script>
</body>
</html>
