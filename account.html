<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- External CSS Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Local CSS Dependencies -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/modal-styles.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    
    <script type="module" src="js/firebase-config.js"></script>
    <script>
    
    
    

    

    // Remove any sidebar <li> elements that are not visible and clean up empty dropdowns
    function pruneSidebarMenu() {
        try {
            const menu = document.getElementById('roleBasedMenu');
            if (!menu) return;

            // Remove non-visible leaf items
            const allItems = menu.querySelectorAll('li[data-feature]');
            allItems.forEach(li => {
                if (!li.classList.contains('menu-visible')) {
                    // If it's an ancestor dropdown, don't remove yet (we'll clean dropdowns separately)
                    const isDropdown = li.classList.contains('menu-dropdown');
                    if (!isDropdown) li.remove();
                }
            });

            // Clean dropdowns: remove empty dropdowns or dropdowns with no visible children
            const dropdowns = menu.querySelectorAll('li.menu-dropdown');
            dropdowns.forEach(dd => {
                const submenu = dd.querySelector('.submenu');
                if (!submenu) { dd.remove(); return; }
                const visibleChildren = submenu.querySelectorAll('li.menu-visible');
                if (visibleChildren.length === 0) {
                    dd.remove();
                } else {
                    // Remove any non-visible children left behind
                    submenu.querySelectorAll('li').forEach(child => { if (!child.classList.contains('menu-visible')) child.remove(); });
                }
            });

            console.log('🧹 Sidebar pruned: only authorized menu items remain');
        } catch (e) {
            console.error('❌ Error pruning sidebar menu:', e);
        }
    }
    document.addEventListener('DOMContentLoaded', () => { updateMenuWithFeatureAuthorization(); });
    </script>
    <style>
        /* Base Font Size - Match Staff Management */
        :root {
            --base-font-size: 0.9rem;
        }
        
        body {
            font-size: var(--base-font-size);
        }
        
        /* Fixed Header Styles */
        .top-nav {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 0; /* remove rounded corners from header */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
            height: 60px;
        }

        /* Main content adjustment for fixed header */
        .main-content {
            padding-top: 60px;
        }

        /* Top nav logo styles */
        .top-nav .company-logo {
            height: 40px;
            width: auto;
            margin-right: 20px;
            object-fit: contain;
        }

        /* Top Navigation Logo */
        .top-nav-logo {
            height: 40px;
            margin-right: 1rem;
            object-fit: contain;
        }

        /* Ensure top-nav-left displays properly */
        .top-nav-left {
            display: flex;
            align-items: center;
        }        /* Ensure top-nav-right displays properly */
        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Profile Dropdown Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Header Company Branding Styles */
        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo, .company-logo {
            width: 40px;
            height: 40px;
            border-radius: 0; /* remove round corners */
            object-fit: cover;
            border: none; /* remove border */
            display: none;
        }

        .header-company-logo.visible, .company-logo.visible {
            display: block;
        }
        
            /* Header logo: match accessboard (no background, no border, no shadow) */
            #headerCompanyLogo{
                width:44px;height:44px;object-fit:cover;display:none;background:transparent;border:none;box-shadow:none;
            }
            #headerCompanyLogo.visible{display:block}
            .header-logo-placeholder{width:40px;height:40px;background:transparent;display:flex;align-items:center;justify-content:center;margin-right:12px;border-radius:0}

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 0; /* square placeholder */
            background: transparent; /* remove gray background */
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1rem;
        }

        .company-name-header, #headerCompanyName {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
            margin-left: 0.75rem;
        }

        @media (max-width: 768px) {
            .header-company-logo, .header-logo-placeholder, .company-logo {
                width: 32px;
                height: 32px;
            }
            
            .company-name-header, #headerCompanyName {
                font-size: 1rem;
                margin-left: 0.5rem;
            }
        }

        /* Timesheet Styles */
        /* Tab container with debug styles */
        .tab-container {
            margin-bottom: 2rem;
            position: relative; /* Create stacking context */
            z-index: 1; /* Ensure above other content */
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 2rem;
            position: relative;
            z-index: 2; /* Ensure buttons are above content */
        }

        .tab-button {
            background: none;
            border: none;
            padding: 1rem 2rem;
            cursor: pointer !important; /* Force cursor */
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative; /* For debug outline */
            pointer-events: auto !important; /* Force clickability */
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: #f8f9fa;
            font-weight: bold; /* Make active state more visible */
        }

        /* Debug hover effects */
        .tab-button:hover {
            background-color: #f0f0f0;
            outline: 2px solid #4CAF50;
        }

        .tab-button:focus {
            outline: 2px solid #2196F3;
        }

        /* Tab content with debug styles */
        .tab-content {
            display: none;
            position: relative;
            min-height: 100px;
            border: 1px dashed #ccc;
            padding: 1rem;
            margin-top: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab-content.active {
            display: block !important; /* Force display */
            opacity: 1;
            border-color: #4CAF50;
        }

        .timesheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* Circular Plus Button */
        .btn-circular {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-circular:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .btn-circular:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }

        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .timesheet-table th,
        .timesheet-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.65rem;
        }

        .timesheet-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.65rem;
        }        .timesheet-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-submitted {
            background: #d4edda;
            color: #155724;
        }

        .status-approved {
            background: #d1ecf1;
            color: #0c5460;
        }        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .approval-indicator {
            margin-left: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .needs-approval {
            background: linear-gradient(90deg, #fff9e6 0%, #ffffff 100%);
            border-left: 3px solid #ffc107;
        }

        .needs-approval:hover {
            background: linear-gradient(90deg, #fff3cd 0%, #f8f9fa 100%);
        }

        /* Timesheet Modal Styles */
        .timesheet-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2000;
            overflow-y: auto;
            font-size: 0.65rem; /* Set base font size for entire modal */
        }

        .timesheet-modal * {
            font-size: inherit; /* Inherit the base modal font size */
        }

        .timesheet-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
        }

        .timesheet-modal-content {
            background: white;
            border-radius: 6px;
            width: 95vw;
            max-width: 1200px;
            min-width: 320px;
            height: auto;
            max-height: 95vh;
            min-height: 400px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            margin: auto;
        }

        .timesheet-modal-header {
            padding: 0.2rem 0.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            flex-shrink: 0;
        }

        .timesheet-modal-header h3 {
            font-size: 0.55rem;
            margin: 0;
        }

        .timesheet-modal-body {
            padding: 0;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Sticky fields section */
        .timesheet-sticky-fields {
            padding: 0.1rem 0.3rem;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 90;
            flex-shrink: 0;
        }

        /* Timesheet info sections spacing */
        .timesheet-info-section {
            margin-bottom: 0.1rem;
        }
        
        .timesheet-info-section .form-section {
            margin-bottom: 0.1rem;
        }
        
        .approval-info {
            margin-bottom: 0.1rem;
        }
        
        .approval-flow-section {
            margin-bottom: 0.1rem;
        }

        /* Scrollable content section */
        .timesheet-scrollable-content {
            padding: 0.1rem 0.3rem 0.1rem 0.3rem;
            overflow-y: auto;
            flex: 1 1 auto;
            max-height: calc(100vh - 150px);
            min-height: 200px;
            scroll-behavior: smooth;
        }

        /* Action section - Always visible at bottom */
        .timesheet-action-section {
            padding: 0.1rem 0.3rem;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 95;
        }

        /* Form row layout for period and month/year */
        .timesheet-modal .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 0.2rem;
            margin-bottom: 0.1rem;
        }

        /* Responsive form row for smaller screens */
        @media (max-width: 768px) {
            .timesheet-modal .form-row {
                grid-template-columns: 1fr 1fr;
                gap: 0.1rem;
            }
        }

        /* Table container with scrolling - reduced height for approval workflow */
        .timesheet-modal .table-container {
            max-height: min(45vh, 350px);
            min-height: 150px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 0.1rem;
            margin-top: 0;
            flex: 1 1 auto;
        }

        .timesheet-entry-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .timesheet-entry-table th,
        .timesheet-entry-table td {
            padding: 0.15rem;
            border: 1px solid #e0e0e0;
            text-align: center;
            font-size: 0.55rem;
        }

        .timesheet-entry-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.55rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timesheet-entry-table input {
            width: 100%;
            border: none;
            padding: 0.15rem;
            text-align: center;
            background: transparent;
            font-size: 0.55rem;
        }        .timesheet-entry-table input:focus {
            outline: 2px solid #3498db;
            border-radius: 4px;
        }

        .timesheet-entry-table input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        /* Status input field styling */
        .status-input-draft {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }

        .status-input-submitted {
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        .status-input-approved {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
        }

        .status-input-rejected {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        .timesheet-table tbody tr {
            transition: all 0.2s ease;
        }

        .timesheet-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Add a subtle indicator that rows are clickable */
        .timesheet-table tbody tr:hover td:first-child::before {
            content: "👁️ ";
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .timesheet-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.2rem;
            margin-bottom: 0.1rem;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 0.2rem;
            border-radius: 4px;
            text-align: center;
        }

        .summary-value {
            font-size: 0.65rem;
            font-weight: 600;
            color: #3498db;
        }        .summary-label {
            color: #666;
            font-size: 0.5rem;
            margin-top: 0.2rem;
        }

        /* Sticky Summary Section */
        .timesheet-summary-section {
            background: white;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            padding: 2px 0;
            position: sticky;
            bottom: 30px; /* Position above action buttons */
            z-index: 1001;
        }

        .timesheet-summary-section .timesheet-summary {
            margin-bottom: 0;
        }

        .timesheet-info-section {
            margin-bottom: 0.6rem;
        }

        /* Form Section Styling */
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.2rem;
            margin-bottom: 0.1rem;
            border-left: 4px solid #3498db;
        }

        /* Timesheet Period specific container - reduce margins further */
        .timesheet-sticky-fields .form-section {
            margin-bottom: 0.02rem;
            margin-top: 0;
            padding-top: 0.05rem;
            padding-bottom: 0.05rem;
        }

        .form-section h4 {
            color: #2c3e50;
            margin: 0 0 0.05rem 0;
            font-size: 0.55rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .form-section h4 i {
            color: #3498db;
            font-size: 0.55rem;
        }

        /* Approval workflow heading styling (h5) */
        .approval-flow-section h5 {
            color: #2c3e50;
            margin: 0.3rem 0 0.2rem 0;
            font-size: 0.65rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 0.3rem;
        }

        .approval-flow-section h5 i {
            color: #3498db;
            font-size: 0.55rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.3rem;
            margin-bottom: 0.2rem;
        }

        .info-card {
            background: #f8f9fa;
            padding: 0.3rem;
            border-radius: 6px;
            text-align: center;
        }

        .info-card label {
            display: block;
            font-weight: 600;
            color: #666;
            font-size: 0.55rem;
            margin-bottom: 0.1rem;
        }        .info-card span {
            display: block;
            font-size: 0.55rem;
            color: #2c3e50;
        }

        .approval-actions {
            margin-top: 0.2rem;
            padding-top: 0.2rem;
            border-top: 1px solid #e0e0e0;
        }

        .approval-section h4 {
            color: #2c3e50;
            margin-bottom: 0.2rem;
            font-weight: 600;
            font-size: 0.55rem;
        }

        .approval-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }        .approval-buttons .btn {
            min-width: 100px;
        }

        .approval-info {
            margin-top: 0.4rem;
            padding-top: 0.4rem;
            border-top: 1px solid #e0e0e0;
        }

        .approval-comments {
            margin-top: 0.3rem;
        }

        .approval-comments label {
            font-weight: 600;
            color: #666;
            display: block;
            margin-bottom: 0.1rem;
            font-size: 0.65rem;
        }        .comments-text {
            background: #f8f9fa;
            padding: 0.3rem;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-style: italic;
            color: #555;
            font-size: 0.65rem;
        }

        .approval-flow-section {
            margin-bottom: 0.3rem;
        }

        .approval-flow-section h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .approval-flow-display {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.3rem;
            border: 1px solid #e0e0e0;
            font-size: 0.65rem;
        }

        .approval-flow-item {
            display: flex;
            align-items: center;
            padding: 0.3rem;
            margin-bottom: 0.2rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .approval-flow-item:last-child {
            margin-bottom: 0;
        }

        .approval-flow-item::after {
            content: '↓';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.65rem;
            color: #3498db;
            background: white;
            padding: 0 5px;
        }

        .approval-flow-item:last-child::after {
            display: none;
        }

        .level-indicator {
            background: #3498db;
            color: white;
            padding: 0.2rem 0.3rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-right: 0.3rem;
            min-width: 50px;
            text-align: center;
        }

        .approver-info {
            flex: 1;
        }

        .approver-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.1rem;
            font-size: 0.65rem;
        }

        .approver-details {
            font-size: 0.65rem;
            color: #666;
        }        .flow-type-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.2rem 0.3rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            margin-bottom: 0.3rem;
            display: inline-block;
        }

        .approval-flow-loading {
            text-align: center;
            padding: 0.5rem;
            color: #666;
            font-style: italic;
            font-size: 0.65rem;
        }        .approval-flow-loading::before {
            content: "⏳";
            margin-right: 0.5rem;
        }

        /* Submitter and Line Manager Information Styles */
        .submitter-info-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .submitter-card, .line-manager-card {
            flex: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .submitter-header, .line-manager-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .submitter-header i {
            color: #3498db;
        }

        .line-manager-header i {
            color: #e74c3c;
        }

        .submitter-name, .line-manager-name {
            font-size: 1rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .line-manager-name {
            color: #e74c3c;
        }

        /* Responsive design for submitter info */
        @media (max-width: 768px) {
            .submitter-info-section {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Org Tab Styles */
        .org-header {
            margin-bottom: 1rem;
        }

        .org-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .org-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .org-section-header {
            background: #f8f9fa;
            padding: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .org-section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .org-section-header h3 i {
            color: #3498db;
        }

        .report-count {
            background: #3498db;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .user-card {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            gap: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .user-card:last-child {
            border-bottom: none;
        }

        .user-card:hover {
            background: #f8f9fa;
        }

        .current-user {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-left: 4px solid #3498db;
        }

        .current-user:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #f8f9fa 100%);
        }

        .line-manager {
            border-left: 4px solid #e74c3c;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            flex-shrink: 0;
        }

        .current-user .user-avatar {
            background: #3498db;
            color: white;
        }

        .line-manager .user-avatar {
            background: #e74c3c;
            color: white;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.05rem;
            font-size: 0.6rem;
        }

        .user-title {
            color: #666;
            margin-bottom: 0.05rem;
            font-size: 0.6rem;
        }

        .user-department {
            color: #888;
            font-size: 0.6rem;
        }

        .user-title-department {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.05rem;
        }

        .user-title-department .user-title {
            margin-bottom: 0;
        }

        .user-title-department .user-department {
            margin-bottom: 0;
        }

        .user-title-department .user-department::before {
            content: '•';
            color: #ccc;
            margin-right: 0.5rem;
        }

        .user-contact {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.6rem;
        }

        .contact-info i {
            color: #3498db;
            width: 16px;
        }

        .user-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .reports-grid {
            padding: 0.5rem;
            display: grid;
            gap: 0;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: #666;
            font-size: 0.6rem;
        }

        /* Responsive design for org tab */
        @media (max-width: 768px) {
            .user-card {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            .user-contact {
                align-items: center;
            }

            .user-status {
                align-items: center;
            }

            .org-section-header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
        }

        /* Data Table Styles for Direct Reports */
        .data-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            height: calc(100vh - 400px); /* Fit to screen height with more offset */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .data-table-wrapper {
            overflow-y: auto;
            overflow-x: auto;
            height: 100%; /* Fill the container height */
            flex: 1;
            /* Custom scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }

        /* Webkit scrollbar styling */
        .data-table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .data-table-wrapper::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }

        .data-table-wrapper::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 4px;
        }

        .data-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #495057;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 0.5rem;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            font-size: 0.6rem;
        }

        .data-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 0.6rem;
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge-table {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .status-active-table {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive-table {
            background: #f8d7da;
            color: #721c24;
        }

        .user-name-cell {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.6rem;
        }

        .user-email-cell {
            color: #666;
            font-size: 0.6rem;
        }

        .user-title-cell {
            color: #495057;
            font-size: 0.6rem;
        }

        .user-phone-cell {
            color: #666;
            font-family: monospace;
            font-size: 0.6rem;
        }

        .user-department-cell {
            color: #495057;
            font-size: 0.6rem;
        }

        /* Menu visibility classes */
        .sidebar .menu li {
            display: none;
        }

        .sidebar .menu li.menu-visible {
            display: block;
        }

        .sidebar.menu-loading .menu li {
            opacity: 0.5;
        }

        /* Dropdown menu styles */
        .sidebar .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .sidebar .menu-dropdown:hover .submenu {
            display: block;
        }

        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar .menu a i {
            margin-right: 10px;
        }

        .sidebar .menu a:hover, .sidebar .menu a.active {
            background-color: var(--secondary-color, #3498db);
        }

        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Hide ALL menu items by default during loading (prevent flicker)
           Match behavior used in other pages like accessdaily.html */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Essential CSS for External Dependencies Integration */
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Poppins', system-ui, -apple-system, sans-serif;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #333333;
            background-color: #ffffff;
            transition: background-color 0.2s, color 0.2s;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Base Styles */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
        }

        .sidebar .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 1rem;
        }

        .sidebar .menu {
            list-style: none;
            margin-top: 1rem;
        }

        .sidebar .menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar .menu a:hover,
        .sidebar .menu a.active {
            background-color: #3498db;
        }

        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 1rem;
            min-height: 100vh;
            background-color: #f5f6fa;
        }

        /* Header Styles */
        .top-nav {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
            height: 60px;
        }

        /* Layout adjustments */
        .main-content {
            padding-top: 80px; /* Account for fixed header */
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .top-nav {
                left: 0;
            }
        }

        /* Menu Visibility System */
        .menu li {
            display: none;
        }

        .menu li.menu-visible {
            display: block;
        }

        .menu-loading .menu li {
            display: block;
            opacity: 0.5;
        }

        /* Dropdown Menu Styles */
        .menu-dropdown .submenu {
            display: none;
            padding-left: 1rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu,
        .menu-dropdown.active .submenu {
            display: block;
        }

        .menu-dropdown .submenu li {
            margin-bottom: 0.25rem;
        }

        .menu-dropdown .submenu a {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* ======================================== */
        /* COMPREHENSIVE ACCOUNT SETTINGS STYLING */
        /* ======================================== */

        /* CSS Variables - Match Company Management */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Content and Layout */
        .content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin: 0;
            overflow: hidden;
        }

        /* Page Header - Match Staff Management Style */
        .content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            margin: 0 0 1rem 0;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
        }

        .content-header h1 {
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.1rem;
            margin: 0;
            font-weight: 600;
        }

        .content-header h1 i {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Enhanced Tab System - Match Company Management */
        .tab-container {
            background: white;
            margin: 0;
        }

        .tab-buttons {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0;
            padding: 0.25rem;
            background: #f8f9fa;
            border-radius: 12px;
            overflow-x: auto;
            margin: 0.5rem 0 0 0;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: #6c757d;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .tab-content {
            display: none;
            padding: 0.5rem;
            min-height: 200px;
            background: white;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styling */
        .form-container {
            margin: 0 auto;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: #3498db;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 0.1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.1rem;
            font-size: 0.55rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.55rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .form-hint {
            display: block;
            color: #6c757d;
            font-size: 0.65rem;
            margin-top: 0.2rem;
            font-style: italic;
        }

        /* Timesheet Modal Specific Overrides */
        .timesheet-modal .form-actions {
            margin-top: 0;
            margin-bottom: 0.2rem;
            display: flex;
            gap: 0.2rem;
            justify-content: flex-end;
        }

        .timesheet-modal .form-actions .btn {
            padding: 0.25rem 0.6rem;
            font-size: 0.55rem;
            min-width: 45px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent !important;
            border: none !important;
            color: inherit !important;
            box-shadow: none !important;
        }

        .timesheet-modal .approval-actions .btn {
            padding: 0.25rem 0.6rem;
            font-size: 0.55rem;
            min-width: 45px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent !important;
            border: none !important;
            color: inherit !important;
            box-shadow: none !important;
        }

        /* Icon colors for different button types */
        .timesheet-modal .btn-secondary i {
            color: #6c757d;
        }

        .timesheet-modal .btn-primary i {
            color: #3498db;
        }

        .timesheet-modal .btn-success i {
            color: #27ae60;
        }

        .timesheet-modal .btn-danger i {
            color: #e74c3c;
        }

        /* Hover effects for icons */
        .timesheet-modal .btn:hover {
            background: rgba(0,0,0,0.05) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .timesheet-modal .btn:hover i {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        .timesheet-modal .btn i {
            font-size: 0.8rem;
        }

        /* Comprehensive responsive design */
        @media (max-width: 1200px) {
            .timesheet-modal-content {
                width: 95vw;
                max-width: 95vw;
            }
        }

        @media (max-width: 768px) {
            .timesheet-modal .form-row {
                grid-template-columns: 1fr;
                gap: 0.3rem;
            }
            
            .timesheet-modal .table-container {
                max-height: min(40vh, 320px);
                min-height: 180px;
            }
            
            .timesheet-modal-content {
                width: 98vw;
                height: 98vh;
                margin: 1vh auto;
                padding: 0.8rem;
            }

            .timesheet-modal .timesheet-scrollable-content {
                max-height: calc(98vh - 120px);
            }

            .timesheet-modal h3 {
                font-size: 0.6rem;
                margin-bottom: 0.4rem;
            }

            .timesheet-modal table th,
            .timesheet-modal table td {
                font-size: 0.5rem;
                padding: 0.2rem;
            }
        }

        @media (max-width: 480px) {
            .timesheet-modal-content {
                width: 100vw;
                height: 100vh;
                margin: 0;
                border-radius: 0;
                padding: 0.6rem;
            }
            
            .timesheet-modal .table-container {
                max-height: min(35vh, 280px);
                min-height: 150px;
            }

            .timesheet-modal .timesheet-scrollable-content {
                max-height: calc(100vh - 100px);
            }

            .timesheet-modal table th,
            .timesheet-modal table td {
                font-size: 0.45rem;
                padding: 0.15rem;
            }

            .timesheet-modal h3 {
                font-size: 0.55rem;
            }

            .timesheet-modal input,
            .timesheet-modal select {
                font-size: 0.5rem;
                padding: 0.25rem;
            }
        }

        /* Landscape orientation optimizations */
        @media (max-height: 600px) and (orientation: landscape) {
            .timesheet-modal-content {
                height: 98vh;
                max-height: 98vh;
            }
            
            .timesheet-modal .table-container {
                max-height: min(35vh, 220px);
                min-height: 120px;
            }

            .timesheet-modal .timesheet-scrollable-content {
                max-height: calc(98vh - 80px);
            }
        }

        /* Very small screens */
        @media (max-width: 320px) {
            .timesheet-modal-content {
                min-width: 100vw;
                width: 100vw;
                padding: 0.4rem;
            }
            
            .timesheet-modal table th,
            .timesheet-modal table td {
                font-size: 0.4rem;
                padding: 0.1rem;
            }
        }

        .timesheet-modal .approval-buttons {
            gap: 0.4rem;
        }

        .timesheet-modal h4 {
            font-size: 0.7rem;
            margin-bottom: 0.2rem;
            margin-top: 0.1rem;
        }

        /* Button Styling */
        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: center;
        }

        /* Small Button Variant - Icon Only, No Background */
        .btn-sm {
            padding: 0.3rem;
            font-size: 0.75rem;
            min-width: auto;
            gap: 0;
            border-radius: 0;
            width: auto;
            height: auto;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        .btn-sm:hover {
            background: transparent !important;
            transform: scale(1.1);
        }

        /* Icon Colors for Different Button Types */
        .btn-sm.btn-primary {
            color: #3498db;
        }

        .btn-sm.btn-danger {
            color: #e74c3c;
        }

        .btn-sm.btn-success {
            color: #2ecc71;
        }

        .btn-sm:hover {
            background: transparent !important;
            transform: scale(1.2);
            opacity: 0.8;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        /* Enhanced Table Styling */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.8rem;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Status and Badge Styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Grid Layout for Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .content-header {
                padding: 0.5rem;
            }

            .content-header h1 {
                font-size: 0.9rem;
            }

            .content-header h1 {
                font-size: 1.5rem;
            }

            .tab-content {
                padding: 1rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .form-grid,
            .form-grid-2 {
                grid-template-columns: 1fr;
            }

            .tab-buttons {
                padding: 0 1rem;
                margin: 1rem 1rem 0 1rem;
            }

            .tab-button {
                padding: 0.6rem 1rem;
                font-size: 0.7rem;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Additional JavaScript Dependencies -->
    <script src="github-pages-fix.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/common-components.js"></script>
    <script src="js/company-data-service-v8.js"></script>
    <script src="validate-fields.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION & AUTHENTICATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Firebase functions
        let database;

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully');
            }
            database = window.firebase.database();
            return window.firebase;
        }

        function getDatabase() {
            return database;
        }

        // Database helper functions using Firebase v8
        function ref(database, path) {
            return database.ref(path);
        }

        function get(reference) {
            return reference.once('value');
        }

        function set(reference, value) {
            return reference.set(value);
        }

        function update(reference, values) {
            return reference.update(values);
        }

        function onValue(reference, callback, options = {}) {
            if (options.onlyOnce) {
                return reference.once('value', callback);
            } else {
                return reference.on('value', callback);
            }
        }

        // Authentication functions
        function getCurrentUser() {
            try {
                return JSON.parse(localStorage.getItem('currentUser') || 'null');
            } catch (error) {
                console.error('Error parsing current user:', error);
                return null;
            }
        }

        async function logoutUser() {
            try {
                await firebase.auth().signOut();
                localStorage.removeItem('currentUser');
                localStorage.removeItem('user');
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('user');
                return true;
            } catch (error) {
                console.error('Error signing out:', error);
                return false;
            }
        }

        // ============================================
        // CENTRALIZED AUTHENTICATION MANAGER
        // ============================================
        
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = getDatabase();
                this.currentCompany = null;
                
                // Debug log
                console.log('🔐 AuthManager initialized');
                console.log('Current user:', this.currentUser);
                
                this.initializeAuth();
            }

            initializeAuth() {
                // Check if user is logged in
                if (!this.currentUser) {
                    // Check if this is a redirect from login
                    if (window.location.pathname.includes('account.html')) {
                        window.location.href = 'login.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                    return;
                }
                
                console.log('✅ User authenticated successfully');
                
                // Show authentication status indicator briefly
                const authStatus = document.getElementById('authStatus');
                if (authStatus) {
                    authStatus.style.display = 'block';
                    setTimeout(() => {
                        authStatus.style.transition = 'opacity 0.5s ease-out';
                        authStatus.style.opacity = '0';
                        setTimeout(() => {
                            authStatus.style.display = 'none';
                        }, 500);
                    }, 2000);
                }
                
                // Load user data and update UI
                this.loadUserRole(this.currentUser);
                this.loadUserCompany();
                this.updateUIForAuthenticatedUser();
                this.updateMenuVisibility();

                // Add event listeners for user profile dropdown
                const userProfileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown');
                
                if (userProfileBtn && profileDropdown) {
                    userProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!userProfileBtn.contains(e.target)) {
                            profileDropdown.classList.remove('show');
                        }
                    });
                }

                // Handle logout
                const logoutBtn = document.querySelector('.profile-dropdown a[href="#"]');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            }

            getCurrentUser() {
                try {
                    return JSON.parse(localStorage.getItem('currentUser') || 'null');
                } catch (error) {
                    console.error('Error parsing current user:', error);
                    return null;
                }
            }

            setCurrentUser(userData) {
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('user', JSON.stringify(userData));
                this.currentUser = userData;
            }

            async logout() {
                const success = await logoutUser();
                if (success) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    window.location.href = 'index.html';
                }
            }

            // Menu visibility methods
            resetMenuVisibility() {
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                });
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
            }

            async updateMenuVisibility() {
                console.log('🔧 Starting menu visibility update...');
                
                    // Ensure loading class is present while we compute permissions
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.add('menu-loading');
                    }
                
                try {
                    if (!this.currentUser) {
                        console.log('❌ No authenticated user found');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    // Get user's company ID and role
                    const companyId = this.currentUser.companyId;
                    const userRole = this.currentUser.role;
                    
                    if (!companyId || !userRole) {
                        console.log('❌ Missing company ID or user role');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                    
                    // Get company role permissions
                    const permissionsRef = ref(this.db, `companies/${companyId}/roles/${userRole}/permissions`);
                    console.log(`🔍 Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                    
                    const permissionsSnapshot = await get(permissionsRef);
                    
                    if (!permissionsSnapshot.exists()) {
                        console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                        
                        // Try to get all roles to see what's available
                        const allRolesRef = ref(this.db, `companies/${companyId}/roles`);
                        const allRolesSnapshot = await get(allRolesRef);
                        
                        if (allRolesSnapshot.exists()) {
                            const allRoles = allRolesSnapshot.val();
                            console.log('🔍 Available roles in company:', Object.keys(allRoles));
                            
                            // Check if the role exists with different casing or format
                            const roleKeys = Object.keys(allRoles);
                            const matchingRole = roleKeys.find(key => 
                                key.toLowerCase() === userRole.toLowerCase() ||
                                key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                            );
                            
                            if (matchingRole && allRoles[matchingRole].permissions) {
                                console.log(`✅ Found matching role: ${matchingRole}`);
                                const permissions = allRoles[matchingRole].permissions;
                                this.updateMenuWithPermissions(permissions);
                                return;
                            }
                        }
                        
                        console.log('❌ No valid permissions found - hiding all menu items');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const permissions = permissionsSnapshot.val();
                    console.log('✅ Loaded permissions:', permissions);
                    this.updateMenuWithPermissions(permissions);
                    
                } catch (error) {
                    console.error('❌ Error updating menu visibility:', error);
                    this.resetMenuVisibility();
                } finally {
                    // Ensure loading class is removed when we're done
                    if (sidebar) {
                        sidebar.classList.remove('menu-loading');
                    }
                }
            }

            updateMenuWithPermissions(permissions) {
                console.log('🎯 Updating menu with permissions...');
                console.log('🎯 Permissions object:', permissions);
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!permissions) {
                    console.log('⚠️ No permissions object provided');
                    return;
                }
                
                // Update menu visibility based on permissions
                const menuItems = document.querySelectorAll('[data-feature]');
                console.log(`🎯 Found ${menuItems.length} menu items to check`);
                let visibleCount = 0;
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const isSubmenuItem = item.closest('.submenu') !== null;
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    const parentDropdown = item.closest('.menu-dropdown');
                    const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                    
                    console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                        return;
                    }
                    
                    // If item doesn't require permission, show it
                    if (!requiresPermission) {
                        // Check if user has permission for this feature
                        if (feature && permissions[feature]) {
                            const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                            if (hasViewPermission) {
                                item.classList.add('menu-visible');
                                visibleCount++;
                                console.log(`✅ Showing menu item: ${feature}`);
                            } else {
                                console.log(`❌ No view permission for: ${feature}`);
                            }
                        } else {
                            console.log(`⚪ Feature not found in permissions: ${feature}`);
                        }
                        return;
                    }
                    
                    // If item requires permission, check if user has it
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature}`);
                        } else {
                            console.log(`❌ No view permission for: ${feature}`);
                        }
                    } else {
                        console.log(`⚪ Feature not found in permissions: ${feature}`);
                    }
                });
                
                // Handle parent dropdowns - show only if they have visible children
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                    } else {
                        console.log(`❌ Hiding parent dropdown ${dropdownFeature} (no visible children)`);
                    }
                });
                
                console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
                
                // If no items are visible, show at least home (only if user has home permission)
                if (visibleCount === 0) {
                    const homeItem = document.querySelector('[data-feature="home_view"]');
                    if (homeItem && permissions && permissions.home_view && 
                        (permissions.home_view.view === true || permissions.home_view === true)) {
                        homeItem.classList.add('menu-visible');
                        console.log('⚠️ No permissions found - showing home as fallback');
                    }
                }
            }


            updateCompanyBranding(){
                if(!this.currentCompany){
                    this.showFallbackBranding();
                    return;
                }
                const logoEl=document.getElementById('headerCompanyLogo');
                const nameEl=document.getElementById('headerCompanyName');
                if(nameEl) nameEl.textContent=this.currentCompany.companyName||'';
                const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl;
                if(logoEl){
                    if(logoUrl){
                        logoEl.src=logoUrl;
                        logoEl.classList.add('visible');
                        logoEl.style.display='block';
                        const placeholder=document.getElementById('headerLogoPlaceholder');
                        if(placeholder) placeholder.style.display='none';
                    } else {
                        const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||''));
                        logoEl.src=svg;
                        logoEl.classList.add('visible');
                        logoEl.style.display='block';
                        const placeholder=document.getElementById('headerLogoPlaceholder');
                        if(placeholder) placeholder.style.display='none';
                    }
                }
                if(this.currentCompany.branding){
                    const root=document.documentElement;
                    if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color',this.currentCompany.branding.primaryColor);
                    if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color',this.currentCompany.branding.secondaryColor);
                }
            }

            showFallbackBranding(){
                const logoEl=document.getElementById('headerCompanyLogo');
                const nameEl=document.getElementById('headerCompanyName');
                if(nameEl){nameEl.textContent='';}
                if(logoEl){
                    const svg=this.generateCompanyInitialsSVG('DX');
                    logoEl.src=svg;
                    logoEl.classList.add('visible');
                    logoEl.style.display='block';
                    const placeholder=document.getElementById('headerLogoPlaceholder');
                    if(placeholder) placeholder.style.display='none';
                }
            }

            getCompanyInitials(name){
                if(!name) return 'CO';
                const parts=name.trim().split(/\s+/);
                if(parts.length===1) return parts[0].substring(0,2).toUpperCase();
                return (parts[0][0]+parts[1][0]).toUpperCase();
            }

            generateCompanyInitialsSVG(initials){
                const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
                return 'data:image/svg+xml;base64,'+btoa(svg);
            }

            async updateUIForAuthenticatedUser() {
                const profileBtn = document.querySelector('.profile-btn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();
                        
                        // Preload avatar URL to avoid showing initials first
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        // Update profile image - now show the correct image immediately
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Create avatar for dropdown (either real avatar or initials)
                        let dropdownAvatarHtml;
                        if (avatarUrl) {
                            dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                        }
                        
                        // Update profile dropdown with user info
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${dropdownAvatarHtml}
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="#"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        `;
                        
                        profileDropdown.innerHTML = userInfoHtml;
                        
                        // Re-attach logout event listener
                        const logoutBtn = profileDropdown.querySelector('a[href="#"]');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                this.logout();
                            });
                        }
                        
                        // Update menu visibility based on user permissions
                        await this.updateMenuWithFeatureAuthorization();
                    }
                }
            }

            // Hide unauthorized sidebar menu items based on feature and role
            async updateMenuWithFeatureAuthorization() {
                if (typeof window.updateMenuWithFeatureAuthorization === 'function') {
                    try {
                        await window.updateMenuWithFeatureAuthorization();
                    } catch (err) {
                        console.error('Error delegating menu authorization to global function:', err);
                    }
                } else {
                    console.warn('Global updateMenuWithFeatureAuthorization not available to delegate');
                }
            }
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return '';
                    return name.trim().replace(/\s+/g, ' ');
                };
                
                const potentialNames = [
                    this.currentUser.displayName,
                    this.currentUser.name,
                    this.currentUser.username
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            }
        }

        // Initialize Firebase when this script loads
        initializeFirebase();
    </script>
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading" id="sideNav">
            <div class="logo"><h2>Dreamex Datalab</h2></div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- Company Logo -->
                    <img src="assets/default-company-logo.png" alt="Company Logo" class="header-company-logo" id="headerCompanyLogo" style="display: none;">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder" style="display: flex; width: 40px; height: 40px; align-items: center; justify-content: center; margin-right: 12px;"></div>
                    <!-- Company Name -->
                    <span id="headerCompanyName" class="company-name-header">Dreamex Datalab</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="assets/default-avatar.png" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>            <!-- Page Content -->
            <div class="content">
                <div class="content-header">
                    <h1><i class="fas fa-user-cog"></i>Account Settings</h1>
                </div>

                <!-- Tab Container -->
                <div class="tab-container">                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" data-tab="timesheet"><i class="fas fa-clock"></i>Timesheet</button>
                        <button type="button" class="tab-button" data-tab="leave"><i class="fas fa-calendar-day"></i>Leave</button>
                        <button type="button" class="tab-button" data-tab="org"><i class="fas fa-sitemap"></i>Org</button>
                    </div>

                    <!-- Timesheet Tab -->
                    <div class="tab-content active" id="timesheetTab">                        <div class="timesheet-header">
                            <div>
                            </div>
                            <button class="btn-circular" onclick="createNewTimesheet()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="timesheet-container">                            <table class="timesheet-table" id="timesheetTable">                                <thead>                                    <tr>
                                        <th>Period</th>
                                        <th>Month/Year</th>
                                        <th>Total Hours</th>
                                        <th>Status</th>
                                        <th>Submitted By</th>
                                        <th>Submitted Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>                                <tbody id="timesheetTableBody">
                                    <!-- Timesheet rows will be added dynamically -->
                                    <tr class="empty-state" id="timesheetEmptyState">
                                        <td colspan="7" style="text-align: center; padding: 3rem; color: #666;">
                                            <i class="fas fa-clock" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                            <p>No timesheets found. Click "Create New Timesheet" to get started.</p>
                                        </td>
                                    </tr>                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Leave Tab -->
                    <div class="tab-content" id="leaveTab">
                        <div class="timesheet-header">
                            <div>
                            </div>
                            <button class="btn-circular" onclick="createNewLeaveRequest()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="timesheet-container">
                            <table class="timesheet-table" id="leaveTable">
                                <thead>
                                    <tr>
                                        <th>Leave Type</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Submitted By</th>
                                        <th>Submitted Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="leaveTableBody">
                                    <!-- Leave request rows will be added dynamically -->
                                    <tr class="empty-state" id="leaveEmptyState">
                                        <td colspan="8" style="text-align: center; padding: 2rem; color: #666; font-size: 0.8rem;">
                                            <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 0.75rem; display: block;"></i>
                                            <p style="font-size: 0.8rem;">No leave requests found.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Org Tab -->
                    <div class="tab-content" id="orgTab">
                        <div class="timesheet-header">
                            <div>
                            </div>
                        </div>

                        <div class="org-container">
                            <!-- Line Manager Section -->
                            <div class="org-section">
                                <div class="org-section-header">
                                    <h3><i class="fas fa-user-tie"></i> Line Manager</h3>
                                </div>
                                
                                <!-- Line Manager Info -->
                                <div id="lineManagerSection">
                                    <div class="user-card line-manager" id="lineManagerCard" style="display: none;">
                                        <div class="user-info">
                                            <div class="user-name" id="lineManagerName">Loading...</div>
                                            <div class="user-title-department">
                                                <span class="user-title" id="lineManagerTitle">Loading...</span>
                                                <span class="user-department" id="lineManagerDepartment">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="user-contact">
                                            <div class="contact-info">
                                                <i class="fas fa-envelope"></i>
                                                <span id="lineManagerEmail">Loading...</span>
                                            </div>
                                            <div class="contact-info">
                                                <i class="fas fa-phone"></i>
                                                <span id="lineManagerPhone">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="empty-state" id="noLineManagerState" style="display: block;">
                                        <i class="fas fa-user-times" style="font-size: 2rem; margin-bottom: 0.75rem; display: block; color: #ccc;"></i>
                                        <p style="color: #666; font-size: 0.8rem;">Loading line manager...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Direct Reports Section -->
                            <div class="org-section">
                                <div class="org-section-header">
                                    <h3><i class="fas fa-users"></i> Direct Reports</h3>
                                    <span class="report-count" id="reportCount">0 reports</span>
                                </div>
                                <div id="directReportsSection">
                                    <div class="data-table-container" id="reportsTableContainer">
                                        <!-- Data Table Wrapper for scrolling -->
                                        <div class="data-table-wrapper">
                                            <table class="data-table" id="reportsTable">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Email</th>
                                                        <th>Job Title</th>
                                                        <th>Phone</th>
                                                        <th>Department</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="reportsTableBody">
                                                    <!-- Direct reports will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="empty-state" id="noReportsState">
                                        <i class="fas fa-users-slash" style="font-size: 3rem; margin-bottom: 1rem; display: block; color: #ccc;"></i>
                                        <p style="color: #666;">No direct reports</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leave Request Modal -->
                <div class="timesheet-modal" id="leaveModal">
                    <div class="timesheet-modal-content">
                        <div class="timesheet-modal-header">
                            <h3 id="leaveModalTitle">Create Leave Request</h3>
                            <button class="btn btn-text" onclick="closeLeaveModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="timesheet-modal-body">
                            <!-- Leave Request Summary Information -->
                            <div class="timesheet-info-section" id="leaveInfoSection" style="display: none;">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <label>Status</label>
                                        <span id="modalLeaveStatus" class="status-badge"></span>
                                    </div>
                                    <div class="info-card">
                                        <label>Created Date</label>
                                        <span id="modalLeaveCreatedDate">-</span>
                                    </div>
                                    <div class="info-card">
                                        <label>Submitted Date</label>
                                        <span id="modalLeaveSubmittedDate">-</span>
                                    </div>
                                    <div class="info-card">
                                        <label>Duration</label>
                                        <span id="modalLeaveDuration">-</span>
                                    </div>
                                </div>

                                <!-- Approval Information -->
                                <div class="approval-info" id="leaveApprovalInfo" style="display: none;">
                                    <h3>Approval Details</h3>
                                    <div class="info-grid">
                                        <div class="info-card">
                                            <label id="modalLeaveActionLabel">Approved Date</label>
                                            <span id="modalLeaveActionDate">-</span>
                                        </div>
                                        <div class="info-card">
                                            <label>Approved/Rejected By</label>
                                            <span id="modalLeaveActionBy">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Approval Comments Display -->
                                <div class="approval-comments-display" id="leaveApprovalCommentsDisplay" style="display: none;">
                                    <h4>Comments</h4>
                                    <div class="comments-text" id="leaveCommentsText"></div>
                                </div>
                            </div>

                            <!-- Approval Flow Section -->
                            <div class="approval-flow-section" id="leaveApprovalFlowSection" style="display: none;">
                                <h3>Approval Flow</h3>
                                <div class="approval-flow-display" id="leaveApprovalFlowDisplay">
                                    <!-- Approval flow will be populated here -->
                                </div>
                            </div>

                            <form id="leaveForm">
                                <div class="form-group">
                                    <label for="leaveType">Leave Type*</label>
                                    <select id="leaveType" name="leaveType" required>
                                        <option value="">Select Leave Type</option>
                                        <option value="annual">Annual Leave</option>
                                        <option value="sick">Sick Leave</option>
                                        <option value="personal">Personal Leave</option>
                                        <option value="emergency">Emergency Leave</option>
                                        <option value="maternity">Maternity/Paternity Leave</option>
                                        <option value="compassionate">Compassionate Leave</option>
                                        <option value="study">Study Leave</option>
                                        <option value="unpaid">Unpaid Leave</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="startDate">Start Date*</label>
                                    <input type="date" id="startDate" name="startDate" required onchange="calculateLeaveDuration()">
                                </div>

                                <div class="form-group">
                                    <label for="endDate">End Date*</label>
                                    <input type="date" id="endDate" name="endDate" required onchange="calculateLeaveDuration()">
                                </div>

                                <div class="form-group">
                                    <label for="leaveDuration">Duration (Days)</label>
                                    <input type="number" id="leaveDuration" name="leaveDuration" readonly>
                                </div>

                                <div class="form-group">
                                    <label for="leaveReason">Reason for Leave*</label>
                                    <textarea id="leaveReason" name="leaveReason" rows="4" required placeholder="Please provide the reason for your leave request..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="handoverNotes">Handover Notes</label>
                                    <textarea id="handoverNotes" name="handoverNotes" rows="3" placeholder="Any important handover information or work arrangements..."></textarea>
                                </div>                                <!-- Form Actions -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="closeLeaveModal()">Cancel</button>
                                    <button type="button" class="btn btn-danger" onclick="deleteLeaveRequest(currentLeaveRequestId)" id="deleteLeaveBtn" style="display: none;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="saveLeaveRequest()">Save Draft</button>
                                    <button type="button" class="btn btn-approve" onclick="submitLeaveRequest()">Submit Request</button>
                                </div>

                                <!-- Approval Actions (for approvers) -->
                                <div class="approval-actions" id="leaveApprovalActions" style="display: none;">
                                    <div class="form-group">
                                        <label for="leaveApprovalComments">Comments</label>
                                        <textarea id="leaveApprovalComments" name="leaveApprovalComments" rows="3" placeholder="Add your comments here..."></textarea>
                                    </div>
                                    <div class="approval-buttons">
                                        <button type="button" class="btn btn-danger" onclick="declineLeaveRequest()">
                                            <i class="fas fa-times"></i> Decline
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="approveLeaveRequest()">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Timesheet Modal -->
                <div class="timesheet-modal" id="timesheetModal">
                    <div class="timesheet-modal-content">
                        <div class="timesheet-modal-header">
                            <h3 id="timesheetModalTitle">New Timesheet</h3>
                            <button class="btn btn-text" onclick="closeTimesheetModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>                        <div class="timesheet-modal-body">
                            <form id="timesheetForm">
                                <!-- Sticky Fields Section -->
                                <div class="timesheet-sticky-fields">
                                    <!-- Basic Timesheet Information -->
                                    <div class="form-section">
                                        <h4><i class="fas fa-calendar-alt"></i> Timesheet Period</h4>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="timesheetPeriod">Period Description</label>
                                                <input type="text" id="timesheetPeriod" name="period" readonly>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="monthYear">Select Month/Year</label>
                                                <input type="month" id="monthYear" name="monthYear" required onchange="updateMonthEntries()">
                                            </div>

                                            <div class="form-group">
                                                <label for="modalTimesheetStatusInput">Current Status</label>
                                                <input type="text" id="modalTimesheetStatusInput" readonly>
                                            </div>

                                            <div class="form-group">
                                                <label for="modalCreatedDateInput">Created Date</label>
                                                <input type="text" id="modalCreatedDateInput" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Scrollable Content Section -->
                                <div class="timesheet-scrollable-content">
                                    
                                    <!-- Hours Entry Table (primary focus for timesheet data entry) -->
                                    <div class="table-container">
                                    <table class="timesheet-entry-table" id="timesheetEntryTable">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Start Time</th>
                                                <th>End Time</th>
                                                <th>Break (hrs)</th>
                                                <th>Regular</th>
                                                <th>Overtime</th>
                                                <th>Comments</th>
                                            </tr>
                                        </thead>
                                        <tbody id="timesheetEntryTableBody">
                                            <!-- Will be populated dynamically -->
                                        </tbody>
                                    </table>
                                    </div>
                                    
                                        <!-- Approval Information (shown for approved/rejected timesheets) -->
                                        <div class="approval-info" id="approvalInfo">
                                            <div class="form-section">
                                                <h4><i class="fas fa-user-check"></i> Approval Details</h4>
                                                <div class="info-grid">
                                                    <div class="info-card">
                                                        <label>Action Date</label>
                                                        <span id="modalActionDate">-</span>
                                                    </div>
                                                    <div class="info-card">
                                                        <label>Approved/Rejected By</label>
                                                        <span id="modalActionBy">-</span>
                                                    </div>
                                                    <div class="info-card">
                                                        <label>Submitted Date</label>
                                                        <span id="modalSubmittedDate">-</span>
                                                    </div>
                                                    <div class="info-card">
                                                        <label>Working Days</label>
                                                        <span id="modalWorkingDays">-</span>
                                                    </div>
                                                </div>
                                                <div class="approval-comments" id="approvalCommentsDisplay">
                                                    <label>Approval Comments:</label>
                                                    <div class="comments-text" id="commentsText"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Approval Flow Section -->
                                        <div class="approval-flow-section" id="timesheetApprovalFlowSection" style="display: none;">
                                            <div class="form-section">
                                                <h4><i class="fas fa-route"></i> Approval Workflow</h4>
                                                <div class="approval-flow-display" id="timesheetApprovalFlowDisplay">
                                                    <!-- Approval flow will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                </div> <!-- End of timesheet-scrollable-content -->

                                <!-- Sticky Summary Section -->
                                <div class="timesheet-summary-section">
                                    <div class="timesheet-summary">
                                        <div class="summary-card">
                                            <div class="summary-value" id="totalRegularHours">0.0</div>
                                            <div class="summary-label">Total Regular Hours</div>
                                        </div>
                                        <div class="summary-card">
                                            <div class="summary-value" id="totalOvertimeHours">0.0</div>
                                            <div class="summary-label">Total Overtime Hours</div>
                                        </div>
                                        <div class="summary-card">
                                            <div class="summary-value" id="totalHours">0.0</div>
                                            <div class="summary-label">Total Hours</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons Section - Always Visible -->
                                <div class="timesheet-action-section">
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="closeTimesheetModal()" title="Cancel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="saveTimesheet()" title="Save Draft">
                                            <i class="fas fa-save"></i>
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="submitTimesheet()" title="Submit to Supervisor">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>

                                    <!-- Approval Actions (shown only for supervisors viewing submitted timesheets) -->
                                    <div class="approval-actions" id="approvalActions" style="display: none;">
                                        <div class="approval-section">
                                            <h4>Timesheet Approval</h4>
                                            <div class="form-group">
                                                <label for="approvalComments">Comments (Optional)</label>
                                                <textarea id="approvalComments" rows="2" placeholder="Add comments for approval or rejection..."></textarea>
                                            </div>
                                            <div class="approval-buttons">
                                                <button type="button" class="btn btn-secondary" onclick="closeTimesheetModal()" title="Cancel">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger" onclick="declineTimesheet()" title="Decline">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                                <button type="button" class="btn btn-success" onclick="approveTimesheet()" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </main>
    </div>    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/roles.js"></script>
    <script type="module" src="js/notifications.js"></script>
    <script type="module" src="js/account.js"></script>
    <script type="module" src="js/main.js"></script>
    <script>
        // Test function to check if onclick works
        window.createNewTimesheet = function() {
            console.log('🔧 createNewTimesheet() called from window scope');
            createNewTimesheetInternal();
        };
        
        window.createNewLeaveRequest = function() {
            console.log('🔧 createNewLeaveRequest() called from window scope');
            createNewLeaveRequestInternal();
        };
        
        // Logo management functions
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize authentication manager first
            window.authManager = new AuthManager();
            
            // Wait for auth manager and company data service to be ready, then initialize user UI
            (async function initAfterAuth() {
                // Initialize current user once authManager is ready
                try {
                    // Wait for authManager to populate currentUser and company data
                    let attempts = 0;
                    while ((!window.authManager || !window.authManager.currentUser) && attempts < 10) {
                        await new Promise(r => setTimeout(r, 300));
                        attempts++;
                    }

                    initializeCurrentUser();

                    // Ensure companyDataService has attempted to load the company context
                    if (window.companyDataService) {
                        let retries = 0;
                        while (retries < 15 && !window.companyDataService.getCurrentCompanyId()) {
                            await new Promise(r => setTimeout(r, 300));
                            retries++;
                        }
                    }

                    // Initialize menu visibility after auth
                    updateMenuVisibility();

                    // Update company branding — call via authManager if available
                    if (window.authManager && typeof window.authManager.updateCompanyBranding === 'function') {
                        try { window.authManager.updateCompanyBranding(); } catch (e) { console.warn('Branding call failed', e); }
                    } else if (window.companyDataService && typeof window.companyDataService.getCurrentCompany === 'function') {
                        // As a fallback, set header directly from companyDataService
                        const comp = window.companyDataService.getCurrentCompany();
                        if (comp) {
                            const logoEl = document.getElementById('headerCompanyLogo');
                            const nameEl = document.getElementById('headerCompanyName');
                            if (nameEl) nameEl.textContent = comp.companyName || '';
                            if (logoEl && (comp.logo || comp.logoUrl)) { logoEl.src = comp.logo || comp.logoUrl; logoEl.classList.add('visible'); }
                        }
                    }

                    // Now apply feature-based menu authorization (allow for slower DB reads)
                    try {
                        await updateMenuWithFeatureAuthorization();
                    } catch (error) {
                        console.error('❌ Error initializing feature-based menu:', error);
                        showBasicMenu();
                    }
                } catch (err) {
                    console.error('Error during auth initialization flow:', err);
                    showBasicMenu();
                }
            })();
            
            // Load saved logo if exists
            const savedLogo = localStorage.getItem('companyLogo') || localStorage.getItem('mainCompanyLogo');
            if (savedLogo) {
                updateLogoInHeader(savedLogo);
            }

            // Initialize tabs
            initializeTabs();
            
            // Load existing timesheets
            loadTimesheets();
              // Load existing leave requests
            loadLeaveRequests();
            
            // Initialize line manager dropdown
            initializeLineManagerDropdown();
            
            // Initialize profile dropdown functionality
            initializeProfileDropdown();
            
            // Initialize sidebar toggle
            const sidebarToggle = document.querySelector('#sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Load organization data (current user and line manager info)
            setTimeout(() => {
                console.log('🚀 Starting organization data load...');
                loadOrganizationData();
                
                // Also run the test function
                setTimeout(() => {
                    console.log('🧪 Running Firebase test...');
                    testFirebaseConnection();
                    
                    // Test direct reports too
                    setTimeout(() => {
                        console.log('🧪 Running direct reports test...');
                        testDirectReports();
                    }, 1000);
                }, 2000);
            }, 1000);
        });
        
        function toggleSidebar(){
            const sb=document.querySelector('.sidebar');
            const mc=document.querySelector('.main-content');
            const top=document.querySelector('.top-nav');
            if(!sb||!mc) return;
            const collapsed=sb.classList.toggle('collapsed');
            mc.classList.toggle('sidebar-collapsed',collapsed);
            if(top){ top.style.left= collapsed? '.5rem': 'calc(var(--sidebar-width) + .5rem)'; }
            localStorage.setItem('sidebarCollapsed',collapsed);
        }
        function restoreSidebarState(){
            const collapsed=localStorage.getItem('sidebarCollapsed')==='true';
            const sb=document.querySelector('.sidebar');
            const mc=document.querySelector('.main-content');
            const top=document.querySelector('.top-nav');
            if(collapsed && sb && mc){ sb.classList.add('collapsed'); mc.classList.add('sidebar-collapsed'); if(top){top.style.left='.5rem';} }
        }
        document.addEventListener('DOMContentLoaded',()=>{
            restoreSidebarState();
            document.getElementById('sidebarToggle')?.addEventListener('click',toggleSidebar);
        });
        
        function initializeCurrentUser() {
            // Get the actual logged-in user from the authentication system
            const currentUser = window.authManager?.getUser();
            
            if (currentUser) {
                // Use the authenticated user's information
                const currentUserName = currentUser.name || currentUser.email?.split('@')[0] || 'Current User';
                localStorage.setItem('userName', currentUserName);
                localStorage.setItem('specificUserName', currentUserName);
                
                // Set user job info from authenticated user or defaults
                if (!localStorage.getItem('userJobTitle')) {
                    localStorage.setItem('userJobTitle', currentUser.jobTitle || currentUser.title || 'Employee');
                }
                if (!localStorage.getItem('userDepartment')) {
                    localStorage.setItem('userDepartment', currentUser.department || 'General');
                }
                
                console.log('Initialized current user as:', currentUserName);
            } else {
                // Fallback if no authenticated user (shouldn't happen with proper auth)
                console.warn('No authenticated user found - this should redirect to login');
                // Don't set hardcoded values, let the auth system handle this
            }
        }

        // Menu visibility functions
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
            // Also reset submenu items specifically
            document.querySelectorAll('.submenu li').forEach(submenuItem => {
                submenuItem.classList.remove('menu-visible');
            });
        }

        async function updateMenuVisibility() {
            console.log('🔧 Starting menu visibility update...');
            
            try {
                const currentUser = window.authManager?.getUser();
                if (!currentUser) {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // Get user's company ID and role
                const companyId = currentUser.companyId;
                const userRole = currentUser.role;
                
                if (!companyId || !userRole) {
                    console.log('❌ Missing company ID or user role');
                    resetMenuVisibility();
                    return;
                }
                
                console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                
                // Get company role permissions from Firebase
                if (typeof firebase === 'undefined') {
                    console.warn('Firebase not available - showing basic menu');
                    showBasicMenu();
                    return;
                }
                
                const snapshot = await firebase.database().ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
                
                if (!snapshot.exists()) {
                    console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                    showBasicMenu();
                    return;
                }
                
                const permissions = snapshot.val();
                console.log('✅ Loaded permissions:', permissions);
                updateMenuWithPermissions(permissions);
                
            } catch (error) {
                console.error('❌ Error updating menu visibility:', error);
                showBasicMenu();
            }
        }

        function updateMenuWithPermissions(permissions) {
            console.log('🎯 Updating menu with permissions...');
            console.log('🎯 Permissions object:', permissions);
            
            // Reset menu visibility first
            resetMenuVisibility();
            
            if (!permissions) {
                console.log('⚠️ No permissions object provided');
                return;
            }
            
            // Update menu visibility based on permissions
            const menuItems = document.querySelectorAll('[data-feature]');
            console.log(`🎯 Found ${menuItems.length} menu items to check`);
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                const isSubmenuItem = item.closest('.submenu') !== null;
                const isDropdownContainer = item.classList.contains('menu-dropdown');
                const parentDropdown = item.closest('.menu-dropdown');
                const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                
                console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                
                // Skip dropdown containers - they will be handled separately
                if (isDropdownContainer) {
                    console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                    return;
                }
                
                // If item doesn't require permission, check if user has permission for this feature
                if (!requiresPermission) {
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature} (no requirement, has permission)`);
                        } else {
                            console.log(`❌ No view permission for: ${feature} (no requirement)`);
                        }
                    } else {
                        // For basic features like home, show by default
                        if (feature === 'home_view' || feature === 'dashboard_view') {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing basic menu item: ${feature}`);
                        } else {
                            console.log(`⚪ Feature not found in permissions: ${feature} (no requirement)`);
                        }
                    }
                    return;
                }
                
                // If item requires permission, check if user has it
                if (feature && permissions[feature]) {
                    const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                    
                    if (hasViewPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature} (has required permission)`);
                    } else {
                        console.log(`❌ No view permission for: ${feature} (permission exists but denied)`);
                    }
                } else {
                    console.log(`⚪ Feature not found in permissions: ${feature} (requires permission but not found)`);
                }
            });
            
            // Handle parent dropdowns - show only if they have visible children
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const hasVisibleChildren = visibleSubmenuItems.length > 0;
                
                console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                
                if (hasVisibleChildren) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                } else {
                    console.log(`❌ Hiding parent dropdown ${dropdownFeature} (no visible children)`);
                }
            });
            
            console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
            
            // If no items are visible, show at least home
            if (visibleCount === 0) {
                showBasicMenu();
            }
        }

        function showBasicMenu() {
            const homeItem = document.querySelector('[data-feature="home_view"]');
            const dashboardItem = document.querySelector('[data-feature="dashboard_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
                console.log('⚠️ No permissions found - showing home as fallback');
            }
            if (dashboardItem) {
                dashboardItem.classList.add('menu-visible');
                console.log('⚠️ No permissions found - showing dashboard as fallback');
            }
        }        function initializeLineManagerDropdown() {
            const lineManagerSelect = document.getElementById('lineManager');
            if (lineManagerSelect) {
                // Load current user's line manager information
                // Add a small delay to ensure auth manager is ready
                setTimeout(() => {
                    loadCurrentUserLineManager(lineManagerSelect);
                }, 200);
            }
            
            // Remove default name setting - let users enter their real names
            
            // For demo purposes: Set default user role that allows approval
            // Remove or modify this in production
            if (!localStorage.getItem('userRole')) {
                localStorage.setItem('userRole', 'supervisor'); // Change to 'employee' to test non-approver view
                console.log('Demo: Set default user role to supervisor. Change to "employee" to test restrictions.');
            }
        }

        async function loadCurrentUserLineManager(lineManagerSelect) {
            try {
                // Get current user from auth manager
                const currentUser = window.authManager?.getUser();
                if (!currentUser || !currentUser.uid) {
                    console.warn('No authenticated user found');
                    lineManagerSelect.innerHTML = '<option value="">Unable to determine current user</option>';
                    return;
                }

                // Fetch current user's data from Firebase to get their line manager
                const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/users/${currentUser.uid}.json`);
                
                if (response.ok) {
                    const userData = await response.json();
                    
                    if (userData) {
                        // Store the user data globally for other functions to access
                        window.currentUserData = userData;
                        
                        // Also update localStorage with current user data (including line manager info)
                        try {
                            const existingUserData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                            const updatedUserData = {
                                ...existingUserData,
                                lineManager: userData.lineManager,
                                lineManagerName: userData.lineManagerName,
                                firstName: userData.firstName,
                                lastName: userData.lastName,
                                email: userData.email,
                                jobTitle: userData.jobTitle,
                                department: userData.department
                            };
                            localStorage.setItem('currentUser', JSON.stringify(updatedUserData));
                        } catch (error) {
                            console.warn('Error updating localStorage with user data:', error);
                        }
                        
                        if (userData.lineManagerName) {
                            // Clear existing options
                            lineManagerSelect.innerHTML = '';
                            
                            // Add the current user's line manager as the selected option
                            const option = document.createElement('option');
                            option.value = userData.lineManager || '';
                            option.textContent = userData.lineManagerName;
                            option.selected = true;
                            lineManagerSelect.appendChild(option);
                            
                            console.log('Loaded line manager for current user:', userData.lineManagerName);
                        } else if (userData.lineManager) {
                            // Line manager ID exists but no name - try to fetch the name
                            try {
                                const managerResponse = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/users/${userData.lineManager}.json`);
                                if (managerResponse.ok) {
                                    const managerData = await managerResponse.json();
                                    if (managerData && managerData.firstName && managerData.lastName) {
                                        const managerName = `${managerData.firstName} ${managerData.lastName}`.trim();
                                        
                                        // Update the user data with the manager name
                                        window.currentUserData.lineManagerName = managerName;
                                        
                                        // Clear existing options
                                        lineManagerSelect.innerHTML = '';
                                        
                                        const option = document.createElement('option');
                                        option.value = userData.lineManager;
                                        option.textContent = managerName;
                                        option.selected = true;
                                        lineManagerSelect.appendChild(option);
                                        
                                        console.log('Fetched and loaded line manager name:', managerName);
                                    } else {
                                        lineManagerSelect.innerHTML = '<option value="">Line Manager Not Found</option>';
                                    }
                                } else {
                                    lineManagerSelect.innerHTML = '<option value="">Unable to Load Line Manager Details</option>';
                                }
                            } catch (error) {
                                console.error('Error fetching line manager details:', error);
                                lineManagerSelect.innerHTML = '<option value="">Error Loading Line Manager</option>';
                            }
                        } else {
                            // No line manager assigned
                            lineManagerSelect.innerHTML = '<option value="">No Line Manager Assigned</option>';
                            console.log('No line manager assigned to current user');
                        }
                    } else {
                        console.warn('No user data found in Firebase');
                        lineManagerSelect.innerHTML = '<option value="">User data not found</option>';
                    }
                } else {
                    console.warn('Failed to load user data from Firebase');
                    lineManagerSelect.innerHTML = '<option value="">Unable to load line manager</option>';
                }
            } catch (error) {
                console.error('Error loading current user line manager:', error);
                lineManagerSelect.innerHTML = '<option value="">Error loading line manager</option>';
            }
        }

        // Initialize profile dropdown functionality
        function initializeProfileDropdown() {
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (profileBtn && profileDropdown) {
                // Toggle dropdown on profile button click
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
                
                // Handle logout functionality
                const logoutBtn = profileDropdown.querySelector('a[href="#"]');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        handleLogout();
                    });
                }
            }
        }
        
        // Handle user logout
        async function handleLogout() {
            try {
                // Clear user data
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userName');
                localStorage.removeItem('specificUserName');
                localStorage.removeItem('userJobTitle');
                localStorage.removeItem('userDepartment');
                sessionStorage.clear();
                
                // Redirect to login page
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error during logout:', error);
                // Still redirect even if there's an error
                window.location.href = 'login.html';
            }
        }

        function updateLogoInHeader(logoUrl) {
            // Update the existing header logo
            const headerLogo = document.getElementById('headerCompanyLogo');
            if (headerLogo) {
                headerLogo.src = logoUrl;
            }
        }

        // Listen for main company logo changes
        window.addEventListener('mainCompanyLogoChanged', function(e) {
            updateLogoInHeader(e.detail.logoUrl);
        });

        // Initialize tabs only after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 Initializing tabs...');
            
            const container = document.querySelector('.tab-buttons');
            console.log('Tab container found:', !!container);
            
            const tabButtons = document.querySelectorAll('.tab-button');
            console.log('Tab buttons found:', tabButtons.length);
            
            const tabContents = document.querySelectorAll('.tab-content');
            console.log('Tab contents found:', tabContents.length);
            
            function activateTab(targetTab) {
                console.log('🎯 Activating tab:', targetTab);
                
                if (!targetTab) {
                    console.warn('No target tab specified');
                    return;
                }
                
                // Remove active classes
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    console.log('Removed active from button:', btn.getAttribute('data-tab'));
                });
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    console.log('Removed active from content:', content.id);
                });
                
                // Activate target button
                const targetButton = Array.from(tabButtons)
                    .find(btn => btn.getAttribute('data-tab') === targetTab);
                    
                if (targetButton) {
                    targetButton.classList.add('active');
                    console.log('Activated button:', targetTab);
                }
                
                // Activate target content
                const targetContent = document.getElementById(targetTab + 'Tab');
                if (targetContent) {
                    targetContent.classList.add('active');
                    console.log('Activated content:', targetTab + 'Tab');
                } else {
                    console.warn('Content not found:', targetTab + 'Tab');
                }
                
                // Load data if needed
                if (targetTab === 'org') {
                    console.log('Loading organization data...');
                    if (typeof loadOrganizationData === 'function') {
                        loadOrganizationData();
                    }
                }
                if (targetTab === 'leave') {
                    console.log('Loading leave data...');
                    if (typeof loadLeaveRequests === 'function') {
                        loadLeaveRequests();
                    }
                }
                if (targetTab === 'timesheet') {
                    console.log('Loading timesheet data...');
                    if (typeof loadTimesheets === 'function') {
                        loadTimesheets();
                    }
                }
            }
            
            // Initialize to first active or default to timesheet
            const initialTab = document.querySelector('.tab-button.active');
            console.log('Initial active tab found:', !!initialTab);
            
            if (initialTab) {
                activateTab(initialTab.getAttribute('data-tab'));
            }
            
            // Add direct click handlers with debug logging
            tabButtons.forEach(button => {
                console.log('Adding click handler to button:', button.getAttribute('data-tab'));
                
                // Add direct click handler
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetTab = this.getAttribute('data-tab');
                    console.log('🖱️ Tab button clicked:', targetTab);
                    console.log('Button element:', this.outerHTML);
                    activateTab(targetTab);
                });
                
                // Also add mousedown for debugging
                button.addEventListener('mousedown', function(e) {
                    console.log('🖱️ Mouse down on tab:', this.getAttribute('data-tab'));
                });
                
                // Check if button is properly interactive
                console.log('Button disabled:', button.disabled);
                console.log('Button hidden:', button.hidden);
                console.log('Button display:', window.getComputedStyle(button).display);
            });
            
            console.log('✅ Tab initialization complete');
        });

        // Timesheet functionality
        let timesheets = [];
        let currentTimesheetId = null;        async function loadTimesheets() {
            try {
                // Get company ID and user ID for scoped loading
                const companyId = getCompanyId();
                const currentUserId = getCurrentUserName() || 'unknown';
                const canApprove = checkUserCanApprove();
                
                console.log('📊 Loading timesheets from Firebase:');
                console.log('  - Company ID:', companyId);
                console.log('  - User ID:', currentUserId);
                console.log('  - Can Approve:', canApprove);
                
                if (!companyId) {
                    console.warn('No company ID found, falling back to local storage');
                    loadTimesheetsFromLocalStorage();
                    return;
                }
                
                let timesheetData = [];
                
                if (canApprove) {
                    // Load ALL timesheets from the company for approvers
                    console.log('🔍 Loading ALL company timesheets (user is approver)');
                    const allTimesheetsUrl = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/timesheets.json`;
                    console.log('  - URL:', allTimesheetsUrl);
                    
                    const response = await fetch(allTimesheetsUrl);
                    
                    if (response.ok) {
                        const allFirebaseTimesheets = await response.json();
                        
                        if (allFirebaseTimesheets) {
                            // Flatten all user timesheets into a single array and normalize submittedBy fields
                            timesheetData = [];
                            Object.keys(allFirebaseTimesheets).forEach(userKey => {
                                const userTimesheets = allFirebaseTimesheets[userKey];
                                if (userTimesheets && typeof userTimesheets === 'object') {
                                    Object.values(userTimesheets).forEach(timesheet => {
                                        // Normalize submittedBy fields: support submittedByName or legacy submittedBy
                                        if (!timesheet.submittedByName && timesheet.submittedBy) {
                                            timesheet.submittedByName = timesheet.submittedBy;
                                        }
                                        // Ensure we always have a submittedBy (string) and submittedById
                                        timesheet.submittedBy = timesheet.submittedByName || timesheet.submittedBy || userKey;
                                        timesheet.submittedById = timesheet.userId || userKey;
                                        timesheetData.push(timesheet);
                                    });
                                }
                            });
                            console.log(`✅ Loaded ${timesheetData.length} timesheets from all users`);
                        }
                    } else {
                        console.warn('Failed to load all company timesheets, trying user-specific path');
                    }
                }
                
                // If we didn't get timesheets as approver, or user is not an approver, load only user's own timesheets
                if (timesheetData.length === 0) {
                    console.log('📝 Loading user-specific timesheets');
                    const userTimesheetsUrl = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/timesheets/${currentUserId}.json`;
                    console.log('  - URL:', userTimesheetsUrl);
                    
                    const response = await fetch(userTimesheetsUrl);
                    
                    if (response.ok) {
                        const firebaseTimesheets = await response.json();
                        
                        if (firebaseTimesheets) {
                            // Convert Firebase object to array and normalize submittedBy fields
                            timesheetData = Object.values(firebaseTimesheets).map(ts => {
                                ts.submittedBy = ts.submittedByName || ts.submittedBy || currentUserId;
                                ts.submittedById = ts.userId || currentUserId;
                                return ts;
                            });
                            console.log('✅ User timesheets loaded from Firebase:', timesheetData.length);
                        }
                    } else {
                        console.warn('Failed to load user timesheets from Firebase, using local storage');
                        loadTimesheetsFromLocalStorage();
                        return;
                    }
                }
                
                // Set the global timesheets array
                timesheets = timesheetData;
                
                // Set up real-time listener
                if (canApprove) {
                    // For approvers, listen to all timesheets
                    setupTimesheetRealTimeListener(companyId, null); // null means all users
                } else {
                    // For regular users, listen only to their own
                    setupTimesheetRealTimeListener(companyId, currentUserId);
                }
                
                console.log('📊 Final timesheets array:', timesheets.length, 'timesheets');
                
            } catch (error) {
                console.error('Error loading timesheets from Firebase:', error);
                loadTimesheetsFromLocalStorage();
            }
            
            await displayTimesheets();
        }
        
        function loadTimesheetsFromLocalStorage() {
            // Fallback to localStorage
            const storedTimesheets = localStorage.getItem('userTimesheets');
            if (storedTimesheets) {
                timesheets = JSON.parse(storedTimesheets);
            } else {
                timesheets = [];
                // Create sample timesheets for demo purposes
                createSampleTimesheets();
            }
        }
        
        // Real-time listener for timesheet updates
        async function setupTimesheetRealTimeListener(companyId, userId) {
            try {
                const database = getDatabase();
                
                // Check if user can approve timesheets
                const canApprove = await checkUserCanApprove();
                
                let timesheetsRef;
                if (canApprove) {
                    // Listen to all company timesheets
                    timesheetsRef = ref(database, `companies/${companyId}/timesheets`);
                    console.log('🔄 Setting up real-time listener for ALL company timesheets (approver mode)');
                } else {
                    // Listen to only user's timesheets
                    timesheetsRef = ref(database, `companies/${companyId}/timesheets/${userId}`);
                    console.log('🔄 Setting up real-time listener for user timesheets only');
                }
                
                onValue(timesheetsRef, (snapshot) => {
                    console.log('📡 Real-time update received for timesheets');
                    const data = snapshot.val();
                    
                    if (data) {
                        if (canApprove) {
                            // For approvers: collect all timesheets from all users and normalize
                            timesheets = [];
                            Object.keys(data).forEach(userKey => {
                                if (data[userKey] && typeof data[userKey] === 'object') {
                                    Object.values(data[userKey]).forEach(ts => {
                                        // Normalize fields
                                        if (!ts.submittedByName && ts.submittedBy) ts.submittedByName = ts.submittedBy;
                                        ts.submittedBy = ts.submittedByName || ts.submittedBy || userKey;
                                        ts.submittedById = ts.userId || userKey;
                                        timesheets.push(ts);
                                    });
                                }
                            });
                            console.log(`✅ All company timesheets updated from real-time listener: ${timesheets.length} total timesheets`);
                        } else {
                            // For regular users: just their timesheets, normalize
                            timesheets = Object.values(data).map(ts => {
                                if (!ts.submittedByName && ts.submittedBy) ts.submittedByName = ts.submittedBy;
                                ts.submittedBy = ts.submittedByName || ts.submittedBy || getCurrentUserName();
                                ts.submittedById = ts.userId || getCurrentUserName();
                                return ts;
                            });
                            console.log(`✅ User timesheets updated from real-time listener: ${timesheets.length} timesheets`);
                        }
                        
                        // Update display in real-time
                        displayTimesheets();
                    } else {
                        timesheets = [];
                        displayTimesheets();
                    }
                });
            } catch (error) {
                console.error('Error setting up real-time listener:', error);
            }
        }
        
        function createSampleTimesheets() {
            const now = new Date();
            const currentUserName = getCurrentUserName(); // Get current user's name
            
            const sampleTimesheets = [
                {
                    id: generateId(),
                    period: 'May 2025 Timesheet',
                    monthYear: '2025-05',
                    status: 'submitted',
                    entries: generateMonthEntries(2025, 4), // May 2025
                    totalHours: 168.0,
                    totalRegularHours: 160.0,
                    totalOvertimeHours: 8.0,
                    createdDate: new Date(2025, 4, 1).toISOString(),
                    submittedDate: new Date(2025, 4, 31).toISOString(),
                    submittedBy: currentUserName
                },
                {
                    id: generateId(),
                    period: 'April 2025 Timesheet',
                    monthYear: '2025-04',
                    status: 'approved',
                    entries: generateMonthEntries(2025, 3), // April 2025
                    totalHours: 160.0,
                    totalRegularHours: 160.0,
                    totalOvertimeHours: 0.0,
                    createdDate: new Date(2025, 3, 1).toISOString(),
                    submittedDate: new Date(2025, 3, 30).toISOString(),
                    approvedDate: new Date(2025, 4, 2).toISOString(),
                    approvedBy: { name: 'John Manager', email: 'john.manager@company.com' },
                    approverComments: 'Timesheet approved. Good work this month!',
                    submittedBy: currentUserName
                },
                {
                    id: generateId(),
                    period: 'March 2025 Timesheet',
                    monthYear: '2025-03',
                    status: 'rejected',
                    entries: generateMonthEntries(2025, 2), // March 2025
                    totalHours: 140.0,
                    totalRegularHours: 140.0,
                    totalOvertimeHours: 0.0,
                    createdDate: new Date(2025, 2, 1).toISOString(),
                    submittedDate: new Date(2025, 2, 31).toISOString(),
                    rejectedDate: new Date(2025, 3, 3).toISOString(),
                    rejectedBy: { name: 'Jane Supervisor', email: 'jane.supervisor@company.com' },
                    approverComments: 'Please review the time entries for March 15-17. Some discrepancies found.',
                    submittedBy: currentUserName
                },
                // Add a timesheet from another user for testing visibility restrictions
                {
                    id: generateId(),
                    period: 'June 2025 Timesheet',
                    monthYear: '2025-06',
                    status: 'submitted',
                    entries: generateMonthEntries(2025, 5), // June 2025
                    totalHours: 160.0,
                    totalRegularHours: 160.0,
                    totalOvertimeHours: 0.0,
                    createdDate: new Date(2025, 5, 1).toISOString(),
                    submittedDate: new Date(2025, 5, 30).toISOString(),
                    submittedBy: 'Sarah Wilson' // Different user
                },
                // Add a draft timesheet from another user (should not be visible)
                {
                    id: generateId(),
                    period: 'July 2025 Timesheet',
                    monthYear: '2025-07',
                    status: 'draft',
                    entries: generateMonthEntries(2025, 6), // July 2025
                    totalHours: 80.0,
                    totalRegularHours: 80.0,
                    totalOvertimeHours: 0.0,
                    createdDate: new Date(2025, 6, 1).toISOString(),
                    submittedDate: null,
                    submittedBy: 'Mike Johnson' // Different user
                }
            ];
            
            timesheets = sampleTimesheets;
            saveTimesheetsToStorage();
        }
        
        function saveTimesheetsToStorage() {
            localStorage.setItem('userTimesheets', JSON.stringify(timesheets));
        }        // Function to check if current user can view a specific timesheet
        async function canUserViewTimesheet(timesheet) {
            const currentUserName = getCurrentUserName();
            
            console.log(`🔍 Checking visibility for timesheet: ${timesheet.period} (submitted by: ${timesheet.submittedBy}, status: ${timesheet.status})`);
            console.log(`👤 Current user: ${currentUserName}`);
            
            // User can always see their own timesheets regardless of status
            if (timesheet.submittedBy === currentUserName) {
                console.log('✅ User can see their own timesheet');
                return true;
            }
            
            // For draft timesheets from other users, only the owner can see them
            if (timesheet.status === 'draft') {
                console.log('❌ Draft timesheet from another user - hidden');
                return false;
            }
            
            // For submitted/approved/rejected timesheets, check if current user is an authorized approver
            if (timesheet.status === 'submitted' || timesheet.status === 'approved' || timesheet.status === 'rejected') {
                console.log('🔍 Checking if user is authorized approver for this timesheet...');
                
                const isAuthorizedApprover = await isUserAuthorizedApprover(timesheet.submittedBy);
                console.log(`✅ Authorized approver check result: ${isAuthorizedApprover}`);
                return isAuthorizedApprover;
            }
            
            console.log('❌ Unknown timesheet status or user not authorized');
            return false;
        }

        // Enhanced function to check if user is authorized approver based on approval flow
        async function isUserAuthorizedApprover(submittedByUser) {
            const currentUserName = getCurrentUserName();
            const companyId = getCompanyId();
            
            console.log(`🔍 Checking if ${currentUserName} is authorized to approve timesheets from ${submittedByUser}`);
            
            if (!companyId) {
                console.warn('⚠️ No company ID found - cannot check approval flow');
                return false;
            }
            
            try {
                // First, get the approval flow configuration
                let timesheetApprovalFlow = null;
                
                // Try Firebase v8 database API first
                if (window.firebase && firebase.database) {
                    try {
                        const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/timesheet`);
                        const snapshot = await approvalFlowRef.once('value');
                        timesheetApprovalFlow = snapshot.val();
                        console.log('📋 Retrieved approval flow from Firebase v8:', timesheetApprovalFlow);
                    } catch (fbError) {
                        console.warn('⚠️ Firebase v8 check failed:', fbError);
                    }
                }
                
                // Fallback to REST API if v8 failed
                if (!timesheetApprovalFlow) {
                    try {
                        const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/approvalFlows/timesheet.json`);
                        
                        if (response.ok) {
                            timesheetApprovalFlow = await response.json();
                            console.log('📋 Retrieved approval flow from REST API:', timesheetApprovalFlow);
                        } else {
                            console.log('❌ Failed to fetch approval flow:', response.status);
                        }
                    } catch (restError) {
                        console.warn('⚠️ REST API check failed:', restError);
                    }
                }
                
                // If no approval flow configuration exists, fall back to basic role check
                if (!timesheetApprovalFlow || !timesheetApprovalFlow.selectedRoles) {
                    console.log('⚠️ No approval flow configuration found - using basic role check');
                    return checkUserCanApprove();
                }
                
                // Check if current user is configured as an approver
                const isConfiguredApprover = checkApproverPermission(timesheetApprovalFlow, currentUserName, submittedByUser);
                
                if (isConfiguredApprover) {
                    console.log('✅ User is configured as approver in approval flow');
                    return true;
                }
                
                // Additional check: If no specific approvers are configured, allow users with approval permissions
                const hasAnyApprovers = Object.values(timesheetApprovalFlow.selectedRoles).some(level => 
                    Array.isArray(level) && level.length > 0
                );
                
                if (!hasAnyApprovers) {
                    console.log('⚠️ No specific approvers configured - using basic role check');
                    return checkUserCanApprove();
                }
                
                console.log('❌ User is not configured as an approver for this timesheet');
                return false;
                
            } catch (error) {
                console.error('💥 Error checking approval authorization:', error);
                // On error, fall back to basic permission check
                return checkUserCanApprove();
            }
        }

        // Helper function to check if current user is an approver for a specific timesheet
        function checkApproverPermission(approvalFlow, currentUserName, submittedBy) {
            console.log('🔍 Checking if current user is an approver for this timesheet...');
            console.log('📋 Approval flow config:', approvalFlow);
            console.log('👤 Current user:', currentUserName);
            console.log('📤 Submitted by:', submittedBy);
            
            // Get current user information
            const currentUserInfo = getCurrentUserInfo();
            const currentUserEmail = currentUserInfo?.email;
            const currentUserRole = localStorage.getItem('userRole');
            
            console.log('👤 Current user email:', currentUserEmail);
            console.log('👤 Current user role:', currentUserRole);
            
            // Check each level of approval
            for (const [levelKey, levelConfig] of Object.entries(approvalFlow.selectedRoles)) {
                if (!levelConfig || !Array.isArray(levelConfig)) {
                    console.log(`⚠️ Skipping invalid level ${levelKey}:`, levelConfig);
                    continue;
                }
                
                console.log(`🔍 Checking approval level: ${levelKey} with ${levelConfig.length} approvers`);
                
                for (const approverConfig of levelConfig) {
                    console.log(`🔍 Checking approver config:`, approverConfig);
                    
                    if (approverConfig.type === 'function') {
                        // Function-based approver (e.g., "Manager", "Supervisor")
                        console.log(`🔍 Checking function-based approver: ${approverConfig.value}`);
                        
                        // Check if user's role matches the required function
                        if (currentUserRole && currentUserRole.toLowerCase().includes(approverConfig.value.toLowerCase())) {
                            console.log('✅ User role matches function-based approver requirement');
                            return true;
                        }
                        
                        // Also check general approval permissions for function-based roles
                        const canApprove = checkUserCanApprove();
                        if (canApprove) {
                            console.log('✅ User can approve based on general function-based permissions');
                            return true;
                        }
                    } 
                    else if (approverConfig.type === 'user') {
                        // Specific user approver
                        console.log(`🔍 Checking specific user approver: ${approverConfig.name} / ${approverConfig.email} / id:${approverConfig.id}`);

                        const nameMatch = approverConfig.name && approverConfig.name === currentUserName;
                        const emailMatch = approverConfig.email && approverConfig.email === currentUserEmail;
                        const idMatch = approverConfig.id && approverConfig.id === currentUserInfo.id;

                        if (nameMatch || emailMatch || idMatch) {
                            console.log('✅ User is specifically listed as an approver');
                            return true;
                        }
                    } 
                    else if (approverConfig.type === 'level') {
                        // Level-based approver (e.g., "one_level_up", "two_levels_up")
                        console.log(`🔍 Checking level-based approver: ${approverConfig.value}`);
                        
                        // For level-based approval, check if user has supervisory role
                        if (currentUserRole && (
                            currentUserRole.toLowerCase().includes('manager') ||
                            currentUserRole.toLowerCase().includes('supervisor') ||
                            currentUserRole.toLowerCase().includes('director') ||
                            currentUserRole.toLowerCase().includes('admin')
                        )) {
                            console.log('✅ User has supervisory role for level-based approval');
                            return true;
                        }
                        
                        // Also use the general approval permission check
                        const canApprove = checkUserCanApprove();
                        if (canApprove) {
                            console.log('✅ User can approve based on level-based permissions');
                            return true;
                        }
                    }
                    else {
                        // Unknown type - attempt to match legacy 'value' field (could be id, email or name)
                        if (approverConfig.value) {
                            const legacyMatch = [currentUserName, currentUserEmail, currentUserInfo?.id].some(v => v && approverConfig.value === v);
                            if (legacyMatch) {
                                console.log('✅ User matches legacy approver value');
                                return true;
                            }
                        }
                        console.log(`⚠️ Unknown approver type: ${approverConfig.type}`);
                    }
                }
            }
            
            console.log('❌ User is not an approver for this timesheet');
            return false;
        }

        // Function to filter timesheets based on visibility rules
        async function filterVisibleTimesheets(allTimesheets) {
            const visibleTimesheets = [];
            
            for (const timesheet of allTimesheets) {
                const canView = await canUserViewTimesheet(timesheet);
                if (canView) {
                    visibleTimesheets.push(timesheet);
                } else {
                    // Extra debug: why this timesheet was not visible
                    try {
                        console.log(`🔒 Timesheet hidden: ${timesheet.id} status:${timesheet.status} submittedBy:${timesheet.submittedBy} -> canUserViewTimesheet returned false`);
                    } catch (e) {
                        console.log('🔒 Timesheet hidden (no id available)');
                    }
                }
            }
            
            return visibleTimesheets;
        }        async function displayTimesheets() {
            console.log('🎭 === DISPLAY TIMESHEETS DEBUG ===');
            const tableBody = document.getElementById('timesheetTableBody');
            const emptyState = document.getElementById('timesheetEmptyState');
            
            console.log('📊 Total timesheets in array:', timesheets.length);
            console.log('📊 All timesheets:', timesheets);
            
            // Filter timesheets based on visibility rules
            const visibleTimesheets = await filterVisibleTimesheets(timesheets);
            
            console.log('👁️ Visible timesheets after filtering:', visibleTimesheets.length);
            console.log('👁️ Visible timesheets:', visibleTimesheets);
            
            if (visibleTimesheets.length === 0) {
                console.log('❌ No visible timesheets - showing empty state');
                emptyState.style.display = 'table-row';
                return;
            }
            
            console.log('✅ Showing', visibleTimesheets.length, 'timesheets');
            emptyState.style.display = 'none';
            
            // Remove existing rows (except empty state)
            const existingRows = tableBody.querySelectorAll('tr:not(.empty-state)');
            existingRows.forEach(row => row.remove());

            visibleTimesheets.forEach(timesheet => {
                console.log('🔨 Creating row for timesheet:', timesheet.id, timesheet.status);
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.setAttribute('data-timesheet-id', timesheet.id);
                
                // Add special styling for timesheets that need approval
                if (timesheet.status === 'submitted' && checkUserCanApprove()) {
                    row.classList.add('needs-approval');
                    console.log('⏳ Added needs-approval styling to timesheet:', timesheet.id);
                }
                  row.innerHTML = `
                    <td>${timesheet.period}</td>
                    <td>${formatMonthYear(timesheet.monthYear)}</td>
                    <td>${timesheet.totalHours || '0.0'} hrs</td>
                    <td>
                        <span class="status-badge status-${timesheet.status}">${capitalizeFirst(timesheet.status)}</span>
                        ${timesheet.status === 'submitted' && checkUserCanApprove() ? '<span class="approval-indicator" title="Needs Approval">⏳</span>' : ''}
                    </td>
                    <td>${timesheet.submittedBy || getCurrentUserName()}</td>
                    <td>${timesheet.submittedDate ? formatDate(timesheet.submittedDate) : '-'}</td>                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-primary" onclick="editTimesheet('${timesheet.id}')" ${timesheet.status === 'approved' ? 'disabled' : ''} title="Edit Timesheet">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTimesheet('${timesheet.id}')" title="Delete Timesheet">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${timesheet.status === 'submitted' && checkUserCanApprove() ? `
                        <button class="btn btn-sm btn-success" onclick="openTimesheetDetailsModal('${timesheet.id}')" title="Review & Approve">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                  // Add click event listener to the row for opening the modal
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on action buttons
                    if (e.target.closest('td').cellIndex !== 6) {
                        openTimesheetDetailsModal(timesheet.id);
                    }
                });
                
                tableBody.appendChild(row);
            });
            
            console.log('🎭 === END DISPLAY TIMESHEETS DEBUG ===');
        }
        
        async function createNewTimesheetInternal() {
            console.log('🔧 createNewTimesheetInternal() called');
            
            try {
                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM format
                const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const period = `${monthName} Timesheet`;
                
                console.log('📋 Creating new timesheet:', period);
                console.log('📋 Generating timesheet ID...');
                
                const newTimesheet = {
                    id: generateId(),
                    period: period,
                    monthYear: currentMonth,
                    status: 'draft',
                    entries: generateMonthEntries(now.getFullYear(), now.getMonth()),
                    totalHours: 0,
                    totalRegularHours: 0,
                    totalOvertimeHours: 0,
                    createdDate: now.toISOString(),
                    submittedDate: null,
                    submittedBy: getCurrentUserName()
                };
                
                console.log('📋 Timesheet object created:', newTimesheet.id);
                console.log('💾 Saving to Firebase...');
                
                // Save to Firebase first
                const saved = await saveTimesheetToFirebase(newTimesheet);
                console.log('💾 Firebase save result:', saved);
                
                // Continue even if Firebase save fails for now
                if (saved || true) { // Temporarily allowing to continue even if Firebase fails
                    console.log('✅ Proceeding with timesheet creation');
                    timesheets.push(newTimesheet);
                    saveTimesheetsToStorage();
                    await displayTimesheets();
                    console.log('🎯 Calling editTimesheet to open modal...');
                    editTimesheet(newTimesheet.id);
                } else {
                    console.error('❌ Failed to save timesheet to Firebase');
                    alert('Failed to create timesheet. Please try again.');
                }
            } catch (error) {
                console.error('💥 Error in createNewTimesheetInternal:', error);
                alert('An error occurred while creating timesheet: ' + error.message);
            }
        }
        
        function editTimesheet(timesheetId) {
            console.log('🎯 editTimesheet() called with ID:', timesheetId);
            currentTimesheetId = timesheetId;
            const timesheet = timesheets.find(t => t.id === timesheetId);
            
            if (!timesheet) {
                console.error('❌ Timesheet not found with ID:', timesheetId);
                return;
            }
            
            console.log('📄 Found timesheet:', timesheet.period, 'Status:', timesheet.status);
            
            // Populate info cards in header
            const statusInput = document.getElementById('modalTimesheetStatusInput');
            statusInput.value = capitalizeFirst(timesheet.status);
            statusInput.className = `status-input-${timesheet.status}`;
            
            document.getElementById('modalCreatedDateInput').value = timesheet.createdDate ? 
                formatDate(timesheet.createdDate) : '-';
                
            // Calculate working days (entries with hours > 0)
            const workingDays = timesheet.entries.filter(entry => 
                (parseFloat(entry.regularHours) || 0) + (parseFloat(entry.overtimeHours) || 0) > 0
            ).length;
            
            // Populate submitted date and working days in approval section
            document.getElementById('modalSubmittedDate').textContent = timesheet.submittedDate ? 
                formatDate(timesheet.submittedDate) : '-';
            document.getElementById('modalWorkingDays').textContent = workingDays;
            
            // Show approval info if timesheet has been approved/rejected
            const approvalInfo = document.getElementById('approvalInfo');
            if (timesheet.status === 'approved' || timesheet.status === 'rejected') {
                approvalInfo.style.display = 'block';
                
                const actionDate = timesheet.status === 'approved' ? timesheet.approvedDate : timesheet.rejectedDate;
                const actionBy = timesheet.status === 'approved' ? timesheet.approvedBy : timesheet.rejectedBy;
                
                document.getElementById('modalActionDate').textContent = actionDate ? 
                    formatDate(actionDate) : '-';
                document.getElementById('modalActionBy').textContent = actionBy ? 
                    (actionBy.name || actionBy.email || 'Unknown') : '-';
                
                if (timesheet.approverComments && timesheet.approverComments.trim()) {
                    document.getElementById('approvalCommentsDisplay').style.display = 'block';
                    document.getElementById('commentsText').textContent = timesheet.approverComments;
                } else {
                    document.getElementById('approvalCommentsDisplay').style.display = 'none';
                }
            } else {
                approvalInfo.style.display = 'none';
            }
            
            // Populate modal
            try {
                const periodElement = document.getElementById('timesheetPeriod');
                const monthYearElement = document.getElementById('monthYear');
                const titleElement = document.getElementById('timesheetModalTitle');
                
                console.log('📝 Elements found:', {
                    period: !!periodElement,
                    monthYear: !!monthYearElement,
                    title: !!titleElement
                });
                
                if (periodElement) periodElement.value = timesheet.period;
                if (monthYearElement) monthYearElement.value = timesheet.monthYear;
                if (titleElement) titleElement.textContent = timesheet.status === 'draft' ? 'Edit Timesheet' : 'View Timesheet';
            } catch (error) {
                console.error('❌ Error populating modal fields:', error);
            }
            
            console.log('📝 Populating timesheet entries...');
            // Populate entries table
            try {
                populateTimesheetEntries(timesheet.entries, timesheet.status !== 'draft');
                updateTimesheetSummary(timesheet);
                console.log('📝 Timesheet entries populated successfully');
            } catch (error) {
                console.error('❌ Error populating timesheet entries:', error);
                // Continue anyway, the modal might still work
            }
            
            // Show/hide form actions and approval actions based on status
            try {
                const formActions = document.querySelector('.form-actions');
                const approvalActions = document.getElementById('approvalActions');
                const saveButton = document.querySelector('.btn[onclick="saveTimesheet()"]');
                const submitButton = document.querySelector('.btn[onclick="submitTimesheet()"]');
                
                console.log('📝 Form actions element found:', !!formActions);
                console.log('📝 Approval actions element found:', !!approvalActions);
                console.log('📝 Save/Submit buttons found:', !!saveButton, !!submitButton);
                console.log('📝 Timesheet status:', timesheet.status);
                
                // Check if user can approve timesheets
                const canApprove = checkUserCanApprove();
                console.log('📝 User can approve:', canApprove);
                
                if (timesheet.status === 'draft') {
                    // Show save and submit buttons for draft
                    console.log('📝 Showing draft mode actions');
                    if (formActions) formActions.style.display = 'flex';
                    if (saveButton) saveButton.style.display = 'inline-flex';
                    if (submitButton) submitButton.style.display = 'inline-flex';
                    if (approvalActions) approvalActions.style.display = 'none';
                    // Hide approval flow for drafts
                    const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                    if (approvalFlowSection) approvalFlowSection.style.display = 'none';
                } else if (timesheet.status === 'submitted') {
                    console.log('📝 Timesheet is submitted, checking approval permissions');
                    // Hide save and submit buttons for submitted timesheets
                    if (saveButton) saveButton.style.display = 'none';
                    if (submitButton) submitButton.style.display = 'none';
                    
                    if (canApprove) {
                        // Show approval actions for submitted timesheets if user can approve
                        console.log('📝 User can approve - showing approval actions');
                        if (formActions) formActions.style.display = 'none';
                        if (approvalActions) {
                            approvalActions.style.display = 'block';
                            console.log('📝 Approval actions made visible');
                            // Clear previous comments
                            const commentsField = document.getElementById('approvalComments');
                            if (commentsField) commentsField.value = '';
                        }
                    } else {
                        // User cannot approve - show only view mode
                        console.log('📝 User cannot approve - showing view only mode');
                        if (formActions) formActions.style.display = 'flex'; // Keep close button visible
                        if (approvalActions) approvalActions.style.display = 'none';
                    }
                    
                    // Show approval flow for submitted timesheets (both approvers and non-approvers can see it)
                    const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                    if (approvalFlowSection) {
                        approvalFlowSection.style.display = 'block';
                        // Load and display approval flow
                        loadTimesheetApprovalFlow();
                    }
                } else if (timesheet.status === 'approved' || timesheet.status === 'rejected') {
                    // For approved/rejected timesheets - view only mode
                    console.log('📝 Timesheet is approved/rejected - showing view only mode');
                    if (saveButton) saveButton.style.display = 'none';
                    if (submitButton) submitButton.style.display = 'none';
                    if (formActions) formActions.style.display = 'flex'; // Keep close button visible
                    if (approvalActions) approvalActions.style.display = 'none';
                    // Hide approval flow for final states
                    const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                    if (approvalFlowSection) approvalFlowSection.style.display = 'none';
                }
            } catch (error) {
                console.error('❌ Error handling form actions:', error);
            }
            
            console.log('🎭 About to show modal...');
            // Show modal
            const modal = document.getElementById('timesheetModal');
            console.log('🎭 Modal element found:', !!modal);
            
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('✅ Modal show class added, body overflow hidden');
            } else {
                console.error('❌ timesheetModal element not found!');
            }
        }        function openTimesheetDetailsModal(timesheetId) {
            console.log('🎭 openTimesheetDetailsModal() called with ID:', timesheetId);
            currentTimesheetId = timesheetId;
            const timesheet = timesheets.find(t => t.id === timesheetId);
            
            if (!timesheet) {
                console.error('❌ Timesheet not found with ID:', timesheetId);
                return;
            }
            
            console.log('📄 Found timesheet:', timesheet.period, 'Status:', timesheet.status, 'Submitted by:', timesheet.submittedBy);
            
            // Check if user can view this timesheet
            const currentUserName = getCurrentUserName();
            const isOwnTimesheet = timesheet.submittedBy === currentUserName;
            
            console.log('👤 Current user:', currentUserName);
            console.log('📝 Is own timesheet:', isOwnTimesheet);
            
            // Populate modal with data
            document.getElementById('timesheetPeriod').value = timesheet.period;
            document.getElementById('monthYear').value = timesheet.monthYear;
            
            // Set appropriate title
            if (isOwnTimesheet) {
                document.getElementById('timesheetModalTitle').textContent = timesheet.status === 'draft' ? 'Edit Timesheet' : 'View Timesheet';
            } else {
                document.getElementById('timesheetModalTitle').textContent = 'Review Timesheet';
            }
            
            // Populate info cards in header
            const statusInput = document.getElementById('modalTimesheetStatusInput');
            statusInput.value = capitalizeFirst(timesheet.status);
            statusInput.className = `status-input-${timesheet.status}`;
            
            document.getElementById('modalCreatedDateInput').value = timesheet.createdDate ? 
                formatDate(timesheet.createdDate) : '-';
                
            // Calculate working days (entries with hours > 0)
            const workingDays = timesheet.entries.filter(entry => 
                (parseFloat(entry.regularHours) || 0) + (parseFloat(entry.overtimeHours) || 0) > 0
            ).length;
            
            // Populate submitted date and working days in approval section
            document.getElementById('modalSubmittedDate').textContent = timesheet.submittedDate ? 
                formatDate(timesheet.submittedDate) : '-';
            document.getElementById('modalWorkingDays').textContent = workingDays;
            
            // Show approval info for approved/rejected timesheets
            const approvalInfo = document.getElementById('approvalInfo');
            
            if (timesheet.status === 'approved' || timesheet.status === 'rejected') {
                approvalInfo.style.display = 'block';
                
                const actionDate = timesheet.status === 'approved' ? timesheet.approvedDate : timesheet.rejectedDate;
                const actionBy = timesheet.status === 'approved' ? timesheet.approvedBy : timesheet.rejectedBy;
                
                document.getElementById('modalActionDate').textContent = actionDate ? 
                    formatDate(actionDate) : '-';
                document.getElementById('modalActionBy').textContent = actionBy ? 
                    (actionBy.name || actionBy.email || 'Unknown') : '-';
                
                if (timesheet.approverComments && timesheet.approverComments.trim()) {
                    document.getElementById('approvalCommentsDisplay').style.display = 'block';
                    document.getElementById('commentsText').textContent = timesheet.approverComments;
                } else {
                    document.getElementById('approvalCommentsDisplay').style.display = 'none';
                }
            } else {
                approvalInfo.style.display = 'none';
            }
            
            // Make month/year field readonly for viewing
            document.getElementById('monthYear').setAttribute('readonly', true);
            
            // Populate entries table - readonly if not own draft timesheet
            const isReadOnly = !(isOwnTimesheet && timesheet.status === 'draft');
            populateTimesheetEntries(timesheet.entries, isReadOnly);
            updateTimesheetSummary(timesheet);
            
            // Handle action visibility based on status and user role - ENHANCED LOGIC
            const formActions = document.querySelector('.form-actions');
            const approvalActions = document.getElementById('approvalActions');
            const saveButton = document.querySelector('.btn[onclick="saveTimesheet()"]');
            const submitButton = document.querySelector('.btn[onclick="submitTimesheet()"]');
            
            console.log('📝 Form actions element found:', !!formActions);
            console.log('📝 Approval actions element found:', !!approvalActions);
            console.log('📝 Save/Submit buttons found:', !!saveButton, !!submitButton);
            
            // Check if user can approve timesheets
            const canApprove = checkUserCanApprove();
            console.log('📝 User can approve:', canApprove);
            
            if (timesheet.status === 'draft' && isOwnTimesheet) {
                // Show save and submit buttons for own draft timesheets
                console.log('📝 Showing draft mode actions for own timesheet');
                formActions.style.display = 'flex';
                if (saveButton) saveButton.style.display = 'inline-flex';
                if (submitButton) submitButton.style.display = 'inline-flex';
                if (approvalActions) approvalActions.style.display = 'none';
                // Hide approval flow for drafts
                const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                if (approvalFlowSection) approvalFlowSection.style.display = 'none';
            } else if (timesheet.status === 'submitted') {
                console.log('📝 Timesheet is submitted, checking approval permissions');
                // Hide save and submit buttons for submitted timesheets
                if (saveButton) saveButton.style.display = 'none';
                if (submitButton) submitButton.style.display = 'none';
                
                if (canApprove && !isOwnTimesheet) {
                    // Show approval actions for submitted timesheets if user can approve and it's not their own
                    console.log('📝 User can approve others timesheet - showing approval actions');
                    formActions.style.display = 'none';
                    if (approvalActions) {
                        approvalActions.style.display = 'block';
                        console.log('📝 Approval actions made visible');
                        // Clear previous comments
                        const commentsField = document.getElementById('approvalComments');
                        if (commentsField) commentsField.value = '';
                    }
                } else {
                    // User cannot approve or it's their own timesheet - show view only mode
                    console.log('📝 Showing view only mode (own timesheet or no approval permission)');
                    formActions.style.display = 'flex'; // Keep close button visible
                    if (approvalActions) approvalActions.style.display = 'none';
                }
                
                // Show approval flow for submitted timesheets
                const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                if (approvalFlowSection) {
                    approvalFlowSection.style.display = 'block';
                    // Load and display approval flow
                    loadTimesheetApprovalFlow();
                }
            } else if (timesheet.status === 'approved' || timesheet.status === 'rejected') {
                // View only mode for approved/rejected timesheets
                console.log('📝 Showing view only mode for final states');
                if (saveButton) saveButton.style.display = 'none';
                if (submitButton) submitButton.style.display = 'none';
                formActions.style.display = 'flex'; // Keep close button visible
                if (approvalActions) approvalActions.style.display = 'none';
                // Show approval flow for final states
                const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                if (approvalFlowSection) {
                    approvalFlowSection.style.display = 'block';
                    loadTimesheetApprovalFlow();
                }
            }
            
            // Show modal
            document.getElementById('timesheetModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function populateTimesheetEntries(entries, readOnly = false) {
            const tableBody = document.getElementById('timesheetEntryTableBody');
            tableBody.innerHTML = '';
            
            entries.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDateWithDay(entry.date)}</td>
                    <td><input type="time" value="${entry.startTime || ''}" ${readOnly ? 'readonly' : ''} onchange="updateEntry('${entry.id}', 'startTime', this.value)"></td>
                    <td><input type="time" value="${entry.endTime || ''}" ${readOnly ? 'readonly' : ''} onchange="updateEntry('${entry.id}', 'endTime', this.value)"></td>
                    <td><input type="number" step="0.5" min="0" value="${entry.breakHours || 0}" ${readOnly ? 'readonly' : ''} onchange="updateEntry('${entry.id}', 'breakHours', this.value)"></td>
                    <td><input type="number" step="0.5" min="0" value="${entry.regularHours || 0}" ${readOnly ? 'readonly' : ''} onchange="updateEntry('${entry.id}', 'regularHours', this.value)"></td>
                    <td><input type="number" step="0.5" min="0" value="${entry.overtimeHours || 0}" ${readOnly ? 'readonly' : ''} onchange="updateEntry('${entry.id}', 'overtimeHours', this.value)"></td>
                    <td><input type="text" value="${entry.comments || ''}" ${readOnly ? 'readonly' : ''} onchange="updateEntry('${entry.id}', 'comments', this.value)" placeholder="Comments"></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateEntry(entryId, field, value) {
            const timesheet = timesheets.find(t => t.id === currentTimesheetId);
            const entry = timesheet.entries.find(e => e.id === entryId);
            
            if (entry) {
                entry[field] = value;
                
                // Auto-calculate hours if start/end times or break are changed
                if (field === 'startTime' || field === 'endTime' || field === 'breakHours') {
                    calculateHours(entry);
                }
                
                updateTimesheetSummary(timesheet);
                saveTimesheetsToStorage();
            }
        }

        function calculateHours(entry) {
            if (entry.startTime && entry.endTime) {
                const start = new Date(`2000-01-01T${entry.startTime}`);
                const end = new Date(`2000-01-01T${entry.endTime}`);
                
                if (end > start) {
                    const totalMinutes = (end - start) / (1000 * 60);
                    const totalHours = totalMinutes / 60;
                    const breakHours = parseFloat(entry.breakHours) || 0;
                    const netHours = Math.max(0, totalHours - breakHours);
                    
                    // Standard work day is 8 hours
                    entry.regularHours = Math.min(netHours, 8);
                    entry.overtimeHours = Math.max(0, netHours - 8);
                }
            }
        }

        function updateTimesheetSummary(timesheet) {
            const totalRegular = timesheet.entries.reduce((sum, entry) => sum + (parseFloat(entry.regularHours) || 0), 0);
            const totalOvertime = timesheet.entries.reduce((sum, entry) => sum + (parseFloat(entry.overtimeHours) || 0), 0);
            const total = totalRegular + totalOvertime;
            
            timesheet.totalRegularHours = totalRegular;
            timesheet.totalOvertimeHours = totalOvertime;
            timesheet.totalHours = total;
            
            document.getElementById('totalRegularHours').textContent = totalRegular.toFixed(1);
            document.getElementById('totalOvertimeHours').textContent = totalOvertime.toFixed(1);
            document.getElementById('totalHours').textContent = total.toFixed(1);
        }        async function saveTimesheet() {
            const timesheet = timesheets.find(t => t.id === currentTimesheetId);
            if (timesheet) {
                timesheet.monthYear = document.getElementById('monthYear').value;
                const date = new Date(timesheet.monthYear + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                timesheet.period = `${monthName} Timesheet`;
                
                console.log('💾 Saving timesheet:', timesheet.id, 'to company-scoped Firebase');
                
                // Save to Firebase first (company-scoped)
                const saved = await saveTimesheetToFirebase(timesheet);
                if (saved) {
                    saveTimesheetsToStorage();
                    console.log('✅ Timesheet saved - real-time listener will update display');
                    alert('Timesheet saved successfully!');
                } else {
                    alert('Failed to save timesheet. Please try again.');
                }
            }
        }        async function submitTimesheet() {
            const timesheet = timesheets.find(t => t.id === currentTimesheetId);
            if (timesheet) {
                timesheet.status = 'submitted';
                timesheet.submittedDate = new Date().toISOString();
                timesheet.submittedBy = getCurrentUserName();
                
                console.log('📤 Submitting timesheet:', timesheet.id, 'to company-scoped Firebase');
                
                // Hide save and submit buttons immediately
                const saveButton = document.querySelector('.btn[onclick="saveTimesheet()"]');
                const submitButton = document.querySelector('.btn[onclick="submitTimesheet()"]');
                const formActions = document.querySelector('.form-actions');
                const approvalActions = document.getElementById('approvalActions');
                
                if (saveButton) saveButton.style.display = 'none';
                if (submitButton) submitButton.style.display = 'none';
                
                // Update status display in modal
                const statusInput = document.getElementById('modalTimesheetStatusInput');
                if (statusInput) {
                    statusInput.value = 'Submitted';
                    statusInput.className = 'status-input-submitted';
                }
                
                // Show approval flow section for submitted timesheets
                const approvalFlowSection = document.getElementById('timesheetApprovalFlowSection');
                if (approvalFlowSection) {
                    approvalFlowSection.style.display = 'block';
                    // Load and display approval flow
                    await loadTimesheetApprovalFlow();
                }
                
                // Check if user can approve and show appropriate actions
                const canApprove = checkUserCanApprove();
                if (canApprove && approvalActions) {
                    formActions.style.display = 'none';
                    approvalActions.style.display = 'block';
                    // Clear previous comments
                    const commentsField = document.getElementById('approvalComments');
                    if (commentsField) commentsField.value = '';
                } else {
                    // Keep only close button visible
                    formActions.style.display = 'flex';
                    if (approvalActions) approvalActions.style.display = 'none';
                }
                
                // Save to Firebase first (company-scoped)
                const saved = await saveTimesheetToFirebase(timesheet);
                if (saved) {
                    saveTimesheetsToStorage();
                    
                    console.log('✅ Timesheet submitted - display updated with new status');
                    alert('Timesheet submitted to supervisor successfully!');
                    
                    // Close modal after user sees the success message
                    setTimeout(() => {
                        closeTimesheetModal();
                        // Update timesheet display to show new status
                        displayTimesheets();
                    }, 1000);
                } else {
                    // If save failed, restore the buttons and status
                    if (saveButton) saveButton.style.display = 'inline-flex';
                    if (submitButton) submitButton.style.display = 'inline-flex';
                    if (statusInput) {
                        statusInput.value = 'Draft';
                        statusInput.className = 'status-input-draft';
                    }
                    if (approvalActions) approvalActions.style.display = 'none';
                    formActions.style.display = 'flex';
                    timesheet.status = 'draft'; // Revert status
                    alert('Failed to submit timesheet. Please try again.');
                }
            }
        }
        
        async function loadTimesheetApprovalFlow() {
            try {
                console.log('Loading timesheet approval flow...');
                
                const user = getCurrentUser();
                if (!user || !user.uid) {
                    console.warn('No user found for approval flow loading');
                    return;
                }
                
                const companyId = getCompanyId();
                if (!companyId) {
                    console.warn('No company ID found for approval flow loading');
                    return;
                }
                
                // Get the display element
                const approvalFlowDisplay = document.getElementById('timesheetApprovalFlowDisplay');
                if (!approvalFlowDisplay) {
                    console.warn('timesheetApprovalFlowDisplay element not found');
                    return;
                }
                
                // Loading state
                approvalFlowDisplay.innerHTML = `
                    <div class="approval-flow-header">
                        <h4>Approval Workflow</h4>
                    </div>
                    <div style="padding: 1rem; text-align: center; color: #666;">
                        <i class="fas fa-spinner fa-spin"></i> Loading approval workflow...
                    </div>
                `;
                
                console.log(`📡 Fetching timesheet approval flow from: companies/${companyId}/approvalFlows/timesheet`);
                
                // Fetch approval flow from company-scoped path using Firebase v8 (REST API as fallback)
                try {
                    // Try Firebase v8 database first
                    if (typeof firebase !== 'undefined' && firebase.database) {
                        const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/timesheet`);
                        const snapshot = await approvalFlowRef.once('value');
                        
                        if (snapshot.exists()) {
                            const config = snapshot.val();
                            console.log('✅ Timesheet approval flow config loaded via Firebase v8:', config);
                            
                            if (config.enabled && config.selectedRoles) {
                                // Generate and display approval flow HTML
                                const approvalHTML = await generateTimesheetApprovalFlowHTML(config);
                                approvalFlowDisplay.innerHTML = approvalHTML;
                                console.log('✅ Timesheet approval flow displayed successfully');
                            } else {
                                displayNoApprovalFlow('Timesheet approval workflow is disabled or not configured.');
                            }
                        } else {
                            console.warn('⚠️ No timesheet approval flow found in Firebase');
                            displayNoApprovalFlow('No timesheet approval workflow configured for this company.');
                        }
                    } else {
                        // Fallback to REST API if Firebase v8 is not available
                        console.log('🔄 Firebase v8 not available, using REST API fallback');
                        const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/approvalFlows/timesheet.json`);
                        
                        if (response.ok) {
                            const config = await response.json();
                            console.log('✅ Timesheet approval flow config loaded via REST API:', config);
                            
                            if (config && config.enabled && config.selectedRoles) {
                                // Generate and display approval flow HTML
                                const approvalHTML = await generateTimesheetApprovalFlowHTML(config);
                                approvalFlowDisplay.innerHTML = approvalHTML;
                                console.log('✅ Timesheet approval flow displayed successfully');
                            } else {
                                displayNoApprovalFlow('Timesheet approval workflow is disabled or not configured.');
                            }
                        } else {
                            console.error('❌ Failed to fetch approval flow via REST API, status:', response.status);
                            displayNoApprovalFlow('Unable to load approval workflow configuration.');
                        }
                    }
                } catch (fetchError) {
                    console.error('❌ Error fetching timesheet approval flow:', fetchError);
                    displayNoApprovalFlow('Error loading approval workflow configuration.');
                }
                
            } catch (error) {
                console.error('Error loading timesheet approval flow:', error);
                displayNoApprovalFlow('Error loading approval workflow configuration.');
            }
        }
        
        // Generate approval flow HTML similar to staff.html
        async function generateTimesheetApprovalFlowHTML(config) {
            try {
                if (!config) {
                    return `
                        <div class="no-approval-flow">
                            <i class="fas fa-info-circle"></i>
                            <h4>No Approval Flow Configured</h4>
                            <p>Timesheet approval flow is not configured. Please set it up in the Approval Flow Settings.</p>
                        </div>
                    `;
                }
                
                console.log('Generating timesheet approval flow HTML with config:', config);
                
                let approvalHTML = `
                    <div class="approval-flow-section">
                        <div class="approval-flow-header">
                            <h4 class="approval-flow-title">
                                <i class="fas fa-route"></i>
                                Timesheet Approval Flow
                            </h4>
                            <span class="approval-flow-status ${config.enabled ? 'enabled' : 'disabled'}">
                                ${config.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </div>
                `;
                
                approvalHTML += `<div class="approval-stages">`;
                
                // Check if we have selectedRoles and it's an object
                if (config.selectedRoles && typeof config.selectedRoles === 'object') {
                    const levelKeys = Object.keys(config.selectedRoles);
                    console.log('Found approval levels:', levelKeys);
                    
                    if (levelKeys.length > 0) {
                        for (let i = 0; i < levelKeys.length; i++) {
                            const levelKey = levelKeys[i];
                            const levelNumber = i + 1;
                            
                            console.log(`Processing level ${levelNumber} (${levelKey})`);
                            
                            // Fetch approver details for this level
                            const approver = await fetchTimesheetApproverDetails(levelKey, config);
                            
                            // For timesheet approval flow display, all stages are pending
                            const stageStatus = 'pending';
                            const stageClass = 'current';
                            const stageStatusText = 'Awaiting Approval';
                            
                            // Get role configuration for stage title
                            const levelData = config.selectedRoles[levelKey];
                            let stageTitle = `Level ${levelNumber}`;
                            
                            approvalHTML += `
                                <div class="approval-stage ${stageClass}">
                                    <div class="stage-number ${stageStatus}">
                                        ${stageStatus === 'completed' ? '<i class="fas fa-check"></i>' : 
                                          stageStatus === 'rejected' ? '<i class="fas fa-times"></i>' : 
                                          stageStatus === 'current' ? '<i class="fas fa-clock"></i>' : levelNumber}
                                    </div>
                                    <div class="stage-info">
                                        <div class="stage-title">
                                            ${stageTitle}
                                        </div>
                                        <div class="approver-info">
                                            ${await generateTimesheetApproverDisplayHTML(approver)}
                                        </div>
                                        <div class="stage-status-text ${stageStatus}">
                                            ${stageStatusText}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        approvalHTML += `
                            <div class="no-approval-flow">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>No approval levels configured for timesheet management.</p>
                            </div>
                        `;
                    }
                } else {
                    approvalHTML += `
                        <div class="no-approval-flow">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Invalid approval flow configuration. Please check the settings.</p>
                        </div>
                    `;
                }
                
                approvalHTML += `
                        </div>
                    </div>
                `;
                
                console.log('Generated timesheet approval flow HTML successfully');
                return approvalHTML;
                
            } catch (error) {
                console.error('Error generating timesheet approval flow HTML:', error);
                return `
                    <div class="approval-flow-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading approval flow: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Fetch approver details for timesheet approval flow
        async function fetchTimesheetApproverDetails(levelKey, approvalConfig) {
            console.log(`🔍 Starting fetchTimesheetApproverDetails for ${levelKey}`);
            
            try {
                if (!levelKey || !approvalConfig || !approvalConfig.selectedRoles) {
                    console.warn(`⚠️ Missing required parameters for ${levelKey}`);
                    return {
                        name: 'Configuration Error',
                        role: 'Invalid Setup',
                        email: '',
                        type: 'error',
                        error: 'Missing configuration parameters'
                    };
                }
                
                const levelData = approvalConfig.selectedRoles[levelKey];
                console.log(`📊 Level data for ${levelKey}:`, levelData);
                
                // Handle both array and object structures
                let roleData;
                if (Array.isArray(levelData)) {
                    roleData = levelData[0];
                } else if (levelData && typeof levelData === 'object') {
                    roleData = levelData;
                } else {
                    console.warn(`⚠️ No valid role data found for ${levelKey}`);
                    return {
                        name: `No Role Data for ${levelKey}`,
                        role: 'Configuration Error',
                        email: '',
                        type: 'error',
                        error: `No role configuration found for level ${levelKey}`
                    };
                }
                
                if (!roleData || !roleData.value) {
                    console.warn(`⚠️ roleData.value is missing for ${levelKey}`);
                    return {
                        name: `Missing Value for ${levelKey}`,
                        role: 'Configuration Error',
                        email: '',
                        type: 'error',
                        error: `Role value is missing for level ${levelKey}`
                    };
                }
                
                const value = roleData.value;
                const text = roleData.text;
                
                // Handle function-based approvers (function_<jobTitle>)
                if (value.startsWith('function_')) {
                    console.log(`🔧 Processing function-based approver: ${value}`);
                    const jobTitleId = value.replace('function_', '');
                    
                    try {
                        console.log(`📊 Looking for users with job title: "${text}"`);
                        
                        // Get users with matching job title
                        const matchingUsers = await getUsersWithJobTitle(text);
                        console.log(`🔍 Found ${matchingUsers.length} matching users:`, matchingUsers);
                        
                        if (matchingUsers.length > 0) {
                            const userNames = matchingUsers.map(user => {
                                let fullName = '';
                                
                                if (user.firstName || user.lastName) {
                                    fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                                }
                                
                                if (!fullName && user.displayName) {
                                    fullName = user.displayName.trim();
                                }
                                
                                if (!fullName && user.name) {
                                    fullName = user.name.trim();
                                }
                                
                                if (!fullName && user.email) {
                                    const emailParts = user.email.split('@');
                                    if (emailParts.length > 0 && emailParts[0].trim() !== '') {
                                        fullName = emailParts[0].replace(/[._-]/g, ' ').split(' ')
                                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                            .join(' ');
                                    } else {
                                        fullName = user.email;
                                    }
                                }
                                
                                if (!fullName) {
                                    fullName = 'Unknown User';
                                }
                                
                                return fullName;
                            }).join(', ');
                            
                            const userEmails = matchingUsers.map(user => user.email).filter(email => email).join(', ');
                            
                            return {
                                name: matchingUsers.length === 1 ? userNames : `${text} (${matchingUsers.length} users)`,
                                role: formatRoleTitle(text),
                                email: userEmails || '',
                                type: 'function',
                                value: value,
                                jobTitle: text,
                                matchingUsers: matchingUsers,
                                userCount: matchingUsers.length,
                                allUserNames: userNames,
                                allUserIds: matchingUsers.map(user => user.id || user.uid || user.email),
                                isResolved: !!userEmails
                            };
                        } else {
                            console.warn(`⚠️ No user found with job title: "${text}"`);
                            return {
                                name: `${text} (Not Assigned)`,
                                role: formatRoleTitle(text),
                                email: '',
                                type: 'function',
                                value: value,
                                jobTitle: text,
                                userCount: 0,
                                allUserNames: '',
                                matchingUsers: [],
                                isResolved: false,
                                error: `No users found with job title "${text}"`
                            };
                        }
                    } catch (functionError) {
                        console.error(`❌ Error in function-based approver lookup for "${text}":`, functionError);
                        return {
                            name: `${text} (Lookup Error)`,
                            role: formatRoleTitle(text),
                            email: '',
                            type: 'function',
                            value: value,
                            jobTitle: text,
                            userCount: 0,
                            isResolved: false,
                            error: `Function approver lookup failed: ${functionError.message}`
                        };
                    }
                }
                
                // Handle user-based approvers (user_<userId>)
                if (value.startsWith('user_')) {
                    console.log(`User-based approver: ${value}`);
                    const userId = value.replace('user_', '');
                    
                    try {
                        let userSnapshot, user;
                        
                        if (typeof window.db !== 'undefined' && typeof window.get !== 'undefined' && typeof window.ref !== 'undefined') {
                            const userRef = window.ref(window.db, `users/${userId}`);
                            userSnapshot = await window.get(userRef);
                            user = userSnapshot.exists() ? userSnapshot.val() : null;
                        } else {
                            const userRef = firebase.database().ref(`users/${userId}`);
                            userSnapshot = await userRef.once('value');
                            user = userSnapshot.val();
                        }
                        
                        if (user) {
                            let fullName = '';
                            
                            if (user.firstName || user.lastName) {
                                fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                            }
                            
                            if (!fullName && user.displayName) {
                                fullName = user.displayName.trim();
                            }
                            
                            if (!fullName && user.name) {
                                fullName = user.name.trim();
                            }
                            
                            if (!fullName && user.email) {
                                const emailParts = user.email.split('@');
                                if (emailParts.length > 0 && emailParts[0].trim() !== '') {
                                    fullName = emailParts[0].replace(/[._-]/g, ' ').split(' ')
                                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                        .join(' ');
                                } else {
                                    fullName = user.email;
                                }
                            }
                            
                            if (!fullName) {
                                fullName = 'Name not available';
                            }
                            
                            const userEmail = user.email || '';
                            const userRole = user.jobTitle || user.role || user.position || 'User';
                            
                            return {
                                name: fullName,
                                role: formatRoleTitle(userRole),
                                email: userEmail,
                                type: 'user',
                                value: value,
                                userId: userId,
                                isResolved: true
                            };
                        } else {
                            console.warn(`⚠️ User not found with ID: ${userId}`);
                            
                            if (text && text.trim() !== '') {
                                return {
                                    name: text,
                                    role: formatRoleTitle('User'),
                                    email: '',
                                    type: 'user',
                                    value: value,
                                    userId: userId,
                                    isResolved: false,
                                    error: 'User data not found in database'
                                };
                            }
                            
                            return {
                                name: `User (ID: ${userId}) - Not Found`,
                                role: formatRoleTitle('Unknown'),
                                email: '',
                                type: 'user',
                                value: value,
                                userId: userId,
                                isResolved: false,
                                error: 'User not found in database'
                            };
                        }
                        
                    } catch (userError) {
                        console.error(`❌ Error fetching user ${userId}:`, userError);
                        
                        if (text && text.trim() !== '') {
                            return {
                                name: text,
                                role: formatRoleTitle('User'),
                                email: '',
                                type: 'user',
                                value: value,
                                userId: userId,
                                isResolved: false,
                                error: `User lookup failed: ${userError.message}`
                            };
                        }
                        
                        return {
                            name: `User (ID: ${userId}) - Error`,
                            role: formatRoleTitle('Unknown'),
                            email: '',
                            type: 'user',
                            value: value,
                            userId: userId,
                            isResolved: false,
                            error: `User lookup failed: ${userError.message}`
                        };
                    }
                }
                
                // Handle level-based approvers (L+1, L+2, etc.)
                if (value.startsWith('L+')) {
                    console.log(`Level-based approver: ${value}`);
                    return {
                        name: `Line Manager (${value})`,
                        role: formatRoleTitle(text || value),
                        email: '',
                        type: 'level',
                        value: value,
                        lineManagerLevel: value,
                        isResolved: false,
                        error: 'Level-based approver not configured for timesheet approval'
                    };
                }
                
                // Fallback for unknown format
                console.warn(`Unknown approver value format: ${value}`);
                return {
                    name: formatRoleTitle(text) || 'Unknown Approver',
                    role: formatRoleTitle('Unknown'),
                    email: '',
                    type: 'unknown',
                    value: value,
                    error: 'Unknown approver format'
                };
                
            } catch (error) {
                console.error('❌ Error fetching timesheet approver details for levelKey:', levelKey);
                console.error('❌ Error details:', error);
                
                return {
                    name: `Error: ${error.message || 'Unknown error'}`,
                    role: formatRoleTitle(`Error for ${levelKey}`),
                    email: '',
                    type: 'error',
                    error: error.message
                };
            }
        }
        
        // Generate approver display HTML for timesheet approval
        async function generateTimesheetApproverDisplayHTML(approver) {
            if (!approver) {
                return `<div class="approver-name" style="color: #dc3545; font-weight: 600;"><i class="fas fa-user-slash"></i> Not assigned</div>`;
            }

            if (approver.type === 'function' && approver.userCount > 0) {
                // Function-based approver with users
                const userCountText = approver.userCount === 1 ? '1 user' : `${approver.userCount} users`;
                const usersInfo = `
                    <div class="function-users-list" style="font-size: 11px; color: #666; margin-top: 4px;">
                        <i class="fas fa-users"></i> ${approver.allUserNames}
                    </div>`;
                
                return `
                    <div class="approver-name" style="font-weight: 600; color: #007bff; font-size: 0.9rem;">
                        <i class="fas fa-user-tie"></i> ${approver.role}
                    </div>
                    <div class="function-approver-info" style="margin-top: 4px;">
                        <span class="function-user-count" style="background: #e7f3ff; color: #0066cc; padding: 2px 6px; border-radius: 12px; font-size: 10px; font-weight: 500;">
                            ${userCountText} can approve
                        </span>
                    </div>
                    ${usersInfo}
                `;
            } else if (approver.type === 'function' && approver.userCount === 0) {
                // Function-based approver with no users
                return `
                    <div class="approver-name" style="font-weight: 600; color: #f59e0b; font-size: 0.9rem;">
                        <i class="fas fa-user-tie"></i> ${approver.role}
                    </div>
                    <div class="function-approver-warning" style="margin-top: 4px;">
                        <span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> No users assigned
                        </span>
                    </div>
                `;
            } else {
                // Regular user or level-based approver
                let displayName = approver.name;
                
                if (!displayName || displayName.trim() === '') {
                    if (approver.email && approver.email.trim() !== '') {
                        const emailParts = approver.email.split('@');
                        if (emailParts.length > 0 && emailParts[0].trim() !== '') {
                            displayName = emailParts[0].replace(/[._-]/g, ' ').split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                .join(' ');
                        } else {
                            displayName = approver.email;
                        }
                    } else if (approver.role && approver.role.trim() !== '') {
                        displayName = approver.role;
                    } else {
                        displayName = 'Name not available';
                    }
                }
                
                return `
                    <div class="approver-name" style="font-weight: 600; color: #495057; font-size: 0.9rem;">
                        <i class="fas fa-user"></i> ${displayName}${approver.role && displayName !== approver.role ? ` - ${approver.role}` : ''}
                    </div>
                `;
            }
        }
        
        // Helper function to format role titles
        function formatRoleTitle(title) {
            if (!title) return '';
            return title.charAt(0).toUpperCase() + title.slice(1).toLowerCase();
        }
        
        // Helper function to get users with specific job title (simplified version)
        async function getUsersWithJobTitle(jobTitle) {
            try {
                if (typeof firebase === 'undefined' || !firebase.database) {
                    console.error('Firebase is not available');
                    return [];
                }
                
                const usersRef = firebase.database().ref('users');
                const snapshot = await usersRef.once('value');
                const users = snapshot.val();
                
                if (!users) {
                    console.log('No users found in database');
                    return [];
                }
                
                const matchingUsers = [];
                const searchTitle = jobTitle.toLowerCase().trim();
                
                Object.keys(users).forEach(userId => {
                    const user = users[userId];
                    if (user && user.jobTitle) {
                        const userJobTitle = user.jobTitle.toLowerCase().trim();
                        if (userJobTitle === searchTitle) {
                            matchingUsers.push({
                                id: userId,
                                uid: userId,
                                ...user
                            });
                        }
                    }
                });
                
                console.log(`Found ${matchingUsers.length} users with job title "${jobTitle}"`);
                return matchingUsers;
                
            } catch (error) {
                console.error('Error getting users with job title:', error);
                return [];
            }
        }
        
        function displayNoApprovalFlow(message) {
            const approvalFlowDisplay = document.getElementById('timesheetApprovalFlowDisplay');
            if (approvalFlowDisplay) {
                approvalFlowDisplay.innerHTML = `
                    <div class="approval-flow-header">
                        <h4>Approval Workflow</h4>
                    </div>
                    <div style="padding: 1rem; text-align: center; color: #666;">
                        <i class="fas fa-info-circle"></i> ${message}
                    </div>
                `;
            }
        }
        
        async function deleteTimesheet(timesheetId) {
            if (confirm('Are you sure you want to delete this timesheet?')) {
                try {
                    // Get company ID for proper scoping
                    const companyId = getCompanyId();
                    const currentUserId = getCurrentUserName() || 'unknown';
                    
                    console.log('🗑️ Deleting timesheet:', timesheetId, 'from company-scoped Firebase');
                    
                    // Delete from Firebase using company-scoped path
                    const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/timesheets/${currentUserId}/${timesheetId}.json`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Remove from local array
                        timesheets = timesheets.filter(t => t.id !== timesheetId);
                        saveTimesheetsToStorage();
                        console.log('✅ Timesheet deleted - real-time listener will update display');
                        alert('Timesheet deleted successfully!');
                    } else {
                        alert('Failed to delete timesheet. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting timesheet:', error);
                    alert('Failed to delete timesheet. Please try again.');
                }
            }
        }

        async function saveTimesheetToFirebase(timesheet) {
            try {
                // Get company ID for proper scoping
                const companyId = getCompanyId();
                const currentUserId = getCurrentUserName() || 'unknown';
                
                console.log('💾 Saving timesheet to Firebase:');
                console.log('  - Company ID:', companyId);
                console.log('  - User ID:', currentUserId);
                console.log('  - Timesheet ID:', timesheet.id);
                
                // Save or update timesheet in Firebase under company scope
                const url = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/timesheets/${currentUserId}/${timesheet.id}.json`;
                console.log('  - URL:', url);
                
                const payload = {
                    id: timesheet.id,
                    userId: currentUserId,
                    companyId: companyId,
                    monthYear: timesheet.monthYear,
                    period: timesheet.period,
                    status: timesheet.status,
                    createdDate: timesheet.createdDate,
                    submittedDate: timesheet.submittedDate,
                    submittedBy: timesheet.submittedBy,
                    approvedDate: timesheet.approvedDate,
                    approvedBy: timesheet.approvedBy,
                    approverComments: timesheet.approverComments,
                    rejectedDate: timesheet.rejectedDate,
                    rejectedBy: timesheet.rejectedBy,
                    rejectionReason: timesheet.rejectionReason,
                    totalHours: timesheet.totalHours,
                    entries: timesheet.entries || []
                };
                
                console.log('  - Payload:', payload);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('  - Response status:', response.status);
                console.log('  - Response ok:', response.ok);
                
                if (response.ok) {
                    const responseData = await response.text();
                    console.log('  - Response data:', responseData);
                    console.log('✅ Timesheet saved to Firebase successfully under company scope');
                    return true;
                } else {
                    const errorData = await response.text();
                    console.error('❌ Failed to save timesheet to Firebase:', response.status, errorData);
                    return false;
                }
            } catch (error) {
                console.error('💥 Error saving timesheet to Firebase:', error);
                return false;
            }
        }        async function approveTimesheet() {
            const timesheet = timesheets.find(t => t.id === currentTimesheetId);
            if (timesheet) {
                const comments = document.getElementById('approvalComments').value;
                
                if (confirm('Are you sure you want to approve this timesheet?')) {
                    timesheet.status = 'approved';
                    timesheet.approvedDate = new Date().toISOString();
                    timesheet.approverComments = comments;
                    timesheet.approvedBy = getCurrentUserInfo(); // You can implement this to get current user info
                    
                    // Save to Firebase first
                    const saved = await saveTimesheetToFirebase(timesheet);
                    if (saved) {
                        saveTimesheetsToStorage();
                        await displayTimesheets();
                        closeTimesheetModal();
                        alert('Timesheet approved successfully!');
                    } else {
                        alert('Failed to approve timesheet. Please try again.');
                    }
                }
            }
        }        async function declineTimesheet() {
            const timesheet = timesheets.find(t => t.id === currentTimesheetId);
            if (timesheet) {
                const comments = document.getElementById('approvalComments').value;
                
                if (!comments.trim()) {
                    alert('Please provide comments when declining a timesheet.');
                    return;
                }
                
                if (confirm('Are you sure you want to decline this timesheet?')) {
                    timesheet.status = 'rejected';
                    timesheet.rejectedDate = new Date().toISOString();
                    timesheet.approverComments = comments;
                    timesheet.rejectedBy = getCurrentUserInfo(); // You can implement this to get current user info
                    
                    // Save to Firebase first
                    const saved = await saveTimesheetToFirebase(timesheet);
                    if (saved) {
                        saveTimesheetsToStorage();
                        await displayTimesheets();
                        closeTimesheetModal();
                        alert('Timesheet declined. Employee will be notified.');
                    } else {
                        alert('Failed to decline timesheet. Please try again.');
                    }
                }
            }
        }
        
        function checkUserCanApprove() {
            console.log('🔍 Checking if user can approve timesheets...');
            
            // Method 1: Check localStorage for user role
            try {
                const userRole = localStorage.getItem('userRole');
                console.log('🔍 User role from localStorage:', userRole);
                if (userRole === 'supervisor' || userRole === 'manager' || userRole === 'admin' || userRole === 'line_manager') {
                    console.log('✅ User can approve based on role:', userRole);
                    return true;
                }
            } catch (error) {
                console.warn('⚠️ Error checking user role from localStorage:', error);
            }
            
            // Method 2: Check if user has approval permissions in user data
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('🔍 User data from localStorage:', userData);
                if (userData.canApproveTimesheets === true || userData.isLineManager === true || userData.role === 'supervisor') {
                    console.log('✅ User can approve based on user data permissions');
                    return true;
                }
            } catch (error) {
                console.warn('⚠️ Error checking user data from localStorage:', error);
            }
            
            // Method 3: Check if current user is someone's line manager (simple check)
            try {
                // If this user appears as a line manager in the dropdown, they can approve
                const lineManagerSelect = document.getElementById('lineManager');
                const currentUserName = getCurrentUserName();
                console.log('🔍 Current user name:', currentUserName);
                
                if (lineManagerSelect && currentUserName) {
                    // Check if current user is listed as a line manager option
                    const options = Array.from(lineManagerSelect.options);
                    const isLineManager = options.some(option => 
                        option.text.includes(currentUserName) && option.value !== ''
                    );
                    if (isLineManager) {
                        console.log('✅ User can approve based on line manager status');
                        return true;
                    }
                }
            } catch (error) {
                console.warn('⚠️ Error checking line manager status:', error);
            }
            
            // Method 4: Temporary override for testing - Allow any admin/manager
            try {
                const testMode = localStorage.getItem('enableApprovalTesting');
                if (testMode === 'true') {
                    console.log('🧪 Approval testing mode enabled - allowing approval');
                    return true;
                }
            } catch (error) {
                // Silent fail for test mode
            }
            
            // Default: Regular users cannot approve
            console.log('❌ User cannot approve timesheets based on current permissions');
            return false;
        }
        
        // Helper function to enable approval testing mode (for development/testing)
        window.enableApprovalTesting = function() {
            localStorage.setItem('enableApprovalTesting', 'true');
            console.log('🧪 Approval testing mode enabled - all users can now approve timesheets');
        };
        
        window.disableApprovalTesting = function() {
            localStorage.removeItem('enableApprovalTesting');
            console.log('🧪 Approval testing mode disabled - normal permissions apply');
        };
        
        // Helper function to test approval permissions
        window.testApprovalPermissions = function() {
            const canApprove = checkUserCanApprove();
            console.log('📝 Current user approval permissions:', canApprove);
            return canApprove;
        };
        
        // Helper function to create a sample submitted timesheet for testing approval
        window.createTestSubmittedTimesheet = function() {
            const testTimesheet = {
                id: 'test_' + generateId(),
                period: 'Weekly',
                monthYear: '2025-08',
                totalHours: 40.0,
                status: 'submitted',
                submittedBy: 'Test User', // Different from current user
                submittedDate: new Date().toISOString(),
                createdDate: new Date().toISOString(),
                entries: generateWeekEntries(getNextFriday(new Date()))
            };
            
            // Add to timesheets array
            timesheets.push(testTimesheet);
            saveTimesheetsToStorage();
            displayTimesheets();
            
            console.log('🧪 Created test submitted timesheet:', testTimesheet.id);
            console.log('🧪 Click on the timesheet row to test approval functionality');
            
            return testTimesheet.id;
        };
        
        // Comprehensive debugging function to identify timesheet visibility issues
        window.debugTimesheetVisibility = async function() {
            console.log('🔧 === TIMESHEET VISIBILITY DEBUG ===');
            
            // Check basic user info
            const currentUserName = getCurrentUserName();
            const companyId = getCompanyId();
            const canApprove = checkUserCanApprove();
            
            console.log('👤 Current User Name:', currentUserName);
            console.log('🏢 Company ID:', companyId);
            console.log('✅ Can Approve:', canApprove);
            
            // Check localStorage data
            console.log('💾 localStorage userRole:', localStorage.getItem('userRole'));
            console.log('💾 localStorage currentUser:', localStorage.getItem('currentUser'));
            console.log('💾 localStorage enableApprovalTesting:', localStorage.getItem('enableApprovalTesting'));
            
            // Check all timesheets
            console.log('📊 Total Timesheets:', timesheets.length);
            timesheets.forEach((timesheet, index) => {
                console.log(`📄 Timesheet ${index + 1}:`, {
                    id: timesheet.id,
                    period: timesheet.period,
                    status: timesheet.status,
                    submittedBy: timesheet.submittedBy,
                    isOwnTimesheet: timesheet.submittedBy === currentUserName
                });
            });
            
            // Test visibility for each timesheet
            console.log('🔍 Testing visibility for each timesheet...');
            for (let i = 0; i < timesheets.length; i++) {
                const timesheet = timesheets[i];
                const canView = await canUserViewTimesheet(timesheet);
                console.log(`🔍 Timesheet ${i + 1} (${timesheet.status} by ${timesheet.submittedBy}): Can View = ${canView}`);
            }
            
            // Check approval flow configuration
            try {
                if (companyId) {
                    console.log('📡 Checking approval flow configuration...');
                    const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/approvalFlows/timesheet.json`);
                    if (response.ok) {
                        const approvalFlow = await response.json();
                        console.log('📋 Approval Flow Config:', approvalFlow);
                    } else {
                        console.log('❌ No approval flow configuration found');
                    }
                } else {
                    console.log('❌ No company ID for approval flow check');
                }
            } catch (error) {
                console.log('❌ Error fetching approval flow:', error);
            }
            
            console.log('🔧 === END DEBUG ===');
        };
        
        // Simplified function to force show submitted timesheets for testing
        window.forceShowSubmittedTimesheets = function() {
            console.log('🚀 Forcing visibility of submitted timesheets for testing...');
            
            // Override the canUserViewTimesheet function temporarily
            const originalFunction = window.canUserViewTimesheet;
            window.canUserViewTimesheet = async function(timesheet) {
                console.log(`🔧 Override: Checking timesheet ${timesheet.id} (${timesheet.status})`);
                
                // User can always see their own timesheets
                const currentUserName = getCurrentUserName();
                if (timesheet.submittedBy === currentUserName) {
                    console.log('✅ Override: Own timesheet - visible');
                    return true;
                }
                
                // If user can approve, show all submitted/approved/rejected timesheets
                if (timesheet.status === 'submitted' || timesheet.status === 'approved' || timesheet.status === 'rejected') {
                    const canApprove = checkUserCanApprove();
                    console.log(`✅ Override: ${timesheet.status} timesheet, can approve: ${canApprove}`);
                    return canApprove;
                }
                
                console.log('❌ Override: Draft timesheet from another user - hidden');
                return false;
            };
            
            // Refresh the display
            displayTimesheets();
            
            console.log('🚀 Override applied! To restore original function, call window.restoreOriginalVisibility()');
            
            // Store original function for restoration
            window.originalCanUserViewTimesheet = originalFunction;
        };
        
        // Function to restore original visibility logic
        window.restoreOriginalVisibility = function() {
            if (window.originalCanUserViewTimesheet) {
                window.canUserViewTimesheet = window.originalCanUserViewTimesheet;
                displayTimesheets();
                console.log('🔄 Original visibility function restored');
            }
        };
        
        // EMERGENCY BYPASS: Show ALL timesheets regardless of permissions
        window.showAllTimesheets = function() {
            console.log('🚨 EMERGENCY BYPASS: Showing ALL timesheets without filtering');
            
            const tableBody = document.getElementById('timesheetTableBody');
            const emptyState = document.getElementById('timesheetEmptyState');
            
            console.log('📊 Total timesheets to show:', timesheets.length);
            
            if (timesheets.length === 0) {
                console.log('❌ No timesheets in array at all');
                emptyState.style.display = 'table-row';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Remove existing rows (except empty state)
            const existingRows = tableBody.querySelectorAll('tr:not(.empty-state)');
            existingRows.forEach(row => row.remove());

            timesheets.forEach(timesheet => {
                console.log('🔨 Creating row for timesheet (BYPASS):', timesheet.id, timesheet.status, 'by:', timesheet.submittedBy);
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.setAttribute('data-timesheet-id', timesheet.id);
                
                // Add special styling for timesheets that need approval
                if (timesheet.status === 'submitted') {
                    row.classList.add('needs-approval');
                    row.style.backgroundColor = '#fff9e6'; // Highlight submitted timesheets
                }
                
                row.innerHTML = `
                    <td>${timesheet.period}</td>
                    <td>${formatMonthYear(timesheet.monthYear)}</td>
                    <td>${timesheet.totalHours || '0.0'} hrs</td>
                    <td>
                        <span class="status-badge status-${timesheet.status}">${capitalizeFirst(timesheet.status)}</span>
                        ${timesheet.status === 'submitted' ? '<span class="approval-indicator" title="Needs Approval">⏳</span>' : ''}
                    </td>
                    <td>${timesheet.submittedBy || getCurrentUserName()}</td>
                    <td>${timesheet.submittedDate ? formatDate(timesheet.submittedDate) : '-'}</td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-primary" onclick="editTimesheet('${timesheet.id}')" title="Edit Timesheet">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTimesheet('${timesheet.id}')" title="Delete Timesheet">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${timesheet.status === 'submitted' ? `
                        <button class="btn btn-sm btn-success" onclick="openTimesheetDetailsModal('${timesheet.id}')" title="Review & Approve">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                
                // Add click event listener to the row for opening the modal
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on action buttons
                    if (e.target.closest('td').cellIndex !== 6) {
                        openTimesheetDetailsModal(timesheet.id);
                    }
                });
                
                tableBody.appendChild(row);
            });
            
            console.log('🚨 BYPASS COMPLETE: All timesheets now visible');
        };
        
        // Function to load timesheets from various sources for debugging
        window.loadAllPossibleTimesheets = async function() {
            console.log('🔍 Loading timesheets from all possible sources...');
            
            // 1. Check localStorage
            const localTimesheets = JSON.parse(localStorage.getItem('userTimesheets') || '[]');
            console.log('💾 localStorage timesheets:', localTimesheets.length, localTimesheets);
            
            // 2. Check if loadTimesheets function loads from Firebase
            try {
                await loadTimesheets();
                console.log('🔥 After loadTimesheets() call, timesheets array:', timesheets.length, timesheets);
            } catch (error) {
                console.log('❌ Error calling loadTimesheets():', error);
            }
            
            // 3. Create sample timesheets if none exist
            if (timesheets.length === 0) {
                console.log('🧪 No timesheets found, creating samples...');
                createSampleTimesheets();
                console.log('🧪 After creating samples:', timesheets.length, timesheets);
            }
            
            // 4. Show what we have
            console.log('📊 Final timesheets array:', timesheets);
            
            return timesheets;
        };
        
        function getCurrentUserInfo() {
            // This is a placeholder function. You should implement this to get current user info
            // For now, return a default user object
            return {
                id: 'current_user_id',
                name: 'Current User',
                email: 'user@company.com',
                role: 'supervisor'
            };
        }

        function displayApprovalFlow(approvalFlow, container) {
            if (!approvalFlow || !approvalFlow.levels || approvalFlow.levels.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No approval flow configured.</p>';
                return;
            }            let html = '';
            
            // Add flow type badge
            const flowTypeText = approvalFlow.approvalOrder === 'sequential' ? 
                'Sequential Approval (In Order)' : 'Parallel Approval (Any Approver)';
            html += `<div class="flow-type-badge">
                <i class="fas fa-${approvalFlow.approvalOrder === 'sequential' ? 'sort-amount-down' : 'users'}"></i>
                ${flowTypeText}
            </div>`;

            // Add approval levels
            approvalFlow.levels.forEach((level, index) => {
                const approverTitle = getApproverTitle(level, approvalFlow.selectedRoles, index + 1);
                const approverDetails = getApproverDetails(level, approvalFlow.selectedRoles, index + 1);
                
                html += `
                    <div class="approval-flow-item">
                        <div class="level-indicator">Level ${level.level}</div>
                        <div class="approver-info">
                            <div class="approver-title">${approverTitle}</div>
                            <div class="approver-details">${approverDetails}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        function getApproverTitle(level, selectedRoles, levelNumber) {
            // Check if we have selected roles with actual names from Firebase configuration
            const levelKey = `level${levelNumber}`;
            const selectedRole = selectedRoles && selectedRoles[levelKey] && selectedRoles[levelKey][0];
            
            if (selectedRole && selectedRole.text) {
                // Special handling for "L+1" or "One Level Up" - show actual line manager name
                if (selectedRole.value === 'L+1' || selectedRole.text.toLowerCase().includes('one level up')) {
                    const lineManagerName = getCurrentUserLineManager();
                    if (lineManagerName) {
                        return `${lineManagerName} (Line Manager)`;
                    }
                    // Fallback if line manager not configured
                    return 'Line Manager (Not Configured)';
                }
                return selectedRole.text;
            }
            
            // Fallback to basic level data - check both possible property names
            const approverValue = level.approverValue || level.value || level.name;
            
            switch (level.approverType) {
                case 'function':
                    return approverValue || 'Job Title';
                case 'name':
                    return approverValue || 'Specific User';
                case 'level':
                    if (approverValue === 'L+1') {
                        // Show actual line manager name for L+1
                        const lineManagerName = getCurrentUserLineManager();
                        if (lineManagerName) {
                            return `${lineManagerName} (Line Manager)`;
                        }
                        return 'Line Manager (Not Configured)';
                    } else if (approverValue === 'L+2') {
                        return 'Two Levels Up';
                    } else if (approverValue === 'L+3') {
                        return 'Three Levels Up';
                    } else if (approverValue === 'L+4') {
                        return 'Four Levels Up';
                    }
                    return `Management Level (${approverValue})`;
                default:
                    return approverValue || 'Approver';
            }
        }
        
        function getApproverDetails(level, selectedRoles, levelNumber) {
            // Check if we have selected roles from Firebase configuration
            const levelKey = `level${levelNumber}`;
            const selectedRole = selectedRoles && selectedRoles[levelKey] && selectedRoles[levelKey][0];            
            if (selectedRole && selectedRole.text) {
                // Provide detailed information based on approver type from Firebase configuration
                switch (level.approverType) {
                    case 'function':
                        return `Approval by any user with job title: ${selectedRole.text}`;
                    case 'name':
                        return `Approval by specific user: ${selectedRole.text}`;
                    case 'level':
                        // Special handling for "L+1" or "One Level Up" - show actual line manager name
                        if (selectedRole.value === 'L+1' || selectedRole.text.toLowerCase().includes('one level up')) {
                            const lineManagerName = getCurrentUserLineManager();
                            if (lineManagerName) {
                                return `Approval by direct line manager: ${lineManagerName}`;
                            }
                            return 'Approval by direct line manager (not configured in account settings)';
                        }
                        return `Approval by ${selectedRole.text}`;
                    default:
                        return `Approval by: ${selectedRole.text}`;
                }
            }
            
            // Fallback to basic level data - check both possible property names
            const approverValue = level.approverValue || level.value || level.name;
            
            switch (level.approverType) {
                case 'function':
                    return `Approval by any user with job title: ${approverValue}`;
                case 'name':
                    return `Approval by specific user: ${approverValue}`;
                case 'level':
                    if (approverValue === 'L+1') {
                        // Show actual line manager name for L+1
                        const lineManagerName = getCurrentUserLineManager();
                        if (lineManagerName) {
                            return `Approval by direct line manager: ${lineManagerName}`;
                        }
                        return 'Approval by direct line manager (not configured in account settings)';
                    } else if (approverValue === 'L+2') {
                        return 'Approval by two levels up from submitter';
                    } else if (approverValue === 'L+3') {
                        return 'Approval by three levels up from submitter';
                    } else if (approverValue === 'L+4') {
                        return 'Approval by four levels up from submitter';
                    }
                    return `Approval by ${approverValue} relative to submitter`;                default:
                    return level.description || `Approval required by: ${approverValue}` || 'No additional details';
            }
        }

        function getCurrentUserName() {
            // Priority 1: Get user from authentication system
            const currentUser = window.authManager?.currentUser;
            if (currentUser) {
                if (currentUser.name && currentUser.name.trim()) {
                    return currentUser.name.trim();
                }
                if (currentUser.displayName && currentUser.displayName.trim()) {
                    return currentUser.displayName.trim();
                }
                if (currentUser.email) {
                    // Extract name from email if available
                    return currentUser.email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
            }
            
            // Priority 2: Check if we have a specific user name set
            const specificUserName = localStorage.getItem('specificUserName');
            if (specificUserName && specificUserName.trim()) {
                return specificUserName.trim();
            }
            
            // Priority 3: Try to get user name from account form
            const nameField = document.getElementById('name');
            if (nameField && nameField.value.trim()) {
                return nameField.value.trim();
            }
            
            // Priority 4: Try userName from localStorage
            const userName = localStorage.getItem('userName');
            if (userName && userName.trim() && userName !== 'Current User') {
                return userName.trim();
            }
            
            // Priority 5: Try to get from currentUser object in localStorage
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (userData.name && userData.name.trim()) {
                    return userData.name.trim();
                }
                if (userData.displayName && userData.displayName.trim()) {
                    return userData.displayName.trim();
                }
                if (userData.fullName && userData.fullName.trim()) {
                    return userData.fullName.trim();
                }
                if (userData.email) {
                    // Extract name from email if available
                    return userData.email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
            } catch (error) {
                console.warn('Error retrieving user data from localStorage:', error);
            }
            
            // Fallback to a generic name if nothing else is available
            return 'Current User';
        }

        function getCurrentUserLineManager() {
            // First priority: Get the line manager from the account form dropdown
            const lineManagerSelect = document.getElementById('lineManager');
            if (lineManagerSelect && lineManagerSelect.selectedOptions.length > 0) {
                const selectedOption = lineManagerSelect.selectedOptions[0];
                if (selectedOption.text !== 'Select Line Manager' && 
                    selectedOption.text !== 'No Line Manager Assigned' && 
                    selectedOption.text !== 'Unable to load line manager' &&
                    selectedOption.text !== 'Error loading line manager' &&
                    selectedOption.value !== '') {
                    return selectedOption.text;
                }
            }
            
            // Second priority: try to get from the current user's data stored in window
            try {
                const currentUser = window.authManager?.getUser();
                if (currentUser && window.currentUserData && window.currentUserData.lineManagerName) {
                    return window.currentUserData.lineManagerName;
                }
            } catch (error) {
                console.warn('Error retrieving current user data from window:', error);
            }
            
            // Third priority: try to get from localStorage 
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (userData.lineManagerName) {
                    return userData.lineManagerName;
                }
                
                // Check if stored in older format
                if (userData.lineManager && typeof userData.lineManager === 'string' && userData.lineManager.includes(' ')) {
                    return userData.lineManager;
                }
            } catch (error) {
                console.warn('Error retrieving user data from localStorage:', error);
            }
            
            // Fourth priority: try to get from account form fields (fallback)
            const lineManagerInput = document.querySelector('input[name="lineManager"]');
            if (lineManagerInput && lineManagerInput.value) {
                return lineManagerInput.value;
            }
            
            // Final fallback
            return 'No Line Manager Assigned';
        }

        function closeTimesheetModal() {
            document.getElementById('timesheetModal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentTimesheetId = null;
            
            // Reset month/year field to be editable
            document.getElementById('monthYear').removeAttribute('readonly');
            
            // Reset form actions visibility
            const formActions = document.querySelector('.form-actions');
            formActions.style.display = 'flex';
              // Hide info section and approval actions
            const infoSection = document.getElementById('timesheetInfoSection');
            infoSection.style.display = 'none';
            
            const approvalActions = document.getElementById('approvalActions');
            approvalActions.style.display = 'none';
            
            const approvalFlowSection = document.getElementById('approvalFlowSection');
            approvalFlowSection.style.display = 'none';
        }
        
        // Utility functions
        function generateId() {
            return 'ts_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getNextFriday(date) {
            const friday = new Date(date);
            friday.setDate(date.getDate() + (5 - date.getDay()) % 7);
            return friday;
        }

        function generateMonthEntries(year, month) {
            const entries = [];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const entryDate = new Date(year, month, day);
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[entryDate.getDay()];
                  entries.push({
                    id: generateId(),
                    dayName: `${dayName} ${day}`,
                    date: entryDate.toISOString().split('T')[0],
                    startTime: '',
                    endTime: '',
                    breakHours: 0,
                    regularHours: 0,
                    overtimeHours: 0,
                    comments: ''
                });
            }
            
            return entries;
        }

        function generateWeekEntries(weekEndingDate) {
            const entries = [];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            for (let i = 0; i < 7; i++) {
                const entryDate = new Date(weekEndingDate);
                entryDate.setDate(weekEndingDate.getDate() - (6 - i));
                  entries.push({
                    id: generateId(),
                    day: days[i],
                    date: entryDate.toISOString().split('T')[0],
                    startTime: '',
                    endTime: '',
                    breakHours: 0,
                    regularHours: 0,
                    overtimeHours: 0,
                    comments: ''
                });
            }
            
            return entries;
        }

        function updateMonthEntries() {
            const timesheet = timesheets.find(t => t.id === currentTimesheetId);
            if (timesheet) {
                const monthYear = document.getElementById('monthYear').value;
                const [year, month] = monthYear.split('-').map(Number);
                timesheet.entries = generateMonthEntries(year, month - 1); // month is 0-based
                timesheet.monthYear = monthYear;
                
                const date = new Date(monthYear + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                timesheet.period = `${monthName} Timesheet`;
                
                populateTimesheetEntries(timesheet.entries);
                updateTimesheetSummary(timesheet);
                saveTimesheetsToStorage();
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateWithDay(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatMonthYear(monthYear) {
            const date = new Date(monthYear + '-01');
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long'
            });
        }

        function capitalizeFirst(str) {            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Leave Management functionality
        let leaveRequests = [];
        let currentLeaveRequestId = null;        async function loadLeaveRequests() {
            try {
                // Load leave requests from Firebase
                const response = await fetch('https://users-8be65-default-rtdb.firebaseio.com/leaveRequests.json');
                
                if (response.ok) {
                    const firebaseData = await response.json();
                    
                    if (firebaseData) {
                        // Convert Firebase object to array
                        leaveRequests = Object.keys(firebaseData).map(key => ({
                            id: key,
                            ...firebaseData[key]
                        }));
                    } else {
                        leaveRequests = [];
                    }
                    
                    console.log('Leave requests loaded from Firebase:', leaveRequests.length);
                } else {
                    console.warn('Failed to load leave requests from Firebase, using empty array');
                    leaveRequests = [];
                }
            } catch (error) {
                console.error('Error loading leave requests from Firebase:', error);
                leaveRequests = [];
            }
            
            await displayLeaveRequests();
        }        async function saveLeaveRequestToFirebase(leaveRequest) {
            try {
                // Get company ID for proper scoping
                const companyId = getCompanyId();
                const currentUserId = getCurrentUserName() || 'unknown';
                
                // Save or update leave request in Firebase under company scope
                const url = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/leaveRequests/${currentUserId}/${leaveRequest.id}.json`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: leaveRequest.id,
                        userId: currentUserId,
                        companyId: companyId,
                        leaveType: leaveRequest.leaveType,
                        startDate: leaveRequest.startDate,
                        endDate: leaveRequest.endDate,
                        duration: leaveRequest.duration,
                        reason: leaveRequest.reason,
                        handoverNotes: leaveRequest.handoverNotes,
                        status: leaveRequest.status,
                        createdDate: leaveRequest.createdDate,
                        submittedDate: leaveRequest.submittedDate,
                        submittedBy: leaveRequest.submittedBy,
                        approvedDate: leaveRequest.approvedDate,
                        rejectedDate: leaveRequest.rejectedDate,
                        approvedBy: leaveRequest.approvedBy,
                        rejectedBy: leaveRequest.rejectedBy,
                        approverComments: leaveRequest.approverComments
                    })
                });
                
                if (response.ok) {
                    console.log('Leave request saved to Firebase successfully under company scope');
                    return true;
                } else {
                    console.error('Failed to save leave request to Firebase:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Error saving leave request to Firebase:', error);
                return false;
            }
        }

        function saveLeaveRequestsToStorage() {
            // Keep localStorage as backup, but primary storage is now Firebase
            localStorage.setItem('userLeaveRequests', JSON.stringify(leaveRequests));
        }

        // Function to check if current user can view a specific leave request
        async function canUserViewLeaveRequest(leaveRequest) {
            const currentUserName = getCurrentUserName();
            
            console.log(`Checking visibility for leave request: ${leaveRequest.leaveType} (submitted by: ${leaveRequest.submittedBy}, status: ${leaveRequest.status})`);
            
            // User can always see their own leave requests regardless of status
            if (leaveRequest.submittedBy === currentUserName) {
                console.log('✓ User can see their own leave request');
                return true;
            }
            
            // For leave requests submitted by others, check if current user is an approver
            if (leaveRequest.status === 'submitted' || leaveRequest.status === 'approved' || leaveRequest.status === 'rejected') {
                console.log('Checking if user can approve this submitted/processed leave request...');
                
                try {                    // Fetch approval flow from Firebase - use correct endpoint for leave requests
                    const response = await fetch('https://users-8be65-default-rtdb.firebaseio.com/approvalFlows/leave_request.json');
                    
                    if (response.ok) {
                        const leaveApprovalFlow = await response.json();
                        
                        if (leaveApprovalFlow && leaveApprovalFlow.selectedRoles) {
                            console.log('Found leave approval flow configuration');
                            
                            // Check if current user is listed as an approver
                            const isApprover = leaveApprovalFlow.selectedRoles.some(role => {
                                if (role.type === 'one_level_up') {
                                    const canApprove = checkUserCanApprove();
                                    console.log(`One level up check result: ${canApprove}`);
                                    return canApprove;
                                } else {
                                    const matches = role.name === currentUserName;
                                    console.log(`Specific role check (${role.name} === ${currentUserName}): ${matches}`);
                                    return matches;
                                }
                            });
                            
                            if (isApprover) {
                                console.log('✓ User is an approver');
                                return true;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error fetching approval flow for leave visibility check:', error);
                }
                
                // Fallback: Use the existing permission check
                const canApprove = checkUserCanApprove();
                console.log(`Fallback approval check result: ${canApprove}`);
                return canApprove;
            }
            
            // For draft leave requests, only the owner can see them
            console.log('✗ User cannot see this leave request (draft from another user or no permission)');
            return false;
        }

        // Function to filter leave requests based on visibility rules
        async function filterVisibleLeaveRequests(allLeaveRequests) {
            const visibleLeaveRequests = [];
            
            for (const leaveRequest of allLeaveRequests) {
                const canView = await canUserViewLeaveRequest(leaveRequest);
                if (canView) {
                    visibleLeaveRequests.push(leaveRequest);
                }
            }
            
            return visibleLeaveRequests;
        }

        async function displayLeaveRequests() {
            const tableBody = document.getElementById('leaveTableBody');
            const emptyState = document.getElementById('leaveEmptyState');
            
            // Filter leave requests based on visibility rules
            const visibleLeaveRequests = await filterVisibleLeaveRequests(leaveRequests);
            
            if (visibleLeaveRequests.length === 0) {
                emptyState.style.display = 'table-row';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Remove existing rows (except empty state)
            const existingRows = tableBody.querySelectorAll('tr:not(.empty-state)');
            existingRows.forEach(row => row.remove());

            visibleLeaveRequests.forEach(leaveRequest => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.setAttribute('data-leave-id', leaveRequest.id);
                
                // Add special styling for leave requests that need approval
                if (leaveRequest.status === 'submitted' && checkUserCanApprove()) {
                    row.classList.add('needs-approval');
                }

                row.innerHTML = `
                    <td>${getLeaveTypeDisplay(leaveRequest.leaveType)}</td>
                    <td>${formatDate(leaveRequest.startDate)}</td>
                    <td>${formatDate(leaveRequest.endDate)}</td>
                    <td>${leaveRequest.duration} day${leaveRequest.duration > 1 ? 's' : ''}</td>
                    <td>
                        <span class="status-badge status-${leaveRequest.status}">${capitalizeFirst(leaveRequest.status)}</span>
                        ${leaveRequest.status === 'submitted' && checkUserCanApprove() ? '<span class="approval-indicator" title="Needs Approval">⏳</span>' : ''}
                    </td>
                    <td>${leaveRequest.submittedBy || getCurrentUserName()}</td>
                    <td>${leaveRequest.submittedDate ? formatDate(leaveRequest.submittedDate) : '-'}</td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-primary" onclick="editLeaveRequest('${leaveRequest.id}')" ${leaveRequest.status === 'approved' ? 'disabled' : ''} title="Edit Leave Request">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${leaveRequest.status === 'draft' ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteLeaveRequest('${leaveRequest.id}')" title="Delete Leave Request">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                        ${leaveRequest.status === 'submitted' && checkUserCanApprove() ? `
                        <button class="btn btn-sm btn-success" onclick="openLeaveDetailsModal('${leaveRequest.id}')" title="Review & Approve">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        ` : ''}
                    </td>
                `;

                // Add click event listener to the row for opening the modal
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on action buttons
                    if (e.target.closest('td').cellIndex !== 7) {
                        openLeaveDetailsModal(leaveRequest.id);
                    }
                });
                
                tableBody.appendChild(row);
            });
        }
        
        async function createNewLeaveRequestInternal() {
            console.log('🔧 createNewLeaveRequestInternal() called');
            const newLeaveRequest = {
                id: generateLeaveId(),
                leaveType: '',
                startDate: '',
                endDate: '',
                duration: 0,
                reason: '',
                handoverNotes: '',
                status: 'draft',
                createdDate: new Date().toISOString(),
                submittedDate: null,
                submittedBy: getCurrentUserName()
            };
            
            console.log('📝 Creating new leave request:', newLeaveRequest.id);
            
            // Save to Firebase immediately when creating a draft
            const saved = await saveLeaveRequestToFirebase(newLeaveRequest);
            console.log('💾 Leave request Firebase save result:', saved);
            
            // Continue even if Firebase save fails for now
            if (saved || true) { // Temporarily allowing to continue even if Firebase fails
                console.log('✅ Proceeding with leave request creation');
                leaveRequests.push(newLeaveRequest);
                saveLeaveRequestsToStorage();
                await displayLeaveRequests();
                console.log('🎯 Calling editLeaveRequest to open modal...');
                editLeaveRequest(newLeaveRequest.id);
            } else {
                console.error('❌ Failed to save leave request to Firebase');
                alert('Failed to create leave request. Please try again.');
            }
        }

        function editLeaveRequest(leaveRequestId) {
            currentLeaveRequestId = leaveRequestId;
            const leaveRequest = leaveRequests.find(lr => lr.id === leaveRequestId);
            
            if (!leaveRequest) return;

            // Hide info section for edit mode
            const infoSection = document.getElementById('leaveInfoSection');
            infoSection.style.display = 'none';
            
            // Show approval flow section for draft leave requests
            const approvalFlowSection = document.getElementById('leaveApprovalFlowSection');
            if (leaveRequest.status === 'draft') {
                approvalFlowSection.style.display = 'block';
                loadLeaveApprovalFlow();
            } else {
                approvalFlowSection.style.display = 'none';
            }
            
            // Populate modal
            document.getElementById('leaveModalTitle').textContent = 
                leaveRequest.status === 'draft' ? 'Edit Leave Request' : 'View Leave Request';
            
            // Populate form fields
            document.getElementById('leaveType').value = leaveRequest.leaveType;
            document.getElementById('startDate').value = leaveRequest.startDate;
            document.getElementById('endDate').value = leaveRequest.endDate;
            document.getElementById('leaveDuration').value = leaveRequest.duration;
            document.getElementById('leaveReason').value = leaveRequest.reason;
            document.getElementById('handoverNotes').value = leaveRequest.handoverNotes;
            
            // Make fields readonly if not draft
            const readonly = leaveRequest.status !== 'draft';
            document.getElementById('leaveType').disabled = readonly;
            document.getElementById('startDate').disabled = readonly;
            document.getElementById('endDate').disabled = readonly;
            document.getElementById('leaveReason').disabled = readonly;
            document.getElementById('handoverNotes').disabled = readonly;
              // Show/hide form actions based on status
            const formActions = document.querySelector('#leaveModal .form-actions');
            const deleteBtn = document.getElementById('deleteLeaveBtn');
            
            if (leaveRequest.status === 'draft') {
                formActions.style.display = 'flex';
                // Show delete button for draft requests
                deleteBtn.style.display = 'inline-block';
            } else {
                formActions.style.display = 'none';
                deleteBtn.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('leaveModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function openLeaveDetailsModal(leaveRequestId) {
            currentLeaveRequestId = leaveRequestId;
            const leaveRequest = leaveRequests.find(lr => lr.id === leaveRequestId);
            
            if (!leaveRequest) return;
            
            // Populate modal with read-only data
            document.getElementById('leaveModalTitle').textContent = 'Leave Request Details';
            
            // Show and populate info section
            const infoSection = document.getElementById('leaveInfoSection');
            infoSection.style.display = 'block';
            
            // Show approval flow section
            const approvalFlowSection = document.getElementById('leaveApprovalFlowSection');
            approvalFlowSection.style.display = 'block';
            loadLeaveApprovalFlow();
            
            // Populate info cards
            const statusBadge = document.getElementById('modalLeaveStatus');
            statusBadge.textContent = capitalizeFirst(leaveRequest.status);
            statusBadge.className = `status-badge status-${leaveRequest.status}`;
            
            document.getElementById('modalLeaveCreatedDate').textContent = leaveRequest.createdDate ? 
                formatDate(leaveRequest.createdDate) : '-';
            document.getElementById('modalLeaveSubmittedDate').textContent = leaveRequest.submittedDate ? 
                formatDate(leaveRequest.submittedDate) : '-';
            document.getElementById('modalLeaveDuration').textContent = 
                `${leaveRequest.duration} day${leaveRequest.duration > 1 ? 's' : ''}`;
            
            // Show approval info for approved/rejected leave requests
            const approvalInfo = document.getElementById('leaveApprovalInfo');
            const approvalCommentsDisplay = document.getElementById('leaveApprovalCommentsDisplay');
            
            if (leaveRequest.status === 'approved' || leaveRequest.status === 'rejected') {
                approvalInfo.style.display = 'block';
                
                const actionDate = leaveRequest.status === 'approved' ? leaveRequest.approvedDate : leaveRequest.rejectedDate;
                const actionBy = leaveRequest.status === 'approved' ? leaveRequest.approvedBy : leaveRequest.rejectedBy;
                
                document.getElementById('modalLeaveActionLabel').textContent = 
                    leaveRequest.status === 'approved' ? 'Approved Date' : 'Rejected Date';
                document.getElementById('modalLeaveActionDate').textContent = actionDate ? 
                    formatDate(actionDate) : '-';
                document.getElementById('modalLeaveActionBy').textContent = actionBy ? 
                    (actionBy.name || actionBy.email || 'Unknown') : '-';
                
                if (leaveRequest.approverComments && leaveRequest.approverComments.trim()) {
                    approvalCommentsDisplay.style.display = 'block';
                    document.getElementById('leaveCommentsText').textContent = leaveRequest.approverComments;
                } else {
                    approvalCommentsDisplay.style.display = 'none';
                }
            } else {
                approvalInfo.style.display = 'none';
                approvalCommentsDisplay.style.display = 'none';
            }
            
            // Populate form fields in read-only mode
            document.getElementById('leaveType').value = leaveRequest.leaveType;
            document.getElementById('startDate').value = leaveRequest.startDate;
            document.getElementById('endDate').value = leaveRequest.endDate;
            document.getElementById('leaveDuration').value = leaveRequest.duration;
            document.getElementById('leaveReason').value = leaveRequest.reason;
            document.getElementById('handoverNotes').value = leaveRequest.handoverNotes;
            
            // Make all fields readonly
            document.getElementById('leaveType').disabled = true;
            document.getElementById('startDate').disabled = true;
            document.getElementById('endDate').disabled = true;
            document.getElementById('leaveReason').disabled = true;
            document.getElementById('handoverNotes').disabled = true;
            
            // Handle action visibility based on status and user role
            const formActions = document.querySelector('#leaveModal .form-actions');
            const approvalActions = document.getElementById('leaveApprovalActions');
            
            const canApprove = checkUserCanApprove();
            
            if (leaveRequest.status === 'submitted' && canApprove) {
                // Show approval actions for submitted leave requests if user can approve
                formActions.style.display = 'none';
                approvalActions.style.display = 'block';
                
                // Clear previous comments
                document.getElementById('leaveApprovalComments').value = '';
            } else {
                // Hide both form actions and approval actions for view mode
                formActions.style.display = 'none';
                approvalActions.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('leaveModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function calculateLeaveDuration() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Include both start and end dates
                    document.getElementById('leaveDuration').value = diffDays;
                } else {
                    document.getElementById('leaveDuration').value = 0;
                }
            }
        }        async function saveLeaveRequest() {
            const leaveRequest = leaveRequests.find(lr => lr.id === currentLeaveRequestId);
            if (leaveRequest) {
                // Update leave request with form data
                leaveRequest.leaveType = document.getElementById('leaveType').value;
                leaveRequest.startDate = document.getElementById('startDate').value;
                leaveRequest.endDate = document.getElementById('endDate').value;
                leaveRequest.duration = parseInt(document.getElementById('leaveDuration').value) || 0;
                leaveRequest.reason = document.getElementById('leaveReason').value;
                leaveRequest.handoverNotes = document.getElementById('handoverNotes').value;
                leaveRequest.submittedBy = getCurrentUserName(); // Ensure submitter is set
                
                // Save to Firebase
                const saved = await saveLeaveRequestToFirebase(leaveRequest);
                
                if (saved) {
                    // Also save to localStorage as backup
                    saveLeaveRequestsToStorage();
                    await displayLeaveRequests();
                    alert('Leave request saved successfully!');
                } else {
                    alert('Failed to save leave request. Please try again.');
                }
            }
        }        async function submitLeaveRequest() {
            const leaveRequest = leaveRequests.find(lr => lr.id === currentLeaveRequestId);
            if (leaveRequest) {
                // Validate required fields
                const leaveType = document.getElementById('leaveType').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const reason = document.getElementById('leaveReason').value;
                
                if (!leaveType || !startDate || !endDate || !reason.trim()) {
                    alert('Please fill in all required fields before submitting.');
                    return;
                }
                
                // Update leave request with form data
                leaveRequest.leaveType = leaveType;
                leaveRequest.startDate = startDate;
                leaveRequest.endDate = endDate;
                leaveRequest.duration = parseInt(document.getElementById('leaveDuration').value) || 0;
                leaveRequest.reason = reason;
                leaveRequest.handoverNotes = document.getElementById('handoverNotes').value;
                leaveRequest.status = 'submitted';
                leaveRequest.submittedDate = new Date().toISOString();
                leaveRequest.submittedBy = getCurrentUserName();
                
                // Save to Firebase
                const saved = await saveLeaveRequestToFirebase(leaveRequest);
                
                if (saved) {
                    // Also save to localStorage as backup
                    saveLeaveRequestsToStorage();
                    await displayLeaveRequests();
                    closeLeaveModal();
                    alert('Leave request submitted successfully!');
                } else {
                    alert('Failed to submit leave request. Please try again.');
                }
            }
        }        async function deleteLeaveRequest(leaveRequestId) {
            if (confirm('Are you sure you want to delete this leave request?')) {
                try {
                    // Get company ID for proper scoping
                    const companyId = getCompanyId();
                    const currentUserId = getCurrentUserName() || 'unknown';
                    
                    // Delete from Firebase using company-scoped path
                    const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/leaveRequests/${currentUserId}/${leaveRequestId}.json`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Remove from local array
                        leaveRequests = leaveRequests.filter(lr => lr.id !== leaveRequestId);
                        saveLeaveRequestsToStorage();
                        await displayLeaveRequests();
                        console.log('Leave request deleted successfully from company scope');
                    } else {
                        alert('Failed to delete leave request. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting leave request:', error);
                    alert('Failed to delete leave request. Please try again.');
                }
            }
        }        async function approveLeaveRequest() {
            const leaveRequest = leaveRequests.find(lr => lr.id === currentLeaveRequestId);
            if (leaveRequest) {
                const comments = document.getElementById('leaveApprovalComments').value;
                
                if (confirm('Are you sure you want to approve this leave request?')) {
                    leaveRequest.status = 'approved';
                    leaveRequest.approvedDate = new Date().toISOString();
                    leaveRequest.approverComments = comments;
                    leaveRequest.approvedBy = getCurrentUserInfo();
                    
                    // Save to Firebase
                    const saved = await saveLeaveRequestToFirebase(leaveRequest);
                    
                    if (saved) {
                        saveLeaveRequestsToStorage();
                        await displayLeaveRequests();
                        closeLeaveModal();
                        alert('Leave request approved successfully!');
                    } else {
                        alert('Failed to approve leave request. Please try again.');
                    }
                }
            }
        }        async function declineLeaveRequest() {
            const leaveRequest = leaveRequests.find(lr => lr.id === currentLeaveRequestId);
            if (leaveRequest) {
                const comments = document.getElementById('leaveApprovalComments').value;
                
                if (!comments.trim()) {
                    alert('Please provide comments when declining a leave request.');
                    return;
                }
                
                if (confirm('Are you sure you want to decline this leave request?')) {
                    leaveRequest.status = 'rejected';
                    leaveRequest.rejectedDate = new Date().toISOString();
                    leaveRequest.approverComments = comments;
                    leaveRequest.rejectedBy = getCurrentUserInfo();
                    
                    // Save to Firebase
                    const saved = await saveLeaveRequestToFirebase(leaveRequest);
                    
                    if (saved) {
                        saveLeaveRequestsToStorage();
                        await displayLeaveRequests();
                        closeLeaveModal();
                        alert('Leave request declined. Employee will be notified.');
                    } else {
                        alert('Failed to decline leave request. Please try again.');
                    }
                }
            }
        }async function loadLeaveApprovalFlow() {
            const approvalFlowDisplay = document.getElementById('leaveApprovalFlowDisplay');
            
            try {
                // Show loading state
                approvalFlowDisplay.innerHTML = '<div class="approval-flow-loading">Loading approval flow configuration...</div>';
                
                // Fetch approval flow from Firebase - correct endpoint for leave_request
                const response = await fetch('https://users-8be65-default-rtdb.firebaseio.com/approvalFlows/leave_request.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const leaveApprovalFlow = await response.json();
                
                if (leaveApprovalFlow) {
                    console.log('Leave approval flow loaded from Firebase:', leaveApprovalFlow);
                    displayApprovalFlow(leaveApprovalFlow, approvalFlowDisplay);
                } else {
                    // No hardcoded fallback - show message that configuration is needed
                    approvalFlowDisplay.innerHTML = '<p style="color: #666; font-style: italic;">No leave request approval flow configured. Please configure the approval flow in Settings.</p>';
                }
                
            } catch (error) {
                console.error('Error loading leave approval flow from Firebase:', error);
                
                // Only try localStorage as fallback, no hardcoded defaults
                let leaveApprovalFlow = null;
                try {
                    const storedApprovalFlows = localStorage.getItem('approvalFlows');
                    if (storedApprovalFlows) {
                        const approvalFlows = JSON.parse(storedApprovalFlows);
                        leaveApprovalFlow = approvalFlows['leave_request'];
                    }
                } catch (localError) {
                    console.warn('Error loading approval flows from localStorage:', localError);
                }
                
                if (leaveApprovalFlow) {
                    console.log('Using leave approval flow from localStorage as fallback');
                    displayApprovalFlow(leaveApprovalFlow, approvalFlowDisplay);
                } else {
                    // No hardcoded fallback - show error message
                    approvalFlowDisplay.innerHTML = '<p style="color: #e74c3c; font-style: italic;">Unable to load leave request approval flow. Please check your connection and try again.</p>';
                }
            }        }

        function closeLeaveModal() {
            document.getElementById('leaveModal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentLeaveRequestId = null;
            
            // Reset form fields
            document.getElementById('leaveType').disabled = false;
            document.getElementById('startDate').disabled = false;
            document.getElementById('endDate').disabled = false;
            document.getElementById('leaveReason').disabled = false;
            document.getElementById('handoverNotes').disabled = false;
              // Reset form actions visibility
            const formActions = document.querySelector('#leaveModal .form-actions');
            formActions.style.display = 'flex';
            
            // Hide delete button (should only show for draft requests when editing)
            const deleteBtn = document.getElementById('deleteLeaveBtn');
            deleteBtn.style.display = 'none';
            
            // Hide info section and approval actions
            const infoSection = document.getElementById('leaveInfoSection');
            infoSection.style.display = 'none';
            
            const approvalActions = document.getElementById('leaveApprovalActions');
            approvalActions.style.display = 'none';
            
            const approvalFlowSection = document.getElementById('leaveApprovalFlowSection');
            approvalFlowSection.style.display = 'none';
        }

        function getLeaveTypeDisplay(leaveType) {
            const leaveTypes = {
                'annual': 'Annual Leave',
                'sick': 'Sick Leave',
                'personal': 'Personal Leave',
                'emergency': 'Emergency Leave',
                'maternity': 'Maternity/Paternity Leave',
                'compassionate': 'Compassionate Leave',
                'study': 'Study Leave',
                'unpaid': 'Unpaid Leave'
            };
            return leaveTypes[leaveType] || leaveType;
        }

        function generateLeaveId() {
            return 'lr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('timesheet-modal')) {
                if (e.target.id === 'timesheetModal') {
                    closeTimesheetModal();
                } else if (e.target.id === 'leaveModal') {
                    closeLeaveModal();
                }
            }
        });

        // Organization Data Functions
        async function loadOrganizationData() {
            console.log('Loading organization data from Firebase...');
            
            try {
                // Load organizational data from Firebase
                const organizationData = await loadOrganizationFromFirebase();
                
                if (organizationData) {
                    // Load current user info with organizational context
                    await loadCurrentUserInfoWithOrg(organizationData);
                    
                    // Load line manager info from organizational data
                    await loadLineManagerInfoFromOrg(organizationData);
                    
                    // Load direct reports from organizational data
                    await loadDirectReportsFromOrg(organizationData);
                } else {
                    // Fallback to sample data if Firebase is not available
                    console.warn('Could not load organizational data from Firebase, using sample data');
                    loadCurrentUserInfo();
                    await loadLineManagerInfo();
                    await loadDirectReports();
                }
            } catch (error) {
                console.error('Error loading organizational data:', error);
                // Fallback to existing functions
                loadCurrentUserInfo();
                await loadLineManagerInfo();
                await loadDirectReports();
            }
        }

        async function loadOrganizationFromFirebase() {
            try {
                // Load users data
                const usersResponse = await fetch('https://users-8be65-default-rtdb.firebaseio.com/users.json');
                const usersData = usersResponse.ok ? await usersResponse.json() : null;
                
                // Load department configurations
                const deptResponse = await fetch('https://users-8be65-default-rtdb.firebaseio.com/fieldOptions/department.json');
                const deptData = deptResponse.ok ? await deptResponse.json() : null;
                
                if (!usersData) {
                    console.warn('No users data found in Firebase');
                    return null;
                }
                
                // Process the organizational data
                const employees = {};
                const departments = new Map();
                
                // Create department configurations map
                const deptConfigs = new Map();
                if (deptData) {
                    Object.values(deptData).forEach(dept => {
                        if (dept.value) {
                            deptConfigs.set(dept.value, {
                                headOfDepartmentName: dept.headOfDepartmentName || null,
                                headOfDepartment: dept.headOfDepartment || null,
                                label: dept.label || dept.value
                            });
                        }
                    });
                }
                
                // First pass: collect all employees
                Object.entries(usersData).forEach(([id, employee]) => {
                    if (employee.firstName && employee.lastName) {
                        employees[id] = {
                            id: id,
                            ...employee,
                            fullName: `${employee.firstName} ${employee.lastName}`
                        };
                    }
                });
                
                // Second pass: organize departments and establish relationships
                Object.values(employees).forEach(employee => {
                    if (employee.department) {
                        if (!departments.has(employee.department)) {
                            const deptConfig = deptConfigs.get(employee.department) || {};
                            departments.set(employee.department, {
                                name: deptConfig.label || employee.department,
                                headOfDepartment: null,
                                headOfDepartmentName: deptConfig.headOfDepartmentName || null,
                                employees: []
                            });
                        }
                        
                        const dept = departments.get(employee.department);
                        dept.employees.push(employee);
                        
                        // If this employee is the head of department from config
                        const deptConfig = deptConfigs.get(employee.department);
                        if (deptConfig && deptConfig.headOfDepartment === employee.id) {
                            dept.headOfDepartment = employee;
                            // Set this employee as line manager for all department members
                            dept.employees.forEach(deptEmployee => {
                                if (deptEmployee.id !== employee.id) {
                                    deptEmployee.lineManager = employee.id;
                                }
                            });
                        }
                    }
                });
                
                return { employees, departments };
            } catch (error) {
                console.error('Error loading organization data from Firebase:', error);
                return null;
            }
        }

        async function loadCurrentUserInfoWithOrg(organizationData) {
            // Try to get current user from Firebase auth or localStorage
            const currentUserId = getCurrentUserId();
            const currentUserName = getCurrentUserName();
            
            console.log('Looking for current user:', currentUserName, 'with ID:', currentUserId);
            
            let currentUser = null;
            
            // First try to find by ID if available
            if (currentUserId && organizationData.employees[currentUserId]) {
                currentUser = organizationData.employees[currentUserId];
                console.log('Found user by ID:', currentUser.fullName);
            } else {
                // Search by name with multiple matching strategies
                const employees = Object.values(organizationData.employees);
                console.log('Searching among', employees.length, 'employees for:', currentUserName);
                
                // Try exact match first
                currentUser = employees.find(emp => 
                    emp.fullName === currentUserName
                );
                
                // Try case-insensitive match
                if (!currentUser) {
                    currentUser = employees.find(emp => 
                        emp.fullName && emp.fullName.toLowerCase() === currentUserName.toLowerCase()
                    );
                }
                
                // Try partial name matches (first name, last name)
                if (!currentUser) {
                    const nameparts = currentUserName.toLowerCase().split(' ');
                    currentUser = employees.find(emp => {
                        if (!emp.fullName) return false;
                        const empNameparts = emp.fullName.toLowerCase().split(' ');
                        return nameparts.some(part => empNameparts.includes(part)) && 
                               empNameparts.some(part => nameparts.includes(part));
                    });
                }
                
                // Try email match
                if (!currentUser) {
                    const userEmail = localStorage.getItem('userEmail');
                    if (userEmail) {
                        currentUser = employees.find(emp => 
                            emp.email && emp.email.toLowerCase() === userEmail.toLowerCase()
                        );
                    }
                }
                
                if (currentUser) {
                    console.log('Found user by name matching:', currentUser.fullName);
                } else {
                    console.log('No user found in organizational data for:', currentUserName);
                }
            }
            
            if (currentUser) {
                // Current user section removed from UI
                // document.getElementById('currentUserName').textContent = currentUser.fullName;
                // document.getElementById('currentUserTitle').textContent = currentUser.jobTitle || currentUser.title || 'Employee';
                // document.getElementById('currentUserDepartment').textContent = currentUser.department || 'General';
                
                // Store current user data for other functions
                window.currentOrgUser = currentUser;
                
                // Update localStorage with the correct user information
                localStorage.setItem('userName', currentUser.fullName);
                localStorage.setItem('userJobTitle', currentUser.jobTitle || currentUser.title || 'Employee');
                localStorage.setItem('userDepartment', currentUser.department || 'General');
                if (currentUser.email) {
                    localStorage.setItem('userEmail', currentUser.email);
                }
                
                console.log('Successfully loaded user info for:', currentUser.fullName);
            } else {
                // Fallback: Force display of current authenticated user even if not found in org data
                console.log('User not found in org data, using current user name:', currentUserName);
                // Current user section removed from UI
                // document.getElementById('currentUserName').textContent = currentUserName;
                // document.getElementById('currentUserTitle').textContent = localStorage.getItem('userJobTitle') || 'Employee';
                // document.getElementById('currentUserDepartment').textContent = localStorage.getItem('userDepartment') || 'General';
                
                // Create a basic user object for consistency
                window.currentOrgUser = {
                    fullName: currentUserName,
                    jobTitle: localStorage.getItem('userJobTitle') || 'Employee',
                    department: localStorage.getItem('userDepartment') || 'General',
                    email: localStorage.getItem('userEmail') || ''
                };
            }
        }

        async function loadLineManagerInfoFromOrg(organizationData) {
            const currentUser = window.currentOrgUser;
            
            // First, try to fetch line manager name from the user's own Firebase record
            try {
                const currentUserId = getCurrentUserId();
                
                if (currentUserId) {
                    console.log('Fetching line manager name for user ID:', currentUserId);
                    const lineManagerNameResponse = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/users/${currentUserId}/lineManagerName.json`);
                    
                    if (lineManagerNameResponse.ok) {
                        const lineManagerName = await lineManagerNameResponse.json();
                        
                        if (lineManagerName && lineManagerName.trim()) {
                            console.log('Found line manager name from Firebase:', lineManagerName);
                            
                            // Try to find additional details from org data if available
                            let lineManagerDetails = null;
                            if (organizationData && organizationData.employees) {
                                lineManagerDetails = Object.values(organizationData.employees).find(emp => 
                                    emp.fullName && emp.fullName.toLowerCase() === lineManagerName.toLowerCase()
                                );
                            }
                            
                            const lineManagerData = {
                                fullName: lineManagerName,
                                title: lineManagerDetails?.jobTitle || lineManagerDetails?.title || 'Line Manager',
                                department: lineManagerDetails?.department || currentUser?.department || 'Management',
                                email: lineManagerDetails?.email || `${lineManagerName.toLowerCase().replace(/\s+/g, '.')}@company.com`,
                                phone: lineManagerDetails?.phone || '+1 (555) 123-4567'
                            };
                            
                            displayLineManager(lineManagerData);
                            console.log('Successfully loaded line manager from Firebase:', lineManagerName);
                            return;
                        } else {
                            console.log('Line manager name is empty or null');
                        }
                    } else {
                        console.log('Failed to fetch line manager name, response status:', lineManagerNameResponse.status);
                    }
                } else {
                    console.log('No current user ID available to fetch line manager');
                }
            } catch (error) {
                console.error('Error fetching line manager name from Firebase:', error);
            }
            
            // Fallback: Use org structure to find line manager
            if (currentUser && currentUser.lineManager) {
                const lineManager = organizationData.employees[currentUser.lineManager];
                
                if (lineManager) {
                    displayLineManager({
                        fullName: lineManager.fullName,
                        title: lineManager.jobTitle || lineManager.title || 'Manager',
                        department: lineManager.department || 'Management',
                        email: lineManager.email || 'manager@company.com'
                    });
                    console.log('Loaded line manager from org data:', lineManager.fullName);
                    return;
                }
            }
            
            // Check if current user is in a department with a head of department
            if (currentUser && currentUser.department) {
                const userDepartment = organizationData.departments.get(currentUser.department);
                
                if (userDepartment && userDepartment.headOfDepartment && 
                    userDepartment.headOfDepartment.id !== currentUser.id) {
                    const hod = userDepartment.headOfDepartment;
                    displayLineManager({
                        fullName: hod.fullName,
                        title: hod.jobTitle || hod.title || 'Head of Department',
                        department: hod.department || 'Management',
                        email: hod.email || 'hod@company.com'
                    });
                    console.log('Loaded department head as line manager:', hod.fullName);
                    return;
                }
            }
            
            // No line manager found
            console.log('No line manager found for current user');
            displayNoLineManager();
        }

        function displayNoLineManager() {
            document.getElementById('lineManagerCard').style.display = 'none';
            const noLineManagerState = document.getElementById('noLineManagerState');
            if (noLineManagerState) {
                noLineManagerState.style.display = 'block';
            }
        }

        async function loadDirectReportsFromOrg(organizationData) {
            // Get current user ID from authentication system
            const currentUserId = getCurrentUserId();
            const currentUserName = getCurrentUserName();
            
            console.log('loadDirectReportsFromOrg called with currentUserId:', currentUserId, 'currentUserName:', currentUserName);
            
            if (!currentUserId) {
                console.warn('No current user ID found');
                displayNoDirectReports();
                return;
            }
            
            console.log('Looking for direct reports for user ID:', currentUserId, 'Name:', currentUserName);
            
            let directReports = [];
            
            try {
                // Use proper Firebase database reference - same logic as users.js
                console.log('Attempting direct Firebase query for direct reports...');
                const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js');
                const db = getDatabase();
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                
                if (usersSnapshot.exists()) {
                    console.log('Users snapshot exists, checking for direct reports...');
                    usersSnapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        console.log(`Checking user ${user.firstName} ${user.lastName}, lineManager: ${user.lineManager}, currentUserId: ${currentUserId}`);
                        
                        // Check if this user's line manager ID matches current user ID
                        if (user.lineManager === currentUserId) {
                            const directReport = {
                                id: childSnapshot.key,
                                uid: childSnapshot.key,
                                name: `${user.firstName || ''} ${user.lastName || ''}`.trim(),
                                fullName: `${user.firstName || ''} ${user.lastName || ''}`.trim(),
                                email: user.email || '',
                                jobTitle: user.jobTitle || '',
                                title: user.jobTitle || '',
                                department: user.department || '',
                                phone: user.phone || '',
                                phoneNumber: user.phone || '',
                                status: user.status || 'active',
                                ...user
                            };
                            directReports.push(directReport);
                            console.log('Found direct report:', directReport.name);
                        }
                    });
                } else {
                    console.warn('No users found in Firebase database');
                }
                
                console.log(`Found ${directReports.length} direct reports from direct Firebase query`);
            } catch (error) {
                console.error('Error fetching direct reports:', error);
                displayNoDirectReports();
                return;
            }
            
            if (directReports.length > 0) {
                console.log('Displaying direct reports:', directReports);
                displayDirectReportsFromOrg(directReports);
            } else {
                console.log('No direct reports found');
                displayNoDirectReports();
            }
            
            // Update report count
            const reportCountElement = document.getElementById('reportCount');
            if (reportCountElement) {
                reportCountElement.textContent = 
                    `${directReports.length} report${directReports.length !== 1 ? 's' : ''}`;
            }
        }

        function displayDirectReportsFromOrg(reports) {
            const reportsTableBody = document.getElementById('reportsTableBody');
            const reportsTableContainer = document.getElementById('reportsTableContainer');
            
            reportsTableBody.innerHTML = reports.map(report => `
                <tr>
                    <td class="user-name-cell">${report.fullName || 'N/A'}</td>
                    <td class="user-email-cell">${report.email || 'No email provided'}</td>
                    <td class="user-title-cell">${report.jobTitle || report.title || 'Employee'}</td>
                    <td class="user-phone-cell">${report.phoneNumber || report.phone || 'No phone provided'}</td>
                    <td class="user-department-cell">${report.department || 'General'}</td>
                    <td>
                        <span class="status-badge-table status-active-table">
                            <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                            Active
                        </span>
                    </td>
                </tr>
            `).join('');
            
            reportsTableContainer.style.display = 'block';
            document.getElementById('noReportsState').style.display = 'none';
        }

        function displayNoDirectReports() {
            document.getElementById('reportsTableContainer').style.display = 'none';
            document.getElementById('noReportsState').style.display = 'block';
        }

        function getCurrentUserId() {
            // Try to get user ID from various sources
            const authUser = window.authManager?.getUser();
            const userId = authUser?.uid || 
                   authUser?.id ||
                   localStorage.getItem('userId') || 
                   localStorage.getItem('currentUserId') || 
                   sessionStorage.getItem('userId') ||
                   '1qmwygW1NZOyEDQeZdxjWnIa7pV2'; // Your specific user ID for testing
            
            console.log('🔍 getCurrentUserId returning:', userId);
            return userId;
        }

        function getCompanyId() {
            // Try to get company ID from current user data
            const authUser = window.authManager?.currentUser;
            return authUser?.companyId || 
                   localStorage.getItem('companyId') || 
                   sessionStorage.getItem('companyId') ||
                   '-OVdOmV_CnbwZ0d7JrkB'; // Your specific company ID
        }

        function loadCurrentUserInfo() {
            // Get current user info from localStorage 
            const currentUserName = getCurrentUserName(); // This will now return the authenticated user's name
            const currentUserTitle = localStorage.getItem('userJobTitle') || 'Employee';
            const currentUserDepartment = localStorage.getItem('userDepartment') || 'General';
            
            // Current user section removed from UI
            // document.getElementById('currentUserName').textContent = currentUserName;
            // document.getElementById('currentUserTitle').textContent = currentUserTitle;
            // document.getElementById('currentUserDepartment').textContent = currentUserDepartment;
            
            console.log('Loaded current user info (fallback):', currentUserName);
        }

        async function loadLineManagerInfo() {
            try {
                // Get current user ID
                const currentUserId = getCurrentUserId();
                const companyId = getCompanyId();
                
                console.log(`🔍 Loading line manager info for user: ${currentUserId} in company: ${companyId}`);
                
                if (!currentUserId) {
                    console.warn('No current user ID found for line manager lookup');
                    showNoLineManagerState();
                    return;
                }

                // Ensure we have the database reference
                const database = window.firebase?.database();
                if (!database) {
                    console.error('Firebase database not available');
                    showNoLineManagerState();
                    return;
                }

                // Get current user data from Firebase to find their line manager
                const currentUserPath = `companies/${companyId}/users/${currentUserId}`;
                console.log(`🔍 Fetching user data from: ${currentUserPath}`);
                
                const currentUserRef = database.ref(currentUserPath);
                const currentUserSnapshot = await currentUserRef.once('value');
                const currentUserData = currentUserSnapshot.val();

                console.log('📊 Current user data:', currentUserData);

                if (currentUserData && currentUserData.lineManager) {
                    // We have the line manager name, now try to find their details
                    const lineManagerName = currentUserData.lineManager;
                    const lineManagerId = currentUserData.lineManagerId;

                    console.log(`📋 Current user's line manager: ${lineManagerName} (ID: ${lineManagerId})`);

                    // Try to get detailed line manager info using the ID if available
                    if (lineManagerId) {
                        const lineManagerPath = `companies/${companyId}/users/${lineManagerId}`;
                        console.log(`🔍 Fetching line manager details from: ${lineManagerPath}`);
                        
                        const lineManagerRef = database.ref(lineManagerPath);
                        const lineManagerSnapshot = await lineManagerRef.once('value');
                        const lineManagerData = lineManagerSnapshot.val();

                        console.log('📊 Line manager detailed data:', lineManagerData);

                        if (lineManagerData) {
                            displayLineManager({
                                name: lineManagerData.name || lineManagerName,
                                title: lineManagerData.jobTitle || 'Manager',
                                department: lineManagerData.department || 'Management',
                                email: lineManagerData.email || 'manager@company.com'
                            });
                            return;
                        }
                    }

                    // Fallback: display with just the name we have
                    console.log(`📋 Using fallback display for line manager: ${lineManagerName}`);
                    displayLineManager({
                        name: lineManagerName,
                        title: 'Manager',
                        department: 'Management',
                        email: 'manager@company.com'
                    });
                } else {
                    // No line manager assigned
                    console.log('No line manager assigned to current user');
                    console.log('No line manager assigned to current user');
                    showNoLineManagerState();
                }
            } catch (error) {
                console.error('Error loading line manager info:', error);
                showNoLineManagerState();
            }
        }

        function showNoLineManagerState() {
            document.getElementById('lineManagerCard').style.display = 'none';
            document.getElementById('noLineManagerState').style.display = 'block';
        }

        // Test function to debug Firebase connection
        async function testFirebaseConnection() {
            console.log('🧪 Testing Firebase connection...');
            
            try {
                const database = window.firebase?.database();
                if (!database) {
                    console.error('❌ Firebase database not available');
                    return;
                }
                
                const userId = '1qmwygW1NZOyEDQeZdxjWnIa7pV2';
                const companyId = '-OVdOmV_CnbwZ0d7JrkB';
                const testPath = `companies/${companyId}/users/${userId}`;
                
                console.log(`🔍 Testing path: ${testPath}`);
                
                const testRef = database.ref(testPath);
                const snapshot = await testRef.once('value');
                const data = snapshot.val();
                
                console.log('📊 Test data retrieved:', data);
                
                // Current user section removed from UI
                // Display current user information
                if (data) {
                    console.log('👤 Current user data found');
                    // document.getElementById('currentUserName').textContent = data.name || 'Unknown User';
                    // document.getElementById('currentUserTitle').textContent = data.jobTitle || data.title || 'Employee';
                    // document.getElementById('currentUserDepartment').textContent = data.department || 'General';
                    console.log(`👤 Current user data: ${data.name} - ${data.jobTitle} - ${data.department}`);
                } else {
                    console.log('❌ No current user data found');
                }
                
                if (data && data.lineManager) {
                    console.log(`✅ Line manager found: ${data.lineManager}`);
                    const lineManagerId = data.lineManagerId;
                    
                    // If we have the line manager ID, fetch their detailed information
                    if (lineManagerId) {
                        console.log(`🔍 Fetching line manager details for ID: ${lineManagerId}`);
                        const lineManagerPath = `companies/${companyId}/users/${lineManagerId}`;
                        const lineManagerRef = database.ref(lineManagerPath);
                        const lineManagerSnapshot = await lineManagerRef.once('value');
                        const lineManagerData = lineManagerSnapshot.val();
                        
                        console.log('📊 Line manager detailed data:', lineManagerData);
                        
                        if (lineManagerData) {
                            // Display detailed line manager information
                            document.getElementById('lineManagerName').textContent = lineManagerData.name || data.lineManager;
                            document.getElementById('lineManagerTitle').textContent = lineManagerData.jobTitle || lineManagerData.title || 'Manager';
                            document.getElementById('lineManagerDepartment').textContent = lineManagerData.department || 'Management';
                            document.getElementById('lineManagerEmail').textContent = lineManagerData.email || 'No email available';
                            document.getElementById('lineManagerPhone').textContent = lineManagerData.phone || lineManagerData.phoneNumber || 'No phone available';
                            
                            console.log(`✅ Displayed: ${lineManagerData.name} - ${lineManagerData.jobTitle} - ${lineManagerData.email} - ${lineManagerData.phone || lineManagerData.phoneNumber || 'No phone'}`);
                        } else {
                            // Fallback to just the name
                            document.getElementById('lineManagerName').textContent = data.lineManager;
                            document.getElementById('lineManagerTitle').textContent = 'Manager';
                            document.getElementById('lineManagerDepartment').textContent = 'Management';
                            document.getElementById('lineManagerEmail').textContent = 'No email available';
                            document.getElementById('lineManagerPhone').textContent = 'No phone available';
                            
                            console.log(`⚠️ Using fallback display for: ${data.lineManager}`);
                        }
                    } else {
                        // No line manager ID, just display the name
                        document.getElementById('lineManagerName').textContent = data.lineManager;
                        document.getElementById('lineManagerTitle').textContent = 'Manager';
                        document.getElementById('lineManagerDepartment').textContent = 'Management';
                        document.getElementById('lineManagerEmail').textContent = 'No email available';
                        document.getElementById('lineManagerPhone').textContent = 'No phone available';
                        
                        console.log(`⚠️ No line manager ID found, displaying name only: ${data.lineManager}`);
                    }
                    
                    // Show the line manager card
                    document.getElementById('lineManagerCard').style.display = 'flex';
                    document.getElementById('noLineManagerState').style.display = 'none';
                } else {
                    console.log('❌ No line manager data found');
                }
                
            } catch (error) {
                console.error('❌ Firebase test failed:', error);
            }
        }

        // Make test function available globally for debugging
        window.testFirebaseConnection = testFirebaseConnection;

        // Test function to debug direct reports
        async function testDirectReports() {
            console.log('🧪 Testing direct reports...');
            
            try {
                const database = window.firebase?.database();
                if (!database) {
                    console.error('❌ Firebase database not available');
                    return;
                }
                
                const currentUserId = '1qmwygW1NZOyEDQeZdxjWnIa7pV2';
                const companyId = '-OVdOmV_CnbwZ0d7JrkB';
                const usersPath = `companies/${companyId}/users`;
                
                console.log(`🔍 Testing direct reports for user: ${currentUserId}`);
                console.log(`🔍 Fetching all users from: ${usersPath}`);
                
                const usersRef = database.ref(usersPath);
                const usersSnapshot = await usersRef.once('value');
                const allUsers = usersSnapshot.val();
                
                console.log('📊 All users in company:', allUsers);
                
                let directReports = [];
                
                if (allUsers) {
                    Object.keys(allUsers).forEach(userId => {
                        const user = allUsers[userId];
                        console.log(`👤 Checking user: ${user.name} (ID: ${userId}), lineManagerId: ${user.lineManagerId}`);
                        
                        if (user.lineManagerId === currentUserId) {
                            directReports.push({
                                name: user.name,
                                email: user.email,
                                jobTitle: user.jobTitle,
                                department: user.department,
                                phone: user.phone || user.phoneNumber || 'No phone provided'
                            });
                            console.log(`✅ Found direct report: ${user.name} - ${user.email} - ${user.phone || user.phoneNumber || 'No phone'}`);
                        }
                    });
                }
                
                console.log(`📊 Total direct reports found: ${directReports.length}`, directReports);
                
                // Update the report count
                const reportCountElement = document.getElementById('reportCount');
                if (reportCountElement) {
                    reportCountElement.textContent = `${directReports.length} report${directReports.length !== 1 ? 's' : ''}`;
                }
                
                if (directReports.length > 0) {
                    // Manually populate the table
                    const tableBody = document.getElementById('reportsTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = directReports.map(report => `
                            <tr>
                                <td class="user-name-cell">${report.name || 'Unknown'}</td>
                                <td class="user-email-cell">${report.email || 'No email'}</td>
                                <td class="user-title-cell">${report.jobTitle || 'Employee'}</td>
                                <td class="user-phone-cell">${report.phone || 'No phone provided'}</td>
                                <td class="user-department-cell">${report.department || 'General'}</td>
                                <td>
                                    <span class="status-badge-table status-active-table">
                                        <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                                        Active
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                        
                        document.getElementById('reportsTableContainer').style.display = 'block';
                        document.getElementById('noReportsState').style.display = 'none';
                    }
                } else {
                    document.getElementById('reportsTableContainer').style.display = 'none';
                    document.getElementById('noReportsState').style.display = 'block';
                }
                
            } catch (error) {
                console.error('❌ Direct reports test failed:', error);
            }
        }

        // Make test functions available globally for debugging
        window.testDirectReports = testDirectReports;

        function displayLineManager(lineManagerData) {
            console.log('Displaying line manager:', lineManagerData);
            
            document.getElementById('lineManagerName').textContent = lineManagerData.name || lineManagerData.fullName || 'Unknown';
            document.getElementById('lineManagerTitle').textContent = lineManagerData.title || lineManagerData.jobTitle || 'Manager';
            document.getElementById('lineManagerDepartment').textContent = lineManagerData.department || 'Management';
            document.getElementById('lineManagerEmail').textContent = lineManagerData.email || 'manager@company.com';
            document.getElementById('lineManagerPhone').textContent = lineManagerData.phone || lineManagerData.phoneNumber || '+1 (555) 123-4567';
            
            document.getElementById('lineManagerCard').style.display = 'flex';
            document.getElementById('noLineManagerState').style.display = 'none';
        }

        async function loadDirectReports() {
            // Get current user ID for proper direct reports lookup
            const currentUserId = getCurrentUserId();
            const companyId = getCompanyId();
            
            console.log('🔍 Loading direct reports for user:', currentUserId, 'in company:', companyId);
            
            if (!currentUserId) {
                console.warn('No current user ID found for direct reports');
                displayNoDirectReports();
                return;
            }
            
            try {
                // Ensure we have the database reference
                const database = window.firebase?.database();
                if (!database) {
                    console.error('Firebase database not available for direct reports');
                    displayNoDirectReports();
                    return;
                }
                
                let directReports = [];
                
                // Query all users in the company to find direct reports
                const usersPath = `companies/${companyId}/users`;
                console.log(`🔍 Fetching all users from: ${usersPath}`);
                
                const usersRef = database.ref(usersPath);
                const usersSnapshot = await usersRef.once('value');
                const allUsers = usersSnapshot.val();
                
                console.log('📊 All users data:', allUsers);
                
                if (allUsers) {
                    // Check each user to see if they report to the current user
                    Object.keys(allUsers).forEach(userId => {
                        const user = allUsers[userId];
                        
                        // Check if this user's line manager ID matches current user ID
                        if (user.lineManagerId === currentUserId) {
                            const directReport = {
                                id: userId,
                                uid: userId,
                                name: user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim(),
                                fullName: user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim(),
                                email: user.email || '',
                                jobTitle: user.jobTitle || user.title || '',
                                title: user.jobTitle || user.title || '',
                                department: user.department || '',
                                phone: user.phone || user.phoneNumber || '',
                                phoneNumber: user.phone || user.phoneNumber || '',
                                status: user.status || 'active'
                            };
                            directReports.push(directReport);
                            console.log('👥 Found direct report:', directReport.name, '- Email:', directReport.email);
                        }
                    });
                }
                
                console.log(`📊 Total direct reports found: ${directReports.length}`);
                
                if (directReports.length > 0) {
                    displayDirectReports(directReports);
                } else {
                    displayNoDirectReports();
                }
                
            } catch (error) {
                console.error('❌ Error loading direct reports:', error);
                displayNoDirectReports();
            }
        }

        async function getSampleDirectReports() {
            // Sample data - in a real app, this would come from Firebase
            const currentUserName = localStorage.getItem('userName') || 'Current User';
            
            // Only show reports if user is in a management role
            const userJobTitle = localStorage.getItem('userJobTitle') || '';
            const isManager = userJobTitle.toLowerCase().includes('manager') || 
                            userJobTitle.toLowerCase().includes('supervisor') || 
                            userJobTitle.toLowerCase().includes('lead') ||
                            userJobTitle.toLowerCase().includes('director');
            
            if (!isManager) {
                return [];
            }
            
            return [
                {
                    id: 'emp1',
                    name: 'John Smith',
                    title: 'Software Engineer',
                    department: 'Engineering',
                    email: 'john.smith@company.com'
                },
                {
                    id: 'emp2',
                    name: 'Sarah Johnson',
                    title: 'Data Analyst',
                    department: 'Analytics',
                    email: 'sarah.johnson@company.com'
                },
                {
                    id: 'emp3',
                    name: 'Mike Davis',
                    title: 'QA Engineer',
                    department: 'Quality Assurance',
                    email: 'mike.davis@company.com'
                }
            ];
        }

        function displayDirectReports(reports) {
            const reportsTableBody = document.getElementById('reportsTableBody');
            const reportsTableContainer = document.getElementById('reportsTableContainer');
            
            reportsTableBody.innerHTML = reports.map(report => `
                <tr>
                    <td class="user-name-cell">${report.name || report.fullName || 'N/A'}</td>
                    <td class="user-email-cell">${report.email || 'No email provided'}</td>
                    <td class="user-title-cell">${report.title || report.jobTitle || 'Employee'}</td>
                    <td class="user-phone-cell">${report.phone || report.phoneNumber || 'No phone provided'}</td>
                    <td class="user-department-cell">${report.department || 'General'}</td>
                    <td>
                        <span class="status-badge-table status-active-table">
                            <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                            Active
                        </span>
                    </td>
                </tr>
            `).join('');
            
            reportsTableContainer.style.display = 'block';
            document.getElementById('noReportsState').style.display = 'none';
        }

        // ============================================
        // FEATURE-BASED MENU AUTHORIZATION SYSTEM
        // ============================================
        // Enhanced menu visibility system based on roles.html template
        
        // Reset all menu items to hidden
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
            
            console.log('🔧 Basic menu fallback completed - only home visible');
        }

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            console.log('🎯 Starting feature-based menu authorization for account.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                } else {
                    console.log('❌ No authenticated user found');
                    showBasicMenu();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    showBasicMenu();
                    return;
                }
                
                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId);
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                showBasicMenu();
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    showBasicMenu();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    showBasicMenu();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    showBasicMenu();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('🔐 All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('🎯 Authorized features for account.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu authorization completed for account.html - ${visibleCount} items visible`);
                
                // Finalize sidebar visibility (prune and remove loading class)
                showSidebarAfterAuth();
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                showBasicMenu();
            }
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

        // Feature-based authorization system that takes priority over role permissions
        // (Implementation aligned with `accessdaily.html` for consistent behavior)
        // Prevent multiple simultaneous executions
        if (!window.isMenuUpdateInProgress) window.isMenuUpdateInProgress = false;

        async function updateMenuWithFeatureAuthorization() {
            if (window.isMenuUpdateInProgress) {
                console.log('🔄 Menu update already in progress, skipping...');
                return;
            }
            window.isMenuUpdateInProgress = true;
            console.log('🎯 Starting feature-based menu authorization for account.html...');
            try {
                let currentUser = null;
                let companyId = null;
                let userRole = null;

                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company and role');
                }

                // If no companyId, search companies to locate user
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company and role...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                                console.log(`✅ Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
                                break;
                            }
                        }
                    }
                }

                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    window.isMenuUpdateInProgress = false;
                    return;
                }

                // STEP 1: Feature-based visibility
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                // STEP 2: Role filtering
                if (userRole) {
                    await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                } else {
                    console.log('⚠️ No user role found, skipping role-based filtering');
                    showSidebarAfterAuth();
                }
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            } finally {
                window.isMenuUpdateInProgress = false;
            }
        }

        // Apply role-based filtering within company authorized features
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log('👤 Applying role-based filtering for role:', userRole);
                const database = window.db || firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                if (!permissionsSnapshot.exists()) {
                    console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
                    if (userRole === 'administrator') {
                        console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                        showSidebarAfterAuth();
                        return;
                    }
                    console.log('❌ No valid permissions found - filtering out items requiring permissions');
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                const permissions = permissionsSnapshot.val();
                console.log('✅ Loaded role permissions:', permissions);
                filterMenuByPermissions(permissions);
            } catch (error) {
                console.error('❌ Error applying role-based filtering:', error);
                showSidebarAfterAuth();
            }
        }

        function filterMenuByPermissions(permissions) {
            console.log('🔍 Filtering visible menu items by role permissions...');
            if (!permissions) {
                console.log('⚠️ No permissions object provided');
                hideItemsRequiringPermissions();
                showSidebarAfterAuth();
                return;
            }
            const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            console.log(`🎯 Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
            let hiddenCount = 0;
            visibleMenuItems.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const feature = item.getAttribute('data-feature');
                if (requiresPermission) {
                    const hasPermission = permissions[requiresPermission];
                    const hasViewPermission = hasPermission === true || (hasPermission && hasPermission.view === true);
                    if (!hasViewPermission) {
                        item.classList.remove('menu-visible');
                        hiddenCount++;
                        console.log(`❌ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
                    } else {
                        console.log(`✅ Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
                    }
                }
            });
            // Re-check dropdown menus after permission filtering
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const dropdownFeature = dropdown.getAttribute('data-feature');
                if (submenuItems.length === 0) {
                    dropdown.classList.remove('menu-visible');
                    console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
                } else {
                    console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
                }
            });
            console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
            showSidebarAfterAuth();
        }

        function hideItemsRequiringPermissions() {
            console.log('🔒 Hiding all menu items that require permissions...');
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            let hiddenCount = 0;
            itemsRequiringPermissions.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                item.classList.remove('menu-visible');
                hiddenCount++;
                console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
            });
            console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
        }

        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                // Prune any non-visible items left behind, then remove loading state
                try { pruneSidebarMenu(); } catch (e) { console.warn('Prune failed', e); }
                sidebar.classList.remove('menu-loading');
                console.log('✅ Sidebar loading state removed - menu authorization complete');
            }
        }

        // 🧪 COMPREHENSIVE SUBMIT TIMESHEET TEST FUNCTION
        window.testSubmitTimesheetFlow = async function() {
            console.log('🧪 === TESTING SUBMIT TIMESHEET FLOW ===');
            
            try {
                // Step 1: Check user and company info
                const currentUser = getCurrentUserName();
                const companyId = getCompanyId();
                console.log('👤 Current User:', currentUser);
                console.log('🏢 Company ID:', companyId);
                
                if (!currentUser || !companyId) {
                    console.error('❌ Missing user or company information');
                    return false;
                }
                
                // Step 2: Create a test timesheet
                console.log('📋 Creating test timesheet...');
                const testTimesheet = {
                    id: 'test_submit_' + Date.now(),
                    period: 'Weekly',
                    monthYear: '2025-08',
                    totalHours: 40.0,
                    status: 'draft',
                    submittedBy: currentUser,
                    createdDate: new Date().toISOString(),
                    entries: [
                        { date: '2025-08-18', hours: 8, description: 'Test work day 1' },
                        { date: '2025-08-19', hours: 8, description: 'Test work day 2' },
                        { date: '2025-08-20', hours: 8, description: 'Test work day 3' },
                        { date: '2025-08-21', hours: 8, description: 'Test work day 4' },
                        { date: '2025-08-22', hours: 8, description: 'Test work day 5' }
                    ]
                };
                
                // Step 3: Save the test timesheet to local array first
                timesheets.push(testTimesheet);
                console.log('✅ Test timesheet added to local array');
                
                // Step 4: Save to Firebase using the regular save function
                console.log('💾 Saving test timesheet to Firebase...');
                const saved = await saveTimesheetToFirebase(testTimesheet);
                if (!saved) {
                    console.error('❌ Failed to save test timesheet to Firebase');
                    return false;
                }
                console.log('✅ Test timesheet saved to Firebase');
                
                // Step 5: Now submit the timesheet
                console.log('📤 Submitting test timesheet...');
                testTimesheet.status = 'submitted';
                testTimesheet.submittedDate = new Date().toISOString();
                
                const submitSaved = await saveTimesheetToFirebase(testTimesheet);
                if (!submitSaved) {
                    console.error('❌ Failed to submit test timesheet to Firebase');
                    return false;
                }
                console.log('✅ Test timesheet submitted to Firebase');
                
                // Step 6: Reload timesheets from Firebase to verify
                console.log('🔄 Reloading timesheets from Firebase...');
                await loadTimesheets();
                
                // Step 7: Check if the submitted timesheet appears
                const foundTimesheet = timesheets.find(t => t.id === testTimesheet.id);
                if (foundTimesheet) {
                    console.log('✅ Test timesheet found after reload:', foundTimesheet.status);
                    if (foundTimesheet.status === 'submitted') {
                        console.log('🎉 SUCCESS: Submit timesheet flow works correctly!');
                        console.log('📊 Refreshing display...');
                        displayTimesheets();
                        return true;
                    } else {
                        console.error('❌ Timesheet status is not "submitted":', foundTimesheet.status);
                        return false;
                    }
                } else {
                    console.error('❌ Test timesheet not found after reload');
                    return false;
                }
                
            } catch (error) {
                console.error('💥 Error in submit timesheet test:', error);
                return false;
            }
        };

        // 🔍 FIREBASE DATA INSPECTION FUNCTION
        window.inspectFirebaseData = async function() {
            console.log('🔍 === INSPECTING FIREBASE DATA ===');
            
            const currentUser = getCurrentUserName();
            const companyId = getCompanyId();
            
            // Check user's timesheets
            const userUrl = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/timesheets/${currentUser}.json`;
            console.log('🔗 User timesheets URL:', userUrl);
            
            try {
                const userResponse = await fetch(userUrl);
                const userData = await userResponse.json();
                console.log('👤 Current user timesheets in Firebase:', userData);
                
                // Check all company timesheets
                const companyUrl = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/timesheets.json`;
                console.log('🔗 All company timesheets URL:', companyUrl);
                
                const companyResponse = await fetch(companyUrl);
                const companyData = await companyResponse.json();
                console.log('🏢 All company timesheets in Firebase:', companyData);
                
                if (companyData) {
                    let totalSubmitted = 0;
                    Object.keys(companyData).forEach(userId => {
                        const userTimesheets = companyData[userId];
                        if (userTimesheets) {
                            Object.keys(userTimesheets).forEach(timesheetId => {
                                const timesheet = userTimesheets[timesheetId];
                                if (timesheet.status === 'submitted') {
                                    totalSubmitted++;
                                    console.log(`📋 Submitted timesheet found: ${timesheetId} by ${timesheet.submittedBy || userId}`);
                                }
                            });
                        }
                    });
                    console.log(`📊 Total submitted timesheets in Firebase: ${totalSubmitted}`);
                } else {
                    console.log('❌ No company timesheets found in Firebase');
                }
                
            } catch (error) {
                console.error('💥 Error inspecting Firebase data:', error);
            }
        };

        // 🔒 TEST TIMESHEET VISIBILITY RULES
        window.testTimesheetVisibility = async function() {
            console.log('🔒 === TESTING TIMESHEET VISIBILITY RULES ===');
            
            const currentUser = getCurrentUserName();
            const companyId = getCompanyId();
            
            console.log('👤 Current User:', currentUser);
            console.log('🏢 Company ID:', companyId);
            
            // Test scenarios
            const testScenarios = [
                {
                    name: 'Own Draft Timesheet',
                    timesheet: {
                        id: 'test_own_draft',
                        status: 'draft',
                        submittedBy: currentUser,
                        period: 'Weekly'
                    },
                    expectedVisible: true
                },
                {
                    name: 'Own Submitted Timesheet', 
                    timesheet: {
                        id: 'test_own_submitted',
                        status: 'submitted',
                        submittedBy: currentUser,
                        period: 'Weekly'
                    },
                    expectedVisible: true
                },
                {
                    name: 'Other User Draft Timesheet',
                    timesheet: {
                        id: 'test_other_draft',
                        status: 'draft',
                        submittedBy: 'Other User',
                        period: 'Weekly'
                    },
                    expectedVisible: false
                },
                {
                    name: 'Other User Submitted Timesheet',
                    timesheet: {
                        id: 'test_other_submitted',
                        status: 'submitted',
                        submittedBy: 'Other User',
                        period: 'Weekly'
                    },
                    expectedVisible: 'depends on approver status'
                }
            ];
            
            console.log('🧪 Running visibility tests...');
            
            for (const scenario of testScenarios) {
                console.log(`\n🔍 Testing: ${scenario.name}`);
                console.log('📋 Timesheet:', scenario.timesheet);
                
                const canView = await canUserViewTimesheet(scenario.timesheet);
                console.log(`👁️ Can view: ${canView}`);
                console.log(`✅ Expected: ${scenario.expectedVisible}`);
                
                if (scenario.expectedVisible === true || scenario.expectedVisible === false) {
                    const result = canView === scenario.expectedVisible ? '✅ PASS' : '❌ FAIL';
                    console.log(`🎯 Result: ${result}`);
                } else {
                    console.log(`🎯 Result: Depends on approver configuration`);
                }
            }
            
            // Test approval flow configuration
            console.log('\n🔧 Testing approval flow configuration...');
            const isApprover = await isUserAuthorizedApprover('Test User');
            console.log(`🛡️ Is authorized approver: ${isApprover}`);
            
            console.log('\n🔒 Visibility testing completed!');
        };

        // 🛡️ TEST APPROVAL FLOW CONFIGURATION
        window.testApprovalFlowConfig = async function() {
            console.log('🛡️ === TESTING APPROVAL FLOW CONFIGURATION ===');
            
            const companyId = getCompanyId();
            console.log('🏢 Company ID:', companyId);
            
            try {
                // Try to fetch approval flow
                const response = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/approvalFlows/timesheet.json`);
                
                if (response.ok) {
                    const approvalFlow = await response.json();
                    console.log('📋 Approval Flow Configuration:', approvalFlow);
                    
                    if (approvalFlow && approvalFlow.selectedRoles) {
                        console.log('✅ Approval flow is configured');
                        
                        // Show each level
                        Object.entries(approvalFlow.selectedRoles).forEach(([level, approvers]) => {
                            console.log(`📊 Level ${level}:`, approvers);
                        });
                        
                        // Test if current user is an approver
                        const isApprover = checkApproverPermission(approvalFlow, getCurrentUserName(), 'Test User');
                        console.log(`🛡️ Current user is approver: ${isApprover}`);
                        
                    } else {
                        console.log('⚠️ No approval flow configured - using basic permissions');
                    }
                } else {
                    console.error('❌ Failed to fetch approval flow:', response.status);
                }
                
            } catch (error) {
                console.error('💥 Error testing approval flow:', error);
            }
        };
    </script>
</body>
</html>
