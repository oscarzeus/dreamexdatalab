<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Screening - Dreamex Datalab HSE</title>
    
    <style>
        /* Font Awesome Icons - Embedded subset */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
        
        /* Embedded CSS from styles.css */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --transition-speed: 0.2s;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Menu Visibility Styles */
        /* Force hide all menu items by default until permissions are loaded */
        #roleBasedMenu li[data-feature],
        #roleBasedMenu .menu-dropdown {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            transition: none !important;
        }

        /* Show menu items when they have proper visibility class */
        #roleBasedMenu li[data-feature].menu-visible,
        #roleBasedMenu .menu-dropdown.menu-visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Ensure submenu items follow parent visibility */
        #roleBasedMenu .menu-dropdown:not(.menu-visible) li {
            display: none !important;
        }

        #roleBasedMenu .menu-dropdown.menu-visible li {
            display: block !important;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        .content {
            width: 100%;
            margin: 0;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: relative;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: #f8f9fa;
            border-radius: 0;
        }

        .header-company-logo {
            width: 60px;
            height: 60px;
            border-radius: 0;
            object-fit: cover;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 0;
            background: #f8f9fa;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
            border: none;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f5f5f5;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .text-muted {
            color: #6c757d !important;
        }

        .job-screen-container {
            padding: 2rem 0;
            width: 100%;
            margin: 0;
            max-width: none;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.25rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 2rem;
            margin: 0 2rem 2rem 2rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin: 0;
            padding: 0;
            border: none;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .stat-number {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Professional stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 0 2rem 1.5rem 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .stat-card .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            line-height: 1;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .stat-card div:last-child {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            line-height: 1.2;
        }

        .controls-section {
            /* Removed background, padding, border-radius, and box-shadow to eliminate box appearance */
            margin-bottom: 2rem;
            width: 100%;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .filter-select, .search-input {
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .filter-select:focus, .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .view-toggles {
            display: flex;
            gap: 0.5rem;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .toggle-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        .table-container {
            background: white;
            border-radius: 0;
            box-shadow: 0 16px 48px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            margin: 0;
            transition: box-shadow 0.3s ease;
        }

        .table-container:hover {
            box-shadow: 0 20px 60px rgba(0,0,0,0.25), 0 12px 32px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.12);
        }

        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .jobs-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dynamic table header colors based on active tab */
        .tab-content.active .jobs-table th {
            color: #ffffff;
        }

        /* Jobs tab - Green headers */
        #jobsTabContent.active .jobs-table th {
            background: #28a745;
        }

        /* Applicants tab - Yellow headers */
        #applicantsTabContent.active .applicants-table th {
            background: #ffc107;
            color: #ffffff;
        }

        /* Archives tab - Red headers */
        #archivesTabContent.active .jobs-table th {
            background: #dc3545;
        }

        .jobs-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .jobs-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            font-size: 0.9rem;
            color: #495057;
        }

        .jobs-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .jobs-table tbody tr {
            transition: all 0.2s ease;
        }

        .job-title-cell {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .job-code {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 0;
            font-size: 0.8rem;
            color: #495057;
            font-weight: 500;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-paused {
            background: #d1ecf1;
            color: #0c5460;
        }

        .urgency-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .urgency-critical {
            background: #dc3545;
            color: white;
            animation: pulse 2s infinite;
        }

        .urgency-high {
            background: #fd7e14;
            color: white;
        }

        .urgency-medium {
            background: #ffc107;
            color: #212529;
        }

        .urgency-normal, .urgency-low {
            background: #28a745;
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .employment-type {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 0;
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }

        .salary-range {
            font-weight: 500;
            color: #28a745;
            font-size: 0.9rem;
        }

        .applications-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .count-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }        .btn-edit {
            background: #ffc107;
            color: #212529;
        }        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-close {
            background: #dc3545;
            color: white;
        }

        .btn-close:hover {
            background: #c82333;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination-info {
            margin: 0 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .jobs-table {
                font-size: 0.8rem;
            }
            
            .jobs-table th,
            .jobs-table td {
                padding: 0.75rem;
            }
        }

        @media (max-width: 1024px) {
            .stats-cards {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            
            .job-screen-container {
                padding: 0.75rem 0;
            }

            .page-header {
                margin: 0 0.75rem 2rem 0.75rem;
            }

            .controls-section {
                margin: 0 0.75rem 2rem 0.75rem;
            }

            .content-tabs {
                margin: 0 0.75rem;
                width: calc(100% - 1.5rem);
            }

            .stats-cards {
                margin: 0 0.75rem 1.5rem 0.75rem;
            }
        }

        @media (max-width: 768px) {
            .job-screen-container {
                padding: 1rem 0;
            }

            .stats-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .actions-row {
                flex-direction: column;
                align-items: stretch;
            }

            .table-container {
                overflow-x: auto;
            }

            .jobs-table {
                min-width: 800px;
            }

            .page-header {
                margin: 0 1rem 2rem 1rem;
                padding: 1rem;
            }

            .stats-cards {
                margin: 0 1rem 1.5rem 1rem;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .controls-section {
                margin: 0 1rem 2rem 1rem;
            }

            .content-tabs {
                margin: 0 1rem;
                width: calc(100% - 2rem);
            }

            .top-nav {
                padding: 0.75rem 1rem;
                border-radius: 0;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 48px;
                height: 48px;
            }

            /* Mobile sidebar toggle behavior */
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .sidebar-toggle-btn {
                display: flex;
            }
        }

        /* Utility classes */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .text-muted {
            color: #6c757d !important;
        }

        .text-center {
            text-align: center;
        }        .d-none {
            display: none !important;
        }        /* Tab Layout Styles */
        .content-tabs {
            margin: 0 2rem;
            width: calc(100% - 4rem);
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .tab-nav-btn:hover {
            color: #28a745;
            background: #f8f9fa;
        }

        /* Default active tab styling (for jobs tab) */
        .tab-nav-btn.active {
            color: #ffffff;
            background: #28a745;
        }

        /* Specific tab colors when active */
        #jobsTabBtn.active {
            color: #ffffff;
            background: #28a745; /* Green for jobs */
        }

        #applicantsTabBtn.active {
            color: #ffffff;
            background: #ffc107; /* Yellow for applicants */
        }

        #archivesTabBtn.active {
            color: #ffffff;
            background: #dc3545; /* Red for archives */
        }

        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-controls {
            margin-bottom: 1.5rem;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid #ced4da;
            border-radius: 0;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .applicant-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .selected-job-info {
            flex: 1;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0;
        }

        .selected-job-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
        }

        .selected-job-details {
            color: #6c757d;
            margin: 0;
            font-size: 0.9rem;
        }

        .jobs-tab {
            flex: 1;
            min-width: 0;
        }

        .applicants-tab {
            flex: 1;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .applicants-tab.active {
            display: block;
        }

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .job-info-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0;
            margin-bottom: 1.5rem;
        }

        .job-info-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
        }

        .job-info-details {
            color: #6c757d;
            margin: 0;
        }

        .applicants-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .applicants-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .applicants-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            font-size: 0.9rem;
            color: #495057;
        }

        .applicants-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .applicants-table tbody tr {
            transition: all 0.2s ease;
        }

        .applicant-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .close-tab-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-tab-btn:hover {
            background: #5a6268;
        }

        .no-applicants {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .no-applicants i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-reviewed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-shortlisted {
            background: #d4edda;
            color: #155724;
        }

        .status-interviewed {
            background: #cce5ff;
            color: #004085;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-hired {
            background: #c3e6cb;
            color: #155724;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .search-export-row,
            .applicant-controls-row {
                flex-direction: column;
            }
            
            .search-wrapper {
                min-width: 100%;
            }
            
            .tab-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-container {
            background: white;
            border-radius: 0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
        }

        .applicant-modal {
            width: 800px;
            max-width: 90vw;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .modal-title {
            margin: 0;
            color: #2c3e50;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: #e9ecef;
            color: #dc3545;
        }

        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .info-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0;
            margin-bottom: 1rem;
        }

        .section-title {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-item label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .info-item span {
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .status-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0;
            font-size: 0.9rem;
            background: white;
        }
    </style>
    
    <!-- EmailJS CDN for job closure notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userProfileImg" src="#" alt="User Avatar" style="display: none;">
                            <div id="userProfilePlaceholder" class="user-initials" style="display: none;"></div>
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">

            <!-- Page Content -->
            <div class="content">
                <!-- Job Screening Content -->
                <div class="job-screen-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-top-row">
                            <div class="header-left">
                                <h1 class="page-title">
                                    <i class="fas fa-table"></i>
                                    Job Screening Dashboard
                                </h1>
                                <p class="page-subtitle">Manage and review all published job openings</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number" id="openJobs">0</div>
                            <div>Open Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="urgentJobs">0</div>
                            <div>Urgent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="draftJobs">0</div>
                            <div>Draft</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalApplicants">0</div>
                            <div>Total Applicants</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgApplications">0</div>
                            <div>Avg. Applications</div>
                        </div>
                    </div>                <!-- Content Tabs Layout -->
                <div class="content-tabs">
                    <!-- Tab Navigation -->                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" id="jobsTabBtn" onclick="switchToTab('jobs')">
                            <i class="fas fa-briefcase"></i>
                            Jobs
                        </button>
                        <button class="tab-nav-btn" id="applicantsTabBtn" onclick="switchToTab('applicants')">
                            <i class="fas fa-users"></i>
                            Applicants
                        </button>
                        <button class="tab-nav-btn" id="archivesTabBtn" onclick="switchToTab('archives')">
                            <i class="fas fa-archive"></i>
                            Archives
                        </button>
                    </div>

                    <!-- Jobs Tab Content -->
                    <div class="tab-content active" id="jobsTabContent">
                        <!-- Jobs Controls -->
                        <div class="tab-controls">
                            <div class="search-export-row">
                                <div class="search-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-input" id="searchInput" placeholder="Search by title, department, or code...">
                                </div>
                                <button class="btn btn-primary" id="exportBtn">
                                    <i class="fas fa-download"></i>
                                    Export Jobs
                                </button>
                            </div>
                        </div>

                        <!-- Hidden filters (keeping functionality) -->
                        <div style="display: none;">
                            <select id="departmentFilter"><option value="">All Departments</option></select>
                            <select id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="closed">Closed</option>
                                <option value="paused">Paused</option>
                            </select>
                            <select id="employmentTypeFilter">
                                <option value="">All Types</option>
                                <option value="full-time">Full Time</option>
                                <option value="part-time">Part Time</option>
                                <option value="contract">Contract</option>
                                <option value="internship">Internship</option>
                                <option value="temporary">Temporary</option>
                            </select>
                            <select id="urgencyFilter">
                                <option value="">All Urgency</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="normal">Normal</option>
                                <option value="low">Low</option>
                            </select>
                            <select id="sortBy">
                                <option value="datePosted">Date Posted</option>
                                <option value="jobTitle">Job Title</option>
                                <option value="department">Department</option>
                                <option value="applications">Applications</option>
                                <option value="urgency">Urgency</option>
                                <option value="status">Status</option>
                            </select>
                        </div>

                        <!-- Jobs Table Container -->
                        <div class="table-container">
                            <!-- Loading State -->
                            <div class="loading-state" id="loadingState">
                                <div class="spinner"></div>
                                <p>Loading job openings...</p>
                            </div>

                            <!-- Jobs Table -->
                            <table class="jobs-table" id="jobsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Job Title</th>
                                        <th>Code</th>
                                        <th>Department</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Urgency</th>
                                        <th>Salary Range</th>
                                        <th>Applications</th>
                                        <th>Posted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <!-- Jobs will be populated here -->
                                </tbody>
                            </table>

                            <!-- Empty State -->
                            <div class="empty-state d-none" id="emptyState">
                                <i class="fas fa-briefcase"></i>
                                <h3>No Jobs Found</h3>
                                <p>No job openings match your current filters.</p>
                                <button class="btn btn-primary" onclick="clearFilters()">
                                    <i class="fas fa-refresh"></i>
                                    Clear Filters
                                </button>
                            </div>

                            <!-- Pagination -->
                            <div class="pagination d-none" id="pagination">
                                <button class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="pagination-info">
                                    <span id="pageInfo">Page 1 of 1</span>
                                </div>
                                <button class="pagination-btn" id="nextPageBtn" onclick="changePage(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Applicants Tab Content -->
                    <div class="tab-content" id="applicantsTabContent">
                        <!-- Applicants Controls -->
                        <div class="tab-controls">
                            <div class="applicant-controls-row">
                                <div class="selected-job-info">
                                    <h3 class="selected-job-title" id="selectedJobTitle">Select a job to view applicants</h3>
                                    <p class="selected-job-details" id="selectedJobDetails"></p>
                                </div>
                                <button class="btn btn-secondary" id="backToJobsBtn" onclick="switchToTab('jobs')">
                                    <i class="fas fa-arrow-left"></i>
                                    Back to Jobs
                                </button>
                            </div>
                        </div>

                        <!-- Applicants Content -->
                        <div class="table-container">
                            <div class="no-applicants" id="noApplicantsMessage">
                                <i class="fas fa-user-friends"></i>
                                <h3>No Job Selected</h3>
                                <p>Select a job from the Jobs tab to view its applicants.</p>
                            </div>

                            <table class="applicants-table" id="applicantsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Applied Date</th>
                                        <th>Status</th>
                                        <th>Resume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="applicantsTableBody">
                                    <!-- Applicants will be populated here -->
                                </tbody>                            </table>
                        </div>
                    </div>

                    <!-- Archives Tab Content -->
                    <div class="tab-content" id="archivesTabContent">
                        <!-- Archives Controls -->
                        <div class="tab-controls">
                            <div class="search-export-row">
                                <div class="search-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-input" id="archiveSearchInput" placeholder="Search archived jobs by title, department, or code...">
                                </div>
                                <div style="display: flex; gap: 1rem;">
                                    <button class="btn btn-success" id="restoreSelectedBtn" onclick="restoreSelectedJobs()" disabled>
                                        <i class="fas fa-undo"></i>
                                        Restore Selected
                                    </button>
                                    <button class="btn btn-primary" id="exportArchivesBtn">
                                        <i class="fas fa-download"></i>
                                        Export Archives
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Archives filters (hidden but functional) -->
                        <div style="display: none;">
                            <select id="archiveDepartmentFilter"><option value="">All Departments</option></select>
                            <select id="archiveEmploymentTypeFilter">
                                <option value="">All Types</option>
                                <option value="full-time">Full Time</option>
                                <option value="part-time">Part Time</option>
                                <option value="contract">Contract</option>
                                <option value="internship">Internship</option>
                                <option value="temporary">Temporary</option>
                            </select>
                            <select id="archiveSortBy">
                                <option value="archivedDate">Date Archived</option>
                                <option value="jobTitle">Job Title</option>
                                <option value="department">Department</option>
                                <option value="datePosted">Original Post Date</option>
                            </select>
                        </div>

                        <!-- Archives Table Container -->
                        <div class="table-container">
                            <!-- Loading State -->
                            <div class="loading-state" id="archiveLoadingState">
                                <div class="spinner"></div>
                                <p>Loading archived jobs...</p>
                            </div>

                            <!-- Archives Table -->
                            <table class="jobs-table" id="archivesTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllArchives" onchange="toggleSelectAllArchives()">
                                        </th>
                                        <th>Job Title</th>
                                        <th>Code</th>
                                        <th>Department</th>
                                        <th>Type</th>
                                        <th>Original Status</th>
                                        <th>Applications</th>
                                        <th>Posted Date</th>
                                        <th>Archived Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="archivesTableBody">
                                    <!-- Archived jobs will be populated here -->
                                </tbody>
                            </table>

                            <!-- Empty Archives State -->
                            <div class="empty-state d-none" id="emptyArchivesState">
                                <i class="fas fa-archive"></i>
                                <h3>No Archived Jobs</h3>
                                <p>No jobs have been archived yet. Jobs are automatically archived when they expire or are manually archived.</p>
                            </div>

                            <!-- Archives Pagination -->
                            <div class="pagination d-none" id="archivesPagination">
                                <button class="pagination-btn" id="archivePrevPageBtn" onclick="changeArchivePage(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="pagination-info">
                                    <span id="archivePageInfo">Page 1 of 1</span>
                                </div>
                                <button class="pagination-btn" id="archiveNextPageBtn" onclick="changeArchivePage(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Applicant Detail Modal -->
    <div class="modal-overlay" id="applicantModalOverlay" style="display: none;">
        <div class="modal-container applicant-modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-user"></i>
                    Applicant Details
                </h2>
                <button class="modal-close" onclick="closeApplicantModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Personal Information -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-user-circle"></i>
                        Personal Information
                    </h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Full Name:</label>
                            <span id="modalFullName">-</span>
                        </div>
                        <div class="info-item">
                            <label>Email:</label>
                            <span id="modalEmail">-</span>
                        </div>
                        <div class="info-item">
                            <label>Phone:</label>
                            <span id="modalPhone">-</span>
                        </div>
                        <div class="info-item">
                            <label>Address:</label>
                            <span id="modalAddress">-</span>
                        </div>
                    </div>
                </div>

                <!-- Professional Information -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-briefcase"></i>
                        Professional Information
                    </h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Current Position:</label>
                            <span id="modalCurrentPosition">-</span>
                        </div>
                        <div class="info-item">
                            <label>Experience:</label>
                            <span id="modalExperience">-</span>
                        </div>
                        <div class="info-item">
                            <label>Expected Salary:</label>
                            <span id="modalExpectedSalary">-</span>
                        </div>
                        <div class="info-item">
                            <label>LinkedIn:</label>
                            <span id="modalLinkedIn">-</span>
                        </div>
                    </div>
                </div>

                <!-- Application Information -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Application Information
                    </h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Applied Date:</label>
                            <span id="modalAppliedDate">-</span>
                        </div>
                        <div class="info-item">
                            <label>Status:</label>
                            <span id="modalStatus" class="status-badge">-</span>
                        </div>
                        <div class="info-item">
                            <label>Available to Start:</label>
                            <span id="modalAvailability">-</span>
                        </div>
                        <div class="info-item">
                            <label>Notice Period:</label>
                            <span id="modalNoticePeriod">-</span>
                        </div>
                    </div>
                </div>

                <!-- Cover Letter -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-envelope"></i>
                        Cover Letter
                    </h3>
                    <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #e9ecef; max-height: 200px; overflow-y: auto;">
                        <div id="modalCoverLetter" style="white-space: pre-wrap; font-size: 0.9rem; line-height: 1.5;">
                            <p class="text-muted">No cover letter provided</p>
                        </div>
                    </div>
                </div>

                <!-- Attachments -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-paperclip"></i>
                        Attachments
                    </h3>
                    <div id="modalAttachments">
                        <p class="text-muted">No attachments</p>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="status-actions">
                    <label>Update Status:</label>
                    <select id="statusSelect" class="status-select">
                        <option value="pending">Pending</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="shortlisted">Shortlisted</option>
                        <option value="interviewed">Interviewed</option>
                        <option value="rejected">Rejected</option>
                        <option value="hired">Hired</option>
                    </select>
                    <button class="btn btn-primary" onclick="updateApplicantStatus()">
                        <i class="fas fa-save"></i>
                        Update Status
                    </button>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="closeApplicantModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>    <!-- Firebase SDK - Keep CDN for standard libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Embedded JavaScript for User Profile and Menu Functionality -->
    <script>
        // Embedded essential functionality from external modules
        
        // User Profile Dropdown functionality (from dashboard.html pattern)
        let profileDropdownInitialized = false;
        
        function initializeUserProfileDropdown() {
            // Prevent multiple initializations
            if (profileDropdownInitialized) {
                console.log('👤 Profile dropdown already initialized, skipping...');
                return;
            }
            
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (!userProfileBtn || !profileDropdown) {
                console.warn('👤 Profile button or dropdown not found');
                return;
            }
            
            console.log('👤 Initializing profile dropdown...');
            
            // Toggle dropdown when profile button is clicked
            userProfileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('👤 Profile button clicked, toggling dropdown');
                profileDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!userProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    if (profileDropdown.classList.contains('show')) {
                        console.log('👤 Closing dropdown (clicked outside)');
                        profileDropdown.classList.remove('show');
                    }
                }
            });
            
            // Logout functionality
            const logoutBtn = document.querySelector('#logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('👤 Logout clicked');
                    // Simple logout - clear storage and redirect
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                });
            }
            
            profileDropdownInitialized = true;
            console.log('✅ Profile dropdown initialized successfully');
        }
        
        // User Profile Photo functionality (from dashboard.html)
        async function initializeUserProfile() {
            try {
                const profileBtn = document.getElementById('userProfileBtn');
                const profileImg = document.getElementById('userProfileImg');
                const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                
                if (!profileBtn || !profileImg || !profilePlaceholder) {
                    console.warn('Profile elements not found');
                    return;
                }
                
                // Get user info from Firebase auth or localStorage
                const user = firebase.auth().currentUser;
                let displayName = 'User';
                
                if (user) {
                    displayName = user.displayName || user.email?.split('@')[0] || 'User';
                } else {
                    // Fallback to localStorage if available
                    displayName = localStorage.getItem('userName') || 'User';
                }
                
                // Preload avatar URL to avoid showing initials first
                const avatarUrl = await getUserAvatarUrl();
                
                // Update profile image - show either real avatar or initials
                if (avatarUrl) {
                    // Show real avatar image
                    profileImg.src = avatarUrl;
                    profileImg.alt = displayName + ' Avatar';
                    profileImg.style.display = 'block';
                    profilePlaceholder.style.display = 'none';
                    console.log('✅ User avatar loaded from Firebase Storage');
                } else {
                    // Show initials avatar
                    profileImg.style.display = 'none';
                    profilePlaceholder.style.display = 'flex';
                    
                    const initials = getUserInitials(displayName);
                    profilePlaceholder.textContent = initials;
                    
                    // Generate a color based on the name for consistency
                    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
                    const colorIndex = displayName.charCodeAt(0) % colors.length;
                    profilePlaceholder.style.backgroundColor = colors[colorIndex];
                    
                    console.log('✅ User initials avatar generated:', initials);
                }
                

                
            } catch (error) {
                console.log('Error initializing user profile:', error);
                // Fallback to default avatar
                const profileImg = document.querySelector('#userProfileBtn img');
                if (profileImg) {
                    generateInitialsAvatar('User', profileImg);
                }
            }
        }
        
        // Get user initials for avatar display (from dashboard.html)
        function getUserInitials(displayName) {
            if (!displayName || displayName === 'User') return 'U';
            
            const words = displayName.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 2).toUpperCase();
            } else {
                return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
            }
        }
        
        // Generate initials avatar (from dashboard.html)
        function generateInitialsAvatar(name, imgElement) {
            if (!imgElement || !name) return;
            
            const initials = getUserInitials(name);
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[name.length % colors.length];
            
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
            imgElement.alt = name + ' Avatar';
        }
        
        // Get user avatar URL or null if not available (from dashboard.html)
        async function getUserAvatarUrl() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) return null;
                
                const storage = firebase.storage();
                const avatarPath = `avatars/${user.uid}/profile.jpg`;
                const avatarRef = storage.ref(avatarPath);
                
                return await avatarRef.getDownloadURL();
            } catch (error) {
                return null;
            }
        }
        
        // Menu visibility management
        function updateMenuVisibility() {
            const menuItems = document.querySelectorAll('#roleBasedMenu [data-feature]');
            
            // Show all menu items by default for job screen (unrestricted access)
            menuItems.forEach(item => {
                item.classList.add('menu-visible');
                item.style.display = 'block';
            });
            
            // Ensure screening menu item is always visible and active
            const screeningItem = document.querySelector('[data-feature="screening_view"]');
            if (screeningItem) {
                screeningItem.classList.add('menu-visible');
                screeningItem.style.display = 'block';
            }
        }
        
        // Notification functionality (simplified)
        function initializeNotifications() {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });
                
                document.addEventListener('click', function(e) {
                    if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                        notificationDropdown.classList.remove('show');
                    }
                });
            }
        }
        
        // Simplified email service placeholder
        let emailService = {
            sendEmail: function(data) {
                console.log('Email service not fully initialized in self-contained mode');
                return Promise.resolve({ success: false, message: 'Email service unavailable' });
            }
        };
        
        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing self-contained jobscreen.html...');
            
            // Set flag to prevent external menu visibility scripts from interfering
            window.jobScreenMenuManaged = true;
            
            // Initialize menu visibility immediately (before auth loads)
            updateMenuVisibilityForJobScreen();
            
            // Initialize UI components
            initializeUserProfileDropdown();
            initializeNotifications();
            
            // Load and initialize job screening functionality
            if (typeof loadJobsFromFirebase === 'function') {
                loadJobsFromFirebase();
            }
            if (typeof setupEventListeners === 'function') {
                setupEventListeners();
            }
            if (typeof setupModalEventListeners === 'function') {
                setupModalEventListeners();
            }
            
            // Ensure jobs tab is properly initialized
            setTimeout(() => {
                console.log('Initializing jobs tab display...');
                switchToTab('jobs');
                
                // Set up a more persistent check for jobs loading
                let jobCheckAttempts = 0;
                const maxJobCheckAttempts = 10;
                
                const checkForJobsInterval = setInterval(() => {
                    jobCheckAttempts++;
                    console.log(`Checking for jobs... attempt ${jobCheckAttempts}/${maxJobCheckAttempts}`, {
                        allJobsCount: allJobs.length,
                        tableVisible: document.getElementById('jobsTable').style.display
                    });
                    
                    if (allJobs.length > 0) {
                        console.log('Jobs found! Ensuring table display...');
                        ensureJobsTableDisplay();
                        clearInterval(checkForJobsInterval);
                    } else if (jobCheckAttempts >= maxJobCheckAttempts) {
                        console.log('Max attempts reached, no jobs to display.');
                        hideLoading();
                        showEmptyState();
                        clearInterval(checkForJobsInterval);
                    }
                }, 500); // Check every 500ms
                
            }, 1000);
            
            console.log('Self-contained jobscreen.html initialized successfully!');
            
            // Override any external menu visibility functions to prevent conflicts
            setTimeout(() => {
                if (window.updateMenuVisibility && typeof window.updateMenuVisibility === 'function') {
                    console.log('🔧 Overriding external updateMenuVisibility function');
                    window.updateMenuVisibility = function() {
                        console.log('📍 External menu visibility call redirected to job screen handler');
                        updateMenuVisibilityForJobScreen();
                    };
                }
            }, 500); // Wait for external scripts to load
        });
    </script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Test Firebase connection
        // Test connection and log status
        firebase.database().ref('.info/connected').on('value', function(snapshot) {
            if (snapshot.val() === true) {
                console.log('✅ Firebase connection: CONNECTED');
            } else {
                console.log('❌ Firebase connection: DISCONNECTED');
            }
        });

        // Job Closure Notification Service Class - Enhanced with EmailJS template_59qelc7
        class JobClosureNotificationService {
            constructor() {
                this.emailServiceUrl = this.getEmailServiceUrl();
                this.apiKey = 'dreemex_hse_email_service_2025';
                
                // EmailJS Configuration for Job Closure Notifications
                this.emailJSConfig = {
                    serviceId: 'service_p2e9swy',
                    templateId: 'template_59qelc7', // Using the specified EmailJS template for job closure
                    publicKey: 'fHs6oaqQgkcPoUwpv'
                };
                
                // Initialize EmailJS
                this.initializeEmailJS();
                
                console.log('📧 JobClosureNotificationService initialized with EmailJS template_59qelc7');
            }

            // Initialize EmailJS for production email delivery
            initializeEmailJS() {
                try {
                    if (typeof emailjs !== 'undefined') {
                        emailjs.init(this.emailJSConfig.publicKey);
                        console.log('✅ EmailJS initialized successfully for job closure notifications');
                        this.emailJSReady = true;
                    } else {
                        console.warn('⚠️ EmailJS library not loaded, falling back to SMTP');
                        this.emailJSReady = false;
                    }
                } catch (error) {
                    console.error('❌ Failed to initialize EmailJS:', error);
                    this.emailJSReady = false;
                }
            }

            // Get email service URL based on environment
            getEmailServiceUrl() {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:3001';
                } else {
                    // Production: use domain with port 3001
                    return `http://${hostname}:3001`;
                }
            }

            // Get submitter and approvers for a position based on position code (similar to jobdetails.html)
            async getPositionRecipients(positionCode, companyId) {
                try {
                    console.log(`📧 ===== RECIPIENT LOOKUP STARTING =====`);
                    console.log(`📧 Looking for position code: "${positionCode}" in company: "${companyId}"`);
                    
                    const database = firebase.database();
                    const recipients = [];

                    // Get position data from staff collection to find submitter and approvers
                    const staffRef = database.ref(`companies/${companyId}/staff`);
                    console.log('📧 Fetching staff data from:', `companies/${companyId}/staff`);
                    
                    const staffSnapshot = await staffRef.once('value');

                    if (!staffSnapshot.exists()) {
                        console.error('❌ No staff data found for company:', companyId);
                        return [];
                    }

                    const allStaff = staffSnapshot.val();
                    console.log('📧 Staff data loaded. Total positions:', Object.keys(allStaff).length);
                    
                    // Debug: Log all available position codes for comparison
                    const staffPositionInfo = Object.entries(allStaff).map(([staffId, staffData]) => ({
                        staffId,
                        jobTitle: staffData.jobTitle,
                        positionCode: staffData.positionCode,
                        jobCode: staffData.jobCode,
                        code: staffData.code
                    }));
                    console.log('📧 Available staff positions:', JSON.stringify(staffPositionInfo, null, 2));
                    
                    // Find the staff position with matching position code
                    let positionFound = false;
                    for (const [staffId, staffData] of Object.entries(allStaff)) {
                        const matchingCodes = [
                            staffData.positionCode,
                            staffData.jobCode,
                            staffData.code
                        ].filter(Boolean);
                        
                        console.log(`📧 Checking staff "${staffData.jobTitle}" with codes:`, matchingCodes);
                        
                        if (matchingCodes.includes(positionCode)) {
                            console.log(`📧 ✅ MATCH FOUND! Position: ${staffData.jobTitle}`);
                            positionFound = true;

                            // Add submitter
                            if (staffData.submittedBy) {
                                console.log(`📧 Processing submitter: ${staffData.submittedBy}`);
                                try {
                                    const submitterInfo = await this.getUserInfo(staffData.submittedBy, companyId);
                                    if (submitterInfo && submitterInfo.email) {
                                        recipients.push({
                                            email: submitterInfo.email,
                                            name: submitterInfo.name || submitterInfo.firstName + ' ' + submitterInfo.lastName || 'Position Submitter',
                                            type: 'submitter',
                                            role: 'Position Submitter'
                                        });
                                        console.log(`📧 ✅ Added submitter: ${submitterInfo.email}`);
                                    } else {
                                        console.warn(`📧 ⚠️ Submitter found but no email: ${staffData.submittedBy}`, submitterInfo);
                                    }
                                } catch (error) {
                                    console.warn(`📧 ⚠️ Could not get submitter info for ${staffData.submittedBy}:`, error.message);
                                }
                            } else {
                                console.warn('📧 ⚠️ No submitter found in position data');
                            }

                            // Add approvers from approval history
                            if (staffData.approvalHistory && Array.isArray(staffData.approvalHistory)) {
                                console.log(`📧 Processing ${staffData.approvalHistory.length} approval entries`);
                                
                                for (const [index, approval] of staffData.approvalHistory.entries()) {
                                    console.log(`📧 Processing approval ${index + 1}:`, approval);
                                    
                                    if (approval.status === 'approved' && approval.approvedBy) {
                                        try {
                                            const approverInfo = await this.getUserInfo(approval.approvedBy, companyId);
                                            if (approverInfo && approverInfo.email) {
                                                // Check for duplicates
                                                const isDuplicate = recipients.some(r => r.email === approverInfo.email);
                                                if (!isDuplicate) {
                                                    recipients.push({
                                                        email: approverInfo.email,
                                                        name: approverInfo.name || approverInfo.firstName + ' ' + approverInfo.lastName || approval.approverName || 'Approver',
                                                        type: 'approver',
                                                        role: approval.level || 'Approver',
                                                        approvedAt: approval.approvedAt
                                                    });
                                                    console.log(`📧 ✅ Added approver: ${approverInfo.email} (${approval.level})`);
                                                } else {
                                                    console.log(`📧 ⚠️ Duplicate approver skipped: ${approverInfo.email}`);
                                                }
                                            } else {
                                                console.warn(`📧 ⚠️ Approver found but no email: ${approval.approvedBy}`, approverInfo);
                                            }
                                        } catch (error) {
                                            console.warn(`📧 ⚠️ Could not get approver info for ${approval.approvedBy}:`, error.message);
                                        }
                                    } else {
                                        console.log(`📧 ⚠️ Skipping approval ${index + 1}: status=${approval.status}, approvedBy=${approval.approvedBy}`);
                                    }
                                }
                            } else {
                                console.warn('📧 ⚠️ No approval history found in position data');
                            }

                            break; // Found the position, no need to continue
                        }
                    }
                    
                    if (!positionFound) {
                        console.error(`📧 ❌ NO MATCH FOUND for position code: "${positionCode}"`);
                        console.error('📧 Available staff positions were:', staffPositionInfo);
                        console.error('📧 Please check if the position code in the job matches any position code in staff.html');
                    }

                    console.log(`📧 ===== RECIPIENT LOOKUP COMPLETE =====`);
                    console.log(`📧 Total recipients found: ${recipients.length}`);
                    if (recipients.length > 0) {
                        console.log('📧 Recipients:', recipients.map(r => `${r.name} (${r.email}) - ${r.type}`));
                    }
                    return recipients;

                } catch (error) {
                    console.error('📧 ❌ Error getting position recipients:', error);
                    return [];
                }
            }

            // Get user information by user ID
            async getUserInfo(userId, companyId) {
                try {
                    const database = firebase.database();
                    
                    // Try to get from company users first
                    const userRef = database.ref(`companies/${companyId}/users/${userId}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (userSnapshot.exists()) {
                        return userSnapshot.val();
                    }

                    // Fallback: try to get from global users
                    const globalUserRef = database.ref(`users/${userId}`);
                    const globalUserSnapshot = await globalUserRef.once('value');
                    
                    if (globalUserSnapshot.exists()) {
                        return globalUserSnapshot.val();
                    }

                    console.warn(`⚠️ User ${userId} not found in company or global users`);
                    return null;

                } catch (error) {
                    console.error(`❌ Error getting user info for ${userId}:`, error);
                    return null;
                }
            }

            // Send job closure notification to all recipients using EmailJS template_59qelc7
            async sendJobClosureNotification(jobData, metadata = {}) {
                try {
                    console.log('📧 Starting job closure notification process with EmailJS template_59qelc7...');

                    // Get recipients (submitter and approvers)
                    const recipients = await this.getPositionRecipients(jobData.positionCode, jobData.companyId);

                    if (recipients.length === 0) {
                        console.warn('⚠️ No recipients found for job closure notification');
                        return {
                            success: false,
                            message: 'No recipients found for notification',
                            recipients: []
                        };
                    }

                    let results = [];
                    let successCount = 0;
                    let failureCount = 0;

                    // Try EmailJS first (Production)
                    if (this.emailJSReady) {
                        console.log('📧 Using EmailJS for production email delivery...');
                        
                        for (const recipient of recipients) {
                            try {
                                // Prepare template parameters for EmailJS template_59qelc7
                                const templateParams = {
                                    // Recipient information
                                    to_name: recipient.name,
                                    to_email: recipient.email,
                                    recipient_type: recipient.type || 'stakeholder',
                                    
                                    // Job details
                                    job_title: jobData.jobTitle,
                                    department: jobData.department || 'Not specified',
                                    position_code: jobData.positionCode || 'N/A',
                                    employment_type: jobData.employmentType || 'Not specified',
                                    work_location: jobData.workLocation || 'Not specified',
                                    published_date: jobData.publishedDate ? new Date(jobData.publishedDate).toLocaleDateString() : 'Not specified',
                                    closed_date: new Date().toLocaleDateString(),
                                    application_deadline: jobData.advertisingClosingDate ? new Date(jobData.advertisingClosingDate).toLocaleDateString() : 'Not specified',
                                    
                                    // Closure information
                                    closure_reason: metadata.closureReason || 'Job position closed',
                                    closure_type: metadata.isAutoClose ? 'Automatic (Deadline Reached)' : 'Manual',
                                    total_applications: jobData.applicationCount || '0',
                                    days_active: this.calculateDaysActive(jobData.publishedDate),
                                    
                                    // Metadata
                                    job_id: metadata.jobId || jobData.jobId || jobData.positionCode || 'N/A',
                                    closed_timestamp: new Date().toLocaleString(),
                                    
                                    // Company information
                                    company_name: 'Dreamex Datalab',
                                    hr_email: 'hr@dreamexdatalab.com',
                                    
                                    // Dynamic content flags
                                    is_submitter: recipient.type === 'submitter',
                                    is_approver: recipient.type === 'approver',
                                    
                                    // Additional context
                                    notification_type: 'job_closure',
                                    system_name: 'Dreamex Datalab HSE System'
                                };

                                console.log(`📧 Sending EmailJS closure notification to ${recipient.name} (${recipient.email})`);

                                // Send via EmailJS
                                const emailResponse = await emailjs.send(
                                    this.emailJSConfig.serviceId,
                                    this.emailJSConfig.templateId,
                                    templateParams
                                );

                                console.log(`✅ EmailJS sent successfully to ${recipient.email}:`, emailResponse.text);
                                
                                results.push({
                                    email: recipient.email,
                                    name: recipient.name,
                                    status: 'sent_emailjs',
                                    messageId: emailResponse.text,
                                    service: 'EmailJS'
                                });
                                successCount++;

                            } catch (error) {
                                console.error(`❌ EmailJS failed for ${recipient.email}:`, error);
                                results.push({
                                    email: recipient.email,
                                    name: recipient.name,
                                    status: 'failed_emailjs',
                                    error: error.message,
                                    service: 'EmailJS'
                                });
                                failureCount++;
                            }
                        }

                        console.log(`📧 EmailJS delivery complete: ${successCount} sent, ${failureCount} failed`);

                        return {
                            success: successCount > 0,
                            service: 'EmailJS',
                            templateId: 'template_59qelc7',
                            totalRecipients: recipients.length,
                            successCount: successCount,
                            failureCount: failureCount,
                            recipients: recipients.map(r => ({ email: r.email, name: r.name, type: r.type })),
                            results: results,
                            message: `Job closure notification sent via EmailJS to ${successCount} of ${recipients.length} recipients`
                        };

                    } else {
                        // Fallback to SMTP email service
                        console.log('📧 EmailJS not available, falling back to SMTP service...');
                        return await this.sendJobClosureNotificationSMTP(jobData, metadata, recipients);
                    }

                } catch (error) {
                    console.error('❌ Error sending job closure notification:', error);
                    return {
                        success: false,
                        error: error.message,
                        message: 'Failed to send job closure notification'
                    };
                }
            }

            // Calculate days active
            calculateDaysActive(publishedDate) {
                if (!publishedDate) return 'Unknown';
                
                const published = new Date(publishedDate);
                const now = new Date();
                const diffTime = Math.abs(now - published);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays.toString();
            }

            // SMTP Fallback method
            async sendJobClosureNotificationSMTP(jobData, metadata, recipients) {
                try {
                    console.log('📧 Using SMTP fallback for job closure email delivery...');

                    // Send notification via SMTP email service
                    const response = await fetch(`${this.emailServiceUrl}/send/job-closure-notification`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': this.apiKey
                        },
                        body: JSON.stringify({
                            recipients: recipients,
                            jobData: {
                                jobTitle: jobData.jobTitle,
                                department: jobData.department,
                                positionCode: jobData.positionCode,
                                employmentType: jobData.employmentType,
                                workLocation: jobData.workLocation,
                                advertisingClosingDate: jobData.advertisingClosingDate,
                                applicationCount: jobData.applicationCount
                            },
                            metadata: {
                                jobId: metadata.jobId,
                                closureReason: metadata.closureReason,
                                isAutoClose: metadata.isAutoClose,
                                closedBy: metadata.closedBy,
                                timestamp: new Date().toISOString()
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Email service responded with status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('📧 SMTP job closure notification result:', result);

                    return {
                        success: result.success,
                        service: 'SMTP',
                        totalRecipients: result.totalRecipients,
                        successCount: result.successCount,
                        failureCount: result.failureCount,
                        recipients: recipients.map(r => ({ email: r.email, name: r.name, type: r.type })),
                        message: `Job closure notification sent via SMTP to ${result.successCount} of ${result.totalRecipients} recipients`
                    };

                } catch (error) {
                    console.error('❌ SMTP fallback failed:', error);
                    throw error;
                }
            }

            // Health check for email service
            async checkEmailServiceHealth() {
                try {
                    const response = await fetch(`${this.emailServiceUrl}/health`, {
                        method: 'GET',
                        headers: {
                            'X-API-Key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const health = await response.json();
                        console.log('📧 Email service health check:', health);
                        return health;
                    } else {
                        console.warn('⚠️ Email service health check failed:', response.status);
                        return { status: 'unhealthy', emailServiceAvailable: false };
                    }
                } catch (error) {
                    console.warn('⚠️ Email service not reachable:', error.message);
                    return { status: 'unreachable', emailServiceAvailable: false };
                }
            }
        }

        // Initialize the Job Closure Notification Service
        const jobClosureNotificationService = new JobClosureNotificationService();

        // Menu activation and role-based visibility
        let menuVisibilityTimeout = null;
        let menuVisibilityInitialized = false;
        
        function updateMenuVisibilityForJobScreen() {
            // Clear any pending updates to debounce rapid calls
            if (menuVisibilityTimeout) {
                clearTimeout(menuVisibilityTimeout);
            }
            
            menuVisibilityTimeout = setTimeout(() => {
                updateMenuVisibilityNow();
            }, 100); // Small delay to batch rapid calls
        }
        
        // Current user identification (same pattern as roles.html and staff.html)
        function getCurrentUser() {
            // First check for 'currentUser' key (used by main login system)
            let user = localStorage.getItem('currentUser');
            if (user) {
                try {
                    return JSON.parse(user);
                } catch (error) {
                    console.warn('🔧 Failed to parse currentUser from localStorage:', error);
                }
            }
            
            // If not found, check for 'user' key (used by index.html modal login)
            user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    // Migrate the user data to the standard 'currentUser' key for consistency
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    return userData;
                } catch (error) {
                    console.warn('🔧 Failed to parse user from localStorage:', error);
                }
            }
            
            return null;
        }
        
        // Load user role permissions from Firebase (same pattern as roles.html and staff.html)
        async function loadUserRolePermissions(userData) {
            if (!userData || !userData.role) {
                console.warn('🔧 No user data or role provided for permission loading');
                return;
            }

            try {
                let roleData = null;
                
                // First try to load from company-scoped roles if company ID is available
                if (userData.companyId) {
                    console.log('🔧 Loading company-scoped role for:', userData.role, 'in company:', userData.companyId);
                    const companyRoleRef = database.ref(`companies/${userData.companyId}/roles/${userData.role}`);
                    const companyRoleSnapshot = await companyRoleRef.once('value');
                    
                    if (companyRoleSnapshot.exists()) {
                        roleData = companyRoleSnapshot.val();
                        console.log('✅ Loaded company-scoped role:', roleData.name || userData.role);
                    }
                }
                
                // Fallback to global roles if company role not found
                if (!roleData) {
                    console.log('🔧 Loading global role for:', userData.role);
                    const globalRoleRef = database.ref(`roles/${userData.role}`);
                    const globalRoleSnapshot = await globalRoleRef.once('value');
                    
                    if (globalRoleSnapshot.exists()) {
                        roleData = globalRoleSnapshot.val();
                        console.log('✅ Loaded global role:', roleData.name || userData.role);
                    }
                }
                
                if (roleData && roleData.permissions) {
                    // Store permissions globally for other components to use
                    window.userPermissions = roleData.permissions;
                    localStorage.setItem('userPermissions', JSON.stringify(roleData.permissions));
                    
                    console.log('✅ Role permissions loaded:', Object.keys(roleData.permissions));
                    
                    // Update menu visibility with the loaded permissions
                    updateMenuVisibilityWithPermissions(roleData.permissions);
                } else {
                    console.warn('⚠️ No role data or permissions found for role:', userData.role);
                    // Show fallback menu for unknown roles
                    showFallbackMenu();
                }
                
            } catch (error) {
                console.error('❌ Error loading user role permissions:', error);
                showFallbackMenu();
            }
        }
        
        // Update menu visibility with specific permissions (extracted from updateMenuVisibilityNow)
        function updateMenuVisibilityWithPermissions(permissions) {
            const menuContainer = document.getElementById('roleBasedMenu');
            const menuItems = document.querySelectorAll('#roleBasedMenu [data-feature]');
            
            if (!menuContainer) {
                console.warn('🔧 Menu container not found');
                return;
            }
            
            console.log('🔧 Updating menu with loaded permissions...', Object.keys(permissions));
            
            // Remove loading state
            menuContainer.classList.remove('menu-loading');
            
            // Reset all menu items first
            menuItems.forEach(item => {
                item.classList.remove('menu-visible');
            });
            
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission})`);
                
                // If item doesn't require permission, show it
                if (!requiresPermission) {
                    item.classList.add('menu-visible');
                    visibleCount++;
                    console.log(`✅ Showing menu item (no permission required): ${feature}`);
                    return;
                }
                
                // If item requires permission, check if user has it
                if (feature && permissions[feature]) {
                    const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                    
                    if (hasViewPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature}`);
                    } else {
                        console.log(`❌ No view permission for: ${feature}`);
                    }
                } else {
                    console.log(`⚪ Feature not found in permissions: ${feature}`);
                }
            });
            
            // Handle parent dropdowns - show if they have visible children
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length > 0) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing parent dropdown (has visible children)`);
                }
            });
            
            console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
            
            // If no items are visible, show at least home and screening as fallback
            if (visibleCount === 0) {
                showFallbackMenu();
            }
            
            menuVisibilityInitialized = true;
            console.log('✅ Menu visibility update completed with role-based permissions');
        }
        
        // Show fallback menu when no permissions are available
        function showFallbackMenu() {
            const homeItem = document.querySelector('[data-feature="home_view"]');
            const screeningItem = document.querySelector('[data-feature="screening_view"]');
            
            if (homeItem) {
                homeItem.classList.add('menu-visible');
                console.log('⚠️ Showing home as fallback');
            }
            if (screeningItem) {
                screeningItem.classList.add('menu-visible');
                console.log('⚠️ Showing screening as fallback');
            }
            
            console.log('⚠️ Fallback menu displayed');
        }
        
        function updateMenuVisibilityNow() {
            const menuContainer = document.getElementById('roleBasedMenu');
            const menuItems = document.querySelectorAll('#roleBasedMenu [data-feature]');
            
            if (!menuContainer) {
                console.warn('🔧 Menu container not found');
                return;
            }
            
            // Get current user and load their role permissions (like roles.html and staff.html)
            const currentUser = getCurrentUser();
            console.log('🔧 Current user loaded:', currentUser?.email || 'No user');
            
            // Try to get permissions from multiple sources
            let permissionsLoaded = false;
            let permissions = {};
            
            if (window.authManager && window.authManager.currentUser && window.authManager.currentUser.permissions) {
                permissions = window.authManager.currentUser.permissions;
                permissionsLoaded = true;
                console.log('🔧 Using permissions from centralized auth:', Object.keys(permissions));
            } else if (window.userPermissions && typeof window.userPermissions === 'object' && Object.keys(window.userPermissions).length > 0) {
                permissions = window.userPermissions;
                permissionsLoaded = true;
                console.log('🔧 Using permissions from global variable:', Object.keys(permissions));
            } else if (localStorage.getItem('userPermissions')) {
                try {
                    const storedPermissions = JSON.parse(localStorage.getItem('userPermissions'));
                    if (storedPermissions && typeof storedPermissions === 'object') {
                        permissions = storedPermissions;
                        permissionsLoaded = true;
                        console.log('🔧 Using permissions from localStorage:', Object.keys(permissions));
                    }
                } catch (error) {
                    console.warn('🔧 Failed to parse stored permissions:', error);
                }
            }
            
            // If no permissions loaded and we have a current user, load role permissions from Firebase
            if (!permissionsLoaded && currentUser && currentUser.role) {
                console.log('🔧 Loading role permissions for user role:', currentUser.role);
                loadUserRolePermissions(currentUser);
                return; // Exit and let the role loading callback handle the menu update
            }
            
            console.log('🔧 Updating menu visibility for job screen...', {
                initialized: menuVisibilityInitialized,
                permissionsLoaded: permissionsLoaded,
                permissionKeys: Object.keys(permissions)
            });
            
            // Remove loading state
            menuContainer.classList.remove('menu-loading');
            
            // Reset all menu items first
            menuItems.forEach(item => {
                item.classList.remove('menu-visible');
            });
            
            let visibleCount = 0;
            
            // If permissions aren't loaded yet, show basic navigation items as fallback
            if (!permissionsLoaded) {
                console.log('⚠️ Permissions not loaded yet, showing basic navigation items as fallback');
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    
                    // Show basic navigation items that should always be available
                    if (feature === 'home_view' || feature === 'screening_view') {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing basic menu item: ${feature}`);
                    }
                    // Also show items that don't require permissions
                    else if (!requiresPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item (no permission required): ${feature}`);
                    }
                });
                
                console.log(`🎯 Basic menu visibility completed - ${visibleCount} items visible (permissions not loaded)`);
                return;
            }
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission})`);
                
                // If item doesn't require permission, show it
                if (!requiresPermission) {
                    item.classList.add('menu-visible');
                    visibleCount++;
                    console.log(`✅ Showing menu item (no permission required): ${feature}`);
                    return;
                }
                
                // If item requires permission, check if user has it
                if (feature && permissions[feature]) {
                    const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                    
                    if (hasViewPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature}`);
                    } else {
                        console.log(`❌ No view permission for: ${feature}`);
                    }
                } else {
                    console.log(`⚪ Feature not found in permissions: ${feature}`);
                }
            });
            
            // Handle parent dropdowns - show if they have visible children
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length > 0) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing parent dropdown (has visible children)`);
                }
            });
            
            console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
            
            // If no items are visible, show at least home and screening as fallback for job screen
            if (visibleCount === 0) {
                const homeItem = document.querySelector('[data-feature="home_view"]');
                const screeningItem = document.querySelector('[data-feature="screening_view"]');
                
                if (homeItem) {
                    homeItem.classList.add('menu-visible');
                    console.log('⚠️ No permissions found - showing home as fallback');
                }
                if (screeningItem) {
                    screeningItem.classList.add('menu-visible');
                    console.log('⚠️ No permissions found - showing screening as fallback');
                }
            }
            
            menuVisibilityInitialized = true;
            console.log('✅ Menu visibility update completed with proper permission structure');
        }

        // Utility function to manually refresh menu visibility (useful for debugging)
        function refreshMenuVisibility() {
            console.log('🔄 Manual menu visibility refresh triggered');
            updateMenuVisibilityForJobScreen();
        }
        
        // Make refresh function globally available for debugging
        window.refreshMenuVisibility = refreshMenuVisibility;
        
        // Make role loading function globally available for debugging
        window.loadUserRolePermissions = loadUserRolePermissions;
        window.getCurrentUser = getCurrentUser;
        
        // Function to show debug info about current permissions
        window.debugMenuPermissions = function() {
            console.log('🔍 Menu Permission Debug Info:');
            
            const currentUser = getCurrentUser();
            console.log('Current user:', currentUser);
            console.log('User role:', currentUser?.role);
            console.log('User company:', currentUser?.companyId);
            
            console.log('AuthManager available:', !!window.authManager);
            console.log('AuthManager currentUser:', window.authManager?.currentUser);
            console.log('AuthManager permissions:', window.authManager?.currentUser?.permissions);
            console.log('Global userPermissions:', window.userPermissions);
            console.log('LocalStorage permissions:', localStorage.getItem('userPermissions'));
            
            const menuItems = document.querySelectorAll('#roleBasedMenu [data-feature]');
            console.log(`Total menu items found: ${menuItems.length}`);
            
            const visibleItems = document.querySelectorAll('#roleBasedMenu [data-feature].menu-visible');
            console.log(`Visible menu items: ${visibleItems.length}`);
            
            visibleItems.forEach(item => {
                console.log(`✅ Visible: ${item.getAttribute('data-feature')}`);
            });
            
            // Show submenu items too
            const submenuItems = document.querySelectorAll('#roleBasedMenu .submenu [data-feature]');
            console.log(`Total submenu items found: ${submenuItems.length}`);
            
            const visibleSubmenuItems = document.querySelectorAll('#roleBasedMenu .submenu [data-feature].menu-visible');
            console.log(`Visible submenu items: ${visibleSubmenuItems.length}`);
            
            visibleSubmenuItems.forEach(item => {
                console.log(`✅ Visible submenu: ${item.getAttribute('data-feature')}`);
            });
            
            return {
                currentUser: currentUser,
                authManagerAvailable: !!window.authManager,
                permissions: window.authManager?.currentUser?.permissions || window.userPermissions,
                totalMenuItems: menuItems.length,
                visibleMenuItems: visibleItems.length,
                totalSubmenuItems: submenuItems.length,
                visibleSubmenuItems: visibleSubmenuItems.length
            };
        };

        // Listen for role changes and centralized auth events
        window.addEventListener('userRoleChanged', () => {
            updateMenuVisibilityForJobScreen();
        });
        
        // Listen for centralized auth initialization
        window.addEventListener('authManagerReady', () => {
            console.log('🔐 Centralized AuthManager is ready, updating interface...');
            updateMenuVisibilityForJobScreen();
            // Re-initialize profile with centralized auth
            setTimeout(() => {
                if (window.authManager && window.authManager.currentUser) {
                    const displayName = window.authManager.getUserDisplayName();
                    window.authManager.generateInitialsAvatar(displayName, document.getElementById('userProfilePlaceholder'));
                }
            }, 500);
        });
        
        // Periodic check for permissions until they're loaded
        let permissionCheckInterval = setInterval(() => {
            const hasPermissions = (window.authManager?.currentUser?.permissions && Object.keys(window.authManager.currentUser.permissions).length > 0) ||
                                 (window.userPermissions && Object.keys(window.userPermissions).length > 0) ||
                                 localStorage.getItem('userPermissions');
            
            // Also check if we have a current user with a role that we can load permissions for
            const currentUser = getCurrentUser();
            const hasUserWithRole = currentUser && currentUser.role;
                                 
            if (hasPermissions) {
                console.log('🔐 Permissions detected, updating menu visibility');
                updateMenuVisibilityForJobScreen();
                clearInterval(permissionCheckInterval);
            } else if (hasUserWithRole && !hasPermissions) {
                console.log('🔐 User with role detected but no permissions, loading role permissions');
                loadUserRolePermissions(currentUser);
                // Don't clear interval yet, wait for permissions to load
            } else {
                console.log('⏳ Still waiting for user role or permissions...');
            }
        }, 2000); // Check every 2 seconds
        
        // Clear the interval after 30 seconds to avoid infinite checking
        setTimeout(() => {
            if (permissionCheckInterval) {
                clearInterval(permissionCheckInterval);
                console.log('⏰ Permission check timeout - showing fallback menu');
                updateMenuVisibilityForJobScreen();
            }
        }, 30000);

        // Global variables
        let allJobs = [];
        let filteredJobs = [];
        let currentPage = 1;
        let selectedJobId = null;
        const itemsPerPage = 20;
        const database = firebase.database();
        
        // Job screening page is unrestricted - all users can access it
        const JOB_SCREENING_UNRESTRICTED = true;
        
        // Email service variable is initialized in embedded script above

        // Helper function to get company ID consistently using centralized services
        function getCompanyId() {
            // Try centralized company data service first
            if (window.companyDataService && window.companyDataService.getCurrentCompanyId) {
                const companyId = window.companyDataService.getCurrentCompanyId();
                if (companyId) {
                    console.log('Using company ID from centralized service:', companyId);
                    return companyId;
                }
            }
            
            // Try from auth manager
            if (window.authManager && window.authManager.currentCompany) {
                const companyId = window.authManager.currentCompany.id;
                if (companyId) {
                    console.log('Using company ID from auth manager:', companyId);
                    return companyId;
                }
            }
            
            // Fallback to localStorage
            const storedCompanyId = localStorage.getItem('companyId');
            if (storedCompanyId) {
                console.log('Using company ID from localStorage:', storedCompanyId);
                return storedCompanyId;
            }
            
            // Final fallback to specific company ID for jobscreen
            const specificCompanyId = '-OVdOmV_CnbwZ0d7JrkB';
            console.log('Using fallback company ID for jobscreen:', specificCompanyId);
            return specificCompanyId;
        }

        // Company branding functions
        async function loadCompanyBranding() {
            console.log('🏢 loadCompanyBranding() called');
            
            try {
                const currentUser = getCurrentUser();
                console.log('🏢 currentUser:', currentUser);
                
                if (!currentUser) {
                    console.warn('⚠️ No currentUser available for company branding');
                    showFallbackBranding();
                    return;
                }

                // Check if authManager is available with company data
                if (window.authManager && window.authManager.currentCompany) {
                    console.log('✅ Using company data from authManager');
                    updateCompanyBranding(window.authManager.currentCompany);
                    return;
                }

                // Fallback: load company data from Firebase
                if (typeof firebase !== 'undefined' && firebase.database) {
                    console.log('🔄 Loading company data from Firebase...');
                    const db = firebase.database();
                    const companiesRef = db.ref('companies');
                    
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        console.log('✅ Companies data received:', Object.keys(companies).length, 'companies');
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === currentUser.uid || userId === currentUser.uid || user.email === currentUser.email) {
                                        foundCompany = company;
                                        console.log('✅ Found user in company:', company.companyName, '(ID:', companyId, ')');
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            updateCompanyBranding(foundCompany);
                        } else {
                            console.warn('⚠️ User not found in any active company');
                            showFallbackBranding();
                        }
                    } else {
                        console.warn('⚠️ No companies data found in Firebase');
                        showFallbackBranding();
                    }
                }
            } catch (error) {
                console.error('❌ Error loading company branding:', error);
                showFallbackBranding();
            }
        }

        function updateCompanyBranding(company) {
            console.log('🏢 updateCompanyBranding() called with company:', company);
            
            if (!company) {
                console.warn('⚠️ No company data available for branding');
                showFallbackBranding();
                return;
            }

            // Update page title
            const currentTitle = document.title;
            if (currentTitle.includes('Dreamex Datalab HSE')) {
                document.title = currentTitle.replace('Dreamex Datalab HSE', `${company.companyName} HSE`);
            }

            // Update header branding elements
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerName = document.getElementById('headerCompanyName');

            console.log('🎯 Header elements found:');
            console.log('- headerLogo:', headerLogo ? '✅' : '❌');
            console.log('- headerName:', headerName ? '✅' : '❌');

            // Update company name first
            if (headerName && company.companyName) {
                headerName.textContent = company.companyName;
                console.log('✅ Company name updated in header:', company.companyName);
            }

            // Check if company has a logo (try both 'logo' and 'logoUrl' properties)
            const logoUrl = company.logo || company.logoUrl;
            if (logoUrl && logoUrl.trim() !== '') {
                console.log('🖼️ Company has logo URL:', logoUrl);
                // Show the logo
                if (headerLogo) {
                    headerLogo.src = logoUrl;
                    headerLogo.style.display = 'block';
                    headerLogo.classList.add('visible');
                    console.log('✅ Company logo displayed');
                }
            } else {
                console.log('🏢 No logo URL available');
                // Hide logo if no URL
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    headerLogo.classList.remove('visible');
                    console.log('✅ Company logo hidden (no URL)');
                }
            }

            // Apply company branding colors if available
            if (company.branding) {
                const root = document.documentElement;
                if (company.branding.primaryColor) {
                    root.style.setProperty('--primary-color', company.branding.primaryColor);
                }
                if (company.branding.secondaryColor) {
                    root.style.setProperty('--secondary-color', company.branding.secondaryColor);
                }
            }
        }

        function showFallbackBranding() {
            console.log('🏢 showFallbackBranding() called - clearing branding');
            
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerName = document.getElementById('headerCompanyName');
            
            // Hide logo
            if (headerLogo) {
                headerLogo.style.display = 'none';
                headerLogo.classList.remove('visible');
                headerLogo.src = '';
            }
            
            // Clear company name
            if (headerName) {
                headerName.textContent = '';
            }
        }

        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                
                // Store sidebar state in localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }
        
        function restoreSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (isCollapsed && sidebar && mainContent) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
            }
        }

        // Check if user is authenticated using centralized auth system
        // Integration with centralized authentication
        function checkAuthenticationAndAccess() {
            return new Promise((resolve) => {
                // Wait for centralized auth to be available
                const waitForAuth = () => {
                    if (window.authManager) {
                        console.log('✅ Centralized AuthManager detected, delegating authentication check');
                        
                        // Use centralized auth manager
                        const hasAccess = window.authManager.currentUser !== null;
                        console.log('🔐 Centralized auth result:', hasAccess ? 'Authenticated' : 'Not authenticated');
                        
                        if (hasAccess) {
                            // Load user permissions from centralized auth
                            window.userPermissions = window.authManager.currentUser?.permissions || [];
                            console.log('👤 User permissions loaded:', window.userPermissions);
                        }
                        
                        resolve(hasAccess);
                    } else {
                        // Fallback to Firebase auth check if centralized auth not ready
                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                console.log('✅ User authenticated via Firebase fallback');
                                resolve(true);
                            } else {
                                console.log('ℹ️ User not authenticated, but screening page allows access');
                                // Job screening page allows unrestricted access
                                resolve(true);
                            }
                        });
                    }
                };
                
                // Try immediately, then with delay
                waitForAuth();
                setTimeout(waitForAuth, 1000); // Fallback after 1 second
            });
        }        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[' + new Date().toLocaleTimeString() + '] 🚀 Page loaded, initializing services...');
            
            // Check authentication and allow access (screening page is now unrestricted)
            await checkAuthenticationAndAccess();
            console.log('[' + new Date().toLocaleTimeString() + '] ✅ Access granted to screening page');
            
            // Load company branding
            try {
                console.log('[' + new Date().toLocaleTimeString() + '] 🏢 Loading company branding...');
                await loadCompanyBranding();
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ Company branding loaded');
            } catch (error) {
                console.warn('[' + new Date().toLocaleTimeString() + '] ⚠️ Company branding failed:', error);
            }
            
            // Initialize sidebar toggle
            try {
                console.log('[' + new Date().toLocaleTimeString() + '] 📱 Initializing sidebar toggle...');
                const sidebarToggle = document.querySelector('#sidebarToggle');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', toggleSidebar);
                    console.log('[' + new Date().toLocaleTimeString() + '] ✅ Sidebar toggle initialized');
                }
                
                // Restore previous sidebar state
                restoreSidebarState();
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ Sidebar state restored');
            } catch (error) {
                console.warn('[' + new Date().toLocaleTimeString() + '] ⚠️ Sidebar toggle initialization failed:', error);
            }
            
            // Initialize user profile and avatar when auth state changes
            // Wait for centralized auth to be available
            const initializeProfileWithCentralizedAuth = async () => {
                if (window.authManager && window.authManager.currentUser) {
                    console.log('[' + new Date().toLocaleTimeString() + '] 👤 Using centralized auth for profile initialization...');
                    try {
                        // Use centralized auth manager methods
                        const displayName = window.authManager.getUserDisplayName();
                        const avatarUrl = await window.authManager.getUserAvatarUrl();
                        
                        const profileImg = document.getElementById('userProfileImg');
                        const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                        
                        if (avatarUrl) {
                            profileImg.src = avatarUrl;
                            profileImg.style.display = 'block';
                            profilePlaceholder.style.display = 'none';
                        } else {
                            // Generate initials avatar using centralized auth
                            window.authManager.generateInitialsAvatar(displayName, profilePlaceholder);
                            profileImg.style.display = 'none';
                            profilePlaceholder.style.display = 'flex';
                        }
                        
                        console.log('[' + new Date().toLocaleTimeString() + '] ✅ Profile initialized with centralized auth');
                    } catch (error) {
                        console.warn('[' + new Date().toLocaleTimeString() + '] ⚠️ Centralized auth profile init failed:', error);
                        // Fallback to legacy initialization
                        await initializeUserProfile();
                    }
                } else {
                    // Fallback to Firebase auth
                    firebase.auth().onAuthStateChanged(async (user) => {
                        try {
                            console.log('[' + new Date().toLocaleTimeString() + '] 👤 Auth state changed, initializing user profile...');
                            await initializeUserProfile();
                            console.log('[' + new Date().toLocaleTimeString() + '] ✅ User profile initialized');
                        } catch (error) {
                            console.warn('[' + new Date().toLocaleTimeString() + '] ⚠️ User profile initialization failed:', error);
                            // Fallback: show placeholder with default user
                            const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                            const profileImg = document.getElementById('userProfileImg');
                            if (profilePlaceholder && profileImg) {
                                profileImg.style.display = 'none';
                                profilePlaceholder.style.display = 'flex';
                                profilePlaceholder.textContent = 'U';
                                profilePlaceholder.style.backgroundColor = '#3498db';
                            }
                        }
                    });
                }
            };
            
            // Try centralized auth immediately and with delay
            initializeProfileWithCentralizedAuth();
            setTimeout(initializeProfileWithCentralizedAuth, 2000);
            
            // Also try to initialize immediately as fallback
            setTimeout(async () => {
                const profileImg = document.getElementById('userProfileImg');
                const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                
                // Only initialize if nothing is showing yet
                if (profileImg && profilePlaceholder && 
                    profileImg.style.display === 'none' && 
                    profilePlaceholder.style.display === 'none') {
                    
                    console.log('[' + new Date().toLocaleTimeString() + '] 🔄 Fallback profile initialization...');
                    try {
                        await initializeUserProfile();
                    } catch (error) {
                        console.warn('Fallback profile init failed:', error);
                        // Show default avatar
                        profileImg.style.display = 'none';
                        profilePlaceholder.style.display = 'flex';
                        profilePlaceholder.textContent = 'U';
                        profilePlaceholder.style.backgroundColor = '#3498db';
                    }
                }
            }, 2000); // Wait 2 seconds for auth to settle
            
            // Menu visibility is already initialized in DOMContentLoaded - don't call again here
            
            // Initialize email service (same pattern as access request system)
            try {
                if (typeof EmailNotificationService !== 'undefined') {
                    emailService = new EmailNotificationService();
                    window.emailNotificationService = emailService; // Make available globally
                    console.log('[' + new Date().toLocaleTimeString() + '] ✅ EmailNotificationService initialized successfully');
                } else {
                    console.warn('[' + new Date().toLocaleTimeString() + '] ❌ EmailNotificationService class not available');
                    console.warn('[' + new Date().toLocaleTimeString() + '] 📧 Emails will be queued for external processing');
                }
            } catch (error) {
                console.warn('[' + new Date().toLocaleTimeString() + '] ❌ Failed to initialize EmailNotificationService:', error);
                console.warn('[' + new Date().toLocaleTimeString() + '] 📧 Emails will be queued for external processing');
            }
            
            // Initialize EmailQueueProcessor
            try {
                if (typeof EmailQueueProcessor !== 'undefined') {
                    const emailQueueProcessor = new EmailQueueProcessor();
                    window.emailQueueProcessor = emailQueueProcessor; // Make available globally
                    console.log('[' + new Date().toLocaleTimeString() + '] ✅ EmailQueueProcessor initialized successfully');
                } else {
                    console.warn('[' + new Date().toLocaleTimeString() + '] ❌ EmailQueueProcessor class not available');
                }
            } catch (error) {
                console.warn('[' + new Date().toLocaleTimeString() + '] ❌ Failed to initialize EmailQueueProcessor:', error);
            }
            
            loadJobsFromFirebase();
            setupEventListeners();
            setupModalEventListeners();
            
            // Check email service status for debugging
            setTimeout(() => {
                checkEmailServiceStatus();
            }, 2000); // Give services time to initialize
            
            // Set up periodic check for expired jobs (every 30 minutes)
            setInterval(() => {
                if (allJobs.length > 0) {
                    checkAndAutoCloseExpiredJobs();
                }
            }, 30 * 60 * 1000); // 30 minutes
            
            // Also check when the page becomes visible (user returns to tab)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && allJobs.length > 0) {
                    setTimeout(() => {
                        checkAndAutoCloseExpiredJobs();
                    }, 1000); // Small delay to ensure page is fully active
                }
            });
        });

        // Setup modal event listeners
        function setupModalEventListeners() {
            // Close modal when clicking outside
            document.addEventListener('click', function(event) {
                const modal = document.getElementById('applicantModalOverlay');
                if (event.target === modal) {
                    closeApplicantModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeApplicantModal();
                }
            });
        }        // Setup event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            
            // Filter dropdowns
            document.getElementById('departmentFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('employmentTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('urgencyFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportJobs);
        }        // Diagnostic function to check email service status
        function checkEmailServiceStatus() {
            console.log('[' + new Date().toLocaleTimeString() + '] 📧 Checking email services...');
            
            // Check EmailNotificationService class
            if (typeof EmailNotificationService !== 'undefined') {
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ EmailNotificationService class: AVAILABLE');
            } else {
                console.log('[' + new Date().toLocaleTimeString() + '] ❌ EmailNotificationService class: NOT AVAILABLE');
                console.log('[' + new Date().toLocaleTimeString() + '] 💡 This may be why emails are not being sent!');
            }
            
            // Check EmailQueueProcessor class
            if (typeof EmailQueueProcessor !== 'undefined') {
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ EmailQueueProcessor class: AVAILABLE');
            } else {
                console.log('[' + new Date().toLocaleTimeString() + '] ❌ EmailQueueProcessor class: NOT AVAILABLE');
            }
            
            // Check global instances
            if (window.emailNotificationService) {
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ Global emailNotificationService instance: AVAILABLE');
            } else {
                console.log('[' + new Date().toLocaleTimeString() + '] ⚠️ Global emailNotificationService instance: NOT AVAILABLE');
            }
            
            if (window.emailQueueProcessor) {
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ Global emailQueueProcessor instance: AVAILABLE');
            } else {
                console.log('[' + new Date().toLocaleTimeString() + '] ⚠️ Global emailQueueProcessor instance: NOT AVAILABLE');
            }
            
            // Check local emailService variable
            if (typeof emailService !== 'undefined' && emailService) {
                console.log('[' + new Date().toLocaleTimeString() + '] ✅ Local emailService variable: AVAILABLE');
            } else {
                console.log('[' + new Date().toLocaleTimeString() + '] ⚠️ Local emailService variable: NOT AVAILABLE');
            }
            
            return {
                emailServiceClassAvailable: typeof EmailNotificationService !== 'undefined',
                emailServiceInstanceAvailable: !!emailService,
                emailQueueProcessorClassAvailable: typeof EmailQueueProcessor !== 'undefined',
                globalEmailServiceAvailable: !!window.emailNotificationService,
                globalQueueProcessorAvailable: !!window.emailQueueProcessor,
                timestamp: new Date().toISOString()
            };
        }// Make diagnostic function globally available for debugging
        window.checkEmailServiceStatus = checkEmailServiceStatus;
          // Add Firebase connection test function
        window.testFirebaseConnection = async function() {
            console.log('🔗 Testing Firebase connection...');
            
            try {
                // Check if Firebase is available
                if (typeof firebase === 'undefined') {
                    console.error('❌ Firebase SDK not loaded');
                    return { success: false, error: 'Firebase SDK not loaded' };
                }
                
                if (firebase.apps.length === 0) {
                    console.error('❌ Firebase not initialized');
                    return { success: false, error: 'Firebase not initialized' };
                }
                
                console.log('✅ Firebase SDK loaded and initialized');
                
                // Test database connection
                const db = firebase.database();
                
                // Test server time offset (indicates connection)
                const serverTimeOffset = await db.ref('.info/serverTimeOffset').once('value');
                console.log(`📡 Server time offset: ${serverTimeOffset.val()}ms`);
                
                // Test simple read/write
                const testKey = 'connection_test_' + Date.now();
                const testData = {
                    timestamp: new Date().toISOString(),
                    test: 'connection_verification'
                };
                
                await db.ref(`test/${testKey}`).set(testData);
                console.log('✅ Write test successful');
                
                const readResult = await db.ref(`test/${testKey}`).once('value');
                if (readResult.exists()) {
                    console.log('✅ Read test successful');
                } else {
                    console.error('❌ Read test failed');
                    return { success: false, error: 'Read test failed' };
                }
                
                // Clean up
                await db.ref(`test/${testKey}`).remove();
                console.log('✅ Cleanup successful');
                
                console.log('🎉 Firebase connection test completed successfully');
                return { 
                    success: true, 
                    serverTimeOffset: serverTimeOffset.val(),
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('❌ Firebase connection test failed:', error);
                return { success: false, error: error.message };
            }
        };
          // Add EmailNotificationService initialization test function
        window.initializeEmailService = async function() {
            console.log('📧 Testing EmailNotificationService initialization...');
            
            try {
                if (emailService) {
                    console.log('✅ EmailNotificationService already initialized');
                    console.log('� Service configuration:');
                    console.log(`   SMTP Server: ${emailService.smtpServerUrl}`);
                    console.log(`   Use SMTP: ${emailService.useSmtpService}`);
                    console.log(`   API Key: ${emailService.apiKey}`);
                    return { success: true, service: emailService };                } else if (window.EmailNotificationService) {
                    console.log('⚠️ EmailNotificationService class available, creating new instance...');
                    emailService = new window.EmailNotificationService();
                    console.log('✅ EmailNotificationService initialized successfully');
                    console.log('📋 Service configuration:');
                    console.log(`   SMTP Server: ${emailService.smtpServerUrl}`);
                    console.log(`   Use SMTP: ${emailService.useSmtpService}`);
                    console.log(`   API Key: ${emailService.apiKey}`);
                    return { success: true, service: emailService };
                } else {
                    console.error('❌ EmailNotificationService class not available');
                    console.log('💡 The class should be loaded by the module script');
                    return { success: false, error: 'EmailNotificationService class not available' };
                }
            } catch (error) {
                console.error('❌ Failed to initialize EmailNotificationService:', error);
                return { success: false, error: error.message };
            }
        };
        
        // Test function to verify email notification system
        window.testEmailNotificationSystem = async function() {
            console.log('Testing email notification system...');
            
            try {
                // Check service status
                const status = checkEmailServiceStatus();
                console.log('Service status:', status);
                
                // Test approver fetching
                console.log('Testing approver fetching...');
                const approvers = await fetchRecruitmentApprovers();
                console.log('Found approvers:', approvers);
                
                if (approvers.length === 0) {
                    console.warn('⚠️ No approvers found - this may be why emails are not being sent');
                    return { success: false, reason: 'No approvers configured' };
                }
                
                // Test email queue
                console.log('Testing email queue...');
                const testEmailData = {
                    to: 'test@example.com',
                    subject: 'Test Email - Job Screen Notification',
                    body: 'This is a test email to verify the notification system.',
                    type: 'test-notification',
                    priority: 'normal'
                };
                
                const queueId = await saveEmailNotificationToQueue(testEmailData);
                console.log('Test email queued with ID:', queueId);
                
                return { 
                    success: true, 
                    approverCount: approvers.length,
                    testQueueId: queueId,
                    emailServiceAvailable: status.emailServiceAvailable
                };
                
            } catch (error) {
                console.error('Error testing email notification system:', error);
                return { success: false, error: error.message };
            }
        };        // Load jobs from Firebase (company-scoped)
        function loadJobsFromFirebase() {
            const companyId = getCompanyId();
            
            if (!companyId) {
                console.warn('No company ID found, loading all jobs...');
                // Fallback to loading all jobs if no company ID
                loadAllJobs();
                return;
            }
            
            console.log('Loading jobs for company:', companyId);
            const jobsRef = database.ref(`companies/${companyId}/jobs`);
            
            jobsRef.on('value', (snapshot) => {
                try {
                    const data = snapshot.val();
                    allJobs = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const job = data[key];
                            job.id = key;
                            job.companyId = companyId; // Ensure company ID is set
                            allJobs.push(job);
                        });
                    }
                      console.log('Loaded jobs for company:', allJobs.length);
                    
                    // If no jobs found, show empty state
                    if (allJobs.length === 0) {
                        console.log('No jobs found.');
                        hideLoading();
                        showEmptyState();
                        return;
                    }
                    
                    // Check for expired jobs and auto-close them
                    checkAndAutoCloseExpiredJobs();
                    
                    updateStatistics();
                    updateDepartmentFilter();
                    
                    // Ensure table is properly displayed
                    ensureJobsTableDisplay();
                    
                } catch (error) {
                    console.error('Error loading jobs:', error);
                    hideLoading();
                    showEmptyState();
                }
            }, (error) => {
                console.error('Firebase error:', error);
                hideLoading();
                showEmptyState();
            });
        }

        // Fallback function to load all jobs (for backward compatibility)
        function loadAllJobs() {
            const jobsRef = database.ref('jobs');
            
            jobsRef.on('value', (snapshot) => {
                try {
                    const data = snapshot.val();
                    allJobs = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const job = data[key];
                            job.id = key;
                            allJobs.push(job);
                        });
                    }
                      console.log('Loaded all jobs:', allJobs.length);
                    
                    // Check for expired jobs and auto-close them
                    checkAndAutoCloseExpiredJobs();
                    
                    updateStatistics();
                    updateDepartmentFilter();
                    
                    // Ensure table is properly displayed
                    ensureJobsTableDisplay();
                    
                } catch (error) {
                    console.error('Error loading jobs:', error);
                    hideLoading();
                    showEmptyState();
                }
            }, (error) => {
                console.error('Firebase error:', error);
                hideLoading();
                showEmptyState();
            });
        }

        // Hide loading state and show content
        function hideLoading() {
            const loadingState = document.getElementById('loadingState');
            const jobsTable = document.getElementById('jobsTable');
            
            if (loadingState) {
                loadingState.style.display = 'none';
            }
            
            if (jobsTable) {
                jobsTable.style.display = 'table';
            }
        }

        // Job loading helper functions for debugging
        window.debugJobScreen = function() {
            console.log('Job Screen Debug Info:', {
                allJobs: allJobs.length,
                filteredJobs: filteredJobs.length,
                jobsTableVisible: document.getElementById('jobsTable').style.display,
                loadingStateVisible: document.getElementById('loadingState').style.display,
                activeTab: document.querySelector('.tab-nav-btn.active')?.textContent
            });
        };

        // Function to ensure jobs table is properly displayed
        function ensureJobsTableDisplay() {
            console.log('Ensuring jobs table is properly displayed...');
            console.log('Current state:', {
                allJobsCount: allJobs.length,
                filteredJobsCount: filteredJobs.length
            });
            
            const loadingState = document.getElementById('loadingState');
            const jobsTable = document.getElementById('jobsTable');
            const emptyState = document.getElementById('emptyState');
            
            if (allJobs.length > 0) {
                // Hide loading state
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                
                // Hide empty state
                if (emptyState) {
                    emptyState.classList.add('d-none');
                }
                
                // Show table
                if (jobsTable) {
                    jobsTable.style.display = 'table';
                }
                
                // Apply filters and render immediately
                applyFilters();
                
                // Force a render after a short delay to ensure everything is ready
                setTimeout(() => {
                    renderTable();
                    console.log('Table force-rendered with', filteredJobs.length, 'filtered jobs');
                }, 50);
                
                console.log('Jobs table display ensured with', allJobs.length, 'jobs');
            } else {
                // Show loading state if no jobs yet (Firebase might still be loading)
                if (loadingState) {
                    loadingState.style.display = 'block';
                }
                if (jobsTable) {
                    jobsTable.style.display = 'none';
                }
                if (emptyState) {
                    emptyState.classList.add('d-none');
                }
                console.log('No jobs available, showing loading state');
            }
        }

        // Make function globally available
        window.ensureJobsTableDisplay = ensureJobsTableDisplay;

        // Show empty state
        function showEmptyState() {
            const loadingState = document.getElementById('loadingState');
            const jobsTable = document.getElementById('jobsTable');
            const emptyState = document.getElementById('emptyState');
            
            if (loadingState) {
                loadingState.style.display = 'none';
            }
            
            if (jobsTable) {
                jobsTable.style.display = 'none';
            }
            
            if (emptyState) {
                emptyState.classList.remove('d-none');
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('employmentTypeFilter').value = '';
            document.getElementById('urgencyFilter').value = '';
            document.getElementById('sortBy').value = 'datePosted';
            applyFilters();
        }

        // Change page
        function changePage(direction) {
            const totalPagesCount = Math.ceil(filteredJobs.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPagesCount) {
                currentPage = newPage;
                renderTable();
            }
        }

        // Update statistics
        function updateStatistics() {            const stats = {
                total: allJobs.length,
                active: allJobs.filter(job => job.status === 'active' || job.status === 'published').length,
                totalApplications: allJobs.reduce((sum, job) => {
                    return sum + (job.applicationCount || 0);
                }, 0)
            };

            document.getElementById('totalJobs').textContent = stats.total;
            document.getElementById('activeJobs').textContent = stats.active;
            document.getElementById('totalApplications').textContent = stats.totalApplications;
        }

        // Update department filter options
        function updateDepartmentFilter() {
            const departments = [...new Set(allJobs
                .map(job => job.department)
                .filter(dept => dept && dept.trim() !== '')
            )];
            
            const departmentFilter = document.getElementById('departmentFilter');
            const currentValue = departmentFilter.value;
            
            // Clear existing options except the first one
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            departments.sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });            // Restore previous selection if it still exists
            if (currentValue && departments.includes(currentValue)) {
                departmentFilter.value = currentValue;
            }
        }

        // Apply filters and sorting
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const employmentTypeFilter = document.getElementById('employmentTypeFilter').value;
            const urgencyFilter = document.getElementById('urgencyFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // Filter jobs
            filteredJobs = allJobs.filter(job => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        job.jobTitle || job.position,
                        job.department,
                        job.positionCode,
                        job.description
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }

                // Department filter
                if (departmentFilter && job.department !== departmentFilter) {
                    return false;
                }

                // Status filter - handle both 'published' and 'active' as equivalent
                if (statusFilter) {
                    const jobStatus = (job.status || 'draft').toLowerCase();
                    const filterStatus = statusFilter.toLowerCase();
                    
                    // Treat 'published' and 'active' as equivalent
                    if (filterStatus === 'active') {
                        if (jobStatus !== 'active' && jobStatus !== 'published') {
                            return false;
                        }
                    } else if (jobStatus !== filterStatus) {
                        return false;
                    }
                }

                // Employment type filter
                if (employmentTypeFilter) {
                    const jobType = (job.employmentType || job.jobType || '').toLowerCase();
                    if (jobType !== employmentTypeFilter) {
                        return false;
                    }
                }

                // Urgency filter
                if (urgencyFilter) {
                    const jobUrgency = (job.urgency || 'normal').toLowerCase();
                    if (jobUrgency !== urgencyFilter) {
                        return false;
                    }
                }

                return true;
            });

            // Debug logging
            console.log('Jobs filtering results:', {
                totalJobs: allJobs.length,
                filteredJobs: filteredJobs.length,
                searchTerm,
                statusFilter,
                departmentFilter,
                jobStatuses: allJobs.map(job => ({ title: job.jobTitle || job.position, status: job.status }))
            });

            // Sort jobs
            filteredJobs.sort((a, b) => {
                switch (sortBy) {
                    case 'jobTitle':
                        return (a.jobTitle || a.position || '').localeCompare(b.jobTitle || b.position || '');
                    case 'department':
                        return (a.department || '').localeCompare(b.department || '');
                    case 'applications':
                        return (b.applicationCount || 0) - (a.applicationCount || 0);
                    case 'urgency':
                        const urgencyOrder = { critical: 4, high: 3, medium: 2, normal: 1, low: 0 };
                        return (urgencyOrder[b.urgency] || 1) - (urgencyOrder[a.urgency] || 1);
                    case 'status':
                        return (a.status || 'draft').localeCompare(b.status || 'draft');
                    case 'datePosted':
                    default:
                        const dateA = new Date(a.datePosted || a.postedDate || a.createdDate || a.createdAt || a.timestamp || 0);
                        const dateB = new Date(b.datePosted || b.postedDate || b.createdDate || b.createdAt || b.timestamp || 0);
                        return dateB - dateA;
                }
            });

            // Reset to first page
            currentPage = 1;
            renderTable();
        }

        // Render the jobs table
        function renderTable() {
            const tbody = document.getElementById('jobsTableBody');
            const table = document.getElementById('jobsTable');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');

            if (filteredJobs.length === 0) {
                table.style.display = 'none';
                emptyState.classList.remove('d-none');
                pagination.classList.add('d-none');
                return;
            }

            // Show table and hide empty state
            table.style.display = 'table';
            emptyState.classList.add('d-none');

            // Calculate pagination
            const totalPages = Math.ceil(filteredJobs.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredJobs.length);
            const pageJobs = filteredJobs.slice(startIndex, endIndex);

            // Clear tbody
            tbody.innerHTML = '';

            // Render each job row
            pageJobs.forEach(job => {
                const row = createJobRow(job);
                tbody.appendChild(row);
            });

            // Update pagination
            if (totalPages > 1) {
                pagination.classList.remove('d-none');
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            } else {
                pagination.classList.add('d-none');
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('employmentTypeFilter').value = '';
            document.getElementById('urgencyFilter').value = '';
            document.getElementById('sortBy').value = 'datePosted';
            applyFilters();
        }

        // Change page
        function changePage(direction) {
            const totalPagesCount = Math.ceil(filteredJobs.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPagesCount) {
                currentPage = newPage;
                renderTable();
            }
        }

        // Create a job row
        function createJobRow(job) {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.addEventListener('click', function() {
                loadJobApplicants(job.id);
            });
            
            const jobTitle = job.jobTitle || job.position || 'Untitled Job';
            const positionCode = job.positionCode || job.jobId || job.id || '-';
            const department = job.department || '-';
            const employmentType = formatEmploymentType(job.employmentType || job.jobType);
            const status = job.status || 'draft';
            const urgency = job.urgency || 'normal';
            const salaryRange = formatSalaryRange(job.salaryMin, job.salaryMax);
            const applicationCount = job.applicationCount || 0;
            const postedDate = formatPostedDateTime(job.datePosted || job.postedDate || job.createdDate || job.createdAt || job.timestamp);            row.innerHTML = `
                <td class="job-title-cell">${jobTitle}</td>
                <td><span class="job-code">${positionCode}</span></td>
                <td>${department}</td>
                <td><span class="employment-type">${employmentType}</span></td>
                <td><span class="status-badge status-${status}">${formatStatus(status)}</span></td>
                <td><span class="urgency-badge urgency-${urgency}">${formatUrgency(urgency)}</span></td>
                <td><span class="salary-range">${salaryRange}</span></td>
                <td>
                    <div class="applications-count">
                        <i class="fas fa-users"></i>
                        <span class="count-badge">${applicationCount}</span>
                    </div>
                </td>
                <td class="text-muted">${postedDate}</td>                <td>
                    <div class="action-buttons">
                        <button class="action-btn btn-edit" onclick="event.stopPropagation(); editJob('${job.id}')" title="Edit Job">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-close" onclick="event.stopPropagation(); closeJob('${job.id}')" title="Close Job">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                </td>
            `;

            return row;
        }

        // Formatting helper functions
        function formatEmploymentType(type) {
            const types = {
                'full-time': 'Full Time',
                'part-time': 'Part Time',
                'contract': 'Contract',
                'internship': 'Internship',
                'temporary': 'Temporary'
            };
            return types[type?.toLowerCase()] || type || 'Full Time';
        }

        function formatStatus(status) {            const statuses = {
                'active': 'Active',
                'published': 'Active',
                'closed': 'Closed',
                'paused': 'Paused'
            };
            return statuses[status?.toLowerCase()] || status || 'Draft';
        }

        function formatUrgency(urgency) {
            const urgencies = {
                'critical': 'Critical',
                'high': 'High',
                'medium': 'Medium',
                'normal': 'Normal',
                'low': 'Low'
            };
            return urgencies[urgency?.toLowerCase()] || 'Normal';
        }

        function formatSalaryRange(min, max) {
            if (!min && !max) return '-';
            
            const formatCurrency = (amount) => {
                if (!amount) return '';
                return '$' + parseInt(amount).toLocaleString();
            };

            if (min && max && min !== max) {
                return `${formatCurrency(min)} - ${formatCurrency(max)}`;
            } else if (min) {
                return `From ${formatCurrency(min)}`;
            } else if (max) {
                return `Up to ${formatCurrency(max)}`;
            }
            
            return '-';
        }

        function formatDate(date) {
            if (!date) return '-';
            
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return '-';
                
                const now = new Date();
                const diff = now - d;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));

                if (days === 0) return 'Today';
                if (days === 1) return 'Yesterday';
                if (days < 7) return `${days} days ago`;
                if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
                
                return d.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return '-';
            }
        }

        // Format date with time for posted column display
        function formatPostedDateTime(date) {
            if (!date) return '-';
            
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return '-';
                
                return d.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return '-';
            }
        }

        // Action functions
        function viewJob(jobId) {
            // Open job details in a new tab or modal
            window.open(`jobdetails.html?jobId=${jobId}`, '_blank');
        }

        // Export jobs function
        function exportJobs() {
            if (filteredJobs.length === 0) {
                alert('No jobs to export. Please apply filters or check if jobs are available.');
                return;
            }

            // Create CSV content
            const headers = ['Job Title', 'Position Code', 'Department', 'Employment Type', 'Status', 'Urgency', 'Salary Range', 'Applications', 'Posted Date'];
            const csvContent = [
                headers.join(','),
                ...filteredJobs.map(job => [
                    `"${job.jobTitle || job.position || 'Untitled Job'}"`,
                    `"${job.positionCode || 'N/A'}"`,
                    `"${job.department || 'N/A'}"`,
                    `"${formatEmploymentType(job.employmentType || job.jobType)}"`,
                    `"${formatStatus(job.status || 'draft')}"`,
                    `"${formatUrgency(job.urgency || 'normal')}"`,
                    `"${formatSalaryRange(job.salaryMin, job.salaryMax)}"`,
                    `"${job.applicationCount || 0}"`,
                    `"${formatPostedDateTime(job.datePosted || job.postedDate || job.createdDate || job.createdAt || job.timestamp)}"`
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `jobs_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }        function editJob(jobId) {
            // Navigate to job edit page with edit mode parameter
            window.location.href = `jobdetails.html?jobId=${jobId}&edit=true`;        }function viewApplications(jobId) {
            // Navigate to the job interview page with the specific job filter
            window.location.href = `jobinterview.html?jobId=${jobId}`;
        }        function closeJob(jobId) {
            // Add debug logging at the start
            console.log('🔴 closeJob function called with jobId:', jobId);
            alert('closeJob function triggered! Check console for details.'); // Temporary debug alert
            
            // Simply close job by updating status - no archiving or moving
            console.log('Closing job by updating status to closed...');
            
            const companyId = getCompanyId();
            console.log('🏢 Company ID retrieved:', companyId);
            
            if (!companyId) {
                console.error('Company ID not found');
                alert('Error: Company ID not found. Please try again.');
                return;
            }
            
            // Get job data from company scope
            const jobRef = database.ref(`companies/${companyId}/jobs/${jobId}`);
            console.log('📊 Firebase reference created:', `companies/${companyId}/jobs/${jobId}`);
            
            jobRef.once('value')
                .then((snapshot) => {
                    console.log('📥 Firebase data retrieved:', snapshot.exists(), snapshot.val());
                    
                    if (!snapshot.exists()) {
                        throw new Error('Job not found');
                    }

                    const jobData = snapshot.val();
                    const now = new Date();
                    
                    // Update job status to closed (keep it in the same location)
                    const updates = {
                        status: 'closed',
                        closedDate: now.toISOString(),
                        originalStatus: jobData.status || 'active',
                        closedBy: 'Admin' // You can get this from current user session
                    };

                    console.log('📝 Updating job with:', updates);

                    // Update the job status in place - don't move it
                    return jobRef.update(updates).then(() => {
                        console.log('✅ Job status updated, now sending notification...');
                        // Send notification email to recruitment approvers
                        return sendJobClosureNotification(jobData, jobId);
                    });
                })
                .then(() => {
                    console.log('Job status updated to closed successfully');
                    // Show success message and refresh the table
                    alert('Job has been closed successfully.');
                    
                    // Refresh the jobs list to show updated status
                    loadJobsFromFirebase();
                })
                .catch((error) => {
                    console.error('Error closing job:', error);
                    alert('Error closing job. Please try again.');
                });
        }
          // Send job closure notification to submitters and approvers using EmailJS template_59qelc7
        async function sendJobClosureNotification(jobData, jobId) {
            try {
                console.log('📧 Starting job closure notification process for job:', jobId);
                
                // Get company ID for recipient lookup
                const companyId = getCompanyId();
                if (!companyId) {
                    console.error('❌ Company ID not found');
                    await logJobClosureNotification(jobId, 0, 'Company ID not found');
                    return;
                }

                // Prepare notification data with job information
                const notificationData = {
                    jobId: jobId,
                    jobTitle: jobData.jobTitle || jobData.position || 'Untitled Job',
                    positionCode: jobData.positionCode || jobData.jobCode || jobData.code || 'N/A',
                    department: jobData.department || 'N/A',
                    employmentType: jobData.employmentType || jobData.jobType || 'Full Time',
                    workLocation: jobData.workLocation || jobData.location || 'Not specified',
                    publishedDate: jobData.datePosted || jobData.postedDate || jobData.createdDate || jobData.createdAt || jobData.timestamp,
                    applicationCount: jobData.applicationCount || 0,
                    advertisingClosingDate: jobData.advertisingClosingDate,
                    companyId: companyId
                };
                
                console.log('📊 Raw job data from Firebase:', JSON.stringify(jobData, null, 2));
                console.log('📊 Notification data prepared:', JSON.stringify(notificationData, null, 2));
                console.log('📊 Position code for recipient lookup:', notificationData.positionCode);

                // Prepare metadata for the notification service
                const metadata = {
                    jobId: jobId,
                    closureReason: 'Manually closed by administrator',
                    isAutoClose: false,
                    closedBy: 'Administrator'
                };

                // Send notification using the new JobClosureNotificationService
                const result = await jobClosureNotificationService.sendJobClosureNotification(notificationData, metadata);
                
                console.log('📧 Job closure notification result:', result);

                // Log the notification result
                if (result.success) {
                    await logJobClosureNotification(jobId, result.successCount, 'Success via EmailJS template_59qelc7');
                    console.log(`✅ Job closure notification sent successfully to ${result.successCount} recipients`);
                } else {
                    await logJobClosureNotification(jobId, 0, result.message || 'Failed to send notifications');
                    console.warn('⚠️ Job closure notification failed:', result.message);
                }

            } catch (error) {
                console.error('❌ Error sending job closure notification:', error);
                // Log the failure for audit purposes
                await logJobClosureNotification(jobId, 0, `Error: ${error.message}`);
                // Don't throw error to prevent breaking the job closure process
            }
        }
          // Fetch recruitment approvers from Firebase approval settings
        async function fetchRecruitmentApprovers() {
            try {
                // Fetch the recruitment approval flow from approval settings
                const approvalFlowRef = database.ref('approvalFlows/recruitment');
                const flowSnapshot = await approvalFlowRef.once('value');
                
                if (!flowSnapshot.exists()) {
                    console.warn('No recruitment approval flow configured in approval settings');
                    return [];
                }
                
                const approvalFlow = flowSnapshot.val();
                if (!approvalFlow.enabled) {
                    console.warn('Recruitment approval flow is disabled');
                    return [];
                }
                
                console.log('Found recruitment approval flow:', approvalFlow);
                
                const approvers = [];
                
                // Process each approval level
                if (approvalFlow.levels && Array.isArray(approvalFlow.levels)) {
                    // Load users data for resolving approvers
                    const usersRef = database.ref('users');
                    const usersSnapshot = await usersRef.once('value');
                    const users = usersSnapshot.val() || {};
                    
                    for (const level of approvalFlow.levels) {
                        const levelApprovers = await resolveApprovalsForLevel(level, users, approvalFlow.selectedRoles);
                        approvers.push(...levelApprovers);
                    }
                }
                
                // Remove duplicates and filter valid approvers
                const uniqueApprovers = [];
                const emailSet = new Set();
                
                for (const approver of approvers) {
                    if (approver && 
                        approver.email && 
                        approver.email.trim() !== '' &&
                        !emailSet.has(approver.email.toLowerCase())) {
                        
                        emailSet.add(approver.email.toLowerCase());
                        uniqueApprovers.push(approver);
                    }
                }
                
                console.log(`Found ${uniqueApprovers.length} valid recruitment approvers`);
                return uniqueApprovers;
                
            } catch (error) {
                console.error('Error fetching recruitment approvers:', error);
                return [];
            }
        }
        
        // Resolve approvers for a specific approval level
        async function resolveApprovalsForLevel(level, users, selectedRoles) {
            const approvers = [];
            
            try {
                if (level.approverType === 'name') {
                    // Direct user assignment
                    const userId = level.value?.replace('user_', '');
                    if (userId && users[userId]) {
                        const user = users[userId];
                        approvers.push({
                            id: userId,
                            name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email,
                            email: user.email,
                            role: user.jobTitle || 'Employee',
                            level: level.level,
                            type: 'direct'
                        });
                    }
                } else if (level.approverType === 'function') {
                    // Find users by job title/function
                    const functionId = level.value?.replace('function_', '');
                    if (functionId) {
                        // Find users with this job title
                        Object.keys(users).forEach(userId => {
                            const user = users[userId];
                            if (user.jobTitle && 
                                (user.jobTitle.toLowerCase().includes(functionId.toLowerCase()) ||
                                 functionId.toLowerCase().includes(user.jobTitle.toLowerCase()))) {
                                approvers.push({
                                    id: userId,
                                    name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email,
                                    email: user.email,
                                    role: user.jobTitle,
                                    level: level.level,
                                    type: 'function'
                                });
                            }
                        });
                    }
                } else if (level.approverType === 'level') {
                    // Hierarchical approval (L+1, L+2, etc.)
                    // For recruitment, we might want to find HR managers or department heads
                    // This would require organizational hierarchy data
                    console.log(`Level-based approval (${level.value}) not fully implemented for recruitment`);
                    
                    // As a fallback, find users with HR or Manager roles
                    Object.keys(users).forEach(userId => {
                        const user = users[userId];
                        if (user.jobTitle && 
                            (user.jobTitle.toLowerCase().includes('hr') ||
                             user.jobTitle.toLowerCase().includes('manager') ||
                             user.jobTitle.toLowerCase().includes('head'))) {
                            approvers.push({
                                id: userId,
                                name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email,
                                email: user.email,
                                role: user.jobTitle,
                                level: level.level,
                                type: 'hierarchy'
                            });
                        }
                    });
                }
                
            } catch (error) {
                console.error(`Error resolving approvers for level ${level.level}:`, error);
            }
            
            return approvers;
        }
        
        // Send job closure email to individual approver
        async function sendJobClosureEmailToApprover(approver, jobData) {
            try {
                // Prepare email template data
                const templateData = {
                    approverName: approver.name || approver.fullName || 'Recruitment Approver',
                    approverEmail: approver.email,
                    jobTitle: jobData.jobTitle,
                    positionCode: jobData.positionCode,
                    department: jobData.department,
                    employmentType: jobData.employmentType,
                    workLocation: jobData.workLocation,
                    salaryRange: jobData.salaryMin !== 'Not specified' && jobData.salaryMax !== 'Not specified' 
                        ? `${jobData.salaryMin} - ${jobData.salaryMax}`
                        : 'Not specified',
                    postedDate: jobData.postedDate,
                    closedDate: jobData.closedDate,
                    applicationCount: jobData.applicationCount,
                    closureReason: jobData.closureReason,
                    originalStatus: jobData.originalStatus,
                    systemDate: new Date().toLocaleDateString(),
                    systemTime: new Date().toLocaleTimeString()
                };
                
                // Get email template for job closure
                const emailTemplate = getJobClosureEmailTemplate();
                
                // Replace template variables
                let emailContent = emailTemplate.body;
                let emailSubject = emailTemplate.subject;
                
                Object.keys(templateData).forEach(key => {
                    const placeholder = `{{${key}}}`;
                    emailContent = emailContent.replace(new RegExp(placeholder, 'g'), templateData[key]);
                    emailSubject = emailSubject.replace(new RegExp(placeholder, 'g'), templateData[key]);
                });
                
                // Send email using the mail notification system
                const emailData = {
                    to: approver.email,
                    subject: emailSubject,
                    body: emailContent,
                    type: 'job-closure-notification',
                    priority: 'normal',
                    jobId: jobData.jobId
                };                // Send email using the same email service pattern as mailnotif.html
                try {
                    // Use the emailService variable initialized on DOMContentLoaded (same as mailnotif.html)
                    if (emailService) {
                        const notificationData = {
                            to: approver.email,
                            subject: emailSubject,
                            body: emailContent,
                            type: 'job-closure-notification',
                            priority: 'normal',
                            jobId: jobData.jobId,
                            approverName: approver.name,
                            metadata: {
                                jobTitle: jobData.jobTitle,
                                department: jobData.department,
                                positionCode: jobData.positionCode
                            }
                        };
                        
                        await emailService.sendJobClosureNotification(notificationData);
                        console.log('✅ Email sent via EmailNotificationService to:', approver.email);
                    } else {
                        // Fallback: Save to Firebase queue for external processing
                        console.log('⚠️ EmailNotificationService not available, queuing email for:', approver.email);
                        await saveEmailNotificationToQueue(emailData);
                    }
                } catch (emailError) {
                    console.error('❌ Error sending email via service, falling back to queue:', emailError);
                    // Fallback: Save to Firebase queue
                    await saveEmailNotificationToQueue(emailData);
                }
                
                console.log(`Job closure notification sent to: ${approver.email}`);
                
            } catch (error) {
                console.error(`Error sending job closure notification to ${approver.email}:`, error);
                throw error;
            }
        }
        
        // Get job closure email template
        function getJobClosureEmailTemplate() {
            return {
                subject: 'Job Position Closed - {{jobTitle}} ({{positionCode}})',
                body: `================================================================================
                           DREAMEX DATALAB HR SYSTEM
                        JOB POSITION CLOSURE NOTIFICATION
================================================================================

Dear {{approverName}},

We are writing to inform you that a job position has been closed and is no longer accepting applications.

JOB POSITION DETAILS:
--------------------------------------------------------------------------------
Job Title            : {{jobTitle}}
Position Code        : {{positionCode}}
Department           : {{department}}
Employment Type      : {{employmentType}}
Work Location        : {{workLocation}}
Salary Range         : {{salaryRange}}

CLOSURE INFORMATION:
--------------------------------------------------------------------------------
Posted Date          : {{postedDate}}
Closed Date          : {{closedDate}}
Original Status      : {{originalStatus}}
Closure Reason       : {{closureReason}}
Total Applications   : {{applicationCount}}

NEXT STEPS:
--------------------------------------------------------------------------------
1. All pending applications for this position have been preserved
2. Applicant data has been archived for future reference
3. No new applications will be accepted for this position
4. Existing applicants can still be contacted if needed
5. Position can be restored from Archives if required

RECRUITMENT SUMMARY:
--------------------------------------------------------------------------------
This position received {{applicationCount}} application(s) during its active period.
All applicant information has been securely archived and remains accessible
through the recruitment management system.

IMPORTANT NOTES:
--------------------------------------------------------------------------------
- Applicant data is retained according to company policy
- Position can be reopened if business needs change
- Contact HR team for any questions about this closure
- Review archived applications if similar positions are posted

ACCESS INFORMATION:
--------------------------------------------------------------------------------
To review archived applications or reopen this position:
1. Access the Job Screening Dashboard
2. Navigate to the Archives tab
3. Search for position code: {{positionCode}}
4. Use the restore function if needed

For questions about this job closure or to discuss future recruitment needs,
please contact the HR team.

Best regards,
Dreamex Datalab HR System
Human Resources Management Division

================================================================================
System Information:
Notification sent on: {{systemDate}} at {{systemTime}}
This is an automated notification from the recruitment management system.
For technical support, contact: it-support@dreamexdatalab.com
================================================================================`
            };
        }
          // Save email notification to queue for external processing
        async function saveEmailNotificationToQueue(emailData) {
            try {
                const emailQueueRef = database.ref('emailQueue').push();
                const queueData = {
                    ...emailData,
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    attempts: 0,
                    type: emailData.type || 'job-closure-notification',
                    priority: emailData.priority || 'normal',
                    source: 'jobscreen',
                    metadata: {
                        userAgent: navigator.userAgent,
                        timestamp: Date.now(),
                        ...emailData.metadata
                    }
                };
                
                await emailQueueRef.set(queueData);
                console.log('Email notification queued successfully:', {
                    queueId: emailQueueRef.key,
                    recipient: emailData.to,
                    type: emailData.type,
                    timestamp: queueData.createdAt
                });
                
                return emailQueueRef.key;
            } catch (error) {
                console.error('Error saving email to queue:', error);
                throw error;
            }
        }
          // Log job closure notification for tracking
        async function logJobClosureNotification(jobId, successCount, status = 'sent') {
            try {
                const logRef = database.ref('notificationLogs').push();
                await logRef.set({
                    type: 'job-closure',
                    jobId: jobId,
                    successCount: successCount,
                    timestamp: new Date().toISOString(),
                    status: status,
                    source: 'jobscreen-manual-closure',
                    userAgent: navigator.userAgent
                });
                  console.log('Job closure notification logged:', { jobId, successCount, status });
            } catch (error) {
                console.error('Error logging notification:', error);
            }
        }

        // Auto-close jobs with expired advertising closing dates
        function checkAndAutoCloseExpiredJobs() {
            const currentDate = new Date();
            currentDate.setHours(23, 59, 59, 999); // Set to end of day for comparison
            
            const expiredJobs = allJobs.filter(job => {
                // Only check active jobs that have an advertising closing date
                if (!job.advertisingClosingDate || job.status === 'closed' || job.status === 'archived') {
                    return false;
                }
                
                const closingDate = new Date(job.advertisingClosingDate);
                return closingDate < currentDate;
            });
            
            if (expiredJobs.length > 0) {
                console.log(`Found ${expiredJobs.length} expired jobs to auto-close:`, expiredJobs.map(j => j.jobTitle || j.title));
                
                // Auto-close each expired job
                expiredJobs.forEach(job => {
                    autoCloseExpiredJob(job.id, job.jobTitle || job.title || 'Untitled Job');
                });
            }
        }        // Auto-close a single expired job
        function autoCloseExpiredJob(jobId, jobTitle) {
            const companyId = getCompanyId();
            if (!companyId) {
                console.error('Company ID not found');
                return;
            }
            
            // Get job data first from company scope
            const jobRef = database.ref(`companies/${companyId}/jobs/${jobId}`);
            jobRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        console.warn(`Job ${jobId} not found for auto-closing`);
                        return;
                    }

                    const jobData = snapshot.val();
                    const now = new Date();
                    
                    // Prepare job data for archiving
                    const archivedJobData = {
                        ...jobData,
                        status: 'closed',
                        closedDate: now.toISOString(),
                        archivedDate: now.toISOString(),
                        originalStatus: jobData.status,
                        archiveReason: 'Auto-closed due to expired advertising date',
                        autoClosedReason: 'Advertising closing date expired',
                        autoClosedDate: now.toISOString(),
                        closedBy: 'System (Auto-close)'
                    };

                    // Create atomic update to move job to company jobclosed
                    const updates = {};
                    updates[`companies/${companyId}/jobclosed/${jobId}`] = archivedJobData;
                    updates[`companies/${companyId}/jobs/${jobId}`] = null;

                    return database.ref().update(updates).then(() => {
                        // Send notification email to recruitment approvers for auto-closed jobs
                        return sendJobAutoCloseNotification(jobData, jobId);
                    });
                })
                .then(() => {
                    console.log(`Auto-closed expired job: ${jobTitle} (ID: ${jobId})`);
                    
                    // Show notification to user if they're on the page
                    if (document.visibilityState === 'visible') {
                        showAutoCloseNotification(jobTitle);
                    }
                })
                .catch((error) => {
                    console.error(`Error auto-closing job ${jobId}:`, error);
                });
        }
        
        // Send auto-close notification to submitters and approvers using EmailJS template_59qelc7
        async function sendJobAutoCloseNotification(jobData, jobId) {
            try {
                console.log('📧 Starting job auto-close notification process for job:', jobId);
                
                // Get company ID for recipient lookup
                const companyId = getCompanyId();
                if (!companyId) {
                    console.error('❌ Company ID not found for auto-close notification');
                    await logJobAutoCloseNotification(jobId, 0, 'Company ID not found');
                    return;
                }

                // Prepare notification data with job information
                const notificationData = {
                    jobId: jobId,
                    jobTitle: jobData.jobTitle || jobData.position || 'Untitled Job',
                    positionCode: jobData.positionCode || 'N/A',
                    department: jobData.department || 'N/A',
                    employmentType: jobData.employmentType || jobData.jobType || 'Full Time',
                    workLocation: jobData.workLocation || jobData.location || 'Not specified',
                    publishedDate: jobData.datePosted || jobData.postedDate || jobData.createdDate || jobData.createdAt || jobData.timestamp,
                    applicationCount: jobData.applicationCount || 0,
                    advertisingClosingDate: jobData.advertisingClosingDate,
                    companyId: companyId
                };

                // Prepare metadata for auto-close notification
                const metadata = {
                    jobId: jobId,
                    closureReason: 'Auto-closed due to expired advertising closing date',
                    isAutoClose: true,
                    closedBy: 'System (Auto-close)'
                };

                // Send notification using the new JobClosureNotificationService
                const result = await jobClosureNotificationService.sendJobClosureNotification(notificationData, metadata);
                
                console.log('📧 Job auto-close notification result:', result);

                // Log the notification result
                if (result.success) {
                    await logJobAutoCloseNotification(jobId, result.successCount, 'Success via EmailJS template_59qelc7');
                    console.log(`✅ Job auto-close notification sent successfully to ${result.successCount} recipients`);
                } else {
                    await logJobAutoCloseNotification(jobId, 0, result.message || 'Failed to send auto-close notifications');
                    console.warn('⚠️ Job auto-close notification failed:', result.message);
                }

            } catch (error) {
                console.error('❌ Error sending job auto-close notification:', error);
                // Log the failure for audit purposes
                await logJobAutoCloseNotification(jobId, 0, `Error: ${error.message}`);
                // Don't throw error to prevent breaking the auto-close process
            }
        }
        
        // Send auto-close email to individual approver
        async function sendJobAutoCloseEmailToApprover(approver, jobData) {
            try {
                // Prepare email template data
                const templateData = {
                    approverName: approver.name || approver.fullName || 'Recruitment Approver',
                    approverEmail: approver.email,
                    jobTitle: jobData.jobTitle,
                    positionCode: jobData.positionCode,
                    department: jobData.department,
                    employmentType: jobData.employmentType,
                    workLocation: jobData.workLocation,
                    salaryRange: jobData.salaryMin !== 'Not specified' && jobData.salaryMax !== 'Not specified' 
                        ? `${jobData.salaryMin} - ${jobData.salaryMax}`
                        : 'Not specified',
                    postedDate: jobData.postedDate,
                    closedDate: jobData.closedDate,
                    advertisingClosingDate: jobData.advertisingClosingDate,
                    applicationCount: jobData.applicationCount,
                    closureReason: jobData.closureReason,
                    originalStatus: jobData.originalStatus,
                    systemDate: new Date().toLocaleDateString(),
                    systemTime: new Date().toLocaleTimeString()
                };
                
                // Get email template for job auto-close
                const emailTemplate = getJobAutoCloseEmailTemplate();
                
                // Replace template variables
                let emailContent = emailTemplate.body;
                let emailSubject = emailTemplate.subject;
                
                Object.keys(templateData).forEach(key => {
                    const placeholder = `{{${key}}}`;
                    emailContent = emailContent.replace(new RegExp(placeholder, 'g'), templateData[key]);
                    emailSubject = emailSubject.replace(new RegExp(placeholder, 'g'), templateData[key]);
                });
                  // Send email using the mail notification system
                const emailData = {
                    to: approver.email,
                    subject: emailSubject,
                    body: emailContent,
                    type: 'job-auto-close-notification',
                    priority: 'normal',
                    jobId: jobData.jobId
                };
                  // Try to use EmailNotificationService first, fallback to queue
                try {
                    if (emailService) {
                        const notificationData = {
                            ...emailData,
                            approverName: approver.name,
                            metadata: {
                                jobTitle: jobData.jobTitle,
                                department: jobData.department,
                                positionCode: jobData.positionCode,
                                advertisingClosingDate: jobData.advertisingClosingDate
                            }
                        };
                        
                        await emailService.sendJobClosureNotification(notificationData);
                        console.log('✅ Auto-close email sent via EmailNotificationService to:', approver.email);
                    } else {
                        // Fallback: Save to Firebase for external email processing
                        await saveEmailNotificationToQueue(emailData);
                        console.log('⚠️ Auto-close email queued for external processing:', approver.email);
                    }
                } catch (emailError) {
                    console.error('❌ Error sending auto-close email via service, falling back to queue:', emailError);
                    await saveEmailNotificationToQueue(emailData);
                }
                
                console.log(`Job auto-close notification sent to: ${approver.email}`);
                
            } catch (error) {
                console.error(`Error sending job auto-close notification to ${approver.email}:`, error);
                throw error;
            }
        }
        
        // Get job auto-close email template
        function getJobAutoCloseEmailTemplate() {
            return {
                subject: 'Job Position Auto-Closed - {{jobTitle}} ({{positionCode}})',
                body: `================================================================================
                           DREAMEX DATALAB HR SYSTEM
                     AUTOMATIC JOB POSITION CLOSURE NOTIFICATION
================================================================================

Dear {{approverName}},

This is an automated notification to inform you that a job position has been 
automatically closed due to its advertising closing date expiring.

JOB POSITION DETAILS:
--------------------------------------------------------------------------------
Job Title               : {{jobTitle}}
Position Code           : {{positionCode}}
Department              : {{department}}
Employment Type         : {{employmentType}}
Work Location           : {{workLocation}}
Salary Range            : {{salaryRange}}

AUTOMATIC CLOSURE INFORMATION:
--------------------------------------------------------------------------------
Posted Date             : {{postedDate}}
Advertising Closing Date: {{advertisingClosingDate}}
Auto-Closed Date        : {{closedDate}}
Original Status         : {{originalStatus}}
Closure Reason          : {{closureReason}}
Total Applications      : {{applicationCount}}

SYSTEM ACTION TAKEN:
--------------------------------------------------------------------------------
✓ Job position automatically moved to Archives
✓ Application acceptance stopped immediately
✓ All existing applications preserved and archived
✓ Position status changed to "Closed"
✓ Notification sent to all recruitment approvers

NEXT STEPS AVAILABLE:
--------------------------------------------------------------------------------
1. Review archived applications in the system
2. Restore position if extension is needed
3. Post new position if requirements have changed
4. Contact applicants if interviews are planned
5. Archive review for compliance purposes

RECRUITMENT SUMMARY:
--------------------------------------------------------------------------------
This position received {{applicationCount}} application(s) during its active period.
All applicant information has been automatically archived and remains accessible
through the recruitment management system for your review.

IMPORTANT NOTES:
--------------------------------------------------------------------------------
⚠️  This was an AUTOMATIC closure due to expired advertising date
📋  All applicant data is securely preserved
🔄  Position can be restored if business needs require
📧  Applicants have NOT been notified of closure yet
✅  You can still review and process existing applications

ACCESS ARCHIVED POSITION:
--------------------------------------------------------------------------------
To review archived applications or restore this position:
1. Access the Job Screening Dashboard
2. Navigate to the "Archives" tab
3. Search for position code: {{positionCode}}
4. Use available actions (View, Restore, etc.)

IMMEDIATE ACTIONS RECOMMENDED:
--------------------------------------------------------------------------------
• Review if any existing applications should be processed
• Determine if the position needs to be extended/restored
• Notify qualified applicants about next steps if applicable
• Consider if similar positions should be posted

For questions about this automatic closure or to restore the position,
please access the recruitment management system or contact the HR team.

Best regards,
Dreamex Datalab HR System
Automated Recruitment Management

================================================================================
System Information:
Auto-closure notification sent on: {{systemDate}} at {{systemTime}}
This is an automated system notification - no response required.
For technical support, contact: it-support@dreamexdatalab.com
================================================================================`
            };
        }
          // Log job auto-close notification for tracking
        async function logJobAutoCloseNotification(jobId, successCount, status = 'sent') {
            try {
                const logRef = database.ref('notificationLogs').push();
                await logRef.set({
                    type: 'job-auto-close',
                    jobId: jobId,
                    successCount: successCount,
                    timestamp: new Date().toISOString(),
                    status: status,
                    reason: 'Advertising closing date expired',
                    source: 'jobscreen-auto-closure',
                    userAgent: navigator.userAgent
                });
                  console.log('Job auto-close notification logged:', { jobId, successCount, status });
            } catch (error) {
                console.error('Error logging auto-close notification:', error);
            }
        }

        // Test function for EmailJS template_59qelc7 job closure notifications
        async function testJobClosureNotification() {
            console.log('🧪 Testing EmailJS job closure notification with template_59qelc7...');
            
            try {
                // Sample job data for testing
                const testJobData = {
                    jobId: 'TEST_001',
                    jobTitle: 'Senior Software Engineer',
                    positionCode: 'ENG001', // Make sure this matches a position in staff.html
                    department: 'Information Technology',
                    employmentType: 'Full Time',
                    workLocation: 'Lagos, Nigeria',
                    publishedDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days ago
                    applicationCount: 15,
                    advertisingClosingDate: new Date().toISOString(),
                    companyId: getCompanyId()
                };

                const testMetadata = {
                    jobId: 'TEST_001',
                    closureReason: 'Test notification - Manual closure',
                    isAutoClose: false,
                    closedBy: 'Test Administrator'
                };

                console.log('📧 Sending test job closure notification...');
                const result = await jobClosureNotificationService.sendJobClosureNotification(testJobData, testMetadata);
                
                console.log('📧 Test result:', result);
                
                if (result.success) {
                    alert(`✅ Test job closure notification sent successfully!\n\nSent to ${result.successCount} recipients using EmailJS template_59qelc7.\n\nCheck console for details.`);
                } else {
                    alert(`❌ Test failed: ${result.message}\n\nCheck console for details.`);
                }

            } catch (error) {
                console.error('❌ Test failed with error:', error);
                alert(`❌ Test failed with error: ${error.message}`);
            }
        }

        // Make test function available globally for console testing
        window.testJobClosureNotification = testJobClosureNotification;
        
        // Debug function to test recipient lookup
        window.testRecipientLookup = async function(positionCode) {
            const companyId = getCompanyId();
            if (!companyId) {
                console.error('Company ID not found');
                return;
            }
            
            console.log(`🔍 Testing recipient lookup for position code: "${positionCode}"`);
            const recipients = await jobClosureNotificationService.getPositionRecipients(positionCode, companyId);
            console.log(`🔍 Result: Found ${recipients.length} recipients`);
            return recipients;
        };

        // Debug function to show all available position codes
        window.showAllPositionCodes = async function() {
            try {
                console.log('📋 Fetching all available position codes...');
                const companyId = getCompanyId();
                if (!companyId) {
                    console.error('❌ No company ID found');
                    return;
                }

                const staffSnapshot = await db.collection('companies').doc(companyId).collection('staff').get();
                
                console.log('📊 Total staff documents:', staffSnapshot.size);
                
                const positionCodes = new Set();
                staffSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.position) {
                        positionCodes.add(data.position);
                    }
                });

                console.log('🎯 Available position codes:', Array.from(positionCodes).sort());
                console.log('📝 Use testRecipientLookup("POSITION_CODE") to test a specific position');
                
                return Array.from(positionCodes);
            } catch (error) {
                console.error('❌ Error fetching position codes:', error);
            }
        };

        // Add test button to page for job closure notifications
        function addJobClosureTestButton() {
            try {
                // Create test button container
                const testContainer = document.createElement('div');
                testContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    display: flex;
                    gap: 10px;
                `;

                // Test EmailJS button
                const testButton = document.createElement('button');
                testButton.innerHTML = '🧪 Test Job Closure Notification';
                testButton.style.cssText = `
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 500;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    transition: all 0.2s ease;
                `;

                testButton.addEventListener('click', testJobClosureNotification);
                testButton.addEventListener('mouseenter', () => {
                    testButton.style.background = '#0056b3';
                    testButton.style.transform = 'translateY(-1px)';
                });
                testButton.addEventListener('mouseleave', () => {
                    testButton.style.background = '#007bff';
                    testButton.style.transform = 'translateY(0)';
                });

                testContainer.appendChild(testButton);
                
                // Debug recipient lookup button
                const debugButton = document.createElement('button');
                debugButton.innerHTML = '🔍 Debug Recipients';
                debugButton.style.cssText = `
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 500;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    transition: all 0.2s ease;
                `;
                
                debugButton.addEventListener('click', async () => {
                    const positionCode = prompt('Enter position code to test recipient lookup:', 'POSTN-001');
                    if (positionCode) {
                        await window.testRecipientLookup(positionCode);
                    }
                });
                debugButton.addEventListener('mouseenter', () => {
                    debugButton.style.background = '#1e7e34';
                    debugButton.style.transform = 'translateY(-1px)';
                });
                debugButton.addEventListener('mouseleave', () => {
                    debugButton.style.background = '#28a745';
                    debugButton.style.transform = 'translateY(0)';
                });
                
                testContainer.appendChild(debugButton);
                
                // Show all position codes button
                const showCodesButton = document.createElement('button');
                showCodesButton.innerHTML = '📋 Show Position Codes';
                showCodesButton.style.cssText = `
                    background: #17a2b8;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 500;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    transition: all 0.2s ease;
                `;
                
                showCodesButton.addEventListener('click', async () => {
                    await window.showAllPositionCodes();
                    console.log('👆 Check the console above for all available position codes');
                });
                showCodesButton.addEventListener('mouseenter', () => {
                    showCodesButton.style.background = '#117a8b';
                    showCodesButton.style.transform = 'translateY(-1px)';
                });
                showCodesButton.addEventListener('mouseleave', () => {
                    showCodesButton.style.background = '#17a2b8';
                    showCodesButton.style.transform = 'translateY(0)';
                });
                
                testContainer.appendChild(showCodesButton);
                document.body.appendChild(testContainer);

                console.log('✅ Job closure test button added to page');

            } catch (error) {
                console.error('❌ Error adding test button:', error);
            }
        }

        // Add test button when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(addJobClosureTestButton, 2000); // Add after page fully loads
        });

        // Show notification for auto-closed job
        function showAutoCloseNotification(jobTitle) {
            // Create a subtle notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f8d7da;
                color: #721c24;
                padding: 12px 16px;
                border: 1px solid #f5c6cb;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-clock" style="color: #721c24;"></i>
                    <div>
                        <strong>Job Auto-Closed</strong><br>
                        "${jobTitle}" was automatically closed due to expired advertising date and moved to Archives.
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove notification after 8 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 8000);
        }

        // Load job applicants in the right tab
        function loadJobApplicants(jobId) {
            selectedJobId = jobId;
            const job = allJobs.find(j => j.id === jobId);
            
            if (!job) {
                console.error('Job not found:', jobId);
                return;
            }

            // Switch to applicants tab
            switchToTab('applicants');
            
            // Update job info
            document.getElementById('selectedJobTitle').textContent = job.jobTitle || job.position || 'Untitled Job';
            document.getElementById('selectedJobDetails').textContent = 
                `${job.department || 'N/A'} • ${formatEmploymentType(job.employmentType)} • Posted ${formatPostedDateTime(job.datePosted)} • ${job.applicationCount || 0} Applications`;

            // Load applicants from Firebase (company-scoped)
            const companyId = getCompanyId() || job.companyId;
            let applicantsRef;
            
            if (companyId) {
                // Use company-scoped path
                applicantsRef = database.ref(`companies/${companyId}/jobs/${jobId}/applications`);
                console.log('Loading applications from company-scoped path:', `companies/${companyId}/jobs/${jobId}/applications`);
            } else {
                // Fallback to old path
                applicantsRef = database.ref(`jobs/${jobId}/applications`);
                console.log('Loading applications from legacy path:', `jobs/${jobId}/applications`);
            }
            
            // Hide no applicants message and show loading
            document.getElementById('noApplicantsMessage').style.display = 'none';
            document.getElementById('applicantsTable').style.display = 'none';
            
            applicantsRef.once('value', (snapshot) => {
                const applicantsData = snapshot.val();
                const tbody = document.getElementById('applicantsTableBody');
                tbody.innerHTML = '';

                if (!applicantsData) {
                    // Show no applicants message
                    document.getElementById('noApplicantsMessage').innerHTML = `
                        <i class="fas fa-user-friends"></i>
                        <h3>No Applicants Yet</h3>
                        <p>This job posting hasn't received any applications.</p>
                    `;
                    document.getElementById('noApplicantsMessage').style.display = 'block';
                    return;
                }

                // Show table and populate with applicants
                document.getElementById('applicantsTable').style.display = 'table';
                  Object.entries(applicantsData).forEach(([applicationId, applicant]) => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function() {
                        showApplicantModal(applicant, applicationId, jobId);
                    });
                    
                    // Debug: Log available date fields
                    console.log('Applicant date fields:', {
                        appliedDate: applicant.appliedDate,
                        applicationDate: applicant.applicationDate,
                        dateApplied: applicant.dateApplied,
                        submittedAt: applicant.submittedAt,
                        timestamp: applicant.timestamp,
                        createdAt: applicant.createdAt
                    });
                    
                    // Get application date from multiple possible fields
                    const applicationDate = applicant.appliedDate || 
                                          applicant.applicationDate || 
                                          applicant.dateApplied || 
                                          applicant.submittedAt || 
                                          applicant.timestamp || 
                                          applicant.createdAt || 
                                          new Date().toISOString(); // fallback to current date
                    
                    console.log('Selected application date:', applicationDate);
                    
                    row.innerHTML = `
                        <td class="applicant-name">${applicant.firstName || ''} ${applicant.lastName || ''}</td>
                        <td>${applicant.email || 'N/A'}</td>
                        <td>${applicant.phone || 'N/A'}</td>
                        <td>${formatDate(applicationDate)}</td>
                        <td><span class="status-badge status-${applicant.status || 'pending'}">${formatApplicationStatus(applicant.status)}</span></td>
                        <td>
                            ${applicant.resumeUrl ? `
                                <a href="${applicant.resumeUrl}" target="_blank" class="btn btn-sm btn-secondary" onclick="event.stopPropagation();">
                                    <i class="fas fa-file-pdf"></i> View
                                </a>
                            ` : 'N/A'}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn btn-view" onclick="event.stopPropagation(); showApplicantModal(${JSON.stringify(applicant)}, '${applicationId}', '${jobId}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); updateApplicationStatus('${applicationId}', '${jobId}')" title="Update Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }).catch((error) => {
                console.error('Error loading applicants:', error);
                document.getElementById('noApplicantsMessage').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error Loading Applicants</h3>
                    <p>There was an error loading the applicants for this job.</p>
                `;
                document.getElementById('noApplicantsMessage').style.display = 'block';
            });
        }        // Switch between tabs
        function switchToTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'jobs') {
                document.getElementById('jobsTabBtn').classList.add('active');
                document.getElementById('jobsTabContent').classList.add('active');
                
                // Ensure jobs are displayed properly
                console.log('Switching to jobs tab, ensuring table is visible');
                const jobsTable = document.getElementById('jobsTable');
                const loadingState = document.getElementById('loadingState');
                
                if (filteredJobs && filteredJobs.length > 0) {
                    if (loadingState) loadingState.style.display = 'none';
                    if (jobsTable) {
                        jobsTable.style.display = 'table';
                        renderTable(); // Re-render the table to ensure it's up to date
                    }
                } else if (allJobs && allJobs.length > 0) {
                    // If we have jobs but none are filtered, re-apply filters
                    applyFilters();
                }
                
            } else if (tabName === 'applicants') {
                document.getElementById('applicantsTabBtn').classList.add('active');
                document.getElementById('applicantsTabContent').classList.add('active');
            } else if (tabName === 'archives') {
                document.getElementById('archivesTabBtn').classList.add('active');
                document.getElementById('archivesTabContent').classList.add('active');
                // Load archived jobs when switching to archives tab
                loadArchivedJobs();
            }
        }

        // Close applicants tab (legacy function - now just switches to jobs tab)
        function closeApplicantsTab() {
            switchToTab('jobs');
            selectedJobId = null;
        }

        // Format application status
        function formatApplicationStatus(status) {
            const statuses = {
                'pending': 'Pending',
                'reviewed': 'Reviewed',
                'shortlisted': 'Shortlisted',
                'interviewed': 'Interviewed',
                'rejected': 'Rejected',
                'hired': 'Hired'
            };
            return statuses[status?.toLowerCase()] || 'Pending';
        }

        // View application details
        function viewApplicationDetails(applicationId, jobId) {
            // For now, show an alert with basic info
            alert(`Application details for ${applicationId} will be implemented in a modal.`);
        }

        // Update application status
        function updateApplicationStatus(applicationId, jobId) {
            // For now, show a simple prompt
            const newStatus = prompt('Enter new status (pending, reviewed, shortlisted, interviewed, rejected, hired):');
            if (newStatus) {
                const statusRef = database.ref(`jobs/${jobId}/applications/${applicationId}/status`);
                statusRef.set(newStatus.toLowerCase()).then(() => {
                    alert('Status updated successfully!');
                    // Reload applicants to show updated status
                    loadJobApplicants(jobId);
                }).catch((error) => {
                    console.error('Error updating status:', error);
                    alert('Error updating status. Please try again.');
                });
            }
        }        // Update viewApplications function to use the new tab system
        function viewApplications(jobId) {
            loadJobApplicants(jobId);
        }

        // Global variables for modal
        let currentModalApplicationId = null;
        let currentModalJobId = null;

        // Show applicant modal
        function showApplicantModal(applicant, applicationId, jobId) {
            currentModalApplicationId = applicationId;
            currentModalJobId = jobId;
            
            // Populate personal information
            document.getElementById('modalFullName').textContent = `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || 'N/A';
            document.getElementById('modalEmail').textContent = applicant.email || 'N/A';
            document.getElementById('modalPhone').textContent = applicant.phone || 'N/A';
            document.getElementById('modalAddress').textContent = applicant.address || 'N/A';
            
            // Populate professional information
            document.getElementById('modalCurrentPosition').textContent = applicant.currentPosition || 'N/A';
            document.getElementById('modalExperience').textContent = applicant.experience || applicant.yearsOfExperience || 'N/A';
            document.getElementById('modalExpectedSalary').textContent = applicant.expectedSalary ? `$${applicant.expectedSalary}` : 'N/A';
            document.getElementById('modalLinkedIn').textContent = applicant.linkedIn || applicant.linkedin || 'N/A';
            
            // Populate application information
            // Debug: Log available date fields in modal
            console.log('Modal - Applicant date fields:', {
                appliedDate: applicant.appliedDate,
                applicationDate: applicant.applicationDate,
                dateApplied: applicant.dateApplied,
                submittedAt: applicant.submittedAt,
                timestamp: applicant.timestamp,
                createdAt: applicant.createdAt
            });
            
            // Get application date from multiple possible fields
            const applicationDate = applicant.appliedDate || 
                                  applicant.applicationDate || 
                                  applicant.dateApplied || 
                                  applicant.submittedAt || 
                                  applicant.timestamp || 
                                  applicant.createdAt || 
                                  new Date().toISOString(); // fallback to current date
            
            console.log('Modal - Selected application date:', applicationDate);
            document.getElementById('modalAppliedDate').textContent = formatDate(applicationDate);
            const statusElement = document.getElementById('modalStatus');
            statusElement.textContent = formatApplicationStatus(applicant.status);
            statusElement.className = `status-badge status-${applicant.status || 'pending'}`;
            
            document.getElementById('modalAvailability').textContent = applicant.availability || applicant.availableToStart || 'N/A';
            document.getElementById('modalNoticePeriod').textContent = applicant.noticePeriod || 'N/A';
            
            // Populate cover letter
            const coverLetterElement = document.getElementById('modalCoverLetter');
            if (applicant.coverLetter && applicant.coverLetter.trim()) {
                coverLetterElement.innerHTML = `<p>${applicant.coverLetter}</p>`;
            } else {
                coverLetterElement.innerHTML = '<p class="text-muted">No cover letter provided</p>';
            }
            
            // Populate attachments
            populateAttachments(applicant);
            
            // Set current status in select
            document.getElementById('statusSelect').value = applicant.status || 'pending';
            
            // Show modal
            document.getElementById('applicantModalOverlay').style.display = 'flex';            document.body.style.overflow = 'hidden';
        }

        // Close applicant modal
        function closeApplicantModal() {
            document.getElementById('applicantModalOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentModalApplicationId = null;
            currentModalJobId = null;
        }

        // Update applicant status from modal
        function updateApplicantStatus() {
            if (!currentModalApplicationId || !currentModalJobId) {
                alert('Error: No applicant selected');
                return;
            }
            
            const newStatus = document.getElementById('statusSelect').value;
            const statusRef = database.ref(`jobs/${currentModalJobId}/applications/${currentModalApplicationId}/status`);
            statusRef.set(newStatus).then(() => {
                alert('Status updated successfully!');
                loadJobApplicants(currentModalJobId);
            }).catch((error) => {
                console.error('Error updating status:', error);
                alert('Error updating status. Please try again.');            });
        }
        
        // Populate attachments section
        function populateAttachments(applicant) {
            const attachmentsContainer = document.getElementById('modalAttachments');
            let attachmentsHtml = '';
            let hasAttachments = false;
            
            // Add resume if available - Check Firebase structure first
            let resumeUrl = null;
            let resumeName = 'Resume.pdf';
              // Priority 1: Check applicant.files.resume.url (Firebase structure)
            if (applicant.files && applicant.files.resume && applicant.files.resume.url) {
                resumeUrl = applicant.files.resume.url;
                resumeName = applicant.files.resume.name || applicant.files.resume.fileName || 'Resume.pdf';
                console.log('Resume found in Firebase structure:', resumeUrl);
            }
            // Priority 2: Check legacy resumeUrl field
            else if (applicant.resumeUrl) {
                resumeUrl = applicant.resumeUrl;
                resumeName = applicant.resumeName || applicant.resumeFileName || 'Resume.pdf';
                console.log('Resume found in legacy field:', resumeUrl);
            }
            else {
                console.log('No resume found in applicant data:', applicant);
            }
            
            if (resumeUrl) {
                hasAttachments = true;
                attachmentsHtml += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-pdf" style="font-size: 1.5rem; color: #dc3545;"></i>
                            <div>
                                <div style="font-weight: 500; color: #2c3e50; font-size: 0.9rem;">${resumeName}</div>
                                <div style="color: #6c757d; font-size: 0.8rem;">Resume</div>
                            </div>
                        </div>
                        <a href="${resumeUrl}" target="_blank" class="btn btn-sm btn-primary" style="text-decoration: none;">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>
                `;
            }            
            // Add cover letter file if available (separate from text) - Check Firebase structure first
            let coverLetterUrl = null;
            let coverLetterName = 'Cover Letter.pdf';
              // Priority 1: Check applicant.files.coverLetter.url (Firebase structure)
            if (applicant.files && applicant.files.coverLetter && applicant.files.coverLetter.url) {
                coverLetterUrl = applicant.files.coverLetter.url;
                coverLetterName = applicant.files.coverLetter.name || applicant.files.coverLetter.fileName || 'Cover Letter.pdf';
                console.log('Cover letter found in Firebase structure:', coverLetterUrl);
            }
            // Priority 2: Check legacy coverLetterUrl field
            else if (applicant.coverLetterUrl && applicant.coverLetterUrl !== resumeUrl) {
                coverLetterUrl = applicant.coverLetterUrl;
                coverLetterName = applicant.coverLetterName || applicant.coverLetterFileName || 'Cover Letter.pdf';
                console.log('Cover letter found in legacy field:', coverLetterUrl);
            }
            
            if (coverLetterUrl) {
                hasAttachments = true;
                attachmentsHtml += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-alt" style="font-size: 1.5rem; color: #28a745;"></i>
                            <div>
                                <div style="font-weight: 500; color: #2c3e50; font-size: 0.9rem;">${coverLetterName}</div>
                                <div style="color: #6c757d; font-size: 0.8rem;">Cover Letter</div>
                            </div>
                        </div>
                        <a href="${coverLetterUrl}" target="_blank" class="btn btn-sm btn-primary" style="
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>
                `;
            }
              // Add portfolio/additional files if available - Check Firebase structure first
            let portfolioUrl = null;
            let portfolioName = 'Portfolio';
              // Priority 1: Check applicant.files.portfolio.url (Firebase structure)
            if (applicant.files && applicant.files.portfolio && applicant.files.portfolio.url) {
                portfolioUrl = applicant.files.portfolio.url;
                portfolioName = applicant.files.portfolio.name || applicant.files.portfolio.fileName || 'Portfolio';
                console.log('Portfolio found in Firebase structure:', portfolioUrl);
            }
            // Priority 2: Check legacy portfolioUrl field
            else if (applicant.portfolioUrl) {
                portfolioUrl = applicant.portfolioUrl;
                portfolioName = applicant.portfolioName || applicant.portfolioFileName || 'Portfolio';
                console.log('Portfolio found in legacy field:', portfolioUrl);
            }
            
            if (portfolioUrl) {
                hasAttachments = true;
                attachmentsHtml += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-briefcase" style="font-size: 1.5rem; color: #6f42c1;"></i>
                            <div>
                                <div style="font-weight: 500; color: #2c3e50; font-size: 0.9rem;">${portfolioName}</div>
                                <div style="color: #6c757d; font-size: 0.8rem;">Portfolio</div>
                            </div>
                        </div>
                        <a href="${portfolioUrl}" target="_blank" class="btn btn-sm btn-primary" style="text-decoration: none;">
                            <i class="fas fa-external-link-alt"></i> View
                        </a>
                    </div>
                `;
            }
            
            // Add other attachments if available (from file uploads array)
            if (applicant.attachments && Array.isArray(applicant.attachments)) {
                applicant.attachments.forEach(attachment => {
                    if (attachment.url) {
                        hasAttachments = true;
                        const fileIcon = getFileIcon(attachment.name || attachment.fileName);
                        attachmentsHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="${fileIcon}" style="font-size: 1.5rem; color: #007bff;"></i>
                                    <div>
                                        <div style="font-weight: 500; color: #2c3e50; font-size: 0.9rem;">${attachment.name || attachment.fileName || 'Attachment'}</div>
                                        <div style="color: #6c757d; font-size: 0.8rem;">${attachment.type || 'File'}</div>
                                    </div>
                                </div>
                                <a href="${attachment.url}" target="_blank" class="btn btn-sm btn-primary" style="text-decoration: none;">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        `;
                    }
                });
            }            // Add files from metadata if available (Firebase file metadata) - avoid duplicates
            if (applicant.files && typeof applicant.files === 'object') {
                console.log('Processing additional files from applicant.files:', applicant.files);
                Object.entries(applicant.files).forEach(([key, fileData]) => {
                    // Skip resume, coverLetter, and portfolio as they're handled above
                    if (fileData && fileData.url && !['resume', 'coverLetter', 'portfolio'].includes(key)) {
                        console.log(`Adding file: ${key}`, fileData);
                        hasAttachments = true;
                        const fileIcon = getFileIcon(fileData.name || fileData.fileName);
                        const displayName = fileData.name || fileData.fileName || 'Attachment';
                        const fileType = fileData.type || key.charAt(0).toUpperCase() + key.slice(1) || 'File';
                        
                        attachmentsHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="${fileIcon}" style="font-size: 1.5rem; color: #007bff;"></i>
                                    <div>
                                        <div style="font-weight: 500; color: #2c3e50; font-size: 0.9rem;">${displayName}</div>
                                        <div style="color: #6c757d; font-size: 0.8rem;">${fileType}</div>
                                    </div>
                                </div>
                                <a href="${fileData.url}" target="_blank" class="btn btn-sm btn-primary" style="text-decoration: none;">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        `;
                    }
                });
            }
            
            if (!hasAttachments) {
                attachmentsContainer.innerHTML = '<p class="text-muted">No attachments</p>';
            } else {
                attachmentsContainer.innerHTML = attachmentsHtml;
            }
        }

        // Get file icon based on file name
        function getFileIcon(fileName) {
            if (!fileName) return 'fas fa-file';
            
            const extension = fileName.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',
                'xls': 'fas fa-file-excel',
                'xlsx': 'fas fa-file-excel',
                'ppt': 'fas fa-file-powerpoint',
                'pptx': 'fas fa-file-powerpoint',
                'jpg': 'fas fa-file-image',
                'jpeg': 'fas fa-file-image',
                'png': 'fas fa-file-image',
                'gif': 'fas fa-file-image',
                'bmp': 'fas fa-file-image',
                'svg': 'fas fa-file-image',
                'txt': 'fas fa-file-alt',
                'rtf': 'fas fa-file-alt',
                'zip': 'fas fa-file-archive',
                'rar': 'fas fa-file-archive',
                '7z': 'fas fa-file-archive',
                'tar': 'fas fa-file-archive',
                'mp4': 'fas fa-file-video',
                'avi': 'fas fa-file-video',
                'mov': 'fas fa-file-video',
                'mp3': 'fas fa-file-audio',
                'wav': 'fas fa-file-audio',
                'csv': 'fas fa-file-csv'
            };
            
            return iconMap[extension] || 'fas fa-file';        }

        // Archives functionality
        let allArchivedJobs = [];
        let filteredArchivedJobs = [];
        let currentArchivePage = 1;
        const archiveItemsPerPage = 20;

        // Load archived jobs from Firebase
        function loadArchivedJobs() {
            document.getElementById('archiveLoadingState').style.display = 'block';
            document.getElementById('archivesTable').style.display = 'none';
            document.getElementById('emptyArchivesState').classList.add('d-none');
            
            const companyId = getCompanyId();
            if (!companyId) {
                console.error('Company ID not found');
                hideArchiveLoading();
                showEmptyArchivesState();
                return;
            }
            
            const archivesRef = database.ref(`companies/${companyId}/jobclosed`);
            
            archivesRef.once('value', (snapshot) => {
                try {
                    const data = snapshot.val();
                    allArchivedJobs = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const job = data[key];
                            job.id = key; // Preserve the original job ID
                            
                            // Add archived date if not present
                            if (!job.archivedDate) {
                                job.archivedDate = job.closedDate || new Date().toISOString();
                            }
                            
                            allArchivedJobs.push(job);
                        });
                        
                        // Sort archived jobs by archived date, most recent first
                        allArchivedJobs.sort((a, b) => {
                            return new Date(b.archivedDate) - new Date(a.archivedDate);
                        });
                    }
                    
                    console.log('Loaded archived jobs:', allArchivedJobs.length);
                    applyArchiveFilters();
                    hideArchiveLoading();
                    
                } catch (error) {
                    console.error('Error loading archived jobs:', error);
                    hideArchiveLoading();
                    showEmptyArchivesState();
                }
            }, (error) => {
                console.error('Firebase error loading archives:', error);
                hideArchiveLoading();
                showEmptyArchivesState();
            });
        }

        // Hide archive loading state
        function hideArchiveLoading() {
            document.getElementById('archiveLoadingState').style.display = 'none';
        }

        // Show empty archives state
        function showEmptyArchivesState() {
            document.getElementById('emptyArchivesState').classList.remove('d-none');
            document.getElementById('archivesTable').style.display = 'none';
        }

        // Apply filters to archived jobs
        function applyArchiveFilters() {
            const searchTerm = document.getElementById('archiveSearchInput').value.toLowerCase();
            
            filteredArchivedJobs = allArchivedJobs.filter(job => {
                const jobTitle = (job.jobTitle || job.title || '').toLowerCase();
                const department = (job.department || '').toLowerCase();
                const positionCode = (job.positionCode || '').toLowerCase();
                
                return jobTitle.includes(searchTerm) || 
                       department.includes(searchTerm) || 
                       positionCode.includes(searchTerm);
            });

            currentArchivePage = 1;
            renderArchivedJobs();
        }

        // Render archived jobs table
        function renderArchivedJobs() {
            const tbody = document.getElementById('archivesTableBody');
            tbody.innerHTML = '';

            if (filteredArchivedJobs.length === 0) {
                showEmptyArchivesState();
                return;
            }

            document.getElementById('emptyArchivesState').classList.add('d-none');
            document.getElementById('archivesTable').style.display = 'table';

            const startIndex = (currentArchivePage - 1) * archiveItemsPerPage;
            const endIndex = startIndex + archiveItemsPerPage;
            const jobsToShow = filteredArchivedJobs.slice(startIndex, endIndex);

            jobsToShow.forEach(job => {
                const row = createArchivedJobRow(job);
                tbody.appendChild(row);
            });

            updateArchivePagination();
        }        // Create archived job table row
        function createArchivedJobRow(job) {
            const row = document.createElement('tr');
            
            const jobTitle = job.jobTitle || job.position || 'Untitled Job';
            const positionCode = job.positionCode || 'N/A';
            const department = job.department || 'N/A';
            const employmentType = formatEmploymentType(job.employmentType || job.jobType);
            const originalStatus = job.originalStatus || job.status || 'Unknown';
            const applicationCount = job.applicationCount || 0;
            const postedDate = formatPostedDateTime(job.datePosted || job.postedDate);
            const archivedDate = formatDate(job.archivedDate || job.dateArchived);

            row.innerHTML = `
                <td>
                    <input type="checkbox" class="archive-checkbox" value="${job.id}" onchange="updateRestoreButton()">
                </td>
                <td class="job-title-cell">${jobTitle}</td>
                <td><span class="job-code">${positionCode}</span></td>
                <td>${department}</td>
                <td><span class="employment-type">${employmentType}</span></td>
                <td><span class="status-badge status-${originalStatus}">${formatStatus(originalStatus)}</span></td>
                <td>
                    <div class="applications-count">
                        <i class="fas fa-users"></i>
                        <span class="count-badge">${applicationCount}</span>
                    </div>
                </td>
                <td class="text-muted">${postedDate}</td>
                <td class="text-muted">${archivedDate}</td>                <td>
                    <div class="action-buttons">
                        <button class="action-btn btn-info" onclick="viewJobParticipants('${job.id}')" title="View Job Participants">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="action-btn btn-success" onclick="restoreJob('${job.id}')" title="Restore Job">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </td>
            `;

            return row;
        }

        // Update restore button state
        function updateRestoreButton() {
            const checkedBoxes = document.querySelectorAll('.archive-checkbox:checked');
            const restoreBtn = document.getElementById('restoreSelectedBtn');
            restoreBtn.disabled = checkedBoxes.length === 0;
        }

        // Toggle select all archives
        function toggleSelectAllArchives() {
            const selectAll = document.getElementById('selectAllArchives');
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateRestoreButton();
        }

        // Restore selected jobs
        function restoreSelectedJobs() {
            const checkedBoxes = document.querySelectorAll('.archive-checkbox:checked');
            const jobIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (jobIds.length === 0) {
                alert('Please select jobs to restore.');
                return;
            }            if (confirm(`Are you sure you want to restore ${jobIds.length} job(s)? They will be moved back to the active jobs list and their advertising closing dates will be updated to prevent immediate auto-closure.`)) {
                jobIds.forEach(jobId => restoreJob(jobId, false));
                // Refresh the archives view and show completion message
                setTimeout(() => {
                    loadArchivedJobs();
                    const newClosingDate = new Date();
                    newClosingDate.setDate(newClosingDate.getDate() + 30);
                    const formattedDate = newClosingDate.toLocaleDateString();
                    alert(`${jobIds.length} job(s) restored successfully!\n\nAll advertising closing dates have been updated to ${formattedDate} (30 days from today).`);
                }, 1000);
            }}

        // Restore individual job
        function restoreJob(jobId, showConfirm = true) {
            if (showConfirm && !confirm('Are you sure you want to restore this job? It will be moved back to the active jobs list.')) {
                return;
            }

            const companyId = getCompanyId();
            if (!companyId) {
                console.error('Company ID not found');
                alert('Error: Company ID not found. Please try again.');
                return;
            }

            // Get job data from company jobclosed
            const archivedJobRef = database.ref(`companies/${companyId}/jobclosed/${jobId}`);
            
            archivedJobRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        throw new Error('Archived job not found');
                    }
                    
                    const jobData = snapshot.val();
                    const now = new Date();
                    
                    // Calculate new advertising closing date (30 days from today)
                    const newClosingDate = new Date();
                    newClosingDate.setDate(newClosingDate.getDate() + 30);
                    
                    // Prepare job data for restoration
                    const restoredJobData = {
                        ...jobData,
                        status: 'active', // Set to active when restored
                        restoredDate: now.toISOString(),
                        restoredBy: 'system', // You can update this with actual user info
                        advertisingClosingDate: newClosingDate.toISOString().split('T')[0] // Set new closing date (30 days from now)
                    };
                    
                    // Remove archive-specific fields
                    delete restoredJobData.archivedDate;
                    delete restoredJobData.closedDate;
                    delete restoredJobData.autoClosedReason;
                    delete restoredJobData.autoClosedDate;
                    delete restoredJobData.archiveReason;
                    delete restoredJobData.archivedBy;

                    // Create atomic update to move job back to active jobs in company scope
                    const updates = {};
                    updates[`companies/${companyId}/jobs/${jobId}`] = restoredJobData;
                    updates[`companies/${companyId}/jobclosed/${jobId}`] = null;
                    
                    return database.ref().update(updates);
                })                .then(() => {
                    console.log(`Job restored successfully: ${jobId}`);
                    
                    // Show success message with new closing date info
                    if (showConfirm) {
                        const newClosingDate = new Date();
                        newClosingDate.setDate(newClosingDate.getDate() + 30);
                        const formattedDate = newClosingDate.toLocaleDateString();
                        alert(`Job restored successfully and moved back to active jobs!\n\nAdvertising closing date has been automatically updated to ${formattedDate} (30 days from today) to prevent immediate auto-closure.`);
                    }
                    
                    // Refresh both jobs and archives lists
                    loadJobsFromFirebase();
                    loadArchivedJobs();
                })
                .catch((error) => {
                    console.error('Error restoring job:', error);
                    alert('Error restoring job. Please try again.');
                });
        }        // View archived job details
        function viewArchivedJob(jobId) {
            // For now, just show an alert with basic info
            // You can extend this to show a detailed modal later
            const job = allArchivedJobs.find(j => j.id === jobId);
            if (job) {
                alert(`Archived Job Details:\n\nTitle: ${job.jobTitle || job.title}\nDepartment: ${job.department}\nArchived: ${formatDate(job.archivedDate)}\nReason: ${job.archiveReason || 'Not specified'}`);
            }
        }

        // View participants of archived job
        function viewJobParticipants(jobId) {
            // Store the jobId in localStorage to pass to jobinterview.html
            localStorage.setItem('selectedArchivedJobId', jobId);
            localStorage.setItem('viewMode', 'archived-participants');
            
            // Redirect to jobinterview.html
            window.location.href = 'jobinterview.html';
        }

        // Archive a job (when closing/completing recruitment)
        async function archiveJob(jobId, reason = 'Job completed') {
            try {
                const companyId = getCompanyId();
                if (!companyId) {
                    console.error('Company ID not found');
                    throw new Error('Company ID not found');
                }
                
                const jobRef = database.ref(`companies/${companyId}/jobs/${jobId}`);
                const snapshot = await jobRef.once('value');
                
                if (snapshot.exists()) {
                    const jobData = snapshot.val();
                    
                    // Prepare archive data with participants
                    const archiveData = {
                        ...jobData,
                        id: jobId,
                        archivedDate: new Date().toISOString(),
                        archiveReason: reason,
                        originalCreationDate: jobData.createdAt || jobData.datePosted,
                        archivedBy: 'System', // You can get current user here
                        status: 'archived'
                    };
                    
                    // Move to company jobclosed
                    const archiveRef = database.ref(`companies/${companyId}/jobclosed/${jobId}`);
                    await archiveRef.set(archiveData);
                    
                    // Remove from active jobs (optional - you might want to keep and just mark as archived)
                    // await jobRef.remove();
                    
                    // Update job status to archived instead of removing
                    await jobRef.update({
                        status: 'archived',
                        archivedDate: new Date().toISOString(),
                        archiveReason: reason
                    });
                    
                    console.log(`Job ${jobId} archived successfully`);
                    
                    // Trigger position closure notification if email system is available
                    if (window.sendRecruitmentApprovalNotification) {
                        const recruitmentData = {
                            position: jobData.jobTitle,
                            department: jobData.department,
                            referenceNumber: jobId,
                            closedBy: 'HR Manager',
                            closureDate: new Date().toLocaleDateString(),
                            recruitmentStartDate: jobData.createdAt ? new Date(jobData.createdAt).toLocaleDateString() : 'N/A',
                            recruitmentEndDate: new Date().toLocaleDateString(),
                            salaryMin: jobData.salaryMin || 'N/A',
                            salaryMax: jobData.salaryMax || 'N/A',
                            workingHours: jobData.workingHours || '40',
                            description: jobData.description || 'N/A',
                            education: jobData.requiredEducation || 'N/A',
                            experience: jobData.requiredExperience || 'N/A',
                            skills: jobData.requiredSkills || 'N/A'
                        };
                        
                        await window.sendRecruitmentApprovalNotification(jobId, recruitmentData);
                    }
                    
                    return true;
                } else {
                    console.error(`Job ${jobId} not found`);
                    return false;
                }
            } catch (error) {
                console.error('Error archiving job:', error);
                return false;
            }
        }

        // Archive pagination
        function updateArchivePagination() {
            const totalPages = Math.ceil(filteredArchivedJobs.length / archiveItemsPerPage);
            const pageInfo = document.getElementById('archivePageInfo');
            const pagination = document.getElementById('archivesPagination');
            const prevBtn = document.getElementById('archivePrevPageBtn');
            const nextBtn = document.getElementById('archiveNextPageBtn');

            if (totalPages <= 1) {
                pagination.classList.add('d-none');
                return;
            }

            pagination.classList.remove('d-none');
            pageInfo.textContent = `Page ${currentArchivePage} of ${totalPages}`;
            
            prevBtn.disabled = currentArchivePage === 1;
            nextBtn.disabled = currentArchivePage === totalPages;
        }

        // Change archive page
        function changeArchivePage(direction) {
            const totalPages = Math.ceil(filteredArchivedJobs.length / archiveItemsPerPage);
            const newPage = currentArchivePage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentArchivePage = newPage;
                renderArchivedJobs();
            }
        }

        // Setup archive event listeners
        function setupArchiveEventListeners() {
            // Archive search input
            document.getElementById('archiveSearchInput').addEventListener('input', applyArchiveFilters);
            
            // Export archives button
            document.getElementById('exportArchivesBtn').addEventListener('click', exportArchivedJobs);
        }

        // Export archived jobs
        function exportArchivedJobs() {
            if (filteredArchivedJobs.length === 0) {
                alert('No archived jobs to export.');
                return;
            }

            const csvContent = generateArchiveCSV(filteredArchivedJobs);
            downloadCSV(csvContent, 'archived_jobs.csv');
        }

        // Generate CSV for archived jobs
        function generateArchiveCSV(jobs) {
            const headers = ['Job Title', 'Position Code', 'Department', 'Employment Type', 'Original Status', 'Applications', 'Posted Date', 'Archived Date', 'Archive Reason'];
            const rows = jobs.map(job => [
                job.jobTitle || job.title || '',
                job.positionCode || '',
                job.department || '',
                job.employmentType || job.jobType || '',
                job.originalStatus || job.status || '',
                job.applicationCount || 0,
                formatPostedDateTime(job.datePosted || job.postedDate) || '',
                formatDate(job.archivedDate || job.dateArchived) || '',
                job.archiveReason || ''
            ]);

            return [headers, ...rows].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        // Update the original setupEventListeners function to include archive listeners
        const originalSetupEventListeners = setupEventListeners;
        setupEventListeners = function() {
            originalSetupEventListeners();
            setupArchiveEventListeners();
        };        // Formatting helper functions continue below...
        // ...existing code...
    </script>
    
    <!-- All external dependencies have been embedded above -->

<script>
// Error handling for missing resources - simplified for self-contained mode
window.addEventListener('error', function(e) {
  console.warn('Resource loading issue (expected in self-contained mode):', e.target.src || e.target.href);
  
  // Prevent error propagation in self-contained mode
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});
</script>

<!-- Essential External Scripts for Centralized Authentication and Services -->
<script type="module" src="js/firebase-config-v8.js"></script>
<script type="module" src="js/auth.js"></script>
<script type="module" src="js/roles.js"></script>
<script type="module" src="js/notifications.js"></script>
<!-- <script type="module" src="js/menu-visibility.js"></script> Menu visibility managed internally -->
<script src="js/header-loader.js"></script>
<script src="js/company-data-service-v8.js"></script>

<!-- Initialize centralized authentication on page load -->
<script>
    // Wait for modules to load and initialize centralized auth
    window.addEventListener('DOMContentLoaded', () => {
        // Additional initialization for centralized auth integration
        console.log('🔐 Waiting for centralized authentication modules to load...');
        
        // Check periodically for auth manager
        let authCheckInterval = setInterval(() => {
            if (window.authManager) {
                console.log('🔐 Centralized AuthManager detected and ready');
                clearInterval(authCheckInterval);
                
                // Dispatch custom event to notify other parts of the system
                window.dispatchEvent(new CustomEvent('authManagerReady'));
                
                // Update menu visibility with centralized permissions
                setTimeout(() => {
                    updateMenuVisibilityForJobScreen();
                }, 500);
            }
        }, 500);
        
        // Stop checking after 10 seconds to prevent infinite loop
        setTimeout(() => {
            if (authCheckInterval) {
                clearInterval(authCheckInterval);
                console.log('🔐 Timeout waiting for centralized auth, using fallback authentication');
            }
        }, 10000);
    });
</script>

</body>
</html>

