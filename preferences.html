<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preferences - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/preferences-loader.js"></script>
    <!-- Inline tab initialization to ensure it runs before modules -->
    <script>
        // Emergency tab fallback - runs immediately
        window.emergencyTabInit = function() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            if (tabButtons.length > 0 && tabPanes.length > 0) {
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = button.getAttribute('data-tab');
                        
                        // Remove active from all
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabPanes.forEach(pane => pane.classList.remove('active'));
                        
                        // Add active to current
                        button.classList.add('active');
                        const targetPane = document.getElementById(targetId);
                        if (targetPane) {
                            targetPane.classList.add('active');
                        }
                    });
                });
                console.log('Emergency tab init successful');
                return true;
            }
            return false;
        };
    </script>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- GitHub Pages Fix Script -->
    <script src="github-pages-fix.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" placeholder="Search...">
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="assets/default-avatar.png" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>            <!-- Page Content -->
            <div class="content">
                <div class="content-header">
                    <h1><i class="fas fa-sliders-h"></i> Preferences</h1>
                    <p>Customize your experience and manage your notification preferences</p>
                </div>

                <!-- Preferences Tab Navigation -->
                <div class="preferences-tabs">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="general">
                            <i class="fas fa-cog"></i> General
                        </button>
                        <button class="tab-btn" data-tab="notifications">
                            <i class="fas fa-bell"></i> Notifications
                        </button>
                        <button class="tab-btn" data-tab="accessibility">
                            <i class="fas fa-universal-access"></i> Accessibility
                        </button>
                        <button class="tab-btn" data-tab="privacy">
                            <i class="fas fa-shield-alt"></i> Privacy & Security
                        </button>
                    </div>

                    <div class="tab-content">
                        <!-- General Settings Tab -->
                        <div class="tab-pane active" id="general">
                            <div class="settings-section">
                                <form id="preferencesForm" class="form-grid">
                                    <!-- Regional Settings -->
                                    <div class="settings-group">
                                        <h2><i class="fas fa-globe"></i> Regional Settings</h2>
                                        <div class="form-group">
                                            <label for="language">Interface Language</label>
                                            <select id="language" name="language">
                                                <option value="en">English</option>
                                                <option value="es">Español</option>
                                                <option value="fr">Français</option>
                                                <option value="de">Deutsch</option>
                                                <option value="ar">العربية</option>
                                                <option value="zh">中文</option>
                                                <option value="ja">日本語</option>
                                            </select>
                                            <div class="form-hint">Changes will take effect after page reload</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="timezone">Timezone</label>
                                            <select id="timezone" name="timezone">
                                                <!-- Timezones will be populated via JavaScript -->
                                            </select>
                                            <div class="preview-text"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="dateFormat">Date Format</label>
                                            <select id="dateFormat" name="dateFormat">
                                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                                <option value="DD.MM.YYYY">DD.MM.YYYY</option>
                                                <option value="YYYY年MM月DD日">YYYY年MM月DD日</option>
                                            </select>
                                            <div class="preview-text"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="timeFormat">Time Format</label>
                                            <select id="timeFormat" name="timeFormat">
                                                <option value="12">12-hour (1:30 PM)</option>
                                                <option value="24">24-hour (13:30)</option>
                                            </select>
                                            <div class="preview-text"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="firstDayOfWeek">First Day of Week</label>
                                            <select id="firstDayOfWeek" name="firstDayOfWeek">
                                                <option value="0">Sunday</option>
                                                <option value="1">Monday</option>
                                                <option value="6">Saturday</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="measurementSystem">Measurement System</label>
                                            <select id="measurementSystem" name="measurementSystem">
                                                <option value="metric">Metric (kilometers, kilograms)</option>
                                                <option value="imperial">Imperial (miles, pounds)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Accessibility Settings -->
                                    <div class="settings-group">
                                        <h2><i class="fas fa-universal-access"></i> Accessibility</h2>
                                        <div class="form-group">
                                            <label for="fontScale">Text Scaling</label>
                                            <select id="fontScale" name="fontScale">
                                                <option value="0.9">Smaller (90%)</option>
                                                <option value="1">Normal (100%)</option>
                                                <option value="1.15">Larger (115%)</option>
                                                <option value="1.3">Extra Large (130%)</option>
                                            </select>
                                            <div class="preview-text">Preview of text scaling</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="contrastMode">Contrast Mode</label>
                                            <select id="contrastMode" name="contrastMode">
                                                <option value="normal">Normal</option>
                                                <option value="high">High Contrast</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="animationReduction">Animation Reduction</label>
                                            <select id="animationReduction" name="animationReduction">
                                                <option value="none">No Reduction</option>
                                                <option value="reduced">Reduced Motion</option>
                                                <option value="minimal">Minimal Animations</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="screenReaderOptimization">Screen Reader Optimization</label>
                                            <select id="screenReaderOptimization" name="screenReaderOptimization">
                                                <option value="auto">Automatic</option>
                                                <option value="enhanced">Enhanced Description</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Display Settings -->
                                    <div class="settings-group">
                                        <h2><i class="fas fa-palette"></i> Display</h2>
                                        <div class="form-group">
                                            <label for="colorScheme">Color Scheme</label>
                                            <select id="colorScheme" name="colorScheme">
                                                <option value="system">Match System</option>
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="accentColor">Accent Color</label>
                                            <select id="accentColor" name="accentColor">
                                                <option value="blue">Blue</option>
                                                <option value="green">Green</option>
                                                <option value="purple">Purple</option>
                                                <option value="orange">Orange</option>
                                                <option value="red">Red</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="defaultFont">Default Font</label>
                                            <select id="defaultFont" name="defaultFont">
                                                <option value="Inter">Inter</option>
                                                <option value="Roboto">Roboto</option>
                                                <option value="Open Sans">Open Sans</option>
                                                <option value="Arial">Arial</option>
                                                <option value="system-ui">System Default</option>
                                            </select>
                                            <div class="preview-text">The quick brown fox jumps over the lazy dog</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="fontSize">Base Font Size</label>
                                            <select id="fontSize" name="fontSize">
                                                <option value="12">Small (12px)</option>
                                                <option value="14">Medium (14px)</option>
                                                <option value="16">Large (16px)</option>
                                                <option value="18">Extra Large (18px)</option>
                                            </select>
                                            <div class="preview-text">Font size preview text</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="density">Layout Density</label>
                                            <select id="density" name="density">
                                                <option value="comfortable">Comfortable</option>
                                                <option value="compact">Compact</option>
                                                <option value="spacious">Spacious</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Data Display Settings -->
                                    <div class="settings-group">
                                        <h2><i class="fas fa-table"></i> Data Display</h2>
                                        <div class="form-group">
                                            <label for="defaultPageSize">Default Items Per Page</label>
                                            <select id="defaultPageSize" name="defaultPageSize">
                                                <option value="10">10 items</option>
                                                <option value="25">25 items</option>
                                                <option value="50">50 items</option>
                                                <option value="100">100 items</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="dataRefreshRate">Data Refresh Rate</label>
                                            <select id="dataRefreshRate" name="dataRefreshRate">
                                                <option value="0">Manual refresh only</option>
                                                <option value="30">Every 30 seconds</option>
                                                <option value="60">Every minute</option>
                                                <option value="300">Every 5 minutes</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="defaultSort">Default Sort Order</label>
                                            <select id="defaultSort" name="defaultSort">
                                                <option value="newest">Newest first</option>
                                                <option value="oldest">Oldest first</option>
                                                <option value="alphabetical">Alphabetical</option>
                                            </select>
                                        </div>                                    </div>

                                    <!-- Form Actions -->
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-approve">
                                            <i class="fas fa-save"></i>
                                            Save General Preferences
                                        </button>
                                        <button type="reset" class="btn btn-secondary">
                                            <i class="fas fa-undo"></i>
                                            Reset to Defaults
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Notifications Tab -->
                        <div class="tab-pane" id="notifications">
                            <div class="settings-section">
                                <div class="notification-preferences">
                                    <div class="section-header">
                                        <h3>Notification Preferences</h3>
                                        <p>Configure how and when you receive notifications</p>
                                    </div>

                                    <form id="notificationPreferencesForm">
                                        <!-- Email Notifications -->
                                        <div class="settings-group">
                                            <h4><i class="fas fa-envelope"></i> Email Notifications</h4>
                                            <div class="notification-toggles">
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="emailAccessRequests">Access Request Updates</label>
                                                        <span class="toggle-description">Receive emails when access requests are submitted or updated</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="emailAccessRequests" name="emailAccessRequests" checked>
                                                        <label for="emailAccessRequests" class="switch"></label>
                                                    </div>
                                                </div>
                                                
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="emailSafetyIncidents">Safety Incidents</label>
                                                        <span class="toggle-description">Get notified about safety incidents and related updates</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="emailSafetyIncidents" name="emailSafetyIncidents" checked>
                                                        <label for="emailSafetyIncidents" class="switch"></label>
                                                    </div>
                                                </div>
                                                
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="emailInspections">Inspection Reminders</label>
                                                        <span class="toggle-description">Receive reminders for upcoming inspections and deadlines</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="emailInspections" name="emailInspections" checked>
                                                        <label for="emailInspections" class="switch"></label>
                                                    </div>
                                                </div>
                                                
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="emailTraining">Training Notifications</label>
                                                        <span class="toggle-description">Get updates about training schedules and requirements</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="emailTraining" name="emailTraining">
                                                        <label for="emailTraining" class="switch"></label>
                                                    </div>
                                                </div>
                                                
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="emailSystemUpdates">System Updates</label>
                                                        <span class="toggle-description">Receive notifications about system maintenance and updates</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="emailSystemUpdates" name="emailSystemUpdates">
                                                        <label for="emailSystemUpdates" class="switch"></label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- In-App Notifications -->
                                        <div class="settings-group">
                                            <h4><i class="fas fa-desktop"></i> In-App Notifications</h4>
                                            <div class="notification-toggles">
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="inAppRealTime">Real-time Updates</label>
                                                        <span class="toggle-description">Show instant notifications for important events</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="inAppRealTime" name="inAppRealTime" checked>
                                                        <label for="inAppRealTime" class="switch"></label>
                                                    </div>
                                                </div>

                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="inAppSound">Sound Notifications</label>
                                                        <span class="toggle-description">Play sound when receiving notifications</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="inAppSound" name="inAppSound">
                                                        <label for="inAppSound" class="switch"></label>
                                                    </div>
                                                </div>

                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="inAppDesktop">Desktop Notifications</label>
                                                        <span class="toggle-description">Show browser notifications even when tab is not active</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="inAppDesktop" name="inAppDesktop">
                                                        <label for="inAppDesktop" class="switch"></label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Notification Frequency -->
                                        <div class="settings-group">
                                            <h4><i class="fas fa-clock"></i> Notification Frequency</h4>
                                            <div class="frequency-settings">
                                                <div class="form-group">
                                                    <label for="notificationFrequency">Email Digest Frequency</label>
                                                    <select id="notificationFrequency" name="notificationFrequency">
                                                        <option value="instant">Instant (as they occur)</option>
                                                        <option value="hourly">Hourly digest</option>
                                                        <option value="daily">Daily digest</option>
                                                        <option value="weekly">Weekly digest</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Priority Settings -->
                                        <div class="settings-group">
                                            <h4><i class="fas fa-exclamation-triangle"></i> Priority Notifications</h4>
                                            <div class="priority-settings">
                                                <div class="toggle-item priority-high">
                                                    <div class="toggle-info">
                                                        <label for="emergencyAlerts">Emergency Alerts</label>
                                                        <span class="toggle-description">Critical safety incidents and emergency situations</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="emergencyAlerts" name="emergencyAlerts" checked>
                                                        <label for="emergencyAlerts" class="switch"></label>
                                                    </div>
                                                </div>

                                                <div class="toggle-item priority-medium">
                                                    <div class="toggle-info">
                                                        <label for="urgentApprovals">Urgent Approvals</label>
                                                        <span class="toggle-description">Time-sensitive approval requests and deadlines</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="urgentApprovals" name="urgentApprovals" checked>
                                                        <label for="urgentApprovals" class="switch"></label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quiet Hours -->
                                        <div class="settings-group">
                                            <h4><i class="fas fa-moon"></i> Quiet Hours</h4>
                                            <div class="quiet-hours-settings">
                                                <div class="toggle-item">
                                                    <div class="toggle-info">
                                                        <label for="quietHours">Enable Quiet Hours</label>
                                                        <span class="toggle-description">Suppress non-critical notifications during specified hours</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="quietHours" name="quietHours">
                                                        <label for="quietHours" class="switch"></label>
                                                    </div>
                                                </div>
                                                
                                                <div id="quietHoursTimes">
                                                    <div class="time-range">
                                                        <div class="form-group">
                                                            <label for="quietStart">Start Time</label>
                                                            <input type="time" id="quietStart" name="quietStart" value="22:00">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="quietEnd">End Time</label>
                                                            <input type="time" id="quietEnd" name="quietEnd" value="08:00">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div class="notification-actions">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i>
                                                Save Notification Settings
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="testNotifications">
                                                <i class="fas fa-bell"></i>
                                                Test Notifications
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" id="clearNotifications">
                                                <i class="fas fa-trash"></i>
                                                Clear All Notifications
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Email Notification History -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h3><i class="fas fa-history"></i> Email Notification History</h3>
                                    <p>View your recent email notification history</p>
                                </div>
                                <div class="email-history-container">
                                    <div class="table-toolbar">
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="emailHistorySearch" placeholder="Search notifications...">
                                        </div>
                                        <div class="table-actions">
                                            <button class="btn btn-outline-primary" id="refreshEmailHistory">
                                                <i class="fas fa-sync-alt"></i> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table" id="emailHistoryTable">
                                            <thead>
                                                <tr>
                                                    <th>Date/Time</th>
                                                    <th>Subject</th>
                                                    <th>Recipient</th>
                                                    <th>Status</th>
                                                    <th>Category</th>
                                                </tr>
                                            </thead>
                                            <tbody id="emailHistoryTableBody">
                                                <!-- Email history rows will be dynamically added here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="emailHistoryPagination" class="pagination-controls">
                                        <!-- Pagination controls will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accessibility Tab -->
                        <div class="tab-pane" id="accessibility">
                            <div class="settings-section">
                                <div class="section-header">
                                    <h3>Accessibility Settings</h3>
                                    <p>Customize the interface to improve accessibility</p>
                                </div>
                                <form id="accessibilityForm">
                                    <!-- Font Size -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-text-height"></i> Text Size</h4>
                                        <div class="form-group">
                                            <label for="fontSize">Base Font Size</label>
                                            <select id="fontSize" name="fontSize">
                                                <option value="small">Small</option>
                                                <option value="medium" selected>Medium</option>
                                                <option value="large">Large</option>
                                                <option value="x-large">Extra Large</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Contrast Settings -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-adjust"></i> Contrast</h4>
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <label for="highContrast">High Contrast Mode</label>
                                                <span class="toggle-description">Increase contrast for better readability</span>
                                            </div>
                                            <div class="toggle-switch">
                                                <input type="checkbox" id="highContrast" name="highContrast">
                                                <label for="highContrast" class="switch"></label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Motion Settings -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-running"></i> Motion</h4>
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <label for="reduceMotion">Reduce Motion</label>
                                                <span class="toggle-description">Minimize animations and transitions</span>
                                            </div>
                                            <div class="toggle-switch">
                                                <input type="checkbox" id="reduceMotion" name="reduceMotion">
                                                <label for="reduceMotion" class="switch"></label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            Save Accessibility Settings
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Privacy & Security Tab -->
                        <div class="tab-pane" id="privacy">
                            <div class="settings-section">
                                <div class="section-header">
                                    <h3>Privacy & Security Settings</h3>
                                    <p>Configure your privacy and security preferences</p>
                                </div>
                                <form id="privacyForm">
                                    <!-- Data Sharing -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-share-alt"></i> Data Sharing</h4>
                                        <div class="form-group">
                                            <label for="dataSharing">Data Sharing Level</label>
                                            <select id="dataSharing" name="dataSharing">
                                                <option value="minimal">Minimal (Required only)</option>
                                                <option value="standard" selected>Standard</option>
                                                <option value="enhanced">Enhanced Analytics</option>
                                            </select>
                                            <div class="form-hint">Controls how your usage data is shared for analytics</div>
                                        </div>
                                    </div>

                                    <!-- Session Settings -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-clock"></i> Session Settings</h4>
                                        <div class="form-group">
                                            <label for="sessionTimeout">Session Timeout</label>
                                            <select id="sessionTimeout" name="sessionTimeout">
                                                <option value="30">30 minutes</option>
                                                <option value="60" selected>1 hour</option>
                                                <option value="120">2 hours</option>
                                                <option value="240">4 hours</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Two-Factor Authentication -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-lock"></i> Authentication</h4>
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <label for="twoFactorAuth">Two-Factor Authentication</label>
                                                <span class="toggle-description">Require verification code when signing in</span>
                                            </div>
                                            <div class="toggle-switch">
                                                <input type="checkbox" id="twoFactorAuth" name="twoFactorAuth">
                                                <label for="twoFactorAuth" class="switch"></label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            Save Privacy Settings
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/roles.js"></script>
    <script type="module" src="js/notifications.js"></script>
    <script type="module" src="js/preferences.js"></script>
      <!-- Fallback tab functionality in case modules fail to load -->
    <script>
        // Enhanced tab functionality with better error handling
        function initSimpleTabs() {
            console.log('Initializing enhanced tab functionality...');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            if (tabButtons.length === 0 || tabPanes.length === 0) {
                console.error('No tabs found for initialization. Buttons:', tabButtons.length, 'Panes:', tabPanes.length);
                return;
            }
            
            console.log('Found', tabButtons.length, 'tab buttons and', tabPanes.length, 'tab panes');
            
            // Add click handlers to tab buttons
            tabButtons.forEach((button, index) => {
                console.log(`Setting up tab ${index + 1}:`, button.getAttribute('data-tab'));
                
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const targetId = button.getAttribute('data-tab');
                    console.log('Tab clicked:', targetId);
                    
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    button.classList.add('active');
                    const targetPane = document.getElementById(targetId);
                    
                    if (targetPane) {
                        targetPane.classList.add('active');
                        console.log('Successfully activated tab:', targetId);
                        
                        // Save last active tab
                        try {
                            localStorage.setItem('lastActivePreferencesTab', targetId);
                        } catch (e) {
                            console.warn('Could not save to localStorage:', e);
                        }
                    } else {
                        console.error('Target pane not found:', targetId);
                    }
                });
            });
            
            // Restore last active tab if exists
            try {
                const lastActiveTab = localStorage.getItem('lastActivePreferencesTab');
                if (lastActiveTab && lastActiveTab !== 'general') {
                    const button = document.querySelector(`[data-tab="${lastActiveTab}"]`);
                    if (button) {
                        console.log('Restoring last active tab:', lastActiveTab);
                        button.click();
                    }
                }
            } catch (e) {
                console.warn('Could not restore last active tab:', e);
            }
            
            console.log('Enhanced tab initialization complete');
        }
        
        // Ensure tabs are initialized regardless of module loading
        let tabsInitialized = false;
        
        function ensureTabsInitialized() {
            if (!tabsInitialized) {
                initSimpleTabs();
                tabsInitialized = true;
            }
        }
        
        // Initialize immediately if DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', ensureTabsInitialized);
        } else {
            ensureTabsInitialized();
        }
        
        // Also initialize after modules should be loaded
        setTimeout(ensureTabsInitialized, 1000);
        
        // Final fallback
        window.addEventListener('load', ensureTabsInitialized);
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }

  // ============================================
  // FEATURE-BASED MENU AUTHORIZATION SYSTEM
  // ============================================
  // Enhanced menu visibility system based on roles.html template
  
  // Reset all menu items to hidden
  function resetMenuVisibility() {
      document.querySelectorAll('[data-feature]').forEach(item => {
          item.classList.remove('menu-visible');
      });
      document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
          dropdown.classList.remove('menu-visible');
      });
  }

  // Emergency fallback - show basic menu items
  function showBasicMenu() {
      console.log('🔧 Emergency fallback: Showing basic menu items');
      resetMenuVisibility();
      const homeItem = document.querySelector('[data-feature="home_view"]');
      if (homeItem) {
          homeItem.classList.add('menu-visible');
      }
  }

  // Feature-based authorization system that takes priority over role permissions
  async function updateMenuWithFeatureAuthorization() {
      console.log('🎯 Starting feature-based menu authorization for preferences.html...');
      
      try {
          let currentUser = null;
          let companyId = null;
          
          // Get user and company info using authManager first
          if (window.authManager && window.authManager.currentUser) {
              currentUser = window.authManager.currentUser;
              companyId = currentUser.companyId;
              console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
          } else if (firebase.auth().currentUser) {
              currentUser = firebase.auth().currentUser;
              console.log('👤 Using Firebase auth - will search for company');
          } else {
              console.log('❌ No authenticated user found');
              resetMenuVisibility();
              return;
          }
          
          // If no company ID from authManager, search companies collection
          if (!companyId && currentUser) {
              console.log('🔍 Searching for user company...');
              const database = firebase.database();
              const companiesRef = database.ref('companies');
              const companiesSnapshot = await companiesRef.once('value');
              
              if (companiesSnapshot.exists()) {
                  const companies = companiesSnapshot.val();
                  
                  for (const [cId, company] of Object.entries(companies)) {
                      if (company.status !== 'active') continue;
                      
                      if (company.users && company.users[currentUser.uid]) {
                          companyId = cId;
                          console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                          break;
                      }
                  }
              }
          }
          
          if (!companyId) {
              console.error('❌ No company ID found, cannot determine authorized features');
              resetMenuVisibility();
              return;
          }
          
          // Apply feature-based authorization
          await applyFeatureBasedMenuVisibility(companyId);
          
      } catch (error) {
          console.error('❌ Error in feature-based menu authorization:', error);
          resetMenuVisibility();
      }
  }

  // Apply feature-based menu visibility
  async function applyFeatureBasedMenuVisibility(companyId) {
      try {
          console.log('🔧 Applying feature-based menu visibility for company:', companyId);
          
          // Get platform features
          const database = firebase.database();
          const featuresSnapshot = await database.ref('/platformFeatures').once('value');
          
          if (!featuresSnapshot.exists()) {
              console.log('⚠️ No platform features found');
              resetMenuVisibility();
              return;
          }
          
          const featuresData = featuresSnapshot.val();
          
          // Get company's selected features
          const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
          const companyData = companySnapshot.val();
          
          if (!companyData) {
              console.error('❌ Company data not found');
              resetMenuVisibility();
              return;
          }
          
          const subscribedFeatureIds = companyData.selectedFeatures || [];
          console.log('🏢 Company subscribed features:', subscribedFeatureIds);
          
          if (subscribedFeatureIds.length === 0) {
              console.log('⚠️ Company has no subscribed features');
              resetMenuVisibility();
              return;
          }
          
          // Collect authorized pages from subscribed features
          const authorizedPages = [];
          subscribedFeatureIds.forEach(featureId => {
              const feature = featuresData[featureId];
              if (feature && feature.status === 'active' && feature.authorizedPages) {
                  console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                  authorizedPages.push(...feature.authorizedPages);
              } else {
                  console.log(`⚠️ Feature ${featureId} not found or inactive`);
              }
          });
          
          console.log('🔐 All authorized pages:', authorizedPages);
          
          // Reset all menu items first
          resetMenuVisibility();
          
          // Create set of authorized features
          const authorizedFeatures = new Set();
          authorizedPages.forEach(pageInfo => {
              if (pageInfo.feature) {
                  authorizedFeatures.add(pageInfo.feature);
              }
          });
          
          console.log('🎯 Authorized features for preferences.html:', Array.from(authorizedFeatures));
          
          // Apply menu visibility
          const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
          let visibleCount = 0;
          
          allMenuItems.forEach(menuItem => {
              const featureAttribute = menuItem.getAttribute('data-feature');
              const isAuthorized = authorizedFeatures.has(featureAttribute);
              const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
              
              if (isDropdownContainer) {
                  return; // Handle dropdowns separately after all items are processed
              }
              
              if (isAuthorized) {
                  menuItem.classList.add('menu-visible');
                  visibleCount++;
                  console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
              } else {
                  menuItem.classList.remove('menu-visible');
                  console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
              }
          });
          
          // Handle dropdown menus - show if they have visible children
          const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
          dropdownMenus.forEach(dropdown => {
              const dropdownFeature = dropdown.getAttribute('data-feature');
              const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
              let hasVisibleChildren = false;
              
              submenuItems.forEach(submenuItem => {
                  if (submenuItem.classList.contains('menu-visible')) {
                      hasVisibleChildren = true;
                  }
              });
              
              if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                  dropdown.classList.add('menu-visible');
                  console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
              } else {
                  dropdown.classList.remove('menu-visible');
                  console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
              }
          });
          
          console.log(`🎯 Feature-based menu authorization completed for preferences.html - ${visibleCount} items visible`);
          
      } catch (error) {
          console.error('❌ Error applying feature-based menu visibility:', error);
          resetMenuVisibility();
      }
  }

  // Make updateMenuWithFeatureAuthorization available globally
  window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

  // Enhanced initialization - use feature-based authorization by default
  setTimeout(async () => {
      try {
          await updateMenuWithFeatureAuthorization();
      } catch (error) {
          console.error('❌ Error initializing feature-based menu:', error);
          showBasicMenu();
      }
  }, 1500);
});
</script>
</body>
</html>
