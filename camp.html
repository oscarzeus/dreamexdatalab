<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accommodation - Dreamex Datalab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase v8 Scripts for Centralized Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
            --header-height: 60px;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: #fff;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #fff;
            text-decoration: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu a.active {
            background-color: var(--accent-color);
        }

        .submenu {
            list-style: none;
            margin-left: 1rem;
            margin-top: 0.5rem;
            display: none;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        .submenu a {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.3rem;
            padding-top: 3.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            transition: margin-left 0.3s ease;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.3rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            height: 50px;
            min-height: 50px;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--dark-color);
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: var(--light-color);
        }

        /* Company Branding */
        .company-branding {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-company-logo {
            height: 35px;
            width: auto;
            border-radius: 4px;
        }

        .company-name-header {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
            width: 40px;
            height: 40px;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .profile-dropdown li {
            border-bottom: 1px solid #eee;
        }

        .profile-dropdown li:last-child {
            border-bottom: none;
        }

        .profile-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--dark-color);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown a:hover {
            background-color: #f8f9fa;
        }

        /* Essential Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Hide ALL menu items by default during loading */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature] {
            display: none !important;
        }

        /* Allow menu-visible items to show even during loading */
        .sidebar.menu-loading .menu-visible,
        .sidebar.menu-loading li.menu-visible,
        .sidebar.menu-loading [data-feature].menu-visible {
            display: block !important;
        }

        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Ensure menu-visible items are always shown */
        .menu-visible {
            display: block !important;
        }

        li.menu-visible,
        [data-feature].menu-visible {
            display: block !important;
        }

        /* Page Content */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            margin: 0.35rem 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }

        .page-header i {
            font-size: 1rem;
        }

        .page-header h1 {
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            margin: 0;
            font-weight: 600;
        }

        /* Add New Button */
        .btn-add-new {
            background: none;
            border: none;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-add-new:hover {
            color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .btn-add-new i {
            font-size: 1.2rem;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            gap: 0.1rem;
            margin-bottom: 0.2rem;
            margin-top: 0.1rem;
        }

        .card {
            background: white;
            border-radius: 3px;
            padding: 0.2rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
            min-height: 35px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.05rem;
        }

        .card-header > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title {
            font-size: 0.55rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            line-height: 1;
            white-space: nowrap;
        }

        .card-value {
            font-size: 0.75rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0;
            line-height: 1;
        }

        .card-icon {
            font-size: 0.75rem;
            opacity: 0.3;
        }

        /* Search and Filter Styles */
        .table-header {
            display: none; /* Hide the entire table header with search/filters */
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .search-filters {
            display: none; /* Hide search filters */
        }

        .search-filters input,
        .search-filters select {
            padding: 0.35rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 5px;
            background: white;
        }

        .search-filters input {
            width: 180px;
        }

        .search-filters select {
            width: 120px;
            cursor: pointer;
        }

        .search-filters input:focus,
        .search-filters select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .tab-button:hover {
            background: #f8fafc;
            color: var(--primary-color);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f8fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings Tab Styles */
        .settings-section{border:1px solid #e5e7eb;border-radius:8px;margin-bottom:1rem;overflow:hidden;}
        .settings-section h3{font-size:.9rem;font-weight:600;color:#374151;padding:.8rem 1rem;margin:0;cursor:pointer;background:#f9fafb;display:flex;align-items:center;gap:8px;justify-content:space-between;transition:background .2s;}
        .settings-section h3:hover{background:#f3f4f6;}
        .settings-section h3 .toggle-icon{font-size:.7rem;color:#9ca3af;transition:transform .2s;}
        .settings-section.collapsed h3 .toggle-icon{transform:rotate(-90deg);}
        .settings-section-content{padding:1rem;border-top:1px solid #e5e7eb;}
        .settings-section.collapsed .settings-section-content{display:none;}
        .access-control-table{width:100%;border-collapse:collapse;font-size:.75rem;}
        .access-control-table th,.access-control-table td{padding:8px 10px;text-align:left;border-bottom:1px solid #e5e7eb;}
        .access-control-table th{background:#f9fafb;font-weight:600;color:#374151;font-size:.7rem;text-transform:uppercase;letter-spacing:.02em;}
        .access-control-table tbody tr:hover{background:#f9fafb;}
        .access-control-table input[type="checkbox"]{width:16px;height:16px;cursor:pointer;}
        .ac-add-btn{background:var(--primary-color);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
        .ac-add-btn:hover{opacity:.9;}
        .ac-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:3000;}
        .ac-modal-content{background:#fff;border-radius:12px;width:100%;max-width:450px;box-shadow:0 10px 40px rgba(0,0,0,.2);}
        .ac-modal-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;}
        .ac-modal-header h3{margin:0;font-size:1rem;color:#111827;display:flex;align-items:center;gap:8px;}
        .ac-modal-close{background:none;border:none;font-size:1.4rem;color:#6b7280;cursor:pointer;}
        .ac-modal-body{padding:20px;}
        .ac-modal-body .form-group{margin-bottom:16px;}
        .ac-modal-body .form-group label{display:block;font-size:.8rem;font-weight:600;color:#374151;margin-bottom:6px;}
        .ac-modal-body .checkbox-group{display:flex;flex-direction:column;gap:8px;}
        .ac-modal-body .checkbox-item{display:flex;align-items:center;gap:8px;font-size:.8rem;color:#374151;}
        .ac-modal-body .checkbox-item input{width:16px;height:16px;}
        .ac-modal-footer{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;}
        .ac-modal-footer .btn{padding:8px 16px;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;}
        .ac-modal-footer .btn-cancel{background:#f3f4f6;border:1px solid #d1d5db;color:#374151;}
        .ac-modal-footer .btn-save{background:var(--primary-color);border:none;color:#fff;}
        .ac-user-autocomplete{position:relative;}
        .ac-user-autocomplete input{width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:.85rem;}
        .ac-user-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d5db;border-radius:6px;max-height:200px;overflow-y:auto;display:none;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.1);}
        .ac-user-dropdown .item{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:.8rem;}
        .ac-user-dropdown .item:hover{background:#f3f4f6;}
        .delete-btn{background:#fee2e2;color:#dc2626;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:.7rem;}
        .delete-btn:hover{background:#fecaca;}

        /* Batch Selection Styles */
        .batch-checkbox{width:16px;height:16px;cursor:pointer;accent-color:var(--primary-color);}
        .batch-action-bar{display:none;align-items:center;gap:12px;padding:10px 16px;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;margin-bottom:12px;}
        .batch-action-bar.visible{display:flex;}
        .batch-action-bar .selected-count{font-size:.75rem;font-weight:600;color:#92400e;}
        .batch-action-bar .batch-btn{padding:6px 12px;border:none;border-radius:6px;font-size:.7rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .2s;}
        .batch-action-bar .batch-btn-delete{background:#ef4444;color:#fff;}
        .batch-action-bar .batch-btn-delete:hover{background:#dc2626;}
        .batch-action-bar .batch-btn-cancel{background:#e5e7eb;color:#374151;}
        .batch-action-bar .batch-btn-cancel:hover{background:#d1d5db;}
        tr.selected{background:#fef3c7 !important;}
        .row-checkbox-cell{width:30px;text-align:center;}
        
        /* Column Filter Button Styles */
        .col-filter-btn{background:none;border:none;padding:2px 4px;cursor:pointer;color:#6b7280;border-radius:3px;transition:all .2s;}
        .col-filter-btn:hover{background:#e5e7eb;color:#374151;}
        .col-filter-btn.active{background:#3b82f6;color:#fff;}
        .col-filter-btn.has-filter{color:#3b82f6;}
        .col-filter-popup{margin-top:4px;z-index:9999 !important;}
        .col-filter-checkboxes{display:flex;flex-direction:column;gap:2px;}
        .col-filter-item{display:flex;align-items:center;gap:6px;padding:3px 4px;font-size:.72rem;cursor:pointer;border-radius:3px;transition:background .15s;}
        .col-filter-item:hover{background:#f3f4f6;}
        .col-filter-item input[type="checkbox"]{margin:0;cursor:pointer;}
        .col-filter-item label{cursor:pointer;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .col-filter-item.select-all{border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin-bottom:3px;font-weight:600;}
        #assignmentsTable thead{position:relative;z-index:10;}
        #assignmentsTable thead th{position:relative;}
        .table-scrollable{overflow:visible !important;}

        /* Employee Search Styles */
        .employee-search-container{position:relative;}
        .employee-search-input{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;font-size:0.85rem;}
        .employee-search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
        .employee-search-result{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s;}
        .employee-search-result:hover{background:#f8f9fa;}
        .employee-search-result:last-child{border-bottom:none;}
        .employee-search-result .emp-name{font-weight:600;color:#333;font-size:0.9rem;}
        .employee-search-result .emp-info{font-size:0.75rem;color:#666;margin-top:2px;}
        .employee-search-result.no-results{color:#999;font-style:italic;cursor:default;}
        .employee-search-result.no-results:hover{background:#fff;}

        /* Room Search Styles */
        .room-search-container{position:relative;}
        .room-search-input{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;font-size:0.85rem;}
        .room-search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
        .room-search-result{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s;}
        .room-search-result:hover{background:#f8f9fa;}
        .room-search-result:last-child{border-bottom:none;}
        .room-search-result .room-name{font-weight:600;color:#333;font-size:0.9rem;}
        .room-search-result .room-info{font-size:0.75rem;color:#666;margin-top:2px;}
        .room-search-result.no-results{color:#999;font-style:italic;cursor:default;}
        .room-search-result.no-results:hover{background:#fff;}

        /* Meal Search Styles */
        .meal-search-container{position:relative;}
        .meal-search-input{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;font-size:0.85rem;}
        .meal-search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
        .meal-search-result{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s;}
        .meal-search-result:hover{background:#f8f9fa;}
        .meal-search-result:last-child{border-bottom:none;}
        .meal-search-result .meal-name{font-weight:600;color:#333;font-size:0.9rem;}
        .meal-search-result .meal-info{font-size:0.75rem;color:#666;margin-top:2px;}
        .meal-search-result.no-results{color:#999;font-style:italic;cursor:default;}
        .meal-search-result.no-results:hover{background:#fff;}
        .meal-search-result.selected{background:#eff6ff;border-left:3px solid #3b82f6;}
        .selected-meals-container{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
        .selected-meal-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#eff6ff;border:1px solid #3b82f6;border-radius:16px;font-size:0.8rem;color:#1d4ed8;}
        .selected-meal-tag .remove-meal{cursor:pointer;font-weight:bold;margin-left:4px;color:#ef4444;}
        .selected-meal-tag .remove-meal:hover{color:#dc2626;}

        /* Assignment Details Modal Styles */
        .assignment-detail-row{display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0;}
        .assignment-detail-row:last-child{border-bottom:none;}
        .assignment-detail-label{width:130px;font-weight:600;color:#6b7280;font-size:0.85rem;}
        .assignment-detail-value{flex:1;color:#111827;font-size:0.9rem;}
        .assignment-detail-value .badge{font-size:0.75rem;}
        .assignment-details-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding-top:8px;}
        .assignment-details-actions .btn{display:inline-flex;align-items:center;gap:6px;}

        /* Meal Types Checkbox Grid */
        .meal-types-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;max-height:150px;overflow-y:auto;padding:8px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;}
        .meal-type-checkbox{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:6px;cursor:pointer;transition:all .2s;}
        .meal-type-checkbox:hover{border-color:#3b82f6;background:#eff6ff;}
        .meal-type-checkbox input[type="checkbox"]{width:16px;height:16px;cursor:pointer;}
        .meal-type-checkbox .meal-info{flex:1;min-width:0;}
        .meal-type-checkbox .meal-name{font-size:0.85rem;font-weight:500;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .meal-type-checkbox .meal-price{font-size:0.7rem;color:#6b7280;}
        .meal-type-checkbox.selected{border-color:#3b82f6;background:#eff6ff;}

        /* Invoice A4 Styles - matching accessboard.html gate pass design */
        .invoice-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:flex-start;justify-content:center;padding:20px;z-index:2000;overflow-y:auto;}
        .invoice-modal-backdrop.hidden{display:none;}
        .invoice-modal-panel{background:#f5f6fa;width:100%;max-width:240mm;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:90vh;}
        .invoice-modal-header{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:12px 12px 0 0;}
        .invoice-modal-title{font-weight:600;display:flex;align-items:center;gap:6px;font-size:0.9rem;color:#1f2937;}
        .invoice-modal-close{background:none;border:none;font-size:1rem;cursor:pointer;color:#64748b;padding:.35rem;border-radius:6px;}
        .invoice-modal-close:hover{background:#f1f5f9;color:#111;}
        .invoice-modal-body{padding:18px 20px;overflow-y:auto;display:flex;flex-direction:column;gap:0;font-size:0.75rem;background:#f5f6fa;}
        .invoice-modal-footer{padding:12px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:.5rem;background:#fff;border-radius:0 0 12px 12px;}
        /* A4 Sheet */
        .invoice-a4-sheet{position:relative;width:190mm;min-height:auto;margin:0 auto;background:#fff;border:none;border-radius:0;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:2mm 2mm 18mm;box-sizing:border-box;color:#111827;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;}
        .invoice-a4-header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:0;}
        .invoice-company-block{display:flex;flex-direction:column;align-items:flex-start;gap:8px;}
        .invoice-a4-logo{width:100px;height:100px;border-radius:8px;object-fit:contain;background:#fff;border:none;display:block;}
        .invoice-a4-company h1{margin:0;font-size:1.1rem;line-height:1.2;font-weight:700;}
        .invoice-a4-company .doc-title{font-size:.9rem;font-weight:700;margin:2px 0 0;color:#111827;text-align:left;}
        .invoice-divider{height:1px;background:#e5e7eb;margin:12px 0 18px;border-radius:1px;}
        /* Sections */
        .invoice-a4-section{margin:4px 0;}
        .invoice-a4-section-title{font-size:.75rem;margin:0 0 8px;display:flex;align-items:center;gap:8px;font-weight:600;color:#fff;background:var(--primary-color, #2c3e50);padding:6px 10px;border-radius:0;}
        .invoice-a4-section-title i{font-size:.8rem;color:#fff;}
        .invoice-a4-section-title .section-text{flex:1;}
        /* Tables */
        .invoice-a4-info-table{width:100%;border-collapse:collapse;font-size:.66rem;}
        .invoice-a4-info-table th{background:var(--primary-color, #2c3e50);font-weight:600;text-transform:none;font-size:.58rem;letter-spacing:.01em;color:#ffffff;padding:6px;border:1px solid var(--primary-color, #2c3e50);text-align:left;}
        .invoice-a4-info-table td{padding:6px;border:1px solid #e5e7eb;vertical-align:top;background:#fff;color:#111827;}
        .invoice-a4-info-table tbody tr:nth-child(odd) td{background:#f9fafb;}
        .invoice-a4-info-table tbody tr:nth-child(even) td{background:#ffffff;}
        .invoice-a4-info-table .text-right{text-align:right;}
        .invoice-a4-info-table .text-center{text-align:center;}
        /* Summary */
        .invoice-summary-section{margin-top:10px;display:flex;justify-content:flex-end;}
        .invoice-summary-table{width:250px;border-collapse:collapse;font-size:.66rem;}
        .invoice-summary-table td{padding:6px 8px;border:1px solid #e5e7eb;}
        .invoice-summary-table tr.total td{background:var(--primary-color, #2c3e50);color:#fff;font-weight:700;}
        /* Notes */
        .invoice-notes-box{background:#f9fafb;border:1px solid #d1d5db;padding:10px 12px;min-height:40px;font-size:.74rem;line-height:1.5;color:#374151;margin-top:8px;}
        /* Status chip */
        .invoice-status-chip{display:inline-block;font-size:.55rem;font-weight:600;letter-spacing:.02em;padding:2px 8px;border-radius:4px;}
        .invoice-status-chip.assigned{color:#1d4ed8;background:#dbeafe;}
        .invoice-status-chip.checked_in{color:#166534;background:#dcfce7;}
        .invoice-status-chip.checked_out{color:#6b7280;background:#f3f4f6;}
        .invoice-status-chip.cancelled{color:#991b1b;background:#fee2e2;}
        /* Print styles - exact same design as modal */
        @media print{
            @page { size: A4; margin: 5mm; }
            
            /* Hide everything by default */
            html, body { 
                margin: 0 !important; 
                padding: 0 !important; 
                background: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body * { visibility: hidden !important; }
            
            /* Show printable area and all children */
            #assignmentInvoiceModal,
            #assignmentInvoiceModal * { 
                visibility: visible !important;
            }
            
            /* Position the print area */
            #assignmentInvoiceModal {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                background: #fff !important;
            }
            
            .invoice-modal-backdrop {
                position: static !important;
                background: #fff !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
                overflow: visible !important;
            }
            
            .invoice-modal-panel {
                position: static !important;
                box-shadow: none !important;
                width: 100% !important;
                max-width: 100% !important;
                background: #fff !important;
                border-radius: 0 !important;
                max-height: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .invoice-modal-header, .invoice-modal-footer {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .invoice-modal-body {
                overflow: visible !important;
                padding: 0 !important;
                margin: 0 !important;
                background: #fff !important;
                max-height: none !important;
            }
            
            /* A4 Sheet - keep same styling */
            .invoice-a4-sheet {
                width: 100% !important;
                margin: 0 !important;
                padding: 2mm !important;
                box-shadow: none !important;
                border: none !important;
                background: #fff !important;
                font-size: 0.75rem !important;
                line-height: 1.4 !important;
                color: #111827 !important;
                font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif !important;
            }
            
            /* Header */
            .invoice-a4-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                gap: 20px !important;
            }
            
            .invoice-company-block {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            
            .invoice-a4-logo {
                width: 100px !important;
                height: 100px !important;
                border-radius: 8px !important;
                object-fit: contain !important;
            }
            
            .invoice-a4-company h1 {
                font-size: 1.1rem !important;
                font-weight: 700 !important;
            }
            
            .invoice-a4-company .doc-title {
                font-size: 0.9rem !important;
                font-weight: 700 !important;
                color: #111827 !important;
            }
            
            /* Section styling - exact same as modal */
            .invoice-a4-section {
                margin: 2px 0 !important;
                padding: 0 !important;
                page-break-inside: auto !important;
            }
            
            .invoice-a4-section-title {
                font-size: 0.75rem !important;
                margin: 0 0 4px !important;
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                font-weight: 600 !important;
                color: #fff !important;
                background: #2c3e50 !important;
                padding: 6px 10px !important;
                border-radius: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-a4-section-title i {
                font-size: 0.8rem !important;
                color: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Table styling - exact same as modal */
            .invoice-a4-info-table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 0.66rem !important;
                margin-top: 2px !important;
            }
            
            .invoice-a4-info-table th {
                background: #2c3e50 !important;
                font-weight: 600 !important;
                font-size: 0.58rem !important;
                color: #ffffff !important;
                padding: 4px 6px !important;
                border: 1px solid #2c3e50 !important;
                text-align: left !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-a4-info-table td {
                padding: 4px 6px !important;
                border: 1px solid #e5e7eb !important;
                vertical-align: top !important;
                color: #111827 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-a4-info-table tbody tr:nth-child(odd) td {
                background: #f9fafb !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-a4-info-table tbody tr:nth-child(even) td {
                background: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-a4-info-table .text-right { text-align: right !important; }
            .invoice-a4-info-table .text-center { text-align: center !important; }
            
            /* Summary table - exact same as modal */
            .invoice-summary-section {
                margin-top: 6px !important;
                display: flex !important;
                justify-content: flex-end !important;
            }
            
            .invoice-summary-table {
                width: 250px !important;
                border-collapse: collapse !important;
                font-size: 0.66rem !important;
            }
            
            .invoice-summary-table td {
                padding: 6px 8px !important;
                border: 1px solid #e5e7eb !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-summary-table tr.total td {
                background: #2c3e50 !important;
                color: #fff !important;
                font-weight: 700 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Notes box - exact same as modal */
            .invoice-notes-box {
                background: #f9fafb !important;
                border: 1px solid #d1d5db !important;
                padding: 8px 10px !important;
                font-size: 0.74rem !important;
                color: #374151 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Reduce section spacing in print */
            .invoice-a4-section { margin: 0 !important; }
            .invoice-a4-section + .invoice-a4-section { margin-top: 4px !important; }
            .invoice-a4-section table { margin-top: 0 !important; }

            /* Hide trailing footer note to prevent blank page */
            .invoice-footer-note { display: none !important; }
            
            /* Status chips - exact same as modal */
            .invoice-status-chip {
                display: inline-block !important;
                font-size: 0.55rem !important;
                font-weight: 600 !important;
                padding: 2px 8px !important;
                border-radius: 4px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-status-chip.assigned {
                color: #1d4ed8 !important;
                background: #dbeafe !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-status-chip.checked_in {
                color: #166534 !important;
                background: #dcfce7 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-status-chip.checked_out {
                color: #6b7280 !important;
                background: #f3f4f6 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice-status-chip.cancelled {
                color: #991b1b !important;
                background: #fee2e2 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Month header rows - blue background */
            tr[style*="background:#e3f2fd"],
            tr[style*="background:#e3f2fd"] td {
                background: #e3f2fd !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Subtotal rows - gray background */
            tr[style*="background:#f5f5f5"],
            tr[style*="background:#f5f5f5"] td {
                background: #f5f5f5 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Green subtotal cells */
            td[style*="background:#c8e6c9"] {
                background: #c8e6c9 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Orange subtotal cells */
            td[style*="background:#ffe0b2"] {
                background: #ffe0b2 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Hide buttons */
            .btn { display: none !important; visibility: hidden !important; }
            
            /* Prevent empty pages */
            @page { orphans: 1; widows: 1; }
            * { page-break-before: auto !important; page-break-after: auto !important; page-break-inside: auto !important; }
            .invoice-a4-sheet { min-height: 0 !important; height: auto !important; }
        }

        .archive-info {
            font-size: 0.85rem;
            color: #64748b;
            font-style: italic;
        }

        /* Table Styles - matching campset.html */
        .table-wrapper { 
            overflow: hidden;
            border: 1px solid #e2e8f0; 
            border-radius: 0 0 8px 8px; 
            background: white;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.08);
            height: calc(100vh - 280px);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .table-wrapper:hover {
            box-shadow: 0 12px 32px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .table-scrollable {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0;
            width: 100%;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            table-layout: fixed;
        }
        
        table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--primary-color);
        }
        
        table thead th {
            background: var(--primary-color);
            color: #ffffff;
            padding: 0.8rem;
            font-weight: 600;
            font-size: 0.75rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.25);
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Define specific column widths for proper alignment */
    /* Updated widths for 8 columns with added Location */
    table th:nth-child(1), table td:nth-child(1) { width: 10%; } /* Room */
    table th:nth-child(2), table td:nth-child(2) { width: 12%; } /* Location */
    table th:nth-child(3), table td:nth-child(3) { width: 18%; } /* Employee */
    table th:nth-child(4), table td:nth-child(4) { width: 12%; } /* Check-in Date */
    table th:nth-child(5), table td:nth-child(5) { width: 12%; } /* Check-out Date */
    table th:nth-child(6), table td:nth-child(6) { width: 10%; } /* Period/Duration */
    table th:nth-child(7), table td:nth-child(7) { width: 10%; } /* Status */
    table th:nth-child(8), table td:nth-child(8) { width: 16%; } /* Actions */
        
        table tbody td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* A4 Format Styles - QuickBooks-like Reports */
        .a4-report-container {
            display: none; /* Hidden by default */
            background: white;
            margin: 0 auto;
            padding: 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            min-height: 297mm; /* A4 height */
            width: 210mm; /* A4 width */
            max-width: 210mm;
            font-family: 'Arial', sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #000;
            position: relative;
        }

        .a4-report-container.show {
            display: block;
        }

        .a4-report-header {
            padding: 12mm 10mm 6mm 10mm;
            border-bottom: none;
            margin-bottom: 8mm;
        }

        .a4-header-row { display:flex; align-items:flex-start; justify-content:space-between; gap:10mm; }
        .a4-brand { display:flex; align-items:center; gap:6mm; }
        .a4-brand-logo { height:20mm; width:auto; border-radius:2mm; }
        .a4-company-info { display:flex; flex-direction:column; gap:2mm; }

        .a4-company-name {
            font-size: 16pt;
            font-weight: 700;
            line-height: 1.1;
        }

        .a4-report-title {
            font-size: 13pt;
            font-weight: 700;
            margin: 0;
        }

        .a4-report-subtitle {
            font-size: 9pt;
            color: #475569;
            margin-top: 1mm;
        }

        .a4-report-content {
            padding: 0 10mm 18mm 10mm;
            margin-bottom: 12mm;
        }

        .a4-meta-banner { margin: 0 10mm 8mm 10mm; background:#f8fafc; border:1px solid #e2e8f0; border-left:3px solid #2563eb; padding:4mm 5mm; font-size:9pt; color:#1f2937; }

        .a4-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10mm;
            font-size: 9pt;
        }

        .a4-report-table th {
            background-color: var(--primary-color);
            color: #ffffff;
            border: 1px solid #ccc;
            border-color: rgba(0,0,0,0.08);
            padding: 3mm 2mm;
            text-align: left;
            font-weight: bold;
            font-size: 9pt;
        }

        .a4-report-table td {
            border: 1px solid #ddd;
            padding: 2mm;
            vertical-align: top;
            font-size: 8pt;
        }

        .a4-report-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .a4-report-footer {
            position: fixed;
            bottom: 10mm;
            left: 10mm;
            right: 10mm;
            border-top: 1px solid #cbd5e1;
            padding-top: 3mm;
            font-size: 8pt;
            color: #475569;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .a4-page-break {
            page-break-before: always;
        }

        .a4-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40mm, 1fr));
            gap: 5mm;
            margin-bottom: 10mm;
            padding: 5mm;
            background-color: #f8f9f8;
            border: 1px solid #ddd;
        }

        .a4-stat-item {
            text-align: center;
        }

        .a4-stat-label {
            font-size: 8pt;
            color: #666;
            margin-bottom: 1mm;
        }

        .a4-stat-value {
            font-size: 12pt;
            font-weight: bold;
            color: #000;
        }

        /* Print styles for A4 format */
        @media print {
            /* Preserve colors when printing */
            html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .a4-report-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                max-width: none;
                width: 100%;
                min-height: auto;
            }

            .a4-report-header,
            .a4-report-content {
                padding-left: 10mm;
                padding-right: 10mm;
            }

            .a4-report-table {
                font-size: 8pt;
            }

            .a4-report-table th,
            .a4-report-table td {
                padding: 1.5mm;
            }

            .a4-report-table th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

            /* Hide web-only elements when printing */
            .sidebar,
            .top-nav,
            .page-header,
            .table-header,
            .search-filters,
            .btn:not(.a4-print-btn) {
                display: none !important;
            }
            /* Force high-contrast for themed A4 when printing */
            #a4ReportContainer[class*="theme-"] .a4-report-header { color: #000 !important; background: #fff !important; }
            #a4ReportContainer[class*="theme-"] .a4-report-table th { background: var(--primary-color) !important; color:#fff !important; }
            #a4ReportContainer[class*="theme-"] .a4-report-table td { color: #111 !important; }

            /* Print styles for details modal */
            .modal {
                display: block !important;
                position: static !important;
                background: white !important;
            }
            .modal-content {
                box-shadow: none !important;
                max-width: none !important;
                width: 100% !important;
                max-height: none !important;
            }
            .modal-header {
                border-bottom: 2px solid #000 !important;
                padding-bottom: 10px !important;
            }
            .modal-footer {
                display: none !important;
            }
            .modal-close {
                display: none !important;
            }
            #reportRowDetailsModal table {
                font-size: 9pt !important;
            }
            #reportRowDetailsModal table th,
            #reportRowDetailsModal table td {
                padding: 4px 6px !important;
            }

            /* Repeat table header on each printed page */
            .a4-report-table thead { display: table-header-group; }
            .a4-report-table tfoot { display: table-footer-group; }

            /* Page size and margins for proper A4 layout */
            @page { size: A4; margin: 12mm; }

            /* Show only the A4 area for details modal */
            body * { visibility: hidden !important; }
            /* Allow printing either the on-demand details A4 or the built-in preview A4 */
            #a4DetailsView, #a4DetailsView *,
            #a4ReportContainer, #a4ReportContainer * { visibility: visible !important; }
            #a4DetailsView, #a4ReportContainer { position: static !important; width: auto !important; margin: 0 !important; padding: 0 !important; }

            /* Page numbering */
            .a4-page-number:after { content: counter(page) " of " counter(pages); }
        }

    /* A4 Column Customizer styles removed in simplified report tab */

    /* Report Designer (Real-time) */
    .report-designer-launcher { position: fixed; bottom: 16px; right: 16px; z-index: 1200; background: linear-gradient(135deg, #2563eb, #10b981); color:#fff; border:none; border-radius: 999px; width: 46px; height: 46px; display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.18); cursor:pointer; }
    .report-designer-launcher:hover { transform: translateY(-1px); box-shadow: 0 14px 32px rgba(0,0,0,0.22); }
    .report-designer-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.35); backdrop-filter: blur(2px); z-index: 1190; display:none; }
    .report-designer-overlay.show { display:block; }
    .report-designer-panel { position: fixed; top:0; right: -460px; width: 420px; height: 100vh; background:#ffffff; border-left:1px solid #e2e8f0; box-shadow:-8px 0 24px rgba(0,0,0,0.12); z-index: 1201; display:flex; flex-direction:column; transition: right .25s ease; }
    .report-designer-panel.show { right: 0; }
    .rd-header { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #e2e8f0; background:#f8fafc; }
    .rd-title { font-size: .9rem; font-weight: 700; color:#0f172a; display:flex; align-items:center; gap:.5rem; }
    .rd-close { border:none; background:transparent; color:#334155; font-size:1.1rem; cursor:pointer; }
    .rd-body { padding:10px; overflow:auto; display:flex; flex-direction:column; gap:.6rem; }
    .rd-section { border:1px solid #e2e8f0; border-radius:8px; padding:.5rem; }
    .rd-section h4 { margin:0 0 .35rem 0; font-size:.75rem; color:#334155; display:flex; align-items:center; gap:.4rem; }
    .rd-fields { display:flex; flex-wrap:wrap; gap:.35rem; }
    .rd-chip { padding:.2rem .45rem; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; font-size:.65rem; color:#334155; display:inline-flex; align-items:center; gap:.3rem; }
    .rd-chip button { border:none; background:transparent; color:#64748b; cursor:pointer; padding:0; font-size:.8rem; }
    .rd-buckets { display:grid; grid-template-columns: 1fr; gap:.5rem; }
    .rd-bucket { border:1px dashed #cbd5e1; border-radius:8px; padding:.4rem; min-height:48px; background:#fafafa; }
    .rd-bucket-label { font-size:.68rem; color:#475569; margin-bottom:.3rem; display:flex; align-items:center; gap:.35rem; }
    .rd-bucket-list { display:flex; flex-wrap:wrap; gap:.35rem; }
    .rd-bucket .rd-chip { background:#e2e8f0; }
    .rd-controls { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
    .rd-control { display:flex; flex-direction:column; gap:.25rem; }
    .rd-control label { font-size:.7rem; color:#475569; }
    .rd-control input[type="checkbox"] { transform: translateY(1px); }
    .rd-footer { padding:.5rem; border-top:1px solid #e2e8f0; display:flex; gap:.5rem; justify-content:flex-end; }
    .rd-btn { border:none; border-radius:6px; padding:.35rem .6rem; font-size:.72rem; cursor:pointer; }
    .rd-btn.primary { background:#2563eb; color:#fff; }
    .rd-btn.secondary { background:#e2e8f0; color:#0f172a; }
    .rd-btn.danger { background:#dc2626; color:#fff; }
    .rd-theme { display:grid; grid-template-columns:repeat(2,1fr); gap:.4rem; }
    .rd-theme button { padding:.35rem; border:1px solid #e2e8f0; border-radius:6px; background:#fff; cursor:pointer; font-size:.7rem; }
    .rd-theme button.active { outline:2px solid #2563eb; }
    .rd-order-controls { display:inline-flex; gap:2px; }
    .rd-order-controls button { border:none; background:#cbd5e1; color:#0f172a; font-size:.65rem; padding:0 .35rem; border-radius:3px; cursor:pointer; }
    .rd-small { font-size:.64rem; color:#64748b; }

        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #34495e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-occupied {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-available {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-maintenance {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-checkout {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
        }

        /* Row Details Modal: show full content without truncation */
        #reportRowDetailsModal table {
            table-layout: auto !important;
        }
        #reportRowDetailsModal table thead th,
        #reportRowDetailsModal table tbody td {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: clip !important;
            word-break: break-word;
        }
        #reportRowDetailsModal table th,
        #reportRowDetailsModal table td {
            width: auto !important;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Inline search for select */
        .select-with-search {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.35rem;
        }
        .select-with-search .inline-input {
            padding: 0.45rem;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .select-with-search select {
            width: 100%;
        }

        /* Multi-select dropdown (match Meal Types control) */
        .multi-dropdown { position: relative; }
        .multi-dropdown-toggle { background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:0.5rem; display:flex; align-items:center; justify-content:space-between; gap:0.5rem; cursor:pointer; font-size:0.85rem; min-height:38px; }
        .multi-dropdown-toggle::after { content:'\25BC'; font-size:0.7rem; color:#475569; }
    /* Remove arrow on Rooms field only */
    #modalRoomsToggle::after { content: none !important; }
        .multi-dropdown-panel { position:absolute; z-index:2100; top:calc(100% + 4px); left:0; right:0; background:#fff; border:1px solid #cbd5e1; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); padding:0.25rem; max-height:260px; overflow:auto; display:none; }
        .multi-dropdown.open .multi-dropdown-panel { display:block; }
        .multi-dropdown-search { width:100%; padding:0.35rem 0.45rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.85rem; margin-bottom:0.35rem; }
        .multi-dropdown-options { display:grid; grid-template-columns: 1fr; gap:2px; }
    .multi-dropdown-option { display:flex; align-items:center; gap:0.3rem; padding:0.22rem 0.28rem; border-radius:4px; cursor:pointer; line-height:1.15; font-size:0.82rem; }
    .multi-dropdown-option input[type="checkbox"]{ width:14px; height:14px; }
        .multi-dropdown-option span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .multi-dropdown-option:hover { background:#f1f5f9; }
        .multi-dropdown-empty { color:#64748b; font-size:0.85rem; padding:0.3rem; }

        /* Inline container to show small counters next to fields */
        .inline-with-count { display: flex; align-items: center; gap: 0.5rem; }
        .field-counter { font-size: 0.75rem; color: #64748b; white-space: nowrap; }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-cards {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .table-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .search-filters {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 900px) {
            .main-content {
                margin-left: 0;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .top-nav {
                left: 0.5rem;
            }
            
            .page-header {
                padding: 0.5rem;
                font-size: 0.85rem;
                margin: 0.25rem 0 0.4rem 0;
            }
            
            .tab-navigation {
                flex-wrap: wrap;
            }
            
            .tab-button {
                flex: 1 1 auto;
                min-width: 120px;
                padding: 0.75rem 1rem;
                font-size: 0.75rem;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 0.1rem;
            }
            
            .card {
                min-height: 30px;
                padding: 0.15rem;
            }
            
            .card-title {
                font-size: 0.5rem;
            }
            
            .card-value {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 768px) {
            .top-nav {
                padding: 0.4rem 0.5rem;
                height: 45px;
                min-height: 45px;
            }
            
            .main-content {
                padding: 0.2rem;
                padding-top: 3rem;
            }
            
            .page-header {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .page-header .btn-add-new {
                padding: 0.3rem;
                font-size: 1rem;
            }
            
            .table-wrapper {
                height: calc(100vh - 320px);
            }
            
            .table-header {
                padding: 0.75rem;
            }
            
            .table-title {
                font-size: 1rem;
            }
            
            table thead th {
                padding: 0.6rem 0.4rem;
                font-size: 0.7rem;
            }
            
            table tbody td {
                padding: 0.5rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
            }
            
            .modal-body {
                padding: 0.75rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .top-nav {
                padding: 0.3rem 0.4rem;
                height: 40px;
                min-height: 40px;
            }
            
            .main-content {
                padding-top: 2.5rem;
            }
            
            .page-header {
                padding: 0.35rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .tab-button {
                padding: 0.6rem 0.75rem;
                font-size: 0.7rem;
                min-width: 100px;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }
            
            .card {
                min-height: 25px;
                padding: 0.1rem;
            }
            
            .card-title {
                font-size: 0.45rem;
            }
            
            .card-value {
                font-size: 0.65rem;
            }
            
            .table-wrapper {
                height: calc(100vh - 280px);
            }
            
            table thead th {
                padding: 0.5rem 0.3rem;
                font-size: 0.65rem;
            }
            
            table tbody td {
                padding: 0.4rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filters input,
            .search-filters select {
                width: 100%;
                margin-bottom: 0.25rem;
            }
            
            .btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .status-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
    <nav class="sidebar menu-loading" id="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    <ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                        <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
                        <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                        <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html" class="active">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <!-- Project Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>
                <!-- Inventory Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                    <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                    <ul class="submenu">
                        <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                        <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                        <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                        <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                    </ul>
                </li>
                <!-- Workspaces: Catering -->
                <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                    <a href="#"><i class="fas fa-utensils"></i> Workspaces  Catering</a>
                    <ul class="submenu">
                        <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                        <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                        <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                        <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                        <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                    </ul>
                </li>
                <li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <nav class="top-nav">
                <div class="top-nav-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                        <span id="headerCompanyName" class="company-name-header"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="" alt="User Avatar" style="display: block;" />
                        </button>
                        <div class="profile-dropdown">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="page-header">
                <div style="display: flex; align-items: center; gap: 0.6rem;">
                    <i class="fas fa-bed"></i>
                    <span>Accommodation</span>
                </div>
                <button type="button" class="btn-add-new" onclick="handleHeaderPlusClick()" title="New">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('active')" id="activeTab">
                    <i class="fas fa-bed"></i> Active Assignments
                </button>
                <button class="tab-button" onclick="switchTab('archives')" id="archivesTab">
                    <i class="fas fa-archive"></i> Archives
                </button>
                <button class="tab-button" onclick="switchTab('analytics')" id="analyticsTab">
                    <i class="fas fa-chart-line"></i> Analytics
                </button>
                <button class="tab-button" onclick="switchTab('reporting')" id="reportingTabBtn">
                    <i class="fas fa-file-alt"></i> Reporting
                </button>
                <button class="tab-button" onclick="switchTab('settings')" id="settingsTabBtn" style="display:none;">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>

            <!-- Active Assignments Tab -->
            <div id="activeContent" class="tab-content active">
                <!-- Batch Action Bar -->
                <div class="batch-action-bar" id="campBatchActionBar">
                    <span class="selected-count"><span id="campSelectedCount">0</span> selected</span>
                    <button class="batch-btn batch-btn-delete" onclick="campBatchDelete()"><i class="fas fa-trash"></i> Delete Selected</button>
                    <button class="batch-btn batch-btn-cancel" onclick="campClearSelection()"><i class="fas fa-times"></i> Cancel</button>
                </div>
                <div class="table-wrapper">
                    <div class="table-header">
                        <div class="table-controls">
                            <div class="search-filters">
                                <input type="text" id="searchAssignments" placeholder="Search employee / room" />
                                <select id="filterStatus">
                                    <option value="">All Status</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="checked_in">Checked In</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="filterRoom">
                                    <option value="">All Rooms</option>
                                </select>
                            </div>
                            <div class="table-actions">
                            </div>
                        </div>
                    </div>
                    <div class="table-scrollable">
                        <table id="assignmentsTable">
                        <thead>
                            <tr>
                                <th class="row-checkbox-cell"><input type="checkbox" class="batch-checkbox" id="campSelectAllCheckbox" title="Select all" onclick="campToggleSelectAll(this)"></th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Room</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterRoom"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Location</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterLocation"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Company</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterCompany"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Employee</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:180px;max-height:250px;">
                                        <input type="text" id="colFilterEmployeeSearch" placeholder="Type to search..." style="width:100%;padding:4px 6px;font-size:.75rem;border:1px solid #d1d5db;border-radius:3px;margin-bottom:4px;">
                                        <div class="col-filter-checkboxes" id="colFilterEmployee" style="max-height:180px;overflow-y:auto;"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Check-in Date</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterCheckIn"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Check-out Date</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterCheckOut"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Period</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterPeriod"></div>
                                    </div>
                                </th>
                                <th style="position:relative;">
                                    <span class="col-filter-title" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;" onclick="toggleColFilter(this)">Status</span>
                                    <div class="col-filter-popup" style="display:none;position:absolute;top:100%;left:0;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:4px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:140px;max-height:220px;overflow-y:auto;">
                                        <div class="col-filter-checkboxes" id="colFilterStatus"></div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated dynamically -->
                    </tbody>
                    </table>
                </div>
            </div>
            </div>

            <!-- Archives Tab -->
            <div id="archivesContent" class="tab-content">
                <div class="table-wrapper">
                    <div class="table-header">
                        <div class="table-controls">
                            <div class="search-filters">
                                <input type="text" id="searchArchives" placeholder="Search archived records" />
                                <select id="filterArchiveRoom">
                                    <option value="">All Rooms</option>
                                </select>
                                <input type="date" id="filterArchiveDate" title="Filter by check-out date" />
                            </div>
                            <div class="table-actions">
                                <span class="archive-info">Completed assignments and check-outs</span>
                            </div>
                        </div>
                    </div>
                    <div class="table-scrollable">
                        <table id="archivesTable">
                            <thead>
                                <tr>
                                    <th>Room</th>
                                    <th>Location</th>
                                    <th>Employee</th>
                                    <th>Check-in Date</th>
                                    <th>Check-out Date</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Archived assignments will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsContent" class="tab-content">
                <div id="campAnalyticsSection" style="margin-top:0.75rem;">
                    <div id="campAnalyticsBuilderMount"></div>
                    <div id="campAnalyticsStatus" style="font-size:0.6rem;color:#475569;margin:0.2rem 0 0.6rem 0;"></div>
                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;margin-top:0.8rem;">
                        <h4 style="margin:0 0 0.4rem 0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;">SAVED ANALYTICS MODELS</h4>
                        <div class="table-scroll" style="max-height:220px;">
                            <table style="font-size:0.6rem;min-width:700px;width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr>
                                        <th style="text-align:left;padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;">Title</th>
                                        <th style="text-align:left;padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;">Category</th>
                                        <th style="text-align:left;padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;">Date Range</th>
                                        <th style="text-align:left;padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;">Values</th>
                                        <th style="text-align:left;padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;">Created</th>
                                        <th style="text-align:left;padding:4px 6px;border:1px solid #e2e8f0;background:#f8fafc;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="campAnalyticsModelsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reporting Tab -->
            <div id="reportingContent" class="tab-content">
                <div class="table-wrapper">
                    <div class="table-header">
                        <div class="table-controls">
                            <div class="table-title" style="font-size:0.9rem;color:#334155;font-weight:600;">
                                <i class="fas fa-file-alt" style="margin-right:6px;color:#2563eb;"></i>
                                <span>Reports</span>
                            </div>
                        </div>
                    </div>
                    <div style="padding:2rem;text-align:center;color:#64748b;">
                        <i class="fas fa-chart-bar" style="font-size:3rem;color:#cbd5e1;margin-bottom:1rem;display:block;"></i>
                        <p style="font-size:0.9rem;margin-bottom:0.5rem;">Click the <strong>+</strong> button to generate a report</p>
                        <p style="font-size:0.8rem;color:#94a3b8;">Generate accommodation reports by site, company, department, and more.</p>
                    </div>
                </div>
            </div>

            <!-- Generate Report Modal -->
            <div id="generateReportModal" class="modal" aria-hidden="true">
                <div class="modal-content" style="max-width:500px;">
                    <div class="modal-header">
                        <h3 class="modal-title" style="display:flex;align-items:center;gap:.6rem;">
                            <i class="fas fa-chart-bar" style="color:#2563eb;"></i> Generate Report
                        </h3>
                        <button class="modal-close" onclick="closeModal('generateReportModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="reportTypeSelect">Report Type</label>
                            <select id="reportTypeSelect">
                                <option value="by_site">Number of Accommodations by Site/Location</option>
                                <option value="by_company">Number of Accommodations by Company</option>
                                <option value="by_department">Number of Accommodations by Department</option>
                                <option value="by_status">Number of Accommodations by Status</option>
                                <option value="by_employee">Number of Accommodations by Employee</option>
                                <option value="occupancy_rate">Occupancy Rate by Site</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reportPeriodSelect">Period</label>
                            <select id="reportPeriodSelect" onchange="toggleCustomDateRange()">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="last_7_days">Last 7 Days</option>
                                <option value="last_30_days">Last 30 Days</option>
                                <option value="this_month">This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="this_year">This Year</option>
                                <option value="last_year">Last Year</option>
                                <option value="all_time">All Time</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        <div id="customDateRangeGroup" style="display:none;">
                            <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                <div class="form-group">
                                    <label for="reportStartDate">Start Date</label>
                                    <input type="date" id="reportStartDate">
                                </div>
                                <div class="form-group">
                                    <label for="reportEndDate">End Date</label>
                                    <input type="date" id="reportEndDate">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Include Records</label>
                            <div class="checkbox-group" style="display:flex;gap:1rem;">
                                <label class="checkbox-item" style="display:flex;align-items:center;gap:6px;">
                                    <input type="checkbox" id="reportIncludeActive" checked>
                                    Active Assignments
                                </label>
                                <label class="checkbox-item" style="display:flex;align-items:center;gap:6px;">
                                    <input type="checkbox" id="reportIncludeArchived" checked>
                                    Archived Records
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeModal('generateReportModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-play"></i> Generate
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Preview Modal (Investigation Report style) -->
            <div class="modal-overlay" id="campReportPreviewOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:flex-start; justify-content:center; overflow:auto; padding:32px 20px;">
                <div class="modal-content camp-report-container" style="background:#fff; border-radius:12px; width:100%; max-width:940px; min-height:60vh; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:visible;">
                    <!-- Print/Export/Close buttons -->
                    <button id="campReportPrintBtn" onclick="printCampReport()" style="position:absolute; top:10px; right:10px; background:#111827; color:#fff; border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; z-index:10;"><i class="fas fa-print"></i> Print / PDF</button>
                    <button id="campReportExportBtn" onclick="exportReportToCSV()" style="position:absolute; top:10px; right:115px; background:#059669; color:#fff; border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; z-index:10;"><i class="fas fa-download"></i> Export CSV</button>
                    <button id="campReportCloseBtn" onclick="closeCampReportPreview()" style="position:absolute; top:10px; right:230px; background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; z-index:10;">Close</button>
                    
                    <div class="camp-report-sheet printable" style="background:#fff; width:100%; padding:20px 24px 40px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827;">
                        <!-- Header with Company Logo and Name -->
                        <div class="camp-report-header" style="display:flex; justify-content:space-between; gap:20px; margin-bottom:0; align-items:flex-start;">
                            <div class="company-block" style="display:flex; flex-direction:column; align-items:flex-start; gap:8px;">
                                <img id="campReportLogo" src="" alt="Company Logo" style="width:100px; height:100px; object-fit:contain; border:none; border-radius:8px; background:#fff; display:none;">
                                <div id="campReportLogoFallback" style="width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px;"></div>
                                <div class="camp-report-company">
                                    <h1 id="campReportCompanyName" style="margin:0; font-size:1.1rem; line-height:1.2; font-weight:700;"></h1>
                                    <h2 id="campReportDocTitle" class="doc-title" style="font-size:.9rem; font-weight:700; margin:2px 0 0; color:#111827; text-align:left;">Accommodation Report</h2>
                                </div>
                            </div>
                            <div class="camp-report-meta" style="font-size:.63rem; color:#374151; text-align:right; line-height:1.35; min-width:150px;">
                                <div id="campReportGenerated" style="font-size:.55rem; color:#6b7280; font-weight:500;"></div>
                            </div>
                        </div>
                        
                        <div class="divider" style="height:1px; background:#e5e7eb; margin:12px 0 18px; border-radius:1px;"></div>
                        
                        <!-- Report Info -->
                        <div class="docmeta-row" style="font-size:.72rem; color:#111827; margin:6px 0 12px;">
                            <span style="font-weight:700; color:#374151; margin-right:6px;">Report Type:</span>
                            <span id="campReportType"></span>
                            <span style="margin:0 12px;">|</span>
                            <span style="font-weight:700; color:#374151; margin-right:6px;">Period:</span>
                            <span id="campReportPeriod"></span>
                        </div>
                        
                        <!-- Sections -->
                        <div class="camp-report-sections" style="display:flex; flex-direction:column; gap:16px;">
                            <!-- Summary Section -->
                            <div class="section">
                                <div class="camp-report-section-title" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; font-weight:600; font-size:.75rem; padding:10px 14px; border:none; border-radius:0; display:flex; align-items:center; gap:10px; box-shadow: 0 2px 8px rgba(44,62,80,0.15);">
                                    <i class="fas fa-chart-pie" style="font-size: 1rem; width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;"></i>
                                    <span class="section-text">Summary</span>
                                </div>
                                <div id="campReportSummary" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px;">
                                    <!-- Summary cards will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Data Section -->
                            <div class="section">
                                <div class="camp-report-section-title" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; font-weight:600; font-size:.75rem; padding:10px 14px; border:none; border-radius:0; display:flex; align-items:center; gap:10px; box-shadow: 0 2px 8px rgba(44,62,80,0.15);">
                                    <i class="fas fa-table" style="font-size: 1rem; width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;"></i>
                                    <span class="section-text">Detailed Breakdown</span>
                                </div>
                                <div style="overflow-x:auto; -webkit-overflow-scrolling:touch; margin-top:8px;">
                                    <table class="camp-report-table" style="width:max-content; min-width:100%; border-collapse:collapse; font-size:.72rem;">
                                        <thead id="campReportTableHead">
                                            <tr style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                                                <th id="campReportCategoryHeader" style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:left; font-weight:600; color:#fff;">Category</th>
                                                <th id="campReportCountHeader" style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff; width:100px;">Count</th>
                                                <th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff; width:180px;">Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="campReportTableBody">
                                            <!-- Data rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsContent" class="tab-content">
                <div class="card" style="padding:1.2rem">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #e5e7eb;">
                        <h2 style="margin:0;color:var(--primary-color);font-size:1.2rem;display:flex;align-items:center;gap:8px;">
                            <i class="fas fa-cog"></i> Settings
                        </h2>
                    </div>

                    <!-- Tab Visibility Section -->
                    <div class="settings-section">
                        <h3 onclick="toggleSettingsSection(this)"><i class="fas fa-eye"></i> Tab Visibility Control <i class="fas fa-chevron-down toggle-icon"></i></h3>
                        <div class="settings-section-content">
                            <p style="font-size:.75rem;color:#6b7280;margin-bottom:.8rem">Control which users can view specific tabs. Users not in the list will only see the Active Assignments tab.</p>
                            <div style="margin-bottom:.8rem">
                                <button type="button" class="ac-add-btn" onclick="openCampAccessControlModal()"><i class="fas fa-plus"></i> Add User</button>
                            </div>
                            <div style="overflow-x:auto">
                                <table class="access-control-table" id="campAccessControlTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Job Title</th>
                                            <th style="text-align:center">Archives</th>
                                            <th style="text-align:center">Analytics</th>
                                            <th style="text-align:center">Reporting</th>
                                            <th style="text-align:center">Settings</th>
                                            <th style="text-align:center">Batch</th>
                                            <th style="text-align:center">Add</th>
                                            <th style="text-align:center">Edit</th>
                                            <th style="text-align:center">Check-in</th>
                                            <th style="text-align:center">Check-out</th>
                                            <th style="text-align:center">Invoice</th>
                                            <th style="text-align:center">Delete</th>
                                            <th style="text-align:center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="campAccessControlTableBody">
                                        <tr><td colspan="15" style="text-align:center;color:#9ca3af">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Camp Access Control Modal -->
    <div class="ac-modal" id="campAccessControlModal" style="display:none;">
        <div class="ac-modal-content">
            <div class="ac-modal-header">
                <h3><i class="fas fa-user-shield"></i> <span id="campAcModalTitle">Add User Access</span></h3>
                <button class="ac-modal-close" onclick="closeCampAccessControlModal()">&times;</button>
            </div>
            <div class="ac-modal-body">
                <div class="form-group" id="campAcUserSelectGroup">
                    <label>Select User</label>
                    <div class="ac-user-autocomplete">
                        <input id="campAcUserInput" type="text" placeholder="Type to search employee..." autocomplete="off" />
                        <input id="campAcUserId" type="hidden" />
                        <div id="campAcUserDropdown" class="ac-user-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" id="campAcUserDisplayGroup" style="display:none;">
                    <label>User</label>
                    <div id="campAcUserDisplay" style="padding:10px;background:#f3f4f6;border-radius:8px;font-size:.85rem;color:#111827;"></div>
                </div>
                <div class="form-group">
                    <label>Tab Permissions</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcArchives" checked>
                            Archives Tab
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcAnalytics" checked>
                            Analytics Tab
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcReporting" checked>
                            Reporting Tab
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcSettings">
                            Settings Tab
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcBatchActions">
                            Batch Actions (select & delete multiple rows)
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Action Button Permissions</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcActionAdd" checked>
                            Add Assignment
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcActionEdit" checked>
                            Edit
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcActionCheckin" checked>
                            Check-in
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcActionCheckout" checked>
                            Check-out
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcActionInvoice" checked>
                            Invoice
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="campAcActionDelete" checked>
                            Delete
                        </label>
                    </div>
                </div>
            </div>
            <div class="ac-modal-footer">
                <button class="btn btn-cancel" onclick="closeCampAccessControlModal()">Cancel</button>
                <button class="btn btn-save" id="campAcSaveBtn" onclick="saveCampAccessControl()">Add</button>
            </div>
        </div>
    </div>

    <!-- Assignment Details Modal -->
    <div id="assignmentDetailsModal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-bed"></i> Assignment Details</h3>
                <button class="modal-close" onclick="closeModal('assignmentDetailsModal')">&times;</button>
            </div>
            <div class="modal-body" id="assignmentDetailsBody">
                <!-- Details will be populated dynamically -->
            </div>
            <div class="modal-footer" id="assignmentDetailsFooter">
                <!-- Action buttons will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Invoice Period Selection Modal -->
    <div id="invoicePeriodModal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calendar-alt"></i> Select Invoice Period</h3>
                <button class="modal-close" onclick="closeModal('invoicePeriodModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.85rem;color:#6b7280;margin-bottom:1rem;">Choose the date range for the invoice. Only days within the actual stay period will be included.</p>
                <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label for="invoicePeriodStart">Start Date</label>
                        <input type="date" id="invoicePeriodStart" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="invoicePeriodEnd">End Date</label>
                        <input type="date" id="invoicePeriodEnd" class="form-control">
                    </div>
                </div>
                <div id="invoicePeriodInfo" style="margin-top:1rem;padding:10px;background:#f3f4f6;border-radius:8px;font-size:0.8rem;">
                    <!-- Period info will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal('invoicePeriodModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="invoicePeriodGenerateBtn" onclick="generateInvoiceWithPeriod()"><i class="fas fa-file-invoice"></i> Generate Invoice</button>
            </div>
        </div>
    </div>

    <!-- Assignment Invoice Modal -->
    <div id="assignmentInvoiceModal" class="invoice-modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="invoice-modal-panel" role="document">
            <div class="invoice-modal-header">
                <div class="invoice-modal-title"><i class="fas fa-file-invoice"></i><span>Assignment Invoice</span></div>
                <button class="invoice-modal-close" type="button" aria-label="Close" onclick="closeInvoiceModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="invoice-modal-body" id="invoiceModalBody">
                <!-- Invoice content will be populated dynamically -->
            </div>
            <div class="invoice-modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeInvoiceModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="printInvoice()"><i class="fas fa-print"></i> Print</button>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h3 class="modal-title">Room Assignment</h3>
                <button class="modal-close" onclick="closeModal('assignmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assignmentForm">
                    <!-- Row 1: Company, Employee, Location, Room -->
                    <div class="form-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
                        <div class="form-group">
                            <label for="assignmentCompanySelect">Company</label>
                            <select id="assignmentCompanySelect" name="assignmentCompanyId" required>
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assignmentEmployeeSearch">Employee</label>
                            <div class="employee-search-container">
                                <input type="text" id="assignmentEmployeeSearch" class="employee-search-input" placeholder="Search employee..." autocomplete="off">
                                <input type="hidden" id="assignmentEmployeeId" name="employeeId" value="">
                                <div id="assignmentEmployeeResults" class="employee-search-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="locationSelect">Location</label>
                            <div class="inline-with-count">
                                <select id="locationSelect" name="location">
                                    <option value="">All Locations</option>
                                </select>
                                <span id="locationRoomCount" class="field-counter"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="roomSearchInput">Room</label>
                            <div class="room-search-container">
                                <input type="text" id="roomSearchInput" class="room-search-input" placeholder="Search room..." autocomplete="off">
                                <input type="hidden" id="roomSelect" name="room" value="">
                                <div id="roomSearchResults" class="room-search-dropdown"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Check-in, Check-out -->
                    <div class="form-row" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                        <div class="form-group">
                            <label for="checkInDate">Check-in</label>
                            <input type="datetime-local" id="checkInDate" name="checkInDate" required>
                        </div>
                        <div class="form-group">
                            <label for="checkOutDate">Check-out</label>
                            <input type="datetime-local" id="checkOutDate" name="checkOutDate" required>
                        </div>
                    </div>

                    <!-- Meal Plan Section -->
                    <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #e5e7eb;">
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                            <input type="checkbox" id="enableMealPlan" onchange="toggleMealPlanSection()">
                            <i class="fas fa-utensils" style="color:#f59e0b;"></i> Include Meal Plan
                        </label>
                        <div id="mealPlanSection" style="display:none;">
                            <div class="form-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
                                <div class="form-group" style="grid-column:span 2;">
                                    <label>Select Meal Types</label>
                                    <div class="meal-search-container">
                                        <input type="text" id="mealSearchInput" class="meal-search-input" placeholder="Search meal types..." autocomplete="off">
                                        <div id="mealSearchResults" class="meal-search-dropdown"></div>
                                    </div>
                                    <div id="selectedMealsContainer" class="selected-meals-container"></div>
                                </div>
                                <div class="form-group">
                                    <label for="mealStartDate">Meal Start</label>
                                    <input type="datetime-local" id="mealStartDate" name="mealStartDate">
                                </div>
                                <div class="form-group">
                                    <label for="mealEndDate">Meal End</label>
                                    <input type="datetime-local" id="mealEndDate" name="mealEndDate">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mealNotes">Meal Notes</label>
                                <input type="text" id="mealNotes" name="mealNotes" placeholder="Dietary restrictions, preferences...">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveAssignment()">Save Assignment</button>
                <button class="btn" onclick="closeModal('assignmentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Check-in Modal -->
    <div id="checkInModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Employee Check-in</h3>
                <button class="modal-close" onclick="closeModal('checkInModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkInForm">
                    <div class="form-group">
                        <label for="checkInEmployee">Employee</label>
                        <select id="checkInEmployee" name="employee" required>
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="actualCheckInDate">Actual Check-in Date</label>
                        <input type="datetime-local" id="actualCheckInDate" name="checkInDate" required>
                    </div>
                    <div class="form-group">
                        <label for="checkInNotes">Check-in Notes</label>
                        <textarea id="checkInNotes" name="notes" rows="3" placeholder="Room condition, special requests, etc..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="processCheckIn()">Check In</button>
                <button class="btn" onclick="closeModal('checkInModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Check-out Modal -->
    <div id="checkOutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Employee Check-out</h3>
                <button class="modal-close" onclick="closeModal('checkOutModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkOutForm">
                    <div class="form-group">
                        <label for="checkOutEmployee">Employee</label>
                        <select id="checkOutEmployee" name="employee" required>
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="actualCheckOutDate">Actual Check-out Date</label>
                        <input type="datetime-local" id="actualCheckOutDate" name="checkOutDate" required>
                    </div>
                    <div class="form-group">
                        <label for="roomCondition">Room Condition</label>
                        <select id="roomCondition" name="condition">
                            <option value="good">Good - Ready for next occupant</option>
                            <option value="cleaning">Needs Cleaning</option>
                            <option value="maintenance">Needs Maintenance</option>
                            <option value="damage">Damaged - Requires Repair</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="checkOutNotes">Check-out Notes</label>
                        <textarea id="checkOutNotes" name="notes" rows="3" placeholder="Room condition details, damages, etc..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="processCheckOut()">Check Out</button>
                <button class="btn" onclick="closeModal('checkOutModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Assignment Modal -->
    <div id="editAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Assignment</h3>
                <button class="modal-close" onclick="closeModal('editAssignmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editAssignmentForm">
                    <input type="hidden" id="editAssignmentId" />

                    <!-- Employee (read-only) -->
                    <div class="form-group">
                        <label for="editEmployeeName">Employee</label>
                        <input type="text" id="editEmployeeName" readonly />
                    </div>

                    <!-- Location + Room row -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editLocationSelect">Location</label>
                            <select id="editLocationSelect">
                                <option value="">All Locations</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editRoomSelect">Room</label>
                            <div class="select-with-search">
                                <input id="editRoomSearch" type="text" class="inline-input" placeholder="Search room..." oninput="filterEditRoomOptions()" autocomplete="off" />
                                <select id="editRoomSelect" required>
                                    <option value="">Select Room</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Period Type -->
                    <div class="form-group">
                        <label for="editPeriodType">Assignment Period</label>
                        <select id="editPeriodType">
                            <option value="rotation">Standard Rotation (4 weeks)</option>
                            <option value="extended">Extended Stay (8 weeks)</option>
                            <option value="permanent">Permanent Assignment</option>
                            <option value="custom">Custom Period</option>
                        </select>
                    </div>

                    <!-- Dates row -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCheckInDate">Check-in</label>
                            <input type="datetime-local" id="editCheckInDate" />
                        </div>
                        <div class="form-group">
                            <label for="editCheckOutDate">Check-out</label>
                            <input type="datetime-local" id="editCheckOutDate" />
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label for="editNotes">Notes</label>
                        <textarea id="editNotes" rows="3" placeholder="Notes for this assignment..."></textarea>
                    </div>

                    <!-- Meal Plan Section -->
                    <div class="form-group" style="border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="editEnableMealPlan" onchange="toggleEditMealPlanSection()">
                            <i class="fas fa-utensils"></i> Enable Meal Plan
                        </label>
                    </div>
                    <div id="editMealPlanSection" style="display:none; padding:15px; background:#f8f9fa; border-radius:8px; margin-bottom:15px;">
                        <div class="form-group">
                            <label>Select Meal Types</label>
                            <div id="editMealTypesGrid" class="meal-types-grid"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMealStartDate">Meal Start Date</label>
                                <input type="date" id="editMealStartDate">
                            </div>
                            <div class="form-group">
                                <label for="editMealEndDate">Meal End Date</label>
                                <input type="date" id="editMealEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editMealNotes">Meal Notes</label>
                            <textarea id="editMealNotes" rows="2" placeholder="Special dietary requirements, allergies, etc."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="updateAssignment()">Save Changes</button>
                <button class="btn" onclick="closeModal('editAssignmentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Centralized Firebase Configuration (from firebase-config-v8.js)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('? Firebase v8 initialized successfully for centralized auth');
            }
            return window.firebase;
        }

        // Initialize Firebase
        const firebase = initializeFirebase();

        // Centralized AuthManager Class (integrated from js/auth.js)
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.currentCompany = null;
                this.db = null;
                this.auth = null;
                this.storage = null;
                this.initializeAuth();
            }

            getCurrentUser() {
                try {
                    const user = localStorage.getItem('currentUser');
                    return user ? JSON.parse(user) : null;
                } catch (error) {
                    console.error('Error getting current user:', error);
                    return null;
                }
            }

            async initializeAuth() {
                console.log('?? Starting centralized authentication initialization...');
                
                try {
                    // Initialize Firebase services
                    this.auth = firebase.auth();
                    this.db = firebase.database();
                    this.storage = firebase.storage();
                    
                    console.log('? Firebase services initialized for centralized auth');

                    // Set up auth state listener
                    this.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            console.log('?? User authenticated via Firebase:', user.email);
                            await this.loadUserData(user);
                        } else {
                            console.log('?? No Firebase user, setting guest mode');
                            this.currentUser = { 
                                uid: 'guest', 
                                displayName: 'Guest User',
                                email: 'guest@dreamex-datalab.com'
                            };
                            this.updateUIForAuthenticatedUser();
                        }
                    });

                    // Check if we have stored user data
                    const stored = localStorage.getItem('currentUser');
                    if (stored) {
                        try { this.currentUser = JSON.parse(stored); } catch (_) {}
                        await this.loadUserRole(this.currentUser);
                        await this.loadUserCompany();
                        this.updateUIForAuthenticatedUser();
                    } else if (!this.currentUser) {
                        // Set guest mode
                        this.currentUser = { 
                            uid: 'guest', 
                            displayName: 'Guest User',
                            email: 'guest@dreamex-datalab.com'
                        };
                        this.updateUIForAuthenticatedUser();
                    }
                    
                } catch (error) {
                    console.error('? Error initializing centralized authentication:', error);
                    // Fallback to guest mode
                    this.currentUser = { 
                        uid: 'guest', 
                        displayName: 'Guest User',
                        email: 'guest@dreamex-datalab.com'
                    };
                    this.updateUIForAuthenticatedUser();
                }
            }

            async loadUserData(user) {
                try {
                    const snap = await this.db.ref(`users/${user.uid}`).once('value');
                    const data = snap.val();
                    
                    if (data && data.companyId) {
                        this.currentUser = { ...user, ...data };
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        await this.loadCompanyData(data.companyId);
                        this.updateUIForAuthenticatedUser();
                    } else {
                        this.currentUser = user;
                        this.updateUIForAuthenticatedUser();
                    }
                } catch (e) {
                    console.error('User load error', e);
                }
            }

            async loadCompanyData(cid) {
                try {
                    const snap = await this.db.ref(`companies/${cid}`).once('value');
                    this.currentCompany = snap.val();
                } catch (e) {
                    console.error('Company load error', e);
                }
            }

            async loadUserRole(user) {
                try {
                    if (!user || user.uid === 'guest') return;
                    
                    const userRef = this.db.ref(`users/${user.uid}`);
                    const snapshot = await userRef.once('value');
                    
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        this.currentUser = { ...user, ...userData };
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        console.log('? User role and data loaded:', userData.role);
                    }
                } catch (error) {
                    console.error('Error loading user role:', error);
                }
            }

            async loadUserCompany() {
                try {
                    if (!this.currentUser || this.currentUser.uid === 'guest') return;
                    
                    const companyId = this.currentUser.companyId;
                    if (companyId) {
                        const companyRef = this.db.ref(`companies/${companyId}`);
                        const snapshot = await companyRef.once('value');
                        
                        if (snapshot.exists()) {
                            this.currentCompany = snapshot.val();
                            this.updateCompanyBranding();
                            console.log('? Company data loaded:', this.currentCompany.companyName);
                        }
                    }
                } catch (error) {
                    console.error('Error loading company data:', error);
                }
            }

            updateUIForAuthenticatedUser() {
                this.updateCompanyBranding();
                this.populateUserProfile();
                console.log('? UI updated for authenticated user');
            }

            updateCompanyBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                const nameEl = document.getElementById('headerCompanyName');
                
                if (!this.currentCompany) {
                    if (logoEl) logoEl.style.display = 'none';
                    if (nameEl) nameEl.textContent = 'Dreamex Datalab';
                    return;
                }
                
                if (nameEl) nameEl.textContent = this.currentCompany.companyName || 'Dreamex Datalab';
                
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoEl) {
                    if (logoUrl) {
                        logoEl.src = logoUrl;
                        logoEl.style.display = 'block';
                    } else {
                        logoEl.style.display = 'none';
                    }
                }
                
                // Apply company branding colors
                if (this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) {
                        root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    }
                    if (this.currentCompany.branding.secondaryColor) {
                        root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                    }
                }
            }

            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                return this.currentUser.displayName || 
                       (this.currentUser.firstName ? 
                        `${this.currentUser.firstName} ${this.currentUser.lastName || ''}`.trim() : 
                        (this.currentUser.email ? this.currentUser.email.split('@')[0] : 'User'));
            }

            getUserInitials() {
                const name = this.getUserDisplayName();
                const parts = name.split(' ').filter(Boolean);
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }

            async getUserAvatarUrl() {
                try {
                    if (!this.currentUser || this.currentUser.uid === 'guest') return null;
                    const uid = this.currentUser.uid;
                    const companyId = this.currentUser.companyId;

                    // 1) If auth has a photoURL, use it
                    if (this.auth?.currentUser?.photoURL) return this.auth.currentUser.photoURL;

                    // 2) Check database fields for direct URLs
                    try {
                        const userSnap = await this.db.ref(`users/${uid}`).once('value');
                        if (userSnap.exists()) {
                            const u = userSnap.val();
                            if (u?.avatarUrl) return u.avatarUrl;
                            if (u?.profilePhotoUrl) return u.profilePhotoUrl;
                            if (u?.photoURL) return u.photoURL;
                        }
                    } catch (_) {}

                    // 3) Build storage path candidates
                    const candidates = [];
                    const exts = ['jpg', 'png', 'jpeg', 'webp'];
                    const names = ['profile', 'avatar'];
                    if (companyId) {
                        names.forEach(n => exts.forEach(ext => candidates.push(`companies/${companyId}/avatars/${uid}/${n}.${ext}`)));
                        names.forEach(n => exts.forEach(ext => candidates.push(`companies/${companyId}/users/${uid}/${n}.${ext}`)));
                    }
                    names.forEach(n => exts.forEach(ext => candidates.push(`avatars/${uid}/${n}.${ext}`)));
                    exts.forEach(ext => candidates.push(`profiles/${uid}/profile.${ext}`));
                    names.forEach(n => exts.forEach(ext => candidates.push(`users/${uid}/${n}.${ext}`)));

                    // Try each candidate sequentially
                    for (const path of candidates) {
                        try {
                            const url = await this.storage.ref(path).getDownloadURL();
                            if (url) return url;
                        } catch (_) { /* continue */ }
                    }
                    console.warn('Avatar not found for user:', uid);
                    return null;
                } catch (e) {
                    console.warn('getUserAvatarUrl failed:', e);
                    return null;
                }
            }

            generateInitialsAvatar(name, img) {
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12'];
                const bg = colors[initials.charCodeAt(0) % 5];
                const svg = `<svg width="40" height="40" xmlns='http://www.w3.org/2000/svg'>
                    <rect width='40' height='40' rx='20' fill='${bg}'/>
                    <text x='20' y='24' font-size='14' font-family='Arial' fill='#fff' text-anchor='middle' font-weight='600'>${initials}</text>
                </svg>`;
                img.src = 'data:image/svg+xml;base64,' + btoa(svg);
                img.style.display = 'block';
            }

            async populateUserProfile() {
                const btn = document.getElementById('userProfileBtn');
                if (!btn || !this.currentUser) return;
                
                const img = btn.querySelector('img');
                const url = await this.getUserAvatarUrl();
                // Set a resilient onerror fallback to initials
                if (img) {
                    img.onerror = () => {
                        this.generateInitialsAvatar(this.getUserDisplayName(), img);
                    };
                    if (url) {
                        img.src = url;
                    } else {
                        this.generateInitialsAvatar(this.getUserDisplayName(), img);
                    }
                }
                
                const dropdown = document.querySelector('.profile-dropdown ul');
                if (dropdown) {
                    dropdown.innerHTML = `
                        <li style='padding:10px 14px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;'>
                            <div style='width:32px;height:32px;border-radius:50%;overflow:hidden;'>
                                ${url ? `<img src='${url}' style='width:32px;height:32px;object-fit:cover;'/>` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:600;">${this.getUserInitials()}</div>`}
                            </div>
                            <div style='display:flex;flex-direction:column;'>
                                <strong style='font-size:12px;'>${this.getUserDisplayName()}</strong>
                                <span style='font-size:10px;color:#666;'>${this.currentUser.email || ''}</span>
                            </div>
                        </li>
                        <li><a href='profile.html'><i class='fas fa-user'></i> Profile</a></li>
                        <li><a href='#' id='logoutLink'><i class='fas fa-sign-out-alt'></i> Logout</a></li>
                    `;
                    
                    const logoutLink = document.getElementById('logoutLink');
                    if (logoutLink) {
                        logoutLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.logout();
                        });
                    }
                }
            }

            async logout() {
                try {
                    await this.auth.signOut();
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force logout even if Firebase fails
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }

            // Legacy method name compatibility
            updateUI() {
                this.updateUIForAuthenticatedUser();
            }

            // Load company employees for assignment dropdown
            async loadCompanyEmployees() {
                try {
                    if (!this.currentUser || this.currentUser.uid === 'guest') return [];
                    
                    const companyId = this.currentUser.companyId;
                    if (!companyId) return [];

                    console.log('?? Loading employees for company:', companyId);
                    
                    const companyRef = this.db.ref(`companies/${companyId}`);
                    const snapshot = await companyRef.once('value');
                    
                    if (snapshot.exists()) {
                        const companyData = snapshot.val();
                        const employees = [];
                        
                        if (companyData.users) {
                            // Load user details for each company user
                            const userPromises = Object.keys(companyData.users).map(async (userId) => {
                                try {
                                    const userRef = this.db.ref(`users/${userId}`);
                                    const userSnapshot = await userRef.once('value');
                                    if (userSnapshot.exists()) {
                                        const userData = userSnapshot.val();
                                        return {
                                            id: userId,
                                            name: userData.displayName || 
                                                  (userData.firstName ? `${userData.firstName} ${userData.lastName || ''}`.trim() : 
                                                   (userData.email ? userData.email.split('@')[0] : 'Unknown User')),
                                            email: userData.email,
                                            department: userData.department || 'N/A',
                                            position: userData.position || 'N/A'
                                        };
                                    }
                                } catch (error) {
                                    console.error('Error loading user:', userId, error);
                                    return null;
                                }
                            });
                            
                            const userResults = await Promise.all(userPromises);
                            employees.push(...userResults.filter(user => user !== null));
                        }
                        
                        console.log('? Loaded employees:', employees.length);
                        return employees.sort((a, b) => a.name.localeCompare(b.name));
                    }
                    
                    return [];
                } catch (error) {
                    console.error('Error loading company employees:', error);
                    return [];
                }
            }
        }

        // ===== ROLE-BASED MENU AUTHORIZATION SYSTEM =====
        // Rebuilt to match project-list.html exactly.

        // Flag to prevent multiple simultaneous executions
        let isMenuUpdateInProgress = false;

        // Reset all menu items to hidden (preserve core features only when authorized)
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items
        function showBasicMenu() {
            console.log(' Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            // Prevent multiple simultaneous executions
            if (isMenuUpdateInProgress) {
                console.log(' Menu update already in progress, skipping...');
                return;
            }
            
            isMenuUpdateInProgress = true;
            console.log(' Starting feature-based menu authorization for camp.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log(' Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log(' Using Firebase auth - will search for company and role');
                } else {
                    console.log(' No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log(' Searching for user company and role...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                                console.log(` Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error(' No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                if (!userRole) {
                    console.warn(' No user role found, proceeding with company features only');
                }
                
                // STEP 1: Apply company feature-based authorization
                console.log(' STEP 1: Applying company feature authorization...');
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                
                // STEP 2: Filter by user role permissions within authorized features
                if (userRole) {
                    console.log(' STEP 2: Applying role-based filtering within authorized features...');
                    await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                } else {
                    console.log(' STEP 2: Skipping role-based filtering (no role found)');
                }
                
            } catch (error) {
                console.error(' Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            } finally {
                // Reset the flag to allow future updates
                isMenuUpdateInProgress = false;
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log(' Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log(' No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error(' Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log(' Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log(' Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(` Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(` Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log(' All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features and hrefs (with alias mapping)
                const authorizedFeatures = new Set();
                const authorizedHrefs = new Set();

                const featureAlias = (key) => {
                    if (!key) return key;
                    // Treat these as aliases of each other
                    if (key === 'risk_view') return 'risk_management_section';
                    if (key === 'risk_management_section') return 'risk_view';
                    return null;
                };
                const normalizeHref = (href) => {
                    if (!href) return '';
                    // Keep relative path portion only
                    try {
                        // If absolute, take pathname; else, use as is
                        const u = new URL(href, window.location.origin);
                        return (u.pathname || '').replace(/^\//, '');
                    } catch {
                        return String(href).replace(/^\//, '');
                    }
                };

                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                        const alias = featureAlias(pageInfo.feature);
                        if (alias) authorizedFeatures.add(alias);
                    }
                    if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
                    if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
                    if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
                });

                console.log(' Authorized features for camp.html:', Array.from(authorizedFeatures));
                console.log(' Authorized hrefs for camp.html:', Array.from(authorizedHrefs));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    const anchor = menuItem.querySelector('a[href]');
                    const href = anchor ? anchor.getAttribute('href') : '';
                    const normalized = normalizeHref(href);
                    const featureAuthorized = authorizedFeatures.has(featureAttribute);
                    const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
                    const isAuthorized = featureAuthorized || hrefAuthorized;

                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }

                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(` Authorized - showing: feature=${featureAttribute} href=${normalized || ''}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(` Not authorized - hiding: feature=${featureAttribute} href=${normalized || ''}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(` Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(` Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(` Company feature authorization completed - ${visibleCount} items initially visible`);
                
                // Return authorized pages for role-based filtering
                return authorizedPages;
                
            } catch (error) {
                console.error(' Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
                return [];
            }
        }

        // Apply role-based filtering within company authorized features
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log(' Applying role-based filtering for role:', userRole);
                
                // Get user role permissions from company
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                
                if (!permissionsSnapshot.exists()) {
                    console.log(` No permissions found for role ${userRole} in company ${companyId}`);
                    
                    // Try to get all roles to see what's available
                    const allRolesRef = database.ref(`companies/${companyId}/roles`);
                    const allRolesSnapshot = await allRolesRef.once('value');
                    
                    if (allRolesSnapshot.exists()) {
                        const allRoles = allRolesSnapshot.val();
                        console.log(' Available roles in company:', Object.keys(allRoles));
                        
                        // Enhanced debugging for administrator role
                        if (userRole === 'administrator') {
                            console.log(' ADMINISTRATOR - Full roles data:', allRoles);
                            if (allRoles.administrator) {
                                console.log(' ADMINISTRATOR role found in company:', allRoles.administrator);
                                if (allRoles.administrator.permissions) {
                                    console.log(' ADMINISTRATOR permissions found:', allRoles.administrator.permissions);
                                    filterMenuByPermissions(allRoles.administrator.permissions);
                                    return;
                                }
                            }
                        }
                        
                        // Check if the role exists with different casing or format
                        const roleKeys = Object.keys(allRoles);
                        const matchingRole = roleKeys.find(key => 
                            key.toLowerCase() === userRole.toLowerCase() ||
                            key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                        );
                        
                        if (matchingRole && allRoles[matchingRole].permissions) {
                            console.log(` Found matching role: ${matchingRole}`);
                            const permissions = allRoles[matchingRole].permissions;
                            filterMenuByPermissions(permissions);
                            return;
                        }
                    }
                    
                    // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                    if (userRole === 'administrator') {
                        console.log(' ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                        showSidebarAfterAuth();
                        return;
                    }
                    
                    // For other roles without permissions, hide all items with permission requirements
                    console.log(' No valid permissions found - filtering out items requiring permissions');
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log(' Loaded role permissions:', permissions);
                
                // Apply permission-based filtering
                filterMenuByPermissions(permissions);
                
            } catch (error) {
                console.error(' Error applying role-based filtering:', error);
                // Don't hide everything on error - keep company features visible
                showSidebarAfterAuth();
            }
        }

        // Filter currently visible menu items by role permissions
        function filterMenuByPermissions(permissions) {
            console.log(' Filtering visible menu items by role permissions...');
            
            if (!permissions) {
                console.log(' No permissions object provided');
                hideItemsRequiringPermissions();
                showSidebarAfterAuth();
                return;
            }
            const permissionAlias = (key) => {
                if (!key) return key;
                if (key === 'risk_view') return 'risk_management_section';
                if (key === 'risk_management_section') return 'risk_view';
                return null;
            };

            // Evaluate all permission-gated items (allow role permissions to add visibility too)
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
            console.log(` Found ${itemsRequiringPermissions.length} items requiring permissions to check`);

            let hiddenCount = 0;
            let shownByPermission = 0;

            itemsRequiringPermissions.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const feature = item.getAttribute('data-feature');

                const perm = permissions[requiresPermission];
                const aliasKey = permissionAlias(requiresPermission);
                const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;

                const hasViewPermission = (p) => p === true || (p && p.view === true);
                const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);

                if (allowed) {
                    if (!item.classList.contains('menu-visible')) shownByPermission++;
                    item.classList.add('menu-visible');
                    console.log(` Showing by permission: ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
                } else {
                    if (item.classList.contains('menu-visible')) hiddenCount++;
                    item.classList.remove('menu-visible');
                    console.log(` Hiding (no permission): ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
                }
            });

            // Re-check dropdown menus after permission filtering
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const dropdownRequires = dropdown.getAttribute('data-requires-permission');

                if (submenuItems.length === 0) {
                    if (dropdownRequires) {
                        const perm = permissions[dropdownRequires];
                        const aliasKey = permissionAlias(dropdownRequires);
                        const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
                        const hasViewPermission = (p) => p === true || (p && p.view === true);
                        const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
                        if (allowed) {
                            dropdown.classList.add('menu-visible');
                            console.log(` Showing dropdown by permission: ${dropdownFeature}`);
                        } else {
                            dropdown.classList.remove('menu-visible');
                            hiddenCount++;
                            console.log(` Hiding dropdown (no children and no permission): ${dropdownFeature}`);
                        }
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(` Hiding dropdown (no visible children): ${dropdownFeature}`);
                    }
                } else {
                    // If any submenu items are visible, the dropdown must be visible even if the
                    // dropdown itself doesn't have a dedicated permission flag.
                    dropdown.classList.add('menu-visible');
                    console.log(` Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
                }
            });

            console.log(` Role-based filtering completed - ${hiddenCount} items hidden; ${shownByPermission} items shown by permission`);
            
            // Ensure at least home is visible
            ensureHomeIsVisible();
            
            // Show sidebar after all filtering is complete
            showSidebarAfterAuth();
        }

        // Hide menu items that require permissions (for users without role permissions)
        function hideItemsRequiringPermissions() {
            console.log(' Hiding all menu items that require permissions...');
            
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            let hiddenCount = 0;
            
            itemsRequiringPermissions.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                item.classList.remove('menu-visible');
                hiddenCount++;
                console.log(` Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
            });
            
            // Hide dropdowns that only contain permission-required items
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length === 0) {
                    dropdown.classList.remove('menu-visible');
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    console.log(` Hiding dropdown (no visible children): ${dropdownFeature}`);
                }
            });
            
            console.log(` Hidden ${hiddenCount} items requiring permissions`);
            
            // Ensure at least home is visible
            ensureHomeIsVisible();
        }

        // Ensure home menu item is visible as fallback
        function ensureHomeIsVisible() {
            const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
            if (homeItem && !homeItem.classList.contains('menu-visible')) {
                homeItem.classList.add('menu-visible');
                console.log(' Ensured home menu item is visible as fallback');
            }
        }

        // Show sidebar and remove loading state after authentication and filtering
        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
                console.log(' Sidebar loading state removed - menu authorization complete');
            }
        }

        // Initialize menu authorization system
        function initializeMenuAuthorization() {
            console.log(' Initializing menu authorization system...');
            
            // Set sidebar to loading state initially
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.add('menu-loading');
            }
            
            // Wait a moment for Firebase to initialize, then start authorization
            setTimeout(() => {
                updateMenuWithFeatureAuthorization();
            }, 500);
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

        // Debug functions for menu visibility
        window.debugMenuState = function() {
            console.log(' Debug Menu State:');
            const menuItems = document.querySelectorAll('[data-feature]');
            console.log(`Total menu items: ${menuItems.length}`);
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                const isVisible = item.classList.contains('menu-visible');
                console.log(`- ${feature}: requires=${requiresPermission}, visible=${isVisible}`);
            });
        };

        // Initialize Centralized AuthManager and setup UI
        let authManager;
    document.addEventListener('DOMContentLoaded', () => {
            console.log('?? Initializing Camp Management with centralized authentication...');
            
            // Initialize centralized AuthManager
            authManager = new AuthManager();
            
            // Expose globally for debugging
            window.authManager = authManager;
            
            setupUIInteractions();
            initCampModule();
            
            // Run sidebar authorization to display menu items as per project-list.html
            if (typeof initializeMenuAuthorization === 'function') {
                initializeMenuAuthorization();
            } else if (typeof updateMenuWithFeatureAuthorization === 'function') {
                updateMenuWithFeatureAuthorization();
            }

            (async () => {
                try {
                    if (authManager && authManager.currentUser) {
                        await authManager.populateUserProfile();
                        const profileImg = document.querySelector('#userProfileBtn img');
                        if (profileImg && (!profileImg.src || profileImg.src === '' || profileImg.src.endsWith('/') || profileImg.src === window.location.href)) {
                            authManager.generateInitialsAvatar(authManager.getUserDisplayName(), profileImg);
                        }
                    }
                    await applyCampTabVisibility();
                    // Load action permissions BEFORE refreshing tables so buttons render correctly
                    await loadCampUserActionPermissions();
                    await refreshTable();
                    setupFilterListeners();
                } catch (e) {
                    console.warn('Camp init post-auth step failed:', e);
                }
            })();
        });

        // UI Interactions
        function setupUIInteractions() {
            const sidebarToggle = document.querySelector('#sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Notification Bell functionality
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });
                
                document.addEventListener('click', (e) => {
                    if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                        notificationDropdown.classList.remove('show');
                    }
                });
                
                const markAllReadBtn = document.querySelector('.mark-all-read');
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', () => {
                        const badge = document.querySelector('.notification-badge');
                        if (badge) badge.textContent = '0';
                        
                        const notifications = document.querySelectorAll('.notification-item.unread');
                        notifications.forEach(notification => {
                            notification.classList.remove('unread');
                        });
                    });
                }
            }
            
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });
                
                document.addEventListener('click', (e) => {
                    if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }
            
            restoreSidebarState();
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }

        function restoreSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (isCollapsed && sidebar && mainContent) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
            }
        }

        // Camp Module Functions
        function initCampModule() {
            loadDashboardData();
            setCurrentDateTime();
            loadCampUserActionPermissions(); // Load action permissions on init
        }

        // ========== GLOBAL ACTION PERMISSIONS SYSTEM ==========
        // Cache for user's action permissions (assign, edit, checkin, checkout, invoice, delete)
        let __campUserActionPerms = null;
        
        /**
         * Load the current user's action permissions from Firebase once and cache them.
         * Called on page init and when permissions might change.
         */
        async function loadCampUserActionPermissions() {
            // Default: all actions DENIED for security (user must be explicitly granted permissions)
            const defaults = { assign: false, edit: false, checkin: false, checkout: false, invoice: false, delete: false };
            // Fallback for errors: also deny all
            const errorDefaults = { assign: false, edit: false, checkin: false, checkout: false, invoice: false, delete: false };
            try {
                const user = window.authManager?.currentUser;
                if (!user || !user.companyId) {
                    __campUserActionPerms = errorDefaults;
                    applyCampActionButtonVisibility();
                    return __campUserActionPerms;
                }
                const uid = user.uid || user.id;
                const tabVisRef = window.authManager.db.ref(`companies/${user.companyId}/campSettings/tabVisibility/${uid}`);
                const snap = await tabVisRef.once('value');
                
                if (snap.exists()) {
                    const p = snap.val();
                    // Explicit permission record: use the values (default to false if not set)
                    __campUserActionPerms = {
                        assign: p.canActionAdd === true,
                        edit: p.canActionEdit === true,
                        checkin: p.canActionCheckin === true,
                        checkout: p.canActionCheckout === true,
                        invoice: p.canActionInvoice === true,
                        delete: p.canActionDelete === true
                    };
                } else {
                    // No permission record = all DENIED (user not in access control list)
                    __campUserActionPerms = defaults;
                }
                console.log(' Camp action permissions loaded:', __campUserActionPerms);
                applyCampActionButtonVisibility();
                return __campUserActionPerms;
            } catch (e) {
                console.warn('Failed to load camp action permissions:', e);
                __campUserActionPerms = errorDefaults;
                applyCampActionButtonVisibility();
                return __campUserActionPerms;
            }
        }
        
        /**
         * Get cached action permissions (sync). Returns defaults if not yet loaded.
         */
        function getCampActionPerms() {
            // Default deny if permissions not yet loaded
            return __campUserActionPerms || { assign: false, edit: false, checkin: false, checkout: false, invoice: false, delete: false };
        }
        
        /**
         * Check if current user has a specific action permission
         * @param {string} action - One of: assign, edit, checkin, checkout, invoice, delete
         * @returns {boolean}
         */
        function canCampAction(action) {
            const perms = getCampActionPerms();
            return perms[action] !== false;
        }
        
        /**
         * Apply visibility to global action buttons based on permissions
         */
        function applyCampActionButtonVisibility() {
            const perms = getCampActionPerms();
            
            // Hide/show the + (new assignment) button
            const addBtn = document.querySelector('.btn-add-new');
            if (addBtn) addBtn.style.display = perms.assign ? '' : 'none';
            
            // Hide/show batch delete button
            const batchDeleteBtn = document.querySelector('.batch-btn-delete');
            if (batchDeleteBtn) batchDeleteBtn.style.display = perms.delete ? '' : 'none';
            
            console.log(' Applied action button visibility:', { addBtn: perms.assign, batchDelete: perms.delete });
        }
        // ========== END ACTION PERMISSIONS SYSTEM ==========

    // Cache of rooms data to resolve room -> location quickly
    const DEFAULT_ROOM_CAPACITY = 2; // Allow two employees per room by default
        let __roomsIndexCache = null; // { [roomCode]: { location: { block, building, floor }, name, type } }
        async function getRoomsIndex() {
            if (__roomsIndexCache) return __roomsIndexCache;
            try {
                const companyId = window.authManager?.currentUser?.companyId;
                if (!companyId) return {};
                // Try preferred path first
                const preferred = await window.authManager.db.ref(`companies/${companyId}/campData/rooms`).once('value');
                if (preferred.exists()) {
                    const data = preferred.val();
                    __roomsIndexCache = normalizeRoomsMap(data);
                    return __roomsIndexCache;
                }
                // Legacy fallback
                const legacy = await window.authManager.db.ref(`companies/${companyId}/rooms`).once('value');
                if (legacy.exists()) {
                    const data = legacy.val();
                    __roomsIndexCache = normalizeRoomsMap(data);
                    return __roomsIndexCache;
                }
                // Shared fallback used elsewhere in this page
                const sharedConfigCompanyId = '-OYL6cpeH7JnNLPBhCTH';
                const shared = await window.authManager.db.ref(`companies/${sharedConfigCompanyId}/campData/rooms`).once('value');
                if (shared.exists()) {
                    const data = shared.val();
                    __roomsIndexCache = normalizeRoomsMap(data);
                    return __roomsIndexCache;
                }
            } catch (e) {
                console.warn('getRoomsIndex error:', e);
            }
            __roomsIndexCache = {};
            return __roomsIndexCache;
        }

        function normalizeRoomsMap(source) {
            const map = {};
            if (!source || typeof source !== 'object') return map;
            Object.values(source).forEach(r => {
                if (!r) return;
                const code = r.code || r.roomNumber || r.id;
                if (!code) return;
                map[String(code)] = {
                    location: r.location || {},
                    name: r.name || '',
                    type: r.type || '',
                    // Try to infer capacity from possible fields; fallback will be handled by helper
                    capacity: (() => {
                        const c = r.capacity || r.maxOccupancy || r.maxCapacity || r.beds || r.Beds;
                        const n = parseInt(c, 10);
                        return Number.isFinite(n) && n > 0 ? n : undefined;
                    })()
                };
            });
            return map;
        }

        async function getEffectiveRoomCapacity(roomCode) {
            try {
                const idx = await getRoomsIndex();
                const meta = idx[String(roomCode)] || null;
                const n = meta && Number.isFinite(meta.capacity) ? meta.capacity : DEFAULT_ROOM_CAPACITY;
                return n > 0 ? n : DEFAULT_ROOM_CAPACITY;
            } catch (_e) {
                return DEFAULT_ROOM_CAPACITY;
            }
        }

        async function getRoomLocationDisplay(roomNumber) {
            if (!roomNumber) return '-';
            try {
                const idx = await getRoomsIndex();
                const meta = idx[String(roomNumber)] || idx[String(roomNumber).trim()] || null;
                if (!meta || !meta.location) return '-';
                const { block, building, floor } = meta.location;
                // Prefer block, else building/floor combo, else any available field
                if (block) return block;
                const parts = [building, floor].filter(Boolean);
                return parts.length ? parts.join(' ') : '-';
            } catch (e) {
                return '-';
            }
        }

        // Returns the set of allowed location blocks for current user and whether a visibility record exists
        async function getAllowedLocationsForCurrentUser() {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    return { set: new Set(), configured: false };
                }
                const uid = window.authManager.currentUser.uid;
                const companyId = window.authManager.currentUser.companyId;
                if (!uid || !companyId) return { set: new Set(), configured: false };
                const visSnap = await window.authManager.db.ref(`companies/${companyId}/campSettings/userLocationVisibility/${uid}`).once('value');
                if (!visSnap.exists()) {
                    // Not set in visibility table -> block all
                    return { set: new Set(), configured: false };
                }
                const cfg = visSnap.val();
                if (cfg && Array.isArray(cfg.locations) && cfg.locations.length > 0) {
                    return { set: new Set(cfg.locations), configured: true };
                }
                // Configured but empty -> also block all
                return { set: new Set(), configured: true };
            } catch (e) {
                console.warn('getAllowedLocationsForCurrentUser error:', e);
                return { set: new Set(), configured: false };
            }
        }

        async function loadDashboardData() {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    // Use default values if not authenticated (no-op if cards are removed)
                    const setStat=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
                    setStat('totalRooms','0');
                    setStat('occupiedRooms','0');
                    setStat('availableRooms','0');
                    setStat('occupancyRate','0%');
                    return;
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.log('No company ID found for dashboard data');
                    return;
                }
                
                // Load room assignments to calculate occupancy
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const assignmentsSnapshot = await assignmentsRef.once('value');

                // Determine total rooms, preferring campset.html storage path
                let totalRooms = 0;
                let roomsSource = null;
                // Primary: companies/{companyId}/campData/rooms
                const campDataRoomsSnap = await window.authManager.db.ref(`companies/${companyId}/campData/rooms`).once('value');
                if (campDataRoomsSnap.exists()) {
                    roomsSource = campDataRoomsSnap.val();
                } else {
                    // Fallback: legacy companies/{companyId}/rooms
                    const legacyRoomsSnap = await window.authManager.db.ref(`companies/${companyId}/rooms`).once('value');
                    if (legacyRoomsSnap.exists()) {
                        roomsSource = legacyRoomsSnap.val();
                    } else {
                        // Final fallback: shared campData/rooms (same as campset.html uses)
                        const sharedConfigCompanyId = '-OYL6cpeH7JnNLPBhCTH';
                        const sharedRoomsSnap = await window.authManager.db.ref(`companies/${sharedConfigCompanyId}/campData/rooms`).once('value');
                        if (sharedRoomsSnap.exists()) {
                            roomsSource = sharedRoomsSnap.val();
                        }
                    }
                }

                if (roomsSource && typeof roomsSource === 'object') {
                    totalRooms = Object.keys(roomsSource).length;
                }

                // Calculate occupied rooms from assignments (distinct rooms with active status)
                let occupiedRooms = 0;
                if (assignmentsSnapshot.exists()) {
                    const assignments = assignmentsSnapshot.val();
                    const activeStatuses = new Set(['checked_in', 'assigned']);
                    const occupiedSet = new Set();
                    Object.values(assignments).forEach(assignment => {
                        if (assignment && activeStatuses.has(assignment.status)) {
                            const roomNum = assignment.roomNumber || assignment.room || assignment.roomCode;
                            if (roomNum) occupiedSet.add(roomNum);
                        }
                    });
                    occupiedRooms = occupiedSet.size;
                }
                
                const availableRooms = totalRooms - occupiedRooms;
                const occupancyRate = totalRooms > 0 ? Math.round((occupiedRooms / totalRooms) * 100) : 0;
                
                // Update UI (no-op if cards are removed)
                const setStat=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
                setStat('totalRooms', totalRooms.toString());
                setStat('occupiedRooms', occupiedRooms.toString());
                setStat('availableRooms', availableRooms.toString());
                setStat('occupancyRate', `${occupancyRate}%`);
                
                console.log(`?? Dashboard updated: ${occupiedRooms}/${totalRooms} rooms occupied (${occupancyRate}%)`);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Fallback to default values (no-op if cards are removed)
                const setStat=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
                setStat('totalRooms','0');
                setStat('occupiedRooms','0');
                setStat('availableRooms','0');
                setStat('occupancyRate','0%');
            }
        }

        function setCurrentDateTime() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentDateTime = now.toISOString().slice(0, 16);
            
            document.getElementById('checkInDate').value = currentDate;
            document.getElementById('actualCheckInDate').value = currentDateTime;
            document.getElementById('actualCheckOutDate').value = currentDateTime;
        }

        // Modal Functions
        async function openAssignmentModal() {
            document.getElementById('assignmentModal').classList.add('show');
            
            // Reset employee search field
            try {
                const searchInput = document.getElementById('assignmentEmployeeSearch');
                const hiddenInput = document.getElementById('assignmentEmployeeId');
                if (searchInput) searchInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
            } catch (e) { console.warn('Employee search reset failed:', e); }

            // Reset room search field
            try {
                const roomSearchInput = document.getElementById('roomSearchInput');
                const roomHiddenInput = document.getElementById('roomSelect');
                if (roomSearchInput) roomSearchInput.value = '';
                if (roomHiddenInput) roomHiddenInput.value = '';
            } catch (e) { console.warn('Room search reset failed:', e); }

            // Reset meal plan section
            try {
                const enableMealPlan = document.getElementById('enableMealPlan');
                const mealPlanSection = document.getElementById('mealPlanSection');
                if (enableMealPlan) enableMealPlan.checked = false;
                if (mealPlanSection) mealPlanSection.style.display = 'none';
                document.getElementById('mealStartDate').value = '';
                document.getElementById('mealEndDate').value = '';
                document.getElementById('mealNotes').value = '';
                // Reset selected meals
                window.__campSelectedMeals = [];
                const selectedMealsContainer = document.getElementById('selectedMealsContainer');
                if (selectedMealsContainer) selectedMealsContainer.innerHTML = '';
                const mealSearchInput = document.getElementById('mealSearchInput');
                if (mealSearchInput) mealSearchInput.value = '';
            } catch (e) { console.warn('Meal plan reset failed:', e); }

            // Initialize employee search functionality
            initializeEmployeeSearch();
            
            // Initialize room search functionality
            initializeRoomSearch();

            // Load companies first so employee loader can read the chosen company
            await loadCompaniesIntoAssignmentSelect();

            // Bind change listener once to refilter employees by selected company
            try {
                const companySel = document.getElementById('assignmentCompanySelect');
                if (companySel && !companySel._employeeFilterBound) {
                    const reload = () => {
                        // Re-load employees when company selection changes
                        loadEmployeesForSearch();
                    };
                    companySel.addEventListener('change', reload);
                    companySel.addEventListener('input', reload);
                    companySel._employeeFilterBound = true;
                }
            } catch (e) { console.warn('Could not bind company change handler:', e); }

            // Now load employees for the selected company, rooms, and meal types
            await Promise.all([
                loadEmployeesForSearch(),
                loadRoomsIntoSelect(),
                loadMealTypesForAssignment()
            ]);

            // Re-filter rooms when the date range changes
            try {
                const ci = document.getElementById('checkInDate');
                const co = document.getElementById('checkOutDate');
                const bind = (el) => {
                    if (!el || el._roomsBound) return;
                    const reload = () => { loadRoomsIntoSelect(); };
                    el.addEventListener('change', reload);
                    el.addEventListener('input', reload);
                    el._roomsBound = true;
                };
                bind(ci); bind(co);
            } catch (e) { console.warn('Could not bind date change handlers for rooms:', e); }
            
            // Auto-sync meal dates with check-in/check-out dates
            try {
                const ci = document.getElementById('checkInDate');
                const co = document.getElementById('checkOutDate');
                const mealStart = document.getElementById('mealStartDate');
                const mealEnd = document.getElementById('mealEndDate');
                if (ci && !ci._mealDateBound) {
                    ci.addEventListener('change', () => {
                        if (!mealStart.value) mealStart.value = ci.value;
                    });
                    ci._mealDateBound = true;
                }
                if (co && !co._mealDateBound) {
                    co.addEventListener('change', () => {
                        if (!mealEnd.value) mealEnd.value = co.value;
                    });
                    co._mealDateBound = true;
                }
            } catch (e) { console.warn('Could not bind meal date sync:', e); }
        }

        async function openCheckInModal() {
            // Check permission before opening check-in modal
            if (!canCampAction('checkin')) {
                showNotification('You do not have permission to perform check-ins', 'warning');
                return;
            }
            document.getElementById('checkInModal').classList.add('show');
            
            // Load company employees into dropdown
            await loadEmployeesIntoCheckInSelect();
        }

        async function openCheckOutModal() {
            // Check permission before opening check-out modal
            if (!canCampAction('checkout')) {
                showNotification('You do not have permission to perform check-outs', 'warning');
                return;
            }
            document.getElementById('checkOutModal').classList.add('show');
            
            // Load checked-in employees into dropdown
            await loadCheckedInEmployeesIntoSelect();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Print the details modal content
        function printReportDetails() {
            const modal = document.getElementById('reportRowDetailsModal');
            if (!modal || !modal.classList.contains('show')) {
                console.warn('Details modal is not open');
                return;
            }
            // Use browser's native print for the modal content
            window.print();
        }

        // Report Options modal helpers
        // Populate options for the generic dimension value field (e.g., Rooms, Status)
        async function populateGenericDimensionOptions(dim){
            const wrap = document.getElementById('modalFocusGenericWrap');
            const label = document.getElementById('modalGenericLabel');
            const sel = document.getElementById('modalDimensionValueSelect');
            const countEl = document.getElementById('modalGenericCount');
            // Custom Rooms UI elements
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            const roomsDropdown = document.getElementById('modalRoomsDropdown');
            const roomsToggle = document.getElementById('modalRoomsToggle');
            const roomsPanel = document.getElementById('modalRoomsPanel');
            const roomsPreview = document.getElementById('modalRoomsPreview');
            if (!wrap || !label || !sel) return;
            let options = [];
            if (dim === 'room') {
                // Build from rooms index for the entire company scope (no visibility filter)
                try {
                    const roomsIdx = await getRoomsIndex();
                    const rooms = Object.keys(roomsIdx)
                        .sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true}));
                    options = rooms;
                } catch (e) { options = []; }
                label.textContent = 'Rooms';
                // Hide the generic select and show custom multi-dropdown
                sel.innerHTML = '';
                document.getElementById('modalGenericSelectWrap').style.display = 'none';
                if (roomsDropdown) roomsDropdown.style.display = '';
                if (roomsHiddenSelect) roomsHiddenSelect.style.display = 'none';
                // Populate hidden select (source of truth for selected options)
                if (roomsHiddenSelect) {
                    roomsHiddenSelect.innerHTML = '';
                    options.forEach(v=>{
                        const o=document.createElement('option'); o.value=String(v); o.textContent=String(v); roomsHiddenSelect.appendChild(o);
                    });
                }
                // Build custom dropdown UI
                buildRoomsDropdownOptions();
                syncRoomsDropdownFromSelect();
                updateRoomsToggleText();
                renderSelectedRoomsPreview();
                wrap.style.display = '';
                if (countEl) { countEl.textContent = `Total rooms: ${options.length}`; countEl.style.display = ''; }
            } else if (dim === 'status') {
                const statuses = ['assigned','checked_in','checked_out','cancelled'];
                options = ['', ...statuses];
                label.textContent = 'Status';
                sel.multiple = false; sel.size = 0;
                if (countEl) countEl.style.display = 'none';
                // Hide custom rooms UI when not applicable
                if (roomsDropdown) roomsDropdown.style.display = 'none';
                if (roomsPreview) roomsPreview.style.display = 'none';
                document.getElementById('modalGenericSelectWrap').style.display = '';
            } else if (dim === 'checkin_date' || dim === 'checkout_date') {
                // Provide dates present in data as convenience; users can still use date range
                const key = dim === 'checkin_date' ? 'actualCheckInDate' : 'actualCheckOutDate';
                const rows = Array.isArray(window.__camp_lastAssignments) ? window.__camp_lastAssignments : [];
                const dates = [...new Set(rows.map(r => (r[key]||'').split('T')[0]).filter(Boolean))].sort();
                options = ['', ...dates];
                label.textContent = (dim==='checkin_date'?'Check-in Date':'Check-out Date');
                sel.multiple = false; sel.size = 0;
                if (countEl) countEl.style.display = 'none';
                if (roomsDropdown) roomsDropdown.style.display = 'none';
                if (roomsPreview) roomsPreview.style.display = 'none';
                document.getElementById('modalGenericSelectWrap').style.display = '';
            } else if (dim === 'duration') {
                // Coarse buckets
                options = ['', '1 day', '2-7 days', '8-30 days', '31+ days'];
                label.textContent = 'Duration';
                sel.multiple = false; sel.size = 0;
                if (countEl) countEl.style.display = 'none';
                if (roomsDropdown) roomsDropdown.style.display = 'none';
                if (roomsPreview) roomsPreview.style.display = 'none';
                document.getElementById('modalGenericSelectWrap').style.display = '';
            } else if (dim && dim !== 'employee' && dim !== 'department' && dim !== 'site') {
                // Fallback generic value field for unknown/slugged columns
                options = [''];
                label.textContent = 'Value';
                sel.multiple = false; sel.size = 0;
                if (countEl) countEl.style.display = 'none';
                if (roomsDropdown) roomsDropdown.style.display = 'none';
                if (roomsPreview) roomsPreview.style.display = 'none';
                document.getElementById('modalGenericSelectWrap').style.display = '';
            } else {
                options = [];
                if (countEl) countEl.style.display = 'none';
                if (roomsDropdown) roomsDropdown.style.display = 'none';
                if (roomsPreview) roomsPreview.style.display = 'none';
                document.getElementById('modalGenericSelectWrap').style.display = '';
            }
            if (options.length) {
                if (dim !== 'room') {
                    const values = sel.multiple ? options : ['', ...options];
                    sel.innerHTML = values.map(v => `<option value="${v}">${v||'(All)'}</option>`).join('');
                    wrap.style.display = '';
                }
            } else {
                sel.innerHTML = '';
                wrap.style.display = 'none';
            }
        }

        // ----- Custom Rooms multi-dropdown (mirrors Meal Types behavior) -----
        function updateRoomsToggleText(){
            const roomsToggle = document.getElementById('modalRoomsToggle');
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            if(!roomsToggle) return;
            const selected = roomsHiddenSelect ? Array.from(roomsHiddenSelect.selectedOptions) : [];
            if(selected.length===0){ roomsToggle.innerHTML='&nbsp;'; return; }
            if(selected.length<=3){ roomsToggle.textContent = selected.map(o=>o.textContent).join(', '); return; }
            roomsToggle.textContent = `${selected.length} selected`;
        }
        function renderSelectedRoomsPreview(){
            const preview = document.getElementById('modalRoomsPreview');
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            if(!preview) return;
            const selected = roomsHiddenSelect ? Array.from(roomsHiddenSelect.selectedOptions) : [];
            if(!selected.length){ preview.style.display='none'; preview.innerHTML=''; return; }
            preview.style.display='flex';
            preview.innerHTML='';
            selected.forEach(opt=>{
                const tag=document.createElement('span');
                tag.textContent=opt.textContent;
                tag.style.background='#eef2f7';
                tag.style.color='#334155';
                tag.style.padding='4px 8px';
                tag.style.borderRadius='999px';
                tag.style.fontSize='12px';
                tag.style.border='1px solid #cbd5e1';
                preview.appendChild(tag);
            });
        }
        let __roomsAllOptions = [];
        function buildRoomsDropdownOptions(){
            const panel = document.getElementById('modalRoomsPanel');
            const optionsHost = document.getElementById('modalRoomsOptions');
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            if(!panel || !roomsHiddenSelect || !optionsHost) return;
            optionsHost.innerHTML='';
            if(roomsHiddenSelect.options.length===0){
                const empty=document.createElement('div');
                empty.className='multi-dropdown-empty';
                empty.textContent='No rooms available';
                optionsHost.appendChild(empty);
                return;
            }
            __roomsAllOptions = Array.from(roomsHiddenSelect.options).map(o=>({ value:o.value, label:o.textContent, selected:o.selected }));
            __renderRoomsOptions(__roomsAllOptions);
        }
        function __renderRoomsOptions(list){
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            const optionsHost = document.getElementById('modalRoomsOptions');
            if(!roomsHiddenSelect || !optionsHost) return;
            optionsHost.innerHTML='';
            list.forEach(item=>{
                const row=document.createElement('div');
                row.className='multi-dropdown-option';
                row.setAttribute('data-value', item.value);
                const cb=document.createElement('input');
                cb.type='checkbox';
                cb.checked=item.selected;
                const lbl=document.createElement('span');
                lbl.textContent=item.label;
                row.appendChild(cb); row.appendChild(lbl);
                row.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    const now=!cb.checked;
                    cb.checked=now;
                    // Reflect to hidden select
                    const opt = Array.from(roomsHiddenSelect.options).find(o=>o.value===item.value);
                    if(opt){ opt.selected=now; }
                    roomsHiddenSelect.dispatchEvent(new Event('change'));
                });
                optionsHost.appendChild(row);
            });
        }
        function syncRoomsDropdownFromSelect(){
            const panel = document.getElementById('modalRoomsPanel');
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            const optionsHost = document.getElementById('modalRoomsOptions');
            if(!panel || !roomsHiddenSelect || !optionsHost) return;
            const map=new Map(Array.from(roomsHiddenSelect.options).map(o=>[o.value, o.selected]));
            optionsHost.querySelectorAll('.multi-dropdown-option').forEach(el=>{
                const val=el.getAttribute('data-value');
                const cb=el.querySelector('input[type="checkbox"]');
                if(cb && map.has(val)) cb.checked=!!map.get(val);
            });
        }

        // Toggle open/close behavior for rooms dropdown
        (function wireRoomsDropdownEvents(){
            const dd=document.getElementById('modalRoomsDropdown');
            const toggle=document.getElementById('modalRoomsToggle');
            const hidden=document.getElementById('modalRoomsHiddenSelect');
            const search=document.getElementById('modalRoomsSearch');
            if(!dd || !toggle || !hidden) return;
            toggle.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.toggle('open'); });
            document.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); });
            hidden.addEventListener('change', ()=>{ updateRoomsToggleText(); renderSelectedRoomsPreview(); syncRoomsDropdownFromSelect(); });
            if(search){
                search.addEventListener('input', ()=>{
                    const q=(search.value||'').toLowerCase().trim();
                    if(!q){ __renderRoomsOptions(__roomsAllOptions); syncRoomsDropdownFromSelect(); return; }
                    const filtered=__roomsAllOptions.filter(it=> (it.label||'').toLowerCase().includes(q) || (it.value||'').toLowerCase().includes(q));
                    __renderRoomsOptions(filtered);
                    syncRoomsDropdownFromSelect();
                });
            }
        })();
        function syncGenericDimensionField(){
            const dim = document.getElementById('modalReportDimensionSelect')?.value||'';
            const nonGeneric = (dim==='employee' || dim==='department' || dim==='site');
            if (nonGeneric) {
                const wrap = document.getElementById('modalFocusGenericWrap');
                if (wrap) wrap.style.display = 'none';
                const roomsDropdown = document.getElementById('modalRoomsDropdown');
                const roomsPreview = document.getElementById('modalRoomsPreview');
                if (roomsDropdown) roomsDropdown.style.display = 'none';
                if (roomsPreview) roomsPreview.style.display = 'none';
                return;
            }
            populateGenericDimensionOptions(dim);
        }
        function setDateInputs(start, end){
            const s=document.getElementById('modalReportStartDate');
            const e=document.getElementById('modalReportEndDate');
            if(s) s.value=start; if(e) e.value=end;
        }
        function formatDateInput(d){ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
        function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
        function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
        function applyReportDatePreset(preset){
            const today=new Date();
            let start=today, end=today;
            switch(preset){
                case 'today': start=end=today; break;
                case 'yesterday': {
                    const y=new Date(today); y.setDate(y.getDate()-1); start=end=y; break;
                }
                case 'last7': {
                    const s=new Date(today); s.setDate(s.getDate()-6); start=s; end=today; break;
                }
                case 'last30': {
                    const s=new Date(today); s.setDate(s.getDate()-29); start=s; end=today; break;
                }
                case 'thisMonth': start=firstDayOfMonth(today); end=lastDayOfMonth(today); break;
                case 'lastMonth': {
                    const lm=new Date(today.getFullYear(), today.getMonth()-1, 1);
                    start=firstDayOfMonth(lm); end=lastDayOfMonth(lm); break;
                }
                case 'ytd': start=new Date(today.getFullYear(),0,1); end=today; break;
                case 'custom': default: {
                    // leave dates as-is
                    return;
                }
            }
            setDateInputs(formatDateInput(start), formatDateInput(end));
            // Period control removed; no need to set preset selector
        }

        // Saved presets using localStorage
        const REPORT_PRESETS_KEY='camp_report_presets_v1';
        function getReportPresets(){ try{ return JSON.parse(localStorage.getItem(REPORT_PRESETS_KEY))||{}; }catch(e){ return {}; } }
        function saveReportPresets(obj){ try{ localStorage.setItem(REPORT_PRESETS_KEY, JSON.stringify(obj)); }catch(e){} }
        function loadPresetDropdown(){
            const sel=document.getElementById('modalSavedPresetSelect'); if(!sel) return;
            const presets=getReportPresets();
            const keys=Object.keys(presets);
            sel.innerHTML = keys.length? keys.map(k=>`<option value="${k}">${k}</option>`).join('') : '<option value="">(no presets)</option>';
        }
        function collectModalOptions(){
            return {
                dimension: document.getElementById('modalReportDimensionSelect')?.value||'',
                startDate: document.getElementById('modalReportStartDate')?.value||'',
                endDate: document.getElementById('modalReportEndDate')?.value||'',
                employeeId: document.getElementById('modalEmployeeSelect')?.value||'',
                department: document.getElementById('modalDepartmentSelect')?.value||'',
                site: document.getElementById('modalSiteSelect')?.value||'',
                dimValue: (()=>{ 
                    const dim=(document.getElementById('modalReportDimensionSelect')?.value||'');
                    if(dim==='room'){
                        const roomsHidden=document.getElementById('modalRoomsHiddenSelect');
                        if(roomsHidden) return [...roomsHidden.selectedOptions].map(o=>o.value).filter(Boolean);
                        return [];
                    }
                    const el=document.getElementById('modalDimensionValueSelect'); 
                    if(!el) return ''; 
                    if(el.multiple){ return [...el.selectedOptions].map(o=>o.value).filter(Boolean); } 
                    return el.value||''; })(),
                includeActive: document.getElementById('modalIncludeActive')?.checked!==false,
                includeArchived: document.getElementById('modalIncludeArchived')?.checked!==false,
                openA4: document.getElementById('modalOpenA4Checkbox')?.checked===true
            };
        }
        function applyModalOptions(opts){
            const set=(id,val)=>{ const el=document.getElementById(id); if(el!=null) el.value=val; };
            set('modalReportDimensionSelect', opts.dimension||'');
            set('modalReportStartDate', opts.startDate||'');
            set('modalReportEndDate', opts.endDate||'');
            set('modalEmployeeSelect', opts.employeeId||'');
            set('modalDepartmentSelect', opts.department||'');
            set('modalSiteSelect', opts.site||'');
            const setChk=(id,val)=>{ const el=document.getElementById(id); if(el) el.checked=!!val; };
            setChk('modalIncludeActive', opts.includeActive!==false);
            setChk('modalIncludeArchived', opts.includeArchived!==false);
            setChk('modalOpenA4Checkbox', !!opts.openA4);
            // sync dimension-driven visibility
            const dim = opts.dimension||'';
            document.getElementById('modalFocusEmployeeWrap').style.display = dim==='employee' ? '' : 'none';
            document.getElementById('modalFocusDepartmentWrap').style.display = dim==='department' ? '' : 'none';
            document.getElementById('modalFocusSiteWrap').style.display = dim==='site' ? '' : 'none';
            // Also refresh the generic dimension field based on the chosen dimension
            syncGenericDimensionField();
            // If presets include generic values, apply them after options populate
            const genSel = document.getElementById('modalDimensionValueSelect');
            const roomsHiddenSelect = document.getElementById('modalRoomsHiddenSelect');
            if (opts) {
                setTimeout(()=>{
                    if (Array.isArray(opts.dimValue)) {
                        if (roomsHiddenSelect && (opts.dimension==='room')) {
                            [...roomsHiddenSelect.options].forEach(o=> o.selected = opts.dimValue.includes(o.value));
                            roomsHiddenSelect.dispatchEvent(new Event('change'));
                        } else if (genSel) {
                            [...genSel.options].forEach(o=> o.selected = opts.dimValue.includes(o.value));
                        }
                    } else if (typeof opts.dimValue === 'string') {
                        if (genSel) genSel.value = opts.dimValue || '';
                    }
                }, 0);
            }
        }
        // Build Dimension options from the Active Assignments tab headers
        function populateReportDimensionOptions() {
            const sel = document.getElementById('modalReportDimensionSelect');
            if (!sel) return;
            // Remember current selection if any
            const prev = sel.value;
            // Extract headers from the Active Assignments table
            const ths = document.querySelectorAll('#assignmentsTable thead th');
            const labels = Array.from(ths).map(th => (th.textContent || '').trim()).filter(Boolean);
            // Map header labels to dimension values and clean labels
            const normalize = (s) => s.toLowerCase().replace(/\s+/g,' ').trim();
            const mapped = [];
            labels.forEach(lbl => {
                const n = normalize(lbl);
                if (n === 'actions') return; // skip
                if (n === 'location') mapped.push({ value: 'site', label: 'Location' });
                else if (n === 'employee') mapped.push({ value: 'employee', label: 'Employee' });
                else if (n === 'room') mapped.push({ value: 'room', label: 'Room' });
                else if (n.startsWith('check-in')) mapped.push({ value: 'checkin_date', label: 'Check-in Date' });
                else if (n.startsWith('check-out')) mapped.push({ value: 'checkout_date', label: 'Check-out Date' });
                else if (n === 'period' || n === 'duration') mapped.push({ value: 'duration', label: 'Duration' });
                else if (n === 'status') mapped.push({ value: 'status', label: 'Status' });
                else {
                    // Fallback: use a slugged value
                    const val = n.replace(/[^a-z0-9_]+/g,'_');
                    mapped.push({ value: val, label: lbl });
                }
            });
            // Ensure Department remains available even if not a visible column
            const hasDepartment = mapped.some(m => m.value === 'department');
            if (!hasDepartment) mapped.splice(2, 0, { value: 'department', label: 'Department' }); // after Room/Location if present
            // Deduplicate by value while preserving order
            const seen = new Set();
            const uniq = mapped.filter(m => { if (seen.has(m.value)) return false; seen.add(m.value); return true; });
            // Build options: Overall + each mapped field
            const opts = [{ value: '', label: 'Overall' }, ...uniq];
            sel.innerHTML = opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
            // Restore previous value if still present; else default to ''
            if (opts.some(o => o.value === prev)) sel.value = prev; else sel.value = '';
        }
        function openGenerateReportsModal(){
            const modal = document.getElementById('generateReportsModal');
            if(!modal) return;
            // Defaults (Period field removed)
            // Populate Dimension options from the Active Assignments tab
            populateReportDimensionOptions();
            if(document.getElementById('modalReportDimensionSelect')) document.getElementById('modalReportDimensionSelect').value='';
            modal.classList.add('show');
            // Populate selects asynchronously
            const empSel = document.getElementById('modalEmployeeSelect');
            const depSel = document.getElementById('modalDepartmentSelect');
            const siteSel = document.getElementById('modalSiteSelect');
            if (empSel && empSel.options.length <= 1) { empSel.disabled = true; empSel.innerHTML='<option>Loading employees...</option>'; populateEmployeeDropdown(empSel).finally(()=>{ empSel.disabled=false; }); }
            if (depSel && depSel.options.length <= 1) { depSel.disabled = true; depSel.innerHTML='<option>Loading departments...</option>'; populateDepartmentDropdown(depSel).finally(()=>{ depSel.disabled=false; }); }
            if (siteSel && siteSel.options.length <= 1) { siteSel.disabled = true; siteSel.innerHTML='<option>Loading sites...</option>'; populateSiteDropdown(siteSel).finally(()=>{ siteSel.disabled=false; }); }
            // Presets dropdown
            loadPresetDropdown();
            // Wire dimension change
            const mDSel=document.getElementById('modalReportDimensionSelect');
            const sync=()=>{
                const dim=mDSel?.value||'';
                document.getElementById('modalFocusEmployeeWrap').style.display = dim==='employee' ? '' : 'none';
                document.getElementById('modalFocusDepartmentWrap').style.display = dim==='department' ? '' : 'none';
                document.getElementById('modalFocusSiteWrap').style.display = dim==='site' ? '' : 'none';
                syncGenericDimensionField();
            };
            if(mDSel) mDSel.onchange = sync; sync();
            // Wire saved preset buttons
            const loadBtn=document.getElementById('modalLoadPresetBtn');
            const saveBtn=document.getElementById('modalSavePresetBtn');
            const delBtn=document.getElementById('modalDeletePresetBtn');
            const sel=document.getElementById('modalSavedPresetSelect');
            if(loadBtn && sel){ loadBtn.onclick=()=>{ const name=sel.value; if(!name) return; const p=getReportPresets()[name]; if(p){ applyModalOptions(p); }} }
            if(saveBtn){ saveBtn.onclick=()=>{ const name=prompt('Preset name'); if(!name) return; const presets=getReportPresets(); presets[name]=collectModalOptions(); saveReportPresets(presets); loadPresetDropdown(); showNotification('Preset saved','success'); } }
            if(delBtn && sel){ delBtn.onclick=()=>{ const name=sel.value; if(!name) return; const ok=confirm(`Delete preset "${name}"?`); if(!ok) return; const presets=getReportPresets(); delete presets[name]; saveReportPresets(presets); loadPresetDropdown(); showNotification('Preset deleted','success'); } }
        }

        function handleHeaderPlusClick() {
            // If on Reporting tab, open Generate Report modal
            const reportingActive = document.getElementById('reportingContent')?.classList.contains('active');
            if (reportingActive) {
                openGenerateReportModal();
                return;
            }
            // Check permission before opening modal
            if (!canCampAction('assign')) {
                showNotification('You do not have permission to create assignments', 'warning');
                return;
            }
            openAssignmentModal();
        }

        // =================== NEW REPORTING TAB FUNCTIONS ===================
        function openGenerateReportModal() {
            const modal = document.getElementById('generateReportModal');
            if (!modal) return;
            
            // Reset form
            document.getElementById('reportTypeSelect').value = 'by_site';
            document.getElementById('reportPeriodSelect').value = 'this_month';
            document.getElementById('customDateRangeGroup').style.display = 'none';
            document.getElementById('reportIncludeActive').checked = true;
            document.getElementById('reportIncludeArchived').checked = true;
            
            modal.classList.add('show');
        }

        function toggleCustomDateRange() {
            const period = document.getElementById('reportPeriodSelect').value;
            document.getElementById('customDateRangeGroup').style.display = period === 'custom' ? '' : 'none';
        }

        function getDateRangeForPeriod(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let start, end;

            switch (period) {
                case 'today':
                    start = end = today;
                    break;
                case 'yesterday':
                    start = end = new Date(today.getTime() - 86400000);
                    break;
                case 'last_7_days':
                    start = new Date(today.getTime() - 6 * 86400000);
                    end = today;
                    break;
                case 'last_30_days':
                    start = new Date(today.getTime() - 29 * 86400000);
                    end = today;
                    break;
                case 'this_month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'last_month':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'this_year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'last_year':
                    start = new Date(now.getFullYear() - 1, 0, 1);
                    end = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                case 'all_time':
                    start = new Date(2000, 0, 1);
                    end = today;
                    break;
                case 'custom':
                    const startVal = document.getElementById('reportStartDate').value;
                    const endVal = document.getElementById('reportEndDate').value;
                    start = startVal ? new Date(startVal) : new Date(2000, 0, 1);
                    end = endVal ? new Date(endVal) : today;
                    break;
                default:
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = today;
            }

            return { start, end };
        }

        async function generateReport() {
            const user = window.authManager?.currentUser;
            if (!user || !user.companyId) {
                showNotification('Not authenticated', 'error');
                return;
            }

            const reportType = document.getElementById('reportTypeSelect').value;
            const period = document.getElementById('reportPeriodSelect').value;
            const includeActive = document.getElementById('reportIncludeActive').checked;
            const includeArchived = document.getElementById('reportIncludeArchived').checked;

            if (!includeActive && !includeArchived) {
                showNotification('Please select at least one record type to include', 'warning');
                return;
            }

            closeModal('generateReportModal');

            try {
                // Get date range
                const { start, end } = getDateRangeForPeriod(period);
                const startStr = start.toISOString().split('T')[0];
                const endStr = end.toISOString().split('T')[0];

                // Open preview modal immediately (will be populated once data is ready)
                const periodLabel = getPeriodLabel(period, start, end);
                const initialTitleMap = {
                    by_site: `Accommodations by Site - ${periodLabel}`,
                    by_company: `Accommodations by Company - ${periodLabel}`,
                    by_department: `Accommodations by Department - ${periodLabel}`,
                    by_status: `Accommodations by Status - ${periodLabel}`,
                    by_employee: `Accommodations by Employee - ${periodLabel}`,
                    occupancy_rate: `Occupancy Rate by Site - ${periodLabel}`
                };
                const initialTitle = initialTitleMap[reportType] || `Report - ${periodLabel}`;
                openCampReportPreview(initialTitle, [], 0, reportType, periodLabel);

                // Fetch assignments
                const snapshot = await firebase.database().ref(`companies/${user.companyId}/roomAssignments`).once('value');
                const allAssignments = snapshot.val() || {};

                // Filter assignments by date and status
                const filtered = Object.entries(allAssignments).filter(([id, a]) => {
                    // Check date range (use checkInDate as reference)
                    const checkIn = (a.actualCheckInDate || a.checkInDate || '').split('T')[0];
                    if (checkIn && (checkIn < startStr || checkIn > endStr)) return false;

                    // Check record type
                    const isActive = a.status === 'assigned' || a.status === 'checked_in';
                    const isArchived = a.status === 'checked_out' || a.status === 'cancelled';
                    
                    if (isActive && !includeActive) return false;
                    if (isArchived && !includeArchived) return false;

                    return true;
                }).map(([id, a]) => ({ id, ...a }));

                // Generate report based on type
                let reportData = [];
                let reportTitle = '';
                // periodLabel already computed above

                switch (reportType) {
                    case 'by_site':
                        reportTitle = `Accommodations by Site - ${periodLabel}`;
                        {
                            const days = listDaysInclusive(start, end);
                            const sitesSet = new Set();
                            const counts = {}; // { [day]: { [site]: number } }

                            for (const a of filtered) {
                                const checkInDay = (a.actualCheckInDate || a.checkInDate || '').split('T')[0];
                                if (!checkInDay) continue;
                                if (checkInDay < days[0] || checkInDay > days[days.length - 1]) continue;

                                const site = await resolveAssignmentSiteLabel(a);
                                sitesSet.add(site);
                                if (!counts[checkInDay]) counts[checkInDay] = {};
                                counts[checkInDay][site] = (counts[checkInDay][site] || 0) + 1;
                            }

                            const sites = Array.from(sitesSet).sort((a, b) => String(a).localeCompare(String(b)));
                            reportData = { kind: 'matrix', days, sites, counts };
                        }
                        break;
                    case 'by_company':
                        reportTitle = `Accommodations by Company - ${periodLabel}`;
                        {
                            const days = listDaysInclusive(start, end);
                            const companiesSet = new Set();
                            const counts = {}; // { [day]: { [company]: number } }

                            for (const a of filtered) {
                                const checkInDay = (a.actualCheckInDate || a.checkInDate || '').split('T')[0];
                                if (!checkInDay) continue;
                                if (checkInDay < days[0] || checkInDay > days[days.length - 1]) continue;

                                const company = await resolveEmployerCompanyNameForAssignment(user.companyId, a);
                                companiesSet.add(company);
                                if (!counts[checkInDay]) counts[checkInDay] = {};
                                counts[checkInDay][company] = (counts[checkInDay][company] || 0) + 1;
                            }

                            const columns = Array.from(companiesSet).sort((a, b) => String(a).localeCompare(String(b)));
                            reportData = { kind: 'matrix', days, columns, counts, columnGroupLabel: 'Company' };
                        }
                        break;
                    case 'by_department':
                        reportTitle = `Accommodations by Department - ${periodLabel}`;
                        {
                            const days = listDaysInclusive(start, end);
                            const deptOptions = await getCampDepartmentOptions(user.companyId);
                            const counts = {}; // { [day]: { [department]: number } }

                            // Build list of official department labels
                            const officialDepts = deptOptions
                                .map(opt => String(opt.label || opt.name || opt.value || '').trim())
                                .filter(Boolean);

                            const departmentsSet = new Set(officialDepts);
                            let hasUnknown = false;

                            for (const a of filtered) {
                                const checkInDay = (a.actualCheckInDate || a.checkInDate || '').split('T')[0];
                                if (!checkInDay) continue;
                                if (checkInDay < days[0] || checkInDay > days[days.length - 1]) continue;

                                const rawDept = await resolveDepartmentRawForAssignment(user.companyId, a);
                                let dept = matchDepartmentLabel(rawDept, deptOptions);
                                if (!dept) {
                                    dept = 'Unknown Department';
                                    hasUnknown = true;
                                }
                                departmentsSet.add(dept);
                                if (!counts[checkInDay]) counts[checkInDay] = {};
                                counts[checkInDay][dept] = (counts[checkInDay][dept] || 0) + 1;
                            }

                            // Keep official order, then append Unknown if needed
                            const columns = officialDepts.slice();
                            if (hasUnknown && !columns.includes('Unknown Department')) {
                                columns.push('Unknown Department');
                            }

                            reportData = { kind: 'matrix', days, columns, counts, columnGroupLabel: 'Department' };
                        }
                        break;
                    case 'by_status':
                        reportTitle = `Accommodations by Status - ${periodLabel}`;
                        {
                            const days = listDaysInclusive(start, end);
                            const statusLabels = ['Assigned', 'Checked In', 'Checked Out', 'Cancelled'];
                            const counts = {}; // { [day]: { [status]: number } }

                            for (const a of filtered) {
                                const checkInDay = (a.actualCheckInDate || a.checkInDate || '').split('T')[0];
                                if (!checkInDay) continue;
                                if (checkInDay < days[0] || checkInDay > days[days.length - 1]) continue;

                                const status = formatStatus(a.status);
                                if (!counts[checkInDay]) counts[checkInDay] = {};
                                counts[checkInDay][status] = (counts[checkInDay][status] || 0) + 1;
                            }

                            reportData = { kind: 'matrix', days, sites: statusLabels, counts, columnGroupLabel: 'Status', hideTotal: true };
                        }
                        break;
                    case 'by_employee':
                        reportTitle = `Accommodations by Employee - ${periodLabel}`;
                        reportData = aggregateBy(filtered, a => a.employeeName || a.employee || 'Unknown Employee');
                        break;
                    case 'occupancy_rate':
                        reportTitle = `Occupancy Rate by Site - ${periodLabel}`;
                        {
                            const days = listDaysInclusive(start, end);

                            // Get room capacities per site
                            const siteCapacities = {};
                            try {
                                const roomsSnap = await firebase.database().ref(`companies/${user.companyId}/rooms`).once('value');
                                const rooms = roomsSnap.val() || {};
                                Object.values(rooms).forEach(room => {
                                    if (!room) return;
                                    let site = room.site || '';
                                    if (!site && room.location) {
                                        if (typeof room.location === 'string') {
                                            site = room.location;
                                        } else {
                                            const { block, building, floor } = room.location;
                                            site = block || [building, floor].filter(Boolean).join(' ') || '';
                                        }
                                    }
                                    site = site || 'Unknown Location';
                                    if (!siteCapacities[site]) siteCapacities[site] = 0;
                                    siteCapacities[site] += parseInt(room.capacity || 1, 10);
                                });
                            } catch (e) {
                                console.warn('Could not fetch rooms:', e);
                            }

                            // Build matrix: days x sites with occupancy counts
                            const sitesSet = new Set(Object.keys(siteCapacities));
                            const counts = {}; // { [day]: { [site]: occupied } }

                            for (const a of filtered) {
                                if (!a || (a.status !== 'assigned' && a.status !== 'checked_in')) continue;
                                const checkInDay = (a.actualCheckInDate || a.checkInDate || '').split('T')[0];
                                if (!checkInDay) continue;
                                if (checkInDay < days[0] || checkInDay > days[days.length - 1]) continue;

                                const site = await resolveAssignmentSiteLabel(a);
                                sitesSet.add(site);
                                if (!counts[checkInDay]) counts[checkInDay] = {};
                                counts[checkInDay][site] = (counts[checkInDay][site] || 0) + 1;
                            }

                            const sites = Array.from(sitesSet).sort((a, b) => String(a).localeCompare(String(b)));
                            reportData = { kind: 'matrix', days, sites, counts, columnGroupLabel: 'Site', isOccupancy: true, siteCapacities };
                        }
                        break;
                }

                // Display report
                displayReport(reportTitle, reportData, filtered.length, reportType, periodLabel);

            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Failed to generate report: ' + (error.message || error), 'error');
            }
        }

        function aggregateBy(data, keyFn) {
            const counts = {};
            data.forEach(item => {
                const key = keyFn(item);
                counts[key] = (counts[key] || 0) + 1;
            });

            const total = data.length;
            return Object.entries(counts)
                .map(([category, count]) => ({
                    category,
                    count,
                    percentage: total > 0 ? ((count / total) * 100).toFixed(1) : '0.0'
                }))
                .sort((a, b) => b.count - a.count);
        }

        async function aggregateByAsync(data, keyFnAsync) {
            const counts = {};
            for (const item of data) {
                let key;
                try {
                    key = await keyFnAsync(item);
                } catch (_e) {
                    key = 'Unknown';
                }
                key = key || 'Unknown';
                counts[key] = (counts[key] || 0) + 1;
            }

            const total = data.length;
            return Object.entries(counts)
                .map(([category, count]) => ({
                    category,
                    count,
                    percentage: total > 0 ? ((count / total) * 100).toFixed(1) : '0.0'
                }))
                .sort((a, b) => b.count - a.count);
        }

        async function calculateOccupancyRate(assignments, companyId) {
            // Get rooms by site
            const siteCounts = {};
            const siteCapacities = {};

            // Get rooms data
            try {
                const roomsSnap = await firebase.database().ref(`companies/${companyId}/rooms`).once('value');
                const rooms = roomsSnap.val() || {};
                
                Object.values(rooms).forEach(room => {
                    if (!room) return;
                    let site = room.site || '';
                    if (!site && room.location) {
                        if (typeof room.location === 'string') {
                            site = room.location;
                        } else {
                            const { block, building, floor } = room.location;
                            site = block || [building, floor].filter(Boolean).join(' ') || '';
                        }
                    }
                    site = site || 'Unknown Location';
                    if (!siteCapacities[site]) siteCapacities[site] = 0;
                    siteCapacities[site] += parseInt(room.capacity || 1, 10);
                });
            } catch (e) {
                console.warn('Could not fetch rooms:', e);
            }

            // Count active assignments per site
            for (const a of assignments) {
                if (!a) continue;
                if (a.status !== 'assigned' && a.status !== 'checked_in') continue;

                let site = a.site || a.location || '';
                if (!site) {
                    const roomCode = a.roomNumber || a.room || a.roomCode || '';
                    const loc = await getRoomLocationDisplay(roomCode);
                    site = (loc && loc !== '-') ? loc : '';
                }

                site = site || 'Unknown Location';
                siteCounts[site] = (siteCounts[site] || 0) + 1;
            }

            // Calculate occupancy rates
            const allSites = new Set([...Object.keys(siteCounts), ...Object.keys(siteCapacities)]);
            return Array.from(allSites).map(site => {
                const occupied = siteCounts[site] || 0;
                const capacity = siteCapacities[site] || 1;
                const rate = ((occupied / capacity) * 100).toFixed(1);
                return {
                    category: site,
                    count: `${occupied} / ${capacity}`,
                    percentage: rate
                };
            }).sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
        }

        function formatStatus(status) {
            const map = {
                'assigned': 'Assigned',
                'checked_in': 'Checked In',
                'checked_out': 'Checked Out',
                'cancelled': 'Cancelled'
            };
            return map[status] || status || 'Unknown';
        }

        function getPeriodLabel(period, start, end) {
            const fmt = d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            switch (period) {
                case 'today': return 'Today';
                case 'yesterday': return 'Yesterday';
                case 'last_7_days': return 'Last 7 Days';
                case 'last_30_days': return 'Last 30 Days';
                case 'this_month': return 'This Month';
                case 'last_month': return 'Last Month';
                case 'this_year': return 'This Year';
                case 'last_year': return 'Last Year';
                case 'all_time': return 'All Time';
                case 'custom': return `${fmt(start)} - ${fmt(end)}`;
                default: return '';
            }
        }

        function isCampMatrixReportData(data) {
            const cols = data && (data.columns || data.sites);
            return !!data && typeof data === 'object' && !Array.isArray(data) && data.kind === 'matrix' && Array.isArray(cols) && Array.isArray(data.days);
        }

        function getCampMatrixColumns(data) {
            if (!data) return [];
            return Array.isArray(data.columns) ? data.columns : (Array.isArray(data.sites) ? data.sites : []);
        }

        function listDaysInclusive(startDate, endDate) {
            const days = [];
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            for (let d = start; d <= end; d = new Date(d.getTime() + 86400000)) {
                days.push(d.toISOString().slice(0, 10));
            }
            return days;
        }

        function formatCampDayLabel(dayKey) {
            // Expecting YYYY-MM-DD. Display only day-of-month (no month/year).
            if (!dayKey) return '';
            const s = String(dayKey);
            const parts = s.split('-');
            if (parts.length === 3 && parts[2]) {
                const dayPart = parts[2];
                const n = parseInt(dayPart, 10);
                return Number.isFinite(n) ? String(n) : dayPart;
            }
            return s;
        }

        async function resolveAssignmentSiteLabel(assignment) {
            if (!assignment) return 'Unknown Location';
            const explicit = assignment.site || assignment.location;
            if (explicit) return explicit;
            const roomCode = assignment.roomNumber || assignment.room || assignment.roomCode || '';
            const loc = await getRoomLocationDisplay(roomCode);
            return (loc && loc !== '-') ? loc : 'Unknown Location';
        }

        function resolveAssignmentCompanyLabel(assignment) {
            if (!assignment) return 'Unknown Company';
            return assignment.companyName || assignment.company || assignment.contractorName || 'Unknown Company';
        }

        const __campUserRecordCache = new Map();
        const __campDepartmentOptionsCache = new Map();

        function campDbRef(path) {
            if (window.authManager && window.authManager.db && typeof window.authManager.db.ref === 'function') {
                return window.authManager.db.ref(path);
            }
            return firebase.database().ref(path);
        }

        async function getCampUserRecord(companyId, userId) {
            if (!companyId || !userId) return null;
            const cacheKey = `${companyId}:${userId}`;
            if (__campUserRecordCache.has(cacheKey)) return __campUserRecordCache.get(cacheKey);

            try {
                // Same primary path used in companymanagement.html
                const scopedSnap = await campDbRef(`companies/${companyId}/users/${userId}`).once('value');
                if (scopedSnap.exists()) {
                    const val = scopedSnap.val();
                    __campUserRecordCache.set(cacheKey, val);
                    return val;
                }
            } catch (_e) {
                // ignore and try global fallback
            }

            try {
                // Fallback used in companymanagement.html for consistency
                const globalSnap = await campDbRef(`users/${userId}`).once('value');
                const val = globalSnap.exists() ? globalSnap.val() : null;
                __campUserRecordCache.set(cacheKey, val);
                return val;
            } catch (_e) {
                __campUserRecordCache.set(cacheKey, null);
                return null;
            }
        }

        async function resolveEmployerCompanyNameForAssignment(companyId, assignment) {
            // Prefer explicit company fields already saved on the assignment
            const direct = assignment && (assignment.companyName || assignment.company || assignment.contractorName);
            if (direct) return direct;

            const userId = assignment && (assignment.employeeId || assignment.employeeUid || assignment.userId || assignment.uid);
            if (!userId) return '-';

            const u = await getCampUserRecord(companyId, userId);
            return (u && (u.employerCompanyName || u.companyName || u.employerCompany || u.employer)) || '-';
        }

        async function getCampDepartmentOptions(companyId) {
            if (!companyId) return [];
            if (__campDepartmentOptionsCache.has(companyId)) return __campDepartmentOptionsCache.get(companyId);

            try {
                const snap = await campDbRef(`companies/${companyId}/fieldOptions/department`).once('value');
                if (snap.exists()) {
                    const departmentsData = snap.val();
                    let options = [];
                    if (Array.isArray(departmentsData)) {
                        options = departmentsData
                            .filter(d => d && d.enabled !== false)
                            .slice()
                            .sort((a, b) => String(a.label || a.name || a.value || '').localeCompare(String(b.label || b.name || b.value || '')));
                    } else if (typeof departmentsData === 'object' && departmentsData) {
                        const deptArray = Object.values(departmentsData);
                        if (deptArray.length > 0 && typeof deptArray[0] === 'object' && deptArray[0].label) {
                            options = deptArray
                                .filter(d => d && d.enabled !== false)
                                .slice()
                                .sort((a, b) => String(a.label || '').localeCompare(String(b.label || '')));
                        } else {
                            options = deptArray
                                .filter(Boolean)
                                .map(dept => ({
                                    label: String(dept),
                                    value: String(dept).toLowerCase().replace(/\s+/g, '-'),
                                    enabled: true
                                }))
                                .sort((a, b) => String(a.label || '').localeCompare(String(b.label || '')));
                        }
                    }

                    __campDepartmentOptionsCache.set(companyId, options);
                    return options;
                }
            } catch (_e) {
                // ignore
            }

            __campDepartmentOptionsCache.set(companyId, []);
            return [];
        }

        function matchDepartmentLabel(rawDepartment, options) {
            const raw = (rawDepartment || '').toString().trim();
            if (!raw) return '';
            const rawLower = raw.toLowerCase();
            const rawSlug = rawLower.replace(/\s+/g, '-');

            for (const opt of (options || [])) {
                if (!opt) continue;
                const label = (opt.label || opt.name || '').toString().trim();
                const value = (opt.value || '').toString().trim();
                if (!label && !value) continue;
                if (label && label.toLowerCase() === rawLower) return label;
                if (value && value.toLowerCase() === rawLower) return label || value;
                if (value && value.toLowerCase() === rawSlug) return label || value;
            }
            return '';
        }

        async function resolveDepartmentRawForAssignment(companyId, assignment) {
            const userId = assignment && (assignment.employeeId || assignment.employeeUid || assignment.userId || assignment.uid);
            if (userId) {
                const u = await getCampUserRecord(companyId, userId);
                const dept = u && typeof u.department === 'string' ? u.department.trim() : '';
                if (dept) return dept;
            }

            const direct = assignment && typeof assignment.department === 'string' ? assignment.department.trim() : '';
            return direct || '';
        }

        function displayReport(title, data, totalRecords, reportType, periodLabel) {
            // Store for export
            window.__campLastReportData = { title, data, totalRecords, reportType, periodLabel };
            
            // Open the report preview modal
            openCampReportPreview(title, data, totalRecords, reportType, periodLabel);
        }

        async function openCampReportPreview(title, data, totalRecords, reportType, periodLabel) {
            const overlay = document.getElementById('campReportPreviewOverlay');
            if (!overlay) return;

            // Get company info for header
            const user = window.authManager?.currentUser;
            let companyName = 'Company Name';
            let logoUrl = '';

            if (user && user.companyId) {
                try {
                    const companySnap = await firebase.database().ref(`companies/${user.companyId}`).once('value');
                    const companyData = companySnap.val();
                    if (companyData) {
                        companyName = companyData.companyName || companyData.name || 'Company Name';
                        logoUrl = companyData.logoUrl || companyData.logo || '';
                    }
                } catch (e) {
                    console.warn('Could not fetch company info:', e);
                }
            }

            // Set company name and logo
            document.getElementById('campReportCompanyName').textContent = companyName;
            const logoEl = document.getElementById('campReportLogo');
            const logoFallback = document.getElementById('campReportLogoFallback');
            
            if (logoUrl) {
                logoEl.src = logoUrl;
                logoEl.style.display = 'block';
                logoFallback.style.display = 'none';
            } else {
                logoEl.style.display = 'none';
                logoFallback.style.display = 'flex';
                logoFallback.textContent = companyName.substring(0, 2).toUpperCase();
            }

            // Set report metadata
            document.getElementById('campReportDocTitle').textContent = title;
            document.getElementById('campReportGenerated').textContent = `Generated on ${new Date().toLocaleString()}`;
            document.getElementById('campReportType').textContent = getReportTypeLabel(reportType);
            document.getElementById('campReportPeriod').textContent = periodLabel;

            const thead = document.getElementById('campReportTableHead');
            const tbody = document.getElementById('campReportTableBody');

            // MATRIX VIEW: by_site (days in rows, sites in columns)
            if (isCampMatrixReportData(data)) {
                const cols = getCampMatrixColumns(data);
                const groupLabel = data.columnGroupLabel || (reportType === 'by_company' ? 'Company' : (reportType === 'by_department' ? 'Department' : 'Location'));
                const isRowEntityTranspose = (reportType === 'by_company' || reportType === 'by_department');

                // Build summary section
                const summaryEl = document.getElementById('campReportSummary');
                summaryEl.innerHTML = `
                    <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#0369a1;">${totalRecords}</div>
                        <div style="font-size:0.75rem;color:#0c4a6e;">Total Records</div>
                    </div>
                    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#15803d;">${cols.length}</div>
                        <div style="font-size:0.75rem;color:#14532d;">${escapeHtmlCamp(groupLabel)}s</div>
                    </div>
                    <div style="background:#fefce8;border:1px solid #fde047;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#a16207;">${data.days.length}</div>
                        <div style="font-size:0.75rem;color:#713f12;">Days</div>
                    </div>
                `;

                if (thead) {
                    if (isRowEntityTranspose) {
                        const dayHeaders = (data.days || []).map(d => {
                            const dayLabel = formatCampDayLabel(d);
                            const safeLabel = escapeHtmlCamp(dayLabel);
                            const safeTitle = escapeHtmlCamp(d);
                            return `<th title="${safeTitle}" style="padding:4px 3px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:700; color:#fff; white-space:nowrap; line-height:1.1; font-size:.62rem; width:22px; min-width:22px; max-width:22px;">${safeLabel}</th>`;
                        }).join('');
                        thead.innerHTML = `
                            <tr style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                                <th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:left; font-weight:600; color:#fff;" rowspan="2">${escapeHtmlCamp(groupLabel)}</th>
                                <th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff;" colspan="${(data.days || []).length}">Date</th>
                                <th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff;" rowspan="2">Total</th>
                            </tr>
                            <tr style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                                ${dayHeaders}
                            </tr>
                        `;
                    } else {
                        const siteHeaders = cols.map(s => {
                            const safe = escapeHtmlCamp(s);
                            return `<th title="${safe}" style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.15; min-width:140px; max-width:260px;">${safe}</th>`;
                        }).join('');
                        const showTotal = !data.hideTotal;
                        thead.innerHTML = `
                            <tr style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                                <th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:left; font-weight:600; color:#fff;" rowspan="2">Date</th>
                                <th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff;" colspan="${cols.length}">${escapeHtmlCamp(groupLabel)}</th>
                                ${showTotal ? '<th style="padding:10px 12px; border:1px solid rgba(255,255,255,0.22); text-align:center; font-weight:600; color:#fff;" rowspan="2">Total</th>' : ''}
                            </tr>
                            <tr style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                                ${siteHeaders}
                            </tr>
                        `;
                    }
                }

                if (!tbody || (data.days || []).length === 0 || cols.length === 0) {
                    const colspan = isRowEntityTranspose ? ((data.days || []).length + 2) : (cols.length + 2);
                    if (tbody) tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;color:#64748b;padding:2rem;">No data found for the selected criteria</td></tr>`;
                } else {
                    if (isRowEntityTranspose) {
                        const days = data.days || [];
                        const counts = data.counts || {};

                        // Calculate column totals for footer
                        const colTotals = days.map(day => {
                            let dayTotal = 0;
                            cols.forEach(entity => {
                                dayTotal += (counts[day] || {})[entity] || 0;
                            });
                            return dayTotal;
                        });
                        const grandTotal = colTotals.reduce((sum, n) => sum + n, 0);

                        const bodyRows = cols.map((entity, idx) => {
                            let rowTotal = 0;
                            const cells = days.map(day => {
                                const dayCounts = counts[day] || {};
                                const n = dayCounts[entity] || 0;
                                rowTotal += n;
                                return `<td style="padding:4px 3px; border:1px solid #e5e7eb; text-align:center; font-size:.58rem; width:22px; min-width:22px; max-width:22px;">${n}</td>`;
                            }).join('');
                            const safeEntity = escapeHtmlCamp(entity);
                            return `
                                <tr style="background:${idx % 2 === 0 ? '#fff' : '#f9fafb'};">
                                    <td title="${safeEntity}" style="padding:3px 5px; border:1px solid #e5e7eb; font-weight:600; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; font-size:.58rem; line-height:1.15;">${safeEntity}</td>
                                    ${cells}
                                    <td style="padding:3px 4px; border:1px solid #e5e7eb; text-align:center; font-weight:700; color:#111827; font-size:.58rem; white-space:nowrap; width:30px; min-width:30px;">${rowTotal}</td>
                                </tr>
                            `;
                        }).join('');

                        // Footer row with totals
                        const footerCells = colTotals.map(n => `<td style="padding:4px 3px; border:1px solid #d1d5db; text-align:center; font-size:.58rem; font-weight:700; color:#111827; background:#f1f5f9;">${n}</td>`).join('');
                        const footerRow = `
                            <tr style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0);">
                                <td style="padding:3px 5px; border:1px solid #d1d5db; font-weight:700; color:#111827; font-size:.58rem; white-space:nowrap;">Total</td>
                                ${footerCells}
                                <td style="padding:3px 4px; border:1px solid #d1d5db; text-align:center; font-weight:700; color:#111827; font-size:.58rem; background:#e2e8f0;">${grandTotal}</td>
                            </tr>
                        `;

                        tbody.innerHTML = bodyRows + footerRow;
                    } else {
                        // Days in rows, sites/entities in columns (by_site, occupancy_rate)
                        const isOccupancy = !!data.isOccupancy;
                        const siteCapacities = data.siteCapacities || {};

                        const showTotal = !data.hideTotal;
                        const bodyRows = data.days.map((day, idx) => {
                            const rowCounts = data.counts[day] || {};
                            let rowTotal = 0;
                            const cells = cols.map(site => {
                                const n = rowCounts[site] || 0;
                                rowTotal += n;
                                if (isOccupancy) {
                                    const cap = siteCapacities[site] || 1;
                                    const pct = ((n / cap) * 100).toFixed(0);
                                    return `<td title="${n}/${cap} (${pct}%)" style="padding:6px 8px; border:1px solid #e5e7eb; text-align:center; font-size:.65rem;">${n}/${cap}</td>`;
                                }
                                return `<td style="padding:10px 12px; border:1px solid #e5e7eb; text-align:center;">${n}</td>`;
                            }).join('');
                            const dayLabel = formatCampDayLabel(day);

                            return `
                                <tr style="background:${idx % 2 === 0 ? '#fff' : '#f9fafb'};">
                                    <td title="${escapeHtmlCamp(day)}" style="padding:10px 12px; border:1px solid #e5e7eb; font-weight:600; color:#111827;">${escapeHtmlCamp(dayLabel)}</td>
                                    ${cells}
                                    ${showTotal ? `<td style="padding:10px 12px; border:1px solid #e5e7eb; text-align:center; font-weight:700; color:#111827;">${rowTotal}</td>` : ''}
                                </tr>
                            `;
                        }).join('');

                        // Footer row with column totals
                        const colTotals = cols.map(site => {
                            let total = 0;
                            data.days.forEach(day => {
                                total += (data.counts[day] || {})[site] || 0;
                            });
                            return total;
                        });
                        const grandTotal = colTotals.reduce((sum, n) => sum + n, 0);

                        const footerCells = cols.map((site, i) => {
                            const n = colTotals[i];
                            if (isOccupancy) {
                                const cap = (siteCapacities[site] || 1) * data.days.length;
                                const pct = ((n / cap) * 100).toFixed(0);
                                return `<td title="${n}/${cap} (${pct}%)" style="padding:6px 8px; border:1px solid #d1d5db; text-align:center; font-size:.65rem; font-weight:700; background:#f1f5f9;">${n}</td>`;
                            }
                            return `<td style="padding:10px 12px; border:1px solid #d1d5db; text-align:center; font-weight:700; background:#f1f5f9;">${n}</td>`;
                        }).join('');

                        const footerRow = `
                            <tr style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0);">
                                <td style="padding:10px 12px; border:1px solid #d1d5db; font-weight:700; color:#111827;">Total</td>
                                ${footerCells}
                                ${showTotal ? `<td style="padding:10px 12px; border:1px solid #d1d5db; text-align:center; font-weight:700; color:#111827; background:#e2e8f0;">${grandTotal}</td>` : ''}
                            </tr>
                        `;

                        tbody.innerHTML = bodyRows + footerRow;
                    }
                }

                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                return;
            }

            // Set dynamic column headers based on report type
            const categoryHeader = document.getElementById('campReportCategoryHeader');
            const countHeader = document.getElementById('campReportCountHeader');
            const columnLabels = getCategoryColumnLabel(reportType);
            if (categoryHeader) categoryHeader.textContent = columnLabels.category;
            if (countHeader) countHeader.textContent = columnLabels.count;

            // Build summary section
            const summaryEl = document.getElementById('campReportSummary');
            summaryEl.innerHTML = `
                <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:1rem;text-align:center;">
                    <div style="font-size:1.5rem;font-weight:700;color:#0369a1;">${totalRecords}</div>
                    <div style="font-size:0.75rem;color:#0c4a6e;">Total Records</div>
                </div>
                <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:1rem;text-align:center;">
                    <div style="font-size:1.5rem;font-weight:700;color:#15803d;">${data.length}</div>
                    <div style="font-size:0.75rem;color:#14532d;">Categories</div>
                </div>
                ${data.length > 0 ? `
                <div style="background:#fefce8;border:1px solid #fde047;border-radius:8px;padding:1rem;text-align:center;">
                    <div style="font-size:1rem;font-weight:700;color:#a16207;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtmlCamp(data[0].category)}">${escapeHtmlCamp(data[0].category)}</div>
                    <div style="font-size:0.75rem;color:#713f12;">Top Category (${data[0].count})</div>
                </div>
                ` : ''}
            `;

            // Build data table
            if (!tbody) return;
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#64748b;padding:2rem;">No data found for the selected criteria</td></tr>';
            } else {
                tbody.innerHTML = data.map((row, idx) => `
                    <tr style="background:${idx === 0 ? '#fffbeb' : (idx % 2 === 0 ? '#fff' : '#f9fafb')};">
                        <td style="padding:10px 12px; border:1px solid #e5e7eb; font-weight:${idx === 0 ? '600' : '400'}; color:#111827;">${escapeHtmlCamp(row.category)}</td>
                        <td style="padding:10px 12px; border:1px solid #e5e7eb; text-align:center; font-weight:600; color:#111827;">${row.count}</td>
                        <td style="padding:10px 12px; border:1px solid #e5e7eb; text-align:center;">
                            <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
                                <div style="flex:1;max-width:80px;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
                                    <div style="width:${row.percentage}%;height:100%;background:${idx === 0 ? '#f59e0b' : '#3b82f6'};border-radius:4px;"></div>
                                </div>
                                <span style="min-width:45px;font-weight:500;">${row.percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // Show modal
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function getReportTypeLabel(reportType) {
            const labels = {
                'by_site': 'Accommodations by Site/Location',
                'by_company': 'Accommodations by Company',
                'by_department': 'Accommodations by Department',
                'by_status': 'Accommodations by Status',
                'by_employee': 'Accommodations by Employee',
                'occupancy_rate': 'Occupancy Rate by Site'
            };
            return labels[reportType] || reportType;
        }

        function getCategoryColumnLabel(reportType) {
            const labels = {
                'by_site': { category: 'Location', count: 'Accommodated' },
                'by_company': { category: 'Company', count: 'Accommodated' },
                'by_department': { category: 'Department', count: 'Accommodated' },
                'by_status': { category: 'Status', count: 'Accommodated' },
                'by_employee': { category: 'Employee', count: 'Accommodated' },
                'occupancy_rate': { category: 'Location', count: 'Occupied / Capacity' }
            };
            return labels[reportType] || { category: 'Category', count: 'Count' };
        }

        function closeCampReportPreview() {
            const overlay = document.getElementById('campReportPreviewOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

                function __ensureCampReportPrintStyle({ landscape } = { landscape: false }) {
                        const styleId = 'campReportPrintStyle';
                        let styleEl = document.getElementById(styleId);
                        if (!styleEl) {
                                styleEl = document.createElement('style');
                                styleEl.id = styleId;
                                document.head.appendChild(styleEl);
                        }

                        const pageSize = landscape ? 'A4 landscape' : 'A4';
                        styleEl.textContent = `
@media print {
    @page { size: ${pageSize}; margin: 6mm; }

    html, body {
        margin: 0 !important;
        padding: 0 !important;
        background: #fff !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    body[data-camp-print="camp-report"] * { visibility: hidden !important; }
    body[data-camp-print="camp-report"] #campReportPreviewOverlay,
    body[data-camp-print="camp-report"] #campReportPreviewOverlay * { visibility: visible !important; }

    body[data-camp-print="camp-report"] #campReportPreviewOverlay {
        display: block !important;
        position: absolute !important;
        inset: 0 !important;
        background: #fff !important;
        overflow: visible !important;
        padding: 0 !important;
    }

    body[data-camp-print="camp-report"] .camp-report-container {
        box-shadow: none !important;
        border-radius: 0 !important;
        max-width: none !important;
        width: 100% !important;
        min-height: auto !important;
    }

    body[data-camp-print="camp-report"] #campReportPrintBtn,
    body[data-camp-print="camp-report"] #campReportExportBtn,
    body[data-camp-print="camp-report"] #campReportCloseBtn { display: none !important; }

    /* Tighten table for landscape (by_company) to fit A4 */
    body[data-camp-print="camp-report"] .camp-report-table { font-size: 7pt !important; }
    body[data-camp-print="camp-report"] .camp-report-table th,
    body[data-camp-print="camp-report"] .camp-report-table td { padding: 2px 3px !important; }
    body[data-camp-print="camp-report"] .camp-report-table th { line-height: 1.05 !important; }
}
                        `.trim();

                        return styleEl;
                }

        function printCampReport() {
                        const overlay = document.getElementById('campReportPreviewOverlay');
                        if (!overlay) {
                                window.print();
                                return;
                        }

                        const report = window.__campLastReportData;
                        const isLandscape = (report && (report.reportType === 'by_company' || report.reportType === 'by_department'));

                        document.body.setAttribute('data-camp-print', 'camp-report');
                        const styleEl = __ensureCampReportPrintStyle({ landscape: isLandscape });

                        const cleanup = () => {
                                document.body.removeAttribute('data-camp-print');
                                if (styleEl && styleEl.parentNode) styleEl.parentNode.removeChild(styleEl);
                                window.removeEventListener('afterprint', cleanup);
                        };
                        window.addEventListener('afterprint', cleanup);

                        // Fallback cleanup (some browsers don't reliably fire afterprint)
                        setTimeout(cleanup, 1500);
                        window.print();
        }

        function exportReportToCSV() {
            const report = window.__campLastReportData;
            if (!report || !report.data) {
                showNotification('No report data to export', 'warning');
                return;
            }

            // Matrix export
            if (isCampMatrixReportData(report.data)) {
                const cols = getCampMatrixColumns(report.data);
                const days = report.data.days || [];
                const counts = report.data.counts || {};

                const isRowEntityTranspose = (report.reportType === 'by_company' || report.reportType === 'by_department');
                const entityLabel = report.reportType === 'by_company' ? 'Company' : (report.reportType === 'by_department' ? 'Department' : 'Entity');
                const header = isRowEntityTranspose ? [entityLabel, ...days, 'Total'] : ['Day', ...cols, 'Total'];

                const bodyRows = isRowEntityTranspose
                    ? cols.map(company => {
                        let rowTotal = 0;
                        const vals = days.map(day => {
                            const n = (counts[day] || {})[company] || 0;
                            rowTotal += n;
                            return n;
                        });
                        return [company, ...vals, rowTotal];
                    })
                    : days.map(day => {
                        const rowCounts = counts[day] || {};
                        let rowTotal = 0;
                        const vals = cols.map(col => {
                            const n = rowCounts[col] || 0;
                            rowTotal += n;
                            return n;
                        });
                        return [day, ...vals, rowTotal];
                    });

                const rows = [
                    [report.title],
                    [],
                    header,
                    ...bodyRows,
                    [],
                    [`Total Records: ${report.totalRecords}`]
                ];

                const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `camp_report_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('Report exported to CSV', 'success');
                return;
            }

            const rows = [
                [report.title],
                [],
                ['Category', 'Count', 'Percentage'],
                ...report.data.map(r => [r.category, r.count, `${r.percentage}%`]),
                [],
                [`Total Records: ${report.totalRecords}`]
            ];

            const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `camp_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Report exported to CSV', 'success');
        }
        // =================== END NEW REPORTING TAB FUNCTIONS ===================

        // Manual employee entry removed; only dropdown selection is supported.

        // Get list of employees who currently have active room assignments
        async function getAssignedEmployees(companyId) {
            try {
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.once('value');
                const assignedEmployees = [];
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    Object.values(assignments).forEach(assignment => {
                        if (assignment.status === 'assigned' || assignment.status === 'checked_in') {
                            assignedEmployees.push(assignment.employeeId);
                        }
                    });
                }
                
                return assignedEmployees;
            } catch (error) {
                console.error('Error getting assigned employees:', error);
                return [];
            }
        }

        // Get list of rooms that are currently occupied
        async function getOccupiedRooms(companyId) {
            try {
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.once('value');
                const counts = new Map();
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    Object.values(assignments).forEach(assignment => {
                        if (assignment.status === 'assigned' || assignment.status === 'checked_in') {
                            const room = assignment.roomNumber || assignment.room || assignment.roomCode;
                            if (!room) return;
                            const key = String(room);
                            counts.set(key, (counts.get(key) || 0) + 1);
                        }
                    });
                }
                const fullRooms = [];
                for (const [room, cnt] of counts.entries()) {
                    const cap = await getEffectiveRoomCapacity(room);
                    if (cnt >= cap) fullRooms.push(room);
                }
                return fullRooms;
            } catch (error) {
                console.error('Error getting occupied rooms:', error);
                return [];
            }
        }

        // Get set of rooms unavailable for a given date range due to overlapping assignments
        async function getRoomsUnavailableInRange(companyId, startDateStr, endDateStr) {
            try {
                const start = startDateStr ? new Date(startDateStr).getTime() : null;
                const end = endDateStr ? new Date(endDateStr).getTime() : null;
                // If dates are missing or invalid, fall back to current occupancy snapshot
                if (!start || !end || !isFinite(start) || !isFinite(end)) {
                    // For fallback, treat any room with active count >= capacity as unavailable
                    const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                    const snap = await assignmentsRef.once('value');
                    const counts = new Map();
                    if (snap.exists()) {
                        const items = snap.val() || {};
                        Object.values(items).forEach(a => {
                            if (!a) return;
                            if (!(a.status === 'assigned' || a.status === 'checked_in')) return;
                            const room = a.roomNumber || a.room || a.roomCode;
                            if (!room) return;
                            const key = String(room);
                            counts.set(key, (counts.get(key) || 0) + 1);
                        });
                    }
                    const blocked = new Set();
                    for (const [room, cnt] of counts.entries()) {
                        const cap = await getEffectiveRoomCapacity(room);
                        if (cnt >= cap) blocked.add(room);
                    }
                    return blocked;
                }

                const blocked = new Set();
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.once('value');
                if (!snapshot.exists()) return blocked;

                const items = snapshot.val() || {};
                const overlapCounts = new Map();
                for (const a of Object.values(items)) {
                    if (!a) continue;
                    if (a.status === 'cancelled') continue;
                    const room = a.roomNumber || a.room || a.roomCode;
                    if (!room) continue;
                    const prevStartStr = a.actualCheckInDate || a.checkInDate;
                    const prevEndStr = a.actualCheckOutDate || a.checkOutDate;
                    const prevStart = prevStartStr ? new Date(prevStartStr).getTime() : null;
                    const prevEnd = prevEndStr ? new Date(prevEndStr).getTime() : Number.POSITIVE_INFINITY;
                    if (!prevStart || !isFinite(prevStart)) continue;
                    const overlaps = prevStart <= end && start <= prevEnd;
                    if (overlaps) {
                        const key = String(room);
                        overlapCounts.set(key, (overlapCounts.get(key) || 0) + 1);
                    }
                }
                for (const [room, cnt] of overlapCounts.entries()) {
                    const cap = await getEffectiveRoomCapacity(room);
                    if (cnt >= cap) blocked.add(room);
                }
                return blocked;
            } catch (e) {
                console.error('getRoomsUnavailableInRange error:', e);
                return new Set();
            }
        }

        // Helper: fetch users for selected company, sourced from owner company's user management scope
        async function fetchCompanyUsers(companyIdToLoad) {
            try {
                const db = window.authManager.db;
                const ownerCompanyId = window.authManager.currentUser.companyId;
                // Always load from the owner company's users list (companymanagement scope)
                const usersRef = db.ref(`companies/${ownerCompanyId}/users`);
                const usersSnap = await usersRef.once('value');
                if (!usersSnap.exists()) return [];

                const userIds = Object.keys(usersSnap.val() || {});
                if (!userIds.length) return [];

                const details = await Promise.all(userIds.map(async (uid) => {
                    try {
                        // Get global user details
                        const uSnap = await db.ref(`users/${uid}`).once('value');
                        // Also read scoped user (to access employerCompany fields quickly)
                        const scopedSnap = await db.ref(`companies/${ownerCompanyId}/users/${uid}`).once('value');
                        if (!uSnap.exists()) return null;
                        const u = uSnap.val() || {};
                        const scoped = scopedSnap.val() || {};
                        // Determine the user's employer company id (scoped source of truth)
                        const employerCompanyId = scoped.employerCompanyId || u.employerCompanyId || ownerCompanyId;
                        // Filter: only include users whose employer company matches the selected company
                        if (employerCompanyId !== companyIdToLoad) return null;
                        return {
                            id: uid,
                            name: u.displayName || (u.firstName ? `${u.firstName} ${u.lastName || ''}`.trim() : (u.email ? u.email.split('@')[0] : 'Unknown')),
                            email: u.email || '',
                            department: u.department || scoped.department || 'N/A',
                            position: u.position || scoped.position || 'N/A'
                        };
                    } catch (e) {
                        console.warn('Failed loading user details for', uid, e);
                        return null;
                    }
                }));

                let filtered = details.filter(Boolean).sort((a, b) => a.name.localeCompare(b.name));

                // Fallback: if nothing matched via employerCompanyId, try selected company's own scope
                if (!filtered.length && companyIdToLoad && companyIdToLoad !== ownerCompanyId) {
                    try {
                        const scopedUsersRef = db.ref(`companies/${companyIdToLoad}/users`);
                        const scopedUsersSnap = await scopedUsersRef.once('value');
                        const scopedIds = Object.keys(scopedUsersSnap.val() || {});
                        if (scopedIds.length) {
                            const scopedDetails = await Promise.all(scopedIds.map(async (uid) => {
                                try {
                                    const uSnap = await db.ref(`users/${uid}`).once('value');
                                    if (!uSnap.exists()) return null;
                                    const u = uSnap.val() || {};
                                    return {
                                        id: uid,
                                        name: u.displayName || (u.firstName ? `${u.firstName} ${u.lastName || ''}`.trim() : (u.email ? u.email.split('@')[0] : 'Unknown')),
                                        email: u.email || '',
                                        department: u.department || 'N/A',
                                        position: u.position || 'N/A'
                                    };
                                } catch (e2) { return null; }
                            }));
                            filtered = scopedDetails.filter(Boolean).sort((a, b) => a.name.localeCompare(b.name));
                        }
                    } catch (e2) {
                        // ignore
                    }
                }

                return filtered;
            } catch (e) {
                console.error('Error fetching company users:', e);
                return [];
            }
        }

        // Global variable to store available employees for search
        window.__campAvailableEmployees = [];

        // Load employees for search (filtered by selected company)
        async function loadEmployeesForSearch() {
            if (!window.authManager) return;

            try {
                // Determine which company's employees to show (selected in the modal)
                const companySel = document.getElementById('assignmentCompanySelect');
                const fallbackCompanyId = window.authManager.currentUser.companyId;
                const selectedCompanyId = (companySel?.value || '').trim() || fallbackCompanyId;

                // Load users for the selected company
                const employees = await fetchCompanyUsers(selectedCompanyId);

                // Get currently assigned employees from the owner company (rooms belong to current company)
                const ownerCompanyId = fallbackCompanyId;
                const assignedEmployees = await getAssignedEmployees(ownerCompanyId);

                // Filter out already assigned employees
                window.__campAvailableEmployees = employees.filter(emp => !assignedEmployees.includes(emp.id));
                
                console.log(`? Loaded ${window.__campAvailableEmployees.length} available employees for search`);

            } catch (error) {
                console.error('Error loading employees for search:', error);
                window.__campAvailableEmployees = [];
            }
        }

        // Search employees by query
        function searchCampEmployees(query) {
            if (!query || query.length < 2) return [];
            const searchTerm = query.toLowerCase();
            return window.__campAvailableEmployees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                (emp.email && emp.email.toLowerCase().includes(searchTerm)) ||
                (emp.department && emp.department.toLowerCase().includes(searchTerm))
            ).slice(0, 10);
        }

        // Show employee search results
        function showEmployeeSearchResults(employees, resultsDiv, searchInput, hiddenInput) {
            resultsDiv.innerHTML = '';
            
            if (employees.length === 0) {
                resultsDiv.innerHTML = '<div class="employee-search-result no-results">No employees found</div>';
            } else {
                employees.forEach(emp => {
                    const div = document.createElement('div');
                    div.className = 'employee-search-result';
                    div.innerHTML = `
                        <div class="emp-name">${emp.name}</div>
                        <div class="emp-info">${emp.department && emp.department !== 'N/A' ? emp.department : ''}${emp.position && emp.position !== 'N/A' ? '  ' + emp.position : ''}${emp.email ? '  ' + emp.email : ''}</div>
                    `;
                    div.onclick = () => selectCampEmployee(emp, searchInput, hiddenInput, resultsDiv);
                    resultsDiv.appendChild(div);
                });
            }
            
            resultsDiv.style.display = 'block';
        }

        // Select an employee from search results
        function selectCampEmployee(employee, searchInput, hiddenInput, resultsDiv) {
            hiddenInput.value = employee.id;
            searchInput.value = employee.name + (employee.department && employee.department !== 'N/A' ? ` (${employee.department})` : '');
            resultsDiv.style.display = 'none';
        }

        // Initialize employee search functionality
        function initializeEmployeeSearch() {
            const searchInput = document.getElementById('assignmentEmployeeSearch');
            const hiddenInput = document.getElementById('assignmentEmployeeId');
            const resultsDiv = document.getElementById('assignmentEmployeeResults');
            
            if (!searchInput || !hiddenInput || !resultsDiv) return;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length >= 2) {
                    const results = searchCampEmployees(query);
                    showEmployeeSearchResults(results, resultsDiv, searchInput, hiddenInput);
                } else {
                    resultsDiv.style.display = 'none';
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        const results = searchCampEmployees(query);
                        if (results.length > 0) {
                            selectCampEmployee(results[0], searchInput, hiddenInput, resultsDiv);
                        }
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        // =================== ROOM SEARCH FUNCTIONS ===================
        // Search rooms by query
        function searchCampRooms(query) {
            if (!query || query.length < 1) return [];
            const searchTerm = query.toLowerCase();
            const base = Array.isArray(window.__camp_availableRooms) ? window.__camp_availableRooms : [];
            const locationSelect = document.getElementById('locationSelect');
            const selectedBlock = locationSelect ? (locationSelect.value || '') : '';
            
            return base.filter(room => {
                const matchesText = (room.label || room.value).toLowerCase().includes(searchTerm);
                const block = (room.location && room.location.block) || '';
                const matchesBlock = !selectedBlock || block === selectedBlock;
                return matchesText && matchesBlock;
            }).slice(0, 15);
        }

        // Show room search results
        function showRoomSearchResults(rooms, resultsDiv, searchInput, hiddenInput) {
            resultsDiv.innerHTML = '';
            
            if (rooms.length === 0) {
                resultsDiv.innerHTML = '<div class="room-search-result no-results">No rooms found</div>';
            } else {
                rooms.forEach(room => {
                    const div = document.createElement('div');
                    div.className = 'room-search-result';
                    const block = (room.location && room.location.block) || '';
                    const type = room.type || '';
                    div.innerHTML = `
                        <div class="room-name">${room.label || room.value}</div>
                        <div class="room-info">${block ? 'Block ' + block : ''}${type ? (block ? '  ' : '') + type : ''}</div>
                    `;
                    div.onclick = () => selectCampRoom(room, searchInput, hiddenInput, resultsDiv);
                    resultsDiv.appendChild(div);
                });
            }
            
            resultsDiv.style.display = 'block';
        }

        // Select a room from search results
        function selectCampRoom(room, searchInput, hiddenInput, resultsDiv) {
            hiddenInput.value = room.value;
            searchInput.value = room.label || room.value;
            resultsDiv.style.display = 'none';
        }

        // Initialize room search functionality
        function initializeRoomSearch() {
            const searchInput = document.getElementById('roomSearchInput');
            const hiddenInput = document.getElementById('roomSelect');
            const resultsDiv = document.getElementById('roomSearchResults');
            
            if (!searchInput || !hiddenInput || !resultsDiv) return;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length >= 1) {
                    const results = searchCampRooms(query);
                    showRoomSearchResults(results, resultsDiv, searchInput, hiddenInput);
                } else {
                    // Show all available rooms when input is empty or short
                    const base = Array.isArray(window.__camp_availableRooms) ? window.__camp_availableRooms : [];
                    const locationSelect = document.getElementById('locationSelect');
                    const selectedBlock = locationSelect ? (locationSelect.value || '') : '';
                    const filtered = base.filter(room => {
                        const block = (room.location && room.location.block) || '';
                        return !selectedBlock || block === selectedBlock;
                    }).slice(0, 15);
                    showRoomSearchResults(filtered, resultsDiv, searchInput, hiddenInput);
                }
            });

            searchInput.addEventListener('focus', () => {
                // Show available rooms on focus
                const base = Array.isArray(window.__camp_availableRooms) ? window.__camp_availableRooms : [];
                const locationSelect = document.getElementById('locationSelect');
                const selectedBlock = locationSelect ? (locationSelect.value || '') : '';
                const filtered = base.filter(room => {
                    const block = (room.location && room.location.block) || '';
                    return !selectedBlock || block === selectedBlock;
                }).slice(0, 15);
                showRoomSearchResults(filtered, resultsDiv, searchInput, hiddenInput);
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchInput.value.trim();
                    const results = searchCampRooms(query);
                    if (results.length > 0) {
                        selectCampRoom(results[0], searchInput, hiddenInput, resultsDiv);
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        // =================== MEAL PLAN FUNCTIONS ===================
        // Global cache for meal types
        window.__campMealTypesCache = [];
        // Selected meals for the assignment
        window.__campSelectedMeals = [];

        // Toggle meal plan section visibility
        function toggleMealPlanSection() {
            const enableMealPlan = document.getElementById('enableMealPlan');
            const mealPlanSection = document.getElementById('mealPlanSection');
            if (mealPlanSection) {
                mealPlanSection.style.display = enableMealPlan.checked ? 'block' : 'none';
            }
            // Auto-fill meal dates from check-in/check-out if empty
            if (enableMealPlan.checked) {
                const ci = document.getElementById('checkInDate')?.value;
                const co = document.getElementById('checkOutDate')?.value;
                const mealStart = document.getElementById('mealStartDate');
                const mealEnd = document.getElementById('mealEndDate');
                // Extract just the date part from datetime-local
                if (ci && !mealStart.value) mealStart.value = ci.split('T')[0];
                if (co && !mealEnd.value) mealEnd.value = co.split('T')[0];
                // Initialize meal search
                initializeMealSearch();
            }
        }

        // Load meal types from Firebase for assignment modal
        async function loadMealTypesForAssignment() {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    return;
                }

                const companyId = window.authManager.currentUser.companyId;
                const ref = window.authManager.db.ref(`companies/${companyId}/catering/mealTypes`);
                const snap = await ref.once('value');
                const data = snap.val() || {};
                const entries = Object.entries(data).filter(([id, mt]) => mt.active !== false);

                window.__campMealTypesCache = entries.map(([id, mt]) => ({
                    id,
                    name: mt.name || id,
                    price: mt.price || 0,
                    currency: mt.currency || ''
                }));

                console.log(' Meal types loaded:', window.__campMealTypesCache.length);

            } catch (error) {
                console.error('Error loading meal types:', error);
            }
        }

        // Search meals by query
        function searchCampMeals(query) {
            if (!query || query.length < 1) return window.__campMealTypesCache.slice(0, 10);
            const searchTerm = query.toLowerCase();
            return window.__campMealTypesCache.filter(meal => 
                meal.name.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
        }

        // Show meal search results
        function showMealSearchResults(meals, resultsDiv, searchInput) {
            resultsDiv.innerHTML = '';
            
            if (meals.length === 0) {
                resultsDiv.innerHTML = '<div class="meal-search-result no-results">No meal types found</div>';
            } else {
                meals.forEach(meal => {
                    const div = document.createElement('div');
                    div.className = 'meal-search-result';
                    // Check if already selected
                    const isSelected = window.__campSelectedMeals.some(m => m.id === meal.id);
                    if (isSelected) div.classList.add('selected');
                    
                    const priceText = meal.price ? `${meal.currency} ${meal.price}/day` : '';
                    div.innerHTML = `
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer;">
                            <div style="flex:1;">
                                <div class="meal-name">${meal.name}</div>
                                <div class="meal-info">${priceText}</div>
                            </div>
                        </div>
                    `;
                    div.onclick = (e) => {
                        e.stopPropagation(); // Prevent dropdown from closing
                        toggleMealSelection(meal, searchInput, resultsDiv);
                    };
                    resultsDiv.appendChild(div);
                });
            }
            
            resultsDiv.style.display = 'block';
        }

        // Toggle meal selection
        function toggleMealSelection(meal, searchInput, resultsDiv) {
            const existingIdx = window.__campSelectedMeals.findIndex(m => m.id === meal.id);
            if (existingIdx !== -1) {
                // Remove if already selected
                window.__campSelectedMeals.splice(existingIdx, 1);
            } else {
                // Add to selection
                window.__campSelectedMeals.push(meal);
            }
            // Update display
            renderSelectedMeals();
            // Refresh dropdown to show updated selection state
            const results = searchCampMeals(searchInput.value.trim());
            showMealSearchResults(results, resultsDiv, searchInput);
        }

        // Render selected meals as tags
        function renderSelectedMeals() {
            const container = document.getElementById('selectedMealsContainer');
            if (!container) return;
            
            if (window.__campSelectedMeals.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = window.__campSelectedMeals.map(meal => `
                <span class="selected-meal-tag">
                    ${meal.name}
                    <span class="remove-meal" onclick="removeMealSelection('${meal.id}')">&times;</span>
                </span>
            `).join('');
        }

        // Remove a meal from selection
        function removeMealSelection(mealId) {
            window.__campSelectedMeals = window.__campSelectedMeals.filter(m => m.id !== mealId);
            renderSelectedMeals();
        }

        // Initialize meal search functionality
        function initializeMealSearch() {
            const searchInput = document.getElementById('mealSearchInput');
            const resultsDiv = document.getElementById('mealSearchResults');
            
            if (!searchInput || !resultsDiv || searchInput.__mealSearchInit) return;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                const results = searchCampMeals(query);
                showMealSearchResults(results, resultsDiv, searchInput);
            });

            searchInput.addEventListener('focus', () => {
                // Show all available meals on focus
                const results = searchCampMeals('');
                showMealSearchResults(results, resultsDiv, searchInput);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
            
            searchInput.__mealSearchInit = true;
        }

        // Get selected meal types from the form (for saving)
        function getSelectedMealTypes() {
            return window.__campSelectedMeals.map(meal => ({
                id: meal.id,
                name: meal.name,
                price: meal.price || 0,
                currency: meal.currency || ''
            }));
        }

        // Toggle edit meal plan section
        function toggleEditMealPlanSection() {
            const enableMealPlan = document.getElementById('editEnableMealPlan');
            const mealPlanSection = document.getElementById('editMealPlanSection');
            if (mealPlanSection) {
                mealPlanSection.style.display = enableMealPlan.checked ? 'block' : 'none';
            }
            // Auto-fill meal dates from check-in/check-out if empty
            if (enableMealPlan.checked) {
                const ci = document.getElementById('editCheckInDate')?.value;
                const co = document.getElementById('editCheckOutDate')?.value;
                const mealStart = document.getElementById('editMealStartDate');
                const mealEnd = document.getElementById('editMealEndDate');
                if (ci && !mealStart.value) mealStart.value = ci;
                if (co && !mealEnd.value) mealEnd.value = co;
            }
        }

        // Load meal types for edit modal
        async function loadMealTypesForEdit(selectedMealIds = []) {
            const container = document.getElementById('editMealTypesGrid');
            if (!container) return;

            try {
                container.innerHTML = '<p style="color:#9ca3af;font-size:0.8rem;">Loading meal types...</p>';

                if (!window.authManager || !window.authManager.currentUser) {
                    container.innerHTML = '<p style="color:#9ca3af;font-size:0.8rem;">Authentication required</p>';
                    return;
                }

                const companyId = window.authManager.currentUser.companyId;
                const ref = window.authManager.db.ref(`companies/${companyId}/catering/mealTypes`);
                const snap = await ref.once('value');
                const data = snap.val() || {};
                const entries = Object.entries(data).filter(([id, mt]) => mt.active !== false);

                window.__campEditMealTypesCache = entries;

                if (entries.length === 0) {
                    container.innerHTML = '<p style="color:#9ca3af;font-size:0.8rem;">No meal types configured.</p>';
                    return;
                }

                container.innerHTML = entries.map(([id, mt]) => {
                    const price = mt.price ? `${mt.currency || ''} ${mt.price}`.trim() : '';
                    const isSelected = selectedMealIds.includes(id);
                    return `
                        <label class="meal-type-checkbox ${isSelected ? 'selected' : ''}" data-meal-id="${id}">
                            <input type="checkbox" name="editMealTypes" value="${id}" ${isSelected ? 'checked' : ''} onchange="updateMealTypeSelection(this)">
                            <div class="meal-info">
                                <div class="meal-name">${mt.name || id}</div>
                                ${price ? `<div class="meal-price">${price}/day</div>` : ''}
                            </div>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading meal types for edit:', error);
                container.innerHTML = '<p style="color:#ef4444;font-size:0.8rem;">Failed to load meal types</p>';
            }
        }

        // Get selected meal types from edit form
        function getEditSelectedMealTypes() {
            const checkboxes = document.querySelectorAll('#editMealTypesGrid input[name="editMealTypes"]:checked');
            const selectedMeals = [];
            checkboxes.forEach(cb => {
                const id = cb.value;
                const cached = window.__campEditMealTypesCache?.find(([mealId]) => mealId === id);
                if (cached) {
                    const [mealId, mt] = cached;
                    selectedMeals.push({
                        id: mealId,
                        name: mt.name,
                        price: mt.price || 0,
                        currency: mt.currency || ''
                    });
                }
            });
            return selectedMeals;
        }

        // Legacy function - now calls loadEmployeesForSearch
        async function loadEmployeesIntoSelect() {
            await loadEmployeesForSearch();
        }

        // Load company options into the assignment modal dropdown
        async function loadCompaniesIntoAssignmentSelect() {
            const companySelect = document.getElementById('assignmentCompanySelect');
            if (!companySelect || !window.authManager) return;

            try {
                companySelect.innerHTML = '<option value="">Loading companies...</option>';
                companySelect.disabled = true;

                const currentCompanyId = window.authManager?.currentUser?.companyId;
                if (!currentCompanyId) {
                    throw new Error('Company context not available');
                }

                const db = window.authManager.db;

                // Build options: Main company + all subcontractors (company scope)
                const options = [];
                // Main company
                try {
                    const companySnap = await db.ref(`companies/${currentCompanyId}`).once('value');
                    const companyData = companySnap.val() || {};
                    const label = companyData.companyName || companyData.name || 'Main Company';
                    options.push({ id: currentCompanyId, name: label });
                } catch (e) {
                    console.warn('Main company load failed:', e);
                    options.push({ id: currentCompanyId, name: 'Main Company' });
                }

                // Subcontractors list from company management scope
                try {
                    const subsSnap = await db.ref(`companies/${currentCompanyId}/subcontractors`).once('value');
                    if (subsSnap.exists()) {
                        const subs = subsSnap.val() || {};
                        Object.entries(subs).forEach(([key, sc]) => {
                            if (!sc) return;
                            const id = sc.id || sc.uid || key;
                            const name = sc.name || sc.companyName || 'Subcontractor';
                            if (id && name) options.push({ id, name });
                        });
                    }
                } catch (e) {
                    console.warn('Subcontractors load failed:', e);
                }

                // Fallback: include fieldOptions/company if present (avoid duplicates)
                try {
                    const optionsRef = db.ref(`companies/${currentCompanyId}/fieldOptions/company`);
                    const snap = await optionsRef.once('value');
                    if (snap.exists()) {
                        snap.forEach(child => {
                            const id = child.key;
                            const val = child.val() || {};
                            const label = val.label || val.name || val.value || id;
                            if (id && !options.some(o => o.id === id)) {
                                options.push({ id, name: label });
                            }
                        });
                    }
                } catch (e) {
                    // non-fatal
                }

                // Render options and default-select main company
                if (!options.length) {
                    options.push({ id: currentCompanyId, name: 'Current Company' });
                }

                companySelect.innerHTML = options.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
                companySelect.value = currentCompanyId;
                companySelect.disabled = false;
                console.log(`? Company dropdown populated (company scope: ${options.length} option${options.length===1?'':'s'})`);
            } catch (error) {
                console.error('Error loading companies into dropdown:', error);
                // Best-effort fallback to current company id
                const currentCompanyId = window.authManager?.currentUser?.companyId || '';
                companySelect.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = currentCompanyId;
                opt.textContent = currentCompanyId ? 'Current Company' : 'Select Company';
                companySelect.appendChild(opt);
                companySelect.disabled = false;
            }
        }

        // Load available rooms into assignment modal dropdown
    async function loadRoomsIntoSelect() {
            const roomSelect = document.getElementById('roomSelect');
            if (!roomSelect || !window.authManager) return;
            
            try {
                // Show loading state on the search input
                let roomSearchInput = document.getElementById('roomSearchInput');
                if (roomSearchInput) {
                    roomSearchInput.placeholder = 'Loading rooms...';
                    roomSearchInput.disabled = true;
                }
                roomSelect.value = '';

                const companyId = window.authManager.currentUser.companyId;
        // Determine currently selected desired period (for availability filtering)
        const ciEl = document.getElementById('checkInDate');
        const coEl = document.getElementById('checkOutDate');
        const selStart = ciEl ? (ciEl.value || '') : '';
        const selEnd = coEl ? (coEl.value || '') : '';
        const unavailableRoomsSet = await getRoomsUnavailableInRange(companyId, selStart, selEnd);
                
                // Load per-user allowed location blocks for visibility filtering
                const { set: allowedLocations, configured } = await getAllowedLocationsForCurrentUser();
                // Hide Location field if not configured or empty
                const locationEl = document.getElementById('locationSelect');
                const locationGroup = locationEl ? locationEl.closest('.form-group') : null;
                if (!configured || (allowedLocations && allowedLocations.size === 0)) {
                    if (locationGroup) locationGroup.style.display = 'none';
                    // Block rooms entirely when not configured per requirements
                    if (roomSearchInput) {
                        roomSearchInput.placeholder = 'No rooms available';
                        roomSearchInput.disabled = true;
                    }
                    roomSelect.value = '';
                    window.__camp_availableRooms = [];
                    return;
                } else if (locationGroup) {
                    locationGroup.style.display = '';
                }

                let allRooms = [];

                // Primary source: company scope rooms at companies/-OYL6cpeH7JnNLPBhCTH/rooms
                try {
                    const scopeCompanyId = '-OYL6cpeH7JnNLPBhCTH';
                    const scopeSnap = await window.authManager.db.ref(`companies/${scopeCompanyId}/rooms`).once('value');
                    if (scopeSnap.exists()) {
                        const data = scopeSnap.val();
                        allRooms = Object.values(data)
                            .filter(r => {
                                const block = r && r.location && r.location.block;
                                return block ? allowedLocations.has(block) : false;
                            })
                            .map(r => {
                                const code = r.code || r.roomNumber || r.id || '';
                                const name = r.name ? `  ${r.name}` : '';
                                const type = r.type ? ` (${r.type})` : '';
                                return { value: code, label: `${code}${name}${type}`.trim(), location: r.location || {} };
                            }).filter(r => r.value);
                    }
                } catch (e) {
                    console.warn('Rooms load (company scope /rooms) failed:', e);
                }

                // Fallback: rooms saved from campset.html under campData/rooms
                if (!allRooms.length) {
                    try {
                        const roomsSnap = await window.authManager.db.ref(`companies/${companyId}/campData/rooms`).once('value');
                        if (roomsSnap.exists()) {
                            const roomsData = roomsSnap.val();
                            allRooms = Object.values(roomsData)
                                .filter(r => {
                                    const block = r && r.location && r.location.block;
                                    return block ? allowedLocations.has(block) : false;
                                })
                                .map(r => {
                                const code = r.code || r.id || '';
                                const name = r.name ? `  ${r.name}` : '';
                                const type = r.type ? ` (${r.type})` : '';
                                return { value: code, label: `${code}${name}${type}`.trim(), location: r.location || {} };
                            }).filter(r => r.value);
                        }
                    } catch (e) {
                        console.warn('Rooms load (campData/rooms) failed:', e);
                    }
                }

                // Fallback to legacy companies/{companyId}/rooms if present
                if (!allRooms.length) {
                    try {
                        const fallbackSnap = await window.authManager.db.ref(`companies/${companyId}/rooms`).once('value');
                        if (fallbackSnap.exists()) {
                            const data = fallbackSnap.val();
                            allRooms = Object.values(data)
                                .filter(r => {
                                    const block = r && r.location && r.location.block;
                                    return block ? allowedLocations.has(block) : false;
                                })
                                .map(r => {
                                const code = r.code || r.roomNumber || r.id || '';
                                const name = r.name ? `  ${r.name}` : '';
                                const type = r.type ? ` (${r.type})` : '';
                                return { value: code, label: `${code}${name}${type}`.trim(), location: r.location || {} };
                            }).filter(r => r.value);
                        }
                    } catch (e) {
                        console.warn('Rooms load (companies/{id}/rooms) failed:', e);
                    }
                }

                // Fallback to shared configuration path used by campset.html
                if (!allRooms.length) {
                    try {
                        const sharedConfigCompanyId = '-OYL6cpeH7JnNLPBhCTH';
                        const sharedSnap = await window.authManager.db.ref(`companies/${sharedConfigCompanyId}/campData/rooms`).once('value');
                        if (sharedSnap.exists()) {
                            const roomsData = sharedSnap.val();
                            allRooms = Object.values(roomsData)
                                .filter(r => {
                                    const block = r && r.location && r.location.block;
                                    return block ? allowedLocations.has(block) : false;
                                })
                                .map(r => {
                                const code = r.code || r.id || '';
                                const name = r.name ? `  ${r.name}` : '';
                                const type = r.type ? ` (${r.type})` : '';
                                return { value: code, label: `${code}${name}${type}`.trim(), location: r.location || {} };
                            }).filter(r => r.value);
                        }
                    } catch (e) {
                        console.warn('Rooms load (shared campData/rooms) failed:', e);
                    }
                }

                // Final fallback to static examples if nothing found
                if (!allRooms.length) {
                    allRooms = [
                        { value: 'A-101', label: 'A-101', location: { block: 'A' } },
                        { value: 'A-102', label: 'A-102', location: { block: 'A' } },
                        { value: 'A-103', label: 'A-103', location: { block: 'A' } },
                        { value: 'B-201', label: 'B-201', location: { block: 'B' } },
                        { value: 'B-202', label: 'B-202', location: { block: 'B' } },
                        { value: 'B-203', label: 'B-203', location: { block: 'B' } },
                        { value: 'C-301', label: 'C-301', location: { block: 'C' } },
                        { value: 'C-302', label: 'C-302', location: { block: 'C' } }
                    ];
                }

                // Populate dropdown excluding rooms unavailable for the selected period and cache for search
                const availableRooms = allRooms.filter(r => !unavailableRoomsSet.has(String(r.value)));
                window.__camp_availableRooms = availableRooms;
                
                // Clear the room search input and hidden value, and enable input
                // Re-fetch element reference to ensure we have the current one
                roomSearchInput = document.getElementById('roomSearchInput');
                if (roomSearchInput) {
                    roomSearchInput.value = '';
                    roomSearchInput.placeholder = `Search room... (${availableRooms.length} available)`;
                    roomSearchInput.disabled = false;
                }
                roomSelect.value = '';
                
                console.log(' Room search loaded with available rooms');

                // Populate Location dropdown with unique blocks
                const locationSelect = document.getElementById('locationSelect');
                if (locationSelect) {
                    const uniqueBlocks = [...new Set(availableRooms.map(r => (r.location && r.location.block) || null).filter(Boolean))].sort();
                    const prev = locationSelect.value;
                    locationSelect.innerHTML = '<option value="">All Locations</option>';
                    uniqueBlocks.forEach(block => {
                        const opt = document.createElement('option');
                        opt.value = block;
                        opt.textContent = block;
                        locationSelect.appendChild(opt);
                    });
                    if (prev && [...locationSelect.options].some(o => o.value === prev)) {
                        locationSelect.value = prev;
                    }
                    if (!locationSelect.__wired) {
                        locationSelect.addEventListener('change', () => {
                            // Clear room selection when location changes
                            const roomSearchInput = document.getElementById('roomSearchInput');
                            const roomHiddenInput = document.getElementById('roomSelect');
                            if (roomSearchInput) roomSearchInput.value = '';
                            if (roomHiddenInput) roomHiddenInput.value = '';
                            updateLocationRoomCount();
                        });
                        locationSelect.__wired = true;
                    }
                    // Initialize room count next to Location
                    updateLocationRoomCount();
                }
                
            } catch (error) {
                console.error('Error loading rooms:', error);
                const roomSearchInput = document.getElementById('roomSearchInput');
                if (roomSearchInput) {
                    roomSearchInput.placeholder = 'Error loading rooms';
                }
            }
        }

        // ---- Employee select: show a tick box next to each name ----
        function updateEmployeeSelectTicks() {
            const sel = document.getElementById('assignmentEmployeeSelect');
            if (!sel) return;
            const selectedIdx = sel.selectedIndex;
            [...sel.options].forEach((opt, idx) => {
                const isPlaceholder = !opt.value;
                const base = opt.dataset && opt.dataset.label
                    ? opt.dataset.label
                    : (opt.textContent || '').replace(/^([??]\s+)/, '');
                if (isPlaceholder) {
                    opt.textContent = base || 'Select Employee';
                } else {
                    opt.textContent = `${idx === selectedIdx ? '?' : '?'} ${base}`.trim();
                }
            });
        }
        function wireEmployeeTickBehavior() {
            const sel = document.getElementById('assignmentEmployeeSelect');
            if (!sel || sel.__tickWired) return;
            sel.addEventListener('change', (e) => {
                handleEmployeeSelectChange();
            });
            sel.addEventListener('input', (e) => {
                handleEmployeeSelectChange();
            });
            sel.__tickWired = true;
        }

        // Maintain a small state for selected employees (max 2)
        window.__assignmentSelectedEmployees = window.__assignmentSelectedEmployees || [];

        function handleEmployeeSelectChange() {
            const sel = document.getElementById('assignmentEmployeeSelect');
            if (!sel) return;
            const id = sel.value;
            if (!id) {
                updateEmployeeSelectTicks();
                renderSelectedEmployees();
                return;
            }
            const label = sel.options[sel.selectedIndex]?.dataset?.label || sel.options[sel.selectedIndex]?.textContent?.replace(/^([??]\s+)/, '') || '';

            // If already selected, remove it (toggle behavior)
            const existingIdx = window.__assignmentSelectedEmployees.findIndex(e => e.id === id);
            if (existingIdx !== -1) {
                window.__assignmentSelectedEmployees.splice(existingIdx, 1);
            } else {
                // Enforce max of 2
                if (window.__assignmentSelectedEmployees.length >= 2) {
                    showNotification('You can select up to two employees for one room.', 'warning');
                } else {
                    window.__assignmentSelectedEmployees.push({ id, label });
                }
            }
            // Reset select to placeholder to avoid a persistent single-select highlight
            sel.selectedIndex = 0;
            updateEmployeeSelectTicks();
            renderSelectedEmployees();
        }

        function renderSelectedEmployees() {
            const container = document.getElementById('assignmentSelectedNames');
            const hidden = document.getElementById('assignmentSelectedEmployeeIds');
            const sel = document.getElementById('assignmentEmployeeSelect');
            if (!container || !hidden || !sel) return;
            const selected = window.__assignmentSelectedEmployees || [];
            hidden.value = selected.map(e => e.id).join(',');
            if (!selected.length) {
                container.textContent = '';
            } else if (selected.length === 1) {
                container.textContent = `Selected: ${selected[0].label}`;
            } else {
                container.textContent = `Selected: ${selected[0].label}, ${selected[1].label}`;
            }

            // Update tick visuals on the options
            const ids = new Set(selected.map(e => e.id));
            [...sel.options].forEach((opt, idx) => {
                const isPlaceholder = !opt.value;
                const base = opt.dataset && opt.dataset.label ? opt.dataset.label : (opt.textContent || '').replace(/^([??]\s+)/, '');
                if (isPlaceholder) {
                    opt.textContent = base || 'Select Employee';
                } else {
                    const checked = ids.has(opt.value);
                    opt.textContent = `${checked ? '?' : '?'} ${base}`.trim();
                }
            });
        }

        // Load employees into check-in modal dropdown
        async function loadEmployeesIntoCheckInSelect() {
            const employeeSelect = document.getElementById('checkInEmployee');
            if (!employeeSelect || !window.authManager) return;
            
            try {
                // Show loading state
                employeeSelect.innerHTML = '<option value="">Loading employees...</option>';
                employeeSelect.disabled = true;
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // Load assignments that are assigned but not checked in
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const assignmentsSnapshot = await assignmentsRef.orderByChild('status').equalTo('assigned').once('value');
                
                // Clear dropdown
                employeeSelect.innerHTML = '<option value="">Select Employee</option>';
                
                if (assignmentsSnapshot.exists()) {
                    const assignments = assignmentsSnapshot.val();
                    Object.values(assignments).forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.employeeId;
                        option.textContent = `${assignment.employeeName} - Room ${assignment.roomNumber}`;
                        option.title = `${assignment.employeeName} assigned to room ${assignment.roomNumber}`;
                        employeeSelect.appendChild(option);
                    });
                }
                
                employeeSelect.disabled = false;
                console.log('? Check-in employee dropdown populated with assigned employees');
                
            } catch (error) {
                console.error('Error loading employees into check-in dropdown:', error);
                employeeSelect.innerHTML = '<option value="">Error loading employees</option>';
                employeeSelect.disabled = false;
            }
        }

        // Load checked-in employees into check-out modal dropdown
        async function loadCheckedInEmployeesIntoSelect() {
            const employeeSelect = document.getElementById('checkOutEmployee');
            if (!employeeSelect || !window.authManager) return;
            
            try {
                // Show loading state
                employeeSelect.innerHTML = '<option value="">Loading checked-in employees...</option>';
                employeeSelect.disabled = true;
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // Load assignments that are checked-in
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const assignmentsSnapshot = await assignmentsRef.orderByChild('status').equalTo('checked_in').once('value');
                
                // Clear dropdown
                employeeSelect.innerHTML = '<option value="">Select Employee</option>';
                
                if (assignmentsSnapshot.exists()) {
                    const assignments = assignmentsSnapshot.val();
                    const checkedInEmployees = [];
                    
                    for (const [assignmentId, assignment] of Object.entries(assignments)) {
                        checkedInEmployees.push({
                            id: assignment.employeeId,
                            name: assignment.employeeName,
                            roomNumber: assignment.roomNumber,
                            checkInDate: assignment.actualCheckInDate
                        });
                    }
                    
                    // Sort by name
                    checkedInEmployees.sort((a, b) => a.name.localeCompare(b.name));
                    
                    checkedInEmployees.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.name} (Room ${employee.roomNumber})`;
                        option.title = `${employee.name} - Room ${employee.roomNumber} - Checked in: ${new Date(employee.checkInDate).toLocaleDateString()}`;
                        employeeSelect.appendChild(option);
                    });
                    
                    console.log('? Check-out employee dropdown populated with', checkedInEmployees.length, 'checked-in employees');
                } else {
                    console.log('No checked-in employees found');
                }
                
                employeeSelect.disabled = false;
                
            } catch (error) {
                console.error('Error loading checked-in employees:', error);
                employeeSelect.innerHTML = '<option value="">Error loading employees</option>';
                employeeSelect.disabled = false;
            }
        }

        // Refresh all dropdowns to reflect current availability
        async function refreshDropdowns() {
            try {
                // Refresh assignment modal dropdowns if open
                const assignmentModal = document.getElementById('assignmentModal');
                if (assignmentModal && assignmentModal.classList.contains('show')) {
                    await Promise.all([
                        loadEmployeesIntoSelect(),
                        loadRoomsIntoSelect()
                    ]);
                }
                
                // Refresh check-in modal dropdown if open
                const checkInModal = document.getElementById('checkInModal');
                if (checkInModal && checkInModal.classList.contains('show')) {
                    await loadEmployeesIntoCheckInSelect();
                }
                
                // Refresh check-out modal dropdown if open
                const checkOutModal = document.getElementById('checkOutModal');
                if (checkOutModal && checkOutModal.classList.contains('show')) {
                    await loadCheckedInEmployeesIntoSelect();
                }
                
                console.log('? Dropdowns refreshed');
            } catch (error) {
                console.error('Error refreshing dropdowns:', error);
            }
        }

        // Action Functions
        
        // Check if employee has any active room assignments
        async function checkExistingAssignment(employeeId, companyId) {
            try {
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.orderByChild('employeeId').equalTo(employeeId).once('value');
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    
                    // Check for active assignments (assigned or checked_in status)
                    for (const [assignmentId, assignment] of Object.entries(assignments)) {
                        if (assignment.status === 'assigned' || assignment.status === 'checked_in') {
                            return {
                                hasActiveAssignment: true,
                                assignment: assignment,
                                assignmentId: assignmentId
                            };
                        }
                    }
                }
                
                return { hasActiveAssignment: false };
            } catch (error) {
                console.error('Error checking existing assignments:', error);
                throw error;
            }
        }

        // Check if room is already assigned to another employee
        async function checkRoomAvailability(roomNumber, companyId) {
            try {
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.orderByChild('roomNumber').equalTo(roomNumber).once('value');
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    
                    // Check for active assignments (assigned or checked_in status)
                    for (const [assignmentId, assignment] of Object.entries(assignments)) {
                        if (assignment.status === 'assigned' || assignment.status === 'checked_in') {
                            return {
                                isOccupied: true,
                                assignment: assignment,
                                assignmentId: assignmentId
                            };
                        }
                    }
                }
                
                return { isOccupied: false };
            } catch (error) {
                console.error('Error checking room availability:', error);
                throw error;
            }
        }

        async function saveAssignment() {
            // Check permission before saving assignment
            if (!canCampAction('assign')) {
                showNotification('You do not have permission to create assignments', 'warning');
                return;
            }
            const form = document.getElementById('assignmentForm');
            const formData = new FormData(form);
            const assignmentData = Object.fromEntries(formData);
            
            // Also directly get the room value from hidden input as fallback
            const roomHiddenInput = document.getElementById('roomSelect');
            if (roomHiddenInput && roomHiddenInput.value && !assignmentData.room) {
                assignmentData.room = roomHiddenInput.value;
            }
            
            console.log('Saving assignment:', assignmentData);
            console.log('Room hidden input value:', roomHiddenInput ? roomHiddenInput.value : 'not found');
            
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    throw new Error('Authentication required');
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }

                // Selected company metadata (for reporting)
                const companySel = document.getElementById('assignmentCompanySelect');
                const selectedCompanyId = (assignmentData.assignmentCompanyId || '').trim() || companyId;
                const selectedCompanyName = companySel ? (companySel.options[companySel.selectedIndex]?.text || '') : '';

                // Get the employee ID from the search input
                const employeeIdFromSearch = (assignmentData.employeeId || '').trim();
                let selectedIds = [];
                
                if (employeeIdFromSearch) {
                    selectedIds = [employeeIdFromSearch];
                }
                
                if (!selectedIds.length) {
                    throw new Error('Please select an employee');
                }
                
                // Validate room selection
                if (!assignmentData.room || !assignmentData.room.trim()) {
                    throw new Error('Please select a room');
                }
                
                // Check if employee already has an active assignment
                for (const eid of selectedIds) {
                    const existingCheck = await checkExistingAssignment(eid, companyId);
                    if (existingCheck.hasActiveAssignment) {
                        const existingAssignment = existingCheck.assignment;
                        const statusText = existingAssignment.status === 'assigned' ? 'assigned to' : 'checked into';
                        throw new Error(`Employee is already ${statusText} room ${existingAssignment.roomNumber}. Please unassign or check out the employee from the current room before assigning a new room.`);
                    }
                }
                
                // Check if room is available for the selected period (period-aware overlap validation)
                const selStart = assignmentData.checkInDate;
                const selEnd = assignmentData.checkOutDate;
                if (!selStart || !selEnd) {
                    throw new Error('Please select both check-in and check-out dates');
                }
                try {
                    const startTs = new Date(selStart).getTime();
                    const endTs = new Date(selEnd).getTime();
                    if (!isFinite(startTs) || !isFinite(endTs)) {
                        throw new Error('Invalid date range');
                    }
                    const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                    const snap = await ref.orderByChild('roomNumber').equalTo(assignmentData.room).once('value');
                    let overlapCount = 0;
                    if (snap.exists()) {
                        for (const a of Object.values(snap.val() || {})) {
                            if (!a || a.status === 'cancelled') continue;
                            const prevStartStr = a.actualCheckInDate || a.checkInDate;
                            const prevEndStr = a.actualCheckOutDate || a.checkOutDate;
                            const prevStart = prevStartStr ? new Date(prevStartStr).getTime() : null;
                            const prevEnd = prevEndStr ? new Date(prevEndStr).getTime() : Number.POSITIVE_INFINITY;
                            if (!prevStart || !isFinite(prevStart)) continue;
                            const overlaps = prevStart <= endTs && startTs <= prevEnd;
                            if (overlaps) overlapCount += 1;
                        }
                    }
                    const cap = await getEffectiveRoomCapacity(assignmentData.room);
                    // When saving multiple employees at once, ensure the combined selection won't exceed capacity
                    const neededSlots = Array.from(new Set(selectedIds)).length; // unique selected
                    if (overlapCount + neededSlots > cap) {
                        const available = Math.max(0, cap - overlapCount);
                        if (available === 0) {
                            throw new Error(`Room ${assignmentData.room} has reached its capacity for the selected period (capacity: ${cap}). Please select another room or adjust dates.`);
                        } else {
                            throw new Error(`Only ${available} slot(s) left in room ${assignmentData.room} for the selected period (capacity: ${cap}). Reduce the number of selected employees or pick another room.`);
                        }
                    }
                } catch (e) {
                    if (e && e.message && e.message.includes('not available for the selected period')) throw e;
                    // If error comes from invalid dates, rethrow; else log and continue
                    if (e && e.message === 'Invalid date range') throw e;
                    console.warn('Period-aware room availability check encountered an issue:', e);
                }
                
                // Save assignments for each selected employee
                let savedCount = 0;
                for (const eid of selectedIds) {
                    // Get employee details
                    const employeeRef = window.authManager.db.ref(`users/${eid}`);
                    const employeeSnapshot = await employeeRef.once('value');
                    const employeeData = employeeSnapshot.val() || {};
                    const employeeName = employeeData.displayName || `${employeeData.firstName || ''} ${employeeData.lastName || ''}`.trim() || employeeData.name || 'Unknown';
                    const employeeEmail = employeeData.email || '';
                    const employeeIdNumber = employeeData.employeeId || ''; // Actual staff ID from company management

                    // datetime-local values already include date and time
                    const checkInDateTime = assignmentData.checkInDate;
                    const checkOutDateTime = assignmentData.checkOutDate;
                    
                    // Extract time parts for storage
                    const checkInTimePart = checkInDateTime.includes('T') ? checkInDateTime.split('T')[1]?.substring(0,5) : '14:00';
                    const checkOutTimePart = checkOutDateTime.includes('T') ? checkOutDateTime.split('T')[1]?.substring(0,5) : '12:00';

                    const assignment = {
                        id: `assignment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        employeeId: eid,
                        employeeIdNumber, // Staff ID number
                        employeeName,
                        employeeEmail,
                        roomNumber: assignmentData.room,
                        checkInDate: checkInDateTime,
                        checkOutDate: checkOutDateTime,
                        checkInTime: checkInTimePart,
                        checkOutTime: checkOutTimePart,
                        status: 'assigned',
                        assignedDate: new Date().toISOString(),
                        assignedBy: window.authManager.currentUser.uid,
                        companyId: companyId,
                        forCompanyId: selectedCompanyId,
                        forCompanyName: selectedCompanyName,
                        actualCheckInDate: null,
                        actualCheckOutDate: null,
                        notes: assignmentData.notes || ''
                    };
                    
                    // Add meal plan if enabled
                    const enableMealPlan = document.getElementById('enableMealPlan');
                    if (enableMealPlan && enableMealPlan.checked) {
                        const selectedMeals = getSelectedMealTypes();
                        const mealStartDate = document.getElementById('mealStartDate')?.value || '';
                        const mealEndDate = document.getElementById('mealEndDate')?.value || '';
                        const mealNotes = document.getElementById('mealNotes')?.value || '';
                        
                        if (selectedMeals.length > 0) {
                            assignment.mealPlan = {
                                enabled: true,
                                mealTypes: selectedMeals,
                                startDate: mealStartDate || assignmentData.checkInDate,
                                endDate: mealEndDate || assignmentData.checkOutDate,
                                notes: mealNotes,
                                createdAt: new Date().toISOString()
                            };
                        }
                    }
                    
                    const assignmentRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignment.id}`);
                    await assignmentRef.set(assignment);
                    await assignmentRef.set(assignment);
                    savedCount += 1;
                    console.log('? Assignment saved successfully:', assignment.id);
                }
                
                // Show success message
                showNotification('Room assignment saved successfully!', 'success');
                
                closeModal('assignmentModal');
                form.reset();
                await refreshTable();
                await refreshDropdowns(); // Refresh dropdowns to update availability
                
            } catch (error) {
                console.error('? Error saving assignment:', error);
                showNotification('Error saving assignment: ' + error.message, 'error');
            }
        }

        async function processCheckIn() {
            const form = document.getElementById('checkInForm');
            const formData = new FormData(form);
            const checkInData = Object.fromEntries(formData);
            
            console.log('Processing check-in:', checkInData);
            
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    throw new Error('Authentication required');
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // Find existing assignment or create new one
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const assignmentsSnapshot = await assignmentsRef.orderByChild('employeeId').equalTo(checkInData.employee).once('value');
                
                let assignmentId = null;
                let assignmentData = null;
                
                if (assignmentsSnapshot.exists()) {
                    // Find active assignment
                    const assignments = assignmentsSnapshot.val();
                    for (const [id, assignment] of Object.entries(assignments)) {
                        if (assignment.status === 'assigned' || assignment.status === 'checked_in') {
                            assignmentId = id;
                            assignmentData = assignment;
                            break;
                        }
                    }
                }
                
                if (!assignmentId) {
                    // Create new assignment if none exists (fallback)
                    assignmentId = `assignment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    assignmentData = {
                        id: assignmentId,
                        employeeId: checkInData.employee,
                        employeeName: 'Unknown',
                        employeeEmail: '',
                        roomNumber: 'TBD', // Room to be determined
                        status: 'checked_in',
                        assignedDate: new Date().toISOString(),
                        assignedBy: window.authManager.currentUser.uid,
                        companyId: companyId
                    };
                }

                // Prevent overlapping check-ins for the same employee in different rooms (includes archives)
                try {
                    const targetRoom = assignmentData.roomNumber || '';
                    const newStart = new Date(checkInData.checkInDate).getTime();
                    // Use planned checkOutDate if available; otherwise assume open-ended
                    const newEnd = assignmentData.checkOutDate ? new Date(assignmentData.checkOutDate).getTime() : Number.POSITIVE_INFINITY;

                    // Reuse the snapshot if we already loaded, otherwise fetch
                    let allAssignments = {};
                    if (assignmentsSnapshot && assignmentsSnapshot.exists()) {
                        allAssignments = assignmentsSnapshot.val();
                    } else {
                        const snap = await assignmentsRef.orderByChild('employeeId').equalTo(checkInData.employee).once('value');
                        allAssignments = snap.exists() ? snap.val() : {};
                    }

                    let conflict = null;
                    for (const [id, a] of Object.entries(allAssignments)) {
                        // Skip the same assignment (we're updating it)
                        if (id === assignmentId) continue;
                        const prevStartStr = a.actualCheckInDate || a.checkInDate;
                        if (!prevStartStr) continue;
                        const prevStart = new Date(prevStartStr).getTime();
                        const prevEndStr = a.actualCheckOutDate || a.checkOutDate;
                        const prevEnd = prevEndStr ? new Date(prevEndStr).getTime() : Number.POSITIVE_INFINITY;
                        // Intervals overlap?
                        const overlaps = prevStart <= newEnd && newStart <= prevEnd;
                        if (!overlaps) continue;
                        const prevRoom = (a.roomNumber || '').toString();
                        const sameRoom = prevRoom === (targetRoom || '').toString();
                        if (!sameRoom) {
                            conflict = { id, room: prevRoom, start: prevStartStr, end: prevEndStr };
                            break;
                        }
                    }

                    if (conflict) {
                        const periodText = `${new Date(conflict.start).toLocaleDateString()}${conflict.end ? ' ? ' + new Date(conflict.end).toLocaleDateString() : ''}`;
                        throw new Error(`This employee already has an accommodation in room ${conflict.room || '-'} during ${periodText}. Check-in to a different room for the same period is not allowed.`);
                    }
                } catch (overlapErr) {
                    console.warn('Overlap validation blocked check-in:', overlapErr);
                    showNotification(overlapErr.message || 'This employee already has an overlapping stay in a different room.', 'error');
                    return; // Stop processing check-in
                }
                
                // Update assignment with check-in details
                const updatedAssignment = {
                    ...assignmentData,
                    status: 'checked_in',
                    actualCheckInDate: checkInData.checkInDate,
                    checkInNotes: checkInData.notes || '',
                    checkedInBy: window.authManager.currentUser.uid,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to Firebase
                const assignmentRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                await assignmentRef.set(updatedAssignment);
                
                console.log('? Check-in processed successfully:', assignmentId);
                // Track action in activity log
                try {
                    await logCampAction('check_in', {
                        assignmentId,
                        employeeId: updatedAssignment.employeeId,
                        employeeName: updatedAssignment.employeeName || assignmentData.employeeName || '',
                        roomNumber: updatedAssignment.roomNumber || assignmentData.roomNumber || '',
                        actualCheckInDate: updatedAssignment.actualCheckInDate,
                        notes: updatedAssignment.checkInNotes || '',
                        forCompanyId: updatedAssignment.forCompanyId || '',
                        forCompanyName: updatedAssignment.forCompanyName || ''
                    });
                } catch (e) {
                    console.warn('?? Failed to log check-in action:', e);
                }
                
                // Show success message
                showNotification(`${assignmentData.employeeName || 'Employee'} checked in successfully!`, 'success');
                
                closeModal('checkInModal');
                form.reset();
                await refreshTable();
                // Update archives view as well (in case it is visible)
                try { await loadArchivesData(); } catch(_){}
                await refreshDropdowns(); // Refresh dropdowns to update availability
                
            } catch (error) {
                console.error('? Error processing check-in:', error);
                showNotification('Error processing check-in: ' + error.message, 'error');
            }
        }

        async function processCheckOut() {
            const form = document.getElementById('checkOutForm');
            const formData = new FormData(form);
            const checkOutData = Object.fromEntries(formData);
            
            console.log('Processing check-out:', checkOutData);
            
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    throw new Error('Authentication required');
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // Find active assignment for the employee
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const assignmentsSnapshot = await assignmentsRef.orderByChild('employeeId').equalTo(checkOutData.employee).once('value');
                
                let assignmentId = null;
                let assignmentData = null;
                
                if (assignmentsSnapshot.exists()) {
                    const assignments = assignmentsSnapshot.val();
                    for (const [id, assignment] of Object.entries(assignments)) {
                        if (assignment.status === 'checked_in' || assignment.status === 'assigned') {
                            assignmentId = id;
                            assignmentData = assignment;
                            break;
                        }
                    }
                }
                
                if (!assignmentId) {
                    throw new Error('No active assignment found for this employee');
                }
                
                // Update assignment with check-out details
                const updatedAssignment = {
                    ...assignmentData,
                    status: 'checked_out',
                    actualCheckOutDate: checkOutData.checkOutDate,
                    roomCondition: checkOutData.condition,
                    checkOutNotes: checkOutData.notes || '',
                    checkedOutBy: window.authManager.currentUser.uid,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to Firebase
                const assignmentRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                await assignmentRef.set(updatedAssignment);
                
                console.log('? Check-out processed successfully:', assignmentId);
                // Track action in activity log
                try {
                    await logCampAction('check_out', {
                        assignmentId,
                        employeeId: updatedAssignment.employeeId,
                        employeeName: updatedAssignment.employeeName || assignmentData.employeeName || '',
                        roomNumber: updatedAssignment.roomNumber || assignmentData.roomNumber || '',
                        actualCheckOutDate: updatedAssignment.actualCheckOutDate,
                        roomCondition: updatedAssignment.roomCondition || '',
                        notes: updatedAssignment.checkOutNotes || '',
                        forCompanyId: updatedAssignment.forCompanyId || '',
                        forCompanyName: updatedAssignment.forCompanyName || ''
                    });
                } catch (e) {
                    console.warn('?? Failed to log check-out action:', e);
                }
                
                // Show success message
                showNotification(`${assignmentData.employeeName || 'Employee'} checked out successfully!`, 'success');
                
                closeModal('checkOutModal');
                form.reset();
                await refreshTable();
                // Ensure archives tab shows this checked-out record immediately
                try { await loadArchivesData(); } catch(_){}
                await refreshDropdowns(); // Refresh dropdowns to update availability
                
            } catch (error) {
                console.error('? Error processing check-out:', error);
                showNotification('Error processing check-out: ' + error.message, 'error');
            }
        }

        function assignRoom(roomNumber) {
            document.getElementById('roomSelect').value = roomNumber;
            openAssignmentModal();
        }

        // Open Assignment Details Modal
        async function openAssignmentDetails(assignmentId) {
            try {
                if (!window.authManager || !window.authManager.currentUser) return;
                const companyId = window.authManager.currentUser.companyId;
                const uid = window.authManager.currentUser.uid;
                
                // Fetch assignment data
                const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                const snap = await ref.once('value');
                if (!snap.exists()) {
                    showNotification('Assignment not found', 'error');
                    return;
                }
                const assignment = snap.val();
                
                // Get location display
                const location = await getRoomLocationDisplay(assignment.roomNumber);
                
                // Format dates
                const checkInDate = assignment.actualCheckInDate 
                    ? new Date(assignment.actualCheckInDate).toLocaleDateString() 
                    : (assignment.checkInDate ? new Date(assignment.checkInDate).toLocaleDateString() + ' (scheduled)' : '-');
                const checkOutDate = assignment.actualCheckOutDate 
                    ? new Date(assignment.actualCheckOutDate).toLocaleDateString() 
                    : (assignment.checkOutDate ? new Date(assignment.checkOutDate).toLocaleDateString() + ' (expected)' : '-');
                
                // Calculate period
                let period = '-';
                if (assignment.actualCheckInDate && assignment.actualCheckOutDate) {
                    const days = Math.ceil((new Date(assignment.actualCheckOutDate) - new Date(assignment.actualCheckInDate)) / (1000 * 60 * 60 * 24));
                    period = `${days} day${days !== 1 ? 's' : ''}`;
                } else if (assignment.checkInDate && assignment.checkOutDate) {
                    const days = Math.ceil((new Date(assignment.checkOutDate) - new Date(assignment.checkInDate)) / (1000 * 60 * 60 * 24));
                    period = `${days} day${days !== 1 ? 's' : ''} (planned)`;
                }
                
                // Status badge
                const statusBadges = {
                    'assigned': '<span class="badge badge-info">Assigned</span>',
                    'checked_in': '<span class="badge badge-success">Checked In</span>',
                    'checked_out': '<span class="badge badge-secondary">Checked Out</span>',
                    'cancelled': '<span class="badge badge-danger">Cancelled</span>'
                };
                const statusBadge = statusBadges[assignment.status] || '<span class="badge badge-warning">Unknown</span>';
                
                // Build details HTML
                const detailsBody = document.getElementById('assignmentDetailsBody');
                detailsBody.innerHTML = `
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Employee</div>
                        <div class="assignment-detail-value">${assignment.employeeName || '-'}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Email</div>
                        <div class="assignment-detail-value">${assignment.employeeEmail || '-'}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Room</div>
                        <div class="assignment-detail-value">${assignment.roomNumber || '-'}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Location</div>
                        <div class="assignment-detail-value">${location}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Check-in</div>
                        <div class="assignment-detail-value">${checkInDate}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Check-out</div>
                        <div class="assignment-detail-value">${checkOutDate}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Period</div>
                        <div class="assignment-detail-value">${period}</div>
                    </div>
                    <div class="assignment-detail-row">
                        <div class="assignment-detail-label">Status</div>
                        <div class="assignment-detail-value">${statusBadge}</div>
                    </div>
                    ${assignment.notes ? `<div class="assignment-detail-row">
                        <div class="assignment-detail-label">Notes</div>
                        <div class="assignment-detail-value">${assignment.notes}</div>
                    </div>` : ''}
                    ${assignment.companyName ? `<div class="assignment-detail-row">
                        <div class="assignment-detail-label">Company</div>
                        <div class="assignment-detail-value">${assignment.companyName}</div>
                    </div>` : ''}
                    ${assignment.mealPlan && assignment.mealPlan.enabled ? `
                    <div class="assignment-detail-row" style="flex-direction:column; align-items:flex-start;">
                        <div class="assignment-detail-label" style="margin-bottom:8px;"><i class="fas fa-utensils"></i> Meal Plan</div>
                        <div class="assignment-detail-value" style="width:100%;">
                            <div style="background:#f8f9fa; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
                                ${assignment.mealPlan.mealTypes && assignment.mealPlan.mealTypes.length > 0 ? `
                                <div style="margin-bottom:8px;"><strong>Meal Types:</strong></div>
                                <ul style="margin:0 0 10px 0; padding-left:20px;">
                                    ${assignment.mealPlan.mealTypes.map(m => `<li>${m.name} - ${m.price} ${m.currency || 'USD'}</li>`).join('')}
                                </ul>` : ''}
                                ${assignment.mealPlan.startDate || assignment.mealPlan.endDate ? `
                                <div style="margin-bottom:5px;"><strong>Meal Period:</strong> ${assignment.mealPlan.startDate || '-'} to ${assignment.mealPlan.endDate || '-'}</div>` : ''}
                                ${assignment.mealPlan.notes ? `<div><strong>Meal Notes:</strong> ${assignment.mealPlan.notes}</div>` : ''}
                            </div>
                        </div>
                    </div>` : ''}
                `;
                
                // Use cached action permissions
                const actionPerms = getCampActionPerms();
                
                // Build action buttons
                const detailsFooter = document.getElementById('assignmentDetailsFooter');
                let buttonsHtml = '<div class="assignment-details-actions">';
                
                // Invoice button (permission controlled)
                if (actionPerms.invoice) {
                    buttonsHtml += `<button class="btn btn-info" onclick="generateAssignmentInvoice('${assignmentId}')" title="Invoice"><i class="fas fa-file-invoice"></i></button>`;
                }
                
                if (actionPerms.edit) {
                    buttonsHtml += `<button class="btn btn-primary" onclick="closeModal('assignmentDetailsModal'); editAssignment('${assignment.id}')" title="Edit"><i class="fas fa-edit"></i></button>`;
                }
                
                if (assignment.status === 'assigned' && actionPerms.checkin) {
                    buttonsHtml += `<button class="btn btn-success" onclick="closeModal('assignmentDetailsModal'); quickCheckIn('${assignment.employeeId}')" title="Check In"><i class="fas fa-sign-in-alt"></i></button>`;
                    buttonsHtml += `<button class="btn btn-info" onclick="closeModal('assignmentDetailsModal'); openBackdatedCheckIn('${assignment.employeeId}')" title="Backdate Check-In"><i class="fas fa-clock"></i></button>`;
                }
                
                if (assignment.status === 'checked_in' && actionPerms.checkout) {
                    buttonsHtml += `<button class="btn btn-warning" onclick="closeModal('assignmentDetailsModal'); quickCheckOut('${assignment.employeeId}')" title="Check Out"><i class="fas fa-sign-out-alt"></i></button>`;
                    buttonsHtml += `<button class="btn btn-secondary" onclick="closeModal('assignmentDetailsModal'); openBackdatedCheckOut('${assignment.employeeId}')" title="Backdate Check-Out"><i class="fas fa-clock"></i></button>`;
                }
                
                if (actionPerms.delete) {
                    buttonsHtml += `<button class="btn btn-danger" onclick="closeModal('assignmentDetailsModal'); confirmDeleteAssignment('${assignment.id}')" title="Delete"><i class="fas fa-trash"></i></button>`;
                }
                
                buttonsHtml += '</div>';
                detailsFooter.innerHTML = buttonsHtml;
                
                // Open modal
                document.getElementById('assignmentDetailsModal').classList.add('show');
                
            } catch (error) {
                console.error('Error opening assignment details:', error);
                showNotification('Failed to load assignment details', 'error');
            }
        }

        // Open Edit modal with data for the given assignment
        async function editAssignment(assignmentId) {
            try {
                // Check permission before opening edit modal
                if (!canCampAction('edit')) {
                    showNotification('You do not have permission to edit assignments', 'warning');
                    return;
                }
                if (!window.authManager || !window.authManager.currentUser) return;
                const companyId = window.authManager.currentUser.companyId;
                const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                const snap = await ref.once('value');
                if (!snap.exists()) {
                    showNotification('Assignment not found', 'error');
                    return;
                }
                const a = snap.val();
                // Prefill form values
                document.getElementById('editAssignmentId').value = assignmentId;
                document.getElementById('editEmployeeName').value = a.employeeName || '';
                document.getElementById('editPeriodType').value = a.periodType || 'rotation';
                
                // Set datetime-local values (format: YYYY-MM-DDTHH:MM)
                if (a.checkInDate) {
                    const ciDate = a.checkInDate.split('T')[0] || a.checkInDate;
                    const ciTime = a.checkInTime || (a.checkInDate.includes('T') ? a.checkInDate.split('T')[1]?.substring(0,5) : '14:00') || '14:00';
                    document.getElementById('editCheckInDate').value = `${ciDate}T${ciTime}`;
                }
                if (a.checkOutDate) {
                    const coDate = a.checkOutDate.split('T')[0] || a.checkOutDate;
                    const coTime = a.checkOutTime || (a.checkOutDate.includes('T') ? a.checkOutDate.split('T')[1]?.substring(0,5) : '12:00') || '12:00';
                    document.getElementById('editCheckOutDate').value = `${coDate}T${coTime}`;
                }
                document.getElementById('editNotes').value = a.notes || '';

                // Load rooms for edit with visibility and current room allowance
                await loadRoomsIntoEditSelect(a.roomNumber);

                // Try to set initial location selection according to the current room's block
                try {
                    const idx = await getRoomsIndex();
                    const meta = idx[String(a.roomNumber)] || null;
                    const block = meta && meta.location ? meta.location.block : '';
                    const locSel = document.getElementById('editLocationSelect');
                    if (locSel && block && [...locSel.options].some(o => o.value === block)) {
                        locSel.value = block;
                        filterEditRoomOptions();
                    }
                } catch (_) {}

                // Preselect room
                const roomSel = document.getElementById('editRoomSelect');
                if (roomSel && a.roomNumber && [...roomSel.options].some(o => o.value === a.roomNumber)) {
                    roomSel.value = a.roomNumber;
                }

                // Load meal plan data
                const enableMealPlan = document.getElementById('editEnableMealPlan');
                const mealPlanSection = document.getElementById('editMealPlanSection');
                if (a.mealPlan && a.mealPlan.enabled) {
                    enableMealPlan.checked = true;
                    mealPlanSection.style.display = 'block';
                    // Load meal types with pre-selected values
                    const selectedIds = (a.mealPlan.mealTypes || []).map(m => m.id);
                    await loadMealTypesForEdit(selectedIds);
                    // Set dates and notes
                    document.getElementById('editMealStartDate').value = a.mealPlan.startDate || '';
                    document.getElementById('editMealEndDate').value = a.mealPlan.endDate || '';
                    document.getElementById('editMealNotes').value = a.mealPlan.notes || '';
                } else {
                    enableMealPlan.checked = false;
                    mealPlanSection.style.display = 'none';
                    document.getElementById('editMealTypesGrid').innerHTML = '';
                    document.getElementById('editMealStartDate').value = '';
                    document.getElementById('editMealEndDate').value = '';
                    document.getElementById('editMealNotes').value = '';
                    // Still load meal types in case user enables it
                    await loadMealTypesForEdit([]);
                }

                document.getElementById('editAssignmentModal').classList.add('show');
            } catch (e) {
                console.error('editAssignment error:', e);
                showNotification('Failed to open edit modal', 'error');
            }
        }

        // Load rooms into Edit modal select with visibility and current room inclusion
        async function loadRoomsIntoEditSelect(currentRoomNumber) {
            const roomSelect = document.getElementById('editRoomSelect');
            if (!roomSelect || !window.authManager) return;
            try {
                roomSelect.innerHTML = '<option value="">Loading rooms...</option>';
                roomSelect.disabled = true;
                const companyId = window.authManager.currentUser.companyId;
                const occupiedRooms = await getOccupiedRooms(companyId);
                const { set: allowedLocations, configured } = await getAllowedLocationsForCurrentUser();

                // Hide Location field if not configured or empty
                const locationEl = document.getElementById('editLocationSelect');
                const locationGroup = locationEl ? locationEl.closest('.form-group') : null;
                if (!configured || (allowedLocations && allowedLocations.size === 0)) {
                    if (locationGroup) locationGroup.style.display = 'none';
                    roomSelect.innerHTML = '<option value="">No rooms available</option>';
                    roomSelect.disabled = true;
                    window.__camp_edit_availableRooms = [];
                    return;
                } else if (locationGroup) {
                    locationGroup.style.display = '';
                }

                // Helper to normalize a room object -> { value, label, location }
                const mapRoom = (r) => {
                    const code = r.code || r.roomNumber || r.id || '';
                    const name = r.name ? `  ${r.name}` : '';
                    const type = r.type ? ` (${r.type})` : '';
                    return { value: code, label: `${code}${name}${type}`.trim(), location: r.location || {} };
                };

                // Load rooms from sources similar to assignment modal
                let allRooms = [];
                try {
                    const snap = await window.authManager.db.ref(`companies/${companyId}/campData/rooms`).once('value');
                    if (snap.exists()) {
                        allRooms = Object.values(snap.val())
                            .filter(r => {
                                const block = r && r.location && r.location.block;
                                return block ? allowedLocations.has(block) : false;
                            })
                            .map(mapRoom).filter(r => r.value);
                    }
                } catch (_) {}

                if (!allRooms.length) {
                    try {
                        const snap = await window.authManager.db.ref(`companies/${companyId}/rooms`).once('value');
                        if (snap.exists()) {
                            allRooms = Object.values(snap.val())
                                .filter(r => {
                                    const block = r && r.location && r.location.block;
                                    return block ? allowedLocations.has(block) : false;
                                })
                                .map(mapRoom).filter(r => r.value);
                        }
                    } catch (_) {}
                }

                if (!allRooms.length) {
                    try {
                        const sharedConfigCompanyId = '-OYL6cpeH7JnNLPBhCTH';
                        const snap = await window.authManager.db.ref(`companies/${sharedConfigCompanyId}/campData/rooms`).once('value');
                        if (snap.exists()) {
                            allRooms = Object.values(snap.val())
                                .filter(r => {
                                    const block = r && r.location && r.location.block;
                                    return block ? allowedLocations.has(block) : false;
                                })
                                .map(mapRoom).filter(r => r.value);
                        }
                    } catch (_) {}
                }

                // Include current room even if occupied, so user can keep it or switch
                const availableRooms = allRooms.filter(r => !occupiedRooms.includes(r.value) || r.value === currentRoomNumber);
                window.__camp_edit_availableRooms = availableRooms;

                // Populate room select
                roomSelect.innerHTML = '<option value="">Select Room</option>';
                availableRooms.forEach(room => {
                    const opt = document.createElement('option');
                    opt.value = room.value;
                    opt.textContent = room.label || room.value;
                    roomSelect.appendChild(opt);
                });

                // Populate location select
                const locationSelect = document.getElementById('editLocationSelect');
                if (locationSelect) {
                    const uniqueBlocks = [...new Set(availableRooms.map(r => (r.location && r.location.block) || null).filter(Boolean))].sort();
                    const prev = locationSelect.value;
                    locationSelect.innerHTML = '<option value="">All Locations</option>';
                    uniqueBlocks.forEach(block => {
                        const opt = document.createElement('option');
                        opt.value = block;
                        opt.textContent = block;
                        locationSelect.appendChild(opt);
                    });
                    if (prev && [...locationSelect.options].some(o => o.value === prev)) {
                        locationSelect.value = prev;
                    }
                    if (!locationSelect.__wired) {
                        locationSelect.addEventListener('change', () => filterEditRoomOptions());
                        locationSelect.__wired = true;
                    }
                }

                roomSelect.disabled = false;
            } catch (e) {
                console.error('loadRoomsIntoEditSelect error:', e);
                roomSelect.innerHTML = '<option value="">Error loading rooms</option>';
                roomSelect.disabled = false;
            }
        }

        // Filter edit-room options by text and selected block
        function filterEditRoomOptions() {
            const select = document.getElementById('editRoomSelect');
            const search = document.getElementById('editRoomSearch');
            const locationSelect = document.getElementById('editLocationSelect');
            if (!select || !search) return;
            const term = (search.value || '').toLowerCase();
            const selectedBlock = locationSelect ? (locationSelect.value || '') : '';
            const base = Array.isArray(window.__camp_edit_availableRooms) ? window.__camp_edit_availableRooms : [];
            const prev = select.value;
            select.innerHTML = '<option value="">Select Room</option>';
            base.filter(r => {
                const matchesText = !term || (r.label || r.value).toLowerCase().includes(term);
                const block = (r.location && r.location.block) || '';
                const matchesBlock = !selectedBlock || block === selectedBlock;
                return matchesText && matchesBlock;
            }).forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.value;
                opt.textContent = r.label || r.value;
                select.appendChild(opt);
            });
            if (prev && [...select.options].some(o => o.value === prev)) select.value = prev;
        }

        // Save updates to assignment
        async function updateAssignment() {
            try {
                // Check permission before updating assignment
                if (!canCampAction('edit')) {
                    showNotification('You do not have permission to edit assignments', 'warning');
                    return;
                }
                if (!window.authManager || !window.authManager.currentUser) return;
                const companyId = window.authManager.currentUser.companyId;
                const id = document.getElementById('editAssignmentId').value;
                
                // Get datetime-local values (already in YYYY-MM-DDTHH:MM format)
                const checkInDateTime = document.getElementById('editCheckInDate').value || null;
                const checkOutDateTime = document.getElementById('editCheckOutDate').value || null;
                
                // Extract time parts for storage
                const checkInTimeVal = checkInDateTime && checkInDateTime.includes('T') ? checkInDateTime.split('T')[1]?.substring(0,5) : '14:00';
                const checkOutTimeVal = checkOutDateTime && checkOutDateTime.includes('T') ? checkOutDateTime.split('T')[1]?.substring(0,5) : '12:00';
                
                const payload = {
                    roomNumber: document.getElementById('editRoomSelect').value || null,
                    checkInDate: checkInDateTime,
                    checkOutDate: checkOutDateTime,
                    checkInTime: checkInTimeVal,
                    checkOutTime: checkOutTimeVal,
                    periodType: document.getElementById('editPeriodType').value || 'rotation',
                    notes: document.getElementById('editNotes').value || '',
                    lastUpdated: new Date().toISOString(),
                    updatedBy: window.authManager.currentUser.uid
                };
                if (!payload.roomNumber) {
                    showNotification('Please select a room', 'error');
                    return;
                }

                // Handle meal plan data
                const enableMealPlan = document.getElementById('editEnableMealPlan');
                if (enableMealPlan && enableMealPlan.checked) {
                    const selectedMeals = getEditSelectedMealTypes();
                    payload.mealPlan = {
                        enabled: true,
                        mealTypes: selectedMeals,
                        startDate: document.getElementById('editMealStartDate').value || null,
                        endDate: document.getElementById('editMealEndDate').value || null,
                        notes: document.getElementById('editMealNotes').value || '',
                        updatedAt: new Date().toISOString()
                    };
                } else {
                    payload.mealPlan = { enabled: false };
                }

                await window.authManager.db.ref(`companies/${companyId}/roomAssignments/${id}`).update(payload);
                closeModal('editAssignmentModal');
                showNotification('Assignment updated', 'success');
                await loadRoomAssignmentsData();
            } catch (e) {
                console.error('updateAssignment error:', e);
                showNotification('Failed to update assignment', 'error');
            }
        }

        // Generate Assignment Invoice
        // Store current assignment ID for invoice generation
        let currentInvoiceAssignmentId = null;
        let currentInvoiceAssignment = null;
        
        async function generateAssignmentInvoice(assignmentId) {
            try {
                // Check permission before generating invoice
                if (!canCampAction('invoice')) {
                    showNotification('You do not have permission to generate invoices', 'warning');
                    return;
                }
                if (!window.authManager || !window.authManager.currentUser) return;
                const companyId = window.authManager.currentUser.companyId;
                
                // Fetch assignment data
                const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                const snap = await ref.once('value');
                if (!snap.exists()) {
                    showNotification('Assignment not found', 'error');
                    return;
                }
                const assignment = snap.val();
                assignment.id = assignmentId;
                
                // Store for later use
                currentInvoiceAssignmentId = assignmentId;
                currentInvoiceAssignment = assignment;
                
                // Determine date range based on assignment data
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Use actual check-in date if available, otherwise scheduled date
                const checkInDateStr = assignment.actualCheckInDate || assignment.checkInDate;
                let checkOutDateStr;
                if (assignment.status === 'checked_in') {
                    checkOutDateStr = todayStr;
                } else {
                    checkOutDateStr = assignment.actualCheckOutDate || assignment.checkOutDate;
                }
                
                // Set date inputs
                const startInput = document.getElementById('invoicePeriodStart');
                const endInput = document.getElementById('invoicePeriodEnd');
                
                if (checkInDateStr) {
                    startInput.value = checkInDateStr.split('T')[0];
                    startInput.min = checkInDateStr.split('T')[0];
                }
                if (checkOutDateStr) {
                    endInput.value = checkOutDateStr.split('T')[0];
                    endInput.max = checkOutDateStr.split('T')[0];
                }
                
                // Update info display
                updateInvoicePeriodInfo(assignment, checkInDateStr, checkOutDateStr);
                
                // Show the period selection modal
                document.getElementById('invoicePeriodModal').classList.add('show');
                
            } catch (error) {
                console.error('Error loading assignment for invoice:', error);
                showNotification('Failed to load assignment', 'error');
            }
        }
        
        function updateInvoicePeriodInfo(assignment, checkInDateStr, checkOutDateStr) {
            const infoDiv = document.getElementById('invoicePeriodInfo');
            const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
            const statusText = { assigned:'Scheduled', checked_in:'Checked In', checked_out:'Checked Out', cancelled:'Cancelled' }[assignment.status] || assignment.status;
            
            infoDiv.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div><strong>Employee:</strong> ${assignment.employeeName || '-'}</div>
                    <div><strong>Room:</strong> ${assignment.roomNumber || '-'}</div>
                    <div><strong>Actual Check-in:</strong> ${fmtDate(checkInDateStr)}</div>
                    <div><strong>Check-out:</strong> ${fmtDate(checkOutDateStr)}${assignment.status === 'checked_in' ? ' (Today)' : ''}</div>
                    <div><strong>Status:</strong> <span style="color:${assignment.status === 'checked_in' ? '#059669' : '#6b7280'};">${statusText}</span></div>
                </div>
            `;
        }
        
        async function generateInvoiceWithPeriod() {
            if (!currentInvoiceAssignmentId || !currentInvoiceAssignment) {
                showNotification('No assignment selected', 'error');
                return;
            }
            
            const periodStart = document.getElementById('invoicePeriodStart').value;
            const periodEnd = document.getElementById('invoicePeriodEnd').value;
            
            if (!periodStart || !periodEnd) {
                showNotification('Please select both start and end dates', 'error');
                return;
            }
            
            if (new Date(periodStart) > new Date(periodEnd)) {
                showNotification('Start date cannot be after end date', 'error');
                return;
            }
            
            // Close period modal
            closeModal('invoicePeriodModal');
            
            // Generate invoice with selected period
            await generateInvoiceForPeriod(currentInvoiceAssignmentId, currentInvoiceAssignment, periodStart, periodEnd);
        }
        
        async function generateInvoiceForPeriod(assignmentId, assignment, periodStart, periodEnd) {
            try {
                if (!window.authManager || !window.authManager.currentUser) return;
                const companyId = window.authManager.currentUser.companyId;
                
                // Get employee's actual ID (staff number) if not stored in assignment
                let displayEmployeeId = assignment.employeeIdNumber || '';
                if (!displayEmployeeId && assignment.employeeId) {
                    try {
                        const empRef = window.authManager.db.ref(`users/${assignment.employeeId}`);
                        const empSnap = await empRef.once('value');
                        const empData = empSnap.val() || {};
                        displayEmployeeId = empData.employeeId || '';
                    } catch(e) { console.warn('Failed to fetch employee ID:', e); }
                }
                
                // Get company info for header - use currentCompany for logo (same as accessboard.html)
                const companyName = window.authManager?.currentCompany?.companyName || window.authManager?.currentUser?.companyName || 'Company';
                const companyLogo = window.authManager?.currentCompany?.logo || window.authManager?.currentCompany?.logoUrl || '';
                const logoInitials = companyName.split(' ').filter(w=>w).map(w=>w[0]).join('').substring(0,2).toUpperCase() || 'CO';
                
                // Generate SVG initials if no logo available (same as AuthManager)
                const generateInitialsSVG = (initials) => {
                    const svg = `<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="8" fill="#f8fafc"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="32">${initials}</text></svg>`;
                    return 'data:image/svg+xml;base64,' + btoa(svg);
                };
                const logoSrc = companyLogo || generateInitialsSVG(logoInitials);
                
                // Get room info for daily rate
                let roomDailyRate = 0;
                let roomCurrency = 'USD';
                try {
                    const roomsRef = window.authManager.db.ref(`companies/${companyId}/rooms`);
                    const roomsSnap = await roomsRef.once('value');
                    const rooms = roomsSnap.val() || {};
                    for (const [id, room] of Object.entries(rooms)) {
                        if (room.roomNumber === assignment.roomNumber) {
                            roomDailyRate = parseFloat(room.dailyRate || room.price || 0);
                            roomCurrency = room.currency || 'USD';
                            break;
                        }
                    }
                } catch(e) { console.warn('Failed to get room rate:', e); }
                
                // Get location display
                const location = await getRoomLocationDisplay(assignment.roomNumber);
                
                // Use the selected period dates
                const periodStartDate = new Date(periodStart);
                const periodEndDate = new Date(periodEnd);
                
                // Calculate dates and duration based on selected period
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Scheduled period (original plan)
                const scheduledCheckIn = assignment.checkInDate ? new Date(assignment.checkInDate) : null;
                const scheduledCheckOut = assignment.checkOutDate ? new Date(assignment.checkOutDate) : null;
                let scheduledDays = 0;
                if (scheduledCheckIn && scheduledCheckOut) {
                    const diffTime = scheduledCheckOut.getTime() - scheduledCheckIn.getTime();
                    scheduledDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    if (scheduledDays < 1) scheduledDays = 1;
                }
                
                // Use selected period for the invoice
                const checkInDateStr = periodStart;
                const checkInDateObj = periodStartDate;
                const checkOutDateStr = periodEnd;
                const checkOutDateObj = periodEndDate;
                
                // Calculate stay days for selected period
                let stayDays = 0;
                let actualCompletedDays = 0;
                if (checkInDateObj && checkOutDateObj) {
                    const diffTime = checkOutDateObj.getTime() - checkInDateObj.getTime();
                    stayDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    if (stayDays < 1) stayDays = 1;
                    actualCompletedDays = stayDays;
                }
                
                // Calculate meal costs - calculate within selected period
                let mealItems = [];
                let mealTotal = 0;
                let mealDays = 0;
                if (assignment.mealPlan && assignment.mealPlan.enabled && assignment.mealPlan.mealTypes) {
                    // Determine meal period that overlaps with selected invoice period
                    const mealPlanStart = assignment.mealPlan.startDate ? new Date(assignment.mealPlan.startDate) : null;
                    const mealPlanEnd = assignment.mealPlan.endDate ? new Date(assignment.mealPlan.endDate) : null;
                    
                    // Calculate overlapping meal days within selected period
                    let mealStartInPeriod = mealPlanStart && mealPlanStart > periodStartDate ? mealPlanStart : periodStartDate;
                    let mealEndInPeriod = mealPlanEnd && mealPlanEnd < periodEndDate ? mealPlanEnd : periodEndDate;
                    
                    if (mealStartInPeriod <= mealEndInPeriod) {
                        mealDays = Math.ceil((mealEndInPeriod - mealStartInPeriod) / (1000 * 60 * 60 * 24)) + 1;
                        if (mealDays < 1) mealDays = 0;
                    }
                    
                    if (mealDays > 0) {
                        assignment.mealPlan.mealTypes.forEach(m => {
                            const dailyPrice = parseFloat(m.price || 0);
                            const totalPrice = dailyPrice * mealDays;
                            mealItems.push({
                                name: m.name,
                                dailyRate: dailyPrice,
                                days: mealDays,
                                total: totalPrice,
                                currency: m.currency || roomCurrency
                            });
                            mealTotal += totalPrice;
                        });
                    }
                }
                
                // Calculate totals - scheduled vs actual charged
                const scheduledAccommodationTotal = roomDailyRate * scheduledDays;
                const actualAccommodationTotal = roomDailyRate * actualCompletedDays;
                const scheduledGrandTotal = scheduledAccommodationTotal + mealTotal;
                const actualGrandTotal = actualAccommodationTotal + mealTotal;
                
                // Format dates
                const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
                const fmtShortDate = (d) => {
                    if (!d) return '-';
                    const date = new Date(d);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };
                const invoiceDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const invoiceNumber = `INV-${assignmentId.substring(0, 8).toUpperCase()}`;
                
                // Status badge
                const statusBadge = (s) => {
                    const cls = s || 'assigned';
                    const txt = { assigned:'Scheduled', checked_in:'Checked In', checked_out:'Checked Out', cancelled:'Cancelled' }[cls] || cls;
                    return `<span class="invoice-status-chip ${cls}">${txt}</span>`;
                };
                
                // Escape HTML
                const esc = (s) => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                
                // Build day-by-day combined rows (accommodation + meals for each day)
                let dayByDayRows = '';
                let rowNum = 1;
                const mealStartDate = assignment.mealPlan?.startDate ? new Date(assignment.mealPlan.startDate) : checkInDateObj;
                const hasMeals = assignment.mealPlan && assignment.mealPlan.enabled && assignment.mealPlan.mealTypes && mealDays > 0;
                const dailyMealTotal = hasMeals ? mealItems.reduce((sum, m) => sum + m.dailyRate, 0) : 0;
                const mealNames = hasMeals ? mealItems.map(m => m.name).join(', ') : '';
                
                if (checkInDateObj && actualCompletedDays > 0) {
                    let currentMonth = null;
                    let monthRoomTotal = 0;
                    let monthMealTotal = 0;
                    let monthDayCount = 0;
                    
                    for (let i = 0; i < actualCompletedDays; i++) {
                        const dayDate = new Date(checkInDateObj);
                        dayDate.setDate(dayDate.getDate() + i);
                        
                        const monthKey = dayDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                        
                        // Check if we're entering a new month
                        if (currentMonth !== null && currentMonth !== monthKey) {
                            // Add subtotal row for previous month
                            dayByDayRows += `
                                <tr style="background:#f5f5f5; font-weight:600;">
                                    <td colspan="2" class="text-right">${currentMonth} Subtotal (${monthDayCount} days)</td>
                                    <td class="text-center">${roomCurrency} ${monthRoomTotal.toFixed(2)}</td>
                                    <td class="text-center">${monthMealTotal > 0 ? roomCurrency + ' ' + monthMealTotal.toFixed(2) : '-'}</td>
                                    <td class="text-right"><strong>${roomCurrency} ${(monthRoomTotal + monthMealTotal).toFixed(2)}</strong></td>
                                </tr>
                            `;
                            // Reset month totals
                            monthRoomTotal = 0;
                            monthMealTotal = 0;
                            monthDayCount = 0;
                        }
                        
                        // Add month header if new month
                        if (currentMonth !== monthKey) {
                            currentMonth = monthKey;
                            dayByDayRows += `
                                <tr style="background:#e3f2fd;">
                                    <td colspan="5" style="font-weight:600; color:#1565c0;"><i class="fas fa-calendar-alt"></i> ${monthKey}</td>
                                </tr>
                            `;
                        }
                        
                        // Check if this day has meals
                        const dayHasMeals = hasMeals && mealStartDate && dayDate >= mealStartDate && i < mealDays;
                        const dayMealAmount = dayHasMeals ? dailyMealTotal : 0;
                        const dayTotal = roomDailyRate + dayMealAmount;
                        
                        // Accumulate month totals
                        monthRoomTotal += roomDailyRate;
                        monthMealTotal += dayMealAmount;
                        monthDayCount++;
                        
                        dayByDayRows += `
                            <tr>
                                <td>${rowNum++}</td>
                                <td>${fmtShortDate(dayDate)}</td>
                                <td class="text-center">${roomCurrency} ${roomDailyRate.toFixed(2)}</td>
                                <td class="text-center">${dayHasMeals ? roomCurrency + ' ' + dayMealAmount.toFixed(2) : '-'}</td>
                                <td class="text-right"><strong>${roomCurrency} ${dayTotal.toFixed(2)}</strong></td>
                            </tr>
                        `;
                    }
                    
                    // Add final month subtotal if there were any days
                    if (currentMonth !== null && monthDayCount > 0) {
                        dayByDayRows += `
                            <tr style="background:#f5f5f5; font-weight:600;">
                                <td colspan="2" class="text-right">${currentMonth} Subtotal (${monthDayCount} days)</td>
                                <td class="text-center">${roomCurrency} ${monthRoomTotal.toFixed(2)}</td>
                                <td class="text-center">${monthMealTotal > 0 ? roomCurrency + ' ' + monthMealTotal.toFixed(2) : '-'}</td>
                                <td class="text-right"><strong>${roomCurrency} ${(monthRoomTotal + monthMealTotal).toFixed(2)}</strong></td>
                            </tr>
                        `;
                    }
                }
                
                // Build invoice HTML - matching accessboard.html gate pass design
                const invoiceHtml = `
<div class="invoice-a4-sheet printable">
    <div class="invoice-a4-header">
        <div class="invoice-company-block">
            <img src="${logoSrc}" class="invoice-a4-logo" alt="Company Logo" onerror="this.src='${generateInitialsSVG(logoInitials)}';" />
            <div class="invoice-a4-company">
                <h1>${esc(companyName)}</h1>
                <h2 class="doc-title">Accommodation Invoice</h2>
            </div>
        </div>
    </div>
    
    <div class="invoice-a4-section">
        <div class="invoice-a4-section-title"><i class="fas fa-user-circle"></i><span class="section-text">Employee Information</span></div>
        <table class="invoice-a4-info-table" style="margin-top:8px;">
            <tbody>
                <tr>
                    <td style="width:50%;" colspan="2"><strong>Name:</strong> ${esc(assignment.employeeName||'-')}</td>
                    <td style="width:50%;" colspan="2"><strong>Employee ID:</strong> ${esc(displayEmployeeId||'-')}</td>
                </tr>
                <tr>
                    <td colspan="2"><strong>Email:</strong> ${esc(assignment.employeeEmail||'-')}</td>
                    <td colspan="2"><strong>Company:</strong> ${esc(assignment.forCompanyName||assignment.companyName||'-')}</td>
                </tr>
                <tr>
                    <td colspan="2"><strong>Invoice #:</strong> ${invoiceNumber}</td>
                    <td colspan="2"><strong>Invoice Date:</strong> ${invoiceDate}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="invoice-a4-section">
        <div class="invoice-a4-section-title"><i class="fas fa-bed"></i><span class="section-text">Accommodation Details</span></div>
        <table class="invoice-a4-info-table" style="margin-top:8px;">
            <tbody>
                <tr>
                    <td style="width:50%;" colspan="2"><strong>Room:</strong> ${esc(assignment.roomNumber||'-')}</td>
                    <td style="width:50%;" colspan="2"><strong>Location:</strong> ${esc(location)}</td>
                </tr>
                <tr>
                    <td colspan="2"><strong>Period Type:</strong> ${esc(assignment.periodType||'Standard')}</td>
                    <td colspan="2"><strong>Status:</strong> ${statusBadge(assignment.status)}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="invoice-a4-section">
        <div class="invoice-a4-section-title"><i class="fas fa-calendar-alt"></i><span class="section-text">Invoice Period (Selected)</span></div>
        <table class="invoice-a4-info-table" style="margin-top:8px;">
            <tbody>
                <tr>
                    <td style="width:50%;" colspan="2"><strong>From:</strong> ${fmtDate(checkInDateStr)}</td>
                    <td style="width:50%;" colspan="2"><strong>To:</strong> ${fmtDate(checkOutDateStr)}</td>
                </tr>
                <tr>
                    <td colspan="2"><strong>Duration:</strong> ${stayDays} day${stayDays !== 1 ? 's' : ''}</td>
                    <td colspan="2"><strong>Daily Rate:</strong> ${roomCurrency} ${roomDailyRate.toFixed(2)}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    ${assignment.mealPlan && assignment.mealPlan.enabled && mealDays > 0 ? `
    <div class="invoice-a4-section">
        <div class="invoice-a4-section-title"><i class="fas fa-utensils"></i><span class="section-text">Meal Plan (within selected period)</span></div>
        <table class="invoice-a4-info-table" style="margin-top:8px;">
            <tbody>
                <tr>
                    <td style="width:50%;" colspan="2"><strong>Original Meal Start:</strong> ${fmtDate(assignment.mealPlan.startDate)}</td>
                    <td style="width:50%;" colspan="2"><strong>Original Meal End:</strong> ${fmtDate(assignment.mealPlan.endDate)}</td>
                </tr>
                <tr>
                    <td colspan="2"><strong>Meal Days in Period:</strong> ${mealDays} day${mealDays !== 1 ? 's' : ''}</td>
                    <td colspan="2"><strong>Meal Types:</strong> ${assignment.mealPlan.mealTypes.map(m => esc(m.name)).join(', ')}</td>
                </tr>
            </tbody>
        </table>
    </div>
    ` : ''}
    
    <div class="invoice-a4-section">
        <div class="invoice-a4-section-title"><i class="fas fa-receipt"></i><span class="section-text">Charges Breakdown (Day by Day)</span></div>
        <table class="invoice-a4-info-table" style="margin-top:8px;font-size:0.75rem;">
            <thead>
                <tr>
                    <th style="width:30px;">#</th>
                    <th>Day</th>
                    <th class="text-center" style="width:90px;">Room</th>
                    <th class="text-center" style="width:90px;">Meals</th>
                    <th class="text-right" style="width:90px;">Total</th>
                </tr>
            </thead>
            <tbody>
                ${dayByDayRows}
                <tr style="background:#f5f5f5;font-weight:bold;">
                    <td colspan="2" class="text-right">Subtotals:</td>
                    <td class="text-center" style="background:#c8e6c9;">${roomCurrency} ${actualAccommodationTotal.toFixed(2)}</td>
                    <td class="text-center" style="background:#ffe0b2;">${mealTotal > 0 ? roomCurrency + ' ' + mealTotal.toFixed(2) : '-'}</td>
                    <td class="text-right"><strong>${roomCurrency} ${actualGrandTotal.toFixed(2)}</strong></td>
                </tr>
            </tbody>
        </table>
        ${hasMeals ? `<p style="font-size:0.7rem;color:#666;margin-top:6px;"><i class="fas fa-utensils"></i> Meals included: ${esc(mealNames)}</p>` : ''}
    </div>
    
    <div class="invoice-summary-section">
        <table class="invoice-summary-table">
            <tbody>
                <tr style="color:#6b7280;">
                    <td>Scheduled Period (${scheduledDays} days)</td>
                    <td class="text-right">${roomCurrency} ${scheduledAccommodationTotal.toFixed(2)}</td>
                </tr>
                <tr>
                    <td><strong>Accommodation (${actualCompletedDays} days @ ${roomCurrency} ${roomDailyRate.toFixed(2)}/day)</strong></td>
                    <td class="text-right"><strong>${roomCurrency} ${actualAccommodationTotal.toFixed(2)}</strong></td>
                </tr>
                ${mealTotal > 0 ? `
                <tr>
                    <td><strong>Meals (${mealDays} days @ ${roomCurrency} ${dailyMealTotal.toFixed(2)}/day)</strong></td>
                    <td class="text-right">${roomCurrency} ${mealTotal.toFixed(2)}</td>
                </tr>
                ` : ''}
                <tr class="total">
                    <td><strong>Grand Total</strong></td>
                    <td class="text-right"><strong>${roomCurrency} ${actualGrandTotal.toFixed(2)}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    ${assignment.notes || (assignment.mealPlan && assignment.mealPlan.notes) ? `
    <div class="invoice-a4-section">
        <div class="invoice-a4-section-title"><i class="fas fa-sticky-note"></i><span class="section-text">Notes</span></div>
        <div class="invoice-notes-box">
            ${assignment.notes ? `<p><strong>Assignment Notes:</strong> ${esc(assignment.notes)}</p>` : ''}
            ${assignment.mealPlan && assignment.mealPlan.notes ? `<p><strong>Meal Notes:</strong> ${esc(assignment.mealPlan.notes)}</p>` : ''}
        </div>
    </div>
    ` : ''}
    
    <div class="invoice-footer-note" style="margin-top:12px;padding-top:8px;border-top:1px solid #e5e7eb;text-align:center;font-size:.6rem;color:#9ca3af;">
        <p>This is a computer-generated invoice. Generated on ${invoiceDate}.</p>
    </div>
</div>
                `;
                
                document.getElementById('invoiceModalBody').innerHTML = invoiceHtml;
                document.getElementById('assignmentInvoiceModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error generating invoice:', error);
                showNotification('Failed to generate invoice', 'error');
            }
        }
        
        // Close invoice modal
        function closeInvoiceModal() {
            document.getElementById('assignmentInvoiceModal').classList.add('hidden');
        }
        
        // Print invoice
        function printInvoice() {
            window.print();
        }

        function extendStay(assignmentId) {
            console.log('Extending stay for assignment:', assignmentId);
            // Add extension logic here
        }

        async function quickCheckIn(employeeId) {
            try {
                // Check permission before quick check-in
                if (!canCampAction('checkin')) {
                    showNotification('You do not have permission to perform check-ins', 'warning');
                    return;
                }
                if (!window.authManager || !window.authManager.currentUser) {
                    throw new Error('Authentication required');
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // Find the assignment for this employee
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.orderByChild('employeeId').equalTo(employeeId).once('value');
                
                if (!snapshot.exists()) {
                    throw new Error('No assignment found for this employee');
                }
                
                const assignments = snapshot.val();
                let assignmentId = null;
                let assignmentData = null;
                
                // Find the active assignment (assigned status)
                for (const [id, assignment] of Object.entries(assignments)) {
                    if (assignment.status === 'assigned') {
                        assignmentId = id;
                        assignmentData = assignment;
                        break;
                    }
                }
                
                if (!assignmentId) {
                    throw new Error('No active assignment found for this employee');
                }

                // Overlap guard: prevent quick check-in if overlapping record exists in another room (including archives)
                try {
                    const targetRoom = assignmentData.roomNumber || '';
                    const newStart = Date.now();
                    const newEnd = assignmentData.checkOutDate ? new Date(assignmentData.checkOutDate).getTime() : Number.POSITIVE_INFINITY;
                    let conflict = null;
                    for (const [id, a] of Object.entries(assignments)) {
                        if (id === assignmentId) continue;
                        const prevStartStr = a.actualCheckInDate || a.checkInDate;
                        if (!prevStartStr) continue;
                        const prevStart = new Date(prevStartStr).getTime();
                        const prevEndStr = a.actualCheckOutDate || a.checkOutDate;
                        const prevEnd = prevEndStr ? new Date(prevEndStr).getTime() : Number.POSITIVE_INFINITY;
                        const overlaps = prevStart <= newEnd && newStart <= prevEnd;
                        if (!overlaps) continue;
                        const prevRoom = (a.roomNumber || '').toString();
                        const sameRoom = prevRoom === (targetRoom || '').toString();
                        if (!sameRoom) {
                            conflict = { id, room: prevRoom, start: prevStartStr, end: prevEndStr };
                            break;
                        }
                    }
                    if (conflict) {
                        const periodText = `${new Date(conflict.start).toLocaleDateString()}${conflict.end ? ' ? ' + new Date(conflict.end).toLocaleDateString() : ''}`;
                        throw new Error(`This employee already has an accommodation in room ${conflict.room || '-'} during ${periodText}. Quick check-in to a different room for the same period is not allowed.`);
                    }
                } catch (overlapErr) {
                    console.warn('Overlap validation blocked quick check-in:', overlapErr);
                    showNotification(overlapErr.message || 'This employee already has an overlapping stay in a different room.', 'error');
                    return; // Stop processing
                }
                
                // Update assignment status to checked_in
                const updatedAssignment = {
                    ...assignmentData,
                    status: 'checked_in',
                    actualCheckInDate: new Date().toISOString(),
                    checkedInBy: window.authManager.currentUser.uid,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to Firebase
                const assignmentRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                await assignmentRef.set(updatedAssignment);
                
                console.log('? Quick check-in processed successfully:', assignmentId);
                
                // Show success message
                showNotification(`${assignmentData.employeeName} checked in successfully!`, 'success');
                
                // Refresh table and dropdowns
                await refreshTable();
                await refreshDropdowns();
                
            } catch (error) {
                console.error('? Error processing quick check-in:', error);
                showNotification('Error processing check-in: ' + error.message, 'error');
            }
        }

        async function quickCheckOut(employeeId) {
            try {
                // Check permission before quick check-out
                if (!canCampAction('checkout')) {
                    showNotification('You do not have permission to perform check-outs', 'warning');
                    return;
                }
                if (!window.authManager || !window.authManager.currentUser) {
                    throw new Error('Authentication required');
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // Find the assignment for this employee
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.orderByChild('employeeId').equalTo(employeeId).once('value');
                
                if (!snapshot.exists()) {
                    throw new Error('No assignment found for this employee');
                }
                
                const assignments = snapshot.val();
                let assignmentId = null;
                let assignmentData = null;
                
                // Find the active assignment (checked_in status)
                for (const [id, assignment] of Object.entries(assignments)) {
                    if (assignment.status === 'checked_in') {
                        assignmentId = id;
                        assignmentData = assignment;
                        break;
                    }
                }
                
                if (!assignmentId) {
                    throw new Error('No checked-in assignment found for this employee');
                }
                
                // Update assignment status to checked_out
                const updatedAssignment = {
                    ...assignmentData,
                    status: 'checked_out',
                    actualCheckOutDate: new Date().toISOString(),
                    checkedOutBy: window.authManager.currentUser.uid,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to Firebase
                const assignmentRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
                await assignmentRef.set(updatedAssignment);
                
                console.log('? Quick check-out processed successfully:', assignmentId);
                
                // Show success message
                showNotification(`${assignmentData.employeeName} checked out successfully!`, 'success');
                
                // Refresh table and dropdowns
                await refreshTable();
                await refreshDropdowns();
                
            } catch (error) {
                console.error('? Error processing quick check-out:', error);
                showNotification('Error processing check-out: ' + error.message, 'error');
            }
        }

        // Open check-in modal for a specific employee, allowing backdated date selection
        async function openBackdatedCheckIn(employeeId) {
            try {
                // Open modal and populate dropdown
                await openCheckInModal();
                const select = document.getElementById('checkInEmployee');
                if (select) {
                    // If the employee is present in the list, preselect
                    if ([...select.options].some(o => o.value === String(employeeId))) {
                        select.value = String(employeeId);
                    }
                }
                // Prefill the date input to planned check-in date if available, else now-1 day at 08:00
                const input = document.getElementById('actualCheckInDate');
                if (input) {
                    let suggested = new Date();
                    try {
                        // Try to find this employee's assignment to use planned check-in
                        const companyId = window.authManager?.currentUser?.companyId;
                        if (companyId) {
                            const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                            const snap = await ref.orderByChild('employeeId').equalTo(employeeId).once('value');
                            if (snap.exists()) {
                                const items = snap.val();
                                for (const a of Object.values(items)) {
                                    if (a.status === 'assigned' || a.status === 'checked_in') {
                                        if (a.checkInDate) {
                                            suggested = new Date(a.checkInDate);
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    } catch (_e) {}
                    if (!isFinite(suggested.getTime())) suggested = new Date();
                    // If still today, default to yesterday 08:00 for convenience
                    const now = new Date();
                    if (suggested.toDateString() === now.toDateString()) {
                        suggested.setDate(suggested.getDate() - 1);
                        suggested.setHours(8, 0, 0, 0);
                    }
                    input.value = new Date(suggested.getTime() - (suggested.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
                    input.focus();
                }
            } catch (e) {
                console.error('openBackdatedCheckIn error:', e);
                showNotification('Could not open backdated check-in. Please try the Check-in button.', 'error');
            }
        }

        // Open check-out modal for a specific employee, allowing backdated date selection
        async function openBackdatedCheckOut(employeeId) {
            try {
                // Open modal and populate dropdown
                await openCheckOutModal();
                const select = document.getElementById('checkOutEmployee');
                if (select) {
                    // If the employee is present in the list, preselect
                    if ([...select.options].some(o => o.value === String(employeeId))) {
                        select.value = String(employeeId);
                    }
                }
                // Prefill the date input to now or planned checkout if available; if still blank, set yesterday 18:00
                const input = document.getElementById('actualCheckOutDate');
                if (input) {
                    let suggested = new Date();
                    try {
                        const companyId = window.authManager?.currentUser?.companyId;
                        if (companyId) {
                            const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                            const snap = await ref.orderByChild('employeeId').equalTo(employeeId).once('value');
                            if (snap.exists()) {
                                const items = snap.val();
                                for (const a of Object.values(items)) {
                                    if (a.status === 'checked_in' || a.status === 'assigned') {
                                        if (a.checkOutDate) {
                                            suggested = new Date(a.checkOutDate);
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    } catch (_e) {}
                    if (!isFinite(suggested.getTime())) suggested = new Date();
                    const now = new Date();
                    if (suggested < now) {
                        // Keep as is (already backdated)
                    } else {
                        // Default to yesterday evening 18:00
                        suggested = new Date();
                        suggested.setDate(suggested.getDate() - 1);
                        suggested.setHours(18, 0, 0, 0);
                    }
                    input.value = new Date(suggested.getTime() - (suggested.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
                    input.focus();
                }
            } catch (e) {
                console.error('openBackdatedCheckOut error:', e);
                showNotification('Could not open backdated check-out. Please try the Check-out button.', 'error');
            }
        }

        function checkOut(assignmentId) {
            console.log('Checking out assignment:', assignmentId);
            // Add checkout logic here
        }

        function markAvailable(roomNumber) {
            console.log('Marking room available:', roomNumber);
            // Add room status update logic here
            refreshTable();
        }

        // Archive action functions
        function viewAssignmentDetails(assignmentId) {
            console.log('Viewing assignment details:', assignmentId);
            // TODO: Implement assignment details modal
            showNotification('Assignment details feature coming soon!', 'info');
        }

        function generateAssignmentReport(assignmentId) {
            console.log('Generating report for assignment:', assignmentId);
            // TODO: Implement PDF report generation for individual assignment
            showNotification('Assignment report feature coming soon!', 'info');
        }

        // Confirm and delete assignment
        async function confirmDeleteAssignment(assignmentId) {
            try {
                // Check permission before deleting
                if (!canCampAction('delete')) {
                    showNotification('You do not have permission to delete assignments', 'warning');
                    return;
                }
                const ok = window.confirm('Are you sure you want to permanently delete this assignment? This action cannot be undone.');
                if (!ok) return;
                await deleteAssignment(assignmentId);
                showNotification('Assignment deleted successfully.', 'success');
                await refreshTable();
                await loadArchivesData();
                await refreshDropdowns();
            } catch (e) {
                console.error('Delete assignment failed:', e);
                showNotification('Failed to delete assignment: ' + (e.message || e), 'error');
            }
        }

        async function deleteAssignment(assignmentId) {
            if (!window.authManager || !window.authManager.currentUser) throw new Error('Authentication required');
            const companyId = window.authManager.currentUser.companyId;
            if (!companyId) throw new Error('Company ID not found');
            const ref = window.authManager.db.ref(`companies/${companyId}/roomAssignments/${assignmentId}`);
            await ref.remove();
        }

        async function refreshTable() {
            console.log('Refreshing assignments table...');
            await loadRoomAssignmentsData();
            // Activity logging helper for camp actions (check-in/check-out)
            async function logCampAction(actionType, payload) {
                try {
                    if (!window.authManager || !window.authManager.currentUser) return;
                    const actor = window.authManager.currentUser;
                    const companyId = actor.companyId;
                    if (!companyId) return;
                    const nowIso = new Date().toISOString();
                    const key = `act_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                    const record = {
                        id: key,
                        type: actionType, // 'check_in' | 'check_out'
                        timestamp: nowIso,
                        actorUid: actor.uid,
                        actorEmail: actor.email || '',
                        companyId,
                        ...payload
                    };
                    const db = window.authManager.db;
                    // Write to company-wide activity log
                    await db.ref(`companies/${companyId}/campActivityLog/${key}`).set(record);
                    // Also write to a per-employee recent activity list (trim to last 50)
                    if (payload && payload.employeeId) {
                        const byUserRef = db.ref(`companies/${companyId}/campRecentActivityByUser/${payload.employeeId}/${key}`);
                        await byUserRef.set(record);
                        // Optional trimming could be implemented via Cloud Functions or periodic cleanup
                    }
                } catch (e) {
                    console.warn('logCampAction failed:', e);
                }
            }
            await loadDashboardData();
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.add('active');
            
            // Handle tab button activation
            let tabButton = document.getElementById(tabName + 'Tab');
            if (!tabButton && tabName === 'reporting') {
                tabButton = document.getElementById('reportingTabBtn');
            }
            if (!tabButton && tabName === 'settings') {
                tabButton = document.getElementById('settingsTabBtn');
            }
            if (tabButton) {
                tabButton.classList.add('active');
            }
            // Load appropriate data
            if (tabName === 'active') {
                loadRoomAssignmentsData();
            } else if (tabName === 'archives') {
                loadArchivesData();
            } else if (tabName === 'analytics') {
                ensureCampAnalyticsBuilder();
                loadCampAnalyticsModels();
            } else if (tabName === 'reporting') {
                // Reporting tab - nothing to auto-load
            } else if (tabName === 'settings') {
                loadCampAccessControl();
            }
        }

        // =================== CAMP SETTINGS TAB LOGIC ===================
        let campAccessControlCache = { users: {}, perms: {} };
        let editingCampAccessControlUid = null;

        function toggleSettingsSection(header) {
            const section = header.closest('.settings-section');
            if (section) section.classList.toggle('collapsed');
        }

        async function loadCampAccessControl() {
            const user = window.authManager?.currentUser;
            if (!user || !user.companyId) return;

            try {
                const [usersSnap, permsSnap] = await Promise.all([
                    firebase.database().ref(`companies/${user.companyId}/users`).once('value'),
                    firebase.database().ref(`companies/${user.companyId}/campSettings/tabVisibility`).once('value')
                ]);
                campAccessControlCache.users = usersSnap.val() || {};
                campAccessControlCache.perms = permsSnap.val() || {};
                renderCampAccessControlTable(campAccessControlCache.users, campAccessControlCache.perms);
            } catch (error) {
                console.error('Error loading camp access control:', error);
            }
        }

        function renderCampAccessControlTable(users, perms) {
            const tbody = document.getElementById('campAccessControlTableBody');
            if (!tbody) return;

            const permUserIds = Object.keys(perms || {});

            if (permUserIds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;color:#9ca3af">No users configured. Click "Add User" to add access control.</td></tr>';
                return;
            }

            tbody.innerHTML = permUserIds.map(uid => {
                const u = users[uid] || {};
                const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                const email = (u.accountType === 'without-account' || u.reportingOnly === true) ? '-' : (u.email || '-');
                const jobTitle = u.jobTitle || u.position || '-';
                const p = perms[uid] || {};

                return `
                    <tr onclick="openCampAccessControlModal('${uid}')" style="cursor:pointer;" title="Click to edit">
                        <td>${escapeHtmlCamp(name)}</td>
                        <td>${escapeHtmlCamp(email)}</td>
                        <td>${escapeHtmlCamp(jobTitle)}</td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="archives" ${p.canSeeArchives ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="analytics" ${p.canSeeAnalytics ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="reporting" ${p.canSeeReporting ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="settings" ${p.canSeeSettings ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="batchActions" ${p.canSeeBatchActions ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="actionAdd" ${p.canActionAdd !== false ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="actionEdit" ${p.canActionEdit !== false ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="actionCheckin" ${p.canActionCheckin !== false ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="actionCheckout" ${p.canActionCheckout !== false ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="actionInvoice" ${p.canActionInvoice !== false ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="actionDelete" ${p.canActionDelete !== false ? 'checked' : ''} onchange="updateCampAccessPerm(this)"></td>
                        <td style="text-align:center" onclick="event.stopPropagation();"><button class="delete-btn" onclick="removeCampAccessUser('${uid}')" title="Remove user"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtmlCamp(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c] || c));
        }

        async function updateCampAccessPerm(checkbox) {
            const user = window.authManager?.currentUser;
            if (!user || !user.companyId) return;

            const uid = checkbox.dataset.uid;
            const perm = checkbox.dataset.perm;
            const update = {};

            if (perm === 'archives') update.canSeeArchives = checkbox.checked;
            if (perm === 'analytics') update.canSeeAnalytics = checkbox.checked;
            if (perm === 'reporting') update.canSeeReporting = checkbox.checked;
            if (perm === 'settings') update.canSeeSettings = checkbox.checked;
            if (perm === 'batchActions') update.canSeeBatchActions = checkbox.checked;
            if (perm === 'actionAdd') update.canActionAdd = checkbox.checked;
            if (perm === 'actionEdit') update.canActionEdit = checkbox.checked;
            if (perm === 'actionCheckin') update.canActionCheckin = checkbox.checked;
            if (perm === 'actionCheckout') update.canActionCheckout = checkbox.checked;
            if (perm === 'actionInvoice') update.canActionInvoice = checkbox.checked;
            if (perm === 'actionDelete') update.canActionDelete = checkbox.checked;

            try {
                await firebase.database().ref(`companies/${user.companyId}/campSettings/tabVisibility/${uid}`).update(update);
                
                // Update local cache
                if (!campAccessControlCache.perms[uid]) campAccessControlCache.perms[uid] = {};
                Object.assign(campAccessControlCache.perms[uid], update);
                
                // Apply changes immediately if it's the current user
                if (uid === user.id || uid === user.uid) {
                    applyCampTabVisibility();
                }

                showNotification('Access updated', 'success');
            } catch (error) {
                console.error('Failed to update access:', error);
                showNotification('Failed to update access', 'error');
                checkbox.checked = !checkbox.checked;
            }
        }

        async function removeCampAccessUser(uid) {
            if (!confirm('Remove this user from access control?')) return;

            const user = window.authManager?.currentUser;
            if (!user || !user.companyId) return;

            try {
                await firebase.database().ref(`companies/${user.companyId}/campSettings/tabVisibility/${uid}`).remove();
                loadCampAccessControl();
                showNotification('User removed from access control', 'success');
            } catch (error) {
                console.error('Failed to remove user:', error);
                showNotification('Failed to remove user', 'error');
            }
        }

        function openCampAccessControlModal(editUid = null) {
            editingCampAccessControlUid = editUid;
            
            const modal = document.getElementById('campAccessControlModal');
            const input = document.getElementById('campAcUserInput');
            const hidden = document.getElementById('campAcUserId');
            const dropdown = document.getElementById('campAcUserDropdown');
            const modalTitle = document.getElementById('campAcModalTitle');
            const saveBtn = document.getElementById('campAcSaveBtn');
            const userSelectGroup = document.getElementById('campAcUserSelectGroup');
            const userDisplayGroup = document.getElementById('campAcUserDisplayGroup');
            const userDisplay = document.getElementById('campAcUserDisplay');

            if (input) input.value = '';
            if (hidden) hidden.value = '';
            if (dropdown) dropdown.innerHTML = '';

            const { users, perms } = campAccessControlCache;
            
            if (editUid) {
                // Edit mode
                const u = users[editUid] || {};
                const p = perms[editUid] || {};
                const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                const email = u.email || '';
                const jobTitle = u.jobTitle || u.position || '';

                modalTitle.textContent = 'Edit User Access';
                saveBtn.textContent = 'Save';
                userSelectGroup.style.display = 'none';
                userDisplayGroup.style.display = 'block';
                userDisplay.innerHTML = `<strong>${escapeHtmlCamp(name)}</strong>${email ? `<br><span style="color:#6b7280;font-size:.8rem;">${escapeHtmlCamp(email)}</span>` : ''}${jobTitle ? `<br><span style="color:#6b7280;font-size:.75rem;">${escapeHtmlCamp(jobTitle)}</span>` : ''}`;
                hidden.value = editUid;

                document.getElementById('campAcArchives').checked = p.canSeeArchives || false;
                document.getElementById('campAcAnalytics').checked = p.canSeeAnalytics || false;
                document.getElementById('campAcReporting').checked = p.canSeeReporting || false;
                document.getElementById('campAcSettings').checked = p.canSeeSettings || false;
                document.getElementById('campAcBatchActions').checked = p.canSeeBatchActions || false;
                document.getElementById('campAcActionAdd').checked = p.canActionAdd !== false;
                document.getElementById('campAcActionEdit').checked = p.canActionEdit !== false;
                document.getElementById('campAcActionCheckin').checked = p.canActionCheckin !== false;
                document.getElementById('campAcActionCheckout').checked = p.canActionCheckout !== false;
                document.getElementById('campAcActionInvoice').checked = p.canActionInvoice !== false;
                document.getElementById('campAcActionDelete').checked = p.canActionDelete !== false;
            } else {
                // Add mode
                modalTitle.textContent = 'Add User Access';
                saveBtn.textContent = 'Add';
                userSelectGroup.style.display = 'block';
                userDisplayGroup.style.display = 'none';

                document.getElementById('campAcArchives').checked = true;
                document.getElementById('campAcAnalytics').checked = true;
                document.getElementById('campAcReporting').checked = true;
                document.getElementById('campAcSettings').checked = false;
                document.getElementById('campAcBatchActions').checked = false;
                document.getElementById('campAcActionAdd').checked = true;
                document.getElementById('campAcActionEdit').checked = true;
                document.getElementById('campAcActionCheckin').checked = true;
                document.getElementById('campAcActionCheckout').checked = true;
                document.getElementById('campAcActionDelete').checked = true;

                // Setup autocomplete
                setupCampUserAutocomplete();
            }

            modal.style.display = 'flex';
        }

        function setupCampUserAutocomplete() {
            const input = document.getElementById('campAcUserInput');
            const dropdown = document.getElementById('campAcUserDropdown');
            const hidden = document.getElementById('campAcUserId');
            const { users, perms } = campAccessControlCache;

            input.addEventListener('input', () => {
                const query = input.value.toLowerCase().trim();
                if (!query) {
                    dropdown.style.display = 'none';
                    return;
                }

                const existingUids = new Set(Object.keys(perms || {}));
                const matches = Object.entries(users || {}).filter(([uid, u]) => {
                    if (existingUids.has(uid)) return false;
                    const name = (u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim()).toLowerCase();
                    const email = (u.email || '').toLowerCase();
                    return name.includes(query) || email.includes(query);
                }).slice(0, 10);

                if (matches.length === 0) {
                    dropdown.innerHTML = '<div class="item" style="color:#9ca3af;cursor:default;">No matching users found</div>';
                } else {
                    dropdown.innerHTML = matches.map(([uid, u]) => {
                        const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                        const email = u.email || '';
                        return `<div class="item" data-uid="${uid}"><span>${escapeHtmlCamp(name)}</span><span style="color:#9ca3af;font-size:.75rem;">${escapeHtmlCamp(email)}</span></div>`;
                    }).join('');
                }
                dropdown.style.display = 'block';
            });

            dropdown.addEventListener('click', (e) => {
                const item = e.target.closest('.item[data-uid]');
                if (item) {
                    const uid = item.dataset.uid;
                    const u = users[uid] || {};
                    const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim();
                    input.value = name;
                    hidden.value = uid;
                    dropdown.style.display = 'none';
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function closeCampAccessControlModal() {
            document.getElementById('campAccessControlModal').style.display = 'none';
            editingCampAccessControlUid = null;
        }

        async function saveCampAccessControl() {
            const user = window.authManager?.currentUser;
            if (!user || !user.companyId) return;

            const uid = (document.getElementById('campAcUserId')?.value || '').trim();
            if (!uid) {
                alert('Please select a user');
                return;
            }

            const canSeeArchives = document.getElementById('campAcArchives').checked;
            const canSeeAnalytics = document.getElementById('campAcAnalytics').checked;
            const canSeeReporting = document.getElementById('campAcReporting').checked;
            const canSeeSettings = document.getElementById('campAcSettings').checked;
            const canSeeBatchActions = document.getElementById('campAcBatchActions').checked;
            const canActionAdd = document.getElementById('campAcActionAdd').checked;
            const canActionEdit = document.getElementById('campAcActionEdit').checked;
            const canActionCheckin = document.getElementById('campAcActionCheckin').checked;
            const canActionCheckout = document.getElementById('campAcActionCheckout').checked;
            const canActionInvoice = document.getElementById('campAcActionInvoice').checked;
            const canActionDelete = document.getElementById('campAcActionDelete').checked;
            const isEditMode = editingCampAccessControlUid !== null;

            try {
                const data = {
                    canSeeArchives,
                    canSeeAnalytics,
                    canSeeReporting,
                    canSeeSettings,
                    canSeeBatchActions,
                    canActionAdd,
                    canActionEdit,
                    canActionCheckin,
                    canActionCheckout,
                    canActionInvoice,
                    canActionDelete
                };

                await firebase.database().ref(`companies/${user.companyId}/campSettings/tabVisibility/${uid}`).set(data);

                closeCampAccessControlModal();
                loadCampAccessControl();
                
                // Apply changes immediately if it's the current user
                if (uid === user.id || uid === user.uid) {
                    applyCampTabVisibility();
                    // Reload action permissions cache for current user
                    await loadCampUserActionPermissions();
                }
                
                // Reload data to apply action button visibility
                loadRoomAssignmentsData();
                
                showNotification(isEditMode ? 'User access updated' : 'User added to access control', 'success');
            } catch (error) {
                console.error('Failed to save camp access control:', error);
                showNotification(isEditMode ? 'Failed to update user' : 'Failed to add user', 'error');
            }
        }

        // =================== BATCH SELECTION FUNCTIONS ===================
        let campSelectedIds = new Set();

        function campToggleRowSelection(checkbox) {
            const id = checkbox.dataset.id;
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                campSelectedIds.add(id);
                row?.classList.add('selected');
            } else {
                campSelectedIds.delete(id);
                row?.classList.remove('selected');
            }
            campUpdateBatchUI();
        }

        function campToggleSelectAll(checkbox) {
            const rowCheckboxes = document.querySelectorAll('#assignmentsTable tbody .row-checkbox') || [];
            rowCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const id = cb.dataset.id;
                const row = cb.closest('tr');
                if (checkbox.checked) {
                    campSelectedIds.add(id);
                    row?.classList.add('selected');
                } else {
                    campSelectedIds.delete(id);
                    row?.classList.remove('selected');
                }
            });
            campUpdateBatchUI();
        }

        function campClearSelection() {
            campSelectedIds.clear();
            const selectAllCb = document.getElementById('campSelectAllCheckbox');
            if (selectAllCb) selectAllCb.checked = false;
            document.querySelectorAll('#assignmentsTable tbody .row-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('tr')?.classList.remove('selected');
            });
            campUpdateBatchUI();
        }

        function campUpdateBatchUI() {
            const count = campSelectedIds.size;
            const selectedCountEl = document.getElementById('campSelectedCount');
            const batchBar = document.getElementById('campBatchActionBar');
            if (selectedCountEl) selectedCountEl.textContent = count;
            if (batchBar) {
                batchBar.classList.toggle('visible', count > 0);
            }
            // Update select all checkbox state
            const rowCheckboxes = document.querySelectorAll('#assignmentsTable tbody .row-checkbox') || [];
            const allChecked = rowCheckboxes.length > 0 && Array.from(rowCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
            const selectAllCb = document.getElementById('campSelectAllCheckbox');
            if (selectAllCb) {
                selectAllCb.checked = allChecked;
                selectAllCb.indeterminate = someChecked && !allChecked;
            }
        }

        async function campBatchDelete() {
            // Check permission before batch delete
            if (!canCampAction('delete')) {
                showNotification('You do not have permission to delete assignments', 'warning');
                return;
            }
            const count = campSelectedIds.size;
            if (count === 0) return;

            if (!confirm(`Are you sure you want to delete ${count} assignment(s)? This action cannot be undone.`)) {
                return;
            }

            const user = window.authManager?.currentUser;
            if (!user || !user.companyId) {
                showNotification('Not authenticated', 'error');
                return;
            }

            try {
                const deletePromises = Array.from(campSelectedIds).map(id =>
                    firebase.database().ref(`companies/${user.companyId}/roomAssignments/${id}`).remove()
                );

                await Promise.all(deletePromises);

                showNotification(`Successfully deleted ${count} assignment(s)`, 'success');

                campClearSelection();
                await refreshTable();
                await loadArchivesData();
            } catch (error) {
                console.error('Batch delete failed:', error);
                showNotification('Failed to delete assignments: ' + (error.message || error), 'error');
            }
        }

        async function applyCampTabVisibility() {
            const user = window.authManager?.currentUser;
            const archivesBtn = document.getElementById('archivesTab');
            const analyticsBtn = document.getElementById('analyticsTab');
            const reportingBtn = document.getElementById('reportingTabBtn');
            const settingsBtn = document.getElementById('settingsTabBtn');

            if (!user || !user.companyId) {
                // Not logged in - show only active tab
                if (archivesBtn) archivesBtn.style.display = 'none';
                if (analyticsBtn) analyticsBtn.style.display = 'none';
                if (reportingBtn) reportingBtn.style.display = 'none';
                if (settingsBtn) settingsBtn.style.display = 'none';
                applyCampBatchActionsVisibility(false);
                return;
            }

            try {
                const snap = await firebase.database().ref(`companies/${user.companyId}/campSettings/tabVisibility/${user.id || user.uid}`).once('value');
                const p = snap.val();

                // If no permission record exists, HIDE all restricted tabs (user not in access control list)
                // Only admins/authorized users should have permission records that grant access
                if (!p) {
                    if (archivesBtn) archivesBtn.style.display = 'none';
                    if (analyticsBtn) analyticsBtn.style.display = 'none';
                    if (reportingBtn) reportingBtn.style.display = 'none';
                    if (settingsBtn) settingsBtn.style.display = 'none';
                    applyCampBatchActionsVisibility(false); // Hide batch actions
                    return;
                }

                // If permission record exists, apply the settings
                const allowArchives = p.canSeeArchives === true;
                const allowAnalytics = p.canSeeAnalytics === true;
                const allowReporting = p.canSeeReporting === true;
                const allowSettings = p.canSeeSettings === true;
                const allowBatchActions = p.canSeeBatchActions === true;

                if (archivesBtn) archivesBtn.style.display = allowArchives ? '' : 'none';
                if (analyticsBtn) analyticsBtn.style.display = allowAnalytics ? '' : 'none';
                if (reportingBtn) reportingBtn.style.display = allowReporting ? '' : 'none';
                if (settingsBtn) settingsBtn.style.display = allowSettings ? '' : 'none';
                applyCampBatchActionsVisibility(allowBatchActions);

                // If current active tab is hidden, switch to active assignments
                const activeTabBtn = document.querySelector('.tab-button.active');
                if (activeTabBtn && activeTabBtn.style.display === 'none') {
                    switchTab('active');
                }
            } catch (error) {
                console.error('Error applying camp tab visibility:', error);
                // On error, show all tabs so user isn't locked out
                if (archivesBtn) archivesBtn.style.display = '';
                if (analyticsBtn) analyticsBtn.style.display = '';
                if (reportingBtn) reportingBtn.style.display = '';
                if (settingsBtn) settingsBtn.style.display = '';
                applyCampBatchActionsVisibility(true);
            }
        }

        // Show/hide batch actions checkbox column
        function applyCampBatchActionsVisibility(show) {
            window._canSeeCampBatchActions = show;
            // Show/hide select all checkbox in header
            const selectAllCell = document.querySelector('#assignmentsTable thead th.row-checkbox-cell');
            if (selectAllCell) selectAllCell.style.display = show ? '' : 'none';
            // Show/hide row checkboxes
            document.querySelectorAll('#assignmentsTable tbody td.row-checkbox-cell').forEach(cell => {
                cell.style.display = show ? '' : 'none';
            });
        }

        // =================== REPORTING TAB LOGIC ===================
        // A4 fields configuration and UI helpers
        const A4_FIELDS_KEY = 'camp_a4_fields_v1';
        const A4_AVAILABLE_FIELDS = [
            { key: 'room', label: 'Room', accessor: r => r.room || r.roomNumber || '' },
            { key: 'location', label: 'Location', accessor: r => r.location || '' },
            { key: 'employee', label: 'Employee', accessor: r => r.employeeName || r.employee || '' },
            { key: 'company', label: 'Company', accessor: r => r.companyName || '' },
            { key: 'department', label: 'Department', accessor: r => r.department || '' },
            { key: 'checkIn', label: 'Check-in Date', accessor: r => r.checkInDate || r.checkIn || '' },
            { key: 'checkOut', label: 'Check-out Date', accessor: r => r.checkOutDate || r.checkOut || '' },
            { key: 'period', label: 'Period/Duration', accessor: r => r.period || r.duration || '' },
            { key: 'status', label: 'Status', accessor: r => r.status || '' }
        ];
        function getSavedA4Fields(){ try{ const raw=localStorage.getItem(A4_FIELDS_KEY); const arr=raw?JSON.parse(raw):null; return Array.isArray(arr)&&arr.length?arr:null; }catch(e){ return null; } }
        function saveA4Fields(list){ try{ localStorage.setItem(A4_FIELDS_KEY, JSON.stringify(list)); }catch(e){} }
        function getDefaultA4Fields(){ return ['room','location','employee','checkIn','checkOut','status']; }
        function getActiveA4Fields(){ return getSavedA4Fields() || getDefaultA4Fields(); }
        function buildA4CustomizeList(){ const listEl=document.getElementById('a4CustomizeList'); if(!listEl) return; const active=new Set(getActiveA4Fields()); listEl.innerHTML=A4_AVAILABLE_FIELDS.map(f=>`<label style="display:flex;align-items:center;gap:0.5rem;font-size:0.8rem;color:#334155;"><input type="checkbox" data-key="${f.key}" ${active.has(f.key)?'checked':''}/> ${f.label}</label>`).join(''); }
        function openA4CustomizePanel(open){ const panel=document.getElementById('a4CustomizePanel'); if(!panel) return; if(open===undefined) panel.classList.toggle('show'); else panel.classList[open?'add':'remove']('show'); }
        function collectA4SelectedFromPanel(){ const panel=document.getElementById('a4CustomizePanel'); if(!panel) return getActiveA4Fields(); const boxes=[...panel.querySelectorAll('input[type="checkbox"][data-key]')]; const sel=boxes.filter(b=>b.checked).map(b=>b.getAttribute('data-key')); return sel.length?sel:getDefaultA4Fields(); }
        function setupA4CustomizeUI(){ const btn=document.getElementById('a4CustomizeBtn'); const panel=document.getElementById('a4CustomizePanel'); const selectAll=document.getElementById('a4SelectAllBtn'); const clearAll=document.getElementById('a4ClearAllBtn'); const apply=document.getElementById('a4ApplyColumnsBtn'); if(!btn||!panel) return; buildA4CustomizeList(); btn.onclick=(e)=>{ e.stopPropagation(); openA4CustomizePanel(); }; selectAll.onclick=()=>{ panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); }; clearAll.onclick=()=>{ panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); }; apply.onclick=()=>{ const sel=collectA4SelectedFromPanel(); saveA4Fields(sel); openA4CustomizePanel(false); populateA4Report(); }; document.addEventListener('click',(e)=>{ if(!panel.contains(e.target) && e.target!==btn){ openA4CustomizePanel(false); }}); }

        // ==== A4 Pivot Config ====
        const A4_PIVOT_KEY = 'camp_a4_pivot_v1';
        const A4_PIVOT_FIELDS = [
            { key: 'none', label: '(None)' },
            { key: 'location', label: 'Location' },
            { key: 'department', label: 'Department' },
            { key: 'status', label: 'Status' },
            { key: 'company', label: 'Company' },
            { key: 'employee', label: 'Employee' },
            { key: 'room', label: 'Room' },
            { key: 'date', label: 'Check-in Day' }
        ];
        const A4_PIVOT_METRICS = [
            { key: 'count', label: 'Count' },
            { key: 'checkedIn', label: 'Checked In' }
        ];
        function defaultPivot(){ return { enabled:false, row:'location', col:'status', metric:'count', rowTotals:true, colTotals:true }; }
        function getSavedPivot(){ try{ const raw=localStorage.getItem(A4_PIVOT_KEY); const obj=raw?JSON.parse(raw):null; return obj||defaultPivot(); }catch(e){ return defaultPivot(); } }
        function savePivot(cfg){ try{ localStorage.setItem(A4_PIVOT_KEY, JSON.stringify(cfg)); }catch(e){} }
        function labelFor(list,key){ return (list.find(x=>x.key===key)||{}).label || key; }
        function fillSelect(sel,list,val){ sel.innerHTML=list.map(x=>`<option value="${x.key}" ${x.key===val?'selected':''}>${x.label}</option>`).join(''); }

        function setupA4PivotUI(){
            const btn=document.getElementById('a4PivotBtn');
            const panel=document.getElementById('a4PivotPanel');
            if(!btn||!panel) return;
            const cfg=getSavedPivot();
            const en=panel.querySelector('#a4PivotEnable');
            const row=panel.querySelector('#a4PivotRow');
            const col=panel.querySelector('#a4PivotCol');
            const met=panel.querySelector('#a4PivotMetric');
            const rt=panel.querySelector('#a4PivotRowTotals');
            const ct=panel.querySelector('#a4PivotColTotals');
            fillSelect(row,A4_PIVOT_FIELDS,cfg.row);
            fillSelect(col,A4_PIVOT_FIELDS,cfg.col);
            fillSelect(met,A4_PIVOT_METRICS,cfg.metric);
            en.checked=cfg.enabled; rt.checked=cfg.rowTotals; ct.checked=cfg.colTotals;
            btn.onclick=(e)=>{ e.stopPropagation(); panel.classList.toggle('show'); };
            panel.querySelector('#a4PivotClearBtn').onclick=()=>{ const d=defaultPivot(); en.checked=d.enabled; fillSelect(row,A4_PIVOT_FIELDS,d.row); fillSelect(col,A4_PIVOT_FIELDS,d.col); fillSelect(met,A4_PIVOT_METRICS,d.metric); rt.checked=d.rowTotals; ct.checked=d.colTotals; };
            panel.querySelector('#a4PivotApplyBtn').onclick=()=>{ const newCfg={ enabled:en.checked, row:row.value, col:col.value, metric:met.value, rowTotals:rt.checked, colTotals:ct.checked }; savePivot(newCfg); panel.classList.remove('show'); populateA4Report(); };
            document.addEventListener('click',(e)=>{ if(!panel.contains(e.target) && e.target!==btn){ panel.classList.remove('show'); }});
        }

        function setupReportingTab() {
            const reportTableBody = document.getElementById('reportTableBody');
            // Controls above the table have been removed; use the modal for all selections

            // Modal Generate action
            const modalGenBtn = document.getElementById('modalGenerateReportBtn');
            if (modalGenBtn) {
                modalGenBtn.addEventListener('click', async () => {
                    const mDSel = document.getElementById('modalReportDimensionSelect');
                    const mStart = document.getElementById('modalReportStartDate');
                    const mEnd = document.getElementById('modalReportEndDate');
                    const mEmp = document.getElementById('modalEmployeeSelect');
                    const mDep = document.getElementById('modalDepartmentSelect');
                    const mSite = document.getElementById('modalSiteSelect');
                    const mGen = document.getElementById('modalDimensionValueSelect');
                    const roomsHidden = document.getElementById('modalRoomsHiddenSelect');
                    // Infer period: for Room with any date range, use 'daily' to display all dates
                    let period = 'custom';
                    const startVal = mStart?.value || '';
                    const endVal = mEnd?.value || '';
                    if (startVal && (!endVal || endVal === startVal)) period = 'daily';
                    // If Room dimension with a multi-day range, force daily breakdown
                    if ((mDSel?.value||'') === 'room' && startVal && endVal && endVal !== startVal) {
                        period = 'daily';
                    }
                    const dimension = mDSel?.value || '';
                    const filter = {
                        startDate: mStart?.value || '',
                        endDate: mEnd?.value || '',
                        includeActive: document.getElementById('modalIncludeActive')?.checked !== false,
                        includeArchived: document.getElementById('modalIncludeArchived')?.checked !== false
                    };
                    if (dimension==='employee' && mEmp) filter.employeeId = mEmp.value;
                    if (dimension==='department' && mDep) filter.department = mDep.value;
                    if (dimension==='site' && mSite) filter.site = mSite.value;
                    if (dimension === 'room' && roomsHidden) {
                        const selectedRooms = [...roomsHidden.selectedOptions].map(o=>o.value).filter(Boolean);
                        if (selectedRooms.length) filter.dimValue = { field: 'room', value: selectedRooms };
                    } else if (mGen && mGen.value) {
                        filter.dimValue = { field: dimension, value: mGen.value };
                    }
                    // Normalize daily selection: if only one date provided, use it as both start and end
                    if (period === 'daily' && filter.startDate && !filter.endDate) {
                        filter.endDate = filter.startDate;
                    }
                    // Main controls removed above table; modal values are the source of truth now
                    try {
                        modalGenBtn.disabled = true;
                        modalGenBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                        // Generate and save a summary row for the selected criteria
                        await renderSingleSummaryRow(period, dimension, filter);
                        // Optionally open A4 view if requested
                        const openA4 = document.getElementById('modalOpenA4Checkbox')?.checked;
                        if (openA4) {
                            openA4PreviewModal();
                        }
                        closeModal('generateReportsModal');
                    } catch(e){
                        console.error(e);
                        showNotification('Error generating report: ' + (e.message||e), 'error');
                    } finally {
                        modalGenBtn.disabled = false;
                        modalGenBtn.innerHTML = '<i class="fas fa-play"></i> Generate';
                    }
                });
            }

            // Export functionality removed per request

            // Simplified report tab: customizer and pivot UI removed

            // Load saved reports on tab init
            (async () => {
                try {
                    await renderSavedReports();
                } catch (e) { console.warn('Failed to load saved reports', e); }
            })();
        }

        // Save generated report to Firebase
        async function saveReportToFirebase(reportData) {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    console.warn('No authenticated user for saving report');
                    return null;
                }
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.warn('No company ID found');
                    return null;
                }
                const reportsRef = window.authManager.db.ref(`companies/${companyId}/reports`);
                const newReportRef = reportsRef.push();
                await newReportRef.set({
                    ...reportData,
                    createdAt: new Date().toISOString(),
                    createdBy: window.authManager.currentUser.uid
                });
                console.log('Report saved to Firebase:', newReportRef.key);
                return newReportRef.key;
            } catch (e) {
                console.error('Failed to save report to Firebase:', e);
                return null;
            }
        }

        // Load all saved reports from Firebase for this company
        async function loadReportsFromFirebase() {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    console.warn('No authenticated user for loading reports');
                    return [];
                }
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.warn('No company ID found');
                    return [];
                }
                const reportsRef = window.authManager.db.ref(`companies/${companyId}/reports`);
                const snapshot = await reportsRef.once('value');
                if (!snapshot.exists()) return [];
                const reportsObj = snapshot.val();
                const reports = Object.entries(reportsObj).map(([id, data]) => ({ id, ...data }));
                // Sort by createdAt descending (newest first)
                reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                return reports;
            } catch (e) {
                console.error('Failed to load reports from Firebase:', e);
                return [];
            }
        }

        // Delete a report from Firebase
        async function deleteReportFromFirebase(reportId) {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    console.warn('No authenticated user for deleting report');
                    return;
                }
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.warn('No company ID found');
                    return;
                }
                const reportRef = window.authManager.db.ref(`companies/${companyId}/reports/${reportId}`);
                await reportRef.remove();
                console.log('Report deleted from Firebase:', reportId);
            } catch (e) {
                console.error('Failed to delete report from Firebase:', e);
            }
        }

        // Render saved reports table
        async function renderSavedReports() {
            const tbody = document.getElementById('reportTableBody');
            if (!tbody) return;
            const reports = await loadReportsFromFirebase();
            if (!reports || !reports.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#64748b;font-size:0.9rem;">No saved reports yet. Click + to generate a new report.</td></tr>';
                return;
            }
            const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
            const html = reports.map(r => {
                const statusClass = r.summary.status === 'checked_in' ? 'status-occupied' : (r.summary.status === 'completed' ? 'status-completed' : (r.summary.status === 'assigned' ? 'status-assigned' : 'status-maintenance'));
                const siteLabel = (r.summary && r.summary.site) ? r.summary.site : (r.dimension === 'site' ? 'All Locations' : '-');
                return `<tr data-report-id="${r.id}" style="cursor:pointer;" title="Click to view details">
                    <td>${esc(r.type)}</td>
                    <td>${esc(r.summary.employee)}</td>
                    <td>${esc(r.summary.department)}</td>
                    <td>${esc(siteLabel)}</td>
                    <td>${esc(r.summary.checkIn)}</td>
                    <td>${esc(r.summary.checkOut)}</td>
                    <td>${esc(r.summary.duration)}</td>
                    <td><span class="status-badge ${statusClass}">${esc(r.summary.status)}</span></td>
                    <td style="text-align:center;">
                        <button class="icon-btn delete-report-btn" data-report-id="${r.id}" title="Delete report" style="color:#ef4444;padding:0.25rem 0.4rem;">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;

            // Wire row click to fetch fresh detail data and open modal
            tbody.querySelectorAll('tr[data-report-id]').forEach(row => {
                row.addEventListener('click', async (e) => {
                    // Don't trigger if delete button was clicked
                    if (e.target.closest('.delete-report-btn')) return;
                    const reportId = row.getAttribute('data-report-id');
                    const report = reports.find(r => r.id === reportId);
                    if (!report) return;
                    await openReportDetails(report);
                });
            });

            // Wire delete buttons
            tbody.querySelectorAll('.delete-report-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const reportId = btn.getAttribute('data-report-id');
                    const ok = window.confirm('Delete this report? This action cannot be undone.');
                    if (!ok) return;
                    await deleteReportFromFirebase(reportId);
                    await renderSavedReports();
                    showNotification('Report deleted successfully.', 'success');
                });
            });
        }

        // Open report details modal with fresh data
        async function openReportDetails(report) {
            try {
                const modal = document.getElementById('reportRowDetailsModal');
                const titleEl = document.getElementById('reportRowDetailsTitle');
                const summaryEl = document.getElementById('reportRowDetailsSummary');
                const contentDiv = document.getElementById('reportRowDetailsContent');
                if (!modal || !titleEl || !summaryEl || !contentDiv) return;

                // Fetch fresh detail rows using stored filter
                const filter = report.filter || {};
                let rows;
                if (report.period === 'daily' && (filter?.startDate || filter?.endDate)) {
                    const rangeStart = new Date(filter.startDate || filter.endDate);
                    const rangeEnd = new Date(filter.endDate || filter.startDate || filter.endDate);
                    const base = await generateReportData('all', { includeActive: true, includeArchived: true });
                    // Prepare selected rooms if any
                    const roomsFilter = (filter?.dimValue && filter.dimValue.field === 'room') ? (Array.isArray(filter.dimValue.value) ? filter.dimValue.value : (filter.dimValue.value ? [filter.dimValue.value] : [])) : [];
                    rows = base.filter(a => {
                        if (filter.employeeId && a.employeeId !== filter.employeeId) return false;
                        if (filter.department && a.department !== filter.department) return false;
                        if (filter.site && a.location !== filter.site) return false;
                        if (roomsFilter.length) {
                            const rn = String(a.roomNumber||a.room||a.roomCode||'');
                            if (!roomsFilter.includes(rn)) return false;
                        }
                        const inRaw = a.actualCheckInDate || a.checkInDate;
                        if (!inRaw) return false;
                        const inD = new Date(inRaw);
                        const outRaw = a.actualCheckOutDate || a.checkOutDate;
                        const outD = outRaw ? new Date(outRaw) : null;
                        const overlaps = inD <= rangeEnd && (outD ? outD >= rangeStart : true);
                        return overlaps;
                    });
                } else {
                    rows = await generateReportData('all', filter);
                }

                const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
                const fmtDate = (d) => (d||'').split('T')[0] || '-';
                const calcDuration = (inD, outD, statusVal) => {
                    if (!inD) return '-';
                    const start = new Date(inD);
                    const end = outD ? new Date(outD) : (statusVal==='checked_in' ? new Date() : null);
                    if (!end) return '-';
                    const days = Math.ceil((end - start) / (1000*60*60*24));
                    return `${days} day${days!==1?'s':''}` + (!outD && statusVal==='checked_in' ? ' (ongoing)' : '');
                };

                // Special cases
                const isDailyBySite = report.period === 'daily' && report.dimension === 'site';
                const isDailyByRoom = report.period === 'daily' && report.dimension === 'room';

                if (isDailyByRoom) {
                    // Render per-day, per-room occupant list
                    const dailyRows = await generateDailyRoomOccupancy(filter);
                    const roomsIdx = await getRoomsIndex();
                    const rowsHtml = dailyRows.map(r => {
                        const emp = (r.employees && r.employees.length) ? r.employees.join(', ') : 'No occupant';
                        const meta = roomsIdx[String(r.room)] || roomsIdx[String(r.room).trim()] || null;
                        const siteLabel = r.site || (meta && meta.location ? (meta.location.name || meta.location.block || '-') : '-');
                        return `<tr>
                            <td>${esc(r.date)}</td>
                            <td>${esc(r.room)}</td>
                            <td>${esc(emp)}</td>
                            <td>${esc(siteLabel)}</td>
                        </tr>`;
                    }).join('');
                    const tableHtml = `
                        <table class="a4-report-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">Date</th>
                                    <th style="text-align:left;">Room</th>
                                    <th style="text-align:left;">Employee</th>
                                    <th style="text-align:left;">Site</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml || `<tr><td colspan=\"4\" style=\"text-align:center;color:#64748b;\">No detail rows</td></tr>`}
                            </tbody>
                        </table>`;
                    const branding = getCompanyBranding();
                    const meta = '';
                    contentDiv.innerHTML = buildA4DetailsHtml(branding, 'Accommodation Report  Daily by Room', meta, tableHtml);
                } else if (isDailyBySite) {
                    // Build a rooms index for robust location lookup
                    const roomsIdx = await getRoomsIndex();
                    const getLocLabel = (r) => {
                        // Prefer explicit location string
                        const direct = r.location || r.site;
                        if (direct && typeof direct === 'string') return direct;
                        // Try room metadata
                        const code = r.roomNumber || r.room || r.roomCode;
                        const meta = code ? (roomsIdx[String(code)] || roomsIdx[String(code).trim()]) : null;
                        const loc = meta && meta.location ? (meta.location.name || meta.location.block || null) : null;
                        return loc || 'Unknown Location';
                    };

                    // Group rows by computed location label
                    const siteGroups = new Map();
                    rows.forEach(r => {
                        const site = getLocLabel(r);
                        if (!siteGroups.has(site)) siteGroups.set(site, []);
                        siteGroups.get(site).push(r);
                    });

                    // Render a table for each site
                    const siteTables = Array.from(siteGroups.entries()).map(([site, siteRows]) => {
                        const rowsHtml = siteRows.map(r => {
                            const inD = r.actualCheckInDate || r.checkInDate || '';
                            const outD = r.actualCheckOutDate || r.checkOutDate || '';
                            const room = r.roomNumber || r.room || r.roomCode || '-';
                            const statusVal = r.status || '-';
                            const dur = calcDuration(inD, outD, statusVal);
                            return `<tr>
                                <td>${esc(r.employeeName||'-')}</td>
                                <td>${esc(r.department||'-')}</td>
                                <td>${esc(room)}</td>
                                <td>${esc(fmtDate(inD))}</td>
                                <td>${esc(fmtDate(outD))}</td>
                                <td>${esc(statusVal)}</td>
                                <td>${esc(dur)}</td>
                            </tr>`;
                        }).join('');

                        return `
                            <div style="margin-bottom:1.5rem;">
                                <h4 style="margin:0 0 0.5rem 0;padding:0.4rem 0.6rem;background:#f1f5f9;border-left:3px solid #2563eb;font-size:0.9rem;color:#1e293b;">
                                    ${esc(site)} <span style="color:#64748b;font-weight:normal;">(${siteRows.length} employee${siteRows.length!==1?'s':''})</span>
                                </h4>
                                <table class="table" style="width:100%; border-collapse:collapse;">
                                    <thead>
                                        <tr>
                                            <th style="text-align:left;">Employee</th>
                                            <th style="text-align:left;">Department</th>
                                            <th style="text-align:left;">Room</th>
                                            <th style="text-align:left;">Check-In</th>
                                            <th style="text-align:left;">Check-Out</th>
                                            <th style="text-align:left;">Status</th>
                                            <th style="text-align:left;">Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rowsHtml}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }).join('');

                    const branding = getCompanyBranding();
                    const meta = '';
                    const body = siteTables || `<div style=\"text-align:center;color:#64748b;padding:2rem;\">No employees found for this report.</div>`;
                    contentDiv.innerHTML = buildA4DetailsHtml(branding, 'Accommodation Report  Daily by Site', meta, body);
                } else {
                    // Render single table for non-grouped reports
                    const roomsIdx = await getRoomsIndex();
                    const getLocLabel = (r) => {
                        const direct = r.location || r.site;
                        if (direct && typeof direct === 'string') return direct;
                        const code = r.roomNumber || r.room || r.roomCode;
                        const meta = code ? (roomsIdx[String(code)] || roomsIdx[String(code).trim()]) : null;
                        const loc = meta && meta.location ? (meta.location.name || meta.location.block || null) : null;
                        return loc || 'Unknown Location';
                    };
                    const rowsHtml = rows.map(r => {
                        const inD = r.actualCheckInDate || r.checkInDate || '';
                        const outD = r.actualCheckOutDate || r.checkOutDate || '';
                        const room = r.roomNumber || r.room || r.roomCode || '-';
                        const statusVal = r.status || '-';
                        const dur = calcDuration(inD, outD, statusVal);
                        return `<tr>
                            <td>${esc(r.employeeName||'-')}</td>
                            <td>${esc(r.department||'-')}</td>
                            <td>${esc(getLocLabel(r))}</td>
                            <td>${esc(room)}</td>
                            <td>${esc(fmtDate(inD))}</td>
                            <td>${esc(fmtDate(outD))}</td>
                            <td>${esc(statusVal)}</td>
                            <td>${esc(dur)}</td>
                        </tr>`;
                    }).join('');

                    const tableHtml = `
                        <table class="a4-report-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">Employee</th>
                                    <th style="text-align:left;">Department</th>
                                    <th style="text-align:left;">Location</th>
                                    <th style="text-align:left;">Room</th>
                                    <th style="text-align:left;">Check-In</th>
                                    <th style="text-align:left;">Check-Out</th>
                                    <th style="text-align:left;">Status</th>
                                    <th style="text-align:left;">Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml || `<tr><td colspan=\"8\" style=\"text-align:center;color:#64748b;\">No detail rows</td></tr>`}
                            </tbody>
                        </table>`;
                    const branding = getCompanyBranding();
                    const meta = '';
                    contentDiv.innerHTML = buildA4DetailsHtml(branding, 'Accommodation Report  Details', meta, tableHtml);
                }

                const periodLabel = report.period.charAt(0).toUpperCase() + report.period.slice(1);
                const dimLabel = report.dimension ? (report.dimension.charAt(0).toUpperCase()+report.dimension.slice(1)) : 'Overall';
                titleEl.textContent = `Details  ${periodLabel}  ${dimLabel}`;
                summaryEl.textContent = `${rows.length} record${rows.length!==1?'s':''} in this group`;

                modal.classList.add('show');
            } catch (e) {
                console.error('Failed to open report details:', e);
            }
        }

        // A4-styled details helpers
        function getCompanyBranding(){
            const nameEl = document.querySelector('.company-name-header');
            const logoEl = document.querySelector('.header-company-logo');
            const name = (nameEl && nameEl.textContent && nameEl.textContent.trim()) || (window.authManager?.currentUser?.companyName) || 'Company';
            const logo = (logoEl && logoEl.getAttribute('src')) || '';
            return { name, logo };
        }

        function buildA4DetailsHtml(branding, title, subtitle, bodyHtml){
            const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
            const logoHtml = branding.logo ? `<img src="${esc(branding.logo)}" alt="Logo" class="a4-brand-logo" />` : '';
            const now = new Date();
            const generatedAt = now.toLocaleString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
            return `
                <div class="a4-report-container show" id="a4DetailsView">
                    <div class="a4-report-header">
                        <div class="a4-header-row">
                            <div class="a4-brand">
                                ${logoHtml}
                                <div class="a4-company-info">
                                    <div class="a4-company-name">${esc(branding.name)}</div>
                                    <div class="a4-report-title">${esc(title)}</div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    ${subtitle ? `<div class="a4-meta-banner">${esc(subtitle)}</div>` : ''}
                    <div class="a4-report-content">
                        ${bodyHtml}
                    </div>
                    <div class="a4-report-footer">
                        <div><small>Generated: ${esc(generatedAt)}</small></div>
                        <div><small>Page <span class="a4-page-number"></span></small></div>
                    </div>
                </div>`;
        }

        // Build a single summary row based on the modal fields and filtered data
        async function renderSingleSummaryRow(period, dimension, filter) {
            const theadRow = document.getElementById('reportTableHeader');
            const tbody = document.getElementById('reportTableBody');
            if (!theadRow || !tbody) return;

            // Reset header to row fields layout
            theadRow.innerHTML = [
                '<th>Type</th>',
                '<th>Employee</th>',
                '<th>Department</th>',
                '<th>Location</th>',
                '<th>Check-in</th>',
                '<th>Check-out</th>',
                '<th>Duration</th>',
                '<th>Status</th>',
                '<th style="width:60px;">Actions</th>'
            ].join('');

            // Fetch filtered base rows
            let rows;
            if (period === 'daily' && (filter?.startDate || filter?.endDate)) {
                // For daily period, use overlap filtering so ongoing stays are included
                const rangeStart = new Date(filter.startDate || filter.endDate);
                const rangeEnd = new Date(filter.endDate || filter.startDate || filter.endDate);
                // Get all rows without date filtering
                const base = await generateReportData('all', { includeActive: true, includeArchived: true });
                rows = base.filter(a => {
                    // Apply non-date filters first
                    if (filter.employeeId && a.employeeId !== filter.employeeId) return false;
                    if (filter.department && a.department !== filter.department) return false;
                    if (filter.site && a.location !== filter.site) return false;
                    // Overlap logic
                    const inRaw = a.actualCheckInDate || a.checkInDate;
                    if (!inRaw) return false;
                    const inD = new Date(inRaw);
                    const outRaw = a.actualCheckOutDate || a.checkOutDate;
                    const outD = outRaw ? new Date(outRaw) : null; // ongoing if null and not checked_out
                    const overlaps = inD <= rangeEnd && (outD ? outD >= rangeStart : true);
                    return overlaps;
                });
            } else {
                rows = await generateReportData('all', filter);
            }
            try { window.__camp_reportingData = rows; } catch(_) {}
            try { window.__camp_report_context = { period, dimension, filter }; } catch(_) {}

            if (!rows || !rows.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#64748b;font-size:0.9rem;">No data for selected criteria.</td></tr>';
                displayReportSummary('', []);
                const canvas = document.getElementById('reportChartCanvas'); if (canvas) canvas.style.display = 'none';
                return;
            }

            const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
            const fmtDate = (d) => (d||'').split('T')[0] || '-';

            // Compute earliest check-in and latest check-out
            const inDates = rows.map(r => r.actualCheckInDate || r.checkInDate).filter(Boolean).map(d => new Date(d));
            const outDates = rows.map(r => r.actualCheckOutDate || r.checkOutDate).filter(Boolean).map(d => new Date(d));
            const firstIn = inDates.length ? new Date(Math.min(...inDates)) : null;
            const lastOut = outDates.length ? new Date(Math.max(...outDates)) : null;

            // Determine status summary
            const hasCheckedIn = rows.some(r => r.status === 'checked_in');
            const allCheckedOut = rows.every(r => r.status === 'checked_out');
            const status = allCheckedOut ? 'completed' : (hasCheckedIn ? 'checked_in' : (rows[0]?.status || '-'));

            // Compute duration
            let duration = '-';
            if (firstIn && lastOut) {
                const days = Math.ceil((lastOut - firstIn) / (1000*60*60*24));
                duration = `${days} day${days!==1?'s':''}`;
            } else if (firstIn && hasCheckedIn) {
                const days = Math.ceil((Date.now() - firstIn.getTime()) / (1000*60*60*24));
                duration = `${days} day${days!==1?'s':''} (ongoing)`;
            }

            // Column values based on chosen dimension and selected focus value
            const unique = (arr) => [...new Set(arr.filter(Boolean))];
            const employees = unique(rows.map(r => r.employeeName));
            const departments = unique(rows.map(r => r.department));
            const sites = unique(rows.map(r => r.location));

            let typeLabel = dimension ? (dimension.charAt(0).toUpperCase()+dimension.slice(1)) : 'All';
            if (period === 'daily' && dimension === 'site') {
                typeLabel = 'Daily by Site';
            }
            let employeeCell = '-';
            let deptCell = '-';
            let siteCell = '-';

            if (dimension === 'employee') {
                if (filter.employeeId) {
                    const match = rows.find(r => r.employeeId === filter.employeeId);
                    employeeCell = match?.employeeName || employees[0] || '-';
                } else {
                    employeeCell = employees.join(', ') || '-';
                }
            } else if (!dimension) {
                employeeCell = employees.join(', ') || '-';
            }

            if (dimension === 'department') {
                deptCell = filter.department || departments[0] || '-';
            } else if (!dimension) {
                deptCell = departments.join(', ') || '-';
            }

            if (dimension === 'site') {
                if (filter.site) {
                    siteCell = filter.site;
                } else if (sites.length > 1) {
                    siteCell = `All Sites (${sites.length})`;
                } else if (sites.length === 1) {
                    siteCell = sites[0];
                } else {
                    siteCell = '-';
                }
            } else if (!dimension) {
                siteCell = sites.join(', ') || '-';
            }

            // Save report to Firebase before rendering
            const reportData = {
                type: typeLabel,
                period,
                dimension,
                filter,
                summary: {
                    employee: employeeCell,
                    department: deptCell,
                    site: siteCell,
                    checkIn: firstIn ? fmtDate(firstIn.toISOString()) : '-',
                    checkOut: lastOut ? fmtDate(lastOut.toISOString()) : '-',
                    duration,
                    status,
                    count: rows.length
                },
                details: rows
            };
            await saveReportToFirebase(reportData);

            // Reload saved reports to display updated table
            await renderSavedReports();

            // If daily by room requested, render a per-day list across the date range with room occupants
            if (period === 'daily' && dimension === 'room') {
                const dailyRows = await generateDailyRoomOccupancy(filter);
                renderDailyRoomOccupancy(dailyRows, tbody);
            } else {
                // Hide summary and chart for now per clean UI direction
                displayReportSummary('', []);
                const canvas = document.getElementById('reportChartCanvas'); if (canvas) canvas.style.display = 'none';
            }
        }

        // Build a per-day occupancy list for selected rooms within the date range
        async function generateDailyRoomOccupancy(filter) {
            const startStr = filter.startDate || filter.endDate;
            const endStr = filter.endDate || filter.startDate || filter.endDate;
            if (!startStr) return [];

            // Normalize date range (inclusive)
            const toYMD = (d) => new Date(d).toISOString().split('T')[0];
            const start = new Date(startStr);
            const end = new Date(endStr || startStr);
            if (end < start) [start, end] = [end, start];
            const days = [];
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                days.push(toYMD(d));
            }

            // Ensure room filter exists (array of room codes)
            const rooms = (filter?.dimValue && filter.dimValue.field === 'room')
                ? (Array.isArray(filter.dimValue.value) ? filter.dimValue.value : [filter.dimValue.value])
                : [];

            // Fetch base rows with overlap filtering already applied
            const base = await generateReportData('all', filter);
            const byRoom = new Map();
            base.forEach(a => {
                const rn = String(a.roomNumber || a.room || a.roomCode || '');
                if (!rn) return;
                if (!byRoom.has(rn)) byRoom.set(rn, []);
                byRoom.get(rn).push(a);
            });

            // Helper to check if assignment covers a specific date (YYYY-MM-DD)
            const coversDate = (a, ymd) => {
                const inD = a.actualCheckInDate || a.checkInDate; if (!inD) return false;
                const outD = a.actualCheckOutDate || a.checkOutDate; // can be null for ongoing
                const d = new Date(ymd);
                const startD = new Date(inD);
                const endD = outD ? new Date(outD) : null;
                return startD <= d && (endD ? endD >= d : true);
            };

            // Build rows: for each day and each selected room, list occupants
            const rows = [];
            const targetedRooms = rooms.length ? rooms : Array.from(byRoom.keys());
            targetedRooms.sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true}));
            for (const date of days) {
                for (const rn of targetedRooms) {
                    const list = byRoom.get(String(rn)) || [];
                    const occupants = list.filter(a => coversDate(a, date));
                    const names = [...new Set(occupants.map(a => a.employeeName).filter(Boolean))];
                    const site = occupants[0]?.location || '-';
                    rows.push({ date, room: String(rn), employees: names, site, details: occupants });
                }
            }

            // Sort by date asc then room asc
            rows.sort((a,b) => (new Date(a.date) - new Date(b.date)) || String(a.room).localeCompare(String(b.room), undefined, {numeric:true}));
            return rows;
        }

        // Render daily room occupancy rows into the main report table
        function renderDailyRoomOccupancy(rows, tbody) {
            const theadRow = document.getElementById('reportTableHeader');
            if (theadRow) {
                theadRow.innerHTML = [
                    '<th>Date</th>',
                    '<th>Room</th>',
                    '<th>Employee</th>',
                    '<th>Site</th>',
                    '<th style="width:60px;">Actions</th>'
                ].join('');
            }
            if (!rows || !rows.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;font-size:0.9rem;">No data for selected criteria.</td></tr>';
                return;
            }
            const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
            const html = rows.map(r => {
                const emp = r.employees.length ? r.employees.join(', ') : 'No occupant';
                return `<tr>
                    <td>${esc(r.date)}</td>
                    <td>${esc(r.room)}</td>
                    <td>${esc(emp)}</td>
                    <td>${esc(r.site||'-')}</td>
                    <td>-</td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;
            // Hide summary/chart for this focused list
            displayReportSummary('', []);
            const canvas = document.getElementById('reportChartCanvas'); if (canvas) canvas.style.display = 'none';
        }

        // New: Combined period + dimension report generator
        async function generateCombinedReport(period, dimension, filter) {
            // First, gather the baseline list using existing generator (type 'all' to get raw rows with applied filters)
            const baseRows = await generateReportData('all', filter);
            const rows = Array.isArray(baseRows) ? baseRows : [];
            // Sync global for A4 usage (so A4 reflects current filters)
            try { window.__camp_reportingData = rows; } catch(_) {}

            // Helper to normalize dates
            const getCheckInDay = (r) => {
                const d = (r.actualCheckInDate || r.checkInDate || '').split('T')[0];
                return d || '';
            };
            const ymd = (d) => d ? new Date(d) : null;
            const monthKey = (d) => {
                const dt = ymd(d); if(!dt) return '';
                const y = dt.getFullYear(); const m = String(dt.getMonth()+1).padStart(2,'0');
                return `${y}-${m}`;
            };
            const yearKey = (d) => {
                const dt = ymd(d); if(!dt) return '';
                return String(dt.getFullYear());
            };

            // Build period groups
            const periodMapper = {
                daily: (r) => getCheckInDay(r),
                monthly: (r) => monthKey(getCheckInDay(r)),
                yearly: (r) => yearKey(getCheckInDay(r)),
                custom: (r) => 'Custom'
            };
            const toPeriod = periodMapper[period] || periodMapper.daily;

            // Dimension extractor
            const dimMapper = {
                '': () => 'Overall',
                site: (r) => r.location || '-',
                department: (r) => r.department || '-',
                employee: (r) => r.employeeName || r.employee || '-'
            };
            const toDim = dimMapper[dimension] || dimMapper[''];

            // Aggregate
            const grid = new Map(); // pKey -> Map(dimVal -> list)
            rows.forEach(r => {
                const pKey = toPeriod(r) || '-';
                const dKey = toDim(r) || '-';
                const pMap = grid.get(pKey) || new Map();
                const list = pMap.get(dKey) || [];
                list.push(r);
                pMap.set(dKey, list);
                grid.set(pKey, pMap);
            });

            // Materialize result as array of { period, dimension, key, count, details }
            const result = [];
            for (const [pKey, pMap] of grid.entries()) {
                for (const [dKey, list] of pMap.entries()) {
                    result.push({ period: pKey, dimension, key: dKey, count: list.length, details: list });
                }
            }
            // Sort by period chronological when possible
            const parsePeriod = (p) => {
                if (period === 'daily') return new Date(p);
                if (period === 'monthly') return new Date(p + '-01');
                if (period === 'yearly') return new Date(p + '-01-01');
                return new Date(0);
            };
            result.sort((a,b) => parsePeriod(a.period) - parsePeriod(b.period) || String(a.key).localeCompare(String(b.key)));
            return result;
        }

        // Renderer for combined reports
        function renderCombinedReport(period, dimension, rows, tbody) {
            if (!Array.isArray(rows) || !rows.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#64748b;font-size:0.9rem;">No data for selected criteria.</td></tr>';
                document.getElementById('reportSummaryStats').style.display = 'none';
                document.getElementById('reportChartCanvas').style.display = 'none';
                return;
            }
            // Persist current report context for A4 usage
            try { window.__camp_report_context = { period, dimension }; } catch(_) {}
            // Also persist the latest combined rows for details modal usage
            try { window.__camp_lastCombinedRows = rows; } catch(_) {}
            // Update header to better reflect combined report layout
            const theadRow = document.getElementById('reportTableHeader');
            if (theadRow) {
                theadRow.innerHTML = [
                    '<th>Period</th>',
                    '<th>Employee / Key</th>',
                    '<th>Department</th>',
                    '<th>Site</th>',
                    '<th>First Check-in</th>',
                    '<th>Last Check-out</th>',
                    '<th>Count</th>',
                    '<th>Status</th>'
                ].join('');
            }
            // Build table rows
            try { window.__camp_a4_click_ctx = null; } catch(_) {}
            const html = rows.map((r,i) => {
                const typeLabel = period.charAt(0).toUpperCase() + period.slice(1);
                const employeeNames = [...new Set(r.details.map(x => x.employeeName).filter(Boolean))].join(', ');
                // If dimension is employee, we already have specific employee; else show top employees
                const employeeCell = (dimension === 'employee') ? r.key : employeeNames;
                const dept = (dimension === 'department') ? r.key : '-';
                const site = (dimension === 'site') ? r.key : '-';
                const sortedByIn = [...r.details].sort((a,b)=> new Date((a.actualCheckInDate||a.checkInDate||'1970-01-01')) - new Date((b.actualCheckInDate||b.checkInDate||'1970-01-01')));
                const sortedByOut = [...r.details].sort((a,b)=> new Date((a.actualCheckOutDate||a.checkOutDate||'1970-01-01')) - new Date((b.actualCheckOutDate||b.checkOutDate||'1970-01-01')));
                const firstIn = (sortedByIn[0]?.actualCheckInDate || sortedByIn[0]?.checkInDate || '').split('T')[0] || '-';
                const lastOut = (sortedByOut[sortedByOut.length-1]?.actualCheckOutDate || sortedByOut[sortedByOut.length-1]?.checkOutDate || '').split('T')[0] || '-';
                const ctx = encodeURIComponent(JSON.stringify({ periodType: period, dim: dimension, periodKey: r.period, dimKey: r.key }));
                return `<tr class="report-row" data-row-index="${i}" data-report-ctx="${ctx}">
                    <td>${typeLabel} ${r.period}</td>
                    <td>${employeeCell || '-'}</td>
                    <td>${dept}</td>
                    <td>${site}</td>
                    <td>${firstIn}</td>
                    <td>${lastOut}</td>
                    <td>${r.count}</td>
                    <td>-</td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;
            // Wire: click a row to open a details modal for that group (instead of A4 preview)
            Array.from(tbody.querySelectorAll('tr.report-row')).forEach(tr => {
                tr.addEventListener('click', () => {
                    const idx = Number(tr.getAttribute('data-row-index'));
                    openReportRowDetailsByIndex(idx);
                });
            });
            // Hide summary and chart for now per clean UI direction
            displayReportSummary('', []);
            const canvas = document.getElementById('reportChartCanvas'); if (canvas) canvas.style.display = 'none';
        }

        // Open a modal showing the detailed rows for a clicked report group
    async function openReportRowDetailsByIndex(index) {
            try {
                const groups = window.__camp_lastCombinedRows || [];
                const group = groups[index];
                if (!group) return;
                const modal = document.getElementById('reportRowDetailsModal');
                const titleEl = document.getElementById('reportRowDetailsTitle');
                const summaryEl = document.getElementById('reportRowDetailsSummary');
        const contentDiv = document.getElementById('reportRowDetailsContent');
        if (!modal || !titleEl || !summaryEl || !contentDiv) return;

                const esc = (s) => String(s ?? '').replace(/[&<>"]|'/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
                const fmtDate = (d) => (d||'').split('T')[0] || '-';
                const calcDuration = (inD, outD, status) => {
                    if (!inD) return '-';
                    const start = new Date(inD);
                    const end = outD ? new Date(outD) : (status==='checked_in' ? new Date() : null);
                    if (!end) return '-';
                    const days = Math.ceil((end - start) / (1000*60*60*24));
                    return `${days} day${days!==1?'s':''}` + (!outD && status==='checked_in' ? ' (ongoing)' : '');
                };

                const periodLabel = group.period;
                const dimLabel = group.dimension ? `${group.dimension.charAt(0).toUpperCase()+group.dimension.slice(1)}: ${group.key}` : 'Overall';
                titleEl.textContent = `Details  ${periodLabel}  ${dimLabel}`;
                summaryEl.textContent = `${group.count} record${group.count!==1?'s':''} in this group`;

                const roomsIdx = await getRoomsIndex();
                const getLocLabel = (r) => {
                    const direct = r.location || r.site;
                    if (direct && typeof direct === 'string') return direct;
                    const code = r.roomNumber || r.room || r.roomCode;
                    const meta = code ? (roomsIdx[String(code)] || roomsIdx[String(code).trim()]) : null;
                    const loc = meta && meta.location ? (meta.location.name || meta.location.block || null) : null;
                    return loc || '-';
                };

                const rowsHtml = group.details.map(r => {
                    const inD = r.actualCheckInDate || r.checkInDate || '';
                    const outD = r.actualCheckOutDate || r.checkOutDate || '';
                    const room = r.roomNumber || r.room || r.roomCode || '-';
                    const status = r.status || '-';
                    const duration = calcDuration(inD, outD, status);
                    return `<tr>
                        <td>${esc(r.employeeName||'-')}</td>
                        <td>${esc(r.department||'-')}</td>
                        <td>${esc(getLocLabel(r))}</td>
                        <td>${esc(room)}</td>
                        <td>${esc(fmtDate(inD))}</td>
                        <td>${esc(fmtDate(outD))}</td>
                        <td>${esc(status)}</td>
                        <td>${esc(duration)}</td>
                    </tr>`;
                }).join('');
                const tableHtml = `
                    <table class="a4-report-table" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr>
                                <th style="text-align:left;">Employee</th>
                                <th style="text-align:left;">Department</th>
                                <th style="text-align:left;">Location</th>
                                <th style="text-align:left;">Room</th>
                                <th style="text-align:left;">Check-In</th>
                                <th style="text-align:left;">Check-Out</th>
                                <th style="text-align:left;">Status</th>
                                <th style="text-align:left;">Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml || `<tr><td colspan=\"8\" style=\"text-align:center;color:#64748b;\">No detail rows</td></tr>`}
                        </tbody>
                    </table>`;
                const branding = getCompanyBranding();
                const meta = `Period: ${esc(group.period)}${group.dimension?`  ${esc(group.dimension)}`:''} | Key: ${esc(group.key||'-')}`;
                contentDiv.innerHTML = buildA4DetailsHtml(branding, 'Accommodation Report  Group Details', meta, tableHtml);

                modal.classList.add('show');
            } catch (e) {
                console.error('Failed to open details modal', e);
            }
        }

        // Dropdown cache to avoid repeated fetch delays
        window.__camp_dropdown_cache = window.__camp_dropdown_cache || { employees: null, departments: null, sites: null };

        // Helper: Populate employee dropdown - uses comprehensive data
        async function populateEmployeeDropdown(select) {
            // Use cache if available
            if (window.__camp_dropdown_cache.employees) {
                select.innerHTML = '<option value="">Select Employee</option>';
                Object.entries(window.__camp_dropdown_cache.employees).forEach(([id, name]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
                return;
            }
            select.innerHTML = '<option value="">Select Employee</option>';
            try {
                // Get comprehensive data from Firebase if available
                let assignments = [];
                if (window.authManager && window.authManager.currentUser) {
                    const companyId = window.authManager.currentUser.companyId;
                    const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                    const snapshot = await assignmentsRef.once('value');
                    if (snapshot.exists()) {
                        assignments = Object.values(snapshot.val());
                    }
                }
                
                // Fallback to cached data
                if (!assignments.length) {
                    assignments = Array.isArray(window.__camp_lastAssignments) ? window.__camp_lastAssignments : [];
                }
                
                const employees = {};
                assignments.forEach(a => {
                    if (a.employeeId && a.employeeName) employees[a.employeeId] = a.employeeName;
                });
                window.__camp_dropdown_cache.employees = employees;
                Object.entries(employees).forEach(([id, name]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
            } catch (e) { 
                console.warn('Error populating employee dropdown:', e);
            }
        }

        // Helper: Populate department dropdown - uses comprehensive data
        async function populateDepartmentDropdown(select) {
            // Use cache if available
            if (window.__camp_dropdown_cache.departments) {
                select.innerHTML = '<option value="">Select Department</option>';
                window.__camp_dropdown_cache.departments.forEach(dep => {
                    const opt = document.createElement('option');
                    opt.value = dep;
                    opt.textContent = dep;
                    select.appendChild(opt);
                });
                return;
            }
            select.innerHTML = '<option value="">Select Department</option>';
            try {
                // Get comprehensive data from Firebase if available
                let assignments = [];
                if (window.authManager && window.authManager.currentUser) {
                    const companyId = window.authManager.currentUser.companyId;
                    const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                    const snapshot = await assignmentsRef.once('value');
                    if (snapshot.exists()) {
                        assignments = Object.values(snapshot.val());
                    }
                }
                
                // Fallback to cached data
                if (!assignments.length) {
                    assignments = Array.isArray(window.__camp_lastAssignments) ? window.__camp_lastAssignments : [];
                }
                
                const depMap = {};
                assignments.forEach(a => {
                    if (a.department) depMap[a.department] = true;
                });
                const departments = Object.keys(depMap);
                window.__camp_dropdown_cache.departments = departments;
                departments.forEach(dep => {
                    const opt = document.createElement('option');
                    opt.value = dep;
                    opt.textContent = dep;
                    select.appendChild(opt);
                });
            } catch (e) { 
                console.warn('Error populating department dropdown:', e);
            }
        }

        // Helper: Populate site/location dropdown - uses comprehensive data
        async function populateSiteDropdown(select) {
            // Use cache if available
            if (window.__camp_dropdown_cache.sites) {
                select.innerHTML = '<option value="">Select Site</option>';
                window.__camp_dropdown_cache.sites.forEach(site => {
                    const opt = document.createElement('option');
                    opt.value = site;
                    opt.textContent = site;
                    select.appendChild(opt);
                });
                return;
            }
            select.innerHTML = '<option value="">Select Site</option>';
            try {
                // Get comprehensive data from Firebase if available
                let assignments = [];
                if (window.authManager && window.authManager.currentUser) {
                    const companyId = window.authManager.currentUser.companyId;
                    const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                    const snapshot = await assignmentsRef.once('value');
                    if (snapshot.exists()) {
                        assignments = Object.values(snapshot.val());
                    }
                }
                
                // Fallback to cached data
                if (!assignments.length) {
                    assignments = Array.isArray(window.__camp_lastAssignments) ? window.__camp_lastAssignments : [];
                }
                
                const siteMap = {};
                assignments.forEach(a => {
                    if (a.location) siteMap[a.location] = true;
                });
                const sites = Object.keys(siteMap);
                window.__camp_dropdown_cache.sites = sites;
                sites.forEach(site => {
                    const opt = document.createElement('option');
                    opt.value = site;
                    opt.textContent = site;
                    select.appendChild(opt);
                });
            } catch (e) { 
                console.warn('Error populating site dropdown:', e);
            }
        }

        // Main report data generator - uses both active assignments and archives
        async function generateReportData(type, filter) {
            // Get comprehensive data from Firebase (both active and archived)
            let allAssignments = [];
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    console.log('No authenticated user for generating reports');
                    return [];
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.log('No company ID found');
                    return [];
                }
                
                // Fetch all assignments from Firebase
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.once('value');
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    allAssignments = Object.entries(assignments).map(([id, assignment]) => ({
                        id,
                        ...assignment
                    }));
                    
                    // Apply per-user visibility: only allowed location blocks
                    const [{ set: allowedLocations }, roomsIdx] = await Promise.all([
                        getAllowedLocationsForCurrentUser(),
                        getRoomsIndex()
                    ]);
                    
                    allAssignments = allAssignments.filter(a => {
                        const roomNum = a.roomNumber || a.room || a.roomCode;
                        const meta = roomsIdx[String(roomNum)] || null;
                        const block = meta && meta.location ? meta.location.block : null;
                        return block && allowedLocations.has(block);
                    });
                }
                
                // Store for other functions to use
                window.__camp_reportingData = allAssignments;
                
            } catch (error) {
                console.error('Error fetching assignment data for reporting:', error);
                // Fallback to cached data if available
                allAssignments = Array.isArray(window.__camp_lastAssignments) ? window.__camp_lastAssignments : [];
            }
            
            // Apply filters
            let filtered = allAssignments.filter(a => {
                let ok = true;
                // Active/archived toggles
                if (filter && (filter.includeActive === false || filter.includeArchived === false)) {
                    const isArchived = a.status === 'checked_out';
                    if (isArchived && filter.includeArchived === false) ok = false;
                    if (!isArchived && filter.includeActive === false) ok = false;
                }
                // Date filtering - include assignments that overlap the selected range
                if (filter.startDate || filter.endDate) {
                    const start = filter.startDate ? new Date(filter.startDate) : null;
                    const end = filter.endDate ? new Date(filter.endDate) : null;
                    const inRaw = a.actualCheckInDate || a.checkInDate;
                    const outRaw = a.actualCheckOutDate || a.checkOutDate; // null/undefined means ongoing
                    if (!inRaw) { ok = false; }
                    else {
                        const inD = new Date(inRaw);
                        const outD = outRaw ? new Date(outRaw) : null;
                        let overlaps = true;
                        if (start && end) {
                            overlaps = inD <= end && (outD ? outD >= start : true);
                        } else if (start && !end) {
                            overlaps = (outD ? outD >= start : true) && inD <= start;
                        } else if (!start && end) {
                            overlaps = inD <= end;
                        }
                        ok = ok && overlaps;
                    }
                }
                
                // Type-specific filtering (only if specific values are selected)
                if (type === 'employee' && filter.employeeId && filter.employeeId !== '') {
                    ok = ok && a.employeeId === filter.employeeId;
                }
                if (type === 'department' && filter.department && filter.department !== '') {
                    ok = ok && a.department === filter.department;
                }
                if (type === 'site' && filter.site && filter.site !== '') {
                    ok = ok && a.location === filter.site;
                }
                // Generic dimension value filter
                if (filter.dimValue && filter.dimValue.field && (filter.dimValue.value!=='' && filter.dimValue.value!=null)) {
                    const f = filter.dimValue.field;
                    const v = filter.dimValue.value;
                    if (f === 'room') {
                        const rn = String(a.roomNumber||a.room||'');
                        ok = ok && (Array.isArray(v) ? v.includes(rn) : rn === v);
                    } else if (f === 'status') {
                        ok = ok && String(a.status||'') === v;
                    } else if (f === 'checkin_date') {
                        const d=(a.actualCheckInDate||a.checkInDate||'').split('T')[0];
                        ok = ok && d === v;
                    } else if (f === 'checkout_date') {
                        const d=(a.actualCheckOutDate||a.checkOutDate||'').split('T')[0];
                        ok = ok && d === v;
                    } else if (f === 'duration') {
                        const start = a.actualCheckInDate||a.checkInDate; const end = a.actualCheckOutDate||a.checkOutDate;
                        if (start && end) {
                            const days = Math.ceil((new Date(end)-new Date(start))/(1000*60*60*24));
                            if (v==='1 day') ok = ok && days===1;
                            else if (v==='2-7 days') ok = ok && days>=2 && days<=7;
                            else if (v==='8-30 days') ok = ok && days>=8 && days<=30;
                            else if (v==='31+ days') ok = ok && days>=31;
                        } else {
                            ok = false;
                        }
                    }
                }
                
                return ok;
            });
            
            console.log('Filtered assignments:', filtered.length, 'from total:', allAssignments.length);
            window.__camp_reportingChartType = filter.chartType || 'auto';
            if (type === 'department') {
                const map = {};
                filtered.forEach(a => {
                    if (!map[a.department]) map[a.department] = [];
                    map[a.department].push(a);
                });
                return Object.entries(map).map(([dep, list]) => ({
                    type: 'Department',
                    department: dep,
                    count: list.length,
                    employees: [...new Set(list.map(x => x.employeeName))].join(', '),
                    details: list
                }));
            }
            if (type === 'site') {
                const map = {};
                filtered.forEach(a => {
                    if (!map[a.location]) map[a.location] = [];
                    map[a.location].push(a);
                });
                return Object.entries(map).map(([site, list]) => ({
                    type: 'Site',
                    site,
                    count: list.length,
                    employees: [...new Set(list.map(x => x.employeeName))].join(', '),
                    details: list
                }));
            }
            if (type === 'daily') {
                const map = {};
                filtered.forEach(a => {
                    const date = a.checkInDate ? a.checkInDate.split('T')[0] : '-';
                    if (!map[date]) map[date] = [];
                    map[date].push(a);
                });
                return Object.entries(map).map(([date, list]) => ({
                    type: 'Daily',
                    date,
                    count: list.length,
                    employees: [...new Set(list.map(x => x.employeeName))].join(', '),
                    details: list
                }));
            }
            if (type === 'all') {
                return filtered;
            }
            return filtered;
        }

        // Render report table with enhanced data display
        function renderReportTable(type, data, tbody) {
            if (!Array.isArray(data) || !data.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#64748b;font-size:0.9rem;">No data for selected criteria.</td></tr>';
                // Hide summary stats and chart
                document.getElementById('reportSummaryStats').style.display = 'none';
                document.getElementById('reportChartCanvas').style.display = 'none';
                return;
            }
            
            let html = '';
            if (type === 'employee' || type === 'all') {
                html = data.map(a => {
                    // Calculate duration
                    let duration = '-';
                    const checkInDate = a.actualCheckInDate || a.checkInDate;
                    const checkOutDate = a.actualCheckOutDate || a.checkOutDate;
                    if (checkInDate && checkOutDate) {
                        const days = Math.ceil((new Date(checkOutDate) - new Date(checkInDate)) / (1000 * 60 * 60 * 24));
                        duration = `${days} day${days !== 1 ? 's' : ''}`;
                    } else if (checkInDate && a.status === 'checked_in') {
                        const days = Math.ceil((new Date() - new Date(checkInDate)) / (1000 * 60 * 60 * 24));
                        duration = `${days} day${days !== 1 ? 's' : ''} (ongoing)`;
                    }
                    
                    return `<tr>
                        <td>${type === 'employee' ? 'Employee' : 'All'}</td>
                        <td>${a.employeeName || '-'}</td>
                        <td>${a.department || '-'}</td>
                        <td>${a.location || '-'}</td>
                        <td>${checkInDate ? checkInDate.split('T')[0] : '-'}</td>
                        <td>${checkOutDate ? checkOutDate.split('T')[0] : '-'}</td>
                        <td>${duration}</td>
                        <td><span class="status-badge ${getStatusClass(a.status)}">${a.status || '-'}</span></td>
                    </tr>`;
                }).join('');
            } else if (type === 'department') {
                html = data.map(d => `<tr>
                    <td>Department</td>
                    <td>${d.employees}</td>
                    <td>${d.department}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>${d.count} assignment${d.count !== 1 ? 's' : ''}</td>
                    <td>-</td>
                </tr>`).join('');
            } else if (type === 'site') {
                html = data.map(s => `<tr>
                    <td>Site</td>
                    <td>${s.employees}</td>
                    <td>-</td>
                    <td>${s.site}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>${s.count} assignment${s.count !== 1 ? 's' : ''}</td>
                    <td>-</td>
                </tr>`).join('');
            } else if (type === 'daily') {
                html = data.map(d => `<tr>
                    <td>Daily</td>
                    <td>${d.employees}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>${d.date}</td>
                    <td>-</td>
                    <td>${d.count} check-in${d.count !== 1 ? 's' : ''}</td>
                    <td>-</td>
                </tr>`).join('');
            }
            tbody.innerHTML = html;
            
            // Show summary stats and potentially chart
            displayReportSummary(type, data);
            displayReportChart(type, data);
        }

        // Helper: Get CSS class for status badges
        function getStatusClass(status) {
            const classes = {
                'assigned': 'status-assigned',
                'checked_in': 'status-occupied',
                'checked_out': 'status-completed',
                'cancelled': 'status-maintenance'
            };
            return classes[status] || '';
        }

        // Display summary statistics
        function displayReportSummary(type, data) {
            // Requested: remove the summary text above the table.
            const summaryDiv = document.getElementById('reportSummaryStats');
            if (summaryDiv) {
                summaryDiv.innerHTML = '';
                summaryDiv.style.display = 'none';
            }
        }

        // Display chart visualization
        function displayReportChart(type, data) {
            const canvas = document.getElementById('reportChartCanvas');
            if (!canvas || !data.length) return;
            
            // Destroy existing chart if any
            if (window.__reportChart) {
                window.__reportChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            let chartConfig = null;
            
            const preferred = window.__camp_reportingChartType || 'auto';
            if (type === 'department') {
                chartConfig = {
                    type: preferred !== 'auto' ? preferred : 'bar',
                    data: {
                        labels: data.map(d => d.department),
                        datasets: [{
                            label: 'Assignments',
                            data: data.map(d => d.count),
                            backgroundColor: 'rgba(37, 99, 235, 0.6)',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Assignments by Department' } }
                    }
                };
            } else if (type === 'site') {
                chartConfig = {
                    type: preferred !== 'auto' ? preferred : 'doughnut',
                    data: {
                        labels: data.map(s => s.site),
                        datasets: [{
                            data: data.map(s => s.count),
                            backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Assignments by Site' } }
                    }
                };
            } else if (type === 'daily') {
                chartConfig = {
                    type: preferred !== 'auto' ? preferred : 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Check-ins',
                            data: data.map(d => d.count),
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Daily Check-ins' } }
                    }
                };
            }
            
            if (chartConfig) {
                window.__reportChart = new Chart(ctx, chartConfig);
                canvas.style.display = 'block';
            } else {
                canvas.style.display = 'none';
            }
        }

        // Export functions
        function exportReportAsCSV() {
            // If A4 is shown, export the A4 table to honor column order/pivot
            const a4Container = document.getElementById('a4ReportContainer');
            const a4Active = a4Container && a4Container.classList.contains('show');
            const table = a4Active ? document.getElementById('a4ReportTable') : document.getElementById('reportTable');
            if (!table) return;
            
            let csv = '';
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = [];
                cells.forEach(cell => {
                    // Clean text content (remove HTML tags and normalize)
                    let text = cell.textContent || cell.innerText || '';
                    text = text.replace(/"/g, '""'); // Escape quotes
                    rowData.push(`"${text}"`);
                });
                csv += rowData.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `accommodation-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('CSV report exported successfully!', 'success');
        }

        function exportReportAsPDF() {
            // Simple PDF export using window.print for now
            // You can enhance this with jsPDF library later
            const originalTitle = document.title;
            document.title = 'Accommodation Report';
            
            // Hide non-essential elements temporarily
            const elementsToHide = document.querySelectorAll('.sidebar, .top-nav, .page-header, .table-header, .search-filters, .btn');
            elementsToHide.forEach(el => el.style.display = 'none');
            
            // Show only the report content
            const reportContent = document.getElementById('reportingContent');
            const originalStyle = reportContent.style.cssText;
            reportContent.style.cssText = 'margin: 0; padding: 20px;';
            
            // Print
            window.print();
            
            // Restore
            document.title = originalTitle;
            elementsToHide.forEach(el => el.style.display = '');
            reportContent.style.cssText = originalStyle;
            
            showNotification('PDF export initiated. Please check your browser\'s print dialog.', 'info');
        }

        // =================== Report Designer (Placeholders + Live Apply) ===================
        const RD_CFG_KEY = 'camp_report_designer_v1';
        function rdDefault(){
            return {
                theme: 'classic',
                columns: getActiveA4Fields(),
                pivot: getSavedPivot(),
                quick: { status:'', location:'' },
                placeholders: {
                    showCompany:true,
                    title:'',
                    subtitle:'',
                    showDatePeriod:true,
                    showSummary:true,
                    summaryChips:['total','checked_in','checked_out'],
                    footerText:'Generated by Dreamex Datalab Accommodation System'
                }
            };
        }
        function rdLoad(){ try{ const raw=localStorage.getItem(RD_CFG_KEY); const obj=raw?JSON.parse(raw):null; return obj||rdDefault(); }catch(e){ return rdDefault(); } }
        function rdSave(cfg){ try{ localStorage.setItem(RD_CFG_KEY, JSON.stringify(cfg)); }catch(e){} }
        function rdOpen(open){
            const overlay=document.getElementById('reportDesignerOverlay');
            const panel=document.getElementById('reportDesignerPanel');
            const show = open===undefined ? !panel.classList.contains('show') : !!open;
            overlay.classList[show?'add':'remove']('show');
            panel.classList[show?'add':'remove']('show');
            panel.setAttribute('aria-hidden', show? 'false':'true');
        }
        function rdRenderFields(cfg){
            const availEl=document.getElementById('rdAvailableFields');
            const colsEl=document.getElementById('rdColumnsList');
            if(!availEl||!colsEl) return;
            // Available = A4_AVAILABLE_FIELDS not currently selected
            const selected=new Set(cfg.columns);
            availEl.innerHTML = A4_AVAILABLE_FIELDS
                .filter(f=>!selected.has(f.key))
                .map(f=>`<span class="rd-chip" data-key="${f.key}">${f.label} <button title="Add" data-act="add">+</button></span>`).join('');
            colsEl.innerHTML = cfg.columns
                .map(k=>{
                    const f=A4_AVAILABLE_FIELDS.find(x=>x.key===k); if(!f) return '';
                    return `<span class="rd-chip" data-key="${k}"><span>${f.label}</span> <span class="rd-order-controls"><button data-act="up">?</button><button data-act="down">?</button><button data-act="remove">?</button></span></span>`;
                }).join('');
            // Bind clicks
            availEl.onclick=(e)=>{
                const btn=e.target.closest('button[data-act="add"]'); if(!btn) return;
                const key=btn.parentElement.getAttribute('data-key');
                if(!cfg.columns.includes(key)) cfg.columns.push(key);
                rdSave(cfg); rdRenderFields(cfg);
            };
            colsEl.onclick=(e)=>{
                const chip=e.target.closest('.rd-chip'); if(!chip) return;
                const key=chip.getAttribute('data-key');
                const idx=cfg.columns.indexOf(key);
                const act=e.target.getAttribute('data-act');
                if(act==='remove' && idx>-1){ cfg.columns.splice(idx,1); }
                else if(act==='up' && idx>0){ const t=cfg.columns[idx-1]; cfg.columns[idx-1]=cfg.columns[idx]; cfg.columns[idx]=t; }
                else if(act==='down' && idx<cfg.columns.length-1){ const t=cfg.columns[idx+1]; cfg.columns[idx+1]=cfg.columns[idx]; cfg.columns[idx]=t; }
                rdSave(cfg); rdRenderFields(cfg);
            };
        }
        function rdSyncPivotUI(cfg){
            // Designer pivot controls mirror A4 pivot
            const row=document.getElementById('rdPivotRow');
            const col=document.getElementById('rdPivotCol');
            const met=document.getElementById('rdPivotMetric');
            const en=document.getElementById('rdPivotEnable');
            const rt=document.getElementById('rdRowTotals');
            const ct=document.getElementById('rdColTotals');
            if(!row||!col||!met||!en||!rt||!ct) return;
            row.innerHTML = A4_PIVOT_FIELDS.map(x=>`<option value="${x.key}" ${x.key===cfg.pivot.row?'selected':''}>${x.label}</option>`).join('');
            col.innerHTML = A4_PIVOT_FIELDS.map(x=>`<option value="${x.key}" ${x.key===cfg.pivot.col?'selected':''}>${x.label}</option>`).join('');
            met.innerHTML = A4_PIVOT_METRICS.map(x=>`<option value="${x.key}" ${x.key===cfg.pivot.metric?'selected':''}>${x.label}</option>`).join('');
            en.checked = !!cfg.pivot.enabled; rt.checked=!!cfg.pivot.rowTotals; ct.checked=!!cfg.pivot.colTotals;
        }
        async function rdInit(){
            const btnOpen=document.getElementById('openReportDesignerBtn');
            const btnClose=document.getElementById('closeReportDesignerBtn');
            const overlay=document.getElementById('reportDesignerOverlay');
            const themeBtns=[...document.querySelectorAll('.rd-theme button[data-theme]')];
            const statusSel=document.getElementById('rdFilterStatus');
            const locSel=document.getElementById('rdFilterLocation');
            const titleEl=document.getElementById('rdTitle');
            const subtitleEl=document.getElementById('rdSubtitle');
            const showCompanyEl=document.getElementById('rdShowCompany');
            const showPeriodEl=document.getElementById('rdShowPeriod');
            const showSummaryEl=document.getElementById('rdShowSummary');
            const chipTotal=document.getElementById('rdChipTotal');
            const chipIn=document.getElementById('rdChipCheckedIn');
            const chipOut=document.getElementById('rdChipCheckedOut');
            const footerEl=document.getElementById('rdFooterText');
            const applyBtn=document.getElementById('rdApplyBtn');
            const resetBtn=document.getElementById('rdResetBtn');
            const saveBtn=document.getElementById('rdSaveBtn');

            if(!btnOpen) return; // Designer markup not present
            const cfg=rdLoad();

            // Populate locations for quick filter
            try {
                const idx=await getRoomsIndex();
                const locations=[...new Set(Object.values(idx).map(v=> v?.location?.name || v?.location?.block || '').filter(Boolean))].sort();
                locations.forEach(l=>{ const opt=document.createElement('option'); opt.value=l; opt.textContent=l; locSel?.appendChild(opt); });
            } catch(_){ }

            // Initialize theme buttons
            themeBtns.forEach(b=>{ b.classList.toggle('active', b.getAttribute('data-theme')===cfg.theme); b.onclick=()=>{ themeBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); cfg.theme=b.getAttribute('data-theme'); rdSave(cfg); }; });

            // Initialize quick filters
            if(statusSel) statusSel.value = cfg.quick.status || '';
            if(locSel) locSel.value = cfg.quick.location || '';

            // Initialize placeholders
            if(titleEl) titleEl.value = cfg.placeholders.title || '';
            if(subtitleEl) subtitleEl.value = cfg.placeholders.subtitle || '';
            if(showCompanyEl) showCompanyEl.checked = cfg.placeholders.showCompany !== false;
            if(showPeriodEl) showPeriodEl.checked = cfg.placeholders.showDatePeriod !== false;
            if(showSummaryEl) showSummaryEl.checked = cfg.placeholders.showSummary !== false;
            if(chipTotal) chipTotal.checked = cfg.placeholders.summaryChips.includes('total');
            if(chipIn) chipIn.checked = cfg.placeholders.summaryChips.includes('checked_in');
            if(chipOut) chipOut.checked = cfg.placeholders.summaryChips.includes('checked_out');
            if(footerEl) footerEl.value = cfg.placeholders.footerText || '';

            // Render fields & pivot
            rdRenderFields(cfg);
            rdSyncPivotUI(cfg);

            // Events
            btnOpen.onclick=()=> rdOpen(true);
            btnClose.onclick=()=> rdOpen(false);
            overlay.onclick=()=> rdOpen(false);

            const onChange=()=>{ // persist quick + placeholders
                cfg.quick.status = statusSel?.value || '';
                cfg.quick.location = locSel?.value || '';
                cfg.placeholders.title = titleEl?.value || '';
                cfg.placeholders.subtitle = subtitleEl?.value || '';
                cfg.placeholders.showCompany = !!(showCompanyEl?.checked ?? true);
                cfg.placeholders.showDatePeriod = !!(showPeriodEl?.checked ?? true);
                cfg.placeholders.showSummary = !!(showSummaryEl?.checked ?? true);
                const chips=[]; if(chipTotal?.checked) chips.push('total'); if(chipIn?.checked) chips.push('checked_in'); if(chipOut?.checked) chips.push('checked_out');
                cfg.placeholders.summaryChips = chips;
                cfg.placeholders.footerText = footerEl?.value || '';
                rdSave(cfg);
            };
            [statusSel,locSel,titleEl,subtitleEl,showCompanyEl,showPeriodEl,showSummaryEl,chipTotal,chipIn,chipOut,footerEl].forEach(el=> el && el.addEventListener('change', onChange));

            document.getElementById('rdPivotRow')?.addEventListener('change', e=>{ cfg.pivot.row=e.target.value; rdSave(cfg); });
            document.getElementById('rdPivotCol')?.addEventListener('change', e=>{ cfg.pivot.col=e.target.value; rdSave(cfg); });
            document.getElementById('rdPivotMetric')?.addEventListener('change', e=>{ cfg.pivot.metric=e.target.value; rdSave(cfg); });
            document.getElementById('rdPivotEnable')?.addEventListener('change', e=>{ cfg.pivot.enabled=e.target.checked; rdSave(cfg); });
            document.getElementById('rdRowTotals')?.addEventListener('change', e=>{ cfg.pivot.rowTotals=e.target.checked; rdSave(cfg); });
            document.getElementById('rdColTotals')?.addEventListener('change', e=>{ cfg.pivot.colTotals=e.target.checked; rdSave(cfg); });

            resetBtn&& (resetBtn.onclick=()=>{ const d=rdDefault(); rdSave(d); rdRenderFields(d); rdSyncPivotUI(d); themeBtns.forEach(x=>x.classList.remove('active')); document.querySelector(`.rd-theme button[data-theme="${d.theme}"]`)?.classList.add('active'); // reset inputs
                if(statusSel) statusSel.value=''; if(locSel) locSel.value=''; if(titleEl) titleEl.value=''; if(subtitleEl) subtitleEl.value=''; if(showCompanyEl) showCompanyEl.checked=true; if(showPeriodEl) showPeriodEl.checked=true; if(showSummaryEl) showSummaryEl.checked=true; if(chipTotal) chipTotal.checked=true; if(chipIn) chipIn.checked=true; if(chipOut) chipOut.checked=true; if(footerEl) footerEl.value=d.placeholders.footerText; });
            saveBtn&& (saveBtn.onclick=()=>{ rdSave(rdLoad()); showNotification('Report Designer settings saved','success'); });
            applyBtn&& (applyBtn.onclick=()=> rdApplyToA4());
        }
        function applyRDQuickFilters(rows){
            const cfg=rdLoad();
            let list = Array.isArray(rows)? rows : [];
            if(cfg.quick.status){ list = list.filter(r=> (r.status||'')===cfg.quick.status); }
            if(cfg.quick.location){ list = list.filter(r=> (r.location||'')===cfg.quick.location); }
            return list;
        }
        function rdApplyToA4(){
            const cfg=rdLoad();
            // Persist A4 columns and pivot
            saveA4Fields(cfg.columns && cfg.columns.length? cfg.columns : getDefaultA4Fields());
            savePivot(cfg.pivot||getSavedPivot());
            // Theme class on A4 container
            const a4=document.getElementById('a4ReportContainer');
            if(a4){ a4.classList.remove('theme-classic','theme-midnight','theme-forest','theme-sunset'); a4.classList.add(`theme-${cfg.theme||'classic'}`); }
            // Show A4 and render
            if(a4 && !a4.classList.contains('show')){ toggleA4Format(); }
            populateA4Report();
            rdOpen(false);
            showNotification('Applied to A4','success');
        }
        // Auto-init Designer after page load
        document.addEventListener('DOMContentLoaded', ()=>{ try{ rdInit(); }catch(_){ } });

        // A4 Format Functions
        function toggleA4Format() {
            const a4Container = document.getElementById('a4ReportContainer');
            const regularContent = document.querySelector('#reportingContent .table-wrapper');
            
            if (a4Container.classList.contains('show')) {
                // Hide A4 format, show regular view
                a4Container.classList.remove('show');
                regularContent.style.display = 'block';
            } else {
                // Show A4 format, hide regular view
                a4Container.classList.add('show');
                regularContent.style.display = 'none';
                // Populate A4 format with current report data
                populateA4Report();
            }
        }

        // Open A4 in a modal: move the A4 container into the modal mount
        function openA4PreviewModal() {
            const modal = document.getElementById('a4PreviewModal');
            const mount = document.getElementById('a4PreviewMount');
            const a4 = document.getElementById('a4ReportContainer');
            if (!modal || !mount || !a4) return;
            // Ensure A4 content is prepared
            if (!a4.classList.contains('show')) {
                a4.classList.add('show');
            }
            populateA4Report();
            // Move A4 into modal
            mount.innerHTML = '';
            mount.appendChild(a4);
            // Show modal
            modal.setAttribute('aria-hidden','false');
            modal.classList.add('show');
        }

        // Close modal and move A4 back to its home wrapper
        function closeA4PreviewModal() {
            const modal = document.getElementById('a4PreviewModal');
            const home = document.getElementById('a4ReportHome');
            const a4 = document.getElementById('a4ReportContainer');
            if (!modal || !home || !a4) return;
            // Hide modal
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden','true');
            // Move A4 back and hide
            home.appendChild(a4);
            a4.classList.remove('show');
        }

        function populateA4Report() {
            const reportType = document.getElementById('reportTypeSelect')?.value || 'all';
            // Use modal fields (page controls were removed)
            const startDate = document.getElementById('modalReportStartDate')?.value || '';
            const endDate = document.getElementById('modalReportEndDate')?.value || '';
            const rdCfg = (typeof rdLoad==='function') ? rdLoad() : null;
            
            // Update A4 report metadata
            const companyNameEl = document.getElementById('a4CompanyName');
            const titleEl = document.getElementById('a4ReportTitle');
            const subtitleEl = document.getElementById('a4ReportSubtitle');
            const dateSpan = document.getElementById('a4ReportDate');
            const footer = document.querySelector('.a4-report-footer small');

            const companyName = window.authManager?.currentUser?.companyName || 'Company Name';
            if(companyNameEl){ companyNameEl.textContent = companyName; companyNameEl.style.display = (rdCfg && rdCfg.placeholders && rdCfg.placeholders.showCompany===false) ? 'none' : ''; }

            const baseTitle = getA4ReportTitle(reportType);
            const customTitle = rdCfg?.placeholders?.title || '';
            if(titleEl) titleEl.textContent = customTitle || baseTitle;
            if(dateSpan) dateSpan.textContent = new Date().toLocaleDateString();
            
            // Update subtitle with date range and clicked group period key if any
            let subtitle = rdCfg?.placeholders?.subtitle || `Generated on ${new Date().toLocaleDateString()}`;
            const period = (startDate || endDate) ? ` | Period: ${startDate || 'Start'} to ${endDate || 'End'}` : '';
            const clickCtx = window.__camp_a4_click_ctx || null;
            const periodKeyText = clickCtx && clickCtx.periodKey ? ` | ${String(clickCtx.periodType||'').toUpperCase()}: ${clickCtx.periodKey}` : '';
            if(rdCfg?.placeholders?.showDatePeriod===false){
                // omit period
            } else {
                subtitle += period + periodKeyText;
            }
            if(subtitleEl) subtitleEl.innerHTML = subtitle;
            if(footer && rdCfg?.placeholders?.footerText){ footer.textContent = rdCfg.placeholders.footerText; }
            
            // Populate summary stats
            populateA4SummaryStats();
            
            // Populate table
            populateA4Table();
        }

        function getA4ReportTitle(reportType) {
            // Prefer modal selections or clicked row context
            const mPSel = document.getElementById('modalReportPeriodSelect');
            const mDSel = document.getElementById('modalReportDimensionSelect');
            let period = mPSel?.value || null;
            let dim = mDSel?.value || '';
            let periodKey = null;
            let dimKey = null;
            const clickCtx = window.__camp_a4_click_ctx || null;
            if (clickCtx) {
                period = clickCtx.periodType || period;
                dim = typeof clickCtx.dim === 'string' ? clickCtx.dim : dim;
                periodKey = clickCtx.periodKey || null;
                dimKey = clickCtx.dimKey || null;
            }
            if (period) {
                const periodLabel = period === 'daily' ? 'Daily' : period === 'monthly' ? 'Monthly' : period === 'yearly' ? 'Yearly' : 'Custom Period';
                const dimLabel = dim === 'site' ? 'by Site' : dim === 'department' ? 'by Department' : dim === 'employee' ? 'by Employee' : 'Overall';
                const suffix = [];
                if (periodKey) suffix.push(String(periodKey));
                if (dim && dim !== '' && dimKey) suffix.push(`${dimLabel.replace('by ','')}: ${dimKey}`);
                const tail = suffix.length ? `  ${suffix.join(' | ')}` : '';
                return `${periodLabel} Accommodation Report ${dimLabel !== 'Overall' ? '('+dimLabel+')' : ''}${tail}`.trim();
            }
            const titles = {
                'employee': 'Employee Stay Report',
                'department': 'Department Summary Report', 
                'site': 'Site/Location Report',
                'daily': 'Daily Accommodation Report',
                'all': 'Complete Accommodation Report'
            };
            return titles[reportType] || 'Accommodation Report';
        }

        function populateA4SummaryStats() {
            const summaryStatsEl = document.getElementById('reportSummaryStats');
            const a4SummaryStatsEl = document.getElementById('a4SummaryStats');
            const rdCfg = (typeof rdLoad==='function') ? rdLoad() : null;
            
            if (summaryStatsEl && summaryStatsEl.style.display !== 'none') {
                // Extract stats from the regular summary
                const statsText = summaryStatsEl.textContent || '';
                const statItems = statsText.split('|').map(s => s.trim()).filter(s => s);
                
                let a4StatsHTML = '';
                statItems.forEach(stat => {
                    const parts = stat.split(':');
                    if (parts.length === 2) {
                        a4StatsHTML += `
                            <div class="a4-stat-item">
                                <div class="a4-stat-label">${parts[0].trim()}</div>
                                <div class="a4-stat-value">${parts[1].trim()}</div>
                            </div>
                        `;
                    }
                });
                
                a4SummaryStatsEl.innerHTML = a4StatsHTML;
            } else {
                // Build from current report data and RD chips
                const rows = Array.isArray(window.__camp_reportingData)? window.__camp_reportingData : [];
                const list = (typeof applyRDQuickFilters==='function') ? applyRDQuickFilters(rows) : rows;
                const total = list.length;
                const checkedIn = list.filter(r=> r.status==='checked_in').length;
                const checkedOut = list.filter(r=> r.status==='checked_out').length;
                const chips = rdCfg?.placeholders?.summaryChips || [];
                const parts = [];
                if(chips.includes('total')) parts.push({label:'Total Assignments', value: total});
                if(chips.includes('checked_in')) parts.push({label:'Checked In', value: checkedIn});
                if(chips.includes('checked_out')) parts.push({label:'Checked Out', value: checkedOut});
                if(rdCfg && rdCfg.placeholders && rdCfg.placeholders.showSummary===false){
                    a4SummaryStatsEl.innerHTML = '';
                } else if(parts.length){
                    a4SummaryStatsEl.innerHTML = parts.map(p=>`<div class="a4-stat-item"><div class="a4-stat-label">${p.label}</div><div class="a4-stat-value">${p.value}</div></div>`).join('');
                } else {
                    a4SummaryStatsEl.innerHTML = '';
                }
            }
        }

        function populateA4Table() {
            const regularTable = document.getElementById('reportTable');
            const a4TableHeader = document.getElementById('a4ReportTableHeader');
            const a4TableBody = document.getElementById('a4ReportTableBody');
            
            if (!regularTable) return;
            // If pivot mode is enabled, render pivot and return
            const pivotCfg = getSavedPivot();
            if (pivotCfg && pivotCfg.enabled) {
                const data = Array.isArray(window.__camp_reportingData) ? window.__camp_reportingData : [];
                const rowKey = pivotCfg.row;
                const colKey = pivotCfg.col;
                const metric = pivotCfg.metric;
                // Collect distinct keys
                const rows = [];
                const cols = [];
                const rowSet = new Set();
                const colSet = new Set();
                const getVal = (r,k)=>{
                    if(k==='date'){ const d=(r.actualCheckInDate||r.checkInDate||'').split('T')[0]; return d||'-'; }
                    if(k==='employee'){ return r.employeeName||r.employee||'-'; }
                    if(k==='room'){ return r.room||r.roomNumber||'-'; }
                    return r[k] || '-';
                };
                const grid = new Map(); // rowVal -> Map(colVal -> count)
                data.forEach(r => {
                    const rk = rowKey==='none' ? 'All' : getVal(r,rowKey);
                    const ck = colKey==='none' ? 'All' : getVal(r,colKey);
                    if(!rowSet.has(rk)){ rowSet.add(rk); rows.push(rk); }
                    if(!colSet.has(ck)){ colSet.add(ck); cols.push(ck); }
                    const rowMap = grid.get(rk) || new Map();
                    const prev = rowMap.get(ck) || 0;
                    const inc = (metric==='checkedIn') ? (r.status==='checked_in' ? 1 : 0) : 1;
                    rowMap.set(ck, prev + inc);
                    grid.set(rk, rowMap);
                });
                // Build header
                const headerCells = [labelFor(A4_PIVOT_FIELDS,rowKey), ...cols.map(c=>escapeHtml(String(c)))];
                if(pivotCfg.rowTotals) headerCells.push('Total');
                a4TableHeader.innerHTML = headerCells.map(h=>`<th>${h}</th>`).join('');
                // Build rows
                let bodyHTML='';
                rows.forEach(rk => {
                    const rowMap = grid.get(rk) || new Map();
                    let total = 0;
                    const tds = cols.map(ck => { const val = rowMap.get(ck)||0; total+=val; return `<td>${val}</td>`; });
                    if(pivotCfg.rowTotals) tds.push(`<td>${total}</td>`);
                    bodyHTML += `<tr><td>${escapeHtml(String(rk))}</td>${tds.join('')}</tr>`;
                });
                // Column totals
                if(pivotCfg.colTotals){
                    let rowLabel = 'Total';
                    const totals = cols.map(ck => {
                        let sum=0; rows.forEach(rk=>{ const v=(grid.get(rk)||new Map()).get(ck)||0; sum+=v; });
                        return `<td>${sum}</td>`; 
                    });
                    if(pivotCfg.rowTotals){ const grand = totals.reduce((s,td)=> s + parseInt(td.replace(/[^0-9-]/g,''),10), 0); totals.push(`<td>${grand}</td>`);} 
                    bodyHTML += `<tr><td>${rowLabel}</td>${totals.join('')}</tr>`;
                }
                a4TableBody.innerHTML = bodyHTML || `<tr><td colspan="${(cols.length+1+(pivotCfg.rowTotals?1:0))||1}" style="text-align:center;padding:20px;">No data available for this report</td></tr>`;
                return; 
            }

            // Determine selected columns
            const selectedKeys = getActiveA4Fields();
            const fieldsMap = new Map(A4_AVAILABLE_FIELDS.map(f=>[f.key,f]));
            const activeFields = selectedKeys.map(k=>fieldsMap.get(k)).filter(Boolean);

            // Build headers from selected fields
            a4TableHeader.innerHTML = activeFields.map(f => `<th>${f.label}</th>`).join('');

            // Prefer data source from generator if available
            let rowsSource = window.__camp_reportingData || [];
            // If a row context was clicked, filter source rows to that group
            const ctx = window.__camp_a4_click_ctx || null;
            if (ctx && Array.isArray(rowsSource) && rowsSource.length) {
                const getDay = (r)=> (r.actualCheckInDate||r.checkInDate||'').split('T')[0] || '';
                const toMonth = (d)=>{ if(!d) return ''; const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; };
                const toYear = (d)=>{ if(!d) return ''; const dt=new Date(d); return String(dt.getFullYear()); };
                rowsSource = rowsSource.filter(r => {
                    const day = getDay(r);
                    const pMatch = ctx.periodType === 'daily' ? (day === ctx.periodKey) : ctx.periodType === 'monthly' ? (toMonth(day) === ctx.periodKey) : ctx.periodType === 'yearly' ? (toYear(day) === ctx.periodKey) : true;
                    if (!pMatch) return false;
                    if (!ctx.dim) return true;
                    if (ctx.dim === 'employee') { const val = r.employeeName || r.employee || '-'; return String(val) === String(ctx.dimKey); }
                    if (ctx.dim === 'department') { const val = r.department || '-'; return String(val) === String(ctx.dimKey); }
                    if (ctx.dim === 'site') { const val = r.location || '-'; return String(val) === String(ctx.dimKey); }
                    return true;
                });
            }
            // Apply quick filters from Designer
            rowsSource = (typeof applyRDQuickFilters==='function') ? applyRDQuickFilters(rowsSource) : rowsSource;
            let a4BodyHTML = '';

            if (Array.isArray(rowsSource) && rowsSource.length) {
                rowsSource.forEach(r => {
                    const cells = activeFields.map(f=>escapeHtml(String((f.accessor(r)||'')).trim()));
                    a4BodyHTML += `<tr>${cells.map(c=>`<td>${c}</td>`).join('')}</tr>`;
                });
            } else {
                // Fallback to scraping existing table
                const headerRow = regularTable.querySelector('thead tr');
                const headerCells = headerRow? Array.from(headerRow.querySelectorAll('th')).map(th=>th.textContent.trim()) : [];
                const indexMap = activeFields.map(f=> headerCells.findIndex(h=> h.toLowerCase().includes(f.label.toLowerCase().split(' ')[0])) ).map(i=> i<0?null:i);
                const bodyRows = regularTable.querySelectorAll('tbody tr');
                bodyRows.forEach(row => {
                    const tds = Array.from(row.querySelectorAll('td'));
                    const values = indexMap.map(i=> i==null?'': (tds[i]?.textContent||'').trim());
                    if(values.length && values.some(v=>v)){
                        a4BodyHTML += `<tr>${values.map(v=>`<td>${escapeHtml(v)}</td>`).join('')}</tr>`;
                    }
                });
            }
            if (!a4BodyHTML) {
                a4BodyHTML = `<tr><td colspan="${activeFields.length||1}" style="text-align:center;padding:20px;">No data available for this report</td></tr>`;
            }
            a4TableBody.innerHTML = a4BodyHTML;
        }

        // Enhanced PDF export for A4 format
        function exportA4ReportAsPDF() {
            const a4Container = document.getElementById('a4ReportContainer');
            if (!a4Container.classList.contains('show')) {
                showNotification('Please switch to A4 format view first', 'warning');
                return;
            }
            
            const originalTitle = document.title;
            document.title = 'Accommodation Report - A4 Format';
            
            // Hide all other elements
            const elementsToHide = document.querySelectorAll('body > *:not(#a4ReportContainer)');
            elementsToHide.forEach(el => el.style.display = 'none');
            
            // Show only A4 container
            a4Container.style.display = 'block';
            a4Container.style.position = 'static';
            a4Container.style.margin = '0';
            a4Container.style.boxShadow = 'none';
            
            // Print
            window.print();
            
            // Restore
            document.title = originalTitle;
            elementsToHide.forEach(el => el.style.display = '');
            a4Container.style.position = 'relative';
            a4Container.style.margin = '0 auto';
            a4Container.style.boxShadow = '0 0 20px rgba(0, 0, 0, 0.1)';
            
            showNotification('A4 PDF export initiated. Check your browser\'s print dialog.', 'success');
        }

        // =================== END REPORTING TAB LOGIC ===================

        // Load archived (checked out) assignments
        async function loadArchivesData() {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    console.log('No authenticated user for loading archives');
                    return;
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.log('No company ID found');
                    return;
                }
                
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.once('value');
                
                const tableBody = document.querySelector('#archivesTable tbody');
                if (!tableBody) return;
                
                // Clear existing rows
                tableBody.innerHTML = '';
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    // Filter for checked_out status only
                    let archivedAssignments = Object.values(assignments)
                        .filter(assignment => assignment.status === 'checked_out')
                        .sort((a, b) => new Date(b.actualCheckOutDate || b.lastUpdated) - new Date(a.actualCheckOutDate || a.lastUpdated));

                    // Apply per-user visibility: only allowed location blocks
                    const [{ set: allowedLocations, configured }, roomsIdx] = await Promise.all([
                        getAllowedLocationsForCurrentUser(),
                        getRoomsIndex()
                    ]);
                    archivedAssignments = archivedAssignments.filter(a => {
                        const roomNum = a.roomNumber || a.room || a.roomCode;
                        const meta = roomsIdx[String(roomNum)] || null;
                        const block = meta && meta.location ? meta.location.block : null;
                        return block && allowedLocations.has(block);
                    });
                    
                    // Apply search filter
                    const searchTerm = document.getElementById('searchArchives')?.value?.toLowerCase() || '';
                    if (searchTerm) {
                        archivedAssignments = archivedAssignments.filter(assignment => 
                            assignment.employeeName?.toLowerCase().includes(searchTerm) ||
                            assignment.roomNumber?.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Apply room filter
                    const roomFilter = document.getElementById('filterArchiveRoom')?.value || '';
                    if (roomFilter) {
                        archivedAssignments = archivedAssignments.filter(assignment => 
                            assignment.roomNumber === roomFilter
                        );
                    }
                    
                    // Apply date filter
                    const dateFilter = document.getElementById('filterArchiveDate')?.value || '';
                    if (dateFilter) {
                        const filterDate = new Date(dateFilter).toDateString();
                        archivedAssignments = archivedAssignments.filter(assignment => {
                            const checkOutDate = assignment.actualCheckOutDate ? 
                                new Date(assignment.actualCheckOutDate).toDateString() : '';
                            return checkOutDate === filterDate;
                        });
                    }
                    
                    // Use cached action permissions (consistent with active table)
                    const actionPerms = getCampActionPerms();
                    const canDelete = actionPerms.delete;
                    const canEdit = actionPerms.edit;

                    if (archivedAssignments.length > 0) {
                        // Resolve locations for each row asynchronously
                        const rows = await Promise.all(archivedAssignments.map(async (assignment) => {
                            const row = document.createElement('tr');
                            const checkInDate = assignment.actualCheckInDate ? 
                                new Date(assignment.actualCheckInDate).toLocaleDateString() : '-';
                            const checkOutDate = assignment.actualCheckOutDate ? 
                                new Date(assignment.actualCheckOutDate).toLocaleDateString() : '-';

                            // Calculate duration
                            let duration = '-';
                            if (assignment.actualCheckInDate && assignment.actualCheckOutDate) {
                                const days = Math.ceil((new Date(assignment.actualCheckOutDate) - new Date(assignment.actualCheckInDate)) / (1000 * 60 * 60 * 24));
                                duration = `${days} day${days !== 1 ? 's' : ''}`;
                            }

                            const location = await getRoomLocationDisplay(assignment.roomNumber);
                            row.innerHTML = `
                                <td>${assignment.roomNumber || '-'}</td>
                                <td>${location}</td>
                                <td>${assignment.employeeName || '-'}</td>
                                <td>${checkInDate}</td>
                                <td>${checkOutDate}</td>
                                <td>${duration}</td>
                                <td><span class="status-badge status-completed">Completed</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-info" onclick="viewAssignmentDetails('${assignment.id}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${canEdit ? `<button class="btn btn-sm btn-secondary" onclick="generateAssignmentReport('${assignment.id}')" title="Generate Report"><i class="fas fa-file-pdf"></i></button>` : ''}
                                        ${canDelete ? `<button class="btn btn-sm btn-danger" onclick="confirmDeleteAssignment('${assignment.id}')" title="Delete"><i class="fas fa-trash"></i></button>` : ''}
                                    </div>
                                </td>
                            `;
                            return row;
                        }));
                        rows.forEach(r => tableBody.appendChild(r));
                    } else {
                        const msg = configured ? 'No archived assignments found' : "Your room visibility is not configured. Please contact an administrator.";
                        tableBody.innerHTML = `<tr><td colspan="8" class="text-center">${msg}</td></tr>`;
                    }
                    
                    console.log(`? Loaded ${archivedAssignments.length} archived assignments`);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No archived assignments found</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading archived assignments:', error);
                const tableBody = document.querySelector('#archivesTable tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Error loading archived assignments</td></tr>';
                }
            }
        }

        // Load room assignments from Firebase and populate table
    async function loadRoomAssignmentsData() {
            try {
                if (!window.authManager || !window.authManager.currentUser) {
                    console.log('No authenticated user for loading assignments');
                    return;
                }
                
                const companyId = window.authManager.currentUser.companyId;
                if (!companyId) {
                    console.log('No company ID found');
                    return;
                }
                
                const assignmentsRef = window.authManager.db.ref(`companies/${companyId}/roomAssignments`);
                const snapshot = await assignmentsRef.once('value');
                
                const tableBody = document.querySelector('#assignmentsTable tbody');
                if (!tableBody) return;
                
                // Clear existing rows
                tableBody.innerHTML = '';
                
                if (snapshot.exists()) {
                    const assignments = snapshot.val();
                    // Filter out checked_out assignments (they belong in archives)
                    let assignmentArray = Object.values(assignments)
                        .filter(assignment => assignment.status !== 'checked_out')
                        .sort((a, b) => 
                            new Date(b.lastUpdated || b.assignedDate) - new Date(a.lastUpdated || a.assignedDate)
                        );
                    
                    // Apply per-user visibility: only allowed location blocks
                    const [{ set: allowedLocations, configured }, roomsIdx] = await Promise.all([
                        getAllowedLocationsForCurrentUser(),
                        getRoomsIndex()
                    ]);
                    assignmentArray = assignmentArray.filter(a => {
                        const roomNum = a.roomNumber || a.room || a.roomCode;
                        const meta = roomsIdx[String(roomNum)] || null;
                        const block = meta && meta.location ? meta.location.block : null;
                        return block && allowedLocations.has(block);
                    });
                    
                    // Apply filters
                    assignmentArray = applyAssignmentFilters(assignmentArray);
                    
                    // Populate room filter dropdown using the same visibility-filtered list
                    populateRoomFilter(assignmentArray);
                    
                    // Use cached action permissions (already loaded on page init)
                    const actionPerms = getCampActionPerms();

                    if (assignmentArray.length > 0) {
                        const rows = await Promise.all(assignmentArray.map(async (assignment) => {
                            const row = document.createElement('tr');
                            row.style.cursor = 'pointer';
                            row.title = 'Click to view details';
                            row.onclick = (e) => {
                                // Don't open details if clicking on checkbox or action buttons
                                if (e.target.closest('.row-checkbox-cell') || e.target.closest('.action-buttons') || e.target.closest('button')) return;
                                openAssignmentDetails(assignment.id);
                            };
                            const statusBadge = getStatusBadge(assignment.status);
                            const checkInDate = assignment.actualCheckInDate ? 
                                new Date(assignment.actualCheckInDate).toLocaleDateString() : '-';
                            const checkOutDate = assignment.actualCheckOutDate ? 
                                new Date(assignment.actualCheckOutDate).toLocaleDateString() : 
                                (assignment.checkOutDate ? new Date(assignment.checkOutDate).toLocaleDateString() : '-');

                            // Calculate period (duration)
                            let period = '-';
                            if (assignment.actualCheckInDate && assignment.actualCheckOutDate) {
                                const days = Math.ceil((new Date(assignment.actualCheckOutDate) - new Date(assignment.actualCheckInDate)) / (1000 * 60 * 60 * 24));
                                period = `${days} day${days !== 1 ? 's' : ''}`;
                            } else if (assignment.checkInDate && assignment.checkOutDate) {
                                const days = Math.ceil((new Date(assignment.checkOutDate) - new Date(assignment.checkInDate)) / (1000 * 60 * 60 * 24));
                                period = `${days} day${days !== 1 ? 's' : ''}`;
                            }

                            const location = await getRoomLocationDisplay(assignment.roomNumber);
                            const company = await resolveEmployerCompanyNameForAssignment(companyId, assignment);
                            row.innerHTML = `
                                <td class="row-checkbox-cell"><input type="checkbox" class="batch-checkbox row-checkbox" data-id="${assignment.id}" onclick="event.stopPropagation(); campToggleRowSelection(this)"></td>
                                <td>${assignment.roomNumber || '-'}</td>
                                <td>${location}</td>
                                <td>${escapeHtmlCamp(company)}</td>
                                <td>${assignment.employeeName || '-'}</td>
                                <td>${checkInDate}</td>
                                <td>${checkOutDate}</td>
                                <td>${period}</td>
                                <td>${statusBadge}</td>
                            `;
                            return row;
                        }));
                        rows.forEach(r => tableBody.appendChild(r));
                        
                        // Apply client-side column filters after rows are rendered
                        // Populate column filter dropdowns and apply filters
                        populateColumnFilterOptions();
                        applyColumnFiltersOnRows();
                    } else {
                        const msg = configured ? 'No assignments match the current filters' : "Your room visibility is not configured. Please contact an administrator.";
                        tableBody.innerHTML = `<tr><td colspan="10" class="text-center">${msg}</td></tr>`;
                    }
                    
                    console.log(`? Loaded ${assignmentArray.length} room assignments`);
                    
                    // Store assignments globally for reporting
                    window.__camp_lastAssignments = assignmentArray;
                    
                    // Re-apply batch actions visibility for the new rows
                    if (typeof window._canSeeCampBatchActions !== 'undefined') {
                        applyCampBatchActionsVisibility(window._canSeeCampBatchActions);
                    }
                } else {
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No room assignments found</td></tr>';
                    window.__camp_lastAssignments = [];
                }
                
            } catch (error) {
                console.error('Error loading rooms into dropdown:', error);
                const tableBody = document.querySelector('#assignmentsTable tbody');
                if (tableBody) {
                const cnt = document.getElementById('locationRoomCount');
                if (cnt) cnt.textContent = '0 rooms';
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading assignments</td></tr>';
                }
                window.__camp_lastAssignments = [];
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'assigned': '<span class="badge badge-info">Assigned</span>',
                'checked_in': '<span class="badge badge-success">Checked In</span>',
                'checked_out': '<span class="badge badge-secondary">Checked Out</span>',
                'cancelled': '<span class="badge badge-danger">Cancelled</span>'
            };
            return badges[status] || '<span class="badge badge-warning">Unknown</span>';
        }

        // Filter assignments based on search and filter criteria
        function applyAssignmentFilters(assignments) {
            const searchTerm = document.getElementById('searchAssignments')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const roomFilter = document.getElementById('filterRoom')?.value || '';

            return assignments.filter(assignment => {
                const matchesSearch = !searchTerm ||
                    (assignment.employeeName && assignment.employeeName.toLowerCase().includes(searchTerm)) ||
                    (assignment.roomNumber && assignment.roomNumber.toLowerCase().includes(searchTerm)) ||
                    (assignment.employeeEmail && assignment.employeeEmail.toLowerCase().includes(searchTerm));

                const matchesStatus = !statusFilter || assignment.status === statusFilter;
                const matchesRoom = !roomFilter || assignment.roomNumber === roomFilter;

                return matchesSearch && matchesStatus && matchesRoom;
            });
        }
        
        // Apply client-side column filters on visible table rows (for async-resolved columns like Location, Company)
        function applyColumnFiltersOnRows() {
            const tableBody = document.querySelector('#assignmentsTable tbody');
            if (!tableBody) return;
            
            // Get selected values for each filter (empty array = show all)
            const colRoomFilter = getColFilterCheckedValues('colFilterRoom');
            const colLocationFilter = getColFilterCheckedValues('colFilterLocation');
            const colCompanyFilter = getColFilterCheckedValues('colFilterCompany');
            const colEmployeeFilter = getColFilterCheckedValues('colFilterEmployee');
            const colCheckInFilter = getColFilterCheckedValues('colFilterCheckIn');
            const colCheckOutFilter = getColFilterCheckedValues('colFilterCheckOut');
            const colPeriodFilter = getColFilterCheckedValues('colFilterPeriod');
            const colStatusFilter = getColFilterCheckedValues('colFilterStatus');
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 9) return; // Skip empty/message rows
                
                // Column indices: 0=checkbox, 1=Room, 2=Location, 3=Company, 4=Employee, 5=CheckIn, 6=CheckOut, 7=Period, 8=Status
                const room = (cells[1]?.textContent || '').trim();
                const location = (cells[2]?.textContent || '').trim();
                const company = (cells[3]?.textContent || '').trim();
                const employee = (cells[4]?.textContent || '').trim();
                const checkIn = (cells[5]?.textContent || '').trim();
                const checkOut = (cells[6]?.textContent || '').trim();
                const period = (cells[7]?.textContent || '').trim();
                const statusCell = cells[8]?.textContent || '';
                // Extract status value from badge text
                const status = statusCell.toLowerCase().replace(/\s+/g, '_').trim();
                
                const matchesRoom = colRoomFilter.length === 0 || colRoomFilter.includes(room);
                const matchesLocation = colLocationFilter.length === 0 || colLocationFilter.includes(location);
                const matchesCompany = colCompanyFilter.length === 0 || colCompanyFilter.includes(company);
                const matchesEmployee = colEmployeeFilter.length === 0 || colEmployeeFilter.includes(employee);
                const matchesCheckIn = colCheckInFilter.length === 0 || colCheckInFilter.includes(checkIn);
                const matchesCheckOut = colCheckOutFilter.length === 0 || colCheckOutFilter.includes(checkOut);
                const matchesPeriod = colPeriodFilter.length === 0 || colPeriodFilter.includes(period);
                const matchesStatus = colStatusFilter.length === 0 || colStatusFilter.some(s => status.includes(s.replace('_', ' ')) || status.includes(s));
                
                row.style.display = (matchesRoom && matchesLocation && matchesCompany && matchesEmployee && matchesCheckIn && matchesCheckOut && matchesPeriod && matchesStatus) ? '' : 'none';
            });
        }
        
        // Populate column filter dropdowns with unique values from the table
        function populateColumnFilterOptions() {
            const tableBody = document.querySelector('#assignmentsTable tbody');
            if (!tableBody) return;
            
            const rows = tableBody.querySelectorAll('tr');
            const uniqueValues = {
                room: new Set(),
                location: new Set(),
                company: new Set(),
                employee: new Set(),
                checkIn: new Set(),
                checkOut: new Set(),
                period: new Set()
            };
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 9) return; // Skip empty/message rows
                
                // Column indices: 0=checkbox, 1=Room, 2=Location, 3=Company, 4=Employee, 5=CheckIn, 6=CheckOut, 7=Period, 8=Status
                const room = (cells[1]?.textContent || '').trim();
                const location = (cells[2]?.textContent || '').trim();
                const company = (cells[3]?.textContent || '').trim();
                const employee = (cells[4]?.textContent || '').trim();
                const checkIn = (cells[5]?.textContent || '').trim();
                const checkOut = (cells[6]?.textContent || '').trim();
                const period = (cells[7]?.textContent || '').trim();
                
                if (room && room !== '-') uniqueValues.room.add(room);
                if (location && location !== '-') uniqueValues.location.add(location);
                if (company && company !== '-') uniqueValues.company.add(company);
                if (employee && employee !== '-') uniqueValues.employee.add(employee);
                if (checkIn && checkIn !== '-') uniqueValues.checkIn.add(checkIn);
                if (checkOut && checkOut !== '-') uniqueValues.checkOut.add(checkOut);
                if (period && period !== '-') uniqueValues.period.add(period);
            });
            
            // Populate each filter with checkboxes
            const filterMappings = [
                { id: 'colFilterRoom', values: uniqueValues.room },
                { id: 'colFilterLocation', values: uniqueValues.location },
                { id: 'colFilterCompany', values: uniqueValues.company },
                { id: 'colFilterEmployee', values: uniqueValues.employee },
                { id: 'colFilterCheckIn', values: uniqueValues.checkIn },
                { id: 'colFilterCheckOut', values: uniqueValues.checkOut },
                { id: 'colFilterPeriod', values: uniqueValues.period },
                { id: 'colFilterStatus', values: new Set(['assigned', 'checked_in', 'cancelled']), labels: { 'assigned': 'Assigned', 'checked_in': 'Checked In', 'cancelled': 'Cancelled' } }
            ];
            
            // Store employee list for search filtering
            window.__colFilterEmployeeList = [...uniqueValues.employee].sort();
            // Store all filter values for reference
            window.__colFilterValues = {};
            
            filterMappings.forEach(({ id, values, labels }) => {
                const container = document.getElementById(id);
                if (!container) return;
                
                // Get currently checked values
                const checkedValues = getColFilterCheckedValues(id);
                window.__colFilterValues[id] = [...values].sort();
                
                // Build checkbox list
                const sortedValues = [...values].sort();
                let html = `<div class="col-filter-item select-all">
                    <input type="checkbox" id="${id}_all" ${checkedValues.length === 0 ? 'checked' : ''} onchange="toggleColFilterAll('${id}', this.checked)">
                    <label for="${id}_all">(Select All)</label>
                </div>`;
                
                sortedValues.forEach((val, idx) => {
                    const displayLabel = labels ? (labels[val] || val) : val;
                    const isChecked = checkedValues.includes(val);
                    html += `<div class="col-filter-item">
                        <input type="checkbox" id="${id}_${idx}" value="${escapeHtmlCamp(val)}" ${isChecked ? 'checked' : ''} onchange="onColFilterChange('${id}')">
                        <label for="${id}_${idx}" title="${escapeHtmlCamp(val)}">${escapeHtmlCamp(displayLabel)}</label>
                    </div>`;
                });
                
                container.innerHTML = html;
            });
            
            // Update filter button indicators
            updateColFilterIndicators();
        }
        
        // Get checked values for a filter
        function getColFilterCheckedValues(filterId) {
            const container = document.getElementById(filterId);
            if (!container) return [];
            const checkboxes = container.querySelectorAll('input[type="checkbox"][value]');
            return [...checkboxes].filter(cb => cb.checked).map(cb => cb.value);
        }
        
        // Toggle all checkboxes in a filter
        function toggleColFilterAll(filterId, checked) {
            const container = document.getElementById(filterId);
            if (!container) return;
            const checkboxes = container.querySelectorAll('input[type="checkbox"][value]');
            checkboxes.forEach(cb => cb.checked = checked ? false : false); // Uncheck all when "Select All" is checked
            if (checked) {
                // Clear all selections = show all
                checkboxes.forEach(cb => cb.checked = false);
            }
            onColFilterChange(filterId);
        }
        
        // Handle filter checkbox change
        function onColFilterChange(filterId) {
            const container = document.getElementById(filterId);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"][value]');
            const selectAllCb = container.querySelector('input[id$="_all"]');
            const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
            
            // Update "Select All" state
            if (selectAllCb) {
                selectAllCb.checked = checkedCount === 0;
            }
            
            // Update filter indicator
            updateColFilterIndicators();
            
            // Apply filters
            applyColumnFiltersOnRows();
        }
        
        // Update filter button indicators (show blue if filter is active)
        function updateColFilterIndicators() {
            const filterIds = ['colFilterRoom', 'colFilterLocation', 'colFilterCompany', 'colFilterEmployee', 'colFilterCheckIn', 'colFilterCheckOut', 'colFilterPeriod', 'colFilterStatus'];
            filterIds.forEach(id => {
                const btn = document.querySelector(`[data-filter="${id}"]`);
                if (btn) {
                    const checkedValues = getColFilterCheckedValues(id);
                    btn.classList.toggle('has-filter', checkedValues.length > 0);
                }
            });
        }
        
        // Filter employee checkboxes based on search input
        function filterEmployeeDropdown(searchTerm) {
            const container = document.getElementById('colFilterEmployee');
            if (!container) return;
            
            const allEmployees = window.__colFilterEmployeeList || [];
            const checkedValues = getColFilterCheckedValues('colFilterEmployee');
            const term = (searchTerm || '').toLowerCase();
            
            const filtered = term ? allEmployees.filter(emp => emp.toLowerCase().includes(term)) : allEmployees;
            
            let html = `<div class="col-filter-item select-all">
                <input type="checkbox" id="colFilterEmployee_all" ${checkedValues.length === 0 ? 'checked' : ''} onchange="toggleColFilterAll('colFilterEmployee', this.checked)">
                <label for="colFilterEmployee_all">(Select All)</label>
            </div>`;
            
            filtered.forEach((val, idx) => {
                const isChecked = checkedValues.includes(val);
                html += `<div class="col-filter-item">
                    <input type="checkbox" id="colFilterEmployee_${idx}" value="${escapeHtmlCamp(val)}" ${isChecked ? 'checked' : ''} onchange="onColFilterChange('colFilterEmployee')">
                    <label for="colFilterEmployee_${idx}" title="${escapeHtmlCamp(val)}">${escapeHtmlCamp(val)}</label>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Helpers to manage filter popups using a body-level portal to avoid clipping
        (function() {
            const state = {
                openPopup: null,
                openBtn: null,
            };

            function positionPortal(popup, btnRect) {
                const viewportPadding = 8;
                const assumedWidth = Math.max(popup.offsetWidth || 0, 200);
                let left = btnRect.left;
                if (left + assumedWidth + viewportPadding > window.innerWidth) {
                    left = Math.max(viewportPadding, window.innerWidth - assumedWidth - viewportPadding);
                }
                let top = btnRect.bottom + 4;
                const maxTop = window.innerHeight - viewportPadding - 20; // leave some space
                if (top > maxTop) top = Math.max(viewportPadding, btnRect.top - (popup.offsetHeight || 220) - 4);
                popup.style.left = left + 'px';
                popup.style.top = top + 'px';
            }

            function openPortal(btn, popup) {
                // Remember origin
                popup.__originParent = popup.parentElement;
                popup.__originNext = popup.nextSibling;

                // Prepare styles for portal
                popup.style.display = 'block';
                popup.style.position = 'fixed';
                popup.style.zIndex = String(99999);
                popup.style.maxHeight = popup.style.maxHeight || '220px';

                // Move to body
                document.body.appendChild(popup);

                // Position relative to button
                const rect = btn.getBoundingClientRect();
                positionPortal(popup, rect);

                // Focus first input
                const input = popup.querySelector('input, select');
                if (input) input.focus();

                state.openPopup = popup;
                state.openBtn = btn;
                btn.classList.add('active');
            }

            function closePortal(popup, btn) {
                if (!popup) return;
                // Hide and restore to origin container
                popup.style.display = 'none';
                popup.style.position = 'absolute';
                popup.style.left = '0';
                popup.style.top = '100%';
                popup.style.zIndex = '';
                if (popup.__originParent) {
                    if (popup.__originNext && popup.__originNext.parentNode === popup.__originParent) {
                        popup.__originParent.insertBefore(popup, popup.__originNext);
                    } else {
                        popup.__originParent.appendChild(popup);
                    }
                }
                if (btn) btn.classList.remove('active');
                state.openPopup = null;
                state.openBtn = null;
            }

            function closeAllPortals() {
                if (state.openPopup) {
                    closePortal(state.openPopup, state.openBtn);
                }
                // Also ensure any stray in-table popups are hidden
                document.querySelectorAll('.col-filter-popup').forEach(p => {
                    if (p !== state.openPopup) p.style.display = 'none';
                });
                document.querySelectorAll('.col-filter-title').forEach(b => b.classList.remove('active'));
            }

            function repositionOpen() {
                if (state.openPopup && state.openBtn && document.body.contains(state.openPopup)) {
                    const rect = state.openBtn.getBoundingClientRect();
                    positionPortal(state.openPopup, rect);
                }
            }

            // Expose toggle function in outer scope
            window.toggleColFilter = function(btn) {
                const popup = btn.closest('th')?.querySelector('.col-filter-popup');
                if (!popup) return;

                // If this popup is already open in portal, close it
                if (state.openPopup === popup) {
                    closePortal(popup, btn);
                    return;
                }

                // Close any currently open popup
                closeAllPortals();

                // Open this popup in portal
                openPortal(btn, popup);
            };

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (state.openPopup) {
                    const clickedInsideTitle = !!e.target.closest('.col-filter-title');
                    const clickedInsidePopup = !!e.target.closest('.col-filter-popup');
                    if (!clickedInsideTitle && !clickedInsidePopup) {
                        closePortal(state.openPopup, state.openBtn);
                    }
                }
            });

            // Reposition on resize/scroll
            window.addEventListener('resize', repositionOpen);
            window.addEventListener('scroll', repositionOpen, true);
        })();
        
        // Close filter popups when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.col-filter-title') && !e.target.closest('.col-filter-popup')) {
                document.querySelectorAll('.col-filter-popup').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.col-filter-title').forEach(b => b.classList.remove('active'));
            }
        });

        // Populate room filter dropdown with unique room numbers
        function populateRoomFilter(assignments) {
            const roomSelect = document.getElementById('filterRoom');
            if (!roomSelect) return;

            // Get unique room numbers
            const rooms = [...new Set(assignments.map(a => a.roomNumber).filter(Boolean))].sort();

            // Clear existing options except the first "All Rooms" option
            roomSelect.innerHTML = '<option value="">All Rooms</option>';

            // Add room options
            rooms.forEach(room => {
                if (room && room !== 'TBD') {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = room;
                    roomSelect.appendChild(option);
                }
            });
        }

        // Update the small counter next to the Location field with the number of available rooms for the selected location
        function updateLocationRoomCount() {
            try {
                const cntEl = document.getElementById('locationRoomCount');
                if (!cntEl) return;
                const locationSelect = document.getElementById('locationSelect');
                const base = Array.isArray(window.__camp_availableRooms) ? window.__camp_availableRooms : [];
                const selectedBlock = locationSelect ? (locationSelect.value || '') : '';
                const count = base.filter(r => {
                    const blk = (r.location && r.location.block) || '';
                    return !selectedBlock || blk === selectedBlock;
                }).length;
                cntEl.textContent = `${count} room${count === 1 ? '' : 's'}`;
            } catch (e) {
                console.warn('updateLocationRoomCount failed:', e);
            }
        }

        // Setup filter event listeners
        function setupFilterListeners() {
            const searchInput = document.getElementById('searchAssignments');
            const statusFilter = document.getElementById('filterStatus');
            const roomFilter = document.getElementById('filterRoom');
            
            [searchInput, statusFilter, roomFilter].forEach(element => {
                if (element) {
                    element.addEventListener('input', () => {
                        loadRoomAssignmentsData();
                    });
                    element.addEventListener('change', () => {
                        loadRoomAssignmentsData();
                    });
                }
            });
            
            // Column filters are now handled by checkbox onchange handlers
            // No need for event listeners on select elements
            
            // Employee search input listener
            const employeeSearchInput = document.getElementById('colFilterEmployeeSearch');
            if (employeeSearchInput) {
                employeeSearchInput.addEventListener('input', (e) => {
                    filterEmployeeDropdown(e.target.value);
                });
            }
            
            // Archive filter listeners
            const archiveSearchInput = document.getElementById('searchArchives');
            const archiveRoomFilter = document.getElementById('filterArchiveRoom');
            const archiveDateFilter = document.getElementById('filterArchiveDate');
            
            [archiveSearchInput, archiveRoomFilter, archiveDateFilter].forEach(element => {
                if (element) {
                    element.addEventListener('input', () => {
                        loadArchivesData();
                    });
                    element.addEventListener('change', () => {
                        loadArchivesData();
                    });
                }
            });
        }

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Notification system
        function showNotification(message, type = 'info') {
            // Create notification container if it doesn't exist
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#b6d4db'};
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease-out;
            `;
            
            const icon = type === 'success' ? '?' : type === 'error' ? '?' : '??';
            notification.innerHTML = `
                <span style="font-size: 16px;">${icon}</span>
                <span style="flex: 1;">${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: inherit;"></button>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // Add CSS for animations
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
                .badge {
                    display: inline-block;
                    padding: 0.25em 0.5em;
                    font-size: 0.75em;
                    font-weight: 700;
                    line-height: 1;
                    text-align: center;
                    white-space: nowrap;
                    vertical-align: baseline;
                    border-radius: 0.375rem;
                }
                .badge-info { background-color: #17a2b8; color: #fff; }
                .badge-success { background-color: #28a745; color: #fff; }
                .badge-secondary { background-color: #6c757d; color: #fff; }
                .badge-danger { background-color: #dc3545; color: #fff; }
                .badge-warning { background-color: #ffc107; color: #212529; }
                .action-buttons {
                    display: flex;
                    gap: 5px;
                    justify-content: center;
                }
                .btn-sm {
                    padding: 0.25rem 0.5rem;
                    font-size: 0.75rem;
                    border-radius: 0.2rem;
                }
                .text-center { text-align: center; }
                .text-danger { color: #dc3545; }
            `;
            document.head.appendChild(style);
        }

        // ================= Accommodation Analytics (pivot-like) =================
        let __campAnalyticsInit = false;
        let __campAnalysisSets = new Map();
        let __campEditingModelId = null;
        function setCampAnalyticsStatus(msg, isError){ const el=document.getElementById('campAnalyticsStatus'); if(el){ el.textContent=msg; el.style.color=isError?'#b91c1c':'#475569'; } }
        function ensureCampAnalyticsBuilder(){ if(__campAnalyticsInit) return; const mount=document.getElementById('campAnalyticsBuilderMount'); if(!mount) return; const section=document.createElement('section'); section.id='campMultiBuilderSection'; section.innerHTML=`<div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.75rem;margin-bottom:0.8rem;"> <h2 style="margin:0 0 0.55rem 0;font-size:0.7rem;font-weight:600;color:#334155;display:flex;align-items:center;gap:6px;"><i class=\"fas fa-layer-group\"></i> Custom Tables & Charts</h2> <div style="display:flex;flex-wrap:wrap;gap:0.4rem;align-items:center;"> <button type=button id=campAddSetBtn class="btn btn-sm btn-primary" style="font-size:0.6rem;">Add Analysis Set</button> <button type=button id=campClearSetsBtn class="btn btn-sm btn-danger" style="font-size:0.6rem;">Clear All</button> <button type=button id=campSaveModelBtn class="btn btn-sm" style="background:#475569;color:#fff;font-size:0.6rem;">Save Model</button> <button type=button id=campUpdateModelBtn class="btn btn-sm" style="background:#0d9488;color:#fff;font-size:0.6rem;display:none;">Update Model</button> </div> <p style="margin:0.45rem 0 0 0;font-size:0.55rem;color:#64748b;">Each set = grouping + optional date range. Generates table + chart for room usage (occupancy).</p> </div> <div id=campSetsContainer style="display:flex;flex-wrap:wrap;gap:0.75rem;"></div>`; mount.appendChild(section); document.getElementById('campAddSetBtn')?.addEventListener('click',()=>addCampAnalysisSet()); document.getElementById('campClearSetsBtn')?.addEventListener('click',clearAllCampSets); document.getElementById('campSaveModelBtn')?.addEventListener('click',saveCampAnalyticsModel); document.getElementById('campUpdateModelBtn')?.addEventListener('click',updateCampAnalyticsModel); __campAnalyticsInit=true; }
    function addCampAnalysisSet(cfg={}){ const id='cas_'+Date.now()+'_'+Math.random().toString(36).slice(2,7); const groupBy=cfg.groupBy||'location'; const chartType=cfg.chartType||'bar'; const start=cfg.start||''; const end=cfg.end||''; const detailField=cfg.detailField||''; const container=document.getElementById('campSetsContainer'); if(!container) return; const div=document.createElement('div'); div.className='camp-set'; div.style.cssText='flex:1 1 380px;min-width:340px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;display:flex;flex-direction:column;gap:0.5rem;'; div.id=id; const friendlyDetail=(v)=>({ room:'Room', location:'Location', operator:'Employee', checkin:'Check-in Date', checkout:'Check-out Date', department:'Department', status:'Status', period:'Period', id:'Record ID' }[v]||''); const subtitleDetail = groupBy==='location' && detailField ? `  Sort: ${friendlyDetail(detailField)}` : ''; div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:0.4rem;"> <span style="font-size:0.6rem;font-weight:600;color:#334155;">Set (${groupBy}${subtitleDetail})</span> <div style="display:flex;gap:0.3rem;"> <button type=button data-action=refresh style="background:#2563eb;color:#fff;border:none;padding:2px 6px;border-radius:4px;font-size:0.55rem;">Refresh</button> <button type=button data-action=remove style="background:#dc2626;color:#fff;border:none;padding:2px 6px;border-radius:4px;font-size:0.55rem;">X</button> </div> </div> <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.35rem;align-items:center;"> <select data-field=groupBy style="font-size:0.55rem;padding:2px 4px;"> <option value=day ${groupBy==='day'?'selected':''}>Day</option> <option value=date ${groupBy==='date'?'selected':''}>Check-in Date</option> <option value=id ${groupBy==='id'?'selected':''}>Record ID</option> <option value=location ${groupBy==='location'?'selected':''}>Location</option> <option value=room ${groupBy==='room'?'selected':''}>Room</option> <option value=operator ${groupBy==='operator'?'selected':''}>Employee</option> <option value=department ${groupBy==='department'?'selected':''}>Department</option> <option value=status ${groupBy==='status'?'selected':''}>Status</option> </select> <input type=date data-field=start value="${start}" style="font-size:0.55rem;padding:2px 4px;"/> <input type=date data-field=end value="${end}" style="font-size:0.55rem;padding:2px 4px;"/> <select data-field=detailField style="font-size:0.55rem;padding:2px 4px;" title="Sort/Focus Field (for Location)"> <option value="" ${detailField===''?'selected':''}>Sort/Focus Field</option> <option value=room ${detailField==='room'?'selected':''}>Room</option> <option value=location ${detailField==='location'?'selected':''}>Location</option> <option value=operator ${detailField==='operator'?'selected':''}>Employee</option> <option value=checkin ${detailField==='checkin'?'selected':''}>Check-in Date</option> <option value=checkout ${detailField==='checkout'?'selected':''}>Check-out Date</option> <option value=department ${detailField==='department'?'selected':''}>Department</option> <option value=status ${detailField==='status'?'selected':''}>Status</option> <option value=period ${detailField==='period'?'selected':''}>Period</option> <option value=id ${detailField==='id'?'selected':''}>Record ID</option> </select> <select data-field=chartType style="font-size:0.55rem;padding:2px 4px;"> <option value=bar ${chartType==='bar'?'selected':''}>Bar</option> <option value=doughnut ${chartType==='doughnut'?'selected':''}>Doughnut</option> <option value=line ${chartType==='line'?'selected':''}>Line</option> <option value=pie ${chartType==='pie'?'selected':''}>Pie</option> </select> </div> <div data-role=tableHolder style="overflow:auto;max-height:160px;border:1px solid #e2e8f0;border-radius:6px;"></div> <div style="height:170px;position:relative;"> <canvas data-role=chartCanvas></canvas> </div>`; container.appendChild(div); div.addEventListener('click',e=>{ const btn=e.target.closest('button[data-action]'); if(!btn) return; const act=btn.getAttribute('data-action'); if(act==='remove'){ __campAnalysisSets.delete(id); div.remove(); } else if(act==='refresh'){ renderCampAnalysisSet(id); } }); div.querySelectorAll('select,input').forEach(inp=>inp.addEventListener('change',()=>renderCampAnalysisSet(id))); __campAnalysisSets.set(id,{ cfg:{groupBy,chartType,start,end,detailField} }); renderCampAnalysisSet(id); }
        function collectAssignmentsDataset(){ return Array.isArray(window.__camp_lastAssignments)? window.__camp_lastAssignments : []; }
        function filterAssignmentsByDate(list,start,end){ if(!start && !end) return list; const s=start?new Date(start).getTime():null; const e=end?new Date(end).getTime()+86400000-1:null; return list.filter(a=>{ const ci=a.checkInDate?new Date(a.checkInDate).getTime():null; if(ci==null) return false; if(s && ci<s) return false; if(e && ci>e) return false; return true; }); }
    function aggregateAssignments(groupBy,{start,end}){ const data=filterAssignmentsByDate(collectAssignmentsDataset(),start,end); const map=new Map(); data.forEach(a=>{ let key='-'; let sortVal=undefined; const getDate=()=> new Date(a.actualCheckInDate||a.checkInDate||Date.now()); switch(groupBy){ case 'day': { const d=getDate(); key=d.toLocaleDateString(undefined,{ day:'2-digit', month:'short' }); sortVal=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(); break; } case 'consumptionDate': { const d=getDate(); key=d.toISOString().slice(0,10); sortVal=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(); break; } case 'id': key=a.id||'Unknown ID'; break; case 'equipmentType': key=a.equipmentType||'Unknown Type'; break; case 'equipmentId': key=a.equipmentId||'Unknown Equipment'; break; case 'location': key=a.location||'Unknown Location'; break; case 'operator': key=a.employeeName||a.employee||'Unknown Operator'; break; case 'quantity': key='N/A'; break; case 'index': key='N/A'; break; case 'department': key=a.department||'Unknown Department'; break; case 'costcenter': key=a.costCenter||a.costcenter||'Unknown Cost Center'; break; case 'securityAgent': key=a.securityAgent||'Unknown Security'; break; case 'supervisor': key=a.supervisor||'Unknown Supervisor'; break; case 'status': key=a.status||'Unknown Status'; break; case 'site': key=a.site||a.location||'Unknown Site'; break; case 'fuelType': key='N/A'; break; case 'room': key=a.roomNumber||a.room||'-'; break; case 'date': key=(a.checkInDate||'').split('T')[0]||'-'; break; default: key=a.location||'-'; } const entry=map.get(key)||{key,assignments:0,checkedIn:0,sortVal:sortVal}; if(typeof sortVal==='number'){ if(typeof entry.sortVal!=='number' || sortVal<entry.sortVal){ entry.sortVal=sortVal; } } entry.assignments+=1; if(a.status==='checked_in') entry.checkedIn+=1; map.set(key,entry); }); let rows=[...map.values()]; if(groupBy==='day'||groupBy==='consumptionDate'){ rows.sort((a,b)=> (a.sortVal||0)-(b.sortVal||0)); } else { rows.sort((a,b)=> b.assignments-a.assignments); } return { rows }; }
    async function renderLocationDetailTable(holder, {start,end, detailField}){
            try{
                const list = filterAssignmentsByDate(collectAssignmentsDataset(), start, end);
                // Resolve room locations using cached index once
                const roomsIdx = await getRoomsIndex();
                const fmt = (d)=> d ? new Date(d).toLocaleDateString() : '-';
                const calcPeriod = (a)=>{
                    let period='-';
                    if(a.actualCheckInDate && a.actualCheckOutDate){
                        const days = Math.ceil((new Date(a.actualCheckOutDate)-new Date(a.actualCheckInDate))/(1000*60*60*24));
                        period = `${days} day${days!==1?'s':''}`;
                    } else if(a.checkInDate && a.checkOutDate){
                        const days = Math.ceil((new Date(a.checkOutDate)-new Date(a.checkInDate))/(1000*60*60*24));
                        period = `${days} day${days!==1?'s':''}`;
                    }
                    return period;
                };
                const locate = (roomNumber)=>{
                    const meta = roomsIdx[String(roomNumber||'').trim()]||null;
                    if(!meta||!meta.location) return '-';
                    const { block, building, floor } = meta.location;
                    if(block) return block;
                    const parts=[building,floor].filter(Boolean);
                    return parts.length? parts.join(' ') : '-';
                };
                // Sort by location then by selected detail field (if provided), otherwise by most recent check-in/assigned date desc
                const getPeriodDays = (a)=>{
                    const start = new Date(a.actualCheckInDate||a.checkInDate||0).getTime();
                    const end = new Date(a.actualCheckOutDate||a.checkOutDate||0).getTime();
                    if(!start || !end) return 0;
                    const days = Math.ceil((end-start)/(1000*60*60*24));
                    return isFinite(days)? days : 0;
                };
                const sorted = [...list].sort((a,b)=>{
                    const la = locate(a.roomNumber);
                    const lb = locate(b.roomNumber);
                    if(la===lb){
                        const field = String(detailField||'');
                        if(field){
                            const normStr = (v)=> String(v==null? '': v).toLowerCase();
                            const normNum = (v)=> Number.isFinite(v)? v : 0;
                            // Compute comparable values for selected field
                            const mapVal = (rec)=>{
                                switch(field){
                                    case 'room': return normStr(rec.roomNumber||rec.room||'');
                                    case 'location': return normStr(locate(rec.roomNumber));
                                    case 'operator': return normStr(rec.employeeName||rec.employee||'');
                                    case 'checkin': return (new Date(rec.actualCheckInDate||rec.checkInDate||0)).getTime();
                                    case 'checkout': return (new Date(rec.actualCheckOutDate||rec.checkOutDate||0)).getTime();
                                    case 'department': return normStr(rec.department||'');
                                    case 'status': return normStr(rec.status||'');
                                    case 'period': return getPeriodDays(rec);
                                    case 'id': return normStr(rec.id||'');
                                    default: return (new Date(rec.actualCheckInDate||rec.checkInDate||rec.assignedDate||0)).getTime();
                                }
                            };
                            const va = mapVal(a); const vb = mapVal(b);
                            // For dates and numeric (period), sort descending, else ascending alpha
                            if(field==='checkin' || field==='checkout' || field==='period'){
                                return normNum(vb) - normNum(va);
                            }
                            return normStr(va).localeCompare(normStr(vb), undefined, {numeric:true, sensitivity:'base'});
                        }
                        const ta = new Date(a.actualCheckInDate||a.checkInDate||a.assignedDate||0).getTime();
                        const tb = new Date(b.actualCheckInDate||b.checkInDate||b.assignedDate||0).getTime();
                        return tb-ta;
                    }
                    return String(la).localeCompare(String(lb));
                });
                let html = '<table style="width:100%;border-collapse:collapse;font-size:0.55rem;min-width:750px;">';
                html += '<thead><tr>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Room</th>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Location</th>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Employee</th>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Check-in Date</th>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Check-out Date</th>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Period</th>'+
                    '<th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Status</th>'+
                '</tr></thead>';
                html += '<tbody>' + sorted.map(a=>{
                    const room = a.roomNumber || '-';
                    const loc = locate(a.roomNumber);
                    const emp = a.employeeName || '-';
                    const cin = fmt(a.actualCheckInDate||a.checkInDate);
                    const cout = fmt(a.actualCheckOutDate||a.checkOutDate);
                    const per = calcPeriod(a);
                    const st = getStatusBadge(a.status||'');
                    return `<tr>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${room}</td>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${loc}</td>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${emp}</td>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${cin}</td>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${cout}</td>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${per}</td>`+
                        `<td style="padding:4px 6px;border:1px solid #e2e8f0;">${st}</td>`+
                    `</tr>`;
                }).join('') + '</tbody>';
                html += '</table>';
                holder.innerHTML = html;
            }catch(e){
                console.warn('renderLocationDetailTable failed', e);
                holder.innerHTML = '<div style="font-size:0.55rem;color:#b91c1c;padding:0.4rem;">Failed to render details.</div>';
            }
        }
    function renderCampAnalysisSet(id){ const rec=__campAnalysisSets.get(id); if(!rec) return; const root=document.getElementById(id); if(!root) return; const cfg={}; root.querySelectorAll('[data-field]').forEach(el=>{ cfg[el.getAttribute('data-field')]=el.value; }); rec.cfg=cfg; const agg=aggregateAssignments(cfg.groupBy,{start:cfg.start,end:cfg.end}); const holder=root.querySelector('[data-role="tableHolder"]'); if(holder){ if(cfg.groupBy==='location'){ holder.innerHTML='<div style="font-size:0.55rem;color:#64748b;padding:0.4rem;">Loading details</div>'; renderLocationDetailTable(holder,{start:cfg.start,end:cfg.end, detailField:cfg.detailField}); } else if(!agg.rows.length){ holder.innerHTML='<div style="font-size:0.55rem;color:#64748b;padding:0.4rem;">No data</div>'; } else { let html='<table style="width:100%;border-collapse:collapse;font-size:0.55rem;">'; const __labelMap={ day:'Day', date:'Check-in Date', id:'Record ID', location:'Location', room:'Room', operator:'Employee', department:'Department', status:'Status' }; const __hdr=__labelMap[cfg.groupBy]||String(cfg.groupBy||'').toUpperCase(); html+='<thead><tr><th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;text-align:left;">'+__hdr+'</th><th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Assignments</th><th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Checked In</th><th style="padding:4px 6px;border:1px solid #e2e8f0;background:#f1f5f9;">Occupancy %</th></tr></thead>'; html+='<tbody>'+agg.rows.map(r=>{ const pct=r.assignments?((r.checkedIn/r.assignments)*100).toFixed(1):'0.0'; return `<tr><td style=\"padding:4px 6px;border:1px solid #e2e8f0;\">${r.key}</td><td style=\"padding:4px 6px;border:1px solid #e2e8f0;text-align:right;\">${r.assignments}</td><td style=\"padding:4px 6px;border:1px solid #e2e8f0;text-align:right;\">${r.checkedIn}</td><td style=\"padding:4px 6px;border:1px solid #e2e8f0;text-align:right;\">${pct}</td></tr>`; }).join('')+'</tbody>'; html+='</table>'; holder.innerHTML=html; } } const canvas=root.querySelector('canvas[data-role="chartCanvas"]'); if(canvas){ try { if(canvas.__chartInst) canvas.__chartInst.destroy(); const labels=agg.rows.slice(0,30).map(r=>r.key); const assignments=agg.rows.slice(0,30).map(r=>r.assignments); const occupancy=agg.rows.slice(0,30).map(r=> r.assignments?+((r.checkedIn/r.assignments)*100).toFixed(1):0); const ctx=canvas.getContext('2d'); const chartCfg={ type: rec.cfg.chartType||'bar', data:{ labels, datasets:[ { label:'Assignments', data:assignments, backgroundColor:'rgba(37,99,235,0.6)', borderColor:'#2563eb', borderWidth:1 }, { label:'Occupancy %', data:occupancy, backgroundColor:'rgba(16,185,129,0.5)', borderColor:'#10b981', borderWidth:1, yAxisID:'y1' } ] }, options:{ responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false }, stacked:false, scales:{ y:{ beginAtZero:true, ticks:{ font:{size:9} } }, y1:{ type:'linear', position:'right', beginAtZero:true, ticks:{ font:{size:9}, callback:v=>v+'%' }, grid:{ drawOnChartArea:false } } }, plugins:{ legend:{ labels:{ font:{ size:9 } } } } } }; if(rec.cfg.chartType==='doughnut'||rec.cfg.chartType==='pie'){ chartCfg.data.datasets=[{ label:'Assignments', data:assignments, backgroundColor:assignments.map(()=> '#2563eb') }]; delete chartCfg.options.scales; } else if(rec.cfg.chartType==='line'){ chartCfg.data.datasets[0].borderWidth=2; chartCfg.data.datasets[0].fill=false; chartCfg.data.datasets[1].type='line'; chartCfg.data.datasets[1].borderWidth=2; chartCfg.data.datasets[1].fill=false; } canvas.__chartInst=new Chart(ctx, chartCfg); rec.chartMeta=chartCfg; rec.tableHtml=holder?holder.innerHTML:''; } catch(e){ console.warn('camp chart render failed', e); } } }
        function clearAllCampSets(){ __campAnalysisSets.clear(); const container=document.getElementById('campSetsContainer'); if(container) container.innerHTML=''; __campEditingModelId=null; const upd=document.getElementById('campUpdateModelBtn'); if(upd) upd.style.display='none'; const save=document.getElementById('campSaveModelBtn'); if(save) save.style.display='inline-block'; }
        function getCampAnalyticsModelPayload(){ const sets=[]; __campAnalysisSets.forEach((rec,id)=> sets.push({ id, cfg:rec.cfg, table:rec.tableHtml||'', chart:rec.chartMeta||{} })); if(!sets.length){ setCampAnalyticsStatus('Nothing to save (no sets).', true); return null; } return { title: prompt('Enter model title','Accommodation Analytics Model') || 'Accommodation Analytics Model', category:'assignments', start:'', end:'', values:['assignments','occupancy'], sets, createdAt:Date.now(), updatedAt:Date.now() }; }
        async function saveCampAnalyticsModel(){ try { if(!firebase||!firebase.database) throw new Error('Firebase not available'); const companyId=window.authManager?.currentUser?.companyId||'global'; const payload=getCampAnalyticsModelPayload(); if(!payload) return; await firebase.database().ref(`analyticsModels/camp/${companyId}`).push(payload); setCampAnalyticsStatus('Model saved.'); loadCampAnalyticsModels(); } catch(e){ console.error(e); setCampAnalyticsStatus('Save failed: '+e.message,true); } }
        async function loadCampAnalyticsModels(){ try { const body=document.getElementById('campAnalyticsModelsBody'); if(!body) return; body.innerHTML=''; if(!firebase||!firebase.database) return; const companyId=window.authManager?.currentUser?.companyId||'global'; const snap=await firebase.database().ref(`analyticsModels/camp/${companyId}`).once('value'); const val=snap.val()||{}; const rows=Object.entries(val).map(([id,m])=>({id,...m})).sort((a,b)=>b.createdAt-a.createdAt); body.innerHTML=rows.map(renderCampAnalyticsModelRow).join(''); } catch(e){ console.warn('load camp analytics models failed', e); } }
        function renderCampAnalyticsModelRow(m){ const range=(m.start||m.end)?`${m.start||''} - ${m.end||''}`:'All Time'; const values=(m.values||[]).join(', '); const created=m.createdAt?new Date(m.createdAt).toLocaleString():''; return `<tr data-id="${m.id}" style="cursor:pointer;">`+`<td>${escapeHtml(m.title||'')}</td>`+`<td>${escapeHtml(m.category||'')}</td>`+`<td>${escapeHtml(range)}</td>`+`<td>${escapeHtml(values)}</td>`+`<td>${escapeHtml(created)}</td>`+`<td>`+`<button style="padding:2px 6px;font-size:.55rem;background:#6366f1;color:#fff;border:none;border-radius:4px;" onclick="event.stopPropagation(); previewCampAnalyticsModel('${m.id}')">Preview</button>`+`<button style="padding:2px 6px;font-size:.55rem;" onclick="event.stopPropagation(); applyCampAnalyticsModel('${m.id}')">Use</button>`+`<button style="padding:2px 6px;font-size:.55rem;background:#0d9488;color:#fff;border:none;border-radius:4px;" onclick="event.stopPropagation(); editCampAnalyticsModel('${m.id}')">Edit</button>`+`<button style="padding:2px 6px;font-size:.55rem;background:#dc2626;color:#fff;border:none;border-radius:4px;" onclick="event.stopPropagation(); deleteCampAnalyticsModel('${m.id}')">Delete</button>`+`</td>`+`</tr>`; }
        async function applyCampAnalyticsModel(id){ try { if(!firebase||!firebase.database) throw new Error('Firebase not available'); const companyId=window.authManager?.currentUser?.companyId||'global'; const snap=await firebase.database().ref(`analyticsModels/camp/${companyId}/${id}`).once('value'); const m=snap.val(); if(!m) return; clearAllCampSets(); (m.sets||[]).forEach(s=> addCampAnalysisSet(s.cfg||{})); setCampAnalyticsStatus('Model applied.'); } catch(e){ console.error(e); setCampAnalyticsStatus('Apply failed: '+e.message,true); } }
        async function previewCampAnalyticsModel(id){ try { await applyCampAnalyticsModel(id); setCampAnalyticsStatus('Preview loaded (model applied temporarily).'); } catch(e){ console.error(e); } }
        async function editCampAnalyticsModel(id){ try { await applyCampAnalyticsModel(id); __campEditingModelId=id; const upd=document.getElementById('campUpdateModelBtn'); if(upd) upd.style.display='inline-block'; const save=document.getElementById('campSaveModelBtn'); if(save) save.style.display='none'; setCampAnalyticsStatus('Edit mode: adjust sets then click Update Model.'); } catch(e){ console.error(e); } }
        async function updateCampAnalyticsModel(){ if(!__campEditingModelId){ setCampAnalyticsStatus('No model in edit mode.', true); return; } try { if(!firebase||!firebase.database) throw new Error('Firebase not available'); const companyId=window.authManager?.currentUser?.companyId||'global'; const snap=await firebase.database().ref(`analyticsModels/camp/${companyId}/${__campEditingModelId}`).once('value'); const existing=snap.val()||{}; const sets=[]; __campAnalysisSets.forEach((rec,id)=> sets.push({ id, cfg:rec.cfg, table:rec.tableHtml||'', chart:rec.chartMeta||{} })); const payload={ ...existing, sets, updatedAt:Date.now() }; await firebase.database().ref(`analyticsModels/camp/${companyId}/${__campEditingModelId}`).set(payload); setCampAnalyticsStatus('Model updated.'); loadCampAnalyticsModels(); __campEditingModelId=null; const upd=document.getElementById('campUpdateModelBtn'); if(upd) upd.style.display='none'; const save=document.getElementById('campSaveModelBtn'); if(save) save.style.display='inline-block'; } catch(e){ console.error(e); setCampAnalyticsStatus('Update failed: '+e.message,true); } }
        async function deleteCampAnalyticsModel(id){ if(!confirm('Delete this analytics model?')) return; try { if(!firebase||!firebase.database) throw new Error('Firebase not available'); const companyId=window.authManager?.currentUser?.companyId||'global'; await firebase.database().ref(`analyticsModels/camp/${companyId}/${id}`).remove(); setCampAnalyticsStatus('Model deleted.'); loadCampAnalyticsModels(); } catch(e){ console.error(e); setCampAnalyticsStatus('Delete failed: '+e.message,true); } }
    </script>
</body>
</html>
