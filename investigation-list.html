<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigation List - Dreamex Datalab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase v8 Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
            --transition-speed: .25s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; color: #222; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--primary-color); color: #fff; padding: 1rem; position: fixed; top: 0; left: 0; bottom: 0; overflow-y: auto; transition: transform .3s ease; z-index: 1000; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 0.3rem; padding-top: 3.2rem; transition: margin-left .3s ease; }
        .main-content.sidebar-collapsed { margin-left: 0; }
        .main-content.sidebar-collapsed .top-nav { left: 0.5rem; }
        .logo h2 { text-align: center; padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.05rem; letter-spacing: .5px; }
        .menu { list-style: none; margin-top: 2rem; }
        .menu li { margin-bottom: 0.45rem; }
        .menu a { display: flex; align-items: center; gap: 10px; color: #fff; text-decoration: none; padding: 0.6rem 0.75rem; border-radius: 6px; font-size: 0.82rem; font-weight: 500; transition: background .25s; }
        .menu a:hover, .menu a.active { background: rgba(255,255,255,0.12); }
        .submenu { list-style: none; margin-left: 0.75rem; display: none; margin-top: 0.25rem; }
        .menu-dropdown:hover .submenu { display: block; }
        .submenu a { font-size: 0.75rem; padding: 0.45rem 0.65rem; }
        
        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) { display: none !important; }
        .menu-dropdown:not(.menu-visible) { display: none !important; }
        .sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] { display: none !important; }
        .sidebar.menu-loading .menu-visible, .sidebar.menu-loading li.menu-visible, .sidebar.menu-loading [data-feature].menu-visible { display: block !important; }
        .menu-loading [data-feature] { display: none !important; }
        .menu-loading .menu-dropdown { display: none !important; }
        .menu-visible { display: block !important; }
        li.menu-visible, [data-feature].menu-visible { display: block !important; }

    .top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
    .sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
    .top-nav-left { display:flex; align-items:center; gap:0.75rem; }
    .company-branding { display:flex; align-items:center; gap:0.5rem; }
    #headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
    /* Show the logo once AuthManager sets it */
    #headerCompanyLogo.visible { display:inline-block; }
    #headerCompanyName { font-weight:600; font-size:0.85rem; }
    .header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }
    .top-nav-right { display:flex; align-items:center; gap:1rem; }
    .notifications { position:relative; display:flex; align-items:center; }
    .notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
    .notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; display:none; }
    .notification-dropdown { display:none; position:absolute; right:0; top:100%; width:320px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:1000; border:1px solid #e9ecef; max-height:400px; overflow:hidden; }
    .notification-dropdown.show { display:block; animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
    .notification-header { padding:12px 16px; border-bottom:1px solid #e9ecef; background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%); display:flex; justify-content:space-between; align-items:center; }
    .notification-header h3 { margin:0; color:#333; font-size:14px; font-weight:600; }
    .mark-all-read { background:none; border:none; color:#3498db; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; }
    .mark-all-read:hover { background:#e3f2fd; color:#1976d2; }
    .clear-all-notifications { background:none; border:none; color:#e74c3c; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; margin-left:8px; }
    .clear-all-notifications:hover { background:#fdf2f2; color:#c0392b; }
    .notification-list { max-height:320px; overflow-y:auto; padding:0; }
    .notification-list::-webkit-scrollbar { width:4px; }
    .notification-list::-webkit-scrollbar-track { background:#f1f1f1; }
    .notification-list::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:2px; }
    .notification-item { padding:12px 16px; border-bottom:1px solid #f1f1f1; cursor:pointer; transition:background-color .2s ease; position:relative; }
    .notification-item:hover { background:#f8f9fa; }
    .notification-item.unread { background:#e8f4fd; border-left:3px solid #3498db; }
    .notification-dot { position:absolute; top:16px; right:16px; width:8px; height:8px; background:#3498db; border-radius:50%; }
    .notification-actions { position:absolute; top:8px; right:8px; display:none; gap:4px; }
    .notification-item:hover .notification-actions { display:flex; }
    .mark-read-btn, .delete-notification-btn { background:none; border:none; cursor:pointer; padding:4px; border-radius:3px; transition:all .2s ease; font-size:12px; }
    .mark-read-btn { color:#3498db; }
    .mark-read-btn:hover { background:#e3f2fd; color:#1976d2; }
    .delete-notification-btn { color:#e74c3c; }
    .delete-notification-btn:hover { background:#fdf2f2; color:#c0392b; }
    .notification-empty { padding:40px 20px; text-align:center; color:#999; display:none; }
    .notification-empty i { font-size:32px; margin-bottom:12px; color:#ddd; }
    .notification-empty-title { font-size:14px; font-weight:500; margin-bottom:4px; color:#666; }
    .notification-empty-message { font-size:12px; color:#999; }
    .user-profile { position:relative; }
    .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
    .profile-btn img { width:100%; height:100%; object-fit:cover; }
    .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
    .profile-dropdown.show { display:block; }
    .profile-dropdown ul { list-style:none; }
    .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
    .profile-dropdown li a:hover { background:#f1f5f9; }

        /* Content Styles */
        .content { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 0; overflow: hidden; }
        .page-header { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: #fff; 
            padding: 0.55rem 0.75rem; 
            border-radius: 0; 
            margin: 0.35rem 0 0.5rem 0; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }
        .page-header i { font-size: 1rem; }
        .header-main { display: flex; align-items: center; gap: 0.6rem; }
        .page-header h1 { color: #fff; display: flex; align-items: center; gap: 0.6rem; font-size: 0.9rem; margin: 0; font-weight: 600; }
        .page-actions { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-create { 
            background: none;
            border: none;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: none;
        }
        .btn-create:hover { color: rgba(255,255,255,0.8); transform: scale(1.1); box-shadow: none; }

        /* Filters */
        .filters { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }

        /* Chronological Event Timeline Visualization (matches investigation-create.html) */
        .event-timeline-viz { position: relative; padding: 1rem 0; overflow: visible; }
        .event-timeline-viz .timeline-track { display: flex; flex-wrap: wrap; align-items: flex-start; position: relative; padding: 0 0.5rem; gap: 6rem 0; overflow: visible; }
        .event-timeline-viz .timeline-event-node { display: flex; flex-direction: column; align-items: center; min-width: 110px; max-width: 140px; width: calc(16.66% - 0.25rem); position: relative; z-index: 1; padding: 0.25rem; margin-bottom: 4.5rem; }
        .event-timeline-viz .event-time-badge { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.68rem; font-weight: 600; margin-bottom: 0.35rem; box-shadow: 0 2px 6px rgba(59,130,246,0.3); z-index: 2; }
        .event-timeline-viz .event-dot { width: 14px; height: 14px; background: #fff; border: 3px solid #3b82f6; border-radius: 50%; margin-bottom: 0.35rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 2; }
        .event-timeline-viz .event-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.4rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); width: 100%; z-index: 2; }
        .event-timeline-viz .event-card .event-title { font-weight: 600; color: #1e293b; font-size: 0.72rem; margin-bottom: 0.15rem; word-break: break-word; }
        .event-timeline-viz .event-card .event-desc { color: #64748b; font-size: 0.68rem; word-break: break-word; }
        .event-timeline-viz .timeline-empty { text-align: center; color: #94a3b8; padding: 1.5rem; font-size: 0.85rem; }
        /* Timeline connectors */
        .event-timeline-viz .timeline-connector { position: absolute; background: linear-gradient(90deg, #3b82f6, #8b5cf6); z-index: 0; }
        .event-timeline-viz .timeline-connector.horizontal { height: 3px; }
        .event-timeline-viz .timeline-connector.vertical { width: 3px; }
        .event-timeline-viz .timeline-connector .arrow { position: absolute; width: 0; height: 0; }
        .event-timeline-viz .timeline-connector .arrow-right { right: -6px; top: -4px; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 7px solid #8b5cf6; }
        .event-timeline-viz .timeline-connector .arrow-down { bottom: -6px; left: -4px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 7px solid #8b5cf6; }
        .event-timeline-viz .timeline-event-node { transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .event-timeline-viz .timeline-event-node:hover { transform: scale(1.03); }

        /* Investigation Modal Print Styles */
        .inv-info-table td { padding:6px 12px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; }
        .inv-info-table td:first-child { width:180px; font-weight:600; color:#374151; white-space:nowrap; }
        /* Define section (card/grid) styles */
        .inv-section-title { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color:#fff; 
            font-weight:600; 
            font-size:.75rem; 
            padding:10px 14px; 
            border:none; 
            border-radius:0; 
            display:flex; 
            align-items:center; 
            gap:10px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.15);
        }
        .inv-section-title i { 
            font-size: 1rem; 
            width: 28px; 
            height: 28px; 
            background: rgba(255,255,255,0.2); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-shrink: 0;
        }
        .inv-section-title .section-text { flex: 1; }
        /* Section icon colors for visual distinction */
        .inv-section-title.define-section i { background: rgba(52,152,219,0.3); }
        .inv-section-title.measure-section i { background: rgba(155,89,182,0.3); }
        .inv-section-title.analyze-section i { background: rgba(241,196,15,0.3); }
        .inv-section-title.improve-section i { background: rgba(46,204,113,0.3); }
        .inv-section-title.control-section i { background: rgba(26,188,156,0.3); }
        .inv-section-title.approval-section i { background: rgba(231,76,60,0.3); }
        .define-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px 14px; margin-top:8px; }
        .define-item { border:1px solid #e5e7eb; border-radius:6px; background:#fff; padding:10px 12px; display:flex; align-items:flex-start; column-gap:8px; }
        .define-item .label { font-size:.74rem; color:#374151; font-weight:700; text-transform:none; letter-spacing:.01em; min-width:160px; white-space:nowrap; }
        .define-item .label::after { content: ':'; margin-left:4px; }
        .define-item .value { font-size:.74rem; color:#111827; line-height:1.35; flex:1; }
        /* Stacked layout - value below title */
        .define-item.stacked { flex-direction:column; gap:4px; grid-column: span 2; }
        .define-item.stacked .label { min-width:auto; }
        .define-item.stacked .label::after { content: ':'; }
        .define-item.stacked .value { width:100%; }
        /* Boxed stacked layout - rectangle container for value only */
        .define-item.stacked.boxed { 
            border: none; 
            border-radius: 0; 
            background: transparent; 
            padding: 0; 
            margin-top: 10px;
        }
        .define-item.stacked.boxed .label { 
            font-size: .76rem; 
            color: #1f2937; 
            font-weight: 700; 
            margin-bottom: 6px;
            padding-bottom: 0;
            border-bottom: none;
        }
        .define-item.stacked.boxed .value { 
            font-size: .74rem; 
            color: #374151; 
            line-height: 1.5; 
            background: #f9fafb;
            padding: 10px 12px;
            border-radius: 0;
            border: 1px solid #d1d5db;
        }
        /* Separator line between specific fields */
        .define-item.with-separator { border-top:2px solid #e2e8f0; padding-top:14px; margin-top:6px; }
        .define-list { margin:4px 0 0; padding-left:18px; }
        .define-list li { margin:2px 0; }
        
        @media print {
            @page { size:A4; margin:10mm; }
            
            /* Hide everything by default */
            html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
            body * { visibility:hidden !important; }
            
            /* Show printable area and all children */
            #investigationDetailsOverlay, 
            #investigationDetailsOverlay *, 
            .printable, 
            .printable * { visibility:visible !important; }
            
            /* Position and size the print area */
            #investigationDetailsOverlay { 
                position:absolute !important; 
                left:0 !important; 
                top:0 !important; 
                width:100% !important; 
                padding:0 !important; 
                background:transparent !important; 
                display:block !important;
                overflow:visible !important;
            }
            
            .modal-content, .inv-preview-container { 
                box-shadow:none !important; 
                border-radius:0 !important; 
                width:100% !important; 
                max-width:100% !important; 
                min-height:auto !important;
                overflow:visible !important;
            }
            
            .inv-sheet { 
                width:100% !important; 
                min-height:auto !important; 
                margin:0 !important; 
                padding:10mm !important; 
                border:none !important; 
                box-shadow:none !important; 
            }
            
            /* Hide buttons */
            .inv-print-btn, .inv-close-btn { display:none !important; }
            
            /* Table styling for print */
            .inv-info-table { 
                width:100% !important; 
                border-collapse:collapse !important;
                page-break-inside:auto !important;
            }
            
            .inv-info-table th { 
                background:#2c3e50 !important; 
                color:#fff !important; 
                -webkit-print-color-adjust:exact !important; 
                print-color-adjust:exact !important; 
            }
            
            .inv-info-table td {
                background:#fff !important;
                color:#111827 !important;
                border:1px solid #e5e7eb !important;
                -webkit-print-color-adjust:exact !important;
                print-color-adjust:exact !important;
            }
            
            .inv-info-table tr { 
                page-break-inside:avoid !important; 
            }
            /* Define section title - enhanced for print */
            .inv-section-title { 
                background: linear-gradient(135deg, #2c3e50, #34495e) !important; 
                color: #fff !important; 
                border: none !important;
                border-radius: 0 !important;
                padding: 10px 12px !important;
                page-break-after:avoid !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .inv-section-title i {
                color: #fff !important;
                font-size: 0.9rem !important;
                width: 24px !important;
                height: 24px !important;
                background: rgba(255,255,255,0.2) !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .define-grid { 
                grid-template-columns: 1fr !important; 
                gap:6px 0 !important; 
            }
            .define-item { 
                page-break-inside:avoid !important; 
                break-inside:avoid !important; 
                border:none !important; 
                background:transparent !important; 
                padding:0 0 6px 0 !important;
                margin:0 !important;
                display:flex !important;
                align-items:flex-start !important;
            }
            .define-item .label { min-width:160px !important; white-space:nowrap !important; }
            .define-item .value { flex:1 !important; }
            /* Stacked items in print - value below title */
            .define-item.stacked { flex-direction:column !important; gap:4px !important; }
            .define-item.stacked .label { min-width:auto !important; }
            .define-item.stacked .value { width:100% !important; }
            /* Boxed stacked items in print */
            .define-item.stacked.boxed { 
                border: none !important; 
                border-radius: 0 !important; 
                background: transparent !important; 
                padding: 0 !important; 
                margin-top: 8px !important;
                page-break-inside: avoid !important;
            }
            .define-item.stacked.boxed .label { 
                font-weight: 700 !important;
                padding-bottom: 0 !important;
                margin-bottom: 4px !important;
                border-bottom: none !important;
            }
            .define-item.stacked.boxed .value { 
                background: #f9fafb !important;
                padding: 8px 10px !important;
                border-radius: 0 !important;
                border: 1px solid #d1d5db !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* Separator line in print */
            .define-item.with-separator { 
                border-top: 2px solid #d1d5db !important; 
                padding-top: 12px !important; 
                margin-top: 8px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Hide generated timestamp in print */
            #invModalGenerated { display:none !important; }
            
            /* Section styling */
            .inv-sections { 
                display:flex !important; 
                flex-direction:column !important; 
                gap:12px !important; 
            }
            
            .inv-sections .section { 
                page-break-inside:avoid !important; 
                break-inside:avoid !important;
            }
            
            /* Header styling */
            .inv-header { 
                display:flex !important; 
                justify-content:space-between !important; 
                page-break-after:avoid !important; 
            }
            
            .inv-logo, #invModalLogo { 
                max-width:80px !important; 
                max-height:80px !important;
                -webkit-print-color-adjust:exact !important;
                print-color-adjust:exact !important;
            }
            
            .inv-logo-fallback { display:none !important; }
            
            /* Timeline styling for print */
            #invTimelineContainer { 
                page-break-inside:avoid !important; 
                overflow:visible !important;
                position:relative !important;
                background:transparent !important;
            }
            
            .event-timeline-viz { 
                page-break-inside:avoid !important; 
                background:transparent !important;
                border:none !important;
                -webkit-print-color-adjust:exact !important;
                print-color-adjust:exact !important;
                overflow:visible !important;
                position:relative !important;
            }
            
            .event-timeline-viz .timeline-track { 
                display:flex !important; 
                flex-wrap:wrap !important;
                position:relative !important;
                overflow:visible !important;
            }
            
            /* Ensure connectors display properly */
            .event-timeline-viz .timeline-connector {
                background:linear-gradient(90deg, #3b82f6, #8b5cf6) !important;
                -webkit-print-color-adjust:exact !important;
                print-color-adjust:exact !important;
                position:absolute !important;
                visibility:visible !important;
            }
            
            .event-timeline-viz .timeline-connector.vertical {
                background:linear-gradient(180deg, #3b82f6, #8b5cf6) !important;
            }
        }

        .filter-grid { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; min-width: 150px; flex: 1; }
        .filter-group label { font-size: 0.85rem; font-weight: 600; color: #374151; }
        .filter-group select, .filter-group input { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; background: white; }
        .filter-group:last-child { flex: 0 0 auto; min-width: auto; }
        .btn-filter { padding: 0.5rem 1rem; background: var(--info-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; }

        /* Table */
        .table-container { background: #fff; overflow: hidden; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .data-table th { background: #f8fafc; padding: 0.6rem 0.5rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 0.75rem; }
        .data-table td { padding: 0.5rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 0.75rem; }
        .data-table tbody tr:hover { background: #f8fafc; }

        /* Status badges */
        .status-badge { display: inline-flex; align-items: center; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .status-open { background: #fef3c7; color: #92400e; }
        .status-in-progress { background: #dbeafe; color: #1e40af; }
        .status-under-review { background: #fde68a; color: #a16207; }
        .status-closed { background: #dcfce7; color: #166534; }

        /* Priority badges */
        .priority-high { background: #fee2e2; color: #dc2626; font-size: 0.7rem; }
        .priority-medium { background: #fef3c7; color: #d97706; font-size: 0.7rem; }
        .priority-low { background: #ecfdf5; color: #059669; font-size: 0.7rem; }

        /* Action buttons */
        .action-btn { padding: 0.2rem 0.4rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.7rem; margin: 0 0.1rem; }
        .btn-view { background: #dbeafe; color: #1e40af; }
        .btn-edit { background: #dcfce7; color: #059669; }
        .btn-delete { background: #fee2e2; color: #dc2626; }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e2e8f0;
            background: #f8fafc;
            padding: 0 1rem;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-btn:hover { color: #1e293b; background: #f1f5f9; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Settings Panel */
        .settings-panel { padding: 1.5rem; }
        .settings-section { margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .settings-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }
        .settings-section-title:hover { background: #f1f5f9; }
        .settings-section-title i { color: var(--primary-color); }
        .settings-section-title .toggle-icon {
            margin-left: auto;
            transition: transform 0.3s ease;
            color: #64748b;
        }
        .settings-section.collapsed .settings-section-title .toggle-icon {
            transform: rotate(-90deg);
        }
        .settings-section-content {
            padding: 1rem;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
        }
        .settings-section.collapsed .settings-section-content {
            max-height: 0;
            padding: 0 1rem;
            opacity: 0;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .setting-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }
        .setting-card label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .setting-card input, .setting-card select, .setting-card textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            background: #fff;
        }
        .setting-card textarea { min-height: 80px; resize: vertical; }
        .setting-card .setting-help {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.35rem;
        }
        .setting-card .setting-unit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .setting-card .setting-unit input { flex: 1; }
        .setting-card .setting-unit span {
            font-size: 0.8rem;
            color: #64748b;
            white-space: nowrap;
        }
        .settings-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        .btn-save-settings {
            padding: 0.6rem 1.5rem;
            background: linear-gradient(135deg, var(--success-color), #1f9d55);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .btn-save-settings:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); }
        .btn-reset-settings {
            padding: 0.6rem 1.5rem;
            background: #fff;
            color: #64748b;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-reset-settings:hover { background: #f1f5f9; color: #1e293b; }

        /* Access Control Table */
        .access-control-card { margin-top: 1.5rem; }
        .access-control-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .access-control-header h3 { font-size: 1rem; font-weight: 600; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
        .access-control-header h3 i { color: var(--primary-color); }
        .access-control-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .access-control-table thead { background: #f1f5f9; }
        .access-control-table th { padding: 0.6rem 0.75rem; text-align: left; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .access-control-table td { padding: 0.6rem 0.75rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .access-control-table tbody tr:hover { background: #f8fafc; }
        .access-control-table .role-badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .access-control-table .role-badge.role-admin { background: #fef3c7; color: #b45309; }
        .access-control-table .role-badge.role-user { background: #dbeafe; color: #1d4ed8; }
        .access-control-table .role-badge.role-manager { background: #dcfce7; color: #16a34a; }
        .access-control-table input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .access-control-table .btn-remove { padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; }
        .access-control-table .btn-remove:hover { background: #fecaca; }

        /* Interactive Guide / Tour Styles */
        .guide-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9998; pointer-events: none; }
        .guide-highlight { position: absolute; box-shadow: 0 0 0 4px #3b82f6, 0 0 0 9999px rgba(0,0,0,0.5); border-radius: 8px; z-index: 9999; pointer-events: none; transition: all 0.3s ease; }
        .guide-tooltip { position: absolute; background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10000; max-width: 360px; min-width: 280px; }
        .guide-tooltip-arrow { position: absolute; width: 12px; height: 12px; background: #fff; transform: rotate(45deg); }
        .guide-tooltip-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .guide-tooltip-header .step-badge { background: #3b82f6; color: #fff; font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .guide-tooltip-header h4 { margin: 0; font-size: 1rem; font-weight: 600; color: #1e293b; }
        .guide-tooltip-body { font-size: 0.85rem; color: #475569; line-height: 1.5; margin-bottom: 1rem; }
        .guide-tooltip-footer { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .guide-tooltip-footer .guide-progress { font-size: 0.75rem; color: #94a3b8; }
        .guide-tooltip-footer .guide-buttons { display: flex; gap: 0.5rem; }
        .guide-btn { padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .guide-btn-skip { background: transparent; border: 1px solid #d1d5db; color: #64748b; }
        .guide-btn-skip:hover { background: #f1f5f9; }
        .guide-btn-prev { background: #f1f5f9; border: none; color: #475569; }
        .guide-btn-prev:hover { background: #e2e8f0; }
        .guide-btn-next { background: #3b82f6; border: none; color: #fff; }
        .guide-btn-next:hover { background: #2563eb; }
        .guide-btn-finish { background: #10b981; border: none; color: #fff; }
        .guide-btn-finish:hover { background: #059669; }
        .guide-start-btn { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(59,130,246,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .guide-start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59,130,246,0.5); }
        .guide-start-btn i { font-size: 1.2rem; }

        /* Video Tutorial Modal Styles */
        .video-tutorial-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .video-tutorial-overlay.active { display: flex; }
        .video-tutorial-container { background: #1a1a2e; border-radius: 16px; width: 90%; max-width: 900px; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.5); }
        .video-tutorial-header { background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
        .video-tutorial-header h3 { margin: 0; color: #fff; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
        .video-tutorial-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; transition: all 0.2s; }
        .video-tutorial-close:hover { background: rgba(255,255,255,0.3); }
        .video-tutorial-screen { position: relative; background: #0f0f1a; aspect-ratio: 16/9; overflow: hidden; }
        .video-tutorial-scene { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.5s ease; padding: 2rem; }
        .video-tutorial-scene.active { opacity: 1; }
        .video-tutorial-scene img { max-width: 100%; max-height: 100%; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .scene-content { text-align: center; color: #fff; }
        .scene-content .scene-icon { font-size: 4rem; margin-bottom: 1rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .scene-content h2 { font-size: 1.8rem; margin: 0 0 0.5rem 0; }
        .scene-content p { font-size: 1rem; color: #94a3b8; margin: 0; max-width: 500px; }
        .scene-demo { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .scene-demo-header { background: #2c3e50; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .scene-demo-dot { width: 10px; height: 10px; border-radius: 50%; }
        .scene-demo-dot.red { background: #ff5f56; }
        .scene-demo-dot.yellow { background: #ffbd2e; }
        .scene-demo-dot.green { background: #27ca40; }
        .scene-demo-body { flex: 1; background: #f8fafc; position: relative; overflow: hidden; }
        .scene-caption { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 2rem 1.5rem 1rem; }
        .scene-caption p { color: #fff; font-size: 1rem; margin: 0; text-align: center; }
        .cursor-pointer { position: absolute; width: 20px; height: 28px; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="%23ffffff" stroke="%23000000" stroke-width="24" d="M0 48v368c0 24 28 38 46 22l96-86 54 122c6 14 22 20 36 14l52-24c14-6 20-22 14-36l-54-122 122-8c26-2 38-34 20-52L46 6C28-12 0 2 0 28v20z"/></svg>') no-repeat top left; background-size: contain; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); transition: all 1s ease; z-index: 100; pointer-events: none; }
        .click-ripple { position: absolute; width: 40px; height: 40px; border: 3px solid #3b82f6; border-radius: 50%; animation: ripple 0.6s ease-out; pointer-events: none; }
        @keyframes ripple { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .highlight-box { position: absolute; border: 3px solid #3b82f6; border-radius: 8px; background: rgba(59,130,246,0.1); animation: pulse-highlight 1s ease infinite; }
        @keyframes pulse-highlight { 0%, 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.4); } 50% { box-shadow: 0 0 0 10px rgba(59,130,246,0); } }
        .video-tutorial-controls { background: #16162a; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; }
        .video-tutorial-progress { flex: 1; height: 6px; background: #2a2a4a; border-radius: 3px; overflow: hidden; cursor: pointer; }
        .video-tutorial-progress-bar { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 3px; transition: width 0.3s ease; }
        .video-tutorial-btn { background: transparent; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; transition: all 0.2s; }
        .video-tutorial-btn:hover { color: #3b82f6; }
        .video-tutorial-time { color: #94a3b8; font-size: 0.8rem; min-width: 80px; }
        .video-btn { position: fixed; bottom: 20px; right: 80px; background: linear-gradient(135deg, #ef4444, #f97316); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(239,68,68,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .video-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239,68,68,0.5); }
        .demo-dropdown { position: fixed; bottom: 80px; right: 80px; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1001; min-width: 220px; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; }
        .demo-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .demo-dropdown-header { padding: 0.75rem 1rem; background: linear-gradient(135deg, #ef4444, #f97316); color: #fff; font-weight: 600; font-size: 0.85rem; }
        .demo-dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f1f5f9; }
        .demo-dropdown-item:last-child { border-bottom: none; }
        .demo-dropdown-item:hover { background: #f8fafc; }
        .demo-dropdown-item i { width: 20px; font-size: 1rem; }
        .demo-dropdown-item .demo-icon-create { color: #3b82f6; }
        .demo-dropdown-item .demo-icon-edit { color: #10b981; }
        .demo-dropdown-item span { font-size: 0.85rem; color: #334155; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; width: 100%; padding-top: 5rem; }
            .top-nav { left: 0.5rem; right: 0.5rem; }
            .filter-grid { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; gap: 1rem; align-items: stretch; }
            .tab-navigation { overflow-x: auto; }
            .settings-grid { grid-template-columns: 1fr; }
        }
    </style>

    <!-- Firebase will be initialized in-page to match project-list.html header behavior -->
</head>
<body>
    <div class="app-container">
        <!-- Sidebar copied to match project-list.html exactly -->
        <nav class="sidebar menu-loading" id="sidebar">
            <div class="logo"><h2>Dreamex Datalab</h2></div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    <ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html" class="active">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                        <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
                        <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                        <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <!-- Project Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>
                <!-- Inventory Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                    <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                    <ul class="submenu">
                        <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                        <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                        <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                        <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                        <li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
                        <li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
                    </ul>
                </li>
                <!-- Workspaces: Catering -->
                <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                    <a href="#"><i class="fas fa-utensils"></i> Workspaces â€” Catering</a>
                    <ul class="submenu">
                        <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                        <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                        <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                        <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                        <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                    </ul>
                </li>
                <li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Navigation (same as dashboard) -->
            <nav class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="lang-switcher" style="margin-right:.5rem;">
                        <select id="langSelect" title="Language" style="padding:.25rem .5rem; border:1px solid #e5e7eb; border-radius:6px; font-size:.8rem; cursor:pointer;">
                            <option value="en">English</option>
                            <option value="fr">FranÃ§ais</option>
                        </select>
                    </div>
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list"></div>
                            <div class="notification-empty">
                                <i class="fas fa-inbox"></i>
                                <div class="notification-empty-title">No notifications</div>
                                <div class="notification-empty-message">You're all caught up</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" style="position:relative;">
                        <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                        <div class="profile-dropdown"><ul></ul></div>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <div class="content">
                <div class="page-header">
                    <div class="header-main">
                        <h1><i class="fas fa-list"></i> <span data-i18n="pageTitle">Investigation List</span></h1>
                    </div>
                    <div class="page-actions">
                        <a href="investigation-create.html" class="btn btn-create" title="New Investigation">
                            <i class="fas fa-plus"></i>
                        </a>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="investigations" onclick="switchTab('investigations')">
                        <i class="fas fa-list"></i> Investigations
                    </button>
                    <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>

                <!-- Investigations Tab -->
                <div class="tab-content active" id="investigationsTab">
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label for="statusFilter" data-i18n="status">Status</label>
                                <select id="statusFilter">
                                    <option value="" data-i18n="allStatus">All Status</option>
                                    <option value="Open" data-i18n="open">Open</option>
                                    <option value="In Progress" data-i18n="inProgress">In Progress</option>
                                    <option value="Under Review" data-i18n="underReview">Under Review</option>
                                    <option value="Closed" data-i18n="closed">Closed</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="priorityFilter" data-i18n="priority">Priority</label>
                                <select id="priorityFilter">
                                    <option value="" data-i18n="allPriorities">All Priorities</option>
                                    <option value="High" data-i18n="high">High</option>
                                    <option value="Medium" data-i18n="medium">Medium</option>
                                    <option value="Low" data-i18n="low">Low</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="investigatorFilter" data-i18n="investigator">Investigator</label>
                                <select id="investigatorFilter">
                                    <option value="" data-i18n="allInvestigators">All Investigators</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dateFromFilter" data-i18n="fromDate">From Date</label>
                                <input type="date" id="dateFromFilter">
                            </div>
                            <div class="filter-group">
                                <label for="dateToFilter" data-i18n="toDate">To Date</label>
                                <input type="date" id="dateToFilter">
                            </div>
                            <div class="filter-group">
                                <button class="btn-filter" id="applyFilters">
                                    <i class="fas fa-filter"></i> <span data-i18n="applyFilters">Apply Filters</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Investigation Table -->
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-i18n="investigationId">Investigation ID</th>
                                    <th data-i18n="title">Title</th>
                                    <th data-i18n="status">Status</th>
                                    <th data-i18n="priority">Priority</th>
                                    <th data-i18n="incidentDate">Incident Date</th>
                                    <th data-i18n="location">Location</th>
                                    <th data-i18n="leadInvestigator">Lead Investigator</th>
                                    <th data-i18n="createdDate">Created Date</th>
                                </tr>
                            </thead>
                            <tbody id="investigationsTableBody">
                                <!-- Investigation rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-content" id="settingsTab">
                    <div class="settings-panel">
                        <!-- Section Control Buttons -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn btn-outline" onclick="expandAllSettingsSections()" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                                <i class="fas fa-expand-alt"></i> Expand All
                            </button>
                            <button type="button" class="btn btn-outline" onclick="collapseAllSettingsSections()" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                                <i class="fas fa-compress-alt"></i> Collapse All
                            </button>
                        </div>

                        <!-- Lead Time Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" onclick="toggleSettingsSection(this)"><i class="fas fa-clock"></i> Lead Time Settings <i class="fas fa-chevron-down toggle-icon"></i></h3>
                            <div class="settings-section-content">
                            <div class="settings-grid">
                                <div class="setting-card">
                                    <label for="targetLeadTime">Target Lead Time (Days)</label>
                                    <div class="setting-unit">
                                        <input type="number" id="targetLeadTime" min="1" max="365" value="30">
                                        <span>days</span>
                                    </div>
                                    <div class="setting-help">Maximum days to complete an investigation from start to close</div>
                                </div>
                                <div class="setting-card">
                                    <label for="warningThreshold">Warning Threshold</label>
                                    <div class="setting-unit">
                                        <input type="number" id="warningThreshold" min="1" max="100" value="80">
                                        <span>% of lead time</span>
                                    </div>
                                    <div class="setting-help">Trigger warning when investigation reaches this % of target lead time</div>
                                </div>
                                <div class="setting-card">
                                    <label for="criticalThreshold">Critical Threshold</label>
                                    <div class="setting-unit">
                                        <input type="number" id="criticalThreshold" min="1" max="100" value="100">
                                        <span>% of lead time</span>
                                    </div>
                                    <div class="setting-help">Trigger critical alert when investigation exceeds this % of target</div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- KPI Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" onclick="toggleSettingsSection(this)"><i class="fas fa-chart-line"></i> KPI Targets <i class="fas fa-chevron-down toggle-icon"></i></h3>
                            <div class="settings-section-content">
                            <div class="settings-grid">
                                <div class="setting-card">
                                    <label for="monthlyTarget">Monthly Investigation Target</label>
                                    <div class="setting-unit">
                                        <input type="number" id="monthlyTarget" min="0" max="1000" value="10">
                                        <span>investigations</span>
                                    </div>
                                    <div class="setting-help">Target number of investigations to complete per month</div>
                                </div>
                                <div class="setting-card">
                                    <label for="closureRate">Target Closure Rate</label>
                                    <div class="setting-unit">
                                        <input type="number" id="closureRate" min="0" max="100" value="90">
                                        <span>%</span>
                                    </div>
                                    <div class="setting-help">Target percentage of investigations closed within lead time</div>
                                </div>
                                <div class="setting-card">
                                    <label for="qualityScore">Minimum Quality Score</label>
                                    <div class="setting-unit">
                                        <input type="number" id="qualityScore" min="0" max="100" value="85">
                                        <span>%</span>
                                    </div>
                                    <div class="setting-help">Minimum quality score required for investigation approval</div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- Priority Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" onclick="toggleSettingsSection(this)"><i class="fas fa-flag"></i> Priority Lead Times <i class="fas fa-chevron-down toggle-icon"></i></h3>
                            <div class="settings-section-content">
                            <div class="settings-grid">
                                <div class="setting-card">
                                    <label for="highPriorityDays">High Priority</label>
                                    <div class="setting-unit">
                                        <input type="number" id="highPriorityDays" min="1" max="365" value="7">
                                        <span>days</span>
                                    </div>
                                    <div class="setting-help">Lead time for high priority investigations</div>
                                </div>
                                <div class="setting-card">
                                    <label for="mediumPriorityDays">Medium Priority</label>
                                    <div class="setting-unit">
                                        <input type="number" id="mediumPriorityDays" min="1" max="365" value="14">
                                        <span>days</span>
                                    </div>
                                    <div class="setting-help">Lead time for medium priority investigations</div>
                                </div>
                                <div class="setting-card">
                                    <label for="lowPriorityDays">Low Priority</label>
                                    <div class="setting-unit">
                                        <input type="number" id="lowPriorityDays" min="1" max="365" value="30">
                                        <span>days</span>
                                    </div>
                                    <div class="setting-help">Lead time for low priority investigations</div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- Notification Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" onclick="toggleSettingsSection(this)"><i class="fas fa-bell"></i> Notification Settings <i class="fas fa-chevron-down toggle-icon"></i></h3>
                            <div class="settings-section-content">
                            <div class="settings-grid">
                                <div class="setting-card">
                                    <label for="reminderDays">Reminder Before Due</label>
                                    <div class="setting-unit">
                                        <input type="number" id="reminderDays" min="1" max="30" value="3">
                                        <span>days</span>
                                    </div>
                                    <div class="setting-help">Send reminder notification X days before due date</div>
                                </div>
                                <div class="setting-card">
                                    <label for="escalationEmail">Escalation Email</label>
                                    <input type="email" id="escalationEmail" placeholder="manager@company.com">
                                    <div class="setting-help">Email address for overdue investigation escalation</div>
                                </div>
                                <div class="setting-card">
                                    <label for="enableAutoReminders">Auto Reminders</label>
                                    <select id="enableAutoReminders">
                                        <option value="true">Enabled</option>
                                        <option value="false">Disabled</option>
                                    </select>
                                    <div class="setting-help">Automatically send reminder notifications</div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- Custom Categories -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" onclick="toggleSettingsSection(this)"><i class="fas fa-tags"></i> Investigation Categories <i class="fas fa-chevron-down toggle-icon"></i></h3>
                            <div class="settings-section-content">
                            <div class="settings-grid">
                                <div class="setting-card" style="grid-column: span 2;">
                                    <label for="investigationCategories">Categories (one per line)</label>
                                    <textarea id="investigationCategories" placeholder="Equipment Failure&#10;Human Error&#10;Process Deviation&#10;Environmental&#10;Near Miss&#10;Safety Incident">Equipment Failure
Human Error
Process Deviation
Environmental
Near Miss
Safety Incident</textarea>
                                    <div class="setting-help">Define custom investigation categories for classification</div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- Access Control Section -->
                        <div class="settings-section access-control-card">
                            <div class="access-control-header">
                                <h3 class="settings-section-title" onclick="toggleSettingsSection(this)" style="flex:1;border:none;background:none;padding:0;">
                                    <i class="fas fa-user-shield"></i> Access Control
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </h3>
                                <button type="button" class="btn btn-primary" title="Add user to access control" onclick="openInvAccessControlModal()" style="padding:0.4rem 0.6rem;font-size:0.75rem;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="settings-section-content">
                                <div class="table-wrapper" style="overflow-x:auto;">
                                    <table class="access-control-table" id="invAccessControlTable">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th style="text-align:center;">Investigations Tab</th>
                                                <th style="text-align:center;">View All Investigations</th>
                                                <th style="text-align:center;">Edit All Investigations</th>
                                                <th style="text-align:center;">Settings Tab</th>
                                                <th style="text-align:center;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invAccessControlTableBody">
                                            <!-- Access control rows will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="settings-actions">
                            <button class="btn-save-settings" onclick="saveInvestigationSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button class="btn-reset-settings" onclick="resetInvestigationSettings()">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Investigation Details Modal (Leave Preview style with company branding) -->
    <div class="modal-overlay" id="investigationDetailsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:flex-start; justify-content:center; overflow:auto; padding:32px 20px;">
        <div class="modal-content inv-preview-container" style="background:#fff; border-radius:12px; width:100%; max-width:940px; min-height:60vh; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:visible;">
            <!-- Print/Close buttons -->
            <button id="invPrintBtn" class="inv-print-btn" style="position:absolute; top:10px; right:10px; background:#111827; color:#fff; border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; z-index:10;"><i class="fas fa-print"></i> <span data-i18n="printPdf">Print / PDF</span></button>
            <button id="invCloseBtn" class="inv-close-btn" style="position:absolute; top:10px; right:120px; background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; z-index:10;" data-i18n="close">Close</button>
            
            <div class="inv-sheet printable" style="background:#fff; width:100%; padding:20px 24px 40px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827;">
                <!-- Header with Company Logo and Name -->
                <div class="inv-header" style="display:flex; justify-content:space-between; gap:20px; margin-bottom:0; align-items:flex-start;">
                    <div class="company-block" style="display:flex; flex-direction:column; align-items:flex-start; gap:8px;">
                        <img id="invModalLogo" class="inv-logo" src="" alt="Company Logo" style="width:100px; height:100px; object-fit:contain; border:none; border-radius:8px; background:#fff; display:none;">
                        <div id="invModalLogoFallback" class="inv-logo-fallback" style="width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px;"></div>
                        <div class="inv-company">
                            <h1 id="invModalCompanyName" style="margin:0; font-size:1.1rem; line-height:1.2; font-weight:700;"></h1>
                            <h2 class="doc-title" style="font-size:.9rem; font-weight:700; margin:2px 0 0; color:#111827; text-align:left;" data-i18n="investigationReport">Investigation Report</h2>
                        </div>
                    </div>
                    <div class="inv-meta" style="font-size:.63rem; color:#374151; text-align:right; line-height:1.35; min-width:150px;">
                        <div id="invModalGenerated" style="font-size:.55rem; color:#6b7280; font-weight:500;"></div>
                    </div>
                </div>
                
                <div class="divider" style="height:1px; background:#e5e7eb; margin:12px 0 18px; border-radius:1px;"></div>
                
                <!-- Document Number -->
                <div class="docmeta-row" style="font-size:.72rem; color:#111827; margin:6px 0 12px;">
                    <span style="font-weight:700; color:#374151; margin-right:6px;" data-i18n="documentNumber">Document Number:</span>
                    <span id="invModalDocNumber"></span>
                </div>
                
                <!-- Sections -->
                <div class="inv-sections" style="display:flex; flex-direction:column; gap:16px;">
                    <div class="section">
                        <div class="inv-section-title define-section" data-i18n="defineSection"><i class="fas fa-clipboard-list"></i><span class="section-text">Define - Incident Information</span></div>
                        <div id="invSectionDefine" class="define-grid"></div>
                    </div>
                    <div class="section">
                        <div class="inv-section-title measure-section" data-i18n="measureSection"><i class="fas fa-chart-bar"></i><span class="section-text">Measure - Data Collection & Analysis</span></div>
                        <table class="inv-info-table" style="width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px;">
                            <tbody id="invSectionMeasure"></tbody>
                        </table>
                        <div id="invTimelineContainer" style="margin-top:12px;"></div>
                    </div>
                    <div class="section">
                        <div class="inv-section-title analyze-section" data-i18n="analyzeSection"><i class="fas fa-search"></i><span class="section-text">Analyze - Root Cause Analysis</span></div>
                        <table class="inv-info-table" style="width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px;">
                            <tbody id="invSectionAnalyze"></tbody>
                        </table>
                    </div>
                    <div class="section">
                        <div class="inv-section-title improve-section" data-i18n="improveSection"><i class="fas fa-tools"></i><span class="section-text">Improve - Corrective Actions</span></div>
                        <table class="inv-info-table" style="width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px;">
                            <tbody id="invSectionImprove"></tbody>
                        </table>
                    </div>
                    <div class="section">
                        <div class="inv-section-title control-section" data-i18n="controlSection"><i class="fas fa-check-circle"></i><span class="section-text">Control - Verification & Lessons Learned</span></div>
                        <table class="inv-info-table" style="width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px;">
                            <tbody id="invSectionControl"></tbody>
                        </table>
                    </div>
                    <div class="section">
                        <div class="inv-section-title approval-section" data-i18n="approvalSection"><i class="fas fa-stamp"></i><span class="section-text">Approval Flow</span></div>
                        <div id="invSectionApproval" style="display:grid; gap:10px; margin-top:10px;"></div>
                    </div>
                    <!-- Approval Actions -->
                    <div id="invApprovalActions" class="section" style="display:none; padding-top:12px; border-top:1px solid #e2e8f0; margin-top:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button type="button" id="invEditBtn" onclick="editCurrentInvestigation()" style="background:#1f2937; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" id="invDeleteBtn" onclick="deleteCurrentInvestigation()" style="background:#dc2626; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button type="button" id="invDeclineBtn" onclick="declineCurrentInvestigation()" style="background:#ef4444; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                    <i class="fas fa-times"></i> Decline
                                </button>
                                <button type="button" id="invApproveBtn" onclick="approveCurrentInvestigation()" style="background:#10b981; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </div>
                        </div>
                        <!-- Comment input for approval/decline -->
                        <div id="invApprovalCommentSection" style="display:none; margin-top:10px;">
                            <label style="font-size:0.7rem; font-weight:600; color:#374151; display:block; margin-bottom:4px;">Comment (optional)</label>
                            <textarea id="invApprovalComment" style="width:100%; min-height:60px; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:0.75rem; resize:vertical;" placeholder="Add a comment for your decision..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Role-based menu authorization (copied from project-list.html) -->
    <script>
    // ===== ROLE-BASED MENU AUTHORIZATION SYSTEM =====
    let isMenuUpdateInProgress = false;

    function resetMenuVisibility() {
        document.querySelectorAll('[data-feature]').forEach(item => {
            item.classList.remove('menu-visible');
        });
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            dropdown.classList.remove('menu-visible');
        });
    }

    function showBasicMenu() {
        resetMenuVisibility();
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.classList.remove('menu-loading');
        const homeItem = document.querySelector('[data-feature="home_view"]');
        if (homeItem) homeItem.classList.add('menu-visible');
    }

    async function updateMenuWithFeatureAuthorization() {
        if (isMenuUpdateInProgress) return;
        isMenuUpdateInProgress = true;
        try {
            let currentUser = null, companyId = null, userRole = null;
            if (window.authManager && window.authManager.currentUser) {
                currentUser = window.authManager.currentUser;
                companyId = currentUser.companyId;
                userRole = currentUser.role;
            } else if (firebase.auth().currentUser) {
                currentUser = firebase.auth().currentUser;
            } else {
                resetMenuVisibility();
                return;
            }
            if (!companyId && currentUser) {
                const database = firebase.database();
                const companiesSnapshot = await database.ref('companies').once('value');
                if (companiesSnapshot.exists()) {
                    const companies = companiesSnapshot.val();
                    for (const [cId, company] of Object.entries(companies)) {
                        if (company.status !== 'active') continue;
                        if (company.users && company.users[currentUser.uid]) {
                            companyId = cId;
                            userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                            break;
                        }
                    }
                }
            }
            if (!companyId) { resetMenuVisibility(); return; }
            const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
            if (userRole) {
                await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
            } else {
                showSidebarAfterAuth();
            }
        } catch (e) {
            resetMenuVisibility();
        } finally {
            isMenuUpdateInProgress = false;
        }
    }

    async function applyFeatureBasedMenuVisibility(companyId) {
        try {
            const database = firebase.database();
            const featuresSnapshot = await database.ref('/platformFeatures').once('value');
            if (!featuresSnapshot.exists()) { resetMenuVisibility(); return []; }
            const featuresData = featuresSnapshot.val();
            const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
            const companyData = companySnapshot.val();
            if (!companyData) { resetMenuVisibility(); return []; }
            const subscribedFeatureIds = companyData.selectedFeatures || [];
            if (subscribedFeatureIds.length === 0) { resetMenuVisibility(); return []; }
            const authorizedPages = [];
            subscribedFeatureIds.forEach(featureId => {
                const feature = featuresData[featureId];
                if (feature && feature.status === 'active' && feature.authorizedPages) {
                    authorizedPages.push(...feature.authorizedPages);
                }
            });
            resetMenuVisibility();
            const authorizedFeatures = new Set();
            const authorizedHrefs = new Set();
            const featureAlias = (key) => {
                if (!key) return key;
                if (key === 'risk_view') return 'risk_management_section';
                if (key === 'risk_management_section') return 'risk_view';
                return null;
            };
            const normalizeHref = (href) => {
                if (!href) return '';
                try { const u = new URL(href, window.location.origin); return (u.pathname || '').replace(/^\//, ''); }
                catch { return String(href).replace(/^\//, ''); }
            };
            authorizedPages.forEach(pageInfo => {
                if (pageInfo.feature) {
                    authorizedFeatures.add(pageInfo.feature);
                    const alias = featureAlias(pageInfo.feature);
                    if (alias) authorizedFeatures.add(alias);
                }
                if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
                if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
                if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
            });
            const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
            allMenuItems.forEach(menuItem => {
                const featureAttribute = menuItem.getAttribute('data-feature');
                const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                const anchor = menuItem.querySelector('a[href]');
                const href = anchor ? anchor.getAttribute('href') : '';
                const normalized = normalizeHref(href);
                const featureAuthorized = authorizedFeatures.has(featureAttribute);
                const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
                const isAuthorized = featureAuthorized || hrefAuthorized;
                if (isDropdownContainer) return;
                if (isAuthorized) menuItem.classList.add('menu-visible');
                else menuItem.classList.remove('menu-visible');
            });
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                let hasVisibleChildren = false;
                submenuItems.forEach(submenuItem => { if (submenuItem.classList.contains('menu-visible')) hasVisibleChildren = true; });
                if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) dropdown.classList.add('menu-visible');
                else dropdown.classList.remove('menu-visible');
            });
            return authorizedPages;
        } catch (error) {
            resetMenuVisibility();
            return [];
        }
    }

    async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
        try {
            const database = firebase.database();
            const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
            const permissionsSnapshot = await permissionsRef.once('value');
            if (!permissionsSnapshot.exists()) {
                if (userRole === 'administrator') { showSidebarAfterAuth(); return; }
                hideItemsRequiringPermissions();
                showSidebarAfterAuth();
                return;
            }
            const permissions = permissionsSnapshot.val();
            filterMenuByPermissions(permissions);
        } catch (error) {
            showSidebarAfterAuth();
        }
    }

    function filterMenuByPermissions(permissions) {
        if (!permissions) { hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
        const permissionAlias = (key) => {
            if (!key) return key;
            if (key === 'risk_view') return 'risk_management_section';
            if (key === 'risk_management_section') return 'risk_view';
            return null;
        };
        const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
        itemsRequiringPermissions.forEach(item => {
            const requiresPermission = item.getAttribute('data-requires-permission');
            const aliasKey = permissionAlias(requiresPermission);
            const perm = permissions[requiresPermission];
            const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
            const hasViewPermission = (p) => p === true || (p && p.view === true);
            const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
            if (allowed) item.classList.add('menu-visible');
            else item.classList.remove('menu-visible');
        });
        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
            const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
            const dropdownFeature = dropdown.getAttribute('data-feature');
            const dropdownRequires = dropdown.getAttribute('data-requires-permission');
            if (submenuItems.length === 0) {
                if (dropdownRequires) {
                    const perm = permissions[dropdownRequires];
                    const aliasKey = permissionAlias(dropdownRequires);
                    const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
                    const hasViewPermission = (p) => p === true || (p && p.view === true);
                    const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
                    if (allowed) dropdown.classList.add('menu-visible'); else dropdown.classList.remove('menu-visible');
                } else {
                    dropdown.classList.remove('menu-visible');
                }
            }
        });
        ensureHomeIsVisible();
        showSidebarAfterAuth();
    }

    function hideItemsRequiringPermissions() {
        const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
        itemsRequiringPermissions.forEach(item => item.classList.remove('menu-visible'));
        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
            const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
            if (visibleSubmenuItems.length === 0) dropdown.classList.remove('menu-visible');
        });
        ensureHomeIsVisible();
    }

    function ensureHomeIsVisible() {
        const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
        if (homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
    }

    function showSidebarAfterAuth() {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.classList.remove('menu-loading');
    }

    function initializeMenuAuthorization() {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.classList.add('menu-loading');
        setTimeout(() => { updateMenuWithFeatureAuthorization(); }, 500);
    }

    window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
    window.debugMenuState = function() {
        const menuItems = document.querySelectorAll('[data-feature]');
        menuItems.forEach(item => {
            const feature = item.getAttribute('data-feature');
            const requiresPermission = item.getAttribute('data-requires-permission');
            const isVisible = item.classList.contains('menu-visible');
            console.log(`- ${feature}: requires=${requiresPermission}, visible=${isVisible}`);
        });
    };
    </script>

    <script>
        // Firebase configuration and initialization (copied pattern to match project-list.html)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('âœ… Firebase v8 initialized successfully for centralized auth');
            }
            return window.firebase;
        }
        const firebase = initializeFirebase();

        // Initialize role-based menu authorization (same behavior as project-list.html)
        if (typeof initializeMenuAuthorization === 'function') {
            // If function already defined, schedule it
            setTimeout(() => initializeMenuAuthorization(), 300);
        } else {
            // Wait until after scripts load
            window.addEventListener('DOMContentLoaded', () => {
                if (typeof initializeMenuAuthorization === 'function') {
                    initializeMenuAuthorization();
                }
            });
        }

        // ========== TRANSLATION SYSTEM ==========
        const translations = {
            en: {
                // Page title and header
                pageTitle: 'Investigation List',
                newInvestigation: 'New Investigation',
                // Filters
                status: 'Status',
                allStatus: 'All Status',
                open: 'Open',
                inProgress: 'In Progress',
                underReview: 'Under Review',
                closed: 'Closed',
                priority: 'Priority',
                allPriorities: 'All Priorities',
                high: 'High',
                medium: 'Medium',
                low: 'Low',
                investigator: 'Investigator',
                allInvestigators: 'All Investigators',
                fromDate: 'From Date',
                toDate: 'To Date',
                applyFilters: 'Apply Filters',
                // Table headers
                investigationId: 'Investigation ID',
                title: 'Title',
                incidentDate: 'Incident Date',
                location: 'Location',
                leadInvestigator: 'Lead Investigator',
                createdDate: 'Created Date',
                actions: 'Actions',
                // Modal
                printPdf: 'Print / PDF',
                close: 'Close',
                investigationReport: 'Investigation Report',
                documentNumber: 'Document Number',
                // Define section
                defineSection: 'Define - Incident Information',
                reference: 'Reference',
                incidentTime: 'Incident Time',
                reportedDate: 'Reported Date',
                department: 'Department',
                incidentType: 'Incident Type',
                classification: 'Classification',
                investigationPurpose: 'Investigation Purpose',
                investigationScope: 'Investigation Scope',
                investigationMethod: 'Investigation Method',
                description: 'Description',
                immediateActions: 'Immediate Actions',
                coordinates: 'Coordinates',
                investigationTeam: 'Investigation Team',
                personsInvolved: 'Persons Involved',
                equipmentInvolved: 'Equipment Involved',
                // Measure section
                measureSection: 'Measure - Data Collection & Analysis',
                severityActual: 'Severity (Actual)',
                potentialSeverity: 'Potential Severity',
                likelihood: 'Likelihood',
                peopleFactors: 'People Factors',
                equipmentFactors: 'Equipment Factors',
                environmentFactors: 'Environment Factors',
                procedures: 'Procedures',
                organizationFactors: 'Organization Factors',
                evidenceFiles: 'Evidence Files',
                exposureHours: 'Exposure Hours',
                trifr: 'TRIFR',
                ltifr: 'LTIFR',
                eventTimeline: 'Event Timeline',
                // Analyze section
                analyzeSection: 'Analyze - Root Cause Analysis',
                fiveWhysAnalysis: 'Five Whys Analysis',
                eventTreeAnalysis: 'Event Tree Analysis',
                dataCollected: 'Data Collected',
                analysisMethod: 'Analysis Method',
                keyFindings: 'Key Findings',
                residualRisk: 'Residual Risk',
                analysisSummary: 'Analysis Summary',
                immediateCauses: 'Immediate Causes',
                failedDefenses: 'Failed Defenses',
                individualTeamActions: 'Individual/Team Actions',
                taskEnvironmentalConditions: 'Task/Environmental Conditions',
                organizationalFactors: 'Organizational Factors',
                contributingFactorsAnalysis: 'Contributing Factors Analysis',
                humanFactors: 'Human Factors',
                managementSystemFactors: 'Management System Factors',
                technicalFactors: 'Technical Factors',
                additionalFactors: 'Additional Factors',
                // Improve section
                improveSection: 'Improve - Corrective Actions',
                recommendationsOwner: 'Recommendations Owner',
                targetDate: 'Target Date',
                verificationMethod: 'Verification Method',
                recommendations: 'Recommendations',
                correctiveActions: 'Corrective Actions',
                noCorrectiveActions: 'No corrective actions defined',
                owner: 'Owner',
                due: 'Due',
                // Control section
                controlSection: 'Control - Verification & Lessons Learned',
                verificationItems: 'Verification Items',
                lessonsLearned: 'Lessons Learned',
                verifiedBy: 'Verified By',
                date: 'Date',
                pending: 'Pending',
                // Approval section
                approvalSection: 'Approval Flow',
                investigationStatus: 'Investigation Status',
                assignedApprover: 'Assigned Approver',
                notAssigned: 'Not assigned',
                preparedBy: 'Prepared By',
                preparedDate: 'Prepared Date',
                reviewedBy: 'Reviewed By',
                reviewDate: 'Review Date',
                approvedBy: 'Approved By',
                approvalDate: 'Approval Date',
                approverComments: 'Approver Comments',
                additionalComments: 'Additional Comments',
                created: 'Created',
                lastUpdated: 'Last Updated',
                draft: 'Draft',
                // Notifications
                notifications: 'Notifications',
                markAllAsRead: 'Mark all as read',
                noNotifications: 'No notifications',
                allCaughtUp: "You're all caught up",
                // Table empty state
                noInvestigations: 'No investigations found',
                // Generated
                generated: 'Generated'
            },
            fr: {
                // Page title and header
                pageTitle: 'Liste des EnquÃªtes',
                newInvestigation: 'Nouvelle EnquÃªte',
                // Filters
                status: 'Statut',
                allStatus: 'Tous les Statuts',
                open: 'Ouvert',
                inProgress: 'En Cours',
                underReview: 'En RÃ©vision',
                closed: 'ClÃ´turÃ©',
                priority: 'PrioritÃ©',
                allPriorities: 'Toutes les PrioritÃ©s',
                high: 'Haute',
                medium: 'Moyenne',
                low: 'Basse',
                investigator: 'EnquÃªteur',
                allInvestigators: 'Tous les EnquÃªteurs',
                fromDate: 'Date de DÃ©but',
                toDate: 'Date de Fin',
                applyFilters: 'Appliquer les Filtres',
                // Table headers
                investigationId: 'ID EnquÃªte',
                title: 'Titre',
                incidentDate: "Date de l'Incident",
                location: 'Lieu',
                leadInvestigator: 'EnquÃªteur Principal',
                createdDate: 'Date de CrÃ©ation',
                actions: 'Actions',
                // Modal
                printPdf: 'Imprimer / PDF',
                close: 'Fermer',
                investigationReport: "Rapport d'EnquÃªte",
                documentNumber: 'NumÃ©ro de Document',
                // Define section
                defineSection: "DÃ©finir - Informations sur l'Incident",
                reference: 'RÃ©fÃ©rence',
                incidentTime: "Heure de l'Incident",
                reportedDate: 'Date de Signalement',
                department: 'DÃ©partement',
                incidentType: "Type d'Incident",
                classification: 'Classification',
                investigationPurpose: "Objectif de l'EnquÃªte",
                investigationScope: "PortÃ©e de l'EnquÃªte",
                investigationMethod: "MÃ©thode d'EnquÃªte",
                description: 'Description',
                immediateActions: 'Actions ImmÃ©diates',
                coordinates: 'CoordonnÃ©es',
                investigationTeam: "Ã‰quipe d'EnquÃªte",
                personsInvolved: 'Personnes ImpliquÃ©es',
                equipmentInvolved: 'Ã‰quipements ImpliquÃ©s',
                // Measure section
                measureSection: 'Mesurer - Collecte et Analyse des DonnÃ©es',
                severityActual: 'GravitÃ© (RÃ©elle)',
                potentialSeverity: 'GravitÃ© Potentielle',
                likelihood: 'ProbabilitÃ©',
                peopleFactors: 'Facteurs Humains',
                equipmentFactors: 'Facteurs Ã‰quipement',
                environmentFactors: 'Facteurs Environnementaux',
                procedures: 'ProcÃ©dures',
                organizationFactors: 'Facteurs Organisationnels',
                evidenceFiles: 'Fichiers de Preuves',
                exposureHours: "Heures d'Exposition",
                trifr: 'TRIFR',
                ltifr: 'LTIFR',
                eventTimeline: 'Chronologie des Ã‰vÃ©nements',
                // Analyze section
                analyzeSection: 'Analyser - Analyse des Causes Profondes',
                fiveWhysAnalysis: 'Analyse des 5 Pourquoi',
                eventTreeAnalysis: "Analyse de l'Arbre d'Ã‰vÃ©nements",
                dataCollected: 'DonnÃ©es CollectÃ©es',
                analysisMethod: "MÃ©thode d'Analyse",
                keyFindings: 'Conclusions ClÃ©s',
                residualRisk: 'Risque RÃ©siduel',
                analysisSummary: "RÃ©sumÃ© de l'Analyse",
                immediateCauses: 'Causes ImmÃ©diates',
                failedDefenses: 'DÃ©fenses DÃ©faillantes',
                individualTeamActions: "Actions Individuelles/d'Ã‰quipe",
                taskEnvironmentalConditions: 'Conditions de TÃ¢che/Environnementales',
                organizationalFactors: 'Facteurs Organisationnels',
                contributingFactorsAnalysis: 'Analyse des Facteurs Contributifs',
                humanFactors: 'Facteurs Humains',
                managementSystemFactors: 'Facteurs du SystÃ¨me de Gestion',
                technicalFactors: 'Facteurs Techniques',
                additionalFactors: 'Facteurs SupplÃ©mentaires',
                // Improve section
                improveSection: 'AmÃ©liorer - Actions Correctives',
                recommendationsOwner: 'Responsable des Recommandations',
                targetDate: 'Date Cible',
                verificationMethod: 'MÃ©thode de VÃ©rification',
                recommendations: 'Recommandations',
                correctiveActions: 'Actions Correctives',
                noCorrectiveActions: 'Aucune action corrective dÃ©finie',
                owner: 'Responsable',
                due: 'Ã‰chÃ©ance',
                // Control section
                controlSection: 'ContrÃ´ler - VÃ©rification et LeÃ§ons Apprises',
                verificationItems: 'Ã‰lÃ©ments de VÃ©rification',
                lessonsLearned: 'LeÃ§ons Apprises',
                verifiedBy: 'VÃ©rifiÃ© Par',
                date: 'Date',
                pending: 'En Attente',
                // Approval section
                approvalSection: "Flux d'Approbation",
                investigationStatus: "Statut de l'EnquÃªte",
                assignedApprover: 'Approbateur AssignÃ©',
                notAssigned: 'Non assignÃ©',
                preparedBy: 'PrÃ©parÃ© Par',
                preparedDate: 'Date de PrÃ©paration',
                reviewedBy: 'RÃ©visÃ© Par',
                reviewDate: 'Date de RÃ©vision',
                approvedBy: 'ApprouvÃ© Par',
                approvalDate: "Date d'Approbation",
                approverComments: "Commentaires de l'Approbateur",
                additionalComments: 'Commentaires SupplÃ©mentaires',
                created: 'CrÃ©Ã©',
                lastUpdated: 'DerniÃ¨re Mise Ã  Jour',
                draft: 'Brouillon',
                // Notifications
                notifications: 'Notifications',
                markAllAsRead: 'Tout marquer comme lu',
                noNotifications: 'Aucune notification',
                allCaughtUp: 'Vous Ãªtes Ã  jour',
                // Table empty state
                noInvestigations: 'Aucune enquÃªte trouvÃ©e',
                // Generated
                generated: 'GÃ©nÃ©rÃ©'
            }
        };

        let currentLang = localStorage.getItem('preferredLanguage') || 'en';

        function t(key) {
            return translations[currentLang]?.[key] || translations['en']?.[key] || key;
        }

        function applyTranslations() {
            // Page title
            document.title = t('pageTitle') + ' - Dreamex Datalab';
            
            // Header
            const pageHeader = document.querySelector('.page-header h1');
            if (pageHeader) pageHeader.innerHTML = `<i class="fas fa-list"></i> ${t('pageTitle')}`;
            
            const newInvBtn = document.querySelector('.btn-create');
            if (newInvBtn) newInvBtn.innerHTML = `<i class="fas fa-plus"></i> ${t('newInvestigation')}`;
            
            // Filters
            document.querySelector('label[for="statusFilter"]').textContent = t('status');
            const statusSelect = document.getElementById('statusFilter');
            if (statusSelect) {
                statusSelect.options[0].text = t('allStatus');
                statusSelect.options[1].text = t('open');
                statusSelect.options[2].text = t('inProgress');
                statusSelect.options[3].text = t('underReview');
                statusSelect.options[4].text = t('closed');
            }
            
            document.querySelector('label[for="priorityFilter"]').textContent = t('priority');
            const prioritySelect = document.getElementById('priorityFilter');
            if (prioritySelect) {
                prioritySelect.options[0].text = t('allPriorities');
                prioritySelect.options[1].text = t('high');
                prioritySelect.options[2].text = t('medium');
                prioritySelect.options[3].text = t('low');
            }
            
            document.querySelector('label[for="investigatorFilter"]').textContent = t('investigator');
            const invSelect = document.getElementById('investigatorFilter');
            if (invSelect && invSelect.options[0]) invSelect.options[0].text = t('allInvestigators');
            
            document.querySelector('label[for="dateFromFilter"]').textContent = t('fromDate');
            document.querySelector('label[for="dateToFilter"]').textContent = t('toDate');
            
            const applyBtn = document.getElementById('applyFilters');
            if (applyBtn) applyBtn.innerHTML = `<i class="fas fa-filter"></i> ${t('applyFilters')}`;
            
            // Table headers
            const ths = document.querySelectorAll('.data-table thead th');
            if (ths.length >= 9) {
                ths[0].textContent = t('investigationId');
                ths[1].textContent = t('title');
                ths[2].textContent = t('status');
                ths[3].textContent = t('priority');
                ths[4].textContent = t('incidentDate');
                ths[5].textContent = t('location');
                ths[6].textContent = t('leadInvestigator');
                ths[7].textContent = t('createdDate');
                ths[8].textContent = t('actions');
            }
            
            // Modal buttons
            const printBtn = document.getElementById('invPrintBtn');
            if (printBtn) printBtn.innerHTML = `<i class="fas fa-print"></i> ${t('printPdf')}`;
            const closeBtn = document.getElementById('invCloseBtn');
            if (closeBtn) closeBtn.textContent = t('close');
            
            // Modal doc title
            const docTitle = document.querySelector('.doc-title');
            if (docTitle) docTitle.textContent = t('investigationReport');
            
            // Document number label
            const docNumLabel = document.querySelector('.docmeta-row span:first-child');
            if (docNumLabel) docNumLabel.textContent = t('documentNumber') + ':';
            
            // Section titles - update span.section-text inside each section title
            const sectionTitles = document.querySelectorAll('.inv-section-title');
            const sectionKeys = ['defineSection', 'measureSection', 'analyzeSection', 'improveSection', 'controlSection', 'approvalSection'];
            sectionTitles.forEach((title, idx) => {
                const textSpan = title.querySelector('.section-text');
                if (textSpan && sectionKeys[idx]) {
                    textSpan.textContent = t(sectionKeys[idx]);
                }
            });
            
            // Notifications
            const notifHeader = document.querySelector('.notification-header h3');
            if (notifHeader) notifHeader.textContent = t('notifications');
            const markAllBtn = document.querySelector('.mark-all-read');
            if (markAllBtn) markAllBtn.textContent = t('markAllAsRead');
            const emptyTitle = document.querySelector('.notification-empty-title');
            if (emptyTitle) emptyTitle.textContent = t('noNotifications');
            const emptyMsg = document.querySelector('.notification-empty-message');
            if (emptyMsg) emptyMsg.textContent = t('allCaughtUp');
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('preferredLanguage', lang);
            applyTranslations();
            // Re-render investigations table if exists
            if (window.investigationListInstance) {
                window.investigationListInstance.renderInvestigations();
            }
        }

        // ========== END TRANSLATION SYSTEM ==========

        // AuthManager and header/profile/notifications logic (aligned with project-list.html)
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.currentCompany = null;
                this.init();
            }
            getCurrentUser() { try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; } }
            setCurrentUser(u) { localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser = u; }
            async init() {
                if (!this.currentUser) { window.location.href = 'login.html'; return; }
                await this.loadUserCompany();
                this.updateCompanyBranding();
                await this.updateUIForAuthenticatedUser();
                this.bindProfileDropdown();
            }
            async loadUserCompany() {
                if (!this.currentUser) return;
                try {
                    const snap = await firebase.database().ref('companies').once('value');
                    if (!snap.exists()) return; const companies = snap.val();
                    for (const [cid, comp] of Object.entries(companies)) {
                        if (comp.status !== 'active') continue;
                        if (comp.users) {
                            for (const [uid, u] of Object.entries(comp.users)) {
                                if (u.authUid === this.currentUser.uid || uid === this.currentUser.uid) {
                                    this.currentUser.companyId = cid; this.currentUser.companyName = comp.companyName; this.currentUser.role = u.role || u.userRole || 'user';
                                    this.currentCompany = comp; this.setCurrentUser(this.currentUser); return;
                                }
                            }
                        }
                    }
                } catch (e) { }
            }
            updateCompanyBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                const nameEl = document.getElementById('headerCompanyName');
                if (!this.currentCompany) { this.showFallbackBranding(); return; }
                if (nameEl) nameEl.textContent = this.currentCompany.companyName || '';
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoEl) {
                    if (logoUrl) { logoEl.src = logoUrl; logoEl.classList.add('visible'); }
                    else { const svg = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || '')); logoEl.src = svg; logoEl.classList.add('visible'); }
                }
                if (this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    if (this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                }
            }
            showFallbackBranding() { const logoEl = document.getElementById('headerCompanyLogo'); if (logoEl) { const svg = this.generateCompanyInitialsSVG('DX'); logoEl.src = svg; logoEl.classList.add('visible'); } }
            getCompanyInitials(name) { if (!name) return 'CO'; const parts = name.trim().split(/\s+/); if (parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
            generateCompanyInitialsSVG(initials) { const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
            getUserDisplayName() { if (!this.currentUser) return 'User'; const n=v=>typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){const cleaned=n(c); if(cleaned) return cleaned;} if (this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
            getUserInitials() { const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
            async getUserAvatarUrl() {
                if (!this.currentUser) return null; const companyId=this.currentUser.companyId||'default';
                const possiblePaths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`];
                for (const path of possiblePaths) { try { const ref=firebase.storage().ref(path); const url=await ref.getDownloadURL(); return url; } catch(err){ continue; } }
                return null;
            }
            async updateUIForAuthenticatedUser() {
                const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return;
                const displayName=this.getUserDisplayName(); const email=this.currentUser.email||'';
                let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); } catch(e){}
                const btnImg=btn.querySelector('img');
                if (avatarUrl && btnImg) { btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; }; }
                else { btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; }
                const avatarHtml = avatarUrl ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
                list.innerHTML = `<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href="account.html"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href="#" id="logoutLink"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`;
                list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); });
            }
            bindProfileDropdown() { const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click',e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
            async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } catch(error){ console.error('Logout error:', error); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } }
        }

        // Sidebar toggle like project-list
        function initializePage() {
            const sidebarToggle=document.getElementById('sidebarToggle');
            const sidebar=document.getElementById('sidebar');
            const mainContent=document.getElementById('mainContent');
            if (sidebarToggle) sidebarToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('sidebar-collapsed'); });
        }

        // Notifications logic
        function getAuthUser(){ if (window.authManager && window.authManager.currentUser) return window.authManager.currentUser; try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch{ return null; } }
        async function loadNotificationsOnce(){ const user=getAuthUser(); if(!user) return []; const db=firebase.database(); const snap=await db.ref(`notifications/${user.uid}`).once('value'); if(!snap.exists()) return []; const list=Object.entries(snap.val()).map(([id,v])=>({id,...v})); list.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)); return list; }
        async function markAllNotificationsAsRead(){ const user=getAuthUser(); if(!user) return; const db=firebase.database(); const ref=db.ref(`notifications/${user.uid}`); const snap=await ref.once('value'); if(!snap.exists()) return; const updates={}; Object.keys(snap.val()).forEach(k=> updates[`${k}/read`]=true); await ref.update(updates); updateNotificationBadgeCount([]); }
        async function markNotificationAsRead(id){ const user=getAuthUser(); if(!user||!id) return; await firebase.database().ref(`notifications/${user.uid}/${id}/read`).set(true); }
        async function deleteNotificationWithConfirm(id){ if(!confirm('Delete this notification?')) return; const user=getAuthUser(); if(!user||!id) return; await firebase.database().ref(`notifications/${user.uid}/${id}`).remove(); const notifications=await loadNotificationsOnce(); populateNotificationDropdown(notifications); }
        async function clearAllNotifications(){ if(!confirm('Delete all notifications? This cannot be undone.')) return; const user=getAuthUser(); if(!user) return; await firebase.database().ref(`notifications/${user.uid}`).remove(); }
        function formatTimeAgo(ts){ if(!ts) return 'Just now'; const diff=Date.now()-ts; const m=Math.floor(diff/60000); const h=Math.floor(diff/3600000); const d=Math.floor(diff/86400000); if(m<1) return 'Just now'; if(m<60) return `${m}m ago`; if(h<24) return `${h}h ago`; return `${d}d ago`; }
        function updateNotificationBadgeCount(notifications){ const badge=document.querySelector('.notification-badge'); if(!badge) return; const unread=notifications.filter(n=>!n.read).length; if(unread>0){ badge.textContent= unread>99 ? '99+' : String(unread); badge.style.display='block'; } else { badge.style.display='none'; } }
        function populateNotificationDropdown(notifications){ const listEl=document.querySelector('.notification-list'); const emptyEl=document.querySelector('.notification-empty'); if(!listEl) return; listEl.innerHTML=''; if(!notifications || notifications.length===0){ if(emptyEl) emptyEl.style.display='block'; updateNotificationBadgeCount([]); return; } if(emptyEl) emptyEl.style.display='none'; notifications.slice(0,10).forEach(n=>{ const div=document.createElement('div'); div.className=`notification-item ${n.read ? 'read' : 'unread'}`; div.innerHTML = `
                <div class="notification-content">
                    <div class="notification-title">${escapeHtml(n.title || 'New Notification')}</div>
                    <div class="notification-message">${escapeHtml(n.message || '')}</div>
                    <div class="notification-time">${formatTimeAgo(n.timestamp)}</div>
                </div>
                <div class="notification-actions">
                    ${!n.read ? `<button class=\"mark-read-btn\" title=\"Mark as read\" onclick=\"markNotificationAsRead('${n.id}')\"><i class=\"fas fa-check\"></i></button>` : `<button class=\"mark-read-btn\" title=\"Already read\" disabled><i class=\"fas fa-check\"></i></button>`}
                    <button class="delete-notification-btn" title="Delete notification" onclick="deleteNotificationWithConfirm('${n.id}')"><i class="fas fa-trash"></i></button>
                </div>
                ${!n.read ? '<div class="notification-dot"></div>' : ''}
            `; listEl.appendChild(div); }); updateNotificationBadgeCount(notifications); }
        function wireNotificationUI(){ const btn=document.getElementById('notificationBtn'); const dropdown=document.querySelector('.notification-dropdown'); const profileDropdown=document.querySelector('.profile-dropdown'); if(!btn||!dropdown) return; const header=dropdown.querySelector('.notification-header'); if(header && !header.querySelector('.clear-all-notifications')){ const clearBtn=document.createElement('button'); clearBtn.className='clear-all-notifications'; clearBtn.textContent='Clear all'; clearBtn.addEventListener('click', async ()=>{ await clearAllNotifications(); const list=await loadNotificationsOnce(); populateNotificationDropdown(list); }); header.appendChild(clearBtn); const markBtn=header.querySelector('.mark-all-read'); if(markBtn) markBtn.addEventListener('click', async ()=>{ await markAllNotificationsAsRead(); const list=await loadNotificationsOnce(); populateNotificationDropdown(list); }); }
            btn.addEventListener('click', async (e)=>{ e.stopPropagation(); dropdown.classList.toggle('show'); if(profileDropdown) profileDropdown.classList.remove('show'); if(dropdown.classList.contains('show')){ const list=await loadNotificationsOnce(); populateNotificationDropdown(list); } });
            document.addEventListener('click', (e)=>{ if(!btn.contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.remove('show'); }); }
        function subscribeNotifications(){ try{ const user=getAuthUser(); if(!user) return; const ref=firebase.database().ref(`notifications/${user.uid}`); ref.on('value', (snap)=>{ if(!snap.exists()){ updateNotificationBadgeCount([]); return; } const list=Object.values(snap.val()); updateNotificationBadgeCount(list); }); } catch(e) { /* noop */ } }
        function escapeHtml(str){ return String(str||'').replace(/[&<>"]+/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    class InvestigationList {
            constructor() {
                this.investigations = [];
                this.filteredInvestigations = [];
                this.init();
            }

            async init() {
                await this.loadInvestigations();
                this.populateFilters();
                this.renderInvestigations();
                this.setupEventListeners();
            }

            async loadInvestigations() {
                try {
                    // Get company context
                    const user = window.authManager?.currentUser;
                    const companyId = user?.companyId;
                    
                    if (!companyId) {
                        console.warn('No company context found, cannot load investigations');
                        this.investigations = [];
                        this.filteredInvestigations = [];
                        return;
                    }

                    const db = firebase.database();
                    
                    // Fetch investigations, approval flow, and access control in parallel
                    const [investigationsSnap, approvalFlowSnap, accessControlSnap] = await Promise.all([
                        db.ref(`companies/${companyId}/investigations`).once('value'),
                        db.ref(`companies/${companyId}/approvalFlows/investigation`).once('value'),
                        db.ref(`companies/${companyId}/investigationAccessControl/${user.uid}`).once('value')
                    ]);
                    
                    if (!investigationsSnap.exists()) {
                        console.log('No investigations found');
                        this.investigations = [];
                        this.filteredInvestigations = [];
                        return;
                    }

                    const data = investigationsSnap.val();
                    const approvalFlowData = approvalFlowSnap.exists() ? approvalFlowSnap.val() : null;
                    const accessControlData = accessControlSnap.exists() ? accessControlSnap.val() : {};
                    
                    // Check if user has "View All Investigations" permission
                    const canViewAllInvestigations = accessControlData.canViewAllInvestigations === true;
                    
                    // Get current user info for visibility check
                    const userUID = user.uid || '';
                    const userEmail = (user.email || '').toLowerCase().trim();
                    const userName = (user.displayName || user.name || '').toLowerCase().trim();
                    const userJobTitle = (user.jobTitle || '').toLowerCase().trim();
                    const userRole = (user.role || '').toLowerCase().trim();
                    const isAdmin = ['admin', 'super user', 'superuser'].includes(userRole);
                    
                    // Build list of approver identifiers from approval flow
                    const approverIdentifiers = [];
                    if (approvalFlowData?.selectedRoles) {
                        Object.values(approvalFlowData.selectedRoles).forEach(levelData => {
                            if (Array.isArray(levelData)) {
                                levelData.forEach(ap => {
                                    if (ap.value) approverIdentifiers.push(ap.value.toLowerCase().trim());
                                    if (ap.text) approverIdentifiers.push(ap.text.toLowerCase().trim());
                                });
                            }
                        });
                    }
                    
                    // Enhanced function to check if user is an approver for a specific investigation
                    const isApproverForInvestigation = async (investigation) => {
                        // Basic approval flow check (same as before)
                        const basicApproverCheck = () => {
                            // Check job title match
                            if (userJobTitle && approverIdentifiers.some(id => 
                                id.includes(userJobTitle) || userJobTitle.includes(id.replace('function_', '').replace(/_/g, ' ')))) {
                                return true;
                            }
                            // Check role match
                            if (userRole && approverIdentifiers.some(id => id.includes(userRole))) {
                                return true;
                            }
                            // Check name match
                            if (userName && approverIdentifiers.some(id => 
                                id === userName || id.includes(userName) || userName.includes(id))) {
                                return true;
                            }
                            // Check email/uid match
                            if (userEmail && approverIdentifiers.some(id => id.includes(userEmail.split('@')[0]))) {
                                return true;
                            }
                            if (userUID && approverIdentifiers.some(id => id.includes(userUID) || id.includes(`user_${userUID}`))) {
                                return true;
                            }
                            return false;
                        };
                        
                        if (basicApproverCheck()) return true;
                        
                        // Enhanced check: resolve L+1 for this specific investigation
                        if (approverIdentifiers.some(id => id === 'l+1')) {
                            try {
                                // Get the creator's line manager for this investigation
                                const creatorIdentifier = investigation.createdByEmail || 
                                    (String(investigation.createdBy || '').includes('@') ? investigation.createdBy : investigation.createdBy);
                                
                                // Resolve creator employee record
                                const creatorEmp = await resolveEmployeeRecord(creatorIdentifier, companyId);
                                if (creatorEmp && (creatorEmp.lineManagerId || creatorEmp.lineManager)) {
                                    const managerIdOrName = creatorEmp.lineManagerId || creatorEmp.lineManager;
                                    const managerInfo = await resolveLineManagerInfo(managerIdOrName, companyId);
                                    const lineManagerName = (managerInfo.name || '').toLowerCase().trim();
                                    
                                    // Check if current user matches the line manager
                                    if (lineManagerName && (
                                        userName === lineManagerName || 
                                        userName.includes(lineManagerName) || 
                                        lineManagerName.includes(userName)
                                    )) {
                                        return true;
                                    }
                                }
                            } catch (e) {
                                console.error('Error resolving L+1 for investigation:', investigation.id, e);
                            }
                        }

                        // Build resolved approver names list per investigation from approval flow
                        try {
                            const approverNamesResolved = [];
                            if (approvalFlowData && approvalFlowData.selectedRoles) {
                                const levels = Object.keys(approvalFlowData.selectedRoles)
                                    .filter(k => k.startsWith('level'))
                                    .sort((a,b)=> parseInt(a.replace('level','')) - parseInt(b.replace('level','')));
                                // Pre-resolve line manager once
                                let resolvedLineManagerName = '';
                                if (approverIdentifiers.some(id => id === 'l+1')) {
                                    const creatorIdentifier = investigation.createdByEmail || 
                                        (String(investigation.createdBy || '').includes('@') ? investigation.createdBy : investigation.createdBy);
                                    const creatorEmp = await resolveEmployeeRecord(creatorIdentifier, companyId);
                                    if (creatorEmp && (creatorEmp.lineManagerId || creatorEmp.lineManager)) {
                                        const managerIdOrName = creatorEmp.lineManagerId || creatorEmp.lineManager;
                                        const managerInfo = await resolveLineManagerInfo(managerIdOrName, companyId);
                                        resolvedLineManagerName = (managerInfo.name || '').toLowerCase().trim();
                                    }
                                }
                                for (const levelKey of levels) {
                                    const levelData = approvalFlowData.selectedRoles[levelKey] || [];
                                    for (const ap of levelData) {
                                        const textVal = (ap.text || '').toLowerCase().trim();
                                        const valueVal = (ap.value || '').toLowerCase().trim();
                                        if (textVal === 'l+1' || valueVal === 'l+1') {
                                            if (resolvedLineManagerName) approverNamesResolved.push(resolvedLineManagerName);
                                        } else if (textVal) {
                                            approverNamesResolved.push(textVal);
                                        }
                                    }
                                }
                            }
                            // Compare against user name variations
                            const userNameVariations = [
                                userName,
                                (user.displayName || '').toLowerCase().trim(),
                                (user.name || '').toLowerCase().trim(),
                                `${(user.firstName || '')} ${(user.lastName || '')}`.toLowerCase().trim()
                            ].filter(Boolean);
                            for (const approverName of approverNamesResolved) {
                                for (const variation of userNameVariations) {
                                    if (!variation) continue;
                                    if (approverName === variation) return true;
                                    if (approverName.length >= 3 && approverName.includes(variation)) return true;
                                    if (variation.length >= 3 && variation.includes(approverName)) return true;
                                }
                            }
                        } catch (e) {
                            // Safe fallback: no match
                        }
                        
                        return false;
                    };
                    
                    // Check if user is a general approver in the flow (for quick filtering)
                    const isApproverInFlow = () => {
                        // Check job title match
                        if (userJobTitle && approverIdentifiers.some(id => 
                            id.includes(userJobTitle) || userJobTitle.includes(id.replace('function_', '').replace(/_/g, ' ')))) {
                            return true;
                        }
                        // Check role match
                        if (userRole && approverIdentifiers.some(id => id.includes(userRole))) {
                            return true;
                        }
                        // Check name match
                        if (userName && approverIdentifiers.some(id => 
                            id === userName || id.includes(userName) || userName.includes(id))) {
                            return true;
                        }
                        // Check email/uid match
                        if (userEmail && approverIdentifiers.some(id => id.includes(userEmail.split('@')[0]))) {
                            return true;
                        }
                        if (userUID && approverIdentifiers.some(id => id.includes(userUID) || id.includes(`user_${userUID}`))) {
                            return true;
                        }
                        // Check if there's L+1 in the flow (we'll resolve this per investigation)
                        if (approverIdentifiers.some(id => id === 'l+1')) {
                            return true; // Potential approver, need to check per investigation
                        }
                        return false;
                    };
                    
                    const userIsApprover = isApproverInFlow();
                    
                    // Filter investigations based on visibility rules
                    const allInvestigations = Object.values(data);
                    
                    // For approvers, we need to check each investigation individually for L+1 resolution
                    const visibilityPromises = allInvestigations.map(async (inv) => {
                        // Admins can see all investigations
                        if (isAdmin) return { inv, visible: true };
                        
                        // Users with "View All Investigations" permission can see all
                        if (canViewAllInvestigations) return { inv, visible: true };
                        
                        // Creator can always see their own investigation
                        const isCreator = inv.createdBy === userUID || 
                                         inv.createdBy === userEmail ||
                                         inv.createdByEmail === userEmail;
                        if (isCreator) return { inv, visible: true };
                        
                        // Check approver status for non-draft investigations
                        const invStatus = (inv.investigationStatus || inv.status || 'draft').toLowerCase();
                        const isDraft = ['draft', 'created', 'new'].includes(invStatus);
                        
                        if (!isDraft && userIsApprover) {
                            // Use enhanced approver check that resolves L+1 for this specific investigation
                            const isApproverForThis = await isApproverForInvestigation(inv);
                            return { inv, visible: isApproverForThis };
                        }
                        
                        return { inv, visible: false };
                    });
                    
                    // Wait for all visibility checks to complete
                    const visibilityResults = await Promise.all(visibilityPromises);
                    const visibleInvestigations = visibilityResults
                        .filter(result => result.visible)
                        .map(result => result.inv);
                    
                    console.log('ðŸ“‹ Investigation visibility:', {
                        total: allInvestigations.length,
                        visible: visibleInvestigations.length,
                        isAdmin,
                        canViewAllInvestigations,
                        userIsApprover,
                        userName,
                        userJobTitle,
                        userRole
                    });

                    this.investigations = visibleInvestigations.map(inv => ({
                        id: inv.id || '',
                        title: inv.title || 'Untitled Investigation',
                        // Prefer the canonical investigationStatus field; fall back to status
                        status: (inv.investigationStatus || inv.status || 'Draft'),
                        priority: inv.priority || 'Medium',
                        incidentDate: inv.incidentDate || '',
                        location: inv.location || '',
                        leadInvestigator: inv.introTeamMembers?.find(m => m.role === 'Lead Investigator')?.employeeName || inv.preparedBy || 'Not Assigned',
                        createdDate: inv.createdDate ? String(inv.createdDate).split('T')[0] : '',
                        description: inv.description || ''
                    }));

                    this.filteredInvestigations = [...this.investigations];
                } catch (error) {
                    console.error('Error loading investigations:', error);
                    this.investigations = [];
                    this.filteredInvestigations = [];
                }
            }

            populateFilters() {
                const investigatorFilter = document.getElementById('investigatorFilter');
                const investigators = [...new Set(this.investigations.map(inv => inv.leadInvestigator))];
                
                investigators.forEach(investigator => {
                    const option = document.createElement('option');
                    option.value = investigator;
                    option.textContent = investigator;
                    investigatorFilter.appendChild(option);
                });
            }

            renderInvestigations() {
                const tableBody = document.getElementById('investigationsTableBody');
                
                if (this.filteredInvestigations.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem; color: #64748b;">
                                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <br>No investigations found
                            </td>
                        </tr>
                    `;
                    return;
                }

                tableBody.innerHTML = this.filteredInvestigations.map(investigation => `
                    <tr data-inv-id="${investigation.id}" style="cursor:pointer;">
                        <td><strong>${investigation.id}</strong></td>
                        <td>${investigation.title}</td>
                        <td><span class="status-badge status-${investigation.status.toLowerCase().replace(' ', '-')}">${investigation.status}</span></td>
                        <td><span class="status-badge priority-${investigation.priority.toLowerCase()}">${investigation.priority}</span></td>
                        <td>${new Date(investigation.incidentDate).toLocaleDateString()}</td>
                        <td>${investigation.location}</td>
                        <td>${investigation.leadInvestigator}</td>
                        <td>${new Date(investigation.createdDate).toLocaleDateString()}</td>
                    </tr>
                `).join('');

                // Row click opens modal (excluding clicks on action buttons)
                Array.from(tableBody.querySelectorAll('tr[data-inv-id]')).forEach(row => {
                    row.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.closest('button')) return; // ignore action button clicks
                        const invId = row.getAttribute('data-inv-id');
                        if (invId) openInvestigationModal(invId);
                    });
                });
            }

            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const investigatorFilter = document.getElementById('investigatorFilter').value;
                const dateFromFilter = document.getElementById('dateFromFilter').value;
                const dateToFilter = document.getElementById('dateToFilter').value;

                this.filteredInvestigations = this.investigations.filter(investigation => {
                    if (statusFilter && investigation.status !== statusFilter) return false;
                    if (priorityFilter && investigation.priority !== priorityFilter) return false;
                    if (investigatorFilter && investigation.leadInvestigator !== investigatorFilter) return false;
                    if (dateFromFilter && investigation.incidentDate < dateFromFilter) return false;
                    if (dateToFilter && investigation.incidentDate > dateToFilter) return false;
                    return true;
                });

                this.renderInvestigations();
            }

            setupEventListeners() {
                // Filter button
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                // Apply on any filter change
                ['statusFilter','priorityFilter','investigatorFilter','dateFromFilter','dateToFilter'].forEach(id => {
                    const el=document.getElementById(id); if (el) el.addEventListener('change', ()=> this.applyFilters());
                });
            }
        }

        // Action functions
        function viewInvestigation(id) {
            openInvestigationModal(id);
        }

        function editInvestigation(id) {
            window.location.href = `investigation-create.html?edit=${id}`;
        }

        function deleteInvestigation(id) {
            if (confirm(`Are you sure you want to delete investigation ${id}?`)) {
                const user = window.authManager?.currentUser;
                const companyId = user?.companyId;
                
                if (!companyId) {
                    alert('Error: Could not determine company context');
                    return;
                }
                
                const db = firebase.database();
                db.ref(`companies/${companyId}/investigations/${id}`).remove()
                    .then(() => {
                        alert('Investigation deleted successfully');
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error deleting investigation:', error);
                        alert('Error deleting investigation: ' + error.message);
                    });
            }
        }

        // Modal logic: fetch and display investigation details
        async function openInvestigationModal(investigationId) {
            try {
                const user = window.authManager?.currentUser;
                const companyId = user?.companyId;
                if (!companyId) { alert('No company context'); return; }
                
                // Show modal immediately with loading state
                const overlay = document.getElementById('investigationDetailsOverlay');
                if (overlay) overlay.style.display = 'flex';
                
                // Use cached company data from authManager if available
                let companyData = window.authManager?.currentCompany;
                
                // Fetch investigation data, approval flow, and company data (if not cached) in parallel
                const fetchPromises = [
                    firebase.database().ref(`companies/${companyId}/investigations/${investigationId}`).once('value'),
                    firebase.database().ref(`companies/${companyId}/approvalFlows/investigation`).once('value')
                ];
                
                if (!companyData) {
                    fetchPromises.push(firebase.database().ref(`companies/${companyId}`).once('value'));
                }
                
                const results = await Promise.all(fetchPromises);
                const snap = results[0];
                const approvalFlowSnap = results[1];
                
                if (!snap.exists()) { 
                    if (overlay) overlay.style.display = 'none';
                    alert('Investigation not found'); 
                    return; 
                }
                const data = snap.val();
                
                // Get approval flow configuration
                const approvalFlowData = approvalFlowSnap.exists() ? approvalFlowSnap.val() : null;
                
                // ============ VISIBILITY CHECK ============
                // Verify user has permission to view this investigation
                const userUID = user.uid || '';
                const userEmail = (user.email || '').toLowerCase().trim();
                const userName = (user.displayName || user.name || '').toLowerCase().trim();
                const userJobTitle = (user.jobTitle || '').toLowerCase().trim();
                const userRole = (user.role || '').toLowerCase().trim();
                const isAdmin = ['admin', 'super user', 'superuser'].includes(userRole);
                
                // Check if user is the creator
                const isCreator = data.createdBy === userUID || 
                                 data.createdBy === userEmail ||
                                 data.createdByEmail === userEmail;
                
                // Build approver identifiers from flow
                const approverIdentifiers = [];
                if (approvalFlowData?.selectedRoles) {
                    Object.values(approvalFlowData.selectedRoles).forEach(levelData => {
                        if (Array.isArray(levelData)) {
                            levelData.forEach(ap => {
                                if (ap.value) approverIdentifiers.push(ap.value.toLowerCase().trim());
                                if (ap.text) approverIdentifiers.push(ap.text.toLowerCase().trim());
                            });
                        }
                    });
                }
                
                // Enhanced approver check with L+1 resolution and multiple name variations
                const isApprover = async () => {
                    // Get all user name variations
                    const userNameVariations = [
                        userName,
                        (user.displayName || '').toLowerCase().trim(),
                        (user.name || '').toLowerCase().trim(),
                        `${(user.firstName || '')} ${(user.lastName || '')}`.toLowerCase().trim(),
                        (user.email || '').split('@')[0].toLowerCase().trim()
                    ].filter(n => n && n.length > 0);
                    
                    // Basic checks
                    if (userJobTitle && approverIdentifiers.some(id => 
                        id.includes(userJobTitle) || userJobTitle.includes(id.replace('function_', '').replace(/_/g, ' ')))) return true;
                    if (userRole && approverIdentifiers.some(id => id.includes(userRole))) return true;
                    if (userEmail && approverIdentifiers.some(id => id.includes(userEmail.split('@')[0]))) return true;
                    if (userUID && approverIdentifiers.some(id => id.includes(userUID) || id.includes(`user_${userUID}`))) return true;
                    
                    // Check all user name variations against approver names
                    for (const variation of userNameVariations) {
                        if (!variation || variation.length < 2) continue;
                        if (approverIdentifiers.some(id => 
                            id === variation || 
                            (id.length >= 3 && id.includes(variation)) || 
                            (variation.length >= 3 && variation.includes(id))
                        )) return true;
                    }
                    
                    // Check if there's L+1 in the flow and resolve it
                    if (approverIdentifiers.some(id => id === 'l+1')) {
                        try {
                            const creatorIdentifier = data.createdByEmail || 
                                (String(data.createdBy || '').includes('@') ? data.createdBy : data.createdBy);
                            const creatorEmp = await resolveEmployeeRecord(creatorIdentifier, companyId);
                            if (creatorEmp && (creatorEmp.lineManagerId || creatorEmp.lineManager)) {
                                const managerIdOrName = creatorEmp.lineManagerId || creatorEmp.lineManager;
                                const managerInfo = await resolveLineManagerInfo(managerIdOrName, companyId);
                                const lineManagerName = (managerInfo.name || '').toLowerCase().trim();
                                
                                // Check if current user matches the resolved line manager
                                for (const variation of userNameVariations) {
                                    if (!variation || variation.length < 2) continue;
                                    if (lineManagerName === variation ||
                                        (lineManagerName.length >= 3 && lineManagerName.includes(variation)) ||
                                        (variation.length >= 3 && variation.includes(lineManagerName))) {
                                        return true;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Error resolving L+1 for modal visibility:', e);
                        }
                    }
                    
                    return false;
                };
                
                const invStatus = (data.investigationStatus || data.status || 'draft').toLowerCase();
                const isSubmitted = !['draft', 'created', 'new'].includes(invStatus);
                
                // Visibility rules: admin OR creator OR (approver AND submitted)
                const canView = isAdmin || isCreator || (await isApprover() && isSubmitted);
                
                if (!canView) {
                    if (overlay) overlay.style.display = 'none';
                    alert('You do not have permission to view this investigation.');
                    return;
                }
                // ============ END VISIBILITY CHECK ============
                
                // Get company data from cache or fetch result
                if (!companyData && results[2]) {
                    companyData = results[2].val() || {};
                }
                companyData = companyData || {};
                
                const companyName = companyData.companyName || companyData.name || '';
                const logoEl = document.getElementById('headerCompanyLogo');
                const logoSrc = (logoEl && logoEl.src && logoEl.classList.contains('visible')) ? logoEl.src : (companyData.logo || companyData.logoUrl || '');

                // Set company logo
                const modalLogo = document.getElementById('invModalLogo');
                const logoFallback = document.getElementById('invModalLogoFallback');
                if (logoSrc) {
                    if (modalLogo) { modalLogo.src = logoSrc; modalLogo.style.display = 'block'; }
                    if (logoFallback) logoFallback.style.display = 'none';
                } else {
                    if (modalLogo) modalLogo.style.display = 'none';
                    if (logoFallback) {
                        logoFallback.style.display = 'flex';
                        logoFallback.textContent = (companyName || 'CN').split(/\s+/).map(w => w[0]).slice(0, 3).join('').toUpperCase();
                    }
                }

                // Set company name
                const companyNameEl = document.getElementById('invModalCompanyName');
                if (companyNameEl) companyNameEl.textContent = companyName || 'Company';

                // Set generated timestamp
                const now = new Date();
                const generatedStr = `Generated: ${now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}, ${now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
                const generatedEl = document.getElementById('invModalGenerated');
                if (generatedEl) generatedEl.textContent = generatedStr;

                // Set document number
                const docNumberEl = document.getElementById('invModalDocNumber');
                if (docNumberEl) docNumberEl.textContent = data.id || investigationId;

                // Helper to create table row
                const tr = (labelKey, label, value) => value ? `<tr><td>${escapeHtml(t(labelKey) || label)}</td><td>${escapeHtml(value)}</td></tr>` : '';
                const trHtml = (labelKey, label, html) => html ? `<tr><td>${escapeHtml(t(labelKey) || label)}</td><td>${html}</td></tr>` : '';

                // Define Section - render as cards/grid (no table)
                const define = document.getElementById('invSectionDefine');
                if (define) {
                    const di = (labelKey, label, value) => value ? `<div class="define-item"><div class="label">${escapeHtml(t(labelKey) || label)}</div><div class="value">${escapeHtml(value)}</div></div>` : '';
                    const diStacked = (labelKey, label, value, withSeparator = false) => value ? `<div class="define-item stacked${withSeparator ? ' with-separator' : ''}"><div class="label">${escapeHtml(t(labelKey) || label)}</div><div class="value">${escapeHtml(value)}</div></div>` : '';
                    const diStackedBoxed = (labelKey, label, value) => value ? `<div class="define-item stacked boxed"><div class="label">${escapeHtml(t(labelKey) || label)}</div><div class="value">${escapeHtml(value)}</div></div>` : '';
                    const diHtml = (labelKey, label, html) => html ? `<div class="define-item"><div class="label">${escapeHtml(t(labelKey) || label)}</div><div class="value">${html}</div></div>` : '';
                    const diHtmlStacked = (labelKey, label, html, withSeparator = false) => html ? `<div class="define-item stacked${withSeparator ? ' with-separator' : ''}"><div class="label">${escapeHtml(t(labelKey) || label)}</div><div class="value">${html}</div></div>` : '';
                    const diHtmlStackedBoxed = (labelKey, label, html) => html ? `<div class="define-item stacked boxed"><div class="label">${escapeHtml(t(labelKey) || label)}</div><div class="value">${html}</div></div>` : '';

                    const teamHtml = Array.isArray(data.introTeamMembers) && data.introTeamMembers.length
                        ? `<ul class="define-list">${data.introTeamMembers.map(m => `<li>${escapeHtml(m.employeeName || '')}${m.role? ' ('+escapeHtml(m.role)+')':''}</li>`).join('')}</ul>` : '';
                    const personsHtml = Array.isArray(data.personsInvolved) && data.personsInvolved.length
                        ? `<ul class="define-list">${data.personsInvolved.map(p => `<li>${escapeHtml(p.name || '')}${p.company? ' - '+escapeHtml(p.company):''}${p.jobTitle? ' ('+escapeHtml(p.jobTitle)+')':''}</li>`).join('')}</ul>` : '';
                    const equipmentHtml = Array.isArray(data.equipmentInvolved) && data.equipmentInvolved.length
                        ? `<ul class="define-list">${data.equipmentInvolved.map(e => `<li>${escapeHtml(e.name || '')}${e.type? ' ('+escapeHtml(e.type)+')':''}${e.condition? ' - '+escapeHtml(e.condition):''}</li>`).join('')}</ul>` : '';

                    define.innerHTML = [
                        // Row 1: Reference & Title
                        di('reference', 'Reference', data.id || ''),
                        di('title', 'Title', data.title || ''),
                        // Row 2: Status & Priority
                        di('status', 'Status', data.status || ''),
                        di('priority', 'Priority', data.priority || ''),
                        // Row 3: Incident Date & Reported Date
                        di('incidentDate', 'Incident Date', data.incidentDate ? new Date(data.incidentDate).toLocaleDateString() : ''),
                        di('reportedDate', 'Reported Date', data.reportedDate ? new Date(data.reportedDate).toLocaleDateString() : ''),
                        // Row 4: Location & Department
                        di('location', 'Location', data.location || ''),
                        di('department', 'Department', data.department || ''),
                        // Row 5: Incident Type & Coordinates
                        di('incidentType', 'Incident Type', data.incidentType || ''),
                        (data.incidentLocation?.latitude ? di('coordinates', 'Coordinates', `${data.incidentLocation.latitude}, ${data.incidentLocation.longitude}`) : di('incidentTime', 'Incident Time', data.incidentTime || '')),
                        // Row 6: Classification & Incident Time (if coordinates exist)
                        di('classification', 'Classification', data.classification || ''),
                        (data.incidentLocation?.latitude ? di('incidentTime', 'Incident Time', data.incidentTime || '') : ''),
                        // Full-width boxed stacked fields
                        diStackedBoxed('investigationPurpose', 'Investigation Purpose', data.investigationPurpose || ''),
                        diStackedBoxed('investigationScope', 'Investigation Scope', data.investigationScope || ''),
                        diStackedBoxed('investigationMethod', 'Investigation Method', data.investigationMethod || ''),
                        diStackedBoxed('description', 'Description', data.description || ''),
                        diStackedBoxed('immediateActions', 'Immediate Actions', data.immediateActions || ''),
                        diHtmlStackedBoxed('investigationTeam', 'Investigation Team', teamHtml),
                        diHtmlStackedBoxed('personsInvolved', 'Persons Involved', personsHtml),
                        diHtmlStackedBoxed('equipmentInvolved', 'Equipment Involved', equipmentHtml)
                    ].join('');
                }

                // Measure Section
                const measure = document.getElementById('invSectionMeasure');
                if (measure) {
                    let evidenceHtml = data.evidence?.length ? data.evidence.map(e => escapeHtml(e.name || e.fileName || '')).join('<br/>') : '';
                    
                    measure.innerHTML = `
                        ${tr('severityActual', 'Severity (Actual)', data.severityActual || '')}
                        ${tr('potentialSeverity', 'Potential Severity', data.severityPotential || '')}
                        ${tr('likelihood', 'Likelihood', data.likelihood || '')}
                        ${tr('peopleFactors', 'People Factors', data.peepo?.peopleFactors || '')}
                        ${tr('equipmentFactors', 'Equipment Factors', data.peepo?.equipmentFactors || '')}
                        ${tr('environmentFactors', 'Environment Factors', data.peepo?.environmentFactors || '')}
                        ${tr('procedures', 'Procedures', data.peepo?.procedures || '')}
                        ${tr('organizationFactors', 'Organization Factors', data.peepo?.organizationFactorsP1 || '')}
                        ${trHtml('evidenceFiles', 'Evidence Files', evidenceHtml)}
                        ${tr('exposureHours', 'Exposure Hours', data.dataAnalysis?.exposureHours || '')}
                        ${tr('trifr', 'TRIFR', data.dataAnalysis?.trifr || '')}
                        ${tr('ltifr', 'LTIFR', data.dataAnalysis?.ltifr || '')}
                    `;
                }

                // Timeline visualization
                const timelineContainer = document.getElementById('invTimelineContainer');
                if (timelineContainer && data.timelineEvents?.length) {
                    timelineContainer.innerHTML = `
                        <div style="font-weight:600; margin-bottom:8px; font-size:.72rem;" data-i18n="eventTimeline">${t('eventTimeline') || 'Event Timeline'}:</div>
                        <div class="event-timeline-viz" style="background:#f8fafc; border-radius:8px; padding:1rem; border:1px solid #e2e8f0; position:relative; overflow:visible;">
                            <div id="modalTimelineTrack" class="timeline-track" style="position:relative; overflow:visible;"></div>
                        </div>
                    `;
                    setTimeout(() => renderTimelineVisualization(data.timelineEvents), 100);
                } else if (timelineContainer) {
                    timelineContainer.innerHTML = '';
                }

                // Analyze Section
                const analyze = document.getElementById('invSectionAnalyze');
                if (analyze) {
                    analyze.innerHTML = `
                        ${tr('fiveWhysAnalysis', 'Five Whys Analysis', data.fiveWhys || '')}
                        ${tr('eventTreeAnalysis', 'Event Tree Analysis', data.eventTree || '')}
                        ${tr('dataCollected', 'Data Collected', data.dataAnalysis?.dataCollected || '')}
                        ${tr('analysisMethod', 'Analysis Method', data.dataAnalysis?.analysisMethod || '')}
                        ${tr('keyFindings', 'Key Findings', data.dataAnalysis?.keyFindings || '')}
                        ${tr('residualRisk', 'Residual Risk', data.dataAnalysis?.riskResidual || '')}
                        ${tr('analysisSummary', 'Analysis Summary', data.dataAnalysis?.analysisSummary || '')}
                        ${tr('immediateCauses', 'Immediate Causes', data.rootCauseAnalysis?.immediateCauses || '')}
                        ${tr('failedDefenses', 'Failed Defenses', data.rootCauseAnalysis?.failedDefenses || '')}
                        ${tr('individualTeamActions', 'Individual/Team Actions', data.rootCauseAnalysis?.individualTeamActions || '')}
                        ${tr('taskEnvironmentalConditions', 'Task/Environmental Conditions', data.rootCauseAnalysis?.taskEnvConditions || '')}
                        ${tr('organizationalFactors', 'Organizational Factors', data.rootCauseAnalysis?.orgFactors || '')}
                        ${tr('contributingFactorsAnalysis', 'Contributing Factors Analysis', data.contributingFactors?.analysis || '')}
                        ${tr('humanFactors', 'Human Factors', data.contributingFactors?.humanFactors || '')}
                        ${tr('managementSystemFactors', 'Management System Factors', data.contributingFactors?.msFactors || '')}
                        ${tr('technicalFactors', 'Technical Factors', data.contributingFactors?.technicalFactors || '')}
                        ${tr('additionalFactors', 'Additional Factors', data.contributingFactors?.additionalFactors || '')}
                    `;
                }

                // Improve Section
                const improve = document.getElementById('invSectionImprove');
                if (improve) {
                    let actionsHtml = Array.isArray(data.correctiveActions) && data.correctiveActions.length
                        ? data.correctiveActions.map(a => `<strong>${escapeHtml(a.description || a.title || '')}</strong><br/>${t('owner') || 'Owner'}: ${escapeHtml(a.owner || '')} | ${t('status') || 'Status'}: ${escapeHtml(a.status || '')} | ${t('priority') || 'Priority'}: ${escapeHtml(a.priority || '')} | ${t('due') || 'Due'}: ${a.targetDate ? new Date(a.targetDate).toLocaleDateString() : 'N/A'}`).join('<br/><br/>')
                        : t('noCorrectiveActions') || 'No corrective actions defined';
                    let recsHtml = Array.isArray(data.recommendations) && data.recommendations.length
                        ? data.recommendations.map(r => escapeHtml(r.description || r.title || '')).join('<br/>')
                        : '';
                    
                    improve.innerHTML = `
                        ${tr('recommendationsOwner', 'Recommendations Owner', data.recommendationsMeta?.owner || '')}
                        ${tr('targetDate', 'Target Date', data.recommendationsMeta?.targetDate ? new Date(data.recommendationsMeta.targetDate).toLocaleDateString() : '')}
                        ${tr('priority', 'Priority', data.recommendationsMeta?.priority || '')}
                        ${tr('verificationMethod', 'Verification Method', data.recommendationsMeta?.verification || '')}
                        ${trHtml('recommendations', 'Recommendations', recsHtml)}
                        ${trHtml('correctiveActions', 'Corrective Actions', actionsHtml)}
                    `;
                }

                // Control Section
                const control = document.getElementById('invSectionControl');
                if (control) {
                    let verificationHtml = Array.isArray(data.verificationItems) && data.verificationItems.length
                        ? data.verificationItems.map(v => `<strong>${escapeHtml(v.item || '')}</strong> - ${t('status') || 'Status'}: ${escapeHtml(v.status || t('pending') || 'Pending')} | ${t('verifiedBy') || 'Verified By'}: ${escapeHtml(v.verifiedBy || '')} | ${t('date') || 'Date'}: ${v.verificationDate ? new Date(v.verificationDate).toLocaleDateString() : 'N/A'}`).join('<br/>')
                        : '';
                    let lessons = Array.isArray(data.lessonsLearned) ? data.lessonsLearned.join('; ') : (data.lessonsLearned || '');
                    
                    control.innerHTML = `
                        ${trHtml('verificationItems', 'Verification Items', verificationHtml)}
                        ${tr('lessonsLearned', 'Lessons Learned', lessons)}
                    `;
                }

                // Approval Section - render with leave modal style design
                const approval = document.getElementById('invSectionApproval');
                
                // Only show approval section if investigation is submitted for review (not draft)
                const investigationStatus = (data.investigationStatus || 'draft').toLowerCase();
                const isSubmittedForReview = !['draft', 'created', 'new'].includes(investigationStatus);
                
                if (approval) {
                    let approvalHtml = '';
                    
                    if (!isSubmittedForReview) {
                        // Show message that approval section will be available after submission
                        approvalHtml = `
                            <div style="border:1px solid #e2e8f0; border-radius:6px; padding:20px; background:#f9fafb; text-align:center;">
                                <div style="font-size:0.8rem; color:#6b7280; margin-bottom:8px;">ðŸ“‹ Approval Flow</div>
                                <div style="font-size:0.75rem; color:#374151;">The approval flow and approval buttons will be available once this investigation is submitted for review.</div>
                            </div>
                        `;
                        approval.innerHTML = approvalHtml;
                        
                        // Store empty data for buttons logic
                        window._currentInvestigationId = investigationId;
                        window._currentInvestigationData = data;
                        window._currentApprovalFlowData = approvalFlowData;
                        window._currentResolvedLineManager = null;
                        window._currentResolvedLineManagerJobTitle = null;
                        
                        // Setup buttons (will hide approval buttons for draft status)
                        setupApprovalButtons(data, approvalFlowData, companyId);
                        return;
                    }
                    
                    // Resolve line manager from creator's employee record FIRST (needed for L+1 in approval flow)
                    let lineManagerDisplay = data.lineManager || '';
                    let lineManagerJobTitle = '';
                    const creatorIdentifier = data.createdByEmail || (String(data.createdBy || '').includes('@') ? data.createdBy : data.createdBy);
                    try {
                        // Resolve creator employee record by UID or email
                        const creatorEmp = await resolveEmployeeRecord(creatorIdentifier, companyId);
                        if (creatorEmp && (creatorEmp.lineManagerId || creatorEmp.lineManager)) {
                            const managerIdOrName = creatorEmp.lineManagerId || creatorEmp.lineManager;
                            const managerInfo = await resolveLineManagerInfo(managerIdOrName, companyId);
                            lineManagerDisplay = managerInfo.name || lineManagerDisplay;
                            lineManagerJobTitle = managerInfo.jobTitle || lineManagerJobTitle;
                        }
                    } catch (e) {
                        console.error('Error resolving line manager:', e);
                    }
                    
                    // Store resolved line manager for approval button matching (L+1 resolution)
                    window._currentResolvedLineManager = lineManagerDisplay;
                    window._currentResolvedLineManagerJobTitle = lineManagerJobTitle;
                    
                    // Build signature & job title lookup maps from company users (like leave modal)
                    let signatureMap = {}; let signatureMapById = {}; let jobTitleById = {}; let jobTitleByName = {}; let fullNameById = {}; let fullNameByName = {};
                    try {
                        const usersSnap = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                        const usersVal = usersSnap.val() || {};
                        Object.entries(usersVal).forEach(([uid, u]) => {
                            if (!u) return;
                            const nm = (u.displayName || u.name || u.fullName || u.email || '').trim();
                            const sig = u.signatureUrl || null;
                            const rawJob = (u.jobTitle || u.title || u.designation || u.positionTitle || u.position || u.role || '').trim();
                            const prettyJob = rawJob ? rawJob.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';
                            if (uid && nm) fullNameById[uid] = nm;
                            if (nm) fullNameByName[nm.toLowerCase()] = nm;
                            if (nm && sig) signatureMap[nm.toLowerCase()] = sig;
                            if (uid && sig) signatureMapById[uid] = sig;
                            if (uid && prettyJob) jobTitleById[uid] = prettyJob;
                            if (nm && prettyJob) jobTitleByName[nm.toLowerCase()] = prettyJob;
                        });
                    } catch(e) { console.warn('Signature map build failed', e); }
                    
                    // Build approval flow table (same design as leave details modal PDF)
                    if (approvalFlowData && approvalFlowData.selectedRoles) {
                        const sortedLevels = Object.keys(approvalFlowData.selectedRoles)
                            .filter(key => key.startsWith('level'))
                            .sort((a, b) => parseInt(a.replace('level', '')) - parseInt(b.replace('level', '')));
                        
                        // Build table rows
                        let tableRows = '';
                        for (const levelKey of sortedLevels) {
                            const levelNum = parseInt(levelKey.replace('level', ''));
                            const levelData = approvalFlowData.selectedRoles[levelKey];
                            
                            // Process names, replacing L+1 with actual line manager name
                            let approverNames = [];
                            if (Array.isArray(levelData)) {
                                for (const ap of levelData) {
                                    let displayName = ap.text || '';
                                    const isL1Token = String(displayName).toLowerCase() === 'l+1' || String(ap.value).toLowerCase() === 'l+1';
                                    if (isL1Token) {
                                        if (lineManagerDisplay) {
                                            displayName = lineManagerDisplay;
                                        } else {
                                            displayName = 'Line Manager (Not Assigned)';
                                        }
                                    }
                                    if (displayName) approverNames.push({ name: displayName, isL1: isL1Token });
                                }
                            }
                            
                            if (approverNames.length > 0) {
                                // Check if this level has approval history
                                const levelHistory = (data.approvalHistory || []).find(h => h.level === levelNum);
                                
                                // Build per-approver status/timestamp/signature
                                const statuses = [];
                                const timestamps = [];
                                const statusClasses = [];
                                const signatures = [];
                                
                                for (let i = 0; i < approverNames.length; i++) {
                                    if (levelHistory && i === 0) {
                                        const status = String(levelHistory.status || '').toLowerCase();
                                        const when = levelHistory.submittedAt ? new Date(levelHistory.submittedAt).toLocaleString() : '-';
                                        const sEff = status === 'approved' ? 'Approved' : status === 'rejected' ? 'Declined' : 'Pending';
                                        statuses.push(sEff);
                                        timestamps.push(when);
                                        statusClasses.push(status === 'approved' ? 'approved' : (status === 'rejected' ? 'declined' : 'pending'));
                                        
                                        // Get signature
                                        let sigUrl = levelHistory.signatureUrl || levelHistory.signature || '';
                                        if (!sigUrl && status === 'approved') {
                                            const uid = levelHistory.userId;
                                            if (uid && signatureMapById[uid]) {
                                                sigUrl = signatureMapById[uid];
                                            } else {
                                                const approverNameLc = (levelHistory.userName || '').toLowerCase();
                                                if (approverNameLc && signatureMap[approverNameLc]) {
                                                    sigUrl = signatureMap[approverNameLc];
                                                }
                                            }
                                        }
                                        signatures.push(sigUrl);
                                    } else {
                                        statuses.push('Pending');
                                        timestamps.push('-');
                                        statusClasses.push('pending');
                                        signatures.push('');
                                    }
                                }
                                
                                // Build approver HTML with job title for approved
                                const approverHtml = approverNames.map((ap, idx) => {
                                    const isApproved = statusClasses[idx] === 'approved';
                                    let jobTitle = '';
                                    let fullName = '';
                                    
                                    if (levelHistory && idx === 0) {
                                        const uid = levelHistory.userId;
                                        if (uid && fullNameById[uid]) fullName = fullNameById[uid];
                                        else if (fullNameByName[ap.name.toLowerCase()]) fullName = fullNameByName[ap.name.toLowerCase()];
                                        
                                        if (isApproved) {
                                            if (uid && jobTitleById[uid]) jobTitle = jobTitleById[uid];
                                            else if (jobTitleByName[ap.name.toLowerCase()]) jobTitle = jobTitleByName[ap.name.toLowerCase()];
                                        }
                                    }
                                    
                                    // Use actual approver name from history if approved
                                    const mainText = (isApproved && levelHistory) ? (levelHistory.userName || fullName || ap.name) : ap.name;
                                    
                                    let parts = [`<span class="approver-fullname">${escapeHtml(mainText)}</span>`];
                                    if (jobTitle && isApproved) {
                                        parts.push(`<span class="approver-job">${escapeHtml(jobTitle)}</span>`);
                                    }
                                    return `<div>${parts.join('<br>')}</div>`;
                                }).join('');
                                
                                const statusHtml = statuses.map((s, idx) => {
                                    return `<div><span class="status-chip ${statusClasses[idx]}">${s}</span></div>`;
                                }).join('');
                                
                                const tsHtml = timestamps.map(t => `<div>${t}</div>`).join('');
                                
                                const signatureHtml = signatures.map((sigUrl, idx) => {
                                    if (statusClasses[idx] === 'approved' && sigUrl) {
                                        return `<div><img src="${sigUrl}" alt="Signature" class="sig-img"/></div>`;
                                    }
                                    return `<div style="height:14px;"></div>`;
                                }).join('');
                                
                                tableRows += `
                                    <tr class="leave-approval-flow-level" data-level="${levelNum}">
                                        <td>${approverHtml}</td>
                                        <td>${statusHtml}</td>
                                        <td class="ts-cell">${tsHtml}</td>
                                        <td><div class="sig-stack">${signatureHtml}</div></td>
                                    </tr>
                                `;
                            }
                        }
                        
                        // Add table with styling matching leave modal PDF
                        approvalHtml += `
                            <style>
                                .inv-approval-table { width:100%; border-collapse:collapse; font-size:0.68rem; }
                                .inv-approval-table th { background:#2c3e50; font-weight:600; font-size:0.6rem; color:#ffffff; padding:8px 6px; border:1px solid #2c3e50; text-align:left; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                                .inv-approval-table td { padding:8px 6px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                                .inv-approval-table td.ts-cell, .inv-approval-table td.ts-cell div { white-space:nowrap; }
                                .inv-approval-table .status-chip { display:inline-block; font-size:0.6rem; font-weight:600; padding:2px 8px; border-radius:12px; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                                .inv-approval-table .status-chip.approved { background:#d1fae5; color:#065f46; }
                                .inv-approval-table .status-chip.declined { background:#fee2e2; color:#991b1b; }
                                .inv-approval-table .status-chip.pending { background:#e5e7eb; color:#374151; }
                                .inv-approval-table .sig-img { max-width:120px; max-height:50px; object-fit:contain; display:block; }
                                .inv-approval-table .sig-stack { display:flex; flex-direction:column; gap:4px; }
                                .inv-approval-table .approver-job { font-size:0.58rem; color:#6b7280; display:block; }
                                .inv-approval-table .approver-fullname { font-size:0.65rem; color:#1f2937; display:block; font-weight:600; }
                                @media print {
                                    .inv-approval-table th { background:#2c3e50 !important; color:#ffffff !important; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
                                    .inv-approval-table .status-chip { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
                                    .inv-approval-table .status-chip.approved { background:#d1fae5 !important; color:#065f46 !important; }
                                    .inv-approval-table .status-chip.declined { background:#fee2e2 !important; color:#991b1b !important; }
                                    .inv-approval-table .status-chip.pending { background:#e5e7eb !important; color:#374151 !important; }
                                }
                            </style>
                            <div style="margin-top:10px;">
                                <div style="font-weight:600; font-size:0.75rem; margin-bottom:8px;">Approval Flow & History</div>
                                <table class="inv-approval-table">
                                    <thead>
                                        <tr>
                                            <th>Approver(s)</th>
                                            <th style="width:80px;">Status</th>
                                            <th style="width:130px;">Timestamp</th>
                                            <th style="width:140px;">Signature</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else if (approvalFlowData && Array.isArray(approvalFlowData.levels)) {
                        // Fallback: use levels array with table format
                        let tableRows = '';
                        approvalFlowData.levels.forEach(level => {
                            if (level.value) {
                                let displayName = level.value;
                                if (displayName.startsWith('function_')) {
                                    displayName = displayName.replace('function_', '').replace(/_/g, ' ');
                                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                                } else if (displayName.startsWith('user_')) {
                                    displayName = displayName.replace('user_', '').replace(/_/g, ' ');
                                }
                                
                                tableRows += `
                                    <tr>
                                        <td><span class="approver-fullname">${escapeHtml(displayName)}</span></td>
                                        <td><span class="status-chip pending">Pending</span></td>
                                        <td>-</td>
                                        <td><div style="height:14px;"></div></td>
                                    </tr>
                                `;
                            }
                        });
                        
                        approvalHtml += `
                            <style>
                                .inv-approval-table { width:100%; border-collapse:collapse; font-size:0.68rem; }
                                .inv-approval-table th { background:#2c3e50; font-weight:600; font-size:0.6rem; color:#ffffff; padding:8px 6px; border:1px solid #2c3e50; text-align:left; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                                .inv-approval-table td { padding:8px 6px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                                .inv-approval-table .status-chip { display:inline-block; font-size:0.6rem; font-weight:600; padding:2px 8px; border-radius:12px; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                                .inv-approval-table .status-chip.pending { background:#e5e7eb; color:#374151; }
                                .inv-approval-table .approver-fullname { font-size:0.65rem; color:#1f2937; display:block; font-weight:600; }
                                @media print {
                                    .inv-approval-table th { background:#2c3e50 !important; color:#ffffff !important; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
                                    .inv-approval-table .status-chip { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
                                    .inv-approval-table .status-chip.pending { background:#e5e7eb !important; color:#374151 !important; }
                                }
                            </style>
                            <div style="margin-top:10px;">
                                <div style="font-weight:600; font-size:0.75rem; margin-bottom:8px;">Approval Flow & History</div>
                                <table class="inv-approval-table">
                                    <thead>
                                        <tr>
                                            <th>Approver(s)</th>
                                            <th style="width:80px;">Status</th>
                                            <th style="width:130px;">Timestamp</th>
                                            <th style="width:140px;">Signature</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        approvalHtml += `<div style="color:#6c757d; font-size:0.75rem; padding:10px;">No approval flow configured for investigations.</div>`;
                    }
                    
                    // Resolve creator's name and job title if createdBy is a UID
                    let preparedByDisplay = data.preparedBy || data.createdByName || '';
                    let preparedByJobTitle = data.createdByJobTitle || '';
                    if (!preparedByDisplay && data.createdBy) {
                        try {
                            const creatorInfo = await resolveUserDisplayInfo(data.createdBy, companyId);
                            preparedByDisplay = creatorInfo.name || data.createdBy;
                            preparedByJobTitle = creatorInfo.jobTitle || '';
                        } catch (e) {
                            preparedByDisplay = data.createdBy;
                        }
                    }
                    const preparedByText = preparedByJobTitle ? `${preparedByDisplay} (${preparedByJobTitle})` : preparedByDisplay;
                    const lineManagerText = lineManagerJobTitle ? `${lineManagerDisplay} (${lineManagerJobTitle})` : lineManagerDisplay;

                    // Document information (no container, just text)
                    approvalHtml += `
                        <div style="margin-top:10px;">
                            <div class="doc-info-row" style="display:flex; flex-wrap:nowrap; gap:16px; font-size:0.68rem; align-items:center;">
                                <div style="white-space:nowrap;"><span style="color:#6b7280;">Prepared By:</span> <span style="font-weight:500;">${escapeHtml(preparedByText || '-')}</span></div>
                                <div style="white-space:nowrap;"><span style="color:#6b7280;">Created:</span> <span style="font-weight:500;">${data.createdDate ? new Date(data.createdDate).toLocaleString() : '-'}</span></div>
                                <div style="white-space:nowrap;"><span style="color:#6b7280;">Last Updated:</span> <span style="font-weight:500;">${data.updatedDate ? new Date(data.updatedDate).toLocaleString() : '-'}</span></div>
                            </div>
                        </div>
                    `;
                    
                    // Comments section
                    if (data.approverComments || data.approvalComments2) {
                        approvalHtml += `
                            <div style="border:1px solid #e2e8f0; border-radius:6px; padding:10px; background:#fff;">
                                <div style="font-size:0.7rem; font-weight:600; margin-bottom:8px; color:#374151;">Comments</div>
                                ${data.approverComments ? `<div style="font-size:0.68rem; margin-bottom:6px;"><span style="color:#6b7280;">Approver Comments:</span> <span>${escapeHtml(data.approverComments)}</span></div>` : ''}
                                ${data.approvalComments2 ? `<div style="font-size:0.68rem;"><span style="color:#6b7280;">Additional Comments:</span> <span>${escapeHtml(data.approvalComments2)}</span></div>` : ''}
                            </div>
                        `;
                    }
                    
                    // If there is an approval history entry with signature, render it like leave modal
                    try {
                        const historyObj = data.history || data.approvalHistory || null;
                        let latestApprovalWithSignature = null;
                        if (historyObj && typeof historyObj === 'object') {
                            const entries = Array.isArray(historyObj) ? historyObj : Object.values(historyObj);
                            latestApprovalWithSignature = entries
                                .filter(h => h && (h.type === 'approval' || String(h.status||'').toLowerCase()==='approved'))
                                .sort((a,b)=> (b.timestamp||0) - (a.timestamp||0))[0];
                        }
                        if (latestApprovalWithSignature && (latestApprovalWithSignature.signatureUrl || latestApprovalWithSignature.signature)) {
                            const sigUrl = latestApprovalWithSignature.signatureUrl || latestApprovalWithSignature.signature;
                            const approverName = latestApprovalWithSignature.by || latestApprovalWithSignature.userName || latestApprovalWithSignature.byEmail || 'Approver';
                            const when = latestApprovalWithSignature.timestamp ? new Date(latestApprovalWithSignature.timestamp).toLocaleString() : '';
                            approvalHtml += `
                                <div style="border:1px solid #e2e8f0; border-radius:6px; padding:10px; background:#fff; margin-top:4px; display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px;">
                                    <div>
                                        <div style="font-size:.75rem; color:#374151; font-weight:700;">Approved by</div>
                                        <div style="font-size:.74rem; color:#111827;">${escapeHtml(approverName)}</div>
                                        <div style="font-size:.7rem; color:#6b7280;">${escapeHtml(when)}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <img src="${escapeHtml(sigUrl)}" alt="Signature" style="max-height:48px; max-width:160px; object-fit:contain; border:1px solid #e5e7eb; border-radius:4px; padding:3px; background:#fafafa;"/>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) { /* ignore rendering issues */ }

                    approval.innerHTML = approvalHtml;
                }

                // Store current investigation data for approval actions
                window._currentInvestigationId = investigationId;
                window._currentInvestigationData = data;
                window._currentApprovalFlowData = approvalFlowData;

                // Show/hide approval action buttons based on user role and approval flow
                setupApprovalButtons(data, approvalFlowData, companyId);

                // Modal is already shown at start - just bind event handlers
                const close = () => { 
                    overlay.style.display = 'none';
                    // Reset stored data
                    window._currentInvestigationId = null;
                    window._currentInvestigationData = null;
                    window._currentApprovalFlowData = null;
                    window._currentResolvedLineManager = null;
                    window._currentResolvedLineManagerJobTitle = null;
                };
                document.getElementById('invCloseBtn')?.addEventListener('click', close, { once: true });
                const printBtn = document.getElementById('invPrintBtn');
                if (printBtn) printBtn.onclick = () => window.print();
                
            } catch (e) {
                console.error('Failed to open investigation details:', e);
                const overlay = document.getElementById('investigationDetailsOverlay');
                if (overlay) overlay.style.display = 'none';
                alert('Failed to open investigation details: ' + e.message);
            }
        }

        // Removed resolveInvestigationApproverName - approver should be stored directly in investigation data

        function escapeHtml(str) {
            if (str == null) return '';
            return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        // Debug function to check approval button state
        window.debugApprovalButtons = function() {
            console.log('ðŸ”§ DEBUG: Current approval button state');
            const actionsContainer = document.getElementById('invApprovalActions');
            const approveBtn = document.getElementById('invApproveBtn');
            const declineBtn = document.getElementById('invDeclineBtn');
            console.log({
                actionsContainer: actionsContainer ? actionsContainer.style.display : 'not found',
                approveBtn: approveBtn ? approveBtn.style.display : 'not found',
                declineBtn: declineBtn ? declineBtn.style.display : 'not found',
                currentUser: window.authManager?.currentUser,
                currentInvestigationData: window._currentInvestigationData,
                currentApprovalFlowData: window._currentApprovalFlowData,
                resolvedLineManager: window._currentResolvedLineManager
            });
        };

        // Setup approval buttons visibility based on user role and approval flow
        async function setupApprovalButtons(data, approvalFlowData, companyId) {
            console.log('🚀 setupApprovalButtons called with:', { 
                data: data ? { id: data.id, status: data.investigationStatus, createdBy: data.createdBy } : null,
                approvalFlowData: approvalFlowData ? Object.keys(approvalFlowData) : null,
                companyId,
                hasSelectedRoles: approvalFlowData?.selectedRoles ? Object.keys(approvalFlowData.selectedRoles) : null
            });
            
            // Check if user has "Edit All Investigations" permission
            let canEditAllInvestigations = false;
            try {
                const user = window.authManager?.currentUser;
                if (user && companyId) {
                    const db = firebase.database();
                    const accessSnap = await db.ref(`companies/${companyId}/investigationAccessControl/${user.uid}`).once('value');
                    if (accessSnap.exists()) {
                        canEditAllInvestigations = accessSnap.val().canEditAllInvestigations === true;
                    }
                }
            } catch (e) {
                console.warn('Failed to check edit all permission:', e);
            }

            const actionsContainer = document.getElementById('invApprovalActions');
            const approveBtn = document.getElementById('invApproveBtn');
            const declineBtn = document.getElementById('invDeclineBtn');
            const editBtn = document.getElementById('invEditBtn');
            const deleteBtn = document.getElementById('invDeleteBtn');
            const commentSection = document.getElementById('invApprovalCommentSection');
            
            console.log('ðŸŽ¯ DOM Elements Found:', {
                actionsContainer: !!actionsContainer,
                approveBtn: !!approveBtn,
                declineBtn: !!declineBtn,
                editBtn: !!editBtn,
                deleteBtn: !!deleteBtn,
                commentSection: !!commentSection
            });
            
            // Hide all by default
            if (actionsContainer) actionsContainer.style.display = 'none';
            if (approveBtn) approveBtn.style.display = 'none';
            if (declineBtn) declineBtn.style.display = 'none';
            if (editBtn) editBtn.style.display = 'none';
            if (deleteBtn) deleteBtn.style.display = 'none';
            if (commentSection) commentSection.style.display = 'none';
            
            const user = window.authManager?.currentUser;
            if (!user) {
                console.log('âŒ No current user found');
                return;
            }
            
            const userRole = (user.role || '').toLowerCase().trim();
            const userJobTitle = (user.jobTitle || '').toLowerCase().trim();
            const userName = (user.displayName || user.name || '').toLowerCase().trim();
            const userEmail = (user.email || '').toLowerCase().trim();
            const investigationStatus = (data.investigationStatus || 'draft').toLowerCase();
            const isCreator = data.createdBy === user.uid || data.createdBy === user.email;
            
            // Check if user is admin/super user
            const isAdmin = ['admin', 'super user', 'superuser'].includes(userRole);
            
            console.log('ðŸ§‘â€ðŸ’¼ Current User Info:', {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                name: user.name,
                role: user.role,
                jobTitle: user.jobTitle,
                computed: { userRole, userJobTitle, userName, userEmail, isCreator, isAdmin }
            });
            
            console.log('ðŸ“‹ Investigation Info:', {
                id: data.id,
                status: data.investigationStatus,
                createdBy: data.createdBy,
                createdByEmail: data.createdByEmail,
                computed: { investigationStatus, isCreator }
            });
            
            // Check if user can approve based on approval flow
            let canApprove = false;
            if (approvalFlowData && approvalFlowData.selectedRoles) {
                console.log('âœ… Approval flow data exists, processing...');
                // Get all approver values and text names from the flow
                const approverValues = [];
                const approverNames = [];
                
                // Get resolved line manager info for L+1 matching
                const resolvedLineManager = (window._currentResolvedLineManager || '').toLowerCase().trim();
                const resolvedLineManagerJobTitle = (window._currentResolvedLineManagerJobTitle || '').toLowerCase().trim();
                
                console.log('ðŸ”„ Resolved Line Manager for L+1:', {
                    resolvedLineManager,
                    resolvedLineManagerJobTitle,
                    windowVars: {
                        _currentResolvedLineManager: window._currentResolvedLineManager,
                        _currentResolvedLineManagerJobTitle: window._currentResolvedLineManagerJobTitle
                    }
                });
                
                Object.values(approvalFlowData.selectedRoles).forEach(levelData => {
                    if (Array.isArray(levelData)) {
                        levelData.forEach(ap => {
                            if (ap.value) approverValues.push(ap.value.toLowerCase().trim());
                            // For L+1, use the resolved line manager name instead of "l+1"
                            const textVal = (ap.text || '').toLowerCase().trim();
                            const valueVal = (ap.value || '').toLowerCase().trim();
                            if (textVal === 'l+1' || valueVal === 'l+1') {
                                // Add resolved line manager name for matching
                                if (resolvedLineManager) {
                                    approverNames.push(resolvedLineManager);
                                    console.log('ðŸ”„ L+1 resolved to:', resolvedLineManager);
                                }
                                // Also add the job title for matching
                                if (resolvedLineManagerJobTitle) {
                                    approverNames.push(resolvedLineManagerJobTitle);
                                    console.log('ðŸ”„ L+1 job title added:', resolvedLineManagerJobTitle);
                                }
                            } else if (textVal) {
                                approverNames.push(textVal);
                                console.log('ðŸ‘¤ Added approver name:', textVal);
                            }
                        });
                    }
                });
                
                console.log('ðŸ“ Final Approval Arrays:', {
                    approverNames,
                    approverValues,
                    approvalFlowData: approvalFlowData.selectedRoles
                });
                
                // Check if user's display name matches any approver name - multiple matching strategies
                if (userName && approverNames.length > 0) {
                    // Get all possible user name variations
                    const user = window.authManager?.currentUser;
                    const userNameVariations = [
                        userName,
                        (user.displayName || '').toLowerCase().trim(),
                        (user.name || '').toLowerCase().trim(),
                        `${(user.firstName || '')} ${(user.lastName || '')}`.toLowerCase().trim(),
                        (user.email || '').split('@')[0].toLowerCase().trim()
                    ].filter(n => n && n.length > 0);
                    
                    console.log('ðŸ‘¤ User name variations:', userNameVariations);
                    
                    for (const approverName of approverNames) {
                        for (const userVariation of userNameVariations) {
                            // Exact match
                            if (approverName === userVariation) {
                                canApprove = true;
                                console.log('âœ… EXACT name match:', { userVariation, approverName });
                                break;
                            }
                            // Contains match (both directions)
                            if (approverName.includes(userVariation) && userVariation.length >= 3) {
                                canApprove = true;
                                console.log('âœ… CONTAINS name match (approver contains user):', { userVariation, approverName });
                                break;
                            }
                            if (userVariation.includes(approverName) && approverName.length >= 3) {
                                canApprove = true;
                                console.log('âœ… CONTAINS name match (user contains approver):', { userVariation, approverName });
                                break;
                            }
                        }
                        if (canApprove) break;
                    }
                }
                
                // Check if user matches any approver by job title
                if (userJobTitle && approverValues.some(v => {
                    const matches = v.includes(userJobTitle) || userJobTitle.includes(v.replace('function_', '').replace(/_/g, ' '));
                    if (matches) console.log('âœ… Job title match found in values:', { userJobTitle, approverValue: v });
                    return matches;
                })) {
                    canApprove = true;
                    console.log('âœ… User job title matches approver value:', userJobTitle);
                }
                
                // Check if job title matches approver names (for function-based approvers shown as text)
                if (userJobTitle && approverNames.some(n => {
                    const matches = n === userJobTitle || n.includes(userJobTitle) || userJobTitle.includes(n);
                    if (matches) console.log('âœ… Job title match found in names:', { userJobTitle, approverName: n });
                    return matches;
                })) {
                    canApprove = true;
                    console.log('âœ… User job title matches approver name:', userJobTitle);
                }
                
                // Check if user matches by role
                if (userRole && approverValues.some(v => {
                    const matches = v.includes(userRole);
                    if (matches) console.log('âœ… Role match found:', { userRole, approverValue: v });
                    return matches;
                })) {
                    canApprove = true;
                    console.log('âœ… User role matches approver:', userRole);
                }
                
                // Check if user email or UID matches any approver (for user_xxx type approvers)
                const userUID = user.uid || '';
                if ((userEmail || userUID) && approverValues.some(v => {
                    const emailPrefix = userEmail ? userEmail.split('@')[0] : '';
                    const matches = (emailPrefix && v.includes(emailPrefix)) || 
                                   (userUID && (v.includes(userUID) || v.includes(`user_${userUID}`)));
                    if (matches) console.log('âœ… Email/UID match found:', { userEmail, userUID, emailPrefix, approverValue: v });
                    return matches;
                })) {
                    canApprove = true;
                    console.log('âœ… User email/UID matches approver:', { userEmail, userUID });
                }
                
                console.log('ðŸ” Final Approval Decision:', { 
                    canApprove, 
                    isAdmin,
                    matchingSummary: {
                        userName_vs_approverNames: userName ? approverNames.filter(n => n === userName || n.includes(userName) || userName.includes(n)) : [],
                        userJobTitle_vs_approverNames: userJobTitle ? approverNames.filter(n => n === userJobTitle || n.includes(userJobTitle) || userJobTitle.includes(n)) : [],
                        userJobTitle_vs_approverValues: userJobTitle ? approverValues.filter(v => v.includes(userJobTitle) || userJobTitle.includes(v.replace('function_', '').replace(/_/g, ' '))) : [],
                        userRole_vs_approverValues: userRole ? approverValues.filter(v => v.includes(userRole)) : [],
                        userEmail_vs_approverValues: userEmail ? approverValues.filter(v => v.includes(userEmail.split('@')[0])) : []
                    }
                });
            } else {
                console.log('âŒ No approval flow data found:', { 
                    approvalFlowData, 
                    hasSelectedRoles: approvalFlowData?.selectedRoles,
                    selectedRolesKeys: approvalFlowData?.selectedRoles ? Object.keys(approvalFlowData.selectedRoles) : null
                });
            }
            
            // Admins can always approve
            if (isAdmin) {
                canApprove = true;
                console.log('âœ… Admin override - can approve');
            }
            
            // Show actions container if any button will be visible
            let showActions = false;
            
            // Check if investigation is submitted for review (not draft)
            const isSubmittedForReview = !['draft', 'created', 'new'].includes(investigationStatus);
            
            // Show approve/decline when user can approve, item not finalized, AND submitted for review
            const nonFinalStatuses = ['pending','submitted','under review','in progress','awaiting approval','awaiting_approval','review','open','partially approved'];
            const isFinal = ['approved','closed','rejected','cancelled','canceled'].includes(investigationStatus);
            
            // Check if this user has already approved this investigation
            const approvalHistory = Array.isArray(data.approvalHistory) ? data.approvalHistory : [];
            const userHasApproved = approvalHistory.some(h => 
                h.status === 'approved' && 
                (h.userId === user.uid || h.userId === userEmail || h.userName?.toLowerCase().trim() === userName)
            );
            
            console.log('ðŸ“Š Status Check:', {
                investigationStatus,
                isSubmittedForReview,
                nonFinalStatuses,
                isFinal,
                userHasApproved,
                approvalHistory: approvalHistory.map(h => ({ userId: h.userId, userName: h.userName, status: h.status })),
                isInNonFinalList: nonFinalStatuses.includes(investigationStatus),
                canShowButtons: canApprove && isSubmittedForReview && !userHasApproved && (!isFinal && (nonFinalStatuses.includes(investigationStatus) || investigationStatus))
            });
            
            // Only show approve/decline if user hasn't already approved
            if (canApprove && isSubmittedForReview && !userHasApproved && (!isFinal && (nonFinalStatuses.includes(investigationStatus) || investigationStatus))) {
                if (approveBtn) {
                    approveBtn.style.display = 'inline-flex';
                    console.log('âœ… Showing approve button - user can approve');
                }
                if (declineBtn) {
                    declineBtn.style.display = 'inline-flex';
                    console.log('âœ… Showing decline button - user can approve');
                }
                if (commentSection) {
                    commentSection.style.display = 'block';
                    console.log('âœ… Showing comment section - user can approve');
                }
                showActions = true;
            } else {
                console.log('âŒ Not showing approve/decline buttons:', {
                    canApprove,
                    isSubmittedForReview,
                    userHasApproved,
                    isFinal,
                    investigationStatus,
                    validStatus: nonFinalStatuses.includes(investigationStatus) || investigationStatus,
                    reason: !canApprove ? 'User cannot approve' : !isSubmittedForReview ? 'Not submitted for review' : userHasApproved ? 'User has already approved' : isFinal ? 'Investigation is final' : 'Invalid status'
                });
            }
            
            // Show edit button for creator, admin, or users with "Edit All" permission (if not closed/approved)
            if ((isCreator || isAdmin || canEditAllInvestigations) && !['closed', 'approved'].includes(investigationStatus)) {
                if (editBtn) editBtn.style.display = 'inline-flex';
                showActions = true;
            }
            
            // Show delete button for creator (if draft), admin, or users with "Edit All" permission
            if ((isCreator && investigationStatus === 'draft') || isAdmin || canEditAllInvestigations) {
                if (deleteBtn) deleteBtn.style.display = 'inline-flex';
                showActions = true;
            }
            
            if (showActions && actionsContainer) {
                actionsContainer.style.display = 'block';
            }
        }

        // Resolve user UID to display name and job title
        async function resolveUserDisplayInfo(uidOrEmail, companyId) {
            try {
                if (!uidOrEmail) return { name: '-', jobTitle: '' };
                const db = firebase.database();
                // Try company employees path first
                if (companyId) {
                    const empSnap = await db.ref(`companies/${companyId}/employees/${uidOrEmail}`).once('value');
                    if (empSnap.exists()) {
                        const emp = empSnap.val();
                        const name = emp.displayName || emp.name || `${emp.firstName || ''} ${emp.lastName || ''}`.trim() || emp.email || uidOrEmail;
                        return { name, jobTitle: emp.jobTitle || emp.position || '' };
                    }
                }
                // Try users path
                const userSnap = await db.ref(`users/${uidOrEmail}`).once('value');
                if (userSnap.exists()) {
                    const u = userSnap.val();
                    const name = u.displayName || u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email || uidOrEmail;
                    return { name, jobTitle: u.jobTitle || u.position || '' };
                }
                // If looks like email, return email username
                if (uidOrEmail.includes('@')) {
                    return { name: uidOrEmail.split('@')[0], jobTitle: '' };
                }
            } catch (e) { /* ignore */ }
            return { name: uidOrEmail, jobTitle: '' };
        }

        // Resolve current user's signature URL using common profile locations
        async function getUserSignatureUrl(user, companyId) {
            try {
                const direct = (user.signatureUrl || user.signature || user.profileSignature || '').toString();
                if (direct) return direct;
                const db = firebase.database();
                const uid = user.uid;
                // Try company employees path
                if (companyId && uid) {
                    const empSnap = await db.ref(`companies/${companyId}/employees/${uid}/signatureUrl`).once('value');
                    if (empSnap.exists() && empSnap.val()) return String(empSnap.val());
                    // Also try nested security section commonly used by profile.html
                    const empSecSnap = await db.ref(`companies/${companyId}/employees/${uid}/security/signatureUrl`).once('value');
                    if (empSecSnap.exists() && empSecSnap.val()) return String(empSecSnap.val());
                    const empSecSnapAlt = await db.ref(`companies/${companyId}/employees/${uid}/security/signature`).once('value');
                    if (empSecSnapAlt.exists() && empSecSnapAlt.val()) return String(empSecSnapAlt.val());
                }
                // Try user profile path
                if (uid) {
                    const userSnap = await db.ref(`users/${uid}/signatureUrl`).once('value');
                    if (userSnap.exists() && userSnap.val()) return String(userSnap.val());
                    // Check possible security tab locations
                    const userSecSnap = await db.ref(`users/${uid}/security/signatureUrl`).once('value');
                    if (userSecSnap.exists() && userSecSnap.val()) return String(userSecSnap.val());
                    const userSecSnapAlt = await db.ref(`users/${uid}/security/signature`).once('value');
                    if (userSecSnapAlt.exists() && userSecSnapAlt.val()) return String(userSecSnapAlt.val());
                }
                // Try email-based key
                const emailKey = (user.email || '').replace(/[@.]/g, '_');
                if (companyId && emailKey) {
                    const emailSnap = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/signatureUrl`).once('value');
                    if (emailSnap.exists() && emailSnap.val()) return String(emailSnap.val());
                    const emailSecSnap = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/security/signatureUrl`).once('value');
                    if (emailSecSnap.exists() && emailSecSnap.val()) return String(emailSecSnap.val());
                    const emailSecSnapAlt = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/security/signature`).once('value');
                    if (emailSecSnapAlt.exists() && emailSecSnapAlt.val()) return String(emailSecSnapAlt.val());
                }
                // Try company profiles path used by profile.html
                if (companyId && uid) {
                    const profSnap = await db.ref(`companies/${companyId}/profiles/${uid}/security/signatureUrl`).once('value');
                    if (profSnap.exists() && profSnap.val()) return String(profSnap.val());
                    const profSnapAlt = await db.ref(`companies/${companyId}/profiles/${uid}/security/signature`).once('value');
                    if (profSnapAlt.exists() && profSnapAlt.val()) return String(profSnapAlt.val());
                }
            } catch (e) { /* ignore */ }
            return '';
        }

        // Fallback: resolve a signature for a given userId or email
        async function getSignatureUrlForUserId(userIdOrEmail, companyId) {
            try {
                const db = firebase.database();
                const isEmail = String(userIdOrEmail).includes('@');
                const uid = isEmail ? null : userIdOrEmail;
                const email = isEmail ? userIdOrEmail : '';
                // Try direct users path
                if (uid) {
                    const u1 = await db.ref(`users/${uid}/signatureUrl`).once('value');
                    if (u1.exists() && u1.val()) return String(u1.val());
                    const u2 = await db.ref(`users/${uid}/security/signatureUrl`).once('value');
                    if (u2.exists() && u2.val()) return String(u2.val());
                    const u3 = await db.ref(`users/${uid}/security/signature`).once('value');
                    if (u3.exists() && u3.val()) return String(u3.val());
                }
                // Try company employees/users by uid
                if (companyId && uid) {
                    const e1 = await db.ref(`companies/${companyId}/employees/${uid}/signatureUrl`).once('value');
                    if (e1.exists() && e1.val()) return String(e1.val());
                    const e2 = await db.ref(`companies/${companyId}/employees/${uid}/security/signatureUrl`).once('value');
                    if (e2.exists() && e2.val()) return String(e2.val());
                    const e3 = await db.ref(`companies/${companyId}/employees/${uid}/security/signature`).once('value');
                    if (e3.exists() && e3.val()) return String(e3.val());
                    const p1 = await db.ref(`companies/${companyId}/profiles/${uid}/security/signatureUrl`).once('value');
                    if (p1.exists() && p1.val()) return String(p1.val());
                    const p2 = await db.ref(`companies/${companyId}/profiles/${uid}/security/signature`).once('value');
                    if (p2.exists() && p2.val()) return String(p2.val());
                }
                // Try email-based
                if (companyId && email) {
                    const emailKey = email.replace(/[@.]/g, '_');
                    const em1 = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/signatureUrl`).once('value');
                    if (em1.exists() && em1.val()) return String(em1.val());
                    const em2 = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/security/signatureUrl`).once('value');
                    if (em2.exists() && em2.val()) return String(em2.val());
                    const em3 = await db.ref(`companies/${companyId}/employeesByEmail/${emailKey}/security/signature`).once('value');
                    if (em3.exists() && em3.val()) return String(em3.val());
                }
            } catch (e) { /* ignore */ }
            return '';
        }

        // Resolve an employee record by UID or email - checks multiple storage paths
        async function resolveEmployeeRecord(identifier, companyId) {
            const db = firebase.database();
            if (!identifier || !companyId) return null;
            try {
                // Try companies/{companyId}/employees/{uid}
                const empSnap = await db.ref(`companies/${companyId}/employees/${identifier}`).once('value');
                if (empSnap.exists()) return { ...empSnap.val(), uid: identifier };
                
                // Try companies/{companyId}/users/{uid} (companymanagement.html stores here)
                const userSnap = await db.ref(`companies/${companyId}/users/${identifier}`).once('value');
                if (userSnap.exists()) return { ...userSnap.val(), uid: identifier };
                
                // If identifier looks like email, search all users by email
                if (String(identifier).includes('@')) {
                    // Search in employees
                    const allEmpsSnap = await db.ref(`companies/${companyId}/employees`).once('value');
                    if (allEmpsSnap.exists()) {
                        const emps = allEmpsSnap.val();
                        for (const [uid, emp] of Object.entries(emps)) {
                            if (emp && emp.email && emp.email.toLowerCase() === identifier.toLowerCase()) {
                                return { ...emp, uid };
                            }
                        }
                    }
                    // Search in users
                    const allUsersSnap = await db.ref(`companies/${companyId}/users`).once('value');
                    if (allUsersSnap.exists()) {
                        const users = allUsersSnap.val();
                        for (const [uid, user] of Object.entries(users)) {
                            if (user && user.email && user.email.toLowerCase() === identifier.toLowerCase()) {
                                return { ...user, uid };
                            }
                        }
                    }
                }
            } catch (e) { console.error('resolveEmployeeRecord error:', e); }
            return null;
        }

        // Resolve line manager info (name + jobTitle) by manager id or name
        async function resolveLineManagerInfo(managerIdentifier, companyId) {
            if (!managerIdentifier) return { name: '', jobTitle: '' };
            // If managerIdentifier looks like a full name (has spaces), return as name directly
            if (typeof managerIdentifier === 'string' && managerIdentifier.includes(' ')) {
                // It's already a name, try to find job title by searching users
                try {
                    const db = firebase.database();
                    const usersSnap = await db.ref(`companies/${companyId}/users`).once('value');
                    if (usersSnap.exists()) {
                        const users = usersSnap.val();
                        for (const [uid, user] of Object.entries(users)) {
                            const userName = user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim();
                            if (userName.toLowerCase() === managerIdentifier.toLowerCase()) {
                                return { name: managerIdentifier, jobTitle: user.jobTitle || '' };
                            }
                        }
                    }
                } catch (e) { /* ignore */ }
                return { name: managerIdentifier, jobTitle: '' };
            }
            // Try to resolve by UID using resolveEmployeeRecord
            const emp = await resolveEmployeeRecord(managerIdentifier, companyId);
            if (emp) {
                const name = emp.displayName || emp.name || `${emp.firstName || ''} ${emp.lastName || ''}`.trim() || emp.email || String(managerIdentifier);
                return { name, jobTitle: emp.jobTitle || emp.position || '' };
            }
            return { name: String(managerIdentifier), jobTitle: '' };
        }

        // Approve current investigation
        async function approveCurrentInvestigation() {
            const investigationId = window._currentInvestigationId;
            const data = window._currentInvestigationData;
            const approvalFlowData = window._currentApprovalFlowData;
            if (!investigationId || !data) {
                alert('No investigation selected');
                return;
            }
            
            if (!confirm('Are you sure you want to approve this investigation?')) return;
            
            try {
                const user = window.authManager?.currentUser;
                const companyId = user?.companyId;
                if (!companyId) {
                    alert('No company context');
                    return;
                }
                
                const comment = document.getElementById('invApprovalComment')?.value || '';
                const now = new Date();
                const signatureUrl = await getUserSignatureUrl(user, companyId);
                
                // Determine which approval level this user represents
                let userApprovalLevel = null; // Start with null to properly detect which level user belongs to
                const userName = (user.displayName || user.name || '').toLowerCase().trim();
                const userJobTitle = (user.jobTitle || '').toLowerCase().trim();
                const userRole = (user.role || '').toLowerCase().trim();
                const userEmail = (user.email || '').toLowerCase().trim();
                const userUID = user.uid || '';
                
                // Also check multiple name variations
                const userNameVariations = [
                    userName,
                    (user.displayName || '').toLowerCase().trim(),
                    (user.name || '').toLowerCase().trim(),
                    (user.firstName || '').toLowerCase().trim(),
                    (user.lastName || '').toLowerCase().trim(),
                    `${(user.firstName || '')} ${(user.lastName || '')}`.toLowerCase().trim(),
                    userEmail.split('@')[0].toLowerCase().trim()
                ].filter(n => n);
                
                console.log('ðŸ” Checking approval level for user:', { userName, userJobTitle, userRole, userEmail, userNameVariations });
                
                if (approvalFlowData?.selectedRoles) {
                    // Check which level this user matches
                    const sortedLevels = Object.keys(approvalFlowData.selectedRoles)
                        .filter(key => key.startsWith('level'))
                        .sort((a, b) => parseInt(a.replace('level', '')) - parseInt(b.replace('level', '')));
                    
                    console.log('ðŸ“‹ Approval flow levels:', sortedLevels);
                    
                    outerLoop:
                    for (const levelKey of sortedLevels) {
                        const levelNum = parseInt(levelKey.replace('level', ''));
                        const levelData = approvalFlowData.selectedRoles[levelKey];
                        
                        console.log(`ðŸ”Ž Checking ${levelKey}:`, levelData);
                        
                        if (Array.isArray(levelData)) {
                            for (const ap of levelData) {
                                const approverText = (ap.text || '').toLowerCase().trim();
                                const approverValue = (ap.value || '').toLowerCase().trim();
                                
                                console.log(`   Comparing with approver: text="${approverText}", value="${approverValue}"`);
                                
                                // Check for L+1 match
                                if (approverText === 'l+1' || approverValue === 'l+1') {
                                    const resolvedLineManager = (window._currentResolvedLineManager || '').toLowerCase().trim();
                                    console.log(`   L+1 check: resolvedLineManager="${resolvedLineManager}"`);
                                    if (resolvedLineManager) {
                                        for (const nameVar of userNameVariations) {
                                            if (nameVar && (resolvedLineManager.includes(nameVar) || nameVar.includes(resolvedLineManager))) {
                                                console.log(`   âœ… L+1 MATCH at level ${levelNum}`);
                                                userApprovalLevel = levelNum;
                                                break outerLoop;
                                            }
                                        }
                                    }
                                }
                                // Check for direct name match using all variations
                                else {
                                    for (const nameVar of userNameVariations) {
                                        if (nameVar && approverText && (approverText === nameVar || approverText.includes(nameVar) || nameVar.includes(approverText))) {
                                            console.log(`   âœ… Name MATCH at level ${levelNum}: "${nameVar}" matches "${approverText}"`);
                                            userApprovalLevel = levelNum;
                                            break outerLoop;
                                        }
                                    }
                                    // Check for job title match
                                    if (userJobTitle && (approverValue.includes(userJobTitle) || approverText === userJobTitle || approverText.includes(userJobTitle))) {
                                        console.log(`   âœ… Job title MATCH at level ${levelNum}`);
                                        userApprovalLevel = levelNum;
                                        break outerLoop;
                                    }
                                    // Check for role match
                                    if (userRole && (approverValue.includes(userRole) || approverText.includes(userRole))) {
                                        console.log(`   âœ… Role MATCH at level ${levelNum}`);
                                        userApprovalLevel = levelNum;
                                        break outerLoop;
                                    }
                                    // Check for email/UID match
                                    if ((userEmail && (approverValue.includes(userEmail.split('@')[0]) || approverText.includes(userEmail.split('@')[0]))) || 
                                        (userUID && (approverValue.includes(userUID) || approverValue.includes(`user_${userUID}`)))) {
                                        console.log(`   âœ… Email/UID MATCH at level ${levelNum}`);
                                        userApprovalLevel = levelNum;
                                        break outerLoop;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // If no level found, default to 1
                if (userApprovalLevel === null) {
                    console.log('âš ï¸ No approval level match found, defaulting to level 1');
                    userApprovalLevel = 1;
                }
                
                console.log('ðŸŽ¯ User approval level determined:', userApprovalLevel);
                
                // Build approval history entry
                const historyEntry = {
                    level: userApprovalLevel,
                    userId: user.uid || user.email,
                    userName: user.displayName || user.name || user.email,
                    status: 'approved',
                    comment: comment,
                    timestamp: now.getTime(),
                    submittedAt: now.toISOString(),
                    signatureUrl: signatureUrl || null
                };
                
                // Get existing approval history
                const existingHistory = Array.isArray(data.approvalHistory) ? data.approvalHistory : [];
                
                // Remove any previous approval from this user at this level (in case of re-approval)
                const filteredHistory = existingHistory.filter(h => !(h.level === userApprovalLevel && h.userId === (user.uid || user.email)));
                
                // Add new approval
                const updatedHistory = [...filteredHistory, historyEntry];
                
                // Determine if all required levels have been approved
                let allLevelsApproved = true;
                let maxRequiredLevel = 1;
                
                if (approvalFlowData?.selectedRoles) {
                    const levels = Object.keys(approvalFlowData.selectedRoles)
                        .filter(key => key.startsWith('level'))
                        .map(key => parseInt(key.replace('level', '')))
                        .sort((a, b) => a - b);
                    
                    maxRequiredLevel = Math.max(...levels);
                    
                    // Check if each required level has at least one approval
                    for (const requiredLevel of levels) {
                        const hasApprovalForLevel = updatedHistory.some(h => h.level === requiredLevel && h.status === 'approved');
                        if (!hasApprovalForLevel) {
                            allLevelsApproved = false;
                            break;
                        }
                    }
                }
                
                console.log('ðŸ“Š Approval Status Check:', {
                    maxRequiredLevel,
                    allLevelsApproved,
                    approvedLevels: updatedHistory.filter(h => h.status === 'approved').map(h => h.level)
                });
                
                // Determine new investigation status
                let newStatus = 'awaiting approval';
                if (allLevelsApproved) {
                    newStatus = 'approved';
                } else if (userApprovalLevel < maxRequiredLevel) {
                    newStatus = 'partially approved';
                } else {
                    newStatus = 'awaiting approval';
                }
                
                // Update investigation
                const updates = {
                    investigationStatus: newStatus,
                    approvalHistory: updatedHistory,
                    updatedDate: now.toISOString()
                };
                
                // Only set final approval fields when fully approved
                if (allLevelsApproved) {
                    updates.approvedBy = user.displayName || user.name || user.email;
                    updates.approvalDate = now.toISOString();
                }
                
                // Always update approver comments
                updates.approverComments = comment || data.approverComments || '';
                
                await firebase.database().ref(`companies/${companyId}/investigations/${investigationId}`).update(updates);
                
                const statusMessage = allLevelsApproved 
                    ? 'Investigation fully approved!' 
                    : `Level ${userApprovalLevel} approval recorded. ${newStatus === 'partially approved' ? 'Waiting for additional approvals.' : 'Investigation needs further approvals.'}`;
                alert(statusMessage);
                
                // Keep modal open and append signature block if this was the final approval
                const approvalSection = document.getElementById('invSectionApproval');
                if (approvalSection && allLevelsApproved) {
                    const signatureBlock = document.createElement('div');
                    signatureBlock.style.border = '1px solid #e2e8f0';
                    signatureBlock.style.borderRadius = '6px';
                    signatureBlock.style.padding = '10px';
                    signatureBlock.style.background = '#fff';
                    signatureBlock.style.display = 'grid';
                    signatureBlock.style.gridTemplateColumns = '1fr auto';
                    signatureBlock.style.alignItems = 'center';
                    signatureBlock.style.gap = '10px';
                    signatureBlock.innerHTML = `
                        <div>
                            <div style="font-size:.75rem; color:#374151; font-weight:700;">Final Approval by</div>
                            <div style="font-size:.74rem; color:#111827;">${escapeHtml(user.displayName || user.name || user.email)}</div>
                            <div style="font-size:.7rem; color:#6b7280;">${new Date().toLocaleString()}</div>
                        </div>
                        <div style="text-align:right;">
                            ${signatureUrl ? `<img src="${escapeHtml(signatureUrl)}" alt="Signature" style="max-height:48px; max-width:160px; object-fit:contain; border:1px solid #e2e8f0; border-radius:4px; padding:3px; background:#fafafa;"/>` : `<div style="font-size:.7rem; color:#9ca3af;">No signature on file</div>`}
                        </div>
                    `;
                    approvalSection.appendChild(signatureBlock);
                }
                
                // Update local cached data and refresh the modal to show new approval status
                window._currentInvestigationData = { ...data, ...updates };
                
                // Update the user's specific level row in the approval flow table immediately
                if (approvalSection) {
                    // Find and update the table row for this user's approval level
                    const levelRow = approvalSection.querySelector(`tr.leave-approval-flow-level[data-level="${userApprovalLevel}"]`);
                    
                    if (levelRow) {
                        const approverName = user.displayName || user.name || user.email;
                        const timestamp = new Date().toLocaleString();
                        
                        // Get user's job title from cached data
                        let jobTitle = user.jobTitle || '';
                        if (!jobTitle) {
                            try {
                                const usersSnap = await firebase.database().ref(`companies/${companyId}/users/${user.uid}`).once('value');
                                const userData = usersSnap.val();
                                if (userData) {
                                    jobTitle = userData.jobTitle || userData.title || userData.designation || '';
                                }
                            } catch(e) {}
                        }
                        const prettyJob = jobTitle ? jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';
                        
                        // Build signature HTML if available; if missing, try to fetch
                        let signatureDisplayUrl = signatureUrl;
                        if (!signatureDisplayUrl) {
                            try {
                                signatureDisplayUrl = await getSignatureUrlForUserId(user.uid || user.email || '', companyId);
                            } catch (e) { /* ignore */ }
                        }
                        
                        // Update the approver cell
                        const approverCell = levelRow.cells[0];
                        if (approverCell) {
                            let approverHtml = `<span class="approver-fullname">${escapeHtml(approverName)}</span>`;
                            if (prettyJob) {
                                approverHtml += `<br><span class="approver-job">${escapeHtml(prettyJob)}</span>`;
                            }
                            approverCell.innerHTML = `<div>${approverHtml}</div>`;
                        }
                        
                        // Update the status cell
                        const statusCell = levelRow.cells[1];
                        if (statusCell) {
                            statusCell.innerHTML = `<div><span class="status-chip approved">Approved</span></div>`;
                        }
                        
                        // Update the timestamp cell
                        const tsCell = levelRow.cells[2];
                        if (tsCell) {
                            tsCell.innerHTML = `<div>${timestamp}</div>`;
                        }
                        
                        // Update the signature cell
                        const sigCell = levelRow.cells[3];
                        if (sigCell) {
                            if (signatureDisplayUrl) {
                                sigCell.innerHTML = `<div class="sig-stack"><div><img src="${signatureDisplayUrl}" alt="Signature" class="sig-img"/></div></div>`;
                            } else {
                                sigCell.innerHTML = `<div class="sig-stack"><div style="height:14px;"></div></div>`;
                            }
                        }
                        
                        // Also update the Investigation Status card at the top
                        const statusCards = approvalSection.querySelectorAll('div[style*="border:1px solid #e2e8f0"]');
                        statusCards.forEach(card => {
                            const statusLabel = card.querySelector('div[style*="font-weight:600"]');
                            if (statusLabel && statusLabel.textContent.trim() === 'Investigation Status') {
                                const statusBadge = card.querySelector('span[style*="border-radius:12px"]');
                                if (statusBadge) {
                                    const newStatusBg = newStatus.toLowerCase() === 'approved' ? '#d1fae5' : 
                                                       newStatus.toLowerCase() === 'rejected' ? '#fee2e2' : 
                                                       newStatus.toLowerCase() === 'partially approved' ? '#fef3c7' : '#e5e7eb';
                                    const newStatusFg = newStatus.toLowerCase() === 'approved' ? '#065f46' : 
                                                       newStatus.toLowerCase() === 'rejected' ? '#991b1b' : 
                                                       newStatus.toLowerCase() === 'partially approved' ? '#92400e' : '#374151';
                                    statusBadge.style.background = newStatusBg;
                                    statusBadge.style.color = newStatusFg;
                                    statusBadge.textContent = newStatus;
                                }
                            }
                        });
                    } else {
                        // Fallback: Re-open the modal to show updated approval flow with new status
                        setTimeout(() => {
                            openInvestigationModal(investigationId);
                        }, 100);
                    }
                }
                
                // Update approval buttons (hide them since user has approved)
                setupApprovalButtons(window._currentInvestigationData, window._currentApprovalFlowData, companyId);
            } catch (err) {
                console.error('Failed to approve investigation:', err);
                alert('Failed to approve: ' + err.message);
            }
        }

        // Decline current investigation
        async function declineCurrentInvestigation() {
            const investigationId = window._currentInvestigationId;
            const data = window._currentInvestigationData;
            const approvalFlowData = window._currentApprovalFlowData;
            if (!investigationId || !data) {
                alert('No investigation selected');
                return;
            }
            
            const comment = document.getElementById('invApprovalComment')?.value || '';
            if (!comment.trim()) {
                alert('Please provide a reason for declining the investigation.');
                document.getElementById('invApprovalComment')?.focus();
                return;
            }
            
            if (!confirm('Are you sure you want to decline this investigation?')) return;
            
            try {
                const user = window.authManager?.currentUser;
                const companyId = user?.companyId;
                if (!companyId) {
                    alert('No company context');
                    return;
                }
                
                const now = new Date();
                
                // Determine which approval level this user represents (same logic as approve)
                let userApprovalLevel = null;
                const userName = (user.displayName || user.name || '').toLowerCase().trim();
                const userJobTitle = (user.jobTitle || '').toLowerCase().trim();
                const userRole = (user.role || '').toLowerCase().trim();
                const userEmail = (user.email || '').toLowerCase().trim();
                const userUID = user.uid || '';
                
                // Also check multiple name variations
                const userNameVariations = [
                    userName,
                    (user.displayName || '').toLowerCase().trim(),
                    (user.name || '').toLowerCase().trim(),
                    (user.firstName || '').toLowerCase().trim(),
                    (user.lastName || '').toLowerCase().trim(),
                    `${(user.firstName || '')} ${(user.lastName || '')}`.toLowerCase().trim(),
                    userEmail.split('@')[0].toLowerCase().trim()
                ].filter(n => n);
                
                if (approvalFlowData?.selectedRoles) {
                    const sortedLevels = Object.keys(approvalFlowData.selectedRoles)
                        .filter(key => key.startsWith('level'))
                        .sort((a, b) => parseInt(a.replace('level', '')) - parseInt(b.replace('level', '')));
                    
                    outerLoop:
                    for (const levelKey of sortedLevels) {
                        const levelNum = parseInt(levelKey.replace('level', ''));
                        const levelData = approvalFlowData.selectedRoles[levelKey];
                        
                        if (Array.isArray(levelData)) {
                            for (const ap of levelData) {
                                const approverText = (ap.text || '').toLowerCase().trim();
                                const approverValue = (ap.value || '').toLowerCase().trim();
                                
                                // Check for L+1 match
                                if (approverText === 'l+1' || approverValue === 'l+1') {
                                    const resolvedLineManager = (window._currentResolvedLineManager || '').toLowerCase().trim();
                                    if (resolvedLineManager) {
                                        for (const nameVar of userNameVariations) {
                                            if (nameVar && (resolvedLineManager.includes(nameVar) || nameVar.includes(resolvedLineManager))) {
                                                userApprovalLevel = levelNum;
                                                break outerLoop;
                                            }
                                        }
                                    }
                                }
                                // Check for direct name match using all variations
                                else {
                                    for (const nameVar of userNameVariations) {
                                        if (nameVar && approverText && (approverText === nameVar || approverText.includes(nameVar) || nameVar.includes(approverText))) {
                                            userApprovalLevel = levelNum;
                                            break outerLoop;
                                        }
                                    }
                                    // Check for job title match
                                    if (userJobTitle && (approverValue.includes(userJobTitle) || approverText === userJobTitle || approverText.includes(userJobTitle))) {
                                        userApprovalLevel = levelNum;
                                        break outerLoop;
                                    }
                                    // Check for role match
                                    if (userRole && (approverValue.includes(userRole) || approverText.includes(userRole))) {
                                        userApprovalLevel = levelNum;
                                        break outerLoop;
                                    }
                                    // Check for email/UID match
                                    if ((userEmail && (approverValue.includes(userEmail.split('@')[0]) || approverText.includes(userEmail.split('@')[0]))) || 
                                        (userUID && (approverValue.includes(userUID) || approverValue.includes(`user_${userUID}`)))) {
                                        userApprovalLevel = levelNum;
                                        break outerLoop;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // If no level found, default to 1
                if (userApprovalLevel === null) {
                    userApprovalLevel = 1;
                }
                
                // Build approval history entry
                const historyEntry = {
                    level: userApprovalLevel,
                    userId: user.uid || user.email,
                    userName: user.displayName || user.name || user.email,
                    status: 'rejected',
                    comment: comment,
                    submittedAt: now.toISOString()
                };
                
                // Update investigation
                const updates = {
                    investigationStatus: 'Rejected',
                    reviewedBy: user.displayName || user.name || user.email,
                    reviewDate: now.toISOString(),
                    approverComments: comment,
                    updatedDate: now.toISOString()
                };
                
                // Add to approval history
                const existingHistory = Array.isArray(data.approvalHistory) ? data.approvalHistory : [];
                updates.approvalHistory = [...existingHistory, historyEntry];
                
                await firebase.database().ref(`companies/${companyId}/investigations/${investigationId}`).update(updates);
                
                // Update the user's specific level row in the approval flow table immediately before closing
                const approvalSection = document.getElementById('invSectionApproval');
                if (approvalSection) {
                    // Find and update the table row for this user's approval level
                    const levelRow = approvalSection.querySelector(`tr.leave-approval-flow-level[data-level="${userApprovalLevel}"]`);
                    
                    if (levelRow) {
                        const approverName = user.displayName || user.name || user.email;
                        const timestamp = new Date().toLocaleString();
                        
                        // Update the approver cell
                        const approverCell = levelRow.cells[0];
                        if (approverCell) {
                            approverCell.innerHTML = `<div><span class="approver-fullname">${escapeHtml(approverName)}</span></div>`;
                        }
                        
                        // Update the status cell
                        const statusCell = levelRow.cells[1];
                        if (statusCell) {
                            statusCell.innerHTML = `<div><span class="status-chip declined">Declined</span></div>`;
                        }
                        
                        // Update the timestamp cell
                        const tsCell = levelRow.cells[2];
                        if (tsCell) {
                            tsCell.innerHTML = `<div>${timestamp}</div>`;
                        }
                        
                        // Clear the signature cell (no signature for declined)
                        const sigCell = levelRow.cells[3];
                        if (sigCell) {
                            sigCell.innerHTML = `<div class="sig-stack"><div style="height:14px;"></div></div>`;
                        }
                    }
                    
                    // Update the Investigation Status card
                    const statusCards = approvalSection.querySelectorAll('div[style*="border:1px solid #e2e8f0"]');
                    statusCards.forEach(card => {
                        const statusLabel = card.querySelector('div[style*="font-weight:600"]');
                        if (statusLabel && statusLabel.textContent.trim() === 'Investigation Status') {
                            const statusBadge = card.querySelector('span[style*="border-radius:12px"]');
                            if (statusBadge) {
                                statusBadge.style.background = '#fee2e2';
                                statusBadge.style.color = '#991b1b';
                                statusBadge.textContent = 'Rejected';
                            }
                        }
                    });
                }
                
                alert('Investigation declined.');
                
                // Close modal and refresh list
                document.getElementById('investigationDetailsOverlay').style.display = 'none';
                if (window.investigationListInstance) {
                    window.investigationListInstance.loadInvestigations().then(() => {
                        window.investigationListInstance.renderInvestigations();
                    });
                }
            } catch (err) {
                console.error('Failed to decline investigation:', err);
                alert('Failed to decline: ' + err.message);
            }
        }

        // Edit current investigation
        function editCurrentInvestigation() {
            const investigationId = window._currentInvestigationId;
            if (!investigationId) {
                alert('No investigation selected');
                return;
            }
            window.location.href = `investigation-create.html?edit=${investigationId}`;
        }

        // Delete current investigation
        async function deleteCurrentInvestigation() {
            const investigationId = window._currentInvestigationId;
            if (!investigationId) {
                alert('No investigation selected');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this investigation? This action cannot be undone.')) return;
            
            try {
                const user = window.authManager?.currentUser;
                const companyId = user?.companyId;
                if (!companyId) {
                    alert('No company context');
                    return;
                }
                
                await firebase.database().ref(`companies/${companyId}/investigations/${investigationId}`).remove();
                
                alert('Investigation deleted successfully.');
                
                // Close modal and refresh list
                document.getElementById('investigationDetailsOverlay').style.display = 'none';
                if (window.investigationListInstance) {
                    window.investigationListInstance.loadInvestigations().then(() => {
                        window.investigationListInstance.renderInvestigations();
                    });
                }
            } catch (err) {
                console.error('Failed to delete investigation:', err);
                alert('Failed to delete: ' + err.message);
            }
        }

        // Render timeline visualization exactly as in investigation-create.html
        function renderTimelineVisualization(events) {
            const track = document.getElementById('modalTimelineTrack');
            if (!track || !events || events.length === 0) return;

            // Sort events by date/time
            const sortedEvents = [...events].sort((a, b) => {
                const dateA = a.date || '';
                const dateB = b.date || '';
                const timeA = a.time || '';
                const timeB = b.time || '';
                return (dateA + timeA).localeCompare(dateB + timeB);
            });

            let html = '';
            sortedEvents.forEach((ev, idx) => {
                const safeTitle = escapeHtml(ev.title || ev.event || '');
                const safeDesc = escapeHtml(ev.description || '');
                // Format date for display
                let dateDisplay = '';
                if (ev.date) {
                    const d = new Date(ev.date);
                    if (!isNaN(d)) {
                        dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ';
                    }
                }
                const timeDisplay = ev.time || '';
                html += `
                    <div class="timeline-event-node" data-idx="${idx}">
                        <div class="event-time-badge">${dateDisplay}${timeDisplay}</div>
                        <div class="event-dot"></div>
                        <div class="event-card">
                            <div class="event-title">${safeTitle || 'Event ' + (idx + 1)}</div>
                            ${safeDesc ? `<div class="event-desc">${safeDesc}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            track.innerHTML = html;

            // Draw connectors after nodes are rendered - use setTimeout to ensure modal is fully visible
            setTimeout(() => {
                requestAnimationFrame(() => drawTimelineConnectors());
            }, 100);
        }

        function drawTimelineConnectors() {
            const track = document.getElementById('modalTimelineTrack');
            if (!track) return;

            // Remove old connectors
            track.querySelectorAll('.timeline-connector').forEach(c => c.remove());

            const nodes = track.querySelectorAll('.timeline-event-node');
            if (nodes.length < 2) return;

            const trackRect = track.getBoundingClientRect();
            if (trackRect.width === 0 || trackRect.height === 0) {
                // Track not visible yet, retry
                setTimeout(() => drawTimelineConnectors(), 50);
                return;
            }

            const rightEdgeX = trackRect.width - 15;
            const leftEdgeX = 15;

            for (let i = 0; i < nodes.length - 1; i++) {
                const current = nodes[i];
                const next = nodes[i + 1];
                const currDot = current.querySelector('.event-dot');
                const nextDot = next.querySelector('.event-dot');
                if (!currDot || !nextDot) continue;

                const currRect = currDot.getBoundingClientRect();
                const nextRect = nextDot.getBoundingClientRect();

                const currCenterX = currRect.left + currRect.width / 2 - trackRect.left;
                const currCenterY = currRect.top + currRect.height / 2 - trackRect.top;
                const nextCenterX = nextRect.left + nextRect.width / 2 - trackRect.left;
                const nextCenterY = nextRect.top + nextRect.height / 2 - trackRect.top;

                // Check if same row (Y difference small) or different row
                const sameRow = Math.abs(currCenterY - nextCenterY) < 20;
                const isLastConnection = (i === nodes.length - 2);

                if (sameRow) {
                    // Horizontal connector with arrow pointing right
                    const line = document.createElement('div');
                    line.className = 'timeline-connector horizontal';
                    line.style.left = currCenterX + 'px';
                    line.style.top = (currCenterY - 1.5) + 'px';
                    line.style.width = (nextCenterX - currCenterX) + 'px';
                    // Add arrow only on last segment
                    if (isLastConnection) {
                        line.innerHTML = '<div class="arrow arrow-right"></div>';
                    }
                    track.appendChild(line);
                } else {
                    // Different row: continuous 90-degree turns
                    // The line goes: right â†’ down at right edge â†’ left along bottom â†’ down to next row Y â†’ right to next node
                    
                    // Calculate midpoint Y between rows for the horizontal run
                    const midY = currCenterY + (nextCenterY - currCenterY) / 2;

                    // 1. Horizontal from current dot to right edge
                    const h1 = document.createElement('div');
                    h1.className = 'timeline-connector horizontal';
                    h1.style.left = currCenterX + 'px';
                    h1.style.top = (currCenterY - 1.5) + 'px';
                    h1.style.width = (rightEdgeX - currCenterX) + 'px';
                    track.appendChild(h1);

                    // 2. Vertical down from right edge to midpoint
                    const v1 = document.createElement('div');
                    v1.className = 'timeline-connector vertical';
                    v1.style.left = (rightEdgeX - 1.5) + 'px';
                    v1.style.top = currCenterY + 'px';
                    v1.style.height = (midY - currCenterY) + 'px';
                    track.appendChild(v1);

                    // 3. Horizontal from right edge to left edge at midpoint (connecting the two verticals)
                    const h2 = document.createElement('div');
                    h2.className = 'timeline-connector horizontal';
                    h2.style.left = leftEdgeX + 'px';
                    h2.style.top = (midY - 1.5) + 'px';
                    h2.style.width = (rightEdgeX - leftEdgeX) + 'px';
                    track.appendChild(h2);

                    // 4. Vertical down from left edge at midpoint to next row Y level
                    const v2 = document.createElement('div');
                    v2.className = 'timeline-connector vertical';
                    v2.style.left = (leftEdgeX - 1.5) + 'px';
                    v2.style.top = midY + 'px';
                    v2.style.height = (nextCenterY - midY) + 'px';
                    track.appendChild(v2);

                    // 5. Horizontal from left edge to next node
                    const h3 = document.createElement('div');
                    h3.className = 'timeline-connector horizontal';
                    h3.style.left = leftEdgeX + 'px';
                    h3.style.top = (nextCenterY - 1.5) + 'px';
                    h3.style.width = (nextCenterX - leftEdgeX) + 'px';
                    // Add arrow only on last segment
                    if (isLastConnection) {
                        h3.innerHTML = '<div class="arrow arrow-right"></div>';
                    }
                    track.appendChild(h3);
                }
            }
        }

        // ========== TAB SWITCHING ==========
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            // Load settings when switching to settings tab
            if (tabName === 'settings') {
                loadInvestigationSettings();
            }
        }

        // ========== INVESTIGATION SETTINGS MANAGEMENT ==========
        const defaultInvestigationSettings = {
            targetLeadTime: 30,
            warningThreshold: 80,
            criticalThreshold: 100,
            monthlyTarget: 10,
            closureRate: 90,
            qualityScore: 85,
            highPriorityDays: 7,
            mediumPriorityDays: 14,
            lowPriorityDays: 30,
            reminderDays: 3,
            escalationEmail: '',
            enableAutoReminders: 'true',
            investigationCategories: 'Equipment Failure\nHuman Error\nProcess Deviation\nEnvironmental\nNear Miss\nSafety Incident'
        };

        async function loadInvestigationSettings() {
            try {
                const user = getAuthUser();
                if (!user || !user.companyId) {
                    console.warn('No company context for settings');
                    applySettingsToForm(defaultInvestigationSettings);
                    return;
                }
                const db = firebase.database();
                const snap = await db.ref(`companies/${user.companyId}/investigationSettings`).once('value');
                if (snap.exists()) {
                    const settings = { ...defaultInvestigationSettings, ...snap.val() };
                    applySettingsToForm(settings);
                    console.log('âœ… Investigation settings loaded');
                } else {
                    applySettingsToForm(defaultInvestigationSettings);
                    console.log('â„¹ï¸ Using default investigation settings');
                }
            } catch (err) {
                console.error('âŒ Error loading investigation settings:', err);
                applySettingsToForm(defaultInvestigationSettings);
            }
        }

        function applySettingsToForm(settings) {
            const fields = [
                'targetLeadTime', 'warningThreshold', 'criticalThreshold',
                'monthlyTarget', 'closureRate', 'qualityScore',
                'highPriorityDays', 'mediumPriorityDays', 'lowPriorityDays',
                'reminderDays', 'escalationEmail', 'enableAutoReminders',
                'investigationCategories'
            ];
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el && settings[field] !== undefined) {
                    el.value = settings[field];
                }
            });
        }

        function getSettingsFromForm() {
            return {
                targetLeadTime: parseInt(document.getElementById('targetLeadTime')?.value) || 30,
                warningThreshold: parseInt(document.getElementById('warningThreshold')?.value) || 80,
                criticalThreshold: parseInt(document.getElementById('criticalThreshold')?.value) || 100,
                monthlyTarget: parseInt(document.getElementById('monthlyTarget')?.value) || 10,
                closureRate: parseInt(document.getElementById('closureRate')?.value) || 90,
                qualityScore: parseInt(document.getElementById('qualityScore')?.value) || 85,
                highPriorityDays: parseInt(document.getElementById('highPriorityDays')?.value) || 7,
                mediumPriorityDays: parseInt(document.getElementById('mediumPriorityDays')?.value) || 14,
                lowPriorityDays: parseInt(document.getElementById('lowPriorityDays')?.value) || 30,
                reminderDays: parseInt(document.getElementById('reminderDays')?.value) || 3,
                escalationEmail: document.getElementById('escalationEmail')?.value || '',
                enableAutoReminders: document.getElementById('enableAutoReminders')?.value || 'true',
                investigationCategories: document.getElementById('investigationCategories')?.value || ''
            };
        }

        // Toggle collapsible settings sections
        function toggleSettingsSection(titleElement) {
            const section = titleElement.parentElement;
            section.classList.toggle('collapsed');
        }

        // Expand all settings sections
        function expandAllSettingsSections() {
            const settingsTab = document.getElementById('settingsTab');
            if (!settingsTab) return;
            settingsTab.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('collapsed');
            });
        }

        // Collapse all settings sections
        function collapseAllSettingsSections() {
            const settingsTab = document.getElementById('settingsTab');
            if (!settingsTab) return;
            settingsTab.querySelectorAll('.settings-section').forEach(section => {
                section.classList.add('collapsed');
            });
        }

        // ========== ACCESS CONTROL FUNCTIONS ==========
        let __invAc_users_cache = {};
        let __invAc_perms_cache = {};

        async function loadInvAccessControlData(companyId) {
            const db = firebase.database();
            const [usersSnap, permsSnap] = await Promise.all([
                db.ref(`companies/${companyId}/users`).once('value'),
                db.ref(`companies/${companyId}/investigationAccessControl`).once('value')
            ]);
            return { users: usersSnap.val() || {}, perms: permsSnap.val() || {} };
        }

        function renderInvAccessControlTable(companyId, users, perms) {
            const tbody = document.getElementById('invAccessControlTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const permUserIds = Object.keys(perms || {});
            if (permUserIds.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="8" style="text-align:center; color:#64748b; padding:1.5rem;">No users configured. Click + to add users.</td>`;
                tbody.appendChild(tr);
            } else {
                permUserIds.forEach((uid) => {
                    const u = users[uid] || {};
                    const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                    const email = (u.accountType === 'without-account' || u.reportingOnly === true || u.canSignIn === false) ? '-' : (u.email || '-');
                    const role = u.role || 'User';
                    const p = perms[uid] || {};

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${name}</td>
                        <td>${email}</td>
                        <td><span class="role-badge role-${(role || 'user').toString().toLowerCase()}">${role}</span></td>
                        <td style="text-align:center;"><input type="checkbox" data-perm="investigations" data-uid="${uid}" ${p.canSeeInvestigationsTab !== false ? 'checked' : ''}></td>
                        <td style="text-align:center;"><input type="checkbox" data-perm="viewAll" data-uid="${uid}" ${p.canViewAllInvestigations ? 'checked' : ''} title="Allow user to see all investigations regardless of submitter"></td>
                        <td style="text-align:center;"><input type="checkbox" data-perm="editAll" data-uid="${uid}" ${p.canEditAllInvestigations ? 'checked' : ''} title="Allow user to edit all investigations regardless of submitter"></td>
                        <td style="text-align:center;"><input type="checkbox" data-perm="settings" data-uid="${uid}" ${p.canSeeSettingsTab ? 'checked' : ''}></td>
                        <td style="text-align:center;"><button class="btn-remove" onclick="removeInvAccessControl('${uid}')" title="Remove user"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // Delegated handler for checkbox changes
            tbody.onchange = async (e) => {
                const target = e.target;
                if (!target || !target.matches('input[type="checkbox"][data-uid]')) return;
                const uid = target.getAttribute('data-uid');
                const perm = target.getAttribute('data-perm');
                const update = {};
                if (perm === 'investigations') update.canSeeInvestigationsTab = target.checked;
                if (perm === 'viewAll') update.canViewAllInvestigations = target.checked;
                if (perm === 'editAll') update.canEditAllInvestigations = target.checked;
                if (perm === 'settings') update.canSeeSettingsTab = target.checked;
                try {
                    const db = firebase.database();
                    await db.ref(`companies/${companyId}/investigationAccessControl/${uid}`).update(update);
                    // Apply visibility if current user
                    const user = getAuthUser();
                    if (user && (user.uid === uid || user.id === uid)) {
                        await applyInvTabVisibility(companyId);
                        // Refresh investigations list if viewAll permission changed
                        if (perm === 'viewAll' && window.investigationListInstance) {
                            await window.investigationListInstance.loadInvestigations();
                            window.investigationListInstance.renderInvestigations();
                        }
                    }
                    console.log('âœ… Access control updated');
                } catch (err) {
                    console.error('âŒ Failed to update access control:', err);
                    alert('Failed to update access control');
                }
            };
        }

        async function populateInvAccessControlTable() {
            try {
                const user = getAuthUser();
                if (!user || !user.companyId) return;
                const { users, perms } = await loadInvAccessControlData(user.companyId);
                __invAc_users_cache = users;
                __invAc_perms_cache = perms;
                renderInvAccessControlTable(user.companyId, users, perms);
            } catch (e) {
                console.warn('Access control could not be populated:', e);
            }
        }

        async function applyInvTabVisibility(companyId) {
            try {
                const user = getAuthUser();
                const me = user?.uid || user?.id;
                if (!me || !companyId) return;
                const db = firebase.database();
                const pSnap = await db.ref(`companies/${companyId}/investigationAccessControl/${me}`).once('value');
                const p = pSnap.val() || {};
                
                // Default: Investigations tab is allowed unless explicitly denied
                const allowInvestigations = p.canSeeInvestigationsTab !== false;
                // Default: Settings tab is allowed unless explicitly denied
                const allowSettings = p.canSeeSettingsTab !== false;

                const invBtn = document.querySelector('.tab-btn[data-tab="investigations"]');
                const settingsBtn = document.querySelector('.tab-btn[data-tab="settings"]');
                const invTab = document.getElementById('investigationsTab');
                const settingsTab = document.getElementById('settingsTab');

                if (invBtn) invBtn.style.display = allowInvestigations ? '' : 'none';
                if (settingsBtn) settingsBtn.style.display = allowSettings ? '' : 'none';
                if (invTab) invTab.style.display = allowInvestigations ? '' : 'none';
                if (settingsTab) settingsTab.style.display = allowSettings ? '' : 'none';

                // If on hidden tab, switch to allowed tab
                const isInvActive = invTab?.classList.contains('active');
                const isSettingsActive = settingsTab?.classList.contains('active');
                if ((isInvActive && !allowInvestigations) || (isSettingsActive && !allowSettings)) {
                    const fallback = allowInvestigations ? 'investigations' : (allowSettings ? 'settings' : null);
                    if (fallback) {
                        switchTab(fallback);
                    }
                }
            } catch (e) {
                console.warn('Failed to apply tab visibility:', e);
            }
        }

        async function openInvAccessControlModal() {
            const select = document.getElementById('invAcUserSelect');
            if (select) {
                select.innerHTML = '<option value="">Loading users...</option>';
            }
            
            // Show modal immediately
            const modal = document.getElementById('invAccessControlModal');
            if (modal) modal.style.display = 'flex';

            // Load users from Firebase
            try {
                const user = getAuthUser();
                if (!user || !user.companyId) {
                    if (select) select.innerHTML = '<option value="">Error: No company context</option>';
                    return;
                }
                const { users, perms } = await loadInvAccessControlData(user.companyId);
                __invAc_users_cache = users;
                __invAc_perms_cache = perms;

                if (select) {
                    const existing = new Set(Object.keys(perms || {}));
                    select.innerHTML = '<option value="">-- Choose a user --</option>';
                    Object.entries(users || {}).forEach(([uid, u]) => {
                        if (existing.has(uid)) return; // Skip users already in access control
                        const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                        const email = u.email || '-';
                        const opt = document.createElement('option');
                        opt.value = uid;
                        opt.textContent = `${name} ${email !== '-' ? `(${email})` : ''}`.trim();
                        select.appendChild(opt);
                    });
                    
                    if (select.options.length <= 1) {
                        select.innerHTML = '<option value="">No available users to add</option>';
                    }
                }
            } catch (err) {
                console.error('Failed to load users:', err);
                if (select) select.innerHTML = '<option value="">Error loading users</option>';
            }

            // Reset checkboxes
            const allowInv = document.getElementById('invAcAllowInvestigations');
            const allowViewAll = document.getElementById('invAcAllowViewAll');
            const allowEditAll = document.getElementById('invAcAllowEditAll');
            const allowSettings = document.getElementById('invAcAllowSettings');
            if (allowInv) allowInv.checked = true;
            if (allowViewAll) allowViewAll.checked = false;
            if (allowEditAll) allowEditAll.checked = false;
            if (allowSettings) allowSettings.checked = true;
        }

        function closeInvAccessControlModal() {
            const modal = document.getElementById('invAccessControlModal');
            if (modal) modal.style.display = 'none';
        }

        async function saveInvAccessControl() {
            const user = getAuthUser();
            if (!user || !user.companyId) {
                alert('Error: No company context');
                return;
            }
            const select = document.getElementById('invAcUserSelect');
            const uid = select?.value || '';
            if (!uid) {
                alert('Please select a user');
                return;
            }
            const canInvestigations = !!document.getElementById('invAcAllowInvestigations')?.checked;
            const canViewAll = !!document.getElementById('invAcAllowViewAll')?.checked;
            const canEditAll = !!document.getElementById('invAcAllowEditAll')?.checked;
            const canSettings = !!document.getElementById('invAcAllowSettings')?.checked;
            try {
                const db = firebase.database();
                await db.ref(`companies/${user.companyId}/investigationAccessControl/${uid}`).set({
                    canSeeInvestigationsTab: canInvestigations,
                    canViewAllInvestigations: canViewAll,
                    canEditAllInvestigations: canEditAll,
                    canSeeSettingsTab: canSettings,
                    addedAt: Date.now(),
                    addedBy: user.uid || user.email || 'unknown'
                });
                await populateInvAccessControlTable();
                closeInvAccessControlModal();
                console.log('âœ… User added to access control');
            } catch (err) {
                console.error('âŒ Failed to save access control:', err);
                alert('Failed to add user: ' + err.message);
            }
        }

        async function removeInvAccessControl(uid) {
            if (!confirm('Remove this user from access control?')) return;
            const user = getAuthUser();
            if (!user || !user.companyId) return;
            try {
                const db = firebase.database();
                await db.ref(`companies/${user.companyId}/investigationAccessControl/${uid}`).remove();
                await populateInvAccessControlTable();
                console.log('âœ… User removed from access control');
            } catch (err) {
                console.error('âŒ Failed to remove user:', err);
                alert('Failed to remove user');
            }
        }

        // Initialize access control on page load
        function initInvAccessControl() {
            const user = getAuthUser();
            if (!user || !user.companyId) {
                setTimeout(initInvAccessControl, 500);
                return;
            }
            populateInvAccessControlTable();
            applyInvTabVisibility(user.companyId);
        }

        async function saveInvestigationSettings() {
            try {
                const user = getAuthUser();
                if (!user || !user.companyId) {
                    alert('Error: No company context. Please log in again.');
                    return;
                }
                const settings = getSettingsFromForm();
                settings.updatedAt = Date.now();
                settings.updatedBy = user.uid || user.email || 'unknown';

                const db = firebase.database();
                await db.ref(`companies/${user.companyId}/investigationSettings`).set(settings);
                
                alert('âœ… Investigation settings saved successfully!');
                console.log('âœ… Investigation settings saved:', settings);
            } catch (err) {
                console.error('âŒ Error saving investigation settings:', err);
                alert('Error saving settings: ' + err.message);
            }
        }

        function resetInvestigationSettings() {
            if (!confirm('Reset all settings to defaults? This will not save until you click "Save Settings".')) return;
            applySettingsToForm(defaultInvestigationSettings);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Auth/brand/notifications just like project-list
            window.authManager = new AuthManager();
            initializePage();
            // Header helpers
            wireNotificationUI();
            subscribeNotifications();
            // Role-based menu authorization if available globally
            if (typeof initializeMenuAuthorization === 'function') {
                initializeMenuAuthorization();
            } else if (typeof updateMenuWithFeatureAuthorization === 'function') {
                updateMenuWithFeatureAuthorization();
            }

            // Initialize Access Control
            setTimeout(initInvAccessControl, 800);

            // Language selector initialization
            const langSelect = document.getElementById('langSelect');
            if (langSelect) {
                langSelect.value = currentLang;
                langSelect.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
            }
            
            // Apply initial translations
            applyTranslations();

            // Page logic
            window.investigationListInstance = new InvestigationList();

            // Safety fallback to remove loading state if menu system doesn't
            setTimeout(() => {
                const sb=document.querySelector('.sidebar');
                if (sb && sb.classList.contains('menu-loading')) sb.classList.remove('menu-loading');
            }, 800);
        });
    </script>
    <style>
        /* Additional print-friendly elements - hide non-modal content */
        @media print {
            /* Hide all non-modal page elements */
            .sidebar, 
            .top-nav, 
            .filters, 
            .table-container, 
            .page-header, 
            .page-actions, 
            .content,
            .modal-footer, 
            .modal-header button#invCloseBtn,
            nav,
            .app-container > *:not(#investigationDetailsOverlay) { 
                display: none !important; 
                visibility: hidden !important;
            }
            
            /* Override app container for print */
            .app-container {
                display:block !important;
                margin:0 !important;
                padding:0 !important;
            }
            
            .main-content {
                margin:0 !important;
                padding:0 !important;
            }
            
            /* Ensure content flows across pages properly */
            .inv-preview-container {
                height:auto !important;
                min-height:auto !important;
                max-height:none !important;
                overflow:visible !important;
            }
            
            /* Allow sections to break across pages when needed */
            .inv-sections .section {
                page-break-inside:auto !important;
            }
            
            /* Avoid breaking inside table rows */
            .inv-info-table tbody tr {
                page-break-inside:avoid !important;
            }
            
            /* Avoid breaking table headers */
            .inv-info-table thead {
                display:table-header-group !important;
            }
            
            /* Ensure long text wraps properly */
            .inv-info-table td {
                word-wrap:break-word !important;
                word-break:break-word !important;
                max-width:none !important;
            }
            
            /* Timeline section should try to stay on one page */
            #invTimelineContainer {
                page-break-inside:avoid !important;
            }
            
            /* Document Information row - force single line in print */
            .doc-info-row {
                display:flex !important;
                flex-wrap:nowrap !important;
                gap:16px !important;
                align-items:center !important;
            }
            .doc-info-row > div {
                white-space:nowrap !important;
            }
        }
    </style>

    <!-- Access Control Modal -->
    <div id="invAccessControlModal" class="modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:#fff; border-radius:12px; width:100%; max-width:500px; box-shadow:0 10px 40px rgba(0,0,0,0.2); position:relative;">
            <div style="padding:1rem 1.25rem; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between;">
                <h3 style="margin:0; font-size:1rem; font-weight:600; display:flex; align-items:center; gap:0.5rem;"><i class="fas fa-user-shield" style="color:var(--primary-color);"></i> Add Access Control</h3>
                <button onclick="closeInvAccessControlModal()" style="background:none; border:none; font-size:1.25rem; cursor:pointer; color:#64748b;">&times;</button>
            </div>
            <div style="padding:1.25rem;">
                <div style="margin-bottom:1rem;">
                    <label style="display:block; font-size:0.85rem; font-weight:600; color:#374151; margin-bottom:0.5rem;">Select User</label>
                    <select id="invAcUserSelect" style="width:100%; padding:0.5rem 0.75rem; border:1px solid #d1d5db; border-radius:6px; font-size:0.85rem;">
                        <option value="">-- Choose a user --</option>
                    </select>
                    <small style="font-size:0.75rem; color:#64748b;">Choose a user who is not already in the access control list.</small>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div>
                        <label style="display:block; font-size:0.85rem; font-weight:600; color:#374151; margin-bottom:0.5rem;">Investigations Tab</label>
                        <label style="display:flex; align-items:center; gap:0.4rem; font-size:0.85rem;">
                            <input type="checkbox" id="invAcAllowInvestigations" checked>
                            Allow access
                        </label>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85rem; font-weight:600; color:#374151; margin-bottom:0.5rem;">Settings Tab</label>
                        <label style="display:flex; align-items:center; gap:0.4rem; font-size:0.85rem;">
                            <input type="checkbox" id="invAcAllowSettings" checked>
                            Allow access
                        </label>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">
                    <div>
                        <label style="display:block; font-size:0.85rem; font-weight:600; color:#374151; margin-bottom:0.5rem;">View All</label>
                        <label style="display:flex; align-items:center; gap:0.4rem; font-size:0.85rem;">
                            <input type="checkbox" id="invAcAllowViewAll">
                            See all investigations
                        </label>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85rem; font-weight:600; color:#374151; margin-bottom:0.5rem;">Edit All</label>
                        <label style="display:flex; align-items:center; gap:0.4rem; font-size:0.85rem;">
                            <input type="checkbox" id="invAcAllowEditAll">
                            Edit all investigations
                        </label>
                    </div>
                </div>
            </div>
            <div style="padding:1rem 1.25rem; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:0.75rem;">
                <button onclick="closeInvAccessControlModal()" style="padding:0.5rem 1rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:6px; font-size:0.85rem; cursor:pointer;">Cancel</button>
                <button onclick="saveInvAccessControl()" style="padding:0.5rem 1rem; background:var(--primary-color); color:#fff; border:none; border-radius:6px; font-size:0.85rem; font-weight:600; cursor:pointer;">Add</button>
            </div>
        </div>
    </div>

    <!-- Interactive Guide Start Button -->
    <button class="guide-start-btn" id="startGuideBtn" onclick="startInteractiveGuide()" title="Help Guide">
        <i class="fas fa-question-circle"></i>
    </button>

    <!-- Demo Video Button with Dropdown -->
    <button class="video-btn" id="demoMenuBtn" onclick="toggleDemoDropdown()" title="Watch Demo">
        <i class="fas fa-play-circle"></i>
    </button>
    
    <!-- Demo Dropdown Menu -->
    <div class="demo-dropdown" id="demoDropdown">
        <div class="demo-dropdown-header"><i class="fas fa-video"></i> Available Demos</div>
        <div class="demo-dropdown-item" onclick="openVideoTutorial(); closeDemoDropdown();">
            <i class="fas fa-plus-circle demo-icon-create"></i>
            <span>Create Investigation</span>
        </div>
        <div class="demo-dropdown-item" onclick="openEditDemoVideo(); closeDemoDropdown();">
            <i class="fas fa-edit demo-icon-edit"></i>
            <span>Edit Investigation</span>
        </div>
    </div>

    <!-- Video Tutorial Modal -->
    <div class="video-tutorial-overlay" id="videoTutorialOverlay">
        <div class="video-tutorial-container" style="max-width:1100px;">
            <div class="video-tutorial-header">
                <h3><i class="fas fa-graduation-cap"></i> How to Create an Investigation</h3>
                <button class="video-tutorial-close" onclick="closeVideoTutorial()">&times;</button>
            </div>
            <div class="video-tutorial-screen" id="videoScreen" style="position:relative; overflow:hidden;">
                <!-- Demo Scenes Container -->
                <div id="demoSceneContainer" style="width:100%; height:100%; position:relative; background:#f1f5f9;"></div>
                
                <!-- Animated Cursor -->
                <div class="cursor-pointer" id="demoCursor" style="display:none; position:absolute; z-index:100;"></div>
                
                <!-- Highlight Overlay -->
                <div id="demoHighlight" class="highlight-box" style="display:none; position:absolute; z-index:99;"></div>
                
                <!-- Caption Overlay -->
                <div class="scene-caption" id="demoCaption" style="position:absolute; bottom:0; left:0; right:0; z-index:101;">
                    <p id="demoCaptionText"><strong>Welcome!</strong> Let's learn how to create an investigation</p>
                </div>
            </div>
            <div class="video-tutorial-controls">
                <button class="video-tutorial-btn" id="videoPlayPauseBtn" onclick="toggleVideoPlayPause()">
                    <i class="fas fa-pause"></i>
                </button>
                <div class="video-tutorial-progress" onclick="seekVideo(event)">
                    <div class="video-tutorial-progress-bar" id="videoProgressBar" style="width:0%"></div>
                </div>
                <span class="video-tutorial-time" id="videoTime">0:00 / 0:50</span>
                <button class="video-tutorial-btn" onclick="restartVideo()">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Demo Video Modal -->
    <div class="video-tutorial-overlay" id="editDemoOverlay">
        <div class="video-tutorial-container" style="max-width:1400px; width:95%;">
            <div class="video-tutorial-header" style="background:linear-gradient(135deg, #10b981, #059669);">
                <h3><i class="fas fa-edit"></i> How to Edit/Modify an Investigation</h3>
                <button class="video-tutorial-close" onclick="closeEditDemoVideo()">&times;</button>
            </div>
            <div class="video-tutorial-screen" id="editVideoScreen" style="position:relative; overflow:hidden; aspect-ratio:16/7; max-height:70vh;">
                <!-- Edit Demo Scenes Container -->
                <div id="editDemoSceneContainer" style="width:100%; height:100%; position:relative; background:#f1f5f9;"></div>
                
                <!-- Caption Overlay -->
                <div class="scene-caption" id="editDemoCaption" style="position:absolute; bottom:0; left:0; right:0; z-index:101;">
                    <p id="editDemoCaptionText"><strong>Welcome!</strong> Let's learn how to edit an investigation</p>
                </div>
            </div>
            <div class="video-tutorial-controls">
                <button class="video-tutorial-btn" id="editVideoPlayPauseBtn" onclick="toggleEditVideoPlayPause()">
                    <i class="fas fa-pause"></i>
                </button>
                <div class="video-tutorial-progress" onclick="seekEditVideo(event)">
                    <div class="video-tutorial-progress-bar" id="editVideoProgressBar" style="width:0%"></div>
                </div>
                <span class="video-tutorial-time" id="editVideoTime">0:00 / 0:45</span>
                <button class="video-tutorial-btn" onclick="restartEditVideo()">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Guide Elements Container -->
    <div id="guideContainer"></div>

    <script>
    // ========== INTERACTIVE GUIDE / TOUR ==========
    const guideSteps = [
        {
            target: '.page-header',
            title: 'Welcome to Investigation List',
            content: 'This page allows you to view, manage, and track all investigations in your organization. Let\'s walk through the main features!',
            position: 'bottom'
        },
        {
            target: '.btn.btn-create',
            title: 'Create New Investigation',
            content: 'Click this <strong>+ button</strong> to create a new investigation. You\'ll be taken to a form where you can enter all the details about the incident.',
            position: 'left'
        },
        {
            target: '.tab-navigation',
            title: 'Navigation Tabs',
            content: 'Switch between <strong>Investigations</strong> (to view all cases) and <strong>Settings</strong> (to configure investigation parameters and access control).',
            position: 'bottom'
        },
        {
            target: '.filters',
            title: 'Filter Investigations',
            content: 'Use these filters to narrow down your search. You can filter by <strong>Status</strong>, <strong>Priority</strong>, <strong>Investigator</strong>, and <strong>Date Range</strong>. Click "Apply Filters" to update the results.',
            position: 'bottom'
        },
        {
            target: '.data-table',
            title: 'Investigation Table',
            content: 'This table shows all investigations. <strong>Click on any row</strong> to open the full details in a modal. You can see the ID, title, status, priority, and other key information at a glance.',
            position: 'top'
        },
        {
            target: '.tab-btn[data-tab="settings"]',
            title: 'Settings Tab',
            content: 'Click here to access investigation settings where you can configure <strong>Lead Times</strong>, <strong>KPI Targets</strong>, <strong>Priority Settings</strong>, <strong>Notifications</strong>, and <strong>Access Control</strong>.',
            position: 'bottom'
        },
        {
            target: '.sidebar',
            title: 'Navigation Menu',
            content: 'Use the sidebar menu to navigate to other modules like <strong>Dashboard</strong>, <strong>Reports</strong>, <strong>Incidents</strong>, and more.',
            position: 'right'
        },
        {
            target: '.user-profile',
            title: 'Your Profile',
            content: 'Click here to access your profile, change settings, or log out of the system.',
            position: 'left'
        }
    ];

    let currentGuideStep = 0;
    let guideActive = false;

    function startInteractiveGuide() {
        currentGuideStep = 0;
        guideActive = true;
        document.getElementById('startGuideBtn').style.display = 'none';
        showGuideStep(currentGuideStep);
    }

    function showGuideStep(stepIndex) {
        const container = document.getElementById('guideContainer');
        container.innerHTML = '';

        if (stepIndex < 0 || stepIndex >= guideSteps.length) {
            endGuide();
            return;
        }

        const step = guideSteps[stepIndex];
        const targetEl = document.querySelector(step.target);
        
        if (!targetEl) {
            // Skip to next step if target not found
            currentGuideStep++;
            if (currentGuideStep < guideSteps.length) {
                showGuideStep(currentGuideStep);
            } else {
                endGuide();
            }
            return;
        }

        // Scroll target into view
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

        setTimeout(() => {
            const rect = targetEl.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

            // Create highlight
            const highlight = document.createElement('div');
            highlight.className = 'guide-highlight';
            highlight.style.top = (rect.top + scrollTop - 4) + 'px';
            highlight.style.left = (rect.left + scrollLeft - 4) + 'px';
            highlight.style.width = (rect.width + 8) + 'px';
            highlight.style.height = (rect.height + 8) + 'px';
            container.appendChild(highlight);

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'guide-tooltip';
            tooltip.innerHTML = `
                <div class="guide-tooltip-header">
                    <span class="step-badge">Step ${stepIndex + 1}</span>
                    <h4>${step.title}</h4>
                </div>
                <div class="guide-tooltip-body">${step.content}</div>
                <div class="guide-tooltip-footer">
                    <span class="guide-progress">${stepIndex + 1} of ${guideSteps.length}</span>
                    <div class="guide-buttons">
                        <button class="guide-btn guide-btn-skip" onclick="endGuide()">Skip</button>
                        ${stepIndex > 0 ? '<button class="guide-btn guide-btn-prev" onclick="prevGuideStep()"><i class="fas fa-arrow-left"></i> Back</button>' : ''}
                        ${stepIndex < guideSteps.length - 1 
                            ? '<button class="guide-btn guide-btn-next" onclick="nextGuideStep()">Next <i class="fas fa-arrow-right"></i></button>' 
                            : '<button class="guide-btn guide-btn-finish" onclick="endGuide()"><i class="fas fa-check"></i> Finish</button>'}
                    </div>
                </div>
            `;

            // Position tooltip based on step.position
            const tooltipWidth = 340;
            const tooltipHeight = 180;
            let tooltipTop, tooltipLeft;
            let arrowStyle = '';

            switch(step.position) {
                case 'top':
                    tooltipTop = rect.top + scrollTop - tooltipHeight - 20;
                    tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - (tooltipWidth / 2);
                    arrowStyle = 'bottom: -6px; left: 50%; transform: translateX(-50%) rotate(45deg);';
                    break;
                case 'bottom':
                    tooltipTop = rect.bottom + scrollTop + 20;
                    tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - (tooltipWidth / 2);
                    arrowStyle = 'top: -6px; left: 50%; transform: translateX(-50%) rotate(45deg);';
                    break;
                case 'left':
                    tooltipTop = rect.top + scrollTop + (rect.height / 2) - (tooltipHeight / 2);
                    tooltipLeft = rect.left + scrollLeft - tooltipWidth - 20;
                    arrowStyle = 'right: -6px; top: 50%; transform: translateY(-50%) rotate(45deg);';
                    break;
                case 'right':
                    tooltipTop = rect.top + scrollTop + (rect.height / 2) - (tooltipHeight / 2);
                    tooltipLeft = rect.right + scrollLeft + 20;
                    arrowStyle = 'left: -6px; top: 50%; transform: translateY(-50%) rotate(45deg);';
                    break;
            }

            // Keep tooltip within viewport
            tooltipLeft = Math.max(20, Math.min(tooltipLeft, window.innerWidth - tooltipWidth - 20));
            tooltipTop = Math.max(20, tooltipTop);

            tooltip.style.top = tooltipTop + 'px';
            tooltip.style.left = tooltipLeft + 'px';

            // Add arrow
            const arrow = document.createElement('div');
            arrow.className = 'guide-tooltip-arrow';
            arrow.style.cssText = arrowStyle;
            tooltip.appendChild(arrow);

            container.appendChild(tooltip);
        }, 300);
    }

    function nextGuideStep() {
        currentGuideStep++;
        showGuideStep(currentGuideStep);
    }

    function prevGuideStep() {
        currentGuideStep--;
        showGuideStep(currentGuideStep);
    }

    function endGuide() {
        guideActive = false;
        const container = document.getElementById('guideContainer');
        container.innerHTML = '';
        document.getElementById('startGuideBtn').style.display = 'flex';
        
        // Save that user has seen the guide
        try {
            localStorage.setItem('investigationGuideCompleted', 'true');
        } catch(e) {}
    }

    // Auto-start guide for first-time visitors (optional)
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            try {
                const hasSeenGuide = localStorage.getItem('investigationGuideCompleted');
                // Uncomment below to auto-start for first-time visitors:
                // if (!hasSeenGuide) { startInteractiveGuide(); }
            } catch(e) {}
        }, 1500);
    });

    // ========== VIDEO TUTORIAL - FULL INVESTIGATION CREATION DEMO ==========
    let videoPlaying = false;
    let videoCurrentStep = 0;
    let videoInterval = null;
    let videoProgress = 0;
    
    // Comprehensive step-by-step scenes - autofill animation (no cursor) with auto-scroll
    const demoScenes = [
        // Define Tab Scenes (1-19)
        { id: 'welcome', caption: '<strong>Welcome!</strong> Let\'s learn how to create a new investigation step by step', duration: 2500 },
        { id: 'click-plus', caption: '<strong>Step 1:</strong> Click the <span style="color:#fbbf24;">+ New Investigation</span> button', duration: 2500 },
        { id: 'form-empty', caption: '<strong>Step 2:</strong> The Create Investigation form opens with <span style="color:#fbbf24;">DMAIC methodology</span> tabs', duration: 2000, scrollTo: 0 },
        { id: 'fill-title', caption: '<strong>Step 3:</strong> Enter the <span style="color:#fbbf24;">Investigation Title</span>', duration: 2000, scrollTo: 0 },
        { id: 'fill-purpose', caption: '<strong>Step 4:</strong> Describe the <span style="color:#fbbf24;">Purpose of Investigation</span>', duration: 2000, scrollTo: 5 },
        { id: 'fill-scope', caption: '<strong>Step 5:</strong> Define the <span style="color:#fbbf24;">Investigation Scope</span>', duration: 2000, scrollTo: 10 },
        { id: 'fill-methodology', caption: '<strong>Step 6:</strong> Specify the <span style="color:#fbbf24;">Investigation Methodology</span>', duration: 2000, scrollTo: 15 },
        { id: 'fill-dates', caption: '<strong>Step 7:</strong> Select <span style="color:#fbbf24;">Incident Date</span> and <span style="color:#fbbf24;">Reported Date</span>', duration: 2000, scrollTo: 22 },
        { id: 'fill-location', caption: '<strong>Step 8:</strong> Choose <span style="color:#fbbf24;">Location</span> and <span style="color:#fbbf24;">Department</span>', duration: 2000, scrollTo: 30 },
        { id: 'fill-type', caption: '<strong>Step 9:</strong> Select <span style="color:#fbbf24;">Incident Type</span> and <span style="color:#fbbf24;">Severity</span>', duration: 2000, scrollTo: 38 },
        { id: 'fill-severity', caption: '<strong>Step 10:</strong> Set <span style="color:#fbbf24;">Potential Severity</span> and <span style="color:#fbbf24;">Likelihood</span>', duration: 2000, scrollTo: 46 },
        { id: 'fill-description', caption: '<strong>Step 11:</strong> Provide detailed <span style="color:#fbbf24;">Incident Description</span>', duration: 2000, scrollTo: 54 },
        { id: 'fill-actions', caption: '<strong>Step 12:</strong> Document <span style="color:#fbbf24;">Immediate Actions Taken</span>', duration: 2000, scrollTo: 62 },
        { id: 'add-equipment', caption: '<strong>Step 13:</strong> Click <span style="color:#fbbf24;">+ Add Equipment</span> to add equipment involved', duration: 2000, scrollTo: 70 },
        { id: 'show-equipment', caption: '<strong>Step 14:</strong> Fill in <span style="color:#fbbf24;">Equipment</span> details (Name, ID, Type, Condition)', duration: 2500, scrollTo: 75 },
        { id: 'add-person', caption: '<strong>Step 15:</strong> Click <span style="color:#fbbf24;">+ Add Person</span> to add persons involved', duration: 2000, scrollTo: 82 },
        { id: 'show-person', caption: '<strong>Step 16:</strong> Fill in <span style="color:#fbbf24;">Person</span> details (Name, Company, Job, Phone)', duration: 2500, scrollTo: 88 },
        { id: 'add-team', caption: '<strong>Step 17:</strong> Click <span style="color:#fbbf24;">+ Add Person</span> to add team members', duration: 2000, scrollTo: 92 },
        { id: 'show-team', caption: '<strong>Step 18:</strong> Select <span style="color:#fbbf24;">Employee</span> and assign <span style="color:#fbbf24;">Role</span>', duration: 2500, scrollTo: 96 },
        // Measure Tab Scenes (20-31)
        { id: 'switch-measure', caption: '<strong>Step 19:</strong> Click <span style="color:#fbbf24;">Measure</span> tab to continue', duration: 2000, scrollTo: 0 },
        { id: 'measure-empty', caption: '<strong>Step 20:</strong> Measure tab contains <span style="color:#fbbf24;">PEEPO Analysis</span>, Location, Evidence & Timeline', duration: 2500, scrollTo: 0 },
        { id: 'fill-people', caption: '<strong>Step 21:</strong> Add <span style="color:#fbbf24;">People Factors</span> in PEEPO Analysis', duration: 2000, scrollTo: 0 },
        { id: 'fill-equipment-factors', caption: '<strong>Step 22:</strong> Add <span style="color:#fbbf24;">Equipment Factors</span>', duration: 2000, scrollTo: 10 },
        { id: 'fill-environment', caption: '<strong>Step 23:</strong> Add <span style="color:#fbbf24;">Environmental Factors</span>', duration: 2000, scrollTo: 20 },
        { id: 'fill-procedures', caption: '<strong>Step 24:</strong> Add <span style="color:#fbbf24;">Procedures</span>', duration: 2000, scrollTo: 30 },
        { id: 'fill-organization', caption: '<strong>Step 25:</strong> Add <span style="color:#fbbf24;">Organization</span> factors', duration: 2000, scrollTo: 40 },
        { id: 'fill-coordinates', caption: '<strong>Step 26:</strong> Enter <span style="color:#fbbf24;">Latitude</span> and <span style="color:#fbbf24;">Longitude</span> for location map', duration: 2000, scrollTo: 55 },
        { id: 'show-evidence', caption: '<strong>Step 27:</strong> Upload <span style="color:#fbbf24;">Photos & Evidence</span> files', duration: 2000, scrollTo: 70 },
        { id: 'add-timeline', caption: '<strong>Step 28:</strong> Click <span style="color:#fbbf24;">+ Add Event</span> to create timeline', duration: 2000, scrollTo: 85 },
        { id: 'show-timeline', caption: '<strong>Step 29:</strong> Fill in <span style="color:#fbbf24;">Event Date/Time</span>, Title, and Description', duration: 2500, scrollTo: 95 },
        { id: 'measure-review', caption: '<strong>Step 30:</strong> Review Measure tab - <span style="color:#22c55e;">All sections completed!</span>', duration: 2000, scrollTo: 100 },
        // Analyze Tab Scenes (32-42)
        { id: 'switch-analyze', caption: '<strong>Step 31:</strong> Click <span style="color:#fbbf24;">Analyze</span> tab to continue', duration: 2000, scrollTo: 0 },
        { id: 'analyze-empty', caption: '<strong>Step 32:</strong> Analyze tab contains <span style="color:#fbbf24;">ICAM Analysis</span> sections', duration: 2500, scrollTo: 0 },
        { id: 'show-contributing', caption: '<strong>Step 33:</strong> Review <span style="color:#fbbf24;">Contributing Factors</span> from PEEPO analysis', duration: 2000, scrollTo: 0 },
        { id: 'add-defense', caption: '<strong>Step 34:</strong> Add <span style="color:#fbbf24;">Absent/Failed Defenses</span> (ICAM)', duration: 2000, scrollTo: 15 },
        { id: 'show-defense', caption: '<strong>Step 35:</strong> Select defense type and add description', duration: 2500, scrollTo: 25 },
        { id: 'add-individual', caption: '<strong>Step 36:</strong> Add <span style="color:#fbbf24;">Individual/Team Actions</span>', duration: 2000, scrollTo: 40 },
        { id: 'show-individual', caption: '<strong>Step 37:</strong> Select action type and add details', duration: 2500, scrollTo: 50 },
        { id: 'add-task-env', caption: '<strong>Step 38:</strong> Add <span style="color:#fbbf24;">Task/Environmental Conditions</span>', duration: 2000, scrollTo: 60 },
        { id: 'add-org-factor', caption: '<strong>Step 39:</strong> Add <span style="color:#fbbf24;">Organisational Factors</span>', duration: 2000, scrollTo: 70 },
        { id: 'fill-data-analysis', caption: '<strong>Step 40:</strong> Document <span style="color:#fbbf24;">Data Collected</span> and <span style="color:#fbbf24;">Key Findings</span>', duration: 2500, scrollTo: 85 },
        { id: 'analyze-review', caption: '<strong>Step 41:</strong> Review Analyze tab - <span style="color:#22c55e;">Analysis complete!</span>', duration: 2000, scrollTo: 100 },
        // Improve Tab Scenes (43-47)
        { id: 'switch-improve', caption: '<strong>Step 42:</strong> Click <span style="color:#fbbf24;">Improve</span> tab to continue', duration: 2000, scrollTo: 0 },
        { id: 'improve-empty', caption: '<strong>Step 43:</strong> Improve tab contains <span style="color:#fbbf24;">Corrective Actions</span>', duration: 2500, scrollTo: 0 },
        { id: 'add-corrective', caption: '<strong>Step 44:</strong> Click <span style="color:#fbbf24;">+ Add</span> to create corrective action', duration: 2000, scrollTo: 0 },
        { id: 'show-corrective', caption: '<strong>Step 45:</strong> Fill in <span style="color:#fbbf24;">Owner, Due Date, Type, Description</span>', duration: 2500, scrollTo: 50 },
        { id: 'improve-review', caption: '<strong>Step 46:</strong> Review Improve tab - <span style="color:#22c55e;">Actions defined!</span>', duration: 2000, scrollTo: 100 },
        // Control Tab Scenes (48-53)
        { id: 'switch-control', caption: '<strong>Step 47:</strong> Click <span style="color:#fbbf24;">Control</span> tab to continue', duration: 2000, scrollTo: 0 },
        { id: 'control-empty', caption: '<strong>Step 48:</strong> Control tab contains <span style="color:#fbbf24;">Verification</span> and <span style="color:#fbbf24;">Lessons Learned</span>', duration: 2500, scrollTo: 0 },
        { id: 'add-verification', caption: '<strong>Step 49:</strong> Click <span style="color:#fbbf24;">+ Add</span> to verify improvements', duration: 2000, scrollTo: 0 },
        { id: 'show-verification', caption: '<strong>Step 50:</strong> Fill in <span style="color:#fbbf24;">Verification details</span> and effectiveness', duration: 2500, scrollTo: 40 },
        { id: 'fill-lessons', caption: '<strong>Step 51:</strong> Document <span style="color:#fbbf24;">Lessons Learned</span>', duration: 2000, scrollTo: 80 },
        { id: 'control-review', caption: '<strong>Step 52:</strong> Review Control tab - <span style="color:#22c55e;">Investigation complete!</span>', duration: 2000, scrollTo: 100 },
        // Final Scenes (54-61)
        { id: 'submit', caption: '<strong>Step 53:</strong> Click <span style="color:#fbbf24;">Submit for Approval</span>', duration: 2500, scrollTo: 100 },
        { id: 'success', caption: '<strong>Done!</strong> Investigation created successfully! Reference: <span style="color:#fbbf24;">INV-2024-0025</span>', duration: 2500 },
        { id: 'back-to-list', caption: '<strong>Step 54:</strong> Return to the <span style="color:#fbbf24;">Investigation List</span> to see your new record', duration: 2500 },
        { id: 'list-new-entry', caption: '<strong>Step 55:</strong> Your new investigation <span style="color:#fbbf24;">INV-2024-0025</span> now appears in the list', duration: 2500 },
        { id: 'click-view', caption: '<strong>Step 56:</strong> Click the <span style="color:#fbbf24;">View button</span> to see the full investigation report', duration: 2500 },
        { id: 'show-report', caption: '<strong>Step 57:</strong> The <span style="color:#fbbf24;">Investigation Report</span> displays all details in read-only mode', duration: 3000 },
        { id: 'click-edit', caption: '<strong>Step 58:</strong> Click the <span style="color:#fbbf24;">Edit button</span> to modify an existing investigation', duration: 2500 },
        { id: 'final', caption: '<strong>Complete!</strong> You now know how to <span style="color:#22c55e;">Create</span>, <span style="color:#fbbf24;">View</span>, and <span style="color:#3b82f6;">Edit</span> investigations!', duration: 3500 }
    ];
    
    const totalDuration = demoScenes.reduce((sum, scene) => sum + scene.duration, 0);

    // Demo Dropdown Functions
    function toggleDemoDropdown() {
        const dropdown = document.getElementById('demoDropdown');
        dropdown.classList.toggle('active');
    }
    
    function closeDemoDropdown() {
        const dropdown = document.getElementById('demoDropdown');
        dropdown.classList.remove('active');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('demoDropdown');
        const btn = document.getElementById('demoMenuBtn');
        if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });

    function openVideoTutorial() {
        document.getElementById('videoTutorialOverlay').classList.add('active');
        buildDemoScenes();
        restartVideo();
    }

    function buildDemoScenes() {
        const container = document.getElementById('demoSceneContainer');
        if (!container) return;
        
        // Generate scenes HTML
        container.innerHTML = generateAllScenes();
        
        // Add CSS animations
        if (!document.getElementById('demoAnimStyles')) {
            const style = document.createElement('style');
            style.id = 'demoAnimStyles';
            style.textContent = `
                @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.6; } }
                @keyframes bounceIn { 0% { transform:scale(0); } 50% { transform:scale(1.2); } 100% { transform:scale(1); } }
                @keyframes blink { 0%, 100% { border-right-color: #3b82f6; } 50% { border-right-color: transparent; } }
                @keyframes autofillGlow { 0% { box-shadow: 0 0 0 2px rgba(34,197,94,0.3); } 50% { box-shadow: 0 0 8px 4px rgba(34,197,94,0.5); } 100% { box-shadow: 0 0 0 2px rgba(34,197,94,0.3); } }
                @keyframes highlightPulse { 0%, 100% { box-shadow: 0 0 0 3px rgba(251,191,36,0.4); } 50% { box-shadow: 0 0 12px 6px rgba(251,191,36,0.6); } }
                @keyframes buttonClick { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(0.95); } }
                @keyframes clickRipple { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(3); opacity: 0; } }
                @keyframes typewriter { from { max-width: 0; } to { max-width: 100%; } }
                @keyframes cursorBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
                @keyframes mouseFloat { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(3px, 3px); } }
                .demo-scene { position:absolute; top:0; left:0; right:0; bottom:60px; }
                .field-highlight { box-shadow: 0 0 0 4px rgba(251,191,36,0.6) !important; border-color: #fbbf24 !important; animation: highlightPulse 1.2s ease-in-out infinite; }
                .field-filled { background: #f0fdf4 !important; border-color: #22c55e !important; }
                .typing-text { 
                    display: inline-block;
                    overflow: hidden;
                    white-space: nowrap;
                    max-width: 0;
                    animation: typewriter 1.5s ease-out forwards;
                    vertical-align: bottom;
                }
                .typing-cursor {
                    display: inline-block;
                    width: 2px;
                    height: 1em;
                    background: #3b82f6;
                    margin-left: 1px;
                    animation: cursorBlink 0.8s step-end infinite;
                    vertical-align: bottom;
                }
                #demoCursor { display: none !important; }
            `;
            document.head.appendChild(style);
        }
    }
    
    function generateAllScenes() {
        // Sidebar HTML (reusable)
        const sidebarHTML = `
            <div style="width:100px; background:#2c3e50; color:#fff; padding:0.25rem; flex-shrink:0; font-size:0.75rem;">
                <div style="text-align:center; padding:0.25rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:600; font-size:0.5rem;">Dreamex</div>
                <div style="margin-top:0.3rem;">
                    <div style="padding:0.2rem 0.3rem; margin-bottom:0.15rem; border-radius:2px; display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
                    <div style="padding:0.2rem 0.3rem; margin-bottom:0.15rem; border-radius:2px; background:rgba(255,255,255,0.15); display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-search-plus"></i> Investigation</div>
                    <div style="padding:0.2rem 0.3rem; margin-bottom:0.15rem; border-radius:2px; display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-hard-hat"></i> Safety</div>
                </div>
            </div>
        `;
        
        // Top nav HTML
        const topNavHTML = `
            <div style="background:#fff; padding:0.2rem 0.4rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e2e8f0;">
                <span style="font-size:0.5rem; font-weight:600; color:#334155;">Company Name</span>
                <div style="width:16px; height:16px; background:#3b82f6; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.7rem;">JD</div>
            </div>
        `;
        
        // Header HTML
        const headerHTML = `
            <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.4rem; display:flex; align-items:center; gap:0.3rem;">
                <i class="fas fa-plus-circle" style="font-size:0.55rem;"></i>
                <span style="font-size:0.55rem; font-weight:600;">Create New Investigation</span>
            </div>
        `;
        
        // DMAIC tabs HTML - now a function to set active tab
        const getTabsHTML = (activeTab = 'define') => {
            const isActive = (tab) => activeTab === tab;
            const isSwitch = (tab) => activeTab === 'switch-' + tab;
            const getStyle = (tab) => {
                const active = isActive(tab);
                const switching = isSwitch(tab);
                return `padding:0.15rem 0.35rem; font-size:0.75rem; font-weight:${active ? '600' : '500'}; border-radius:999px; background:#fff; border:1px solid ${active ? '#0ea5e9' : '#e5e7eb'}; color:${active ? '#0ea5e9' : '#64748b'}; ${switching ? 'box-shadow:0 0 12px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}`;
            };
            return `
            <div style="background:#f8fafc; padding:0.2rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                <span style="${getStyle('define')}">Define</span>
                <span style="${getStyle('measure')}">Measure</span>
                <span style="${getStyle('analyze')}">Analyze</span>
                <span style="${getStyle('improve')}">Improve</span>
                <span style="${getStyle('control')}">Control</span>
            </div>
        `;
        };
        
        // Legacy tabs HTML for backwards compatibility
        const tabsHTML = getTabsHTML('define');
        
        // Footer buttons HTML generator
        const footerHTML = (highlightSubmit = false) => `
            <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.25rem 0.4rem; display:flex; justify-content:flex-end; gap:0.3rem;">
                <button style="padding:0.2rem 0.4rem; font-size:0.75rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                <button style="padding:0.2rem 0.4rem; font-size:0.75rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                <button style="padding:0.2rem 0.4rem; font-size:0.75rem; background:#3b82f6; color:#fff; border:none; border-radius:3px; font-weight:600; ${highlightSubmit ? 'box-shadow:0 0 0 3px rgba(251,191,36,0.6); animation:pulse 1s infinite;' : ''}"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
        `;
        
        // Field states for progressive filling - matching investigation-create.html exactly
        const fieldStates = {
            title: { empty: 'Enter title...', filled: 'Warehouse Forklift Incident' },
            purpose: { empty: 'Describe the purpose and objectives...', filled: 'Investigate root cause of forklift collision' },
            scope: { empty: 'Define the scope and boundaries...', filled: 'Warehouse B operations area' },
            methodology: { empty: 'Describe the methodology...', filled: 'ICAM methodology with interviews' },
            incidentDate: { empty: 'Select date/time', filled: '2024-12-10 14:30' },
            reportedDate: { empty: 'Select date/time', filled: '2024-12-10 15:00' },
            location: { empty: 'Select Location', filled: 'Warehouse B - Zone 3' },
            department: { empty: 'Select Department', filled: 'Operations' },
            incidentType: { empty: 'Select Type', filled: 'Property Damage' },
            severityActual: { empty: 'Select', filled: 'Major' },
            severityPotential: { empty: 'Select', filled: 'Catastrophic' },
            likelihood: { empty: 'Select', filled: 'Possible' },
            description: { empty: 'Provide a detailed description...', filled: 'Forklift operator collided with storage rack while reversing...' },
            immediateActions: { empty: 'What was done right after...', filled: 'Area cordoned off, first aid administered' }
        };
        
        // Generate form content based on which fields are filled
        // Options: showEquipment (highlight/show), showPerson (highlight/show), showTeam (highlight/show)
        const generateFormContent = (filledFields = [], highlightField = null, showEquipment = false, showPerson = false, showTeam = false, showValidation = false) => {
            const getFieldStyle = (fieldName) => {
                const isFilled = filledFields.includes(fieldName);
                const isHighlighted = highlightField === fieldName;
                if (isHighlighted) return 'border:3px solid #fbbf24; background:#fffbeb; box-shadow: 0 0 12px rgba(251,191,36,0.5);';
                if (isFilled) return 'border:2px solid #22c55e; background:#f0fdf4;';
                return 'border:2px solid #e2e8f0; background:#f8fafc;';
            };
            const getFieldValue = (fieldName) => {
                const isHighlighted = highlightField === fieldName;
                const isFilled = filledFields.includes(fieldName);
                const value = isFilled ? fieldStates[fieldName].filled : fieldStates[fieldName].empty;
                
                // Add typing effect for highlighted field
                if (isHighlighted && isFilled) {
                    return `<span class="typing-text">${value}</span><span class="typing-cursor"></span>`;
                }
                return value;
            };
            const getTextColor = (fieldName) => {
                return filledFields.includes(fieldName) ? 'color:#1e293b; font-weight:500;' : 'color:#94a3b8;';
            };
            
            return `
                <div id="demoFormScroll" style="flex:1; overflow-y:auto; padding:0.4rem; background:#fff; font-size:0.5rem;">
                    <!-- Introduction Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-info-circle" style="color:#3b82f6; font-size:0.55rem;"></i> Introduction
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; margin-bottom:0.25rem;">
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Investigation Title *</label>
                                    <div style="${getFieldStyle('title')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; min-height:1.2em; ${getTextColor('title')}">${getFieldValue('title')}</div>
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Reference Number</label>
                                    <div style="border:2px solid #e2e8f0; background:#f1f5f9; border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; color:#64748b;">INV-2024-0025</div>
                                </div>
                            </div>
                            <div style="margin-bottom:0.25rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Purpose of Investigation</label>
                                <div style="${getFieldStyle('purpose')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; min-height:1.5em; ${getTextColor('purpose')}">${getFieldValue('purpose')}</div>
                            </div>
                            <div style="margin-bottom:0.25rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Investigation Scope</label>
                                <div style="${getFieldStyle('scope')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; min-height:1.5em; ${getTextColor('scope')}">${getFieldValue('scope')}</div>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Investigation Methodology</label>
                                <div style="${getFieldStyle('methodology')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; min-height:1.5em; ${getTextColor('methodology')}">${getFieldValue('methodology')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Incident Summary Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-file-alt" style="color:#f59e0b; font-size:0.55rem;"></i> Incident Summary
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; margin-bottom:0.25rem;">
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Incident Date *</label>
                                    <div style="${getFieldStyle('incidentDate')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${getTextColor('incidentDate')}"><i class="fas fa-calendar" style="font-size:0.7rem; margin-right:0.15rem;"></i>${getFieldValue('incidentDate')}</div>
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Reported Date *</label>
                                    <div style="${getFieldStyle('reportedDate')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${getTextColor('reportedDate')}"><i class="fas fa-calendar" style="font-size:0.7rem; margin-right:0.15rem;"></i>${getFieldValue('reportedDate')}</div>
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; margin-bottom:0.25rem;">
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Location *</label>
                                    <div style="${getFieldStyle('location')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${getTextColor('location')}">${getFieldValue('location')}</div>
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Business Unit / Department</label>
                                    <div style="${getFieldStyle('department')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${getTextColor('department')}">${getFieldValue('department')}</div>
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; margin-bottom:0.25rem;">
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Incident Type *</label>
                                    <div style="${getFieldStyle('incidentType')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${getTextColor('incidentType')}">${getFieldValue('incidentType')}</div>
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Severity (Actual)</label>
                                    <div style="${getFieldStyle('severityActual')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${filledFields.includes('severityActual') ? 'color:#dc2626; font-weight:700;' : 'color:#94a3b8;'}">${getFieldValue('severityActual')}</div>
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; margin-bottom:0.25rem;">
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Potential Severity</label>
                                    <div style="${getFieldStyle('severityPotential')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${filledFields.includes('severityPotential') ? 'color:#dc2626; font-weight:700;' : 'color:#94a3b8;'}">${getFieldValue('severityPotential')}</div>
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Likelihood (Pre-incident)</label>
                                    <div style="${getFieldStyle('likelihood')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; ${getTextColor('likelihood')}">${getFieldValue('likelihood')}</div>
                                </div>
                            </div>
                            <div style="margin-bottom:0.25rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Incident Description *</label>
                                <div style="${getFieldStyle('description')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; min-height:1.8em; ${getTextColor('description')}">${getFieldValue('description')}</div>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Immediate Actions Taken</label>
                                <div style="${getFieldStyle('immediateActions')} border-radius:4px; padding:0.2rem 0.25rem; font-size:0.5rem; min-height:1.5em; ${getTextColor('immediateActions')}">${getFieldValue('immediateActions')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equipment Involved Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                            <span style="display:flex; align-items:center; gap:0.25rem;"><i class="fas fa-tools" style="color:#8b5cf6; font-size:0.55rem;"></i> Equipment Involved</span>
                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.75rem; font-weight:600; ${highlightField === 'equipment' ? 'box-shadow:0 0 12px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i> Add</button>
                        </div>
                        ${showEquipment ? `
                        <div style="padding:0.3rem;">
                            <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.25rem; ${highlightField === 'equipmentFields' ? 'box-shadow:0 0 12px rgba(251,191,36,0.5); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}">
                                <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto; gap:0.25rem; align-items:end;">
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Equipment Name:</label>
                                        <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">Forklift FLT-204</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Equipment ID/Serial:</label>
                                        <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">SN-78432</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Type/Category:</label>
                                        <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">Material Handling</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Condition:</label>
                                        <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">Damaged</div>
                                    </div>
                                    <button style="background:#ef4444; color:#fff; border:none; padding:0.15rem; border-radius:4px; font-size:0.7rem;"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div style="padding:0.3rem; color:#94a3b8; font-size:0.5rem; font-style:italic;">No equipment added yet</div>
                        `}
                    </div>
                    
                    <!-- People Section -->
                    <div style="margin-bottom:0.3rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-users" style="color:#22c55e; font-size:0.55rem;"></i> People
                        </div>
                        <div style="padding:0.3rem;">
                            <!-- Persons Involved subsection -->
                            <div style="margin-bottom:0.3rem;">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.15rem;">
                                    <label style="font-size:0.5rem; font-weight:700; color:#374151;">Persons Involved</label>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.75rem; font-weight:600; ${highlightField === 'person' ? 'box-shadow:0 0 12px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-user-plus"></i> Add Person</button>
                                </div>
                                ${showPerson ? `
                                <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.25rem; ${highlightField === 'personFields' ? 'box-shadow:0 0 12px rgba(251,191,36,0.5); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}">
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto; gap:0.25rem; align-items:end;">
                                        <div>
                                            <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Name:</label>
                                            <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">James Wilson</div>
                                        </div>
                                        <div>
                                            <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Company:</label>
                                            <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">ABC Logistics</div>
                                        </div>
                                        <div>
                                            <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Job Title:</label>
                                            <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">Forklift Operator</div>
                                        </div>
                                        <div>
                                            <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Phone Number:</label>
                                            <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">+971 50 123 4567</div>
                                        </div>
                                        <button style="background:#ef4444; color:#fff; border:none; padding:0.15rem; border-radius:4px; font-size:0.7rem;"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                ` : `
                                <div style="color:#94a3b8; font-size:0.5rem; font-style:italic;">No persons added yet</div>
                                `}
                            </div>
                            <!-- Investigation Team subsection -->
                            <div>
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.15rem;">
                                    <label style="font-size:0.5rem; font-weight:700; color:#374151;">Investigation Team</label>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.75rem; font-weight:600; ${highlightField === 'team' ? 'box-shadow:0 0 12px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-user-plus"></i> Add Person</button>
                                </div>
                                ${showTeam ? `
                                <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.25rem; ${highlightField === 'teamFields' ? 'box-shadow:0 0 12px rgba(251,191,36,0.5); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}">
                                    <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:0.25rem; align-items:end;">
                                        <div>
                                            <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Employee:</label>
                                            <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">John Smith (HSE Manager)</div>
                                        </div>
                                        <div>
                                            <label style="display:block; font-weight:700; margin-bottom:0.1rem; font-size:0.75rem; color:#374151;">Role:</label>
                                            <div style="border:2px solid #22c55e; background:#fff; border-radius:4px; padding:0.15rem; font-size:0.48rem; color:#1e293b; font-weight:500;">Lead Investigator</div>
                                        </div>
                                        <button style="background:#ef4444; color:#fff; border:none; padding:0.15rem; border-radius:4px; font-size:0.7rem;"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                ` : `
                                <div style="color:#94a3b8; font-size:0.5rem; font-style:italic;">No team members added yet</div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    ${showValidation ? `
                        <div style="background:#ecfdf5; border:2px solid #a7f3d0; border-radius:5px; padding:0.25rem; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-check-circle" style="color:#22c55e; font-size:0.6rem;"></i>
                            <span style="font-size:0.5rem; color:#166534; font-weight:600;">All required fields completed - Ready to submit</span>
                        </div>
                    ` : ''}
                </div>
            `;
        };
        
        // Measure tab field states
        const measureFieldStates = {
            people: { empty: 'Add element', filled: 'Lack of training' },
            equipmentFactors: { empty: 'Add element', filled: 'Faulty brakes' },
            environment: { empty: 'Add element', filled: 'Poor lighting' },
            procedures: { empty: 'Add element', filled: 'Outdated SOP' },
            organization: { empty: 'Add element', filled: 'Inadequate supervision' },
            latitude: { empty: 'e.g., 25.276987', filled: '25.276987' },
            longitude: { empty: 'e.g., 55.296249', filled: '55.296249' },
            eventTime: { empty: 'Select date/time', filled: '2024-12-10 14:25' },
            eventTitle: { empty: 'Event title', filled: 'Initial contact with rack' },
            eventDesc: { empty: 'Event description', filled: 'Forklift reversed into storage rack B-12' }
        };
        
        // Generate Measure tab content
        const generateMeasureContent = (filledFields = [], highlightField = null, showTimeline = false, showValidation = false) => {
            const getFieldStyle = (fieldName) => {
                const isFilled = filledFields.includes(fieldName);
                const isHighlighted = highlightField === fieldName;
                if (isHighlighted) return 'border:3px solid #fbbf24; background:#fffbeb; box-shadow: 0 0 12px rgba(251,191,36,0.5);';
                if (isFilled) return 'border:2px solid #22c55e; background:#f0fdf4;';
                return 'border:2px solid #e2e8f0; background:#f8fafc;';
            };
            const getFieldValue = (fieldName) => {
                const isHighlighted = highlightField === fieldName;
                const isFilled = filledFields.includes(fieldName);
                const value = isFilled ? measureFieldStates[fieldName].filled : measureFieldStates[fieldName].empty;
                if (isHighlighted && isFilled) {
                    return `<span class="typing-text">${value}</span><span class="typing-cursor"></span>`;
                }
                return value;
            };
            const getTextColor = (fieldName) => {
                return filledFields.includes(fieldName) ? 'color:#1e293b; font-weight:500;' : 'color:#94a3b8;';
            };
            
            // Tag component helper
            const getTagHTML = (fieldName, tagValue) => {
                const isFilled = filledFields.includes(fieldName);
                const isHighlighted = highlightField === fieldName;
                if (isFilled) {
                    return `<span style="display:inline-flex; align-items:center; gap:0.2rem; background:#dbeafe; color:#1d4ed8; padding:0.1rem 0.3rem; border-radius:999px; font-size:0.75rem; font-weight:500; ${isHighlighted ? 'animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><span class="${isHighlighted ? 'typing-text' : ''}">${tagValue}</span>${isHighlighted ? '<span class="typing-cursor"></span>' : ''}<i class="fas fa-times" style="font-size:0.6rem; cursor:pointer;"></i></span>`;
                }
                return '';
            };
            
            return `
                <div id="demoMeasureScroll" style="flex:1; overflow-y:auto; padding:0.4rem; background:#fff; font-size:0.5rem;">
                    <!-- PEEPO Analysis Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-project-diagram" style="color:#8b5cf6; font-size:0.55rem;"></i> PEEPO Analysis
                        </div>
                        <div style="padding:0.35rem;">
                            <!-- People Factors -->
                            <div style="margin-bottom:0.3rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">People Factors</label>
                                <div style="margin-bottom:0.15rem;">${getTagHTML('people', 'Lack of training')}</div>
                                <div style="display:flex; gap:0.2rem; align-items:center;">
                                    <div style="${getFieldStyle('people')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; flex:1; ${getTextColor('people')}">${filledFields.includes('people') ? '' : measureFieldStates.people.empty}</div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'people' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <!-- Equipment Factors -->
                            <div style="margin-bottom:0.3rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                <div style="margin-bottom:0.15rem;">${getTagHTML('equipmentFactors', 'Faulty brakes')}</div>
                                <div style="display:flex; gap:0.2rem; align-items:center;">
                                    <div style="${getFieldStyle('equipmentFactors')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; flex:1; ${getTextColor('equipmentFactors')}">${filledFields.includes('equipmentFactors') ? '' : measureFieldStates.equipmentFactors.empty}</div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'equipmentFactors' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <!-- Environmental Factors -->
                            <div style="margin-bottom:0.3rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Environmental Factors</label>
                                <div style="margin-bottom:0.15rem;">${getTagHTML('environment', 'Poor lighting')}</div>
                                <div style="display:flex; gap:0.2rem; align-items:center;">
                                    <div style="${getFieldStyle('environment')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; flex:1; ${getTextColor('environment')}">${filledFields.includes('environment') ? '' : measureFieldStates.environment.empty}</div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'environment' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <!-- Procedures -->
                            <div style="margin-bottom:0.3rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Procedures</label>
                                <div style="margin-bottom:0.15rem;">${getTagHTML('procedures', 'Outdated SOP')}</div>
                                <div style="display:flex; gap:0.2rem; align-items:center;">
                                    <div style="${getFieldStyle('procedures')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; flex:1; ${getTextColor('procedures')}">${filledFields.includes('procedures') ? '' : measureFieldStates.procedures.empty}</div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'procedures' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <!-- Organization -->
                            <div>
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Organization</label>
                                <div style="margin-bottom:0.15rem;">${getTagHTML('organization', 'Inadequate supervision')}</div>
                                <div style="display:flex; gap:0.2rem; align-items:center;">
                                    <div style="${getFieldStyle('organization')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; flex:1; ${getTextColor('organization')}">${filledFields.includes('organization') ? '' : measureFieldStates.organization.empty}</div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'organization' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Incident Location Map Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-map-marker-alt" style="color:#ef4444; font-size:0.55rem;"></i> Incident Location Map
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:0.3rem; margin-bottom:0.25rem;">
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Latitude</label>
                                    <div style="${getFieldStyle('latitude')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; ${getTextColor('latitude')}">${getFieldValue('latitude')}</div>
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Longitude</label>
                                    <div style="${getFieldStyle('longitude')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.48rem; ${getTextColor('longitude')}">${getFieldValue('longitude')}</div>
                                </div>
                                <div style="display:flex; align-items:flex-end; gap:0.15rem;">
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem;"><i class="fas fa-sync-alt"></i></button>
                                    <button style="background:#f1f5f9; color:#475569; border:1px solid #d1d5db; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem;"><i class="fas fa-crosshairs"></i></button>
                                </div>
                            </div>
                            <div style="height:60px; background:#e2e8f0; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#64748b; font-size:0.75rem;">
                                ${filledFields.includes('latitude') ? '<i class="fas fa-map-marker-alt" style="color:#ef4444; font-size:1rem;"></i>' : 'ðŸ“ Map will appear here'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Photos & Evidence Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                            <span style="display:flex; align-items:center; gap:0.25rem;"><i class="fas fa-images" style="color:#f59e0b; font-size:0.55rem;"></i> Photos & Evidence</span>
                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'evidence' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                        </div>
                        <div style="padding:0.35rem;">
                            ${filledFields.includes('evidence') ? `
                            <div style="display:flex; gap:0.2rem; flex-wrap:wrap;">
                                <div style="width:40px; height:40px; background:#dbeafe; border-radius:4px; display:flex; align-items:center; justify-content:center; border:2px solid #3b82f6;">
                                    <i class="fas fa-image" style="color:#3b82f6; font-size:0.8rem;"></i>
                                </div>
                                <div style="flex:1; font-size:0.75rem;">
                                    <div style="font-weight:600; color:#334155;">incident_photo_01.jpg</div>
                                    <div style="color:#64748b;">Image â€¢ 2.4 MB</div>
                                </div>
                            </div>
                            ` : `
                            <div style="text-align:center; color:#94a3b8; font-size:0.75rem; padding:0.3rem;">
                                <i class="fas fa-folder-open" style="font-size:0.8rem; color:#d1d5db; display:block; margin-bottom:0.15rem;"></i>
                                No files uploaded yet
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Timeline Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                            <span style="display:flex; align-items:center; gap:0.25rem;"><i class="fas fa-clock" style="color:#22c55e; font-size:0.55rem;"></i> Timeline</span>
                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'timeline' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i> Add Event</button>
                        </div>
                        <div style="padding:0.35rem;">
                            ${showTimeline ? `
                            <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.25rem; margin-bottom:0.25rem; ${highlightField === 'timelineFields' ? 'box-shadow:0 0 12px rgba(251,191,36,0.5); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}">
                                <div style="display:grid; grid-template-columns:100px 1fr 1.5fr auto; gap:0.2rem; align-items:center;">
                                    <div style="${getFieldStyle('eventTime')} border-radius:4px; padding:0.12rem; font-size:0.7rem; ${getTextColor('eventTime')}"><i class="fas fa-calendar" style="font-size:0.6rem; margin-right:0.1rem;"></i>${getFieldValue('eventTime')}</div>
                                    <div style="${getFieldStyle('eventTitle')} border-radius:4px; padding:0.12rem; font-size:0.7rem; ${getTextColor('eventTitle')}">${getFieldValue('eventTitle')}</div>
                                    <div style="${getFieldStyle('eventDesc')} border-radius:4px; padding:0.12rem; font-size:0.7rem; ${getTextColor('eventDesc')}">${getFieldValue('eventDesc')}</div>
                                    <div style="display:flex; gap:0.15rem;">
                                        <button style="background:#dcfce7; color:#059669; border:none; padding:0.12rem; border-radius:3px; font-size:0.6rem;"><i class="fas fa-save"></i></button>
                                        <button style="background:#fee2e2; color:#dc2626; border:none; padding:0.12rem; border-radius:3px; font-size:0.6rem;"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div style="background:#f8fafc; border-radius:4px; padding:0.2rem; margin-top:0.2rem;">
                                <div style="font-size:0.7rem; color:#64748b; font-weight:600; margin-bottom:0.15rem;">Timeline Visualization</div>
                                <div style="position:relative; height:20px; background:#e2e8f0; border-radius:10px;">
                                    <div style="position:absolute; top:50%; left:10%; transform:translateY(-50%); width:8px; height:8px; background:#3b82f6; border-radius:50%; border:2px solid #fff;"></div>
                                    <div style="position:absolute; top:-12px; left:10%; font-size:0.6rem; color:#334155; transform:translateX(-50%);">14:25</div>
                                </div>
                            </div>
                            ` : `
                            <div style="text-align:center; color:#94a3b8; font-size:0.75rem; padding:0.3rem;">
                                Add events above to see the chronological timeline
                            </div>
                            `}
                        </div>
                    </div>
                    
                    ${showValidation ? `
                        <div style="background:#ecfdf5; border:2px solid #a7f3d0; border-radius:5px; padding:0.25rem; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-check-circle" style="color:#22c55e; font-size:0.6rem;"></i>
                            <span style="font-size:0.5rem; color:#166534; font-weight:600;">Measure tab completed - Ready to continue</span>
                        </div>
                    ` : ''}
                </div>
            `;
        };
        
        // Analyze tab field states
        const analyzeFieldStates = {
            defense: { empty: '-- Select Defense Type --', filled: 'DF11 - Safe Work Procedures' },
            defenseDesc: { empty: 'Add description...', filled: 'SOP not followed for reversing operations' },
            individual: { empty: '-- Select Action Type --', filled: 'ITA08 - Routine Violation' },
            individualDesc: { empty: 'Add description...', filled: 'Operator skipped pre-operation checks' },
            taskEnv: { empty: '-- Select Condition --', filled: 'TEC11 - Poor Lighting' },
            orgFactor: { empty: '-- Select Factor --', filled: 'OF24 - Inadequate Supervision' },
            dataCollected: { empty: 'Document all data collected...', filled: 'CCTV footage reviewed, witness statements taken...' },
            keyFindings: { empty: 'Summarize key findings...', filled: 'Root cause: Inadequate pre-operation checks combined with poor visibility' }
        };
        
        // Generate Analyze tab content
        const generateAnalyzeContent = (filledFields = [], highlightField = null, showDefense = false, showIndividual = false, showValidation = false) => {
            const getFieldStyle = (fieldName) => {
                const isFilled = filledFields.includes(fieldName);
                const isHighlighted = highlightField === fieldName;
                if (isHighlighted) return 'border:3px solid #fbbf24; background:#fffbeb; box-shadow: 0 0 12px rgba(251,191,36,0.5);';
                if (isFilled) return 'border:2px solid #22c55e; background:#f0fdf4;';
                return 'border:2px solid #e2e8f0; background:#f8fafc;';
            };
            const getFieldValue = (fieldName) => {
                const isHighlighted = highlightField === fieldName;
                const isFilled = filledFields.includes(fieldName);
                const value = isFilled ? analyzeFieldStates[fieldName].filled : analyzeFieldStates[fieldName].empty;
                if (isHighlighted && isFilled) {
                    return `<span class="typing-text">${value}</span><span class="typing-cursor"></span>`;
                }
                return value;
            };
            const getTextColor = (fieldName) => {
                return filledFields.includes(fieldName) ? 'color:#1e293b; font-weight:500;' : 'color:#94a3b8;';
            };
            
            return `
                <div id="demoAnalyzeScroll" style="flex:1; overflow-y:auto; padding:0.4rem; background:#fff; font-size:0.5rem;">
                    <!-- Contributing Factors Summary Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-exclamation-triangle" style="color:#dc2626; font-size:0.55rem;"></i> Contributing Factors Summary
                        </div>
                        <div style="padding:0.35rem;">
                            <p style="font-size:0.7rem; color:#64748b; margin-bottom:0.2rem;">Factors marked as Contributing from PEEPO analysis appear here</p>
                            <div style="min-height:25px; padding:0.2rem; background:#fef2f2; border:1px dashed #fca5a5; border-radius:4px; ${highlightField === 'contributing' ? 'box-shadow:0 0 8px rgba(251,191,36,0.5);' : ''}">
                                ${filledFields.includes('contributing') ? `
                                <span style="display:inline-block; background:#fee2e2; color:#dc2626; padding:0.1rem 0.25rem; border-radius:999px; font-size:0.7rem; font-weight:500; margin:0.05rem;">Lack of training</span>
                                <span style="display:inline-block; background:#fee2e2; color:#dc2626; padding:0.1rem 0.25rem; border-radius:999px; font-size:0.7rem; font-weight:500; margin:0.05rem;">Faulty brakes</span>
                                ` : `<span style="color:#94a3b8; font-size:0.7rem;">No contributing factors identified yet</span>`}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Absent/Failed Defenses Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-shield-alt" style="color:#f59e0b; font-size:0.55rem;"></i> Absent/Failed Defenses (ICAM)
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:flex; gap:0.2rem; align-items:center; margin-bottom:0.2rem;">
                                <div style="${getFieldStyle('defense')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.7rem; flex:1; ${getTextColor('defense')}">${getFieldValue('defense')}</div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'defense' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                            </div>
                            ${showDefense ? `
                            <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.2rem; ${highlightField === 'defenseFields' ? 'box-shadow:0 0 8px rgba(251,191,36,0.5);' : ''}">
                                <div style="font-size:0.7rem; font-weight:600; color:#166534; margin-bottom:0.1rem;">DF11 - Safe Work Procedures</div>
                                <div style="${getFieldStyle('defenseDesc')} border-radius:4px; padding:0.1rem; font-size:0.7rem; ${getTextColor('defenseDesc')}">${getFieldValue('defenseDesc')}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Individual/Team Actions Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-user-cog" style="color:#8b5cf6; font-size:0.55rem;"></i> Individual or Team Actions
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:flex; gap:0.2rem; align-items:center; margin-bottom:0.2rem;">
                                <div style="${getFieldStyle('individual')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.7rem; flex:1; ${getTextColor('individual')}">${getFieldValue('individual')}</div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'individual' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                            </div>
                            ${showIndividual ? `
                            <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.2rem; ${highlightField === 'individualFields' ? 'box-shadow:0 0 8px rgba(251,191,36,0.5);' : ''}">
                                <div style="font-size:0.7rem; font-weight:600; color:#166534; margin-bottom:0.1rem;">ITA08 - Routine Violation</div>
                                <div style="${getFieldStyle('individualDesc')} border-radius:4px; padding:0.1rem; font-size:0.7rem; ${getTextColor('individualDesc')}">${getFieldValue('individualDesc')}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Task/Environmental Conditions Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-tasks" style="color:#0ea5e9; font-size:0.55rem;"></i> Task / Environmental Conditions
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:flex; gap:0.2rem; align-items:center;">
                                <div style="${getFieldStyle('taskEnv')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.7rem; flex:1; ${getTextColor('taskEnv')}">${getFieldValue('taskEnv')}</div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'taskEnv' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                            </div>
                            ${filledFields.includes('taskEnv') ? `
                            <div style="margin-top:0.15rem; background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.15rem;">
                                <div style="font-size:0.7rem; font-weight:600; color:#166534;">TEC11 - Poor Lighting</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Organisational Factors Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-building" style="color:#ec4899; font-size:0.55rem;"></i> Organisational Factors
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="display:flex; gap:0.2rem; align-items:center;">
                                <div style="${getFieldStyle('orgFactor')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.7rem; flex:1; ${getTextColor('orgFactor')}">${getFieldValue('orgFactor')}</div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'orgFactor' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                            </div>
                            ${filledFields.includes('orgFactor') ? `
                            <div style="margin-top:0.15rem; background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.15rem;">
                                <div style="font-size:0.7rem; font-weight:600; color:#166534;">OF24 - Inadequate Supervision</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Data Analysis Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-chart-bar" style="color:#22c55e; font-size:0.55rem;"></i> Data Analysis
                        </div>
                        <div style="padding:0.35rem;">
                            <div style="margin-bottom:0.2rem;">
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Data Collected</label>
                                <div style="${getFieldStyle('dataCollected')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.7rem; min-height:1.5em; ${getTextColor('dataCollected')}">${getFieldValue('dataCollected')}</div>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Key Findings</label>
                                <div style="${getFieldStyle('keyFindings')} border-radius:4px; padding:0.15rem 0.2rem; font-size:0.7rem; min-height:1.5em; ${getTextColor('keyFindings')}">${getFieldValue('keyFindings')}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${showValidation ? `
                        <div style="background:#ecfdf5; border:2px solid #a7f3d0; border-radius:5px; padding:0.25rem; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-check-circle" style="color:#22c55e; font-size:0.6rem;"></i>
                            <span style="font-size:0.5rem; color:#166534; font-weight:600;">Analyze tab completed - Analysis complete!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        };
        
        // Improve tab field states
        const improveFieldStates = {
            owner: { empty: 'Select owner...', filled: 'John Smith' },
            dueDate: { empty: 'Select date', filled: '2024-12-31' },
            actionType: { empty: 'Select type', filled: 'Preventive' },
            status: { empty: 'Select status', filled: 'Open' },
            actionDesc: { empty: 'Enter description...', filled: 'Update reversing procedure and implement mandatory spotter requirement' }
        };
        
        // Generate Improve tab content
        const generateImproveContent = (filledFields = [], highlightField = null, showAction = false, showValidation = false) => {
            const getFieldStyle = (fieldName) => {
                const isFilled = filledFields.includes(fieldName);
                const isHighlighted = highlightField === fieldName;
                if (isHighlighted) return 'border:3px solid #fbbf24; background:#fffbeb; box-shadow: 0 0 12px rgba(251,191,36,0.5);';
                if (isFilled) return 'border:2px solid #22c55e; background:#f0fdf4;';
                return 'border:2px solid #e2e8f0; background:#f8fafc;';
            };
            const getFieldValue = (fieldName) => {
                const isHighlighted = highlightField === fieldName;
                const isFilled = filledFields.includes(fieldName);
                const value = isFilled ? improveFieldStates[fieldName].filled : improveFieldStates[fieldName].empty;
                if (isHighlighted && isFilled) {
                    return `<span class="typing-text">${value}</span><span class="typing-cursor"></span>`;
                }
                return value;
            };
            const getTextColor = (fieldName) => {
                return filledFields.includes(fieldName) ? 'color:#1e293b; font-weight:500;' : 'color:#94a3b8;';
            };
            
            return `
                <div id="demoImproveScroll" style="flex:1; overflow-y:auto; padding:0.4rem; background:#fff; font-size:0.5rem;">
                    <!-- Corrective Actions Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                            <span style="display:flex; align-items:center; gap:0.25rem;"><i class="fas fa-tasks" style="color:#3b82f6; font-size:0.55rem;"></i> Corrective Actions</span>
                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'addAction' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                        </div>
                        <div style="padding:0.35rem;">
                            ${showAction ? `
                            <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.25rem; ${highlightField === 'actionFields' ? 'box-shadow:0 0 12px rgba(251,191,36,0.5); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}">
                                <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Action Owner</label>
                                        <div style="${getFieldStyle('owner')} border-radius:4px; padding:0.1rem; font-size:0.7rem; ${getTextColor('owner')}">${getFieldValue('owner')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Due Date</label>
                                        <div style="${getFieldStyle('dueDate')} border-radius:4px; padding:0.1rem; font-size:0.7rem; ${getTextColor('dueDate')}">${getFieldValue('dueDate')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Action Type</label>
                                        <div style="${getFieldStyle('actionType')} border-radius:4px; padding:0.1rem; font-size:0.7rem; ${getTextColor('actionType')}">${getFieldValue('actionType')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Status</label>
                                        <div style="${getFieldStyle('status')} border-radius:4px; padding:0.1rem; font-size:0.7rem; ${filledFields.includes('status') ? 'color:#f59e0b; font-weight:600;' : 'color:#94a3b8;'}">${getFieldValue('status')}</div>
                                    </div>
                                </div>
                                <div>
                                    <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Description</label>
                                    <div style="${getFieldStyle('actionDesc')} border-radius:4px; padding:0.1rem; font-size:0.7rem; min-height:1.2em; ${getTextColor('actionDesc')}">${getFieldValue('actionDesc')}</div>
                                </div>
                            </div>
                            ` : `
                            <div style="text-align:center; color:#94a3b8; font-size:0.75rem; padding:0.5rem;">
                                <i class="fas fa-tasks" style="font-size:1rem; color:#d1d5db; display:block; margin-bottom:0.2rem;"></i>
                                No corrective actions added yet. Click "+" to add a corrective action.
                            </div>
                            `}
                        </div>
                    </div>
                    
                    ${showValidation ? `
                        <div style="background:#ecfdf5; border:2px solid #a7f3d0; border-radius:5px; padding:0.25rem; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-check-circle" style="color:#22c55e; font-size:0.6rem;"></i>
                            <span style="font-size:0.5rem; color:#166534; font-weight:600;">Improve tab completed - Actions defined!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        };
        
        // Control tab field states
        const controlFieldStates = {
            verifyAction: { empty: 'Select action...', filled: 'Update reversing procedure' },
            verifiedBy: { empty: 'Select verifier...', filled: 'Sarah Johnson' },
            verifyDate: { empty: 'Select date', filled: '2025-01-15' },
            verifyStatus: { empty: 'Select status', filled: 'Verified' },
            effectiveness: { empty: 'Select rating', filled: 'Effective' },
            lessonsLearned: { empty: 'Document key lessons learned...', filled: 'Always ensure pre-operation checks are completed. Implement buddy system for reversing maneuvers in warehouse areas.' }
        };
        
        // Generate Control tab content
        const generateControlContent = (filledFields = [], highlightField = null, showVerification = false, showValidation = false) => {
            const getFieldStyle = (fieldName) => {
                const isFilled = filledFields.includes(fieldName);
                const isHighlighted = highlightField === fieldName;
                if (isHighlighted) return 'border:3px solid #fbbf24; background:#fffbeb; box-shadow: 0 0 12px rgba(251,191,36,0.5);';
                if (isFilled) return 'border:2px solid #22c55e; background:#f0fdf4;';
                return 'border:2px solid #e2e8f0; background:#f8fafc;';
            };
            const getFieldValue = (fieldName) => {
                const isHighlighted = highlightField === fieldName;
                const isFilled = filledFields.includes(fieldName);
                const value = isFilled ? controlFieldStates[fieldName].filled : controlFieldStates[fieldName].empty;
                if (isHighlighted && isFilled) {
                    return `<span class="typing-text">${value}</span><span class="typing-cursor"></span>`;
                }
                return value;
            };
            const getTextColor = (fieldName) => {
                return filledFields.includes(fieldName) ? 'color:#1e293b; font-weight:500;' : 'color:#94a3b8;';
            };
            
            return `
                <div id="demoControlScroll" style="flex:1; overflow-y:auto; padding:0.4rem; background:#fff; font-size:0.5rem;">
                    <!-- Improvement Verification Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                            <span style="display:flex; align-items:center; gap:0.25rem;"><i class="fas fa-clipboard-check" style="color:#22c55e; font-size:0.55rem;"></i> Improvement Verification</span>
                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.15rem 0.25rem; border-radius:4px; font-size:0.7rem; ${highlightField === 'addVerify' ? 'box-shadow:0 0 8px rgba(251,191,36,0.6); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}"><i class="fas fa-plus"></i></button>
                        </div>
                        <div style="padding:0.35rem;">
                            <p style="font-size:0.7rem; color:#64748b; margin-bottom:0.2rem;">Track and verify the implementation of corrective actions</p>
                            ${showVerification ? `
                            <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:5px; padding:0.25rem; ${highlightField === 'verifyFields' ? 'box-shadow:0 0 12px rgba(251,191,36,0.5); animation:highlightPulse 1.2s ease-in-out infinite;' : ''}">
                                <div style="display:grid; grid-template-columns:1.5fr 1fr 1fr 1fr 1fr; gap:0.2rem; align-items:end;">
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Action/Improvement</label>
                                        <div style="${getFieldStyle('verifyAction')} border-radius:4px; padding:0.1rem; font-size:0.65rem; ${getTextColor('verifyAction')}">${getFieldValue('verifyAction')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Verified By</label>
                                        <div style="${getFieldStyle('verifiedBy')} border-radius:4px; padding:0.1rem; font-size:0.65rem; ${getTextColor('verifiedBy')}">${getFieldValue('verifiedBy')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Date</label>
                                        <div style="${getFieldStyle('verifyDate')} border-radius:4px; padding:0.1rem; font-size:0.65rem; ${getTextColor('verifyDate')}">${getFieldValue('verifyDate')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Status</label>
                                        <div style="${getFieldStyle('verifyStatus')} border-radius:4px; padding:0.1rem; font-size:0.65rem; ${filledFields.includes('verifyStatus') ? 'color:#22c55e; font-weight:600;' : 'color:#94a3b8;'}">${getFieldValue('verifyStatus')}</div>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:700; margin-bottom:0.05rem; font-size:0.7rem; color:#374151;">Effectiveness</label>
                                        <div style="${getFieldStyle('effectiveness')} border-radius:4px; padding:0.1rem; font-size:0.65rem; ${filledFields.includes('effectiveness') ? 'color:#22c55e; font-weight:600;' : 'color:#94a3b8;'}">${getFieldValue('effectiveness')}</div>
                                    </div>
                                </div>
                            </div>
                            ` : `
                            <div style="text-align:center; color:#94a3b8; font-size:0.75rem; padding:0.4rem;">
                                <i class="fas fa-clipboard-check" style="font-size:0.9rem; color:#d1d5db; display:block; margin-bottom:0.15rem;"></i>
                                No verification items added yet
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Lessons Learned Section -->
                    <div style="margin-bottom:0.4rem; border:2px solid #e2e8f0; border-radius:6px;">
                        <div style="padding:0.3rem 0.4rem; background:#f8fafc; border-bottom:2px solid #e2e8f0; font-size:0.6rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-book" style="color:#f59e0b; font-size:0.55rem;"></i> Lessons Learned
                        </div>
                        <div style="padding:0.35rem;">
                            <label style="font-size:0.75rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Key Lessons Learned</label>
                            <div style="${getFieldStyle('lessonsLearned')} border-radius:4px; padding:0.2rem; font-size:0.75rem; min-height:2.5em; ${getTextColor('lessonsLearned')}">${getFieldValue('lessonsLearned')}</div>
                        </div>
                    </div>
                    
                    ${showValidation ? `
                        <div style="background:#ecfdf5; border:2px solid #a7f3d0; border-radius:5px; padding:0.25rem; display:flex; align-items:center; gap:0.25rem;">
                            <i class="fas fa-check-circle" style="color:#22c55e; font-size:0.6rem;"></i>
                            <span style="font-size:0.5rem; color:#166534; font-weight:600;">Control tab completed - Investigation complete!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        };
        
        // Full page wrapper - now accepts activeTab parameter
        const wrapInPage = (content, highlightSubmit = false, activeTab = 'define') => `
            <div style="display:flex; height:100%; background:#f5f7fa;">
                ${sidebarHTML}
                <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                    ${topNavHTML}
                    ${headerHTML}
                    ${getTabsHTML(activeTab)}
                    ${content}
                    ${footerHTML(highlightSubmit)}
                </div>
            </div>
        `;
        
        return `
            <!-- Scene 1: Welcome -->
            <div class="demo-scene" id="scene-welcome" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:linear-gradient(135deg, #2c3e50 0%, #3b5998 100%);">
                <i class="fas fa-search-plus" style="font-size:3.5rem; color:#fff; margin-bottom:0.75rem;"></i>
                <h2 style="color:#fff; font-size:1.5rem; margin-bottom:0.4rem;">Investigation Module</h2>
                <p style="color:rgba(255,255,255,0.8); font-size:0.9rem;">Complete Step-by-Step Guide</p>
            </div>
            
            <!-- Scene 2: Investigation List - Click + Button -->
            <div class="demo-scene" id="scene-click-plus" style="display:none; height:100%; background:#f5f7fa;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column;">
                        ${topNavHTML}
                        <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.4rem 0.6rem; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:0.7rem; font-weight:600;"><i class="fas fa-list"></i> Investigation List</span>
                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.3rem 0.6rem; border-radius:4px; font-size:0.6rem; font-weight:600; box-shadow:0 0 0 3px rgba(251,191,36,0.6); animation:pulse 1s infinite;"><i class="fas fa-plus"></i> New Investigation</button>
                        </div>
                        <div style="flex:1; padding:0.4rem; background:#fff;">
                            <table style="width:100%; font-size:0.55rem; border-collapse:collapse;">
                                <thead><tr style="background:#f8fafc;"><th style="padding:0.3rem; text-align:left; border-bottom:1px solid #e2e8f0;">ID</th><th style="padding:0.3rem; text-align:left; border-bottom:1px solid #e2e8f0;">Title</th><th style="padding:0.3rem; text-align:left; border-bottom:1px solid #e2e8f0;">Status</th></tr></thead>
                                <tbody>
                                    <tr><td style="padding:0.3rem; border-bottom:1px solid #f1f5f9;">INV-001</td><td style="padding:0.3rem; border-bottom:1px solid #f1f5f9;">Equipment Failure</td><td style="padding:0.3rem;"><span style="background:#dcfce7; color:#166534; padding:1px 4px; border-radius:3px; font-size:0.5rem;">Closed</span></td></tr>
                                    <tr><td style="padding:0.3rem; border-bottom:1px solid #f1f5f9;">INV-002</td><td style="padding:0.3rem; border-bottom:1px solid #f1f5f9;">Near Miss Report</td><td style="padding:0.3rem;"><span style="background:#fef3c7; color:#92400e; padding:1px 4px; border-radius:3px; font-size:0.5rem;">In Progress</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene 3: Empty Form -->
            <div class="demo-scene" id="scene-form-empty" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent([], null, false, false, false, false))}
            </div>
            
            <!-- Scene 4: Fill Title -->
            <div class="demo-scene" id="scene-fill-title" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title'], 'title', false, false, false, false))}
            </div>
            
            <!-- Scene 5: Fill Purpose -->
            <div class="demo-scene" id="scene-fill-purpose" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose'], 'purpose', false, false, false, false))}
            </div>
            
            <!-- Scene 6: Fill Scope -->
            <div class="demo-scene" id="scene-fill-scope" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope'], 'scope', false, false, false, false))}
            </div>
            
            <!-- Scene 7: Fill Methodology -->
            <div class="demo-scene" id="scene-fill-methodology" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology'], 'methodology', false, false, false, false))}
            </div>
            
            <!-- Scene 8: Fill Dates -->
            <div class="demo-scene" id="scene-fill-dates" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate'], 'incidentDate', false, false, false, false))}
            </div>
            
            <!-- Scene 9: Fill Location -->
            <div class="demo-scene" id="scene-fill-location" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department'], 'location', false, false, false, false))}
            </div>
            
            <!-- Scene 10: Fill Type -->
            <div class="demo-scene" id="scene-fill-type" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual'], 'incidentType', false, false, false, false))}
            </div>
            
            <!-- Scene 11: Fill Severity/Likelihood -->
            <div class="demo-scene" id="scene-fill-severity" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood'], 'severityPotential', false, false, false, false))}
            </div>
            
            <!-- Scene 12: Fill Description -->
            <div class="demo-scene" id="scene-fill-description" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description'], 'description', false, false, false, false))}
            </div>
            
            <!-- Scene 13: Fill Immediate Actions -->
            <div class="demo-scene" id="scene-fill-actions" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'immediateActions', false, false, false, false))}
            </div>
            
            <!-- Scene 14: Click Add Equipment Button -->
            <div class="demo-scene" id="scene-add-equipment" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'equipment', false, false, false, false))}
            </div>
            
            <!-- Scene 15: Show Equipment Fields -->
            <div class="demo-scene" id="scene-show-equipment" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'equipmentFields', true, false, false, false))}
            </div>
            
            <!-- Scene 16: Click Add Person Button -->
            <div class="demo-scene" id="scene-add-person" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'person', true, false, false, false))}
            </div>
            
            <!-- Scene 17: Show Person Fields -->
            <div class="demo-scene" id="scene-show-person" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'personFields', true, true, false, false))}
            </div>
            
            <!-- Scene 18: Click Add Team Button -->
            <div class="demo-scene" id="scene-add-team" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'team', true, true, false, false))}
            </div>
            
            <!-- Scene 19: Show Team Fields -->
            <div class="demo-scene" id="scene-show-team" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], 'teamFields', true, true, true, false))}
            </div>
            
            <!-- Scene 20: Switch to Measure Tab (highlight tab) -->
            <div class="demo-scene" id="scene-switch-measure" style="display:none; height:100%;">
                ${wrapInPage(generateFormContent(['title', 'purpose', 'scope', 'methodology', 'incidentDate', 'reportedDate', 'location', 'department', 'incidentType', 'severityActual', 'severityPotential', 'likelihood', 'description', 'immediateActions'], null, true, true, true, true), false, 'switch')}
            </div>
            
            <!-- Scene 21: Measure Tab Empty -->
            <div class="demo-scene" id="scene-measure-empty" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent([], null, false, false), false, 'measure')}
            </div>
            
            <!-- Scene 22: Fill People Factors -->
            <div class="demo-scene" id="scene-fill-people" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people'], 'people', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 23: Fill Equipment Factors -->
            <div class="demo-scene" id="scene-fill-equipment-factors" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors'], 'equipmentFactors', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 24: Fill Environmental Factors -->
            <div class="demo-scene" id="scene-fill-environment" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment'], 'environment', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 25: Fill Procedures -->
            <div class="demo-scene" id="scene-fill-procedures" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures'], 'procedures', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 26: Fill Organization -->
            <div class="demo-scene" id="scene-fill-organization" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization'], 'organization', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 27: Fill Coordinates -->
            <div class="demo-scene" id="scene-fill-coordinates" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization', 'latitude', 'longitude'], 'latitude', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 28: Show Evidence Upload -->
            <div class="demo-scene" id="scene-show-evidence" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization', 'latitude', 'longitude', 'evidence'], 'evidence', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 29: Add Timeline Event -->
            <div class="demo-scene" id="scene-add-timeline" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization', 'latitude', 'longitude', 'evidence'], 'timeline', false, false), false, 'measure')}
            </div>
            
            <!-- Scene 30: Show Timeline Fields -->
            <div class="demo-scene" id="scene-show-timeline" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization', 'latitude', 'longitude', 'evidence', 'eventTime', 'eventTitle', 'eventDesc'], 'timelineFields', true, false), false, 'measure')}
            </div>
            
            <!-- Scene 31: Measure Tab Review -->
            <div class="demo-scene" id="scene-measure-review" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization', 'latitude', 'longitude', 'evidence', 'eventTime', 'eventTitle', 'eventDesc'], null, true, true), false, 'measure')}
            </div>
            
            <!-- ========== ANALYZE TAB SCENES ========== -->
            
            <!-- Scene 32: Switch to Analyze Tab -->
            <div class="demo-scene" id="scene-switch-analyze" style="display:none; height:100%;">
                ${wrapInPage(generateMeasureContent(['people', 'equipmentFactors', 'environment', 'procedures', 'organization', 'latitude', 'longitude', 'evidence', 'eventTime', 'eventTitle', 'eventDesc'], null, true, true), false, 'switch-analyze')}
            </div>
            
            <!-- Scene 33: Analyze Tab Empty -->
            <div class="demo-scene" id="scene-analyze-empty" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent([], null, false, false, false), false, 'analyze')}
            </div>
            
            <!-- Scene 34: Show Contributing Factors -->
            <div class="demo-scene" id="scene-show-contributing" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing'], 'contributing', false, false, false), false, 'analyze')}
            </div>
            
            <!-- Scene 35: Add Defense -->
            <div class="demo-scene" id="scene-add-defense" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing'], 'defense', false, false, false), false, 'analyze')}
            </div>
            
            <!-- Scene 36: Show Defense Fields -->
            <div class="demo-scene" id="scene-show-defense" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc'], 'defenseFields', true, false, false), false, 'analyze')}
            </div>
            
            <!-- Scene 37: Add Individual Action -->
            <div class="demo-scene" id="scene-add-individual" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc'], 'individual', true, false, false), false, 'analyze')}
            </div>
            
            <!-- Scene 38: Show Individual Fields -->
            <div class="demo-scene" id="scene-show-individual" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc', 'individual', 'individualDesc'], 'individualFields', true, true, false), false, 'analyze')}
            </div>
            
            <!-- Scene 39: Add Task/Environmental -->
            <div class="demo-scene" id="scene-add-task-env" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc', 'individual', 'individualDesc', 'taskEnv'], 'taskEnv', true, true, false), false, 'analyze')}
            </div>
            
            <!-- Scene 40: Add Org Factor -->
            <div class="demo-scene" id="scene-add-org-factor" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc', 'individual', 'individualDesc', 'taskEnv', 'orgFactor'], 'orgFactor', true, true, false), false, 'analyze')}
            </div>
            
            <!-- Scene 41: Fill Data Analysis -->
            <div class="demo-scene" id="scene-fill-data-analysis" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc', 'individual', 'individualDesc', 'taskEnv', 'orgFactor', 'dataCollected', 'keyFindings'], 'dataCollected', true, true, false), false, 'analyze')}
            </div>
            
            <!-- Scene 42: Analyze Tab Review -->
            <div class="demo-scene" id="scene-analyze-review" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc', 'individual', 'individualDesc', 'taskEnv', 'orgFactor', 'dataCollected', 'keyFindings'], null, true, true, true), false, 'analyze')}
            </div>
            
            <!-- ========== IMPROVE TAB SCENES ========== -->
            
            <!-- Scene 43: Switch to Improve Tab -->
            <div class="demo-scene" id="scene-switch-improve" style="display:none; height:100%;">
                ${wrapInPage(generateAnalyzeContent(['contributing', 'defense', 'defenseDesc', 'individual', 'individualDesc', 'taskEnv', 'orgFactor', 'dataCollected', 'keyFindings'], null, true, true, true), false, 'switch-improve')}
            </div>
            
            <!-- Scene 44: Improve Tab Empty -->
            <div class="demo-scene" id="scene-improve-empty" style="display:none; height:100%;">
                ${wrapInPage(generateImproveContent([], null, false, false), false, 'improve')}
            </div>
            
            <!-- Scene 45: Add Corrective Action -->
            <div class="demo-scene" id="scene-add-corrective" style="display:none; height:100%;">
                ${wrapInPage(generateImproveContent([], 'addAction', false, false), false, 'improve')}
            </div>
            
            <!-- Scene 46: Show Corrective Action Fields -->
            <div class="demo-scene" id="scene-show-corrective" style="display:none; height:100%;">
                ${wrapInPage(generateImproveContent(['owner', 'dueDate', 'actionType', 'status', 'actionDesc'], 'actionFields', true, false), false, 'improve')}
            </div>
            
            <!-- Scene 47: Improve Tab Review -->
            <div class="demo-scene" id="scene-improve-review" style="display:none; height:100%;">
                ${wrapInPage(generateImproveContent(['owner', 'dueDate', 'actionType', 'status', 'actionDesc'], null, true, true), false, 'improve')}
            </div>
            
            <!-- ========== CONTROL TAB SCENES ========== -->
            
            <!-- Scene 48: Switch to Control Tab -->
            <div class="demo-scene" id="scene-switch-control" style="display:none; height:100%;">
                ${wrapInPage(generateImproveContent(['owner', 'dueDate', 'actionType', 'status', 'actionDesc'], null, true, true), false, 'switch-control')}
            </div>
            
            <!-- Scene 49: Control Tab Empty -->
            <div class="demo-scene" id="scene-control-empty" style="display:none; height:100%;">
                ${wrapInPage(generateControlContent([], null, false, false), false, 'control')}
            </div>
            
            <!-- Scene 50: Add Verification -->
            <div class="demo-scene" id="scene-add-verification" style="display:none; height:100%;">
                ${wrapInPage(generateControlContent([], 'addVerify', false, false), false, 'control')}
            </div>
            
            <!-- Scene 51: Show Verification Fields -->
            <div class="demo-scene" id="scene-show-verification" style="display:none; height:100%;">
                ${wrapInPage(generateControlContent(['verifyAction', 'verifiedBy', 'verifyDate', 'verifyStatus', 'effectiveness'], 'verifyFields', true, false), false, 'control')}
            </div>
            
            <!-- Scene 52: Fill Lessons Learned -->
            <div class="demo-scene" id="scene-fill-lessons" style="display:none; height:100%;">
                ${wrapInPage(generateControlContent(['verifyAction', 'verifiedBy', 'verifyDate', 'verifyStatus', 'effectiveness', 'lessonsLearned'], 'lessonsLearned', true, false), false, 'control')}
            </div>
            
            <!-- Scene 53: Control Tab Review -->
            <div class="demo-scene" id="scene-control-review" style="display:none; height:100%;">
                ${wrapInPage(generateControlContent(['verifyAction', 'verifiedBy', 'verifyDate', 'verifyStatus', 'effectiveness', 'lessonsLearned'], null, true, true), false, 'control')}
            </div>
            
            <!-- ========== FINAL SCENES ========== -->
            
            <!-- Scene 54: Submit -->
            <div class="demo-scene" id="scene-submit" style="display:none; height:100%;">
                ${wrapInPage(generateControlContent(['verifyAction', 'verifiedBy', 'verifyDate', 'verifyStatus', 'effectiveness', 'lessonsLearned'], null, true, true), true, 'control')}
            </div>
            
            <!-- Scene 55: Success Message -->
            <div class="demo-scene" id="scene-success" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                <div style="background:#fff; border-radius:50%; width:70px; height:70px; display:flex; align-items:center; justify-content:center; margin-bottom:0.75rem; animation:bounceIn 0.5s;">
                    <i class="fas fa-check" style="font-size:2rem; color:#22c55e;"></i>
                </div>
                <h2 style="color:#fff; font-size:1.3rem; margin-bottom:0.3rem;">Success!</h2>
                <p style="color:rgba(255,255,255,0.9); font-size:0.85rem; margin-bottom:0.2rem;">Investigation Created</p>
                <p style="color:rgba(255,255,255,0.7); font-size:0.7rem;">Reference: INV-2024-0025</p>
            </div>
            
            <!-- ========== POST-SUBMISSION SCENES ========== -->
            
            <!-- Scene 56: Back to List -->
            <div class="demo-scene" id="scene-back-to-list" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                <div style="background:#fff; border-radius:50%; width:70px; height:70px; display:flex; align-items:center; justify-content:center; margin-bottom:0.75rem; animation:pulse 1s infinite;">
                    <i class="fas fa-arrow-left" style="font-size:2rem; color:#3b82f6;"></i>
                </div>
                <h2 style="color:#fff; font-size:1.3rem; margin-bottom:0.3rem;">Returning to List</h2>
                <p style="color:rgba(255,255,255,0.9); font-size:0.85rem;">View your investigations...</p>
            </div>
            
            <!-- Scene 57: Investigation List with New Entry - Matches actual investigation-list.html -->
            <div class="demo-scene" id="scene-list-new-entry" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    <!-- Sidebar -->
                    <div style="width:90px; background:#2c3e50; color:#fff; padding:0.2rem; flex-shrink:0; font-size:0.7rem;">
                        <div style="text-align:center; padding:0.2rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:600; font-size:0.75rem;">Dreamex Datalab</div>
                        <div style="margin-top:0.25rem;">
                            <div style="padding:0.15rem 0.25rem; margin-bottom:0.1rem; border-radius:2px; display:flex; align-items:center; gap:0.15rem; opacity:0.7;"><i class="fas fa-home" style="font-size:0.7rem;"></i> Home</div>
                            <div style="padding:0.15rem 0.25rem; margin-bottom:0.1rem; border-radius:2px; display:flex; align-items:center; gap:0.15rem; opacity:0.7;"><i class="fas fa-shield-alt" style="font-size:0.7rem;"></i> Safety</div>
                            <div style="padding:0.15rem 0.25rem; margin-bottom:0.1rem; border-radius:2px; background:rgba(255,255,255,0.15); display:flex; align-items:center; gap:0.15rem;"><i class="fas fa-search-plus" style="font-size:0.7rem;"></i> Investigation</div>
                        </div>
                    </div>
                    <!-- Main Content -->
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        <!-- Top Nav -->
                        <div style="background:#fff; padding:0.15rem 0.3rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e2e8f0; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display:flex; align-items:center; gap:0.3rem;">
                                <div style="width:18px; height:18px; background:#3b82f6; border-radius:3px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem; font-weight:600;">DX</div>
                                <span style="font-size:0.75rem; font-weight:600; color:#334155;">Company Name</span>
                            </div>
                            <div style="width:18px; height:18px; background:#64748b; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem;">JD</div>
                        </div>
                        <!-- Page Header -->
                        <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.2rem 0.35rem; display:flex; align-items:center; justify-content:space-between; margin:0.2rem; border-radius:4px;">
                            <div style="display:flex; align-items:center; gap:0.25rem;">
                                <i class="fas fa-search-plus" style="font-size:0.5rem;"></i>
                                <span style="font-size:0.5rem; font-weight:600;">Investigation List</span>
                            </div>
                            <button style="background:none; border:none; color:#fff; font-size:0.6rem; cursor:pointer;"><i class="fas fa-plus-circle"></i></button>
                        </div>
                        <!-- Tabs -->
                        <div style="padding:0.15rem 0.35rem; display:flex; gap:0.2rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:600; background:#3b82f6; color:#fff; border-radius:3px;"><i class="fas fa-list" style="margin-right:0.15rem;"></i>Investigations</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:500; background:#f1f5f9; color:#64748b; border-radius:3px;"><i class="fas fa-cog" style="margin-right:0.15rem;"></i>Settings</span>
                        </div>
                        <!-- Filters -->
                        <div style="padding:0.2rem 0.35rem; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                            <div style="display:flex; gap:0.2rem; align-items:flex-end; flex-wrap:wrap;">
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Status</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Status</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Priority</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Priorities</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Investigator</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All</div>
                                </div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.12rem 0.25rem; border-radius:2px; font-size:0.6rem;"><i class="fas fa-filter"></i> Apply</button>
                            </div>
                        </div>
                        <!-- Table -->
                        <div style="flex:1; padding:0.2rem 0.35rem; overflow:auto;">
                            <div style="background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.08); overflow:hidden;">
                                <table style="width:100%; border-collapse:collapse; font-size:0.7rem;">
                                    <thead style="background:#f8fafc;">
                                        <tr>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Investigation ID</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Title</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Status</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Priority</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Incident Date</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Location</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="background:#fef3c7; animation:highlightPulse 1.5s infinite; cursor:pointer;" onclick="">
                                            <td style="padding:0.25rem; color:#1e293b; font-weight:600; border-bottom:1px solid #f1f5f9;">INV-2024-0025</td>
                                            <td style="padding:0.25rem; color:#1e293b; border-bottom:1px solid #f1f5f9;">Warehouse Forklift Incident</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Pending Approval</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fee2e2; color:#dc2626; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">High</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">10 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Warehouse B - Zone 3</td>
                                        </tr>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Chemical Spill - Lab Area</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Approved</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Medium</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">08 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Laboratory A</td>
                                        </tr>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0023</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Slip and Fall - Main Entrance</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dbeafe; color:#2563eb; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Closed</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Low</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">05 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Main Office Entrance</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:0.25rem; padding:0.2rem; background:#dbeafe; border-radius:3px; border-left:2px solid #3b82f6;">
                                <p style="margin:0; font-size:0.7rem; color:#1e40af;"><i class="fas fa-info-circle" style="margin-right:0.15rem;"></i><strong>New investigation added!</strong> INV-2024-0025 is now visible in the list.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene 58: Click to View - Click on investigation row -->
            <div class="demo-scene" id="scene-click-view" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    <!-- Sidebar -->
                    <div style="width:90px; background:#2c3e50; color:#fff; padding:0.2rem; flex-shrink:0; font-size:0.7rem;">
                        <div style="text-align:center; padding:0.2rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:600; font-size:0.75rem;">Dreamex Datalab</div>
                        <div style="margin-top:0.25rem;">
                            <div style="padding:0.15rem 0.25rem; margin-bottom:0.1rem; border-radius:2px; display:flex; align-items:center; gap:0.15rem; opacity:0.7;"><i class="fas fa-home" style="font-size:0.7rem;"></i> Home</div>
                            <div style="padding:0.15rem 0.25rem; margin-bottom:0.1rem; border-radius:2px; display:flex; align-items:center; gap:0.15rem; opacity:0.7;"><i class="fas fa-shield-alt" style="font-size:0.7rem;"></i> Safety</div>
                            <div style="padding:0.15rem 0.25rem; margin-bottom:0.1rem; border-radius:2px; background:rgba(255,255,255,0.15); display:flex; align-items:center; gap:0.15rem;"><i class="fas fa-search-plus" style="font-size:0.7rem;"></i> Investigation</div>
                        </div>
                    </div>
                    <!-- Main Content -->
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        <!-- Top Nav -->
                        <div style="background:#fff; padding:0.15rem 0.3rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e2e8f0; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display:flex; align-items:center; gap:0.3rem;">
                                <div style="width:18px; height:18px; background:#3b82f6; border-radius:3px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem; font-weight:600;">DX</div>
                                <span style="font-size:0.75rem; font-weight:600; color:#334155;">Company Name</span>
                            </div>
                            <div style="width:18px; height:18px; background:#64748b; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem;">JD</div>
                        </div>
                        <!-- Page Header -->
                        <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.2rem 0.35rem; display:flex; align-items:center; justify-content:space-between; margin:0.2rem; border-radius:4px;">
                            <div style="display:flex; align-items:center; gap:0.25rem;">
                                <i class="fas fa-search-plus" style="font-size:0.5rem;"></i>
                                <span style="font-size:0.5rem; font-weight:600;">Investigation List</span>
                            </div>
                            <button style="background:none; border:none; color:#fff; font-size:0.6rem; cursor:pointer;"><i class="fas fa-plus-circle"></i></button>
                        </div>
                        <!-- Tabs -->
                        <div style="padding:0.15rem 0.35rem; display:flex; gap:0.2rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:600; background:#3b82f6; color:#fff; border-radius:3px;"><i class="fas fa-list" style="margin-right:0.15rem;"></i>Investigations</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:500; background:#f1f5f9; color:#64748b; border-radius:3px;"><i class="fas fa-cog" style="margin-right:0.15rem;"></i>Settings</span>
                        </div>
                        <!-- Filters -->
                        <div style="padding:0.2rem 0.35rem; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                            <div style="display:flex; gap:0.2rem; align-items:flex-end; flex-wrap:wrap;">
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Status</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Status</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Priority</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Priorities</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Investigator</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All</div>
                                </div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.12rem 0.25rem; border-radius:2px; font-size:0.6rem;"><i class="fas fa-filter"></i> Apply</button>
                            </div>
                        </div>
                        <!-- Table with highlighted clickable row -->
                        <div style="flex:1; padding:0.2rem 0.35rem; overflow:auto;">
                            <div style="background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.08); overflow:hidden;">
                                <table style="width:100%; border-collapse:collapse; font-size:0.7rem;">
                                    <thead style="background:#f8fafc;">
                                        <tr>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Investigation ID</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Title</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Status</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Priority</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Incident Date</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Location</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="background:#eff6ff; cursor:pointer; animation:highlightPulse 1s infinite; box-shadow:0 0 0 2px rgba(59,130,246,0.4);">
                                            <td style="padding:0.25rem; color:#1e293b; font-weight:600; border-bottom:1px solid #f1f5f9;">INV-2024-0025</td>
                                            <td style="padding:0.25rem; color:#1e293b; border-bottom:1px solid #f1f5f9;">Warehouse Forklift Incident</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Pending Approval</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fee2e2; color:#dc2626; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">High</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">10 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Warehouse B - Zone 3</td>
                                        </tr>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Chemical Spill - Lab Area</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Approved</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Medium</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">08 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Laboratory A</td>
                                        </tr>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0023</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Slip and Fall - Main Entrance</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dbeafe; color:#2563eb; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Closed</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Low</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">05 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Main Office Entrance</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:0.25rem; padding:0.2rem; background:#dbeafe; border-radius:3px; border-left:2px solid #3b82f6;">
                                <p style="margin:0; font-size:0.7rem; color:#1e40af;"><i class="fas fa-mouse-pointer" style="margin-right:0.15rem;"></i><strong>Click on the row</strong> to open the investigation report modal.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene 59: Show Report View - Modal with full DMAIC structure -->
            <div class="demo-scene" id="scene-show-report" style="display:none; height:100%;">
                <div style="position:relative; height:100%; background:rgba(0,0,0,0.55); display:flex; align-items:flex-start; justify-content:center; padding:0.5rem; overflow:auto;">
                    <!-- Modal Container -->
                    <div style="background:#fff; border-radius:8px; width:95%; max-width:500px; box-shadow:0 12px 32px rgba(0,0,0,0.25); overflow:hidden; animation:bounceIn 0.4s;">
                        <!-- Modal Header with buttons -->
                        <div style="position:relative; padding:0.5rem 0.6rem; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                            <div style="position:absolute; top:0.3rem; right:0.3rem; display:flex; gap:0.2rem;">
                                <button style="background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:4px; padding:0.15rem 0.3rem; font-size:0.6rem; cursor:pointer;">Close</button>
                                <button style="background:#111827; color:#fff; border:none; border-radius:4px; padding:0.15rem 0.3rem; font-size:0.6rem; cursor:pointer;"><i class="fas fa-print"></i> Print</button>
                            </div>
                            <!-- Company Header -->
                            <div style="display:flex; align-items:flex-start; gap:0.4rem;">
                                <div style="width:35px; height:35px; background:#3b82f6; border-radius:5px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.5rem; font-weight:700;">DX</div>
                                <div>
                                    <h1 style="margin:0; font-size:0.55rem; font-weight:700; color:#111827;">Company Name</h1>
                                    <h2 style="margin:0.1rem 0 0; font-size:0.5rem; font-weight:600; color:#374151;">Investigation Report</h2>
                                </div>
                            </div>
                            <div style="margin-top:0.3rem; font-size:0.7rem; color:#64748b;">
                                <span style="font-weight:600; color:#374151;">Document Number:</span> <span style="color:#111827;">INV-2024-0025</span>
                            </div>
                        </div>
                        
                        <!-- Scrollable Content -->
                        <div id="demoReportScroll" style="max-height:320px; overflow-y:auto; padding:0.4rem;">
                            <!-- Define Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-clipboard-list" style="font-size:0.5rem; width:16px; height:16px; background:rgba(52,152,219,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Define - Incident Information</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; font-size:0.65rem;">
                                        <div><span style="color:#64748b;">Reference:</span> <strong>INV-2024-0025</strong></div>
                                        <div><span style="color:#64748b;">Title:</span> <strong>Warehouse Forklift Incident</strong></div>
                                        <div><span style="color:#64748b;">Status:</span> <span style="background:#fef3c7; color:#d97706; padding:0.05rem 0.15rem; border-radius:2px;">Pending Approval</span></div>
                                        <div><span style="color:#64748b;">Priority:</span> <span style="background:#fee2e2; color:#dc2626; padding:0.05rem 0.15rem; border-radius:2px;">High</span></div>
                                        <div><span style="color:#64748b;">Incident Date:</span> <strong>10 Dec 2024</strong></div>
                                        <div><span style="color:#64748b;">Reported Date:</span> <strong>10 Dec 2024</strong></div>
                                        <div><span style="color:#64748b;">Location:</span> <strong>Warehouse B - Zone 3</strong></div>
                                        <div><span style="color:#64748b;">Department:</span> <strong>Operations</strong></div>
                                    </div>
                                    <div style="margin-top:0.25rem; padding:0.2rem; background:#f8fafc; border-radius:2px; font-size:0.65rem;">
                                        <div style="color:#64748b; margin-bottom:0.1rem;">Description:</div>
                                        <div style="color:#111827;">Forklift operator collided with storage rack while reversing in aisle B-7. Equipment damage to forklift front guard and rack support beam.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Measure Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-chart-bar" style="font-size:0.5rem; width:16px; height:16px; background:rgba(155,89,182,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Measure - Data Collection</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; font-size:0.65rem;">
                                        <div><span style="color:#64748b;">Severity (Actual):</span> <strong style="color:#dc2626;">Major</strong></div>
                                        <div><span style="color:#64748b;">Potential Severity:</span> <strong style="color:#dc2626;">Catastrophic</strong></div>
                                        <div><span style="color:#64748b;">Likelihood:</span> <strong>Possible</strong></div>
                                        <div><span style="color:#64748b;">Risk Level:</span> <span style="background:#fee2e2; color:#dc2626; padding:0.05rem 0.15rem; border-radius:2px;">High</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Analyze Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-search" style="font-size:0.5rem; width:16px; height:16px; background:rgba(241,196,15,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Analyze - Root Cause Analysis</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem;">
                                    <div style="font-size:0.65rem;">
                                        <div style="margin-bottom:0.15rem;"><span style="color:#64748b;">Root Cause:</span> <strong>Inadequate training on reversing procedures in narrow aisles</strong></div>
                                        <div><span style="color:#64748b;">Contributing Factors:</span></div>
                                        <ul style="margin:0.1rem 0 0 0.5rem; padding:0; font-size:0.36rem; color:#475569;">
                                            <li>Poor visibility due to insufficient lighting</li>
                                            <li>Lack of warning signage in aisle</li>
                                            <li>Time pressure from delivery deadlines</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Improve Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-tools" style="font-size:0.5rem; width:16px; height:16px; background:rgba(46,204,113,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Improve - Corrective Actions</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem;">
                                    <div style="font-size:0.65rem;">
                                        <div style="display:flex; align-items:center; gap:0.15rem; padding:0.15rem 0; border-bottom:1px solid #f1f5f9;">
                                            <i class="fas fa-check-circle" style="color:#10b981; font-size:0.7rem;"></i>
                                            <span>Install additional LED lighting in warehouse aisles</span>
                                            <span style="margin-left:auto; background:#dcfce7; color:#16a34a; padding:0.05rem 0.15rem; border-radius:2px; font-size:0.55rem;">Completed</span>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:0.15rem; padding:0.15rem 0; border-bottom:1px solid #f1f5f9;">
                                            <i class="fas fa-clock" style="color:#f59e0b; font-size:0.7rem;"></i>
                                            <span>Conduct refresher training for all forklift operators</span>
                                            <span style="margin-left:auto; background:#fef3c7; color:#d97706; padding:0.05rem 0.15rem; border-radius:2px; font-size:0.55rem;">In Progress</span>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:0.15rem; padding:0.15rem 0;">
                                            <i class="fas fa-clock" style="color:#f59e0b; font-size:0.7rem;"></i>
                                            <span>Install convex mirrors at aisle intersections</span>
                                            <span style="margin-left:auto; background:#fef3c7; color:#d97706; padding:0.05rem 0.15rem; border-radius:2px; font-size:0.55rem;">Pending</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Control Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-check-circle" style="font-size:0.5rem; width:16px; height:16px; background:rgba(26,188,156,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Control - Verification & Lessons Learned</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem; font-size:0.65rem;">
                                    <div style="margin-bottom:0.15rem;"><span style="color:#64748b;">Verification Status:</span> <strong>Pending verification of completed actions</strong></div>
                                    <div><span style="color:#64748b;">Lessons Learned:</span> <span style="color:#111827;">Regular safety audits required for high-traffic areas. Training must include practical reversing exercises.</span></div>
                                </div>
                            </div>
                            
                            <!-- Approval Flow Section -->
                            <div style="margin-bottom:0.3rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-stamp" style="font-size:0.5rem; width:16px; height:16px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Approval Flow</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem;">
                                    <div style="display:flex; gap:0.3rem; font-size:0.36rem;">
                                        <div style="flex:1; background:#dcfce7; border:1px solid #86efac; border-radius:3px; padding:0.2rem; text-align:center;">
                                            <div style="color:#16a34a; font-weight:600;"><i class="fas fa-check"></i> Level 1</div>
                                            <div style="color:#166534;">John Smith</div>
                                            <div style="color:#15803d; font-size:0.55rem;">Approved</div>
                                        </div>
                                        <div style="flex:1; background:#fef3c7; border:1px solid #fcd34d; border-radius:3px; padding:0.2rem; text-align:center;">
                                            <div style="color:#d97706; font-weight:600;"><i class="fas fa-clock"></i> Level 2</div>
                                            <div style="color:#92400e;">Safety Manager</div>
                                            <div style="color:#b45309; font-size:0.55rem;">Pending</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Success message -->
                        <div style="padding:0.25rem 0.4rem; background:#dcfce7; border-top:1px solid #86efac;">
                            <p style="margin:0; font-size:0.7rem; color:#166534; text-align:center;"><i class="fas fa-check-circle" style="margin-right:0.15rem;"></i><strong>Investigation Report loaded!</strong> Full DMAIC details displayed.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene 60: Click Edit Button - Show edit button in modal -->
            <div class="demo-scene" id="scene-click-edit" style="display:none; height:100%;">
                <div style="position:relative; height:100%; background:rgba(0,0,0,0.55); display:flex; align-items:flex-start; justify-content:center; padding:0.5rem; overflow:auto;">
                    <!-- Modal Container -->
                    <div style="background:#fff; border-radius:8px; width:95%; max-width:500px; box-shadow:0 12px 32px rgba(0,0,0,0.25); overflow:hidden;">
                        <!-- Modal Header with buttons -->
                        <div style="position:relative; padding:0.5rem 0.6rem; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                            <div style="position:absolute; top:0.3rem; right:0.3rem; display:flex; gap:0.2rem;">
                                <button style="background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:4px; padding:0.15rem 0.3rem; font-size:0.6rem; cursor:pointer;">Close</button>
                                <button style="background:#111827; color:#fff; border:none; border-radius:4px; padding:0.15rem 0.3rem; font-size:0.6rem; cursor:pointer;"><i class="fas fa-print"></i> Print</button>
                            </div>
                            <!-- Company Header -->
                            <div style="display:flex; align-items:flex-start; gap:0.4rem;">
                                <div style="width:35px; height:35px; background:#3b82f6; border-radius:5px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.5rem; font-weight:700;">DX</div>
                                <div>
                                    <h1 style="margin:0; font-size:0.55rem; font-weight:700; color:#111827;">Company Name</h1>
                                    <h2 style="margin:0.1rem 0 0; font-size:0.5rem; font-weight:600; color:#374151;">Investigation Report</h2>
                                </div>
                            </div>
                            <div style="margin-top:0.3rem; font-size:0.7rem; color:#64748b;">
                                <span style="font-weight:600; color:#374151;">Document Number:</span> <span style="color:#111827;">INV-2024-0025</span>
                            </div>
                        </div>
                        
                        <!-- Scrollable Content (condensed) -->
                        <div style="max-height:250px; overflow-y:auto; padding:0.4rem;">
                            <!-- Define Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px 3px 0 0; display:flex; align-items:center; gap:0.25rem;">
                                    <i class="fas fa-clipboard-list" style="font-size:0.5rem;"></i>
                                    <span style="font-size:0.75rem; font-weight:600;">Define - Incident Information</span>
                                </div>
                                <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 3px 3px; padding:0.3rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; font-size:0.65rem;">
                                        <div><span style="color:#64748b;">Reference:</span> <strong>INV-2024-0025</strong></div>
                                        <div><span style="color:#64748b;">Title:</span> <strong>Warehouse Forklift Incident</strong></div>
                                        <div><span style="color:#64748b;">Status:</span> <span style="background:#fef3c7; color:#d97706; padding:0.05rem 0.15rem; border-radius:2px;">Pending</span></div>
                                        <div><span style="color:#64748b;">Priority:</span> <span style="background:#fee2e2; color:#dc2626; padding:0.05rem 0.15rem; border-radius:2px;">High</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- More sections (collapsed representation) -->
                            <div style="margin-bottom:0.4rem; opacity:0.6;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px; font-size:0.75rem;">
                                    <i class="fas fa-chart-bar" style="margin-right:0.2rem;"></i> Measure - Data Collection
                                </div>
                            </div>
                            <div style="margin-bottom:0.4rem; opacity:0.6;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px; font-size:0.75rem;">
                                    <i class="fas fa-search" style="margin-right:0.2rem;"></i> Analyze - Root Cause Analysis
                                </div>
                            </div>
                            <div style="margin-bottom:0.4rem; opacity:0.6;">
                                <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.25rem 0.35rem; border-radius:3px; font-size:0.75rem;">
                                    <i class="fas fa-tools" style="margin-right:0.2rem;"></i> Improve - Corrective Actions
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons - Edit highlighted -->
                        <div style="padding:0.35rem 0.4rem; background:#f8fafc; border-top:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; gap:0.2rem;">
                                <button style="background:#1f2937; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.7rem; animation:highlightPulse 1s infinite; box-shadow:0 0 12px rgba(31,41,55,0.5);"><i class="fas fa-edit" style="margin-right:0.15rem;"></i> Edit</button>
                                <button style="background:#dc2626; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.7rem; opacity:0.7;"><i class="fas fa-trash" style="margin-right:0.15rem;"></i> Delete</button>
                            </div>
                            <div style="display:flex; gap:0.2rem;">
                                <button style="background:#ef4444; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.7rem; opacity:0.7;"><i class="fas fa-times" style="margin-right:0.15rem;"></i> Decline</button>
                                <button style="background:#10b981; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.7rem; opacity:0.7;"><i class="fas fa-check" style="margin-right:0.15rem;"></i> Approve</button>
                            </div>
                        </div>
                        
                        <!-- Info message -->
                        <div style="padding:0.25rem 0.4rem; background:#dbeafe; border-top:1px solid #93c5fd;">
                            <p style="margin:0; font-size:0.7rem; color:#1e40af; text-align:center;"><i class="fas fa-edit" style="margin-right:0.15rem;"></i><strong>Click the Edit button</strong> to modify investigation details.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene 61: Final Success -->
            <div class="demo-scene" id="scene-final" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; background:linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                <div style="background:#fff; border-radius:50%; width:70px; height:70px; display:flex; align-items:center; justify-content:center; margin-bottom:0.75rem; animation:bounceIn 0.5s;">
                    <i class="fas fa-graduation-cap" style="font-size:2rem; color:#8b5cf6;"></i>
                </div>
                <h2 style="color:#fff; font-size:1.3rem; margin-bottom:0.3rem;">Tutorial Complete!</h2>
                <p style="color:rgba(255,255,255,0.9); font-size:0.8rem; margin-bottom:0.5rem; text-align:center;">You've learned how to:</p>
                <ul style="color:rgba(255,255,255,0.85); font-size:0.65rem; margin:0; padding-left:1.2rem; line-height:1.6;">
                    <li>Create a new ICAM investigation</li>
                    <li>Complete all DMAIC tabs</li>
                    <li>Submit for approval</li>
                    <li>View investigation reports</li>
                    <li>Edit existing investigations</li>
                </ul>
            </div>
        `;
    }

    function closeVideoTutorial() {
        document.getElementById('videoTutorialOverlay').classList.remove('active');
        pauseVideo();
        videoCurrentStep = 0;
        videoProgress = 0;
        updateVideoUI();
    }

    function toggleVideoPlayPause() {
        if (videoPlaying) {
            pauseVideo();
        } else {
            playVideo();
        }
    }

    function playVideo() {
        videoPlaying = true;
        document.querySelector('#videoPlayPauseBtn i').className = 'fas fa-pause';
        
        videoInterval = setInterval(() => {
            videoProgress += 100;
            
            // Calculate current step based on cumulative durations
            let cumulative = 0;
            let newStep = 0;
            for (let i = 0; i < demoScenes.length; i++) {
                cumulative += demoScenes[i].duration;
                if (videoProgress <= cumulative) {
                    newStep = i;
                    break;
                }
                if (i === demoScenes.length - 1) {
                    newStep = i;
                }
            }
            
            if (newStep !== videoCurrentStep) {
                videoCurrentStep = newStep;
                showDemoScene(videoCurrentStep);
            }
            
            // Update progress bar
            updateVideoUI();
            
            // End of video
            if (videoProgress >= totalDuration) {
                pauseVideo();
                videoProgress = totalDuration;
                updateVideoUI();
            }
        }, 100);
    }

    function pauseVideo() {
        videoPlaying = false;
        document.querySelector('#videoPlayPauseBtn i').className = 'fas fa-play';
        if (videoInterval) {
            clearInterval(videoInterval);
            videoInterval = null;
        }
    }

    function restartVideo() {
        pauseVideo();
        videoCurrentStep = 0;
        videoProgress = 0;
        buildDemoScenes();
        showDemoScene(0);
        updateVideoUI();
        setTimeout(() => playVideo(), 500);
    }

    function seekVideo(event) {
        const progressBar = event.currentTarget;
        const rect = progressBar.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const percentage = clickX / rect.width;
        
        videoProgress = Math.floor(percentage * totalDuration);
        
        // Find which step we're on
        let cumulative = 0;
        for (let i = 0; i < demoScenes.length; i++) {
            cumulative += demoScenes[i].duration;
            if (videoProgress <= cumulative) {
                videoCurrentStep = i;
                break;
            }
        }
        
        showDemoScene(videoCurrentStep);
        updateVideoUI();
    }

    function showDemoScene(sceneIndex) {
        const scene = demoScenes[sceneIndex];
        if (!scene) return;
        
        const container = document.getElementById('demoSceneContainer');
        const cursor = document.getElementById('demoCursor');
        const captionText = document.getElementById('demoCaptionText');
        
        // Hide all scenes
        container.querySelectorAll('.demo-scene').forEach(s => s.style.display = 'none');
        
        // Show current scene
        const currentSceneEl = document.getElementById('scene-' + scene.id);
        if (currentSceneEl) {
            currentSceneEl.style.display = scene.id === 'welcome' || scene.id === 'success' ? 'flex' : 'block';
        }
        
        // Update caption
        if (captionText) {
            captionText.innerHTML = scene.caption;
        }
        
        // Hide cursor - autofill mode, no mouse pointer
        if (cursor) {
            cursor.style.display = 'none';
        }

        // Auto-scroll the tab content based on scrollTo percentage
        if (scene.scrollTo !== undefined && currentSceneEl) {
            // Small delay to ensure the scene is rendered
            setTimeout(() => {
                // Try all possible scroll containers
                const scrollEl = currentSceneEl.querySelector('#demoFormScroll') || 
                                 currentSceneEl.querySelector('#demoMeasureScroll') ||
                                 currentSceneEl.querySelector('#demoAnalyzeScroll') ||
                                 currentSceneEl.querySelector('#demoImproveScroll') ||
                                 currentSceneEl.querySelector('#demoControlScroll');
                if (scrollEl) {
                    const maxScroll = scrollEl.scrollHeight - scrollEl.clientHeight;
                    const targetScroll = (scene.scrollTo / 100) * maxScroll;
                    scrollEl.scrollTo({ 
                        top: targetScroll, 
                        behavior: 'smooth' 
                    });
                }
            }, 100);
        }
    }

    function addDemoClickEffect(xPercent, yPercent) {
        const screen = document.getElementById('videoScreen');
        if (!screen) return;
        
        const rect = screen.getBoundingClientRect();
        const x = (xPercent / 100) * rect.width;
        const y = (yPercent / 100) * rect.height;
        
        const ripple = document.createElement('div');
        ripple.className = 'click-ripple';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.style.position = 'absolute';
        ripple.style.zIndex = '102';
        screen.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
    }

    function updateVideoUI() {
        // Update progress bar
        const progressPercent = (videoProgress / totalDuration) * 100;
        document.getElementById('videoProgressBar').style.width = progressPercent + '%';
        
        // Update time display
        const currentSeconds = Math.floor(videoProgress / 1000);
        const totalSeconds = Math.floor(totalDuration / 1000);
        const currentMin = Math.floor(currentSeconds / 60);
        const currentSec = currentSeconds % 60;
        const totalMin = Math.floor(totalSeconds / 60);
        const totalSec = totalSeconds % 60;
        document.getElementById('videoTime').textContent = 
            `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${totalMin}:${totalSec.toString().padStart(2, '0')}`;
    }

    // Close video on overlay click
    document.getElementById('videoTutorialOverlay')?.addEventListener('click', (e) => {
        if (e.target.id === 'videoTutorialOverlay') {
            closeVideoTutorial();
        }
    });

    // ========== EDIT DEMO VIDEO - MODIFY INVESTIGATION DEMO ==========
    let editVideoPlaying = false;
    let editVideoCurrentStep = 0;
    let editVideoInterval = null;
    let editVideoProgress = 0;
    
    // Edit Investigation Demo Scenes
    const editDemoScenes = [
        { id: 'edit-welcome', caption: '<strong>Welcome!</strong> Let\'s learn how to edit and modify an existing investigation', duration: 2500 },
        { id: 'edit-view-list', caption: '<strong>Step 1:</strong> Start from the <span style="color:#fbbf24;">Investigation List</span> page', duration: 2500 },
        { id: 'edit-modal-scroll', caption: '<strong>Step 2:</strong> Click a row to open the <span style="color:#fbbf24;">Investigation Details</span> modal and click <span style="color:#10b981;">Edit</span>...', duration: 6000, scrollFrom: 0, scrollTo: 100, scrollDuration: 4500, clickEditAt: 5000 },
        { id: 'edit-form-opens', caption: '<strong>Step 3:</strong> The form opens in <span style="color:#fbbf24;">Edit Mode</span> - edit any field you need', duration: 2500, scrollTo: 0 },
        { id: 'edit-define-scroll', caption: '<strong>Step 4:</strong> <span style="color:#fbbf24;">Define Tab</span> - Edit Title, Purpose, Scope, Description, Equipment, People...', duration: 5000, scrollFrom: 0, scrollTo: 100, scrollDuration: 4500 },
        { id: 'edit-switch-measure', caption: '<strong>Step 5:</strong> Click <span style="color:#fbbf24;">Measure</span> tab to edit data collection', duration: 2000, scrollTo: 0 },
        { id: 'edit-measure-scroll', caption: '<strong>Step 6:</strong> <span style="color:#fbbf24;">Measure Tab</span> - Edit PEEPO Analysis, Location, Evidence, Timeline...', duration: 5000, scrollFrom: 0, scrollTo: 100, scrollDuration: 4500 },
        { id: 'edit-switch-analyze', caption: '<strong>Step 7:</strong> Click <span style="color:#fbbf24;">Analyze</span> tab', duration: 2000, scrollTo: 0 },
        { id: 'edit-add-rootcause', caption: '<strong>Step 8:</strong> Add or edit <span style="color:#fbbf24;">Root Causes</span> and <span style="color:#fbbf24;">Failed Defenses</span>', duration: 2500, scrollTo: 20 },
        { id: 'edit-switch-improve', caption: '<strong>Step 9:</strong> Click <span style="color:#fbbf24;">Improve</span> tab', duration: 2000, scrollTo: 0 },
        { id: 'edit-improve-scroll', caption: '<strong>Step 10:</strong> <span style="color:#fbbf24;">Improve Tab</span> - Add or update Corrective Actions...', duration: 4000, scrollFrom: 0, scrollTo: 100, scrollDuration: 3500 },
        { id: 'edit-switch-control', caption: '<strong>Step 11:</strong> Click <span style="color:#fbbf24;">Control</span> tab to verify', duration: 2000, scrollTo: 0 },
        { id: 'edit-save', caption: '<strong>Step 12:</strong> Click <span style="color:#fbbf24;">Save Changes</span>', duration: 2500, scrollTo: 100 },
        { id: 'edit-success', caption: '<strong>Success!</strong> Investigation updated successfully!', duration: 2500 },
        { id: 'edit-updated-list', caption: '<strong>Step 13:</strong> Return to list - changes are <span style="color:#22c55e;">saved</span>', duration: 2500 },
        { id: 'edit-final', caption: '<strong>Complete!</strong> You now know how to <span style="color:#10b981;">Edit</span> and <span style="color:#fbbf24;">Update</span> investigations!', duration: 3000 }
    ];
    
    const editTotalDuration = editDemoScenes.reduce((sum, scene) => sum + scene.duration, 0);

    function openEditDemoVideo() {
        document.getElementById('editDemoOverlay').classList.add('active');
        buildEditDemoScenes();
        restartEditVideo();
    }

    function closeEditDemoVideo() {
        document.getElementById('editDemoOverlay').classList.remove('active');
        pauseEditVideo();
        editVideoCurrentStep = 0;
        editVideoProgress = 0;
        updateEditVideoUI();
    }

    function toggleEditVideoPlayPause() {
        if (editVideoPlaying) {
            pauseEditVideo();
        } else {
            playEditVideo();
        }
    }

    function playEditVideo() {
        editVideoPlaying = true;
        document.querySelector('#editVideoPlayPauseBtn i').className = 'fas fa-pause';
        
        editVideoInterval = setInterval(() => {
            editVideoProgress += 100;
            
            let cumulative = 0;
            let newStep = 0;
            for (let i = 0; i < editDemoScenes.length; i++) {
                cumulative += editDemoScenes[i].duration;
                if (editVideoProgress <= cumulative) {
                    newStep = i;
                    break;
                }
                if (i === editDemoScenes.length - 1) {
                    newStep = i;
                }
            }
            
            if (newStep !== editVideoCurrentStep) {
                editVideoCurrentStep = newStep;
                showEditDemoScene(editVideoCurrentStep);
            }
            
            updateEditVideoUI();
            
            if (editVideoProgress >= editTotalDuration) {
                pauseEditVideo();
                editVideoProgress = editTotalDuration;
                updateEditVideoUI();
            }
        }, 100);
    }

    function pauseEditVideo() {
        editVideoPlaying = false;
        document.querySelector('#editVideoPlayPauseBtn i').className = 'fas fa-play';
        if (editVideoInterval) {
            clearInterval(editVideoInterval);
            editVideoInterval = null;
        }
    }

    function restartEditVideo() {
        pauseEditVideo();
        editVideoCurrentStep = 0;
        editVideoProgress = 0;
        buildEditDemoScenes();
        showEditDemoScene(0);
        updateEditVideoUI();
        setTimeout(() => playEditVideo(), 500);
    }

    function seekEditVideo(event) {
        const progressBar = event.currentTarget;
        const rect = progressBar.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const percentage = clickX / rect.width;
        
        editVideoProgress = Math.floor(percentage * editTotalDuration);
        
        let cumulative = 0;
        for (let i = 0; i < editDemoScenes.length; i++) {
            cumulative += editDemoScenes[i].duration;
            if (editVideoProgress <= cumulative) {
                editVideoCurrentStep = i;
                break;
            }
        }
        
        showEditDemoScene(editVideoCurrentStep);
        updateEditVideoUI();
    }

    function showEditDemoScene(sceneIndex) {
        const scene = editDemoScenes[sceneIndex];
        if (!scene) return;
        
        const container = document.getElementById('editDemoSceneContainer');
        const captionText = document.getElementById('editDemoCaptionText');
        
        // Hide all scenes
        container.querySelectorAll('.demo-scene').forEach(s => s.style.display = 'none');
        
        // Show current scene
        const currentSceneEl = document.getElementById('scene-' + scene.id);
        if (currentSceneEl) {
            currentSceneEl.style.display = scene.id.includes('welcome') || scene.id.includes('success') || scene.id.includes('final') ? 'flex' : 'block';
        }
        
        // Update caption
        if (captionText) {
            captionText.innerHTML = scene.caption;
        }
        
        // Auto-scroll with optional duration for smooth animated scroll
        if (scene.scrollTo !== undefined && currentSceneEl) {
            setTimeout(() => {
                const scrollEl = currentSceneEl.querySelector('[data-scroll-container]');
                if (scrollEl) {
                    const maxScroll = scrollEl.scrollHeight - scrollEl.clientHeight;
                    const targetScroll = (scene.scrollTo / 100) * maxScroll;
                    
                    // If scrollFrom is specified, start from that position
                    if (scene.scrollFrom !== undefined) {
                        scrollEl.scrollTop = (scene.scrollFrom / 100) * maxScroll;
                    }
                    
                    // If scrollDuration is specified, animate the scroll over that duration
                    if (scene.scrollDuration) {
                        const startScroll = scrollEl.scrollTop;
                        const scrollDistance = targetScroll - startScroll;
                        const startTime = performance.now();
                        
                        function animateScroll(currentTime) {
                            const elapsed = currentTime - startTime;
                            const progress = Math.min(elapsed / scene.scrollDuration, 1);
                            // Ease-in-out function for smooth scrolling
                            const easeProgress = progress < 0.5 
                                ? 2 * progress * progress 
                                : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                            
                            scrollEl.scrollTop = startScroll + (scrollDistance * easeProgress);
                            
                            if (progress < 1) {
                                requestAnimationFrame(animateScroll);
                            }
                        }
                        requestAnimationFrame(animateScroll);
                    } else {
                        scrollEl.scrollTo({ top: targetScroll, behavior: 'smooth' });
                    }
                }
            }, 100);
        }
        
        // Handle clickEditAt - trigger Edit button click animation at specified time
        if (scene.clickEditAt !== undefined && currentSceneEl) {
            setTimeout(() => {
                // Find the Edit button and add click animation
                const editBtn = currentSceneEl.querySelector('.demo-edit-btn');
                if (editBtn) {
                    editBtn.style.transform = 'scale(0.95)';
                    editBtn.style.boxShadow = '0 0 20px rgba(16,185,129,0.8)';
                    editBtn.style.animation = 'buttonClick 0.3s ease-out';
                    
                    // Add ripple effect
                    const ripple = document.createElement('div');
                    ripple.style.cssText = 'position:absolute; left:25px; top:50%; transform:translate(-50%, -50%); width:40px; height:40px; border-radius:50%; background:rgba(16,185,129,0.4); animation:clickRipple 0.6s ease-out; pointer-events:none;';
                    editBtn.parentElement.style.position = 'relative';
                    editBtn.parentElement.appendChild(ripple);
                    
                    // Remove ripple after animation
                    setTimeout(() => ripple.remove(), 600);
                }
                
                // Also move the mouse cursor to the Edit button position
                const cursor = currentSceneEl.querySelector('.demo-mouse-cursor');
                if (cursor) {
                    cursor.style.transition = 'top 0.6s ease, left 0.6s ease';
                    // Fine-tuned to the Edit button center
                    cursor.style.top = '86%';
                    cursor.style.left = '22%';
                }
                
                // Update info bar to show clicking message
                const infoBar = currentSceneEl.querySelector('.demo-info-bar');
                if (infoBar) {
                    infoBar.style.background = '#dcfce7';
                    infoBar.style.borderTopColor = '#86efac';
                    infoBar.innerHTML = '<p style="margin:0; font-size:0.75rem; color:#166534; text-align:center;"><i class="fas fa-mouse-pointer" style="margin-right:4px;"></i><strong>Clicking Edit button...</strong></p>';
                }
            }, scene.clickEditAt);
        }
    }

    function updateEditVideoUI() {
        const progressPercent = (editVideoProgress / editTotalDuration) * 100;
        document.getElementById('editVideoProgressBar').style.width = progressPercent + '%';
        
        const currentSeconds = Math.floor(editVideoProgress / 1000);
        const totalSeconds = Math.floor(editTotalDuration / 1000);
        const currentMin = Math.floor(currentSeconds / 60);
        const currentSec = currentSeconds % 60;
        const totalMin = Math.floor(totalSeconds / 60);
        const totalSec = totalSeconds % 60;
        document.getElementById('editVideoTime').textContent = 
            `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${totalMin}:${totalSec.toString().padStart(2, '0')}`;
    }

    // Close edit video on overlay click
    document.getElementById('editDemoOverlay')?.addEventListener('click', (e) => {
        if (e.target.id === 'editDemoOverlay') {
            closeEditDemoVideo();
        }
    });

    function buildEditDemoScenes() {
        const container = document.getElementById('editDemoSceneContainer');
        if (!container) return;
        
        container.innerHTML = generateEditDemoScenes();
    }

    // Mouse cursor component generator for edit demo
    function editMouseCursor(top, left, animate = true) {
        return `<div class="demo-mouse-cursor" style="position:absolute; top:${top}; left:${left}; z-index:200; pointer-events:none; ${animate ? 'animation:mouseFloat 1s ease-in-out infinite;' : ''}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 4L10.5 20L12.5 13.5L19 11.5L4 4Z" fill="#111827" stroke="#ffffff" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
        </div>`;
    }

    function generateEditDemoScenes() {
        // Reusable HTML components with larger font sizes for readability
        const sidebarHTML = `
            <div style="width:120px; background:#2c3e50; color:#fff; padding:0.3rem; flex-shrink:0; font-size:0.65rem;">
                <div style="text-align:center; padding:0.3rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:600; font-size:0.75rem;">Dreamex Datalab</div>
                <div style="margin-top:0.35rem;">
                    <div style="padding:0.2rem 0.3rem; margin-bottom:0.15rem; border-radius:3px; display:flex; align-items:center; gap:0.2rem; opacity:0.7;"><i class="fas fa-home" style="font-size:0.65rem;"></i> Home</div>
                    <div style="padding:0.2rem 0.3rem; margin-bottom:0.15rem; border-radius:3px; display:flex; align-items:center; gap:0.2rem; opacity:0.7;"><i class="fas fa-shield-alt" style="font-size:0.65rem;"></i> Safety</div>
                    <div style="padding:0.2rem 0.3rem; margin-bottom:0.15rem; border-radius:3px; background:rgba(255,255,255,0.15); display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-search-plus" style="font-size:0.65rem;"></i> Investigation</div>
                </div>
            </div>
        `;
        
        const topNavHTML = `
            <div style="background:#fff; padding:0.25rem 0.4rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e2e8f0; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                <div style="display:flex; align-items:center; gap:0.4rem;">
                    <div style="width:28px; height:28px; background:#3b82f6; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem; font-weight:600;">DX</div>
                    <span style="font-size:0.75rem; font-weight:600; color:#334155;">Company Name</span>
                </div>
                <div style="width:28px; height:28px; background:#64748b; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem;">JD</div>
            </div>
        `;
        
        const pageHeaderHTML = `
            <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.3rem 0.5rem; display:flex; align-items:center; justify-content:space-between; margin:0.3rem; border-radius:6px;">
                <div style="display:flex; align-items:center; gap:0.35rem;">
                    <i class="fas fa-search-plus" style="font-size:0.85rem;"></i>
                    <span style="font-size:0.85rem; font-weight:600;">Investigation List</span>
                </div>
                <button style="background:none; border:none; color:#fff; font-size:1rem; cursor:pointer;"><i class="fas fa-plus-circle"></i></button>
            </div>
        `;
        
        const editHeaderHTML = `
            <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:0.3rem 0.5rem; display:flex; align-items:center; justify-content:space-between; margin:0.3rem; border-radius:6px;">
                <div style="display:flex; align-items:center; gap:0.35rem;">
                    <i class="fas fa-edit" style="font-size:0.85rem;"></i>
                    <span style="font-size:0.85rem; font-weight:600;">Edit Investigation - INV-2024-0025</span>
                </div>
            </div>
        `;

        return `
            <!-- Scene: Welcome -->
            <div class="demo-scene" id="scene-edit-welcome" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div style="background:#fff; border-radius:50%; width:70px; height:70px; display:flex; align-items:center; justify-content:center; margin-bottom:0.75rem; animation:bounceIn 0.5s;">
                    <i class="fas fa-edit" style="font-size:2rem; color:#10b981;"></i>
                </div>
                <h2 style="color:#fff; font-size:1.3rem; margin-bottom:0.3rem;">Edit Investigation</h2>
                <p style="color:rgba(255,255,255,0.9); font-size:0.85rem;">Learn how to modify existing investigations</p>
            </div>
            
            <!-- Scene: View List -->
            <div class="demo-scene" id="scene-edit-view-list" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${pageHeaderHTML}
                        <!-- Tabs -->
                        <div style="padding:0.15rem 0.35rem; display:flex; gap:0.2rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:600; background:#3b82f6; color:#fff; border-radius:3px;"><i class="fas fa-list" style="margin-right:0.15rem;"></i>Investigations</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:500; background:#f1f5f9; color:#64748b; border-radius:3px;"><i class="fas fa-cog" style="margin-right:0.15rem;"></i>Settings</span>
                        </div>
                        <!-- Filters -->
                        <div style="padding:0.2rem 0.35rem; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                            <div style="display:flex; gap:0.2rem; align-items:flex-end; flex-wrap:wrap;">
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Status</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Status</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Priority</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Priorities</div>
                                </div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.12rem 0.25rem; border-radius:2px; font-size:0.6rem;"><i class="fas fa-filter"></i> Apply</button>
                            </div>
                        </div>
                        <!-- Table -->
                        <div style="flex:1; padding:0.2rem 0.35rem; overflow:auto;">
                            <div style="background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.08); overflow:hidden;">
                                <table style="width:100%; border-collapse:collapse; font-size:0.7rem;">
                                    <thead style="background:#f8fafc;">
                                        <tr>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">ID</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Title</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Status</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Priority</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#1e293b; font-weight:600; border-bottom:1px solid #f1f5f9;">INV-2024-0025</td>
                                            <td style="padding:0.25rem; color:#1e293b; border-bottom:1px solid #f1f5f9;">Warehouse Forklift Incident</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">In Progress</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fee2e2; color:#dc2626; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">High</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">10 Dec 2024</td>
                                        </tr>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Chemical Spill - Lab Area</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Approved</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Medium</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">08 Dec 2024</td>
                                        </tr>
                                        <tr style="cursor:pointer;">
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0023</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Slip and Fall - Main Entrance</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dbeafe; color:#2563eb; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Closed</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Low</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">05 Dec 2024</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <!-- Mouse cursor pointing to selected investigation row (INV-2024-0025) -->
                                ${editMouseCursor('33%', '18%')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Investigation Details Modal with auto-scroll -->
            <div class="demo-scene" id="scene-edit-modal-scroll" style="display:none; height:100%; position:relative;">
                <div style="position:relative; height:100%; background:rgba(0,0,0,0.55); display:flex; align-items:flex-start; justify-content:center; padding:1.5rem 1rem; overflow:auto;">
                    <div style="background:#fff; border-radius:12px; width:100%; max-width:700px; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:visible;">
                        <!-- Print/Close buttons (absolute positioned like original) -->
                        <button style="position:absolute; top:10px; right:10px; background:#111827; color:#fff; border:none; border-radius:6px; padding:5px 8px; font-size:0.65rem; cursor:pointer; display:inline-flex; align-items:center; gap:4px; z-index:10;"><i class="fas fa-print"></i> Print / PDF</button>
                        <button style="position:absolute; top:10px; right:95px; background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:6px; padding:5px 8px; font-size:0.65rem; cursor:pointer; z-index:10;">Close</button>
                        
                        <!-- Modal Content Sheet -->
                        <div style="background:#fff; width:100%; padding:16px 20px 30px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827;">
                            <!-- Header with Company Logo and Name -->
                            <div style="display:flex; justify-content:space-between; gap:16px; margin-bottom:0; align-items:flex-start;">
                                <div style="display:flex; flex-direction:column; align-items:flex-start; gap:6px;">
                                    <div style="width:60px; height:60px; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px;">DX</div>
                                    <div>
                                        <h1 style="margin:0; font-size:0.9rem; line-height:1.2; font-weight:700;">Company Name</h1>
                                        <h2 style="font-size:0.8rem; font-weight:700; margin:2px 0 0; color:#111827; text-align:left;">Investigation Report</h2>
                                    </div>
                                </div>
                                <div style="font-size:0.55rem; color:#374151; text-align:right; line-height:1.35; min-width:100px;">
                                    <div style="font-size:0.5rem; color:#6b7280; font-weight:500;">Generated: 11 Dec 2024</div>
                                </div>
                            </div>
                            
                            <div style="height:1px; background:#e5e7eb; margin:10px 0 14px; border-radius:1px;"></div>
                            
                            <!-- Document Number -->
                            <div style="font-size:0.68rem; color:#111827; margin:5px 0 10px;">
                                <span style="font-weight:700; color:#374151; margin-right:5px;">Document Number:</span>
                                <span>INV-2024-0025</span>
                            </div>
                            
                            <!-- Scrollable Sections Container -->
                            <div data-scroll-container style="max-height:280px; overflow-y:auto;">
                                <!-- Define Section -->
                                <div style="margin-bottom:12px;">
                                    <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:6px 10px; border-radius:5px 5px 0 0; display:flex; align-items:center; gap:6px;">
                                        <i class="fas fa-clipboard-list" style="font-size:0.7rem;"></i>
                                        <span style="font-size:0.75rem; font-weight:600;">Define - Incident Information</span>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 5px 5px; padding:8px;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:0.68rem;">
                                            <div><span style="color:#64748b;">Reference:</span> <strong>INV-2024-0025</strong></div>
                                            <div><span style="color:#64748b;">Title:</span> <strong>Warehouse Forklift Incident</strong></div>
                                            <div><span style="color:#64748b;">Status:</span> <span style="background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:3px; font-size:0.6rem;">In Progress</span></div>
                                            <div><span style="color:#64748b;">Priority:</span> <span style="background:#fee2e2; color:#dc2626; padding:2px 6px; border-radius:3px; font-size:0.6rem;">High</span></div>
                                            <div><span style="color:#64748b;">Incident Date:</span> <strong>10 Dec 2024</strong></div>
                                            <div><span style="color:#64748b;">Reported Date:</span> <strong>10 Dec 2024</strong></div>
                                            <div><span style="color:#64748b;">Location:</span> <strong>Warehouse B - Zone 3</strong></div>
                                            <div><span style="color:#64748b;">Department:</span> <strong>Operations</strong></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Measure Section -->
                                <div style="margin-bottom:12px;">
                                    <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:6px 10px; border-radius:5px 5px 0 0; display:flex; align-items:center; gap:6px;">
                                        <i class="fas fa-chart-bar" style="font-size:0.7rem;"></i>
                                        <span style="font-size:0.75rem; font-weight:600;">Measure - Data Collection & Analysis</span>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 5px 5px; padding:8px;">
                                        <table style="width:100%; border-collapse:collapse; font-size:0.65rem;">
                                            <tbody>
                                                <tr><td style="padding:3px 6px; color:#64748b; width:40%;">Severity (Actual)</td><td style="padding:3px 6px;"><span style="background:#fee2e2; color:#dc2626; padding:1px 4px; border-radius:2px;">Major</span></td></tr>
                                                <tr><td style="padding:3px 6px; color:#64748b;">Potential Severity</td><td style="padding:3px 6px;"><span style="background:#fee2e2; color:#dc2626; padding:1px 4px; border-radius:2px;">Catastrophic</span></td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Analyze Section -->
                                <div style="margin-bottom:12px;">
                                    <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:6px 10px; border-radius:5px 5px 0 0; display:flex; align-items:center; gap:6px;">
                                        <i class="fas fa-search" style="font-size:0.7rem;"></i>
                                        <span style="font-size:0.75rem; font-weight:600;">Analyze - Root Cause Analysis</span>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 5px 5px; padding:8px;">
                                        <table style="width:100%; border-collapse:collapse; font-size:0.65rem;">
                                            <tbody>
                                                <tr><td style="padding:3px 6px; color:#64748b; width:40%;">Contributing Factors</td><td style="padding:3px 6px;">Poor visibility, Time pressure</td></tr>
                                                <tr><td style="padding:3px 6px; color:#64748b;">Failed Defenses</td><td style="padding:3px 6px;">Inadequate training procedures</td></tr>
                                                <tr><td style="padding:3px 6px; color:#64748b;">Organisational Factors</td><td style="padding:3px 6px;">Resource constraints</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Improve Section -->
                                <div style="margin-bottom:12px;">
                                    <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:6px 10px; border-radius:5px 5px 0 0; display:flex; align-items:center; gap:6px;">
                                        <i class="fas fa-tools" style="font-size:0.7rem;"></i>
                                        <span style="font-size:0.75rem; font-weight:600;">Improve - Corrective Actions</span>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 5px 5px; padding:8px;">
                                        <table style="width:100%; border-collapse:collapse; font-size:0.65rem;">
                                            <tbody>
                                                <tr><td style="padding:3px 6px; color:#64748b; width:40%;">Action 1</td><td style="padding:3px 6px;">Install LED lighting <span style="background:#dcfce7; color:#16a34a; padding:1px 4px; border-radius:2px; font-size:0.55rem;">Completed</span></td></tr>
                                                <tr><td style="padding:3px 6px; color:#64748b;">Action 2</td><td style="padding:3px 6px;">Refresher training <span style="background:#fef3c7; color:#d97706; padding:1px 4px; border-radius:2px; font-size:0.55rem;">In Progress</span></td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Control Section -->
                                <div style="margin-bottom:12px;">
                                    <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:6px 10px; border-radius:5px 5px 0 0; display:flex; align-items:center; gap:6px;">
                                        <i class="fas fa-check-circle" style="font-size:0.7rem;"></i>
                                        <span style="font-size:0.75rem; font-weight:600;">Control - Verification & Lessons Learned</span>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 5px 5px; padding:8px;">
                                        <table style="width:100%; border-collapse:collapse; font-size:0.65rem;">
                                            <tbody>
                                                <tr><td style="padding:3px 6px; color:#64748b; width:40%;">Verification Status</td><td style="padding:3px 6px;">Pending verification</td></tr>
                                                <tr><td style="padding:3px 6px; color:#64748b;">Lessons Learned</td><td style="padding:3px 6px;">Regular safety audits required</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Approval Flow Section -->
                                <div style="margin-bottom:12px;">
                                    <div style="background:linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:6px 10px; border-radius:5px 5px 0 0; display:flex; align-items:center; gap:6px;">
                                        <i class="fas fa-stamp" style="font-size:0.7rem;"></i>
                                        <span style="font-size:0.75rem; font-weight:600;">Approval Flow</span>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-top:none; border-radius:0 0 5px 5px; padding:8px;">
                                        <div style="display:flex; gap:8px; font-size:0.6rem;">
                                            <div style="flex:1; background:#dcfce7; border:1px solid #86efac; border-radius:4px; padding:6px; text-align:center;">
                                                <div style="color:#16a34a; font-weight:600;"><i class="fas fa-check"></i> Level 1</div>
                                                <div style="color:#166534; font-size:0.55rem;">Approved</div>
                                            </div>
                                            <div style="flex:1; background:#fef3c7; border:1px solid #fcd34d; border-radius:4px; padding:6px; text-align:center;">
                                                <div style="color:#d97706; font-weight:600;"><i class="fas fa-clock"></i> Level 2</div>
                                                <div style="color:#92400e; font-size:0.55rem;">Pending</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Approval Actions (inside scroll container so it scrolls into view) -->
                                <div style="padding-top:10px; border-top:1px solid #e2e8f0; margin-top:10px; padding-bottom:20px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                                        <div style="display:flex; align-items:center; gap:6px; position:relative;">
                                            <button class="demo-edit-btn" style="background:#1f2937; color:#fff; border:none; font-size:0.65rem; padding:5px 10px; border-radius:6px; cursor:pointer; animation:highlightPulse 1s infinite; box-shadow:0 0 12px rgba(31,41,55,0.5);"><i class="fas fa-edit"></i> Edit</button>
                                            <button style="background:#dc2626; color:#fff; border:none; font-size:0.65rem; padding:5px 10px; border-radius:6px; cursor:pointer; opacity:0.6;"><i class="fas fa-trash"></i> Delete</button>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <button style="background:#ef4444; color:#fff; border:none; font-size:0.65rem; padding:5px 10px; border-radius:6px; cursor:pointer; opacity:0.6;"><i class="fas fa-times"></i> Decline</button>
                                            <button style="background:#10b981; color:#fff; border:none; font-size:0.65rem; padding:5px 10px; border-radius:6px; cursor:pointer; opacity:0.6;"><i class="fas fa-check"></i> Approve</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Info message bar -->
                        <div class="demo-info-bar" style="padding:8px 12px; background:#dbeafe; border-top:1px solid #93c5fd; border-radius:0 0 12px 12px;">
                            <p style="margin:0; font-size:0.75rem; color:#1e40af; text-align:center;"><i class="fas fa-eye" style="margin-right:4px;"></i><strong>Viewing all sections...</strong></p>
                        </div>
                    </div>
                </div>
                <!-- Mouse cursor that will animate to Edit button -->
                ${editMouseCursor('28%', '48%')}
            </div>
            
            <!-- Scene: Edit Form Opens -->
            <div class="demo-scene" id="scene-edit-form-opens" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <!-- DMAIC Tabs -->
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <!-- Form Content - Full Define Tab Fields -->
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Introduction Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-info-circle" style="color:#3b82f6;"></i> Introduction
                                    <span style="margin-left:auto; background:#10b981; color:#fff; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;">Edit Mode</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Investigation Title *</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Warehouse Forklift Incident</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Reference Number</label>
                                            <div style="border:1px solid #e2e8f0; background:#f1f5f9; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#64748b;">INV-2024-0025</div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Purpose of Investigation</label>
                                        <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Investigate root cause of forklift collision</div>
                                    </div>
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Investigation Scope</label>
                                        <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Warehouse B operations area and forklift procedures</div>
                                    </div>
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Investigation Methodology</label>
                                        <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">ICAM methodology with interviews and CCTV review</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Incident Summary Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-file-alt" style="color:#f59e0b;"></i> Incident Summary
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Incident Date *</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">10 Dec 2024 14:30</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Reported Date *</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">10 Dec 2024 15:00</div>
                                        </div>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Location *</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Warehouse B - Zone 3</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Business Unit / Department</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Operations</div>
                                        </div>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Incident Type *</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Property Damage</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Severity (Actual)</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;"><span style="background:#dc2626; color:#fff; padding:0.03rem 0.1rem; border-radius:2px; font-size:0.5rem;">Major</span></div>
                                        </div>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Potential Severity</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;"><span style="background:#dc2626; color:#fff; padding:0.03rem 0.1rem; border-radius:2px; font-size:0.5rem;">Catastrophic</span></div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Likelihood (Pre-incident)</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Possible</div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Incident Description *</label>
                                        <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b; min-height:1.5rem;">Forklift operator collided with storage rack while reversing in aisle B-7. Equipment damage to forklift front guard and rack support beam.</div>
                                    </div>
                                    <div>
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Immediate Actions Taken</label>
                                        <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Area cordoned off, first aid administered, supervisor notified</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Equipment Involved Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-tools" style="color:#8b5cf6;"></i> Equipment Involved
                                    <button style="margin-left:auto; background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-plus"></i></button>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#f0fdf4; border:1px solid #22c55e; border-radius:3px; padding:0.15rem; margin-bottom:0.15rem;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:0.15rem; font-size:0.55rem;">
                                            <div><span style="color:#64748b;">Name:</span> <strong>Forklift FLT-204</strong></div>
                                            <div><span style="color:#64748b;">ID/Serial:</span> <strong>SN-78432</strong></div>
                                            <div><span style="color:#64748b;">Type:</span> <strong>Material Handling</strong></div>
                                            <div><span style="color:#64748b;">Condition:</span> <span style="background:#dc2626; color:#fff; padding:0.02rem 0.08rem; border-radius:2px;">Damaged</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- People Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-users" style="color:#22c55e;"></i> People
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- Persons Involved -->
                                    <div style="margin-bottom:0.2rem;">
                                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.1rem;">
                                            <span style="font-size:0.6rem; font-weight:600; color:#374151;">Persons Involved</span>
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-user-plus"></i> Add</button>
                                        </div>
                                        <div style="background:#f0fdf4; border:1px solid #22c55e; border-radius:3px; padding:0.15rem;">
                                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:0.15rem; font-size:0.55rem;">
                                                <div><span style="color:#64748b;">Name:</span> <strong>James Wilson</strong></div>
                                                <div><span style="color:#64748b;">Company:</span> <strong>ABC Logistics</strong></div>
                                                <div><span style="color:#64748b;">Job Title:</span> <strong>Forklift Operator</strong></div>
                                                <div><span style="color:#64748b;">Phone:</span> <strong>+971 50 123 4567</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Investigation Team -->
                                    <div>
                                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.1rem;">
                                            <span style="font-size:0.6rem; font-weight:600; color:#374151;">Investigation Team</span>
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-user-plus"></i> Add</button>
                                        </div>
                                        <div style="background:#f0fdf4; border:1px solid #22c55e; border-radius:3px; padding:0.15rem;">
                                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.15rem; font-size:0.55rem;">
                                                <div><span style="color:#64748b;">Employee:</span> <strong>John Smith (HSE Manager)</strong></div>
                                                <div><span style="color:#64748b;">Role:</span> <strong>Lead Investigator</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Footer -->
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Define Tab Scroll - Shows all editable fields -->
            <div class="demo-scene" id="scene-edit-define-scroll" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Introduction Section with highlighted editable fields -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-info-circle" style="color:#3b82f6;"></i> Introduction
                                    <span style="margin-left:auto; background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Investigation Title *</label>
                                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Warehouse Forklift Incident</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Reference Number</label>
                                            <div style="border:1px solid #e2e8f0; background:#f1f5f9; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#64748b;">INV-2024-0025</div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Purpose of Investigation</label>
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Investigate root cause of forklift collision</div>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Scope</label>
                                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Warehouse B operations, forklift procedures</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Methodology</label>
                                            <div style="border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">ICAM Investigation</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Incident Summary Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-exclamation-triangle" style="color:#f59e0b;"></i> Incident Summary
                                    <span style="margin-left:auto; background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Incident Date</label>
                                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">10 Dec 2024</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Reported Date</label>
                                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">10 Dec 2024</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Location</label>
                                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Warehouse B</div>
                                        </div>
                                        <div>
                                            <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Department</label>
                                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Logistics</div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Description</label>
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b; min-height:1.5rem;">Forklift operator collided with storage rack while reversing...</div>
                                    </div>
                                    <div>
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Immediate Actions Taken</label>
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.15rem; font-size:0.65rem; color:#1e293b;">Area cordoned off, forklift removed from service</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Equipment Involved Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-tools" style="color:#6366f1;"></i> Equipment Involved
                                        <span style="background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                    </div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem; margin-bottom:0.15rem;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.15rem; font-size:0.55rem;">
                                            <div><span style="color:#64748b;">Type:</span> <strong>Forklift</strong></div>
                                            <div><span style="color:#64748b;">ID:</span> <strong>FL-2847</strong></div>
                                            <div><span style="color:#64748b;">Condition:</span> <strong style="color:#f59e0b;">Damaged</strong></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- People Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-users" style="color:#8b5cf6;"></i> People
                                    <span style="margin-left:auto; background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="margin-bottom:0.2rem;">
                                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.1rem;">
                                            <span style="font-size:0.6rem; font-weight:600; color:#374151;">Persons Involved</span>
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-user-plus"></i> Add</button>
                                        </div>
                                        <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem;">
                                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.15rem; font-size:0.55rem;">
                                                <div><span style="color:#64748b;">Name:</span> <strong>James Wilson</strong></div>
                                                <div><span style="color:#64748b;">Role:</span> <strong>Forklift Operator</strong></div>
                                                <div><span style="color:#64748b;">Injury:</span> <strong style="color:#22c55e;">None</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.1rem;">
                                            <span style="font-size:0.6rem; font-weight:600; color:#374151;">Investigation Team</span>
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-user-plus"></i> Add</button>
                                        </div>
                                        <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem;">
                                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.15rem; font-size:0.55rem;">
                                                <div><span style="color:#64748b;">Employee:</span> <strong>John Smith (HSE Manager)</strong></div>
                                                <div><span style="color:#64748b;">Role:</span> <strong>Lead Investigator</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Switch to Measure Tab -->
            <div class="demo-scene" id="scene-edit-switch-measure" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('22%', '24%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px; animation:highlightPulse 1s infinite;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- People Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">People Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                Operator fatigue
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Insufficient training
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                Camera malfunction
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Worn tires
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Environment Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Environment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                Poor lighting
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Cluttered floor
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Procedure Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Procedure Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                No spotter required
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Organization Factors -->
                                    <div>
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Organization Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                High pressure
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Understaffed shift
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Measure Tab Scroll - Shows all editable fields -->
            <div class="demo-scene" id="scene-edit-measure-scroll" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- PEEPO Analysis Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis
                                    <span style="margin-left:auto; background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- People Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">People Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                Operator fatigue
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Insufficient training
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                Camera malfunction
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Worn tires
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Environment Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Environment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                Poor lighting
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Cluttered floor
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Procedure Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Procedure Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                No spotter required
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Organization Factors -->
                                    <div>
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.1rem;">Organization Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#dc2626; margin-right:0.15rem;"></span>
                                                High pressure
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                            <span style="display:inline-flex; align-items:center; background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.55rem;">
                                                <span style="width:5px; height:5px; border-radius:50%; background:#f59e0b; margin-right:0.15rem;"></span>
                                                Understaffed shift
                                                <span style="margin-left:0.2rem; font-weight:700; cursor:pointer;">×</span>
                                            </span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.2rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.55rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Location/Map Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-map-marker-alt" style="color:#ef4444;"></i> Incident Location
                                    <span style="margin-left:auto; background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; height:2rem; display:flex; align-items:center; justify-content:center; font-size:0.6rem; color:#64748b;">
                                        <i class="fas fa-map"></i> Location Map - Click to update coordinates
                                    </div>
                                </div>
                            </div>
                            <!-- Evidence & Photos Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-images" style="color:#0ea5e9;"></i> Photos & Evidence
                                        <span style="background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                    </div>
                                    <button style="background:#fff; color:#374151; border:1px solid #d1d5db; padding:0.08rem 0.15rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                </div>
                                <div style="padding:0.2rem;">
                                    <!-- Evidence Table -->
                                    <table style="width:100%; border-collapse:collapse; font-size:0.5rem;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.1rem; text-align:left; border-bottom:1px solid #e5e7eb; width:15%;">Preview</th>
                                                <th style="padding:0.1rem; text-align:left; border-bottom:1px solid #e5e7eb;">File Name</th>
                                                <th style="padding:0.1rem; text-align:left; border-bottom:1px solid #e5e7eb; width:18%;">Type</th>
                                                <th style="padding:0.1rem; text-align:left; border-bottom:1px solid #e5e7eb; width:15%;">Size</th>
                                                <th style="padding:0.1rem; text-align:center; border-bottom:1px solid #e5e7eb; width:15%;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding:0.1rem;"><div style="width:1.2rem; height:0.9rem; background:#f1f5f9; border-radius:2px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-image" style="font-size:0.4rem; color:#94a3b8;"></i></div></td>
                                                <td style="padding:0.1rem; color:#374151;">forklift_damage.jpg</td>
                                                <td style="padding:0.1rem; color:#64748b;">Image</td>
                                                <td style="padding:0.1rem; color:#64748b;">245 KB</td>
                                                <td style="padding:0.1rem; text-align:center;"><button style="background:none; border:none; color:#3b82f6; font-size:0.45rem; cursor:pointer; margin-right:0.1rem;"><i class="fas fa-eye"></i></button><button style="background:none; border:none; color:#dc2626; font-size:0.45rem; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr>
                                                <td style="padding:0.1rem;"><div style="width:1.2rem; height:0.9rem; background:#f1f5f9; border-radius:2px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-image" style="font-size:0.4rem; color:#94a3b8;"></i></div></td>
                                                <td style="padding:0.1rem; color:#374151;">scene_photo.png</td>
                                                <td style="padding:0.1rem; color:#64748b;">Image</td>
                                                <td style="padding:0.1rem; color:#64748b;">512 KB</td>
                                                <td style="padding:0.1rem; text-align:center;"><button style="background:none; border:none; color:#3b82f6; font-size:0.45rem; cursor:pointer; margin-right:0.1rem;"><i class="fas fa-eye"></i></button><button style="background:none; border:none; color:#dc2626; font-size:0.45rem; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- Timeline Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-clock" style="color:#10b981;"></i> Timeline
                                        <span style="background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                    </div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.08rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i> Add Event</button>
                                </div>
                                <div style="padding:0.2rem;">
                                    <!-- Timeline Event 1 -->
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem; align-items:center;">
                                        <input type="text" value="2024-12-10 08:30" style="width:2.5rem; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                        <input type="text" value="Shift Start" placeholder="Title" style="flex:1; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                        <input type="text" value="Operator began shift" placeholder="Description" style="flex:2; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                        <button style="background:#dcfce7; color:#059669; border:none; padding:0.08rem 0.12rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-save"></i></button>
                                        <button style="background:#fee2e2; color:#dc2626; border:none; padding:0.08rem 0.12rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-trash"></i></button>
                                    </div>
                                    <!-- Timeline Event 2 -->
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem; align-items:center;">
                                        <input type="text" value="2024-12-10 10:45" style="width:2.5rem; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                        <input type="text" value="Collision" placeholder="Title" style="flex:1; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                        <input type="text" value="Forklift struck racking" placeholder="Description" style="flex:2; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                        <button style="background:#dcfce7; color:#059669; border:none; padding:0.08rem 0.12rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-save"></i></button>
                                        <button style="background:#fee2e2; color:#dc2626; border:none; padding:0.08rem 0.12rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-trash"></i></button>
                                    </div>
                                    <!-- Timeline Visualization -->
                                    <div style="margin-top:0.2rem; padding:0.15rem; background:#f8fafc; border-radius:3px;">
                                        <div style="font-size:0.45rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Timeline Visualization</div>
                                        <div style="display:flex; align-items:center; gap:0.3rem; position:relative;">
                                            <div style="text-align:center;">
                                                <div style="width:0.6rem; height:0.6rem; background:linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius:50%;"></div>
                                                <div style="font-size:0.35rem; color:#64748b; margin-top:0.05rem;">08:30</div>
                                                <div style="font-size:0.35rem; color:#374151;">Start</div>
                                            </div>
                                            <div style="flex:1; height:2px; background:linear-gradient(90deg, #3b82f6, #8b5cf6);"></div>
                                            <div style="text-align:center;">
                                                <div style="width:0.6rem; height:0.6rem; background:linear-gradient(135deg, #ef4444, #dc2626); border-radius:50%;"></div>
                                                <div style="font-size:0.35rem; color:#64748b; margin-top:0.05rem;">10:45</div>
                                                <div style="font-size:0.35rem; color:#374151;">Collision</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Witness Statements Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-user-friends" style="color:#6366f1;"></i> Witness Statements
                                        <span style="background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                    </div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem; font-size:0.55rem;">
                                        <strong>Mike Thompson</strong> (Witness) - "I saw the forklift reversing..."
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update PEEPO Analysis -->
            <div class="demo-scene" id="scene-edit-update-peepo" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('45%', '50%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Section Control Buttons -->
                            <div style="display:flex; gap:0.15rem; margin-bottom:0.3rem; justify-content:flex-end;">
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-expand-alt"></i> Expand All</button>
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                            </div>
                            <!-- PEEPO Analysis Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="font-size:0.7rem; font-weight:600; color:#374151; margin-bottom:0.25rem; padding-bottom:0.15rem; border-bottom:2px solid #e5e7eb; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> Peepo Analysis
                                    <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.5rem; color:#9ca3af;"></i>
                                </div>
                                <div style="padding:0.2rem 0;">
                                    <!-- People Factors - HIGHLIGHTED for editing -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">People Factors</label>
                                        <!-- Tags Container with highlight -->
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; padding:0.15rem; animation:highlightPulse 1s infinite;">
                                            <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                                <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Operator fatigue <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Insufficient training <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#dcfce7; color:#166534; border:2px solid #22c55e; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus-circle" style="margin-right:0.1rem; font-size:0.4rem;"></i>Rushed to meet deadline (NEW) <button style="margin-left:0.15rem; background:transparent; border:none; color:#166534; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            </div>
                                            <!-- Tag Input Row -->
                                            <div style="display:flex; gap:0.1rem; align-items:center;">
                                                <input type="text" placeholder="Add element" value="Rushed to meet deadline" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Reverse camera malfunction <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Worn tires <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Environmental Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Environmental Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Poor lighting <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Cluttered floor <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Procedures -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Procedures</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">No spotter required <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Organization -->
                                    <div>
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Organization</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">High production pressure <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Understaffed shift <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Equipment Factors (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-equipment-factors" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('45%', '45%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Section Control Buttons -->
                            <div style="display:flex; gap:0.15rem; margin-bottom:0.3rem; justify-content:flex-end;">
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-expand-alt"></i> Expand All</button>
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                            </div>
                            <!-- PEEPO Analysis Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="font-size:0.7rem; font-weight:600; color:#374151; margin-bottom:0.25rem; padding-bottom:0.15rem; border-bottom:2px solid #e5e7eb; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> Peepo Analysis
                                    <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.5rem; color:#9ca3af;"></i>
                                </div>
                                <div style="padding:0.2rem 0;">
                                    <!-- People Factors - Updated -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">People Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Operator fatigue <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Insufficient training <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Rushed to meet deadline <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors - HIGHLIGHTED for editing -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; padding:0.15rem; animation:highlightPulse 1s infinite;">
                                            <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                                <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Reverse camera malfunction <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Worn tires <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#dcfce7; color:#166534; border:2px solid #22c55e; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus-circle" style="margin-right:0.1rem; font-size:0.4rem;"></i>Hydraulic leak (NEW) <button style="margin-left:0.15rem; background:transparent; border:none; color:#166534; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            </div>
                                            <div style="display:flex; gap:0.1rem; align-items:center;">
                                                <input type="text" placeholder="Add element" value="Hydraulic leak" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Environmental Factors -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Environmental Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Poor lighting <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Cluttered floor <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Procedures -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Procedures</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">No spotter required <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Organization -->
                                    <div>
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Organization</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">High production pressure <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Understaffed shift <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Environment Factors (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-environment-factors" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('45%', '52%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Section Control Buttons -->
                            <div style="display:flex; gap:0.15rem; margin-bottom:0.3rem; justify-content:flex-end;">
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-expand-alt"></i> Expand All</button>
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                            </div>
                            <!-- PEEPO Analysis Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="font-size:0.7rem; font-weight:600; color:#374151; margin-bottom:0.25rem; padding-bottom:0.15rem; border-bottom:2px solid #e5e7eb; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> Peepo Analysis
                                    <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.5rem; color:#9ca3af;"></i>
                                </div>
                                <div style="padding:0.2rem 0;">
                                    <!-- People Factors - Updated -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">People Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Operator fatigue <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Insufficient training <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Rushed to meet deadline <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors - Updated -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Reverse camera malfunction <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Worn tires <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Hydraulic leak <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Environmental Factors - HIGHLIGHTED for editing -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Environmental Factors</label>
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; padding:0.15rem; animation:highlightPulse 1s infinite;">
                                            <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                                <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Poor lighting <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Cluttered floor <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#dcfce7; color:#166534; border:2px solid #22c55e; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus-circle" style="margin-right:0.1rem; font-size:0.4rem;"></i>Oil spill (NEW) <button style="margin-left:0.15rem; background:transparent; border:none; color:#166534; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            </div>
                                            <div style="display:flex; gap:0.1rem; align-items:center;">
                                                <input type="text" placeholder="Add element" value="Oil spill" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Procedures -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Procedures</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">No spotter required <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Organization -->
                                    <div>
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Organization</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">High production pressure <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Understaffed shift <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Procedure Factors (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-procedure-factors" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('45%', '60%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Section Control Buttons -->
                            <div style="display:flex; gap:0.15rem; margin-bottom:0.3rem; justify-content:flex-end;">
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-expand-alt"></i> Expand All</button>
                                <button style="padding:0.1rem 0.2rem; font-size:0.5rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:3px;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                            </div>
                            <!-- PEEPO Analysis Section -->
                            <div style="margin-bottom:0.4rem;">
                                <div style="font-size:0.7rem; font-weight:600; color:#374151; margin-bottom:0.25rem; padding-bottom:0.15rem; border-bottom:2px solid #e5e7eb; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> Peepo Analysis
                                    <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.5rem; color:#9ca3af;"></i>
                                </div>
                                <div style="padding:0.2rem 0;">
                                    <!-- People Factors - Updated -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">People Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Operator fatigue <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Insufficient training <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Rushed to meet deadline <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors - Updated -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Equipment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Reverse camera malfunction <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Worn tires <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Hydraulic leak <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Environmental Factors - Updated -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Environmental Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;"><span style="width:4px; height:4px; background:#dc2626; border-radius:50%; margin-right:0.1rem;"></span>Poor lighting <button style="margin-left:0.15rem; background:transparent; border:none; color:#dc2626; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Cluttered floor <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Oil spill <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <!-- Procedures - HIGHLIGHTED for editing -->
                                    <div style="margin-bottom:0.25rem;">
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Procedures</label>
                                        <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; padding:0.15rem; animation:highlightPulse 1s infinite;">
                                            <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                                <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">No spotter required <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#dcfce7; color:#166534; border:2px solid #22c55e; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus-circle" style="margin-right:0.1rem; font-size:0.4rem;"></i>SOP outdated (NEW) <button style="margin-left:0.15rem; background:transparent; border:none; color:#166534; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                                <span style="display:inline-flex; align-items:center; background:#dcfce7; color:#166534; border:2px solid #22c55e; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus-circle" style="margin-right:0.1rem; font-size:0.4rem;"></i>No checklist (NEW) <button style="margin-left:0.15rem; background:transparent; border:none; color:#166534; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            </div>
                                            <div style="display:flex; gap:0.1rem; align-items:center;">
                                                <input type="text" placeholder="Add element" value="SOP outdated" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Organization -->
                                    <div>
                                        <label style="font-size:0.55rem; font-weight:600; color:#374151; display:block; margin-bottom:0.1rem;">Organization</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.1rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">High production pressure <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.08rem 0.25rem; font-size:0.5rem;">Understaffed shift <button style="margin-left:0.15rem; background:transparent; border:none; color:#0ea5e9; cursor:pointer; font-weight:700; font-size:0.5rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.1rem; align-items:center;">
                                            <input type="text" placeholder="Add element" style="flex:1; padding:0.1rem 0.15rem; font-size:0.5rem; border:1px solid #d1d5db; border-radius:3px;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Organization Factors (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-organization-factors" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('45%', '68%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- People Factors - Completed with tags -->
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;"><i class="fas fa-users" style="color:#3b82f6; margin-right:0.15rem;"></i>People Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.08rem; border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.12rem;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Operator fatigue (10hr shift) <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Insufficient training <button style="background:none; border:none; color:#991b1b; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Rushed to meet deadline <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                        </div>
                                    </div>
                                    <!-- Equipment Factors - Completed with tags -->
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;"><i class="fas fa-cogs" style="color:#f59e0b; margin-right:0.15rem;"></i>Equipment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.08rem; border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.12rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Reverse camera inoperative <button style="background:none; border:none; color:#991b1b; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Worn tires <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Hydraulic leak <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                        </div>
                                    </div>
                                    <!-- Environment Factors - Completed with tags -->
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;"><i class="fas fa-cloud-sun" style="color:#10b981; margin-right:0.15rem;"></i>Environment Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.08rem; border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.12rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Lighting at 50 lux <button style="background:none; border:none; color:#991b1b; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Oil spill on floor <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Pallets obstructing visibility <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                        </div>
                                    </div>
                                    <!-- Procedure Factors - Completed with tags -->
                                    <div style="margin-bottom:0.2rem;">
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;"><i class="fas fa-clipboard-list" style="color:#8b5cf6; margin-right:0.15rem;"></i>Procedure Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.08rem; border:1px solid #22c55e; background:#f0fdf4; border-radius:3px; padding:0.12rem;">
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">SOP outdated (2019) <button style="background:none; border:none; color:#991b1b; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">No pre-shift checklist <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">No zone marking <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                        </div>
                                    </div>
                                    <!-- Organization Factors - HIGHLIGHTED with animation -->
                                    <div>
                                        <label style="font-size:0.6rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;"><i class="fas fa-building" style="color:#ec4899; margin-right:0.15rem;"></i>Organization Factors</label>
                                        <div style="display:flex; flex-wrap:wrap; gap:0.15rem; margin-bottom:0.08rem; border:2px solid #fbbf24; background:#fffbeb; border-radius:3px; padding:0.12rem; animation:highlightPulse 1s infinite;">
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">High production pressure <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem;">Understaffed shift <button style="background:none; border:none; color:#0369a1; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                            <span style="display:inline-flex; align-items:center; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.06rem 0.2rem; font-size:0.45rem; animation:tagAdded 0.5s ease;">Budget cuts 15% <button style="background:none; border:none; color:#991b1b; cursor:pointer; padding:0 0.1rem; font-size:0.4rem; margin-left:0.1rem;">Ã—</button></span>
                                        </div>
                                        <div style="display:flex; gap:0.15rem; align-items:center;">
                                            <input type="text" value="Safety training backlog" style="flex:1; border:1px solid #fbbf24; border-radius:3px; padding:0.08rem 0.15rem; font-size:0.5rem; background:#fff;">
                                            <button style="background:#3b82f6; color:#fff; border:none; border-radius:3px; padding:0.08rem 0.15rem; font-size:0.5rem; cursor:pointer;">+</button>
                                            <label style="font-size:0.45rem; color:#64748b; display:flex; align-items:center; gap:0.1rem;"><input type="checkbox" style="width:0.5rem; height:0.5rem;"> Contributing</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Incident Location Map (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-location-map" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('55%', '55%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- PEEPO Analysis - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Incident Location Map - HIGHLIGHTED with collapsible header -->
                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; margin-bottom:0.3rem; animation:highlightPulse 1s infinite;">
                                <div style="padding:0.2rem 0.3rem; background:#fef3c7; border-bottom:1px solid #fbbf24; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-map-marker-alt" style="color:#ef4444;"></i> Incident Location Map</span>
                                    <i class="fas fa-chevron-down" style="color:#64748b; font-size:0.6rem;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- Form Grid matching original design -->
                                    <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:0.2rem; margin-bottom:0.2rem;">
                                        <div>
                                            <label style="font-size:0.55rem; color:#64748b; display:block; margin-bottom:0.05rem;">Latitude</label>
                                            <input type="text" value="25.278542" style="width:100%; border:2px solid #fbbf24; background:#fff; border-radius:3px; padding:0.1rem 0.15rem; font-size:0.55rem; box-sizing:border-box;">
                                        </div>
                                        <div>
                                            <label style="font-size:0.55rem; color:#64748b; display:block; margin-bottom:0.05rem;">Longitude</label>
                                            <input type="text" value="55.297831" style="width:100%; border:2px solid #fbbf24; background:#fff; border-radius:3px; padding:0.1rem 0.15rem; font-size:0.55rem; box-sizing:border-box;">
                                        </div>
                                        <div style="display:flex; align-items:flex-end; gap:0.1rem;">
                                            <button style="background:#3b82f6; color:#fff; border:none; padding:0.12rem 0.2rem; border-radius:3px; font-size:0.5rem; white-space:nowrap;"><i class="fas fa-sync-alt"></i> Update Map</button>
                                            <button style="background:#fff; color:#3b82f6; border:1px solid #3b82f6; padding:0.12rem 0.2rem; border-radius:3px; font-size:0.5rem; white-space:nowrap;"><i class="fas fa-crosshairs"></i> Use Current</button>
                                        </div>
                                    </div>
                                    <!-- Map Container matching original design -->
                                    <div style="height:70px; background:#f8fafc; border-radius:4px; border:1px solid #e5e7eb; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;">
                                        <!-- Simulated map background -->
                                        <div style="position:absolute; inset:0; background:linear-gradient(135deg, #dbeafe 0%, #e0f2fe 50%, #f0f9ff 100%);"></div>
                                        <div style="position:absolute; inset:0; opacity:0.15;">
                                            <div style="position:absolute; top:20%; left:10%; width:40%; height:2px; background:#94a3b8;"></div>
                                            <div style="position:absolute; top:50%; left:5%; width:60%; height:2px; background:#94a3b8;"></div>
                                            <div style="position:absolute; top:80%; left:15%; width:50%; height:2px; background:#94a3b8;"></div>
                                            <div style="position:absolute; top:10%; left:30%; width:2px; height:60%; background:#94a3b8;"></div>
                                            <div style="position:absolute; top:20%; left:60%; width:2px; height:50%; background:#94a3b8;"></div>
                                        </div>
                                        <!-- Marker with animation -->
                                        <div style="z-index:2; display:flex; flex-direction:column; align-items:center;">
                                            <i class="fas fa-map-marker-alt" style="color:#ef4444; font-size:1.4rem; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2)); animation:bounce 1s infinite;"></i>
                                            <div style="width:8px; height:4px; background:rgba(0,0,0,0.2); border-radius:50%; margin-top:-2px;"></div>
                                        </div>
                                        <span style="position:absolute; bottom:3px; left:5px; font-size:0.4rem; color:#64748b; background:rgba(255,255,255,0.8); padding:0.05rem 0.1rem; border-radius:2px;">Â© OpenStreetMap</span>
                                        <span style="position:absolute; top:3px; right:5px; font-size:0.4rem; color:#1e293b; background:rgba(255,255,255,0.9); padding:0.05rem 0.15rem; border-radius:2px; font-weight:600;">Warehouse B-7</span>
                                    </div>
                                    <p style="font-size:0.5rem; color:#10b981; margin-top:0.1rem;"><i class="fas fa-check-circle"></i> Coordinates updated: 25.278542, 55.297831 (Warehouse B-7 Location)</p>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>            <!-- Scene: Update Photos & Evidence (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-photos-evidence" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('60%', '58%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- PEEPO Analysis - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Location Map - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-map-marker-alt" style="color:#ef4444;"></i> Incident Location Map</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Photos & Evidence - HIGHLIGHTED with collapsible header -->
                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; margin-bottom:0.3rem; animation:highlightPulse 1s infinite;">
                                <div style="padding:0.2rem 0.3rem; background:#fef3c7; border-bottom:1px solid #fbbf24; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-images" style="color:#8b5cf6;"></i> Photos & Evidence</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;">
                                        <button style="background:#fff; color:#3b82f6; border:1px solid #3b82f6; padding:0.08rem 0.15rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                        <i class="fas fa-chevron-down" style="color:#64748b; font-size:0.6rem;"></i>
                                    </span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- statements-table style from original -->
                                    <table style="width:100%; font-size:0.5rem; border-collapse:collapse; border:1px solid #e5e7eb; border-radius:4px;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151; width:25px;">Preview</th>
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151;">File Name</th>
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151; width:40px;">Type</th>
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151; width:35px;">Size</th>
                                                <th style="padding:0.12rem; text-align:center; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151; width:45px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="transition:background 0.2s;">
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0;"><div style="width:22px; height:22px; background:#dbeafe; border-radius:3px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-image" style="font-size:0.55rem; color:#3b82f6;"></i></div></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#1e293b;">rack_damage_01.jpg</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0;"><span style="background:#dbeafe; color:#1d4ed8; padding:0.04rem 0.12rem; border-radius:3px; font-size:0.45rem;">Image</span></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#64748b;">2.4 MB</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; text-align:center;"><i class="fas fa-eye" style="color:#3b82f6; margin-right:0.15rem; cursor:pointer;"></i><i class="fas fa-trash" style="color:#ef4444; cursor:pointer;"></i></td>
                                            </tr>
                                            <tr style="transition:background 0.2s;">
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0;"><div style="width:22px; height:22px; background:#dbeafe; border-radius:3px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-image" style="font-size:0.55rem; color:#3b82f6;"></i></div></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#1e293b;">forklift_position.jpg</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0;"><span style="background:#dbeafe; color:#1d4ed8; padding:0.04rem 0.12rem; border-radius:3px; font-size:0.45rem;">Image</span></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#64748b;">1.8 MB</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; text-align:center;"><i class="fas fa-eye" style="color:#3b82f6; margin-right:0.15rem; cursor:pointer;"></i><i class="fas fa-trash" style="color:#ef4444; cursor:pointer;"></i></td>
                                            </tr>
                                            <!-- NEW file being added - highlighted row -->
                                            <tr style="background:#f0fdf4; animation:tagAdded 0.5s ease;">
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e;"><div style="width:22px; height:22px; background:#dcfce7; border:1px solid #22c55e; border-radius:3px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-file-pdf" style="font-size:0.55rem; color:#ef4444;"></i></div></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; color:#10b981; font-weight:600;"><i class="fas fa-plus-circle" style="margin-right:0.1rem;"></i>CCTV_footage_report.pdf <span style="background:#dcfce7; color:#15803d; padding:0.02rem 0.1rem; border-radius:2px; font-size:0.4rem;">NEW</span></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e;"><span style="background:#fee2e2; color:#dc2626; padding:0.04rem 0.12rem; border-radius:3px; font-size:0.45rem;">PDF</span></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; color:#10b981; font-weight:500;">856 KB</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; text-align:center;"><i class="fas fa-eye" style="color:#3b82f6; margin-right:0.15rem; cursor:pointer;"></i><i class="fas fa-trash" style="color:#ef4444; cursor:pointer;"></i></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size:0.45rem; color:#10b981; margin-top:0.15rem;"><i class="fas fa-check-circle"></i> 1 new file added to evidence</p>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Timeline (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-timeline" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('55%', '62%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- PEEPO Analysis - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Location Map - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-map-marker-alt" style="color:#ef4444;"></i> Incident Location Map</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Photos & Evidence - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-images" style="color:#8b5cf6;"></i> Photos & Evidence</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Timeline - HIGHLIGHTED with collapsible header -->
                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; margin-bottom:0.3rem; animation:highlightPulse 1s infinite;">
                                <div style="padding:0.2rem 0.3rem; background:#fef3c7; border-bottom:1px solid #fbbf24; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-clock" style="color:#f59e0b;"></i> Timeline</span>
                                    <i class="fas fa-chevron-down" style="color:#64748b; font-size:0.6rem;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- Add Event Button (matching original btn btn-primary style) -->
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.12rem 0.25rem; border-radius:4px; font-size:0.55rem; font-weight:500; margin-bottom:0.2rem;"><i class="fas fa-plus"></i> Add Event</button>
                                    
                                    <!-- Timeline Container - EXACT original design with inputs -->
                                    <div style="margin-bottom:0.25rem;">
                                        <!-- Event 1 - Original design: datetime + title + description + buttons -->
                                        <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem; align-items:center;">
                                            <div style="min-width:55px;">
                                                <input type="text" value="2025-12-10 14:30" readonly style="width:100%; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.4rem; background:#f9fafb;">
                                            </div>
                                            <input type="text" value="Forklift entered aisle B-7" readonly style="flex:1; padding:0.08rem 0.12rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                            <input type="text" value="Operator began maneuvering" readonly style="flex:1.5; padding:0.08rem 0.12rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem; color:#64748b;">
                                            <div style="display:flex; gap:0.08rem;">
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#dcfce7; color:#059669;"><i class="fas fa-save"></i></button>
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#fee2e2; color:#dc2626;"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        <!-- Event 2 -->
                                        <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem; align-items:center;">
                                            <div style="min-width:55px;">
                                                <input type="text" value="2025-12-10 14:32" readonly style="width:100%; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.4rem; background:#f9fafb;">
                                            </div>
                                            <input type="text" value="Collision with storage rack" readonly style="flex:1; padding:0.08rem 0.12rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                            <input type="text" value="Forklift rear struck rack R-42" readonly style="flex:1.5; padding:0.08rem 0.12rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem; color:#64748b;">
                                            <div style="display:flex; gap:0.08rem;">
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#dcfce7; color:#059669;"><i class="fas fa-save"></i></button>
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#fee2e2; color:#dc2626;"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        <!-- Event 3 -->
                                        <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem; align-items:center;">
                                            <div style="min-width:55px;">
                                                <input type="text" value="2025-12-10 14:33" readonly style="width:100%; padding:0.08rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.4rem; background:#f9fafb;">
                                            </div>
                                            <input type="text" value="Rack damage observed" readonly style="flex:1; padding:0.08rem 0.12rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem;">
                                            <input type="text" value="Visible bending of upright beam" readonly style="flex:1.5; padding:0.08rem 0.12rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.45rem; color:#64748b;">
                                            <div style="display:flex; gap:0.08rem;">
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#dcfce7; color:#059669;"><i class="fas fa-save"></i></button>
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#fee2e2; color:#dc2626;"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        <!-- NEW Event - highlighted with yellow border -->
                                        <div style="display:flex; gap:0.15rem; align-items:center; background:#f0fdf4; padding:0.1rem; border-radius:4px; border:2px solid #22c55e; animation:tagAdded 0.5s ease;">
                                            <div style="min-width:55px;">
                                                <input type="text" value="2025-12-10 14:35" style="width:100%; padding:0.08rem; border:2px solid #22c55e; border-radius:3px; font-size:0.4rem; background:#fff;">
                                            </div>
                                            <input type="text" value="Area cordoned off" style="flex:1; padding:0.08rem 0.12rem; border:2px solid #22c55e; border-radius:3px; font-size:0.45rem; color:#10b981; font-weight:500;">
                                            <input type="text" value="Supervisor notified, perimeter set" style="flex:1.5; padding:0.08rem 0.12rem; border:2px solid #22c55e; border-radius:3px; font-size:0.45rem; color:#10b981;">
                                            <div style="display:flex; gap:0.08rem;">
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#dcfce7; color:#059669;"><i class="fas fa-save"></i></button>
                                                <button style="padding:0.06rem 0.12rem; border:none; border-radius:3px; font-size:0.4rem; background:#fee2e2; color:#dc2626;"><i class="fas fa-trash"></i></button>
                                            </div>
                                            <span style="background:#dcfce7; color:#15803d; padding:0.02rem 0.08rem; border-radius:2px; font-size:0.35rem; font-weight:600;">NEW</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Chart Container - Timeline Visualization (EXACT original design) -->
                                    <div style="background:#f8fafc; border-radius:6px; padding:0.2rem;">
                                        <div style="font-size:0.55rem; font-weight:600; color:#374151; margin-bottom:0.15rem;">Timeline Visualization</div>
                                        <!-- event-timeline-viz with timeline-event-node design -->
                                        <div style="display:flex; flex-wrap:wrap; gap:0.2rem; padding:0.15rem; position:relative;">
                                            <!-- Timeline connector line -->
                                            <div style="position:absolute; top:22px; left:10%; right:10%; height:3px; background:linear-gradient(90deg, #3b82f6, #8b5cf6); z-index:0;"></div>
                                            
                                            <!-- Event Node 1 -->
                                            <div style="display:flex; flex-direction:column; align-items:center; min-width:45px; z-index:1;">
                                                <div style="background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:#fff; padding:0.06rem 0.12rem; border-radius:999px; font-size:0.4rem; font-weight:600; margin-bottom:0.1rem; box-shadow:0 1px 3px rgba(59,130,246,0.3);">14:30</div>
                                                <div style="width:10px; height:10px; background:#fff; border:2px solid #3b82f6; border-radius:50%; margin-bottom:0.1rem; box-shadow:0 1px 4px rgba(0,0,0,0.15);"></div>
                                                <div style="background:#fff; border:1px solid #e2e8f0; border-radius:4px; padding:0.1rem; text-align:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); width:45px;">
                                                    <div style="font-weight:600; color:#1e293b; font-size:0.4rem;">Entry</div>
                                                    <div style="color:#64748b; font-size:0.35rem;">Aisle B-7</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Event Node 2 -->
                                            <div style="display:flex; flex-direction:column; align-items:center; min-width:45px; z-index:1;">
                                                <div style="background:linear-gradient(135deg, #f59e0b, #d97706); color:#fff; padding:0.06rem 0.12rem; border-radius:999px; font-size:0.4rem; font-weight:600; margin-bottom:0.1rem; box-shadow:0 1px 3px rgba(245,158,11,0.3);">14:32</div>
                                                <div style="width:10px; height:10px; background:#fff; border:2px solid #f59e0b; border-radius:50%; margin-bottom:0.1rem; box-shadow:0 1px 4px rgba(0,0,0,0.15);"></div>
                                                <div style="background:#fff; border:1px solid #e2e8f0; border-radius:4px; padding:0.1rem; text-align:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); width:45px;">
                                                    <div style="font-weight:600; color:#1e293b; font-size:0.4rem;">Collision</div>
                                                    <div style="color:#64748b; font-size:0.35rem;">Rack R-42</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Event Node 3 -->
                                            <div style="display:flex; flex-direction:column; align-items:center; min-width:45px; z-index:1;">
                                                <div style="background:linear-gradient(135deg, #ef4444, #dc2626); color:#fff; padding:0.06rem 0.12rem; border-radius:999px; font-size:0.4rem; font-weight:600; margin-bottom:0.1rem; box-shadow:0 1px 3px rgba(239,68,68,0.3);">14:33</div>
                                                <div style="width:10px; height:10px; background:#fff; border:2px solid #ef4444; border-radius:50%; margin-bottom:0.1rem; box-shadow:0 1px 4px rgba(0,0,0,0.15);"></div>
                                                <div style="background:#fff; border:1px solid #e2e8f0; border-radius:4px; padding:0.1rem; text-align:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); width:45px;">
                                                    <div style="font-weight:600; color:#1e293b; font-size:0.4rem;">Damage</div>
                                                    <div style="color:#64748b; font-size:0.35rem;">Observed</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Event Node 4 - NEW -->
                                            <div style="display:flex; flex-direction:column; align-items:center; min-width:45px; z-index:1; animation:tagAdded 0.5s ease;">
                                                <div style="background:linear-gradient(135deg, #22c55e, #16a34a); color:#fff; padding:0.06rem 0.12rem; border-radius:999px; font-size:0.4rem; font-weight:600; margin-bottom:0.1rem; box-shadow:0 1px 3px rgba(34,197,94,0.3); animation:highlightPulse 1s infinite;">14:35</div>
                                                <div style="width:10px; height:10px; background:#fff; border:2px solid #22c55e; border-radius:50%; margin-bottom:0.1rem; box-shadow:0 1px 4px rgba(0,0,0,0.15); animation:highlightPulse 1s infinite;"></div>
                                                <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:4px; padding:0.1rem; text-align:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); width:45px;">
                                                    <div style="font-weight:600; color:#10b981; font-size:0.4rem;">Cordoned</div>
                                                    <div style="color:#10b981; font-size:0.35rem;">NEW</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Witness Statements (Measure Tab) -->
            <div class="demo-scene" id="scene-edit-update-witness-statements" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('60%', '70%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- PEEPO Analysis - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-project-diagram" style="color:#8b5cf6;"></i> PEEPO Analysis</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Location Map - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-map-marker-alt" style="color:#ef4444;"></i> Incident Location Map</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Photos & Evidence - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-images" style="color:#8b5cf6;"></i> Photos & Evidence</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Timeline - Completed (collapsed) -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-clock" style="color:#f59e0b;"></i> Timeline</span>
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-check-circle" style="color:#22c55e;"></i><i class="fas fa-chevron-up" style="color:#64748b; font-size:0.6rem;"></i></span>
                                </div>
                            </div>
                            <!-- Witness Statements - HIGHLIGHTED with collapsible header and + button -->
                            <div style="border:2px solid #fbbf24; background:#fffbeb; border-radius:4px; margin-bottom:0.3rem; animation:highlightPulse 1s infinite;">
                                <div style="padding:0.2rem 0.3rem; background:#fef3c7; border-bottom:1px solid #fbbf24; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-chevron-down" style="font-size:0.6rem; color:#64748b;"></i>
                                        Witness Statements
                                    </span>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.18rem; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                </div>
                                <div style="padding:0.25rem;">
                                    <!-- statements-table matching original design -->
                                    <table style="width:100%; font-size:0.5rem; border-collapse:collapse; border:1px solid #e5e7eb; border-radius:4px;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151;">Name</th>
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151;">Role/Position</th>
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151;">Date</th>
                                                <th style="padding:0.12rem; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151;">Summary</th>
                                                <th style="padding:0.12rem; text-align:center; border-bottom:1px solid #e2e8f0; font-weight:600; color:#374151;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="transition:background 0.2s;">
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#1e293b; font-weight:500;">James Wilson</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#64748b;">Forklift Operator</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#64748b;">Dec 10, 2025</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; color:#1e293b; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Reverse camera wasn't working properly...</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #e2e8f0; text-align:center;">
                                                    <i class="fas fa-eye" style="color:#3b82f6; margin-right:0.15rem; cursor:pointer;"></i>
                                                    <i class="fas fa-edit" style="color:#f59e0b; margin-right:0.15rem; cursor:pointer;"></i>
                                                    <i class="fas fa-trash" style="color:#ef4444; cursor:pointer;"></i>
                                                </td>
                                            </tr>
                                            <!-- NEW statement being added - highlighted row -->
                                            <tr style="background:#f0fdf4; animation:tagAdded 0.5s ease;">
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; color:#10b981; font-weight:600;"><i class="fas fa-plus-circle" style="margin-right:0.08rem;"></i>Mark Thompson <span style="background:#dcfce7; color:#15803d; padding:0.02rem 0.1rem; border-radius:2px; font-size:0.4rem;">NEW</span></td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; color:#10b981;">Shift Supervisor</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; color:#10b981;">Dec 11, 2025</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; color:#10b981; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Lighting in aisle B-7 has been reported...</td>
                                                <td style="padding:0.1rem; border-bottom:1px solid #22c55e; text-align:center;">
                                                    <i class="fas fa-eye" style="color:#3b82f6; margin-right:0.15rem; cursor:pointer;"></i>
                                                    <i class="fas fa-edit" style="color:#f59e0b; margin-right:0.15rem; cursor:pointer;"></i>
                                                    <i class="fas fa-trash" style="color:#ef4444; cursor:pointer;"></i>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size:0.45rem; color:#10b981; margin-top:0.15rem;"><i class="fas fa-check-circle"></i> 1 new witness statement recorded</p>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Switch to Analyze Tab -->
            <div class="demo-scene" id="scene-edit-switch-analyze" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('27%', '24%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px; animation:highlightPulse 1s infinite;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <!-- Expand/Collapse buttons -->
                        <div style="display:flex; gap:0.15rem; padding:0.15rem 0.3rem; justify-content:flex-end; background:#fff; border-bottom:1px solid #e2e8f0;">
                            <button style="padding:0.08rem 0.2rem; font-size:0.55rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; color:#64748b;"><i class="fas fa-expand-alt"></i> Expand All</button>
                            <button style="padding:0.08rem 0.2rem; font-size:0.55rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; color:#64748b;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Contributing Factors Summary Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-exclamation-triangle" style="color:#dc2626;"></i> Contributing Factors Summary</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Factors marked as <span style="color:#dc2626; font-weight:600;">Contributing</span> (red) from PEEPO analysis appear here.</p>
                                    <div style="min-height:20px; padding:0.2rem; background:#fef2f2; border:1px dashed #fca5a5; border-radius:4px; display:flex; gap:0.15rem; flex-wrap:wrap;">
                                        <span style="background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.2rem; font-size:0.5rem; display:inline-flex; align-items:center; gap:0.1rem;">
                                            <i class="fas fa-times-circle" style="font-size:0.45rem;"></i> EQ02 - Malfunctioning camera
                                        </span>
                                        <span style="background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.2rem; font-size:0.5rem; display:inline-flex; align-items:center; gap:0.1rem;">
                                            <i class="fas fa-times-circle" style="font-size:0.45rem;"></i> EN03 - Poor lighting
                                        </span>
                                        <span style="background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:999px; padding:0.08rem 0.2rem; font-size:0.5rem; display:inline-flex; align-items:center; gap:0.1rem;">
                                            <i class="fas fa-times-circle" style="font-size:0.45rem;"></i> PE04 - Operator fatigue
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Absent/Failed Defenses (ICAM) Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-shield-alt" style="color:#6366f1;"></i> Absent/Failed Defenses (ICAM)</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Identify defenses that were absent, failed, or not used.</p>
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem;">
                                        <select style="flex:1; padding:0.1rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem;">
                                            <option>-- Select Defense Type --</option>
                                        </select>
                                        <button style="padding:0.1rem 0.2rem; background:#3b82f6; color:#fff; border:none; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-radius:3px; overflow:hidden;">
                                        <div style="padding:0.15rem; background:#f0f9ff; border-bottom:1px solid #e2e8f0; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>DF03 - Isolation/Lockout Systems</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                        <div style="padding:0.15rem; background:#fff; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>DF45 - Direct Supervision</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Individual or Team Actions Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-user-cog" style="color:#f59e0b;"></i> Individual or Team Actions</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Identify individual or team actions that contributed to the incident.</p>
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem;">
                                        <select style="flex:1; padding:0.1rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem;">
                                            <option>-- Select Action Type --</option>
                                        </select>
                                        <button style="padding:0.1rem 0.2rem; background:#3b82f6; color:#fff; border:none; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-radius:3px; overflow:hidden;">
                                        <div style="padding:0.15rem; background:#fffbeb; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>ITA04 - Attention Failure</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Task / Environmental Conditions Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-tasks" style="color:#10b981;"></i> Task / Environmental Conditions</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Identify task-related and environmental conditions that contributed.</p>
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem;">
                                        <select style="flex:1; padding:0.1rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem;">
                                            <option>-- Select Condition Type --</option>
                                        </select>
                                        <button style="padding:0.1rem 0.2rem; background:#3b82f6; color:#fff; border:none; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-radius:3px; overflow:hidden;">
                                        <div style="padding:0.15rem; background:#f0fdf4; border-bottom:1px solid #e2e8f0; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>TEC11 - Poor Lighting</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                        <div style="padding:0.15rem; background:#fff; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>TEC23 - Fatigue</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Organisational Factors Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-building" style="color:#8b5cf6;"></i> Organisational Factors</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Identify organisational factors that contributed to the incident.</p>
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem;">
                                        <select style="flex:1; padding:0.1rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem;">
                                            <option>-- Select Factor Type --</option>
                                        </select>
                                        <button style="padding:0.1rem 0.2rem; background:#3b82f6; color:#fff; border:none; border-radius:3px; font-size:0.5rem;"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-radius:3px; overflow:hidden;">
                                        <div style="padding:0.15rem; background:#f5f3ff; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>OF10 - Poor Equipment Maintenance</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Data Analysis Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-chart-bar" style="color:#0ea5e9;"></i> Data Analysis</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="margin-bottom:0.15rem;">
                                        <label style="font-size:0.5rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Data Collected</label>
                                        <textarea style="width:100%; padding:0.1rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem; resize:none; height:30px;" placeholder="Document all data collected...">CCTV footage reviewed, witness interviews conducted, equipment inspection completed, maintenance records analyzed</textarea>
                                    </div>
                                    <div>
                                        <label style="font-size:0.5rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Key Findings</label>
                                        <textarea style="width:100%; padding:0.1rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem; resize:none; height:30px;" placeholder="Summarize key findings...">Camera malfunction reported but not actioned, lighting maintenance overdue by 2 weeks, operator worked 10 hours prior to incident</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Add Failed Defense -->
            <div class="demo-scene" id="scene-edit-add-rootcause" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('75%', '28%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <!-- Expand/Collapse buttons -->
                        <div style="display:flex; gap:0.15rem; padding:0.15rem 0.3rem; justify-content:flex-end; background:#fff; border-bottom:1px solid #e2e8f0;">
                            <button style="padding:0.08rem 0.2rem; font-size:0.55rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; color:#64748b;"><i class="fas fa-expand-alt"></i> Expand All</button>
                            <button style="padding:0.08rem 0.2rem; font-size:0.55rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; color:#64748b;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Contributing Factors Summary Section - collapsed -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-exclamation-triangle" style="color:#dc2626;"></i> Contributing Factors Summary</span>
                                    <i class="fas fa-chevron-right" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                            </div>
                            <!-- Absent/Failed Defenses (ICAM) Section - Adding new defense -->
                            <div style="border:2px solid #fbbf24; border-radius:4px; margin-bottom:0.3rem; animation:highlightPulse 1s infinite;">
                                <div style="padding:0.2rem 0.3rem; background:#fffbeb; border-bottom:1px solid #fbbf24; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-shield-alt" style="color:#6366f1;"></i> Absent/Failed Defenses (ICAM)</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Identify defenses that were absent, failed, or not used.</p>
                                    <div style="display:flex; gap:0.15rem; margin-bottom:0.15rem;">
                                        <select style="flex:1; padding:0.1rem; border:2px solid #fbbf24; border-radius:3px; font-size:0.5rem; background:#fffbeb;">
                                            <option>DF14 - Inspection/Audit Program</option>
                                        </select>
                                        <button style="padding:0.1rem 0.2rem; background:#fbbf24; color:#92400e; border:none; border-radius:3px; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div style="border:1px solid #e2e8f0; border-radius:3px; overflow:hidden;">
                                        <div style="padding:0.15rem; background:#f0f9ff; border-bottom:1px solid #e2e8f0; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>DF03 - Isolation/Lockout Systems</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                        <div style="padding:0.15rem; background:#fff; border-bottom:1px solid #e2e8f0; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between;">
                                            <span><strong>DF45 - Direct Supervision</strong></span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                        <div style="padding:0.15rem; background:#fffbeb; border:2px solid #fbbf24; font-size:0.55rem; display:flex; align-items:center; justify-content:space-between; animation:highlightPulse 1s infinite;">
                                            <span style="color:#10b981; font-weight:600;"><i class="fas fa-plus-circle"></i> <strong>DF14 - Inspection/Audit Program</strong> (NEW)</span>
                                            <button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.45rem;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Individual or Team Actions Section - collapsed -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-user-cog" style="color:#f59e0b;"></i> Individual or Team Actions</span>
                                    <i class="fas fa-chevron-right" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                            </div>
                            <!-- Task / Environmental Conditions Section - collapsed -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-tasks" style="color:#10b981;"></i> Task / Environmental Conditions</span>
                                    <i class="fas fa-chevron-right" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                            </div>
                            <!-- Organisational Factors Section - collapsed -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-building" style="color:#8b5cf6;"></i> Organisational Factors</span>
                                    <i class="fas fa-chevron-right" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                            </div>
                            <!-- Data Analysis Section - collapsed -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-chart-bar" style="color:#0ea5e9;"></i> Data Analysis</span>
                                    <i class="fas fa-chevron-right" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Switch to Improve Tab -->
            <div class="demo-scene" id="scene-edit-switch-improve" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('32%', '24%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px; animation:highlightPulse 1s infinite;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Corrective Actions Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-tasks" style="color:#f59e0b;"></i> Corrective Actions</span>
                                    <button style="padding:0.08rem 0.15rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem; color:#64748b;"><i class="fas fa-plus"></i></button>
                                </div>
                                <div style="padding:0.2rem;">
                                    <!-- Corrective Actions Table -->
                                    <table style="width:100%; border-collapse:collapse; font-size:0.5rem;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action Owner</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Due Date</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action Type</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Status</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Description</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center; font-weight:600; color:#64748b;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Maintenance Team</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">15 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Corrective</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#fef3c7; color:#d97706; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">In Progress</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Install additional lighting in aisle B-7</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr style="background:#f8fafc;">
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Equipment Services</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">11 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Corrective</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Completed</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Repair forklift reverse camera</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Training Dept</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">20 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Preventive</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#e0e7ff; color:#4f46e5; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Scheduled</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Conduct refresher training for operators</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Improve Tab Scroll - Shows all editable fields -->
            <div class="demo-scene" id="scene-edit-improve-scroll" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Corrective Actions Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-tasks" style="color:#f59e0b;"></i> Corrective Actions
                                        <span style="background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                    </div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-plus"></i> Add Action</button>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem; margin-bottom:0.15rem;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.55rem;">
                                            <div><strong>Install additional lighting</strong></div>
                                            <span style="background:#fef3c7; color:#d97706; padding:0.05rem 0.15rem; border-radius:2px;">In Progress</span>
                                        </div>
                                        <div style="font-size:0.5rem; color:#64748b;">Owner: Maintenance Team | Due: 15 Dec 2024</div>
                                    </div>
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem; margin-bottom:0.15rem;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.55rem;">
                                            <div><strong>Repair forklift camera</strong></div>
                                            <span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.15rem; border-radius:2px;">Completed</span>
                                        </div>
                                        <div style="font-size:0.5rem; color:#64748b;">Owner: Equipment Services | Due: 11 Dec 2024</div>
                                    </div>
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.55rem;">
                                            <div><strong>Conduct refresher training</strong></div>
                                            <span style="background:#e0e7ff; color:#4f46e5; padding:0.05rem 0.15rem; border-radius:2px;">Scheduled</span>
                                        </div>
                                        <div style="font-size:0.5rem; color:#64748b;">Owner: Training Dept | Due: 20 Dec 2024</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Recommendations Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:0.2rem;">
                                        <i class="fas fa-lightbulb" style="color:#eab308;"></i> Recommendations
                                        <span style="background:#fbbf24; color:#92400e; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-edit"></i> Editable</span>
                                    </div>
                                    <button style="background:#3b82f6; color:#fff; border:none; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.55rem;"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#fffbeb; border:2px solid #fbbf24; border-radius:3px; padding:0.15rem; font-size:0.55rem;">
                                        <strong>1.</strong> Update SOPs to require spotters in narrow aisles
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Update Action Status -->
            <div class="demo-scene" id="scene-edit-update-action" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('75%', '52%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Corrective Actions Section -->
                            <div style="border:2px solid #fbbf24; border-radius:4px; animation:highlightPulse 1s infinite;">
                                <div style="padding:0.2rem 0.3rem; background:#fffbeb; border-bottom:1px solid #fbbf24; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-tasks" style="color:#f59e0b;"></i> Corrective Actions</span>
                                    <span style="background:#fbbf24; color:#92400e; padding:0.05rem 0.15rem; border-radius:2px; font-size:0.45rem;">Updating Status...</span>
                                </div>
                                <div style="padding:0.2rem;">
                                    <!-- Corrective Actions Table -->
                                    <table style="width:100%; border-collapse:collapse; font-size:0.5rem;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action Owner</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Due Date</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action Type</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Status</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Description</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center; font-weight:600; color:#64748b;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="background:#fffbeb; border:2px solid #fbbf24;">
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Maintenance Team</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">11 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Corrective</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">
                                                    <span style="text-decoration:line-through; background:#fef3c7; color:#d97706; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.4rem;">In Progress</span>
                                                    <span style="color:#10b981;">â†’</span>
                                                    <span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.4rem; font-weight:600;">Completed âœ“</span>
                                                </td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Install additional lighting in aisle B-7</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr style="background:#f8fafc;">
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Equipment Services</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">11 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Corrective</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Completed</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Repair forklift reverse camera</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Training Dept</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">20 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Preventive</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#e0e7ff; color:#4f46e5; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Scheduled</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Conduct refresher training for operators</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Add New Corrective Action -->
            <div class="demo-scene" id="scene-edit-add-action" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('93%', '24%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Corrective Actions Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-tasks" style="color:#f59e0b;"></i> Corrective Actions</span>
                                    <button style="padding:0.08rem 0.15rem; background:#fbbf24; color:#92400e; border:none; border-radius:3px; font-size:0.5rem; animation:highlightPulse 1s infinite;"><i class="fas fa-plus"></i></button>
                                </div>
                                <div style="padding:0.2rem;">
                                    <!-- Corrective Actions Table -->
                                    <table style="width:100%; border-collapse:collapse; font-size:0.5rem;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action Owner</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Due Date</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action Type</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Status</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Description</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center; font-weight:600; color:#64748b;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Maintenance Team</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">11 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Corrective</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Completed</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Install additional lighting in aisle B-7</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr style="background:#f8fafc;">
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Equipment Services</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">11 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Corrective</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Completed</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Repair forklift reverse camera</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Training Dept</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">20 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Preventive</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#e0e7ff; color:#4f46e5; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Scheduled</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Conduct refresher training for operators</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr style="background:#fffbeb; border:2px solid #fbbf24;">
                                                <td style="padding:0.1rem; border:1px solid #fbbf24; color:#10b981; font-weight:600;"><i class="fas fa-plus-circle"></i> Safety Manager</td>
                                                <td style="padding:0.1rem; border:1px solid #fbbf24;">22 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #fbbf24;">Preventive</td>
                                                <td style="padding:0.1rem; border:1px solid #fbbf24;"><span style="background:#fef3c7; color:#d97706; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Pending</span></td>
                                                <td style="padding:0.1rem; border:1px solid #fbbf24; color:#10b981; font-weight:600;">Update narrow aisle spotter policy (NEW)</td>
                                                <td style="padding:0.1rem; border:1px solid #fbbf24; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Switch to Control Tab -->
            <div class="demo-scene" id="scene-edit-switch-control" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('37%', '24%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px; animation:highlightPulse 1s infinite;">Control</span>
                        </div>
                        <!-- Expand/Collapse buttons -->
                        <div style="display:flex; gap:0.15rem; padding:0.15rem 0.3rem; justify-content:flex-end; background:#fff; border-bottom:1px solid #e2e8f0;">
                            <button style="padding:0.08rem 0.2rem; font-size:0.55rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; color:#64748b;"><i class="fas fa-expand-alt"></i> Expand All</button>
                            <button style="padding:0.08rem 0.2rem; font-size:0.55rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; color:#64748b;"><i class="fas fa-compress-alt"></i> Collapse All</button>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <!-- Improvement Verification Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-clipboard-check" style="color:#10b981;"></i> Improvement Verification</span>
                                    <span style="display:flex; align-items:center; gap:0.15rem;">
                                        <button style="padding:0.08rem 0.15rem; background:#fff; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem; color:#64748b;"><i class="fas fa-plus"></i></button>
                                        <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                    </span>
                                </div>
                                <div style="padding:0.2rem;">
                                    <p style="font-size:0.5rem; color:#64748b; margin-bottom:0.15rem;">Track and verify the implementation of corrective actions and improvements.</p>
                                    <!-- Improvement Verification Table -->
                                    <table style="width:100%; border-collapse:collapse; font-size:0.5rem;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Action/Improvement</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Verified By</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Verification Date</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Status</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:left; font-weight:600; color:#64748b;">Effectiveness</th>
                                                <th style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center; font-weight:600; color:#64748b;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Lighting installation in B-7</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">John Smith</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">12 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Verified</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dbeafe; color:#1e40af; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Effective</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr style="background:#f8fafc;">
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Camera repair on forklift</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Ahmed Hassan</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">11 Dec 2024</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dcfce7; color:#16a34a; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Verified</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#dbeafe; color:#1e40af; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Effective</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                            <tr>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">Operator refresher training</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">-</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">-</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;"><span style="background:#fef3c7; color:#d97706; padding:0.05rem 0.1rem; border-radius:2px; font-size:0.45rem;">Pending</span></td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0;">-</td>
                                                <td style="padding:0.1rem; border:1px solid #e2e8f0; text-align:center;"><button style="padding:0.05rem 0.1rem; background:#fee2e2; color:#dc2626; border:none; border-radius:2px; font-size:0.4rem;"><i class="fas fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- Lessons Learned Section -->
                            <div style="border:1px solid #e2e8f0; border-radius:4px;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.65rem; font-weight:700; color:#334155; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                    <span style="display:flex; align-items:center; gap:0.2rem;"><i class="fas fa-book" style="color:#f59e0b;"></i> Lessons Learned</span>
                                    <i class="fas fa-chevron-down" style="font-size:0.5rem; color:#64748b;"></i>
                                </div>
                                <div style="padding:0.25rem;">
                                    <label style="font-size:0.5rem; color:#64748b; font-weight:600; display:block; margin-bottom:0.08rem;">Key Lessons Learned</label>
                                    <textarea style="width:100%; padding:0.15rem; border:1px solid #d1d5db; border-radius:3px; font-size:0.5rem; resize:none; height:50px;" placeholder="Document key lessons learned...">1. Pre-shift equipment inspections are critical for preventing equipment-related incidents.\n2. Proper lighting in all work areas is essential for safe forklift operations.\n3. All SOP updates should follow a formal change management process to ensure safety equipment is included in inspections.</textarea>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Click Save Changes -->
            <div class="demo-scene" id="scene-edit-save" style="display:none; height:100%; position:relative;">
                ${editMouseCursor('92%', '88%')}
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff;">
                            <div style="border:1px solid #e2e8f0; border-radius:4px; margin-bottom:0.3rem;">
                                <div style="padding:0.2rem 0.3rem; background:#f8fafc; border-bottom:1px solid #e2e8f0; font-size:0.75rem; font-weight:700; color:#334155; display:flex; align-items:center; gap:0.2rem;">
                                    <i class="fas fa-tasks" style="color:#f59e0b;"></i> Corrective Actions
                                    <span style="margin-left:auto; background:#10b981; color:#fff; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.55rem;"><i class="fas fa-check"></i> All Changes Ready</span>
                                </div>
                                <div style="padding:0.25rem;">
                                    <div style="background:#f0fdf4; border:1px solid #10b981; border-radius:4px; padding:0.2rem; margin-bottom:0.2rem;">
                                        <p style="margin:0; font-size:0.65rem; color:#166534; font-weight:600;"><i class="fas fa-clipboard-check" style="margin-right:0.1rem;"></i> Summary of Changes:</p>
                                        <ul style="margin:0.1rem 0 0 0.3rem; padding:0; font-size:0.6rem; color:#166534;">
                                            <li>Title updated</li>
                                            <li>Description expanded</li>
                                            <li>PEEPO factors enhanced</li>
                                            <li>New root cause factor added</li>
                                            <li>Action #1 marked completed</li>
                                            <li>New corrective action added</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:flex-end; gap:0.2rem;">
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#f1f5f9; color:#475569; border:1px solid #d1d5db; border-radius:3px;">Cancel</button>
                            <button style="padding:0.15rem 0.3rem; font-size:0.65rem; background:#22c55e; color:#fff; border:none; border-radius:3px; font-weight:600; animation:highlightPulse 1s infinite; box-shadow:0 0 10px rgba(34,197,94,0.5);"><i class="fas fa-save"></i> Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Success Message -->
            <div class="demo-scene" id="scene-edit-success" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${editHeaderHTML}
                        <div style="background:#f8fafc; padding:0.15rem 0.35rem; border-bottom:1px solid #e2e8f0; display:flex; gap:0.15rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Define</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Measure</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Analyze</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:600; background:#fff; border:1px solid #0ea5e9; color:#0ea5e9; border-radius:999px;">Improve</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.65rem; font-weight:500; background:#fff; border:1px solid #e5e7eb; color:#64748b; border-radius:999px;">Control</span>
                        </div>
                        <div data-scroll-container style="flex:1; overflow-y:auto; padding:0.3rem; background:#fff; display:flex; align-items:center; justify-content:center;">
                            <div style="text-align:center; animation:bounceIn 0.5s ease-out;">
                                <div style="width:80px; height:80px; background:linear-gradient(135deg, #10b981, #059669); border-radius:50%; margin:0 auto 0.3rem; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 25px rgba(16,185,129,0.4);">
                                    <i class="fas fa-check" style="font-size:2rem; color:#fff;"></i>
                                </div>
                                <h3 style="margin:0 0 0.2rem; font-size:0.7rem; color:#1e293b; font-weight:700;">Investigation Updated!</h3>
                                <p style="margin:0 0 0.3rem; font-size:0.75rem; color:#64748b;">All changes have been saved successfully</p>
                                <div style="display:flex; gap:0.2rem; justify-content:center; flex-wrap:wrap;">
                                    <span style="background:#dcfce7; color:#166534; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.6rem;"><i class="fas fa-check"></i> Title Updated</span>
                                    <span style="background:#dcfce7; color:#166534; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.6rem;"><i class="fas fa-check"></i> PEEPO Enhanced</span>
                                    <span style="background:#dcfce7; color:#166534; padding:0.1rem 0.2rem; border-radius:3px; font-size:0.6rem;"><i class="fas fa-check"></i> Actions Updated</span>
                                </div>
                            </div>
                        </div>
                        <div style="background:#fff; border-top:1px solid #e2e8f0; padding:0.2rem 0.35rem; display:flex; justify-content:center; gap:0.2rem;">
                            <button style="padding:0.15rem 0.4rem; font-size:0.65rem; background:#3b82f6; color:#fff; border:none; border-radius:3px; font-weight:600;"><i class="fas fa-arrow-left"></i> Back to List</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Updated List View -->
            <div class="demo-scene" id="scene-edit-updated-list" style="display:none; height:100%;">
                <div style="display:flex; height:100%;">
                    ${sidebarHTML}
                    <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; overflow:hidden;">
                        ${topNavHTML}
                        ${pageHeaderHTML}
                        <!-- Tabs -->
                        <div style="padding:0.15rem 0.35rem; display:flex; gap:0.2rem;">
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:600; background:#3b82f6; color:#fff; border-radius:3px;"><i class="fas fa-list" style="margin-right:0.15rem;"></i>Investigations</span>
                            <span style="padding:0.12rem 0.3rem; font-size:0.7rem; font-weight:500; background:#f1f5f9; color:#64748b; border-radius:3px;"><i class="fas fa-cog" style="margin-right:0.15rem;"></i>Settings</span>
                        </div>
                        <!-- Filters -->
                        <div style="padding:0.2rem 0.35rem; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                            <div style="display:flex; gap:0.2rem; align-items:flex-end; flex-wrap:wrap;">
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Status</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Status</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Priority</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All Priorities</div>
                                </div>
                                <div style="flex:1; min-width:50px;">
                                    <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.08rem;">Investigator</div>
                                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:2px; padding:0.1rem; font-size:0.6rem; color:#374151;">All</div>
                                </div>
                                <button style="background:#3b82f6; color:#fff; border:none; padding:0.12rem 0.25rem; border-radius:2px; font-size:0.6rem;"><i class="fas fa-filter"></i> Apply</button>
                            </div>
                        </div>
                        <!-- Table with updated investigation -->
                        <div style="flex:1; padding:0.2rem 0.35rem; overflow:auto;">
                            <div style="background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.08); overflow:hidden;">
                                <table style="width:100%; border-collapse:collapse; font-size:0.7rem;">
                                    <thead style="background:#f8fafc;">
                                        <tr>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Investigation ID</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Title</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Status</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Priority</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Incident Date</th>
                                            <th style="padding:0.25rem; text-align:left; font-weight:600; color:#475569; border-bottom:1px solid #e2e8f0;">Location</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="background:#f0fdf4; border:2px solid #10b981; animation:highlightPulse 1.5s infinite;">
                                            <td style="padding:0.25rem; color:#1e293b; font-weight:600; border-bottom:1px solid #f1f5f9;">INV-2024-0025</td>
                                            <td style="padding:0.25rem; color:#1e293b; border-bottom:1px solid #f1f5f9;">
                                                <span style="color:#10b981; font-weight:600;">Forklift Collision - Warehouse B Zone 3</span>
                                                <span style="background:#10b981; color:#fff; padding:0.03rem 0.12rem; border-radius:2px; font-size:0.5rem; margin-left:0.15rem;">UPDATED</span>
                                            </td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Pending Approval</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fee2e2; color:#dc2626; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">High</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">10 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Warehouse B - Zone 3</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Chemical Spill - Lab Area</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Approved</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#fef3c7; color:#d97706; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Medium</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">08 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Laboratory A</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">INV-2024-0023</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Slip and Fall - Main Entrance</td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dbeafe; color:#2563eb; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Closed</span></td>
                                            <td style="padding:0.25rem; border-bottom:1px solid #f1f5f9;"><span style="background:#dcfce7; color:#16a34a; padding:0.08rem 0.2rem; border-radius:2px; font-size:0.6rem;">Low</span></td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">05 Dec 2024</td>
                                            <td style="padding:0.25rem; color:#64748b; border-bottom:1px solid #f1f5f9;">Main Office Entrance</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:0.25rem; padding:0.2rem; background:#dcfce7; border-radius:3px; border-left:2px solid #10b981;">
                                <p style="margin:0; font-size:0.7rem; color:#166534;"><i class="fas fa-check-circle" style="margin-right:0.15rem;"></i><strong>Changes saved!</strong> INV-2024-0025 has been updated with your modifications.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scene: Final Completion -->
            <div class="demo-scene" id="scene-edit-final" style="display:none; height:100%;">
                <div style="display:flex; align-items:center; justify-content:center; height:100%; background:linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);">
                    <div style="text-align:center; color:#fff; animation:bounceIn 0.5s ease-out;">
                        <div style="width:100px; height:100px; background:rgba(255,255,255,0.2); border-radius:50%; margin:0 auto 0.4rem; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px); border:2px solid rgba(255,255,255,0.3);">
                            <i class="fas fa-edit" style="font-size:2.5rem;"></i>
                        </div>
                        <h2 style="margin:0 0 0.2rem; font-size:0.9rem; font-weight:700;">Edit Tutorial Complete!</h2>
                        <p style="margin:0 0 0.4rem; font-size:0.5rem; opacity:0.9;">You've learned how to modify investigations</p>
                        <div style="display:flex; flex-direction:column; gap:0.15rem; margin-bottom:0.4rem;">
                            <div style="display:flex; align-items:center; gap:0.2rem; justify-content:center;">
                                <i class="fas fa-check-circle" style="color:#a7f3d0;"></i>
                                <span style="font-size:0.7rem;">Open investigation from list</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:0.2rem; justify-content:center;">
                                <i class="fas fa-check-circle" style="color:#a7f3d0;"></i>
                                <span style="font-size:0.7rem;">Edit details across DMAIC tabs</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:0.2rem; justify-content:center;">
                                <i class="fas fa-check-circle" style="color:#a7f3d0;"></i>
                                <span style="font-size:0.7rem;">Update action statuses</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:0.2rem; justify-content:center;">
                                <i class="fas fa-check-circle" style="color:#a7f3d0;"></i>
                                <span style="font-size:0.7rem;">Add new factors & actions</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:0.2rem; justify-content:center;">
                                <i class="fas fa-check-circle" style="color:#a7f3d0;"></i>
                                <span style="font-size:0.7rem;">Save changes successfully</span>
                            </div>
                        </div>
                        <div style="background:rgba(255,255,255,0.15); padding:0.2rem 0.4rem; border-radius:5px; backdrop-filter:blur(5px);">
                            <span style="font-size:0.75rem; font-weight:600;"><i class="fas fa-redo" style="margin-right:0.15rem;"></i>Click Restart to watch again</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    </script>
</body>
</html>


