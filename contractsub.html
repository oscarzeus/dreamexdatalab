<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create Employee Contract - Dreamex Datalab HSE Management System">
    <meta name="keywords" content="employee contract, HR, contract creation, Dreamex Datalab">
    <meta name="author" content="Dreamex Datalab">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Create Employee Contract - Dreamex Datalab</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          onerror="this.onerror=null; console.warn('Font Awesome failed to load - using fallback');">
    <link rel="stylesheet" href="css/styles.css" 
          onerror="this.onerror=null; console.warn('styles.css failed to load - using embedded styles');">
    <link rel="stylesheet" href="css/forms.css" 
          onerror="this.onerror=null; console.warn('forms.css failed to load - using embedded styles');">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <style>
        /* Import jobscreen.html design elements */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --transition-speed: 0.2s;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        /* Contract Creation Page Styles with jobscreen.html design */
        .contract-form-container {
            padding: 2rem 0;
            width: 100%;
            margin: 0;
            max-width: none;
        }

        /* Override content padding for full-width layout */
        .content {
            width: 100%;
            margin: 0;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Page Header with Gradient (matching jobscreen.html) */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.6rem 1rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            margin: 0 2rem 1rem 2rem;
            transition: box-shadow 0.2s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 1.25rem;
            color: white;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        /* Tab Layout Styles (matching jobscreen.html) */
        .content-tabs {
            margin: 0 2rem;
            width: calc(100% - 4rem);
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }
        /* Slightly scale down tab icons to match reduced label size */
        .tab-nav-btn i { font-size: 0.95em; }

        .tab-nav-btn:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        .tab-nav-btn.active {
            color: #ffffff;
            background: #007bff;
        }

        /* Specific tab colors when active */
        #templateSelectionBtn.active {
            color: #ffffff;
            background: #007bff; /* Blue for template selection */
        }

        #contractFormBtn.active {
            color: #ffffff;
            background: #28a745; /* Green for contract form */
        }

        #previewBtn.active {
            color: #ffffff;
            background: #17a2b8; /* Teal for preview */
        }

        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-controls {
            margin-bottom: 1.5rem;
        }

        /* Updated form styling to match jobscreen.html */
        .template-selection {
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
        }

        .contract-form {
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
        }

        .contract-form-header {
            background: white;
            padding: 2rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .contract-form-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .contract-form-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin: 0;
        }

        .template-selection h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .contract-form h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Template table (Select Template tab) */
        .template-table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        table.template-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        .template-table thead th {
            text-align: left;
            padding: 12px 10px;
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }
        .template-table tbody td {
            padding: 10px;
            border-bottom: 1px solid #f1f3f5;
            color: #343a40;
            vertical-align: middle;
        }
        .template-table tbody tr:hover {
            background: #f8f9ff;
        }
        .template-table tbody tr.template-row.selected {
            background: #eef5ff;
        }
        .template-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #495057;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }
        .icon-btn:hover {
            background: #f8f9fa;
            color: #0d6efd;
            border-color: #ced4da;
        }
        .text-muted-small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .template-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .template-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }

        .template-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.2);
        }

        .template-card h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .template-card p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .template-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .template-category {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Contract Form */
        .contract-form {
            background: white;
            padding: 1.25rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .contract-form h3 {
            color: #2c3e50;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .form-section h4 {
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .form-row.four-cols {
            grid-template-columns: repeat(4, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.35rem;
            font-size: 0.9rem;
        }
        .contract-form hr {
            margin: 0.75rem 0 !important;
        }
        /* Reduce spacing of horizontal rules inside forms to save vertical space */
        .contract-form hr {
            margin: 1rem 0 !important;
        }

        .form-label.required::after {
            content: ' *';
            color: #dc3545;
        }

        .form-control {
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }        .form-control:invalid {
            border-color: #dc3545;
        }

        /* Input with addon (for currency next to salary amount) */
        .input-with-addon {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .input-with-addon .form-control {
            flex: 1 1 auto;
        }
        .input-addon {
            padding: 0.5rem 0.6rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: #f8f9fa;
            color: #495057;
            font-size: 0.85rem;
            min-width: 3.25rem;
            text-align: center;
            white-space: nowrap;
        }

        /* Employee Dropdown Styles */
        .employee-dropdown-container {
            position: relative;
        }

        .loading-employees {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading-spinner-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .form-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .text-muted {
            color: #6c757d !important;
        }

        /* Template Content Display */
        .template-content-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            min-height: 300px;
        }

        .template-content-display h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-placeholder {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #856404;
        }

        /* Action Buttons */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        /* Loading States */
        .loading-templates {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Real-time update notification styles */
        @keyframes slideInFromRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Empty State */
        .empty-templates {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-templates i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .progress-step.active {
            background: #007bff;
            color: white;
        }

        .progress-step.completed {
            background: #28a745;
            color: white;
        }        .progress-step.pending {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Dynamic Template Fields */
        .dynamic-template-section {
            border-left: 4px solid #007bff;
            background: #f8f9ff;
        }

        .dynamic-template-section h4 {
            color: #007bff;
        }

        .table-editor {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            background: white;
        }

        .table-editor .table {
            margin-bottom: 1rem;
        }

        .table-editor .table th {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .table-editor .table td {
            border-color: #dee2e6;
        }

        .list-editor {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            background: white;
        }

        .list-editor .input-group {
            margin-bottom: 0.5rem;
        }

        .list-editor .input-group:last-of-type {
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .contract-form-container {
                padding: 1rem;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }
            
            /* Mobile sidebar adjustments */
            .sidebar {
                position: fixed;
                left: -250px;
                width: 250px;
                height: 100vh;
                z-index: 2000;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            /* Override collapsed state on mobile - use left positioning instead */
            .sidebar.collapsed {
                left: -250px;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .main-content.expanded {
                margin-left: 0; /* No change on mobile */
            }
            
            .top-nav {
                position: relative;
            }
            
            /* Mobile sidebar toggle button */
            .sidebar-toggle-btn {
                font-size: 1.5rem;
                padding: 0.5rem;
            }

            /* Company header responsive styles */
            .company-name-header {
                font-size: 1rem;
                display: none; /* Hide company name on very small screens */
            }

            .header-company-logo, .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }

            .top-nav-left {
                gap: 0.5rem;
            }

            /* Mobile overlay when sidebar is open */
            .sidebar.active::before {
                content: '';
                position: fixed;
                top: 0;
                left: 250px;
                width: calc(100vw - 250px);
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }
        }
        
        /* Show company name on larger screens */
        @media (min-width: 769px) {
            .company-name-header {
                display: inline-block;
            }
        }
        
        /* Desktop menu toggle (hidden by default) */
        .mobile-menu-toggle {
            display: none;
        }
        
        /* Fallback CSS Styles for Standalone Operation */
        /* Basic reset and layout styles in case external CSS fails */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f6fa;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-250px);
        }
        
        .sidebar .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1rem;
        }
        
        .sidebar .menu {
            list-style: none;
        }
        
        .sidebar .menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .sidebar .menu a:hover {
            background: #3498db;
        }
        
        /* Menu dropdown styles - hover based like dashboard.html */
        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }
        
        .menu-dropdown:hover .submenu {
            display: block;
        }
        
        .submenu li {
            margin-bottom: 0;
        }
        
        .submenu a {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 0;
        }
        
        .submenu a:hover {
            background: rgba(52, 152, 219, 0.3);
        }
        
        /* Icon spacing */
        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 1.2rem;
            text-align: center;
        }
        
        /* Top navigation improvements */
        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Profile dropdown styles (aligned with project-list.html) */
        .profile-dropdown { 
            display: none; 
            position: absolute; 
            right: 0; 
            top: 110%; 
            background: #fff; 
            border-radius: 8px; 
            min-width: 200px; 
            box-shadow: 0 6px 18px rgba(0,0,0,0.12); 
            overflow: hidden; 
            z-index: 1000;
        }
        .profile-dropdown.show { display: block; }
        .profile-dropdown ul { list-style: none; margin: 0; padding: 0; }
        .profile-dropdown li a { display: block; padding: 0.65rem 0.85rem; font-size: 0.72rem; text-decoration: none; color: #1e293b; font-weight: 500; }
        .profile-dropdown li a:hover { background: #f1f5f9; }
        
        .notifications {
            position: relative;
        }
        
        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* While loading, keep defaults (hidden until authorized) to match project-list behavior */
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 1rem;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }
        
        .top-nav {
            background: #fff;
            padding: 0.5rem 0.75rem;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 0.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            min-height: 50px;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color, #333);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: contain;
            background: transparent;
            border: none;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }
        
        .user-profile {
            position: relative;
        }
        
        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Removed duplicate .profile-dropdown styles (now defined earlier to match project-list) */
        
        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            margin-right: 1rem;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        /* Error handling styles */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }

        /* Compact sizing for Employee Details tab only */
        #employeeDetails .contract-form {
            font-size: 0.85rem;
        }
        #employeeDetails .contract-form h3 {
            font-size: 1.05rem;
            margin-bottom: 0.6rem;
        }
        #employeeDetails .form-section {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        #employeeDetails .form-section h4 {
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }
        #employeeDetails .form-row {
            gap: 0.5rem;
        }
        #employeeDetails .form-label {
            font-size: 0.82rem;
            margin-bottom: 0.25rem;
        }
        #employeeDetails .form-control {
            padding: 0.5rem 0.6rem;
            font-size: 0.85rem;
        }
        #employeeDetails .input-addon {
            padding: 0.4rem 0.5rem;
            font-size: 0.78rem;
            min-width: 2.6rem;
        }
        #employeeDetails .form-text {
            font-size: 0.72rem;
        }
    </style>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" 
            onerror="console.error('Firebase App failed to load'); window.firebaseLoaded = false;"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" 
            onerror="console.error('Firebase Auth failed to load');"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js" 
            onerror="console.error('Firebase Database failed to load');"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js" 
            onerror="console.error('Firebase Storage failed to load');"></script>
    
    <!-- GitHub Pages Fix Script with error handling -->
    <script src="github-pages-fix.js" 
            onerror="console.warn('GitHub Pages Fix script not found - continuing without it');"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Menu (replicated exactly from project-list.html) -->
        <nav class="sidebar menu-loading" id="sidebar">
            <div class="logo"><h2>Dreamex Datalab</h2></div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    <!-- Risk Management (separate section) -->
<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
<ul class="submenu">
<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
</ul>
</li></ul>
                </li>
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    <ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                        <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
                        <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                        <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <!-- Project Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>
                <!-- Inventory Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                    <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                    <ul class="submenu">
                        <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                        <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                        <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                        <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                        <li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
                        <li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
                    </ul>
                </li>
                <!-- Workspaces: Catering -->
                <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                    <a href="#"><i class="fas fa-utensils"></i> Workspaces ï¿½ Catering</a>
                    <ul class="submenu">
                        <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                        <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                        <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                        <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                        <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="lang-switcher" style="margin-right:.5rem; display:flex; align-items:center; gap:.5rem;">
                        <!-- Circular language toggle button -->
                        <button id="langToggleBtn" type="button" title="Language" aria-label="Language"
                            style="width:36px; height:36px; border-radius:50%; border:1px solid #e5e7eb; background:#ffffff; color:#111827; display:inline-flex; align-items:center; justify-content:center; font-weight:600; font-size:12px; box-shadow:0 1px 2px rgba(0,0,0,0.06); cursor:pointer; transition:background .15s, transform .05s;">
                            EN
                        </button>
                        <!-- Keep the original select for logic, but hide it visually -->
                        <select id="langSelect" title="Language" style="display:none;">
                            <option value="en">English</option>
                            <option value="fr">Franï¿½ais</option>
                        </select>
                    </div>
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHR4dCB4PSIyMCIgeT0iMjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlU8L3R4dD4KPHN2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- Page Header (styled like Staff Management header) -->
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 0.6rem;">
                        <i class="fas fa-file-signature"></i>
                        <span data-i18n="page.title">Create Employee Contract</span>
                    </div>
                    <div class="page-actions">
                        <!-- Optional: add header actions here (e.g., New Contract button) -->
                    </div>
                </div>

                <!-- Tab-based Navigation (matching jobscreen.html) -->
                <div class="content-tabs">
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" id="templateSelectionBtn" onclick="switchTab('templateSelection')">
                            <i class="fas fa-file-alt"></i>
                            <span data-i18n="tab.selectTemplate">Select Template</span>
                        </button>
                        <button class="tab-nav-btn" id="employeeDetailsBtn" onclick="switchTab('employeeDetails')">
                            <i class="fas fa-id-card"></i>
                            <span data-i18n="tab.employeeDetails">Employee Details</span>
                        </button>
                        <button class="tab-nav-btn" id="contractFormBtn" onclick="switchTab('contractForm')">
                            <i class="fas fa-edit"></i>
                            <span data-i18n="tab.fillDetails">Fill Details</span>
                        </button>
                        
                    </div>

                    <!-- Template Selection Tab -->
                    <div class="tab-content active" id="templateSelection">
                        <div class="template-selection">
                            
                            
                            <!-- Loading State -->
                            <div class="loading-templates" id="loadingTemplates">
                                <div class="loading-spinner"></div>
                                <h4 data-i18n="template.loading">Loading Templates...</h4>
                                <p data-i18n="template.loadingDesc">Fetching available contract templates</p>
                            </div>

                            <!-- Template Grid -->
                            <div class="template-grid" id="templateGrid" style="display: none;">
                                <!-- Templates will be loaded here -->
                            </div>

                            <!-- Empty State -->
                            <div class="empty-templates" id="emptyTemplates" style="display: none;">
                                <i class="fas fa-file-alt"></i>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-primary" onclick="window.open('dochtml.html', '_blank')">
                                        <i class="fas fa-plus"></i>
                                        <span data-i18n="template.create">Create Templates</span>
                                    </button>
                                </div>
                            </div>

                            <div class="form-actions">
                                <a href="contract.html" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i>
                                    <span data-i18n="btn.backToContracts">Back to Contracts</span>
                                </a>
                                <button class="btn btn-primary" id="continueToForm" onclick="proceedToForm()" disabled>
                                    <i class="fas fa-arrow-right"></i>
                                    <span data-i18n="btn.continueToEmployee">Continue to Employee Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Details Tab -->
                    <div class="tab-content" id="employeeDetails">
                        <div class="contract-form">

                            <form id="employeeFormData">
                                <!-- Employee Information -->
                                <div class="form-section">
                                    <h4><i class="fas fa-user"></i> <span data-i18n="section.employeeInfo">Employee Information</span></h4>
                                    
                                    <!-- Employee Selection Dropdown -->
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label" data-i18n="label.selectPerson">Select Employee or Candidate</label>
                                            <div class="employee-dropdown-container">
                                                <select class="form-control" id="employeeDropdown" onchange="fillEmployeeDetails()">
                                                    <option value="" data-i18n="option.selectPerson">Select a person (employee or candidate)...</option>
                                                </select>
                                                <div class="loading-employees" id="loadingEmployees" style="display: none;">
                                                    <div class="loading-spinner-small"></div>
                                                    <span data-i18n="loading.employees">Loading employees...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr style="margin: 1.5rem 0; border: 1px solid #e9ecef;">

                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label required">Employee Name</label>
                                            <input type="text" class="form-control" id="employeeName" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">Employee ID</label>
                                            <input type="text" class="form-control" id="employeeId" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">Email</label>
                                            <input type="email" class="form-control" id="employeeEmail" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="employeePhone" readonly>
                                        </div>
                                    </div>

                                    <!-- Seniority Date -->
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label" for="employeeSeniorityDate" data-i18n="label.seniority">Seniority</label>
                                            <input type="date" class="form-control" id="employeeSeniorityDate">
                                            <div class="form-text" data-i18n="hint.seniority">Date used to determine employee seniority.</div>
                                        </div>
                                    </div>

                                    <!-- Additional Employee Information -->
                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.gender">Gender</label>
                                            <select class="form-control" id="gender">
                                                <option value="" data-i18n="option.selectTitle">Select Title</option>
                                                <option value="Sir" data-i18n="option.gender.sir">Sir</option>
                                                <option value="Madam" data-i18n="option.gender.madam">Madam</option>
                                                <option value="Miss" data-i18n="option.gender.miss">Miss</option>
                                                <option value="Doctor" data-i18n="option.gender.doctor">Doctor</option>
                                                <option value="Professor" data-i18n="option.gender.professor">Professor</option>
                                                <option value="Engineer" data-i18n="option.gender.engineer">Engineer</option>
                                                <option value="Other" data-i18n="option.other">Other</option>
                                            </select>
                                            <div class="form-text" data-i18n="hint.gender">Used as salutation (e.g., Sir, Madam, Doctor) in documents.</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.fatherName">Father Name</label>
                                            <input type="text" class="form-control" id="fatherName">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.motherName">Mother Name</label>
                                            <input type="text" class="form-control" id="motherName">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.nationality">Nationality</label>
                                            <select class="form-control" id="nationality">
                                                <option value="" data-i18n="option.selectNationality">Select Nationality</option>
                                                <option value="Afghan">Afghan</option>
                                                <option value="Albanian">Albanian</option>
                                                <option value="Algerian">Algerian</option>
                                                <option value="American">American</option>
                                                <option value="Andorran">Andorran</option>
                                                <option value="Angolan">Angolan</option>
                                                <option value="Antiguan and Barbudan">Antiguan and Barbudan</option>
                                                <option value="Argentinian">Argentinian</option>
                                                <option value="Armenian">Armenian</option>
                                                <option value="Australian">Australian</option>
                                                <option value="Austrian">Austrian</option>
                                                <option value="Azerbaijani">Azerbaijani</option>
                                                <option value="Bahamian">Bahamian</option>
                                                <option value="Bahraini">Bahraini</option>
                                                <option value="Bangladeshi">Bangladeshi</option>
                                                <option value="Barbadian">Barbadian</option>
                                                <option value="Belarusian">Belarusian</option>
                                                <option value="Belgian">Belgian</option>
                                                <option value="Belizean">Belizean</option>
                                                <option value="Beninese">Beninese</option>
                                                <option value="Bhutanese">Bhutanese</option>
                                                <option value="Bolivian">Bolivian</option>
                                                <option value="Bosnian and Herzegovinian">Bosnian and Herzegovinian</option>
                                                <option value="Botswanan">Botswanan</option>
                                                <option value="Brazilian">Brazilian</option>
                                                <option value="Bruneian">Bruneian</option>
                                                <option value="Bulgarian">Bulgarian</option>
                                                <option value="Burkinabï¿½">Burkinabï¿½</option>
                                                <option value="Burundian">Burundian</option>
                                                <option value="Cabo Verdean">Cabo Verdean</option>
                                                <option value="Cambodian">Cambodian</option>
                                                <option value="Cameroonian">Cameroonian</option>
                                                <option value="Canadian">Canadian</option>
                                                <option value="Central African">Central African</option>
                                                <option value="Chadian">Chadian</option>
                                                <option value="Chilean">Chilean</option>
                                                <option value="Chinese">Chinese</option>
                                                <option value="Colombian">Colombian</option>
                                                <option value="Comorian">Comorian</option>
                                                <option value="Congolese">Congolese</option>
                                                <option value="Costa Rican">Costa Rican</option>
                                                <option value="Ivorian">Ivorian</option>
                                                <option value="Croatian">Croatian</option>
                                                <option value="Cuban">Cuban</option>
                                                <option value="Cypriot">Cypriot</option>
                                                <option value="Czech">Czech</option>
                                                <option value="Danish">Danish</option>
                                                <option value="Djiboutian">Djiboutian</option>
                                                <option value="Dominican">Dominican</option>
                                                <option value="Ecuadorian">Ecuadorian</option>
                                                <option value="Egyptian">Egyptian</option>
                                                <option value="Salvadoran">Salvadoran</option>
                                                <option value="Equatorial Guinean">Equatorial Guinean</option>
                                                <option value="Eritrean">Eritrean</option>
                                                <option value="Estonian">Estonian</option>
                                                <option value="Eswatini">Eswatini</option>
                                                <option value="Ethiopian">Ethiopian</option>
                                                <option value="Fijian">Fijian</option>
                                                <option value="Finnish">Finnish</option>
                                                <option value="French">French</option>
                                                <option value="Gabonese">Gabonese</option>
                                                <option value="Gambian">Gambian</option>
                                                <option value="Georgian">Georgian</option>
                                                <option value="German">German</option>
                                                <option value="Ghanaian">Ghanaian</option>
                                                <option value="Greek">Greek</option>
                                                <option value="Grenadian">Grenadian</option>
                                                <option value="Guatemalan">Guatemalan</option>
                                                <option value="Guinean">Guinean</option>
                                                <option value="Bissau-Guinean">Bissau-Guinean</option>
                                                <option value="Guyanese">Guyanese</option>
                                                <option value="Haitian">Haitian</option>
                                                <option value="Honduran">Honduran</option>
                                                <option value="Hungarian">Hungarian</option>
                                                <option value="Icelandic">Icelandic</option>
                                                <option value="Indian">Indian</option>
                                                <option value="Indonesian">Indonesian</option>
                                                <option value="Iranian">Iranian</option>
                                                <option value="Iraqi">Iraqi</option>
                                                <option value="Irish">Irish</option>
                                                <option value="Israeli">Israeli</option>
                                                <option value="Italian">Italian</option>
                                                <option value="Jamaican">Jamaican</option>
                                                <option value="Japanese">Japanese</option>
                                                <option value="Jordanian">Jordanian</option>
                                                <option value="Kazakhstani">Kazakhstani</option>
                                                <option value="Kenyan">Kenyan</option>
                                                <option value="I-Kiribati">I-Kiribati</option>
                                                <option value="Kuwaiti">Kuwaiti</option>
                                                <option value="Kyrgyz">Kyrgyz</option>
                                                <option value="Lao">Lao</option>
                                                <option value="Latvian">Latvian</option>
                                                <option value="Lebanese">Lebanese</option>
                                                <option value="Basotho">Basotho</option>
                                                <option value="Liberian">Liberian</option>
                                                <option value="Libyan">Libyan</option>
                                                <option value="Liechtensteiner">Liechtensteiner</option>
                                                <option value="Lithuanian">Lithuanian</option>
                                                <option value="Luxembourgish">Luxembourgish</option>
                                                <option value="Malagasy">Malagasy</option>
                                                <option value="Malawian">Malawian</option>
                                                <option value="Malaysian">Malaysian</option>
                                                <option value="Maldivian">Maldivian</option>
                                                <option value="Malian">Malian</option>
                                                <option value="Maltese">Maltese</option>
                                                <option value="Marshallese">Marshallese</option>
                                                <option value="Mauritanian">Mauritanian</option>
                                                <option value="Mauritian">Mauritian</option>
                                                <option value="Mexican">Mexican</option>
                                                <option value="Micronesian">Micronesian</option>
                                                <option value="Moldovan">Moldovan</option>
                                                <option value="Monegasque">Monegasque</option>
                                                <option value="Mongolian">Mongolian</option>
                                                <option value="Montenegrin">Montenegrin</option>
                                                <option value="Moroccan">Moroccan</option>
                                                <option value="Mozambican">Mozambican</option>
                                                <option value="Burmese">Burmese</option>
                                                <option value="Namibian">Namibian</option>
                                                <option value="Nauruan">Nauruan</option>
                                                <option value="Nepalese">Nepalese</option>
                                                <option value="Dutch">Dutch</option>
                                                <option value="New Zealander">New Zealander</option>
                                                <option value="Nicaraguan">Nicaraguan</option>
                                                <option value="Nigerien">Nigerien</option>
                                                <option value="Nigerian">Nigerian</option>
                                                <option value="North Korean">North Korean</option>
                                                <option value="North Macedonian">North Macedonian</option>
                                                <option value="Norwegian">Norwegian</option>
                                                <option value="Omani">Omani</option>
                                                <option value="Pakistani">Pakistani</option>
                                                <option value="Palauan">Palauan</option>
                                                <option value="Panamanian">Panamanian</option>
                                                <option value="Papua New Guinean">Papua New Guinean</option>
                                                <option value="Paraguayan">Paraguayan</option>
                                                <option value="Peruvian">Peruvian</option>
                                                <option value="Filipino">Filipino</option>
                                                <option value="Polish">Polish</option>
                                                <option value="Portuguese">Portuguese</option>
                                                <option value="Qatari">Qatari</option>
                                                <option value="Romanian">Romanian</option>
                                                <option value="Russian">Russian</option>
                                                <option value="Rwandan">Rwandan</option>
                                                <option value="Kittitian or Nevisian">Kittitian or Nevisian</option>
                                                <option value="Saint Lucian">Saint Lucian</option>
                                                <option value="Vincentian">Vincentian</option>
                                                <option value="Samoan">Samoan</option>
                                                <option value="Sammarinese">Sammarinese</option>
                                                <option value="Sï¿½o Tomï¿½an">Sï¿½o Tomï¿½an</option>
                                                <option value="Saudi">Saudi</option>
                                                <option value="Senegalese">Senegalese</option>
                                                <option value="Serbian">Serbian</option>
                                                <option value="Seychellois">Seychellois</option>
                                                <option value="Sierra Leonean">Sierra Leonean</option>
                                                <option value="Singaporean">Singaporean</option>
                                                <option value="Slovak">Slovak</option>
                                                <option value="Slovenian">Slovenian</option>
                                                <option value="Solomon Islander">Solomon Islander</option>
                                                <option value="Somali">Somali</option>
                                                <option value="South African">South African</option>
                                                <option value="South Korean">South Korean</option>
                                                <option value="South Sudanese">South Sudanese</option>
                                                <option value="Spanish">Spanish</option>
                                                <option value="Sri Lankan">Sri Lankan</option>
                                                <option value="Sudanese">Sudanese</option>
                                                <option value="Surinamese">Surinamese</option>
                                                <option value="Swedish">Swedish</option>
                                                <option value="Swiss">Swiss</option>
                                                <option value="Syrian">Syrian</option>
                                                <option value="Tajikistani">Tajikistani</option>
                                                <option value="Tanzanian">Tanzanian</option>
                                                <option value="Thai">Thai</option>
                                                <option value="Timorese">Timorese</option>
                                                <option value="Togolese">Togolese</option>
                                                <option value="Tongan">Tongan</option>
                                                <option value="Trinidadian and Tobagonian">Trinidadian and Tobagonian</option>
                                                <option value="Tunisian">Tunisian</option>
                                                <option value="Turkish">Turkish</option>
                                                <option value="Turkmen">Turkmen</option>
                                                <option value="Tuvaluan">Tuvaluan</option>
                                                <option value="Ugandan">Ugandan</option>
                                                <option value="Ukrainian">Ukrainian</option>
                                                <option value="Emirati">Emirati</option>
                                                <option value="British">British</option>
                                                <option value="Uruguayan">Uruguayan</option>
                                                <option value="Uzbekistani">Uzbekistani</option>
                                                <option value="Vanuatuan">Vanuatuan</option>
                                                <option value="Venezuelan">Venezuelan</option>
                                                <option value="Vietnamese">Vietnamese</option>
                                                <option value="Yemeni">Yemeni</option>
                                                <option value="Zambian">Zambian</option>
                                                <option value="Zimbabwean">Zimbabwean</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.birthDate">Birth Date</label>
                                            <input type="date" class="form-control" id="birthDate">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.birthCountry">Birth Country</label>
                                            <select class="form-control" id="birthCountry">
                                                <option value="" data-i18n="option.selectCountry">Select Country</option>
                                                <option value="Afghanistan">Afghanistan</option>
                                                <option value="Albania">Albania</option>
                                                <option value="Algeria">Algeria</option>
                                                <option value="Andorra">Andorra</option>
                                                <option value="Angola">Angola</option>
                                                <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                                                <option value="Argentina">Argentina</option>
                                                <option value="Armenia">Armenia</option>
                                                <option value="Australia">Australia</option>
                                                <option value="Austria">Austria</option>
                                                <option value="Azerbaijan">Azerbaijan</option>
                                                <option value="Bahamas">Bahamas</option>
                                                <option value="Bahrain">Bahrain</option>
                                                <option value="Bangladesh">Bangladesh</option>
                                                <option value="Barbados">Barbados</option>
                                                <option value="Belarus">Belarus</option>
                                                <option value="Belgium">Belgium</option>
                                                <option value="Belize">Belize</option>
                                                <option value="Benin">Benin</option>
                                                <option value="Bhutan">Bhutan</option>
                                                <option value="Bolivia">Bolivia</option>
                                                <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                                                <option value="Botswana">Botswana</option>
                                                <option value="Brazil">Brazil</option>
                                                <option value="Brunei">Brunei</option>
                                                <option value="Bulgaria">Bulgaria</option>
                                                <option value="Burkina Faso">Burkina Faso</option>
                                                <option value="Burundi">Burundi</option>
                                                <option value="Cabo Verde">Cabo Verde</option>
                                                <option value="Cambodia">Cambodia</option>
                                                <option value="Cameroon">Cameroon</option>
                                                <option value="Canada">Canada</option>
                                                <option value="Central African Republic">Central African Republic</option>
                                                <option value="Chad">Chad</option>
                                                <option value="Chile">Chile</option>
                                                <option value="China">China</option>
                                                <option value="Colombia">Colombia</option>
                                                <option value="Comoros">Comoros</option>
                                                <option value="Congo (Congo-Brazzaville)">Congo (Congo-Brazzaville)</option>
                                                <option value="Costa Rica">Costa Rica</option>
                                                <option value="Cï¿½te dï¿½Ivoire">Cï¿½te dï¿½Ivoire</option>
                                                <option value="Croatia">Croatia</option>
                                                <option value="Cuba">Cuba</option>
                                                <option value="Cyprus">Cyprus</option>
                                                <option value="Czechia">Czechia</option>
                                                <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
                                                <option value="Denmark">Denmark</option>
                                                <option value="Djibouti">Djibouti</option>
                                                <option value="Dominica">Dominica</option>
                                                <option value="Dominican Republic">Dominican Republic</option>
                                                <option value="Ecuador">Ecuador</option>
                                                <option value="Egypt">Egypt</option>
                                                <option value="El Salvador">El Salvador</option>
                                                <option value="Equatorial Guinea">Equatorial Guinea</option>
                                                <option value="Eritrea">Eritrea</option>
                                                <option value="Estonia">Estonia</option>
                                                <option value="Eswatini">Eswatini</option>
                                                <option value="Ethiopia">Ethiopia</option>
                                                <option value="Fiji">Fiji</option>
                                                <option value="Finland">Finland</option>
                                                <option value="France">France</option>
                                                <option value="Gabon">Gabon</option>
                                                <option value="Gambia">Gambia</option>
                                                <option value="Georgia">Georgia</option>
                                                <option value="Germany">Germany</option>
                                                <option value="Ghana">Ghana</option>
                                                <option value="Greece">Greece</option>
                                                <option value="Grenada">Grenada</option>
                                                <option value="Guatemala">Guatemala</option>
                                                <option value="Guinea">Guinea</option>
                                                <option value="Guinea-Bissau">Guinea-Bissau</option>
                                                <option value="Guyana">Guyana</option>
                                                <option value="Haiti">Haiti</option>
                                                <option value="Honduras">Honduras</option>
                                                <option value="Hungary">Hungary</option>
                                                <option value="Iceland">Iceland</option>
                                                <option value="India">India</option>
                                                <option value="Indonesia">Indonesia</option>
                                                <option value="Iran">Iran</option>
                                                <option value="Iraq">Iraq</option>
                                                <option value="Ireland">Ireland</option>
                                                <option value="Israel">Israel</option>
                                                <option value="Italy">Italy</option>
                                                <option value="Jamaica">Jamaica</option>
                                                <option value="Japan">Japan</option>
                                                <option value="Jordan">Jordan</option>
                                                <option value="Kazakhstan">Kazakhstan</option>
                                                <option value="Kenya">Kenya</option>
                                                <option value="Kiribati">Kiribati</option>
                                                <option value="Kuwait">Kuwait</option>
                                                <option value="Kyrgyzstan">Kyrgyzstan</option>
                                                <option value="Laos">Laos</option>
                                                <option value="Latvia">Latvia</option>
                                                <option value="Lebanon">Lebanon</option>
                                                <option value="Lesotho">Lesotho</option>
                                                <option value="Liberia">Liberia</option>
                                                <option value="Libya">Libya</option>
                                                <option value="Liechtenstein">Liechtenstein</option>
                                                <option value="Lithuania">Lithuania</option>
                                                <option value="Luxembourg">Luxembourg</option>
                                                <option value="Madagascar">Madagascar</option>
                                                <option value="Malawi">Malawi</option>
                                                <option value="Malaysia">Malaysia</option>
                                                <option value="Maldives">Maldives</option>
                                                <option value="Mali">Mali</option>
                                                <option value="Malta">Malta</option>
                                                <option value="Marshall Islands">Marshall Islands</option>
                                                <option value="Mauritania">Mauritania</option>
                                                <option value="Mauritius">Mauritius</option>
                                                <option value="Mexico">Mexico</option>
                                                <option value="Micronesia">Micronesia</option>
                                                <option value="Moldova">Moldova</option>
                                                <option value="Monaco">Monaco</option>
                                                <option value="Mongolia">Mongolia</option>
                                                <option value="Montenegro">Montenegro</option>
                                                <option value="Morocco">Morocco</option>
                                                <option value="Mozambique">Mozambique</option>
                                                <option value="Myanmar">Myanmar</option>
                                                <option value="Namibia">Namibia</option>
                                                <option value="Nauru">Nauru</option>
                                                <option value="Nepal">Nepal</option>
                                                <option value="Netherlands">Netherlands</option>
                                                <option value="New Zealand">New Zealand</option>
                                                <option value="Nicaragua">Nicaragua</option>
                                                <option value="Niger">Niger</option>
                                                <option value="Nigeria">Nigeria</option>
                                                <option value="North Korea">North Korea</option>
                                                <option value="North Macedonia">North Macedonia</option>
                                                <option value="Norway">Norway</option>
                                                <option value="Oman">Oman</option>
                                                <option value="Pakistan">Pakistan</option>
                                                <option value="Palau">Palau</option>
                                                <option value="Panama">Panama</option>
                                                <option value="Papua New Guinea">Papua New Guinea</option>
                                                <option value="Paraguay">Paraguay</option>
                                                <option value="Peru">Peru</option>
                                                <option value="Philippines">Philippines</option>
                                                <option value="Poland">Poland</option>
                                                <option value="Portugal">Portugal</option>
                                                <option value="Qatar">Qatar</option>
                                                <option value="Romania">Romania</option>
                                                <option value="Russia">Russia</option>
                                                <option value="Rwanda">Rwanda</option>
                                                <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                                                <option value="Saint Lucia">Saint Lucia</option>
                                                <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
                                                <option value="Samoa">Samoa</option>
                                                <option value="San Marino">San Marino</option>
                                                <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                                                <option value="Saudi Arabia">Saudi Arabia</option>
                                                <option value="Senegal">Senegal</option>
                                                <option value="Serbia">Serbia</option>
                                                <option value="Seychelles">Seychelles</option>
                                                <option value="Sierra Leone">Sierra Leone</option>
                                                <option value="Singapore">Singapore</option>
                                                <option value="Slovakia">Slovakia</option>
                                                <option value="Slovenia">Slovenia</option>
                                                <option value="Solomon Islands">Solomon Islands</option>
                                                <option value="Somalia">Somalia</option>
                                                <option value="South Africa">South Africa</option>
                                                <option value="South Korea">South Korea</option>
                                                <option value="South Sudan">South Sudan</option>
                                                <option value="Spain">Spain</option>
                                                <option value="Sri Lanka">Sri Lanka</option>
                                                <option value="Sudan">Sudan</option>
                                                <option value="Suriname">Suriname</option>
                                                <option value="Sweden">Sweden</option>
                                                <option value="Switzerland">Switzerland</option>
                                                <option value="Syria">Syria</option>
                                                <option value="Tajikistan">Tajikistan</option>
                                                <option value="Tanzania">Tanzania</option>
                                                <option value="Thailand">Thailand</option>
                                                <option value="Timor-Leste">Timor-Leste</option>
                                                <option value="Togo">Togo</option>
                                                <option value="Tonga">Tonga</option>
                                                <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                                                <option value="Tunisia">Tunisia</option>
                                                <option value="Turkey">Turkey</option>
                                                <option value="Turkmenistan">Turkmenistan</option>
                                                <option value="Tuvalu">Tuvalu</option>
                                                <option value="Uganda">Uganda</option>
                                                <option value="Ukraine">Ukraine</option>
                                                <option value="United Arab Emirates">United Arab Emirates</option>
                                                <option value="United Kingdom">United Kingdom</option>
                                                <option value="United States">United States</option>
                                                <option value="Uruguay">Uruguay</option>
                                                <option value="Uzbekistan">Uzbekistan</option>
                                                <option value="Vanuatu">Vanuatu</option>
                                                <option value="Venezuela">Venezuela</option>
                                                <option value="Vietnam">Vietnam</option>
                                                <option value="Yemen">Yemen</option>
                                                <option value="Zambia">Zambia</option>
                                                <option value="Zimbabwe">Zimbabwe</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.maritalStatus">Marital Status</label>
                                            <select class="form-control" id="maritalStatus">
                                                <option value="" data-i18n="option.selectStatus">Select Status</option>
                                                <option value="Single" data-i18n="option.marital.single">Single</option>
                                                <option value="Married" data-i18n="option.marital.married">Married</option>
                                                <option value="Divorced" data-i18n="option.marital.divorced">Divorced</option>
                                                <option value="Widowed" data-i18n="option.marital.widowed">Widowed</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.dependents">Dependents</label>
                                            <input type="number" class="form-control" id="dependents" min="0" step="1">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label" data-i18n="label.address">Address</label>
                                            <textarea class="form-control" id="address" rows="2" placeholder="Residential address"></textarea>
                                        </div>
                                    </div>

                                    <div class="form-section" style="margin-top:.5rem;">
                                        <h4><i class="fas fa-phone"></i> <span data-i18n="section.emergencyContact">Emergency Contact</span></h4>
                                        <div id="emergencyContactsContainer" class="form-group" style="margin-bottom: 0;"></div>
                                        <div class="form-group" style="margin-top: .5rem;">
                                            <button type="button" class="btn btn-outline-primary" id="addEmergencyContactBtn">
                                                <i class="fas fa-plus"></i>
                                                <span data-i18n="button.addContact">Add contact</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Position Information -->
                                <div class="form-section">
                                    <h4><i class="fas fa-briefcase"></i> <span data-i18n="section.positionInfo">Position Information</span></h4>
                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.positionTitle">Position Title</label>
                                            <input type="text" class="form-control" id="positionTitle" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.department">Department</label>
                                            <input type="text" class="form-control" id="department" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.reportingManager">Reporting Manager</label>
                                            <input type="text" class="form-control" id="reportingManager" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.location">Location</label>
                                            <select class="form-control" id="workLocation">
                                                <option value="" data-i18n="option.selectWorkArea">Select Work Area</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contract Terms -->
                                <div class="form-section">
                                    <h4><i class="fas fa-calendar-alt"></i> <span data-i18n="section.contractTerms">Contract Terms</span></h4>
                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.contractType">Contract Type</label>
                                            <select class="form-control" id="contractType" required>
                                                <option value="" data-i18n="option.selectContractType">Select Contract Type</option>
                                                <option value="permanent" data-i18n="option.contract.permanent">Permanent</option>
                                                <option value="temporary" data-i18n="option.contract.temporary">Temporary</option>
                                                <option value="contract" data-i18n="option.contract.contract">Contract</option>
                                                <option value="probation" data-i18n="option.contract.probation">Probation</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.employmentType">Employment Type</label>
                                            <select class="form-control" id="employmentType" required>
                                                <option value="" data-i18n="option.selectEmploymentType">Select Employment Type</option>
                                                <option value="full-time" data-i18n="option.emp.fullTime">Full Time</option>
                                                <option value="part-time" data-i18n="option.emp.partTime">Part Time</option>
                                                <option value="consultant" data-i18n="option.emp.consultant">Consultant</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.startDate">Start Date</label>
                                            <input type="date" class="form-control" id="startDate" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.endDate">End Date</label>
                                            <input type="date" class="form-control" id="endDate">
                                        </div>
                                    </div>
                                </div>

                                <!-- Compensation -->
                                <div class="form-section">
                                    <h4><i class="fas fa-dollar-sign"></i> <span data-i18n="section.compensation">Compensation</span></h4>
                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label required" data-i18n="label.salaryAmount">Salary Amount</label>
                                            <div class="input-with-addon">
                                                <input type="number" class="form-control" id="salaryAmount" required readonly>
                                                <span class="input-addon" id="salaryCurrencyBadge">USD</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.grossSalary">Gross Salary</label>
                                            <div class="input-with-addon">
                                                <input type="number" class="form-control" id="grossSalary" min="0" step="0.01" placeholder="Auto-calculated" readonly>
                                                <span class="input-addon" id="grossSalaryCurrencyBadge">USD</span>
                                            </div>
                                            <div class="form-text" data-i18n="hint.grossSalary">Auto-calculated: Salary Amount + Transportation + Accommodation</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Band</label>
                                            <select class="form-control" id="compGrade">
                                                <option value="">Select Band</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Grade</label>
                                            <select class="form-control" id="gradeItemSelect">
                                                <option value="">Select Grade Item</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                                                <span data-i18n="label.transportationAllowance">Transportation Allowance</span>
                                                <button type="button" id="btnHousingAllowanceSettings" title="Settings" aria-label="Transportation allowance settings" onclick="openAllowanceSettings('housing')" style="background:transparent; border:none; color:#6c757d; cursor:pointer; padding:.2rem;">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                            </label>
                                            <input type="number" class="form-control" id="housingAllowance" min="0" step="0.01" placeholder="0" readonly>
                                            <input type="hidden" id="housingAllowanceRule" value="">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                                                <span data-i18n="label.accommodationAllowance">Accommodation Allowance</span>
                                                <button type="button" id="btnAccommodationAllowanceSettings" title="Settings" aria-label="Accommodation allowance settings" onclick="openAllowanceSettings('accommodation')" style="background:transparent; border:none; color:#6c757d; cursor:pointer; padding:.2rem;">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                            </label>
                                            <input type="number" class="form-control" id="accommodationAllowance" min="0" step="0.01" placeholder="0" readonly>
                                            <input type="hidden" id="accommodationAllowanceRule" value="">
                                        </div>
                                    </div>
                                    <div class="form-row" style="display:none;">
                                        <!-- Hidden raw numeric fields used for preview/placeholders/save -->
                                        <input type="hidden" id="minSalary">
                                        <input type="hidden" id="midSalary">
                                        <input type="hidden" id="maxSalary">
                                        <input type="hidden" id="gradeCurrency">
                                    </div>
                                    
                                    
                                </div>

                                <!-- Work Terms -->
                                <div class="form-section">
                                    <h4><i class="fas fa-clock"></i> <span data-i18n="section.workTerms">Work Terms</span></h4>
                                    <div class="form-row four-cols">
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.workingHours">Working Hours (per week)</label>
                                            <input type="number" class="form-control" id="workingHours" min="1" max="80" value="40">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.workingHoursPerDay">Working Hours (per day)</label>
                                            <input type="number" class="form-control" id="workingHoursPerDay" min="1" max="24" value="8">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.noticePeriod">Notice Period (days)</label>
                                            <input type="number" class="form-control" id="noticePeriod" min="0" value="30">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.probationPeriod">Probation Period (months)</label>
                                            <input type="number" class="form-control" id="probationPeriod" min="0" max="12">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" data-i18n="label.annualLeave">Annual Leave (days)</label>
                                            <input type="number" class="form-control" id="annualLeave" min="0" value="20">
                                        </div>
                                    </div>
                                </div>

                                
                                
                            </form>

                            <div class="form-actions">
                                <button class="btn btn-secondary" onclick="switchTab('templateSelection')">
                                    <i class="fas fa-arrow-left"></i>
                                    <span data-i18n="btn.backToTemplates">Back to Templates</span>
                                </button>
                                <button class="btn btn-primary" onclick="switchTab('contractForm')">
                                    <i class="fas fa-arrow-right"></i>
                                    <span data-i18n="btn.nextFillDetails">Next: Fill Details</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Form Tab -->
                    <div class="tab-content" id="contractForm">
                        <div class="contract-form">
                        <h3><i class="fas fa-edit"></i> <span data-i18n="section.contractDetails">Contract Details</span></h3>
                        <p data-i18n="contract.detailsDesc">Fill in the required information to create the employee contract.</p>

                        <!-- Exact Template Preview from Document Template Creator -->
                        <div class="template-content-display" id="selectedTemplateDisplay" style="margin-bottom: 1rem;">
                            <h4><i class="fas fa-file-contract"></i> <span data-i18n="section.selectedTemplate">Selected Template</span></h4>
                            <div id="selectedTemplateRender"><!-- A4-rendered template will appear here --></div>
                        </div>

                        <form id="contractFormData">
                            <!-- Dynamic template fields will be loaded here based on the selected template -->
                        </form>

                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="backToTemplateSelection()">
                                <i class="fas fa-arrow-left"></i>
                                <span data-i18n="btn.backToTemplates">Back to Templates</span>
                            </button>
                            <button class="btn btn-success" onclick="createContract()">
                                <i class="fas fa-check"></i>
                                <span data-i18n="btn.createContract">Create Contract</span>
                            </button>
                        </div>
                        </div>
                    </div>
                    
                </div>
            </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- External scripts removed to prevent unauthorized redirections -->
    <!-- All authentication and configuration handled inline for standalone operation -->
    
    <script>
        // Standalone Page Safety Checks and Error Handling
        console.log('?? Initializing Contract Creation Page (Standalone Mode)');
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('?? Global error caught:', e.error || e.message);
            // Continue execution - don't let errors break the page
            return true;
        });
        
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
            console.error('? Firebase is not available - some features may not work');
            window.firebaseAvailable = false;
        } else {
            window.firebaseAvailable = true;
            console.log('? Firebase is available');
        }
        
        // Firebase Configuration for Compat SDK
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase with error handling
        let database = null;
        try {
            if (window.firebaseAvailable && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('? Firebase initialized successfully');
            } else if (window.firebaseAvailable && firebase.apps.length > 0) {
                database = firebase.database();
                console.log('? Using existing Firebase instance');
            }
        } catch (error) {
            console.error('? Firebase initialization failed:', error);
            window.firebaseAvailable = false;
        }
        
    // Contract Creation Variables
    let templates = [];
    let selectedTemplate = null;
    let currentUser = null;
    // Edit mode state
    let editMode = false;
    let editContractId = null;
    let editCompanyId = null;
    let loadedContractData = null;
    let employees = [];
    // Quick lookup for company users (from companymanagement.html modal saves)
    // Built in loadEmployees() and used to fetch authoritative Job Title
    let companyUsersIndex = { byEmail: {}, byUid: {} };
    // Dynamic lists cache for work areas (sites)
    let siteOptions = [];
        
        // =========================
        // Lightweight i18n (EN/FR)
        // =========================
        const CONTRACT_I18N_KEY = 'app_lang';
        const I18N_DICTIONARY = {
            en: {
                'page.title': 'Create Employee Contract',
                'tab.selectTemplate': 'Select Template',
                'tab.employeeDetails': 'Employee Details',
                'tab.fillDetails': 'Fill Details',
                'tab.reviewCreate': 'Review & Create',
                'template.selectHeader': 'Select Contract Template',
                'template.selectDesc': 'Choose a template to use as the basis for your employee contract. Templates are created in the Document Template Creator.',
                'template.loading': 'Loading Templates...',
                'template.loadingDesc': 'Fetching available contract templates',
                'template.create': 'Create Templates',
                'btn.backToContracts': 'Back to Contracts',
                'btn.continueToEmployee': 'Continue to Employee Details',
                'section.employeeInfo': 'Employee Information',
                'label.selectPerson': 'Select Employee or Candidate',
                'option.selectPerson': 'Select a person (employee or candidate)...',
                'loading.employees': 'Loading employees...',
                'label.gender': 'Gender',
                'option.selectTitle': 'Select Title',
                'option.gender.sir': 'Sir',
                'option.gender.madam': 'Madam',
                'option.gender.miss': 'Miss',
                'option.gender.doctor': 'Doctor',
                'option.gender.professor': 'Professor',
                'option.gender.engineer': 'Engineer',
                'option.other': 'Other',
                'hint.gender': 'Used as salutation (e.g., Sir, Madam, Doctor) in documents.',
                'label.fatherName': 'Father Name',
                'label.motherName': 'Mother Name',
                'label.nationality': 'Nationality',
                'option.selectNationality': 'Select Nationality',
                'label.birthDate': 'Birth Date',
                'label.birthCountry': 'Birth Country',
                'option.selectCountry': 'Select Country',
                'label.maritalStatus': 'Marital Status',
                'option.selectStatus': 'Select Status',
                'option.marital.single': 'Single',
                'option.marital.married': 'Married',
                'option.marital.divorced': 'Divorced',
                'option.marital.widowed': 'Widowed',
                'label.dependents': 'Dependents',
                'label.address': 'Address',
                'section.emergencyContact': 'Emergency Contact',
                'label.fullName': 'Full Name',
                'label.relationship': 'Relationship',
                'option.selectRelationship': 'Select Relationship',
                'label.email': 'Email',
                'button.addContact': 'Add contact',
                'button.remove': 'Remove',
                'option.rel.spouse': 'Spouse',
                'option.rel.parent': 'Parent',
                'option.rel.father': 'Father',
                'option.rel.mother': 'Mother',
                'option.rel.sibling': 'Sibling',
                'option.rel.brother': 'Brother',
                'option.rel.sister': 'Sister',
                'option.rel.child': 'Child',
                'option.rel.son': 'Son',
                'option.rel.daughter': 'Daughter',
                'option.rel.relative': 'Relative',
                'option.rel.friend': 'Friend',
                'option.rel.guardian': 'Guardian',
                'option.rel.colleague': 'Colleague',
                'label.contact': 'Contact',
                'section.positionInfo': 'Position Information',
                'label.positionTitle': 'Position Title',
                'label.department': 'Department',
                'label.reportingManager': 'Reporting Manager',
                'label.location': 'Location',
                'option.selectWorkArea': 'Select Work Area',
                'section.contractTerms': 'Contract Terms',
                'label.contractType': 'Contract Type',
                'option.selectContractType': 'Select Contract Type',
                'option.contract.permanent': 'Permanent',
                'option.contract.temporary': 'Temporary',
                'option.contract.contract': 'Contract',
                'option.contract.probation': 'Probation',
                'label.employmentType': 'Employment Type',
                'option.selectEmploymentType': 'Select Employment Type',
                'option.emp.fullTime': 'Full Time',
                'option.emp.partTime': 'Part Time',
                'option.emp.consultant': 'Consultant',
                'label.startDate': 'Start Date',
                'label.endDate': 'End Date',
                'section.compensation': 'Compensation',
                'label.salaryAmount': 'Salary Amount',
                'label.grossSalary': 'Gross Salary',
                'hint.grossSalary': 'Auto-calculated: Salary Amount + Transportation + Accommodation',
                'label.grade': 'Grade',
                'option.selectGrade': 'Select Grade and Step (Min/Mid/Max)',
                'hint.grade': 'Pick Band name and step (Min/Mid/Max). Currency and Salary Amount will auto-fill.',
                'label.transportationAllowance': 'Transportation Allowance',
                'label.accommodationAllowance': 'Accommodation Allowance',
                'section.workTerms': 'Work Terms',
                'label.workingHours': 'Working Hours (per week)',
                'label.workingHoursPerDay': 'Working Hours (per day)',
                'label.noticePeriod': 'Notice Period (days)',
                'label.probationPeriod': 'Probation Period (months)',
                'label.annualLeave': 'Annual Leave (days)',
                'btn.backToTemplates': 'Back to Templates',
                'btn.nextFillDetails': 'Next: Fill Details',
                'section.contractDetails': 'Contract Details',
                'contract.detailsDesc': 'Fill in the required information to create the employee contract.',
                'section.selectedTemplate': 'Selected Template',
                'btn.previewContract': 'Preview Contract',
                'btn.createContract': 'Create Contract',
                'section.previewReview': 'Contract Preview & Review',
                'preview.desc': 'Review the complete contract before creating it. Make any final adjustments if needed.',
                'section.completePreview': 'Complete Contract Preview',
                'btn.backToForm': 'Back to Form',
                'msg.enterJobTitleFirst': 'Enter Job Title first',
                'option.noPeopleFound': 'No people found'
            },
            fr: {
                'page.title': 'Crï¿½er un contrat de travail',
                'tab.selectTemplate': 'Sï¿½lectionner un modï¿½le',
                'tab.employeeDetails': 'Dï¿½tails de lï¿½employï¿½',
                'tab.fillDetails': 'Remplir les dï¿½tails',
                'tab.reviewCreate': 'Relire et crï¿½er',
                'template.selectHeader': 'Sï¿½lectionner un modï¿½le de contrat',
                'template.selectDesc': 'Choisissez un modï¿½le comme base pour votre contrat. Les modï¿½les sont crï¿½ï¿½s dans le crï¿½ateur de documents.',
                'template.loading': 'Chargement des modï¿½lesï¿½',
                'template.loadingDesc': 'Rï¿½cupï¿½ration des modï¿½les disponibles',
                'template.create': 'Crï¿½er des modï¿½les',
                'btn.backToContracts': 'Retour aux contrats',
                'btn.continueToEmployee': 'Continuer vers les dï¿½tails de lï¿½employï¿½',
                'section.employeeInfo': 'Informations sur lï¿½employï¿½',
                'label.selectPerson': 'Sï¿½lectionner un employï¿½ ou un candidat',
                'option.selectPerson': 'Sï¿½lectionnez une personne (employï¿½ ou candidat)ï¿½',
                'loading.employees': 'Chargement des employï¿½sï¿½',
                'label.gender': 'Civilitï¿½',
                'option.selectTitle': 'Sï¿½lectionner une civilitï¿½',
                'option.gender.sir': 'Monsieur',
                'option.gender.madam': 'Madame',
                'option.gender.miss': 'Mademoiselle',
                'option.gender.doctor': 'Docteur',
                'option.gender.professor': 'Professeur',
                'option.gender.engineer': 'Ingï¿½nieur',
                'option.other': 'Autre',
                'hint.gender': 'Utilisï¿½e comme salutation (ex. Monsieur, Madame, Docteur) dans les documents.',
                'label.fatherName': 'Nom du pï¿½re',
                'label.motherName': 'Nom de la mï¿½re',
                'label.nationality': 'Nationalitï¿½',
                'option.selectNationality': 'Sï¿½lectionner la nationalitï¿½',
                'label.birthDate': 'Date de naissance',
                'label.birthCountry': 'Pays de naissance',
                'option.selectCountry': 'Sï¿½lectionner un pays',
                'label.maritalStatus': 'ï¿½tat civil',
                'option.selectStatus': 'Sï¿½lectionner lï¿½ï¿½tat civil',
                'option.marital.single': 'Cï¿½libataire',
                'option.marital.married': 'Mariï¿½(e)',
                'option.marital.divorced': 'Divorcï¿½(e)',
                'option.marital.widowed': 'Veuf(ve)',
                'label.dependents': 'Personnes ï¿½ charge',
                'label.address': 'Adresse',
                'section.emergencyContact': 'Contact dï¿½urgence',
                'label.fullName': 'Nom complet',
                'label.relationship': 'Lien',
                'option.selectRelationship': 'Sï¿½lectionner un lien',
                'label.email': 'E-mail',
                'button.addContact': 'Ajouter un contact',
                'button.remove': 'Supprimer',
                'option.rel.spouse': 'Conjoint(e)',
                'option.rel.parent': 'Parent',
                'option.rel.father': 'Pï¿½re',
                'option.rel.mother': 'Mï¿½re',
                'option.rel.sibling': 'Fratrie',
                'option.rel.brother': 'Frï¿½re',
                'option.rel.sister': 'Sï¿½ur',
                'option.rel.child': 'Enfant',
                'option.rel.son': 'Fils',
                'option.rel.daughter': 'Fille',
                'option.rel.relative': 'Proche',
                'option.rel.friend': 'Ami(e)',
                'option.rel.guardian': 'Tuteur/Tutrice',
                'option.rel.colleague': 'Collï¿½gue',
                'label.contact': 'Contact',
                'section.positionInfo': 'Informations sur le poste',
                'label.positionTitle': 'Intitulï¿½ du poste',
                'label.department': 'Dï¿½partement',
                'label.reportingManager': 'Manager hiï¿½rarchique',
                'label.location': 'Lieu',
                'option.selectWorkArea': 'Sï¿½lectionner une zone de travail',
                'section.contractTerms': 'Conditions du contrat',
                'label.contractType': 'Type de contrat',
                'option.selectContractType': 'Sï¿½lectionner un type de contrat',
                'option.contract.permanent': 'CDI',
                'option.contract.temporary': 'Temporaire',
                'option.contract.contract': 'Contrat',
                'option.contract.probation': 'Pï¿½riode dï¿½essai',
                'label.employmentType': 'Type dï¿½emploi',
                'option.selectEmploymentType': 'Sï¿½lectionner un type dï¿½emploi',
                'option.emp.fullTime': 'Temps plein',
                'option.emp.partTime': 'Temps partiel',
                'option.emp.consultant': 'Consultant',
                'label.startDate': 'Date de dï¿½but',
                'label.endDate': 'Date de fin',
                'section.compensation': 'Rï¿½munï¿½ration',
                'label.salaryAmount': 'Salaire',
                'label.grossSalary': 'Salaire brut',
                'hint.grossSalary': 'Auto-calculï¿½ : Salaire + Transport + Hï¿½bergement',
                'label.grade': 'Niveau/Grade',
                'option.selectGrade': 'Sï¿½lectionnez le grade et lï¿½ï¿½chelon (Min/Mid/Max)',
                'hint.grade': 'Choisissez le grade et lï¿½ï¿½chelon. La devise et le salaire seront remplis automatiquement.',
                'label.transportationAllowance': 'Indemnitï¿½ de transport',
                'label.accommodationAllowance': 'Indemnitï¿½ de logement',
                'section.workTerms': 'Conditions de travail',
                'label.workingHours': 'Heures de travail (par semaine)',
                'label.workingHoursPerDay': 'Heures de travail (par jour)',
                'label.noticePeriod': 'Prï¿½avis (jours)',
                'label.probationPeriod': 'Pï¿½riode dï¿½essai (mois)',
                'label.annualLeave': 'Congï¿½s annuels (jours)',
                'btn.backToTemplates': 'Retour aux modï¿½les',
                'btn.nextFillDetails': 'Suivant : Remplir les dï¿½tails',
                'section.contractDetails': 'Dï¿½tails du contrat',
                'contract.detailsDesc': 'Renseignez les informations requises pour crï¿½er le contrat.',
                'section.selectedTemplate': 'Modï¿½le sï¿½lectionnï¿½',
                'btn.previewContract': 'Aperï¿½u du contrat',
                'btn.createContract': 'Crï¿½er le contrat',
                'section.previewReview': 'Aperï¿½u et relecture du contrat',
                'preview.desc': 'Relisez le contrat complet avant de le crï¿½er. Apportez les derniers ajustements si nï¿½cessaire.',
                'section.completePreview': 'Aperï¿½u complet du contrat',
                'btn.backToForm': 'Retour au formulaire',
                'msg.enterJobTitleFirst': 'Saisissez dï¿½abord lï¿½intitulï¿½ du poste',
                'option.noPeopleFound': 'Aucune personne trouvï¿½e'
            }
        };

        // =========================
        // Nationalities (EN/FR)
        // Values are stable (English demonyms); labels change by language
        // =========================
        const NATIONALITIES = [
            { value: 'Afghan', en: 'Afghan', fr: 'Afghan(e)' },
            { value: 'Albanian', en: 'Albanian', fr: 'Albanais(e)' },
            { value: 'Algerian', en: 'Algerian', fr: 'Algï¿½rien(ne)' },
            { value: 'American', en: 'American', fr: 'Amï¿½ricain(e)' },
            { value: 'Andorran', en: 'Andorran', fr: 'Andorran(e)' },
            { value: 'Angolan', en: 'Angolan', fr: 'Angolais(e)' },
            { value: 'Antiguan and Barbudan', en: 'Antiguan and Barbudan', fr: 'Antiguais(e) et Barbudien(ne)' },
            { value: 'Argentine', en: 'Argentine', fr: 'Argentin(e)' },
            { value: 'Armenian', en: 'Armenian', fr: 'Armï¿½nien(ne)' },
            { value: 'Australian', en: 'Australian', fr: 'Australien(ne)' },
            { value: 'Austrian', en: 'Austrian', fr: 'Autrichien(ne)' },
            { value: 'Azerbaijani', en: 'Azerbaijani', fr: 'Azerbaï¿½djanais(e)' },
            { value: 'Bahamian', en: 'Bahamian', fr: 'Bahamï¿½en(ne)' },
            { value: 'Bahraini', en: 'Bahraini', fr: 'Bahreï¿½nien(ne)' },
            { value: 'Bangladeshi', en: 'Bangladeshi', fr: 'Bangladais(e)' },
            { value: 'Barbadian', en: 'Barbadian', fr: 'Barbadien(ne)' },
            { value: 'Belarusian', en: 'Belarusian', fr: 'Biï¿½lorusse' },
            { value: 'Belgian', en: 'Belgian', fr: 'Belge' },
            { value: 'Belizean', en: 'Belizean', fr: 'Bï¿½lizien(ne)' },
            { value: 'Beninese', en: 'Beninese', fr: 'Bï¿½ninois(e)' },
            { value: 'Bhutanese', en: 'Bhutanese', fr: 'Bhoutanais(e)' },
            { value: 'Bolivian', en: 'Bolivian', fr: 'Bolivien(ne)' },
            { value: 'Bosnian', en: 'Bosnian', fr: 'Bosniaque' },
            { value: 'Botswanan', en: 'Botswanan', fr: 'Botswanais(e)' },
            { value: 'Brazilian', en: 'Brazilian', fr: 'Brï¿½silien(ne)' },
            { value: 'British', en: 'British', fr: 'Britannique' },
            { value: 'Bruneian', en: 'Bruneian', fr: 'Brunï¿½ien(ne)' },
            { value: 'Bulgarian', en: 'Bulgarian', fr: 'Bulgare' },
            { value: 'Burkinabï¿½', en: 'Burkinabï¿½', fr: 'Burkinabï¿½' },
            { value: 'Burmese', en: 'Burmese', fr: 'Birman(e)' },
            { value: 'Burundian', en: 'Burundian', fr: 'Burundais(e)' },
            { value: 'Cambodian', en: 'Cambodian', fr: 'Cambodgien(ne)' },
            { value: 'Cameroonian', en: 'Cameroonian', fr: 'Camerounais(e)' },
            { value: 'Canadian', en: 'Canadian', fr: 'Canadien(ne)' },
            { value: 'Cape Verdean', en: 'Cape Verdean', fr: 'Cap-Verdien(ne)' },
            { value: 'Central African', en: 'Central African', fr: 'Centrafricain(e)' },
            { value: 'Chadian', en: 'Chadian', fr: 'Tchadien(ne)' },
            { value: 'Chilean', en: 'Chilean', fr: 'Chilien(ne)' },
            { value: 'Chinese', en: 'Chinese', fr: 'Chinois(e)' },
            { value: 'Colombian', en: 'Colombian', fr: 'Colombien(ne)' },
            { value: 'Comorian', en: 'Comorian', fr: 'Comorien(ne)' },
            { value: 'Congolese (Congo-Brazzaville)', en: 'Congolese (Congo-Brazzaville)', fr: 'Congolais(e) (Congo-Brazzaville)' },
            { value: 'Congolese (DR Congo)', en: 'Congolese (DR Congo)', fr: 'Congolais(e) (RDC)' },
            { value: 'Costa Rican', en: 'Costa Rican', fr: 'Costaricien(ne)' },
            { value: 'Croatian', en: 'Croatian', fr: 'Croate' },
            { value: 'Cuban', en: 'Cuban', fr: 'Cubain(e)' },
            { value: 'Cypriot', en: 'Cypriot', fr: 'Chypriote' },
            { value: 'Czech', en: 'Czech', fr: 'Tchï¿½que' },
            { value: 'Danish', en: 'Danish', fr: 'Danois(e)' },
            { value: 'Djiboutian', en: 'Djiboutian', fr: 'Djiboutien(ne)' },
            { value: 'Dominican (Dominica)', en: 'Dominican (Dominica)', fr: 'Dominiquais(e)' },
            { value: 'Dominican (Dominican Republic)', en: 'Dominican (Dominican Republic)', fr: 'Dominicain(e)' },
            { value: 'Dutch', en: 'Dutch', fr: 'Nï¿½erlandais(e)' },
            { value: 'East Timorese', en: 'East Timorese', fr: 'Timorais(e)' },
            { value: 'Ecuadorean', en: 'Ecuadorean', fr: 'ï¿½quatorien(ne)' },
            { value: 'Egyptian', en: 'Egyptian', fr: 'ï¿½gyptien(ne)' },
            { value: 'Emirati', en: 'Emirati', fr: 'ï¿½mirati(e)' },
            { value: 'English', en: 'English', fr: 'Anglais(e)' },
            { value: 'Equatorial Guinean', en: 'Equatorial Guinean', fr: 'ï¿½quato-Guinï¿½en(ne)' },
            { value: 'Eritrean', en: 'Eritrean', fr: 'ï¿½rythrï¿½en(ne)' },
            { value: 'Estonian', en: 'Estonian', fr: 'Estonien(ne)' },
            { value: 'Ethiopian', en: 'Ethiopian', fr: 'ï¿½thiopien(ne)' },
            { value: 'Fijian', en: 'Fijian', fr: 'Fidjien(ne)' },
            { value: 'Finnish', en: 'Finnish', fr: 'Finlandais(e)' },
            { value: 'French', en: 'French', fr: 'Franï¿½ais(e)' },
            { value: 'Gabonese', en: 'Gabonese', fr: 'Gabonais(e)' },
            { value: 'Gambian', en: 'Gambian', fr: 'Gambien(ne)' },
            { value: 'Georgian', en: 'Georgian', fr: 'Gï¿½orgien(ne)' },
            { value: 'German', en: 'German', fr: 'Allemand(e)' },
            { value: 'Ghanaian', en: 'Ghanaian', fr: 'Ghanï¿½en(ne)' },
            { value: 'Greek', en: 'Greek', fr: 'Grec(que)' },
            { value: 'Grenadian', en: 'Grenadian', fr: 'Grenadien(ne)' },
            { value: 'Guatemalan', en: 'Guatemalan', fr: 'Guatï¿½maltï¿½que' },
            { value: 'Guinean', en: 'Guinean', fr: 'Guinï¿½en(ne)' },
            { value: 'Bissau-Guinean', en: 'Bissau-Guinean', fr: 'Bissao-Guinï¿½en(ne)' },
            { value: 'Guyanese', en: 'Guyanese', fr: 'Guyanien(ne)' },
            { value: 'Haitian', en: 'Haitian', fr: 'Haï¿½tien(ne)' },
            { value: 'Honduran', en: 'Honduran', fr: 'Hondurien(ne)' },
            { value: 'Hungarian', en: 'Hungarian', fr: 'Hongrois(e)' },
            { value: 'Icelander', en: 'Icelander', fr: 'Islandais(e)' },
            { value: 'Indian', en: 'Indian', fr: 'Indien(ne)' },
            { value: 'Indonesian', en: 'Indonesian', fr: 'Indonï¿½sien(ne)' },
            { value: 'Iranian', en: 'Iranian', fr: 'Iranien(ne)' },
            { value: 'Iraqi', en: 'Iraqi', fr: 'Irakien(ne)' },
            { value: 'Irish', en: 'Irish', fr: 'Irlandais(e)' },
            { value: 'Israeli', en: 'Israeli', fr: 'Israï¿½lien(ne)' },
            { value: 'Italian', en: 'Italian', fr: 'Italien(ne)' },
            { value: 'Ivorian', en: 'Ivorian', fr: 'Ivoirien(ne)' },
            { value: 'Jamaican', en: 'Jamaican', fr: 'Jamaï¿½cain(e)' },
            { value: 'Japanese', en: 'Japanese', fr: 'Japonais(e)' },
            { value: 'Jordanian', en: 'Jordanian', fr: 'Jordanien(ne)' },
            { value: 'Kazakh', en: 'Kazakh', fr: 'Kazakh' },
            { value: 'Kenyan', en: 'Kenyan', fr: 'Kï¿½nyan(ne)' },
            { value: 'Kiribati', en: 'Kiribati', fr: 'Kiribatien(ne)' },
            { value: 'Kuwaiti', en: 'Kuwaiti', fr: 'Koweï¿½tien(ne)' },
            { value: 'Kyrgyz', en: 'Kyrgyz', fr: 'Kirghize' },
            { value: 'Laotian', en: 'Laotian', fr: 'Laotien(ne)' },
            { value: 'Latvian', en: 'Latvian', fr: 'Letton(ne)' },
            { value: 'Lebanese', en: 'Lebanese', fr: 'Libanais(e)' },
            { value: 'Liberian', en: 'Liberian', fr: 'Libï¿½rien(ne)' },
            { value: 'Libyan', en: 'Libyan', fr: 'Libyen(ne)' },
            { value: 'Liechtensteiner', en: 'Liechtensteiner', fr: 'Liechtensteinois(e)' },
            { value: 'Lithuanian', en: 'Lithuanian', fr: 'Lituanien(ne)' },
            { value: 'Luxembourgish', en: 'Luxembourgish', fr: 'Luxembourgeois(e)' },
            { value: 'Macedonian', en: 'Macedonian', fr: 'Macï¿½donien(ne)' },
            { value: 'Malagasy', en: 'Malagasy', fr: 'Malgache' },
            { value: 'Malawian', en: 'Malawian', fr: 'Malawien(ne)' },
            { value: 'Malaysian', en: 'Malaysian', fr: 'Malaisien(ne)' },
            { value: 'Maldivian', en: 'Maldivian', fr: 'Maldivien(ne)' },
            { value: 'Malian', en: 'Malian', fr: 'Malien(ne)' },
            { value: 'Maltese', en: 'Maltese', fr: 'Maltais(e)' },
            { value: 'Marshallese', en: 'Marshallese', fr: 'Marshallais(e)' },
            { value: 'Mauritanian', en: 'Mauritanian', fr: 'Mauritanien(ne)' },
            { value: 'Mauritian', en: 'Mauritian', fr: 'Mauricien(ne)' },
            { value: 'Mexican', en: 'Mexican', fr: 'Mexicain(e)' },
            { value: 'Micronesian', en: 'Micronesian', fr: 'Micronï¿½sien(ne)' },
            { value: 'Moldovan', en: 'Moldovan', fr: 'Moldave' },
            { value: 'Monï¿½gasque', en: 'Monegasque', fr: 'Monï¿½gasque' },
            { value: 'Mongolian', en: 'Mongolian', fr: 'Mongol(e)' },
            { value: 'Montenegrin', en: 'Montenegrin', fr: 'Montï¿½nï¿½grin(e)' },
            { value: 'Moroccan', en: 'Moroccan', fr: 'Marocain(e)' },
            { value: 'Mozambican', en: 'Mozambican', fr: 'Mozambicain(e)' },
            { value: 'Namibian', en: 'Namibian', fr: 'Namibien(ne)' },
            { value: 'Nauruan', en: 'Nauruan', fr: 'Nauruan(e)' },
            { value: 'Nepalese', en: 'Nepalese', fr: 'Nï¿½palais(e)' },
            { value: 'New Zealander', en: 'New Zealander', fr: 'Nï¿½o-Zï¿½landais(e)' },
            { value: 'Nicaraguan', en: 'Nicaraguan', fr: 'Nicaraguayen(ne)' },
            { value: 'Nigerien', en: 'Nigerien', fr: 'Nigï¿½rien(ne)' },
            { value: 'Nigerian', en: 'Nigerian', fr: 'Nigï¿½rian(ne)' },
            { value: 'Niuean', en: 'Niuean', fr: 'Niuï¿½en(ne)' },
            { value: 'North Korean', en: 'North Korean', fr: 'Nord-Corï¿½en(ne)' },
            { value: 'Northern Irish', en: 'Northern Irish', fr: 'Nord-Irlandais(e)' },
            { value: 'Norwegian', en: 'Norwegian', fr: 'Norvï¿½gien(ne)' },
            { value: 'Omani', en: 'Omani', fr: 'Omanais(e)' },
            { value: 'Pakistani', en: 'Pakistani', fr: 'Pakistanais(e)' },
            { value: 'Palauan', en: 'Palauan', fr: 'Palaosien(ne)' },
            { value: 'Panamanian', en: 'Panamanian', fr: 'Panamï¿½en(ne)' },
            { value: 'Papua New Guinean', en: 'Papua New Guinean', fr: 'Papou-Nï¿½o-Guinï¿½en(ne)' },
            { value: 'Paraguayan', en: 'Paraguayan', fr: 'Paraguayen(ne)' },
            { value: 'Peruvian', en: 'Peruvian', fr: 'Pï¿½ruvien(ne)' },
            { value: 'Filipino', en: 'Filipino', fr: 'Philippin(e)' },
            { value: 'Polish', en: 'Polish', fr: 'Polonais(e)' },
            { value: 'Portuguese', en: 'Portuguese', fr: 'Portugais(e)' },
            { value: 'Qatari', en: 'Qatari', fr: 'Qatari' },
            { value: 'Romanian', en: 'Romanian', fr: 'Roumain(e)' },
            { value: 'Russian', en: 'Russian', fr: 'Russe' },
            { value: 'Rwandan', en: 'Rwandan', fr: 'Rwandais(e)' },
            { value: 'Saint Lucian', en: 'Saint Lucian', fr: 'Saint-Lucien(ne)' },
            { value: 'Salvadoran', en: 'Salvadoran', fr: 'Salvadorien(ne)' },
            { value: 'Sammarinese', en: 'Sammarinese', fr: 'Saint-Marinais(e)' },
            { value: 'Samoan', en: 'Samoan', fr: 'Samoan(e)' },
            { value: 'Sï¿½o Tomï¿½an', en: 'Sï¿½o Tomï¿½an', fr: 'Santomï¿½en(ne)' },
            { value: 'Saudi', en: 'Saudi', fr: 'Saoudien(ne)' },
            { value: 'Scottish', en: 'Scottish', fr: 'ï¿½cossais(e)' },
            { value: 'Senegalese', en: 'Senegalese', fr: 'Sï¿½nï¿½galais(e)' },
            { value: 'Serbian', en: 'Serbian', fr: 'Serbe' },
            { value: 'Seychellois', en: 'Seychellois', fr: 'Seychellois(e)' },
            { value: 'Sierra Leonean', en: 'Sierra Leonean', fr: 'Sierralï¿½onais(e)' },
            { value: 'Singaporean', en: 'Singaporean', fr: 'Singapourien(ne)' },
            { value: 'Slovak', en: 'Slovak', fr: 'Slovaque' },
            { value: 'Slovene', en: 'Slovene', fr: 'Slovï¿½ne' },
            { value: 'Solomon Islander', en: 'Solomon Islander', fr: 'Salomonien(ne)' },
            { value: 'Somali', en: 'Somali', fr: 'Somalien(ne)' },
            { value: 'South African', en: 'South African', fr: 'Sud-Africain(e)' },
            { value: 'South Korean', en: 'South Korean', fr: 'Sud-Corï¿½en(ne)' },
            { value: 'South Sudanese', en: 'South Sudanese', fr: 'Sud-Soudanais(e)' },
            { value: 'Spanish', en: 'Spanish', fr: 'Espagnol(e)' },
            { value: 'Sri Lankan', en: 'Sri Lankan', fr: 'Sri-Lankais(e)' },
            { value: 'Sudanese', en: 'Sudanese', fr: 'Soudanais(e)' },
            { value: 'Surinamese', en: 'Surinamese', fr: 'Surinamais(e)' },
            { value: 'Swazi', en: 'Swazi', fr: 'Eswatinien(ne)' },
            { value: 'Swedish', en: 'Swedish', fr: 'Suï¿½dois(e)' },
            { value: 'Swiss', en: 'Swiss', fr: 'Suisse' },
            { value: 'Syrian', en: 'Syrian', fr: 'Syrien(ne)' },
            { value: 'Taiwanese', en: 'Taiwanese', fr: 'Taï¿½wanais(e)' },
            { value: 'Tajik', en: 'Tajik', fr: 'Tadjik(e)' },
            { value: 'Tanzanian', en: 'Tanzanian', fr: 'Tanzanien(ne)' },
            { value: 'Thai', en: 'Thai', fr: 'Thaï¿½landais(e)' },
            { value: 'Togolese', en: 'Togolese', fr: 'Togolais(e)' },
            { value: 'Tongan', en: 'Tongan', fr: 'Tongien(ne)' },
            { value: 'Trinidadian or Tobagonian', en: 'Trinidadian or Tobagonian', fr: 'Trinidadien(ne) ou Tobagonien(ne)' },
            { value: 'Tunisian', en: 'Tunisian', fr: 'Tunisien(ne)' },
            { value: 'Turkish', en: 'Turkish', fr: 'Turc(que)' },
            { value: 'Turkmen', en: 'Turkmen', fr: 'Turkmï¿½ne' },
            { value: 'Tuvaluan', en: 'Tuvaluan', fr: 'Tuvaluan(e)' },
            { value: 'Ugandan', en: 'Ugandan', fr: 'Ougandais(e)' },
            { value: 'Ukrainian', en: 'Ukrainian', fr: 'Ukrainien(ne)' },
            { value: 'Uruguayan', en: 'Uruguayan', fr: 'Uruguayen(ne)' },
            { value: 'Uzbek', en: 'Uzbek', fr: 'Ouzbek' },
            { value: 'Vanuatuan', en: 'Vanuatuan', fr: 'Vanuatuan(e)' },
            { value: 'Vatican', en: 'Vatican', fr: 'Vatican' },
            { value: 'Venezuelan', en: 'Venezuelan', fr: 'Vï¿½nï¿½zuï¿½lien(ne)' },
            { value: 'Vietnamese', en: 'Vietnamese', fr: 'Vietnamien(ne)' },
            { value: 'Welsh', en: 'Welsh', fr: 'Gallois(e)' },
            { value: 'Yemeni', en: 'Yemeni', fr: 'Yï¿½mï¿½nite' },
            { value: 'Zambian', en: 'Zambian', fr: 'Zambien(ne)' },
            { value: 'Zimbabwean', en: 'Zimbabwean', fr: 'Zimbabwï¿½en(ne)' }
        ];

        function getLang() {
            const sel = document.getElementById('langSelect');
            const stored = localStorage.getItem(CONTRACT_I18N_KEY);
            const lang = (sel?.value) || stored || 'en';
            return ['en','fr'].includes(lang) ? lang : 'en';
        }

        function setLang(lang) {
            localStorage.setItem(CONTRACT_I18N_KEY, lang);
            const sel = document.getElementById('langSelect');
            if (sel) sel.value = lang;
            const btn = document.getElementById('langToggleBtn');
            if (btn) btn.textContent = (lang === 'fr' ? 'FR' : 'EN');
        }

        function t(key) {
            const lang = getLang();
            return I18N_DICTIONARY[lang]?.[key] || I18N_DICTIONARY.en[key] || key;
        }

        function applyI18n() {
            // Labels and static text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key) return;
                el.textContent = t(key);
            });
            // Option labels
            document.querySelectorAll('option[data-i18n]').forEach(opt => {
                const key = opt.getAttribute('data-i18n');
                if (!key) return;
                opt.textContent = t(key);
            });
        }

        function initContractI18n() {
            const sel = document.getElementById('langSelect');
            const btn = document.getElementById('langToggleBtn');
            const stored = localStorage.getItem(CONTRACT_I18N_KEY) || 'en';
            if (sel) {
                sel.value = ['en','fr'].includes(stored) ? stored : 'en';
                sel.addEventListener('change', () => {
                    setLang(sel.value);
                    applyI18n();
                    // Re-render dynamic option lists dependent on language
                    try { populateNationalityOptions && populateNationalityOptions(); } catch(_) {}
                    // Apply gendered nationality labels in French
                    try { updateNationalityLabelsForFrench && updateNationalityLabelsForFrench(); } catch(_) {}
                    try { populateBirthCountryOptions && populateBirthCountryOptions(); } catch(_) {}
                    // Update marital status labels for French with gender agreement
                    try { updateMaritalLabelsForFrench && updateMaritalLabelsForFrench(); } catch(_) {}
                    // Keep marital status preview synced with new labels
                    try { updatePreviewField && updatePreviewField('maritalStatus'); } catch(_) {}
                    // Keep nationality and birth country preview synced with localized labels
                    try { updatePreviewField && updatePreviewField('nationality'); } catch(_) {}
                    // Keep birth country preview synced with localized label
                    try { updatePreviewField && updatePreviewField('birthCountry'); } catch(_) {}
                    try { generateCompleteContractPreview && generateCompleteContractPreview(); } catch(_) {}
                });
            }
            // Initialize button label and behavior
            if (btn) {
                btn.textContent = (['en','fr'].includes(stored) ? stored : 'en') === 'fr' ? 'FR' : 'EN';
                // hover/active styles
                btn.addEventListener('mouseenter', () => { btn.style.background = '#f9fafb'; });
                btn.addEventListener('mouseleave', () => { btn.style.background = '#ffffff'; });
                btn.addEventListener('mousedown', () => { btn.style.background = '#f3f4f6'; });
                btn.addEventListener('mouseup', () => { btn.style.background = getLang() === 'en' ? '#ffffff' : '#ffffff'; });
                btn.addEventListener('click', () => {
                    const next = getLang() === 'en' ? 'fr' : 'en';
                    setLang(next);
                    // trigger select change chain
                    if (sel) {
                        const prev = sel.value;
                        sel.value = next;
                        if (prev !== next) sel.dispatchEvent(new Event('change'));
                    } else {
                        // Fallback if select is absent
                        applyI18n();
                        try { populateNationalityOptions && populateNationalityOptions(); } catch(_) {}
                        try { updateNationalityLabelsForFrench && updateNationalityLabelsForFrench(); } catch(_) {}
                        try { populateBirthCountryOptions && populateBirthCountryOptions(); } catch(_) {}
                        try { updateMaritalLabelsForFrench && updateMaritalLabelsForFrench(); } catch(_) {}
                        try { updatePreviewField && updatePreviewField('maritalStatus'); } catch(_) {}
                        try { updatePreviewField && updatePreviewField('nationality'); } catch(_) {}
                        try { updatePreviewField && updatePreviewField('birthCountry'); } catch(_) {}
                        try { generateCompleteContractPreview && generateCompleteContractPreview(); } catch(_) {}
                    }
                    // subtle press feedback
                    btn.style.transform = 'scale(0.97)';
                    setTimeout(() => { btn.style.transform = ''; }, 80);
                });
            }
            applyI18n();
            try { populateNationalityOptions && populateNationalityOptions(); } catch(_) {}
            try { updateNationalityLabelsForFrench && updateNationalityLabelsForFrench(); } catch(_) {}
            try { populateBirthCountryOptions && populateBirthCountryOptions(); } catch(_) {}
            // Initial marital status label adjustment based on current language and salutation
            try { updateMaritalLabelsForFrench && updateMaritalLabelsForFrench(); } catch(_) {}
            window.__i18nApply = applyI18n;
            window.__i18nT = t;
        }

        // Populate the nationality select with bilingual labels
        function populateNationalityOptions() {
            const sel = document.getElementById('nationality');
            if (!sel) return;
            const currentValue = sel.value || '';
            const lang = getLang();
            // Build options
            const opts = [`<option value="" data-i18n="option.selectNationality">${t('option.selectNationality')}</option>`]
                .concat(NATIONALITIES.map(n => `<option value="${n.value}">${lang === 'fr' ? n.fr : n.en}</option>`));
            sel.innerHTML = opts.join('');
            // Restore selection if possible
            if (currentValue) {
                const has = [...sel.options].some(o => String(o.value).toLowerCase() === String(currentValue).toLowerCase());
                if (has) sel.value = [...sel.options].find(o => String(o.value).toLowerCase() === String(currentValue).toLowerCase()).value;
            }
        }

        // Birth Country bilingual labels (values remain English country names)
        let BIRTH_COUNTRY_BASE = null; // cached list of English country names
        const COUNTRY_FR_OVERRIDES = {
            'Afghanistan': 'Afghanistan', 'Albania': 'Albanie', 'Algeria': 'Algï¿½rie', 'Andorra': 'Andorre', 'Angola': 'Angola',
            'Antigua and Barbuda': 'Antigua-et-Barbuda', 'Argentina': 'Argentine', 'Armenia': 'Armï¿½nie', 'Australia': 'Australie', 'Austria': 'Autriche',
            'Azerbaijan': 'Azerbaï¿½djan', 'Bahamas': 'Bahamas', 'Bahrain': 'Bahreï¿½n', 'Bangladesh': 'Bangladesh', 'Barbados': 'Barbade',
            'Belarus': 'Biï¿½lorussie', 'Belgium': 'Belgique', 'Belize': 'Belize', 'Benin': 'Bï¿½nin', 'Bhutan': 'Bhoutan',
            'Bolivia': 'Bolivie', 'Bosnia and Herzegovina': 'Bosnie-Herzï¿½govine', 'Botswana': 'Botswana', 'Brazil': 'Brï¿½sil', 'Brunei': 'Brunï¿½i',
            'Bulgaria': 'Bulgarie', 'Burkina Faso': 'Burkina Faso', 'Burundi': 'Burundi', 'Cabo Verde': 'Cap-Vert', 'Cambodia': 'Cambodge',
            'Cameroon': 'Cameroun', 'Canada': 'Canada', 'Central African Republic': 'Rï¿½publique centrafricaine', 'Chad': 'Tchad', 'Chile': 'Chili',
            'China': 'Chine', 'Colombia': 'Colombie', 'Comoros': 'Comores', 'Congo (Congo-Brazzaville)': 'Congo (Brazzaville)',
            'Costa Rica': 'Costa Rica', 'Cï¿½te dï¿½Ivoire': 'Cï¿½te dï¿½Ivoire', 'Croatia': 'Croatie', 'Cuba': 'Cuba', 'Cyprus': 'Chypre',
            'Czechia': 'Tchï¿½quie', 'Democratic Republic of the Congo': 'Rï¿½publique dï¿½mocratique du Congo', 'Denmark': 'Danemark', 'Djibouti': 'Djibouti',
            'Dominica': 'Dominique', 'Dominican Republic': 'Rï¿½publique dominicaine', 'Ecuador': 'ï¿½quateur', 'Egypt': 'ï¿½gypte', 'El Salvador': 'Salvador',
            'Equatorial Guinea': 'Guinï¿½e ï¿½quatoriale', 'Eritrea': 'ï¿½rythrï¿½e', 'Estonia': 'Estonie', 'Eswatini': 'Eswatini', 'Ethiopia': 'ï¿½thiopie',
            'Fiji': 'Fidji', 'Finland': 'Finlande', 'France': 'France', 'Gabon': 'Gabon', 'Gambia': 'Gambie',
            'Georgia': 'Gï¿½orgie', 'Germany': 'Allemagne', 'Ghana': 'Ghana', 'Greece': 'Grï¿½ce', 'Grenada': 'Grenade',
            'Guatemala': 'Guatemala', 'Guinea': 'Guinï¿½e', 'Guinea-Bissau': 'Guinï¿½e-Bissau', 'Guyana': 'Guyana', 'Haiti': 'Haï¿½ti',
            'Honduras': 'Honduras', 'Hungary': 'Hongrie', 'Iceland': 'Islande', 'India': 'Inde', 'Indonesia': 'Indonï¿½sie',
            'Iran': 'Iran', 'Iraq': 'Irak', 'Ireland': 'Irlande', 'Israel': 'Israï¿½l', 'Italy': 'Italie',
            'Jamaica': 'Jamaï¿½que', 'Japan': 'Japon', 'Jordan': 'Jordanie', 'Kazakhstan': 'Kazakhstan', 'Kenya': 'Kenya',
            'Kiribati': 'Kiribati', 'Kuwait': 'Koweï¿½t', 'Kyrgyzstan': 'Kirghizistan', 'Laos': 'Laos', 'Latvia': 'Lettonie', 'Lebanon': 'Liban',
            'Lesotho': 'Lesotho', 'Liberia': 'Libï¿½ria', 'Libya': 'Libye', 'Liechtenstein': 'Liechtenstein', 'Lithuania': 'Lituanie', 'Luxembourg': 'Luxembourg',
            'Madagascar': 'Madagascar', 'Malawi': 'Malawi', 'Malaysia': 'Malaisie', 'Maldives': 'Maldives', 'Mali': 'Mali', 'Malta': 'Malte',
            'Marshall Islands': 'ï¿½les Marshall', 'Mauritania': 'Mauritanie', 'Mauritius': 'Maurice', 'Mexico': 'Mexique', 'Micronesia': 'Micronï¿½sie',
            'Moldova': 'Moldavie', 'Monaco': 'Monaco', 'Mongolia': 'Mongolie', 'Montenegro': 'Montï¿½nï¿½gro', 'Morocco': 'Maroc',
            'Mozambique': 'Mozambique', 'Myanmar': 'Myanmar', 'Namibia': 'Namibie', 'Nauru': 'Nauru', 'Nepal': 'Nï¿½pal', 'Netherlands': 'Pays-Bas',
            'New Zealand': 'Nouvelle-Zï¿½lande', 'Nicaragua': 'Nicaragua', 'Niger': 'Niger', 'Nigeria': 'Nigï¿½ria', 'North Korea': 'Corï¿½e du Nord',
            'North Macedonia': 'Macï¿½doine du Nord', 'Norway': 'Norvï¿½ge', 'Oman': 'Oman', 'Pakistan': 'Pakistan', 'Palau': 'Palaos',
            'Panama': 'Panama', 'Papua New Guinea': 'Papouasie-Nouvelle-Guinï¿½e', 'Paraguay': 'Paraguay', 'Peru': 'Pï¿½rou', 'Philippines': 'Philippines',
            'Poland': 'Pologne', 'Portugal': 'Portugal', 'Qatar': 'Qatar', 'Romania': 'Roumanie', 'Russia': 'Russie', 'Rwanda': 'Rwanda',
            'Saint Kitts and Nevis': 'Saint-Christophe-et-Niï¿½vï¿½s', 'Saint Lucia': 'Sainte-Lucie', 'Saint Vincent and the Grenadines': 'Saint-Vincent-et-les-Grenadines',
            'Samoa': 'Samoa', 'San Marino': 'Saint-Marin', 'Sao Tome and Principe': 'Sao Tomï¿½-et-Principe', 'Saudi Arabia': 'Arabie saoudite',
            'Senegal': 'Sï¿½nï¿½gal', 'Serbia': 'Serbie', 'Seychelles': 'Seychelles', 'Sierra Leone': 'Sierra Leone', 'Singapore': 'Singapour',
            'Slovakia': 'Slovaquie', 'Slovenia': 'Slovï¿½nie', 'Solomon Islands': 'ï¿½les Salomon', 'Somalia': 'Somalie', 'South Africa': 'Afrique du Sud',
            'South Korea': 'Corï¿½e du Sud', 'South Sudan': 'Soudan du Sud', 'Spain': 'Espagne', 'Sri Lanka': 'Sri Lanka', 'Sudan': 'Soudan',
            'Suriname': 'Suriname', 'Sweden': 'Suï¿½de', 'Switzerland': 'Suisse', 'Syria': 'Syrie', 'Tajikistan': 'Tadjikistan',
            'Tanzania': 'Tanzanie', 'Thailand': 'Thaï¿½lande', 'Timor-Leste': 'Timor oriental', 'Togo': 'Togo', 'Tonga': 'Tonga',
            'Trinidad and Tobago': 'Trinitï¿½-et-Tobago', 'Tunisia': 'Tunisie', 'Turkey': 'Turquie', 'Turkmenistan': 'Turkmï¿½nistan', 'Tuvalu': 'Tuvalu',
            'Uganda': 'Ouganda', 'Ukraine': 'Ukraine', 'United Arab Emirates': 'ï¿½mirats arabes unis', 'United Kingdom': 'Royaume-Uni',
            'United States': 'ï¿½tats-Unis', 'Uruguay': 'Uruguay', 'Uzbekistan': 'Ouzbï¿½kistan', 'Vanuatu': 'Vanuatu', 'Venezuela': 'Venezuela',
            'Vietnam': 'Viï¿½t Nam', 'Yemen': 'Yï¿½men', 'Zambia': 'Zambie', 'Zimbabwe': 'Zimbabwe'
        };

        function getBirthCountryBaseList() {
            if (BIRTH_COUNTRY_BASE) return BIRTH_COUNTRY_BASE;
            const sel = document.getElementById('birthCountry');
            if (!sel) return [];
            // Harvest from existing static options (skip the first default)
            BIRTH_COUNTRY_BASE = [...sel.options].slice(1).map(o => o.value || o.textContent.trim());
            return BIRTH_COUNTRY_BASE;
        }

        function countryLabel(name, lang) {
            if (lang === 'fr') return COUNTRY_FR_OVERRIDES[name] || name;
            return name;
        }

        function populateBirthCountryOptions() {
            const sel = document.getElementById('birthCountry');
            if (!sel) return;
            const currentValue = sel.value || '';
            const base = getBirthCountryBaseList();
            const lang = getLang();
            const opts = [`<option value="" data-i18n="option.selectCountry">${t('option.selectCountry')}</option>`]
                .concat(base.map(n => `<option value="${n}">${countryLabel(n, lang)}</option>`));
            sel.innerHTML = opts.join('');
            if (currentValue) {
                const has = [...sel.options].some(o => String(o.value) === String(currentValue));
                if (has) sel.value = currentValue;
            }
        }

        // Update French marital status option labels to match salutation gender (Monsieur/Madame)
        function updateMaritalLabelsForFrench() {
            const lang = getLang();
            const sel = document.getElementById('maritalStatus');
            if (!sel) return;
            const genderSel = document.getElementById('gender');
            const genderVal = genderSel?.value || '';
            // Helper to set label for a given value
            const setLabel = (val, label) => {
                const opt = [...sel.options].find(o => o.value === val);
                if (opt) opt.textContent = label;
            };
            if (lang !== 'fr') {
                // Restore default dictionary-driven labels when not French
                setLabel('Single', t('option.marital.single'));
                setLabel('Married', t('option.marital.married'));
                setLabel('Divorced', t('option.marital.divorced'));
                setLabel('Widowed', t('option.marital.widowed'));
                return;
            }
            // French with gender agreement
            const isMasculine = genderVal === 'Sir';
            const isFeminine = genderVal === 'Madam' || genderVal === 'Miss';
            // Single is not gendered in French label
            setLabel('Single', 'Cï¿½libataire');
            if (isMasculine) {
                setLabel('Married', 'Mariï¿½');
                setLabel('Divorced', 'Divorcï¿½');
                setLabel('Widowed', 'Veuf');
            } else if (isFeminine) {
                setLabel('Married', 'Mariï¿½e');
                setLabel('Divorced', 'Divorcï¿½e');
                setLabel('Widowed', 'Veuve');
            } else {
                // Neutral/fallback
                setLabel('Married', 'Mariï¿½(e)');
                setLabel('Divorced', 'Divorcï¿½(e)');
                setLabel('Widowed', 'Veuf(ve)');
            }
        }

        // Wire salutation change to update French marital labels
        function setupMaritalStatusGenderBehavior() {
            const g = document.getElementById('gender');
            if (g) {
                g.addEventListener('change', () => {
                    try { updateMaritalLabelsForFrench && updateMaritalLabelsForFrench(); } catch(_) {}
                    try { updateNationalityLabelsForFrench && updateNationalityLabelsForFrench(); } catch(_) {}
                    // Keep preview in sync with label changes
                    try { updatePreviewField && updatePreviewField('maritalStatus'); } catch(_) {}
                    try { updatePreviewField && updatePreviewField('nationality'); } catch(_) {}
                });
            }
            // Initial run
            try { updateMaritalLabelsForFrench && updateMaritalLabelsForFrench(); } catch(_) {}
            try { updateNationalityLabelsForFrench && updateNationalityLabelsForFrench(); } catch(_) {}
        }

        // Update French nationality option labels to match salutation gender (Monsieur/Madame)
        function updateNationalityLabelsForFrench() {
            const lang = getLang();
            const sel = document.getElementById('nationality');
            if (!sel) return;
            const genderSel = document.getElementById('gender');
            const genderVal = genderSel?.value || '';
            const isMasculine = genderVal === 'Sir';
            const isFeminine = genderVal === 'Madam' || genderVal === 'Miss';

            // Map nationalities by value for lookup
            const natMap = new Map(NATIONALITIES.map(n => [n.value, n]));

            [...sel.options].forEach(opt => {
                if (!opt.value) return; // skip placeholder
                const entry = natMap.get(opt.value);
                if (!entry) return;
                if (lang !== 'fr') {
                    opt.textContent = entry.en;
                    return;
                }
                const fr = entry.fr || entry.en;
                const base = fr.replace(/\s*\([^)]*\)/g, '').trim();
                const suffixMatch = fr.match(/\(([^)]+)\)/);
                const suffix = suffixMatch ? suffixMatch[1] : '';
                if (isMasculine) {
                    opt.textContent = base;
                } else if (isFeminine) {
                    opt.textContent = suffix ? (base + suffix) : fr;
                } else {
                    // Neutral/fallback keeps the combined form
                    opt.textContent = fr;
                }
            });
        }
        
        // Standalone page initialization
        function initializeStandalonePage() {
            console.log('?? Initializing standalone page features...');
            
            // Initialize menu loading state
            initializeMenuLoading();
            
            // Set up basic UI interactions
            setupUIInteractions();
            
            // Initialize form validation
            setupFormValidation();
            
            // Make form fields editable
            makeFormFieldsEditable();
            
            console.log('? Standalone page initialization complete');
        }
        
        // Initialize menu loading state
        function initializeMenuLoading() {
            // Add menu-loading class to sidebar while permissions are loading
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.add('menu-loading');
            }
        }
        
        // Menu visibility methods
        function resetMenuVisibility() {
            document.querySelectorAll('#roleBasedMenu li').forEach(item => {
                item.style.display = 'block';
            });
        }
        
        function updateMenuWithPermissions(permissions) {
            console.log('?? Updating menu with permissions...');
            console.log('?? Permissions object:', permissions);
            
            // Reset menu visibility first
            resetMenuVisibility();
            
            if (!permissions) {
                console.log('?? No permissions object provided - showing all menu items');
                // If no permissions available, show all menu items
                document.querySelectorAll('#roleBasedMenu li').forEach(item => {
                    item.style.display = 'block';
                });
                return;
            }
            
            // Handle individual menu items
            const menuItems = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
            console.log(`?? Found ${menuItems.length} menu items with permission requirements`);
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const requiredPermission = item.getAttribute('data-requires-permission');
                console.log(`?? Checking menu item requirement: ${requiredPermission}`);
                
                if (requiredPermission && permissions[requiredPermission]) {
                    const hasViewPermission = permissions[requiredPermission].view === true || permissions[requiredPermission] === true;
                    
                    if (hasViewPermission) {
                        item.style.display = 'block';
                        visibleCount++;
                        console.log(`? Showing menu item: ${requiredPermission}`);
                    } else {
                        item.style.display = 'none';
                        console.log(`? No view permission for: ${requiredPermission}`);
                    }
                } else {
                    item.style.display = 'none';
                    console.log(`? Permission not found: ${requiredPermission}`);
                }
            });
            
            // Show items without permission requirements
            const itemsWithoutPermissions = document.querySelectorAll('#roleBasedMenu li:not([data-requires-permission])');
            itemsWithoutPermissions.forEach(item => {
                item.style.display = 'block';
                visibleCount++;
            });
            
            // Handle submenu items within dropdowns
            const submenuItems = document.querySelectorAll('#roleBasedMenu .submenu li[data-requires-permission]');
            submenuItems.forEach(item => {
                const requiredPermission = item.getAttribute('data-requires-permission');
                if (requiredPermission && permissions[requiredPermission]) {
                    const hasViewPermission = permissions[requiredPermission].view === true || permissions[requiredPermission] === true;
                    item.style.display = hasViewPermission ? 'block' : 'none';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show submenu items without permission requirements
            const submenuItemsWithoutPermissions = document.querySelectorAll('#roleBasedMenu .submenu li:not([data-requires-permission])');
            submenuItemsWithoutPermissions.forEach(item => {
                item.style.display = 'block';
            });
            
            // Handle parent dropdowns - show if they have visible children or no permission requirement
            document.querySelectorAll('#roleBasedMenu .menu-dropdown').forEach(dropdown => {
                const requiredPermission = dropdown.getAttribute('data-requires-permission');
                
                if (!requiredPermission) {
                    // No permission requirement for the dropdown itself, check children
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li[style*="block"], .submenu li:not([style*="none"]):not([data-requires-permission])');
                    dropdown.style.display = visibleSubmenuItems.length > 0 ? 'block' : 'none';
                } else {
                    // Dropdown has permission requirement
                    if (permissions[requiredPermission]) {
                        const hasViewPermission = permissions[requiredPermission].view === true || permissions[requiredPermission] === true;
                        dropdown.style.display = hasViewPermission ? 'block' : 'none';
                    } else {
                        dropdown.style.display = 'none';
                    }
                }
            });
            
            console.log(`?? Menu update complete. Visible items: ${visibleCount}`);
            
            // Remove loading class from sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
        }
        
        async function updateMenuVisibility() {
            console.log('?? Starting menu visibility update...');
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            try {
                if (!window.firebaseAvailable || !currentUser) {
                    console.log('?? Firebase not available or no user - showing default menu');
                    // Show all menu items if no permissions system available
                    document.querySelectorAll('#roleBasedMenu li').forEach(item => {
                        item.style.display = 'block';
                    });
                    return;
                }
                
                // Try to load user permissions from Firebase
                const database = firebase.database();
                const userRef = database.ref(`users/${currentUser.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.role) {
                    // Load role permissions
                    const roleRef = database.ref(`roles/${userData.role}/permissions`);
                    const roleSnapshot = await roleRef.once('value');
                    const permissions = roleSnapshot.val();
                    
                    if (permissions) {
                        updateMenuWithPermissions(permissions);
                    } else {
                        console.log('?? No permissions found for role, showing all menu items');
                        updateMenuWithPermissions(null);
                    }
                } else {
                    console.log('?? No user role found, showing all menu items');
                    updateMenuWithPermissions(null);
                }
            } catch (error) {
                console.error('? Error loading menu permissions:', error);
                // On error, show all menu items
                updateMenuWithPermissions(null);
            }
        }
        
        // Basic UI interactions setup
        function setupUIInteractions() {
            // Profile dropdown is bound by AuthManager to avoid double-binding
            
            // Notification dropdown toggle
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    notificationDropdown.style.display = 'none';
                });
            }
            
            // Setup sidebar toggle
            setupSidebarToggle();
        }

        // ===== Add AuthManager (from project-list.html) for branding and user dropdown =====
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.currentCompany = null;
                this.init();
            }
            getCurrentUser() {
                try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; }
            }
            setCurrentUser(u) {
                localStorage.setItem('currentUser', JSON.stringify(u));
                localStorage.setItem('user', JSON.stringify(u));
                this.currentUser = u;
            }
            async init() {
                if (!this.currentUser) {
                    // Match project-list.html behavior: redirect to login when not authenticated
                    window.location.href = 'login.html';
                    return;
                }
                await this.loadUserCompany();
                this.updateCompanyBranding();
                await this.updateUIForAuthenticatedUser();
                this.bindProfileDropdown();
            }
            async loadUserCompany() {
                if (!this.currentUser || !window.firebaseAvailable) return;
                try {
                    const snap = await firebase.database().ref('companies').once('value');
                    if (!snap.exists()) return;
                    const companies = snap.val();
                    for (const [cid, comp] of Object.entries(companies)) {
                        if (comp.status !== 'active') continue;
                        if (comp.users) {
                            for (const [uid, u] of Object.entries(comp.users)) {
                                if (u.authUid === this.currentUser.uid || uid === this.currentUser.uid) {
                                    this.currentUser.companyId = cid;
                                    this.currentUser.companyName = comp.companyName;
                                    this.currentUser.role = u.role || u.userRole || 'user';
                                    this.currentCompany = comp;
                                    this.setCurrentUser(this.currentUser);
                                    return;
                                }
                            }
                        }
                    }
                } catch (e) { /* ignore */ }
            }
            updateCompanyBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                const nameEl = document.getElementById('headerCompanyName');
                if (!this.currentCompany) { this.showFallbackBranding(); return; }
                if (nameEl) nameEl.textContent = this.currentCompany.companyName || '';
                const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
                if (logoEl) {
                    if (logoUrl) {
                        logoEl.src = logoUrl;
                        logoEl.classList.add('visible');
                    } else {
                        const svg = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || ''));
                        logoEl.src = svg;
                        logoEl.classList.add('visible');
                    }
                }
                if (this.currentCompany && this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    if (this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                }
            }
            showFallbackBranding() {
                const logoEl = document.getElementById('headerCompanyLogo');
                if (logoEl) {
                    const svg = this.generateCompanyInitialsSVG('DX');
                    logoEl.src = svg;
                    logoEl.classList.add('visible');
                }
            }
            getCompanyInitials(name) {
                if (!name) return 'CO';
                const parts = name.trim().split(/\s+/);
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            generateCompanyInitialsSVG(initials) {
                const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`;
                return 'data:image/svg+xml;base64,' + btoa(svg);
            }
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                const n = v => typeof v === 'string' ? v.trim().replace(/\s+/g, ' ') : '';
                const cand = [this.currentUser.displayName, this.currentUser.name, this.currentUser.username];
                for (const c of cand) { const cleaned = n(c); if (cleaned) return cleaned; }
                if (this.currentUser.email) return n(this.currentUser.email.split('@')[0]) || 'User';
                return 'User';
            }
            getUserInitials() {
                const dn = this.getUserDisplayName();
                const parts = dn.split(' ').filter(Boolean);
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return parts.slice(0, 2).map(p => p[0]).join('').toUpperCase();
            }
            async getUserAvatarUrl() {
                if (!this.currentUser || !window.firebaseAvailable) return null;
                const companyId = this.currentUser.companyId || 'default';
                const possiblePaths = [
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
                    `companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
                    `avatars/${this.currentUser.uid}/profile.jpg`,
                    `avatars/${this.currentUser.uid}/profile.png`,
                    `avatars/${this.currentUser.uid}/avatar.jpg`,
                    `avatars/${this.currentUser.uid}/avatar.png`,
                    `profiles/${this.currentUser.uid}/profile.jpg`,
                    `profiles/${this.currentUser.uid}/profile.png`
                ];
                for (const path of possiblePaths) {
                    try {
                        const ref = firebase.storage().ref(path);
                        const url = await ref.getDownloadURL();
                        return url;
                    } catch (err) { continue; }
                }
                return null;
            }
            async updateUIForAuthenticatedUser() {
                const btn = document.getElementById('userProfileBtn');
                const list = document.querySelector('.profile-dropdown ul');
                if (!btn || !list || !this.currentUser) return;
                const displayName = this.getUserDisplayName();
                const email = this.currentUser.email || '';
                let avatarUrl = null;
                try { avatarUrl = await this.getUserAvatarUrl(); } catch (error) { }
                const btnImg = btn.querySelector('img');
                if (btnImg) {
                    if (avatarUrl) {
                        btnImg.src = avatarUrl;
                        btnImg.alt = displayName + ' Avatar';
                        btnImg.style.display = 'block';
                        btnImg.onerror = () => {
                            btnImg.style.display = 'none';
                            btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
                        };
                    } else {
                        btnImg.style.display = 'none';
                        btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
                    }
                }
                const avatarHtml = avatarUrl ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
                list.innerHTML = `<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>`;
                list.querySelector('#logoutLink')?.addEventListener('click', e => { e.preventDefault(); this.logout(); });
            }
            bindProfileDropdown() {
                const btn = document.getElementById('userProfileBtn');
                const dd = document.querySelector('.profile-dropdown');
                if (btn && dd) {
                    btn.addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('show'); });
                    document.addEventListener('click', e => { if (!btn.contains(e.target)) dd.classList.remove('show'); });
                }
            }
            async logout() {
                try {
                    if (window.firebaseAvailable) {
                        await firebase.auth().signOut();
                    }
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }
        }

        // Helper to get current user
        function getAuthUser() {
            if (window.authManager && window.authManager.currentUser) return window.authManager.currentUser;
            try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; }
        }

        // ===== Role-based menu authorization (from project-list.html) =====
        let isMenuUpdateInProgress = false;
        function resetMenuVisibilityClasses() {
            document.querySelectorAll('[data-feature]').forEach(item => item.classList.remove('menu-visible'));
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => dropdown.classList.remove('menu-visible'));
        }
        function showBasicMenu() {
            resetMenuVisibilityClasses();
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('menu-loading');
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) homeItem.classList.add('menu-visible');
        }
        async function updateMenuWithFeatureAuthorization() {
            if (isMenuUpdateInProgress) return;
            isMenuUpdateInProgress = true;
            try {
                let user = getAuthUser();
                let companyId = user?.companyId;
                let userRole = user?.role;
                if (!user && window.firebaseAvailable && firebase.auth().currentUser) {
                    user = firebase.auth().currentUser;
                }
                if (!user) { resetMenuVisibilityClasses(); return; }
                if (!companyId && window.firebaseAvailable) {
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            if (company.users && company.users[user.uid]) {
                                companyId = cId;
                                userRole = company.users[user.uid].role || company.users[user.uid].userRole;
                                break;
                            }
                        }
                    }
                }
                if (!companyId) { resetMenuVisibilityClasses(); return; }
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                if (userRole) await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
            } catch (e) {
                console.error('Menu authorization error:', e);
                resetMenuVisibilityClasses();
            } finally {
                isMenuUpdateInProgress = false;
            }
        }
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                if (!featuresSnapshot.exists()) { resetMenuVisibilityClasses(); return []; }
                const featuresData = featuresSnapshot.val();
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                if (!companyData) { resetMenuVisibilityClasses(); return []; }
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                if (subscribedFeatureIds.length === 0) { resetMenuVisibilityClasses(); return []; }
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) authorizedPages.push(...feature.authorizedPages);
                });
                resetMenuVisibilityClasses();
                const authorizedFeatures = new Set();
                authorizedPages.forEach(p => { if (p.feature) authorizedFeatures.add(p.feature); });
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    if (isDropdownContainer) return;
                    if (authorizedFeatures.has(featureAttribute)) menuItem.classList.add('menu-visible');
                });
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    submenuItems.forEach(si => { if (si.classList.contains('menu-visible')) hasVisibleChildren = true; });
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) dropdown.classList.add('menu-visible');
                });
                return authorizedPages;
            } catch (e) {
                console.error('Feature-based visibility error:', e);
                resetMenuVisibilityClasses();
                return [];
            }
        }
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                if (!permissionsSnapshot.exists()) { hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
                const permissions = permissionsSnapshot.val();
                filterMenuByPermissions(permissions);
            } catch (e) {
                console.error('Role-based filtering error:', e);
                showSidebarAfterAuth();
            }
        }
        function filterMenuByPermissions(permissions) {
            if (!permissions) { hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
            const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            visibleMenuItems.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const hasPermission = permissions[requiresPermission];
                const hasViewPermission = hasPermission === true || (hasPermission && hasPermission.view === true);
                if (!hasViewPermission) item.classList.remove('menu-visible');
            });
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (submenuItems.length === 0) dropdown.classList.remove('menu-visible');
            });
            ensureHomeIsVisible();
            showSidebarAfterAuth();
        }
        function hideItemsRequiringPermissions() {
            const items = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            items.forEach(item => item.classList.remove('menu-visible'));
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (submenuItems.length === 0) dropdown.classList.remove('menu-visible');
            });
            ensureHomeIsVisible();
        }
        function ensureHomeIsVisible() {
            const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
            if (homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
        }
        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('menu-loading');
        }
        function initializeMenuAuthorization() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.add('menu-loading');
            setTimeout(() => { if (window.firebaseAvailable) updateMenuWithFeatureAuthorization(); else { // fallback: show all
                document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li => li.classList.add('menu-visible'));
                showSidebarAfterAuth();
            }}, 500);
        }
        
        // Setup sidebar toggle functionality
        function setupSidebarToggle() {
            console.log('?? Setting up sidebar toggle...');
            
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            console.log('Elements found:', {
                toggle: sidebarToggle ? '?' : '?',
                sidebar: sidebar ? '?' : '?', 
                mainContent: mainContent ? '?' : '?'
            });
            
            if (!sidebarToggle) {
                console.error('? Sidebar toggle button not found!');
                return;
            }
            
            if (!sidebar) {
                console.error('? Sidebar element not found!');
                return;
            }
            
            if (!mainContent) {
                console.error('? Main content element not found!');
                return;
            }
            
            // Simple toggle function
            sidebarToggle.onclick = function() {
                console.log('??? Toggle button clicked!');
                
                if (window.innerWidth <= 768) {
                    // Mobile behavior
                    const isActive = sidebar.classList.contains('active');
                    if (isActive) {
                        sidebar.classList.remove('active');
                        console.log('?? Mobile sidebar hidden');
                    } else {
                        sidebar.classList.add('active');
                        console.log('?? Mobile sidebar shown');
                    }
                } else {
                    // Desktop behavior
                    const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
                    
                    if (isCurrentlyCollapsed) {
                        // Show sidebar
                        sidebar.classList.remove('collapsed');
                        mainContent.classList.remove('expanded');
                        localStorage.setItem('sidebarCollapsed', 'false');
                        console.log('??? Desktop sidebar expanded');
                    } else {
                        // Hide sidebar
                        sidebar.classList.add('collapsed');
                        mainContent.classList.add('expanded');
                        localStorage.setItem('sidebarCollapsed', 'true');
                        console.log('??? Desktop sidebar collapsed');
                    }
                }
            };
            
            // Load saved state (desktop only)
            if (window.innerWidth > 768) {
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    console.log('? Loaded collapsed state from localStorage');
                }
            }
            
            // Add click outside to close for mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    if (!e.target.closest('.sidebar') && !e.target.closest('#sidebarToggle')) {
                        if (sidebar.classList.contains('active')) {
                            sidebar.classList.remove('active');
                            console.log('?? Mobile sidebar closed by outside click');
                        }
                    }
                }
            });
            
            console.log('? Sidebar toggle setup complete');
        }
        
        // Setup mobile menu behavior and responsive handling
        function setupMobileMenu() {
            console.log('?? Setting up mobile menu...');
            
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (!sidebar || !mainContent) {
                console.error('? Mobile menu: Required elements not found');
                return;
            }
            
            // Handle window resize to switch between desktop and mobile modes
            window.addEventListener('resize', function() {
                console.log('?? Window resized, current width:', window.innerWidth);
                
                if (window.innerWidth <= 768) {
                    // Mobile mode - remove desktop classes
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                    console.log('?? Switched to mobile mode');
                } else {
                    // Desktop mode - restore saved state
                    const savedState = localStorage.getItem('sidebarCollapsed');
                    if (savedState === 'true') {
                        sidebar.classList.add('collapsed');
                        mainContent.classList.add('expanded');
                    }
                    console.log('??? Switched to desktop mode');
                }
            });
            
            console.log('? Mobile menu setup complete');
        }
        
        // Load and display company header information
        function loadCompanyHeader() {
            console.log('?? Loading company header...');
            
            try {
                // Get company data from localStorage or use default
                const companyData = JSON.parse(localStorage.getItem('currentCompany') || '{}');
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');

                console.log('Header elements found:', {
                    logo: headerLogo ? '?' : '?',
                    placeholder: headerLogoPlaceholder ? '?' : '?',
                    companyName: headerCompanyName ? '?' : '?'
                });

                // Update company name
                if (headerCompanyName) {
                    const companyName = companyData.companyName || 'Dreamex Datalab HSE';
                    headerCompanyName.textContent = companyName;
                    console.log('? Company name updated:', companyName);
                }

                // Update logo or show placeholder
                if (companyData.logoUrl || companyData.logo) {
                    const logoUrl = companyData.logoUrl || companyData.logo;
                    console.log('? Company logo URL found:', logoUrl);
                    
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log('? Company logo displayed');
                    }
                    
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'none';
                        console.log('? Logo placeholder hidden');
                    }
                } else {
                    console.log('?? No company logo URL, showing placeholder');
                    // Show placeholder if no logo
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                        console.log('? Logo placeholder shown');
                    }
                    
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        console.log('? Company logo hidden');
                    }
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab') && companyData.companyName) {
                    document.title = title.replace('Dreamex Datalab', companyData.companyName);
                    console.log('? Page title updated');
                }
            } catch (error) {
                console.error('? Error loading company header:', error);
                // Show fallback branding
                showFallbackBranding();
            }
        }

        // Show fallback branding when no company data is available
        function showFallbackBranding() {
            console.log('?? Showing fallback branding');
            const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const headerCompanyName = document.getElementById('headerCompanyName');
            const headerLogo = document.getElementById('headerCompanyLogo');
            
            // Show placeholder logo
            if (headerLogoPlaceholder) {
                headerLogoPlaceholder.style.display = 'flex';
                console.log('? Fallback logo placeholder shown');
            }
            
            // Hide company logo
            if (headerLogo) {
                headerLogo.style.display = 'none';
                console.log('? Company logo hidden (fallback)');
            }
            
            // Set fallback company name
            if (headerCompanyName) {
                headerCompanyName.textContent = 'Dreamex Datalab HSE';
                console.log('? Fallback company name set');
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('? Contract Creation Page - DOM Content Loaded');
            console.log('?? This page displays templates from Firebase Realtime Database saved by dochtml.html');
            console.log('?? Template storage path: companies/{companyId}/documentTemplates');
            console.log('?? Real-time synchronization: ENABLED');
            console.log('?? Company-scoped templates: ONLY');
            console.log('');
            console.log('?? Starting page initialization...');
            
            // Debug: Check if elements exist
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            console.log('Debug - Elements found:', {
                sidebarToggle: !!sidebarToggle,
                sidebar: !!sidebar,
                mainContent: !!mainContent
            });
            
            // Debug: Add direct click test
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    console.log('Direct click test: Sidebar toggle button clicked!');
                });
                console.log('Direct click listener added to toggle button');
            }
            
            // Initialize standalone features first
            initializeStandalonePage();
            
            // Setup sidebar toggle functionality
            setupSidebarToggle();
            
            // Setup mobile menu for responsive behavior
            setupMobileMenu();
            
            // Load company header information
            loadCompanyHeader();
            
            // Initialize AuthManager for profile dropdown and branding
            window.authManager = new AuthManager();

            // Then initialize Firebase-dependent features
            if (window.firebaseAvailable) {
                // Load salary grade/band mappings early
                loadSalaryMappings();
                // Load salary subitems (band items) settings
                loadSalarySubitemsSettings();
                // Setup grade dropdown wiring
                setupGradeWiring();
                initializeAuth();
                // Templates will be loaded after user company data is available
                // Delay employee loading to allow authentication to complete
                setTimeout(() => {
                    loadEmployees();
                }, 1000);
                // Load work areas into Location select once company context likely available
                setTimeout(() => { try { loadWorkAreasIntoLocationSelect(); } catch(e){ console.warn('Work areas load failed', e);} }, 1200);
                // Use same authorization as project-list.html
                initializeMenuAuthorization();
            } else {
                console.warn('?? Firebase not available - running in limited mode');
                showFirebaseError();
                // Load employees from fallback in standalone mode
                loadEmployees();
                initializeMenuAuthorization(); // Still update menu visibility in standalone mode
                // Setup grade UI even in limited mode to avoid errors
                setupGradeWiring();
            }
            
            console.log('?? Contract creation page loaded successfully');
            // Initialize i18n after page load
            try { initContractI18n && initContractI18n(); } catch(_) {}
            // Setup marital status gendered label behavior
            try { setupMaritalStatusGenderBehavior && setupMaritalStatusGenderBehavior(); } catch(_) {}
            // Initialize salary currency badge from gradeCurrency (fallback USD)
            try {
                const badge = document.getElementById('salaryCurrencyBadge');
                if (badge) {
                    const cur = (document.getElementById('gradeCurrency')?.value) || 'USD';
                    badge.textContent = cur || 'USD';
                }
                // Initialize gross salary display
                setTimeout(() => {
                    try { recomputeGrossSalary(); } catch(_) {}
                }, 0);
            } catch(_){}
            // Keep compensation controls visible across dynamic updates
            try { keepCompFieldsVisibleInit(); } catch(_) {}
        });
        
        // Show Firebase error message
        function showFirebaseError() {
            const container = document.querySelector('.contract-form-container');
            if (container) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <strong>?? Limited Functionality</strong><br>
                    Some features may not work properly due to missing dependencies. 
                    The page will continue to function with reduced capabilities.
                `;
                container.insertBefore(errorDiv, container.firstChild);
            }
        }

        // Initialize authentication
        function initializeAuth() {
            try {
                if (!window.firebaseAvailable || !firebase.auth) {
                    console.warn('?? Firebase Auth not available - running without authentication');
                    // Set a default user for standalone mode
                    currentUser = {
                        email: 'standalone@user.local',
                        displayName: 'Standalone User',
                        uid: 'standalone-user-id'
                    };
                    updateUserProfile(currentUser);
                    return;
                }
                
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        currentUser = user;
                        console.log('? User authenticated:', user.email);
                        updateUserProfile(user);
                        loadUserCompanyData(user); // Load company data for authenticated user
                        updateMenuWithFeatureAuthorization(); // Update menu when user changes
                    } else {
                        console.log('?? No user authenticated - using guest mode');
                        // Set guest user for standalone operation
                        currentUser = {
                            email: 'guest@user.local',
                            displayName: 'Guest User',
                            uid: 'guest-user-id'
                        };
                        updateUserProfile(currentUser);
                        updateMenuWithFeatureAuthorization(); // Update menu for guest user
                        
                        // Load templates for guest user (only global templates)
                        console.log('?? Loading global templates for guest user...');
                        loadTemplates();
                    }
                });
            } catch (error) {
                console.error('? Error initializing authentication:', error);
                // Fallback to standalone mode
                currentUser = {
                    email: 'fallback@user.local',
                    displayName: 'Fallback User',
                    uid: 'fallback-user-id'
                };
                updateUserProfile(currentUser);
                
                // Load templates for fallback user (only global templates)
                console.log('?? Loading global templates for fallback user...');
                loadTemplates();
            }
        }

        // Load user company data and store companyId
        async function loadUserCompanyData(user) {
            try {
                if (!window.firebaseAvailable || !firebase.database || !user) {
                    console.log('?? Firebase not available or no user - skipping company data load');
                    return;
                }

                const database = firebase.database();
                const userRef = database.ref(`users/${user.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();

                if (userData && userData.companyId) {
                    // Update currentUser with companyId
                    currentUser.companyId = userData.companyId;
                    
                    console.log('? User company ID loaded:', userData.companyId);
                    
                    // Optionally load full company details
                    const companyRef = database.ref(`companies/${userData.companyId}`);
                    const companySnapshot = await companyRef.once('value');
                    const companyData = companySnapshot.val();
                    
                    if (companyData) {
                        // Store company data in localStorage for other functions
                        localStorage.setItem('currentCompany', JSON.stringify({
                            companyId: userData.companyId,
                            companyName: companyData.companyName,
                            ...companyData
                        }));
                        
                        console.log('? Company data loaded:', companyData.companyName);
                        // With company context available, (re)load salary mappings and subitems
                        try { typeof loadSalaryMappings === 'function' && loadSalaryMappings(); } catch(_) {}
                        try { typeof loadSalarySubitemsSettings === 'function' && loadSalarySubitemsSettings(); } catch(_) {}
                        // If edit mode is active, ensure compensation selectors get a chance to restore now that mappings exist
                        try {
                            if (window.editMode && window.loadedContractData) {
                                // Re-run the compensation restore piece with the loaded data (safe no-op if already set)
                                // We call the inner logic indirectly by triggering the band population from current title
                                const currentTitle = document.getElementById('positionTitle')?.value || window.loadedContractData.positionTitle || '';
                                if (currentTitle && typeof populateGradeOptionsForTitle === 'function') {
                                    populateGradeOptionsForTitle(currentTitle);
                                }
                            }
                        } catch(_) {}
                    }
                    
                    // Now that company data is loaded, load templates with company scope
                    console.log('?? Loading templates with company context...');
                    
                    // Test Firebase Realtime Database connection first
                    testRealtimeDatabaseConnection();
                    
                    // Load templates
                    loadTemplates();
                    
                    // Setup real-time template updates after templates are loaded
                    setTimeout(() => {
                        setupRealTimeTemplateUpdates();
                    }, 1000);
                    
                    // Now that company data is loaded, refresh employees list
                    console.log('?? Reloading employees with company context...');
                    loadEmployees();
                } else {
                    console.log('?? No company ID found for user');
                    // Load global templates only since no company context is available
                    console.log('?? Loading global templates only (no company context)...');
                    loadTemplates();
                    
                    // Still try to setup real-time updates in case user gets company access later
                    setTimeout(() => {
                        setupRealTimeTemplateUpdates();
                    }, 1000);
                }
            } catch (error) {
                console.error('? Error loading user company data:', error);
                // Load global templates on error
                console.log('?? Loading global templates only (error fallback)...');
                loadTemplates();
                
                // Still try to setup real-time updates for error recovery
                setTimeout(() => {
                    setupRealTimeTemplateUpdates();
                }, 1000);
            }
        }

        // Update user profile in UI
        function updateUserProfile(user) {
            const userAvatar = document.getElementById('userAvatar');
            
            if (userAvatar) {
                // Try to get custom avatar or use initials
                getUserAvatarUrl(user).then(avatarUrl => {
                    if (avatarUrl) {
                        userAvatar.src = avatarUrl;
                        userAvatar.alt = (user.displayName || user.email) + ' Avatar';
                    } else {
                        // Generate initials avatar
                        generateInitialsAvatar(user.displayName || user.email, userAvatar);
                    }
                }).catch(error => {
                    console.warn('Could not load user avatar, using initials:', error);
                    generateInitialsAvatar(user.displayName || user.email, userAvatar);
                });
            }
        }
        
        // Get user avatar URL or initials
        async function getUserAvatarUrl(user) {
            try {
                if (window.firebaseAvailable && firebase.storage && user && user.uid) {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${user.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } else {
                    // No custom avatar found
                    return null;
                }
            } catch (error) {
                // No custom avatar found or error accessing storage
                return null;
            }
        }
        
        // Generate initials avatar
        function generateInitialsAvatar(name, imgElement) {
            const initials = name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Create SVG avatar with initials
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            const encodedSvg = btoa(svg);
            imgElement.src = `data:image/svg+xml;base64,${encodedSvg}`;
            imgElement.alt = name + ' Avatar';
        }

        // Load people from Firebase (company-scoped): offers (all), employees, and users
        async function loadEmployees() {
            console.log('Loading people from company scope (offers, employees, users)...');
            
            // Show loading state
            const loadingElement = document.getElementById('loadingEmployees');
            const dropdown = document.getElementById('employeeDropdown');
            
            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }

            try {
                // Check if Firebase is available and user is authenticated
                if (!window.firebaseAvailable || !firebase.database || !currentUser) {
                    console.warn('?? Firebase not available or no user - loading from fallback URL');
                    await loadEmployeesFromFallback();
                    return;
                }

                // First, get the user's company data to determine companyId
                const database = firebase.database();
                const userRef = database.ref(`users/${currentUser.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                
                let companyId = null;
                
                // Try to get companyId from user data
                if (userData && userData.companyId) {
                    companyId = userData.companyId;
                } else {
                    // Fallback: try to get from localStorage
                    const companyData = JSON.parse(localStorage.getItem('currentCompany') || '{}');
                    if (companyData.companyId) {
                        companyId = companyData.companyId;
                    }
                }
                
                if (!companyId) {
                    console.warn('?? No company context found - loading from fallback URL');
                    await loadEmployeesFromFallback();
                    return;
                }
                
                console.log('Loading company data for:', companyId);

                // Load company offers (all statuses), jobs, employees, and users
                const [offersSnapshot, jobsSnapshot, employeesSnapshot, usersSnapshot] = await Promise.all([
                    database.ref(`companies/${companyId}/offers`).once('value'),
                    database.ref(`companies/${companyId}/jobs`).once('value'),
                    database.ref(`companies/${companyId}/employees`).once('value'),
                    database.ref(`companies/${companyId}/users`).once('value')
                ]);

                const offersData = offersSnapshot.val() || {};
                const jobsData = jobsSnapshot.val() || {};
                const companyEmployeesData = employeesSnapshot.val() || {};
                const companyUsersData = usersSnapshot.val() || {};

                console.log('Counts ï¿½ Offers:', Object.keys(offersData).length, 'Jobs:', Object.keys(jobsData).length, 'Employees:', Object.keys(companyEmployeesData).length, 'Users:', Object.keys(companyUsersData).length);

                // Build quick lookup index for company users by email and UID
                try {
                    companyUsersIndex = { byEmail: {}, byUid: {} };
                    Object.entries(companyUsersData).forEach(([uid, u]) => {
                        const email = (u.email || '').toLowerCase();
                        const userRecord = { ...u, uid };
                        if (email) companyUsersIndex.byEmail[email] = userRecord;
                        companyUsersIndex.byUid[uid] = userRecord;
                    });
                    // Expose for other functions
                    window.companyUsersIndex = companyUsersIndex;
                } catch (e) {
                    console.warn('Could not build company users index', e);
                }

                // 1) Normalize from offers
                const fromOffers = Object.entries(offersData).map(([offerId, offer]) => {
                    // Find matching job posting by title to get lineManager
                    let jobData = null;
                    const jobTitle = offer.jobTitle;
                    
                    // Search for job by title in jobs data
                    for (const [jobId, job] of Object.entries(jobsData)) {
                        if (job.title === jobTitle || job.jobTitle === jobTitle || job.positionTitle === jobTitle) {
                            jobData = job;
                            console.log(`Found job data for ${jobTitle}:`, {
                                lineManager: job.lineManager,
                                department: job.department,
                                workLocation: job.workLocation,
                                location: job.location
                            });
                            break;
                        }
                    }
                    
                    return {
                        firebaseId: offerId,
                        offerId: offerId,
                        // Candidate information
                        candidateId: offer.candidateId,
                        candidateName: getCandidateFullName(offer),
                        name: getCandidateFullName(offer),
                        fullName: getCandidateFullName(offer),
                        firstName: offer.candidateFirstName || offer.firstName,
                        lastName: offer.candidateLastName || offer.lastName,
                        candidateEmail: offer.candidateEmail,
                        email: offer.candidateEmail,
                        candidatePhone: offer.candidatePhone,
                        phone: offer.candidatePhone,
                        // Job information
                        jobTitle: offer.jobTitle,
                        position: offer.jobTitle,
                        department: offer.department,
                        // Management information - PRIORITIZE lineManager from job posting
                        lineManager: jobData?.lineManager || offer.lineManager || offer.reportingManager || offer.manager,
                        hiringManager: offer.hiringManager,
                        reportingManager: jobData?.lineManager || offer.reportingManager || offer.lineManager || offer.manager,
                        manager: offer.manager || jobData?.lineManager,
                        // Employment details
                        employmentType: offer.employmentType,
                        // Location information - PRIORITIZE workLocation (Primary Work Location) from job posting
                        location: jobData?.workLocation || offer.location || offer.workLocation,
                        workLocation: jobData?.workLocation || offer.workLocation || offer.location,
                        // Offer information
                        salary: offer.salary,
                        proposedSalary: offer.proposedSalary || offer.salary,
                        salaryAmount: offer.salaryAmount || offer.salary,
                        baseSalary: offer.baseSalary,
                        salaryType: offer.salaryType,
                        // Date information from offer
                        startDate: offer.startDate,
                        offerExpiryDate: offer.offerExpiryDate,
                        contractDuration: offer.contractDuration,
                        acceptedAt: offer.acceptedAt,
                        createdAt: offer.createdAt,
                        status: offer.status,
                        source: 'offer',
                        companyId: companyId,
                        // Store job data for reference
                        jobData: jobData,
                        // Include all original offer data
                        ...offer
                    };
                });

                // 2) Normalize from employees collection
                const fromEmployees = Object.entries(companyEmployeesData).map(([id, emp]) => {
                    const first = emp.personal?.firstName || emp.firstName || '';
                    const last = emp.personal?.lastName || emp.lastName || '';
                    const full = `${first} ${last}`.trim() || emp.name || emp.fullName || emp.contact?.email || 'Unknown Employee';
                    return {
                        firebaseId: id,
                        employeeId: emp.employeeId || id,
                        name: full,
                        fullName: full,
                        firstName: first,
                        lastName: last,
                        email: emp.contact?.email || emp.email || '',
                        phone: emp.contact?.phone || emp.phone || '',
                        position: emp.employment?.position || emp.position || '',
                        department: emp.employment?.department || emp.department || '',
                        manager: emp.employment?.manager || '',
                        reportingManager: emp.employment?.manager || '',
                        employmentType: emp.employment?.type || emp.employmentType || '',
                        status: emp.employment?.status || emp.status || '',
                        source: 'employee',
                        companyId
                    };
                });

                // 3) Normalize from users collection
                const fromUsers = Object.entries(companyUsersData).map(([id, u]) => {
                    const first = u.firstName || u.given_name || '';
                    const last = u.lastName || u.family_name || '';
                    const full = `${first} ${last}`.trim() || u.displayName || u.name || u.email || 'Unknown User';
                    return {
                        firebaseId: id,
                        userUid: id,
                        employeeId: u.employeeId || id,
                        name: full,
                        fullName: full,
                        firstName: first,
                        lastName: last,
                        email: u.email || '',
                        phone: u.phone || '',
                        department: u.department || '',
                        // Persist both normalized position and explicit jobTitle from user modal
                        position: u.title || u.position || u.jobTitle || '',
                        jobTitle: u.jobTitle || u.title || u.position || '',
                        userJobTitle: u.jobTitle || '',
                        // Reporting chain from companymanagement modal
                        lineManager: u.lineManager || '',
                        lineManagerId: u.lineManagerId || '',
                        manager: u.manager || '',
                        reportingManager: u.lineManager || u.manager || '',
                        source: 'user',
                        companyId
                    };
                });

                // Merge and deduplicate by email or ID; prefer employee > offer > user for richer data
                const merged = [...fromOffers, ...fromEmployees, ...fromUsers];
                const byKey = new Map();
                merged.forEach(p => {
                    const key = (p.email || '').toLowerCase() || String(p.employeeId || p.candidateId || p.firebaseId || '').toLowerCase();
                    if (!byKey.has(key)) {
                        byKey.set(key, p);
                    } else {
                        const existing = byKey.get(key);
                        const rank = { user: 1, offer: 2, employee: 3 };
                        const a = rank[p.source || 'offer'] || 0;
                        const b = rank[existing.source || 'offer'] || 0;
                        byKey.set(key, a >= b ? { ...existing, ...p } : { ...p, ...existing });
                    }
                });

                employees = Array.from(byKey.values()).sort((a, b) => (a.fullName || a.name || '').localeCompare(b.fullName || b.name || ''));
                console.log(`Loaded ${employees.length} people (merged from offers, employees, users)`);
                populateEmployeeDropdown();
                
            } catch (error) {
                console.error('Error loading employees from company-scoped data:', error);
                console.log('Falling back to global acceptedoffer.json');
                await loadEmployeesFromFallback();
            } finally {
                // Hide loading state
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

    // Fallback function to load from global acceptedoffer.json (offers only)
        async function loadEmployeesFromFallback() {
            try {
                const response = await fetch('https://users-8be65-default-rtdb.firebaseio.com/acceptedoffer.json');
                const data = await response.json();
                
                console.log('Fallback employees data received:', data);
                
                if (data) {
                    // Convert Firebase object to array
                    employees = Object.entries(data).map(([firebaseId, employee]) => ({
                        firebaseId,
                        ...employee
                    }));
                    
                    console.log(`Loaded ${employees.length} employees from fallback acceptedoffer.json`);
                    populateEmployeeDropdown();
                } else {
                    console.log('No employees found in fallback acceptedoffer.json');
                    employees = [];
                    populateEmployeeDropdown();
                }
            } catch (error) {
                console.error('Error loading employees from fallback:', error);
                employees = [];
                populateEmployeeDropdown();
            }
        }

        // Helper function to get candidate full name (same as offer.html)
        function getCandidateFullName(offer) {
            if (offer.candidateName) {
                return offer.candidateName;
            }
            
            const firstName = offer.candidateFirstName || offer.firstName || '';
            const lastName = offer.candidateLastName || offer.lastName || '';
            
            if (firstName && lastName) {
                return `${firstName} ${lastName}`.trim();
            }
            
            return firstName || lastName || offer.candidateEmail || 'Unknown Candidate';
        }

        // Populate the employee dropdown
        function populateEmployeeDropdown() {
            const dropdown = document.getElementById('employeeDropdown');
            
            if (!dropdown) return;

            // Clear existing options (except the default one)
            dropdown.innerHTML = `<option value="" data-i18n="option.selectPerson">${t('option.selectPerson')}</option>`;

            if (employees.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = t('option.noPeopleFound');
                option.disabled = true;
                dropdown.appendChild(option);
                return;
            }

            // Add options: Full Name ï¿½ Job Title (when available)
            employees.forEach((employee, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                // Determine full name
                let displayText = employee.fullName || employee.name || employee.candidateName || '';
                if (!displayText) {
                    if (employee.firstName || employee.lastName) {
                        displayText = `${employee.firstName || ''} ${employee.lastName || ''}`.trim();
                    } else {
                        displayText = 'Unknown Candidate';
                    }
                }

                // Determine job title
                const jobTitle = (employee.position || employee.jobTitle || employee.title || '').toString().trim();
                option.textContent = jobTitle ? `${displayText} ï¿½ ${jobTitle}` : displayText;
                dropdown.appendChild(option);
            });

            console.log(`Populated dropdown with ${employees.length} people`);
        }

        // Fill employee details when dropdown selection changes
        function fillEmployeeDetails() {
            const dropdown = document.getElementById('employeeDropdown');
            const selectedIndex = dropdown.value;

            if (selectedIndex === '' || selectedIndex === null) {
                // Clear the form if no employee is selected
                clearEmployeeForm();
                return;
            }

            const selectedEmployee = employees[parseInt(selectedIndex)];
            if (!selectedEmployee) {
                console.error('Selected employee not found');
                return;
            }

            console.log('Selected employee:', selectedEmployee);

            // Fill employee information fields
            const employeeName = selectedEmployee.candidateName || selectedEmployee.name || selectedEmployee.fullName || 
                                 (selectedEmployee.firstName && selectedEmployee.lastName ? 
                                  `${selectedEmployee.firstName} ${selectedEmployee.lastName}` : '');
            
            document.getElementById('employeeName').value = employeeName;
            document.getElementById('employeeId').value = selectedEmployee.employeeId || selectedEmployee.candidateId || '';
            document.getElementById('employeeEmail').value = selectedEmployee.email || '';
            document.getElementById('employeePhone').value = selectedEmployee.phone || selectedEmployee.phoneNumber || '';

            // Try to prefill additional personal info when available
            try {
                const personal = selectedEmployee.personal || {};
                const contact = selectedEmployee.contact || {};
                const address = selectedEmployee.address || personal.address || contact.address || selectedEmployee.homeAddress || '';
                const ec = selectedEmployee.emergencyContact || {};
                const demographics = selectedEmployee.demographics || {};
                // Map legacy gender/salutation abbreviations to full-word salutations
                const mapGenderToTitle = (g) => {
                    if (!g) return '';
                    const s = String(g).trim().toLowerCase();
                    // Gender to salutation
                    if (['male','m'].includes(s)) return 'Sir';
                    if (['female','f','woman','lady'].includes(s)) return 'Madam';
                    // Common abbreviations to full words
                    if (s === 'mr' || s === 'mister') return 'Sir';
                    if (s === 'mrs' || s === 'madam') return 'Madam';
                    if (s === 'ms') return 'Madam';
                    if (s === 'miss') return 'Miss';
                    if (s === 'dr' || s === 'dr.') return 'Doctor';
                    if (s === 'prof' || s === 'prof.') return 'Professor';
                    if (s === 'eng' || s === 'eng.') return 'Engineer';
                    return '';
                };
                if (document.getElementById('gender')) {
                    const titleRaw = personal.title || personal.salutation || selectedEmployee.title || personal.gender || demographics.gender;
                    const title = mapGenderToTitle(titleRaw) || (typeof titleRaw === 'string' ? titleRaw : '');
                    document.getElementById('gender').value = title || '';
                }
                if (document.getElementById('fatherName')) document.getElementById('fatherName').value = personal.fatherName || '';
                if (document.getElementById('motherName')) document.getElementById('motherName').value = personal.motherName || '';
                if (document.getElementById('nationality')) {
                    const nat = personal.nationality || demographics.nationality || '';
                    const sel = document.getElementById('nationality');
                    if ([...sel.options].some(o => o.value.toLowerCase() === String(nat).toLowerCase())) {
                        sel.value = [...sel.options].find(o => o.value.toLowerCase() === String(nat).toLowerCase()).value;
                    } else {
                        sel.value = '';
                    }
                }
                if (document.getElementById('birthDate')) document.getElementById('birthDate').value = personal.birthDate || demographics.birthDate || '';
                if (document.getElementById('birthCountry')) {
                    const bc = personal.birthCountry || demographics.birthCountry || '';
                    const sel = document.getElementById('birthCountry');
                    if ([...sel.options].some(o => o.value === bc)) sel.value = bc; else sel.value = '';
                }
                if (document.getElementById('maritalStatus')) document.getElementById('maritalStatus').value = personal.maritalStatus || demographics.maritalStatus || '';
                if (document.getElementById('dependents')) document.getElementById('dependents').value = personal.dependents || demographics.dependents || '';
                if (document.getElementById('address')) document.getElementById('address').value = address || '';
                try {
                    const contactsArr = Array.isArray(selectedEmployee.emergencyContacts)
                        ? selectedEmployee.emergencyContacts
                        : (ec && Object.keys(ec).length ? [ec] : []);
                    if (typeof renderEmergencyContactsUI === 'function') {
                        renderEmergencyContactsUI(contactsArr);
                    }
                } catch(_) { /* non-fatal */ }
            } catch (e) { console.warn('Prefill of additional personal info failed', e); }

            // Fill position information; prefer Job Title from company user details modal (authoritative)
            let positionFromUserModal = '';
            try {
                // If merged data carried userJobTitle, use it
                if (selectedEmployee.userJobTitle && String(selectedEmployee.userJobTitle).trim()) {
                    positionFromUserModal = String(selectedEmployee.userJobTitle).trim();
                } else {
                    // Otherwise, try to look up by email in the company users index
                    const emailKey = (selectedEmployee.email || '').toLowerCase();
                    const userRec = emailKey && window.companyUsersIndex && window.companyUsersIndex.byEmail
                        ? window.companyUsersIndex.byEmail[emailKey]
                        : null;
                    if (userRec && userRec.jobTitle) {
                        positionFromUserModal = String(userRec.jobTitle).trim();
                        console.log('?? Job Title fetched from company users (modal):', positionFromUserModal);
                    }
                }
            } catch (e) { console.warn('Job title lookup from users index failed', e); }

            const determinedPositionTitle = positionFromUserModal
                || selectedEmployee.jobTitle
                || selectedEmployee.position
                || selectedEmployee.title
                || selectedEmployee.designation
                || selectedEmployee.role
                || '';
            if (determinedPositionTitle) {
                document.getElementById('positionTitle').value = determinedPositionTitle;
                try {
                    populateGradeOptionsForTitle(determinedPositionTitle);
                } catch(_){}
            }
            if (selectedEmployee.department) {
                document.getElementById('department').value = selectedEmployee.department;
            }
            
            // Fill reporting manager - prefer value from company users modal (lineManager)
            let reportingManagerName = '';
            try {
                // Check carried fields from normalized selection
                if (selectedEmployee.lineManager && String(selectedEmployee.lineManager).trim()) {
                    reportingManagerName = String(selectedEmployee.lineManager).trim();
                    console.log('?? Using lineManager from company users data:', reportingManagerName);
                } else if (selectedEmployee.reportingManager && String(selectedEmployee.reportingManager).trim()) {
                    reportingManagerName = String(selectedEmployee.reportingManager).trim();
                    console.log('?? Using reportingManager from user data:', reportingManagerName);
                } else {
                    // Lookup by email in company users index
                    const emailKey = (selectedEmployee.email || '').toLowerCase();
                    const userRec = emailKey && window.companyUsersIndex && window.companyUsersIndex.byEmail
                        ? window.companyUsersIndex.byEmail[emailKey]
                        : null;
                    if (userRec && userRec.lineManager) {
                        reportingManagerName = String(userRec.lineManager).trim();
                        console.log('?? Reporting manager fetched from company users (modal):', reportingManagerName);
                    }
                }
            } catch (e) { console.warn('Reporting manager lookup from users index failed', e); }

            // Fall back to recruitment data if none from users modal
            if (!reportingManagerName) {
                if (selectedEmployee.lineManager) {
                    reportingManagerName = selectedEmployee.lineManager;
                    console.log('? Using line manager from recruitment process:', reportingManagerName);
                } else if (selectedEmployee.hiringManager) {
                    reportingManagerName = selectedEmployee.hiringManager;
                    console.log('? Using hiring manager as reporting manager:', reportingManagerName);
                } else if (selectedEmployee.manager || selectedEmployee.reportingManager) {
                    reportingManagerName = selectedEmployee.manager || selectedEmployee.reportingManager;
                    console.log('? Using general manager field:', reportingManagerName);
                } else {
                    console.log('?? No reporting manager found for selected employee');
                }
            }
            
            if (reportingManagerName) {
                document.getElementById('reportingManager').value = reportingManagerName;
            }
            
            // Fill work location from recruitment process - prioritize Primary Work Location from job posting
            let workLocationName = '';
            if (selectedEmployee.location) {
                workLocationName = selectedEmployee.location;
                console.log('? Using Primary Work Location from job posting:', workLocationName);
            } else if (selectedEmployee.workLocation) {
                workLocationName = selectedEmployee.workLocation;
                console.log('? Using work location from offer:', workLocationName);
            } else {
                console.log('?? No Primary Work Location information found for selected employee');
            }
            
            if (workLocationName) {
                const locEl = document.getElementById('workLocation');
                if (locEl) {
                    if (siteOptions && siteOptions.length) {
                        if (!siteOptions.includes(workLocationName)) {
                            const opt = document.createElement('option');
                            opt.value = workLocationName;
                            opt.textContent = workLocationName;
                            locEl.appendChild(opt);
                        }
                        locEl.value = workLocationName;
                    } else {
                        // Load options then set
                        loadWorkAreasIntoLocationSelect().then(() => {
                            if (!siteOptions.includes(workLocationName)) {
                                const opt = document.createElement('option');
                                opt.value = workLocationName;
                                opt.textContent = workLocationName;
                                locEl.appendChild(opt);
                            }
                            locEl.value = workLocationName;
                        }).catch(() => {
                            const opt = document.createElement('option');
                            opt.value = workLocationName;
                            opt.textContent = workLocationName;
                            locEl.appendChild(opt);
                            locEl.value = workLocationName;
                        });
                    }
                }
            }

            // Trigger re-render for placeholder-driven content after auto-fill
            try {
                if (typeof renderSelectedTemplateInForm === 'function') {
                    renderSelectedTemplateInForm();
                }
                const previewTab = document.getElementById('preview');
                if (previewTab && previewTab.classList.contains('active') && typeof displayTemplateContent === 'function') {
                    displayTemplateContent();
                }
                // Also update new compensation-related previews
                ['compGrade','minSalary','midSalary','maxSalary'].forEach(updatePreviewField);
            } catch (e) { console.warn('Post-fill render refresh failed', e); }

            // Fill compensation information if available
            // Prioritize base salary from offer, then fall back to other salary fields
            let salaryValue = selectedEmployee.baseSalary || selectedEmployee.salary || selectedEmployee.salaryAmount;
            if (salaryValue) {
                document.getElementById('salaryAmount').value = salaryValue;
                if (selectedEmployee.baseSalary) {
                    console.log('? Using base salary from offer:', selectedEmployee.baseSalary);
                } else if (selectedEmployee.salary) {
                    console.log('? Using salary from offer:', selectedEmployee.salary);
                } else {
                    console.log('? Using salary amount from offer:', selectedEmployee.salaryAmount);
                }
            } else {
                console.log('?? No salary information found in offer data');
            }

            // Fill probation period from offer letter
            if (selectedEmployee.probationPeriod) {
                document.getElementById('probationPeriod').value = selectedEmployee.probationPeriod;
                console.log('? Using probation period from offer letter:', selectedEmployee.probationPeriod);
            } else {
                console.log('?? No probation period found in offer letter');
            }

            // Fill employment type from offer data
            if (selectedEmployee.employmentType) {
                // Map common employment type values to dropdown options
                let employmentTypeValue = selectedEmployee.employmentType.toLowerCase();
                
                // Handle various employment type formats
                if (employmentTypeValue.includes('full') || employmentTypeValue.includes('permanent')) {
                    employmentTypeValue = 'full-time';
                } else if (employmentTypeValue.includes('part')) {
                    employmentTypeValue = 'part-time';
                } else if (employmentTypeValue.includes('consultant') || employmentTypeValue.includes('contract')) {
                    employmentTypeValue = 'consultant';
                }
                
                // Set the dropdown value
                const employmentTypeSelect = document.getElementById('employmentType');
                if (employmentTypeSelect) {
                    // Check if the mapped value exists in the dropdown options
                    const option = employmentTypeSelect.querySelector(`option[value="${employmentTypeValue}"]`);
                    if (option) {
                        employmentTypeSelect.value = employmentTypeValue;
                        console.log('? Using employment type from offer:', selectedEmployee.employmentType, '?', employmentTypeValue);
                    } else {
                        console.log('?? Employment type from offer not found in dropdown options:', selectedEmployee.employmentType);
                    }
                }
            } else {
                console.log('?? No employment type found in offer data');
            }

            // Fill date information from offer letter
            if (selectedEmployee.startDate) {
                document.getElementById('startDate').value = selectedEmployee.startDate;
                console.log('? Using start date from offer letter:', selectedEmployee.startDate);
            } else {
                console.log('?? No start date found in offer letter');
            }

            // Calculate end date based on offer information
            let calculatedEndDate = '';
            if (selectedEmployee.offerExpiryDate) {
                // Note: Offer expiry date is different from contract end date
                // We should use this cautiously and may need to calculate based on contract duration
                console.log('?? Offer expiry date available:', selectedEmployee.offerExpiryDate);
            }
            
            if (selectedEmployee.contractDuration && selectedEmployee.startDate) {
                // Try to calculate end date based on contract duration and start date
                const startDate = new Date(selectedEmployee.startDate);
                if (!isNaN(startDate.getTime())) {
                    const duration = selectedEmployee.contractDuration;
                    
                    // Handle different duration formats
                    if (duration && duration.toLowerCase() !== 'permanent' && duration.toLowerCase() !== 'indefinite') {
                        // Try to parse duration (e.g., "12 months", "2 years", "6 months")
                        const durationMatch = duration.match(/(\d+)\s*(month|year|day)s?/i);
                        if (durationMatch) {
                            const amount = parseInt(durationMatch[1]);
                            const unit = durationMatch[2].toLowerCase();
                            
                            const endDate = new Date(startDate);
                            if (unit === 'month') {
                                endDate.setMonth(endDate.getMonth() + amount);
                            } else if (unit === 'year') {
                                endDate.setFullYear(endDate.getFullYear() + amount);
                            } else if (unit === 'day') {
                                endDate.setDate(endDate.getDate() + amount);
                            }
                            
                            calculatedEndDate = endDate.toISOString().split('T')[0];
                            console.log('? Calculated contract end date from duration:', calculatedEndDate, `(${duration})`);
                        } else {
                            console.log('?? Could not parse contract duration format:', duration);
                        }
                    } else {
                        console.log('?? Contract is permanent/indefinite - no end date set');
                    }
                } else {
                    console.log('?? Invalid start date format for end date calculation');
                }
            } else {
                console.log('?? Missing contract duration or start date for end date calculation');
            }
            
            // Set calculated end date if available
            if (calculatedEndDate) {
                document.getElementById('endDate').value = calculatedEndDate;
                console.log('? Contract end date populated from offer data');
            } else {
                console.log('?? No contract end date calculated - leaving field empty for manual entry');
            }            // Trigger validation for filled fields
            const filledFields = ['employeeName', 'employeeId', 'employeeEmail', 'employeePhone', 
                                 'gender','fatherName','motherName','nationality','birthDate','birthCountry','maritalStatus','dependents','address',
                                 'emergencyContactName','emergencyContactRelationship','emergencyContactPhone','emergencyContactAddress',
                                 'positionTitle', 'department', 'reportingManager', 'workLocation',
                                 'salaryAmount', 'grossSalary', 'employmentType', 'startDate', 'endDate', 'probationPeriod'];
            
            const lockedIds = new Set(['employeeName','employeeId','employeeEmail','employeePhone','positionTitle','department','reportingManager','salaryAmount','grossSalary','housingAllowance','accommodationAllowance']);
            filledFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    validateField(field);
                    // Ensure field remains editable after being populated
                    if (!lockedIds.has(fieldId)) field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                    if (!lockedIds.has(fieldId)) field.readOnly = false;
                    field.disabled = false;
                }
            });

            console.log('Employee details filled successfully');
        }        // Clear employee form fields
        function clearEmployeeForm() {
            const fields = ['employeeName', 'employeeId', 'employeeEmail', 'employeePhone', 
                           'gender','fatherName','motherName','nationality','birthDate','birthCountry','maritalStatus','dependents','address',
                           'emergencyContactName','emergencyContactRelationship','emergencyContactPhone','emergencyContactAddress',
                           'positionTitle', 'department', 'reportingManager', 'workLocation',
                           'salaryAmount', 'grossSalary', 'employmentType', 'startDate', 'endDate', 'probationPeriod'];
            
            const lockedIds2 = new Set(['employeeName','employeeId','employeeEmail','employeePhone','positionTitle','department','reportingManager','salaryAmount','grossSalary','housingAllowance','accommodationAllowance']);
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    // Ensure field is editable after clearing
                    if (!lockedIds2.has(fieldId)) field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                    if (!lockedIds2.has(fieldId)) field.readOnly = false;
                    field.disabled = false;
                    // Remove validation styling
                    field.classList.remove('is-valid', 'is-invalid');
                }
            });
        }

        // Load work areas from Settings (companies/{companyId}/fieldOptions/area) and populate Location select
        async function loadWorkAreasIntoLocationSelect() {
            if (!window.firebaseAvailable || !firebase.database) return;
            try {
                let companyId = currentUser?.companyId;
                if (!companyId) {
                    try { const cc = JSON.parse(localStorage.getItem('currentCompany')||'{}'); companyId = cc.companyId; } catch(_){}
                }
                if (!companyId) return;
                let options = [];
                // Primary
                try {
                    const snap = await firebase.database().ref(`companies/${companyId}/fieldOptions/area`).once('value');
                    if (snap.exists()) {
                        const raw = snap.val();
                        if (Array.isArray(raw)) options = raw.filter(o=>o && o.enabled !== false).map(o=>o.label||o.value||o).filter(Boolean);
                        else options = Object.values(raw || {}).filter(o=>o && o.enabled !== false).map(o=>o.label||o.value||o).filter(Boolean);
                    }
                } catch(_) {}
                // Secondary
                if (!options.length) {
                    try {
                        const snap2 = await firebase.database().ref(`companies/${companyId}/settings/fieldOptions/area`).once('value');
                        if (snap2.exists()) {
                            const raw = snap2.val();
                            if (Array.isArray(raw)) options = raw.filter(o=>o && o.enabled !== false).map(o=>o.label||o.value||o).filter(Boolean);
                            else options = Object.values(raw || {}).filter(o=>o && o.enabled !== false).map(o=>o.label||o.value||o).filter(Boolean);
                        }
                    } catch(_) {}
                }
                // Legacy
                if (!options.length) {
                    try {
                        const snap3 = await firebase.database().ref(`companies/${companyId}/sites`).once('value');
                        if (snap3.exists()) options = Object.values(snap3.val()||{}).map(s=>s.name||s).filter(Boolean);
                    } catch(_) {}
                }
                siteOptions = options;
                const sel = document.getElementById('workLocation');
                if (sel) {
                    const current = sel.value;
                    sel.innerHTML = '<option value="">Select Work Area</option>' + (options||[]).map(o=>`<option value="${o}">${o}</option>`).join('');
                    if (current) {
                        if (!options.includes(current)) {
                            const opt = document.createElement('option'); opt.value = current; opt.textContent = current; sel.appendChild(opt);
                        }
                        sel.value = current;
                    }
                }
            } catch (e) {
                console.error('Failed to load work areas:', e);
            }
        }

        // Generate employee ID based on name and department
        function generateEmployeeId(name, department) {
            if (!name) return '';
            
            // Create initials from name
            const nameParts = name.trim().split(' ');
            const initials = nameParts.map(part => part.charAt(0).toUpperCase()).join('');
            
            // Create department code (first 3 letters)
            const deptCode = department ? department.substring(0, 3).toUpperCase() : 'GEN';
            
            // Generate random number
            const randomNum = Math.floor(Math.random() * 9000) + 1000; // 4-digit number
            
            return `${initials}${deptCode}${randomNum}`;
        }
        function loadTemplates() {
            console.log('?? Loading templates from Firebase Realtime Database...');
            
            // Show loading state
            document.getElementById('loadingTemplates').style.display = 'block';
            document.getElementById('templateGrid').style.display = 'none';
            document.getElementById('emptyTemplates').style.display = 'none';

            // Get current user's company ID for filtering
            const userCompanyId = currentUser?.companyId;
            console.log('?? Loading templates ONLY for company:', userCompanyId);

            // Initialize empty templates array
            templates = [];

            // Only load company-specific templates if we have a company ID
            if (database && userCompanyId) {
                console.log('?? Loading ONLY company-specific templates from Firebase Realtime Database');
                console.log('?? Database path:', `companies/${userCompanyId}/documentTemplates`);
                
                // Load ONLY company-specific templates (matches dochtml.html save path exactly)
                database.ref(`companies/${userCompanyId}/documentTemplates`).once('value')
                    .then((snapshot) => {
                        const companyTemplates = snapshot.val() || {};
                        console.log('?? Company templates found:', companyTemplates);
                        console.log('?? Number of company templates:', Object.keys(companyTemplates).length);
                        
                        Object.entries(companyTemplates).forEach(([templateId, template]) => {
                            // Check if it's a contract-related template
                            const isContractTemplate = template.category === 'contract' || 
                                template.category === 'employment' ||
                                template.name?.toLowerCase().includes('contract') ||
                                template.name?.toLowerCase().includes('employment');
                            
                            console.log(`?? Template "${template.name}":`, {
                                id: templateId,
                                category: template.category,
                                name: template.name,
                                companyId: template.companyId,
                                isContractTemplate: isContractTemplate,
                                createdAt: template.createdAt,
                                lastModified: template.lastModified
                            });
                            
                            if (isContractTemplate) {
                                templates.push({ id: templateId, companyId: userCompanyId, ...template });
                            }
                        });
                        
                        console.log(`? Successfully loaded ${templates.length} company-specific contract templates`);
                        displayTemplates();
                    })
                    .catch((error) => {
                        console.error('? Error loading company-specific templates from Firebase Realtime Database:', error);
                        templates = [];
                        displayTemplates();
                    });
            } else {
                console.log('?? Cannot load templates - missing database connection or company ID');
                console.log('Database available:', !!database);
                console.log('Company ID available:', !!userCompanyId);
                console.log('Current user object:', currentUser);
                templates = [];
                displayTemplates();
            }
        }

        // Display templates in the grid
        function displayTemplates() {
            console.log('?? Displaying templates in table...');

            const loadingElement = document.getElementById('loadingTemplates');
            const templateGrid = document.getElementById('templateGrid');
            const emptyElement = document.getElementById('emptyTemplates');

            // Hide loading state
            loadingElement.style.display = 'none';

            if (templates.length === 0) {
                console.log('?? No templates found - showing empty state');
                // Show empty state
                templateGrid.style.display = 'none';
                emptyElement.style.display = 'block';
                return;
            }

            console.log(`?? Displaying ${templates.length} templates in table`);
            // Show container area
            templateGrid.style.display = 'block';
            emptyElement.style.display = 'none';

            // Helper to format timestamps
            const fmt = (ts) => {
                if (!ts) return '-';
                const d = new Date(ts);
                if (isNaN(d)) return '-';
                try {
                    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' }) + ' ' +
                           d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                } catch (_) {
                    return d.toISOString();
                }
            };

            const rows = templates.map((template, idx) => {
                const id = template.id || template.name;
                const sectionsCount = Array.isArray(template.sections) ? template.sections.length : 0;
                const updated = template.updatedAt || template.lastModified || template.modifiedAt || null;
                const created = template.createdAt || template.created || null;
                const category = template.category || 'General';
                return `
                    <tr class="template-row" data-template-id="${id}" onclick="selectTemplate('${id}')">
                        <td>${idx + 1}</td>
                        <td>
                            <div style="display:flex;flex-direction:column;gap:2px;">
                                <span style="font-weight:600;color:#2c3e50;">${template.name || '-'}</span>
                                <span class="text-muted-small">${template.description ? template.description : ''}</span>
                            </div>
                        </td>
                        <td><span class="template-category">${category}</span></td>
                        <td>${sectionsCount}</td>
                        <td>${fmt(updated)}</td>
                        <td>${fmt(created)}</td>
                        <td>
                            <div class="template-actions">
                                <button class="icon-btn" title="Select template" aria-label="Select template" onclick="event.stopPropagation(); selectTemplate('${id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            templateGrid.innerHTML = `
                <div class="template-table-container">
                    <table class="template-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Template Name</th>
                                <th>Category</th>
                                <th>Sections</th>
                                <th>Last Modified</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;

            // Highlight previously selected template if any
            if (selectedTemplate && (selectedTemplate.id || selectedTemplate.name)) {
                const selId = selectedTemplate.id || selectedTemplate.name;
                const selRow = templateGrid.querySelector(`.template-row[data-template-id="${selId}"]`);
                if (selRow) selRow.classList.add('selected');
            }

            console.log(`Displayed ${templates.length} templates`);
        }

        // Setup real-time template updates listener
        function setupRealTimeTemplateUpdates() {
            const userCompanyId = currentUser?.companyId;
            
            if (!database || !userCompanyId) {
                console.log('?? Cannot setup real-time updates - missing database or company ID');
                console.log('Database available:', !!database);
                console.log('Company ID available:', !!userCompanyId);
                return;
            }

            console.log('?? Setting up real-time template updates for company:', userCompanyId);
            console.log('?? Watching paths:');
            console.log('  - Template updates:', `companies/${userCompanyId}/templateUpdates`);
            console.log('  - Template collection:', `companies/${userCompanyId}/documentTemplates`);

            // Listen for template update notifications (triggered by dochtml.html)
            const templateUpdatesRef = database.ref(`companies/${userCompanyId}/templateUpdates`);
            templateUpdatesRef.on('value', (snapshot) => {
                const updateData = snapshot.val();
                
                if (updateData && updateData.timestamp) {
                    console.log('?? Real-time template update notification received:', updateData);
                    
                    // Reload templates after a short delay to allow for database consistency
                    setTimeout(() => {
                        console.log('?? Reloading templates due to update notification...');
                        loadTemplates();
                    }, 500);
                }
            });

            // Also listen directly to the templates collection for immediate updates
            const templatesRef = database.ref(`companies/${userCompanyId}/documentTemplates`);
            
            templatesRef.on('child_added', (snapshot) => {
                const templateId = snapshot.key;
                const templateData = snapshot.val();
                console.log('?? New template added - refreshing list:', templateId, templateData?.name);
                setTimeout(() => loadTemplates(), 300);
            });

            templatesRef.on('child_changed', (snapshot) => {
                const templateId = snapshot.key;
                const templateData = snapshot.val();
                console.log('?? Template updated - refreshing list:', templateId, templateData?.name);
                setTimeout(() => loadTemplates(), 300);
            });

            templatesRef.on('child_removed', (snapshot) => {
                const templateId = snapshot.key;
                console.log('?? Template removed - refreshing list:', templateId);
                setTimeout(() => loadTemplates(), 300);
            });

            console.log('? Real-time template update listeners configured successfully');
        }

        // Debug function to check template loading issues
        async function debugTemplateLoading() {
            console.log('?? === TEMPLATE DEBUG START ===');
            
            // Check current user and company ID
            console.log('Current User:', currentUser);
            console.log('User Company ID:', currentUser?.companyId);
            
            // Check localStorage for company data
            const localCompany = localStorage.getItem('currentCompany');
            console.log('LocalStorage Company:', localCompany ? JSON.parse(localCompany) : 'None');
            
            // Check if database is available
            console.log('Database available:', !!database);
            console.log('Firebase available:', !!window.firebaseAvailable);
            
            // Check localStorage for templates
            const userCompanyId = currentUser?.companyId;
            if (userCompanyId) {
                const localTemplates = localStorage.getItem(`documentTemplates_${userCompanyId}`);
                console.log('LocalStorage Templates:', localTemplates ? JSON.parse(localTemplates) : 'None');
                
                // Check Firebase Realtime Database for templates
                if (database) {
                    try {
                        const snapshot = await database.ref(`companies/${userCompanyId}/documentTemplates`).once('value');
                        const firebaseTemplates = snapshot.val();
                        console.log('Firebase Realtime DB Templates:', firebaseTemplates || 'None');
                        
                        if (firebaseTemplates) {
                            console.log('Template analysis:');
                            Object.entries(firebaseTemplates).forEach(([id, template]) => {
                                const isContract = template.category === 'contract' || 
                                                 template.category === 'employment' ||
                                                 template.name?.toLowerCase().includes('contract') ||
                                                 template.name?.toLowerCase().includes('employment');
                                console.log(`- "${template.name}": category="${template.category}", isContract=${isContract}`);
                            });
                        }
                    } catch (error) {
                        console.error('Error checking Firebase templates:', error);
                    }
                }
                
                // Also check if any global fallback data exists
                try {
                    const globalTemplates = localStorage.getItem('documentTemplates');
                    console.log('Global LocalStorage Templates:', globalTemplates ? JSON.parse(globalTemplates) : 'None');
                } catch (error) {
                    console.log('Error checking global templates:', error);
                }
            } else {
                console.log('? No company ID available - cannot check templates');
                
                // Let's manually set a test company ID for debugging
                console.log('?? Setting test company ID for debugging...');
                if (!currentUser) {
                    currentUser = {
                        uid: 'test-user-id',
                        email: 'test@example.com',
                        companyId: 'test-company-123'
                    };
                } else {
                    currentUser.companyId = 'test-company-123';
                }
                console.log('Test user set:', currentUser);
                
                // Now try to load templates with test company ID
                console.log('? Attempting to load templates with test company ID...');
                loadTemplates();
            }
            
            console.log('Current templates array:', templates);
            console.log('Templates array length:', templates.length);
            
            console.log('??? === TEMPLATE DEBUG END ===');
        }

        // Force load template test function
        async function forceLoadTemplateTest() {
            console.log('?? === FORCE TEMPLATE TEST START ===');
            
            // Create a test template in localStorage for debugging
            const testCompanyId = currentUser?.companyId || 'test-company-123';
            const testTemplates = [
                {
                    id: 'test-template-1',
                    name: 'Test Employment Contract',
                    category: 'contract',
                    description: 'This is a test contract template',
                    sections: [
                        { name: 'Employee Information', fields: ['name', 'position'] },
                        { name: 'Terms and Conditions', fields: ['salary', 'start_date'] }
                    ],
                    createdAt: new Date().toISOString(),
                    companyId: testCompanyId
                },
                {
                    id: 'test-template-2', 
                    name: 'Contract for Full-time Employment',
                    category: 'employment',
                    description: 'Full-time employment contract template',
                    sections: [
                        { name: 'Basic Info', fields: ['employee_name', 'job_title'] }
                    ],
                    createdAt: new Date().toISOString(),
                    companyId: testCompanyId
                }
            ];
            
            // Save test templates to localStorage
            localStorage.setItem(`documentTemplates_${testCompanyId}`, JSON.stringify(testTemplates));
            console.log('? Test templates saved to localStorage');
            
            // Try to save to Firebase as well if available
            if (database && testCompanyId) {
                try {
                    for (const template of testTemplates) {
                        await database.ref(`companies/${testCompanyId}/documentTemplates/${template.id}`).set(template);
                    }
                    console.log('? Test templates saved to Firebase');
                } catch (error) {
                    console.log('?? Could not save to Firebase:', error);
                }
            }
            
            // Set company ID if not set
            if (!currentUser) {
                currentUser = { uid: 'test-user', email: 'test@example.com', companyId: testCompanyId };
            } else {
                currentUser.companyId = testCompanyId;
            }
            
            // Now reload templates
            console.log('?? Reloading templates after test data setup...');
            loadTemplates();
            
            console.log('?? === FORCE TEMPLATE TEST END ===');
        }

        // Test Firebase Realtime Database connection
        function testRealtimeDatabaseConnection() {
            console.log('?? Testing Firebase Realtime Database connection...');
            
            const userCompanyId = currentUser?.companyId;
            
            if (!database) {
                console.error('? Firebase Realtime Database not available');
                return;
            }
            
            if (!userCompanyId) {
                console.error('? No company ID available for testing');
                return;
            }
            
            console.log('?? Testing connection to path:', `companies/${userCompanyId}/documentTemplates`);
            
            // Test read access
            database.ref(`companies/${userCompanyId}/documentTemplates`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    console.log('? Firebase Realtime Database connection successful');
                    console.log('?? Current templates in database:', Object.keys(data || {}).length);
                    console.log('?? Template data:', data);
                })
                .catch((error) => {
                    console.error('? Firebase Realtime Database connection failed:', error);
                });
        }

        // Select a template
        function selectTemplate(templateId) {
            // Remove previous selection (from both cards and table rows if any)
            document.querySelectorAll('.template-card.selected, .template-row.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Find and select the template
            selectedTemplate = templates.find(t => (t.id || t.name) === templateId);
            if (selectedTemplate) {
                // Add selected class to clicked row if exists
                const row = document.querySelector(`.template-row[data-template-id="${templateId}"]`);
                if (row) {
                    row.classList.add('selected');
                }

                // Enable continue button
                const btn = document.getElementById('continueToForm');
                if (btn) btn.disabled = false;

                console.log('Selected template:', selectedTemplate);
                // If user already on Fill Details tab, render selected template immediately
                try {
                    const contractFormTab = document.getElementById('contractForm');
                    if (contractFormTab && contractFormTab.classList.contains('active')) {
                        renderSelectedTemplateInForm();
                    }
                } catch (e) { console.warn('Render on select failed', e); }
            }
        }
        // Proceed to form after template selection (updated for tab navigation)
        function proceedToForm() {
            if (!selectedTemplate) {
                alert('Please select a template first');
                return;
            }
            // Next step is Employee Details
            switchTab('employeeDetails');
        }

        // Tab switching functionality (matching jobscreen.html)
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show the selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate the corresponding tab button
            let buttonId = '';
            switch(tabName) {
                case 'templateSelection':
                    buttonId = 'templateSelectionBtn';
                    break;
                    case 'employeeDetails':
                        buttonId = 'employeeDetailsBtn';
                        break;
                case 'contractForm':
                    buttonId = 'contractFormBtn';
                        // Load dynamic template fields and render A4 view when entering Fill Details
                        if (selectedTemplate) {
                            loadTemplateFieldsIntoForm();
                            makeFormFieldsEditable();
                            renderSelectedTemplateInForm();
                        }
                        // Re-assert visibility of compensation controls when switching to the form tab
                        try { ensureCompFieldsVisible(); } catch(_) {}
                    break;
            }
            
            const tabButton = document.getElementById(buttonId);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Scroll to top of content
            if (selectedTab) {
                selectedTab.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Back to template selection (updated for tab navigation)
        function backToTemplateSelection() {
            switchTab('templateSelection');
        }        // Display template content in preview
        function displayTemplateContent() {
            const previewContainer = document.getElementById('templateContentPreview');
            
            // Start with comprehensive contract preview
            let contentHTML = generateCompleteContractPreview();
            // Refresh derived values before injecting placeholders
            try { if (typeof recomputeGrossSalary === 'function') recomputeGrossSalary(); } catch(_) {}
            contentHTML = applyPlaceholdersToHtml(contentHTML);
            
            previewContainer.innerHTML = contentHTML;
            
            // Set up real-time preview updates
            setupRealTimePreview();
        }

        // Build exact A4-style HTML for selected template with client-side pagination to A4 pages
        // This mirrors the dochtml.html preview and creates multiple .a4-page blocks when content exceeds one page.
        function buildA4TemplateHTML(template) {
            if (!template) return '';

            const safe = (v) => (v == null ? '' : String(v));
            const logo = safe(template.logo);
            const positionsRaw = template.logoPositions || {};
            // Normalize logo positions to an object with boolean flags
            let positions = {};
            if (Array.isArray(positionsRaw)) {
                positionsRaw.forEach(p => { positions[String(p).toLowerCase()] = true; });
            } else if (typeof positionsRaw === 'object' && positionsRaw) {
                positions = Object.assign({}, positionsRaw);
            }
            const companyName = safe(template.companyName);
            const title = safe(template.title);

            const renderLogo = (extra = '') => logo ? `<img src="${logo}" alt="Logo" style="max-height:80px;max-width:200px;object-fit:contain;${extra}">` : '';

            // Header composition
            let header = '<div style="display:flex;flex-direction:column;align-items:center;margin-bottom:16px;">';
            if (positions.top) header += renderLogo('margin-bottom:8px;');
            header += '<div style="display:flex;align-items:center;justify-content:center;gap:12px;">';
            if (positions.left) header += renderLogo();
            header += `<div style="text-align:center;">${companyName ? `<div style=\"font-size:18px;font-weight:700;color:#111;\">${companyName}</div>` : ''}${title ? `<div style=\"font-size:14px;color:#333;margin-top:4px;\">${title}</div>` : ''}</div>`;
            if (positions.right) header += renderLogo();
            header += '</div>';
            if (positions.bottom) header += renderLogo('margin-top:8px;');
            header += '</div>';

            // Sections
            const sectionHTML = (s) => {
                if (!s) return '';
                const align = s.alignment === 'center' ? 'center' : (s.alignment === 'right' ? 'right' : 'left');
                const wrap = (inner) => `<div style="text-align:${align};margin:8px 0;">${inner}</div>`;
                const type = (s.type || '').toLowerCase();
                switch (type) {
                    case 'heading': {
                        const txt = safe(s.title || s.content || '');
                        return wrap(`<h2 style="color:#2c3e50;margin-bottom:1rem;display:inline-block;">${txt}</h2>`);
                    }
                    case 'subheading':
                    case 'subtitle': {
                        const txt = safe(s.title || s.content || '');
                        return wrap(`<h3 style="color:#334155;margin:.5rem 0;display:inline-block;">${txt}</h3>`);
                    }
                    case 'text':
                    case 'paragraph': {
                        const stitle = safe(s.title || '');
                        const html = safe(s.content || '').replace(/\n/g, '<br>');
                        const titleHTML = stitle ? `<h3 style=\"display:inline-block;\">${stitle}</h3>` : '';
                        return wrap(`${titleHTML}<p style=\"display:inline-block;margin-bottom:1rem;text-align:left;\">${html}</p>`);
                        return wrap(`<p style="display:inline-block;margin-bottom:1rem;text-align:left;">${html}</p>`);
                    }
                    case 'textarea':
                        {
                            const label = safe(s.label || s.title || s.content || '');
                            const isReadonly = s.readonly ? true : false;
                            const isRequired = s.required ? true : false;
                            const maxLength = s.maxLength || s.maxlength || '';
                            return wrap(`
                                ${label ? `<h3 style=\"display:inline-block;\">${label}</h3>` : ''}
                                <div style=\"margin-bottom:1rem;\">
                                    <textarea style=\"width:100%;padding:.75rem;border:2px solid #e9ecef;border-radius:6px;font-family:inherit;font-size:.9rem;line-height:1.5;resize:vertical;min-height:120px;background:${isReadonly ? '#f8f9fa' : 'white'};\" placeholder=\"${safe(s.content || 'Enter your text here...')}\" ${isReadonly ? 'readonly' : ''} ${isRequired ? 'required' : ''} ${maxLength ? `maxlength=\"${maxLength}\"` : ''}></textarea>
                                </div>
                            `);
                        }
                    case 'placeholder': {
                        const placeholderType = s.inputType || s.placeholderType || 'text';
                        const defaultValue = safe(s.defaultValue || '');
                        const label = safe(s.label || s.title || s.content || '');
                        return wrap(`
                            ${label ? `<h3 style=\"display:inline-block;\">${label}</h3>` : ''}
                            <div style=\"display:inline-block;background:#e3f2fd;padding:.5rem;border-radius:4px;margin-bottom:1rem;text-align:left;\">
                                <strong>Placeholder:</strong> ${safe(s.content || '')}
                                <span style=\"color:#666;\">(${placeholderType}${defaultValue ? ', default: ' + defaultValue : ''})</span>
                            </div>
                        `);
                    }
                    case 'input': {
                        const label = safe(s.label || s.title || s.content || '');
                        const ph = safe(s.placeholder || '');
                        return wrap(`${label ? `<div style=\"font-weight:600;margin-bottom:4px;\">${label}</div>` : ''}<div style=\"min-height:28px;border:1px dashed #cbd5e1;background:#f8fafc;padding:6px 8px;color:#64748b;font-style:italic;\">${ph || '[input]'}</div>`);
                    }
                    case 'html':
                    case 'richtext': {
                        const stitle = safe(s.title || '');
                        const html = safe(s.content || '').trim();
                        const titleHTML = stitle ? `<h3 style=\"display:inline-block;\">${stitle}</h3>` : '';
                        return wrap(`${titleHTML}${html || '<div style=\"color:#94a3b8;\">[empty]</div>'}`);
                        return wrap(html || '<div style=\"color:#94a3b8;\">[empty]</div>');
                    }
                    case 'image': {
                        const src = safe(s.url || s.src || '');
                        const altText = safe(s.alt || s.title || 'Image');
                        const stitle = safe(s.title || '');
                        const titleHTML = stitle ? `<h3 style=\"display:inline-block;\">${stitle}</h3>` : '';
                        if (!src) return wrap(`${titleHTML}<div style=\"color:#94a3b8;\">[missing image]</div>`);
                        return wrap(`${titleHTML}<img src=\"${src}\" alt=\"${altText}\" style=\"max-width:100%;height:auto;\">`);
                        const alt = safe(s.alt || s.title || 'Image');
                        if (!src) return wrap('<div style=\"color:#94a3b8;\">[missing image]</div>');
                        return wrap(`<img src=\"${src}\" alt=\"${alt}\" style=\"max-width:100%;height:auto;\">`);
                    }
                    case 'stamp': {
                        const stitle = safe(s.title || '');
                        const note = safe(s.content || '');
                        const dataUrl = safe(s.stampImage || s.url || s.src || '');
                        const size = parseInt(s.stampSize || '120', 10);
                        const circular = !!s.stampCircular;
                        const showBorder = ('stampBorder' in s) ? !!s.stampBorder : true;
                        const radius = circular ? '50%' : '0';
                        const border = showBorder ? '2px solid rgba(100,116,139,0.6)' : 'none';
                        const titleHTML = stitle ? `<h3 style=\"display:inline-block;\">${stitle}</h3>` : '';
                        const caption = note ? `<div style=\"margin-top:.35rem;font-size:.85rem;color:#334155;\">${note.replace(/\n/g,'<br>')}</div>` : '';
                        const imgHTML = dataUrl
                            ? `<img src=\"${dataUrl}\" alt=\"Stamp\" style=\"width:${size}px;height:${size}px;object-fit:contain;border-radius:${radius};border:${border};opacity:.92;background:transparent;\">`
                            : `<div style=\"width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;color:#94a3b8;border:${border};border-radius:${radius};\">No Stamp</div>`;
                        return wrap(`${titleHTML}<div style=\"display:inline-flex;align-items:center;justify-content:center;width:${size}px;height:${size}px;\">${imgHTML}</div>${caption}`);
                    }
                    case 'divider':
                    case 'line': {
                        return wrap('<hr style=\"border:none;border-top:1px solid #e2e8f0;\"/>');
                    }
                    case 'table': {
                        const stitle = safe(s.title || '');
                        const headers = (s.headers || '').split('|').map(h => h.trim()).filter(Boolean);
                        if (!headers.length) headers.push('Column 1', 'Column 2');
                        const rows = (s.content || '')
                            .split('\n').map(r => r.trim()).filter(Boolean)
                            .map(r => r.split('|').map(c => c.trim()));
                        const body = rows.length
                            ? rows.map(cells => `<tr>${(cells.length ? cells : new Array(headers.length).fill('')).map(cell => `<td style=\"border:1px solid #ddd;padding:8px;\">${cell || '&nbsp;'}</td>`).join('')}</tr>`).join('')
                            : `<tr>${headers.map(() => `<td style=\"border:1px solid #ddd;padding:8px;\">&nbsp;</td>`).join('')}</tr>`;
                        const titleHTML = stitle ? `<h3 style=\"display:inline-block;\">${stitle}</h3>` : '';
                        return wrap(`${titleHTML}<table style=\"width:100%;border-collapse:collapse;\"><thead><tr>${headers.map(h => `<th style=\"border:1px solid #ddd;padding:8px;background:#f8f9fa;\">${h}</th>`).join('')}</tr></thead><tbody>${body}</tbody></table>`);
                        if (!headers.length) headers.push('Column 1', 'Column 2');
                        return wrap(`<table style=\"width:100%;border-collapse:collapse;\"><thead><tr>${headers.map(h => `<th style=\"border:1px solid #ddd;padding:8px;background:#f8f9fa;\">${h}</th>`).join('')}</tr></thead><tbody><tr>${headers.map(() => `<td style=\"border:1px solid #ddd;padding:8px;\">&nbsp;</td>`).join('')}</tr></tbody></table>`);
                    }
                    case 'list': {
                        const items = safe(s.content || '').split('\n').filter(x => x.trim());
                        const title = safe(s.title || '');
                        return wrap(`
                            ${title ? `<h3 style=\"display:inline-block;\">${title}</h3>` : ''}
                            <ul style=\"display:inline-block;text-align:left;\">${(items.length?items:['[item]']).map(it => `<li>${it}</li>`).join('')}</ul>
                        `);
                    }
                    case 'signature': {
                        const stitle = safe(s.title || '');
                        const note = safe(s.content || '');
                        const cntRaw = parseInt(s.signatureCount || s.count || '2', 10);
                        const n = Math.max(2, Math.min(3, isNaN(cntRaw) ? 2 : cntRaw));
                        const labels = Array.isArray(s.signatureLabels) ? s.signatureLabels : [];
                        const jc = (align === 'right') ? 'flex-end' : (align === 'center' ? 'center' : 'flex-start');
                        const blockWidth = n === 2 ? '48%' : '31%';
                        const titleHTML = stitle ? `<h3 style=\"display:inline-block;\">${stitle}</h3>` : '';
                        let row = `${titleHTML}${note ? `<div style=\"color:#475569;font-size:.9rem;margin-bottom:.25rem;\">${note.replace(/\n/g,'<br>')}</div>` : ''}`;
                        row += `<div style=\"display:flex;gap:1rem;justify-content:${jc};\">`;
                        for (let i = 0; i < n; i++) {
                            const label = safe(labels[i] || `Signature ${i+1}`);
                            let inlineStampHTML = '';
                            try {
                                const inlineStamps = Array.isArray(s.inlineStamps) ? s.inlineStamps : [];
                                const slot = inlineStamps[i];
                                if (slot && slot.enabled && slot.dataUrl) {
                                    const size = parseInt(slot.size || '120', 10) || 120;
                                    inlineStampHTML = `<div style=\"margin-top:.35rem;\"><img src=\"${safe(slot.dataUrl)}\" alt=\"Stamp\" style=\"width:${size}px;height:${size}px;object-fit:contain;opacity:.92;\"></div>`;
                                }
                            } catch (_) { /* noop */ }
                            row += `
                                <div style=\"width:${blockWidth};min-width:160px;text-align:center;\">\n                                    <div style=\"height:56px;border-bottom:1px solid #94a3b8;margin:0 6px;\"></div>\n                                    <div style=\"margin-top:.35rem;font-size:.85rem;color:#334155;\">${label}</div>\n                                    ${inlineStampHTML}\n                                </div>
                            `;
                        }
                        row += `</div>`;
                        return wrap(row);
                    }
                    default: {
                        // Generic fallback: try to show title and content rather than dropping the section
                        const title = safe(s.title || s.label || '');
                        const content = safe(s.content || s.placeholder || '');
                        if (title || content) {
                            const titleHTML = title ? `<h3 style=\"display:inline-block;\">${title}</h3>` : '';
                            const contentHTML = content ? `<p style=\"display:inline-block;margin-bottom:1rem;text-align:left;\">${content.replace(/\n/g, '<br>')}</p>` : '';
                            return wrap(`${titleHTML}${contentHTML}`);
                        }
                        return wrap('<span style=\"color:#94a3b8;\">[empty section]</span>');
                    }
                }
            };

            // Build paginated pages
            const toEl = (html) => {
                const div = document.createElement('div');
                div.innerHTML = html.trim();
                return div.firstElementChild || div;
            };

            // Measure available inner height for a single A4 page (in pixels)
            const pageMeasure = document.createElement('div');
            pageMeasure.style.cssText = 'position:absolute;visibility:hidden;z-index:-1;left:-10000px;top:-10000px;width:210mm;height:297mm;padding:16mm;box-sizing:border-box;background:#fff;';
            const innerMeasure = document.createElement('div');
            innerMeasure.style.cssText = 'height:100%;box-sizing:border-box;';
            pageMeasure.appendChild(innerMeasure);
            document.body.appendChild(pageMeasure);
            const maxInnerHeight = innerMeasure.clientHeight || (pageMeasure.clientHeight - 0);

            // Working measure container where we append blocks to check fit
            const work = document.createElement('div');
            work.style.cssText = 'position:absolute;visibility:hidden;z-index:-1;left:-10000px;top:-10000px;width:210mm;padding:16mm;box-sizing:border-box;background:#fff;';
            const workInner = document.createElement('div');
            workInner.style.cssText = 'box-sizing:border-box;min-height:0;';
            work.appendChild(workInner);
            document.body.appendChild(work);

            const pagesHTML = [];
            let currentChunks = [];
            let isFirstPage = true;

            const flushPage = () => {
                const pageContent = (isFirstPage ? header : '') + currentChunks.join('');
                pagesHTML.push(`<div class=\"a4-page\" style=\"background:#fff;width:210mm;height:297mm;margin:0 auto 8mm;box-shadow:0 2px 8px rgba(0,0,0,.08);\"><div style=\"height:100%;padding:16mm;box-sizing:border-box;\">${pageContent}</div></div>`);
                currentChunks = [];
                isFirstPage = false;
                // Reset measurer for next page (clear content)
                workInner.innerHTML = '';
            };

            // Seed first page with header for measuring
            workInner.innerHTML = header;

            // Collect stamps linked to signatures
            const stampsBySignature = new Map();
            (template.sections || []).forEach((sec, idx) => {
                if (sec.type === 'stamp' && sec.stampSignatureLink) {
                    const sigIdx = parseInt(sec.stampSignatureLink.replace('section_', ''), 10);
                    if (!isNaN(sigIdx)) {
                        if (!stampsBySignature.has(sigIdx)) stampsBySignature.set(sigIdx, []);
                        stampsBySignature.get(sigIdx).push(sec);
                    }
                }
            });

            const sections = (template.sections || []).map((sec, idx) => {
                // Skip stamps linked to signatures; they'll render under the signature
                if (sec.type === 'stamp' && sec.stampSignatureLink) return '';
                let html = sectionHTML(sec);
                // If this is a signature section, append linked stamps
                if (sec.type === 'signature' && stampsBySignature.has(idx)) {
                    const linkedStamps = stampsBySignature.get(idx);
                    linkedStamps.forEach(stampSec => {
                        html += sectionHTML(stampSec);
                    });
                }
                return html;
            }).filter(Boolean);
            for (const html of sections) {
                const el = toEl(html);
                workInner.appendChild(el);
                const fits = workInner.scrollHeight <= maxInnerHeight;
                if (fits) {
                    currentChunks.push(html);
                } else {
                    // Remove the overflowing block and flush current page
                    workInner.removeChild(el);
                    if (currentChunks.length === 0) {
                        // Edge case: single block too large even on empty page ï¿½ allow it to overflow a dedicated page
                        currentChunks.push(html);
                        flushPage();
                    } else {
                        flushPage();
                        // Start new page and try to add the block
                        workInner.innerHTML = '';
                        workInner.appendChild(toEl(isFirstPage ? header : ''));
                        workInner.appendChild(el);
                        const fitsOnNew = workInner.scrollHeight <= maxInnerHeight;
                        if (fitsOnNew) {
                            currentChunks.push(html);
                        } else {
                            // Still too large; put it alone on its own page
                            currentChunks.push(html);
                            flushPage();
                        }
                    }
                }
            }

            if (currentChunks.length) flushPage();

            // Cleanup measurers
            document.body.removeChild(pageMeasure);
            document.body.removeChild(work);

            return pagesHTML.join('');
        }

        // Build a flat data map for placeholder resolution
        function getPlaceholderData() {
            const data = {};
            try {
                // Core form fields
                const ids = [
                    'employeeName', 'employeeId', 'employeeEmail', 'employeePhone',
                    // Note: 'gender' now represents salutation/title (e.g., Mr, Mrs, Ms)
                    'gender','fatherName','motherName','nationality','birthDate','birthCountry','maritalStatus','dependents','address',
                    'emergencyContactName','emergencyContactRelationship','emergencyContactPhone','emergencyContactAddress',
                    'positionTitle','department','reportingManager','workLocation',
                    'contractType', 'employmentType', 'startDate', 'endDate',
                    'salaryAmount', 'grossSalary', 'housingAllowance','accommodationAllowance', 'probationPeriod',
                    // Compensation grade & range
                    'compGrade','minSalary','midSalary','maxSalary','gradeCurrency',
                    'workingHours','workingHoursPerDay','noticePeriod','annualLeave'
                ];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    let val = el.value;
                    if ((id === 'salaryAmount' || id === 'grossSalary' || id === 'probationPeriod' || id === 'workingHours' || id === 'workingHoursPerDay' || id === 'noticePeriod' || id === 'annualLeave') && val !== '') {
                        const num = Number(val);
                        if (!Number.isNaN(num)) val = num;
                    }
                    if ((id === 'minSalary' || id === 'midSalary' || id === 'maxSalary') && val !== '') {
                        const num = Number(val);
                        if (!Number.isNaN(num)) val = num;
                    }
                    if (id === 'dependents' && val !== '') {
                        const num = Number(val);
                        if (!Number.isNaN(num)) val = num;
                    }
                    data[id] = val || '';
                });

                // Derived/common values
                data.companyName = (selectedTemplate && (selectedTemplate.companyName || selectedTemplate.company || selectedTemplate.orgName)) || '';
                data.templateTitle = (selectedTemplate && (selectedTemplate.title || selectedTemplate.name)) || '';
                data.today = new Date();

                // Include selected employee values if available
                if (window.employees && Array.isArray(window.employees)) {
                    const dd = document.getElementById('employeeDropdown');
                    if (dd && dd.value !== '' && !Number.isNaN(Number(dd.value))) {
                        const idx = Number(dd.value);
                        const emp = window.employees[idx];
                        if (emp && typeof emp === 'object') {
                            const empName = emp.candidateName || emp.name || emp.fullName || (emp.firstName && emp.lastName ? `${emp.firstName} ${emp.lastName}` : '');
                            data.employeeName = data.employeeName || empName || '';
                            data.employeeEmail = data.employeeEmail || emp.email || '';
                            data.employeePhone = data.employeePhone || emp.phone || emp.phoneNumber || '';
                            data.employeeId = data.employeeId || emp.employeeId || emp.candidateId || '';
                            // Prefer job title captured from companymanagement modal
                            let titleFromUser = '';
                            if (emp.userJobTitle && String(emp.userJobTitle).trim()) {
                                titleFromUser = String(emp.userJobTitle).trim();
                            } else if (emp.email && window.companyUsersIndex && window.companyUsersIndex.byEmail) {
                                const rec = window.companyUsersIndex.byEmail[(emp.email || '').toLowerCase()];
                                if (rec && rec.jobTitle) titleFromUser = String(rec.jobTitle).trim();
                            }
                            data.positionTitle = data.positionTitle || titleFromUser || emp.position || emp.jobTitle || '';
                            data.department = data.department || emp.department || '';
                            // Prefer reporting manager from company users modal
                            let rmFromUser = '';
                            if (emp.lineManager && String(emp.lineManager).trim()) {
                                rmFromUser = String(emp.lineManager).trim();
                            } else if (emp.email && window.companyUsersIndex && window.companyUsersIndex.byEmail) {
                                const rec = window.companyUsersIndex.byEmail[(emp.email || '').toLowerCase()];
                                if (rec && rec.lineManager) rmFromUser = String(rec.lineManager).trim();
                            }
                            data.reportingManager = data.reportingManager || rmFromUser || emp.reportingManager || emp.manager || '';
                        }
                    }
                }
            } catch (e) {
                console.warn('getPlaceholderData error', e);
            }
            return data;
        }

        function applyPlaceholderFilter(value, filter, allData) {
            try {
                switch ((filter || '').toLowerCase()) {
                    case 'currency': {
                        const num = typeof value === 'number' ? value : Number(value);
                        const code = allData.gradeCurrency || 'USD';
                        if (Number.isFinite(num)) {
                            return new Intl.NumberFormat(undefined, { style: 'currency', currency: code }).format(num);
                        }
                        return value != null ? String(value) : '';
                    }
                    case 'date': {
                        let d;
                        if (value instanceof Date) d = value;
                        else if (typeof value === 'string' && value) d = new Date(value);
                        else if (typeof value === 'number') d = new Date(value);
                        if (d && !isNaN(d.getTime())) {
                            return d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                        }
                        return value != null ? String(value) : '';
                    }
                    case 'upper':
                    case 'uppercase':
                        return (value == null ? '' : String(value)).toUpperCase();
                    case 'lower':
                    case 'lowercase':
                        return (value == null ? '' : String(value)).toLowerCase();
                    case 'title': {
                        const s = (value == null ? '' : String(value));
                        return s.replace(/\w\S*/g, (w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
                    }
                    case 'number': {
                        const num = Number(value);
                        return Number.isFinite(num) ? new Intl.NumberFormat().format(num) : (value != null ? String(value) : '');
                    }
                    default:
                        return value != null ? String(value) : '';
                }
            } catch (e) {
                return value != null ? String(value) : '';
            }
        }

        // Replace {{key}} or {{key|filter}} with values from getPlaceholderData()
        function applyPlaceholdersToHtml(html) {
            if (!html) return html;
            const allData = getPlaceholderData();
            // Build a normalization map so placeholders are case/separator agnostic, e.g., {{grosssalary}} -> grossSalary
            const normalize = (k) => (k == null ? '' : String(k)).toLowerCase().replace(/[_\-\s]/g, '');
            const normalizedKeyMap = {};
            Object.keys(allData).forEach(k => { normalizedKeyMap[normalize(k)] = k; });
            return html.replace(/\{\{\s*([a-zA-Z0-9_.-]+)\s*(?:\|\s*([a-zA-Z0-9_-]+)\s*)?\}\}/g, (_, rawKey, rawFilter) => {
                const key = (rawKey || '').trim();
                const filter = (rawFilter || '').trim();
                let value = '';
                // Support simple dot paths e.g., employee.firstName if present in data map
                if (key in allData) {
                    value = allData[key];
                } else if (key.includes('.')) {
                    const parts = key.split('.');
                    let cur = allData;
                    for (const p of parts) {
                        if (cur && typeof cur === 'object' && p in cur) cur = cur[p]; else { cur = undefined; break; }
                    }
                    value = cur;
                } else {
                    // Try normalized lookup (case/separator insensitive)
                    const nk = normalizedKeyMap[normalize(key)];
                    if (nk && nk in allData) value = allData[nk];
                }
                if (filter) return applyPlaceholderFilter(value, filter, allData);
                return value != null ? String(value) : '';
            });
        }

        function renderSelectedTemplateInForm() {
            const host = document.getElementById('selectedTemplateRender');
            if (!host) return;
            if (!selectedTemplate) {
                host.innerHTML = '<div style="padding:.5rem;color:#64748b;">Select a template to display it here.</div>';
                return;
            }
            // Ensure derived fields like grossSalary are fresh before applying placeholders
            try { if (typeof recomputeGrossSalary === 'function') recomputeGrossSalary(); } catch(_) {}
            const raw = buildA4TemplateHTML(selectedTemplate);
            host.innerHTML = applyPlaceholdersToHtml(raw);
        }

        // Generate complete contract preview with all fields
        function generateCompleteContractPreview() {
            let contentHTML = '<div style="font-family: Arial, sans-serif; line-height: 1.6; width: 100%;">';
            
            // Header with company logo if available
            if (selectedTemplate && selectedTemplate.logo) {
                contentHTML += `
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #2c3e50; padding-bottom: 1rem;">
                        <img src="${selectedTemplate.logo}" alt="Company Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 1rem;">
                        <h1 style="color: #2c3e50; margin: 0;">EMPLOYMENT CONTRACT</h1>
                    </div>
                `;
            } else {
                contentHTML += `
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #2c3e50; padding-bottom: 1rem;">
                        <h1 style="color: #2c3e50; margin: 0;">EMPLOYMENT CONTRACT</h1>
                    </div>
                `;
            }

            // Employee Information Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Employee Information</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Full Name:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeeName">[Employee Name]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Employee ID:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeeId">[Employee ID]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Email Address:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeeEmail">[Email Address]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Phone Number:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeePhone">[Phone Number]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Gender:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-gender">[Gender]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Father Name:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-fatherName">[Father Name]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Mother Name:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-motherName">[Mother Name]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Nationality:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-nationality">[Nationality]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Birth Date:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-birthDate">[Birth Date]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Birth Country:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-birthCountry">[Birth Country]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Marital Status:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-maritalStatus">[Marital Status]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Dependents:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-dependents">[Dependents]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Address:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-address">[Address]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Emergency Contact:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">
                                <div id="preview-emergencyContacts" class="text-muted-small">No emergency contacts</div>
                            </td>
                        </tr>
                    </table>
                </div>
            `;

            // Position Information Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Position Information</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Position Title:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-positionTitle">[Position Title]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Department:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-department">[Department]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Reporting Manager:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-reportingManager">[Reporting Manager]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Work Location:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-workLocation">[Work Location]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Contract Terms Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Contract Terms</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Contract Type:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-contractType">[Contract Type]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Employment Type:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employmentType">[Employment Type]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Start Date:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-startDate">[Start Date]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">End Date:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-endDate">[End Date - if applicable]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Compensation Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Compensation</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Salary Amount:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-salaryAmount">[Salary Amount]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; font-weight:600; background:#f8fafc;">Gross Salary</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-grossSalary">[Gross Salary]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Transportation Allowance:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-housingAllowance">[Transportation Allowance]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Accommodation Allowance:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-accommodationAllowance">[Accommodation Allowance]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Band:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-compGrade">[Band]</td>
                        </tr>
                        <!-- Min/Mid/Max are now selected within the Grade dropdown; keep fields for placeholder/back-compat but hide rows if empty -->
                        <tr>
                            
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Probation Period:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-probationPeriod">[Probation Period]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Work Terms Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Work Terms</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Working Hours:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-workingHours">[Working Hours] hours per week</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Working Hours per Day:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-workingHoursPerDay">[Working Hours per Day] hours per day</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Notice Period:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-noticePeriod">[Notice Period] days</td>
                        </tr>
                    </table>
                </div>
            `;

            // Benefits Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Benefits & Leave</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Annual Leave:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-annualLeave">[Annual Leave] days per year</td>
                        </tr>
                        <tr>
                            
                        </tr>
                    </table>
                </div>
            `;


            // Template-specific sections
            if (selectedTemplate && selectedTemplate.sections) {
                contentHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h2 style="color: #007bff; border-bottom: 1px solid #007bff; padding-bottom: 0.5rem;">Template-Specific Fields</h2>
                        <div id="preview-templateFields">
                `;

                selectedTemplate.sections.forEach((section, index) => {
                    if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                        contentHTML += `
                            <div style="margin-bottom: 1rem; padding: 0.5rem; border-left: 4px solid #007bff; background: #f8f9ff;">
                                <strong>${section.title || section.label || section.content}:</strong>
                                <div id="preview-template_field_${index}" style="margin-top: 0.5rem; font-style: italic; color: #666;">
                                    [${section.placeholder || 'Enter value here'}]
                                </div>
                            </div>
                        `;
                    } else if (section.type === 'table' && section.editable) {
                        contentHTML += `
                            <div style="margin-bottom: 1rem;">
                                <strong>${section.title || 'Table Data'}:</strong>
                                <div id="preview-template_table_${index}" style="margin-top: 0.5rem;">
                                    [Table data will appear here]
                                </div>
                            </div>
                        `;
                    } else if (section.type === 'list' && section.editable) {
                        contentHTML += `
                            <div style="margin-bottom: 1rem;">
                                <strong>${section.title || 'List Items'}:</strong>
                                <div id="preview-template_list_${index}" style="margin-top: 0.5rem;">
                                    [List items will appear here]
                                </div>
                            </div>
                        `;
                    } else if (section.type === 'heading') {
                        contentHTML += `<h3 style="color: #2c3e50; margin: 1rem 0;">${section.title || section.content}</h3>`;
                    } else if (section.type === 'paragraph') {
                        contentHTML += `<p style="margin-bottom: 1rem;">${section.content.replace(/\n/g, '<br>')}</p>`;
                    }
                });

                contentHTML += `
                        </div>
                    </div>
                `;
            }

            // Signature section
            contentHTML += `
                <div style="margin-top: 3rem; border-top: 2px solid #2c3e50; padding-top: 2rem;">
                    <h2 style="color: #2c3e50; margin-bottom: 2rem;">Signatures</h2>
                    <div style="display: flex; justify-content: space-between; margin-top: 3rem;">
                        <div style="width: 45%; text-align: center;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 0.5rem; height: 50px;"></div>
                            <div><strong>Employee Signature</strong></div>
                            <div>Date: _______________</div>
                        </div>
                        <div style="width: 45%; text-align: center;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 0.5rem; height: 50px;"></div>
                            <div><strong>Employer Signature</strong></div>
                            <div>Date: _______________</div>
                        </div>
                    </div>
                </div>
            `;

            contentHTML += '</div>';
            return contentHTML;
        }

        // Setup real-time preview updates
        function setupRealTimePreview() {
            // Debounced refresh function for placeholder-driven content
            let phTimer = null;
            const refreshPlaceholders = () => {
                if (phTimer) clearTimeout(phTimer);
                phTimer = setTimeout(() => {
                    try {
                        if (selectedTemplate) {
                            renderSelectedTemplateInForm();
                            const previewTab = document.getElementById('preview');
                            if (previewTab && previewTab.classList.contains('active')) {
                                displayTemplateContent();
                            }
                        }
                    } catch (e) { console.warn('refreshPlaceholders error', e); }
                }, 120);
            };
            const fieldsToWatch = [
                'employeeName', 'employeeId', 'employeeEmail', 'employeePhone',
                'gender','fatherName','motherName','nationality','birthDate','birthCountry','maritalStatus','dependents','address',
                'emergencyContactName','emergencyContactRelationship','emergencyContactPhone','emergencyContactAddress',
                'positionTitle', 'department', 'reportingManager', 'workLocation',
                'contractType', 'employmentType', 'startDate', 'endDate',
                'salaryAmount', 'grossSalary', 'housingAllowance','accommodationAllowance', 'probationPeriod',
                'compGrade','minSalary','midSalary','maxSalary',
                'workingHours', 'workingHoursPerDay', 'noticePeriod', 'annualLeave'
            ];

            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Update immediately with current value
                    updatePreviewField(fieldId);
                    
                    // Add event listeners for real-time updates
                    field.addEventListener('input', () => { updatePreviewField(fieldId); refreshPlaceholders(); });
                    field.addEventListener('change', () => { updatePreviewField(fieldId); refreshPlaceholders(); });
                }
            });

            // Watch for template fields
            updateTemplateFieldsPreviews();

            // Also watch dynamic template fields for placeholder refresh
            const formContainer = document.getElementById('contractFormData');
            const employeeContainer = document.getElementById('employeeFormData');
            if (formContainer) {
                formContainer.addEventListener('input', (e) => {
                    const t = e.target;
                    if (t && (t.matches('input, textarea, select'))) {
                        refreshPlaceholders();
                    }
                });
                formContainer.addEventListener('change', (e) => {
                    const t = e.target;
                    if (t && (t.matches('input, textarea, select'))) {
                        refreshPlaceholders();
                    }
                });
            }
            if (employeeContainer) {
                employeeContainer.addEventListener('input', (e) => {
                    const t = e.target;
                    if (t && (t.matches('input, textarea, select'))) {
                        refreshPlaceholders();
                    }
                });
                employeeContainer.addEventListener('change', (e) => {
                    const t = e.target;
                    if (t && (t.matches('input, textarea, select'))) {
                        refreshPlaceholders();
                    }
                });
            }
        }

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const lang = getLang();
                const locale = lang === 'fr' ? 'fr-FR' : 'en-US';
                return date.toLocaleDateString(locale, { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            } catch (error) {
                return dateString; // Return original if formatting fails
            }
        }

        // =========================
        // Allowance rule modal + logic
        // =========================
        let _currentAllowanceConfigTarget = null; // 'housing' | 'accommodation'
        let _allowanceAnchorEl = null;
        let _allowanceOutsideHandler = null;
        let _allowanceRepositionHandler = null;

        function positionAllowancePopover(modal, anchorEl) {
            if (!modal || !anchorEl) return;
            // Show invisibly to measure
            modal.style.visibility = 'hidden';
            modal.style.display = 'block';
            const rect = anchorEl.getBoundingClientRect();
            const pad = 8;
            const maxW = Math.min(420, window.innerWidth - 2 * pad);
            modal.style.maxWidth = maxW + 'px';
            const mw = modal.offsetWidth;
            const mh = modal.offsetHeight;
            // Prefer below the anchor; if not enough space, place above
            let top = rect.bottom + pad;
            if (top + mh > window.innerHeight - pad) {
                top = Math.max(pad, rect.top - mh - pad);
            }
            // Align right edge of popover with right edge of anchor where possible
            let left = rect.right - mw;
            left = Math.min(left, window.innerWidth - mw - pad);
            left = Math.max(left, pad);
            // Apply as fixed coords
            modal.style.top = `${Math.round(top)}px`;
            modal.style.left = `${Math.round(left)}px`;
            modal.style.visibility = 'visible';
        }

        function openAllowanceSettings(kind) {
            _currentAllowanceConfigTarget = kind;
            // Try to anchor to the settings button; fallback to the allowance input
            _allowanceAnchorEl = document.getElementById(kind === 'housing' ? 'btnHousingAllowanceSettings' : 'btnAccommodationAllowanceSettings')
                || document.getElementById(kind === 'housing' ? 'housingAllowance' : 'accommodationAllowance')
                || null;
            const modalId = 'allowanceRuleModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'allowance-popover';
                // Popover styling
                Object.assign(modal.style, {
                    position: 'fixed',
                    zIndex: '9999',
                    background: '#fff',
                    border: '1px solid #dee2e6',
                    borderRadius: '8px',
                    boxShadow: '0 12px 28px rgba(0,0,0,0.18)',
                    padding: '0',
                    display: 'block'
                });
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid #e9ecef;">
                            <h2>Allowance Settings</h2>
                            <span class="close" onclick="closeAllowanceSettings()">&times;</span>
                        </div>
                        <div class="modal-body" style="padding:.8rem;">
                            <div class="form-group">
                                <label class="form-label">Mode</label>
                                <select id="allowanceRuleMode" class="form-control">
                                    <option value="percent">Percent of Salary</option>
                                    <option value="fixed">Fixed Amount</option>
                                </select>
                            </div>
                            <div class="form-group" id="percentRow">
                                <label class="form-label">Percent (%)</label>
                                <input type="number" id="allowanceRulePercent" class="form-control" min="0" step="0.01" placeholder="e.g., 10 for 10%">
                            </div>
                            <div class="form-group" id="fixedRow" style="display:none;">
                                <label class="form-label">Fixed Amount</label>
                                <input type="number" id="allowanceRuleFixed" class="form-control" min="0" step="0.01" placeholder="e.g., 500">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cap (optional)</label>
                                <input type="number" id="allowanceRuleCap" class="form-control" min="0" step="0.01" placeholder="Maximum amount">
                            </div>
                        </div>
                        <div class="modal-footer" style="display:flex; gap:.5rem; justify-content:flex-end; padding:.6rem .8rem; border-top:1px solid #e9ecef;">
                            <button class="btn btn-secondary" onclick="closeAllowanceSettings()">Cancel</button>
                            <button class="btn btn-success" onclick="saveAllowanceSettings()">Save</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
                // Wire mode change
                modal.querySelector('#allowanceRuleMode').addEventListener('change', function() {
                    const mode = this.value;
                    modal.querySelector('#percentRow').style.display = mode === 'percent' ? '' : 'none';
                    modal.querySelector('#fixedRow').style.display = mode === 'fixed' ? '' : 'none';
                });
            } else {
                modal.style.display = 'block';
            }

            // Load existing rule
            const ruleInputId = kind === 'housing' ? 'housingAllowanceRule' : 'accommodationAllowanceRule';
            const ruleRaw = document.getElementById(ruleInputId)?.value || '';
            let rule = null;
            try { rule = ruleRaw ? JSON.parse(ruleRaw) : null; } catch(_) { rule = null; }
            const modeEl = modal.querySelector('#allowanceRuleMode');
            const percentEl = modal.querySelector('#allowanceRulePercent');
            const fixedEl = modal.querySelector('#allowanceRuleFixed');
            const capEl = modal.querySelector('#allowanceRuleCap');
            if (rule && rule.mode) {
                modeEl.value = rule.mode;
                percentEl.value = rule.percent ?? '';
                fixedEl.value = rule.fixed ?? '';
                capEl.value = rule.cap ?? '';
            } else {
                modeEl.value = 'percent';
                percentEl.value = '';
                fixedEl.value = '';
                capEl.value = '';
            }
            // Ensure correct rows visibility
            modeEl.dispatchEvent(new Event('change'));

            // Position next to field/button
            if (_allowanceAnchorEl) {
                positionAllowancePopover(modal, _allowanceAnchorEl);
                // Reposition on scroll/resize
                if (_allowanceRepositionHandler) {
                    window.removeEventListener('resize', _allowanceRepositionHandler);
                    window.removeEventListener('scroll', _allowanceRepositionHandler, true);
                }
                _allowanceRepositionHandler = () => positionAllowancePopover(modal, _allowanceAnchorEl);
                window.addEventListener('resize', _allowanceRepositionHandler);
                window.addEventListener('scroll', _allowanceRepositionHandler, true);
            }

            // Outside click to close
            if (_allowanceOutsideHandler) document.removeEventListener('mousedown', _allowanceOutsideHandler);
            _allowanceOutsideHandler = (e) => {
                if (!modal.contains(e.target) && e.target !== _allowanceAnchorEl) {
                    closeAllowanceSettings();
                }
            };
            document.addEventListener('mousedown', _allowanceOutsideHandler);
        }

        function closeAllowanceSettings() {
            const modal = document.getElementById('allowanceRuleModal');
            if (modal) modal.style.display = 'none';
            _currentAllowanceConfigTarget = null;
            _allowanceAnchorEl = null;
            if (_allowanceOutsideHandler) {
                document.removeEventListener('mousedown', _allowanceOutsideHandler);
                _allowanceOutsideHandler = null;
            }
            if (_allowanceRepositionHandler) {
                window.removeEventListener('resize', _allowanceRepositionHandler);
                window.removeEventListener('scroll', _allowanceRepositionHandler, true);
                _allowanceRepositionHandler = null;
            }
        }

        function saveAllowanceSettings() {
            const modal = document.getElementById('allowanceRuleModal');
            if (!modal || !_currentAllowanceConfigTarget) return;
            const mode = modal.querySelector('#allowanceRuleMode').value;
            const percent = parseFloat(modal.querySelector('#allowanceRulePercent').value || '');
            const fixed = parseFloat(modal.querySelector('#allowanceRuleFixed').value || '');
            const cap = parseFloat(modal.querySelector('#allowanceRuleCap').value || '');
            const rule = {
                mode,
                percent: Number.isFinite(percent) ? percent : undefined,
                fixed: Number.isFinite(fixed) ? fixed : undefined,
                cap: Number.isFinite(cap) ? cap : undefined
            };
            const ruleInputId = _currentAllowanceConfigTarget === 'housing' ? 'housingAllowanceRule' : 'accommodationAllowanceRule';
            const ruleInput = document.getElementById(ruleInputId);
            if (ruleInput) ruleInput.value = JSON.stringify(rule);
            applyAllowanceRule(_currentAllowanceConfigTarget);
            closeAllowanceSettings();
        }

        function applyAllowanceRule(kind) {
            const salary = parseFloat(document.getElementById('salaryAmount')?.value || '0') || 0;
            const ruleInputId = kind === 'housing' ? 'housingAllowanceRule' : 'accommodationAllowanceRule';
            const outInputId = kind === 'housing' ? 'housingAllowance' : 'accommodationAllowance';
            const ruleRaw = document.getElementById(ruleInputId)?.value || '';
            let val = '';
            if (ruleRaw) {
                try {
                    const rule = JSON.parse(ruleRaw);
                    if (rule && rule.mode === 'percent' && typeof rule.percent === 'number') {
                        val = (salary * (rule.percent / 100));
                    } else if (rule && rule.mode === 'fixed' && typeof rule.fixed === 'number') {
                        val = rule.fixed;
                    }
                    if (typeof rule.cap === 'number' && Number.isFinite(rule.cap)) {
                        val = Math.min(val, rule.cap);
                    }
                } catch(_) {}
            }
            if (val !== '') {
                const n = Math.round((val + Number.EPSILON) * 100) / 100;
                const el = document.getElementById(outInputId);
                if (el) {
                    el.value = n;
                    if (typeof updatePreviewField === 'function') updatePreviewField(outInputId);
                }
            }
        }

        // Recompute allowances whenever salary changes
        document.addEventListener('DOMContentLoaded', function() {
            const sal = document.getElementById('salaryAmount');
            if (sal) {
                const recompute = () => {
                    applyAllowanceRule('housing');
                    applyAllowanceRule('accommodation');
                    recomputeGrossSalary();
                };
                sal.addEventListener('input', recompute);
                sal.addEventListener('change', recompute);
            }
            // Also recompute gross when allowances change manually
            const ha = document.getElementById('housingAllowance');
            const aa = document.getElementById('accommodationAllowance');
            [ha, aa].forEach(el => {
                if (!el) return;
                el.addEventListener('input', () => recomputeGrossSalary());
                el.addEventListener('change', () => recomputeGrossSalary());
            });

            // Initialize Emergency Contacts UI
            try {
                const addBtn = document.getElementById('addEmergencyContactBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', function(){ addEmergencyContactRow({}); });
                }
                const container = document.getElementById('emergencyContactsContainer');
                if (container && !container.children.length) {
                    renderEmergencyContactsUI([]);
                }
            } catch(e) { console.warn('Emergency contacts init failed', e); }
        });

        // Update individual preview field
        function updatePreviewField(fieldId) {
            const field = document.getElementById(fieldId);
            const previewElement = document.getElementById(`preview-${fieldId}`);
            
            if (field && previewElement) {
                let value = field.value || `[${field.placeholder || fieldId}]`;
                
                // Format specific fields
                if (fieldId === 'compGrade') {
                    try { value = field.options[field.selectedIndex]?.text || ''; } catch(_){ }
                }
                if (fieldId === 'salaryAmount' && field.value) {
                    // Determine display currency: prefer gradeCurrency, else selected currency
                    const currency = (document.getElementById('gradeCurrency')?.value) || 'USD';
                    value = `${currency} ${parseFloat(field.value).toLocaleString()}`;
                    // Keep the badge in sync while typing
                    const badge = document.getElementById('salaryCurrencyBadge');
                    if (badge) badge.textContent = currency;
                    // Recompute allowances if rules are defined (guarded)
                    if (typeof applyAllowanceRule === 'function') {
                        try { applyAllowanceRule('housing'); } catch(_) {}
                        try { applyAllowanceRule('accommodation'); } catch(_) {}
                    }
                }
                if ((fieldId === 'minSalary' || fieldId === 'midSalary' || fieldId === 'maxSalary') && field.value) {
                    const currency = (document.getElementById('gradeCurrency')?.value) || 'USD';
                    value = `${currency} ${parseFloat(field.value).toLocaleString()}`;
                }
                if ((fieldId === 'housingAllowance' || fieldId === 'accommodationAllowance') && field.value) {
                    const currency = (document.getElementById('gradeCurrency')?.value) || 'USD';
                    value = `${currency} ${parseFloat(field.value).toLocaleString()}`;
                    // Gross salary depends on these
                    recomputeGrossSalary();
                }
                if (fieldId === 'grossSalary' && field.value !== '') {
                    const currency = (document.getElementById('gradeCurrency')?.value) || 'USD';
                    value = `${currency} ${parseFloat(field.value).toLocaleString()}`;
                    const badge = document.getElementById('grossSalaryCurrencyBadge');
                    if (badge) badge.textContent = currency;
                }
                if (fieldId === 'startDate' || fieldId === 'endDate') {
                    if (field.value) {
                        value = formatDate(field.value);
                    }
                }
                if (fieldId === 'birthDate' && field.value) {
                    value = formatDate(field.value);
                }
                if (fieldId === 'probationPeriod' && field.value) {
                    value = `${field.value} months`;
                }
                if (fieldId === 'workingHours' && field.value) {
                    value = `${field.value} hours per week`;
                }
                if (fieldId === 'workingHoursPerDay' && field.value) {
                    value = `${field.value} hours per day`;
                }
                // Ensure maritalStatus uses the option label, not raw value
                if (fieldId === 'maritalStatus') {
                    try { value = field.options[field.selectedIndex]?.text || value; } catch(_) {}
                }
                // Ensure nationality uses the option label to reflect localization and gender agreement
                if (fieldId === 'nationality') {
                    try { value = field.options[field.selectedIndex]?.text || value; } catch(_) {}
                }
                // Ensure birthCountry uses the option label to reflect localization
                if (fieldId === 'birthCountry') {
                    try { value = field.options[field.selectedIndex]?.text || value; } catch(_) {}
                }
                if (fieldId === 'noticePeriod' && field.value) {
                    value = `${field.value} days`;
                }
                if (fieldId === 'annualLeave' && field.value) {
                    value = `${field.value} days per year`;
                }
                
                if (fieldId === 'dependents' && field.value) {
                    value = `${field.value}`;
                }
                
                previewElement.innerHTML = value;
            }
        }

        // Emergency Contacts: UI + collection + preview
        function buildRelationshipOptions(selected) {
            const opts = [
                {v:'', t: (window.i18n&&i18n['option.selectRelationship'])||'Select Relationship'},
                {v:'Spouse', t:(window.i18n&&i18n['option.rel.spouse'])||'Spouse'},
                {v:'Parent', t:(window.i18n&&i18n['option.rel.parent'])||'Parent'},
                {v:'Father', t:(window.i18n&&i18n['option.rel.father'])||'Father'},
                {v:'Mother', t:(window.i18n&&i18n['option.rel.mother'])||'Mother'},
                {v:'Sibling', t:(window.i18n&&i18n['option.rel.sibling'])||'Sibling'},
                {v:'Brother', t:(window.i18n&&i18n['option.rel.brother'])||'Brother'},
                {v:'Sister', t:(window.i18n&&i18n['option.rel.sister'])||'Sister'},
                {v:'Child', t:(window.i18n&&i18n['option.rel.child'])||'Child'},
                {v:'Son', t:(window.i18n&&i18n['option.rel.son'])||'Son'},
                {v:'Daughter', t:(window.i18n&&i18n['option.rel.daughter'])||'Daughter'},
                {v:'Relative', t:(window.i18n&&i18n['option.rel.relative'])||'Relative'},
                {v:'Friend', t:(window.i18n&&i18n['option.rel.friend'])||'Friend'},
                {v:'Guardian', t:(window.i18n&&i18n['option.rel.guardian'])||'Guardian'},
                {v:'Colleague', t:(window.i18n&&i18n['option.rel.colleague'])||'Colleague'},
                {v:'Other', t:(window.i18n&&i18n['option.other'])||'Other'}
            ];
            return opts.map(o=>`<option value="${o.v}" ${String(selected||'')===o.v?'selected':''}>${o.t}</option>`).join('');
        }

        function addEmergencyContactRow(data) {
            const container = document.getElementById('emergencyContactsContainer');
            if (!container) return;
            const d = data || {};
            const row = document.createElement('div');
            row.className = 'form-row four-cols contact-row';
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label" data-i18n="label.fullName">${(window.i18n&&i18n['label.fullName'])||'Full Name'}</label>
                    <input type="text" class="form-control contact-name" value="${(d.name||d.fullName||'').toString().replace(/"/g,'&quot;')}">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="label.relationship">${(window.i18n&&i18n['label.relationship'])||'Relationship'}</label>
                    <select class="form-control contact-relationship">${buildRelationshipOptions(d.relationship)}</select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="label.contact">${(window.i18n&&i18n['label.contact'])||'Contact'}</label>
                    <input type="tel" class="form-control contact-phone" value="${(d.phone||d.contact||'').toString().replace(/"/g,'&quot;')}">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="label.email">${(window.i18n&&i18n['label.email'])||'Email'}</label>
                    <input type="email" class="form-control contact-email" value="${(d.email||'').toString().replace(/"/g,'&quot;')}">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="label.address">${(window.i18n&&i18n['label.address'])||'Address'}</label>
                    <input type="text" class="form-control contact-address" value="${(d.address||'').toString().replace(/"/g,'&quot;')}">
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;">
                    <button type="button" class="btn btn-outline-danger remove-contact-btn" title="${(window.i18n&&i18n['button.remove'])||'Remove'}"><i class="fas fa-times"></i></button>
                </div>
            `;
            // Bind change events to refresh preview
            row.querySelectorAll('input,select').forEach(el => {
                el.addEventListener('input', updateEmergencyContactsPreview);
                el.addEventListener('change', updateEmergencyContactsPreview);
            });
            // Remove handler
            row.querySelector('.remove-contact-btn').addEventListener('click', function(){
                row.remove();
                updateEmergencyContactsPreview();
            });
            container.appendChild(row);
            updateEmergencyContactsPreview();
        }

        function renderEmergencyContactsUI(contacts) {
            const container = document.getElementById('emergencyContactsContainer');
            if (!container) return;
            container.innerHTML = '';
            if (Array.isArray(contacts) && contacts.length) {
                contacts.forEach(c => addEmergencyContactRow(c));
            } else {
                addEmergencyContactRow({});
            }
            updateEmergencyContactsPreview();
        }

        function collectEmergencyContacts() {
            const container = document.getElementById('emergencyContactsContainer');
            const rows = container ? Array.from(container.querySelectorAll('.contact-row')) : [];
            const contacts = rows.map(r => ({
                name: r.querySelector('.contact-name')?.value?.trim() || '',
                relationship: r.querySelector('.contact-relationship')?.value || '',
                phone: r.querySelector('.contact-phone')?.value?.trim() || '',
                email: r.querySelector('.contact-email')?.value?.trim() || '',
                address: r.querySelector('.contact-address')?.value?.trim() || ''
            })).filter(c => (c.name || c.phone || c.email || c.relationship || c.address));
            return contacts;
        }

        function updateEmergencyContactsPreview() {
            const preview = document.getElementById('preview-emergencyContacts');
            if (!preview) return;
            const contacts = collectEmergencyContacts();
            if (!contacts.length) {
                preview.textContent = 'No emergency contacts';
                return;
            }
            const html = contacts.map(c => {
                const safe = (s)=> (s||'').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const line1 = `<strong>${safe(c.name)}</strong>${c.relationship?` <span class="text-muted-small">(${safe(c.relationship)})</span>`:''}`;
                const line2 = [c.phone, c.email].filter(Boolean).map(safe).join(' ï¿½ ');
                const line3 = c.address ? safe(c.address) : '';
                return `<div style="margin-bottom:6px;">${line1}${line2?`<div>${line2}</div>`:''}${line3?`<div>${line3}</div>`:''}</div>`;
            }).join('');
            preview.innerHTML = html;
        }

        // Compute Gross Salary = Salary Amount + Transportation + Accommodation
        function recomputeGrossSalary() {
            const salary = parseFloat(document.getElementById('salaryAmount')?.value || '0') || 0;
            const transport = parseFloat(document.getElementById('housingAllowance')?.value || '0') || 0;
            const accommodation = parseFloat(document.getElementById('accommodationAllowance')?.value || '0') || 0;
            const total = Math.round(((salary + transport + accommodation) + Number.EPSILON) * 100) / 100;
            const grossEl = document.getElementById('grossSalary');
            if (grossEl) {
                grossEl.value = total;
                updatePreviewField('grossSalary');
            }
            // Ensure currency badge stays in sync with grade currency
            const currency = (document.getElementById('gradeCurrency')?.value) || 'USD';
            const gBadge = document.getElementById('grossSalaryCurrencyBadge');
            if (gBadge) gBadge.textContent = currency;
            return total;
        }

        // Update template fields previews
        function updateTemplateFieldsPreviews() {
            if (!selectedTemplate || !selectedTemplate.sections) return;

            selectedTemplate.sections.forEach((section, index) => {
                if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                    const fieldId = `template_field_${index}`;
                    const previewId = `preview-${fieldId}`;
                    const field = document.getElementById(fieldId);
                    const previewElement = document.getElementById(previewId);
                    
                    if (field && previewElement) {
                        // Update immediately
                        const value = field.value || `[${section.placeholder || section.content || 'Enter value here'}]`;
                        previewElement.innerHTML = value.replace(/\n/g, '<br>');
                        
                        // Add event listener
                        field.addEventListener('input', () => {
                            const newValue = field.value || `[${section.placeholder || section.content || 'Enter value here'}]`;
                            previewElement.innerHTML = newValue.replace(/\n/g, '<br>');
                        });
                    }
                }
            });
        }

        // ===== Compensation Band & Grade wiring =====
        // Salary subitems settings (e.g., Min/Mid/Max or custom)
        let salarySubitemsDefs = [];

        function getDefaultSalarySubitems(){
            return [
                { id: 'minSalary', label: 'Min', key: 'minSalary', enabled: true, order: 1, type: 'number' },
                { id: 'midSalary', label: 'Mid', key: 'midSalary', enabled: true, order: 2, type: 'number' },
                { id: 'maxSalary', label: 'Max', key: 'maxSalary', enabled: true, order: 3, type: 'number' }
            ];
        }

        async function loadSalarySubitemsSettings(){
            try{
                if (!window.firebaseAvailable || !firebase.database) {
                    salarySubitemsDefs = getDefaultSalarySubitems();
                    populateGradeItemsOptions();
                    try { window.salarySubitemsDefs = salarySubitemsDefs; } catch(_) {}
                    return;
                }
                let companyId = (window.currentUser && window.currentUser.companyId) || '';
                if (!companyId) {
                    try { const cc = JSON.parse(localStorage.getItem('currentCompany')||'{}'); companyId = cc.companyId; } catch(_){ }
                }
                const snap = await firebase.database().ref(`companies/${companyId}/salarySettings/subitems`).once('value');
                if(snap.exists()){
                    const obj = snap.val();
                    salarySubitemsDefs = Object.values(obj).sort((a,b)=> (a.order||0)-(b.order||0));
                } else {
                    salarySubitemsDefs = getDefaultSalarySubitems();
                }
            }catch(e){
                console.warn('loadSalarySubitemsSettings failed, using defaults', e);
                salarySubitemsDefs = getDefaultSalarySubitems();
            } finally {
                populateGradeItemsOptions();
                try { window.salarySubitemsDefs = salarySubitemsDefs; } catch(_) {}
            }
        }

        function populateGradeItemsOptions(){
            const sel = document.getElementById('gradeItemSelect');
            if(!sel) return;
            const enabled = (salarySubitemsDefs||[]).filter(s=>s.enabled).sort((a,b)=> (a.order||0)-(b.order||0));
            const prev = sel.value;
            sel.innerHTML = '<option value="">Select Grade Item</option>' + enabled.map(s=>`<option value="${s.key}">${s.label || s.key}</option>`).join('');
            // Try restore previous selection
            if (prev && enabled.some(s=>s.key===prev)) sel.value = prev;
        }

        function getBandValueForItem(gradeObj, itemKey){
            if (!gradeObj || !itemKey) return null;
            if (itemKey === 'minSalary') return gradeObj.minSalary;
            if (itemKey === 'midSalary') return gradeObj.midSalary;
            if (itemKey === 'maxSalary') return gradeObj.maxSalary;
            if (gradeObj.subitems && Object.prototype.hasOwnProperty.call(gradeObj.subitems, itemKey)){
                return gradeObj.subitems[itemKey];
            }
            return null;
        }

        // ===== Compensation Grade wiring =====
    let salaryMappingsByTitle = null; // { [lowerJobTitle]: Array<gradeOption> }
    let currentTitleGradeOptions = [];
    try { window.currentTitleGradeOptions = currentTitleGradeOptions; } catch(_) {}

        // --- Guard helpers to avoid flicker during compensation restoration ---
        function beginCompRestore(durationMs = 6000){
            try { window.compRestoreUntil = Date.now() + Math.max(1000, durationMs); } catch(_) {}
        }
        function endCompRestore(){
            try { window.compRestoreUntil = 0; } catch(_) {}
        }
        function isCompRestoreActive(){
            try { return (window.compRestoreUntil || 0) > Date.now(); } catch(_) { return false; }
        }

        async function loadSalaryMappings() {
            try {
                if (!window.firebaseAvailable || !firebase.database) return;
                let companyId = (window.currentUser && window.currentUser.companyId) || '';
                if (!companyId) {
                    try { const cc = JSON.parse(localStorage.getItem('currentCompany')||'{}'); companyId = cc.companyId; } catch(_){ }
                }
                if (!companyId) return;

                const db = firebase.database();
                const [gradesSnap, bandsSnap] = await Promise.all([
                    db.ref(`companies/${companyId}/salaryGrades`).once('value'),
                    db.ref(`companies/${companyId}/salaryBands`).once('value')
                ]);
                const gradesObj = gradesSnap.val() || {};
                const bandsObj = bandsSnap.val() || {};

                const map = {};
                // Normalize grades by jobTitle
                Object.entries(gradesObj).forEach(([id, g]) => {
                    if (!g || !g.jobTitle) return;
                    const key = String(g.jobTitle).toLowerCase().trim();
                    if (!map[key]) map[key] = [];
                        map[key].push({
                        id,
                        grade: g.grade || g.bandName || 'Not Assigned',
                        currency: g.currency || '',
                        minSalary: (g.minSalary!=null && g.minSalary!=='') ? Number(g.minSalary) : '',
                        midSalary: (g.midSalary!=null && g.midSalary!=='') ? Number(g.midSalary) : '',
                        maxSalary: (g.maxSalary!=null && g.maxSalary!=='') ? Number(g.maxSalary) : '',
                        source: 'salaryGrades'
                    });
                });
                // From bands: add entries for each job title in band
                Object.entries(bandsObj).forEach(([bandId, b]) => {
                    const titles = Array.isArray(b?.jobTitles) ? b.jobTitles : [];
                    titles.forEach(t => {
                        const key = String(t || '').toLowerCase().trim();
                        if (!key) return;
                        if (!map[key]) map[key] = [];
                        map[key].push({
                            id: bandId,
                            grade: b.bandName || 'Band',
                            currency: b.currency || '',
                            minSalary: (b.minSalary!=null && b.minSalary!=='') ? Number(b.minSalary) : '',
                            midSalary: (b.midSalary!=null && b.midSalary!=='') ? Number(b.midSalary) : '',
                            maxSalary: (b.maxSalary!=null && b.maxSalary!=='') ? Number(b.maxSalary) : '',
                            subitems: b.subitems || {},
                            source: 'salaryBands'
                        });
                    });
                });

                salaryMappingsByTitle = map;
                // Expose on window for any code paths that reference the global
                try { window.salaryMappingsByTitle = salaryMappingsByTitle; } catch(_) {}
                // If a position title is already set, try to populate options now (unless restoring)
                const pt = document.getElementById('positionTitle')?.value?.trim();
                if (pt) {
                    if (!isCompRestoreActive()) {
                        populateGradeOptionsForTitle(pt);
                    } else {
                        console.log('??? Skipping auto-populate on mappings load during active restore');
                    }
                }
            } catch (e) {
                console.warn('loadSalaryMappings failed', e);
            }
        }

        function populateGradeOptionsForTitle(jobTitle) {
            try {
                const sel = document.getElementById('compGrade');
                if (!sel) return;
                const titleKey = String(jobTitle || '').toLowerCase().trim();
                const restoring = isCompRestoreActive();
                console.log(`?? populateGradeOptionsForTitle called with: "${jobTitle}", restoring: ${restoring}`);
                
                // Keep previous selection label if any (to try to preserve on refresh)
                const prevSelectedText = sel.options && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex].text : '';
                const prevSelectedValue = sel.value;

                // If job title is empty or mappings not ready, avoid clearing while restoring to prevent flicker
                if (!titleKey || !salaryMappingsByTitle) {
                    console.log(`?? Missing titleKey (${!!titleKey}) or salaryMappingsByTitle (${!!salaryMappingsByTitle}), restoring: ${restoring}`);
                    if (!restoring) {
                        sel.innerHTML = '<option value="">' + (titleKey ? 'Select Band' : 'Enter Job Title First') + '</option>';
                        currentTitleGradeOptions = [];
                        // Reset displays/hidden fields only when not restoring
                        setGradeDisplays(null);
                    }
                    return;
                }
                const list = salaryMappingsByTitle[titleKey] || [];
                // Only display Salary Bands (E1, E2, etc.) related to the selected job
                const bandOnly = list.filter(g => g && g.source === 'salaryBands');
                currentTitleGradeOptions = bandOnly;
                try { window.currentTitleGradeOptions = currentTitleGradeOptions; } catch(_) {}

                // Don't clear the select if we're restoring and already have a temporary option that matches saved data
                const hasTemporaryOption = prevSelectedText && prevSelectedValue === prevSelectedText;
                if (restoring && hasTemporaryOption) {
                    console.log(`??? Preserving temporary option while appending real options: ${prevSelectedText}`);
                    // Append options without clearing, avoiding duplicates by label
                    const existingLabels = new Set(Array.from(sel.options || []).map(o => (o.text || '').toLowerCase()));
                    bandOnly.forEach((g, idx) => {
                        const label = (g.grade || 'Band');
                        if (!existingLabels.has(label.toLowerCase())) {
                            const opt = document.createElement('option');
                            opt.value = JSON.stringify({ type: 'band', index: idx, id: g.id });
                            opt.textContent = label;
                            sel.appendChild(opt);
                        }
                    });
                    // Try to switch from temporary selection to the real structured option
                    let selectedIndexToSet = bandOnly.findIndex(g => (g.grade || '').toLowerCase() === prevSelectedText.toLowerCase());
                    if (selectedIndexToSet >= 0) {
                        const val = JSON.stringify({ type: 'band', index: selectedIndexToSet, id: bandOnly[selectedIndexToSet].id });
                        sel.value = val;
                        sel.dispatchEvent(new Event('change'));
                        // Remove temporary option if present
                        const temp = Array.from(sel.options || []).find(o => o.getAttribute && o.getAttribute('data-temporary') === 'true');
                        if (temp) temp.remove();
                    }
                    return;
                }

                // Normal path: rebuild options
                sel.innerHTML = '<option value="">' + 'Select Band' + '</option>';
                // Reset displays/hidden fields
                setGradeDisplays(null);
                bandOnly.forEach((g, idx) => {
                    const opt = document.createElement('option');
                    opt.value = JSON.stringify({ type: 'band', index: idx, id: g.id });
                    opt.textContent = g.grade || 'Band';
                    sel.appendChild(opt);
                });
                // Autofill logic: if previous selection matches a band name, restore it; else if exactly one band, select it
                let selectedIndexToSet = -1;
                if (prevSelectedText) {
                    selectedIndexToSet = bandOnly.findIndex(g => (g.grade || '').toLowerCase() === prevSelectedText.toLowerCase());
                }
                if (selectedIndexToSet === -1 && bandOnly.length === 1) {
                    selectedIndexToSet = 0;
                }
                if (selectedIndexToSet >= 0) {
                    const val = JSON.stringify({ type: 'band', index: selectedIndexToSet, id: bandOnly[selectedIndexToSet].id });
                    sel.value = val;
                    // Trigger change to apply salary and currency autofill
                    sel.dispatchEvent(new Event('change'));
                }
            } catch (e) {
                console.warn('populateGradeOptionsForTitle failed', e);
            }
        }

        function setGradeDisplays(gradeObj) {
            const minRaw = document.getElementById('minSalary');
            const midRaw = document.getElementById('midSalary');
            const maxRaw = document.getElementById('maxSalary');
            const curRaw = document.getElementById('gradeCurrency');
            const minDisp = document.getElementById('minSalaryDisplay');
            const midDisp = document.getElementById('midSalaryDisplay');
            const maxDisp = document.getElementById('maxSalaryDisplay');
            const gradeSel = document.getElementById('compGrade');

            if (!gradeObj) {
                if (minRaw) minRaw.value = '';
                if (midRaw) midRaw.value = '';
                if (maxRaw) maxRaw.value = '';
                if (curRaw) curRaw.value = '';
                if (minDisp) minDisp.value = '';
                if (midDisp) midDisp.value = '';
                if (maxDisp) maxDisp.value = '';
                if (gradeSel) updatePreviewField('compGrade');
                ['minSalary','midSalary','maxSalary'].forEach(updatePreviewField);
                return;
            }
            if (minRaw) minRaw.value = gradeObj.minSalary ?? '';
            if (midRaw) midRaw.value = gradeObj.midSalary ?? '';
            if (maxRaw) maxRaw.value = gradeObj.maxSalary ?? '';
            if (curRaw) curRaw.value = gradeObj.currency || '';

            const currency = gradeObj.currency || 'USD';
            if (minDisp) minDisp.value = gradeObj.minSalary != null && gradeObj.minSalary !== '' ? `${currency} ${Number(gradeObj.minSalary).toLocaleString()}` : '';
            if (midDisp) midDisp.value = gradeObj.midSalary != null && gradeObj.midSalary !== '' ? `${currency} ${Number(gradeObj.midSalary).toLocaleString()}` : '';
            if (maxDisp) maxDisp.value = gradeObj.maxSalary != null && gradeObj.maxSalary !== '' ? `${currency} ${Number(gradeObj.maxSalary).toLocaleString()}` : '';

            // Update preview fields
            updatePreviewField('compGrade');
            updatePreviewField('minSalary');
            updatePreviewField('midSalary');
            updatePreviewField('maxSalary');
            // Update salary currency badge if we have a grade currency
            try {
                const badge = document.getElementById('salaryCurrencyBadge');
                if (badge) {
                    const cur = gradeObj.currency || 'USD';
                    badge.textContent = cur;
                }
                const gBadge = document.getElementById('grossSalaryCurrencyBadge');
                if (gBadge) {
                    const cur = gradeObj.currency || 'USD';
                    gBadge.textContent = cur;
                }
                const bBadge = document.getElementById('basicSalaryCurrencyBadge');
                if (bBadge) {
                    const cur = gradeObj.currency || 'USD';
                    bBadge.textContent = cur;
                }
            } catch(_){}

            // If grade has currency, sync currency dropdown for consistency
            try {
                // No currency dropdown anymore ï¿½ badge already updated above
            } catch(_){}
        }

        function setupGradeWiring() {
            const titleEl = document.getElementById('positionTitle');
            const gradeEl = document.getElementById('compGrade');
            if (titleEl) {
                let tmr = null;
                const refresh = () => {
                    if (tmr) clearTimeout(tmr);
                    tmr = setTimeout(() => {
                        populateGradeOptionsForTitle(titleEl.value);
                    }, 200);
                };
                titleEl.addEventListener('input', () => { if (isCompRestoreActive()) return; refresh(); });
                titleEl.addEventListener('change', () => { if (isCompRestoreActive()) return; refresh(); });
            }
            if (gradeEl) {
                gradeEl.addEventListener('change', () => {
                    let parsed = null;
                    try { parsed = gradeEl.value ? JSON.parse(gradeEl.value) : null; } catch(_) { parsed = null; }
                    const gradeObj = parsed && Number.isInteger(parsed.index) ? currentTitleGradeOptions[parsed.index] : null;
                    setGradeDisplays(gradeObj);
                    // Repopulate Grade items for the selected band, showing only subitems that have values
                    try {
                        populateGradeItemsForBand(gradeObj);
                    } catch(_) {}
                    // Do NOT set Salary Amount here; it should be set only when Grade is selected
                    // Always sync currency to the grade/band currency if available
                    try {
                        const curSel = document.getElementById('currency');
                        if (curSel && gradeObj && gradeObj.currency) {
                            curSel.value = gradeObj.currency;
                            // also store to hidden gradeCurrency
                            const curRaw = document.getElementById('gradeCurrency');
                            if (curRaw) curRaw.value = gradeObj.currency;
                            updatePreviewField('currency');
                            // Refresh salary range previews with new currency
                            ['minSalary','midSalary','maxSalary'].forEach(updatePreviewField);
                            // Sync gross salary currency badge
                            const gBadge = document.getElementById('grossSalaryCurrencyBadge');
                            if (gBadge) gBadge.textContent = gradeObj.currency;
                            const bBadge = document.getElementById('basicSalaryCurrencyBadge');
                            if (bBadge) bBadge.textContent = gradeObj.currency;
                            recomputeGrossSalary();
                        }
                    } catch(_) { }
                    // Ensure compensation controls remain visible after dynamic updates
                    try { ensureCompFieldsVisible(); } catch(_) {}
                });
            }
        }

        // Defensive: keep Salary Amount and Grade controls visible even if other flows toggle sections
        function ensureCompFieldsVisible() {
            try {
                const ids = ['salaryAmount','compGrade','gradeItemSelect'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    // Unhide the control
                    el.style.display = '';
                    el.style.visibility = 'visible';
                    // Unhide its immediate container groups
                    const grp = el.closest('.form-group');
                    if (grp) {
                        grp.style.display = '';
                        grp.style.visibility = 'visible';
                        // Also unhide the label within the form-group
                        const lbl = grp.querySelector('label');
                        if (lbl) {
                            lbl.style.display = '';
                            lbl.style.visibility = 'visible';
                        }
                    }
                    const sec = el.closest('.form-section');
                    if (sec) {
                        sec.style.display = '';
                        sec.style.visibility = 'visible';
                    }
                });
                // Also ensure the contract form wrapper isn't inadvertently hidden by inline styles
                const contractForm = document.getElementById('contractForm');
                if (contractForm && contractForm.classList.contains('active')) {
                    contractForm.style.display = 'block';
                }
            } catch(_) {}
        }

        // Attach a lightweight observer to re-assert visibility after DOM mutations within the contract form
        function keepCompFieldsVisibleInit() {
            try {
                if (window._compFieldsObserverInstalled) return;
                const target = document.getElementById('contractForm');
                if (!target) return;
                const obs = new MutationObserver(() => {
                    try { ensureCompFieldsVisible(); } catch(_) {}
                });
                obs.observe(target, { childList: true, subtree: true, attributes: true, attributeFilter: ['style','class'] });
                window._compFieldsObserverInstalled = true;
                // Initial passes
                ensureCompFieldsVisible();
                setTimeout(() => { try { ensureCompFieldsVisible(); } catch(_) {} }, 0);
            } catch(_) {}
        }

        // Repopulate the Grade items dropdown with only subitems that exist on the selected band
        function populateGradeItemsForBand(gradeObj) {
            const sel = document.getElementById('gradeItemSelect');
            if (!sel) return;
            // Get enabled subitems from settings in ordered form
            const defs = (window.salarySubitemsDefs || salarySubitemsDefs || []).filter(d => d && d.enabled).sort((a,b)=> (a.order||0)-(b.order||0));
            const available = [];
            if (gradeObj && defs.length && typeof getBandValueForItem === 'function') {
                defs.forEach(d => {
                    const v = getBandValueForItem(gradeObj, d.key);
                    if (v != null && v !== '') {
                        available.push({ key: d.key, label: d.label || d.key, value: v });
                    }
                });
            }
            // Include currency and amount for clarity in option labels
            const currency = (gradeObj && (gradeObj.currency || document.getElementById('gradeCurrency')?.value)) || 'USD';
            sel.innerHTML = '<option value="">Select Grade Item</option>' + available.map(it => `<option value="${it.key}">${it.label} ï¿½ ${Number(it.value).toLocaleString()} ${currency}</option>`).join('');
            // Ensure no grade is auto-selected; user must pick Grade to set amounts
            sel.value = '';
            // Clear Salary Amount and Basic Salary until a Grade is chosen
            const salInput = document.getElementById('salaryAmount');
            const basicInput = document.getElementById('basicSalary');
            if (salInput) {
                salInput.value = '';
                if (typeof updatePreviewField === 'function') updatePreviewField('salaryAmount');
            }
            if (basicInput) basicInput.value = '';
        }

        // Go back to template selection
        function backToTemplateSelection() {
            // Update progress indicator
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('pending');

            // Show template selection and hide form
            document.getElementById('templateSelection').style.display = 'block';
            document.getElementById('contractForm').style.display = 'none';

            // Scroll to top
            document.getElementById('templateSelection').scrollIntoView({ behavior: 'smooth' });
        }

        // Make all form fields editable
        function makeFormFieldsEditable() {
            console.log('Making form fields editable...');
            
            // Get all form inputs, selects, and textareas across both forms
            const formFields = document.querySelectorAll('#contractFormData input, #contractFormData select, #contractFormData textarea, #employeeFormData input, #employeeFormData select, #employeeFormData textarea');
            
            const lockedIds = new Set(['employeeName','employeeId','employeeEmail','employeePhone','positionTitle','department','reportingManager','salaryAmount','grossSalary','housingAllowance','accommodationAllowance']);
            formFields.forEach(field => {
                // Remove readonly and disabled attributes
                if (!lockedIds.has(field.id)) {
                    field.removeAttribute('readonly');
                }
                field.removeAttribute('disabled');
                
                // Ensure the field is editable
                if (!lockedIds.has(field.id)) {
                    field.readOnly = false;
                }
                field.disabled = false;
                
                // Add focus event to highlight editable fields
                field.addEventListener('focus', function() {
                    this.style.borderColor = '#007bff';
                    this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,0.25)';
                });
                
                // Remove highlight when field loses focus
                field.addEventListener('blur', function() {
                    this.style.borderColor = '#ced4da';
                    this.style.boxShadow = 'none';
                });
            });
            
            console.log(`Made ${formFields.length} form fields editable`);
        }
        function setupFormValidation() {
            const contractForm = document.getElementById('contractFormData');
            const employeeForm = document.getElementById('employeeFormData');
            const inputs = document.querySelectorAll('#contractFormData input[required], #contractFormData select[required], #employeeFormData input[required], #employeeFormData select[required]');

            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateField(this);
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateField(this);
                    }
                });
            });
        }

        // Validate individual field
        function validateField(field) {
            const isValid = field.checkValidity();
            
            if (isValid) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
            }

            return isValid;
        }

        // Validate entire form
        function validateForm() {
            const requiredFields = document.querySelectorAll('#contractFormData input[required], #contractFormData select[required], #employeeFormData input[required], #employeeFormData select[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });

            return isValid;
        }

        // Preview contract
        function previewContract() {
            if (!validateForm()) {
                alert('Please fill in all required fields before previewing the contract.');
                return;
            }

            // Update progress indicator
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.remove('pending');
            document.getElementById('step3').classList.add('active');

            // Collect form data
            const formData = collectFormData();
            
            // Generate preview (this would typically open a modal or new window)
            console.log('Contract preview data:', formData);
            
            // For now, just show an alert
            alert('Contract preview would be displayed here. Implementation can be extended to show a formatted preview.');
        }

        // Create contract (overridden in edit mode to update)
        function createContract() {
            if (!validateForm()) {
                alert('Please fill in all required fields before creating the contract.');
                return;
            }

            if (!selectedTemplate) {
                alert('Please select a template first.');
                return;
            }

            // Collect form data
            const formData = collectFormData();
            console.log('?? Creating contract with form data:', formData);
            console.log('?? Grade data being saved:', {
                compGrade: formData.compGrade,
                compGradeSelection: formData.compGradeSelection,
                compGradeItemKey: formData.compGradeItemKey,
                compGradeItemLabel: formData.compGradeItemLabel
            });
            const contractData = {
                ...formData,
                template: {
                    id: selectedTemplate.id || selectedTemplate.name,
                    name: selectedTemplate.name,
                    type: selectedTemplate.category
                },
                status: 'draft',
                createdAt: new Date().toISOString(),
                createdBy: currentUser ? {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: currentUser.displayName
                } : null,
                version: 1,
                formVersion: '1.0'
            };

            console.log('Creating contract:', contractData);

            // Save to Firebase with company scoping
            if (database) {
                // Check if user has company context
                if (currentUser && currentUser.companyId) {
                    // Add company ID to contract data
                    contractData.companyId = currentUser.companyId;
                    
                    // Save to company-scoped contracts
                    const contractRef = database.ref(`companies/${currentUser.companyId}/contracts`).push();
                    contractData.contractId = contractRef.key; // Store the generated contract ID
                    
                    contractRef.set(contractData)
                        .then(() => {
                            console.log('? Contract created successfully with company scope:', currentUser.companyId);
                            // Redirect to contracts list with success message
                            const params = new URLSearchParams({
                                created: '1',
                                id: contractData.contractId,
                                cid: currentUser.companyId
                            });
                            window.location.href = `contr.html?${params.toString()}`;
                        })
                        .catch((error) => {
                            console.error('? Error creating company-scoped contract:', error);
                            alert('Error creating contract. Please try again.');
                        });
                } else {
                    // Fallback: Save to global contracts if no company context
                    console.warn('?? No company context available, saving to global contracts');
                    const contractRef = database.ref('contracts').push();
                    contractData.contractId = contractRef.key;
                    contractRef.set(contractData)
                        .then(() => {
                            console.log('?? Contract created in global scope (no company context)');
                            const params = new URLSearchParams({
                                created: '1',
                                id: contractData.contractId
                            });
                            window.location.href = `contr.html?${params.toString()}`;
                        })
                        .catch((error) => {
                            console.error('? Error creating global contract:', error);
                            alert('Error creating contract. Please try again.');
                        });
                }
            } else {
                console.error('? Database not available');
                alert('Database connection not available. Please try again.');
            }
        }

        // Update existing contract (edit mode)
        async function updateContract() {
            if (!validateForm()) {
                alert('Please fill in all required fields before saving changes.');
                return;
            }
            if (!database) { alert('Database connection not available.'); return; }
            if (!editMode || !editContractId) { alert('Edit mode not initialized.'); return; }

            const path = editCompanyId ? `companies/${editCompanyId}/contracts/${editContractId}` : `contracts/${editContractId}`;
            try {
                // Ensure we have the previous snapshot
                if (!loadedContractData) {
                    const snap = await database.ref(path).once('value');
                    loadedContractData = snap.val() || {};
                }
                const prev = loadedContractData || {};
                const formData = collectFormData();
                const nowIso = new Date().toISOString();
                const nextVersion = (typeof prev.version === 'number' ? prev.version + 1 : 2);
                const templateInfo = selectedTemplate ? {
                    id: selectedTemplate.id || selectedTemplate.name,
                    name: selectedTemplate.name,
                    type: selectedTemplate.category
                } : (prev.template || null);

                const updatePayload = {
                    ...formData,
                    template: templateInfo,
                    status: prev.status || 'draft',
                    updatedAt: nowIso,
                    updatedBy: currentUser ? { uid: currentUser.uid, email: currentUser.email, displayName: currentUser.displayName } : null,
                    version: nextVersion
                };

                await database.ref(path).update(updatePayload);
                // Redirect back to list with updated banner
                const params = new URLSearchParams({ updated: '1', id: editContractId });
                if (editCompanyId) params.set('cid', editCompanyId);
                window.location.href = `contr.html?${params.toString()}`;
            } catch (err) {
                console.error('Error updating contract:', err);
                alert('Error saving changes. Please try again.');
            }
        }

        // Initialize edit mode if query params specify an edit
    function initializeEditIfNeeded(attempt = 0) {
            try {
                const url = new URL(window.location.href);
                const isEdit = url.searchParams.get('edit');
                const id = url.searchParams.get('id');
                const cid = url.searchParams.get('cid');
        const desiredTab = url.searchParams.get('tab');
                if (isEdit !== '1' || !id) return; // not in edit mode

                // Ensure database is ready
                if (!database) {
                    if (attempt < 20) return setTimeout(() => initializeEditIfNeeded(attempt + 1), 300);
                    console.warn('Database not ready; skipping edit init');
                    return;
                }
                // Mark edit mode and capture identifiers
                editMode = true;
                editContractId = id;
                editCompanyId = cid || (currentUser && currentUser.companyId) || null;
                window.__editDesiredTab = (desiredTab && ['templateSelection','employeeDetails','contractForm'].includes(desiredTab)) ? desiredTab : 'contractForm';

                // Override the create action to update instead
                try { window.createContract = updateContract; } catch(_) {}

                // Update UI labels
                try {
                    document.title = 'Edit Employee Contract - Dreamex Datalab';
                    const titleSpan = document.querySelector('[data-i18n="page.title"]');
                    if (titleSpan) titleSpan.textContent = 'Edit Employee Contract';
                    const finalBtnLabel = document.querySelector('[data-i18n="btn.createContract"]');
                    if (finalBtnLabel) finalBtnLabel.textContent = 'Save Changes';
                } catch(_) {}

                // Load existing contract data and prefill
                loadContractForEdit();
            } catch (e) {
                console.warn('initializeEditIfNeeded error:', e);
            }
        }

        async function loadContractForEdit() {
            const path = editCompanyId ? `companies/${editCompanyId}/contracts/${editContractId}` : `contracts/${editContractId}`;
            try {
                console.log(`?? Loading contract from path: ${path}`);
                const snap = await database.ref(path).once('value');
                const data = snap.val();
                console.log('?? Loaded contract data:', data);
                if (!data) { alert('Contract not found.'); return; }
                loadedContractData = data;
                // Try to select the original template if available and templates are loaded
                if (data.template && (data.template.id || data.template.name)) {
                    const selId = data.template.id || data.template.name;
                    console.log(`?? Attempting to select template: ${selId}`);
                    // If templates already loaded, select; else wait briefly and retry a few times
                    const trySelect = (n=0) => {
                        const t = templates && templates.find(t => (t.id || t.name) === selId);
                        if (t) {
                            selectedTemplate = t;
                            console.log('? Template selected, loading form fields');
                            try { selectTemplate(selId); } catch(_) {}
                            // Ensure form is rendered for selected template
                            try { loadTemplateFieldsIntoForm(); makeFormFieldsEditable(); renderSelectedTemplateInForm(); } catch(_) {}
                        } else if (n < 20) {
                            setTimeout(() => trySelect(n+1), 300);
                        }
                    };
                    trySelect();
                }
                // Prefill common fields - delay slightly to ensure form elements are ready
                console.log('? Delaying form fill to ensure elements are ready...');
                setTimeout(() => {
                    fillFormFromContractData(data);
                }, 500);
                // Jump to requested tab for editing (default employeeDetails)
                try { switchTab(window.__editDesiredTab || 'employeeDetails'); } catch(_) {}
            } catch (err) {
                console.error('Failed to load contract for edit:', err);
            }
        }

                    fillFormFromContractData(data);
        function normalizeSalutation(val) {
            if (val == null) return '';
            const s = String(val).trim().toLowerCase();
            // Common gender/abbr/title inputs mapped to our salutation options
            if (['m', 'male', 'mr', 'sir', 'monsieur'].includes(s)) return 'Sir';
            if (['f', 'female', 'mrs', 'ms', 'madam', 'madame'].includes(s)) return 'Madam';
            if (['miss', 'mademoiselle'].includes(s)) return 'Miss';
            if (['dr', 'doctor', 'docteur'].includes(s)) return 'Doctor';
            if (['prof', 'professor', 'professeur'].includes(s)) return 'Professor';
            if (['eng', 'engineer', 'ingenieur', 'ingï¿½nieur'].includes(s)) return 'Engineer';
            // If already one of our options or empty, pass through
            const passthrough = ['sir','madam','miss','doctor','professor','engineer'];
            if (passthrough.includes(s)) return val;
            return '';
        }

        function normalizeEmploymentType(val){
            if (val == null) return '';
            let s = String(val).trim().toLowerCase();
            if (s.includes('full') || s.includes('permanent')) return 'full-time';
            if (s.includes('part')) return 'part-time';
            if (s.includes('consult') || s.includes('contract')) return 'consultant';
            // If one of our canonical values, keep it
            if (['full-time','part-time','consultant'].includes(s)) return s;
            return '';
        }

        function fillFormFromContractData(data) {
            if (!data || typeof data !== 'object') return;
            console.log('?? fillFormFromContractData called with data:', data);
            // Map legacy keys to current element IDs
            const aliasMap = {
                jobTitle: 'positionTitle',
                position: 'positionTitle',
                location: 'workLocation',
                manager: 'reportingManager',
                basicSalary: 'salaryAmount',
                salary: 'salaryAmount',
                salaryAmount: 'salaryAmount',
                salutation: 'gender',
                title: 'gender',
                band: 'compGrade',
                bandName: 'compGrade',
                gradeBand: 'compGrade',
                gradeLabel: 'compGrade',
                grade: 'gradeItemSelect',
                gradeItem: 'gradeItemSelect',
                // Seniority synonyms -> employeeSeniorityDate field
                seniority: 'employeeSeniorityDate',
                seniorityDate: 'employeeSeniorityDate',
                seniority_date: 'employeeSeniorityDate',
                employeeSeniorityDate: 'employeeSeniorityDate'
            };
            const ids = Object.keys(data);
            console.log('?? Processing fields:', ids);
            const missingElements = [];
            const processedFields = [];
            ids.forEach(k => {
                let el = document.getElementById(k);
                if (!el && aliasMap[k]) el = document.getElementById(aliasMap[k]);
                if (!el) {
                    missingElements.push(k);
                    return;
                }
                const v = data[k];
                processedFields.push(`${k}: ${v}`);
                // Skip setting Band/Grade here; handled by compensation restore below
                // But DO set salary amount immediately - don't wait for restoration
                if (el.id === 'compGrade' || el.id === 'gradeItemSelect') {
                    if (el.id === 'gradeItemSelect') {
                        console.log(`?? Skipping gradeItemSelect for now (will be restored later)`);
                    }
                    return;
                }
                // For salary amount, set it directly regardless of input type (handles alias-mapped keys too)
                if (el.id === 'salaryAmount') {
                    const salaryVal = (typeof v === 'number') ? v : (v !== '' && v != null ? Number(v) : 0);
                    if (Number.isFinite(salaryVal)) {
                        el.value = salaryVal;
                        console.log(`?? Set salaryAmount directly to: ${salaryVal}`);
                        try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {}
                        try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
                    } else {
                        // If not a number, clear to 0 to avoid NaN lingering
                        el.value = '';
                    }
                    return;
                }
                if (el.tagName === 'SELECT') {
                    try {
                        let valueToSet = v;
                        if (el.id === 'gender') valueToSet = normalizeSalutation(v || data.salutation || '');
                        if (el.id === 'employmentType') valueToSet = normalizeEmploymentType(v);
                        el.value = valueToSet;
                        // If we just set gender, refresh gender-dependent labels in FR
                        if (el.id === 'gender') {
                            try { updateMaritalLabelsForFrench && updateMaritalLabelsForFrench(); } catch(_){}
                            try { updateNationalityLabelsForFrench && updateNationalityLabelsForFrench(); } catch(_){}
                        }
                    } catch(_) {}
                } else if (el.type === 'checkbox') {
                    el.checked = !!v;
                } else if (el.type === 'radio') {
                    // if radios share same name, set the one matching value
                    const r = document.querySelector(`input[type="radio"][name="${el.name}"][value="${v}"]`);
                    if (r) r.checked = true;
                } else {
                    el.value = (v != null ? v : '');
                    // If this is the position title, trigger grade population
                    if (el.id === 'positionTitle' && v) {
                        setTimeout(() => {
                            try { 
                                console.log(`??? Triggering grade options for position: ${v}`);
                                // Avoid early repopulation if we are in the middle of restoration
                                if (!isCompRestoreActive() && typeof populateGradeOptionsForTitle === 'function') {
                                    populateGradeOptionsForTitle(v);
                                } else {
                                    console.log('??? Skipping early grade options population during active restore');
                                }
                            } catch(e) { console.warn('Position title grade population failed', e); }
                        }, 100);
                    }
                }
                try { updatePreviewField && updatePreviewField(k); } catch(_) {}
            });
            console.log('? Processed fields:', processedFields);
            console.log('? Missing elements for:', missingElements);
            // If seniority wasn't set via top-level aliases, check nested objects (employment/personal)
            try {
                const senEl = document.getElementById('employeeSeniorityDate');
                const alreadySet = processedFields.some(s => s.startsWith('seniority') || s.startsWith('employeeSeniorityDate'));
                if (senEl && !alreadySet) {
                    const nestedSen = (data?.employment?.seniorityDate || data?.employment?.seniority || data?.personal?.seniorityDate || data?.personal?.seniority || '');
                    if (nestedSen) {
                        senEl.value = nestedSen;
                        try { updatePreviewField && updatePreviewField('employeeSeniorityDate'); } catch(_) {}
                    }
                }
            } catch(_) {}
            // Refresh computed fields
            try { applyAllowanceRule && applyAllowanceRule('housing'); } catch(_) {}
            try { applyAllowanceRule && applyAllowanceRule('accommodation'); } catch(_) {}
            try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
            // Update currency badge
            try {
                const badge = document.getElementById('salaryCurrencyBadge');
                if (badge) badge.textContent = (document.getElementById('gradeCurrency')?.value) || 'USD';
            } catch(_) {}

            // Restore emergency contacts (multi) from saved data
            try {
                let contacts = [];
                if (Array.isArray(data.emergencyContacts)) {
                    contacts = data.emergencyContacts;
                } else {
                    // Back-compat: rebuild from legacy fields if present
                    const legacy = {
                        name: data.emergencyContactName || '',
                        relationship: data.emergencyContactRelationship || '',
                        phone: data.emergencyContactPhone || '',
                        address: data.emergencyContactAddress || '',
                        email: data.emergencyContactEmail || ''
                    };
                    if (legacy.name || legacy.phone || legacy.relationship || legacy.address || legacy.email) {
                        contacts = [legacy];
                    }
                }
                if (typeof renderEmergencyContactsUI === 'function') {
                    renderEmergencyContactsUI(contacts);
                }
            } catch(e) { console.warn('restore emergency contacts failed', e); }

            // Load work location options if needed
            try { 
                const locationEl = document.getElementById('workLocation');
                if (locationEl && (data.workLocation || data.location)) {
                    console.log('?? Loading work location options...');
                    loadWorkAreasIntoLocationSelect().then(() => {
                        const locValue = data.workLocation || data.location;
                        if (locValue) {
                            // Ensure the option exists
                            if (!Array.from(locationEl.options).some(opt => opt.value === locValue)) {
                                const newOpt = document.createElement('option');
                                newOpt.value = locValue;
                                newOpt.textContent = locValue;
                                locationEl.appendChild(newOpt);
                            }
                            locationEl.value = locValue;
                            console.log(`? Set work location to: ${locValue}`);
                        }
                    }).catch(console.warn);
                }
            } catch(e) { console.warn('Work location restoration failed', e); }

            // Restore dynamic template fields (textarea/input/table/list) if present in saved contract
            try { restoreDynamicTemplateFieldsFromData(data); } catch(e) { console.warn('restoreDynamicTemplateFieldsFromData failed', e); }

            // Restore Compensation selectors (Band/Grade and Grade Item) based on saved data
            try { 
                // Ensure position title is set first, then restore compensation after a brief delay
                const restoreGradeWithDelay = () => {
                    setTimeout(() => {
                        try { 
                            restoreCompensationSelectorsFromData(data); 
                        } catch(e) { 
                            console.warn('restoreCompensationSelectorsFromData failed', e); 
                        }
                    }, 750); // Give time for position title to populate grade options
                };
                restoreGradeWithDelay();
            } catch(e) { console.warn('compensation restoration setup failed', e); }

            // --- helpers ---
            function restoreDynamicTemplateFieldsFromData(saved){
                const tf = saved?.templateFields || saved?.customFieldsData;
                if (!tf) return;
                // Wait until template is rendered
                let attempts = 0;
                const tryApply = () => {
                    attempts++;
                    const ready = !!(window.selectedTemplate && selectedTemplate.sections && document.querySelectorAll('.dynamic-template-section').length);
                    if (!ready) {
                        if (attempts < 20) return setTimeout(tryApply, 250);
                        return;
                    }
                    Object.entries(tf).forEach(([key, obj]) => {
                        if (!obj) return;
                        // Text/textarea
                        if (key.startsWith('template_field_')){
                            const el = document.getElementById(key);
                            if (el) {
                                el.value = obj.value ?? '';
                                try { updatePreviewField && updatePreviewField(key); } catch(_) {}
                            }
                        }
                        // Table
                        if (key.startsWith('template_table_')){
                            const tbody = document.getElementById(`${key}_tbody`);
                            if (tbody && Array.isArray(obj.value)){
                                // Clear existing rows
                                tbody.innerHTML = '';
                                const headers = (obj.headers ? String(obj.headers).split('|').map(h=>h.trim()) : []);
                                const colCount = headers.length || (Array.isArray(obj.value[0]) ? obj.value[0].length : 2);
                                obj.value.forEach(rowArr => {
                                    const tr = document.createElement('tr');
                                    for (let i=0;i<colCount;i++){
                                        const td = document.createElement('td');
                                        const input = document.createElement('input');
                                        input.type = 'text';
                                        input.className = 'form-control form-control-sm';
                                        input.value = (rowArr && rowArr[i] != null) ? rowArr[i] : '';
                                        td.appendChild(input);
                                        tr.appendChild(td);
                                    }
                                    const tdAct = document.createElement('td');
                                    tdAct.innerHTML = '<button type="button" class="btn btn-sm btn-danger" onclick="removeTableRow(this)">Remove<\/button>';
                                    tr.appendChild(tdAct);
                                    tbody.appendChild(tr);
                                });
                                try { makeFormFieldsEditable && makeFormFieldsEditable(); } catch(_) {}
                            }
                        }
                        // List
                        if (key.startsWith('template_list_')){
                            const container = document.getElementById(`${key}_items`);
                            if (container && Array.isArray(obj.value)){
                                container.innerHTML = '';
                                obj.value.forEach(item => {
                                    const div = document.createElement('div');
                                    div.className = 'input-group mb-2';
                                    div.innerHTML = `
                                        <input type="text" class="form-control" value="${(item ?? '').toString().replace(/"/g,'&quot;')}">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeListItem(this)"><i class="fas fa-times"><\/i><\/button>
                                    `;
                                    container.appendChild(div);
                                });
                                try { makeFormFieldsEditable && makeFormFieldsEditable(); } catch(_) {}
                            }
                        }
                    });
                };
                tryApply();
            }

            function restoreCompensationSelectorsFromData(saved){
                console.log('?? Restoring compensation selectors with data:', saved);
                try { beginCompRestore(6500); } catch(_) {}
                const posTitle = (saved && (saved.positionTitle || saved.jobTitle || saved.position)) || document.getElementById('positionTitle')?.value || '';
                const compSel = saved?.compGradeSelection; // expected { id, index?, type }
                // Accept multiple synonyms for band/grade label keyed fields
                const compLabel = saved?.compGrade || saved?.band || saved?.bandName || saved?.gradeBand || saved?.gradeLabel; // band label
                const salaryAmount = (typeof saved?.salaryAmount === 'number') ? saved.salaryAmount : parseFloat(saved?.salaryAmount) || 0;
                const savedItemKey = saved?.compGradeItemKey || '';
                const savedItemValue = (typeof saved?.compGradeItemValue === 'number') ? saved.compGradeItemValue : parseFloat(saved?.compGradeItemValue) || 0;
                console.log(`?? Position: ${posTitle}, Band: ${compLabel}, Salary: ${salaryAmount}, Item: ${savedItemKey}, ItemValue: ${savedItemValue}`);
                console.log(`?? CompGradeSelection object:`, compSel);

                // IMMEDIATE FALLBACK: If we have salaryAmount but mappings aren't ready, set salary directly
                const gradeEl = document.getElementById('compGrade');
                const itemEl = document.getElementById('gradeItemSelect');
                const salInputDirect = document.getElementById('salaryAmount');
                
                // Check if salary is still missing (value is 0 or empty)
                if (salInputDirect && (!salInputDirect.value || parseFloat(salInputDirect.value) === 0)) {
                    if (salaryAmount > 0) {
                        console.log(`?? IMMEDIATE: Setting salary directly to ${salaryAmount}`);
                        salInputDirect.value = salaryAmount;
                        try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {}
                        try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
                    }
                }
                
                // IMMEDIATE: Try to set compGrade text label if we have it (even if no selection object)
                if (gradeEl && compLabel && (!gradeEl.value || gradeEl.value === '{}')) {
                    console.log(`??? IMMEDIATE: Setting compGrade label to: ${compLabel}`);
                    // Clear any existing options first to avoid duplicates
                    gradeEl.innerHTML = '';
                    // Add the saved grade as a temporary option
                    const opt = new Option(compLabel, compLabel, true, true);
                    gradeEl.add(opt);
                    gradeEl.value = compLabel;
                    try { updatePreviewField && updatePreviewField('compGrade'); } catch(_) {}
                    // Mark this as a temporary option by adding a data attribute
                    opt.setAttribute('data-temporary', 'true');
                }

                // We need salary mappings and subitem defs loaded, and DOM selects available
                let attempts = 0;
                const tryApply = () => {
                    attempts++;
                    console.log(`?? Compensation restore attempt ${attempts}/30`);
                    // Consider both local-scoped and window-exposed mappings
                    const mappingsReady = !!(((typeof salaryMappingsByTitle !== 'undefined' && salaryMappingsByTitle) || window.salaryMappingsByTitle) && typeof populateGradeOptionsForTitle === 'function');
                    const defsReady = !!(window.salarySubitemsDefs && window.salarySubitemsDefs.length);
                    const gradeEl = document.getElementById('compGrade');
                    const itemEl = document.getElementById('gradeItemSelect');
                    console.log(`?? Ready states - mappings: ${mappingsReady}, defs: ${defsReady}, gradeEl: ${!!gradeEl}, itemEl: ${!!itemEl}`);
                    
                    // If mappings still not ready but we've waited long enough, use what we have
                    const shouldGiveUp = attempts > 30;
                    if (shouldGiveUp) {
                        console.log(`?? Compensation restore giving up after ${attempts} attempts, setting fallback values`);
                        // Set salary as final fallback
                        if (salInputDirect && salaryAmount > 0) {
                            salInputDirect.value = salaryAmount;
                            try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {}
                        }
                        // Fallback: inject a temporary option so the grade label is visibly selected
                        if (gradeEl && compLabel) {
                            const want = String(compLabel).trim().toLowerCase();
                            const hasOpt = Array.from(gradeEl.options || []).some(o => String(o.text||'').trim().toLowerCase() === want);
                            if (!hasOpt) {
                                const opt = new Option(compLabel, compLabel, true, true);
                                gradeEl.add(opt);
                            }
                            gradeEl.value = compLabel;
                            try { gradeEl.dispatchEvent(new Event('change')); } catch(_) {}
                            try { updatePreviewField && updatePreviewField('compGrade'); } catch(_) {}
                        }
                        try { endCompRestore(); } catch(_) {}
                        return;
                    }
                    
                    if (!(mappingsReady && gradeEl && itemEl)){
                        if (attempts < 30) return setTimeout(tryApply, 300); // Increased timeout interval
                        return;
                    }
                    // Populate band options for current title
                    console.log(`??? Populating grade options for title: ${posTitle}`);
                    
                    // Check if we already have a temporary option that we need to preserve
                    const currentText = gradeEl.options && gradeEl.selectedIndex >= 0 ? gradeEl.options[gradeEl.selectedIndex].text : '';
                    const hasTemporary = currentText && gradeEl.value === currentText;
                    
                    if (hasTemporary && currentText === compLabel) {
                        console.log(`??? Preserving temporary grade option during mapping: ${compLabel}`);
                        // Don't repopulate yet - wait for next attempt or let the real options load
                        const options = (window.currentTitleGradeOptions || []);
                        if (!options.length) {
                            if (attempts < 25) return setTimeout(tryApply, 250);
                        }
                    } else {
                        try { populateGradeOptionsForTitle(posTitle); } catch(_) {}
                    }
                    const options = (window.currentTitleGradeOptions || []);
                    console.log(`?? Available band options:`, options);
                    if (!options.length){
                        if (attempts < 25) return setTimeout(tryApply, 250);
                        console.log('? No band options available after timeout');
                        return;
                    }
                    // Find band by id first, then by saved index, then by label (case/space-insensitive)
                    let idx = -1, id = null;
                    const norm = (s)=>String(s||'').toLowerCase().replace(/\s|[-_]/g,'');
                    if (compSel && compSel.id){
                        idx = options.findIndex(o => (o && (o.id === compSel.id)));
                        if (idx >= 0) id = options[idx].id;
                        console.log(`?? Found by ID ${compSel.id}: index ${idx}`);
                    }
                    if (idx < 0 && compSel && Number.isInteger(compSel.index) && compSel.index >= 0 && compSel.index < options.length){
                        idx = compSel.index;
                        id = options[idx] && (options[idx].id || options[idx].key || null);
                        console.log(`?? Found by saved index ${compSel.index}: index ${idx}`);
                    }
                    if (idx < 0 && compLabel){
                        const target = norm(compLabel);
                        idx = options.findIndex(o => {
                            const g = norm(o && (o.grade || o.label || o.name || ''));
                            return g === target;
                        });
                        if (idx >= 0) id = options[idx] && (options[idx].id || options[idx].key || null);
                        console.log(`?? Found by label "${compLabel}" (normalized "${target}"): index ${idx}`);
                    }
                    if (idx < 0) {
                        console.log(`? No band match found for compSel=${JSON.stringify(compSel)}, compLabel="${compLabel}"`);
                        console.log(`?? Available options:`, options.map(o => ({grade: o.grade, label: o.label, name: o.name, id: o.id})));
                    }
                    if (idx >= 0){
                        const val = JSON.stringify({ type:'band', index: idx, id: id });
                        gradeEl.value = val;
                        // Trigger change to refresh displays and repopulate grade items
                        gradeEl.dispatchEvent(new Event('change'));
                        // End restore soon after a successful selection to re-enable normal UI updates
                        setTimeout(() => { try { endCompRestore(); } catch(_) {} }, 800);

                        // After grade items are populated, try to select the one matching saved salaryAmount
                        let tries2 = 0;
                        const pickGradeItem = () => {
                            tries2++;
                            // Ensure salary subitem defs and item options are ready
                            const defsReady2 = !!(window.salarySubitemsDefs && window.salarySubitemsDefs.length);
                            const hasItems = itemEl && itemEl.options && itemEl.options.length > 1;
                            if (!(defsReady2 && hasItems)){
                                if (tries2 < 25) return setTimeout(pickGradeItem, 200);
                                // As a fallback, if still not ready, at least set salary directly from saved
                                if (!hasItems && Number.isFinite(salaryAmount) && salaryAmount > 0) {
                                    const salInputFb = document.getElementById('salaryAmount');
                                    const basicInputFb = document.getElementById('basicSalary');
                                    if (salInputFb) { salInputFb.value = Number(salaryAmount); try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {} }
                                    if (basicInputFb) { basicInputFb.value = Number(salaryAmount); }
                                    try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
                                }
                                return;
                            }
                            // Compute candidates from defs and selected grade object
                            let parsed = null;
                            try { parsed = gradeEl.value ? JSON.parse(gradeEl.value) : null; } catch(_) { parsed = null; }
                            const gradeObj = (parsed && Number.isInteger(parsed.index)) ? (window.currentTitleGradeOptions ? window.currentTitleGradeOptions[parsed.index] : null) : null;
                            if (!gradeObj) return;
                            const defs = (window.salarySubitemsDefs || []).filter(d=>d && d.enabled).sort((a,b) => (a.order||0)-(b.order||0));
                            const currency = gradeObj.currency || document.getElementById('gradeCurrency')?.value || 'USD';
                            const tolAbs = 0.5; // absolute numeric tolerance
                            const tolPct = 0.01; // 1% relative tolerance
                            let matchedKey = '';
                            // Prefer exact saved key if present
                            if (savedItemKey) {
                                const exists = defs.some(d=>d.key===savedItemKey);
                                if (exists) matchedKey = savedItemKey;
                            }
                            // Try by saved label if available
                            if (!matchedKey && saved && saved.compGradeItemLabel){
                                const target = norm(saved.compGradeItemLabel);
                                const found = defs.find(d => norm(d.label || d.key) === target);
                                if (found) matchedKey = found.key;
                            }
                            // Fallback: match by salary value if key missing or not found
                            if (!matchedKey) {
                                let bestKey = '';
                                let bestDiff = Number.POSITIVE_INFINITY;
                                defs.forEach(d => {
                                    const val = (typeof getBandValueForItem === 'function') ? getBandValueForItem(gradeObj, d.key) : null;
                                    if (val != null && val !== ''){
                                        const num = Number(val);
                                        if (Number.isFinite(num)){
                                            const diff = Math.abs(num - salaryAmount);
                                            if (diff < bestDiff) { bestDiff = diff; bestKey = d.key; }
                                        }
                                    }
                                });
                                // Accept closest if within tolerance window
                                const accept = Number.isFinite(salaryAmount) && salaryAmount > 0 && (bestDiff <= Math.max(tolAbs, tolPct * Math.abs(salaryAmount)));
                                if (accept) matchedKey = bestKey;
                            }
                            if (matchedKey){
                                itemEl.value = matchedKey;
                                itemEl.dispatchEvent(new Event('change'));
                                // Ensure salary preview/gross updated
                                try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {}
                                try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
                            } else {
                                // Final fallback: directly set salary from saved amount so Salary field isn't left blank
                                if (Number.isFinite(salaryAmount) && salaryAmount > 0){
                                    const salInput = document.getElementById('salaryAmount');
                                    const basicInput = document.getElementById('basicSalary');
                                    if (salInput) { salInput.value = Number(salaryAmount); try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {} }
                                    if (basicInput) { basicInput.value = Number(salaryAmount); }
                                    try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
                                }
                            }
                        };
                        pickGradeItem();
                    }
                };
                tryApply();
                
                // Final safety check after all attempts: ensure salary is set if we have it
                setTimeout(() => {
                    const salInputFinal = document.getElementById('salaryAmount');
                    if (salInputFinal && (!salInputFinal.value || parseFloat(salInputFinal.value) === 0)) {
                        if (salaryAmount > 0) {
                            console.log(`?? FINAL SAFETY: Setting missing salary to ${salaryAmount}`);
                            salInputFinal.value = salaryAmount;
                            try { updatePreviewField && updatePreviewField('salaryAmount'); } catch(_) {}
                            try { recomputeGrossSalary && recomputeGrossSalary(); } catch(_) {}
                        }
                    }
                    // Also verify grade label is set
                    if (gradeEl && compLabel && (!gradeEl.value || gradeEl.value === '{}')) {
                        console.log(`?? FINAL SAFETY: Setting missing grade label to ${compLabel}`);
                        const want = String(compLabel).trim().toLowerCase();
                        const hasOpt = Array.from(gradeEl.options || []).some(o => String(o.text||'').trim().toLowerCase() === want);
                        if (!hasOpt) {
                            const opt = new Option(compLabel, compLabel, true, true);
                            gradeEl.add(opt);
                        }
                        gradeEl.value = compLabel;
                        try { gradeEl.dispatchEvent(new Event('change')); } catch(_) {}
                        try { updatePreviewField && updatePreviewField('compGrade'); } catch(_) {}
                    }
                    try { endCompRestore(); } catch(_) {}
                }, 3000); // Wait 3 seconds then do final check
            }
        }
        function collectFormData() {
            const baseData = {
                // Employee Information
                employeeName: document.getElementById('employeeName').value,
                employeeId: document.getElementById('employeeId').value,
                employeeEmail: document.getElementById('employeeEmail').value,
                employeePhone: document.getElementById('employeePhone').value,
                gender: document.getElementById('gender')?.value || '',
                employeeSeniorityDate: document.getElementById('employeeSeniorityDate')?.value || '',
                fatherName: document.getElementById('fatherName')?.value || '',
                motherName: document.getElementById('motherName')?.value || '',
                nationality: document.getElementById('nationality')?.value || '',
                birthDate: document.getElementById('birthDate')?.value || '',
                birthCountry: document.getElementById('birthCountry')?.value || '',
                maritalStatus: document.getElementById('maritalStatus')?.value || '',
                dependents: parseInt(document.getElementById('dependents')?.value || '0') || 0,
                address: document.getElementById('address')?.value || '',
                
                // Position Information
                positionTitle: document.getElementById('positionTitle').value,
                department: document.getElementById('department').value,
                reportingManager: document.getElementById('reportingManager').value,
                workLocation: document.getElementById('workLocation').value,
                
                // Contract Terms
                contractType: document.getElementById('contractType').value,
                employmentType: document.getElementById('employmentType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                
                // Compensation
                salaryAmount: parseFloat(document.getElementById('salaryAmount').value) || 0,
                grossSalary: (function(){
                    const v = document.getElementById('grossSalary')?.value;
                    if (v === '' || v == null) return 0;
                    const n = parseFloat(v);
                    return Number.isFinite(n) ? n : 0;
                })(),
                housingAllowance: parseFloat(document.getElementById('housingAllowance')?.value || '') || 0,
                accommodationAllowance: parseFloat(document.getElementById('accommodationAllowance')?.value || '') || 0,
                probationPeriod: parseInt(document.getElementById('probationPeriod').value) || 0,
                compGrade: (function(){
                    const gradeEl = document.getElementById('compGrade');
                    if (!gradeEl || gradeEl.selectedIndex < 0) return '';
                    const option = gradeEl.options[gradeEl.selectedIndex];
                    return option ? (option.text || option.value || '') : '';
                })(),
                compGradeSelection: (function(){ 
                    try { 
                        const gradeEl = document.getElementById('compGrade');
                        const val = gradeEl?.value || '';
                        return val ? JSON.parse(val) : null; 
                    } catch(_) { return null; } 
                })(),
                minSalary: parseFloat(document.getElementById('minSalary')?.value || '') || '',
                midSalary: document.getElementById('midSalary')?.value !== '' ? (parseFloat(document.getElementById('midSalary')?.value) || 0) : '',
                maxSalary: parseFloat(document.getElementById('maxSalary')?.value || '') || '',
                gradeCurrency: document.getElementById('gradeCurrency')?.value || '',
                // Persist which Grade item (subitem) was chosen, for reliable restoration
                compGradeItemKey: (function(){
                    const sel = document.getElementById('gradeItemSelect');
                    return sel ? (sel.value || '') : '';
                })(),
                compGradeItemLabel: (function(){
                    try {
                        const key = document.getElementById('gradeItemSelect')?.value || '';
                        if (!key) return '';
                        const defs = (window.salarySubitemsDefs || []).filter(d=>d && d.enabled);
                        const def = defs.find(d=>d.key===key);
                        return def ? (def.label || def.key) : key;
                    } catch(_) { return ''; }
                })(),
                compGradeItemValue: (function(){
                    try {
                        const key = document.getElementById('gradeItemSelect')?.value || '';
                        if (!key) return '';
                        const gradeEl = document.getElementById('compGrade');
                        let parsed = null;
                        try { parsed = gradeEl?.value ? JSON.parse(gradeEl.value) : null; } catch(_) { parsed = null; }
                        const gradeObj = (parsed && Number.isInteger(parsed.index)) ? (window.currentTitleGradeOptions ? window.currentTitleGradeOptions[parsed.index] : null) : null;
                        if (!gradeObj) return '';
                        if (typeof getBandValueForItem === 'function') {
                            const v = getBandValueForItem(gradeObj, key);
                            return (v != null && v !== '') ? Number(v) : '';
                        }
                        return '';
                    } catch(_) { return ''; }
                })(),
                
                // Work Terms
                workingHours: parseInt(document.getElementById('workingHours').value) || 40,
                workingHoursPerDay: parseFloat(document.getElementById('workingHoursPerDay')?.value) || 8,
                noticePeriod: parseInt(document.getElementById('noticePeriod').value) || 30,
                
                // Benefits
                annualLeave: parseInt(document.getElementById('annualLeave').value) || 20
            };

            // Collect emergency contacts (multi)
            try {
                const contacts = (typeof collectEmergencyContacts === 'function') ? collectEmergencyContacts() : [];
                baseData.emergencyContacts = contacts;
                // Back-compat single-contact mirrors
                if (contacts && contacts.length) {
                    const first = contacts[0] || {};
                    baseData.emergencyContactName = first.name || first.fullName || '';
                    baseData.emergencyContactRelationship = first.relationship || '';
                    baseData.emergencyContactPhone = first.phone || '';
                    baseData.emergencyContactAddress = first.address || '';
                } else {
                    baseData.emergencyContactName = '';
                    baseData.emergencyContactRelationship = '';
                    baseData.emergencyContactPhone = '';
                    baseData.emergencyContactAddress = '';
                }
            } catch(_) { /* non-fatal */ }

            // Collect dynamic template fields
            const templateFields = collectTemplateFieldsData();

            // Include allowance rule definitions if present
            const housingRule = document.getElementById('housingAllowanceRule')?.value;
            const accommodationRule = document.getElementById('accommodationAllowanceRule')?.value;
            if (housingRule) baseData.housingAllowanceRule = housingRule;
            if (accommodationRule) baseData.accommodationAllowanceRule = accommodationRule;

            return {
                ...baseData,
                // Back-compat mirror in case downstream readers expect seniorityDate
                seniorityDate: (document.getElementById('employeeSeniorityDate')?.value || ''),
                templateFields: templateFields,
                customFieldsData: templateFields // For compatibility
            };
        }

        // Collect data from dynamic template fields
        function collectTemplateFieldsData() {
            const templateFields = {};
            
            if (!selectedTemplate || !selectedTemplate.sections) {
                return templateFields;
            }

            selectedTemplate.sections.forEach((section, index) => {
                const fieldId = `template_field_${index}`;
                const tableId = `template_table_${index}`;
                const listId = `template_list_${index}`;

                if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        templateFields[fieldId] = {
                            type: section.type,
                            title: section.title || section.label,
                            value: field.value,
                            section: section
                        };
                    }
                } else if (section.type === 'table' && section.editable) {
                    const tableData = collectTableData(tableId);
                    if (tableData) {
                        templateFields[tableId] = {
                            type: 'table',
                            title: section.title || section.label,
                            value: tableData,
                            headers: section.headers,
                            section: section
                        };
                    }
                } else if (section.type === 'list' && section.editable) {
                    const listData = collectListData(listId);
                    if (listData) {
                        templateFields[listId] = {

                            type: 'list',
                            title: section.title || section.label,
                            value: listData,
                            section: section
                        };
                    }
                }
            });

            console.log('Collected template fields data:', templateFields);
            return templateFields;
        }

        // Collect table data
        function collectTableData(tableId) {
            const tbody = document.getElementById(`${tableId}_tbody`);
            if (!tbody) return null;

            const rows = [];
            const tableRows = tbody.querySelectorAll('tr');
            
            tableRows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="text"]');
                const rowData = [];
                inputs.forEach(input => {
                    rowData.push(input.value.trim());
                });
                if (rowData.some(cell => cell !== '')) {
                    rows.push(rowData);
                }
            });

            return rows;
        }

        // Collect list data
        function collectListData(listId) {
            const container = document.getElementById(`${listId}_items`);
            if (!container) return null;

            const items = [];
            const inputs = container.querySelectorAll('input[type="text"]');
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    items.push(input.value.trim());
                }
            });

            return items;
        }

        // Load template fields into the form
        function loadTemplateFieldsIntoForm() {
            if (!selectedTemplate || !selectedTemplate.sections) {
                console.log('No template or sections available to load');
                return;
            }

            console.log('Loading template fields into form...', selectedTemplate);

            // Find the form container where we'll add dynamic fields
            const formContainer = document.getElementById('contractFormData');
            
            // Remove any existing dynamic template fields
            const existingDynamicSections = formContainer.querySelectorAll('.dynamic-template-section');
            existingDynamicSections.forEach(section => section.remove());

            // Process template sections and create form fields
            selectedTemplate.sections.forEach((section, index) => {
                if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                    createDynamicFormField(section, index, formContainer);
                } else if (section.type === 'table' && section.editable) {
                    createDynamicTableField(section, index, formContainer);
                } else if (section.type === 'list' && section.editable) {
                    createDynamicListField(section, index, formContainer);
                }
            });

            // Make sure all new fields are editable
            makeFormFieldsEditable();
            
            console.log('Template fields loaded into form');
        }

        // Create dynamic form field based on template section
        function createDynamicFormField(section, index, formContainer) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-section dynamic-template-section';
            sectionDiv.setAttribute('data-template-section', index);

            let sectionHTML = `
                <h4><i class="fas fa-file-alt"></i> ${section.title || `Template Field ${index + 1}`}</h4>
            `;

            const fieldId = `template_field_${index}`;
            const isRequired = section.required || false;
            const isReadonly = section.readonly || false;

            if (section.type === 'textarea') {
                sectionHTML += `
                    <div class="form-group full-width">
                        <label class="form-label${isRequired ? ' required' : ''}">${section.label || section.title || section.content}</label>
                        <textarea 
                            class="form-control" 
                            id="${fieldId}" 
                            rows="${section.rows || 4}"
                            placeholder="${section.placeholder || section.content || ''}"
                            ${isRequired ? 'required' : ''}
                            ${isReadonly ? 'readonly' : ''}
                        >${section.defaultValue || ''}</textarea>
                        ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                    </div>
                `;
            } else if (section.type === 'placeholder' || section.type === 'input') {
                const inputType = section.inputType || section.placeholderType || 'text';
                sectionHTML += `
                    <div class="form-group${section.fullWidth ? ' full-width' : ''}">
                        <label class="form-label${isRequired ? ' required' : ''}">${section.label || section.title || section.content}</label>
                        <input 
                            type="${inputType === 'number' ? 'number' : inputType === 'date' ? 'date' : inputType === 'email' ? 'email' : 'text'}" 
                            class="form-control" 
                            id="${fieldId}"
                            placeholder="${section.placeholder || section.content || ''}"
                            value="${section.defaultValue || ''}"
                            ${isRequired ? 'required' : ''}
                            ${isReadonly ? 'readonly' : ''}
                            ${inputType === 'number' && section.min ? `min="${section.min}"` : ''}
                            ${inputType === 'number' && section.max ? `max="${section.max}"` : ''}
                        >
                        ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                    </div>
                `;
            }

            sectionDiv.innerHTML = sectionHTML;
            formContainer.appendChild(sectionDiv);
        }

        // Create dynamic table field
        function createDynamicTableField(section, index, formContainer) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-section dynamic-template-section';
            sectionDiv.setAttribute('data-template-section', index);

            const fieldId = `template_table_${index}`;
            const headers = section.headers ? section.headers.split('|').map(h => h.trim()) : ['Column 1', 'Column 2'];

            let sectionHTML = `
                <h4><i class="fas fa-table"></i> ${section.title || `Template Table ${index + 1}`}</h4>
                <div class="form-group full-width">
                    <label class="form-label">${section.label || section.title || 'Table Data'}</label>
                    <div class="table-editor" id="${fieldId}">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    ${headers.map(header => `<th>${header}</th>`).join('')}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="${fieldId}_tbody">
                                <tr>
                                    ${headers.map(() => '<td><input type="text" class="form-control form-control-sm"></td>').join('')}
                                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeTableRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addTableRow('${fieldId}_tbody', ${headers.length})">Add Row</button>
                    </div>
                    ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                </div>
            `;

            sectionDiv.innerHTML = sectionHTML;
            formContainer.appendChild(sectionDiv);
        }

        // Create dynamic list field
        function createDynamicListField(section, index, formContainer) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-section dynamic-template-section';
            sectionDiv.setAttribute('data-template-section', index);

            const fieldId = `template_list_${index}`;
            const listItems = section.content ? section.content.split('\n').filter(item => item.trim()) : [''];

            let sectionHTML = `
                <h4><i class="fas fa-list"></i> ${section.title || `Template List ${index + 1}`}</h4>
                <div class="form-group full-width">
                    <label class="form-label">${section.label || section.title || 'List Items'}</label>
                    <div class="list-editor" id="${fieldId}">
                        <div id="${fieldId}_items">
            `;

            listItems.forEach((item, itemIndex) => {
                sectionHTML += `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="${item.trim()}" placeholder="List item">
                        <button type="button" class="btn btn-outline-danger" onclick="removeListItem(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });

            sectionHTML += `
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addListItem('${fieldId}_items')">Add Item</button>
                    </div>
                    ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                </div>
            `;

            sectionDiv.innerHTML = sectionHTML;
            formContainer.appendChild(sectionDiv);
        }

        // Helper functions for dynamic table management
        function addTableRow(tbodyId, columnCount) {
            const tbody = document.getElementById(tbodyId);
            const newRow = document.createElement('tr');
            
            let rowHTML = '';
            for (let i = 0; i < columnCount; i++) {
                rowHTML += '<td><input type="text" class="form-control form-control-sm"></td>';
            }
            rowHTML += '<td><button type="button" class="btn btn-sm btn-danger" onclick="removeTableRow(this)">Remove</button></td>';
            
            newRow.innerHTML = rowHTML;
            tbody.appendChild(newRow);
            
            // Make new inputs editable
            makeFormFieldsEditable();
        }

        function removeTableRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentElement;
            
            // Don't remove if it's the last row
            if (tbody.children.length > 1) {
                row.remove();
            } else {
                alert('At least one row must remain in the table.');
            }
        }

        // Helper functions for dynamic list management
        function addListItem(containerId) {
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = 'input-group mb-2';
            newItem.innerHTML = `
                <input type="text" class="form-control" placeholder="List item">
                <button type="button" class="btn btn-outline-danger" onclick="removeListItem(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(newItem);
            
            // Make new input editable
            makeFormFieldsEditable();
        }

        function removeListItem(button) {
            const item = button.closest('.input-group');
            const container = item.parentElement;
            
            // Don't remove if it's the last item
            if (container.children.length > 1) {
                item.remove();
            } else {
                alert('At least one item must remain in the list.');
            }
        }
    </script>

    <script>
    // Initialize salary bands and grade items wiring on load
    document.addEventListener('DOMContentLoaded', function() {
        // Defer slightly to ensure Firebase and DOM are ready
        setTimeout(function() {
            try { if (typeof loadSalarySubitemsSettings === 'function') loadSalarySubitemsSettings(); } catch(e) { console.warn('loadSalarySubitemsSettings init failed', e); }
            try { if (typeof loadSalaryMappings === 'function') loadSalaryMappings(); } catch(e) { console.warn('loadSalaryMappings init failed', e); }
            try { if (typeof setupGradeWiring === 'function') setupGradeWiring(); } catch(e) { console.warn('setupGradeWiring init failed', e); }

            // Wire Grade item selection to override Salary Amount with the selected band's item value
            try {
                var gradeItemSel = document.getElementById('gradeItemSelect');
                if (gradeItemSel) {
                    gradeItemSel.addEventListener('change', function() {
                        var itemKey = gradeItemSel.value;
                        var gradeEl = document.getElementById('compGrade');
                        if (!gradeEl || !itemKey) return;
                        var parsed = null;
                        try { parsed = gradeEl.value ? JSON.parse(gradeEl.value) : null; } catch(_) { parsed = null; }
                        var gradeObj = (parsed && Number.isInteger(parsed.index)) ? (window.currentTitleGradeOptions ? window.currentTitleGradeOptions[parsed.index] : null) : null;
                        if (!gradeObj) return;
                        try {
                            var val = (typeof getBandValueForItem === 'function') ? getBandValueForItem(gradeObj, itemKey) : null;
                            if (val != null && val !== '') {
                                var salInput = document.getElementById('salaryAmount');
                                var basicInput = document.getElementById('basicSalary');
                                if (salInput) {
                                    salInput.value = Number(val);
                                    if (typeof updatePreviewField === 'function') updatePreviewField('salaryAmount');
                                    if (typeof recomputeGrossSalary === 'function') recomputeGrossSalary();
                                }
                                if (basicInput) {
                                    basicInput.value = Number(val);
                                }
                            }
                        } catch(e) {
                            console.warn('gradeItemSelect change handler failed', e);
                        }
                    });
                }
            } catch(e) { console.warn('gradeItemSelect wiring failed', e); }

            // Ensure initial Salary Amount and Basic Salary are empty until Grade is selected (skip in edit mode or if loaded data exists)
            try {
                var salInput0 = document.getElementById('salaryAmount');
                var basic0 = document.getElementById('basicSalary');
                var shouldClear = true;
                try {
                    if (window.editMode) shouldClear = false;
                    if (window.loadedContractData && (loadedContractData.salaryAmount || loadedContractData.compGradeItemKey)) shouldClear = false;
                } catch(_) {}
                if (shouldClear) {
                    if (salInput0) { salInput0.value = ''; if (typeof updatePreviewField === 'function') updatePreviewField('salaryAmount'); }
                    if (basic0) { basic0.value = ''; }
                }
            } catch(e) { }

            // Keep Gross Salary = Salary Amount + Transportation + Accommodation in sync
            try {
                var fieldsToWatch = ['salaryAmount','housingAllowance','accommodationAllowance'];
                fieldsToWatch.forEach(function(id){
                    var el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', function(){ if (typeof recomputeGrossSalary === 'function') recomputeGrossSalary(); });
                        el.addEventListener('change', function(){ if (typeof recomputeGrossSalary === 'function') recomputeGrossSalary(); });
                    }
                });
                // Also observe programmatic value changes (since readonly inputs won't emit input events)
                function observeValue(el, onSet){
                    if (!el) return;
                    try {
                        var proto = Object.getPrototypeOf(el);
                        var desc = Object.getOwnPropertyDescriptor(proto, 'value');
                        if (!desc || !desc.set || !desc.get) return;
                        Object.defineProperty(el, 'value', {
                            configurable: true,
                            enumerable: desc.enumerable,
                            get: function(){ return desc.get.call(this); },
                            set: function(v){
                                desc.set.call(this, v);
                                try { if (typeof onSet === 'function') onSet(v); } catch(_) {}
                            }
                        });
                    } catch(_) {}
                }
                fieldsToWatch.forEach(function(id){
                    var el = document.getElementById(id);
                    observeValue(el, function(){ if (typeof recomputeGrossSalary === 'function') recomputeGrossSalary(); });
                });
            } catch(e) { console.warn('gross salary listeners failed', e); }
        }, 400);
    });
    </script>

<script>
// Initialize edit mode after DOM is ready (with slight delay to ensure Firebase init)
document.addEventListener('DOMContentLoaded', function() {
    try { beginCompRestore(7000); } catch(_) {}
    setTimeout(() => { try { initializeEditIfNeeded(); } catch(_) {} }, 600);
});

// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});
</script>
</body>
</html>

