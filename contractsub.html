<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create Employee Contract - Dreamex Datalab HSE Management System">
    <meta name="keywords" content="employee contract, HR, contract creation, Dreamex Datalab">
    <meta name="author" content="Dreamex Datalab">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Create Employee Contract - Dreamex Datalab</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          onerror="this.onerror=null; console.warn('Font Awesome failed to load - using fallback');">
    <link rel="stylesheet" href="css/styles.css" 
          onerror="this.onerror=null; console.warn('styles.css failed to load - using embedded styles');">
    <link rel="stylesheet" href="css/forms.css" 
          onerror="this.onerror=null; console.warn('forms.css failed to load - using embedded styles');">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <style>
        /* Import jobscreen.html design elements */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --transition-speed: 0.2s;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        /* Contract Creation Page Styles with jobscreen.html design */
        .contract-form-container {
            padding: 2rem 0;
            width: 100%;
            margin: 0;
            max-width: none;
        }

        /* Override content padding for full-width layout */
        .content {
            width: 100%;
            margin: 0;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Page Header with Gradient (matching jobscreen.html) */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.25rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin: 0 2rem 2rem 2rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        /* Tab Layout Styles (matching jobscreen.html) */
        .content-tabs {
            margin: 0 2rem;
            width: calc(100% - 4rem);
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .tab-nav-btn:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        .tab-nav-btn.active {
            color: #ffffff;
            background: #007bff;
        }

        /* Specific tab colors when active */
        #templateSelectionBtn.active {
            color: #ffffff;
            background: #007bff; /* Blue for template selection */
        }

        #contractFormBtn.active {
            color: #ffffff;
            background: #28a745; /* Green for contract form */
        }

        #previewBtn.active {
            color: #ffffff;
            background: #17a2b8; /* Teal for preview */
        }

        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-controls {
            margin-bottom: 1.5rem;
        }

        /* Updated form styling to match jobscreen.html */
        .template-selection {
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
        }

        .contract-form {
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
        }

        .contract-form-header {
            background: white;
            padding: 2rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .contract-form-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .contract-form-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin: 0;
        }

        .template-selection h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .contract-form h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .template-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .template-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }

        .template-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.2);
        }

        .template-card h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .template-card p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .template-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .template-category {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Contract Form */
        .contract-form {
            background: white;
            padding: 2rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .contract-form h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .form-section h4 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-label.required::after {
            content: ' *';
            color: #dc3545;
        }

        .form-control {
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }        .form-control:invalid {
            border-color: #dc3545;
        }

        /* Employee Dropdown Styles */
        .employee-dropdown-container {
            position: relative;
        }

        .loading-employees {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading-spinner-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .form-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .text-muted {
            color: #6c757d !important;
        }

        /* Template Content Display */
        .template-content-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            min-height: 300px;
        }

        .template-content-display h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-placeholder {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #856404;
        }

        /* Action Buttons */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        /* Loading States */
        .loading-templates {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Real-time update notification styles */
        @keyframes slideInFromRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Empty State */
        .empty-templates {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-templates i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .progress-step.active {
            background: #007bff;
            color: white;
        }

        .progress-step.completed {
            background: #28a745;
            color: white;
        }        .progress-step.pending {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Dynamic Template Fields */
        .dynamic-template-section {
            border-left: 4px solid #007bff;
            background: #f8f9ff;
        }

        .dynamic-template-section h4 {
            color: #007bff;
        }

        .table-editor {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            background: white;
        }

        .table-editor .table {
            margin-bottom: 1rem;
        }

        .table-editor .table th {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .table-editor .table td {
            border-color: #dee2e6;
        }

        .list-editor {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            background: white;
        }

        .list-editor .input-group {
            margin-bottom: 0.5rem;
        }

        .list-editor .input-group:last-of-type {
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .contract-form-container {
                padding: 1rem;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }
            
            /* Mobile sidebar adjustments */
            .sidebar {
                position: fixed;
                left: -250px;
                width: 250px;
                height: 100vh;
                z-index: 2000;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            /* Override collapsed state on mobile - use left positioning instead */
            .sidebar.collapsed {
                left: -250px;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .main-content.expanded {
                margin-left: 0; /* No change on mobile */
            }
            
            .top-nav {
                position: relative;
            }
            
            /* Mobile sidebar toggle button */
            .sidebar-toggle-btn {
                font-size: 1.5rem;
                padding: 0.5rem;
            }

            /* Company header responsive styles */
            .company-name-header {
                font-size: 1rem;
                display: none; /* Hide company name on very small screens */
            }

            .header-company-logo, .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }

            .top-nav-left {
                gap: 0.5rem;
            }

            /* Mobile overlay when sidebar is open */
            .sidebar.active::before {
                content: '';
                position: fixed;
                top: 0;
                left: 250px;
                width: calc(100vw - 250px);
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }
        }
        
        /* Show company name on larger screens */
        @media (min-width: 769px) {
            .company-name-header {
                display: inline-block;
            }
        }
        
        /* Desktop menu toggle (hidden by default) */
        .mobile-menu-toggle {
            display: none;
        }
        
        /* Fallback CSS Styles for Standalone Operation */
        /* Basic reset and layout styles in case external CSS fails */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f6fa;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-250px);
        }
        
        .sidebar .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1rem;
        }
        
        .sidebar .menu {
            list-style: none;
        }
        
        .sidebar .menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .sidebar .menu a:hover {
            background: #3498db;
        }
        
        /* Menu dropdown styles - hover based like dashboard.html */
        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }
        
        .menu-dropdown:hover .submenu {
            display: block;
        }
        
        .submenu li {
            margin-bottom: 0;
        }
        
        .submenu a {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 0;
        }
        
        .submenu a:hover {
            background: rgba(52, 152, 219, 0.3);
        }
        
        /* Icon spacing */
        .sidebar .menu a i {
            margin-right: 0.75rem;
            width: 1.2rem;
            text-align: center;
        }
        
        /* Top navigation improvements */
        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .notifications {
            position: relative;
        }
        
        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Show menu items by default until permissions are loaded */
        .menu-loading [data-feature] {
            display: block !important;
        }

        .menu-loading .menu-dropdown {
            display: block !important;
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 1rem;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }
        
        .top-nav {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color, #333);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }
        
        .user-profile {
            position: relative;
        }
        
        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
        }
        
        .profile-dropdown ul {
            list-style: none;
            margin: 0;
            padding: 0.5rem 0;
        }
        
        .profile-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: #333;
            text-decoration: none;
        }
        
        .profile-dropdown a:hover {
            background: #f8f9fa;
        }
        
        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            margin-right: 1rem;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        /* Error handling styles */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }
    </style>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" 
            onerror="console.error('Firebase App failed to load'); window.firebaseLoaded = false;"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" 
            onerror="console.error('Firebase Auth failed to load');"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js" 
            onerror="console.error('Firebase Database failed to load');"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js" 
            onerror="console.error('Firebase Storage failed to load');"></script>
    
    <!-- GitHub Pages Fix Script with error handling -->
    <script src="github-pages-fix.js" 
            onerror="console.warn('GitHub Pages Fix script not found - continuing without it');"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Menu -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                        <li data-feature="emissions_view"><a href="emissions.html">Emissions</a></li>
                        <li data-feature="waste_view"><a href="wasteboard.html">Waste Management</a></li>
                        <li data-feature="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHR4dCB4PSIyMCIgeT0iMjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlU8L3R4dD4KPHN2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- Page Header with Gradient (matching jobscreen.html) -->
                <div class="page-header">
                    <div class="header-top-row">
                        <div class="header-left">
                            <h1 class="page-title">
                                <i class="fas fa-file-signature"></i>
                                Create Employee Contract
                            </h1>
                        </div>
                        <div class="header-right">
                            <!-- Optional: Add any header actions here -->
                        </div>
                    </div>
                    <p class="page-subtitle">Create a new employee contract using pre-defined templates</p>
                </div>

                <!-- Tab-based Navigation (matching jobscreen.html) -->
                <div class="content-tabs">
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" id="templateSelectionBtn" onclick="switchTab('templateSelection')">
                            <i class="fas fa-file-alt"></i>
                            <span>Select Template</span>
                        </button>
                        <button class="tab-nav-btn" id="contractFormBtn" onclick="switchTab('contractForm')">
                            <i class="fas fa-edit"></i>
                            <span>Fill Details</span>
                        </button>
                        <button class="tab-nav-btn" id="previewBtn" onclick="switchTab('preview')">
                            <i class="fas fa-eye"></i>
                            <span>Review & Create</span>
                        </button>
                    </div>

                    <!-- Template Selection Tab -->
                    <div class="tab-content active" id="templateSelection">
                        <div class="template-selection">
                            <h3><i class="fas fa-file-contract"></i> Select Contract Template</h3>
                            <p>Choose a template to use as the basis for your employee contract. Templates are created in the Document Template Creator.</p>
                            
                            <!-- Loading State -->
                            <div class="loading-templates" id="loadingTemplates">
                                <div class="loading-spinner"></div>
                                <h4>Loading Templates...</h4>
                                <p>Fetching available contract templates</p>
                            </div>

                            <!-- Template Grid -->
                            <div class="template-grid" id="templateGrid" style="display: none;">
                                <!-- Templates will be loaded here -->
                            </div>

                            <!-- Empty State -->
                            <div class="empty-templates" id="emptyTemplates" style="display: none;">
                                <i class="fas fa-file-alt"></i>
                                <h4>No Contract Templates Available</h4>
                                <p>Create contract templates in the Document Template Creator to use them here.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-primary" onclick="window.open('dochtml.html', '_blank')">
                                        <i class="fas fa-plus"></i>
                                        Create Templates
                                    </button>
                                </div>
                            </div>

                            <div class="form-actions">
                                <a href="contract.html" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i>
                                    Back to Contracts
                                </a>
                                <button class="btn btn-primary" id="continueToForm" onclick="proceedToForm()" disabled>
                                    <i class="fas fa-arrow-right"></i>
                                    Continue to Form
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Form Tab -->
                    <div class="tab-content" id="contractForm">
                        <div class="contract-form">
                        <h3><i class="fas fa-edit"></i> Contract Details</h3>
                        <p>Fill in the required information to create the employee contract.</p>

                        <form id="contractFormData">                            <!-- Employee Information -->
                            <div class="form-section">
                                <h4><i class="fas fa-user"></i> Employee Information</h4>
                                
                                <!-- Employee Selection Dropdown -->
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label class="form-label">Select from Accepted Offers</label>
                                        <div class="employee-dropdown-container">
                                            <select class="form-control" id="employeeDropdown" onchange="fillEmployeeDetails()">
                                                <option value="">Select an employee from accepted offers...</option>
                                            </select>
                                            <div class="loading-employees" id="loadingEmployees" style="display: none;">
                                                <div class="loading-spinner-small"></div>
                                                <span>Loading employees...</span>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Choose from employees with accepted job offers, or fill in details manually below.</small>
                                    </div>
                                </div>

                                <hr style="margin: 1.5rem 0; border: 1px solid #e9ecef;">

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Employee Name</label>
                                        <input type="text" class="form-control" id="employeeName" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label required">Employee ID</label>
                                        <input type="text" class="form-control" id="employeeId" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Email</label>
                                        <input type="email" class="form-control" id="employeeEmail" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="employeePhone">
                                    </div>
                                </div>
                            </div>

                            <!-- Position Information -->
                            <div class="form-section">
                                <h4><i class="fas fa-briefcase"></i> Position Information</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Position Title</label>
                                        <input type="text" class="form-control" id="positionTitle" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label required">Department</label>
                                        <input type="text" class="form-control" id="department" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Reporting Manager</label>
                                        <input type="text" class="form-control" id="reportingManager" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" id="workLocation">
                                    </div>
                                </div>
                            </div>

                            <!-- Contract Terms -->
                            <div class="form-section">
                                <h4><i class="fas fa-calendar-alt"></i> Contract Terms</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Contract Type</label>
                                        <select class="form-control" id="contractType" required>
                                            <option value="">Select Contract Type</option>
                                            <option value="permanent">Permanent</option>
                                            <option value="temporary">Temporary</option>
                                            <option value="contract">Contract</option>
                                            <option value="probation">Probation</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label required">Employment Type</label>
                                        <select class="form-control" id="employmentType" required>
                                            <option value="">Select Employment Type</option>
                                            <option value="full-time">Full Time</option>
                                            <option value="part-time">Part Time</option>
                                            <option value="consultant">Consultant</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="endDate">
                                    </div>
                                </div>
                            </div>

                            <!-- Compensation -->
                            <div class="form-section">
                                <h4><i class="fas fa-dollar-sign"></i> Compensation</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Salary Amount</label>
                                        <input type="number" class="form-control" id="salaryAmount" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Currency</label>
                                        <select class="form-control" id="currency">
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="NGN">NGN</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Probation Period (months)</label>
                                        <input type="number" class="form-control" id="probationPeriod" min="0" max="12">
                                    </div>
                                </div>
                            </div>

                            <!-- Work Terms -->
                            <div class="form-section">
                                <h4><i class="fas fa-clock"></i> Work Terms</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Working Hours (per week)</label>
                                        <input type="number" class="form-control" id="workingHours" min="1" max="80" value="40">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Notice Period (days)</label>
                                        <input type="number" class="form-control" id="noticePeriod" min="0" value="30">
                                    </div>
                                </div>
                            </div>

                            <!-- Benefits -->
                            <div class="form-section">
                                <h4><i class="fas fa-gift"></i> Benefits & Leave</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Annual Leave (days)</label>
                                        <input type="number" class="form-control" id="annualLeave" min="0" value="20">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Sick Leave (days)</label>
                                        <input type="number" class="form-control" id="sickLeave" min="0" value="10">
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Additional Benefits</label>
                                    <textarea class="form-control" id="additionalBenefits" rows="3" placeholder="List any additional benefits, allowances, or perks..."></textarea>
                                </div>
                            </div>

                            <!-- Additional Terms -->
                            <div class="form-section">
                                <h4><i class="fas fa-file-alt"></i> Additional Terms</h4>
                                <div class="form-group full-width">
                                    <label class="form-label">Special Terms & Conditions</label>
                                    <textarea class="form-control" id="specialTerms" rows="4" placeholder="Enter any special terms, conditions, or clauses specific to this contract..."></textarea>
                                </div>
                            </div>
                        </form>

                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="backToTemplateSelection()">
                                <i class="fas fa-arrow-left"></i>
                                Back to Templates
                            </button>
                            <button class="btn btn-primary" onclick="switchTab('preview')">
                                <i class="fas fa-eye"></i>
                                Preview Contract
                            </button>
                            <button class="btn btn-success" onclick="createContract()">
                                <i class="fas fa-check"></i>
                                Create Contract
                            </button>
                        </div>
                        </div>
                    </div>

                    <!-- Preview Tab -->
                    <div class="tab-content" id="preview">
                        <div class="contract-form">
                            <h3><i class="fas fa-eye"></i> Contract Preview & Review</h3>
                            <p>Review the complete contract before creating it. Make any final adjustments if needed.</p>

                            <!-- Template Content Preview -->
                            <div class="template-content-display" id="templateContentDisplay">
                                <h4><i class="fas fa-file-contract"></i> Complete Contract Preview</h4>
                                <div id="templateContentPreview">
                                    <!-- Template content will be displayed here -->
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-secondary" onclick="switchTab('contractForm')">
                                    <i class="fas fa-arrow-left"></i>
                                    Back to Form
                                </button>
                                <button class="btn btn-success" onclick="createContract()">
                                    <i class="fas fa-check"></i>
                                    Create Contract
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- External scripts removed to prevent unauthorized redirections -->
    <!-- All authentication and configuration handled inline for standalone operation -->
    
    <script>
        // Standalone Page Safety Checks and Error Handling
        console.log('🚀 Initializing Contract Creation Page (Standalone Mode)');
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('💥 Global error caught:', e.error || e.message);
            // Continue execution - don't let errors break the page
            return true;
        });
        
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
            console.error('❌ Firebase is not available - some features may not work');
            window.firebaseAvailable = false;
        } else {
            window.firebaseAvailable = true;
            console.log('✅ Firebase is available');
        }
        
        // Firebase Configuration for Compat SDK
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase with error handling
        let database = null;
        try {
            if (window.firebaseAvailable && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('✅ Firebase initialized successfully');
            } else if (window.firebaseAvailable && firebase.apps.length > 0) {
                database = firebase.database();
                console.log('✅ Using existing Firebase instance');
            }
        } catch (error) {
            console.error('❌ Firebase initialization failed:', error);
            window.firebaseAvailable = false;
        }
        
        // Contract Creation Variables
        let templates = [];
        let selectedTemplate = null;
        let currentUser = null;
        let employees = [];
        
        // Standalone page initialization
        function initializeStandalonePage() {
            console.log('🔧 Initializing standalone page features...');
            
            // Initialize menu loading state
            initializeMenuLoading();
            
            // Set up basic UI interactions
            setupUIInteractions();
            
            // Initialize form validation
            setupFormValidation();
            
            // Make form fields editable
            makeFormFieldsEditable();
            
            console.log('✅ Standalone page initialization complete');
        }
        
        // Initialize menu loading state
        function initializeMenuLoading() {
            // Add menu-loading class to sidebar while permissions are loading
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.add('menu-loading');
            }
        }
        
        // Menu visibility methods
        function resetMenuVisibility() {
            document.querySelectorAll('#roleBasedMenu li').forEach(item => {
                item.style.display = 'block';
            });
        }
        
        function updateMenuWithPermissions(permissions) {
            console.log('🎯 Updating menu with permissions...');
            console.log('🎯 Permissions object:', permissions);
            
            // Reset menu visibility first
            resetMenuVisibility();
            
            if (!permissions) {
                console.log('⚠️ No permissions object provided - showing all menu items');
                // If no permissions available, show all menu items
                document.querySelectorAll('#roleBasedMenu li').forEach(item => {
                    item.style.display = 'block';
                });
                return;
            }
            
            // Handle individual menu items
            const menuItems = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
            console.log(`🎯 Found ${menuItems.length} menu items with permission requirements`);
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const requiredPermission = item.getAttribute('data-requires-permission');
                console.log(`🔍 Checking menu item requirement: ${requiredPermission}`);
                
                if (requiredPermission && permissions[requiredPermission]) {
                    const hasViewPermission = permissions[requiredPermission].view === true || permissions[requiredPermission] === true;
                    
                    if (hasViewPermission) {
                        item.style.display = 'block';
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${requiredPermission}`);
                    } else {
                        item.style.display = 'none';
                        console.log(`❌ No view permission for: ${requiredPermission}`);
                    }
                } else {
                    item.style.display = 'none';
                    console.log(`⚪ Permission not found: ${requiredPermission}`);
                }
            });
            
            // Show items without permission requirements
            const itemsWithoutPermissions = document.querySelectorAll('#roleBasedMenu li:not([data-requires-permission])');
            itemsWithoutPermissions.forEach(item => {
                item.style.display = 'block';
                visibleCount++;
            });
            
            // Handle submenu items within dropdowns
            const submenuItems = document.querySelectorAll('#roleBasedMenu .submenu li[data-requires-permission]');
            submenuItems.forEach(item => {
                const requiredPermission = item.getAttribute('data-requires-permission');
                if (requiredPermission && permissions[requiredPermission]) {
                    const hasViewPermission = permissions[requiredPermission].view === true || permissions[requiredPermission] === true;
                    item.style.display = hasViewPermission ? 'block' : 'none';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show submenu items without permission requirements
            const submenuItemsWithoutPermissions = document.querySelectorAll('#roleBasedMenu .submenu li:not([data-requires-permission])');
            submenuItemsWithoutPermissions.forEach(item => {
                item.style.display = 'block';
            });
            
            // Handle parent dropdowns - show if they have visible children or no permission requirement
            document.querySelectorAll('#roleBasedMenu .menu-dropdown').forEach(dropdown => {
                const requiredPermission = dropdown.getAttribute('data-requires-permission');
                
                if (!requiredPermission) {
                    // No permission requirement for the dropdown itself, check children
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li[style*="block"], .submenu li:not([style*="none"]):not([data-requires-permission])');
                    dropdown.style.display = visibleSubmenuItems.length > 0 ? 'block' : 'none';
                } else {
                    // Dropdown has permission requirement
                    if (permissions[requiredPermission]) {
                        const hasViewPermission = permissions[requiredPermission].view === true || permissions[requiredPermission] === true;
                        dropdown.style.display = hasViewPermission ? 'block' : 'none';
                    } else {
                        dropdown.style.display = 'none';
                    }
                }
            });
            
            console.log(`🎯 Menu update complete. Visible items: ${visibleCount}`);
            
            // Remove loading class from sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
        }
        
        async function updateMenuVisibility() {
            console.log('🔧 Starting menu visibility update...');
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            try {
                if (!window.firebaseAvailable || !currentUser) {
                    console.log('⚠️ Firebase not available or no user - showing default menu');
                    // Show all menu items if no permissions system available
                    document.querySelectorAll('#roleBasedMenu li').forEach(item => {
                        item.style.display = 'block';
                    });
                    return;
                }
                
                // Try to load user permissions from Firebase
                const database = firebase.database();
                const userRef = database.ref(`users/${currentUser.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.role) {
                    // Load role permissions
                    const roleRef = database.ref(`roles/${userData.role}/permissions`);
                    const roleSnapshot = await roleRef.once('value');
                    const permissions = roleSnapshot.val();
                    
                    if (permissions) {
                        updateMenuWithPermissions(permissions);
                    } else {
                        console.log('⚠️ No permissions found for role, showing all menu items');
                        updateMenuWithPermissions(null);
                    }
                } else {
                    console.log('⚠️ No user role found, showing all menu items');
                    updateMenuWithPermissions(null);
                }
            } catch (error) {
                console.error('❌ Error loading menu permissions:', error);
                // On error, show all menu items
                updateMenuWithPermissions(null);
            }
        }
        
        // Basic UI interactions setup
        function setupUIInteractions() {
            // Profile dropdown toggle
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    profileDropdown.style.display = 'none';
                });
            }
            
            // Notification dropdown toggle
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    notificationDropdown.style.display = 'none';
                });
            }
            
            // Setup sidebar toggle
            setupSidebarToggle();
        }
        
        // Setup sidebar toggle functionality
        function setupSidebarToggle() {
            console.log('🔧 Setting up sidebar toggle...');
            
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            console.log('Elements found:', {
                toggle: sidebarToggle ? '✅' : '❌',
                sidebar: sidebar ? '✅' : '❌', 
                mainContent: mainContent ? '✅' : '❌'
            });
            
            if (!sidebarToggle) {
                console.error('❌ Sidebar toggle button not found!');
                return;
            }
            
            if (!sidebar) {
                console.error('❌ Sidebar element not found!');
                return;
            }
            
            if (!mainContent) {
                console.error('❌ Main content element not found!');
                return;
            }
            
            // Simple toggle function
            sidebarToggle.onclick = function() {
                console.log('🖱️ Toggle button clicked!');
                
                if (window.innerWidth <= 768) {
                    // Mobile behavior
                    const isActive = sidebar.classList.contains('active');
                    if (isActive) {
                        sidebar.classList.remove('active');
                        console.log('📱 Mobile sidebar hidden');
                    } else {
                        sidebar.classList.add('active');
                        console.log('📱 Mobile sidebar shown');
                    }
                } else {
                    // Desktop behavior
                    const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
                    
                    if (isCurrentlyCollapsed) {
                        // Show sidebar
                        sidebar.classList.remove('collapsed');
                        mainContent.classList.remove('expanded');
                        localStorage.setItem('sidebarCollapsed', 'false');
                        console.log('🖥️ Desktop sidebar expanded');
                    } else {
                        // Hide sidebar
                        sidebar.classList.add('collapsed');
                        mainContent.classList.add('expanded');
                        localStorage.setItem('sidebarCollapsed', 'true');
                        console.log('🖥️ Desktop sidebar collapsed');
                    }
                }
            };
            
            // Load saved state (desktop only)
            if (window.innerWidth > 768) {
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    console.log('✅ Loaded collapsed state from localStorage');
                }
            }
            
            // Add click outside to close for mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    if (!e.target.closest('.sidebar') && !e.target.closest('#sidebarToggle')) {
                        if (sidebar.classList.contains('active')) {
                            sidebar.classList.remove('active');
                            console.log('📱 Mobile sidebar closed by outside click');
                        }
                    }
                }
            });
            
            console.log('✅ Sidebar toggle setup complete');
        }
        
        // Setup mobile menu behavior and responsive handling
        function setupMobileMenu() {
            console.log('🔧 Setting up mobile menu...');
            
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (!sidebar || !mainContent) {
                console.error('❌ Mobile menu: Required elements not found');
                return;
            }
            
            // Handle window resize to switch between desktop and mobile modes
            window.addEventListener('resize', function() {
                console.log('📱 Window resized, current width:', window.innerWidth);
                
                if (window.innerWidth <= 768) {
                    // Mobile mode - remove desktop classes
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                    console.log('📱 Switched to mobile mode');
                } else {
                    // Desktop mode - restore saved state
                    const savedState = localStorage.getItem('sidebarCollapsed');
                    if (savedState === 'true') {
                        sidebar.classList.add('collapsed');
                        mainContent.classList.add('expanded');
                    }
                    console.log('🖥️ Switched to desktop mode');
                }
            });
            
            console.log('✅ Mobile menu setup complete');
        }
        
        // Load and display company header information
        function loadCompanyHeader() {
            console.log('🏢 Loading company header...');
            
            try {
                // Get company data from localStorage or use default
                const companyData = JSON.parse(localStorage.getItem('currentCompany') || '{}');
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');

                console.log('Header elements found:', {
                    logo: headerLogo ? '✅' : '❌',
                    placeholder: headerLogoPlaceholder ? '✅' : '❌',
                    companyName: headerCompanyName ? '✅' : '❌'
                });

                // Update company name
                if (headerCompanyName) {
                    const companyName = companyData.companyName || 'Dreamex Datalab HSE';
                    headerCompanyName.textContent = companyName;
                    console.log('✅ Company name updated:', companyName);
                }

                // Update logo or show placeholder
                if (companyData.logoUrl || companyData.logo) {
                    const logoUrl = companyData.logoUrl || companyData.logo;
                    console.log('✅ Company logo URL found:', logoUrl);
                    
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log('✅ Company logo displayed');
                    }
                    
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'none';
                        console.log('✅ Logo placeholder hidden');
                    }
                } else {
                    console.log('ℹ️ No company logo URL, showing placeholder');
                    // Show placeholder if no logo
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                        console.log('✅ Logo placeholder shown');
                    }
                    
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        console.log('✅ Company logo hidden');
                    }
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab') && companyData.companyName) {
                    document.title = title.replace('Dreamex Datalab', companyData.companyName);
                    console.log('✅ Page title updated');
                }
            } catch (error) {
                console.error('❌ Error loading company header:', error);
                // Show fallback branding
                showFallbackBranding();
            }
        }

        // Show fallback branding when no company data is available
        function showFallbackBranding() {
            console.log('🏢 Showing fallback branding');
            const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const headerCompanyName = document.getElementById('headerCompanyName');
            const headerLogo = document.getElementById('headerCompanyLogo');
            
            // Show placeholder logo
            if (headerLogoPlaceholder) {
                headerLogoPlaceholder.style.display = 'flex';
                console.log('✅ Fallback logo placeholder shown');
            }
            
            // Hide company logo
            if (headerLogo) {
                headerLogo.style.display = 'none';
                console.log('✅ Company logo hidden (fallback)');
            }
            
            // Set fallback company name
            if (headerCompanyName) {
                headerCompanyName.textContent = 'Dreamex Datalab HSE';
                console.log('✅ Fallback company name set');
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('� Contract Creation Page - DOM Content Loaded');
            console.log('🔗 This page displays templates from Firebase Realtime Database saved by dochtml.html');
            console.log('📍 Template storage path: companies/{companyId}/documentTemplates');
            console.log('🔄 Real-time synchronization: ENABLED');
            console.log('📊 Company-scoped templates: ONLY');
            console.log('');
            console.log('📄 Starting page initialization...');
            
            // Debug: Check if elements exist
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            console.log('Debug - Elements found:', {
                sidebarToggle: !!sidebarToggle,
                sidebar: !!sidebar,
                mainContent: !!mainContent
            });
            
            // Debug: Add direct click test
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    console.log('Direct click test: Sidebar toggle button clicked!');
                });
                console.log('Direct click listener added to toggle button');
            }
            
            // Initialize standalone features first
            initializeStandalonePage();
            
            // Setup sidebar toggle functionality
            setupSidebarToggle();
            
            // Setup mobile menu for responsive behavior
            setupMobileMenu();
            
            // Load company header information
            loadCompanyHeader();
            
            // Then initialize Firebase-dependent features
            if (window.firebaseAvailable) {
                initializeAuth();
                // Templates will be loaded after user company data is available
                // Delay employee loading to allow authentication to complete
                setTimeout(() => {
                    loadEmployees();
                }, 1000);
                updateMenuVisibility();
            } else {
                console.warn('⚠️ Firebase not available - running in limited mode');
                showFirebaseError();
                // Load employees from fallback in standalone mode
                loadEmployees();
                updateMenuVisibility(); // Still update menu visibility in standalone mode
            }
            
            console.log('🎉 Contract creation page loaded successfully');
        });
        
        // Show Firebase error message
        function showFirebaseError() {
            const container = document.querySelector('.contract-form-container');
            if (container) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <strong>⚠️ Limited Functionality</strong><br>
                    Some features may not work properly due to missing dependencies. 
                    The page will continue to function with reduced capabilities.
                `;
                container.insertBefore(errorDiv, container.firstChild);
            }
        }

        // Initialize authentication
        function initializeAuth() {
            try {
                if (!window.firebaseAvailable || !firebase.auth) {
                    console.warn('⚠️ Firebase Auth not available - running without authentication');
                    // Set a default user for standalone mode
                    currentUser = {
                        email: 'standalone@user.local',
                        displayName: 'Standalone User',
                        uid: 'standalone-user-id'
                    };
                    updateUserProfile(currentUser);
                    return;
                }
                
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        currentUser = user;
                        console.log('✅ User authenticated:', user.email);
                        updateUserProfile(user);
                        loadUserCompanyData(user); // Load company data for authenticated user
                        updateMenuVisibility(); // Update menu when user changes
                    } else {
                        console.log('ℹ️ No user authenticated - using guest mode');
                        // Set guest user for standalone operation
                        currentUser = {
                            email: 'guest@user.local',
                            displayName: 'Guest User',
                            uid: 'guest-user-id'
                        };
                        updateUserProfile(currentUser);
                        updateMenuVisibility(); // Update menu for guest user
                        
                        // Load templates for guest user (only global templates)
                        console.log('🔄 Loading global templates for guest user...');
                        loadTemplates();
                    }
                });
            } catch (error) {
                console.error('❌ Error initializing authentication:', error);
                // Fallback to standalone mode
                currentUser = {
                    email: 'fallback@user.local',
                    displayName: 'Fallback User',
                    uid: 'fallback-user-id'
                };
                updateUserProfile(currentUser);
                
                // Load templates for fallback user (only global templates)
                console.log('🔄 Loading global templates for fallback user...');
                loadTemplates();
            }
        }

        // Load user company data and store companyId
        async function loadUserCompanyData(user) {
            try {
                if (!window.firebaseAvailable || !firebase.database || !user) {
                    console.log('⚠️ Firebase not available or no user - skipping company data load');
                    return;
                }

                const database = firebase.database();
                const userRef = database.ref(`users/${user.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();

                if (userData && userData.companyId) {
                    // Update currentUser with companyId
                    currentUser.companyId = userData.companyId;
                    
                    console.log('✅ User company ID loaded:', userData.companyId);
                    
                    // Optionally load full company details
                    const companyRef = database.ref(`companies/${userData.companyId}`);
                    const companySnapshot = await companyRef.once('value');
                    const companyData = companySnapshot.val();
                    
                    if (companyData) {
                        // Store company data in localStorage for other functions
                        localStorage.setItem('currentCompany', JSON.stringify({
                            companyId: userData.companyId,
                            companyName: companyData.companyName,
                            ...companyData
                        }));
                        
                        console.log('✅ Company data loaded:', companyData.companyName);
                    }
                    
                    // Now that company data is loaded, load templates with company scope
                    console.log('🔄 Loading templates with company context...');
                    
                    // Test Firebase Realtime Database connection first
                    testRealtimeDatabaseConnection();
                    
                    // Load templates
                    loadTemplates();
                    
                    // Setup real-time template updates after templates are loaded
                    setTimeout(() => {
                        setupRealTimeTemplateUpdates();
                    }, 1000);
                    
                    // Now that company data is loaded, refresh employees list
                    console.log('🔄 Reloading employees with company context...');
                    loadEmployees();
                } else {
                    console.log('⚠️ No company ID found for user');
                    // Load global templates only since no company context is available
                    console.log('🔄 Loading global templates only (no company context)...');
                    loadTemplates();
                    
                    // Still try to setup real-time updates in case user gets company access later
                    setTimeout(() => {
                        setupRealTimeTemplateUpdates();
                    }, 1000);
                }
            } catch (error) {
                console.error('❌ Error loading user company data:', error);
                // Load global templates on error
                console.log('🔄 Loading global templates only (error fallback)...');
                loadTemplates();
                
                // Still try to setup real-time updates for error recovery
                setTimeout(() => {
                    setupRealTimeTemplateUpdates();
                }, 1000);
            }
        }

        // Update user profile in UI
        function updateUserProfile(user) {
            const userAvatar = document.getElementById('userAvatar');
            
            if (userAvatar) {
                // Try to get custom avatar or use initials
                getUserAvatarUrl(user).then(avatarUrl => {
                    if (avatarUrl) {
                        userAvatar.src = avatarUrl;
                        userAvatar.alt = (user.displayName || user.email) + ' Avatar';
                    } else {
                        // Generate initials avatar
                        generateInitialsAvatar(user.displayName || user.email, userAvatar);
                    }
                }).catch(error => {
                    console.warn('Could not load user avatar, using initials:', error);
                    generateInitialsAvatar(user.displayName || user.email, userAvatar);
                });
            }
        }
        
        // Get user avatar URL or initials
        async function getUserAvatarUrl(user) {
            try {
                if (window.firebaseAvailable && firebase.storage && user && user.uid) {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${user.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } else {
                    // No custom avatar found
                    return null;
                }
            } catch (error) {
                // No custom avatar found or error accessing storage
                return null;
            }
        }
        
        // Generate initials avatar
        function generateInitialsAvatar(name, imgElement) {
            const initials = name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Create SVG avatar with initials
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            const encodedSvg = btoa(svg);
            imgElement.src = `data:image/svg+xml;base64,${encodedSvg}`;
            imgElement.alt = name + ' Avatar';
        }

        // Load employees from Firebase (company-scoped accepted offers)
        async function loadEmployees() {
            console.log('Loading employees from accepted offers...');
            
            // Show loading state
            const loadingElement = document.getElementById('loadingEmployees');
            const dropdown = document.getElementById('employeeDropdown');
            
            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }

            try {
                // Check if Firebase is available and user is authenticated
                if (!window.firebaseAvailable || !firebase.database || !currentUser) {
                    console.warn('⚠️ Firebase not available or no user - loading from fallback URL');
                    await loadEmployeesFromFallback();
                    return;
                }

                // First, get the user's company data to determine companyId
                const database = firebase.database();
                const userRef = database.ref(`users/${currentUser.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                
                let companyId = null;
                
                // Try to get companyId from user data
                if (userData && userData.companyId) {
                    companyId = userData.companyId;
                } else {
                    // Fallback: try to get from localStorage
                    const companyData = JSON.parse(localStorage.getItem('currentCompany') || '{}');
                    if (companyData.companyId) {
                        companyId = companyData.companyId;
                    }
                }
                
                if (!companyId) {
                    console.warn('⚠️ No company context found - loading from fallback URL');
                    await loadEmployeesFromFallback();
                    return;
                }
                
                console.log('Loading accepted offers for company:', companyId);
                
                // Load both accepted offers and job postings from company-scoped paths
                const [offersSnapshot, jobsSnapshot] = await Promise.all([
                    database.ref(`companies/${companyId}/offers`).orderByChild('status').equalTo('accepted').once('value'),
                    database.ref(`companies/${companyId}/jobs`).once('value')
                ]);
                
                const acceptedOffersData = offersSnapshot.val() || {};
                const jobsData = jobsSnapshot.val() || {};
                
                console.log('Accepted offers data for company:', companyId, acceptedOffersData);
                console.log('Job postings data for company:', companyId, Object.keys(jobsData).length, 'jobs');
                
                if (Object.keys(acceptedOffersData).length === 0) {
                    console.log('No accepted offers found for company');
                    employees = [];
                    populateEmployeeDropdown();
                    return;
                }
                
                // Convert Firebase object to array with offer data and job data
                employees = Object.entries(acceptedOffersData).map(([offerId, offer]) => {
                    // Find matching job posting by title to get lineManager
                    let jobData = null;
                    const jobTitle = offer.jobTitle;
                    
                    // Search for job by title in jobs data
                    for (const [jobId, job] of Object.entries(jobsData)) {
                        if (job.title === jobTitle || job.jobTitle === jobTitle || job.positionTitle === jobTitle) {
                            jobData = job;
                            console.log(`Found job data for ${jobTitle}:`, {
                                lineManager: job.lineManager,
                                department: job.department,
                                workLocation: job.workLocation,
                                location: job.location
                            });
                            break;
                        }
                    }
                    
                    return {
                        firebaseId: offerId,
                        offerId: offerId,
                        // Candidate information
                        candidateId: offer.candidateId,
                        candidateName: getCandidateFullName(offer),
                        name: getCandidateFullName(offer),
                        fullName: getCandidateFullName(offer),
                        firstName: offer.candidateFirstName || offer.firstName,
                        lastName: offer.candidateLastName || offer.lastName,
                        candidateEmail: offer.candidateEmail,
                        email: offer.candidateEmail,
                        candidatePhone: offer.candidatePhone,
                        phone: offer.candidatePhone,
                        // Job information
                        jobTitle: offer.jobTitle,
                        position: offer.jobTitle,
                        department: offer.department,
                        // Management information - PRIORITIZE lineManager from job posting
                        lineManager: jobData?.lineManager || offer.lineManager || offer.reportingManager || offer.manager,
                        hiringManager: offer.hiringManager,
                        reportingManager: jobData?.lineManager || offer.reportingManager || offer.lineManager || offer.manager,
                        manager: offer.manager || jobData?.lineManager,
                        // Employment details
                        employmentType: offer.employmentType,
                        // Location information - PRIORITIZE workLocation (Primary Work Location) from job posting
                        location: jobData?.workLocation || offer.location || offer.workLocation,
                        workLocation: jobData?.workLocation || offer.workLocation || offer.location,
                        // Offer information
                        salary: offer.salary,
                        proposedSalary: offer.proposedSalary || offer.salary,
                        salaryAmount: offer.salaryAmount || offer.salary,
                        baseSalary: offer.baseSalary,
                        salaryType: offer.salaryType,
                        // Date information from offer
                        startDate: offer.startDate,
                        offerExpiryDate: offer.offerExpiryDate,
                        contractDuration: offer.contractDuration,
                        acceptedAt: offer.acceptedAt,
                        createdAt: offer.createdAt,
                        status: offer.status,
                        companyId: companyId,
                        // Store job data for reference
                        jobData: jobData,
                        // Include all original offer data
                        ...offer
                    };
                });
                
                console.log(`Loaded ${employees.length} employees from accepted offers`);
                populateEmployeeDropdown();
                
            } catch (error) {
                console.error('Error loading employees from company-scoped data:', error);
                console.log('Falling back to global acceptedoffer.json');
                await loadEmployeesFromFallback();
            } finally {
                // Hide loading state
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

        // Fallback function to load from global acceptedoffer.json
        async function loadEmployeesFromFallback() {
            try {
                const response = await fetch('https://users-8be65-default-rtdb.firebaseio.com/acceptedoffer.json');
                const data = await response.json();
                
                console.log('Fallback employees data received:', data);
                
                if (data) {
                    // Convert Firebase object to array
                    employees = Object.entries(data).map(([firebaseId, employee]) => ({
                        firebaseId,
                        ...employee
                    }));
                    
                    console.log(`Loaded ${employees.length} employees from fallback acceptedoffer.json`);
                    populateEmployeeDropdown();
                } else {
                    console.log('No employees found in fallback acceptedoffer.json');
                    employees = [];
                    populateEmployeeDropdown();
                }
            } catch (error) {
                console.error('Error loading employees from fallback:', error);
                employees = [];
                populateEmployeeDropdown();
            }
        }

        // Helper function to get candidate full name (same as offer.html)
        function getCandidateFullName(offer) {
            if (offer.candidateName) {
                return offer.candidateName;
            }
            
            const firstName = offer.candidateFirstName || offer.firstName || '';
            const lastName = offer.candidateLastName || offer.lastName || '';
            
            if (firstName && lastName) {
                return `${firstName} ${lastName}`.trim();
            }
            
            return firstName || lastName || offer.candidateEmail || 'Unknown Candidate';
        }

        // Populate the employee dropdown
        function populateEmployeeDropdown() {
            const dropdown = document.getElementById('employeeDropdown');
            
            if (!dropdown) return;

            // Clear existing options (except the default one)
            dropdown.innerHTML = '<option value="">Select an employee from accepted offers...</option>';

            if (employees.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No employees found in accepted offers';
                option.disabled = true;
                dropdown.appendChild(option);
                return;
            }

            // Add employee options
            employees.forEach((employee, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                // Create display text with available information
                let displayText = '';
                if (employee.candidateName || employee.name || employee.fullName) {
                    displayText = employee.candidateName || employee.name || employee.fullName;
                } else if (employee.firstName && employee.lastName) {
                    displayText = `${employee.firstName} ${employee.lastName}`;
                } else if (employee.email) {
                    displayText = employee.email;
                } else {
                    displayText = `Employee ${index + 1}`;
                }

                // Add additional info if available
                if (employee.email && displayText !== employee.email) {
                    displayText += ` (${employee.email})`;
                }
                if (employee.position || employee.jobTitle) {
                    displayText += ` - ${employee.position || employee.jobTitle}`;
                }

                option.textContent = displayText;
                dropdown.appendChild(option);
            });

            console.log(`Populated dropdown with ${employees.length} employees`);
        }

        // Fill employee details when dropdown selection changes
        function fillEmployeeDetails() {
            const dropdown = document.getElementById('employeeDropdown');
            const selectedIndex = dropdown.value;

            if (selectedIndex === '' || selectedIndex === null) {
                // Clear the form if no employee is selected
                clearEmployeeForm();
                return;
            }

            const selectedEmployee = employees[parseInt(selectedIndex)];
            if (!selectedEmployee) {
                console.error('Selected employee not found');
                return;
            }

            console.log('Selected employee:', selectedEmployee);

            // Fill employee information fields
            const employeeName = selectedEmployee.candidateName || selectedEmployee.name || selectedEmployee.fullName || 
                                 (selectedEmployee.firstName && selectedEmployee.lastName ? 
                                  `${selectedEmployee.firstName} ${selectedEmployee.lastName}` : '');
            
            document.getElementById('employeeName').value = employeeName;
            document.getElementById('employeeId').value = selectedEmployee.employeeId || selectedEmployee.candidateId || '';
            document.getElementById('employeeEmail').value = selectedEmployee.email || '';
            document.getElementById('employeePhone').value = selectedEmployee.phone || selectedEmployee.phoneNumber || '';

            // Fill position information if available
            if (selectedEmployee.position || selectedEmployee.jobTitle) {
                document.getElementById('positionTitle').value = selectedEmployee.position || selectedEmployee.jobTitle;
            }
            if (selectedEmployee.department) {
                document.getElementById('department').value = selectedEmployee.department;
            }
            
            // Fill reporting manager from recruitment process - prioritize line manager
            let reportingManagerName = '';
            if (selectedEmployee.lineManager) {
                reportingManagerName = selectedEmployee.lineManager;
                console.log('✅ Using line manager from recruitment process:', reportingManagerName);
            } else if (selectedEmployee.hiringManager) {
                reportingManagerName = selectedEmployee.hiringManager;
                console.log('✅ Using hiring manager as reporting manager:', reportingManagerName);
            } else if (selectedEmployee.manager || selectedEmployee.reportingManager) {
                reportingManagerName = selectedEmployee.manager || selectedEmployee.reportingManager;
                console.log('✅ Using general manager field:', reportingManagerName);
            } else {
                console.log('⚠️ No line manager, hiring manager, or reporting manager found for selected employee');
            }
            
            if (reportingManagerName) {
                document.getElementById('reportingManager').value = reportingManagerName;
            }
            
            // Fill work location from recruitment process - prioritize Primary Work Location from job posting
            let workLocationName = '';
            if (selectedEmployee.location) {
                workLocationName = selectedEmployee.location;
                console.log('✅ Using Primary Work Location from job posting:', workLocationName);
            } else if (selectedEmployee.workLocation) {
                workLocationName = selectedEmployee.workLocation;
                console.log('✅ Using work location from offer:', workLocationName);
            } else {
                console.log('⚠️ No Primary Work Location information found for selected employee');
            }
            
            if (workLocationName) {
                document.getElementById('workLocation').value = workLocationName;
            }

            // Fill compensation information if available
            // Prioritize base salary from offer, then fall back to other salary fields
            let salaryValue = selectedEmployee.baseSalary || selectedEmployee.salary || selectedEmployee.salaryAmount;
            if (salaryValue) {
                document.getElementById('salaryAmount').value = salaryValue;
                if (selectedEmployee.baseSalary) {
                    console.log('✅ Using base salary from offer:', selectedEmployee.baseSalary);
                } else if (selectedEmployee.salary) {
                    console.log('✅ Using salary from offer:', selectedEmployee.salary);
                } else {
                    console.log('✅ Using salary amount from offer:', selectedEmployee.salaryAmount);
                }
            } else {
                console.log('⚠️ No salary information found in offer data');
            }

            // Fill probation period from offer letter
            if (selectedEmployee.probationPeriod) {
                document.getElementById('probationPeriod').value = selectedEmployee.probationPeriod;
                console.log('✅ Using probation period from offer letter:', selectedEmployee.probationPeriod);
            } else {
                console.log('⚠️ No probation period found in offer letter');
            }

            // Fill employment type from offer data
            if (selectedEmployee.employmentType) {
                // Map common employment type values to dropdown options
                let employmentTypeValue = selectedEmployee.employmentType.toLowerCase();
                
                // Handle various employment type formats
                if (employmentTypeValue.includes('full') || employmentTypeValue.includes('permanent')) {
                    employmentTypeValue = 'full-time';
                } else if (employmentTypeValue.includes('part')) {
                    employmentTypeValue = 'part-time';
                } else if (employmentTypeValue.includes('consultant') || employmentTypeValue.includes('contract')) {
                    employmentTypeValue = 'consultant';
                }
                
                // Set the dropdown value
                const employmentTypeSelect = document.getElementById('employmentType');
                if (employmentTypeSelect) {
                    // Check if the mapped value exists in the dropdown options
                    const option = employmentTypeSelect.querySelector(`option[value="${employmentTypeValue}"]`);
                    if (option) {
                        employmentTypeSelect.value = employmentTypeValue;
                        console.log('✅ Using employment type from offer:', selectedEmployee.employmentType, '→', employmentTypeValue);
                    } else {
                        console.log('⚠️ Employment type from offer not found in dropdown options:', selectedEmployee.employmentType);
                    }
                }
            } else {
                console.log('⚠️ No employment type found in offer data');
            }

            // Fill date information from offer letter
            if (selectedEmployee.startDate) {
                document.getElementById('startDate').value = selectedEmployee.startDate;
                console.log('✅ Using start date from offer letter:', selectedEmployee.startDate);
            } else {
                console.log('⚠️ No start date found in offer letter');
            }

            // Calculate end date based on offer information
            let calculatedEndDate = '';
            if (selectedEmployee.offerExpiryDate) {
                // Note: Offer expiry date is different from contract end date
                // We should use this cautiously and may need to calculate based on contract duration
                console.log('📅 Offer expiry date available:', selectedEmployee.offerExpiryDate);
            }
            
            if (selectedEmployee.contractDuration && selectedEmployee.startDate) {
                // Try to calculate end date based on contract duration and start date
                const startDate = new Date(selectedEmployee.startDate);
                if (!isNaN(startDate.getTime())) {
                    const duration = selectedEmployee.contractDuration;
                    
                    // Handle different duration formats
                    if (duration && duration.toLowerCase() !== 'permanent' && duration.toLowerCase() !== 'indefinite') {
                        // Try to parse duration (e.g., "12 months", "2 years", "6 months")
                        const durationMatch = duration.match(/(\d+)\s*(month|year|day)s?/i);
                        if (durationMatch) {
                            const amount = parseInt(durationMatch[1]);
                            const unit = durationMatch[2].toLowerCase();
                            
                            const endDate = new Date(startDate);
                            if (unit === 'month') {
                                endDate.setMonth(endDate.getMonth() + amount);
                            } else if (unit === 'year') {
                                endDate.setFullYear(endDate.getFullYear() + amount);
                            } else if (unit === 'day') {
                                endDate.setDate(endDate.getDate() + amount);
                            }
                            
                            calculatedEndDate = endDate.toISOString().split('T')[0];
                            console.log('✅ Calculated contract end date from duration:', calculatedEndDate, `(${duration})`);
                        } else {
                            console.log('⚠️ Could not parse contract duration format:', duration);
                        }
                    } else {
                        console.log('📋 Contract is permanent/indefinite - no end date set');
                    }
                } else {
                    console.log('⚠️ Invalid start date format for end date calculation');
                }
            } else {
                console.log('⚠️ Missing contract duration or start date for end date calculation');
            }
            
            // Set calculated end date if available
            if (calculatedEndDate) {
                document.getElementById('endDate').value = calculatedEndDate;
                console.log('✅ Contract end date populated from offer data');
            } else {
                console.log('📋 No contract end date calculated - leaving field empty for manual entry');
            }            // Trigger validation for filled fields
            const filledFields = ['employeeName', 'employeeId', 'employeeEmail', 'employeePhone', 
                                 'positionTitle', 'department', 'reportingManager', 'workLocation',
                                 'salaryAmount', 'employmentType', 'startDate', 'endDate', 'probationPeriod'];
            
            filledFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    validateField(field);
                    // Ensure field remains editable after being populated
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                    field.readOnly = false;
                    field.disabled = false;
                }
            });

            console.log('Employee details filled successfully');
        }        // Clear employee form fields
        function clearEmployeeForm() {
            const fields = ['employeeName', 'employeeId', 'employeeEmail', 'employeePhone', 
                           'positionTitle', 'department', 'reportingManager', 'workLocation',
                           'salaryAmount', 'employmentType', 'startDate', 'endDate', 'probationPeriod'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    // Ensure field is editable after clearing
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                    field.readOnly = false;
                    field.disabled = false;
                    // Remove validation styling
                    field.classList.remove('is-valid', 'is-invalid');
                }
            });
        }

        // Generate employee ID based on name and department
        function generateEmployeeId(name, department) {
            if (!name) return '';
            
            // Create initials from name
            const nameParts = name.trim().split(' ');
            const initials = nameParts.map(part => part.charAt(0).toUpperCase()).join('');
            
            // Create department code (first 3 letters)
            const deptCode = department ? department.substring(0, 3).toUpperCase() : 'GEN';
            
            // Generate random number
            const randomNum = Math.floor(Math.random() * 9000) + 1000; // 4-digit number
            
            return `${initials}${deptCode}${randomNum}`;
        }
        function loadTemplates() {
            console.log('🔄 Loading templates from Firebase Realtime Database...');
            
            // Show loading state
            document.getElementById('loadingTemplates').style.display = 'block';
            document.getElementById('templateGrid').style.display = 'none';
            document.getElementById('emptyTemplates').style.display = 'none';

            // Get current user's company ID for filtering
            const userCompanyId = currentUser?.companyId;
            console.log('🏢 Loading templates ONLY for company:', userCompanyId);

            // Initialize empty templates array
            templates = [];

            // Only load company-specific templates if we have a company ID
            if (database && userCompanyId) {
                console.log('📊 Loading ONLY company-specific templates from Firebase Realtime Database');
                console.log('📍 Database path:', `companies/${userCompanyId}/documentTemplates`);
                
                // Load ONLY company-specific templates (matches dochtml.html save path exactly)
                database.ref(`companies/${userCompanyId}/documentTemplates`).once('value')
                    .then((snapshot) => {
                        const companyTemplates = snapshot.val() || {};
                        console.log('📋 Company templates found:', companyTemplates);
                        console.log('📊 Number of company templates:', Object.keys(companyTemplates).length);
                        
                        Object.entries(companyTemplates).forEach(([templateId, template]) => {
                            // Check if it's a contract-related template
                            const isContractTemplate = template.category === 'contract' || 
                                template.category === 'employment' ||
                                template.name?.toLowerCase().includes('contract') ||
                                template.name?.toLowerCase().includes('employment');
                            
                            console.log(`📄 Template "${template.name}":`, {
                                id: templateId,
                                category: template.category,
                                name: template.name,
                                companyId: template.companyId,
                                isContractTemplate: isContractTemplate,
                                createdAt: template.createdAt,
                                lastModified: template.lastModified
                            });
                            
                            if (isContractTemplate) {
                                templates.push({ id: templateId, companyId: userCompanyId, ...template });
                            }
                        });
                        
                        console.log(`✅ Successfully loaded ${templates.length} company-specific contract templates`);
                        displayTemplates();
                    })
                    .catch((error) => {
                        console.error('❌ Error loading company-specific templates from Firebase Realtime Database:', error);
                        templates = [];
                        displayTemplates();
                    });
            } else {
                console.log('⚠️ Cannot load templates - missing database connection or company ID');
                console.log('Database available:', !!database);
                console.log('Company ID available:', !!userCompanyId);
                console.log('Current user object:', currentUser);
                templates = [];
                displayTemplates();
            }
        }

        // Display templates in the grid
        function displayTemplates() {
            console.log('🎨 Displaying templates in grid...');
            
            const loadingElement = document.getElementById('loadingTemplates');
            const templateGrid = document.getElementById('templateGrid');
            const emptyElement = document.getElementById('emptyTemplates');

            // Hide loading state
            loadingElement.style.display = 'none';

            if (templates.length === 0) {
                console.log('📭 No templates found - showing empty state');
                // Show empty state
                templateGrid.style.display = 'none';
                emptyElement.style.display = 'block';
                return;
            }

            console.log(`📋 Displaying ${templates.length} templates in grid`);
            // Show template grid
            templateGrid.style.display = 'grid';
            emptyElement.style.display = 'none';

            // Generate template cards
            templateGrid.innerHTML = templates.map(template => `
                <div class="template-card" onclick="selectTemplate('${template.id || template.name}')">
                    <h4>${template.name}</h4>
                    <p>${template.description || 'No description available'}</p>
                    <div class="template-card-footer">
                        <span class="template-category">${template.category || 'General'}</span>
                        <span>${template.sections ? template.sections.length : 0} sections</span>
                        <span style="color: #28a745; font-size: 0.7rem;">Company Template</span>
                    </div>
                </div>
            `).join('');

            console.log(`Displayed ${templates.length} templates`);
        }

        // Setup real-time template updates listener
        function setupRealTimeTemplateUpdates() {
            const userCompanyId = currentUser?.companyId;
            
            if (!database || !userCompanyId) {
                console.log('⚠️ Cannot setup real-time updates - missing database or company ID');
                console.log('Database available:', !!database);
                console.log('Company ID available:', !!userCompanyId);
                return;
            }

            console.log('🔄 Setting up real-time template updates for company:', userCompanyId);
            console.log('📍 Watching paths:');
            console.log('  - Template updates:', `companies/${userCompanyId}/templateUpdates`);
            console.log('  - Template collection:', `companies/${userCompanyId}/documentTemplates`);

            // Listen for template update notifications (triggered by dochtml.html)
            const templateUpdatesRef = database.ref(`companies/${userCompanyId}/templateUpdates`);
            templateUpdatesRef.on('value', (snapshot) => {
                const updateData = snapshot.val();
                
                if (updateData && updateData.timestamp) {
                    console.log('📡 Real-time template update notification received:', updateData);
                    
                    // Reload templates after a short delay to allow for database consistency
                    setTimeout(() => {
                        console.log('🔄 Reloading templates due to update notification...');
                        loadTemplates();
                    }, 500);
                }
            });

            // Also listen directly to the templates collection for immediate updates
            const templatesRef = database.ref(`companies/${userCompanyId}/documentTemplates`);
            
            templatesRef.on('child_added', (snapshot) => {
                const templateId = snapshot.key;
                const templateData = snapshot.val();
                console.log('📡 New template added - refreshing list:', templateId, templateData?.name);
                setTimeout(() => loadTemplates(), 300);
            });

            templatesRef.on('child_changed', (snapshot) => {
                const templateId = snapshot.key;
                const templateData = snapshot.val();
                console.log('📡 Template updated - refreshing list:', templateId, templateData?.name);
                setTimeout(() => loadTemplates(), 300);
            });

            templatesRef.on('child_removed', (snapshot) => {
                const templateId = snapshot.key;
                console.log('📡 Template removed - refreshing list:', templateId);
                setTimeout(() => loadTemplates(), 300);
            });

            console.log('✅ Real-time template update listeners configured successfully');
        }

        // Debug function to check template loading issues
        async function debugTemplateLoading() {
            console.log('🔍 === TEMPLATE DEBUG START ===');
            
            // Check current user and company ID
            console.log('Current User:', currentUser);
            console.log('User Company ID:', currentUser?.companyId);
            
            // Check localStorage for company data
            const localCompany = localStorage.getItem('currentCompany');
            console.log('LocalStorage Company:', localCompany ? JSON.parse(localCompany) : 'None');
            
            // Check if database is available
            console.log('Database available:', !!database);
            console.log('Firebase available:', !!window.firebaseAvailable);
            
            // Check localStorage for templates
            const userCompanyId = currentUser?.companyId;
            if (userCompanyId) {
                const localTemplates = localStorage.getItem(`documentTemplates_${userCompanyId}`);
                console.log('LocalStorage Templates:', localTemplates ? JSON.parse(localTemplates) : 'None');
                
                // Check Firebase Realtime Database for templates
                if (database) {
                    try {
                        const snapshot = await database.ref(`companies/${userCompanyId}/documentTemplates`).once('value');
                        const firebaseTemplates = snapshot.val();
                        console.log('Firebase Realtime DB Templates:', firebaseTemplates || 'None');
                        
                        if (firebaseTemplates) {
                            console.log('Template analysis:');
                            Object.entries(firebaseTemplates).forEach(([id, template]) => {
                                const isContract = template.category === 'contract' || 
                                                 template.category === 'employment' ||
                                                 template.name?.toLowerCase().includes('contract') ||
                                                 template.name?.toLowerCase().includes('employment');
                                console.log(`- "${template.name}": category="${template.category}", isContract=${isContract}`);
                            });
                        }
                    } catch (error) {
                        console.error('Error checking Firebase templates:', error);
                    }
                }
                
                // Also check if any global fallback data exists
                try {
                    const globalTemplates = localStorage.getItem('documentTemplates');
                    console.log('Global LocalStorage Templates:', globalTemplates ? JSON.parse(globalTemplates) : 'None');
                } catch (error) {
                    console.log('Error checking global templates:', error);
                }
            } else {
                console.log('❌ No company ID available - cannot check templates');
                
                // Let's manually set a test company ID for debugging
                console.log('🧪 Setting test company ID for debugging...');
                if (!currentUser) {
                    currentUser = {
                        uid: 'test-user-id',
                        email: 'test@example.com',
                        companyId: 'test-company-123'
                    };
                } else {
                    currentUser.companyId = 'test-company-123';
                }
                console.log('Test user set:', currentUser);
                
                // Now try to load templates with test company ID
                console.log('� Attempting to load templates with test company ID...');
                loadTemplates();
            }
            
            console.log('Current templates array:', templates);
            console.log('Templates array length:', templates.length);
            
            console.log('�🔍 === TEMPLATE DEBUG END ===');
        }

        // Force load template test function
        async function forceLoadTemplateTest() {
            console.log('🧪 === FORCE TEMPLATE TEST START ===');
            
            // Create a test template in localStorage for debugging
            const testCompanyId = currentUser?.companyId || 'test-company-123';
            const testTemplates = [
                {
                    id: 'test-template-1',
                    name: 'Test Employment Contract',
                    category: 'contract',
                    description: 'This is a test contract template',
                    sections: [
                        { name: 'Employee Information', fields: ['name', 'position'] },
                        { name: 'Terms and Conditions', fields: ['salary', 'start_date'] }
                    ],
                    createdAt: new Date().toISOString(),
                    companyId: testCompanyId
                },
                {
                    id: 'test-template-2', 
                    name: 'Contract for Full-time Employment',
                    category: 'employment',
                    description: 'Full-time employment contract template',
                    sections: [
                        { name: 'Basic Info', fields: ['employee_name', 'job_title'] }
                    ],
                    createdAt: new Date().toISOString(),
                    companyId: testCompanyId
                }
            ];
            
            // Save test templates to localStorage
            localStorage.setItem(`documentTemplates_${testCompanyId}`, JSON.stringify(testTemplates));
            console.log('✅ Test templates saved to localStorage');
            
            // Try to save to Firebase as well if available
            if (database && testCompanyId) {
                try {
                    for (const template of testTemplates) {
                        await database.ref(`companies/${testCompanyId}/documentTemplates/${template.id}`).set(template);
                    }
                    console.log('✅ Test templates saved to Firebase');
                } catch (error) {
                    console.log('⚠️ Could not save to Firebase:', error);
                }
            }
            
            // Set company ID if not set
            if (!currentUser) {
                currentUser = { uid: 'test-user', email: 'test@example.com', companyId: testCompanyId };
            } else {
                currentUser.companyId = testCompanyId;
            }
            
            // Now reload templates
            console.log('🔄 Reloading templates after test data setup...');
            loadTemplates();
            
            console.log('🧪 === FORCE TEMPLATE TEST END ===');
        }

        // Test Firebase Realtime Database connection
        function testRealtimeDatabaseConnection() {
            console.log('🧪 Testing Firebase Realtime Database connection...');
            
            const userCompanyId = currentUser?.companyId;
            
            if (!database) {
                console.error('❌ Firebase Realtime Database not available');
                return;
            }
            
            if (!userCompanyId) {
                console.error('❌ No company ID available for testing');
                return;
            }
            
            console.log('📍 Testing connection to path:', `companies/${userCompanyId}/documentTemplates`);
            
            // Test read access
            database.ref(`companies/${userCompanyId}/documentTemplates`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    console.log('✅ Firebase Realtime Database connection successful');
                    console.log('📊 Current templates in database:', Object.keys(data || {}).length);
                    console.log('📋 Template data:', data);
                })
                .catch((error) => {
                    console.error('❌ Firebase Realtime Database connection failed:', error);
                });
        }

        // Select a template
        function selectTemplate(templateId) {
            // Remove previous selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Find and select the template
            selectedTemplate = templates.find(t => (t.id || t.name) === templateId);
            if (selectedTemplate) {
                // Add selected class to clicked card
                event.target.closest('.template-card').classList.add('selected');
                
                // Enable continue button
                document.getElementById('continueToForm').disabled = false;
                
                console.log('Selected template:', selectedTemplate);
            }
        }        // Proceed to form after template selection (updated for tab navigation)
        function proceedToForm() {
            if (!selectedTemplate) {
                alert('Please select a template first');
                return;
            }

            // Switch to contract form tab
            switchTab('contractForm');

            // Load template fields into the form
            loadTemplateFieldsIntoForm();

            // Ensure all form fields are editable
            makeFormFieldsEditable();

            // Display template content
            displayTemplateContent();

            // Load template fields into the form
            loadTemplateFieldsIntoForm();
        }

        // Tab switching functionality (matching jobscreen.html)
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show the selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate the corresponding tab button
            let buttonId = '';
            switch(tabName) {
                case 'templateSelection':
                    buttonId = 'templateSelectionBtn';
                    break;
                case 'contractForm':
                    buttonId = 'contractFormBtn';
                    break;
                case 'preview':
                    buttonId = 'previewBtn';
                    // Update preview when switching to preview tab
                    if (selectedTemplate) {
                        displayTemplateContent();
                    }
                    break;
            }
            
            const tabButton = document.getElementById(buttonId);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Scroll to top of content
            if (selectedTab) {
                selectedTab.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Back to template selection (updated for tab navigation)
        function backToTemplateSelection() {
            switchTab('templateSelection');
        }        // Display template content in preview
        function displayTemplateContent() {
            const previewContainer = document.getElementById('templateContentPreview');
            
            // Start with comprehensive contract preview
            let contentHTML = generateCompleteContractPreview();
            
            previewContainer.innerHTML = contentHTML;
            
            // Set up real-time preview updates
            setupRealTimePreview();
        }

        // Generate complete contract preview with all fields
        function generateCompleteContractPreview() {
            let contentHTML = '<div style="font-family: Arial, sans-serif; line-height: 1.6; width: 100%;">';
            
            // Header with company logo if available
            if (selectedTemplate && selectedTemplate.logo) {
                contentHTML += `
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #2c3e50; padding-bottom: 1rem;">
                        <img src="${selectedTemplate.logo}" alt="Company Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 1rem;">
                        <h1 style="color: #2c3e50; margin: 0;">EMPLOYMENT CONTRACT</h1>
                    </div>
                `;
            } else {
                contentHTML += `
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #2c3e50; padding-bottom: 1rem;">
                        <h1 style="color: #2c3e50; margin: 0;">EMPLOYMENT CONTRACT</h1>
                    </div>
                `;
            }

            // Employee Information Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Employee Information</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Full Name:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeeName">[Employee Name]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Employee ID:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeeId">[Employee ID]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Email Address:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeeEmail">[Email Address]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Phone Number:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employeePhone">[Phone Number]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Position Information Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Position Information</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Position Title:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-positionTitle">[Position Title]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Department:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-department">[Department]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Reporting Manager:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-reportingManager">[Reporting Manager]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Work Location:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-workLocation">[Work Location]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Contract Terms Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Contract Terms</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Contract Type:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-contractType">[Contract Type]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Employment Type:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-employmentType">[Employment Type]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Start Date:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-startDate">[Start Date]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">End Date:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-endDate">[End Date - if applicable]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Compensation Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Compensation</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Salary Amount:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-salaryAmount">[Salary Amount]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Currency:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-currency">[Currency]</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Probation Period:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-probationPeriod">[Probation Period]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Work Terms Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Work Terms</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Working Hours:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-workingHours">[Working Hours] hours per week</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Notice Period:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-noticePeriod">[Notice Period] days</td>
                        </tr>
                    </table>
                </div>
            `;

            // Benefits Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Benefits & Leave</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 30%;">Annual Leave:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-annualLeave">[Annual Leave] days per year</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Sick Leave:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-sickLeave">[Sick Leave] days per year</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Additional Benefits:</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;" id="preview-additionalBenefits">[Additional Benefits]</td>
                        </tr>
                    </table>
                </div>
            `;

            // Additional Terms Section
            contentHTML += `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #2c3e50; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">Additional Terms & Conditions</h2>
                    <div style="border: 1px solid #dee2e6; padding: 1rem; background: #f8f9fa; min-height: 100px;">
                        <div id="preview-specialTerms">[Special Terms & Conditions will appear here]</div>
                    </div>
                </div>
            `;

            // Template-specific sections
            if (selectedTemplate && selectedTemplate.sections) {
                contentHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h2 style="color: #007bff; border-bottom: 1px solid #007bff; padding-bottom: 0.5rem;">Template-Specific Fields</h2>
                        <div id="preview-templateFields">
                `;

                selectedTemplate.sections.forEach((section, index) => {
                    if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                        contentHTML += `
                            <div style="margin-bottom: 1rem; padding: 0.5rem; border-left: 4px solid #007bff; background: #f8f9ff;">
                                <strong>${section.title || section.label || section.content}:</strong>
                                <div id="preview-template_field_${index}" style="margin-top: 0.5rem; font-style: italic; color: #666;">
                                    [${section.placeholder || 'Enter value here'}]
                                </div>
                            </div>
                        `;
                    } else if (section.type === 'table' && section.editable) {
                        contentHTML += `
                            <div style="margin-bottom: 1rem;">
                                <strong>${section.title || 'Table Data'}:</strong>
                                <div id="preview-template_table_${index}" style="margin-top: 0.5rem;">
                                    [Table data will appear here]
                                </div>
                            </div>
                        `;
                    } else if (section.type === 'list' && section.editable) {
                        contentHTML += `
                            <div style="margin-bottom: 1rem;">
                                <strong>${section.title || 'List Items'}:</strong>
                                <div id="preview-template_list_${index}" style="margin-top: 0.5rem;">
                                    [List items will appear here]
                                </div>
                            </div>
                        `;
                    } else if (section.type === 'heading') {
                        contentHTML += `<h3 style="color: #2c3e50; margin: 1rem 0;">${section.title || section.content}</h3>`;
                    } else if (section.type === 'paragraph') {
                        contentHTML += `<p style="margin-bottom: 1rem;">${section.content.replace(/\n/g, '<br>')}</p>`;
                    }
                });

                contentHTML += `
                        </div>
                    </div>
                `;
            }

            // Signature section
            contentHTML += `
                <div style="margin-top: 3rem; border-top: 2px solid #2c3e50; padding-top: 2rem;">
                    <h2 style="color: #2c3e50; margin-bottom: 2rem;">Signatures</h2>
                    <div style="display: flex; justify-content: space-between; margin-top: 3rem;">
                        <div style="width: 45%; text-align: center;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 0.5rem; height: 50px;"></div>
                            <div><strong>Employee Signature</strong></div>
                            <div>Date: _______________</div>
                        </div>
                        <div style="width: 45%; text-align: center;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 0.5rem; height: 50px;"></div>
                            <div><strong>Employer Signature</strong></div>
                            <div>Date: _______________</div>
                        </div>
                    </div>
                </div>
            `;

            contentHTML += '</div>';
            return contentHTML;
        }

        // Setup real-time preview updates
        function setupRealTimePreview() {
            const fieldsToWatch = [
                'employeeName', 'employeeId', 'employeeEmail', 'employeePhone',
                'positionTitle', 'department', 'reportingManager', 'workLocation',
                'contractType', 'employmentType', 'startDate', 'endDate',
                'salaryAmount', 'currency', 'probationPeriod',
                'workingHours', 'noticePeriod', 'annualLeave', 'sickLeave',
                'additionalBenefits', 'specialTerms'
            ];

            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Update immediately with current value
                    updatePreviewField(fieldId);
                    
                    // Add event listeners for real-time updates
                    field.addEventListener('input', () => updatePreviewField(fieldId));
                    field.addEventListener('change', () => updatePreviewField(fieldId));
                }
            });

            // Watch for template fields
            updateTemplateFieldsPreviews();
        }

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            } catch (error) {
                return dateString; // Return original if formatting fails
            }
        }

        // Update individual preview field
        function updatePreviewField(fieldId) {
            const field = document.getElementById(fieldId);
            const previewElement = document.getElementById(`preview-${fieldId}`);
            
            if (field && previewElement) {
                let value = field.value || `[${field.placeholder || fieldId}]`;
                
                // Format specific fields
                if (fieldId === 'salaryAmount' && field.value) {
                    const currency = document.getElementById('currency')?.value || 'USD';
                    value = `${currency} ${parseFloat(field.value).toLocaleString()}`;
                }
                if (fieldId === 'currency') {
                    // When currency changes, also update salary amount display
                    updatePreviewField('salaryAmount');
                    value = field.value || 'USD';
                }
                if (fieldId === 'startDate' || fieldId === 'endDate') {
                    if (field.value) {
                        value = formatDate(field.value);
                    }
                }
                if (fieldId === 'probationPeriod' && field.value) {
                    value = `${field.value} months`;
                }
                if (fieldId === 'workingHours' && field.value) {
                    value = `${field.value} hours per week`;
                }
                if (fieldId === 'noticePeriod' && field.value) {
                    value = `${field.value} days`;
                }
                if (fieldId === 'annualLeave' && field.value) {
                    value = `${field.value} days per year`;
                }
                if (fieldId === 'sickLeave' && field.value) {
                    value = `${field.value} days per year`;
                }
                
                previewElement.innerHTML = value;
            }
        }

        // Update template fields previews
        function updateTemplateFieldsPreviews() {
            if (!selectedTemplate || !selectedTemplate.sections) return;

            selectedTemplate.sections.forEach((section, index) => {
                if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                    const fieldId = `template_field_${index}`;
                    const previewId = `preview-${fieldId}`;
                    const field = document.getElementById(fieldId);
                    const previewElement = document.getElementById(previewId);
                    
                    if (field && previewElement) {
                        // Update immediately
                        const value = field.value || `[${section.placeholder || section.content || 'Enter value here'}]`;
                        previewElement.innerHTML = value.replace(/\n/g, '<br>');
                        
                        // Add event listener
                        field.addEventListener('input', () => {
                            const newValue = field.value || `[${section.placeholder || section.content || 'Enter value here'}]`;
                            previewElement.innerHTML = newValue.replace(/\n/g, '<br>');
                        });
                    }
                }
            });
        }

        // Go back to template selection
        function backToTemplateSelection() {
            // Update progress indicator
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('pending');

            // Show template selection and hide form
            document.getElementById('templateSelection').style.display = 'block';
            document.getElementById('contractForm').style.display = 'none';

            // Scroll to top
            document.getElementById('templateSelection').scrollIntoView({ behavior: 'smooth' });
        }

        // Make all form fields editable
        function makeFormFieldsEditable() {
            console.log('Making form fields editable...');
            
            // Get all form inputs, selects, and textareas
            const formFields = document.querySelectorAll('#contractFormData input, #contractFormData select, #contractFormData textarea');
            
            formFields.forEach(field => {
                // Remove readonly and disabled attributes
                field.removeAttribute('readonly');
                field.removeAttribute('disabled');
                
                // Ensure the field is editable
                field.readOnly = false;
                field.disabled = false;
                
                // Add focus event to highlight editable fields
                field.addEventListener('focus', function() {
                    this.style.borderColor = '#007bff';
                    this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,0.25)';
                });
                
                // Remove highlight when field loses focus
                field.addEventListener('blur', function() {
                    this.style.borderColor = '#ced4da';
                    this.style.boxShadow = 'none';
                });
            });
            
            console.log(`Made ${formFields.length} form fields editable`);
        }
        function setupFormValidation() {
            const form = document.getElementById('contractFormData');
            const inputs = form.querySelectorAll('input[required], select[required]');

            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateField(this);
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateField(this);
                    }
                });
            });
        }

        // Validate individual field
        function validateField(field) {
            const isValid = field.checkValidity();
            
            if (isValid) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
            }

            return isValid;
        }

        // Validate entire form
        function validateForm() {
            const form = document.getElementById('contractFormData');
            const requiredFields = form.querySelectorAll('input[required], select[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });

            return isValid;
        }

        // Preview contract
        function previewContract() {
            if (!validateForm()) {
                alert('Please fill in all required fields before previewing the contract.');
                return;
            }

            // Update progress indicator
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.remove('pending');
            document.getElementById('step3').classList.add('active');

            // Collect form data
            const formData = collectFormData();
            
            // Generate preview (this would typically open a modal or new window)
            console.log('Contract preview data:', formData);
            
            // For now, just show an alert
            alert('Contract preview would be displayed here. Implementation can be extended to show a formatted preview.');
        }

        // Create contract
        function createContract() {
            if (!validateForm()) {
                alert('Please fill in all required fields before creating the contract.');
                return;
            }

            if (!selectedTemplate) {
                alert('Please select a template first.');
                return;
            }

            // Collect form data
            const formData = collectFormData();
            const contractData = {
                ...formData,
                template: {
                    id: selectedTemplate.id || selectedTemplate.name,
                    name: selectedTemplate.name,
                    type: selectedTemplate.category
                },
                status: 'draft',
                createdAt: new Date().toISOString(),
                createdBy: currentUser ? {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: currentUser.displayName
                } : null,
                version: 1,
                formVersion: '1.0'
            };

            console.log('Creating contract:', contractData);

            // Save to Firebase with company scoping
            if (database) {
                // Check if user has company context
                if (currentUser && currentUser.companyId) {
                    // Add company ID to contract data
                    contractData.companyId = currentUser.companyId;
                    
                    // Save to company-scoped contracts
                    const contractRef = database.ref(`companies/${currentUser.companyId}/contracts`).push();
                    contractData.contractId = contractRef.key; // Store the generated contract ID
                    
                    contractRef.set(contractData)
                        .then(() => {
                            console.log('✅ Contract created successfully with company scope:', currentUser.companyId);
                            alert('Contract created successfully! Contract saved to your company system.');
                            
                            // Stay on the same page - no redirection
                            // User can navigate manually if needed
                            console.log('Contract creation completed - staying on current page');
                        })
                        .catch((error) => {
                            console.error('❌ Error creating company-scoped contract:', error);
                            alert('Error creating contract. Please try again.');
                        });
                } else {
                    // Fallback: Save to global contracts if no company context
                    console.warn('⚠️ No company context available, saving to global contracts');
                    database.ref('contracts').push(contractData)
                        .then(() => {
                            console.log('⚠️ Contract created in global scope (no company context)');
                            alert('Contract created successfully! Contract saved to system.');
                            
                            // Stay on the same page - no redirection
                            // User can navigate manually if needed
                            console.log('Contract creation completed - staying on current page');
                        })
                        .catch((error) => {
                            console.error('❌ Error creating global contract:', error);
                            alert('Error creating contract. Please try again.');
                        });
                }
            } else {
                console.error('❌ Database not available');
                alert('Database connection not available. Please try again.');
            }
        }        // Collect form data
        function collectFormData() {
            const baseData = {
                // Employee Information
                employeeName: document.getElementById('employeeName').value,
                employeeId: document.getElementById('employeeId').value,
                employeeEmail: document.getElementById('employeeEmail').value,
                employeePhone: document.getElementById('employeePhone').value,
                
                // Position Information
                positionTitle: document.getElementById('positionTitle').value,
                department: document.getElementById('department').value,
                reportingManager: document.getElementById('reportingManager').value,
                workLocation: document.getElementById('workLocation').value,
                
                // Contract Terms
                contractType: document.getElementById('contractType').value,
                employmentType: document.getElementById('employmentType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                
                // Compensation
                salaryAmount: parseFloat(document.getElementById('salaryAmount').value) || 0,
                currency: document.getElementById('currency').value,
                probationPeriod: parseInt(document.getElementById('probationPeriod').value) || 0,
                
                // Work Terms
                workingHours: parseInt(document.getElementById('workingHours').value) || 40,
                noticePeriod: parseInt(document.getElementById('noticePeriod').value) || 30,
                
                // Benefits
                annualLeave: parseInt(document.getElementById('annualLeave').value) || 20,
                sickLeave: parseInt(document.getElementById('sickLeave').value) || 10,
                additionalBenefits: document.getElementById('additionalBenefits').value,
                
                // Additional Terms
                specialTerms: document.getElementById('specialTerms').value
            };

            // Collect dynamic template fields
            const templateFields = collectTemplateFieldsData();
            
            return {
                ...baseData,
                templateFields: templateFields,
                customFieldsData: templateFields // For compatibility
            };
        }

        // Collect data from dynamic template fields
        function collectTemplateFieldsData() {
            const templateFields = {};
            
            if (!selectedTemplate || !selectedTemplate.sections) {
                return templateFields;
            }

            selectedTemplate.sections.forEach((section, index) => {
                const fieldId = `template_field_${index}`;
                const tableId = `template_table_${index}`;
                const listId = `template_list_${index}`;

                if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        templateFields[fieldId] = {
                            type: section.type,
                            title: section.title || section.label,
                            value: field.value,
                            section: section
                        };
                    }
                } else if (section.type === 'table' && section.editable) {
                    const tableData = collectTableData(tableId);
                    if (tableData) {
                        templateFields[tableId] = {
                            type: 'table',
                            title: section.title || section.label,
                            value: tableData,
                            headers: section.headers,
                            section: section
                        };
                    }
                } else if (section.type === 'list' && section.editable) {
                    const listData = collectListData(listId);
                    if (listData) {
                        templateFields[listId] = {

                            type: 'list',
                            title: section.title || section.label,
                            value: listData,
                            section: section
                        };
                    }
                }
            });

            console.log('Collected template fields data:', templateFields);
            return templateFields;
        }

        // Collect table data
        function collectTableData(tableId) {
            const tbody = document.getElementById(`${tableId}_tbody`);
            if (!tbody) return null;

            const rows = [];
            const tableRows = tbody.querySelectorAll('tr');
            
            tableRows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="text"]');
                const rowData = [];
                inputs.forEach(input => {
                    rowData.push(input.value.trim());
                });
                if (rowData.some(cell => cell !== '')) {
                    rows.push(rowData);
                }
            });

            return rows;
        }

        // Collect list data
        function collectListData(listId) {
            const container = document.getElementById(`${listId}_items`);
            if (!container) return null;

            const items = [];
            const inputs = container.querySelectorAll('input[type="text"]');
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    items.push(input.value.trim());
                }
            });

            return items;
        }

        // Load template fields into the form
        function loadTemplateFieldsIntoForm() {
            if (!selectedTemplate || !selectedTemplate.sections) {
                console.log('No template or sections available to load');
                return;
            }

            console.log('Loading template fields into form...', selectedTemplate);

            // Find the form container where we'll add dynamic fields
            const formContainer = document.getElementById('contractFormData');
            
            // Remove any existing dynamic template fields
            const existingDynamicSections = formContainer.querySelectorAll('.dynamic-template-section');
            existingDynamicSections.forEach(section => section.remove());

            // Process template sections and create form fields
            selectedTemplate.sections.forEach((section, index) => {
                if (section.type === 'placeholder' || section.type === 'textarea' || section.type === 'input') {
                    createDynamicFormField(section, index, formContainer);
                } else if (section.type === 'table' && section.editable) {
                    createDynamicTableField(section, index, formContainer);
                } else if (section.type === 'list' && section.editable) {
                    createDynamicListField(section, index, formContainer);
                }
            });

            // Make sure all new fields are editable
            makeFormFieldsEditable();
            
            console.log('Template fields loaded into form');
        }

        // Create dynamic form field based on template section
        function createDynamicFormField(section, index, formContainer) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-section dynamic-template-section';
            sectionDiv.setAttribute('data-template-section', index);

            let sectionHTML = `
                <h4><i class="fas fa-file-alt"></i> ${section.title || `Template Field ${index + 1}`}</h4>
            `;

            const fieldId = `template_field_${index}`;
            const isRequired = section.required || false;
            const isReadonly = section.readonly || false;

            if (section.type === 'textarea') {
                sectionHTML += `
                    <div class="form-group full-width">
                        <label class="form-label${isRequired ? ' required' : ''}">${section.label || section.title || section.content}</label>
                        <textarea 
                            class="form-control" 
                            id="${fieldId}" 
                            rows="${section.rows || 4}"
                            placeholder="${section.placeholder || section.content || ''}"
                            ${isRequired ? 'required' : ''}
                            ${isReadonly ? 'readonly' : ''}
                        >${section.defaultValue || ''}</textarea>
                        ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                    </div>
                `;
            } else if (section.type === 'placeholder' || section.type === 'input') {
                const inputType = section.inputType || section.placeholderType || 'text';
                sectionHTML += `
                    <div class="form-group${section.fullWidth ? ' full-width' : ''}">
                        <label class="form-label${isRequired ? ' required' : ''}">${section.label || section.title || section.content}</label>
                        <input 
                            type="${inputType === 'number' ? 'number' : inputType === 'date' ? 'date' : inputType === 'email' ? 'email' : 'text'}" 
                            class="form-control" 
                            id="${fieldId}"
                            placeholder="${section.placeholder || section.content || ''}"
                            value="${section.defaultValue || ''}"
                            ${isRequired ? 'required' : ''}
                            ${isReadonly ? 'readonly' : ''}
                            ${inputType === 'number' && section.min ? `min="${section.min}"` : ''}
                            ${inputType === 'number' && section.max ? `max="${section.max}"` : ''}
                        >
                        ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                    </div>
                `;
            }

            sectionDiv.innerHTML = sectionHTML;
            formContainer.appendChild(sectionDiv);
        }

        // Create dynamic table field
        function createDynamicTableField(section, index, formContainer) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-section dynamic-template-section';
            sectionDiv.setAttribute('data-template-section', index);

            const fieldId = `template_table_${index}`;
            const headers = section.headers ? section.headers.split('|').map(h => h.trim()) : ['Column 1', 'Column 2'];

            let sectionHTML = `
                <h4><i class="fas fa-table"></i> ${section.title || `Template Table ${index + 1}`}</h4>
                <div class="form-group full-width">
                    <label class="form-label">${section.label || section.title || 'Table Data'}</label>
                    <div class="table-editor" id="${fieldId}">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    ${headers.map(header => `<th>${header}</th>`).join('')}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="${fieldId}_tbody">
                                <tr>
                                    ${headers.map(() => '<td><input type="text" class="form-control form-control-sm"></td>').join('')}
                                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeTableRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addTableRow('${fieldId}_tbody', ${headers.length})">Add Row</button>
                    </div>
                    ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                </div>
            `;

            sectionDiv.innerHTML = sectionHTML;
            formContainer.appendChild(sectionDiv);
        }

        // Create dynamic list field
        function createDynamicListField(section, index, formContainer) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-section dynamic-template-section';
            sectionDiv.setAttribute('data-template-section', index);

            const fieldId = `template_list_${index}`;
            const listItems = section.content ? section.content.split('\n').filter(item => item.trim()) : [''];

            let sectionHTML = `
                <h4><i class="fas fa-list"></i> ${section.title || `Template List ${index + 1}`}</h4>
                <div class="form-group full-width">
                    <label class="form-label">${section.label || section.title || 'List Items'}</label>
                    <div class="list-editor" id="${fieldId}">
                        <div id="${fieldId}_items">
            `;

            listItems.forEach((item, itemIndex) => {
                sectionHTML += `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="${item.trim()}" placeholder="List item">
                        <button type="button" class="btn btn-outline-danger" onclick="removeListItem(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });

            sectionHTML += `
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addListItem('${fieldId}_items')">Add Item</button>
                    </div>
                    ${section.description ? `<small class="form-text text-muted">${section.description}</small>` : ''}
                </div>
            `;

            sectionDiv.innerHTML = sectionHTML;
            formContainer.appendChild(sectionDiv);
        }

        // Helper functions for dynamic table management
        function addTableRow(tbodyId, columnCount) {
            const tbody = document.getElementById(tbodyId);
            const newRow = document.createElement('tr');
            
            let rowHTML = '';
            for (let i = 0; i < columnCount; i++) {
                rowHTML += '<td><input type="text" class="form-control form-control-sm"></td>';
            }
            rowHTML += '<td><button type="button" class="btn btn-sm btn-danger" onclick="removeTableRow(this)">Remove</button></td>';
            
            newRow.innerHTML = rowHTML;
            tbody.appendChild(newRow);
            
            // Make new inputs editable
            makeFormFieldsEditable();
        }

        function removeTableRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentElement;
            
            // Don't remove if it's the last row
            if (tbody.children.length > 1) {
                row.remove();
            } else {
                alert('At least one row must remain in the table.');
            }
        }

        // Helper functions for dynamic list management
        function addListItem(containerId) {
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = 'input-group mb-2';
            newItem.innerHTML = `
                <input type="text" class="form-control" placeholder="List item">
                <button type="button" class="btn btn-outline-danger" onclick="removeListItem(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(newItem);
            
            // Make new input editable
            makeFormFieldsEditable();
        }

        function removeListItem(button) {
            const item = button.closest('.input-group');
            const container = item.parentElement;
            
            // Don't remove if it's the last item
            if (container.children.length > 1) {
                item.remove();
            } else {
                alert('At least one item must remain in the list.');
            }
        }
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});
</script>
</body>
</html>

