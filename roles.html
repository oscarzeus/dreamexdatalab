<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Management - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .profile-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: border-color 0.2s ease;
        }

        .profile-btn:hover img {
            border-color: rgba(52, 152, 219, 0.5);
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .content-header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin: 0;
        }

        /* Button Styles */
        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-edit:hover {
            background-color: #2980b9;
        }

        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Hide menu items during loading until authorization is confirmed */
        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
                max-width: calc(100vw - 200px);
            }
            
            .top-nav {
                left: calc(200px + 0.5rem);
            }
            
            .top-nav-left {
                gap: 0.75rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 36px;
                height: 36px;
            }
            
            .content {
                max-width: calc(100vw - 200px - 1rem);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
                padding-top: 5rem;
            }
            
            .top-nav {
                left: 0.5rem;
                right: 0.5rem;
                padding: 0.75rem 1rem;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }
            
            .content {
                max-width: calc(100vw - 1rem);
            }
        }
        /* Enhanced Role Management Styles */        .content {
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: calc(100vh - 80px);
            width: 100%;
            max-width: calc(100vw - var(--sidebar-width) - 1rem);
            box-sizing: border-box;
            overflow-x: hidden;
            margin: 0 auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 18px 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(226, 232, 240, 0.5);
            color: white;
        }        .content-header h1 {
            margin: 0;
            color: white;
            font-size: 1.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-header h1::before {
            content: '\f505';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 1.4rem;
            filter: drop-shadow(0 2px 4px rgba(255, 255, 255, 0.3));
        }        .btn-create {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.25);
            text-decoration: none;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-create i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .btn-create:hover i {
            transform: rotate(90deg);
        }        .settings-section {
            background: transparent;
            padding: 0;
            width: 100%;
            max-width: 100%;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px 12px 0 0;
            border: 1px solid rgba(226, 232, 240, 0.5);
            border-bottom: none;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.06);
            margin-bottom: 0;
            width: 100%;
            max-width: 100%;
        }        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            outline: none;
        }

        .tab-button:focus {
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        .tab-button::before {
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tab-button.roles-tab::before {
            content: '\f0c0';
            color: #3b82f6;
        }

        .tab-button.permissions-tab::before {
            content: '\f023';
            color: #8b5cf6;
        }

        .tab-button:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #1e293b;
            transform: translateY(-1px);
        }

        .tab-button:hover::before {
            transform: scale(1.1);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .tab-button.active::before {
            color: white;
            transform: scale(1.1);
        }

        .tab-button.active:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ffffff, rgba(255, 255, 255, 0.8), #ffffff);
        }        .roles-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(226, 232, 240, 0.5);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
            height: calc(100vh - 220px);
            overflow: hidden;
            position: relative;
            width: 100%;
            max-width: 100%;
        }        /* Tab content */
        .tab-content {
            position: absolute;
            width: calc(100% - 40px);
            padding: 20px;
            height: calc(100% - 40px);
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 100%;
        }

        .tab-content.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .tab-content.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .tab-content::-webkit-scrollbar {
            width: 6px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            border-radius: 3px;
        }        .roles-list, .permissions-section {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
            overflow: visible;
            height: 100%;
        }        .roles-list h2, .permissions-section h2 {
            margin: 0 0 20px 0;
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .roles-list h2::before {
            content: '\f0c0';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #3b82f6;
            font-size: 1rem;
        }

        .permissions-section h2::before {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #8b5cf6;
            font-size: 1rem;
        }

        /* Table Styles - Matching staff.html */
        .roles-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 1rem;
        }

        .roles-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .roles-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .roles-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .roles-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .roles-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .roles-table tbody tr {
            transition: all 0.2s ease;
        }

        .role-name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .role-description-cell {
            color: #666;
            max-width: 300px;
        }

        .permissions-count-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            background: #e3f2fd;
            color: #1565c0;
        }

        .user-count-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .role-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn-action {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-edit {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn-edit:hover {
            background: #bbdefb;
            transform: translateY(-1px);
        }

        .btn-view {
            background: #e8f5e8;
            color: #2e7d2e;
        }

        .btn-view:hover {
            background: #d4edda;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #ffebee;
            color: #c62828;
        }

        .btn-delete:hover {
            background: #ffcdd2;
            transform: translateY(-1px);
        }

        .roles-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 320px);
            overflow-y: auto;
            padding-right: 8px;
        }

        .roles-grid::-webkit-scrollbar {
            width: 6px;
        }

        .roles-grid::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .roles-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            border-radius: 3px;
        }        .role-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 18px 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
        }

        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            opacity: 0;
            transition: opacity 0.3s ease;
        }        .role-card:hover {
            border-color: #3b82f6;
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.15);
        }

        .role-card:hover .role-info {
            transform: translateX(2px);
        }

        .role-card:hover .role-stats {
            transform: translateX(-2px);
        }

        .role-card:hover::before {
            opacity: 1;
        }

        .role-card:active {
            transform: translateY(-1px) scale(0.98);
        }

        .role-card.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .role-card.active::before {
            opacity: 1;
        }

        .role-card.updating {
            pointer-events: none;
            opacity: 0.7;
        }

        .role-card.updating::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }        .role-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 auto;
        }        .role-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
            transition: transform 0.3s ease;
        }

        .role-description {
            font-size: 0.9rem;
            color: #64748b;
            margin: 4px 0 0 0;
            line-height: 1.4;
        }

        .role-name::before {
            content: '\f2bd';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #3b82f6;
            font-size: 0.8rem;
        }        .role-stats {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.8rem;
            color: #64748b;
            flex: 0 0 auto;
            margin-left: 20px;
            transition: transform 0.3s ease;
        }

        .role-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .role-stat i {
            color: #3b82f6;
        }        .permissions-container {
            max-height: calc(100vh - 320px);
            overflow-y: auto;
            padding-right: 8px;
        }

        .permissions-container::-webkit-scrollbar {
            width: 6px;
        }

        .permissions-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }        .permissions-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            border-radius: 3px;
        }

        /* Permissions header and controls styles */
        .permissions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .permissions-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-dropdown {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-dropdown label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
        }

        .page-filter-dropdown {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .page-filter-dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .page-filter-dropdown:hover {
            border-color: #94a3b8;
        }.permission-section {
            margin-bottom: 18px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Enhanced permissions grid layout for wider modal */
        .permissions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .permissions-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        .permission-section {
            break-inside: avoid;
        }

        .permission-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .permission-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .permission-header h3::before {
            content: '\f0c9';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #8b5cf6;
            font-size: 0.9rem;
        }

        .permission-content {
            padding: 15px;
        }        .permission-group {
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #fefefe 0%, #f9fafb 100%);
            border: 1px solid #f1f5f9;
            border-radius: 6px;
        }

        .permission-group h4 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .permission-group h4::before {
            content: '\f0e8';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #6366f1;
            font-size: 0.8rem;
        }        .permission-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            align-items: center;
        }.checkbox-container {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
        }

        .checkbox-container:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .checkbox-container input[type="checkbox"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            position: relative;
            background: white;
            transition: all 0.3s ease;
        }

        .checkbox-container input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-color: #3b82f6;
        }

        .checkbox-container input[type="checkbox"]:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
        }        .checkbox-container span:last-child {
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
        }

        /* Modal Enhancements */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 1200px;
            width: 95%;
            max-height: 95vh;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }.modal-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            padding: 15px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }.modal-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }        .modal-body {
            padding: 25px 30px;
            max-height: calc(95vh - 160px);
            overflow-y: auto;
        }

        .form-grid {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 500;
            color: #374151;
            font-size: 0.85rem;
        }

        .required-field::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }        .form-group input,
        .form-group textarea {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .form-hint {
            font-size: 0.75rem;
            color: #64748b;
            font-style: italic;
        }        .modal-footer {
            padding: 15px 18px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        .modal-footer .btn:not(.btn-create) {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .modal-footer .btn:not(.btn-create):hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-1px);
        }

        /* Responsive Design */
        @media (max-width: 1600px) {
            .modal-content {
                max-width: 1100px;
            }
        }

        @media (max-width: 1400px) {
            .modal-content {
                max-width: 900px;
            }
        }

        @media (max-width: 1200px) {
            .modal-content {
                max-width: 800px;
            }
        }

        @media (max-width: 1200px) {
            .roles-container {
                height: calc(100vh - 220px);
            }

            .modal-content {
                max-width: 1000px;
            }

            .permission-options {
                grid-template-columns: repeat(4, 1fr);
            }

            .permissions-grid {
                grid-template-columns: 1fr;
            }
        }        @media (max-width: 768px) {
            .content-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                padding: 15px 18px;
            }

            .content-header h1 {
                font-size: 1.4rem;
            }

            .permissions-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .permissions-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .page-filter-dropdown {
                min-width: 100%;
            }

            .tab-button {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .tab-button::before {
                font-size: 0.8rem;
            }

            .roles-container {
                height: calc(100vh - 200px);
            }

            .tab-content {
                padding: 15px;
            }

            .permission-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .permissions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .modal-content {
                width: 98%;
                max-width: none;
                margin: 10px;
            }

            .modal-body {
                padding: 20px;
            }

            .role-card {
                padding: 15px 18px;
                flex-direction: column;
                align-items: flex-start;
                min-height: auto;
            }

            .role-info {
                margin-bottom: 12px;
            }

            .role-stats {
                margin-left: 0;
                gap: 15px;
            }            .role-stat {
                font-size: 0.75rem;
            }            .modal-content {
                margin: 15px;
                width: calc(100% - 30px);
            }

            .roles-grid {
                max-height: calc(100vh - 300px);
            }

            .permissions-container {
                max-height: calc(100vh - 300px);
            }
        }

        /* Animation for role selection */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .permission-section {
            animation: slideIn 0.3s ease-out;
        }

        /* Loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
        }

        .loading::before {
            content: '\f110';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }        .tab-button.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .tab-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            margin: 0 0 8px 0;
            color: #374151;
        }        .empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Additional responsive handling for very small screens */
        @media (max-width: 480px) {
            .permission-options {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .checkbox-container {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .modal-body {
                padding: 15px;
            }

            .permission-section {
                margin-bottom: 15px;
            }

            .modal-content {
                margin: 5px;
                width: calc(100% - 10px);
            }
        }        /* Role sections and enhanced cards */
        .roles-section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }

        .section-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #374151;
        }

        .section-badge.company {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .role-card.custom-role {
            border-left: 4px solid #3b82f6;
        }

        .role-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .role-actions .btn-edit,
        .role-actions .btn-delete {
            background: none;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .role-actions .btn-edit {
            color: #3b82f6;
        }

        .role-actions .btn-edit:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .role-actions .btn-delete {
            color: #ef4444;
        }

        .role-actions .btn-delete:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }


    </style>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Embedded Firebase Configuration -->
    <script>
        // Firebase v8 configuration for domain compatibility
        // This file provides v8 compatible Firebase functions for use across all pages

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully');
            }
            return window.firebase;
        }

        // Authentication functions using Firebase v8
        function loginWithEmail(email, password) {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        resolve(userCredential.user);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }

        function logoutUser() {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.signOut()
                    .then(() => {
                        resolve(true);
                    })
                    .catch((error) => {
                        console.error('Logout error:', error);
                        resolve(false);
                    });
            });
        }

        function resetPassword(email) {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        resolve({ success: true });
                    })
                    .catch((error) => {
                        resolve({ success: false, error: error.code });
                    });
            });
        }

        // Database functions using Firebase v8
        function getDatabase() {
            const firebase = initializeFirebase();
            return firebase.database();
        }

        function ref(database, path) {
            return database.ref(path);
        }

        function get(reference) {
            return reference.once('value');
        }

        function set(reference, value) {
            return reference.set(value);
        }

        function update(reference, values) {
            return reference.update(values);
        }

        function remove(reference) {
            return reference.remove();
        }

        function onValue(reference, callback, options = {}) {
            if (options.onlyOnce) {
                return reference.once('value', callback);
            } else {
                return reference.on('value', callback);
            }
        }

        // Initialize Firebase when this script is loaded
        initializeFirebase();
    </script>
    
    <!-- Embedded AuthManager Class -->
    <script>
        // CompanyDataService stub for compatibility
        const companyDataService = {
            initializeUserContext: async () => {
                // Stub implementation
                return Promise.resolve();
            },
            getCurrentCompanyId: () => {
                // Try to get company ID from current user
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                return currentUser.companyId || null;
            }
        };
        
        // Make it available globally for AuthManager
        window.companyDataService = companyDataService;

        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = getDatabase();
                this.currentCompany = null;
                
                // Initialize menu loading state
                this.initializeMenuLoading();
                
                this.initializeAuth();
            }

            initializeMenuLoading() {
                // Add menu-loading class to sidebar while permissions are loading
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.add('menu-loading');
                }
            }

            initializeAuth() {
                // Check if we're on the login page
                if (window.location.pathname.includes('login.html')) {
                    this.initializeLoginPage();
                } else if (window.location.pathname.includes('company-complete-registration.html')) {
                    // Skip authentication check for registration page
                    return;
                } else if (window.location.pathname.includes('approval-settings.html')) {
                    // Skip authentication check for approval-settings page - allow access to all users
                    console.log('Skipping authentication check for approval-settings.html');
                    // Still load user data if available, but don't require authentication
                    if (this.currentUser) {
                        this.loadUserRole(this.currentUser);
                        this.loadUserCompany();
                    }
                    this.updateUIForAuthenticatedUser();
                    return;
                } else {
                    // Check if user is logged in
                    if (!this.currentUser) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Check page access permissions
                    this.checkPageAccess().then(hasAccess => {
                        if (!hasAccess) {
                            console.warn('Page access denied, redirecting to unauthorized.html');
                            window.location.href = 'unauthorized.html';
                            return;
                        }
                        
                        this.loadUserRole(this.currentUser);
                        this.loadUserCompany();
                        this.updateUIForAuthenticatedUser();
                    }).catch(error => {
                        console.error('Error checking page access:', error);
                        window.location.href = 'unauthorized.html';
                    });
                }
            }

            async loadUserCompany() {
                if (!this.currentUser) return;

                try {
                    // Get user's company information from company data service
                    if (window.companyDataService) {
                        await window.companyDataService.initializeUserContext();
                        const companyId = window.companyDataService.getCurrentCompanyId();
                        
                        if (companyId) {
                            // Load company data
                            const companyRef = ref(this.db, `companies/${companyId}`);
                            const companySnapshot = await get(companyRef);
                            
                            if (companySnapshot.exists()) {
                                this.currentCompany = companySnapshot.val();
                                this.updateCompanyBranding();
                            }
                        } else {
                            console.warn('No company context found for user');
                        }
                    } else {
                        console.warn('Company data service not available');
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }

            updateCompanyBranding() {
                console.log('🏢 updateCompanyBranding() called');
                if (!this.currentCompany) {
                    console.log('❌ No company data available for branding');
                    this.showFallbackBranding();
                    return;
                }

                console.log('✅ Company data found:', this.currentCompany.companyName);

                // Update company logo and name in header
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');

                console.log('Header elements found:', {
                    logo: headerLogo ? '✅' : '❌',
                    placeholder: headerLogoPlaceholder ? '✅' : '❌',
                    companyName: headerCompanyName ? '✅' : '❌'
                });

                // Update company name
                if (headerCompanyName) {
                    headerCompanyName.textContent = this.currentCompany.companyName || '';
                    console.log('✅ Company name updated:', headerCompanyName.textContent);
                }

                // Update logo or show placeholder
                if (this.currentCompany.logoUrl || this.currentCompany.logo) {
                    const logoUrl = this.currentCompany.logoUrl || this.currentCompany.logo;
                    console.log('✅ Company logo URL found:', logoUrl);
                    
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log('✅ Company logo displayed');
                    }
                    
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'none';
                        console.log('✅ Logo placeholder hidden');
                    }
                } else {
                    console.log('ℹ️ No company logo URL, showing placeholder');
                    // Show placeholder if no logo
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                        console.log('✅ Logo placeholder shown');
                    }
                    
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        console.log('✅ Company logo hidden');
                    }
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab HSE')) {
                    document.title = title.replace('Dreamex Datalab HSE', `${this.currentCompany.companyName} HSE`);
                    console.log('✅ Page title updated');
                }
            }

            showFallbackBranding() {
                console.log('🏢 Showing fallback branding');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');
                const headerLogo = document.getElementById('headerCompanyLogo');
                
                // Show placeholder logo
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'flex';
                    console.log('✅ Fallback logo placeholder shown');
                }
                
                // Hide company logo
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    console.log('✅ Company logo hidden (fallback)');
                }
                
                // Set fallback company name
                if (headerCompanyName) {
                    headerCompanyName.textContent = '';
                    console.log('✅ Fallback company name cleared');
                }
            }

            async checkPageAccess() {
                const currentPath = window.location.pathname;
                const userRole = this.currentUser?.role;

                // Public pages accessible to all authenticated users
                const publicPages = ['/index.html', '/account.html', '/profile.html', '/unauthorized.html', '/company-complete-registration.html'];
                if (publicPages.some(page => currentPath.includes(page))) {
                    return true;
                }

                // Role management page - accessible to authenticated users without company check
                if (currentPath.includes('/roles.html')) {
                    console.log('Granting access to roles page for authenticated user');
                    return true;
                }

                // Check if user has company access by checking Firebase directly
                const hasCompanyAccess = await this.checkUserCompanyAccess();
                if (!hasCompanyAccess) {
                    console.warn('User does not have company access - no valid company association found');
                    return false;
                }

                // Company management pages accessible to all company users
                const companyPages = ['/dashboard.html', '/companyboard.html', '/tasks.html', '/companymanagement.html', '/settings.html', '/staff.html', '/recruitboard.html', '/jobdetails.html', '/jobpost.html', '/jobscreen.html', '/interview.html'];
                if (companyPages.some(page => currentPath.includes(page))) {
                    console.log('Granting access to company page:', currentPath);
                    return true;
                }


                // Check role-specific permissions from Firebase for other pages
                const roleRef = ref(this.db, `roles/${userRole}/permissions`);
                return new Promise((resolve) => {
                    onValue(roleRef, (snapshot) => {
                        const permissions = snapshot.val() || {};
                        const allowedPages = permissions.pages || [];
                        
                        // Check if current page is in allowed pages
                        const isAllowed = allowedPages.some(page => 
                            currentPath.includes(page.toLowerCase())
                        );
                        
                        console.log('Role-based access check for', currentPath, ':', isAllowed);
                        resolve(isAllowed);
                    }, {
                        onlyOnce: true
                    });
                });
            }

            async checkUserCompanyAccess() {
                if (!this.currentUser) return false;

                try {
                    // Wait for company data service to be available (with timeout)
                    let retries = 0;
                    const maxRetries = 20; // 10 seconds total
                    while (!window.companyDataService && retries < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        retries++;
                    }
                    
                    // Get user's company information from company data service
                    if (window.companyDataService) {
                        await window.companyDataService.initializeUserContext();
                        const companyId = window.companyDataService.getCurrentCompanyId();
                        
                        if (!companyId) {
                            console.warn('User not associated with any company');
                            return false;
                        }

                        // Verify company exists and is active
                        const companyRef = ref(this.db, `companies/${companyId}`);
                        const companySnapshot = await get(companyRef);
                        
                        if (!companySnapshot.exists()) {
                            console.warn('Associated company not found');
                            return false;
                        }

                        const companyData = companySnapshot.val();
                        
                        if (companyData.status !== 'active') {
                            console.warn('Company is not active');
                            return false;
                        }

                        return true;
                    } else {
                        console.warn('Company data service not available after waiting');
                        return false;
                    }
                } catch (error) {
                    console.error('Error checking company access:', error);
                    return false;
                }
            }

            async checkSpecificPermission(permissionName) {
                if (!this.currentUser) {
                    console.warn('No current user found for permission check');
                    return false;
                }

                const userRole = this.currentUser.role;
                if (!userRole) {
                    console.warn('No role found for current user');
                    return false;
                }

                try {
                    // Check if user has the specific permission through their role
                    const roleRef = ref(this.db, `roles/${userRole}/permissions`);
                    const roleSnapshot = await get(roleRef);
                    
                    if (!roleSnapshot.exists()) {
                        console.warn(`Role ${userRole} permissions not found`);
                        return false;
                    }

                    const permissions = roleSnapshot.val();
                    const hasPermission = permissions && permissions[permissionName] === true;
                    
                    console.log(`Permission check for ${permissionName}:`, hasPermission, 'for role:', userRole);
                    console.log('Available permissions for role:', userRole, Object.keys(permissions || {}));
                    
                    return hasPermission;
                } catch (error) {
                    console.error('Error checking specific permission:', error);
                    return false;
                }
            }

            getCurrentUser() {
                // First check for 'currentUser' key (used by main login system)
                let user = localStorage.getItem('currentUser');
                if (user) {
                    return JSON.parse(user);
                }
                
                // If not found, check for 'user' key (used by index.html modal login)
                user = localStorage.getItem('user');
                if (user) {
                    const userData = JSON.parse(user);
                    // Migrate the user data to the standard 'currentUser' key for consistency
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    return userData;
                }
                
                return null;
            }

            setCurrentUser(userData) {
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('user', JSON.stringify(userData)); // For consistency with index.html
                this.currentUser = userData;
            }

            async logout() {
                const success = await logoutUser();
                if (success) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user'); // Clear both keys
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    window.roleManager?.setRole(null);
                    window.location.href = 'login.html';
                }
            }

            async loadUserRole(userData) {
                if (!userData || !userData.role) return;

                try {
                    let roleData = null;
                    
                    // First try to load from company-scoped roles if company ID is available
                    if (userData.companyId || this.currentUser?.companyId) {
                        const companyId = userData.companyId || this.currentUser?.companyId;
                        const companyRoleRef = ref(this.db, `companies/${companyId}/roles/${userData.role}`);
                        const companyRoleSnapshot = await get(companyRoleRef);
                        
                        if (companyRoleSnapshot.exists()) {
                            roleData = companyRoleSnapshot.val();
                            console.log('✅ Loaded company-scoped role:', roleData.name || userData.role);
                        }
                    }
                    
                    // Fallback to global roles if company role not found
                    if (!roleData) {
                        const globalRoleRef = ref(this.db, `roles/${userData.role}`);
                        const globalRoleSnapshot = await get(globalRoleRef);
                        
                        if (globalRoleSnapshot.exists()) {
                            roleData = globalRoleSnapshot.val();
                            console.log('✅ Loaded global role:', roleData.name || userData.role);
                        }
                    }
                    
                    // Set the role in role manager if available
                    if (roleData && window.roleManager?.setRole) {
                        window.roleManager.setRole(roleData);
                    }
                    
                    return roleData;
                    
                } catch (error) {
                    console.error('❌ Error loading user role:', error);
                    
                    // Fallback to original method for backwards compatibility
                    const roleRef = ref(this.db, `roles/${userData.role}`);
                    return new Promise((resolve, reject) => {
                        onValue(roleRef, (snapshot) => {
                            const roleData = snapshot.val();
                            if (roleData) {
                                window.roleManager?.setRole(roleData);
                            }
                            resolve(roleData);
                        }, {
                            onlyOnce: true
                        });
                    });
                }
            }

            async updateUIForAuthenticatedUser() {
                const profileBtn = document.querySelector('.profile-btn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();
                        
                        // Update profile image
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            // Try to get custom avatar or use initials
                            const avatarUrl = await this.getUserAvatarUrl();
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Update profile dropdown with user info
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                        ${initials}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="#"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        `;
                        
                        profileDropdown.innerHTML = userInfoHtml;
                        
                        // Re-attach logout event listener
                        const logoutBtn = profileDropdown.querySelector('a[href="#"]');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                this.logout();
                            });
                        }
                        
                        // Update menu visibility based on user permissions
                        await this.updateMenuVisibility();
                    }
                }
                
                // Update other user display elements on the page
                this.updateUserProfileDisplay();
            }

            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Menu visibility methods
            resetMenuVisibility() {
                // Check if we have authenticated user data before preserving core features
                const hasAuthenticatedUser = this.currentUser && 
                                            this.currentUser.companyId &&
                                            this.currentUser.role;
                
                if (hasAuthenticatedUser) {
                    // Define core features that should remain visible for authenticated users
                    const coreFeatures = ['home_view', 'health_view', 'environment_view', 'settings_view'];
                    
                    document.querySelectorAll('[data-feature]').forEach(item => {
                        const feature = item.getAttribute('data-feature');
                        // Only preserve core features for authenticated users
                        if (!coreFeatures.includes(feature)) {
                            item.classList.remove('menu-visible');
                        } else {
                            // Ensure core features stay visible for authenticated users
                            item.classList.add('menu-visible');
                            console.log('🔒 AuthManager: Preserving core feature visibility for authenticated user:', feature);
                        }
                    });
                    
                    // For dropdowns, check if they contain core features
                    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                        const feature = dropdown.getAttribute('data-feature');
                        if (!coreFeatures.includes(feature)) {
                            dropdown.classList.remove('menu-visible');
                        } else {
                            // Ensure core dropdown features stay visible for authenticated users
                            dropdown.classList.add('menu-visible');
                            console.log('🔒 AuthManager: Preserving core dropdown visibility for authenticated user:', feature);
                        }
                    });
                } else {
                    // No authenticated user - hide everything
                    console.log('⚠️ AuthManager: No authenticated user - hiding all menu items');
                    document.querySelectorAll('[data-feature]').forEach(item => {
                        item.classList.remove('menu-visible');
                    });
                    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('menu-visible');
                    });
                }
            }

            async updateMenuVisibility() {
                console.log('🔧 Starting menu visibility update with feature-first priority...');
                
                // Remove loading class
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                try {
                    if (!this.currentUser) {
                        console.log('❌ No authenticated user found');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    // Get user's company ID and role
                    const companyId = this.currentUser.companyId;
                    const userRole = this.currentUser.role;
                    
                    if (!companyId || !userRole) {
                        console.log('❌ Missing company ID or user role');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                    
                    // PRIORITY 1: Feature-based authorization (takes precedence)
                    console.log('🎯 Applying feature-based authorization first (has priority)...');
                    try {
                        await updateMenuWithFeatureAuthorization();
                        console.log('✅ Feature-based authorization applied successfully');
                        return; // Exit early - feature authorization has handled menu visibility
                    } catch (error) {
                        console.error('❌ Feature-based authorization failed, falling back to role permissions:', error);
                    }
                    
                    // FALLBACK: Role-based permissions (only if feature-based fails)
                    console.log('🔄 Falling back to role-based permissions...');
                    
                    // Get company role permissions
                    const permissionsRef = ref(this.db, `companies/${companyId}/roles/${userRole}/permissions`);
                    console.log(`🔍 Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                    
                    const permissionsSnapshot = await get(permissionsRef);
                    
                    if (!permissionsSnapshot.exists()) {
                        console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                        
                        // Try to get all roles to see what's available
                        const allRolesRef = ref(this.db, `companies/${companyId}/roles`);
                        const allRolesSnapshot = await get(allRolesRef);
                        
                        if (allRolesSnapshot.exists()) {
                            const allRoles = allRolesSnapshot.val();
                            console.log('🔍 Available roles in company:', Object.keys(allRoles));
                            
                            // Enhanced debugging for administrator role
                            if (userRole === 'administrator') {
                                console.log('🔑 ADMINISTRATOR - Full roles data:', allRoles);
                                if (allRoles.administrator) {
                                    console.log('🔑 ADMINISTRATOR role found in company:', allRoles.administrator);
                                    if (allRoles.administrator.permissions) {
                                        console.log('🔑 ADMINISTRATOR permissions found:', allRoles.administrator.permissions);
                                        this.updateMenuWithPermissions(allRoles.administrator.permissions);
                                        return;
                                    }
                                }
                            }
                            
                            // Check if the role exists with different casing or format
                            const roleKeys = Object.keys(allRoles);
                            const matchingRole = roleKeys.find(key => 
                                key.toLowerCase() === userRole.toLowerCase() ||
                                key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                            );
                            
                            if (matchingRole && allRoles[matchingRole].permissions) {
                                console.log(`✅ Found matching role: ${matchingRole}`);
                                const permissions = allRoles[matchingRole].permissions;
                                this.updateMenuWithPermissions(permissions);
                                return;
                            }
                        }
                        
                        console.log('❌ No valid permissions found - hiding all menu items');
                        
                        // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                        if (userRole === 'administrator') {
                            console.log('🔑 ADMINISTRATOR FALLBACK - Granting full permissions');
                            const fullAdminPermissions = this.createDefaultAdministratorRole().permissions;
                            this.updateMenuWithPermissions(fullAdminPermissions);
                            return;
                        }
                        
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const permissions = permissionsSnapshot.val();
                    console.log('✅ Loaded permissions:', permissions);
                    
                    // Special handling for administrator role - ensure they have comprehensive permissions
                    if (userRole === 'administrator') {
                        console.log('🔑 ADMINISTRATOR - Ensuring full permissions access');
                        if (!permissions || Object.keys(permissions).length < 10) {
                            console.log('🔑 ADMINISTRATOR - Insufficient permissions found, using full admin permissions');
                            const fullAdminPermissions = this.createDefaultAdministratorRole().permissions;
                            this.updateMenuWithPermissions(fullAdminPermissions);
                            return;
                        }
                    }
                    
                    this.updateMenuWithPermissions(permissions);
                    
                } catch (error) {
                    console.error('❌ Error updating menu visibility:', error);
                    this.resetMenuVisibility();
                }
            }

            updateMenuWithPermissions(permissions) {
                console.log('🎯 Updating menu with permissions...');
                console.log('🎯 Permissions object:', permissions);
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!permissions) {
                    console.log('⚠️ No permissions object provided');
                    return;
                }
                
                // Update menu visibility based on permissions
                const menuItems = document.querySelectorAll('[data-feature]');
                console.log(`🎯 Found ${menuItems.length} menu items to check`);
                let visibleCount = 0;
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    
                    console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission})`);
                    
                    // If item doesn't require permission, show it
                    if (!requiresPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item (no permission required): ${feature}`);
                        return;
                    }
                    
                    // If item requires permission, check if user has it
                    if (requiresPermission && permissions[requiresPermission]) {
                        const hasViewPermission = permissions[requiresPermission].view === true || permissions[requiresPermission] === true;
                        
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature} (permission: ${requiresPermission})`);
                        } else {
                            console.log(`❌ No view permission for: ${feature} (permission: ${requiresPermission})`);
                        }
                    } else {
                        console.log(`⚪ Required permission not found: ${requiresPermission} for feature: ${feature}`);
                    }
                });
                
                // Handle parent dropdowns - show if they have visible children
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    if (visibleSubmenuItems.length > 0) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing parent dropdown (has visible children)`);
                    }
                });
                
                console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
                
                // If no items are visible, show at least home
                if (visibleCount === 0) {
                    const homeItem = document.querySelector('[data-feature="home_view"]');
                    if (homeItem) {
                        homeItem.classList.add('menu-visible');
                        console.log('⚠️ No permissions found - showing home as fallback');
                    }
                }
            }

            // Get user display name with consistent fallback logic
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                // Helper function to clean and validate name
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return null;
                    
                    // Remove unwanted patterns (system-generated usernames, IDs, etc.)
                    const unwantedPatterns = [
                        /^standard_[a-z0-9]+$/i,        // standard_mcz5jhe4
                        /^[a-z0-9]{8,}$/i,              // random strings of 8+ chars
                        /^user_[a-z0-9]+$/i,            // user_something
                        /^[0-9]+$/,                     // pure numbers
                        /dreamex/i,                     // company name fragments
                        /^[a-z]{2,3}_[a-z0-9]+$/i      // prefix_random patterns
                    ];
                    
                    const cleanedName = name.trim();
                    
                    // Check if name matches any unwanted pattern
                    if (unwantedPatterns.some(pattern => pattern.test(cleanedName))) {
                        return null;
                    }
                    
                    // Must be at least 2 characters and contain at least one letter
                    if (cleanedName.length < 2 || !/[a-zA-Z]/.test(cleanedName)) {
                        return null;
                    }
                    
                    return cleanedName;
                };
                
                // Try each potential name source in order of preference
                const potentialNames = [
                    this.currentUser.name,
                    this.currentUser.displayName,
                    this.currentUser.firstName && this.currentUser.lastName ? 
                        this.currentUser.firstName + ' ' + this.currentUser.lastName : null,
                    this.currentUser.firstName,
                    this.currentUser.lastName
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                // Final fallback to email username (but clean it too)
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Get user role
            getUserRole() {
                return this.currentUser?.role || 'User';
            }

            // Get user department
            getUserDepartment() {
                return this.currentUser?.department || '';
            }

            // Get user company information
            getUserCompany() {
                return {
                    id: this.currentUser?.companyId,
                    name: this.currentUser?.companyName
                };
            }

            // Get user avatar URL or initials
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    // No custom avatar found
                    return null;
                }
            }

            // Update user avatar display with custom image or initials
            async updateUserAvatarDisplay(elementId = 'userAvatarInitials') {
                const avatarElement = document.getElementById(elementId);
                if (avatarElement) {
                    try {
                        const avatarUrl = await this.getUserAvatarUrl();
                        if (avatarUrl) {
                            // Show custom avatar
                            avatarElement.innerHTML = `<img src="${avatarUrl}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                        } else {
                            // Show initials
                            avatarElement.textContent = this.getUserInitials();
                        }
                    } catch (error) {
                        // Fallback to initials
                        avatarElement.textContent = this.getUserInitials();
                    }
                }
            }

            // Update user avatar initials on page
            updateUserAvatarInitials(elementId = 'userAvatarInitials') {
                const avatarElement = document.getElementById(elementId);
                if (avatarElement) {
                    avatarElement.textContent = this.getUserInitials();
                }
            }

            // Update user profile display elements
            async updateUserProfileDisplay() {
                // Update avatar displays with custom images or initials
                await this.updateUserAvatarDisplay();
                await this.updateUserAvatarDisplay('userInitials'); // Alternative ID used in some pages
                
                // Update user name displays
                const userNameElements = document.querySelectorAll('#userName, #userDisplayName, .user-name-display');
                userNameElements.forEach(element => {
                    element.textContent = this.getUserDisplayName();
                });
                
                // Update user email displays
                const userEmailElements = document.querySelectorAll('#userEmail, #userDisplayEmail, .user-email-display');
                userEmailElements.forEach(element => {
                    element.textContent = this.getUserEmail();
                });
                
                // Update user role displays
                const userRoleElements = document.querySelectorAll('#userRole, .user-role-display');
                userRoleElements.forEach(element => {
                    element.textContent = this.getUserRole();
                });
            }
        }

        // Initialize authentication manager
        const authManager = new AuthManager();

        // Export for use in other modules
        window.authManager = authManager;
    </script>
    
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                            <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <!-- Workspaces: Catering -->
                <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                    <a href="#"><i class="fas fa-utensils"></i> Workspaces — Catering</a>
                    <ul class="submenu">
                        <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                        <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                        <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                        <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                        <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                        <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html"><i class="fas fa-coins"></i> Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <!-- Project Management as section button with submenu -->
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <div class="content-header">
                    <h1>Roles & Permissions</h1>
                    <button id="createRoleBtn" class="btn btn-create">
                        <i class="fas fa-plus"></i>
                        Create New Role
                    </button>
                </div>                <div class="settings-section">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-button roles-tab active" data-tab="roles">
                            <i class="fas fa-users"></i>
                            Available Roles
                        </button>
                        <button class="tab-button permissions-tab" data-tab="permissions">
                            <i class="fas fa-key"></i>
                            Permissions
                        </button>
                        <button class="tab-button users-tab" data-tab="users">
                            <i class="fas fa-user-friends"></i>
                            Users
                        </button>
                    </div>

                    <div class="roles-container">
                        <!-- Roles Tab Content -->
                        <div id="rolesTab" class="tab-content active">
                            <div class="roles-list">
                                <h2>Available Roles</h2>
                                
                                <!-- Roles Table -->
                                <div class="roles-table-container">
                                    <div style="overflow-x: auto;">
                                        <table class="roles-table" id="rolesTable">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAllRolesCheckbox" onchange="toggleSelectAllRoles()">
                                                    </th>
                                                    <th>Role Name</th>
                                                    <th>Description</th>
                                                    <th>Permissions</th>
                                                    <th>Users</th>
                                                    <th>Created</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rolesTableBody">
                                                <!-- Dynamic content will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Empty State -->
                                <div class="empty-state" id="rolesEmptyState" style="display: none;">
                                    <i class="fas fa-users-slash"></i>
                                    <h3>No Roles Available</h3>
                                    <p>Create your first role to get started with role management.</p>
                                </div>
                            </div>
                        </div>                        <!-- Permissions Tab Content -->
                        <div id="permissionsTab" class="tab-content">
                            <div class="permissions-section">
                                <div class="permissions-header">
                                    <h2>Role Permissions</h2>
                                    <div class="permissions-controls">
                                        <div class="filter-dropdown">
                                            <label for="pageFilter">Filter by Page:</label>
                                            <select id="pageFilter" class="page-filter-dropdown">
                                                <option value="all">All Pages/Modules</option>
                                                <option value="home">Home</option>
                                                <option value="health">Health</option>
                                                <option value="safety">Safety</option>
                                                <option value="investigation">Investigation</option>
                                                <option value="fuel">Fuel Management</option>
                                                <option value="environment">Environment</option>
                                                <option value="security">Security</option>
                                                <option value="logistics">Logistics</option>
                                                <option value="hr">HR</option>
                                                <option value="project">Project</option>
                                                <option value="catering">Catering / Meals</option>
                                                <option value="settings">Settings</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div id="permissionsContainer" class="permissions-container">
                                    <!-- Settings Section -->
                                    <div class="permission-section">
                                        <div class="permission-header">
                                            <h3>Settings</h3>
                                        </div>
                                        <div class="permission-content">
                                            <!-- Company Management -->
                                            <div class="permission-group">
                                                <h4>Company Management</h4>
                                                <div class="permission-options">
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="company_management_view">
                                                        <span class="checkmark"></span>
                                                        <span>View</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="company_management_create">
                                                        <span class="checkmark"></span>
                                                        <span>Create</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="company_management_edit">
                                                        <span class="checkmark"></span>
                                                        <span>Edit</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="company_management_delete">
                                                        <span class="checkmark"></span>
                                                        <span>Delete</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Profile Management -->
                                            <div class="permission-group">
                                                <h4>Profile Management</h4>
                                                <div class="permission-options">
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="profile_view">
                                                        <span class="checkmark"></span>
                                                        <span>View</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="profile_edit">
                                                        <span class="checkmark"></span>
                                                        <span>Edit</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Safety Management -->
                                            <div class="permission-group">
                                                <h4>Safety Management</h4>
                                                <div class="permission-options">
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="safety_view">
                                                        <span class="checkmark"></span>
                                                        <span>View</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="safety_create">
                                                        <span class="checkmark"></span>
                                                        <span>Create</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="safety_edit">
                                                        <span class="checkmark"></span>
                                                        <span>Edit</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="safety_delete">
                                                        <span class="checkmark"></span>
                                                        <span>Delete</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- User Management -->
                                            <div class="permission-group">
                                                <h4>User Management</h4>
                                                <div class="permission-options">
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="user_management_view">
                                                        <span class="checkmark"></span>
                                                        <span>View</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="user_management_create">
                                                        <span class="checkmark"></span>
                                                        <span>Create</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="user_management_edit">
                                                        <span class="checkmark"></span>
                                                        <span>Edit</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="user_management_delete">
                                                        <span class="checkmark"></span>
                                                        <span>Delete</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- HR Management -->
                                            <div class="permission-group">
                                                <h4>HR Management</h4>
                                                <div class="permission-options">
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="hr_view">
                                                        <span class="checkmark"></span>
                                                        <span>View HR</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_view">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - View</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_create">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - Create</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_edit">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - Edit</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_delete">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - Delete</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_export">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - Export</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_import">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - Import</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="salary_management_view">
                                                        <span class="checkmark"></span>
                                                        <span>Salary Management - View</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="salary_management_create">
                                                        <span class="checkmark"></span>
                                                        <span>Salary Management - Create</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="salary_management_edit">
                                                        <span class="checkmark"></span>
                                                        <span>Salary Management - Edit</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="salary_management_delete">
                                                        <span class="checkmark"></span>
                                                        <span>Salary Management - Delete</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="salary_management_export">
                                                        <span class="checkmark"></span>
                                                        <span>Salary Management - Export</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="staff_management_import">
                                                        <span class="checkmark"></span>
                                                        <span>Staff Management - Import</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="authority_to_recruit_view">
                                                        <span class="checkmark"></span>
                                                        <span>Authority to Recruit</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="job_advertising_view">
                                                        <span class="checkmark"></span>
                                                        <span>Job Advertising</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="screening_view">
                                                        <span class="checkmark"></span>
                                                        <span>Screening</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="interview_view">
                                                        <span class="checkmark"></span>
                                                        <span>Interview</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="hiring_view">
                                                        <span class="checkmark"></span>
                                                        <span>Hiring Management</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="offer_view">
                                                        <span class="checkmark"></span>
                                                        <span>Offer Management</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="contract_view">
                                                        <span class="checkmark"></span>
                                                        <span>Contract Management</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="onboarding_view">
                                                        <span class="checkmark"></span>
                                                        <span>Onboarding</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Project Management -->
                                            <div class="permission-group">
                                                <h4>Project Management</h4>
                                                <div class="permission-options">
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="project_dashboard">
                                                        <span class="checkmark"></span>
                                                        <span>Dashboard</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="project_list">
                                                        <span class="checkmark"></span>
                                                        <span>List</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="project_reports">
                                                        <span class="checkmark"></span>
                                                        <span>Reports</span>
                                                    </label>
                                                    <label class="checkbox-container">
                                                        <input type="checkbox" data-permission="project_create">
                                                        <span class="checkmark"></span>
                                                        <span>Create</span>
                                                    </label>
                                                </div>
                                            </div>
                            </div>
                        </div>
                        <!-- Users Tab Content -->
                        <div id="usersTab" class="tab-content">
                            <div class="permissions-section">
                                <div class="permissions-header">
                                    <h2 id="usersTabTitle"><i class="fas fa-user-friends"></i> Users in Role</h2>
                                    <div class="permissions-controls">
                                        <div class="filter-dropdown">
                                            <label for="usersSearch">Search</label>
                                            <input id="usersSearch" type="text" placeholder="Search by name or email" class="page-filter-dropdown" style="padding:8px 12px;">
                                        </div>
                                    </div>
                                </div>
                                <div class="roles-table-container" style="margin-top:0;">
                                    <div style="overflow-x:auto;">
                                        <table class="roles-table" id="usersByRoleTable">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Role</th>
                                                </tr>
                                            </thead>
                                            <tbody id="usersByRoleBody">
                                                <!-- Users will render here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="empty-state" id="usersByRoleEmpty" style="display:none;">
                                    <i class="fas fa-user-slash"></i>
                                    <h3>No users found for this role</h3>
                                    <p>Assign this role to users in your company to see them here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Modal -->
            <div id="roleModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">Create New Role</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="roleForm" class="form-grid">
                            <div class="form-group full-width">
                                <label for="roleName" class="required-field">Role Name</label>
                                <input type="text" id="roleName" name="roleName" required>
                                <small class="form-hint">Enter a unique name for the role</small>
                            </div>
                            <div class="form-group full-width">
                                <label for="roleDescription">Description</label>
                                <textarea id="roleDescription" name="roleDescription" rows="3"></textarea>
                                <small class="form-hint">Briefly describe the role's purpose and responsibilities</small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" id="cancelBtn">Cancel</button>
                        <button type="button" class="btn btn-create" id="saveRoleBtn">Create Role</button>
                    </div>
                </div>
            </div>
        </main>
    </div>    
    
    <!-- Embedded Role Management JavaScript -->
    <script>
        // RoleManager class - adapted for embedded Firebase v8
        class RoleManager {
            constructor() {
                this.db = getDatabase();
                this.roles = [];
                this.currentRole = null;
                // Cache of users within the current company scope for fast per-role counts
                this.companyUsers = {};
                this.standardPermissions = ['view', 'create', 'edit', 'delete', 'export'];
                this.features = {
                    home_view: { name: 'Home', actions: ['view'] },
                    // Investigation module
                    investigation_view: { name: 'Investigation', actions: ['view'] },
                    investigation_dashboard_view: { name: 'Investigation Dashboard', actions: this.standardPermissions },
                    investigation_list_view: { name: 'Investigation List', actions: this.standardPermissions },
                    create_investigation_view: { name: 'Create Investigation', actions: this.standardPermissions },
                    health_view: { name: 'Health', actions: this.standardPermissions },
                    health_assessment_view: { name: 'Health Assessment', actions: this.standardPermissions },
                    health_consultation_view: { name: 'Health Consultation', actions: this.standardPermissions },
                    medical_folder_view: { name: 'Medical Folder', actions: this.standardPermissions },
                    safety_view: { name: 'Safety', actions: this.standardPermissions },
                    training_view: { name: 'Training', actions: this.standardPermissions },
                    risk_view: { name: 'Risk Management', actions: this.standardPermissions },
                    risk_register_view: { name: 'Risk Register', actions: this.standardPermissions },
                    jsa_view: { name: 'Job Safety Analysis', actions: this.standardPermissions },
                    ptw_view: { name: 'Permit to Work', actions: this.standardPermissions },
                    incident_view: { name: 'Incident Reports', actions: this.standardPermissions },
                    inspection_view: { name: 'Inspection', actions: this.standardPermissions },
                    audit_view: { name: 'Audit', actions: this.standardPermissions },
                    audit_log_view: { name: 'Audit Log', actions: ['view', 'export'] },
                    environment_view: { name: 'Environment', actions: this.standardPermissions },
                    water_view: { name: 'Water Quality', actions: this.standardPermissions },
                    // Fuel Management Features
                    fuel_management: { name: 'Fuel Management', actions: ['view'] },
                    vessel_offloading: { name: 'Vessel Offloading', actions: this.standardPermissions },
                    fuel_storage: { name: 'Fuel Storage Status', actions: this.standardPermissions },
                    tank_transfer: { name: 'Tank-to-Tank Transfer', actions: this.standardPermissions },
                    truck_loading: { name: 'Fuel Truck Loading', actions: this.standardPermissions },
                    quality_analysis: { name: 'Fuel Quality Analysis', actions: this.standardPermissions },
                    fuel_distribution: { name: 'Fuel Distribution', actions: this.standardPermissions },
                    fuel_consumption_analysis: { name: 'Fuel Consumption Analysis', actions: this.standardPermissions },
                    fuel_daily_report: { name: 'Daily Fuel Report', actions: this.standardPermissions },
                    security_view: { name: 'Security', actions: this.standardPermissions },
                    access_view: { name: 'Access Request', actions: this.standardPermissions },
                    access_daily_view: { name: 'Daily Access Control', actions: [...this.standardPermissions, 'view_attachments'] },
                    removal_view: { name: 'Property Removal', actions: this.standardPermissions },
                    security_site_map_view: { name: 'Security Site Map', actions: this.standardPermissions },
                    security_level_evaluation_view: { name: 'Security Level Evaluation', actions: this.standardPermissions },
                    logistics_view: { name: 'Logistics', actions: this.standardPermissions },
                    fleet_view: { name: 'Fleet Management', actions: this.standardPermissions },
                    travel_view: { name: 'Travel Requests', actions: this.standardPermissions },
                    accommodation_view: { name: 'Accommodation', actions: this.standardPermissions },
                    camp_view: { name: 'Camp Management', actions: this.standardPermissions },
                    camp_settings_view: { name: 'Camp Settings', actions: this.standardPermissions },
                    lms_view: { name: 'Learning Management System', actions: this.standardPermissions },
                    // HR Management Features
                    hr_view: { name: 'HR Management', actions: ['view'] },
                    staff_management_view: { name: 'Staff Management', actions: [...this.standardPermissions, 'approve', 'import'] },
                    salary_management_view: { name: 'Salary Management', actions: [...this.standardPermissions, 'export'] },
                    // Payroll Management Features
                    payroll_view: { name: 'Payroll', actions: ['view'] },
                    timesheets_view: { name: 'Timesheets', actions: this.standardPermissions },
                    payroll_runs_view: { name: 'Payroll Runs', actions: this.standardPermissions },
                    pay_elements_view: { name: 'Pay Elements', actions: this.standardPermissions },
                    tax_deductions_view: { name: 'Tax & Deductions', actions: this.standardPermissions },
                    overtime_rules_view: { name: 'Overtime Rules', actions: this.standardPermissions },
                    payslips_view: { name: 'Payslips', actions: this.standardPermissions },
                    payroll_reports_view: { name: 'Payroll Reports', actions: this.standardPermissions },
                    payroll_settings_view: { name: 'Payroll Settings', actions: this.standardPermissions },
                    authority_to_recruit_view: { name: 'Authority to Recruit', actions: this.standardPermissions },
                    job_advertising_view: { name: 'Job Advertising', actions: this.standardPermissions },
                    screening_view: { name: 'Screening', actions: this.standardPermissions },
                    interview_view: { name: 'Interview', actions: this.standardPermissions },
                    hiring_view: { name: 'Hiring Management', actions: ['view'] },
                    offer_view: { name: 'Offer Management', actions: this.standardPermissions },
                    contract_view: { name: 'Contract Management', actions: this.standardPermissions },
                    onboarding_view: { name: 'Onboarding', actions: this.standardPermissions },
                    chart_view: { name: 'HR Charts', actions: this.standardPermissions },
                    chartboard_view: { name: 'HR Chart Board', actions: this.standardPermissions },
                    kpi_view: { name: 'KPI Management', actions: ['view'] },
                    kpi_create_view: { name: 'Create KPI', actions: this.standardPermissions },
                    kpi_dashboard_view: { name: 'KPI Dashboard', actions: this.standardPermissions },
                    // Project Management Features (granular, like HR)
                    project_dashboard_view: { name: 'Project Dashboard', actions: this.standardPermissions },
                    project_list_view: { name: 'Project List', actions: this.standardPermissions },
                    project_reports_view: { name: 'Project Reports', actions: this.standardPermissions },
                    project_create_view: { name: 'Project Create', actions: this.standardPermissions },
                    // Inventory Management Features
                    inventory_view: { name: 'Inventory Management', actions: ['view'] },
                    inventory_dashboard_view: { name: 'Inventory Dashboard', actions: this.standardPermissions },
                    inventory_items_view: { name: 'Inventory Items', actions: this.standardPermissions },
                    inventory_warehouses_view: { name: 'Inventory Warehouses', actions: this.standardPermissions },
                    inventory_reservations_view: { name: 'Material Reservations', actions: [...this.standardPermissions, 'approve'] },
                    inventory_approvals_view: { name: 'Inventory Approvals', actions: [...this.standardPermissions, 'approve'] },
                    inventory_issue_view: { name: 'Material Issue', actions: this.standardPermissions },
                    // Catering / Meals Management Features
                    catering_view: { name: 'Catering / Meals', actions: ['view'] },
                    catering_manage_types: { name: 'Meal Types', actions: this.standardPermissions },
                    catering_assign: { name: 'Eligibility & Assign', actions: [...this.standardPermissions, 'approve'] },
                    catering_consumption_manual: { name: 'Consumption (Manual)', actions: ['view', 'create'] },
                    catering_consumption_nfc: { name: 'Consumption (NFC)', actions: ['view', 'create'] },
                    catering_reports: { name: 'Catering Reports', actions: ['view', 'export'] },
                    settings_view: { name: 'Settings', actions: ['view'] },
                    profile_view: { name: 'Profile Management', actions: ['view', 'edit'] },
                    account_settings_view: { name: 'Account Settings', actions: ['view', 'edit'] },
                    company_management_view: { name: 'Company Management', actions: this.standardPermissions },
                    approval_settings_view: { name: 'Approval Flow Settings', actions: ['view', 'edit'] },
                    field_setup_view: { name: 'Field Setup', actions: ['view', 'create', 'edit', 'delete', 'import', 'export'] },
                    preferences_view: { name: 'Preferences', actions: ['view', 'edit'] },
                    notification_settings_view: { name: 'Notification Settings', actions: ['view', 'edit'] },
                    user_management_view: { name: 'User Management', actions: this.standardPermissions },
                    role_permissions_view: { name: 'Role Permissions', actions: this.standardPermissions }
                };
                
                // Define page categories for filtering
                this.pageCategories = {
                    home: ['home_view'],
                    investigation: ['investigation_view', 'investigation_dashboard_view', 'investigation_list_view', 'create_investigation_view'],
                    health: ['health_view', 'health_assessment_view', 'health_consultation_view', 'medical_folder_view'],
                    safety: ['safety_view', 'training_view', 'jsa_view', 'ptw_view', 'incident_view', 'inspection_view', 'audit_view', 'audit_log_view'],
                    // Risk Management separated from Safety for clearer grouping in role modal
                    risk: ['risk_view', 'risk_register_view'],
                    environment: ['environment_view', 'water_view'],
                    fuel: ['fuel_management', 'vessel_offloading', 'fuel_storage', 'tank_transfer', 'truck_loading', 'quality_analysis', 'fuel_distribution', 'fuel_consumption_analysis', 'fuel_daily_report'],
                    security: ['security_view', 'access_view', 'access_daily_view', 'removal_view', 'security_site_map_view', 'security_level_evaluation_view'],
                    logistics: ['logistics_view', 'fleet_view', 'travel_view', 'lms_view'],
                    accommodation: ['accommodation_view', 'camp_view', 'camp_settings_view'],
                    hr: [
                        'hr_view',
                        'staff_management_view',
                        'salary_management_view',
                        // Payroll-related features
                        'payroll_view',
                        'timesheets_view',
                        'payroll_runs_view',
                        'pay_elements_view',
                        'tax_deductions_view',
                        'overtime_rules_view',
                        'payslips_view',
                        'payroll_reports_view',
                        'payroll_settings_view',
                        // Other HR features
                        'recruit_view', 'recruitment_view', 'jobpost_view', 'screening_view', 'interview_view', 'contract_view', 'onboard_view', 'chart_view', 'chartboard_view'
                    ],
                    project: [
                        'project_dashboard_view',
                        'project_list_view',
                        'project_reports_view',
                        'project_create_view'
                    ],
                    inventory: [
                        'inventory_view',
                        'inventory_dashboard_view', 
                        'inventory_items_view',
                        'inventory_warehouses_view',
                        'inventory_reservations_view',
                        'inventory_approvals_view',
                        'inventory_issue_view'
                    ],
                    catering: [
                        'catering_view',
                        'catering_manage_types',
                        'catering_assign',
                        'catering_consumption_manual',
                        'catering_consumption_nfc',
                        'catering_reports'
                    ],
                    kpi: ['kpi_view', 'kpi_create_view', 'kpi_dashboard_view'],
                    settings: ['settings_view', 'profile_view', 'account_settings_view', 'company_management_view', 'approval_settings_view', 'field_setup_view', 'preferences_view', 'notification_settings_view', 'user_management_view', 'role_permissions_view']
                };
                
                this.initializeRoleManagement();
            }

            initializePageFilter() {
                const pageFilter = document.getElementById('pageFilter');
                if (!pageFilter) return;

                pageFilter.addEventListener('change', (e) => {
                    this.filterPermissionsByPage(e.target.value);
                });
            }

            filterPermissionsByPage(selectedPage) {
                const container = document.getElementById('permissionsContainer');
                if (!container) return;

                const sections = container.querySelectorAll('.permission-section');
                
                sections.forEach(section => {
                    const headerText = section.querySelector('.permission-header h3').textContent;
                    
                    if (selectedPage === 'all') {
                        section.style.display = '';
                    } else {
                        // Find which features belong to the selected page category
                        const categoryFeatures = this.pageCategories[selectedPage] || [];
                        const shouldShow = categoryFeatures.some(featureId => {
                            const feature = this.features[featureId];
                            return feature && feature.name === headerText;
                        });
                        
                        section.style.display = shouldShow ? '' : 'none';
                    }
                });
            }

            initializeRoleManagement() {
                // Initialize role modal if we're on the roles page
                if (document.querySelector('.roles-table-container')) {
                    this.initializeModal();
                    this.loadRolesAndPermissions();
                    // Start listening to company users to compute per-company user counts by role
                    this.startCompanyUsersListener();
                    this.initializePageFilter();
                }

                // Don't initialize menu visibility here - let the main auth system handle it
                console.log('🎯 RoleManager initialized, menu visibility handled by auth system');
            }

            // Listen to users under the current company to compute per-role user counts
            startCompanyUsersListener() {
                const currentUser = window.authManager?.currentUser;
                const companyId = currentUser?.companyId;
                if (!companyId) {
                    console.warn('Cannot start users listener: missing companyId');
                    return;
                }

                try {
                    const usersRef = ref(this.db, `companies/${companyId}/users`);
                    onValue(usersRef, (snapshot) => {
                        const users = snapshot.exists() ? snapshot.val() : {};
                        this.companyUsers = users || {};
                        // Re-render roles so the Users column reflects latest counts
                        if (Array.isArray(this.roles) && this.roles.length > 0) {
                            this.renderRoles();
                        }
                    });

                    // Fallback: listen to employees collection too and merge
                    const employeesRef = ref(this.db, `companies/${companyId}/employees`);
                    onValue(employeesRef, (snapshot) => {
                        const employees = snapshot.exists() ? snapshot.val() : {};
                        // Merge employees into companyUsers if users path is empty or to augment
                        const merged = { ...(this.companyUsers || {}) };
                        Object.entries(employees || {}).forEach(([k, v]) => {
                            if (!merged[k]) merged[k] = v;
                        });
                        this.companyUsers = merged;
                        if (Array.isArray(this.roles) && this.roles.length > 0) {
                            this.renderRoles();
                        }
                    });
                } catch (err) {
                    console.error('Error starting company users listener:', err);
                }
            }

            // Menu visibility is now handled by the main feature-based authorization system
            // This method is removed to avoid conflicts with updateMenuWithFeatureAuthorization

            initializeModal() {
                const modal = document.getElementById('roleModal');
                const createRoleBtn = document.getElementById('createRoleBtn');
                const closeBtn = document.querySelector('.close-modal');
                const cancelBtn = document.getElementById('cancelBtn');
                const saveBtn = document.getElementById('saveRoleBtn');
                const roleForm = document.getElementById('roleForm');

                if (createRoleBtn) {
                    createRoleBtn.addEventListener('click', () => this.showModal());
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideModal());
                }

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => this.hideModal());
                }

                if (saveBtn && roleForm) {
                    saveBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!roleForm.checkValidity()) {
                            roleForm.reportValidity();
                            return;
                        }

                        // Prevent double submits and provide quick feedback
                        const originalText = saveBtn.textContent;
                        saveBtn.disabled = true;
                        saveBtn.textContent = originalText.includes('Create') ? 'Creating…' : 'Saving…';

                        try {
                            const roleId = roleForm.dataset.roleId;
                            if (roleId) {
                                await this.updateRole(roleId);
                            } else {
                                await this.createRole();
                            }
                        } catch (err) {
                            console.error('Error saving role:', err);
                            window.notificationManager?.addNotification({
                                type: 'Error',
                                message: `Failed to save role: ${err?.message || 'Unknown error'}`
                            });
                        } finally {
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalText;
                        }
                    });
                }

                // Close modal when clicking outside
                if (modal) {
                    window.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideModal();
                        }
                    });
                }
            }

            showModal(roleData = null) {
                const modal = document.getElementById('roleModal');
                const form = document.getElementById('roleForm');
                const modalTitle = document.getElementById('modalTitle');
                const saveBtn = document.getElementById('saveRoleBtn');

                if (!modal || !form || !modalTitle || !saveBtn) return;

                // Clear previous permissions
                const existingPermissions = form.querySelector('.permissions-grid');
                if (existingPermissions) {
                    existingPermissions.remove();
                }

                // Add permissions grid with improved organization
                const permissionsGrid = document.createElement('div');
                permissionsGrid.className = 'permissions-grid full-width';

                // Add permissions header
                const permissionsHeader = document.createElement('div');
                permissionsHeader.className = 'form-group full-width';
                permissionsHeader.innerHTML = `
                    <label>Permissions</label>
                    <small class="form-hint">Select the permissions for this role. Permissions are grouped by module for clarity.</small>
                `;
                permissionsGrid.appendChild(permissionsHeader);

                // Helper to add a section header
                function addSectionHeader(title) {
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'permissions-section-header';
                    sectionHeader.innerHTML = `<h3 style="margin-top:2rem;margin-bottom:0.5rem;color:#2c3e50;font-size:1.1rem;border-bottom:1px solid #e0e0e0;padding-bottom:0.25rem;">${title}</h3>`;
                    permissionsGrid.appendChild(sectionHeader);
                }

                // Render grouped permissions
                const featuresToShow = { ...this.features };
                const categories = [
                    { key: 'hr', label: 'HR Management' },
                    { key: 'project', label: 'Project Management' },
                    { key: 'risk', label: 'Risk Management' },
                    { key: 'kpi', label: 'KPI Management' },
                    { key: 'settings', label: 'Settings & Admin' },
                    { key: 'home', label: 'Home' },
                    { key: 'health', label: 'Health' },
                    { key: 'safety', label: 'Safety' },
                    { key: 'investigation', label: 'Investigation' },
                    { key: 'environment', label: 'Environment' },
                    { key: 'fuel', label: 'Fuel Management' },
                    { key: 'security', label: 'Security' },
                    { key: 'logistics', label: 'Logistics' },
                    { key: 'accommodation', label: 'Accommodation' }
                ];
                const usedFeatures = new Set();
                categories.forEach(cat => {
                    const featureIds = this.pageCategories[cat.key] || [];
                    if (featureIds.length > 0) {
                        addSectionHeader(cat.label);
                        featureIds.forEach(featureId => {
                            const feature = featuresToShow[featureId];
                            if (!feature) return;
                            usedFeatures.add(featureId);
                            const section = document.createElement('div');
                            section.className = 'permission-section';
                            const header = document.createElement('div');
                            header.className = 'permission-header';
                            const selectAllId = `select_all_${featureId}`;
                            header.innerHTML = `
                                <div class="permission-header-content">
                                    <h4>${feature.name}</h4>
                                    <label class="checkbox-container select-all">
                                        <input type="checkbox" id="${selectAllId}">
                                        <span class="checkmark"></span>
                                        <span class="checkbox-label">Select All</span>
                                    </label>
                                </div>
                            `;
                            section.appendChild(header);
                            const checkboxes = document.createElement('div');
                            checkboxes.className = 'permission-checkboxes';
                            (feature.actions || []).forEach(action => {
                                const checked = roleData?.permissions?.[featureId]?.[action] || false;
                                const checkboxId = `permission_${featureId}_${action}`;
                                checkboxes.innerHTML += `
                                    <label class="checkbox-container">
                                        <input type="checkbox" 
                                            id="${checkboxId}"
                                            name="permissions[${featureId}][${action}]"
                                            ${checked ? 'checked' : ''}>
                                        <span class="checkmark"></span>
                                        <span class="checkbox-label">${action.charAt(0).toUpperCase() + action.slice(1)}</span>
                                    </label>
                                `;
                            });
                            section.appendChild(checkboxes);
                            permissionsGrid.appendChild(section);
                            setTimeout(() => {
                                const selectAllCheckbox = document.getElementById(selectAllId);
                                const permissionCheckboxes = checkboxes.querySelectorAll('input[type="checkbox"]');
                                if (selectAllCheckbox && permissionCheckboxes.length > 0) {
                                    selectAllCheckbox.checked = Array.from(permissionCheckboxes).every(checkbox => checkbox.checked);
                                    selectAllCheckbox.addEventListener('change', (e) => {
                                        permissionCheckboxes.forEach(checkbox => {
                                            checkbox.checked = e.target.checked;
                                        });
                                    });
                                    permissionCheckboxes.forEach(checkbox => {
                                        checkbox.addEventListener('change', () => {
                                            selectAllCheckbox.checked = Array.from(permissionCheckboxes).every(cb => cb.checked);
                                        });
                                    });
                                }
                            }, 0);
                        });
                    }
                });
                // Render any features not in categories
                Object.entries(featuresToShow).forEach(([featureId, feature]) => {
                    if (usedFeatures.has(featureId)) return;
                    const section = document.createElement('div');
                    section.className = 'permission-section';
                    const header = document.createElement('div');
                    header.className = 'permission-header';
                    const selectAllId = `select_all_${featureId}`;
                    header.innerHTML = `
                        <div class="permission-header-content">
                            <h4>${feature.name}</h4>
                            <label class="checkbox-container select-all">
                                <input type="checkbox" id="${selectAllId}">
                                <span class="checkmark"></span>
                                <span class="checkbox-label">Select All</span>
                            </label>
                        </div>
                    `;
                    section.appendChild(header);
                    const checkboxes = document.createElement('div');
                    checkboxes.className = 'permission-checkboxes';
                    (feature.actions || []).forEach(action => {
                        const checked = roleData?.permissions?.[featureId]?.[action] || false;
                        const checkboxId = `permission_${featureId}_${action}`;
                        checkboxes.innerHTML += `
                            <label class="checkbox-container">
                                <input type="checkbox" 
                                    id="${checkboxId}"
                                    name="permissions[${featureId}][${action}]"
                                    ${checked ? 'checked' : ''}>
                                <span class="checkmark"></span>
                                <span class="checkbox-label">${action.charAt(0).toUpperCase() + action.slice(1)}</span>
                            </label>
                        `;
                    });
                    section.appendChild(checkboxes);
                    permissionsGrid.appendChild(section);
                    setTimeout(() => {
                        const selectAllCheckbox = document.getElementById(selectAllId);
                        const permissionCheckboxes = checkboxes.querySelectorAll('input[type="checkbox"]');
                        if (selectAllCheckbox && permissionCheckboxes.length > 0) {
                            selectAllCheckbox.checked = Array.from(permissionCheckboxes).every(checkbox => checkbox.checked);
                            selectAllCheckbox.addEventListener('change', (e) => {
                                permissionCheckboxes.forEach(checkbox => {
                                    checkbox.checked = e.target.checked;
                                });
                            });
                            permissionCheckboxes.forEach(checkbox => {
                                checkbox.addEventListener('change', () => {
                                    selectAllCheckbox.checked = Array.from(permissionCheckboxes).every(cb => cb.checked);
                                });
                            });
                        }
                    }, 0);
                });

                // Add permissions grid to form
                form.insertBefore(permissionsGrid, form.querySelector('.modal-footer'));

                if (roleData) {
                    modalTitle.textContent = 'Edit Role';
                    form.dataset.roleId = roleData.id;
                    form.roleName.value = roleData.name;
                    form.roleDescription.value = roleData.description || '';
                    saveBtn.textContent = 'Save Changes';
                } else {
                    modalTitle.textContent = 'Create New Role';
                    form.reset();
                    delete form.dataset.roleId;
                    saveBtn.textContent = 'Create Role';
                }

                modal.classList.add('show');
                form.roleName.focus();
            }

            hideModal() {
                const modal = document.getElementById('roleModal');
                const form = document.getElementById('roleForm');
                const saveBtn = document.getElementById('saveRoleBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                
                if (!modal || !form) return;
                
                modal.classList.remove('show');
                form.reset();
                
                // Reset form fields to editable state
                if (form.roleName) {
                    form.roleName.readOnly = false;
                    form.roleName.style.backgroundColor = '';
                    form.roleName.style.opacity = '';
                }
                
                if (form.roleDescription) {
                    form.roleDescription.readOnly = false;
                    form.roleDescription.style.backgroundColor = '';
                    form.roleDescription.style.opacity = '';
                }
                
                // Reset buttons
                if (saveBtn) {
                    saveBtn.style.display = '';
                    saveBtn.textContent = 'Save Changes';
                }
                
                if (cancelBtn) {
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.style.background = '';
                }
                
                // Remove any existing permissions grids
                const existingPermissions = form.querySelector('.permissions-grid');
                if (existingPermissions) {
                    existingPermissions.remove();
                }
            }

            showModalReadOnly(roleData) {
                const modal = document.getElementById('roleModal');
                const form = document.getElementById('roleForm');
                const modalTitle = document.getElementById('modalTitle');
                const saveBtn = document.getElementById('saveRoleBtn');

                if (!modal || !form || !modalTitle || !saveBtn) return;

                // Clear previous permissions
                const existingPermissions = form.querySelector('.permissions-grid');
                if (existingPermissions) {
                    existingPermissions.remove();
                }

                // Add permissions grid (read-only version)
                const permissionsGrid = document.createElement('div');
                permissionsGrid.className = 'permissions-grid full-width';
                
                // Add permissions header
                const permissionsHeader = document.createElement('div');
                permissionsHeader.className = 'form-group full-width';
                permissionsHeader.innerHTML = `
                    <label>Permissions (Read-Only)</label>
                    <small class="form-hint" style="color: #10b981;">This is a default system role that cannot be modified. All permissions are enabled for Administrators.</small>
                `;
                permissionsGrid.appendChild(permissionsHeader);

                // Add permission sections for each feature (all checked and disabled)
                Object.entries(this.features).forEach(([featureId, feature]) => {
                    const section = document.createElement('div');
                    section.className = 'permission-section';
                    
                    const header = document.createElement('div');
                    header.className = 'permission-header';
                    
                    // Add select all checkbox (checked and disabled)
                    const selectAllId = `select_all_${featureId}_readonly`;
                    header.innerHTML = `
                        <div class="permission-header-content">
                            <h4>${feature.name}</h4>
                            <label class="checkbox-container select-all">
                                <input type="checkbox" id="${selectAllId}" checked disabled style="opacity: 0.7;">
                                <span class="checkmark" style="opacity: 0.7;"></span>
                                <span class="checkbox-label" style="color: #10b981; font-weight: 500;">All Enabled</span>
                            </label>
                        </div>
                    `;
                    section.appendChild(header);

                    const checkboxes = document.createElement('div');
                    checkboxes.className = 'permission-checkboxes';
                    
                    feature.actions.forEach(action => {
                        const checkboxId = `permission_${featureId}_${action}_readonly`;
                        checkboxes.innerHTML += `
                            <label class="checkbox-container">
                                <input type="checkbox" 
                                    id="${checkboxId}"
                                    name="permissions[${featureId}][${action}]"
                                    checked disabled style="opacity: 0.7;">
                                <span class="checkmark" style="opacity: 0.7;"></span>
                                <span class="checkbox-label" style="color: #10b981;">${action.charAt(0).toUpperCase() + action.slice(1)}</span>
                            </label>
                        `;
                    });
                    
                    section.appendChild(checkboxes);
                    permissionsGrid.appendChild(section);
                });

                // Add permissions grid to form
                form.insertBefore(permissionsGrid, form.querySelector('.modal-footer'));

                // Set up the modal for read-only viewing
                modalTitle.textContent = 'View Administrator Role';
                modalTitle.innerHTML = `
                    <i class="fas fa-shield-alt" style="color: #10b981; margin-right: 8px;"></i>
                    View Administrator Role
                `;
                
                // Make form fields read-only
                form.roleName.value = roleData.name;
                form.roleName.readOnly = true;
                form.roleName.style.backgroundColor = '#f8f9fa';
                form.roleName.style.opacity = '0.8';
                
                form.roleDescription.value = roleData.description || '';
                form.roleDescription.readOnly = true;
                form.roleDescription.style.backgroundColor = '#f8f9fa';
                form.roleDescription.style.opacity = '0.8';
                
                // Hide the save button and show close button instead
                saveBtn.style.display = 'none';
                
                // Make sure cancel button shows as "Close"
                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) {
                    cancelBtn.textContent = 'Close';
                    cancelBtn.style.background = '#6b7280';
                }

                modal.classList.add('show');
                
                // Focus on close button instead of name field
                if (cancelBtn) {
                    cancelBtn.focus();
                }
            }

            async createRole() {
                const form = document.getElementById('roleForm');
                if (!form) return;

                // Get current user's company ID
                const currentUser = window.authManager?.currentUser;
                if (!currentUser || !currentUser.companyId) {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Unable to create role: Company information not found.'
                    });
                    return;
                }

                // Collect permissions
                const permissions = {};
                form.querySelectorAll('input[name^="permissions["]').forEach(checkbox => {
                    const matches = checkbox.name.match(/permissions\[(.*?)\]\[(.*?)\]/);
                    if (matches) {
                        const [, featureId, action] = matches;
                        if (!permissions[featureId]) {
                            permissions[featureId] = {};
                        }
                        permissions[featureId][action] = checkbox.checked;
                    }
                });

                const roleData = {
                    id: this.generateRoleId(form.roleName.value),
                    name: form.roleName.value,
                    description: form.roleDescription.value,
                    permissions: permissions,
                    companyId: currentUser.companyId,
                    isCustom: true,
                    createdBy: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                try {
                    // Save role under company scope: companies/{companyId}/roles/{roleId}
                    await set(ref(this.db, `companies/${currentUser.companyId}/roles/${roleData.id}`), roleData);
                    
                    // Also store the role name separately at the specified path for easy access
                    await set(ref(this.db, `companies/${currentUser.companyId}/roles/${roleData.id}/name`), roleData.name);
                    
                    window.notificationManager?.addNotification({
                        type: 'Success',
                        message: `Role "${roleData.name}" has been created successfully for your company.`
                    });
                    
                    // No need to manually reload - Firebase listener will handle it
                    this.hideModal();
                } catch (error) {
                    console.error('Error creating role:', error);
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: `Failed to create role: ${error.message}`
                    });
                }
            }

            async updateRole(roleId) {
                const form = document.getElementById('roleForm');
                if (!form) return;

                // Find the role to ensure it exists and is editable
                const role = this.roles.find(r => r.id === roleId);
                if (!role) {
                    console.warn('Role not found in local cache, proceeding with update by ID:', roleId);
                }

                // Prevent updates to system Administrator role
                if ((role && (role.isDefault || role.isSystemRole || role.id === 'administrator')) || roleId === 'administrator') {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Cannot modify the default Administrator role.'
                    });
                    return;
                }

                const currentUser = window.authManager?.currentUser;
                if (!currentUser || !currentUser.companyId) {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Unable to update role: Company information not found.'
                    });
                    return;
                }

                // Collect permissions
                const permissions = {};
                form.querySelectorAll('input[name^="permissions["]').forEach(checkbox => {
                    const matches = checkbox.name.match(/permissions\[(.*?)\]\[(.*?)\]/);
                    if (matches) {
                        const [, featureId, action] = matches;
                        if (!permissions[featureId]) {
                            permissions[featureId] = {};
                        }
                        permissions[featureId][action] = checkbox.checked;
                    }
                });

                const updates = {
                    name: form.roleName.value,
                    description: form.roleDescription.value,
                    permissions: permissions,
                    updatedBy: currentUser.uid,
                    updatedAt: new Date().toISOString()
                };

                try {
                    // Update role under company scope: companies/{companyId}/roles/{roleId}
                    await update(ref(this.db, `companies/${currentUser.companyId}/roles/${roleId}`), updates);
                    
                    // Also update the role name separately at the specified path for easy access
                    await set(ref(this.db, `companies/${currentUser.companyId}/roles/${roleId}/name`), updates.name);
                    
                    window.notificationManager?.addNotification({
                        type: 'Success',
                        message: `Role "${updates.name}" has been updated successfully.`
                    });
                    
                    // No need to manually reload - Firebase listener will handle it
                    this.hideModal();
                } catch (error) {
                    console.error('Error updating role:', error);
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: `Failed to update role: ${error.message}`
                    });
                }
            }

            async deleteRole(roleId) {
                // Find the role to check if it exists
                const role = this.roles.find(r => r.id === roleId);
                if (!role) {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Role not found.'
                    });
                    return;
                }

                // Prevent deletion of default Administrator role
                if (role.isDefault || role.isSystemRole || role.id === 'administrator') {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Cannot delete the default Administrator role. This is a system role that provides full access permissions.'
                    });
                    return;
                }

                if (!confirm(`Are you sure you want to delete the role "${role.name}"? This action cannot be undone.`)) {
                    return;
                }

                const currentUser = window.authManager?.currentUser;
                if (!currentUser || !currentUser.companyId) {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Unable to delete role: Company information not found.'
                    });
                    return;
                }

                try {
                    // Delete from company scope: companies/{companyId}/roles/{roleId}
                    await set(ref(this.db, `companies/${currentUser.companyId}/roles/${roleId}`), null);
                    
                    window.notificationManager?.addNotification({
                        type: 'Success',
                        message: `Role "${role.name}" has been deleted successfully.`
                    });
                    
                    // No need to manually reload - Firebase listener will handle it
                } catch (error) {
                    console.error('Error deleting role:', error);
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: `Failed to delete role: ${error.message}`
                    });
                }
            }

            async loadRolesAndPermissions() {
                const currentUser = window.authManager?.currentUser;
                if (!currentUser || !currentUser.companyId) {
                    console.warn('Cannot load roles: User or company information not available');
                    this.renderEmptyState();
                    return;
                }

                try {
                    this.roles = [];

                    // Load company-specific roles first
                    const companyRolesRef = ref(this.db, `companies/${currentUser.companyId}/roles`);
                    onValue(companyRolesRef, (snapshot) => {
                        this.roles = [];
                        let hasAdministratorRole = false;
                        
                        // Add company-specific roles
                        if (snapshot.exists()) {
                            snapshot.forEach((childSnapshot) => {
                                const role = {
                                    id: childSnapshot.key,
                                    ...childSnapshot.val()
                                };
                                
                                // Check if administrator role exists in Firebase
                                if (role.id === 'administrator') {
                                    hasAdministratorRole = true;
                                }
                                
                                this.roles.push(role);
                            });
                        }
                        
                        // Only add the default Administrator role if it doesn't exist in Firebase
                        if (!hasAdministratorRole) {
                            const defaultAdminRole = this.createDefaultAdministratorRole();
                            this.roles.unshift(defaultAdminRole); // Add at the beginning
                        }
                        
                        this.renderRoles();
                        this.renderPermissions();
                    });

                } catch (error) {
                    console.error('Error loading roles:', error);
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Failed to load roles. Please refresh the page.'
                    });
                }
            }

            createDefaultAdministratorRole() {
                console.log('🔧 Creating default Administrator role...');
                // Create comprehensive permissions object with all permissions enabled
                const allPermissions = {
                    // Core system permissions
                    home_view: { view: true },
                    
                    // Health module permissions
                    health_view: { view: true, create: true, edit: true, delete: true },
                    health_assessment_view: { view: true, create: true, edit: true, delete: true },
                    health_consultation_view: { view: true, create: true, edit: true, delete: true },
                    medical_folder_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Safety module permissions
                    safety_view: { view: true, create: true, edit: true, delete: true },
                    training_view: { view: true, create: true, edit: true, delete: true },
                    risk_view: { view: true, create: true, edit: true, delete: true },
                    jsa_view: { view: true, create: true, edit: true, delete: true },
                    ptw_view: { view: true, create: true, edit: true, delete: true },
                    incident_view: { view: true, create: true, edit: true, delete: true },
                    inspection_view: { view: true, create: true, edit: true, delete: true },
                    audit_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Environment module permissions
                    environment_view: { view: true, create: true, edit: true, delete: true },
                    water_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Fuel Management module permissions
                    fuel_management: { view: true },
                    vessel_offloading: { view: true, create: true, edit: true, delete: true },
                    fuel_storage: { view: true, create: true, edit: true, delete: true },
                    tank_transfer: { view: true, create: true, edit: true, delete: true },
                    truck_loading: { view: true, create: true, edit: true, delete: true },
                    quality_analysis: { view: true, create: true, edit: true, delete: true },
                    fuel_distribution: { view: true, create: true, edit: true, delete: true },
                    fuel_consumption_analysis: { view: true, create: true, edit: true, delete: true },
                    fuel_daily_report: { view: true, create: true, edit: true, delete: true },
                    
                    // Security module permissions
                    security_view: { view: true, create: true, edit: true, delete: true },
                    access_view: { view: true, create: true, edit: true, delete: true },
                    access_daily_view: { view: true, create: true, edit: true, delete: true, view_attachments: true },
                    removal_view: { view: true, create: true, edit: true, delete: true },
                    security_site_map_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Logistics module permissions
                    logistics_view: { view: true, create: true, edit: true, delete: true },
                    fleet_view: { view: true, create: true, edit: true, delete: true },
                    travel_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Accommodation module permissions
                    accommodation_view: { view: true, create: true, edit: true, delete: true },
                    camp_view: { view: true, create: true, edit: true, delete: true },
                    camp_settings_view: { view: true, create: true, edit: true, delete: true },
                    
                    // HR module permissions
                    hr_view: { view: true, create: true, edit: true, delete: true },
                    human_hr_view: { view: true, create: true, edit: true, delete: true },
                    staff_management_view: { view: true, create: true, edit: true, delete: true, export: true, import: true },
                    salary_management_view: { view: true, create: true, edit: true, delete: true, export: true },
                    // Payroll module permissions
                    payroll_view: { view: true },
                    timesheets_view: { view: true, create: true, edit: true, delete: true, export: true },
                    payroll_runs_view: { view: true, create: true, edit: true, delete: true, export: true },
                    pay_elements_view: { view: true, create: true, edit: true, delete: true, export: true },
                    tax_deductions_view: { view: true, create: true, edit: true, delete: true, export: true },
                    overtime_rules_view: { view: true, create: true, edit: true, delete: true, export: true },
                    payslips_view: { view: true, create: true, edit: true, delete: true, export: true },
                    payroll_reports_view: { view: true, create: true, edit: true, delete: true, export: true },
                    payroll_settings_view: { view: true, create: true, edit: true, delete: true, export: true },
                    authority_to_recruit_view: { view: true, create: true, edit: true, delete: true },
                    job_advertising_view: { view: true, create: true, edit: true, delete: true },
                    screening_view: { view: true, create: true, edit: true, delete: true },
                    interview_view: { view: true, create: true, edit: true, delete: true },
                    offer_view: { view: true, create: true, edit: true, delete: true },
                    contract_view: { view: true, create: true, edit: true, delete: true },
                    onboarding_view: { view: true, create: true, edit: true, delete: true },
                    kpi_dashboard_view: { view: true, create: true, edit: true, delete: true },

                    // Investigation module permissions
                    investigation_view: { view: true },
                    investigation_dashboard_view: { view: true, create: true, edit: true, delete: true },
                    investigation_list_view: { view: true, create: true, edit: true, delete: true },
                    create_investigation_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Project module permissions
                    project_view: { view: true },

                    // Inventory module permissions  
                    inventory_view: { view: true, create: true, edit: true, delete: true },
                    inventory_dashboard_view: { view: true, create: true, edit: true, delete: true },
                    inventory_items_view: { view: true, create: true, edit: true, delete: true },
                    inventory_warehouses_view: { view: true, create: true, edit: true, delete: true },
                    inventory_reservations_view: { view: true, create: true, edit: true, delete: true, approve: true },
                    inventory_approvals_view: { view: true, create: true, edit: true, delete: true, approve: true },
                    inventory_issue_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Communication permissions
                    communication_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Settings and administration permissions
                    settings_view: { view: true, create: true, edit: true, delete: true },
                    account_settings_view: { view: true, create: true, edit: true, delete: true },
                    company_management_view: { view: true, create: true, edit: true, delete: true },
                    approval_settings_view: { view: true, create: true, edit: true, delete: true },
                    field_setup_view: { view: true, create: true, edit: true, delete: true },
                    preferences_view: { view: true, create: true, edit: true, delete: true },
                    notification_settings_view: { view: true, create: true, edit: true, delete: true },
                    audit_log_view: { view: true, create: true, edit: true, delete: true },
                    user_management_view: { view: true, create: true, edit: true, delete: true },
                    role_permissions_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Legacy permissions for compatibility with existing code
                    company_management: { view: true, create: true, edit: true, delete: true },
                    user_management: { view: true, create: true, edit: true, delete: true },
                    staff_management: { view: true, create: true, edit: true, delete: true, export: true, import: true },
                    health_management: { view: true, create: true, edit: true, delete: true },
                    environment_management: { view: true, create: true, edit: true, delete: true },
                    security_management: { view: true, create: true, edit: true, delete: true },
                    logistics_management: { view: true, create: true, edit: true, delete: true },
                    camp_management: { view: true, create: true, edit: true, delete: true },
                    role_management: { view: true, create: true, edit: true, delete: true },
                    reports: { view: true, create: true, edit: true, delete: true, export: true },
                    settings: { view: true, create: true, edit: true, delete: true },
                    
                    // Dashboard and general permissions
                    dashboard: { view: true, edit: true, delete: true, create: true },
                    users: { view: true, edit: true, delete: true, create: true },
                    roles: { view: true, edit: true, delete: true, create: true },
                    company: { view: true, edit: true, delete: true, create: true },
                    
                    // Additional permissions for comprehensive access
                    safety: { view: true, create: true, edit: true, delete: true },
                    hr: { view: true, create: true, edit: true, delete: true },
                    authority_to_recruit: { view: true },
                    job_advertising: { view: true },
                    screening: { view: true },
                    interview: { view: true },
                    hiring: { view: true },
                    offer: { view: true },
                    contract: { view: true },
                    onboarding: { view: true }
                };

                const adminRole = {
                    id: 'administrator',
                    name: 'Administrator',
                    description: 'Default administrator role with full system access. This role cannot be modified or deleted.',
                    permissions: allPermissions,
                    isDefault: true,
                    isSystemRole: true,
                    isEditable: false,
                    isDeletable: false,
                    createdAt: new Date().toISOString(),
                    userCount: 0 // This will be calculated when rendering
                };

                console.log('✅ Default Administrator role created with', Object.keys(allPermissions).length, 'permission categories');
                return adminRole;
            }

            renderEmptyState() {
                const rolesTableBody = document.getElementById('rolesTableBody');
                const rolesEmptyState = document.getElementById('rolesEmptyState');
                const rolesTableContainer = document.querySelector('.roles-table-container');
                
                if (!rolesTableBody || !rolesEmptyState) return;
                
                rolesTableContainer.style.display = 'none';
                rolesEmptyState.style.display = 'block';
            }

            renderRoles() {
                const rolesTableBody = document.getElementById('rolesTableBody');
                const rolesEmptyState = document.getElementById('rolesEmptyState');
                const rolesTableContainer = document.querySelector('.roles-table-container');
                
                if (!rolesTableBody) return;

                if (this.roles.length === 0) {
                    rolesTableContainer.style.display = 'none';
                    rolesEmptyState.style.display = 'block';
                    return;
                }

                rolesTableContainer.style.display = 'block';
                rolesEmptyState.style.display = 'none';
                rolesTableBody.innerHTML = '';
                
                this.roles.forEach(role => {
                    const row = this.createRoleRow(role);
                    rolesTableBody.appendChild(row);
                });
            }

            createRoleRow(role) {
                const row = document.createElement('tr');
                
                const permissionCount = this.countPermissions(role.permissions || {});
                const userCount = this.getUserCountForRole(role) || 0;
                const createdDate = role.createdAt ? new Date(role.createdAt).toLocaleDateString() : 'N/A';
                
                // Check if this is the default Administrator role
                const isDefaultAdmin = role.isDefault || role.isSystemRole || role.id === 'administrator';
                const roleNameDisplay = isDefaultAdmin ? 
                    `<div class="role-name-cell">
                        ${role.name} 
                        <span style="color: #10b981; font-size: 0.75rem; font-weight: 500; background: #dcfce7; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">
                            <i class="fas fa-shield-alt" style="margin-right: 4px;"></i>Default
                        </span>
                    </div>` :
                    `<div class="role-name-cell">${role.name}</div>`;
                
                const actionsHTML = isDefaultAdmin ? 
                    `<div class="role-actions">
                        <button class="btn-action btn-view" title="View role permissions" style="background: #e3f2fd; color: #1565c0;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <span style="color: #6b7280; font-size: 0.8rem; font-style: italic;">Cannot modify</span>
                    </div>` :
                    `<div class="role-actions">
                        <button class="btn-action btn-edit" title="Edit this role">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" title="Delete this role">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="role-checkbox" data-role-id="${role.id}" ${isDefaultAdmin ? 'disabled style="opacity: 0.5;"' : ''}>
                    </td>
                    <td>
                        ${roleNameDisplay}
                    </td>
                    <td>
                        <div class="role-description-cell">${role.description || 'No description provided'}</div>
                    </td>
                    <td>
                        <span class="permissions-count-badge">${permissionCount} permissions</span>
                    </td>
                    <td>
                        <span class="user-count-badge">${userCount} users</span>
                    </td>
                    <td>${createdDate}</td>
                    <td>
                        ${actionsHTML}
                    </td>
                `;

                // Add event listeners
                const checkbox = row.querySelector('.role-checkbox');
                const editBtn = row.querySelector('.btn-edit');
                const deleteBtn = row.querySelector('.btn-delete');
                const viewBtn = row.querySelector('.btn-view');

                // Checkbox event listener (only for non-default roles)
                if (checkbox && !isDefaultAdmin) {
                    checkbox.addEventListener('change', () => {
                        updateBulkActionsVisibility();
                    });
                }

                // Edit button event listener (only for non-default roles)
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showModal(role);
                    });
                }

                // Delete button event listener (only for non-default roles)
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteRole(role.id);
                    });
                }

                // View button event listener (for default Administrator role)
                if (viewBtn) {
                    viewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showModalReadOnly(role);
                    });
                }

                // Add click handler for row selection (permissions view)
                row.addEventListener('click', (e) => {
                    // Don't trigger if clicking on checkbox or action buttons
                    if (e.target.closest('.role-actions') || e.target.type === 'checkbox') return;
                    // Alt+Click opens permissions; normal click opens Users tab
                    if (e.altKey) {
                        this.selectRole(role);
                    } else {
                        this.switchToUsersTab(role);
                    }
                });

                return row;
            }

            // Count only users belonging to the current company whose role matches this role
            getUserCountForRole(role) {
                try {
                    if (!role) return 0;
                    const roleId = (role.id || '').toString().toLowerCase();
                    const roleName = (role.name || '').toString().toLowerCase();
                    const usersObj = this.companyUsers || {};
                    let count = 0;

                    Object.values(usersObj).forEach(u => {
                        if (!u) return;
                        // Common fields that may carry the role information
                        const userRoleRaw = (u.role || u.roleId || u.role_name || u.userRole || '').toString();
                        const userRole = userRoleRaw.toLowerCase();
                        // Some data models keep an array of roles
                        const rolesArray = Array.isArray(u.roles) ? u.roles.map(r => (r || '').toString().toLowerCase()) : [];

                        if (!userRole && rolesArray.length === 0) return;

                        const matchesDirect = userRole === roleId || userRole === roleName;
                        const matchesArray = rolesArray.includes(roleId) || rolesArray.includes(roleName);
                        if (matchesDirect || matchesArray) count++;
                    });

                    return count;
                } catch (e) {
                    console.warn('Error counting users for role', role?.id || role?.name, e);
                    return 0;
                }
            }

            countPermissions(permissions) {
                let count = 0;
                Object.values(permissions).forEach(featurePerms => {
                    Object.values(featurePerms).forEach(hasPermission => {
                        if (hasPermission) count++;
                    });
                });
                return count;
            }

            selectRole(role) {
                // Remove active class from all role cards
                document.querySelectorAll('.role-card').forEach(card => {
                    card.classList.remove('active');
                });
                
                // Add active class to selected card
                event.currentTarget.classList.add('active');
                
                // Switch to permissions tab and show this role's permissions
                this.switchToPermissionsTab(role);
            }

            switchToPermissionsTab(role) {
                // Switch tab
                document.querySelector('.tab-button.roles-tab').classList.remove('active');
                document.querySelector('.tab-button.permissions-tab').classList.add('active');
                document.querySelector('#rolesTab').classList.remove('active');
                document.querySelector('#permissionsTab').classList.add('active');
                
                // Update permissions title
                const permissionsTitle = document.querySelector('.permissions-section h2');
                if (permissionsTitle) {
                    permissionsTitle.innerHTML = `<i class="fas fa-key"></i> ${role.name} Permissions`;
                }
                
                // Update permission checkboxes to reflect this role's permissions
                this.updatePermissionsDisplay(role.permissions || {});
            }

            // New: switch to Users tab and render users for a role
            switchToUsersTab(role) {
                // Activate users tab
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-button.users-tab')?.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                document.querySelector('#usersTab')?.classList.add('active');

                // Update title
                const titleEl = document.getElementById('usersTabTitle');
                if (titleEl) {
                    titleEl.innerHTML = `<i class="fas fa-user-friends"></i> Users in ${role.name || role.id}`;
                }

                // Render users for selected role
                this.renderUsersForRole(role);

                // Wire up search filter
                const searchEl = document.getElementById('usersSearch');
                if (searchEl && !searchEl._bound) {
                    searchEl.addEventListener('input', () => this.renderUsersForRole(role));
                    searchEl._bound = true;
                }
            }

            // Build array of users in current company matching a role
            getUsersForRole(role) {
                const roleId = (role.id || '').toString().toLowerCase();
                const roleName = (role.name || '').toString().toLowerCase();
                const usersObj = this.companyUsers || {};
                const users = [];
                Object.entries(usersObj).forEach(([uid, u]) => {
                    if (!u) return;
                    const userRoleRaw = (u.role || u.roleId || u.role_name || u.userRole || '').toString();
                    const userRole = userRoleRaw.toLowerCase();
                    const rolesArray = Array.isArray(u.roles) ? u.roles.map(r => (r || '').toString().toLowerCase()) : [];
                    const matchesDirect = userRole === roleId || userRole === roleName;
                    const matchesArray = rolesArray.includes(roleId) || rolesArray.includes(roleName);
                    if (matchesDirect || matchesArray) {
                        users.push({
                            uid,
                            name: u.fullName || u.name || u.displayName || u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : u.email || 'User',
                            email: u.email || '',
                            role: userRoleRaw || role.name || role.id
                        });
                    }
                });
                return users;
            }

            renderUsersForRole(role) {
                const tbody = document.getElementById('usersByRoleBody');
                const empty = document.getElementById('usersByRoleEmpty');
                const searchEl = document.getElementById('usersSearch');
                if (!tbody) return;
                tbody.innerHTML = '';

                let users = this.getUsersForRole(role);
                const q = (searchEl?.value || '').toLowerCase();
                if (q) {
                    users = users.filter(u => (u.name || '').toLowerCase().includes(q) || (u.email || '').toLowerCase().includes(q));
                }

                if (!users.length) {
                    if (empty) empty.style.display = 'block';
                    return;
                }
                if (empty) empty.style.display = 'none';

                users.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.name || ''}</td>
                        <td>${u.email || ''}</td>
                        <td>${u.role || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            updatePermissionsDisplay(permissions) {
                const checkboxes = document.querySelectorAll('.permissions-container input[type="checkbox"]');
                
                // Clear all checkboxes first
                checkboxes.forEach(checkbox => checkbox.checked = false);
                
                // Set permissions based on role
                Object.entries(permissions).forEach(([featureId, featurePerms]) => {
                    Object.entries(featurePerms).forEach(([action, hasPermission]) => {
                        const checkbox = document.querySelector(`input[data-permission="${featureId}_${action}"]`);
                        if (checkbox && hasPermission) {
                            checkbox.checked = true;
                        }
                    });
                });
            }

            renderPermissions() {
                const container = document.getElementById('permissionsContainer');
                if (!container) return;

                container.innerHTML = '';
                Object.entries(this.features).forEach(([featureId, feature]) => {
                    const section = document.createElement('div');
                    section.className = 'permission-section';
                    
                    const header = document.createElement('div');
                    header.className = 'permission-header';
                    header.innerHTML = `<h3>${feature.name}</h3>`;
                    
                    const content = document.createElement('div');
                    content.className = 'permission-content';
                    
                    const permissionGroup = document.createElement('div');
                    permissionGroup.className = 'permission-group';
                    permissionGroup.innerHTML = `<h4>Available Actions</h4>`;
                    
                    const permissionOptions = document.createElement('div');
                    permissionOptions.className = 'permission-options';
                    
                    feature.actions.forEach(action => {
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.className = 'checkbox-container';
                        checkboxContainer.innerHTML = `
                            <input type="checkbox" 
                                id="perm_${featureId}_${action}"
                                name="permissions[${featureId}][${action}]"
                                data-permission="${featureId}_${action}"
                                data-feature="${featureId}"
                                data-action="${action}">
                            <span class="checkmark"></span>
                            <span>${action.charAt(0).toUpperCase() + action.slice(1)}</span>
                        `;
                        permissionOptions.appendChild(checkboxContainer);
                    });
                    
                    permissionGroup.appendChild(permissionOptions);
                    content.appendChild(permissionGroup);
                    section.appendChild(header);
                    section.appendChild(content);
                    container.appendChild(section);
                });
            }

            generateRoleId(roleName) {
                return roleName.toLowerCase()
                    .replace(/[^a-z0-9]/g, '_')
                    .replace(/_+/g, '_')
                    .replace(/^_|_$/g, '') + 
                    '_' + 
                    Date.now().toString(36);
            }

            // Helper method to ensure role name is stored separately when roles are assigned to users
            async ensureRoleNameStored(companyId, roleId, roleName) {
                if (!companyId || !roleId || !roleName) {
                    console.warn('Invalid parameters for role name storage:', { companyId, roleId, roleName });
                    return;
                }

                try {
                    // Store the role name separately at the specified path for easy access
                    await set(ref(this.db, `companies/${companyId}/roles/${roleId}/name`), roleName);
                    console.log(`✅ Role name stored: companies/${companyId}/roles/${roleId}/name = ${roleName}`);
                } catch (error) {
                    console.error('Error storing role name:', error);
                }
            }

            // Method to get role name from the company path
            async getRoleNameFromCompanyPath(companyId, roleId) {
                if (!companyId || !roleId) {
                    console.warn('Invalid parameters for role name retrieval:', { companyId, roleId });
                    return null;
                }

                try {
                    const snapshot = await get(ref(this.db, `companies/${companyId}/roles/${roleId}/name`));
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (error) {
                    console.error('Error retrieving role name:', error);
                    return null;
                }
            }

            // Methods for use throughout the application
            setRole(role) {
                this.currentRole = role;
                // Menu visibility is handled by main feature-based authorization system
                console.log('🔧 Role set in RoleManager:', role?.name);
            }

            getCurrentRole() {
                return this.currentRole;
            }

            // hasPermission method removed - permission checking is handled by feature-based authorization system

            async duplicateRole(sourceRole) {
                const currentUser = window.authManager?.currentUser;
                if (!currentUser || !currentUser.companyId) {
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: 'Unable to duplicate role: Company information not found.'
                    });
                    return;
                }

                // Create new role based on source role
                const newRoleName = `${sourceRole.name} (Copy)`;
                const newRoleData = {
                    id: this.generateRoleId(newRoleName),
                    name: newRoleName,
                    description: `Copy of ${sourceRole.name}: ${sourceRole.description || 'No description'}`,
                    permissions: JSON.parse(JSON.stringify(sourceRole.permissions || {})), // Deep copy
                    companyId: currentUser.companyId,
                    isCustom: true,
                    createdBy: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                try {
                    // Save the duplicated role
                    await set(ref(this.db, `companies/${currentUser.companyId}/roles/${newRoleData.id}`), newRoleData);
                    
                    // Also store the role name separately at the specified path for easy access
                    await set(ref(this.db, `companies/${currentUser.companyId}/roles/${newRoleData.id}/name`), newRoleData.name);
                    
                    window.notificationManager?.addNotification({
                        type: 'Success',
                        message: `Role "${newRoleName}" has been created based on "${sourceRole.name}".`
                    });
                    
                    // No need to manually reload - Firebase listener will handle it
                    
                    // Open the new role for editing after a short delay to allow Firebase update
                    setTimeout(() => {
                        this.showModal(newRoleData);
                    }, 500);
                    
                } catch (error) {
                    console.error('Error duplicating role:', error);
                    window.notificationManager?.addNotification({
                        type: 'Error',
                        message: `Failed to duplicate role: ${error.message}`
                    });
                }
            }
        }

        // Centralized initialization - prevent multiple competing DOMContentLoaded listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Starting centralized roles.html initialization...');
            
            // Step 1: Initialize RoleManager
            window.roleManager = new RoleManager();
            console.log('✅ RoleManager initialized');
            
            // Step 2: Add menu-loading class to sidebar initially
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.add('menu-loading');
                console.log('🔧 Added menu-loading class to sidebar');
            }
            
            // Step 3: Initialize menu authorization with proper timing
            setTimeout(() => {
                console.log('🎯 Initializing menu authorization...');
                updateMenuWithFeatureAuthorization();
            }, 300); // Sufficient time for AuthManager and Firebase
            
            // Step 4: Initialize platform feature listener
            setTimeout(() => {
                console.log('📡 Initializing platform feature update listener...');
                initializePlatformFeatureUpdateListener();
            }, 1000);
            
            console.log('🚀 Centralized initialization sequence started');
        });

        // Global helper function for role assignment - can be used by other modules
        window.storeRoleNameInCompanyPath = async function(companyId, roleId, roleName) {
            if (window.roleManager) {
                return await window.roleManager.ensureRoleNameStored(companyId, roleId, roleName);
            } else {
                console.warn('RoleManager not available for role name storage');
                
                // Fallback: directly store using Firebase if roleManager is not ready
                try {
                    const db = firebase.database();
                    await db.ref(`companies/${companyId}/roles/${roleId}/name`).set(roleName);
                    console.log(`✅ Role name stored (fallback): companies/${companyId}/roles/${roleId}/name = ${roleName}`);
                } catch (error) {
                    console.error('Error storing role name (fallback):', error);
                }
            }
        };

        // Global helper function to get role name from company path
        window.getRoleNameFromCompanyPath = async function(companyId, roleId) {
            if (window.roleManager) {
                return await window.roleManager.getRoleNameFromCompanyPath(companyId, roleId);
            } else {
                console.warn('RoleManager not available for role name retrieval');
                
                // Fallback: directly retrieve using Firebase if roleManager is not ready
                try {
                    const db = firebase.database();
                    const snapshot = await db.ref(`companies/${companyId}/roles/${roleId}/name`).once('value');
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (error) {
                    console.error('Error retrieving role name (fallback):', error);
                    return null;
                }
            }
        };
    </script>
    
    <!-- Embedded Menu Visibility Management -->
    <script>
        // Menu visibility management - adapted for embedded Firebase v8
        
        // Reset all menu items to hidden (preserve core features only when authorized)
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Legacy role-based menu functions removed to prevent conflicts
        // Menu visibility is now handled entirely by updateMenuWithFeatureAuthorization()

        // Flag to prevent multiple simultaneous executions
        let isMenuUpdateInProgress = false;

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            // Prevent multiple simultaneous executions
            if (isMenuUpdateInProgress) {
                console.log('🔄 Menu update already in progress, skipping...');
                return;
            }
            
            isMenuUpdateInProgress = true;
            console.log('🎯 Starting feature-based menu authorization for roles.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company and role');
                } else {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company and role...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                userRole = company.users[currentUser.uid].role || company.users[currentUser.uid].userRole;
                                console.log(`✅ Found user in company: ${companyId} (${company.name}) with role: ${userRole}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                if (!userRole) {
                    console.warn('⚠️ No user role found, proceeding with company features only');
                }
                
                // STEP 1: Apply company feature-based authorization
                console.log('🏢 STEP 1: Applying company feature authorization...');
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                
                // STEP 2: Filter by user role permissions within authorized features
                if (userRole) {
                    console.log('👤 STEP 2: Applying role-based filtering within authorized features...');
                    await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                } else {
                    console.log('⚠️ STEP 2: Skipping role-based filtering (no role found)');
                }
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            } finally {
                // Reset the flag to allow future updates
                isMenuUpdateInProgress = false;
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('🔐 All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features and hrefs (with alias mapping)
                const authorizedFeatures = new Set();
                const authorizedHrefs = new Set();

                const featureAlias = (key) => {
                    if (!key) return key;
                    if (key === 'risk_view') return 'risk_management_section';
                    if (key === 'risk_management_section') return 'risk_view';
                    return null;
                };
                const normalizeHref = (href) => {
                    if (!href) return '';
                    try {
                        const u = new URL(href, window.location.origin);
                        return (u.pathname || '').replace(/^\//, '');
                    } catch {
                        return String(href).replace(/^\//, '');
                    }
                };

                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                        const alias = featureAlias(pageInfo.feature);
                        if (alias) authorizedFeatures.add(alias);
                    }
                    if (pageInfo.href) authorizedHrefs.add(normalizeHref(pageInfo.href));
                    if (pageInfo.page) authorizedHrefs.add(normalizeHref(pageInfo.page));
                    if (pageInfo.url) authorizedHrefs.add(normalizeHref(pageInfo.url));
                });

                console.log('🎯 Authorized features for roles.html:', Array.from(authorizedFeatures));
                console.log('🔗 Authorized hrefs for roles.html:', Array.from(authorizedHrefs));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    const anchor = menuItem.querySelector('a[href]');
                    const href = anchor ? anchor.getAttribute('href') : '';
                    const normalized = normalizeHref(href);
                    const featureAuthorized = authorizedFeatures.has(featureAttribute);
                    const hrefAuthorized = normalized && authorizedHrefs.has(normalized);
                    const isAuthorized = featureAuthorized || hrefAuthorized;

                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }

                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Authorized - showing: feature=${featureAttribute} href=${normalized || '—'}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Not authorized - hiding: feature=${featureAttribute} href=${normalized || '—'}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Company feature authorization completed - ${visibleCount} items initially visible`);
                
                // Return authorized pages for role-based filtering
                return authorizedPages;
                
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
                return [];
            }
        }

        // Apply role-based filtering within company authorized features
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log('👤 Applying role-based filtering for role:', userRole);
                
                // Get user role permissions from company
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                
                if (!permissionsSnapshot.exists()) {
                    console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
                    
                    // Try to get all roles to see what's available
                    const allRolesRef = database.ref(`companies/${companyId}/roles`);
                    const allRolesSnapshot = await allRolesRef.once('value');
                    
                    if (allRolesSnapshot.exists()) {
                        const allRoles = allRolesSnapshot.val();
                        console.log('🔍 Available roles in company:', Object.keys(allRoles));
                        
                        // Enhanced debugging for administrator role
                        if (userRole === 'administrator') {
                            console.log('🔑 ADMINISTRATOR - Full roles data:', allRoles);
                            if (allRoles.administrator) {
                                console.log('🔑 ADMINISTRATOR role found in company:', allRoles.administrator);
                                if (allRoles.administrator.permissions) {
                                    console.log('🔑 ADMINISTRATOR permissions found:', allRoles.administrator.permissions);
                                    filterMenuByPermissions(allRoles.administrator.permissions);
                                    return;
                                }
                            }
                        }
                        
                        // Check if the role exists with different casing or format
                        const roleKeys = Object.keys(allRoles);
                        const matchingRole = roleKeys.find(key => 
                            key.toLowerCase() === userRole.toLowerCase() ||
                            key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                        );
                        
                        if (matchingRole && allRoles[matchingRole].permissions) {
                            console.log(`✅ Found matching role: ${matchingRole}`);
                            const permissions = allRoles[matchingRole].permissions;
                            filterMenuByPermissions(permissions);
                            return;
                        }
                    }
                    
                    // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                    if (userRole === 'administrator') {
                        console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                        showSidebarAfterAuth();
                        return;
                    }
                    
                    // For other roles without permissions, hide all items with permission requirements
                    console.log('❌ No valid permissions found - filtering out items requiring permissions');
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log('✅ Loaded role permissions:', permissions);
                
                // Apply permission-based filtering
                filterMenuByPermissions(permissions);
                
            } catch (error) {
                console.error('❌ Error applying role-based filtering:', error);
                // Don't hide everything on error - keep company features visible
                showSidebarAfterAuth();
            }
        }

        // Filter menu items by role permissions (can add visibility)
        function filterMenuByPermissions(permissions) {
            console.log('🔍 Filtering visible menu items by role permissions...');
            
            if (!permissions) {
                console.log('⚠️ No permissions object provided');
                hideItemsRequiringPermissions();
                showSidebarAfterAuth();
                return;
            }
            const permissionAlias = (key) => {
                if (!key) return key;
                if (key === 'risk_view') return 'risk_management_section';
                if (key === 'risk_management_section') return 'risk_view';
                return null;
            };

            // Evaluate all permission-gated items (allow role permissions to add visibility too)
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
            console.log(`🎯 Found ${itemsRequiringPermissions.length} items requiring permissions to check`);

            let hiddenCount = 0;
            let shownByPermission = 0;

            itemsRequiringPermissions.forEach(item => {
                const requiresPermission = item.getAttribute('data-requires-permission');
                const feature = item.getAttribute('data-feature');

                const perm = permissions[requiresPermission];
                const aliasKey = permissionAlias(requiresPermission);
                const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;

                const hasViewPermission = (p) => p === true || (p && p.view === true);
                const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);

                if (allowed) {
                    if (!item.classList.contains('menu-visible')) shownByPermission++;
                    item.classList.add('menu-visible');
                    console.log(`✅ Showing by permission: ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
                } else {
                    if (item.classList.contains('menu-visible')) hiddenCount++;
                    item.classList.remove('menu-visible');
                    console.log(`❌ Hiding (no permission): ${feature} (requires: ${requiresPermission}${aliasKey ? ` | alias: ${aliasKey}` : ''})`);
                }
            });

            // Re-check dropdown menus after permission filtering
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const dropdownRequires = dropdown.getAttribute('data-requires-permission');

                if (submenuItems.length === 0) {
                    if (dropdownRequires) {
                        const perm = permissions[dropdownRequires];
                        const aliasKey = permissionAlias(dropdownRequires);
                        const aliasPerm = aliasKey ? permissions[aliasKey] : undefined;
                        const hasViewPermission = (p) => p === true || (p && p.view === true);
                        const allowed = hasViewPermission(perm) || hasViewPermission(aliasPerm);
                        if (allowed) {
                            dropdown.classList.add('menu-visible');
                            console.log(`✅ Showing dropdown by permission: ${dropdownFeature}`);
                        } else {
                            dropdown.classList.remove('menu-visible');
                            hiddenCount++;
                            console.log(`❌ Hiding dropdown (no children and no permission): ${dropdownFeature}`);
                        }
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
                    }
                } else {
                    console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
                }
            });

            console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden; ${shownByPermission} items shown by permission`);
            
            // Ensure at least home is visible
            ensureHomeIsVisible();
            
            // Show sidebar after all filtering is complete
            showSidebarAfterAuth();
        }

        // Hide menu items that require permissions (for users without role permissions)
        function hideItemsRequiringPermissions() {
            console.log('🔒 Hiding all menu items that require permissions...');
            
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            let hiddenCount = 0;
            
            itemsRequiringPermissions.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                item.classList.remove('menu-visible');
                hiddenCount++;
                console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
            });
            
            // Hide dropdowns that only contain permission-required items
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length === 0) {
                    dropdown.classList.remove('menu-visible');
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
                }
            });
            
            console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
            
            // Ensure at least home is visible
            ensureHomeIsVisible();
        }

        // Ensure home menu item is visible as fallback
        function ensureHomeIsVisible() {
            const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
            if (homeItem && !homeItem.classList.contains('menu-visible')) {
                homeItem.classList.add('menu-visible');
                console.log('✅ Ensured home menu item is visible as fallback');
            }
        }

        // Show sidebar and remove loading state after authentication and filtering
        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
                console.log('✅ Sidebar loading state removed - menu authorization complete');
            }
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

        // Menu initialization is now handled by centralized DOMContentLoaded listener above

        // Debug functions for menu visibility
        window.debugMenuState = function() {
            console.log('🔧 Debug Menu State:');
            const menuItems = document.querySelectorAll('[data-feature]');
            console.log(`Total menu items: ${menuItems.length}`);
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                const isVisible = item.classList.contains('menu-visible');
                console.log(`- ${feature}: requires=${requiresPermission}, visible=${isVisible}`);
            });
        };

        // Test function to manually trigger the authorization process
        window.testMenuAuthorization = function() {
            console.log('🧪 Testing menu authorization process...');
            
            if (window.authManager && window.authManager.currentUser) {
                console.log('👤 Current user:', window.authManager.currentUser);
                console.log('🏢 Company ID:', window.authManager.currentUser.companyId);
                console.log('👥 User role:', window.authManager.currentUser.role);
                
                // Trigger the authorization process
                updateMenuWithFeatureAuthorization()
                    .then(() => {
                        console.log('✅ Menu authorization test completed');
                        window.debugMenuState();
                    })
                    .catch(error => {
                        console.error('❌ Menu authorization test failed:', error);
                    });
            } else {
                console.log('❌ No authenticated user found for testing');
            }
        };

        // Test function to check current authorization state
        window.checkAuthorizationState = function() {
            console.log('🔍 Checking current authorization state...');
            
            if (window.authManager) {
                console.log('✅ AuthManager available:', !!window.authManager);
                console.log('👤 Current user:', window.authManager.currentUser);
                
                if (window.authManager.currentUser) {
                    const user = window.authManager.currentUser;
                    console.log('📊 User details:');
                    console.log('  - Email:', user.email);
                    console.log('  - Company ID:', user.companyId);
                    console.log('  - Role:', user.role);
                    console.log('  - UID:', user.uid);
                }
            } else {
                console.log('❌ AuthManager not available');
            }
            
            // Check Firebase auth state
            if (firebase && firebase.auth()) {
                const firebaseUser = firebase.auth().currentUser;
                console.log('🔥 Firebase auth user:', firebaseUser ? firebaseUser.email : 'None');
            } else {
                console.log('❌ Firebase auth not available');
            }
            
            // Check menu state
            window.debugMenuState();
        };
    </script>
    
    <!-- Embedded Notification Manager -->
    <script>
        // NotificationManager class - adapted for embedded Firebase v8
        class NotificationManager {
            constructor() {
                this.notifications = this.loadNotifications();
                this.settings = this.loadSettings();
                this.initializeNotifications();
            }

            loadSettings() {
                const defaultSettings = {
                    emailNotifications: true,
                    notifySubmitter: true,
                    notifyApprovers: true,
                    notifyOnComplete: true,
                    systemUpdates: true,
                    securityAlerts: true,
                    notificationDisplay: '30',
                    showReadNotifications: true
                };

                const savedSettings = localStorage.getItem('notificationSettings');
                return savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            }

            initializeNotifications() {
                // Wait for DOM to be ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.setupNotificationElements();
                    });
                } else {
                    this.setupNotificationElements();
                }
            }

            setupNotificationElements() {
                // Add event listeners
                const notificationBtn = document.getElementById('notificationBtn');
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', () => {
                        const dropdown = document.querySelector('.notification-dropdown');
                        if (dropdown) {
                            dropdown.classList.toggle('show');
                        }
                    });
                }

                // Handle mark all as read
                const markAllReadBtn = document.querySelector('.mark-all-read');
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', () => {
                        this.markAllAsRead();
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications')) {
                        const dropdown = document.querySelector('.notification-dropdown');
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    }
                });

                // Force update badge after setup
                this.updateNotificationBadge();
                this.renderNotifications();
                this.startPeriodicBadgeUpdate();
                this.addSampleNotificationsIfEmpty();
            }

            startPeriodicBadgeUpdate() {
                // Update badge every 30 seconds
                setInterval(() => {
                    this.updateNotificationBadge();
                }, 30000);
            }

            addSampleNotificationsIfEmpty() {
                // Only add sample notifications if there are no existing notifications
                if (this.notifications.length === 0) {
                    this.addNotification({
                        type: 'System Update',
                        message: 'Welcome to the HSE Management System! Your role management is ready to use.'
                    });
                    
                    this.addNotification({
                        type: 'Info',
                        message: 'You can create and manage custom roles for your company.'
                    });
                }
            }

            loadNotifications() {
                const notifications = localStorage.getItem('notifications');
                return notifications ? JSON.parse(notifications) : [];
            }

            saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
                setTimeout(() => {
                    this.updateNotificationBadge();
                }, 10);
                this.renderNotifications();
            }

            addNotification(notification) {
                const newNotification = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    read: false,
                    ...notification
                };

                this.notifications.unshift(newNotification);
                this.saveNotifications();
            }

            markAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.saveNotifications();
                }
            }

            markAllAsRead() {
                this.notifications.forEach(notification => {
                    notification.read = true;
                });
                this.saveNotifications();
            }

            updateNotificationBadge() {
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    const unreadCount = this.notifications.filter(n => !n.read).length;
                    badge.textContent = unreadCount.toString();
                    
                    if (unreadCount > 0) {
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            renderNotifications() {
                const notificationList = document.querySelector('.notification-list');
                if (!notificationList) return;

                notificationList.innerHTML = '';

                // Filter notifications by date
                const daysToShow = parseInt(this.settings.notificationDisplay);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysToShow);
                
                let filteredNotifications = this.notifications.filter(notification => 
                    new Date(notification.timestamp) > cutoffDate
                );

                // Filter read notifications if setting is disabled
                if (!this.settings.showReadNotifications) {
                    filteredNotifications = filteredNotifications.filter(n => !n.read);
                }

                if (filteredNotifications.length === 0) {
                    notificationList.innerHTML = '<div class="notification-item">No notifications</div>';
                    return;
                }

                filteredNotifications.forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                    
                    const date = new Date(notification.timestamp);
                    const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                    notificationElement.innerHTML = `
                        <div class="notification-header">
                            <span class="notification-type">${notification.type}</span>
                            <span class="notification-time">${timeString}</span>
                        </div>
                        <div class="notification-content">${notification.message}</div>
                    `;

                    notificationElement.addEventListener('click', () => {
                        this.markAsRead(notification.id);
                        if (notification.link) {
                            window.location.href = notification.link;
                        }
                    });

                    notificationList.appendChild(notificationElement);
                });
            }
        }

        // Initialize notification manager
        window.notificationManager = new NotificationManager();
    </script>
    
    <script>
        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // Debug: Log elements found
            console.log('Tab buttons found:', tabButtons.length);
            console.log('Tab contents found:', tabContents.length);

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    console.log('Clicked tab:', targetTab);

                    // Prevent double-clicking the same tab
                    if (this.classList.contains('active')) {
                        return;
                    }

                    // Add loading effect to button
                    this.style.pointerEvents = 'none';
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add fade-out class to all contents first
                    tabContents.forEach(content => {
                        content.classList.add('fade-out');
                        content.classList.remove('active');
                    });

                    // Add active class to clicked button
                    this.classList.add('active');

                    // Show corresponding tab content after a short delay for smooth transition
                    setTimeout(() => {
                        const targetContent = document.getElementById(targetTab + 'Tab');
                        console.log('Target content element:', targetContent);
                        
                        if (targetContent) {
                            // Remove fade-out and add active class
                            tabContents.forEach(content => content.classList.remove('fade-out'));
                            targetContent.classList.add('active');
                            console.log('Added active class to:', targetTab + 'Tab');
                        } else {
                            console.error('Could not find element with ID:', targetTab + 'Tab');
                        }
                        
                        // Re-enable button
                        this.style.pointerEvents = 'auto';
                    }, 150);
                });
            });

            // Initial setup - make sure first tab is active
            const firstTabButton = document.querySelector('.tab-button.active');
            if (firstTabButton) {
                const targetTab = firstTabButton.getAttribute('data-tab');
                const targetContent = document.getElementById(targetTab + 'Tab');
                if (targetContent && !targetContent.classList.contains('active')) {
                    targetContent.classList.add('active');
                    console.log('Initial tab setup completed for:', targetTab + 'Tab');
                }
            }

            // Add keyboard navigation support
            tabButtons.forEach((button, index) => {
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const nextIndex = e.key === 'ArrowLeft' 
                            ? (index - 1 + tabButtons.length) % tabButtons.length
                            : (index + 1) % tabButtons.length;
                        tabButtons[nextIndex].click();
                        tabButtons[nextIndex].focus();
                    }
                });
                
                // Make tabs focusable
                button.setAttribute('tabindex', '0');
            });
        });            // Role selection functionality
            const roleCards = document.querySelectorAll('.role-card');
            const permissionsTab = document.querySelector('[data-tab="permissions"]');
            
            roleCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Prevent double-clicking
                    if (this.classList.contains('updating')) return;
                    
                    // Add updating state
                    this.classList.add('updating');
                    
                    // Remove active class from all role cards
                    roleCards.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked card after a brief delay
                    setTimeout(() => {
                        this.classList.add('active');
                        this.classList.remove('updating');
                    }, 500);
                    
                    // Get role type
                    const roleType = this.getAttribute('data-role');
                    console.log('Selected role:', roleType);
                    
                    // Update permissions section header
                    const permissionsTitle = document.querySelector('.permissions-section h2');
                    if (permissionsTitle) {
                        setTimeout(() => {
                            permissionsTitle.innerHTML = `<i class="fas fa-key"></i> ${this.querySelector('.role-name').textContent} Permissions`;
                        }, 250);
                    }
                    
                    // Simulate loading permissions for the selected role
                    setTimeout(() => {
                        updatePermissionsForRole(roleType);
                    }, 300);
                });
            });
        
        function updatePermissionsForRole(roleType) {
            const checkboxes = document.querySelectorAll('.permissions-container input[type="checkbox"]');
            
            // Clear all checkboxes first
            checkboxes.forEach(checkbox => checkbox.checked = false);
            
            // Set permissions based on role type
            const rolePermissions = {
                'manager': ['company_management_view', 'company_management_edit', 
                           'profile_view', 'profile_edit',
                           'safety_view', 'safety_create', 'safety_edit',
                           'user_management_view', 'user_management_edit',
                           'hr_view', 'staff_management_view', 'staff_management_create', 'staff_management_edit', 'staff_management_delete', 'staff_management_export', 'staff_management_import',
                           'salary_management_view', 'salary_management_create', 'salary_management_edit', 'salary_management_delete', 'salary_management_export',
                           'authority_to_recruit_view', 'job_advertising_view', 
                           'screening_view', 'interview_view', 'hiring_view', 'offer_view', 'contract_view', 'onboarding_view'],
                'employee': ['company_management_view', 'profile_view', 'safety_view', 'safety_create', 'user_management_view',
                            'hr_view', 'staff_management_view'],
                'viewer': ['company_management_view', 'profile_view', 'safety_view', 'user_management_view', 'hr_view']
            };
            
            const permissions = rolePermissions[roleType] || [];
            permissions.forEach(permission => {
                const checkbox = document.querySelector(`input[data-permission="${permission}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    // Add visual feedback
                    const container = checkbox.closest('.checkbox-container');
                    if (container) {
                        container.style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
                        setTimeout(() => {
                            container.style.background = '';
                        }, 300);
                    }
                }
            });
        }
        
        // Function to update user avatar display
        async function updateUserAvatar() {
            try {
                const userAvatarImg = document.getElementById('userAvatar');
                if (!userAvatarImg) {
                    console.log('👤 User avatar element not found');
                    return;
                }
                
                if (!window.authManager || !window.authManager.currentUser) {
                    console.log('👤 No authenticated user found for avatar update');
                    return;
                }
                
                const currentUser = window.authManager.currentUser;
                console.log('👤 Updating avatar for user:', currentUser.uid);
                
                // Show loading state
                const originalSrc = userAvatarImg.src;
                const loadingSvg = `data:image/svg+xml;base64,${btoa(`
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="#e0e0e0"/>
                        <circle cx="20" cy="20" r="8" fill="#999">
                            <animate attributeName="r" values="6;10;6" dur="1.5s" repeatCount="indefinite"/>
                            <animate attributeName="opacity" values="1;0.3;1" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                `)}`;
                userAvatarImg.src = loadingSvg;
                
                // Try to get custom avatar URL
                let avatarUrl = null;
                try {
                    if (window.firebase && window.firebase.storage) {
                        const storage = window.firebase.storage();
                        const avatarPath = `avatars/${currentUser.uid}/profile.jpg`;
                        const avatarRef = storage.ref(avatarPath);
                        avatarUrl = await avatarRef.getDownloadURL();
                        console.log('👤 Custom avatar found:', avatarUrl);
                    }
                } catch (error) {
                    console.log('👤 No custom avatar found, using initials');
                }
                
                if (avatarUrl) {
                    // Display custom avatar
                    userAvatarImg.src = avatarUrl;
                    userAvatarImg.alt = 'Profile Picture';
                    userAvatarImg.title = `${currentUser.displayName || currentUser.email || 'User'} - Click to access profile menu`;
                    userAvatarImg.style.borderRadius = '50%';
                    userAvatarImg.style.objectFit = 'cover';
                    console.log('👤 Custom avatar displayed successfully');
                    
                    // Add error handling for failed image loads
                    userAvatarImg.onerror = function() {
                        console.log('👤 Failed to load custom avatar, falling back to initials');
                        generateInitialsAvatar();
                    };
                } else {
                    generateInitialsAvatar();
                }
                
                function generateInitialsAvatar() {
                    // Generate initials avatar
                    const displayName = currentUser.displayName || currentUser.email || 'User';
                    const initials = displayName.split(' ')
                        .map(name => name.charAt(0).toUpperCase())
                        .join('')
                        .substring(0, 2);
                    
                    // Create SVG with initials and random color
                    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
                    const colorIndex = Math.abs(currentUser.uid.split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % colors.length;
                    const backgroundColor = colors[colorIndex];
                    
                    const svgAvatar = `data:image/svg+xml;base64,${btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                            <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                        </svg>
                    `)}`;
                    
                    userAvatarImg.src = svgAvatar;
                    userAvatarImg.alt = displayName + ' Avatar';
                    userAvatarImg.title = `${displayName} - Click to access profile menu`;
                    userAvatarImg.onerror = null; // Remove error handler
                    console.log('👤 Initials avatar displayed:', initials, 'with color:', backgroundColor);
                }
            } catch (error) {
                console.error('👤 Error updating user avatar:', error);
                // Restore original src if there was an error
                if (userAvatarImg && originalSrc) {
                    userAvatarImg.src = originalSrc;
                }
            }
        }
    </script>

    <!-- Authentication Script -->
    <script type="module">
        // Authentication is automatically initialized by auth.js
        // The AuthManager constructor handles login verification and page access checks
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Roles page loaded - authentication check completed by AuthManager');
            
            // Menu visibility is handled entirely by updateMenuWithFeatureAuthorization
            // No additional calls needed here
            
            // Initialize company branding with fallback
            setTimeout(() => {
                if (window.authManager) {
                    console.log('🏢 Checking for company branding...');
                    if (window.authManager.currentCompany) {
                        window.authManager.updateCompanyBranding();
                    } else {
                        console.log('🏢 No company data available, showing fallback branding');
                        window.authManager.showFallbackBranding();
                    }
                    
                    // Update user avatar display
                    console.log('👤 Updating user avatar...');
                    updateUserAvatar();
                    
                    // Make avatar update function globally available
                    window.updateUserAvatar = updateUserAvatar;
                    
                    // Set up periodic avatar refresh (every 30 seconds)
                    setInterval(updateUserAvatar, 30000);
                } else {
                    console.log('❌ AuthManager not available, showing basic branding');
                    // Basic fallback branding
                    const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                    const headerCompanyName = document.getElementById('headerCompanyName');
                    
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                    if (headerCompanyName) {
                        headerCompanyName.textContent = '';
                    }
                }
            }, 500); // Give AuthManager time to initialize
            
            // Show authentication status indicator briefly
            const authStatus = document.getElementById('authStatus');
            if (authStatus) {
                authStatus.style.display = 'block';
                setTimeout(() => {
                    authStatus.style.transition = 'opacity 0.5s ease-out';
                    authStatus.style.opacity = '0';
                    setTimeout(() => {
                        authStatus.style.display = 'none';
                    }, 500);
                }, 2000);
            }
            
            // Add role-based access message
            if (window.authManager && window.authManager.currentUser) {
                const userRole = window.authManager.currentUser.role;
                console.log(`Roles page accessed by user with role: ${userRole}`);
                
                // Check if user has appropriate role for roles management
                const allowedRoles = ['manager'];
                if (!allowedRoles.includes(userRole)) {
                    console.warn('User does not have sufficient privileges for roles management');
                }
            }
            
            // Initialize profile dropdown
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }
            
            // Fallback avatar update with retry mechanism
            let avatarUpdateAttempts = 0;
            const maxAvatarUpdateAttempts = 10;
            
            const tryUpdateAvatar = () => {
                if (window.authManager && window.authManager.currentUser) {
                    updateUserAvatar();
                    console.log('👤 Avatar updated successfully on attempt', avatarUpdateAttempts + 1);
                } else if (avatarUpdateAttempts < maxAvatarUpdateAttempts) {
                    avatarUpdateAttempts++;
                    console.log('👤 AuthManager not ready, retrying avatar update in 1 second... (attempt', avatarUpdateAttempts, '/', maxAvatarUpdateAttempts, ')');
                    setTimeout(tryUpdateAvatar, 1000);
                } else {
                    console.log('👤 Max avatar update attempts reached, giving up');
                }
            };
            
            // Start the retry mechanism
            tryUpdateAvatar();
            
            // Handle logout
            const logoutBtn = document.querySelector('.profile-dropdown a[href="#"]');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (window.authManager) {
                        window.authManager.logout();
                    }
                });
            }
        });
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // All styles are embedded in this file - no external CSS files needed
  console.log('✅ Role Management page loaded successfully');
  
  // Debug: Check if essential elements are present
  const sidebar = document.querySelector('.sidebar');
  const mainContent = document.querySelector('.main-content');
  const contentHeader = document.querySelector('.content-header');
  
  console.log('🔍 Page elements check:');
  console.log('- Sidebar:', sidebar ? '✅ Found' : '❌ Missing');
  console.log('- Main content:', mainContent ? '✅ Found' : '❌ Missing');
  console.log('- Content header:', contentHeader ? '✅ Found' : '❌ Missing');
  
  // Check if auth manager is ready and menu visibility is working
  if (window.authManager) {
    console.log('✅ AuthManager available');
    if (window.authManager.currentUser) {
      console.log('✅ User authenticated');
      console.log('🔧 Menu visibility will be managed by AuthManager');
    } else {
      console.log('⚠️ No authenticated user found');
    }
  } else {
    console.log('❌ AuthManager not available');
  }
  
  // Show a temporary success message
  const testDiv = document.createElement('div');
  testDiv.style.cssText = `
    position: fixed;
    top: 50px;
    right: 10px;
    background: #10b981;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 1000;
  `;
  testDiv.innerHTML = '<i class="fas fa-check"></i> Page loaded - Menu permissions active';
  document.body.appendChild(testDiv);
  
  // Remove after 3 seconds
  setTimeout(() => {
    testDiv.remove();
  }, 3000);
});

// Global function for select all functionality
function toggleSelectAllRoles() {
    const selectAllCheckbox = document.getElementById('selectAllRolesCheckbox');
    const roleCheckboxes = document.querySelectorAll('.role-checkbox');
    
    if (selectAllCheckbox && roleCheckboxes.length > 0) {
        roleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateBulkActionsVisibility();
    }
}

        // Platform Feature Update Listener - Listen for updates from super admin dashboard
        function initializePlatformFeatureUpdateListener() {
            console.log('🔧 Initializing platform feature update listener for roles.html...');
            
            // Check for feature updates on page load
            checkForPlatformFeatureUpdates();
            
            // Listen for custom events (real-time updates)
            window.addEventListener('platformFeatureUpdated', (event) => {
                console.log('📡 Received real-time platform feature update:', event.detail);
                handlePlatformFeatureUpdate(event.detail);
            });
            
            // Poll for localStorage updates every 5 seconds
            setInterval(checkForPlatformFeatureUpdates, 5000);
            
            console.log('✅ Platform feature update listener initialized for roles.html');
        }

        function checkForPlatformFeatureUpdates() {
            try {
                const updateSignal = localStorage.getItem('platformFeatureUpdate');
                if (updateSignal) {
                    const signal = JSON.parse(updateSignal);
                    
                    // Check if this is a new update (not processed before)
                    const lastProcessedTimestamp = sessionStorage.getItem('lastFeatureUpdateProcessed_roles');
                    if (!lastProcessedTimestamp || signal.timestamp > parseInt(lastProcessedTimestamp)) {
                        console.log('📱 New platform feature update detected in roles.html:', signal);
                        handlePlatformFeatureUpdate(signal);
                        
                        // Mark this update as processed for roles.html
                        sessionStorage.setItem('lastFeatureUpdateProcessed_roles', signal.timestamp.toString());
                    }
                }
            } catch (error) {
                console.error('❌ Error checking for platform feature updates in roles.html:', error);
            }
        }

        // Debounced platform feature update handler
        let platformFeatureUpdateTimeout = null;
        
        function handlePlatformFeatureUpdate(updateSignal) {
            try {
                const actionType = updateSignal.deleted ? 'deleted' : 'updated';
                console.log(`🔄 Processing platform feature ${actionType} for feature: ${updateSignal.featureName} (${updateSignal.featureId}) in roles.html`);
                
                if (!updateSignal.deleted) {
                    console.log('📋 New authorized pages:', updateSignal.authorizedPages);
                }
                
                // Debounce multiple rapid updates
                if (platformFeatureUpdateTimeout) {
                    clearTimeout(platformFeatureUpdateTimeout);
                }
                
                platformFeatureUpdateTimeout = setTimeout(() => {
                    console.log('🔧 Applying debounced menu visibility update due to platform feature change in roles.html...');
                    
                    if (typeof window.updateMenuWithFeatureAuthorization === 'function') {
                        console.log('🔧 Triggering feature-based menu update...');
                        window.updateMenuWithFeatureAuthorization();
                        console.log('✅ Feature-based menu update completed');
                    } else {
                        console.log('⚠️ updateMenuWithFeatureAuthorization function not available');
                    }
                }, 300); // 300ms debounce
                
                // Show notification about the feature update
                showFeatureUpdateNotification(updateSignal, actionType);
                
            } catch (error) {
                console.error('❌ Error handling platform feature update in roles.html:', error);
            }
        }

        // Show notification about feature updates
        function showFeatureUpdateNotification(updateSignal, actionType) {
            try {
                const message = updateSignal.deleted 
                    ? `Platform feature "${updateSignal.featureName}" has been deleted. Menu visibility refreshed.`
                    : `Platform feature "${updateSignal.featureName}" has been updated. Menu visibility refreshed.`;
                
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #3498db;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 10000;
                    max-width: 350px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                
                document.body.appendChild(notification);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
                
                console.log(`ℹ️ Platform feature "${updateSignal.featureName}" ${actionType} - menu refreshed in roles.html`);
                
            } catch (error) {
                console.error('❌ Error showing feature update notification in roles.html:', error);
            }
        }

        // Apply menu visibility specifically for roles.html
        function applyMenuVisibilityInRoles(authorizedPages) {
            console.log('🎯 Applying menu visibility in roles.html with authorized pages:', authorizedPages);
            
            // Reset all menu items to hidden first
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            
            // Create set of authorized features
            const authorizedFeatures = new Set();
            authorizedPages.forEach(pageInfo => {
                if (pageInfo.feature) {
                    authorizedFeatures.add(pageInfo.feature);
                }
            });
            
            console.log('🔐 Authorized features:', Array.from(authorizedFeatures));
            
            // Show authorized menu items
            const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
            let visibleCount = 0;
            
            allMenuItems.forEach(menuItem => {
                const featureAttribute = menuItem.getAttribute('data-feature');
                const isAuthorized = authorizedFeatures.has(featureAttribute);
                const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                
                if (isDropdownContainer) {
                    return; // Handle dropdowns separately
                }
                
                if (isAuthorized) {
                    menuItem.classList.add('menu-visible');
                    visibleCount++;
                    console.log(`✅ Showing menu item: ${featureAttribute}`);
                } else {
                    menuItem.classList.remove('menu-visible');
                    console.log(`❌ Hiding menu item: ${featureAttribute}`);
                }
            });
            
            // Handle dropdown menus
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                let hasVisibleChildren = false;
                
                submenuItems.forEach(submenuItem => {
                    if (submenuItem.classList.contains('menu-visible')) {
                        hasVisibleChildren = true;
                    }
                });
                
                if (hasVisibleChildren) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing dropdown menu: ${dropdownFeature}`);
                } else {
                    dropdown.classList.remove('menu-visible');
                    console.log(`❌ Hiding dropdown menu: ${dropdownFeature}`);
                }
            });
            
            console.log(`🎯 Menu visibility applied in roles.html - ${visibleCount} items visible`);
        }

        // Show notification about feature update
        function showFeatureUpdateNotification(updateSignal, actionType) {
            try {
                const message = updateSignal.deleted 
                    ? `Platform feature "${updateSignal.featureName}" has been deleted. Menu visibility refreshed.`
                    : `Platform feature "${updateSignal.featureName}" has been updated. Menu visibility refreshed.`;
                
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #3498db;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 10000;
                    max-width: 350px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                
                document.body.appendChild(notification);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
                
                console.log(`ℹ️ Platform feature "${updateSignal.featureName}" ${actionType} - menu refreshed in roles.html`);
                
            } catch (error) {
                console.error('❌ Error showing feature update notification in roles.html:', error);
            }
        }

        // Platform feature listener initialization is now handled by centralized DOMContentLoaded listener above

        // Test function to verify menu visibility update listener for roles.html
        window.testMenuVisibilityListenerRoles = function() {
            console.log('🧪 Testing menu visibility update listener for roles.html...');
            console.log('📡 Checking for updates...');
            checkForPlatformFeatureUpdates();
            console.log('✅ Test completed for roles.html. Check console for any detected updates.');
        };

        // Debug function to check current company's selected features for roles.html
        window.debugCompanyFeaturesRoles = async function() {
            console.log('🔍 Debugging current company features for roles.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                }
                
                if (!companyId && currentUser) {
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found in roles.html');
                    return;
                }
                
                const companySnapshot = await firebase.database().ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                const featuresSnapshot = await firebase.database().ref('/platformFeatures').once('value');
                const featuresData = featuresSnapshot.val();
                
                console.log('🏢 Company data for roles.html:', {
                    name: companyData?.name,
                    selectedFeatures: companyData?.selectedFeatures
                });
                
                if (companyData?.selectedFeatures) {
                    console.log('🎯 Selected features with details in roles.html:');
                    companyData.selectedFeatures.forEach(featureId => {
                        const feature = featuresData[featureId];
                        if (feature) {
                            console.log(`  📦 ${feature.name} (${featureId}):`, {
                                status: feature.status,
                                authorizedPages: feature.authorizedPages
                            });
                        } else {
                            console.log(`  ❌ Feature ${featureId} not found in platform features`);
                        }
                    });
                } else {
                    console.log('⚠️ Company has no selected features');
                }
                
            } catch (error) {
                console.error('❌ Error debugging company features in roles.html:', error);
            }
        };

        // Global functions attached to window for proper scoping
        window.updateBulkActionsVisibility = function() {
            const selectedCheckboxes = document.querySelectorAll('.role-checkbox:checked');
            const bulkActions = document.querySelector('.bulk-actions');
            
            if (bulkActions) {
                bulkActions.style.display = selectedCheckboxes.length > 0 ? 'flex' : 'none';
            }
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllRolesCheckbox');
            const roleCheckboxes = document.querySelectorAll('.role-checkbox');
            
            if (selectAllCheckbox && roleCheckboxes.length > 0) {
                const checkedCount = document.querySelectorAll('.role-checkbox:checked').length;
                selectAllCheckbox.checked = checkedCount === roleCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < roleCheckboxes.length;
            }
        };
        
        window.bulkDeleteRoles = function() {
            const selectedCheckboxes = document.querySelectorAll('.role-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.roleId);
            
            if (selectedIds.length === 0) return;
            
            const confirmMessage = `Are you sure you want to delete ${selectedIds.length} role${selectedIds.length > 1 ? 's' : ''}? This action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                // Here you would typically call your role deletion API
                selectedIds.forEach(roleId => {
                    if (window.authManager?.roleManager) {
                        window.authManager.roleManager.deleteRole(roleId);
                    }
                });
                
                // Clear selections
                selectedCheckboxes.forEach(cb => cb.checked = false);
                window.updateBulkActionsVisibility();
            }
        };

        // Enhanced fallback function to ensure critical menu items are visible
        window.ensureCriticalMenuItemsVisible = function() {
            console.log('🔧 Checking menu items visibility based on actual permissions...');

            // Only show items that have permissions or don't require permissions
            // This should be handled by the permission system, not force-showing everything
            const menuItems = document.querySelectorAll('[data-feature]');

            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                // If item doesn't require permission, show it (like fuel_management, environment_view, security_view)
                if (!requiresPermission) {
                    item.classList.add('menu-visible');
                    console.log(`✅ Made visible (no permission required): ${feature}`);
                } else {
                    // If item requires permission, it should only be shown by the permission system
                    console.log(`⏳ Permission required for: ${feature} (${requiresPermission})`);
                }
            });

            // Ensure parent dropdowns are visible if they have visible children or don't require permissions
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const requiresPermission = dropdown.getAttribute('data-requires-permission');
                const visibleChildren = dropdown.querySelectorAll('.submenu li.menu-visible');
                
                if (!requiresPermission || visibleChildren.length > 0) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Made dropdown visible: ${dropdown.getAttribute('data-feature')}`);
                }
            });

            console.log('🔧 Permission-based menu items visibility check completed');
        };
  
  // Auto-run critical menu visibility after a delay to override any hiding
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        window.ensureCriticalMenuItemsVisible();
    }, 2000);
  });

</script>
</body>
</html>