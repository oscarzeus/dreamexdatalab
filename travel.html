<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Travel Requests - Dreamex Datalab HSE</title>
	<!-- Step 1 Skeleton Implementation -->

	<!-- Firebase v8 CDN -->
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

	<!-- Icons -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<!-- Export Libraries -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	
	<!-- EmailJS CDN for email service -->
	<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

	<style>
		:root {
			--primary-color: #2c3e50;
			--secondary-color: #3498db;
			--accent-color: #e74c3c;
			--text-color: #333;
			--bg-color: #f5f6fa;
			--sidebar-width: 250px;
			--font-family: 'Inter', system-ui, -apple-system, sans-serif;
			--base-font-size: 0.9rem;
			--transition-speed: 0.2s;
		}
		* { margin:0; padding:0; box-sizing: border-box; }
		body { font-family: var(--font-family); font-size: var(--base-font-size); background:#f8f9fa; color:#333; }
		.app-container { display:flex; min-height:100vh; }
		.sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; z-index:1000; transition:transform 0.3s ease; }
		.sidebar .logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); }
		.menu { list-style:none; margin-top:1.5rem; }
		.menu li { margin-bottom:0.4rem; }
		.menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.55rem 0.75rem; border-radius:6px; font-size:0.8rem; transition:background .25s; }
		.menu a:hover, .menu a.active { background:var(--secondary-color); }
		.menu-dropdown .submenu { display:none; list-style:none; margin-left:1rem; }
		.menu-dropdown:hover .submenu { display:block; }
		/* Permission visibility */
		[data-feature]:not(.menu-visible) { display:none !important; }
		.menu-dropdown:not(.menu-visible) { display:none !important; }
		/* Hide all menu items while loading to prevent flicker */
		.sidebar.menu-loading [data-feature] { display:none !important; }
		/* Main content */
		.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.5rem; padding-top:4rem; transition:margin-left 0.3s ease; }
		.top-nav { position:fixed; top:0.25rem; left:calc(var(--sidebar-width) + 0.5rem); right:0.5rem; height:50px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 0.75rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-radius:4px; z-index:200; transition:left .3s; }
		.top-nav-left { display:flex; align-items:center; gap:0.75rem; }
		.sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
		.company-branding { display:flex; align-items:center; gap:0.5rem; }
		#headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
		#headerCompanyName { font-weight:600; font-size:0.85rem; }
		.top-nav-right { display:flex; align-items:center; gap:1rem; }
		
		/* Notification Styles */
		.notifications {
			position: relative;
			display: flex;
			align-items: center;
		}

		.notification-btn {
			background: none;
			border: none;
			cursor: pointer;
			position: relative;
			font-size: 1.2rem;
			padding: 0.5rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.notification-badge {
			position: absolute;
			top: -5px;
			right: -5px;
			background-color: var(--accent-color);
			color: white;
			border-radius: 50%;
			padding: 0.2rem 0.5rem;
			font-size: 0.7rem;
		}

		.notification-dropdown {
			display: none;
			position: absolute;
			right: 0;
			top: 100%;
			width: 300px;
			background-color: white;
			border-radius: 5px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			z-index: 1000;
		}

		.notification-dropdown.show {
			display: block;
		}

		.notification-header {
			padding: 1rem;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.notification-header h3 {
			margin: 0;
			font-size: 1rem;
		}

		.mark-all-read {
			background: none;
			border: none;
			color: var(--primary-color);
			cursor: pointer;
			font-size: 0.8rem;
		}

		.notification-list {
			max-height: 300px;
			overflow-y: auto;
		}

		.notification-item {
			padding: 0.75rem 1rem;
			border-bottom: 1px solid #f0f0f0;
			cursor: pointer;
		}

		.notification-item:hover {
			background-color: #f8f9fa;
		}

		.notification-item.unread {
			background-color: #f0f8ff;
		}
		
		/* User Profile Styles */
		.profile-btn { background:none; border:none; cursor:pointer; padding:0; }
		.profile-btn img { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#eee; }
		.profile-dropdown { position:absolute; top:100%; right:0; background:#fff; border:1px solid #ddd; border-radius:6px; padding:0; display:none; min-width:220px; box-shadow:0 4px 12px rgba(0,0,0,0.12); }
		.profile-dropdown.show { display:block; }
		.profile-dropdown ul { list-style:none; }
		.profile-dropdown li a { display:flex; align-items:center; gap:8px; padding:10px 14px; text-decoration:none; color:#333; font-size:0.8rem; }
		.profile-dropdown li a:hover { background:#f5f5f5; }
		/* Page header */
		.page-header { background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)); color:#fff; padding:0.75rem 1rem; margin:0 0 0.5rem 0; border-radius:0; display:flex; align-items:center; justify-content:space-between; box-shadow:0 4px 18px rgba(0,0,0,0.15); }
		.page-header h1 { font-size:0.95rem; font-weight:600; display:flex; align-items:center; gap:0.5rem; }
		.page-actions { display:flex; gap:0.5rem; }
		.btn-primary { background:var(--secondary-color); color:#fff; }
		.btn-outline { background:#fff; color:var(--secondary-color); border:1px solid var(--secondary-color); }
		.btn:hover { opacity:0.9; }
		/* Table */
		.table-container { background:#fff; border-radius:6px; box-shadow:0 12px 36px rgba(0,0,0,0.12),0 4px 12px rgba(0,0,0,0.08); overflow:hidden; display:flex; flex-direction:column; height:calc(100vh - 170px); }
		.table-wrapper { flex:1; overflow:auto; }
		table { width:100%; border-collapse:collapse; font-size:0.65rem; }
		thead th { position:sticky; top:0; background:#f0f2f5; text-align:left; padding:0.45rem 0.6rem; font-weight:600; border-bottom:2px solid #e2e6ea; white-space:nowrap; }
		tbody td { padding:0.4rem 0.6rem; border-bottom:1px solid #eee; }
		tbody tr:hover { background:#fafafa; }
		.status-chip { padding:0.2rem 0.5rem; border-radius:12px; font-size:0.55rem; font-weight:600; background:#e0e7ff; color:#1f3b7d; display:inline-block; }
		.actions { display:flex; gap:0.3rem; }
		.actions button { font-size:0.55rem; padding:0.25rem 0.45rem; border-radius:4px; border:none; cursor:pointer; background:#f0f0f0; }
		/* Modal */
		.modal { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding:2rem 1rem; z-index:10000; }
		.modal.show { display:flex; }
		.modal-content { background:#fff; width:100%; max-width:1000px; border-radius:10px; padding:1.25rem 1.5rem 1.5rem; max-height:85vh; overflow:auto; box-shadow:0 18px 48px rgba(0,0,0,0.25); }
		.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem; }
		.modal-header h2 { font-size:0.85rem; font-weight:600; }
		.close-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666; }
		form .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:0.75rem; }
		.form-group { display:flex; flex-direction:column; gap:0.25rem; }
		.form-group label { font-size:0.6rem; font-weight:600; color:#444; text-transform:uppercase; letter-spacing:.5px; }
		.form-group input, .form-group select, .form-group textarea { padding:0.4rem 0.5rem; font-size:0.65rem; border:1px solid #d0d5db; border-radius:6px; background:#fff; height:36px; box-sizing:border-box; }
		.form-group textarea { resize:vertical; min-height:60px; height:auto; }
		.btn { border:none; cursor:pointer; border-radius:6px; padding:0.45rem 0.85rem; font-size:0.7rem; font-weight:500; display:inline-flex; align-items:center; gap:0.4rem; transition:.25s; height:36px; box-sizing:border-box; }
		.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--secondary-color); box-shadow:0 0 0 2px rgba(52,152,219,0.25); }
		.inline-tags { display:flex; gap:0.4rem; flex-wrap:wrap; }
		.inline-tags label { display:flex; align-items:center; gap:0.25rem; background:#f4f6f9; padding:0.3rem 0.55rem; border-radius:20px; font-size:0.55rem; cursor:pointer; border:1px solid #e0e4e8; }
		.cost-summary { background:#f8fafc; border:1px solid #e2e8f0; padding:0.6rem 0.8rem; border-radius:8px; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:0.5rem; margin-top:0.6rem; }
		.summary-item { font-size:0.6rem; display:flex; flex-direction:column; gap:0.15rem; }
		.summary-item span:first-child { font-weight:600; color:#444; }
		.form-actions { margin-top:0.9rem; display:flex; justify-content:flex-end; gap:0.5rem; }
		.empty-state { padding:2rem; text-align:center; color:#666; font-size:0.75rem; }
	.fieldset-title { grid-column:1/-1; font-size:0.55rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#6a6f75; margin-top:0.4rem; padding-top:0.4rem; border-top:1px dashed #d5dadd; display:flex; align-items:center; gap:0.35rem; }
	.fieldset-title i { font-size:0.6rem; opacity:0.7; }
	.error-msg { font-size:0.5rem; color:#b91c1c; display:none; }
	.has-error input, .has-error select, .has-error textarea { border-color:#dc2626; box-shadow:0 0 0 2px rgba(220,38,38,0.2); }
	.filter-bar { display:flex; flex-wrap:wrap; gap:0.5rem; margin:0 0 0.5rem 0; }
	.filter-bar .filter-group { display:flex; flex-direction:column; gap:0.2rem; }
	.filter-bar label { font-size:0.55rem; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:#555; }
	.filter-bar input, .filter-bar select { padding:0.35rem 0.45rem; font-size:0.6rem; border:1px solid #d0d5db; border-radius:5px; }
	.tag-chip { background:#eef2f7; border:1px solid #d4dae1; padding:0.18rem 0.5rem; font-size:0.55rem; border-radius:14px; font-weight:500; display:inline-flex; align-items:center; gap:0.35rem; }
	.tag-chip span { color:#334155; }
	.inline-note { font-size:0.5rem; color:#6b7280; }
	.hidden { display:none !important; }
	/* Mode fields removed */
	.badge-required { background:#fee2e2; color:#991b1b; padding:0.15rem 0.4rem; font-size:0.5rem; border-radius:4px; font-weight:600; }
	.status-chip.pending { background:#fef3c7; color:#92400e; }
	.status-chip.approved { background:#dcfce7; color:#166534; }
	.status-chip.declined { background:#fee2e2; color:#991b1b; }
	.status-chip.cancelled { background:#e2e8f0; color:#475569; }
	.btn-icon { background:#fff; border:1px solid #cfd6dd; color:#334155; }
	.btn-icon:hover { background:#f1f5f9; }
	.page-actions .btn-icon { padding:0.45rem 0.65rem; }
	.tooltip { position:relative; }
	.tooltip:hover::after { content:attr(data-tip); position:absolute; top:calc(100% + 4px); left:50%; transform:translateX(-50%); background:#1e293b; color:#fff; font-size:0.55rem; padding:0.25rem 0.4rem; border-radius:4px; white-space:nowrap; z-index:50; }
		/* Sidebar Collapse Functionality */
		.sidebar.collapsed {
			transform: translateX(-100%);
		}
		
		.main-content.sidebar-collapsed {
			margin-left: 0;
		}
		
		.main-content.sidebar-collapsed .top-nav {
			left: 0.5rem;
		}
		
		/* Responsive */
		@media (max-width:900px){ .main-content { margin-left:0; } .sidebar { transform:translateX(-100%); transition:transform .3s; } .sidebar.open { transform:translateX(0); } .top-nav { left:0.5rem; } }
		
		/* Attachment Display Styles */
		.attachment-item {
			transition: all 0.2s ease;
			border: 1px solid #e9ecef !important;
		}
		.attachment-item:hover {
			background-color: #f1f3f4 !important;
			border-color: #dee2e6 !important;
		}
		.attachment-item .fas {
			font-size: 1.2rem;
		}
		.attachment-item .fw-semibold {
			font-size: 0.85rem;
			color: #495057;
		}
		.attachment-item .text-muted {
			font-size: 0.75rem;
		}
		
		/* Approval Flow Styles */
		.approval-step {
			transition: all 0.2s ease;
		}
		.approval-step.current {
			background-color: #fef3c7 !important;
			border-left: 4px solid #f59e0b;
			padding-left: .6rem !important;
		}
		.approval-step.completed {
			background-color: #d1fae5 !important;
			border-left: 4px solid #10b981;
			padding-left: .6rem !important;
		}
		.approval-step.rejected {
			background-color: #fee2e2 !important;
			border-left: 4px solid #ef4444;
			padding-left: .6rem !important;
		}
		.btn-approve {
			background: #10b981;
			color: white;
			border: none;
		}
		.btn-approve:hover {
			background: #059669;
		}
		
		/* Tab Navigation Styles */
		.tab-navigation {
			display: flex;
			gap: 0;
			margin-bottom: 1.5rem;
			border-bottom: 2px solid #e2e8f0;
		}
		
		.tab-button {
			background: none;
			border: none;
			padding: 0.75rem 1.5rem;
			cursor: pointer;
			font-size: 0.9rem;
			font-weight: 500;
			color: #64748b;
			border-bottom: 3px solid transparent;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}
		
		.tab-button:hover {
			color: #334155;
			background: #f8fafc;
		}
		
		.tab-button.active {
			color: #3b82f6;
			border-bottom-color: #3b82f6;
			background: #eff6ff;
		}
		
		.tab-content {
			display: none;
		}
		
		.tab-content.active {
			display: block;
		}
		
		/* Travel Order Table Styles */
		#travelOrderTable th {
			font-size: 0.75rem;
			padding: 0.5rem;
		}
		
		#travelOrderTable td {
			font-size: 0.8rem;
			padding: 0.5rem;
		}
		
		/* Table Row Hover and Click Styles */
		#travelOrderTable tbody tr {
			cursor: pointer;
			transition: background-color 0.2s ease;
		}
		
		#travelOrderTable tbody tr:hover {
			background-color: #f8fafc;
		}
		
		/* Status Badge Styles */
		.status-badge {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			border-radius: 0.375rem;
			font-size: 0.75rem;
			font-weight: 500;
			text-transform: uppercase;
		}
		
		.status-draft {
			background-color: #f3f4f6;
			color: #374151;
		}
		
		.status-issued {
			background-color: #dbeafe;
			color: #1d4ed8;
		}
		
		.status-completed {
			background-color: #dcfce7;
			color: #166534;
		}
		
		.status-cancelled {
			background-color: #fecaca;
			color: #dc2626;
		}
		
		/* Traveler tag styling */
		.traveler-tag {
			background: #3498db;
			color: white;
			padding: 0.25rem 0.75rem;
			border-radius: 15px;
			font-size: 0.62rem;
			font-weight: 500;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
		}
		
		.traveler-tag .remove-tag {
			background: rgba(255, 255, 255, 0.3);
			border: none;
			color: white;
			border-radius: 50%;
			width: 16px;
			height: 16px;
			font-size: 0.6rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background-color 0.2s ease;
		}
		
		.traveler-tag .remove-tag:hover {
			background: rgba(255, 255, 255, 0.5);
		}
	</style>
</head>
<body>
	<div class="app-container">
		<nav class="sidebar menu-loading" id="sidebar">
			<div class="logo">
				<h2>Dreamex Datalab</h2>
			</div>
			<ul class="menu" id="roleBasedMenu">
				<li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
					<a href="index.html"><i class="fas fa-home"></i> Home</a>
				</li>
				<li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
					<a href="#"><i class="fas fa-medkit"></i> Health</a>
					<ul class="submenu">
						<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
						<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
						<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
					<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
					<ul class="submenu">
						<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
						<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
						<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
						<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
						<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
						<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
						<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="fuel_management">
					<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
					<ul class="submenu">
						<li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
						<li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
						<li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
						<li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
						<li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
						<li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
						<li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
						<li data-feature="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="environment_view">
					<a href="#"><i class="fas fa-leaf"></i> Environment</a>
					<ul class="submenu">
						<li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="security_view">
					<a href="#"><i class="fas fa-lock"></i> Security</a>
					<ul class="submenu">
						<li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
						<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
						<li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
					
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
				</li>
				<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
					<a href="#"><i class="fas fa-truck"></i> Logistics</a>
					<ul class="submenu">
						<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
						<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
						<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
						<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
					<a href="#"><i class="fas fa-users"></i> HR</a>
					<ul class="submenu">
						<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
						<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
						<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
						<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
						<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
						<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
						<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
						<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
						<li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
						<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
						<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
						<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
						<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
						<li data-feature="travel_request_view" data-requires-permission="travel_request_view"><a class="active" href="travel.html">Travel Requests</a></li>
					</ul>
				</li>
				<li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
				<li class="menu-dropdown" data-feature="settings_view">
					<a href="#"><i class="fas fa-cog"></i> Settings</a>
					<ul class="submenu">
						<li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
						<li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
						<li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
						<li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
						<li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
						<li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
						<li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
						<li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
						<li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
					</ul>
				</li>
			</ul>
		</nav>
		<main class="main-content" id="mainContent">
			<nav class="top-nav">
				<div class="top-nav-left">
					<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
					<div class="company-branding">
						<img id="headerCompanyLogo" alt="Company Logo" />
						<span id="headerCompanyName"></span>
					</div>
				</div>
				<div class="top-nav-right">
					<div class="notifications">
						<button id="notificationBtn" class="notification-btn">
							<i class="fas fa-bell"></i>
							<span class="notification-badge">0</span>
						</button>
						<div class="notification-dropdown">
							<div class="notification-header">
								<h3>Notifications</h3>
								<button class="mark-all-read">Mark all as read</button>
							</div>
							<div class="notification-list">
								<!-- Notifications will be dynamically added here -->
							</div>
						</div>
					</div>
					<div class="user-profile" style="position:relative;">
						<button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
						<div class="profile-dropdown"><ul></ul></div>
					</div>
				</div>
			</nav>

			<section class="travel-content">
				<div class="page-header">
					<h1><i class="fas fa-suitcase-rolling"></i> Travel Management</h1>
					<div class="page-actions">
						<button id="newTravelRequestBtn" class="btn btn-primary"><i class="fas fa-plus"></i></button>
					</div>
				</div>

				<!-- Tab Navigation -->
				<div class="tab-navigation">
					<button class="tab-button active" onclick="switchTab('requests')">
						<i class="fas fa-list"></i> Travel Requests
					</button>
					<button class="tab-button" onclick="switchTab('orders')">
						<i class="fas fa-clipboard-list"></i> Travel Order
					</button>
				</div>

				<!-- Travel Requests Tab -->
				<div id="requestsTab" class="tab-content active">
					<div class="table-container">
						<div class="filter-bar" id="filterBar">
							<div class="filter-group">
								<label for="searchTerm">Search</label>
								<input type="text" id="searchTerm" placeholder="Destination / Purpose" />
							</div>
							<div class="filter-group">
								<label for="filterType">Type</label>
								<select id="filterType">
									<option value="">All</option>
									<option value="national">National</option>
									<option value="international">International</option>
								</select>
							</div>
							<div class="filter-group">
								<label for="filterStatus">Status</label>
								<select id="filterStatus">
									<option value="">All</option>
									<option value="Pending Approval">Pending</option>
									<option value="Approved">Approved</option>
									<option value="Declined">Declined</option>
								</select>
							</div>
							<div class="filter-group">
								<label for="fromDate">From</label>
								<input type="date" id="fromDate" />
							</div>
							<div class="filter-group">
								<label for="toDate">To</label>
								<input type="date" id="toDate" />
							</div>
						</div>
						<div class="table-wrapper">
							<table id="travelRequestsTable">
								<thead>
									<tr>
										<th>ID</th>
										<th>Destination</th>
										<th>Type</th>
										<!-- Mode column removed -->
										<th>Dates</th>
										<th>Per Diem</th>
										<th>Accom.</th>
										<th>Total</th>
										<th>Status</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div id="emptyState" class="empty-state" style="display:none;">
								<i class="fas fa-suitcase-rolling" style="font-size:2rem; margin-bottom:0.5rem; opacity:0.4;"></i>
								<div>No travel requests yet. Click "New Request" to create one.</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Travel Order Tab -->
				<div id="ordersTab" class="tab-content">
					<!-- Travel Orders header removed as requested -->
					
					<div class="table-container">
						<div class="filter-bar">
							<div class="filter-group">
								<label for="orderSearchTerm">Search</label>
								<input type="text" id="orderSearchTerm" placeholder="Order ID / Traveler Name" />
							</div>
							<div class="filter-group">
								<label for="orderFilterStatus">Status</label>
								<select id="orderFilterStatus">
									<option value="">All</option>
									<option value="Draft">Draft</option>
									<option value="Issued">Issued</option>
									<option value="Completed">Completed</option>
									<option value="Cancelled">Cancelled</option>
								</select>
							</div>
							<div class="filter-group">
								<label for="orderFromDate">From</label>
								<input type="date" id="orderFromDate" />
							</div>
							<div class="filter-group">
								<label for="orderToDate">To</label>
								<input type="date" id="orderToDate" />
							</div>
							<button id="refreshOrderBtn" class="btn btn-icon tooltip" data-tip="Refresh" title="Refresh">
								<i class="fas fa-rotate"></i>
							</button>
						</div>
						<div class="table-wrapper">
							<table id="travelOrderTable">
								<thead>
									<tr>
										<th>Order ID</th>
										<th>Traveler(s)</th>
										<th>Origin</th>
										<th>Destination</th>
										<th>Driver</th>
										<th>Vehicle</th>
										<th>Departure</th>
										<th>Return</th>
										<th>Status</th>
										<th>Created Date</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div id="orderEmptyState" class="empty-state" style="display:none;">
								<i class="fas fa-clipboard-list" style="font-size:2rem; margin-bottom:0.5rem; opacity:0.4;"></i>
								<div>No travel orders created yet. Click "Create Travel Order" to start.</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</main>
	</div>

	<!-- Modal -->
	<div class="modal" id="travelRequestModal" aria-hidden="true" role="dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Create Travel Request</h2>
				<button class="close-btn" id="closeModalBtn" aria-label="Close">&times;</button>
			</div>
			<form id="travelRequestForm" autocomplete="off" novalidate>
				<!-- Meta info bar (shown in edit mode) -->
				<div id="requestMetaBar" style="display:none; margin:0 0 .85rem; padding:.55rem .75rem; border:1px solid #e2e8f0; background:#f8fafc; border-radius:6px; font-size:.6rem; line-height:1.3; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.5rem;">
					<div><strong>ID:</strong> <span id="metaReqId">—</span></div>
					<div><strong>Status:</strong> <span id="metaReqStatus" class="status-chip" style="padding:.15rem .45rem; border-radius:14px; background:#eef2f6;">—</span></div>
					<div><strong>Created At:</strong> <span id="metaReqCreatedAt">—</span></div>
					<div><strong>Created By:</strong> <span id="metaReqCreatedBy">—</span></div>
				</div>
				<div class="grid">
					<div class="fieldset-title"><i class="fas fa-route"></i> Core Travel Details</div>
					<div class="form-group">
						<label for="origin">Origin</label>
						<select id="origin" name="origin" required>
							<option value="" disabled selected>Select Origin</option>
						</select>
						<div class="error-msg" data-error-for="origin">Origin is required</div>
					</div>
					<div class="form-group">
						<label for="destination">Destination</label>
						<select id="destination" name="destination" required>
							<option value="" disabled selected>Select Destination</option>
						</select>
						<div class="error-msg" data-error-for="destination">Destination is required</div>
					</div>
					<div class="form-group">
						<label for="travelType">Travel Type</label>
						<select id="travelType" name="travelType" required>
							<option value="national">National</option>
							<option value="international">International</option>
						</select>
						<div class="error-msg" data-error-for="travelType">Select travel type</div>
					</div>
					<div id="internationalFields" class="hidden" style="grid-column:1/-1; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:0.75rem;">
						<div class="fieldset-title" style="border-top:none; margin-top:0;"><i class="fas fa-globe"></i> International Specific</div>
						<div class="form-group">
							<label for="passportExpiry">Passport Expiry</label>
							<input type="date" id="passportExpiry" name="passportExpiry" />
						</div>
						<div class="form-group">
							<label for="visaRequired">Visa Required</label>
							<select id="visaRequired" name="visaRequired">
								<option value="">Select</option>
								<option value="yes">Yes</option>
								<option value="no">No</option>
							</select>
						</div>
					</div>

					<div class="fieldset-title"><i class="fas fa-users"></i> People Traveling</div>
					<div id="peopleSection" style="grid-column:1/-1;">
						<div id="peopleContainer"></div>
						<div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
							<button type="button" id="addPersonBtn" class="btn btn-outline" title="Add Person"><i class="fas fa-plus"></i></button>
							<span class="inline-note">Each person may have separate departure/return dates.</span>
						</div>
					</div>

					<!-- small template (hidden) -->
					   <template id="personRowTemplate">
						   <div class="person-container">
							   <div class="person-row" style="display:grid; grid-template-columns:1.5fr 1fr 0.9fr 0.9fr 1fr 1fr 0.6fr auto; gap:0.5rem; align-items:center; margin-top:0.5rem;">
								   <div class="form-group">
									   <label>Full name</label>
									   <input type="text" name="personName" class="person-name" placeholder="Full name" required />
								   </div>
								   <div class="form-group"><label>Job title</label><input type="text" name="personTitle" class="person-title" placeholder="Job title" /></div>
								   <div class="form-group"><label>Departure</label><input type="date" name="personDeparture" class="person-departure" /></div>
								   <div class="form-group"><label>Return</label><input type="date" name="personReturn" class="person-return" /></div>
								   <div class="form-group"><label>Stay</label>
									   <select name="personStay" class="person-stay">
										   <option value="">Select</option>
										   <option value="camp">Camp</option>
										   <option value="hotel">Hotel</option>
										   <option value="guesthouse">Guesthouse</option>
										   <option value="other">Other</option>
									   </select>
								   </div>
								   <div class="form-group"><label>Contact</label><input type="text" name="personContact" class="person-contact" placeholder="Phone or email" /></div>
								   <div class="form-group"><label>Per Diem</label><input type="number" step="0.01" min="0" name="personPerDiem" class="person-perdiem" placeholder="0.00" /></div>
								   <div style="display:flex; align-items:center; margin-top:1.5rem;">
									   <button type="button" class="btn btn-outline remove-person" title="Remove Person" style="padding:0.4rem; min-width:auto;"><i class="fas fa-trash"></i></button>
								   </div>
							   </div>
							   <div class="form-group" style="margin-top:0.5rem;">
								   <label>Justification</label>
								   <textarea name="personJustification" class="person-justification" placeholder="Explain why this person needs to travel" rows="2" style="resize:vertical;"></textarea>
							   </div>
							   <div class="form-group" style="margin-top:0.5rem;">
								   <label>Attachments</label>
								   <input type="file" name="personAttachments" class="person-attachments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="font-size:0.65rem;" />
								   <small style="font-size:0.55rem; color:#666; margin-top:0.25rem; display:block;">Upload passport, visa, or other travel documents (PDF, DOC, JPG, PNG)</small>
							   </div>
							   <div class="person-separator" style="border-top:1px solid #e2e8f0; margin:1rem 0; opacity:0.7;"></div>
						   </div>
					   </template>
				<div class="fieldset-title"><i class="fas fa-coins"></i> Financials</div>
				<!-- Mode and per-mode transport costs removed -->
				<div class="form-group">
					<label for="costCenter">Cost Center / Dept</label>
					<input type="text" id="costCenter" name="costCenter" placeholder="e.g. FIN-OPS" />
				</div>
				</div>
				<div class="cost-summary" id="costSummary">
					<div class="summary-item"><span>Days</span><strong id="daysDisplay">0</strong></div>
					<div class="summary-item"><span>Per Diem Total</span><strong id="perDiemTotalDisplay">0.00</strong></div>
					<div class="summary-item"><span>Accommodation Total</span><strong id="accommodationTotalDisplay">0.00</strong></div>
					<div class="summary-item"><span>Transport</span><strong id="transportCostDisplay">0.00</strong></div>
					<div class="summary-item"><span>Other</span><strong id="otherCostDisplay">0.00</strong></div>
					<div class="summary-item"><span>Total Cost</span><strong id="totalCostDisplay">0.00</strong></div>
				</div>
				<div class="form-actions">
					<button type="button" class="btn btn-outline" id="cancelFormBtn">Cancel</button>
					<button type="submit" class="btn btn-primary">Submit Request</button>
				</div>
			</form>
		</div>
	</div>

		<!-- View Details Modal -->
		<div class="modal" id="travelRequestViewModal" aria-hidden="true" role="dialog">
			<div class="modal-content" style="max-width:960px;">
				<div class="modal-header">
					<h2>Travel Request Details</h2>
					<button class="close-btn" id="closeViewModalBtn" aria-label="Close">&times;</button>
				</div>
				<div id="travelRequestDetails" style="display:flex; flex-direction:column; gap:0.9rem; font-size:0.62rem; max-height:70vh; overflow:auto;">
					<!-- dynamic content injected here -->
				</div>
				<div class="form-actions" style="justify-content:flex-end; margin-top:1rem;">
					<button type="button" class="btn btn-outline" id="closeViewFooterBtn">Close</button>
				</div>
			</div>
		</div>

		<!-- Create Travel Order Modal -->
		<div class="modal" id="createTravelOrderModal" aria-hidden="true" role="dialog">
			<div class="modal-content" style="max-width:800px;">
				<div class="modal-header">
					<h2>Create Travel Order</h2>
					<button class="close-btn" id="closeTravelOrderModalBtn" aria-label="Close">&times;</button>
				</div>
				<form id="travelOrderForm">
					<div style="display:flex; flex-direction:column; gap:0.9rem; font-size:0.62rem; max-height:70vh; overflow:auto; padding:1rem;">
						<!-- Order Information Grid -->
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.65rem;">
							<div><strong>Order ID:</strong><br>
								<input type="text" id="orderIdField" readonly style="background-color:#f9fafb; border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
							</div>
							<div><strong>Status:</strong><br>
								<select id="orderStatusField" required style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
									<option value="Draft">Draft</option>
									<option value="Issued">Issued</option>
									<option value="Completed">Completed</option>
									<option value="Cancelled">Cancelled</option>
								</select>
							</div>
							<div><strong>Created By:</strong><br>
								<input type="text" id="orderCreatedByField" readonly style="background-color:#f9fafb; border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
							</div>
						</div>
						
						<!-- Travel Information Grid -->
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.65rem;">
							<div><strong>Origin:</strong><br>
								<select id="orderOriginField" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
									<option value="">Select Origin</option>
									<!-- Origin options will be populated dynamically -->
								</select>
							</div>
							<div><strong>Destination:</strong><br>
								<select id="orderDestinationField" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
									<option value="">Select Destination</option>
									<!-- Destination options will be populated dynamically -->
								</select>
							</div>
							<div><strong>Trip Type:</strong><br>
								<select id="orderTripTypeField" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
									<option value="">Select Trip Type</option>
									<option value="one-way">One Way</option>
									<option value="round-trip">Round Trip</option>
								</select>
							</div>
						</div>
						
						<!-- Vehicle and Dates Grid -->
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.65rem;">
							<div><strong>Departure Date:</strong><br>
								<input type="date" id="orderDepartureDateField" required style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
							</div>
							<div id="returnDateContainer"><strong>Return Date:</strong><br>
								<input type="date" id="orderReturnDateField" required style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
							</div>
							<div><strong>Vehicle:</strong><br>
								<select id="orderVehicleField" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
									<option value="">Select Vehicle</option>
									<!-- Vehicle options will be populated dynamically -->
								</select>
								<div id="vehicleAvailabilityStatus" style="font-size:0.55rem; margin-top:0.2rem; color:#6b7280; display:none;"></div>
							</div>
							<div><strong>Driver:</strong><br>
								<input type="text" id="orderDriverField" placeholder="Enter driver name" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
							</div>
							<div><strong>Driver Contact:</strong><br>
								<input type="text" id="orderDriverContactField" placeholder="Enter contact number" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%;">
							</div>
						</div>
						
						<!-- Travelers Section -->
						<div>
							<h3 style="font-size:.7rem; margin:0 0 .4rem; display:flex; align-items:center; gap:.35rem;"><i class="fas fa-users"></i> Select Travelers</h3>
							<select id="approvedTravelersDropdown" onchange="addTraveler()" style="border:1px solid #e2e8f0; padding:0.4rem; border-radius:4px; font-size:0.62rem; width:100%; margin-bottom:.5rem;">
								<option value="">Select Approved Traveler</option>
								<!-- Approved travelers will be populated here -->
							</select>
							<div id="selectedTravelersContainer" style="display:none; margin-top:0.5rem;">
								<div id="selectedTravelersTags" style="display:flex; flex-wrap:wrap; gap:0.5rem;"></div>
							</div>
						</div>
						
						<!-- Notes Section -->
						<div>
							<h3 style="font-size:.7rem; margin:0 0 .4rem; display:flex; align-items:center; gap:.35rem;"><i class="fas fa-sticky-note"></i> Notes</h3>
							<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:.6rem .7rem;">
								<textarea id="orderNotesField" rows="3" placeholder="Additional notes or instructions..." style="border:none; background:transparent; resize:vertical; font-size:0.62rem; width:100%; outline:none;"></textarea>
							</div>
						</div>
					</div>
					
					<div class="form-actions">
						<button type="button" class="btn btn-outline" id="cancelTravelOrderBtn">Cancel</button>
						<button type="submit" class="btn btn-primary">Create Travel Order</button>
					</div>
				</form>
			</div>
		</div>

		<!-- View Travel Order Modal -->
		<div class="modal" id="viewTravelOrderModal" aria-hidden="true" role="dialog">
			<div class="modal-content" style="max-width:900px;">
				<div class="modal-header">
					<h2>Travel Order Details</h2>
					<button class="close-btn" id="closeViewTravelOrderModalBtn" aria-label="Close">&times;</button>
				</div>
				<div style="padding:1.5rem; font-size:0.65rem; max-height:70vh; overflow:auto;">
					<!-- Order Information -->
					<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:1rem; margin-bottom:1rem;">
						<h3 style="margin:0 0 0.8rem; font-size:0.75rem; color:#374151; display:flex; align-items:center; gap:0.5rem;">
							<i class="fas fa-info-circle"></i> Order Information
						</h3>
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:0.8rem;">
							<div><strong>Order ID:</strong><br><span id="viewOrderId">—</span></div>
							<div><strong>Status:</strong><br><span id="viewOrderStatus" class="status-badge">—</span></div>
							<div><strong>Created By:</strong><br><span id="viewOrderCreatedBy">—</span></div>
							<div><strong>Created Date:</strong><br><span id="viewOrderCreatedDate">—</span></div>
						</div>
					</div>
					
					<!-- Travel Information -->
					<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:1rem; margin-bottom:1rem;">
						<h3 style="margin:0 0 0.8rem; font-size:0.75rem; color:#374151; display:flex; align-items:center; gap:0.5rem;">
							<i class="fas fa-route"></i> Travel Information
						</h3>
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:0.8rem;">
							<div><strong>Origin:</strong><br><span id="viewOrderOrigin">—</span></div>
							<div><strong>Destination:</strong><br><span id="viewOrderDestination">—</span></div>
							<div><strong>Departure Date:</strong><br><span id="viewOrderDepartureDate">—</span></div>
							<div><strong>Return Date:</strong><br><span id="viewOrderReturnDate">—</span></div>
						</div>
					</div>
					
					<!-- Vehicle & Driver Information -->
					<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:1rem; margin-bottom:1rem;">
						<h3 style="margin:0 0 0.8rem; font-size:0.75rem; color:#374151; display:flex; align-items:center; gap:0.5rem;">
							<i class="fas fa-car"></i> Vehicle & Driver
						</h3>
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:0.8rem;">
							<div><strong>Vehicle:</strong><br><span id="viewOrderVehicle">—</span></div>
							<div><strong>Driver:</strong><br><span id="viewOrderDriver">—</span></div>
							<div><strong>Driver Contact:</strong><br><span id="viewOrderDriverContact">—</span></div>
						</div>
					</div>
					
					<!-- Travelers Information -->
					<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:1rem; margin-bottom:1rem;">
						<h3 style="margin:0 0 0.8rem; font-size:0.75rem; color:#374151; display:flex; align-items:center; gap:0.5rem;">
							<i class="fas fa-users"></i> Travelers
						</h3>
						<div id="viewOrderTravelers" style="display:flex; flex-wrap:wrap; gap:0.5rem;">
							<!-- Travelers will be populated here -->
						</div>
					</div>
					
					<!-- Notes -->
					<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:1rem;">
						<h3 style="margin:0 0 0.8rem; font-size:0.75rem; color:#374151; display:flex; align-items:center; gap:0.5rem;">
							<i class="fas fa-sticky-note"></i> Notes
						</h3>
						<div id="viewOrderNotes" style="padding:0.5rem; background:#fff; border-radius:4px; min-height:60px; white-space:pre-wrap;">
							<!-- Notes will be populated here -->
						</div>
					</div>
				</div>
				
				<div class="form-actions">
					<button type="button" class="btn btn-outline" id="closeViewTravelOrderBtn">Close</button>
					<button type="button" class="btn btn-primary" id="editFromViewBtn" onclick="editTravelOrderFromView()">Edit Order</button>
				</div>
			</div>
		</div>

		<script>
		// Firebase configuration (same as staff.html)
		const firebaseConfig = {
			apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
			authDomain: "users-8be65.firebaseapp.com",
			databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
			projectId: "users-8be65",
			storageBucket: "users-8be65.firebasestorage.app",
			messagingSenderId: "909025468149",
			appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
			measurementId: "G-XHFMRCJQEZ"
		};
		function initializeFirebase(){ if(!window.firebase || !window.firebase.apps || !window.firebase.apps.length){ window.firebase.initializeApp(firebaseConfig); } return window.firebase; }
		initializeFirebase();

		function getDatabase(){ return initializeFirebase().database(); }
		function ref(db,path){ return db.ref(path); }
		function get(r){ return r.once('value'); }

		// Global database instance
		const database = getDatabase();

		class AuthManager {
			constructor(){ this.currentUser = this.getCurrentUser(); this.db = getDatabase(); this.currentCompany = null; this.initializeAuth(); }
			getCurrentUser(){ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
			setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
			async initializeAuth(){
				if(!this.currentUser){
					console.warn('AuthManager(travel): no user, continuing as guest (redirect disabled)');
					this.currentUser={ uid:'guest', displayName:'Guest User'};
				}
				await this.loadUserCompany();
				await this.updateUIForAuthenticatedUser();
			}
			async loadUserCompany(){ if(!this.currentUser) return; try { const companiesSnap = await get(ref(this.db,'companies')); if(companiesSnap.exists()){ const companies = companiesSnap.val(); for(const [companyId,company] of Object.entries(companies)){ if(company.status !== 'active') continue; if(company.users){ for(const [uid,user] of Object.entries(company.users)){ if(user.authUid === this.currentUser.uid || uid === this.currentUser.uid){ this.currentCompany = company; this.currentUser.companyId = companyId; this.currentUser.companyName = company.companyName; this.updateCompanyBranding(); break; } } } if(this.currentCompany) break; } } } catch(e){ console.error('Company load error', e); } }
			updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ if(logoEl) logoEl.style.display='none'; if(nameEl) nameEl.textContent=''; return; } if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo || this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.style.display='block'; } else { logoEl.style.display='none'; } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
			async updateUIForAuthenticatedUser(){ this.populateUserProfile(); await this.updateMenuVisibility(); }
			getUserDisplayName(){ if(!this.currentUser) return 'User'; return this.currentUser.displayName || this.currentUser.name || (this.currentUser.email? this.currentUser.email.split('@')[0]:'User'); }
			getUserInitials(){ const n=this.getUserDisplayName(); const parts=n.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
			async getUserAvatarUrl(){ try { const storage=window.firebase.storage(); const avatarRef = storage.ref(`avatars/${this.currentUser.uid}/profile.jpg`); return await avatarRef.getDownloadURL(); } catch(e){ return null; } }
			generateInitialsAvatar(name,img){ const initials=this.getUserInitials(); const bg=['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12'][initials.charCodeAt(0)%5]; const svg=`<svg width="40" height="40" xmlns='http://www.w3.org/2000/svg'><rect width='40' height='40' rx='20' fill='${bg}'/><text x='20' y='24' font-size='14' font-family='Arial' fill='#fff' text-anchor='middle' font-weight='600'>${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); }
			async populateUserProfile(){ const btn=document.getElementById('userProfileBtn'); if(!btn || !this.currentUser) return; const img=btn.querySelector('img'); const url=await this.getUserAvatarUrl(); if(url){ img.src=url; } else { this.generateInitialsAvatar(this.getUserDisplayName(), img); } const dropdown=document.querySelector('.profile-dropdown ul'); if(dropdown){ dropdown.innerHTML=`<li style='padding:10px 14px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;'><div style='width:32px;height:32px;border-radius:50%;overflow:hidden;'>${url? `<img src='${url}' style='width:32px;height:32px;object-fit:cover;'/>`: `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:600;">${this.getUserInitials()}</div>`}</div><div style='display:flex;flex-direction:column;'><strong style='font-size:12px;'>${this.getUserDisplayName()}</strong><span style='font-size:10px;color:#666;'>${this.currentUser.email||''}</span></div></li><li><a href='#' id='logoutLink'><i class='fas fa-sign-out-alt'></i> Logout</a></li>`; const logoutLink=document.getElementById('logoutLink'); if(logoutLink){ logoutLink.addEventListener('click', e=>{ e.preventDefault(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='index.html'; }); } } }
			resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=> i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=> d.classList.remove('menu-visible')); }
		}

		// Instantiate AuthManager after DOM loaded
		let authManager; document.addEventListener('DOMContentLoaded', ()=>{ authManager = new AuthManager(); setupUIInteractions(); initTravelModule(); initEmailJS(); });

		// EmailJS Configuration and Service
		class EmailService {
			constructor() {
				// Working EmailJS configuration from staff.html
				this.emailJSPublicKey = 'fHs6oaqQgkcPoUwpv'; // Working public key
				this.emailJSPrivateKey = 'DYBlzuRorbsDIdU5wGBru'; // Working private key
				this.serviceId = 'service_p2e9swy'; // Your service ID
				this.templateId = 'template_uglh3g9'; // Travel order template
				this.isInitialized = false;
			}

			async initialize() {
				try {
					console.log('🔧 Initializing EmailJS...');
					
					// Wait for EmailJS library to load
					let attempts = 0;
					while (typeof emailjs === 'undefined' && attempts < 50) {
						await new Promise(resolve => setTimeout(resolve, 100));
						attempts++;
					}
					
					if (typeof emailjs !== 'undefined') {
						emailjs.init(this.emailJSPublicKey);
						this.isInitialized = true;
						console.log('✅ EmailJS initialized successfully');
						console.log('🔑 Public Key:', this.emailJSPublicKey);
						console.log('🚀 Service ID:', this.serviceId);
						console.log('📝 Template ID:', this.templateId);
					} else {
						console.error('❌ EmailJS library failed to load');
						throw new Error('EmailJS library not available');
					}
				} catch (error) {
					console.error('❌ Error initializing EmailJS:', error);
					this.isInitialized = false;
					throw error;
				}
			}

			async sendTravelOrderEmail(orderData, pdfBlob, recipientEmail) {
				if (!this.isInitialized) {
					throw new Error('EmailJS not initialized');
				}

				try {
					console.log('📧 Preparing travel order email for:', recipientEmail);
					console.log('📋 Order data:', orderData.orderId);

					// Convert PDF blob to base64
					const pdfBase64 = await this.blobToBase64(pdfBlob);
					console.log('✅ PDF converted, size:', pdfBase64.length, 'characters');
					
					// Check if PDF is too large (EmailJS limit is around 3MB)
					if (pdfBase64.length > 3000000) {
						throw new Error('PDF file is too large for email. Please reduce the size.');
					}
					
					// Prepare email parameters matching position creation notification style
					const emailParams = {
						// Basic email configuration (matching staff.html notification style)
						to_email: recipientEmail,
						to_name: 'Travel Manager',
						from_name: 'Dreamex Datalab HSE System',
						subject: `Travel Order Document: ${orderData.orderId}`,
						
						// Position-style fields (adapted for travel orders)
						position_title: `Travel Order ${orderData.orderId}`,
						department: 'Travel Management Department',
						requesting_manager: orderData.createdBy || orderData.requestedBy || 'System Administrator',
						request_date: orderData.createdAt ? new Date(orderData.createdAt).toLocaleDateString() : new Date().toLocaleDateString(),
						position_id: orderData.orderId,
						position_code: orderData.orderId,
						
						// Travel-specific details formatted as notification content
						referenceNumber: orderData.orderId,
						requestedStartDate: orderData.departureDate ? new Date(orderData.departureDate).toLocaleDateString() : 'N/A',
						expectedStartDate: orderData.departureDate ? new Date(orderData.departureDate).toLocaleDateString() : 'N/A',
						priority: orderData.priority || 'Standard',
						employmentType: 'Travel Assignment',
						workLocation: `${orderData.origin || 'N/A'} to ${orderData.destination || 'N/A'}`,
						contractDuration: orderData.departureDate && orderData.returnDate ? 
							`${Math.ceil((new Date(orderData.returnDate) - new Date(orderData.departureDate)) / (1000 * 60 * 60 * 24))} days` : 'N/A',
						workingHours: 'As per travel schedule',
						reportingManager: orderData.createdBy || 'Travel Coordinator',
						
						// Compensation/budget details (adapted for travel)
						salaryMin: 'N/A',
						salaryMax: 'N/A',
						benefitsPackage: 'Travel allowances as per policy',
						annualBudgetImpact: orderData.estimatedCost || 'As per travel budget',
						departmentBudget: 'Travel Department Budget',
						availableBudget: 'Within approved limits',
						
						// Travel justification (formatted as business need)
						businessNeed: `Travel requirement for business operations from ${orderData.origin || 'N/A'} to ${orderData.destination || 'N/A'}`,
						keyResponsibilities: 'Travel to designated location and complete assigned business activities',
						requiredSkills: 'N/A',
						requiredExperience: 'N/A',
						requiredEducation: 'N/A',
						
						// Organizational impact (adapted for travel)
						teamSizeImpact: orderData.travelers ? `${orderData.travelers.length} traveler(s)` : '1 traveler',
						workflowChanges: 'Temporary travel assignment',
						trainingRequired: 'Travel safety briefing',
						equipmentNeeded: 'As per travel requirements',
						officeSpace: 'Temporary location',
						
						// Timeline information
						jobPostingStartDate: 'N/A',
						applicationDeadline: 'N/A',
						interviewPeriod: 'N/A',
						onboardingDuration: 'N/A',
						
						// Approval information
						approvalLink: `${window.location.origin}/travel.html?view=${orderData.firebaseKey || orderData.orderId}`,
						nextApproverRole: 'Travel Manager',
						approvalType: 'Travel Order Review',
						currentStage: '1',
						totalStages: '1',
						
						// Contact information
						requestingManagerEmail: orderData.createdByEmail || 'travel@dreamexdatalab.com',
						hrEmail: 'hr@dreamexdatalab.com',
						budgetTeamEmail: 'finance@dreamexdatalab.com',
						
						// Company information
						company_name: 'Dreamex Datalab',
						company_email: 'info@dreamexdatalab.com',
						
						// Comprehensive message content (matching notification template style)
						message: `================================================================================
🚗                    DREAMEX DATALAB HSE SYSTEM                    🚗
🚗                  TRAVEL ORDER DOCUMENT NOTIFICATION               🚗
🚗                         OFFICIAL CONFIRMATION                     🚗
================================================================================

Dear Travel Manager,

A travel order document has been generated and requires your attention.

TRAVEL ORDER DETAILS:
--------------------------------------------------------------------------------
Reference Number      : ${orderData.orderId}
Travel Purpose        : Business Assignment
Origin Location       : ${orderData.origin || 'N/A'}
Destination Location  : ${orderData.destination || 'N/A'}
Departure Date        : ${orderData.departureDate ? new Date(orderData.departureDate).toLocaleDateString() : 'N/A'}
Return Date           : ${orderData.returnDate ? new Date(orderData.returnDate).toLocaleDateString() : 'N/A'}
Duration              : ${orderData.departureDate && orderData.returnDate ? 
							Math.ceil((new Date(orderData.returnDate) - new Date(orderData.departureDate)) / (1000 * 60 * 60 * 24)) + ' days' : 'N/A'}
Order Status          : ${orderData.status || 'Pending'}

AUTHORIZED TRAVELERS:
--------------------------------------------------------------------------------${orderData.travelers ? orderData.travelers.map((traveler, index) => 
`
${index + 1}. ${traveler.name || 'N/A'} - ${traveler.title || 'Staff Member'}`).join('') : 
`
1. Travel details pending confirmation`}

TRANSPORT ARRANGEMENTS:
--------------------------------------------------------------------------------
Vehicle Assignment    : ${orderData.vehicle ? `${orderData.vehicle.plateNumber} - ${orderData.vehicle.vehicleName || orderData.vehicle.vehicleType}` : 'Not Assigned'}
Driver Assignment     : ${orderData.driver || 'Not Assigned'}
Driver Contact        : ${orderData.driverContact || 'N/A'}

ORDER INFORMATION:
--------------------------------------------------------------------------------
Created By            : ${orderData.createdBy || 'System Administrator'}
Creation Date         : ${orderData.createdAt ? new Date(orderData.createdAt).toLocaleDateString() : new Date().toLocaleDateString()}
Order ID              : ${orderData.orderId}
Current Status        : ${orderData.status || 'Pending'}

📋 TRAVEL ORDER DOCUMENT:
--------------------------------------------------------------------------------
The complete travel order document is attached to this email for your records
and approval processes.

📞 CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions about this travel order:
• Travel Coordinator: ${orderData.createdByEmail || 'travel@dreamexdatalab.com'}
• HR Team: hr@dreamexdatalab.com
• Finance Team: finance@dreamexdatalab.com

🔗 REVIEW LINK:
--------------------------------------------------------------------------------
To review this travel order online:
${window.location.origin}/travel.html?view=${orderData.firebaseKey || orderData.orderId}

Thank you for your attention to this travel order notification.

Best regards,
Dreamex Datalab HSE System
🚗 Automated Travel Order Notification System 🚗

================================================================================
This is an automated travel order notification.
Order ID: ${orderData.orderId} | Generated: ${new Date().toLocaleDateString()}
================================================================================`,
						
						// Dynamic travel order attachment
						travel_order: pdfBase64,
						travel_order_name: `Travel_Order_${orderData.orderId}.pdf`,
						travel_order_size: Math.round(pdfBase64.length / 1024) + ' KB'
					};

					console.log('📨 Sending travel order email via EmailJS...');
					console.log('🔧 Using Service ID:', this.serviceId);
					console.log('🔧 Using Template ID:', this.templateId);
					console.log('📎 Attachment size:', pdfBase64.length, 'characters');
					
					// Use the same method as staff.html - send with public key parameter
					const response = await emailjs.send(
						this.serviceId,
						this.templateId,
						emailParams,
						this.emailJSPublicKey
					);
					
					console.log('✅ Travel order email sent successfully:', response);
					return response;
				} catch (error) {
					console.error('❌ EmailJS Error Details:');
					console.error('  Error object:', error);
					console.error('  Error type:', typeof error);
					console.error('  Error status:', error.status);
					console.error('  Error text:', error.text);
					console.error('  Error message:', error.message);
					
					// Create a meaningful error message
					let meaningfulError = 'Travel order email sending failed';
					
					if (error.status === 400) {
						meaningfulError = 'Bad request - Check template parameters';
					} else if (error.status === 401) {
						meaningfulError = 'Unauthorized - Check EmailJS public key';
					} else if (error.status === 404) {
						meaningfulError = 'Not found - Check service ID and template ID';
					} else if (error.status === 413) {
						meaningfulError = 'File too large - PDF exceeds size limit';
					} else if (error.message) {
						meaningfulError = error.message;
					} else if (error.text) {
						meaningfulError = error.text;
					}
					
					throw new Error(meaningfulError);
				}
			}

			blobToBase64(blob) {
				return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = () => {
						const base64 = reader.result.split(',')[1];
						resolve(base64);
					};
					reader.onerror = reject;
					reader.readAsDataURL(blob);
				});
			}
		}

		// Simple working test function
		async function sendTestEmail() {
			try {
				console.log('🧪 Testing EmailJS with simple message...');
				
				const email = prompt('Enter your email address for testing:');
				if (!email) return;
				
				// Ensure EmailJS is ready
				if (!emailService || !emailService.isInitialized) {
					console.log('🔧 Initializing EmailJS...');
					emailService = new EmailService();
					await emailService.initialize();
				}
				
				const testParams = {
					to_name: 'Test User',
					to_email: email,
					from_name: 'Travel System',
					message: 'This is a test email from the travel management system. If you receive this, the email service is working correctly!'
				};
				
				console.log('📧 Sending test email...');
				const response = await emailjs.send(
					emailService.serviceId,
					emailService.templateId,
					testParams
				);
				
				console.log('✅ Test email sent successfully!', response);
				alert(`✅ Test email sent successfully to ${email}!\nCheck your inbox.`);
				return true;
				
			} catch (error) {
				console.error('❌ Test email failed:', error);
				alert(`❌ Test failed: ${error.message}\nCheck console for details.`);
				return false;
			}
		}

		// Enhanced email function with better error handling
		async function emailTravelOrder(orderKey) {
			let loadingButton = null;
			try {
				console.log('🔍 Starting email process for order:', orderKey);
				
				const order = travelOrders.find(o => o.firebaseKey === orderKey);
				if (!order) {
					alert('Travel order not found');
					return;
				}

				console.log('📋 Order found:', order.orderId);

				// Ensure EmailJS is ready
				if (!emailService || !emailService.isInitialized) {
					console.log('🔧 Initializing EmailJS...');
					emailService = new EmailService();
					await emailService.initialize();
				}

				if (!emailService.isInitialized) {
					throw new Error('EmailJS initialization failed');
				}

				const recipientEmail = prompt('Enter recipient email address:', '');
				if (!recipientEmail) return;

				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailRegex.test(recipientEmail)) {
					alert('Please enter a valid email address');
					return;
				}

				// Show loading
				loadingButton = event.target;
				loadingButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
				loadingButton.disabled = true;

				console.log('📄 Generating PDF...');
				const pdfBlob = await generatePDFBlob(order);
				console.log('✅ PDF generated, size:', pdfBlob.size, 'bytes');
				
				console.log('📨 Sending email...');
				const response = await emailService.sendTravelOrderEmail(order, pdfBlob, recipientEmail);
				console.log('✅ Email sent successfully:', response);
				
				alert(`✅ Travel order emailed successfully to ${recipientEmail}!\n\nOrder ID: ${order.orderId}`);
				
			} catch (error) {
				console.error('❌ Full error object:', error);
				console.error('❌ Error type:', typeof error);
				console.error('❌ Error properties:', Object.keys(error));
				
				let errorMessage = 'Unknown error occurred';
				
				if (error && typeof error === 'object') {
					if (error.message) {
						errorMessage = error.message;
					} else if (error.text) {
						errorMessage = error.text;
					} else if (error.status) {
						errorMessage = `HTTP Error ${error.status}`;
					} else if (error.toString && error.toString() !== '[object Object]') {
						errorMessage = error.toString();
					}
				} else if (typeof error === 'string') {
					errorMessage = error;
				}
				
				console.error('❌ Final error message:', errorMessage);
				alert(`❌ Error sending email: ${errorMessage}\n\nCheck browser console for details.`);
			} finally {
				if (loadingButton) {
					loadingButton.innerHTML = '<i class="fas fa-envelope"></i>';
					loadingButton.disabled = false;
				}
			}
		}

		// Comprehensive EmailJS Debugging and Testing
		async function diagnoseEmailJSIssues() {
			console.log('🔍 === COMPREHENSIVE EMAILJS DIAGNOSIS ===');
			
			// Step 1: Check library loading
			console.log('📚 Step 1: Library Check');
			console.log('  EmailJS global object:', typeof emailjs);
			console.log('  EmailJS send method:', typeof emailjs?.send);
			console.log('  EmailJS init method:', typeof emailjs?.init);
			
			// Step 2: Check service configuration
			console.log('🔧 Step 2: Service Configuration');
			console.log('  Public Key:', emailService?.emailJSPublicKey);
			console.log('  Service ID:', emailService?.serviceId);
			console.log('  Template ID:', emailService?.templateId);
			console.log('  Is Initialized:', emailService?.isInitialized);
			
			// Step 3: Test basic EmailJS connection
			console.log('🌐 Step 3: Testing EmailJS Connection');
			try {
				// Test with minimal template (no attachment)
				const testParams = {
					to_email: 'test@example.com',
					from_name: 'Test System',
					message: 'This is a test email'
				};
				
				console.log('📧 Attempting basic send test...');
				// Note: This will fail but shows us the exact error
				const response = await emailjs.send(
					emailService.serviceId,
					emailService.templateId,
					testParams
				);
				console.log('✅ Basic test succeeded:', response);
			} catch (error) {
				console.log('❌ Basic test failed (expected):', error.message);
				console.log('  Error status:', error.status);
				console.log('  Error text:', error.text);
			}
			
			// Step 4: Check what's actually being sent
			console.log('📝 Step 4: Template Parameter Analysis');
			if (travelOrders.length > 0) {
				const sampleOrder = travelOrders[0];
				console.log('  Sample order structure:', Object.keys(sampleOrder));
				console.log('  Order ID:', sampleOrder.orderId);
				console.log('  Has travelers:', !!sampleOrder.travelers);
				console.log('  Has vehicle:', !!sampleOrder.vehicle);
			}
			
			console.log('🔍 === DIAGNOSIS COMPLETE ===');
			
			// Return configuration for user
			return {
				publicKey: emailService?.emailJSPublicKey,
				serviceId: emailService?.serviceId,
				templateId: emailService?.templateId,
				isReady: emailService?.isInitialized,
				libraryLoaded: typeof emailjs !== 'undefined'
			};
		}

		// Test with simplified parameters (no PDF attachment)
		async function testBasicEmail() {
			try {
				console.log('🧪 Testing basic email without PDF...');
				
				if (!emailService?.isInitialized) {
					console.error('❌ EmailJS not initialized');
					return false;
				}
				
				const email = prompt('Enter test email address:');
				if (!email) return false;
				
				const basicParams = {
					to_email: email,
					from_name: 'Travel Management System',
					order_id: 'TEST-001',
					traveler_names: 'Test Traveler',
					departure_date: '2025-09-01',
					return_date: '2025-09-05',
					origin: 'Test Origin',
					destination: 'Test Destination',
					vehicle: 'Test Vehicle',
					driver: 'Test Driver',
					status: 'Test'
					// NO ATTACHMENT - this is the key difference
				};
				
				console.log('📧 Sending basic email...');
				const response = await emailjs.send(
					emailService.serviceId,
					emailService.templateId,
					basicParams
				);
				
				console.log('✅ Basic email sent successfully:', response);
				alert('✅ Basic email sent successfully! Check your inbox.');
				return true;
				
			} catch (error) {
				console.error('❌ Basic email failed:', error);
				alert(`❌ Basic email failed: ${error.message}`);
				return false;
			}
		}

		// Test EmailJS service readiness
		function testEmailService() {
			console.log('🧪 Testing EmailJS service...');
			console.log('EmailJS library loaded:', typeof emailjs !== 'undefined');
			console.log('EmailService exists:', !!emailService);
			console.log('EmailService initialized:', emailService?.isInitialized);
			console.log('Public Key:', emailService?.emailJSPublicKey);
			console.log('Service ID:', emailService?.serviceId);
			console.log('Template ID:', emailService?.templateId);
			
			if (!emailService || !emailService.isInitialized) {
				console.error('❌ Email service not ready');
				return false;
			}
			
			console.log('✅ Email service ready');
			return true;
		}

		// Initialize EmailJS
		let emailService;
		function initEmailJS() {
			try {
				console.log('🔧 Initializing EmailJS service...');
				emailService = new EmailService();
				emailService.initialize();
				
				// Verify initialization after a short delay
				setTimeout(() => {
					if (emailService && emailService.isInitialized) {
						console.log('✅ EmailJS service ready for travel orders');
					} else {
						console.warn('⚠️ EmailJS service initialization may have failed');
					}
				}, 1000);
			} catch (error) {
				console.error('❌ Error initializing EmailJS:', error);
			}
		}

		// Feature-based authorization system (exactly like staff.html)
		function resetMenuVisibility() {
			document.querySelectorAll('[data-feature]').forEach(item => {
				item.classList.remove('menu-visible');
			});
			document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
				dropdown.classList.remove('menu-visible');
			});
		}

		// Emergency fallback - show basic menu items
		function showBasicMenu() {
			console.log('🔧 Emergency fallback: Showing basic menu items');
			resetMenuVisibility();
			
			// Remove loading class
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
			}
			
			const homeItem = document.querySelector('[data-feature="home_view"]');
			if (homeItem) {
				homeItem.classList.add('menu-visible');
			}
		}

		// NEW: Unrestricted menu visibility helper (does not reveal sidebar)
		function showAllMenus(){
			// Mark everything visible but do NOT remove loading state here.
			document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li=> li.classList.add('menu-visible'));
			document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(li=> li.classList.add('menu-visible'));
			console.log('🔧 showAllMenus: all menu items marked visible (sidebar reveal deferred)');
		}

		// Feature-based authorization system that takes priority over role permissions
		async function updateMenuWithFeatureAuthorization() {
			console.log('🎯 Starting feature-based menu authorization for travel.html...');
			// (Removed shortcut) Always apply company feature filtering first, then role-based filtering.
			
			try {
				let currentUser = null;
				let companyId = null;
				
				// Get user and company info using authManager first
				if (window.authManager && window.authManager.currentUser) {
					currentUser = window.authManager.currentUser;
					companyId = currentUser.companyId;
					console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
				} else if (firebase.auth().currentUser) {
					currentUser = firebase.auth().currentUser;
					console.log('👤 Using Firebase auth - will search for company');
				} else {
					console.log('❌ No authenticated user found');
					resetMenuVisibility();
					return;
				}
				
				// If no company ID from authManager, search companies collection
				if (!companyId && currentUser) {
					console.log('🔍 Searching for user company...');
					const database = firebase.database();
					const companiesRef = database.ref('companies');
					const companiesSnapshot = await companiesRef.once('value');
					
					if (companiesSnapshot.exists()) {
						const companies = companiesSnapshot.val();
						
						for (const [cId, company] of Object.entries(companies)) {
							if (company.status !== 'active') continue;
							
							if (company.users && company.users[currentUser.uid]) {
								companyId = cId;
								console.log(`✅ Found user in company: ${companyId} (${company.name})`);
								break;
							}
						}
					}
				}
				
				if (!companyId) {
					console.error('❌ No company ID found, cannot determine authorized features');
					resetMenuVisibility();
					return;
				}
				
				// Apply feature-based authorization and get list of authorized pages
				const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
			
				// Determine user role (try currentUser.role, otherwise lookup in company users)
				let userRole = currentUser.role || null;
				if(!userRole){
					try{
						const db = firebase.database();
						const userSnap = await db.ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
						if(userSnap.exists()){
							const u = userSnap.val();
							userRole = u.role || u.userRole || 'user';
						}
					}catch(e){
						console.warn('Could not determine user role from company record, defaulting to user', e);
						userRole = 'user';
					}
				}
			
				// Apply role-based filtering within the authorized pages
				await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
				return;
			} catch (error) {
				console.error('❌ Error in feature-based menu authorization:', error);
				resetMenuVisibility();
			}
		}

		// Apply feature-based menu visibility
		async function applyFeatureBasedMenuVisibility(companyId) {
			try {
				console.log('🔧 Applying feature-based menu visibility for company:', companyId);
				
				// Get platform features
				const database = firebase.database();
				const featuresSnapshot = await database.ref('/platformFeatures').once('value');
				
				if (!featuresSnapshot.exists()) {
					console.log('⚠️ No platform features found');
					resetMenuVisibility();
					return;
				}
				
				const featuresData = featuresSnapshot.val();
				
				// Get company's selected features
				const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
				const companyData = companySnapshot.val();
				
				if (!companyData) {
					console.error('❌ Company data not found');
					resetMenuVisibility();
					return;
				}
				
				const subscribedFeatureIds = companyData.selectedFeatures || [];
				console.log('🏢 Company subscribed features:', subscribedFeatureIds);
				
				if (subscribedFeatureIds.length === 0) {
					console.log('⚠️ Company has no subscribed features');
					resetMenuVisibility();
					return;
				}
				
				// Collect authorized pages from subscribed features
				const authorizedPages = [];
				subscribedFeatureIds.forEach(featureId => {
					const feature = featuresData[featureId];
					if (feature && feature.status === 'active' && feature.authorizedPages) {
						console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
						authorizedPages.push(...feature.authorizedPages);
					} else {
						console.log(`⚠️ Feature ${featureId} not found or inactive`);
					}
				});
				
				console.log('🔐 All authorized pages:', authorizedPages);
				
				// Reset all menu items first
				resetMenuVisibility();
				
				// Create set of authorized features
				const authorizedFeatures = new Set();
				authorizedPages.forEach(pageInfo => {
					if (pageInfo.feature) {
						authorizedFeatures.add(pageInfo.feature);
					}
				});
				
				console.log('🎯 Authorized features for travel.html:', Array.from(authorizedFeatures));
				
				// Apply menu visibility
				const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
				let visibleCount = 0;
				
				allMenuItems.forEach(menuItem => {
					const featureAttribute = menuItem.getAttribute('data-feature');
					const isAuthorized = authorizedFeatures.has(featureAttribute);
					const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
					
					if (isDropdownContainer) {
						return; // Handle dropdowns separately after all items are processed
					}
					
					if (isAuthorized) {
						menuItem.classList.add('menu-visible');
						visibleCount++;
						console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
					} else {
						menuItem.classList.remove('menu-visible');
						console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
					}
				});
				
				// Handle dropdown menus - show if they have visible children
				const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
				dropdownMenus.forEach(dropdown => {
					const dropdownFeature = dropdown.getAttribute('data-feature');
					const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
					let hasVisibleChildren = false;
					
					submenuItems.forEach(submenuItem => {
						if (submenuItem.classList.contains('menu-visible')) {
							hasVisibleChildren = true;
						}
					});
					
					if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
						dropdown.classList.add('menu-visible');
						console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
					} else {
						dropdown.classList.remove('menu-visible');
						console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
					}
				});
				
				console.log(`🎯 Feature-based menu authorization completed for travel.html - ${visibleCount} items visible`);
			
				// Return authorizedPages to allow role-based filtering to run afterwards
				return authorizedPages;
			} catch (error) {
				console.error('❌ Error applying feature-based menu visibility:', error);
				resetMenuVisibility();
			}
		}

		// Make updateMenuWithFeatureAuthorization available globally
		window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

		// Apply role-based filtering within company authorized features
		async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
			try {
				console.log('👤 Applying role-based filtering for role:', userRole);
				
				// Get user role permissions from company
				const database = firebase.database();
				const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
				const permissionsSnapshot = await permissionsRef.once('value');
				
				if (!permissionsSnapshot.exists()) {
					console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
					
					// CRITICAL: If user is administrator but no permissions found, provide full access as fallback
					if (userRole === 'administrator') {
						console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
						showSidebarAfterAuth();
						return;
					}
					
					// For other roles without permissions, hide all items with permission requirements
					console.log('❌ No valid permissions found - filtering out items requiring permissions');
					hideItemsRequiringPermissions();
					showSidebarAfterAuth();
					return;
				}
				
				const permissions = permissionsSnapshot.val();
				console.log('✅ Loaded role permissions:', permissions);
				
				// Apply permission-based filtering
				filterMenuByPermissions(permissions);
				
			} catch (error) {
				console.error('❌ Error applying role-based filtering:', error);
				// Don't hide everything on error - keep company features visible
				showSidebarAfterAuth();
			}
		}

		// Filter currently visible menu items by role permissions
		function filterMenuByPermissions(permissions) {
			console.log('🔍 Filtering visible menu items by role permissions...');
			
			if (!permissions) {
				console.log('⚠️ No permissions object provided');
				hideItemsRequiringPermissions();
				showSidebarAfterAuth();
				return;
			}
			
			// Only check items that are already visible from company features
			const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			console.log(`🎯 Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
			
			let hiddenCount = 0;
			
			visibleMenuItems.forEach(item => {
				const requiresPermission = item.getAttribute('data-requires-permission');
				const feature = item.getAttribute('data-feature');
				
				if (requiresPermission) {
					const hasPermission = permissions[requiresPermission];
					const hasViewPermission = hasPermission === true || 
							(hasPermission && hasPermission.view === true);
					
					if (!hasViewPermission) {
						item.classList.remove('menu-visible');
						hiddenCount++;
						console.log(`❌ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
					} else {
						console.log(`✅ Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
					}
				}
			});
			
			// Re-check dropdown menus after permission filtering
			const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
			dropdownMenus.forEach(dropdown => {
				const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
				const dropdownFeature = dropdown.getAttribute('data-feature');
				
				if (submenuItems.length === 0) {
					dropdown.classList.remove('menu-visible');
					console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
				} else {
					console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
				}
			});
			
			console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
			
			// Show sidebar after all filtering is complete
			showSidebarAfterAuth();
		}

		// Hide menu items that require permissions (for users without role permissions)
		function hideItemsRequiringPermissions() {
			console.log('🔒 Hiding all menu items that require permissions...');
			
			const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			let hiddenCount = 0;
			
			itemsRequiringPermissions.forEach(item => {
				const feature = item.getAttribute('data-feature');
				const requiresPermission = item.getAttribute('data-requires-permission');
				
				item.classList.remove('menu-visible');
				hiddenCount++;
				console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
			});
			
			console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
		}

		// Show sidebar and remove loading state after authentication and filtering
		function showSidebarAfterAuth() {
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
				console.log('✅ Sidebar loading state removed - menu authorization complete');
			}
		}

		// Initialize menu visibility properly through authManager (like roles.html and dashboard.html)
		document.addEventListener('DOMContentLoaded', () => {
			// Wait for auth manager to be ready
			setTimeout(async () => {
				try {
					await updateMenuWithFeatureAuthorization();
				} catch (error) {
					console.error('❌ Error initializing feature-based menu:', error);
					showBasicMenu();
				}
			}, 1500);
		});

		// UI interactions (sidebar & profile)
		function setupUIInteractions(){ 
			const sidebarToggle = document.querySelector('#sidebarToggle');
			if (sidebarToggle) {
				sidebarToggle.addEventListener('click', toggleSidebar);
			}
			
			// Notification Bell functionality
			const notificationBtn = document.getElementById('notificationBtn');
			const notificationDropdown = document.querySelector('.notification-dropdown');
			if (notificationBtn && notificationDropdown) {
				notificationBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					notificationDropdown.classList.toggle('show');
				});
				
				// Close notification dropdown when clicking outside
				document.addEventListener('click', (e) => {
					if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
						notificationDropdown.classList.remove('show');
					}
				});
				
				// Mark all as read functionality
				const markAllReadBtn = document.querySelector('.mark-all-read');
				if (markAllReadBtn) {
					markAllReadBtn.addEventListener('click', () => {
						// Update badge count
						const badge = document.querySelector('.notification-badge');
						if (badge) badge.textContent = '0';
						
						// Mark all notifications as read
						const notifications = document.querySelectorAll('.notification-item.unread');
						notifications.forEach(notification => {
							notification.classList.remove('unread');
						});
					});
				}
			}
			
			const profileBtn=document.getElementById('userProfileBtn'); 
			const profileDropdown=document.querySelector('.profile-dropdown'); 
			profileBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); profileDropdown.classList.toggle('show'); }); 
			document.addEventListener('click', (e)=>{ if(!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)){ profileDropdown.classList.remove('show'); } }); 
			
			// Restore sidebar state on page load
			restoreSidebarState();
		}
		
		function toggleSidebar() {
			const sidebar = document.querySelector('.sidebar');
			const mainContent = document.querySelector('.main-content');
			
			if (sidebar && mainContent) {
				sidebar.classList.toggle('collapsed');
				mainContent.classList.toggle('sidebar-collapsed');
				
				// Store sidebar state in localStorage
				const isCollapsed = sidebar.classList.contains('collapsed');
				localStorage.setItem('sidebarCollapsed', isCollapsed);
			}
		}
		
		function restoreSidebarState() {
			const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
			const sidebar = document.querySelector('.sidebar');
			const mainContent = document.querySelector('.main-content');
			
			if (isCollapsed && sidebar && mainContent) {
				sidebar.classList.add('collapsed');
				mainContent.classList.add('sidebar-collapsed');
			}
		}

	// Travel module (Step 3 - Firebase persistence added)
	const travelRequests = []; // Render source
	let travelRequestsByKey = {}; // Map for quick duplicate avoidance
	let travelListenerAttached = false;
	let travelSyncInProgress = false;
	let currentCompanyId = null; // Global company ID for travel orders
		function initTravelModule(){
			const newBtn = document.getElementById('newTravelRequestBtn');
			const modal = document.getElementById('travelRequestModal');
			const closeBtn = document.getElementById('closeModalBtn');
			const cancelBtn = document.getElementById('cancelFormBtn');
			const form = document.getElementById('travelRequestForm');
			const travelType = document.getElementById('travelType');
			const advanceReq = document.getElementById('advanceRequired');
			const searchTerm = document.getElementById('searchTerm');
			const filterType = document.getElementById('filterType');
			const filterStatus = document.getElementById('filterStatus');
			const fromDate = document.getElementById('fromDate');
			const toDate = document.getElementById('toDate');
			// Removed exportExcelBtn, exportPdfBtn, refreshBtn

			// Context-aware + button
			newBtn.addEventListener('click', () => {
				// Check which tab is active
				const requestsTabActive = document.getElementById('requestsTab').classList.contains('active');
				const ordersTabActive = document.getElementById('ordersTab').classList.contains('active');
				if (ordersTabActive) {
					// Open create travel order modal
					if (typeof openCreateTravelOrderModal === 'function') {
						openCreateTravelOrderModal();
					}
				} else {
					// Default: open create travel request modal
					openModal();
				}
			});

			closeBtn.addEventListener('click', ()=> closeModal());
			cancelBtn.addEventListener('click', ()=> closeModal());
			modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
			form.addEventListener('submit', handleSubmit);
			travelType.addEventListener('change', ()=> toggleInternational(travelType.value));
			[searchTerm, filterType, filterStatus, fromDate, toDate].forEach(el=> el.addEventListener('input', applyFilters));
			// Removed exportExcelBtn, exportPdfBtn, refreshBtn event listeners
			document.querySelector('#travelRequestsTable tbody').addEventListener('click', handleRowAction);
			recalcCosts();
			renderTravelRequests();
			waitForCompanyAndAttachListener();
		}
		function waitForCompanyAndAttachListener(attempt=0){ if(attempt>40) return; // ~20s max (500ms interval)
			if(authManager && authManager.currentUser && authManager.currentUser.companyId){ 
				currentCompanyId = authManager.currentUser.companyId; // Set global company ID
				attachTravelRealtimeListener(); 
				// Also initialize travel orders loading
				renderTravelOrders();
			} else { 
				setTimeout(()=> waitForCompanyAndAttachListener(attempt+1), 500); 
			} 
		}
		function attachTravelRealtimeListener(){ if(travelListenerAttached) return; if(!authManager.currentUser.companyId) return; const db=getDatabase(); const companyId=authManager.currentUser.companyId; const path=`companies/${companyId}/travelRequests`; const r=ref(db,path); travelListenerAttached=true; travelSyncInProgress=true; r.on('value', snap=>{ travelSyncInProgress=false; if(!snap.exists()){ travelRequests.length=0; travelRequestsByKey={}; renderTravelRequests(); return; } const data=snap.val(); travelRequestsByKey = data; // Build array sorted by createdAt desc
				const arr = Object.entries(data).map(([key,val])=> ({ firebaseKey:key, ...val }) ); arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0)); travelRequests.length=0; travelRequests.push(...arr); renderTravelRequests(); }, err=>{ console.error('Travel realtime listener error', err); travelListenerAttached=false; setTimeout(()=> attachTravelRealtimeListener(), 5000); }); }
	function toggleInternational(val){ const intl=document.getElementById('internationalFields'); if(val==='international'){ intl.classList.remove('hidden'); } else { intl.classList.add('hidden'); } }
	// Mode fields removed — rebuildModeCostInputs no longer needed
	function validateTravelForm(){ let valid=true; const setError=(name, state)=>{ const msg=document.querySelector(`.error-msg[data-error-for="${name}"]`); const field = document.getElementById(name); if(!msg) return; if(state){ msg.style.display='none'; field?.classList.remove('has-error'); } else { msg.style.display='block'; field?.classList.add('has-error'); valid=false; } }; const origin=document.getElementById('origin').value.trim(); setError('origin', origin.length>0); const destination=document.getElementById('destination').value.trim(); setError('destination', destination.length>0); const travelType=document.getElementById('travelType').value; setError('travelType', !!travelType); 
		// Validate that at least one person is added - use global function
		const people = (window.collectPeopleFromForm) ? window.collectPeopleFromForm() : [];
		if(people.length === 0) {
			alert('Please add at least one person for this travel request.');
			valid = false;
		}
		// Validate people have required fields
		for(let i = 0; i < people.length; i++) {
			const person = people[i];
			if(!person.name || person.name.trim().length === 0) {
				alert(`Person ${i+1}: Name is required.`);
				valid = false;
				break;
			}
		}
		return valid; }
	function applyFilters(){ renderTravelRequests(); }
	function openModal(){ 
		document.getElementById('travelRequestModal').classList.add('show'); 
		document.getElementById('travelRequestModal').setAttribute('aria-hidden','false'); 
		// Auto-add first person if creating new request
		const form = document.getElementById('travelRequestForm');
		if(!form.dataset.editKey || form.dataset.editKey === '') {
			// Only add person if no people are present (new request)
			const peopleContainer = document.getElementById('peopleContainer');
			if(peopleContainer && peopleContainer.children.length === 0) {
				// Add first person automatically for new requests
				setTimeout(() => {
					const addPersonBtn = document.getElementById('addPersonBtn');
					if(addPersonBtn) {
						addPersonBtn.click();
					} else {
						// Fallback: manually add person if button not available yet
						window.addFirstPerson && window.addFirstPerson();
					}
				}, 200);
			}
		}
	}
	function closeModal(){ 
		document.getElementById('travelRequestModal').classList.remove('show'); 
		document.getElementById('travelRequestModal').setAttribute('aria-hidden','true'); 
		const form=document.getElementById('travelRequestForm'); 
		form.reset(); 
		form.dataset.editKey=''; 
		// Clear people section
		const peopleContainer = document.getElementById('peopleContainer');
		if(peopleContainer) peopleContainer.innerHTML = '';
		// Hide meta bar
		const metaBar=document.getElementById('requestMetaBar');
		if(metaBar) metaBar.style.display='none';
		recalcCosts(); 
	}
	async function handleSubmit(e){ e.preventDefault(); if(!validateTravelForm()) return; const form=e.target; const editKey=form.dataset.editKey || null; const submitBtn = form.querySelector('button[type="submit"]'); const originalText = submitBtn.textContent; submitBtn.disabled=true; submitBtn.textContent= editKey? 'Updating...' : 'Saving...'; try { const data=new FormData(form); const days = 1; // Default to 1 day since dates are now per person
const perDiemRate=0; // Removed field
const accommodationRate=0; // Removed field
const transportCost = 0; const otherCost=0; // Removed field
const perDiemTotal = perDiemRate * days; const accommodationTotal = accommodationRate * 0; // nights removed
const totalCost = perDiemTotal + accommodationTotal + transportCost + otherCost; const user = authManager.currentUser || {}; // collect people rows from the form and include in saved object - use global function
const people = (window.collectPeopleFromForm) ? window.collectPeopleFromForm() : [];

if(editKey){ const updated={ origin:data.get('origin'), destination:data.get('destination'), travelType:data.get('travelType'), days, perDiemRate, accommodationRate, perDiemTotal, accommodationTotal, transportCost, otherCost, totalCost, costCenter:data.get('costCenter')||'', passportExpiry:data.get('passportExpiry')||null, visaRequired:data.get('visaRequired')||null, people, updatedAt:Date.now() }; await updateExistingRequest(editKey, updated); } else { const createdAt=Date.now(); const request={ id:'TRV-'+createdAt, origin:data.get('origin'), destination:data.get('destination'), travelType:data.get('travelType'), days, perDiemRate, accommodationRate, perDiemTotal, accommodationTotal, transportCost, otherCost, totalCost, costCenter:data.get('costCenter')||'', passportExpiry:data.get('passportExpiry')||null, visaRequired:data.get('visaRequired')||null, people, status:'Pending Approval', currentApprovalStep: 1, approvalStatus: {}, createdAt, createdBy:{ uid:user.uid||null, email:user.email||null, name:user.displayName||user.name||'' } }; if(!travelListenerAttached){ travelRequests.unshift(request); renderTravelRequests(); } await saveTravelRequestToFirebase(request); } closeModal(); form.dataset.editKey=''; } catch(err){ console.error('Save travel request failed', err); alert('Failed to save travel request.'); } finally { submitBtn.disabled=false; submitBtn.textContent=originalText; } }
	async function saveTravelRequestToFirebase(request){ if(!authManager.currentUser || !authManager.currentUser.companyId){ console.warn('No company context for save'); return; } const db=getDatabase(); const companyId=authManager.currentUser.companyId; const path=`companies/${companyId}/travelRequests`; const collectionRef = ref(db, path); // Use push key for uniqueness
	    const newRef = collectionRef.push(); await newRef.set(request); }
		function recalcCosts(){ const days=1; // Default to 1 day since dates are now per person
			const perDiemRate=0; // Removed field
const accommodationRate=0; // Removed field
const otherCost=0; // Removed field
const transportCost = 0; const perDiemTotal=perDiemRate*days; const accommodationTotal=accommodationRate*0; // nights removed
const totalCost = perDiemTotal + accommodationTotal + transportCost + otherCost; document.getElementById('daysDisplay').textContent=days; document.getElementById('perDiemTotalDisplay').textContent=perDiemTotal.toFixed(2); document.getElementById('accommodationTotalDisplay').textContent=accommodationTotal.toFixed(2); document.getElementById('transportCostDisplay').textContent=transportCost.toFixed(2); document.getElementById('otherCostDisplay').textContent=otherCost.toFixed(2); document.getElementById('totalCostDisplay').textContent=totalCost.toFixed(2); }
	async function renderTravelRequests(){ const tbody=document.querySelector('#travelRequestsTable tbody'); tbody.innerHTML=''; if(travelRequests.length===0){ document.getElementById('emptyState').style.display='block'; return; } const searchTerm=document.getElementById('searchTerm').value.toLowerCase(); const typeFilter=document.getElementById('filterType').value; const statusFilter=document.getElementById('filterStatus').value; const fromDate=document.getElementById('fromDate').value; const toDate=document.getElementById('toDate').value; 
	
	// Filter requests with async approval checking
	const filteredRequests = [];
	for (const r of travelRequests) {
		const matchesSearch = !searchTerm || r.destination.toLowerCase().includes(searchTerm) || (r.id||'').toLowerCase().includes(searchTerm); 
		const matchesType = !typeFilter || r.travelType===typeFilter; 
		const matchesStatus = !statusFilter || r.status===statusFilter; 
		const depOk = true; 
		const retOk = true; 
		
		// Approval-based visibility filtering
		const currentUser = authManager.currentUser;
		if (!currentUser) continue;
		
		// Show if user is the submitter
		const isSubmitter = r.createdBy?.uid === currentUser.uid;
		
		// Show if user can approve this request
		const canApprove = await canUserApproveRequest(r, currentUser);
		
		const visibilityOk = isSubmitter || canApprove;
		
		if (matchesSearch && matchesType && matchesStatus && depOk && retOk && visibilityOk) {
			filteredRequests.push(r);
		}
	} if(filteredRequests.length===0){ document.getElementById('emptyState').style.display='block'; } else { document.getElementById('emptyState').style.display='none'; } filteredRequests.forEach(req=>{ const canEdit = authManager.currentUser && (req.createdBy?.uid === authManager.currentUser.uid); const statusClass=(req.status||'').toLowerCase().replace(/\s+/g,''); const currency=req.currency||''; const peopleSummary = Array.isArray(req.people) && req.people.length? req.people.map(p=>p.name).join(', '): ''; // Show people count instead of dates
const peopleInfo = Array.isArray(req.people) && req.people.length? `${req.people.length} person(s)` : 'No people'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${req.id}</td><td>${req.destination}</td><td>${req.travelType}</td><td>${peopleInfo}</td><td>${currency} ${req.perDiemTotal.toFixed(2)}</td><td>${currency} ${req.accommodationTotal.toFixed(2)}</td><td>${currency} ${req.totalCost.toFixed(2)}</td><td><span class='status-chip ${statusClass}'>${req.status}</span></td><td class='actions'><button class='tooltip' data-tip='View' title='View' data-action='view' data-id='${req.firebaseKey||req.id}'><i class='fas fa-eye'></i></button>${canEdit? `<button class='tooltip' data-tip='Edit' title='Edit' data-action='edit' data-id='${req.firebaseKey||req.id}'><i class='fas fa-edit'></i></button><button class='tooltip' data-tip='Cancel' title='Cancel' data-action='cancel' data-id='${req.firebaseKey||req.id}'><i class='fas fa-ban'></i></button>`:''}</td>`; // attach people summary as title for hover
		if(peopleSummary) tr.querySelector('td').setAttribute('title', peopleSummary);
		tbody.appendChild(tr); }); }
	function findRequestByKey(key){ return travelRequests.find(r=> (r.firebaseKey===key) || (r.id===key)); }
	async function handleRowAction(e){ const btn=e.target.closest('button[data-action]'); if(!btn) return; const action=btn.getAttribute('data-action'); const key=btn.getAttribute('data-id'); const req=findRequestByKey(key); if(!req) return; if(action==='view'){ await openViewModal(req); } else if(action==='edit'){ if(req.createdBy?.uid !== authManager.currentUser?.uid){ alert('You can only edit your own requests.'); return; } openEditModal(req); } else if(action==='cancel'){ cancelRequest(req); } }
	// Helper function to get file icon based on file type
	function getFileIcon(fileName, fileType) {
		const extension = fileName.toLowerCase().split('.').pop();
		if (fileType && fileType.includes('pdf') || extension === 'pdf') {
			return 'fas fa-file-pdf';
		} else if (fileType && fileType.includes('image') || ['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
			return 'fas fa-file-image';
		} else if (['doc', 'docx'].includes(extension)) {
			return 'fas fa-file-word';
		} else if (['xls', 'xlsx'].includes(extension)) {
			return 'fas fa-file-excel';
		} else {
			return 'fas fa-file';
		}
	}

	async function openViewModal(req){
		// Build read-only HTML snapshot
		const container=document.getElementById('travelRequestDetails');
		if(!container) return;
		const fmt=(v)=> (v===undefined||v===null||v==='')?'<span style="opacity:.5;">—</span>': v;
		const toCurrency=(v)=> (Number(v)||0).toFixed(2);
		const createdAt = req.createdAt? new Date(req.createdAt).toLocaleString(): '—';
			   const peopleHtml = (Array.isArray(req.people) && req.people.length)? req.people.map((p,i)=>{
				   return `<div class="person-block" style="border:1px solid #e2e8f0; padding:.6rem .7rem; border-radius:6px; background:#f8fafc; display:flex; flex-direction:column; gap:.35rem;">
					   <div style="font-weight:600; font-size:.6rem; color:#334155;">Person ${i+1}</div>
					   <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:.45rem;">
						   <div><strong>Name:</strong> ${fmt(p.name)}</div>
						   <div><strong>Title:</strong> ${fmt(p.title)}</div>
						   <div><strong>Contact:</strong> ${fmt(p.contact)}</div>
						   <div><strong>Departure:</strong> ${fmt(p.departureDate)}</div>
						   <div><strong>Return:</strong> ${fmt(p.returnDate)}</div>
						   <div><strong>Stay:</strong> ${fmt(p.stay)}</div>
						   <div><strong>Per Diem:</strong> ${toCurrency(p.perDiem||0)}</div>
						   <div><strong>Attachments:</strong> 
							   ${p.attachments && p.attachments.length > 0 ? 
								   `<div class="mt-2">
									   ${p.attachments.map(att => {
										   const sizeInKB = (att.size / 1024).toFixed(1);
										   const icon = getFileIcon(att.name, att.type);
										   return `
											   <div class="d-flex align-items-center mb-2 p-2 border rounded" style="background-color: #f8f9fa;">
												   <i class="${icon} me-2 text-primary"></i>
												   <div class="flex-grow-1">
													   <div class="fw-semibold small">${att.name}</div>
													   <small class="text-muted">${att.type || 'Unknown type'} • ${sizeInKB} KB</small>
												   </div>
											   </div>
										   `;
									   }).join('')}
								   </div>` : 
								   '<span class="text-muted">None</span>'
							   }
						   }
					   </div>
					   <div><strong>Justification:</strong><br>${fmt(p.justification)}</div>
				   </div>`; }).join('') : '<div style="opacity:.6;">No people added.</div>';
		container.innerHTML = `
			<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.65rem;">
				<div><strong>ID:</strong> ${fmt(req.id)}</div>
				<div><strong>Status:</strong> <span class="status-chip" style="padding:.15rem .4rem; border-radius:14px; background:#eef2f6;">${fmt(req.status)}</span></div>
				<div><strong>Created At:</strong> ${createdAt}</div>
				<div><strong>Created By:</strong> ${fmt(req.createdBy?.name||req.createdBy?.email)}</div>
				<div><strong>Origin:</strong> ${fmt(req.origin)}</div>
				<div><strong>Destination:</strong> ${fmt(req.destination)}</div>
				<div><strong>Type:</strong> ${fmt(req.travelType)}</div>
				<div><strong>Days:</strong> ${fmt(req.days)}</div>
				<div><strong>Cost Center:</strong> ${fmt(req.costCenter)}</div>
				${req.travelType === 'international' ? `
				<div><strong>Passport Expiry:</strong> ${fmt(req.passportExpiry ? new Date(req.passportExpiry).toLocaleDateString() : null)}</div>
				<div><strong>Visa Required:</strong> ${fmt(req.visaRequired)}</div>
				` : ''}
			</div>
			<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.55rem; background:#f1f5f9; padding:.6rem .7rem; border-radius:6px;">
				<div><strong>Per Diem Total:</strong><br>${toCurrency(req.perDiemTotal||0)}</div>
				<div><strong>Accommodation Total:</strong><br>${toCurrency(req.accommodationTotal||0)}</div>
				<div><strong>Transport:</strong><br>${toCurrency(req.transportCost||0)}</div>
				<div><strong>Other:</strong><br>${toCurrency(req.otherCost||0)}</div>
				<div><strong>Total Cost:</strong><br>${toCurrency(req.totalCost||0)}</div>
			</div>
			<div>
				<h3 style="font-size:.7rem; margin:0 0 .4rem; display:flex; align-items:center; gap:.35rem;"><i class="fas fa-users"></i> People</h3>
				<div style="display:flex; flex-direction:column; gap:.6rem;">${peopleHtml}</div>
			</div>
			<div>
				<h3 style="font-size:.7rem; margin:0 0 .4rem; display:flex; align-items:center; gap:.35rem;"><i class="fas fa-clipboard-check"></i> Approval Flow</h3>
				<div id="approvalFlowSection" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:.6rem .7rem;">
					<div id="approvalSteps"></div>
				</div>
			</div>
		`;
		
		// Populate approval flow
		populateApprovalFlow(req);
		
		// Update modal footer with approval actions
		await updateViewModalFooter(req);
		
		// Show view modal
		const viewModal=document.getElementById('travelRequestViewModal');
		viewModal.classList.add('show');
		viewModal.setAttribute('aria-hidden','false');
	}

	// Populate approval flow section
	async function populateApprovalFlow(req) {
		const approvalStepsContainer = document.getElementById('approvalSteps');
		if (!approvalStepsContainer) return;

		try {
			// Get approval flow configuration for travel requests
			const approvalFlow = await getApprovalFlowConfig('travel_request');
			if (!approvalFlow || !approvalFlow.selectedRoles || Object.keys(approvalFlow.selectedRoles).length === 0) {
				approvalStepsContainer.innerHTML = '<div style="opacity:.6; font-size:.6rem;">No approval flow configured</div>';
				return;
			}

			// Get current approval status from request
			const approvalStatus = req.approvalStatus || {};
			const currentStep = req.currentApprovalStep || 1;
			const isFullyApproved = req.status === 'Approved';
			const isDeclined = req.status === 'Declined';

			// Generate approval steps HTML based on selectedRoles
			let stepsHtml = '';
			const levelKeys = Object.keys(approvalFlow.selectedRoles).sort((a, b) => {
				const levelA = parseInt(a.replace('level', ''));
				const levelB = parseInt(b.replace('level', ''));
				return levelA - levelB;
			});

			// Add overall status header if request is approved or declined
			if (isFullyApproved || isDeclined) {
				const overallStatusColor = isFullyApproved ? '#10b981' : '#ef4444';
				const overallStatusIcon = isFullyApproved ? 'fas fa-check-circle' : 'fas fa-times-circle';
				const overallStatusText = isFullyApproved ? 'FULLY APPROVED' : 'DECLINED';
				const overallDate = isFullyApproved ? 
					(req.finalApprovedAt ? new Date(req.finalApprovedAt).toLocaleString() : '') :
					(req.finalDeclinedAt ? new Date(req.finalDeclinedAt).toLocaleString() : '');
				
				// Enhanced final approver name display
				let overallApprover = isFullyApproved ? 
					(req.finalApprovedBy || 'System') :
					(req.finalDeclinedBy || 'System');
				
				// If it looks like an email, show just the username part
				if (overallApprover && overallApprover.includes('@')) {
					overallApprover = overallApprover.split('@')[0];
				}

				stepsHtml += `
					<div class="approval-step" id="overallStatus" style="display:flex; align-items:center; gap:.5rem; padding:.6rem; margin-bottom:.5rem; background:${isFullyApproved ? '#d1fae5' : '#fee2e2'}; border:2px solid ${overallStatusColor}; border-radius:6px;">
						<i class="${overallStatusIcon}" style="color: ${overallStatusColor}; font-size:1.2rem;"></i>
						<div style="flex:1;">
							<div style="font-weight:700; font-size:.7rem; color:${overallStatusColor};">${overallStatusText}</div>
							<div class="final-approver-name" style="font-size:.55rem; color:#6b7280;">Final decision by: ${overallApprover}</div>
							${overallDate ? `<div style="font-size:.5rem; color:#9ca3af;">${overallDate}</div>` : ''}
						</div>
					</div>
				`;
			}

			levelKeys.forEach((levelKey, index) => {
				const stepNumber = index + 1;
				const levelApprovers = approvalFlow.selectedRoles[levelKey];
				
				if (!levelApprovers || !Array.isArray(levelApprovers)) return;
				
				const approvalInfo = approvalStatus[levelKey];
				const isCompleted = approvalInfo?.status === 'approved';
				const isRejected = approvalInfo?.status === 'declined';
				const isCurrentStep = stepNumber === currentStep && !isFullyApproved && !isDeclined;
				
				let statusClass = '';
				let statusIcon = '';
				let statusText = '';
				let statusColor = '';
				
				if (isCompleted) {
					statusClass = 'completed';
					statusIcon = 'fas fa-check-circle';
					statusText = 'Approved';
					statusColor = '#10b981';
				} else if (isRejected) {
					statusClass = 'rejected';
					statusIcon = 'fas fa-times-circle';
					statusText = 'Declined';
					statusColor = '#ef4444';
				} else if (isCurrentStep) {
					statusClass = 'current';
					statusIcon = 'fas fa-clock';
					statusText = 'Pending';
					statusColor = '#f59e0b';
				} else {
					statusClass = 'pending';
					statusIcon = 'fas fa-circle';
					statusText = 'Waiting';
					statusColor = '#9ca3af';
				}

				// Get approver display names
				const approverNames = levelApprovers.map(approver => {
					if (approver.value.startsWith('user_')) {
						return approver.text || 'Unknown User';
					} else if (approver.value.startsWith('function_')) {
						return approver.text || approver.value.replace('function_', '');
					} else if (approver.value.startsWith('L+')) {
						return approver.text || approver.value;
					}
					return approver.text || 'Unknown Approver';
				}).join(', ');

				// Enhanced approver name - if we have approval info, try to get better name
				let approverName = approverNames;
				if (approvalInfo && (approvalInfo.status === 'approved' || approvalInfo.status === 'declined')) {
					// If we have the approval info, use the stored approver name
					// If it looks like an email, try to get the user's full name from database
					const storedName = approvalInfo.approverName;
					if (storedName && storedName.includes('@')) {
						// This is likely an email, try to get full name
						if (approvalInfo.approverUid) {
							// We'll store this temporarily and update it asynchronously
							approverName = storedName.split('@')[0]; // Use email username as fallback
							
							// Try to get full name asynchronously
							getUserFullName(approvalInfo.approverUid, storedName).then(fullName => {
								// Update the display if we got a better name
								if (fullName && fullName !== storedName.split('@')[0]) {
									const stepElement = document.querySelector(`[data-level="${levelKey}"] .approver-name`);
									if (stepElement) {
										stepElement.textContent = fullName;
									}
								}
							});
						} else {
							approverName = storedName.split('@')[0];
						}
					} else {
						approverName = storedName || approverNames;
					}
				}

				const approvalDate = approvalInfo?.approvedAt ? new Date(approvalInfo.approvedAt).toLocaleString() : 
									 approvalInfo?.declinedAt ? new Date(approvalInfo.declinedAt).toLocaleString() : '';
				const declineReason = approvalInfo?.declineReason || '';

				stepsHtml += `
					<div class="approval-step ${statusClass}" data-level="${levelKey}" style="display:flex; align-items:center; gap:.5rem; padding:.4rem 0; border-bottom:1px solid #e2e8f0;">
						<i class="${statusIcon}" style="color: ${statusColor};"></i>
						<div style="flex:1;">
							<div style="font-weight:600; font-size:.6rem;">Level ${stepNumber}</div>
							<div class="approver-name" style="font-size:.55rem; color:#6b7280;">${approverName}</div>
							${approvalDate ? `<div style="font-size:.5rem; color:#9ca3af;">${approvalDate}</div>` : ''}
							${declineReason ? `<div style="font-size:.5rem; color:#ef4444; font-style:italic;">Reason: ${declineReason}</div>` : ''}
						</div>
						<div style="font-size:.55rem; font-weight:500; color: ${statusColor};">
							${statusText}
						</div>
					</div>
				`;
			});

			approvalStepsContainer.innerHTML = stepsHtml;
		} catch (error) {
			console.error('Error populating approval flow:', error);
			approvalStepsContainer.innerHTML = '<div style="opacity:.6; font-size:.6rem;">Error loading approval flow</div>';
		}
	}

	// Update modal footer with approval actions
	async function updateViewModalFooter(req) {
		const footerContainer = document.querySelector('#travelRequestViewModal .form-actions');
		if (!footerContainer) return;

		const currentUser = authManager.currentUser;
		if (!currentUser) return;

		// Check if current user can approve this request
		const canApprove = await canUserApproveRequest(req, currentUser);
		const isOwner = req.createdBy?.uid === currentUser.uid;

		console.log(`🔍 updateViewModalFooter: canApprove=${canApprove}, isOwner=${isOwner}, status=${req.status}`);

		let footerHtml = '';
		
		if (canApprove && req.status === 'Pending Approval') {
			console.log('✅ Showing approve/decline buttons');
			footerHtml += `
				<button type="button" class="btn btn-approve" onclick="approveRequest('${req.firebaseKey}')">
					<i class="fas fa-check"></i> Approve
				</button>
				<button type="button" class="btn" onclick="declineRequest('${req.firebaseKey}')" style="background:#ef4444; color:white;">
					<i class="fas fa-times"></i> Decline
				</button>
			`;
		} else {
			console.log('❌ Not showing approve/decline buttons');
		}

		footerHtml += `<button type="button" class="btn btn-outline" id="closeViewFooterBtn">Close</button>`;
		
		footerContainer.innerHTML = footerHtml;
	}

	// Check if user can approve the request
	async function canUserApproveRequest(req, user) {
		if (!user || !user.companyId) {
			console.log('❌ canUserApproveRequest: No user or companyId');
			return false;
		}
		
		try {
			// Get approval flow configuration
			const approvalFlow = await getApprovalFlowConfig('travel_request');
			if (!approvalFlow || !approvalFlow.selectedRoles || Object.keys(approvalFlow.selectedRoles).length === 0) {
				console.log('❌ canUserApproveRequest: No approval flow configured, using fallback');
				// No approval flow configured - fallback to admin/manager roles
				return user.role === 'admin' || user.role === 'manager';
			}

			const currentStep = req.currentApprovalStep || 1;
			const currentLevelKey = `level${currentStep}`;
			
			console.log(`🔍 canUserApproveRequest: Checking step ${currentStep} (${currentLevelKey}) for user ${user.email}`);
			
			// Get the approvers for the current step
			const currentLevelApprovers = approvalFlow.selectedRoles[currentLevelKey];
			if (!currentLevelApprovers || !Array.isArray(currentLevelApprovers)) {
				console.log(`❌ canUserApproveRequest: No approvers found for ${currentLevelKey}`);
				return false;
			}

			console.log(`🔍 canUserApproveRequest: Found ${currentLevelApprovers.length} approvers for ${currentLevelKey}:`, currentLevelApprovers);

			// Check if current user is in the list of approvers for this level
			for (const approver of currentLevelApprovers) {
				console.log(`🔍 Checking approver:`, approver);
				
				// Check user-specific approver (user_uid format)
				if (approver.value === `user_${user.uid}`) {
					console.log(`✅ canUserApproveRequest: User matches specific approver user_${user.uid}`);
					return true;
				}
				
				// Check function/role-based approver (function_title format)
				if (approver.value.startsWith('function_')) {
					const requiredTitle = approver.value.replace('function_', '').toLowerCase();
					const userTitle = (user.jobTitle || user.title || '').toLowerCase();
					console.log(`🔍 Checking function approver: required="${requiredTitle}", user="${userTitle}"`);
					if (userTitle === requiredTitle) {
						console.log(`✅ canUserApproveRequest: User matches function approver ${approver.value}`);
						return true;
					}
				}
				
				// Check level-based approver (L+1, L+2 format)
				if (approver.value.startsWith('L+')) {
					console.log(`🔍 Checking level approver: ${approver.value}, user role: ${user.role}`);
					// This would require hierarchy checking - for now, allow admins/managers
					if (user.role === 'admin' || user.role === 'manager') {
						console.log(`✅ canUserApproveRequest: User matches level approver ${approver.value}`);
						return true;
					}
				}
			}

			console.log(`❌ canUserApproveRequest: User not found in approver list for ${currentLevelKey}`);
			return false;
		} catch (error) {
			console.error('❌ Error checking approval permissions:', error);
			// Fallback to role-based check if approval flow check fails
			return user.role === 'admin' || user.role === 'manager';
		}
	}

	// Get approval flow configuration
	async function getApprovalFlowConfig(processType) {
		try {
			if (!authManager.currentUser?.companyId) return null;
			
			const db = getDatabase();
			const flowRef = ref(db, `companies/${authManager.currentUser.companyId}/approvalFlows/${processType}`);
			const snapshot = await get(flowRef);
			
			return snapshot.exists() ? snapshot.val() : null;
		} catch (error) {
			console.error('Error getting approval flow config:', error);
			return null;
		}
	}

	// Get user full name from database
	async function getUserFullName(userId, fallbackEmail = '') {
		try {
			if (!authManager.currentUser?.companyId || !userId) {
				return fallbackEmail?.split('@')[0] || 'Unknown User';
			}

			const db = getDatabase();
			const userRef = ref(db, `companies/${authManager.currentUser.companyId}/users/${userId}`);
			const snapshot = await get(userRef);
			
			if (snapshot.exists()) {
				const userData = snapshot.val();
				const fullName = userData.displayName || 
								userData.name || 
								(userData.firstName && userData.lastName ? `${userData.firstName} ${userData.lastName}` : '') ||
								userData.email?.split('@')[0] ||
								fallbackEmail?.split('@')[0] ||
								'Unknown User';
				
				console.log(`👤 Retrieved user name for ${userId}: ${fullName}`);
				return fullName;
			}
			
			// Fallback to email username or unknown
			return fallbackEmail?.split('@')[0] || 'Unknown User';
		} catch (error) {
			console.error('Error getting user full name:', error);
			return fallbackEmail?.split('@')[0] || 'Unknown User';
		}
	}

	// Approve request function
	window.approveRequest = async function(requestKey) {
		if (!confirm('Are you sure you want to approve this travel request?')) return;
		
		try {
			const currentUser = authManager.currentUser;
			if (!currentUser?.companyId) return;

			const db = getDatabase();
			const requestRef = ref(db, `companies/${currentUser.companyId}/travelRequests/${requestKey}`);
			
			// Get current request
			const snapshot = await get(requestRef);
			if (!snapshot.exists()) {
				alert('Request not found');
				return;
			}

			const request = snapshot.val();
			const currentStep = request.currentApprovalStep || 1;
			const currentLevelKey = `level${currentStep}`;
			
			// Get better approver name - try multiple sources
			const approverName = currentUser.displayName || 
							   currentUser.name || 
							   (currentUser.firstName && currentUser.lastName ? `${currentUser.firstName} ${currentUser.lastName}` : '') ||
							   currentUser.email?.split('@')[0] || 
							   'Unknown Approver';
			
			// Update approval status for current level
			const updates = {
				[`approvalStatus/${currentLevelKey}/status`]: 'approved',
				[`approvalStatus/${currentLevelKey}/approverName`]: approverName,
				[`approvalStatus/${currentLevelKey}/approverEmail`]: currentUser.email,
				[`approvalStatus/${currentLevelKey}/approverUid`]: currentUser.uid,
				[`approvalStatus/${currentLevelKey}/approvedAt`]: Date.now(),
				updatedAt: Date.now()
			};

			// Check if this is the final approval step
			const approvalFlow = await getApprovalFlowConfig('travel_request');
			const totalSteps = approvalFlow?.selectedRoles ? Object.keys(approvalFlow.selectedRoles).length : 1;
			
			console.log(`🔍 Approval: Current step ${currentStep}, Total steps ${totalSteps}`);
			console.log(`👤 Approver name: ${approverName}`);
			
			if (currentStep >= totalSteps) {
				// Final approval - mark as approved
				updates.status = 'Approved';
				updates.finalApprovedAt = Date.now();
				updates.finalApprovedBy = approverName;
				console.log('✅ Final approval - marking request as Approved');
			} else {
				// Move to next approval step
				updates.currentApprovalStep = currentStep + 1;
				console.log(`📋 Moving to next step: ${currentStep + 1}`);
			}

			await requestRef.update(updates);
			
			// Close modal and refresh
			document.getElementById('travelRequestViewModal').classList.remove('show');
			// Refresh the requests list if function exists
			if (typeof renderTravelRequests === 'function') {
				renderTravelRequests();
			}
			
		} catch (error) {
			console.error('Error approving request:', error);
			alert('Failed to approve request');
		}
	};

	// Decline request function
	window.declineRequest = async function(requestKey) {
		const reason = prompt('Please provide a reason for declining this request:');
		if (!reason) return;
		
		try {
			const currentUser = authManager.currentUser;
			if (!currentUser?.companyId) return;

			const db = getDatabase();
			const requestRef = ref(db, `companies/${currentUser.companyId}/travelRequests/${requestKey}`);
			
			// Get current request to determine current step
			const snapshot = await get(requestRef);
			if (!snapshot.exists()) {
				alert('Request not found');
				return;
			}

			const request = snapshot.val();
			const currentStep = request.currentApprovalStep || 1;
			const currentLevelKey = `level${currentStep}`;
			
			// Get better approver name - try multiple sources
			const approverName = currentUser.displayName || 
							   currentUser.name || 
							   (currentUser.firstName && currentUser.lastName ? `${currentUser.firstName} ${currentUser.lastName}` : '') ||
							   currentUser.email?.split('@')[0] || 
							   'Unknown Approver';
			
			const updates = {
				status: 'Declined',
				[`approvalStatus/${currentLevelKey}/status`]: 'declined',
				[`approvalStatus/${currentLevelKey}/approverName`]: approverName,
				[`approvalStatus/${currentLevelKey}/approverEmail`]: currentUser.email,
				[`approvalStatus/${currentLevelKey}/approverUid`]: currentUser.uid,
				[`approvalStatus/${currentLevelKey}/declinedAt`]: Date.now(),
				[`approvalStatus/${currentLevelKey}/declineReason`]: reason,
				finalDeclinedAt: Date.now(),
				finalDeclinedBy: approverName,
				updatedAt: Date.now()
			};

			console.log(`❌ Declining request at step ${currentStep} (${currentLevelKey})`);
			console.log(`👤 Decliner name: ${approverName}`);

			await requestRef.update(updates);
			
			// Close modal and refresh
			document.getElementById('travelRequestViewModal').classList.remove('show');
			if (typeof renderTravelRequests === 'function') {
				renderTravelRequests();
			}
			
		} catch (error) {
			console.error('Error declining request:', error);
			alert('Failed to decline request');
		}
	};

	// Close handlers for view modal
	document.addEventListener('DOMContentLoaded',()=>{
		const viewModal=document.getElementById('travelRequestViewModal');
		const closeBtns=['closeViewModalBtn','closeViewFooterBtn'];
		closeBtns.forEach(id=> document.getElementById(id)?.addEventListener('click', ()=>{
			viewModal.classList.remove('show');
			viewModal.setAttribute('aria-hidden','true');
		}));
		viewModal.addEventListener('click', (e)=>{ if(e.target===viewModal){ viewModal.classList.remove('show'); viewModal.setAttribute('aria-hidden','true'); } });
	});
	function openEditModal(req){ populateForm(req,false); // ensure meta bar visible
		const form=document.getElementById('travelRequestForm');
		form.dataset.editKey = req.firebaseKey || '';
		document.querySelector('#travelRequestForm .btn[type="submit"]').style.display='';
		const metaBar=document.getElementById('requestMetaBar');
		if(metaBar){
			metaBar.style.display='grid';
			document.getElementById('metaReqId').textContent = req.id || req.firebaseKey || '—';
			document.getElementById('metaReqStatus').textContent = req.status || '—';
			const createdAt = req.createdAt? new Date(req.createdAt).toLocaleString(): '—';
			document.getElementById('metaReqCreatedAt').textContent = createdAt;
			document.getElementById('metaReqCreatedBy').textContent = (req.createdBy?.name)|| (req.createdBy?.email) || '—';
		}
		openModal();
	}
	function populateForm(req, readOnly){ const form=document.getElementById('travelRequestForm'); form.reset(); form.dataset.editKey='';
		// Hide meta unless explicitly enabled in edit path
		const metaBar=document.getElementById('requestMetaBar'); if(metaBar) metaBar.style.display='none';
		const map={ origin:'origin', destination:'destination', travelType:'travelType', costCenter:'costCenter', passportExpiry:'passportExpiry', visaRequired:'visaRequired' };
		Object.entries(map).forEach(([k,id])=>{ if(req && req[k]!==undefined && document.getElementById(id)){ document.getElementById(id).value=req[k]; } });
		// people - use global function with fallback
		if(window.populatePeopleSection) {
			window.populatePeopleSection(req?.people || []);
		} else if(document.populatePeopleSection) {
			document.populatePeopleSection(req?.people || []);
		}
		toggleInternational(req?.travelType); recalcCosts();
		Array.from(form.elements).forEach(el=>{ el.disabled=readOnly; });
	}
	async function cancelRequest(req){ if(!confirm('Cancel this travel request?')) return; if(!authManager.currentUser?.companyId) return; const db=getDatabase(); const path=`companies/${authManager.currentUser.companyId}/travelRequests/${req.firebaseKey}`; try { await ref(db,path).update({ status:'Cancelled', updatedAt: Date.now() }); } catch(err){ console.error('Cancel failed', err); alert('Failed to cancel request.'); } }
	async function updateExistingRequest(editKey, updated){ if(!authManager.currentUser?.companyId || !editKey) return; const db=getDatabase(); const path=`companies/${authManager.currentUser.companyId}/travelRequests/${editKey}`; try { await ref(db,path).update(updated); } catch(err){ console.error('Update failed', err); alert('Failed to update request.'); } }
	function exportTravelToExcel(){ try { const rowsCount=document.querySelectorAll('#travelRequestsTable tbody tr').length; if(rowsCount===0){ alert('No data to export'); return; } const table=document.getElementById('travelRequestsTable'); const wb = XLSX.utils.table_to_book(table, { sheet:'TravelRequests' }); XLSX.writeFile(wb, 'travel_requests.xlsx'); } catch(e){ console.error('Excel export failed', e); alert('Excel export failed'); } }
	function exportTravelToPDF(){ const jsPDFLib = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF; if(!jsPDFLib){ alert('PDF library not loaded'); return; } const doc = new jsPDFLib('l','pt','a4'); doc.setFontSize(14); doc.text('Travel Requests Report', 40,40); let y=70; const headers=['ID','Destination','Type','People','Per Diem','Accom','Total','Status']; doc.setFontSize(10); let xStart=40; const colWidths=[60,140,80,80,70,70,70,60]; let x = xStart; headers.forEach((h,i)=>{ doc.text(h, x, y); x+=colWidths[i]; }); y+=16; const rows = travelRequests.map(r=>[r.id,r.destination,r.travelType,Array.isArray(r.people) && r.people.length? `${r.people.length} person(s)` : 'No people',(r.currency||'')+' '+r.perDiemTotal.toFixed(2),(r.currency||'')+' '+r.accommodationTotal.toFixed(2),(r.currency||'')+' '+r.totalCost.toFixed(2),r.status]); rows.forEach(row=>{ if(y>520){ doc.addPage(); y=50; x=xStart; headers.forEach((h,i)=>{ doc.text(h,x,y); x+=colWidths[i]; }); y+=16; } x=xStart; row.forEach((cell,i)=>{ const text=String(cell); const lines=doc.splitTextToSize(text, colWidths[i]-4); lines.forEach((ln,li)=>{ doc.text(ln, x, y + li*10); }); x+=colWidths[i]; }); y+=14; }); doc.save('travel_requests.pdf'); }
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const originDropdown = document.getElementById('origin');
			const destinationDropdown = document.getElementById('destination');
			// Use explicit RTDB REST endpoint as requested
			const url = 'https://users-8be65-default-rtdb.firebaseio.com/companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area.json';

			fetch(url)
				.then(res => {
					if (!res.ok) throw new Error('Network response was not ok');
					return res.json();
				})
					.then(data => {
						if (!data) return;
						const appendOption = (val, label) => {
							const opt = document.createElement('option');
							opt.value = (val === undefined || val === null) ? String(label) : String(val);
							opt.textContent = String(label);
							originDropdown.appendChild(opt.cloneNode(true));
							destinationDropdown.appendChild(opt.cloneNode(true));
						};

						// Handle array of items
						if (Array.isArray(data)) {
							data.forEach(item => {
								if (item && typeof item === 'object') {
									const label = item.label || item.name || item.title || item.value || JSON.stringify(item);
									const value = item.value || item.id || item.key || label;
									appendOption(value, label);
								} else {
									appendOption(item, item);
								}
							});
						// Handle object map { key: labelOrObject }
						} else if (typeof data === 'object') {
							Object.keys(data).forEach(key => {
								const entry = data[key];
								if (entry && typeof entry === 'object') {
									const label = entry.label || entry.name || entry.title || entry.value || JSON.stringify(entry);
									const value = entry.value || entry.id || key;
									appendOption(value, label);
								} else {
									appendOption(key, entry);
								}
							});
						} else {
							appendOption(data, data);
						}
				})
				.catch(err => {
					console.error('Failed to load work areas from RTDB:', err);
				});
			
			// People section helpers
			const peopleContainer = document.getElementById('peopleContainer');
			const personTemplate = document.getElementById('personRowTemplate');
			const addPersonBtn = document.getElementById('addPersonBtn');
			function addPersonRow(person){
				const tpl = personTemplate.content.cloneNode(true);
				const container = tpl.querySelector('.person-container');
				const row = container.querySelector('.person-row');
				if(person){
					row.querySelector('.person-name').value = person.name || '';
					row.querySelector('.person-title').value = person.title || '';
					row.querySelector('.person-departure').value = person.departureDate || '';
					row.querySelector('.person-return').value = person.returnDate || '';
					row.querySelector('.person-stay').value = person.stay || '';
					row.querySelector('.person-perdiem').value = (person.perDiem !== undefined && person.perDiem !== null) ? person.perDiem : '';
					container.querySelector('.person-justification').value = person.justification || '';
					// Set contact field if present
					if (person.contact !== undefined) {
						row.querySelector('.person-contact').value = person.contact || '';
					}
				}
				row.querySelector('.remove-person').addEventListener('click', ()=>{ container.remove(); });
				peopleContainer.appendChild(container);
				return container;
			}
			function populatePeopleSection(people){ peopleContainer.innerHTML=''; if(!Array.isArray(people) || people.length===0) return; people.forEach(p=> addPersonRow(p)); }
			function collectPeopleFromForm(){ const containers = Array.from(peopleContainer.children); return containers.map(container=>{ const attachmentInput = container.querySelector('.person-attachments'); const attachmentCount = attachmentInput?.files?.length || 0; 
				   // Collect attachment details instead of just count
				   const attachments = [];
				   if(attachmentInput && attachmentInput.files) {
					   for(let i = 0; i < attachmentInput.files.length; i++) {
						   const file = attachmentInput.files[i];
						   attachments.push({
							   name: file.name,
							   size: file.size,
							   type: file.type,
							   lastModified: file.lastModified
						   });
					   }
				   }
				   return {
					   name: container.querySelector('.person-name')?.value?.trim() || '',
					   title: container.querySelector('.person-title')?.value?.trim() || '',
					   contact: container.querySelector('.person-contact')?.value?.trim() || '',
					   departureDate: container.querySelector('.person-departure')?.value || '',
					   returnDate: container.querySelector('.person-return')?.value || '',
					   stay: container.querySelector('.person-stay')?.value || '',
					   perDiem: parseFloat(container.querySelector('.person-perdiem')?.value || '0'),
					   justification: container.querySelector('.person-justification')?.value?.trim() || '',
					   attachmentCount: attachmentCount,
					   attachments: attachments
				   };
			   }).filter(p=>p.name.length>0); }
			addPersonBtn?.addEventListener('click', ()=> addPersonRow({}));
			
			// Expose functions globally for access from other parts of the app
			window.addPersonRow = addPersonRow;
			window.populatePeopleSection = populatePeopleSection;
			window.collectPeopleFromForm = collectPeopleFromForm;
			
			// Global helper to add first person
			window.addFirstPerson = function() {
				const peopleContainer = document.getElementById('peopleContainer');
				if(peopleContainer && peopleContainer.children.length === 0) {
					addPersonRow({});
				}
			};
			
			// expose populate to outer scope (keep for backwards compatibility)
			document.populatePeopleSection = populatePeopleSection;
		});
		
		// Tab switching functionality
		function switchTab(tabName) {
			// Update tab buttons
			document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
			document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
			
			// Update tab content
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
			document.getElementById(tabName + 'Tab').classList.add('active');
			
			// Load data for the active tab
			if (tabName === 'orders') {
				renderTravelOrders();
			} else if (tabName === 'requests') {
				renderTravelRequests();
			}
		}
		
		// Travel Order functionality
		let travelOrders = [];
		
		async function renderTravelOrders() {
			try {
				// Get company ID
				const companyId = authManager?.currentUser?.companyId || currentCompanyId;
				if (!companyId) {
					console.warn('No company ID found for travel orders');
					return;
				}
				
				// Set up real-time listener for travel orders
				const travelOrdersRef = database.ref(`companies/${companyId}/travelOrders`);
				
				// Remove any existing listener
				travelOrdersRef.off();
				
				// Add real-time listener
				travelOrdersRef.on('value', (snapshot) => {
					const ordersData = snapshot.val() || {};
					
					travelOrders = Object.keys(ordersData).map(key => ({
						...ordersData[key],
						firebaseKey: key
					})).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
					
					// Apply filters and render table
					applyOrderFilters();
				});
				
			} catch (error) {
				console.error('Error loading travel orders:', error);
			}
		}
		
		function applyOrderFilters() {
			const searchTerm = document.getElementById('orderSearchTerm')?.value?.toLowerCase() || '';
			const statusFilter = document.getElementById('orderFilterStatus')?.value || '';
			const fromDate = document.getElementById('orderFromDate')?.value || '';
			const toDate = document.getElementById('orderToDate')?.value || '';
			
			const filteredOrders = travelOrders.filter(order => {
				const matchesSearch = !searchTerm || 
					order.orderId.toLowerCase().includes(searchTerm) ||
					order.travelers.some(traveler => traveler.name.toLowerCase().includes(searchTerm));
				const matchesStatus = !statusFilter || order.status === statusFilter;
				const matchesFromDate = !fromDate || order.departureDate >= fromDate;
				const matchesToDate = !toDate || order.returnDate <= toDate;
				
				return matchesSearch && matchesStatus && matchesFromDate && matchesToDate;
			});
			
			renderOrderTable(filteredOrders);
		}
		
		function renderOrderTable(orders) {
			const tbody = document.querySelector('#travelOrderTable tbody');
			const emptyState = document.getElementById('orderEmptyState');
			
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			if (orders.length === 0) {
				emptyState.style.display = 'block';
				return;
			}
			
			emptyState.style.display = 'none';
			
			orders.forEach(order => {
				const tr = document.createElement('tr');
				tr.style.cursor = 'pointer';
				tr.addEventListener('click', (e) => {
					// Don't trigger row click if clicking on action buttons
					if (!e.target.closest('.actions')) {
						viewTravelOrder(order.firebaseKey);
					}
				});
				
				const travelerNames = order.travelers.map(t => t.name).join(', ');
				const travelerCount = order.travelers.length;
				const displayNames = travelerCount > 2 ? 
					`${order.travelers[0].name}, ${order.travelers[1].name} (+${travelerCount - 2} more)` : 
					travelerNames;
				
				// Vehicle information display
				const vehicleDisplay = order.vehicle && order.vehicle.plateNumber ? 
					order.vehicle.plateNumber : '—';
				
				tr.innerHTML = `
					<td>${order.orderId}</td>
					<td title="${travelerNames}">${displayNames}</td>
					<td>${order.origin || '—'}</td>
					<td>${order.destination || '—'}</td>
					<td>${order.driver || '—'}</td>
					<td title="${order.vehicle ? `${order.vehicle.plateNumber} - ${order.vehicle.vehicleName || order.vehicle.vehicleType}` : 'No vehicle assigned'}">${vehicleDisplay}</td>
					<td>${order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—'}</td>
					<td>${order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—'}</td>
					<td><span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></td>
					<td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—'}</td>
					<td class="actions">
						<button class="tooltip" data-tip="View Order" title="View Order" onclick="viewTravelOrder('${order.firebaseKey}')">
							<i class="fas fa-eye"></i>
						</button>
						<button class="tooltip" data-tip="Edit Order" title="Edit Order" onclick="editTravelOrder('${order.firebaseKey}')">
							<i class="fas fa-edit"></i>
						</button>
						<button class="tooltip" data-tip="Print Order" title="Print Order" onclick="printTravelOrder('${order.firebaseKey}')">
							<i class="fas fa-print"></i>
						</button>
						<button class="tooltip" data-tip="Email Order" title="Email Order" onclick="emailTravelOrder('${order.firebaseKey}')">
							<i class="fas fa-envelope"></i>
						</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
		}
		
		function viewOriginalRequest(requestKey) {
			const req = findRequestByKey(requestKey);
			if (req) {
				openViewModal(req);
			}
		}
		
		function exportTravelOrder(requestKey, travelerName) {
			const order = travelOrders.find(o => o.requestKey === requestKey && o.travelerName === travelerName);
			if (!order) {
				alert('Travel order not found');
				return;
			}
			
			// Create a simple travel order export
			const content = `
TRAVEL ORDER

Request ID: ${order.requestId}
Traveler: ${order.travelerName}
Title: ${order.title || 'N/A'}
Destination: ${order.destination}
Travel Type: ${order.travelType}
Departure: ${order.departureDate ? new Date(order.departureDate).toLocaleDateString() : 'N/A'}
Return: ${order.returnDate ? new Date(order.returnDate).toLocaleDateString() : 'N/A'}
Duration: ${order.days} days
Per Diem: ${order.currency} ${order.perDiem.toFixed(2)}
Approved By: ${order.approvedBy}
Approved Date: ${order.approvedAt ? new Date(order.approvedAt).toLocaleDateString() : 'N/A'}
			`.trim();
			
			const blob = new Blob([content], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `travel_order_${order.requestId}_${order.travelerName.replace(/\s+/g, '_')}.txt`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}
		
		// Add event listeners for travel order filters
		document.addEventListener('DOMContentLoaded', function() {
			const orderSearchTerm = document.getElementById('orderSearchTerm');
			const orderFilterStatus = document.getElementById('orderFilterStatus');
			const orderFromDate = document.getElementById('orderFromDate');
			const orderToDate = document.getElementById('orderToDate');
			const refreshOrderBtn = document.getElementById('refreshOrderBtn');
			const newTravelOrderBtn = document.getElementById('newTravelOrderBtn');
			const closeTravelOrderModalBtn = document.getElementById('closeTravelOrderModalBtn');
			const cancelTravelOrderBtn = document.getElementById('cancelTravelOrderBtn');
			const travelOrderForm = document.getElementById('travelOrderForm');
			const createTravelOrderModal = document.getElementById('createTravelOrderModal');
			
			[orderSearchTerm, orderFilterStatus, orderFromDate, orderToDate].forEach(el => {
				if (el) {
					el.addEventListener('input', applyOrderFilters);
				}
			});
			
			if (refreshOrderBtn) {
				refreshOrderBtn.addEventListener('click', renderTravelOrders);
			}
			
			if (newTravelOrderBtn) {
				newTravelOrderBtn.addEventListener('click', openCreateTravelOrderModal);
			}
			
			[closeTravelOrderModalBtn, cancelTravelOrderBtn].forEach(btn => {
				if (btn) {
					btn.addEventListener('click', closeTravelOrderModal);
				}
			});
			
			if (createTravelOrderModal) {
				createTravelOrderModal.addEventListener('click', (e) => {
					if (e.target === createTravelOrderModal) {
						closeTravelOrderModal();
					}
				});
			}
			
			if (travelOrderForm) {
				travelOrderForm.addEventListener('submit', handleTravelOrderSubmit);
			}
			
			// Add event listeners for travel order form fields that affect vehicle availability
			const orderDepartureDateField = document.getElementById('orderDepartureDateField');
			const orderReturnDateField = document.getElementById('orderReturnDateField');
			const orderOriginField = document.getElementById('orderOriginField');
			const orderDestinationField = document.getElementById('orderDestinationField');
			const orderTripTypeField = document.getElementById('orderTripTypeField');
			
			// Refresh vehicle options when key fields change
			[orderDepartureDateField, orderReturnDateField, orderOriginField, orderDestinationField].forEach(field => {
				if (field) {
					field.addEventListener('change', () => {
						// Delay to ensure all fields are updated before checking availability
						setTimeout(() => {
							loadVehicleOptions();
						}, 100);
					});
				}
			});
			
			// Handle trip type changes
			if (orderTripTypeField && orderReturnDateField) {
				orderTripTypeField.addEventListener('change', () => {
					const tripType = orderTripTypeField.value;
					const returnDateContainer = document.getElementById('returnDateContainer');
					
					if (tripType === 'one-way') {
						// Hide return date field for one-way trips
						if (returnDateContainer) {
							returnDateContainer.style.display = 'none';
						}
						orderReturnDateField.removeAttribute('required');
						orderReturnDateField.value = ''; // Clear return date
					} else if (tripType === 'round-trip') {
						// Show return date field for round trips
						if (returnDateContainer) {
							returnDateContainer.style.display = 'block';
						}
						orderReturnDateField.setAttribute('required', 'required');
					} else {
						// Default state when no trip type selected - show return date field
						if (returnDateContainer) {
							returnDateContainer.style.display = 'block';
						}
						orderReturnDateField.setAttribute('required', 'required');
					}
					
					// Refresh vehicle options and traveler list after trip type change
					setTimeout(() => {
						loadVehicleOptions();
						filterTravelersByDates();
					}, 100);
				});
			}
			
			// View Travel Order Modal elements and listeners
			const closeViewTravelOrderModalBtn = document.getElementById('closeViewTravelOrderModalBtn');
			const closeViewTravelOrderBtn = document.getElementById('closeViewTravelOrderBtn');
			const viewTravelOrderModal = document.getElementById('viewTravelOrderModal');
			
			[closeViewTravelOrderModalBtn, closeViewTravelOrderBtn].forEach(btn => {
				if (btn) {
					btn.addEventListener('click', closeViewTravelOrderModal);
				}
			});
			
			if (viewTravelOrderModal) {
				viewTravelOrderModal.addEventListener('click', (e) => {
					if (e.target === viewTravelOrderModal) {
						closeViewTravelOrderModal();
					}
				});
			}

			// Add event listeners for date filtering
			const departureDateField = document.getElementById('orderDepartureDateField');
			const returnDateField = document.getElementById('orderReturnDateField');
			const tripTypeField = document.getElementById('orderTripTypeField');
			
			if (departureDateField) {
				departureDateField.addEventListener('change', filterTravelersByDates);
			}
			
			if (returnDateField) {
				returnDateField.addEventListener('change', filterTravelersByDates);
			}
			
			if (tripTypeField) {
				tripTypeField.addEventListener('change', filterTravelersByDates);
			}
		});
		
		// Travel Order Global Variables
		let selectedTravelers = [];
		let allApprovedTravelers = [];
		
		// Travel Order Creation Functions
		async function openCreateTravelOrderModal() {
			try {
				// Load travel requests from Firebase
				if (!currentCompanyId) {
					alert('Company information not available. Please refresh the page and try again.');
					return;
				}
				
				// Generate order ID immediately when modal opens
				const orderPrefix = 'TO';
				const timestamp = Date.now().toString().slice(-6);
				const orderId = `${orderPrefix}-${timestamp}`;
				
				// Pre-populate the Order ID field
				document.getElementById('orderIdField').value = orderId;
				document.getElementById('orderStatusField').value = 'Draft';
				document.getElementById('orderCreatedByField').value = authManager?.getUserDisplayName() || 'Current User';
				
				// Load vehicles and populate dropdown
				await loadVehicleOptions();
				
				// Load origin options and populate dropdown
				await loadOriginOptions();
				
				// Load destination options and populate dropdown
				await loadDestinationOptions();
				
				const database = firebase.database();
				const snapshot = await database.ref(`companies/${currentCompanyId}/travelRequests`).once('value');
				const requestsData = snapshot.val() || {};
				
				// Convert to array and filter for approved requests
				const allRequests = Object.keys(requestsData).map(key => ({
					...requestsData[key],
					firebaseKey: key
				}));
				
				const approvedRequests = allRequests.filter(req => req.status === 'Approved');
				
				if (approvedRequests.length === 0) {
					alert('No approved travel requests found. You need approved travel requests to create travel orders.');
					return;
				}
				
				console.log('Found approved requests:', approvedRequests.length);
				
				// Populate approved travelers dropdown
				populateApprovedTravelersDropdown(approvedRequests);
				
				// Show the modal
				const modal = document.getElementById('createTravelOrderModal');
				modal.classList.add('show');
				modal.setAttribute('aria-hidden', 'false');
			} catch (error) {
				console.error('Error opening create travel order modal:', error);
				alert('Error opening travel order creation. Please try again.');
			}
		}
		
		async function loadVehicleOptions() {
			try {
				if (!currentCompanyId) {
					console.warn('No company ID available for loading vehicles');
					return;
				}
				
				const database = firebase.database();
				const snapshot = await database.ref(`companies/${currentCompanyId}/vehicles`).once('value');
				const vehiclesData = snapshot.val() || {};
				
				const vehicleSelect = document.getElementById('orderVehicleField');
				if (!vehicleSelect) {
					console.warn('Vehicle select element not found');
					return;
				}
				
				// Clear existing options except the first one
				vehicleSelect.innerHTML = '<option value="">Select Vehicle</option>';
				
				// Convert vehicles data to array and sort by plate number
				const vehicles = Object.keys(vehiclesData).map(key => ({
					id: key,
					...vehiclesData[key]
				}))
				  // Only include vehicles with plate numbers
				  .filter(vehicle => vehicle.plateNumber)
				  // Only include Active vehicles (accept either vehicleStatus or status field)
				  .filter(vehicle => (vehicle.vehicleStatus || vehicle.status || '').toLowerCase() === 'active')
				  .sort((a, b) => (a.plateNumber || '').localeCompare(b.plateNumber || ''));
				
				// Get current form values for availability checking
				const departureDate = document.getElementById('orderDepartureDateField')?.value;
				const returnDate = document.getElementById('orderReturnDateField')?.value;
				const origin = document.getElementById('orderOriginField')?.value;
				const destination = document.getElementById('orderDestinationField')?.value;
				const tripType = document.getElementById('orderTripTypeField')?.value;
				
				// Filter out unavailable vehicles if dates and route are selected
				let availableVehicles = vehicles;
				const statusElement = document.getElementById('vehicleAvailabilityStatus');
				
				// Check availability if we have departure date, origin, destination, and either return date or one-way trip
				if (departureDate && origin && destination && (returnDate || tripType === 'one-way')) {
					const unavailableVehicleIds = await getUnavailableVehicles(departureDate, returnDate, origin, destination);
					availableVehicles = vehicles.filter(vehicle => !unavailableVehicleIds.includes(vehicle.id));
					
					// Show status message
					if (statusElement) {
						const filteredCount = vehicles.length - availableVehicles.length;
						if (filteredCount > 0) {
							statusElement.textContent = `${filteredCount} vehicle(s) unavailable for this period/route`;
							statusElement.style.color = '#ef4444';
							statusElement.style.display = 'block';
						} else if (availableVehicles.length > 0) {
							statusElement.textContent = `${availableVehicles.length} vehicle(s) available`;
							statusElement.style.color = '#10b981';
							statusElement.style.display = 'block';
						} else {
							statusElement.textContent = 'No vehicles available for this period/route';
							statusElement.style.color = '#ef4444';
							statusElement.style.display = 'block';
						}
					}
				} else {
					// Hide status message when not all required fields are selected
					if (statusElement) {
						statusElement.style.display = 'none';
					}
				}
				
				// Add vehicle options
				availableVehicles.forEach(vehicle => {
					const option = document.createElement('option');
					option.value = vehicle.id;
					option.textContent = `${vehicle.plateNumber} - ${vehicle.vehicleName || vehicle.vehicleType || 'Unknown Vehicle'}`;
					option.dataset.plateNumber = vehicle.plateNumber;
					option.dataset.vehicleName = vehicle.vehicleName || '';
					option.dataset.vehicleType = vehicle.vehicleType || '';
					option.dataset.status = vehicle.vehicleStatus || vehicle.status || '';
					vehicleSelect.appendChild(option);
				});
				
				const filteredCount = vehicles.length - availableVehicles.length;
				if (filteredCount > 0) {
					console.log(`Filtered out ${filteredCount} unavailable vehicles for the selected period and route`);
				}
				console.log(`Loaded ${availableVehicles.length} available vehicles for selection`);
				
			} catch (error) {
				console.error('Error loading vehicle options:', error);
			}
		}
		
		// Function to check which vehicles are unavailable for a given period and route
		async function getUnavailableVehicles(departureDate, returnDate, origin, destination) {
			try {
				if (!currentCompanyId) return [];
				
				const database = firebase.database();
				const snapshot = await database.ref(`companies/${currentCompanyId}/travelOrders`).once('value');
				const ordersData = snapshot.val() || {};
				
				const unavailableVehicleIds = new Set();
				
				// Convert dates to Date objects for comparison
				const requestDeparture = new Date(departureDate);
				// For one-way trips, use departure date as return date for comparison
				const requestReturn = returnDate ? new Date(returnDate) : new Date(departureDate);
				
				// Check each existing travel order
				Object.entries(ordersData).forEach(([orderKey, order]) => {
					// Skip the order being edited (if any)
					if (window.editingOrderKey && orderKey === window.editingOrderKey) {
						return;
					}
					
					// Skip orders that are cancelled or don't have vehicle assigned
					if (!order.vehicle || !order.vehicle.vehicleId || order.status === 'Cancelled') {
						return;
					}
					
					// Skip orders that don't have the same route
					if (order.origin !== origin || order.destination !== destination) {
						return;
					}
					
					// Check if dates overlap
					if (order.departureDate) {
						const orderDeparture = new Date(order.departureDate);
						// For existing orders, if no return date, use departure date
						const orderReturn = order.returnDate ? new Date(order.returnDate) : new Date(order.departureDate);
						
						// Check for date overlap - two periods overlap if:
						// requestDeparture <= orderReturn AND requestReturn >= orderDeparture
						if (requestDeparture <= orderReturn && requestReturn >= orderDeparture) {
							unavailableVehicleIds.add(order.vehicle.vehicleId);
						}
					}
				});
				
				return Array.from(unavailableVehicleIds);
				
			} catch (error) {
				console.error('Error checking vehicle availability:', error);
				return [];
			}
		}
		
		async function loadOriginOptions() {
			try {
				const originSelect = document.getElementById('orderOriginField');
				if (!originSelect) {
					console.warn('Origin select element not found');
					return;
				}
				
				// Clear existing options except the first one
				originSelect.innerHTML = '<option value="">Select Origin</option>';
				
				// Use the same URL as the travel request form
				const url = 'https://users-8be65-default-rtdb.firebaseio.com/companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area.json';
				
				const response = await fetch(url);
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				
				const data = await response.json();
				if (!data) return;
				
				const appendOption = (val, label) => {
					const option = document.createElement('option');
					option.value = (val === undefined || val === null) ? String(label) : String(val);
					option.textContent = String(label);
					originSelect.appendChild(option);
				};
				
				// Handle array of items
				if (Array.isArray(data)) {
					data.forEach(item => {
						if (item && typeof item === 'object') {
							const label = item.label || item.name || item.title || item.value || JSON.stringify(item);
							const value = item.value || item.id || item.key || label;
							appendOption(value, label);
						} else {
							appendOption(item, item);
						}
					});
				// Handle object map { key: labelOrObject }
				} else if (typeof data === 'object') {
					Object.keys(data).forEach(key => {
						const entry = data[key];
						if (entry && typeof entry === 'object') {
							const label = entry.label || entry.name || entry.title || entry.value || JSON.stringify(entry);
							const value = entry.value || entry.id || key;
							appendOption(value, label);
						} else {
							appendOption(key, entry);
						}
					});
				} else {
					appendOption(data, data);
				}
				
				console.log('Origin options loaded successfully');
				
			} catch (error) {
				console.error('Error loading origin options:', error);
			}
		}
		
		async function loadDestinationOptions() {
			try {
				const destinationSelect = document.getElementById('orderDestinationField');
				if (!destinationSelect) {
					console.warn('Destination select element not found');
					return;
				}
				
				// Clear existing options except the first one
				destinationSelect.innerHTML = '<option value="">Select Destination</option>';
				
				// Use the same URL as the travel request form
				const url = 'https://users-8be65-default-rtdb.firebaseio.com/companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area.json';
				
				const response = await fetch(url);
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				
				const data = await response.json();
				if (!data) return;
				
				const appendOption = (val, label) => {
					const option = document.createElement('option');
					option.value = (val === undefined || val === null) ? String(label) : String(val);
					option.textContent = String(label);
					destinationSelect.appendChild(option);
				};
				
				// Handle array of items
				if (Array.isArray(data)) {
					data.forEach(item => {
						if (item && typeof item === 'object') {
							const label = item.label || item.name || item.title || item.value || JSON.stringify(item);
							const value = item.value || item.id || item.key || label;
							appendOption(value, label);
						} else {
							appendOption(item, item);
						}
					});
				// Handle object map { key: labelOrObject }
				} else if (typeof data === 'object') {
					Object.keys(data).forEach(key => {
						const entry = data[key];
						if (entry && typeof entry === 'object') {
							const label = entry.label || entry.name || entry.title || entry.value || JSON.stringify(entry);
							const value = entry.value || entry.id || key;
							appendOption(value, label);
						} else {
							appendOption(key, entry);
						}
					});
				} else {
					appendOption(data, data);
				}
				
				console.log('Destination options loaded successfully');
				
			} catch (error) {
				console.error('Error loading destination options:', error);
			}
		}
		
		function populateApprovedTravelersDropdown(approvedRequests) {
			const dropdown = document.getElementById('approvedTravelersDropdown');
			if (!dropdown) return;
			
			// Clear existing options except the first one
			dropdown.innerHTML = '<option value="">Select Approved Traveler</option>';
			
			// Reset global variables
			selectedTravelers = [];
			allApprovedTravelers = [];
			
			   // Extract all travelers from approved requests, include contact field
			   window.allApprovedTravelersRequests = approvedRequests;
			   approvedRequests.forEach(request => {
				   if (request.people && Array.isArray(request.people)) {
					   request.people.forEach(person => {
						   if (person.name) {
							   const travelerData = {
								   id: `${request.firebaseKey}-${person.name}`,
								   name: person.name,
								   title: person.title || 'No Title',
								   contact: person.contact || '',
								   departureDate: person.departureDate || '',
								   returnDate: person.returnDate || '',
								   destination: request.destination || '',
								   travelType: request.travelType || '',
								   requestId: request.firebaseKey
							   };
							   allApprovedTravelers.push(travelerData);
						   }
					   });
				   }
			   });
			
			// Apply initial filtering (will show all travelers if no dates selected)
			filterTravelersByDates();
		}
		
		function addTraveler() {
			const dropdown = document.getElementById('approvedTravelersDropdown');
			const selectedValue = dropdown.value;
			const selectedOption = dropdown.options[dropdown.selectedIndex];
			
			if (selectedValue && !selectedTravelers.some(t => t.id === selectedValue)) {
				const travelerData = JSON.parse(selectedOption.dataset.travelerData);
				selectedTravelers.push(travelerData);
				
				updateTravelersDisplay();
				updateTravelersData();
				
				// Reset dropdown
				dropdown.selectedIndex = 0;
			}
		}
		
		function removeTraveler(travelerId) {
			selectedTravelers = selectedTravelers.filter(t => t.id !== travelerId);
			updateTravelersDisplay();
			updateTravelersData();
		}
		
		function updateTravelersDisplay() {
			const container = document.getElementById('selectedTravelersContainer');
			const tagsContainer = document.getElementById('selectedTravelersTags');
			
			if (selectedTravelers.length > 0) {
				container.style.display = 'block';
				tagsContainer.innerHTML = selectedTravelers.map(traveler => `
					<div class="traveler-tag">
						${traveler.name}
						<button type="button" class="remove-tag" onclick="removeTraveler('${traveler.id}')" title="Remove ${traveler.name}">
							×
						</button>
					</div>
				`).join('');
			} else {
				container.style.display = 'none';
				tagsContainer.innerHTML = '';
			}
		}
		
		function updateTravelersData() {
			// Store selected travelers data globally for form submission
			window.selectedTravelersData = selectedTravelers;
		}
		
		function filterTravelersByDates() {
			const departureDateField = document.getElementById('orderDepartureDateField');
			const returnDateField = document.getElementById('orderReturnDateField');
			const tripTypeField = document.getElementById('orderTripTypeField');
			const dropdown = document.getElementById('approvedTravelersDropdown');
			
			if (!departureDateField || !dropdown) return;
			
			const selectedDepartureDate = departureDateField.value;
			const selectedReturnDate = returnDateField?.value;
			const tripType = tripTypeField?.value;
			
			// Clear existing options except the first one
			dropdown.innerHTML = '<option value="">Select Approved Traveler</option>';
			
			// If departure date is selected, filter travelers by both original dates and availability
			if (selectedDepartureDate) {
				// First filter by matching travel request dates
				let filteredTravelers = allApprovedTravelers.filter(traveler => {
					// For round trip, check both dates match
					if (tripType === 'round-trip' && selectedReturnDate) {
						return traveler.departureDate === selectedDepartureDate && 
							   traveler.returnDate === selectedReturnDate;
					}
					// For one way, only check departure date
					else if (tripType === 'one-way') {
						return traveler.departureDate === selectedDepartureDate;
					}
					// If trip type not selected but dates are, match accordingly
					else if (selectedReturnDate) {
						return traveler.departureDate === selectedDepartureDate && 
							   traveler.returnDate === selectedReturnDate;
					} else {
						return traveler.departureDate === selectedDepartureDate;
					}
				});
				
				// Then filter out travelers who are already booked during this period
				filteredTravelers = filterOutBookedTravelers(filteredTravelers, selectedDepartureDate, selectedReturnDate);
				
				// Get unique travelers from filtered list
				const uniqueFilteredTravelers = filteredTravelers.reduce((acc, current) => {
					const existing = acc.find(item => item.name === current.name);
					if (!existing) {
						acc.push(current);
					}
					return acc;
				}, []);
				
				// Populate dropdown with filtered travelers
				uniqueFilteredTravelers.forEach(traveler => {
					const option = document.createElement('option');
					option.value = traveler.id;
					option.textContent = `${traveler.name} - ${traveler.title}`;
					option.dataset.travelerData = JSON.stringify(traveler);
					dropdown.appendChild(option);
				});
				
				const totalAvailable = allApprovedTravelers.length;
				const afterDateFilter = filteredTravelers.length;
				const bookingConflicts = totalAvailable - afterDateFilter;
				
				console.log(`Traveler filtering: ${uniqueFilteredTravelers.length} available (${bookingConflicts} with booking conflicts)`);
			} else {
				// If dates not selected, show all travelers
				const uniqueTravelers = allApprovedTravelers.reduce((acc, current) => {
					const existing = acc.find(item => item.name === current.name);
					if (!existing) {
						acc.push(current);
					}
					return acc;
				}, []);
				
				uniqueTravelers.forEach(traveler => {
					const option = document.createElement('option');
					option.value = traveler.id;
					option.textContent = `${traveler.name} - ${traveler.title}`;
					option.dataset.travelerData = JSON.stringify(traveler);
					dropdown.appendChild(option);
				});
			}
		}
		
		// Function to filter out travelers who are already booked during the selected period
		function filterOutBookedTravelers(travelers, departureDate, returnDate) {
			if (!departureDate || !currentCompanyId) return travelers;
			
			try {
				// Get existing travel orders synchronously from the global array
				const bookedTravelerNames = new Set();
				
				// Convert dates to Date objects for comparison
				const requestDeparture = new Date(departureDate);
				const requestReturn = returnDate ? new Date(returnDate) : new Date(departureDate);
				
				// Check each existing travel order
				travelOrders.forEach(order => {
					// Skip the order being edited (if any)
					if (window.editingOrderKey && order.firebaseKey === window.editingOrderKey) {
						return;
					}
					
					// Skip cancelled orders
					if (order.status === 'Cancelled') {
						return;
					}
					
					// Check if dates overlap
					if (order.departureDate) {
						const orderDeparture = new Date(order.departureDate);
						const orderReturn = order.returnDate ? new Date(order.returnDate) : new Date(order.departureDate);
						
						// Check for date overlap
						if (requestDeparture <= orderReturn && requestReturn >= orderDeparture) {
							// Add all travelers from this overlapping order to the blocked list
							if (order.travelers && Array.isArray(order.travelers)) {
								order.travelers.forEach(traveler => {
									if (traveler.name) {
										bookedTravelerNames.add(traveler.name.trim().toLowerCase());
									}
								});
							}
						}
					}
				});
				
				// Filter out booked travelers
				return travelers.filter(traveler => {
					const travelerName = traveler.name.trim().toLowerCase();
					return !bookedTravelerNames.has(travelerName);
				});
				
			} catch (error) {
				console.error('Error filtering booked travelers:', error);
				return travelers; // Return original list if error occurs
			}
		}
		
		function showApprovedTravelersSelector(approvedRequests) {
			try {
				const modal = document.getElementById('createTravelOrderModal');
				const container = document.getElementById('selectedTravelersContainer');
				
				if (!modal || !container) {
					console.error('Modal or container element not found');
					alert('Modal elements not found. Please refresh the page and try again.');
					return;
				}
				
				console.log('Building traveler selector for', approvedRequests.length, 'approved requests');
				
				// Validate that requests have people array
				const validRequests = approvedRequests.filter(req => req.people && Array.isArray(req.people) && req.people.length > 0);
				
				if (validRequests.length === 0) {
					alert('No valid travelers found in approved requests.');
					return;
				}
				
				// Create traveler selection interface
				container.innerHTML = `
					<div style="margin-bottom: 1rem;">
						<h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Select Approved Travelers:</h4>
						<div id="approvedTravelersSelector" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem;">
							${validRequests.map(req => `
								<div class="request-group" style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb;">
									<div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem;">
										${req.destination || 'No destination'} - ${req.travelType || 'No type'} (${req.id || 'No ID'})
									</div>
									${req.people.map((person, index) => `
										<label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; cursor: pointer;">
											<input type="checkbox" 
												class="traveler-checkbox" 
												data-request-key="${req.firebaseKey || ''}"
												data-request-id="${req.id || ''}"
												data-person-index="${index}"
												data-destination="${req.destination || ''}"
												data-travel-type="${req.travelType || ''}"
												data-purpose="${req.purpose || ''}"
												data-departure="${person.departureDate || ''}"
												data-return="${person.returnDate || ''}"
												style="margin: 0;">
											<span style="font-size: 0.8rem;">
												${person.name || 'No name'} - ${person.title || 'No Title'} 
												(${person.departureDate || 'No departure'} to ${person.returnDate || 'No return'})
											</span>
										</label>
									`).join('')}
								</div>
							`).join('')}
						</div>
						<button type="button" id="confirmTravelerSelection" class="btn btn-primary" style="margin-top: 0.5rem;">
							Confirm Selection
						</button>
					</div>
				`;
				
				// Add event listener for confirm button
				const confirmBtn = document.getElementById('confirmTravelerSelection');
				if (confirmBtn) {
					confirmBtn.addEventListener('click', confirmTravelerSelection);
				}
				
				// Show modal
				modal.classList.add('show');
				modal.setAttribute('aria-hidden', 'false');
				
			} catch (error) {
				console.error('Error in showApprovedTravelersSelector:', error);
				alert('Error displaying traveler selection. Please try again.');
			}
		}
		
		function confirmTravelerSelection() {
			const checkboxes = document.querySelectorAll('.traveler-checkbox:checked');
			
			if (checkboxes.length === 0) {
				alert('Please select at least one traveler.');
				return;
			}
			
			   // Collect selected travelers data, including contact field
			   const selectedTravelers = Array.from(checkboxes).map(checkbox => {
				   const requestKey = checkbox.dataset.requestKey;
				   const requestId = checkbox.dataset.requestId;
				   const personIndex = parseInt(checkbox.dataset.personIndex);
				   // Use allApprovedTravelers to get the contact field for the traveler
				   const travelerId = `${requestKey}-${checkbox.nextElementSibling.textContent.split(' - ')[0]}`;
				   const traveler = allApprovedTravelers.find(t => t.id === travelerId);
				   return {
					   requestKey,
					   requestId,
					   personIndex,
					   name: traveler && traveler.name ? traveler.name : checkbox.nextElementSibling.textContent.split(' - ')[0],
					   title: traveler && traveler.title ? traveler.title : (checkbox.nextElementSibling.textContent.split(' - ')[1]?.split(' (')[0] || ''),
					   contact: traveler && traveler.contact ? traveler.contact : '',
					   destination: checkbox.dataset.destination,
					   travelType: checkbox.dataset.travelType,
					   purpose: checkbox.dataset.purpose,
					   departureDate: checkbox.dataset.departure,
					   returnDate: checkbox.dataset.return
				   };
			   });
			
			// Pre-fill the form with selected data
			populateTravelOrderForm(selectedTravelers);
		}
		
		function populateTravelOrderForm(travelers) {
			// Get common data from first traveler
			const firstTraveler = travelers[0];
			
			// Populate form fields (Order ID is already set when modal opens)
			// Set destination dropdown value
			const destinationField = document.getElementById('orderDestinationField');
			if (destinationField && firstTraveler.destination) {
				destinationField.value = firstTraveler.destination;
			}
			
			document.getElementById('orderDepartureDateField').value = firstTraveler.departureDate;
			document.getElementById('orderReturnDateField').value = firstTraveler.returnDate;
			
			// Display selected travelers with same styling as travel request details
			const container = document.getElementById('selectedTravelersContainer');
			container.innerHTML = `
				<div style="display:flex; flex-direction:column; gap:.6rem;">
					${travelers.map((traveler, index) => `
						<div style="display:grid; grid-template-columns:1fr auto; gap:.5rem; align-items:center; padding:.5rem; background:#ffffff; border:1px solid #e2e8f0; border-radius:6px;">
							<div style="display:flex; flex-direction:column; gap:.2rem;">
								<div style="font-weight:600; font-size:.65rem;">${traveler.name}</div>
								<div style="font-size:.6rem; color:#64748b;">${traveler.title || 'No Title'}</div>
								<div style="font-size:.55rem; color:#94a3b8;">
									${traveler.departureDate || 'No departure'} to ${traveler.returnDate || 'No return'}
								</div>
							</div>
							<button type="button" onclick="removeTraveler(${index})" style="background:#ef4444; color:white; border:none; padding:.25rem .5rem; border-radius:4px; font-size:.55rem; cursor:pointer;">
								Remove
							</button>
						</div>
					`).join('')}
				</div>
			`;
			
			// Store travelers data for form submission
			window.selectedTravelersData = travelers;
		}
		
		function removeTraveler(index) {
			if (window.selectedTravelersData) {
				window.selectedTravelersData.splice(index, 1);
				populateTravelOrderForm(window.selectedTravelersData);
			}
		}
		
		function closeTravelOrderModal() {
			const modal = document.getElementById('createTravelOrderModal');
			modal.classList.remove('show');
			modal.setAttribute('aria-hidden', 'true');
			
			// Clear form and reset state
			clearTravelOrderForm();
		}
		
		function closeViewTravelOrderModal() {
			const modal = document.getElementById('viewTravelOrderModal');
			modal.classList.remove('show');
			modal.setAttribute('aria-hidden', 'true');
			
			// Clear current viewing order key
			window.currentViewingOrderKey = null;
		}
		
		function clearTravelOrderForm() {
			// Reset the form
			const form = document.getElementById('travelOrderForm');
			if (form) {
				form.reset();
			}
			
			// Clear selected travelers
			window.selectedTravelersData = [];
			selectedTravelers = [];
			
			// Hide and clear travelers container
			const selectedTravelersContainer = document.getElementById('selectedTravelersContainer');
			const selectedTravelersTags = document.getElementById('selectedTravelersTags');
			
			if (selectedTravelersContainer) {
				selectedTravelersContainer.style.display = 'none';
			}
			if (selectedTravelersTags) {
				selectedTravelersTags.innerHTML = '';
			}
			
			// Reset dropdown
			const dropdown = document.getElementById('approvedTravelersDropdown');
			if (dropdown) {
				dropdown.selectedIndex = 0;
			}
			
			// Generate new Order ID for next time
			const orderIdField = document.getElementById('orderIdField');
			if (orderIdField) {
				orderIdField.value = 'TO-' + Date.now();
			}
			
			// Reset modal title and button text for create mode
			const modalTitle = document.querySelector('#createTravelOrderModal .modal-header h2');
			const submitButton = document.querySelector('#createTravelOrderModal .btn-primary');
			
			if (modalTitle) modalTitle.textContent = 'Create Travel Order';
			if (submitButton) submitButton.textContent = 'Create Travel Order';
			
			// Reset editing mode
			window.editingMode = false;
			window.editingOrderKey = null;
		}
		
		async function handleTravelOrderSubmit(e) {
			e.preventDefault();
			
			if (!window.selectedTravelersData || window.selectedTravelersData.length === 0) {
				alert('No travelers selected. Please select travelers first.');
				return;
			}
			
			try {
				const formData = new FormData(e.target);
				const database = firebase.database();
				
				// Get company ID from auth manager
				const companyId = authManager?.currentUser?.companyId || currentCompanyId;
				if (!companyId) {
					alert('Company not found. Please refresh the page and try again.');
					return;
				}
				
				// Get selected vehicle information
				const vehicleSelect = document.getElementById('orderVehicleField');
				const selectedVehicleId = vehicleSelect.value;
				const selectedVehicleOption = vehicleSelect.selectedOptions[0];
				const vehicleInfo = selectedVehicleId ? {
					vehicleId: selectedVehicleId,
					plateNumber: selectedVehicleOption?.dataset.plateNumber || '',
					vehicleName: selectedVehicleOption?.dataset.vehicleName || '',
					vehicleType: selectedVehicleOption?.dataset.vehicleType || ''
				} : null;
				
				const travelOrder = {
					orderId: document.getElementById('orderIdField').value,
					status: document.getElementById('orderStatusField').value,
					origin: document.getElementById('orderOriginField').value,
					destination: document.getElementById('orderDestinationField').value,
					driver: document.getElementById('orderDriverField').value,
					driverContact: document.getElementById('orderDriverContactField').value,
					departureDate: document.getElementById('orderDepartureDateField').value,
					returnDate: document.getElementById('orderReturnDateField').value,
					notes: document.getElementById('orderNotesField').value,
					vehicle: vehicleInfo,
					travelers: window.selectedTravelersData,
					createdBy: authManager?.getUserDisplayName() || 'Current User',
					updatedAt: new Date().toISOString(),
					companyId: companyId
				};
				
				// Check if we're editing or creating
				if (window.editingMode && window.editingOrderKey) {
					// Update existing order
					const orderRef = database.ref(`companies/${companyId}/travelOrders/${window.editingOrderKey}`);
					
					// Get existing data to preserve createdAt
					const existingSnapshot = await orderRef.once('value');
					const existingData = existingSnapshot.val();
					
					if (existingData) {
						travelOrder.createdAt = existingData.createdAt; // Preserve original creation date
					} else {
						travelOrder.createdAt = new Date().toISOString();
					}
					
					await orderRef.update(travelOrder);
					alert('Travel order updated successfully!');
				} else {
					// Create new order
					travelOrder.createdAt = new Date().toISOString();
					await database.ref(`companies/${companyId}/travelOrders`).push(travelOrder);
					alert('Travel order created successfully!');
				}
				
				// Reset editing mode
				window.editingMode = false;
				window.editingOrderKey = null;
				
				// Close modal and refresh table
				closeTravelOrderModal();
				
				// Refresh the travel orders table to show the changes
				await renderTravelOrders();
				
			} catch (error) {
				console.error('Error saving travel order:', error);
				alert('Error saving travel order. Please try again.');
			}
		}
		
		// Travel Order Action Functions
		function viewTravelOrder(orderKey) {
			try {
				// Find the order in the travelOrders array
				const order = travelOrders.find(o => o.firebaseKey === orderKey);
				if (!order) {
					alert('Travel order not found');
					return;
				}
				
				// Populate modal with order data
				document.getElementById('viewOrderId').textContent = order.orderId || '—';
				
				// Status with styling
				const statusElement = document.getElementById('viewOrderStatus');
				statusElement.textContent = order.status || '—';
				statusElement.className = `status-badge status-${(order.status || '').toLowerCase()}`;
				
				document.getElementById('viewOrderCreatedBy').textContent = order.createdBy || '—';
				document.getElementById('viewOrderCreatedDate').textContent = order.createdAt ? 
					new Date(order.createdAt).toLocaleDateString() : '—';
				
				// Travel information
				document.getElementById('viewOrderOrigin').textContent = order.origin || '—';
				document.getElementById('viewOrderDestination').textContent = order.destination || '—';
				document.getElementById('viewOrderDepartureDate').textContent = order.departureDate ? 
					new Date(order.departureDate).toLocaleDateString() : '—';
				document.getElementById('viewOrderReturnDate').textContent = order.returnDate ? 
					new Date(order.returnDate).toLocaleDateString() : '—';
				
				// Vehicle and driver
				const vehicleText = order.vehicle && order.vehicle.plateNumber ? 
					`${order.vehicle.plateNumber} - ${order.vehicle.vehicleName || order.vehicle.vehicleType || 'Vehicle'}` : '—';
				document.getElementById('viewOrderVehicle').textContent = vehicleText;
				document.getElementById('viewOrderDriver').textContent = order.driver || '—';
				document.getElementById('viewOrderDriverContact').textContent = order.driverContact || '—';
				
				// Travelers
				const travelersContainer = document.getElementById('viewOrderTravelers');
				travelersContainer.innerHTML = '';
				   if (order.travelers && order.travelers.length > 0) {
					   order.travelers.forEach(traveler => {
						   const travelerTag = document.createElement('div');
						   travelerTag.style.cssText = `
							   background: #3b82f6; color: white; padding: 0.3rem 0.6rem; 
							   border-radius: 4px; font-size: 0.6rem; display: inline-flex; 
							   align-items: center; gap: 0.3rem; margin: 0.1rem;
						   `;
						   travelerTag.innerHTML = `
							   <i class="fas fa-user"></i>
							   <span>${traveler.name}${traveler.title ? ` - ${traveler.title}` : ''}</span>
							   <span style="color:#d1fae5; font-size:0.6rem; margin-left:0.5rem;">${traveler.contact ? `📞 ${traveler.contact}` : ''}</span>
						   `;
						   travelersContainer.appendChild(travelerTag);
					   });
				   } else {
					   travelersContainer.innerHTML = '<span style="color:#6b7280;">No travelers assigned</span>';
				   }
				
				// Notes
				document.getElementById('viewOrderNotes').textContent = order.notes || 'No notes provided';
				
				// Store current order key for editing
				window.currentViewingOrderKey = orderKey;
				
				// Show modal
				const modal = document.getElementById('viewTravelOrderModal');
				modal.classList.add('show');
				modal.setAttribute('aria-hidden', 'false');
				
			} catch (error) {
				console.error('Error viewing travel order:', error);
				alert('Error loading travel order details');
			}
		}
		
		function editTravelOrder(orderKey) {
			try {
				// Find the order in the travelOrders array
				const order = travelOrders.find(o => o.firebaseKey === orderKey);
				if (!order) {
					alert('Travel order not found');
					return;
				}
				
				// Set editing mode
				window.editingOrderKey = orderKey;
				window.editingMode = true;
				
				// Open the create modal (which will serve as edit modal)
				openCreateTravelOrderModal().then(() => {
					// Populate form with existing data
					populateEditForm(order);
				});
				
			} catch (error) {
				console.error('Error editing travel order:', error);
				alert('Error loading travel order for editing');
			}
		}
		
		async function populateEditForm(order) {
			try {
				// Basic order information
				document.getElementById('orderIdField').value = order.orderId || '';
				document.getElementById('orderStatusField').value = order.status || 'Draft';
				document.getElementById('orderCreatedByField').value = order.createdBy || '';
				
				// Travel information
				document.getElementById('orderOriginField').value = order.origin || '';
				document.getElementById('orderDestinationField').value = order.destination || '';
				document.getElementById('orderDepartureDateField').value = order.departureDate || '';
				document.getElementById('orderReturnDateField').value = order.returnDate || '';
				
				// Vehicle and driver
				if (order.vehicle && order.vehicle.vehicleId) {
					document.getElementById('orderVehicleField').value = order.vehicle.vehicleId;
				}
				document.getElementById('orderDriverField').value = order.driver || '';
				document.getElementById('orderDriverContactField').value = order.driverContact || '';
				
				// Notes
				document.getElementById('orderNotesField').value = order.notes || '';
				
				// Populate travelers
				if (order.travelers && order.travelers.length > 0) {
					window.selectedTravelersData = [...order.travelers];
					selectedTravelers = [...order.travelers];
					updateTravelersDisplay();
				}
				
				// Change modal title and button text for editing
				const modalTitle = document.querySelector('#createTravelOrderModal .modal-header h2');
				const submitButton = document.querySelector('#createTravelOrderModal .btn-primary');
				
				if (modalTitle) modalTitle.textContent = 'Edit Travel Order';
				if (submitButton) submitButton.textContent = 'Update Travel Order';
				
			} catch (error) {
				console.error('Error populating edit form:', error);
			}
		}
		
		function editTravelOrderFromView() {
			if (window.currentViewingOrderKey) {
				closeViewTravelOrderModal();
				editTravelOrder(window.currentViewingOrderKey);
			}
		}
		
		   async function printTravelOrder(orderKey) {
			   try {
				   // Find the order in the travelOrders array
				   const order = travelOrders.find(o => o.firebaseKey === orderKey);
				   if (!order) {
					   alert('Travel order not found');
					   return;
				   }

				   // Fetch latest contact values for each traveler from Firebase
				   if (order.travelers && order.travelers.length > 0 && order.firebaseKey) {
					   const companyId = authManager?.currentUser?.companyId || currentCompanyId;
					   if (companyId) {
						   const db = getDatabase();
						   const basePath = `companies/${companyId}/travelOrders/${order.firebaseKey}/travelers`;
						   // Fetch all travelers' contact fields in parallel
						   const contactPromises = order.travelers.map((_, idx) => {
							   const travelerRef = ref(db, `${basePath}/${idx}/contact`);
							   return get(travelerRef).then(snap => snap.exists() ? snap.val() : (order.travelers[idx].contact || '—')).catch(() => order.travelers[idx].contact || '—');
						   });
						   const contacts = await Promise.all(contactPromises);
						   // Overwrite contact fields for PDF export
						   order.travelers = order.travelers.map((trav, idx) => ({ ...trav, contact: contacts[idx] }));
					   }
				   }

				   // Create new jsPDF instance
				   const { jsPDF } = window.jspdf;
				   const doc = new jsPDF();

				   // Simplified professional color scheme
				   const primaryColor = [45, 55, 72]; // Dark gray
				   const secondaryColor = [113, 128, 150]; // Medium gray
				   const lightGray = [247, 250, 252]; // Very light gray

				   // Company information
				   const companyName = authManager?.currentCompany?.companyName || 'Company Name';
				   let yPosition = 25;

				   // Simple header with minimal background
					  // doc.setFillColor(...lightGray);
					  // doc.rect(0, 0, 210, 35, 'F');

				   // Add company logo if available
				const logoUrl = authManager?.currentCompany?.logo || authManager?.currentCompany?.logoUrl;
				   if (logoUrl) {
					   try {
						   // Create a temporary image element to load the logo
						   const img = new Image();
						   img.crossOrigin = 'anonymous';
						   // Use Promise to handle async image loading
						   const loadImage = new Promise((resolve, reject) => {
							   img.onload = () => {
								   try {
									   // Add logo to PDF (professional size and positioning)
									   doc.addImage(img, 'JPEG', 15, 8, 20, 20);
									   resolve();
								   } catch (err) {
									   reject(err);
								   }
							   };
							   img.onerror = reject;
							   img.src = logoUrl;
						   });
						   // Wait for image to load or use fallback
						   loadImage.catch(() => {
							   // Fallback to company initials if logo fails to load
							   doc.setTextColor(255, 255, 255);
							   doc.setFontSize(12);
							   doc.setFont(undefined, 'bold');
							   const initials = companyName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
							   doc.text(initials, 20, 22);
						   });
					   } catch (error) {
						   console.warn('Error loading logo:', error);
						   // Fallback to company initials
						   doc.setTextColor(255, 255, 255);
						   doc.setFontSize(12);
						   doc.setFont(undefined, 'bold');
						   const initials = companyName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
						   doc.text(initials, 20, 22);
					   }
				   } else {
					   // Fallback to company initials when no logo is available
					   doc.setTextColor(255, 255, 255);
					   doc.setFontSize(12);
					   doc.setFont(undefined, 'bold');
					   const initials = companyName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
					   doc.text(initials, 20, 22);
				   }
				
				// Company name in header
				   doc.setTextColor(...primaryColor);
				   doc.setFontSize(22);
				   doc.setFont(undefined, 'bold');
				   doc.text(companyName, 20, 20); // align left
				   // Travel Order title
				   doc.setFontSize(14);
				   doc.setFont(undefined, 'normal');
				   doc.text('TRAVEL ORDER DOCUMENT', 20, 28); // align left
				   yPosition = 50;
				   // Removed order information box border
				
				// Order details header
				doc.setFontSize(14);
				doc.setFont(undefined, 'bold');
				doc.text('ORDER INFORMATION', 20, yPosition + 3);
				
				yPosition += 12;
				
				// Order details in single column layout (left-aligned)
				const leftColumn = 20;
				
				doc.setFontSize(10);
				doc.setFont(undefined, 'bold');
				doc.text('Order ID:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.orderId || '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Status:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.status || '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Created By:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.createdBy || '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Created Date:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—', leftColumn + 35, yPosition);
				
				yPosition += 12;
				
				   // Travel Information Section
				   // doc.setFillColor(...lightGray);
				   // doc.rect(15, yPosition - 3, 180, 8, 'F');
				   doc.setTextColor(...primaryColor);
				   doc.setFontSize(12);
				   doc.setFont(undefined, 'bold');
				   doc.text('TRAVEL INFORMATION', 20, yPosition + 2);
				   yPosition += 12;
				   // Removed travel info bordered box
				
				doc.setFontSize(10);
				doc.setFont(undefined, 'bold');
				doc.text('From:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.origin || '—', leftColumn + 15, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('To:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.destination || '—', leftColumn + 15, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Departure:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Return:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—', leftColumn + 20, yPosition);
				yPosition += 5;
				
				// Duration calculation
				if (order.departureDate && order.returnDate) {
					const depDate = new Date(order.departureDate);
					const retDate = new Date(order.returnDate);
					const diffTime = Math.abs(retDate - depDate);
					const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
					
					doc.setFont(undefined, 'bold');
					doc.text('Duration:', leftColumn, yPosition);
					doc.setFont(undefined, 'normal');
					doc.text(`${diffDays} day(s)`, leftColumn + 25, yPosition);
				}
				
				yPosition += 12;
				
				// Vehicle & Driver Section
				   // doc.setFillColor(...lightGray);
				   // doc.rect(15, yPosition - 3, 180, 8, 'F');
				   doc.setTextColor(...primaryColor);
				   doc.setFontSize(12);
				   doc.setFont(undefined, 'bold');
				   doc.text('VEHICLE & DRIVER DETAILS', 20, yPosition + 2);
				
				yPosition += 12;
				
				   // Vehicle info (no bordered box)
				
				doc.setFontSize(10);
				const vehicleText = order.vehicle && order.vehicle.plateNumber ? 
					`${order.vehicle.plateNumber}${order.vehicle.vehicleName ? ` - ${order.vehicle.vehicleName}` : ''}` : 'Not Assigned';
				
				doc.setFont(undefined, 'bold');
				doc.text('Vehicle:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(vehicleText, leftColumn + 20, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Driver:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.driver || 'Not Assigned', leftColumn + 20, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Contact:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.driverContact || 'Not Provided', leftColumn + 20, yPosition);
				
				yPosition += 12;
				
				// Travelers Section
				doc.setFillColor(...lightGray);
				doc.rect(15, yPosition - 3, 180, 8, 'F');
				doc.setTextColor(...primaryColor);
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.text('AUTHORIZED TRAVELERS', 20, yPosition + 2);
				
				yPosition += 12;
				
				// Travelers table
				if (order.travelers && order.travelers.length > 0) {
					// Table header
					doc.setFillColor(...lightGray);
					doc.rect(15, yPosition - 3, 180, 6, 'F');
					doc.setFontSize(10);
					doc.setFont(undefined, 'bold');
					   doc.text('No.', 20, yPosition + 1);
					   doc.text('Name', 35, yPosition + 1);
					   doc.text('Title/Position', 100, yPosition + 1);
					   doc.text('Phone Number', 150, yPosition + 1);
					
					yPosition += 8;
					
					// Table rows with simple alternating background
					order.travelers.forEach((traveler, index) => {
						if (index % 2 === 0) {
							doc.setFillColor(250, 250, 250);
							doc.rect(15, yPosition - 3, 180, 6, 'F');
						}
						doc.setTextColor(...primaryColor);
						doc.setFont(undefined, 'normal');
						doc.text(`${index + 1}.`, 20, yPosition + 1);
						doc.text(traveler.name || '—', 35, yPosition + 1);
						doc.text(traveler.title || '—', 100, yPosition + 1);
						doc.text(traveler.contact || '—', 150, yPosition + 1);
						yPosition += 6;
					});
				} else {
					doc.setFont(undefined, 'italic');
					doc.setTextColor(...secondaryColor);
					doc.text('No travelers assigned to this order', leftColumn, yPosition);
					yPosition += 6;
				}
				
				yPosition += 10;
				
				// Notes Section
				doc.setFillColor(...lightGray);
				doc.rect(15, yPosition - 3, 180, 8, 'F');
				doc.setTextColor(...primaryColor);
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.text('ADDITIONAL NOTES', 20, yPosition + 2);
				
				yPosition += 12;
				
				// Notes box
				const notesHeight = 18;
				doc.setFillColor(252, 252, 252);
				   // doc.rect(15, yPosition - 5, 180, notesHeight, 'FD');
				
				   doc.setFontSize(9);
				   doc.setFont(undefined, 'normal');
				   const notes = order.notes || 'No additional notes provided for this travel order.';
				   const splitNotes = doc.splitTextToSize(notes, 170);
				   doc.text(splitNotes, 20, yPosition, { align: 'left' });
				
				yPosition += notesHeight + 10;
				
				// Approval Section
				doc.setFillColor(...lightGray);
				doc.rect(15, yPosition - 3, 180, 8, 'F');
				doc.setTextColor(...primaryColor);
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.text('APPROVALS & SIGNATURES', 20, yPosition + 2, { align: 'left' });

				yPosition += 12;

				// Display current user name and status
				doc.setFontSize(10);
				doc.setFont(undefined, 'bold');
				doc.text('Approved By:', 20, yPosition);
				doc.setFont(undefined, 'normal');
				var approverName = (authManager && authManager.getUserDisplayName) ? authManager.getUserDisplayName() : 'Current User';
				doc.text(approverName, 50, yPosition);
				yPosition += 6;
				doc.setFont(undefined, 'bold');
				doc.text('Status:', 20, yPosition);
				// Set green color for 'Approved'
				doc.setFont(undefined, 'normal');
				doc.setTextColor(16, 101, 52); // green
				doc.text('Approved', 50, yPosition);
				doc.setTextColor(...primaryColor); // reset to default for next section
				yPosition += 14;
				
				// Simple footer
				doc.setFillColor(...primaryColor);
				doc.rect(0, yPosition, 210, 12, 'F');
				
				   doc.setTextColor(255, 255, 255);
				   doc.setFontSize(8);
				   doc.setFont(undefined, 'normal');
				   const footerText = `Generated on ${new Date().toLocaleDateString()} | Order ID: ${order.orderId || 'N/A'}`;
				   doc.text(footerText, 20, yPosition + 7, { align: 'left' });
				
				// Save the PDF
				const fileName = `Travel_Order_${order.orderId || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
				doc.save(fileName);
				
			} catch (error) {
				console.error('Error generating PDF:', error);
				alert('Error generating PDF. Please try again.');
			}
		}
		
		// Generate OPTIMIZED PDF as Blob for email attachment (reduced size)
		async function generatePDFBlob(order) {
			const { jsPDF } = window.jspdf;
			
			// Use minimal PDF settings for smaller file size
			const doc = new jsPDF({
				orientation: 'portrait',
				unit: 'mm',
				format: 'a4',
				compress: true,
				precision: 2
			});
			
			// Minimal color scheme (reduces file size)
			const black = [0, 0, 0];
			const gray = [128, 128, 128];
			
			// Company information
			const companyName = authManager?.currentCompany?.companyName || 'Company Name';
			let yPosition = 15;
			
			// MINIMAL HEADER - no background fills to reduce size
			doc.setTextColor(...black);
			doc.setFontSize(16);
			doc.setFont('helvetica', 'bold');
			doc.text(companyName, 20, yPosition);
			
			yPosition += 8;
			doc.setFontSize(12);
			doc.setFont('helvetica', 'normal');
			doc.text('TRAVEL ORDER', 20, yPosition);
			
			yPosition += 15;
			
			// MINIMAL Order information - simple text only
			doc.setFontSize(10);
			doc.setFont('helvetica', 'bold');
			doc.text('ORDER DETAILS', 20, yPosition);
			yPosition += 6;
			
			// Order details in compact format
			doc.setFont('helvetica', 'normal');
			doc.setFontSize(9);
			
			doc.text(`Order ID: ${order.orderId || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Status: ${order.status || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Created: ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`By: ${order.createdBy || '—'}`, 20, yPosition);
			yPosition += 8;
			
			// Travel Information - compact format
			doc.setFont('helvetica', 'bold');
			doc.setFontSize(10);
			doc.text('TRAVEL DETAILS', 20, yPosition);
			yPosition += 6;
			
			doc.setFont('helvetica', 'normal');
			doc.setFontSize(9);
			doc.text(`From: ${order.origin || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`To: ${order.destination || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Departure: ${order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Return: ${order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—'}`, 20, yPosition);
			yPosition += 4;
			
			// Duration calculation (compact)
			if (order.departureDate && order.returnDate) {
				const depDate = new Date(order.departureDate);
				const retDate = new Date(order.returnDate);
				const diffTime = Math.abs(retDate - depDate);
				const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
				doc.text(`Duration: ${diffDays} day(s)`, 20, yPosition);
				yPosition += 4;
			}
			yPosition += 4;
			
			// Vehicle & Driver (compact)
			if (order.vehicle || order.driver) {
				doc.setFont('helvetica', 'bold');
				doc.setFontSize(10);
				doc.text('TRANSPORT', 20, yPosition);
				yPosition += 6;
				
				doc.setFont('helvetica', 'normal');
				doc.setFontSize(9);
				if (order.vehicle) {
					const vehicleInfo = `${order.vehicle.plateNumber || ''} ${order.vehicle.vehicleName || order.vehicle.vehicleType || ''}`.trim();
					doc.text(`Vehicle: ${vehicleInfo || '—'}`, 20, yPosition);
					yPosition += 4;
				}
				if (order.driver) {
					doc.text(`Driver: ${order.driver}`, 20, yPosition);
					yPosition += 4;
				}
				yPosition += 4;
			}
			
			// Travelers (compact format)
			if (order.travelers && order.travelers.length > 0) {
				doc.setFont('helvetica', 'bold');
				doc.setFontSize(10);
				doc.text('TRAVELERS', 20, yPosition);
				yPosition += 6;
				
				doc.setFont('helvetica', 'normal');
				doc.setFontSize(9);
				order.travelers.forEach((traveler, index) => {
					const travelerInfo = `${index + 1}. ${traveler.name || '—'}`;
					doc.text(travelerInfo, 20, yPosition);
					yPosition += 4;
					
					// Prevent page overflow with minimal spacing
					if (yPosition > 270) {
						doc.addPage();
						yPosition = 20;
					}
				});
				yPosition += 4;
			}
			
			// Footer (minimal)
			const pageHeight = doc.internal.pageSize.height;
			doc.setFontSize(8);
			doc.setTextColor(...gray);
			doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, pageHeight - 10);
			
			// Convert to blob with compression
			const pdfBlob = doc.output('blob');
			console.log('✅ Optimized PDF generated, size:', Math.round(pdfBlob.size / 1024), 'KB');
			
			return pdfBlob;
		}
			
			// Order information box with simple border
			doc.setTextColor(...primaryColor);
			doc.setDrawColor(...secondaryColor);
			doc.setLineWidth(0.5);
			doc.rect(15, yPosition - 5, 180, 25);
			
			// Order details header
			doc.setFontSize(14);
			doc.setFont(undefined, 'bold');
			doc.text('ORDER INFORMATION', 20, yPosition + 3);
			
			yPosition += 12;
			
			// Order details in single column layout (left-aligned)
			const leftColumn = 20;
			
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('Order ID:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.orderId || '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Status:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.status || '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Created By:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.createdBy || '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Created Date:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—', leftColumn + 35, yPosition);
			
			yPosition += 12;
			
			// Travel Information Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('TRAVEL INFORMATION', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Travel info in a simple bordered box
			doc.setDrawColor(...secondaryColor);
			doc.setLineWidth(0.5);
			doc.rect(15, yPosition - 5, 180, 30);
			
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('From:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.origin || '—', leftColumn + 15, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('To:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.destination || '—', leftColumn + 15, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Departure:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Return:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—', leftColumn + 20, yPosition);
			yPosition += 5;
			
			// Duration calculation
			if (order.departureDate && order.returnDate) {
				const depDate = new Date(order.departureDate);
				const retDate = new Date(order.returnDate);
				const diffTime = Math.abs(retDate - depDate);
				const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
				
				doc.setFont(undefined, 'bold');
				doc.text('Duration:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(`${diffDays} day(s)`, leftColumn + 25, yPosition);
			}
			
			yPosition += 12;
			
			// Vehicle & Driver Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('VEHICLE & DRIVER DETAILS', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Vehicle info in bordered box
			doc.rect(15, yPosition - 5, 180, 22);
			
			doc.setFontSize(10);
			const vehicleText = order.vehicle && order.vehicle.plateNumber ? 
				`${order.vehicle.plateNumber}${order.vehicle.vehicleName ? ` - ${order.vehicle.vehicleName}` : ''}` : 'Not Assigned';
			
			doc.setFont(undefined, 'bold');
			doc.text('Vehicle:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(vehicleText, leftColumn + 20, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Driver:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.driver || 'Not Assigned', leftColumn + 20, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Contact:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.driverContact || 'Not Provided', leftColumn + 20, yPosition);
			
			yPosition += 12;
			
			// Travelers Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('AUTHORIZED TRAVELERS', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Travelers table
			if (order.travelers && order.travelers.length > 0) {
				   // Table header
				   doc.setFillColor(...lightGray);
				   doc.rect(15, yPosition - 3, 180, 6, 'F');
				   doc.setFontSize(10);
				   doc.setFont(undefined, 'bold');
				   doc.text('No.', 20, yPosition + 1);
				   doc.text('Name', 35, yPosition + 1);
				   doc.text('Title/Position', 100, yPosition + 1);
				   doc.text('Contact', 160, yPosition + 1);

				   yPosition += 8;

				   // Table rows with simple alternating background
				   order.travelers.forEach((traveler, index) => {
					   if (index % 2 === 0) {
						   doc.setFillColor(250, 250, 250);
						   doc.rect(15, yPosition - 3, 180, 6, 'F');
					   }

					   doc.setTextColor(...primaryColor);
					   doc.setFont(undefined, 'normal');
					   doc.text(`${index + 1}.`, 20, yPosition + 1);
					   doc.text(traveler.name || '—', 35, yPosition + 1);
					   doc.text(traveler.title || '—', 100, yPosition + 1);
					   doc.text(traveler.contact || '—', 160, yPosition + 1);

					   yPosition += 6;
				   });
			} else {
				doc.setFont(undefined, 'italic');
				doc.setTextColor(...secondaryColor);
				doc.text('No travelers assigned to this order', leftColumn, yPosition);
				yPosition += 6;
			}
			
			yPosition += 10;
			
			// Notes Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('ADDITIONAL NOTES', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Notes box
			const notesHeight = 18;
			doc.setFillColor(252, 252, 252);
			doc.rect(15, yPosition - 5, 180, notesHeight, 'FD');
			
			doc.setFontSize(9);
			doc.setFont(undefined, 'normal');
			const notes = order.notes || 'No additional notes provided for this travel order.';
			const splitNotes = doc.splitTextToSize(notes, 170);
			doc.text(splitNotes, 20, yPosition);
			
			yPosition += notesHeight + 10;
			
			// Approval Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('APPROVALS & SIGNATURES', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Approval boxes with simple styling
			const approvalBoxHeight = 20;
			doc.setFillColor(250, 250, 250);
			
			// Manager Approval
			doc.rect(15, yPosition, 85, approvalBoxHeight, 'FD');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(9);
			doc.setFont(undefined, 'bold');
			doc.text('Manager Approval:', 20, yPosition + 4);
			doc.setFont(undefined, 'normal');
			doc.text('Name: ____________________', 20, yPosition + 8);
			doc.text('Signature: ________________', 20, yPosition + 12);
			doc.text('Date: ____________________', 20, yPosition + 16);
			
			// Finance Approval
			doc.rect(110, yPosition, 85, approvalBoxHeight, 'FD');
			doc.setFont(undefined, 'bold');
			doc.text('Finance Approval:', 115, yPosition + 4);
			doc.setFont(undefined, 'normal');
			doc.text('Name: ____________________', 115, yPosition + 8);
			doc.text('Signature: ________________', 115, yPosition + 12);
			doc.text('Date: ____________________', 115, yPosition + 16);
			
			yPosition += approvalBoxHeight + 8;
			
			// Simple footer
			doc.setFillColor(...primaryColor);
			doc.rect(0, yPosition, 210, 12, 'F');
		
		// Enhanced Test Email Function with Diagnostics
		async function testEmailToSpecificAddress() {
			try {
				console.log('🧪 Starting enhanced email test with diagnostics...');
				
				// Check EmailJS initialization
				console.log('🔍 Checking EmailJS status...');
				console.log('EmailJS library loaded:', typeof emailjs !== 'undefined');
				console.log('EmailService initialized:', emailService?.isInitialized);
				console.log('EmailJS Public Key:', emailService?.emailJSPublicKey);
				console.log('Service ID:', emailService?.serviceId);
				console.log('Template ID:', emailService?.templateId);
				
				if (!emailService || !emailService.isInitialized) {
					throw new Error('EmailJS service not initialized properly');
				}

				// Create test travel order data
				const testOrder = {
					firebaseKey: 'test-order-123',
					orderId: 'TO-TEST-001',
					status: 'Issued',
					createdBy: 'Test User',
					createdAt: new Date().toISOString(),
					origin: 'New York Office',
					destination: 'Los Angeles Branch',
					departureDate: '2025-09-15',
					returnDate: '2025-09-20',
					vehicle: {
						plateNumber: 'ABC-123',
						vehicleName: 'Toyota Camry',
						vehicleType: 'Sedan'
					},
					driver: 'John Smith',
					driverContact: '+1-555-0123',
					travelers: [
						{
							name: 'Test Traveler 1',
							title: 'Manager'
						},
						{
							name: 'Test Traveler 2', 
							title: 'Assistant'
						}
					],
					notes: 'This is a test travel order for EmailJS functionality testing.'
				};

				console.log('📝 Test order created:', testOrder);

				// Generate PDF blob
				console.log('📄 Generating PDF...');
				const pdfBlob = await generatePDFBlob(testOrder);
				console.log('✅ PDF generated successfully, size:', pdfBlob.size, 'bytes');

				// Convert PDF to base64 for logging
				const pdfBase64 = await emailService.blobToBase64(pdfBlob);
				console.log('� PDF converted to base64, length:', pdfBase64.length);

				// Prepare template parameters
				const templateParams = {
					to_email: 'imoudreamentreprises@gmail.com',
					from_name: 'Travel Management System',
					order_id: testOrder.orderId,
					traveler_names: testOrder.travelers.map(t => t.name).join(', '),
					departure_date: new Date(testOrder.departureDate).toLocaleDateString(),
					return_date: new Date(testOrder.returnDate).toLocaleDateString(),
					origin: testOrder.origin,
					destination: testOrder.destination,
					vehicle: `${testOrder.vehicle.plateNumber} - ${testOrder.vehicle.vehicleName}`,
					driver: testOrder.driver,
					status: testOrder.status,
					attachment: pdfBase64,
					attachment_name: 'tr_file.pdf'
				};

				console.log('📋 Template parameters prepared:', {
					...templateParams,
					attachment: `[BASE64 PDF - ${pdfBase64.length} chars]`
				});

				// Send test email with detailed logging
				console.log('📧 Sending test email to imoudreamentreprises@gmail.com...');
				console.log('Using EmailJS service:', emailService.serviceId);
				console.log('Using template:', emailService.templateId);
				
				const response = await emailjs.send(
					emailService.serviceId, 
					emailService.templateId, 
					templateParams
				);
				
				console.log('✅ EmailJS response received:', response);
				console.log('Response status:', response.status);
				console.log('Response text:', response.text);
				
				alert(`✅ Test email sent successfully to imoudreamentreprises@gmail.com!\n\nResponse: ${response.text}\nStatus: ${response.status}\n\nCheck your inbox and spam folder.`);
				
				return response;
				
			} catch (error) {
				console.error('❌ Test email failed:', error);
				console.error('Error details:', error.name, error.message);
				if (error.text) console.error('EmailJS error text:', error.text);
				if (error.status) console.error('EmailJS error status:', error.status);
				
				alert(`❌ Test email failed!\n\nError: ${error.message}\nType: ${error.name}\n\nCheck console for details.`);
				throw error;
			}
		}

		// Simple test without PDF attachment for troubleshooting
		async function testSimpleEmail() {
			try {
				console.log('🧪 Testing simple email without PDF...');
				
				const simpleParams = {
					to_email: 'imoudreamentreprises@gmail.com',
					from_name: 'Travel Management System',
					order_id: 'SIMPLE-TEST-001',
					traveler_names: 'Test User',
					departure_date: '2025-09-15',
					return_date: '2025-09-20',
					origin: 'Test Origin',
					destination: 'Test Destination',
					vehicle: 'Test Vehicle',
					driver: 'Test Driver',
					status: 'Test Status'
					// No attachment for this test
				};

				console.log('📧 Sending simple test email...');
				const response = await emailjs.send(
					emailService.serviceId, 
					emailService.templateId, 
					simpleParams
				);
				
				console.log('✅ Simple email sent successfully:', response);
				alert(`✅ Simple test email sent successfully!\n\nResponse: ${response.text}\nStatus: ${response.status}`);
				
				return response;
				
			} catch (error) {
				console.error('❌ Simple email test failed:', error);
				alert(`❌ Simple email test failed: ${error.message}`);
				throw error;
			}
		}
		
		// Make functions globally available
		window.switchTab = switchTab;
		window.renderTravelOrders = renderTravelOrders;
		window.viewTravelOrder = viewTravelOrder;
		window.editTravelOrder = editTravelOrder;
		window.printTravelOrder = printTravelOrder;
		window.emailTravelOrder = emailTravelOrder;
		window.sendTestEmail = sendTestEmail;
		window.testEmailToSpecificAddress = testEmailToSpecificAddress;
		window.testSimpleEmail = testSimpleEmail;
		window.testEmailService = testEmailService;
		window.diagnoseEmailJSIssues = diagnoseEmailJSIssues;
		window.testBasicEmail = testBasicEmail;
		window.removeTraveler = removeTraveler;
	</script>
</body>
</html>
