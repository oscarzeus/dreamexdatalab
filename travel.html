<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Travel Requests - Dreamex Datalab HSE</title>
	<!-- Step 1 Skeleton Implementation -->

	<!-- Firebase v8 CDN -->
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

	<!-- Icons -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<!-- Export Libraries -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	
	<!-- EmailJS CDN for email service -->
	<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

	<style>
		:root {
			--primary-color: #2c3e50;
			--secondary-color: #3498db;
			--accent-color: #e74c3c;
			--text-color: #333;
			--bg-color: #f5f6fa;
			--sidebar-width: 250px;
			--font-family: 'Inter', system-ui, -apple-system, sans-serif;
			--base-font-size: 0.9rem;
			--transition-speed: 0.2s;
		}
		* { margin:0; padding:0; box-sizing: border-box; }
		body { font-family: var(--font-family); font-size: var(--base-font-size); background:#f8f9fa; color:#333; }
		.app-container { display:flex; min-height:100vh; }
		.sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; z-index:1000; transition:transform 0.3s ease; }
		.sidebar .logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); }
		.menu { list-style:none; margin-top:1.5rem; }
		.menu li { margin-bottom:0.4rem; }
		.menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.55rem 0.75rem; border-radius:6px; font-size:0.8rem; transition:background .25s; }
		.menu a:hover, .menu a.active { background:var(--secondary-color); }
		.menu-dropdown .submenu { display:none; list-style:none; margin-left:1rem; }
		.menu-dropdown:hover .submenu { display:block; }
		/* Permission visibility */
		[data-feature]:not(.menu-visible) { display:none !important; }
		.menu-dropdown:not(.menu-visible) { display:none !important; }
		/* Hide all menu items while loading to prevent flicker */
		.sidebar.menu-loading [data-feature] { display:none !important; }
		/* Main content */
		.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.5rem; padding-top:4rem; transition:margin-left 0.3s ease; }
		.top-nav { position:fixed; top:0.25rem; left:calc(var(--sidebar-width) + 0.5rem); right:0.5rem; height:50px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 0.75rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-radius:4px; z-index:200; transition:left .3s; }
		.top-nav-left { display:flex; align-items:center; gap:0.75rem; }
		.sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
		.company-branding { display:flex; align-items:center; gap:0.5rem; }
		#headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
		#headerCompanyName { font-weight:600; font-size:0.85rem; }
		.top-nav-right { display:flex; align-items:center; gap:1rem; }
		
		/* Notification Styles */
		.notifications {
			position: relative;
			display: flex;
			align-items: center;
		}

		.notification-btn {
			background: none;
			border: none;
			cursor: pointer;
			position: relative;
			font-size: 1.2rem;
			padding: 0.5rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.notification-badge {
			position: absolute;
			top: -5px;
			right: -5px;
			background-color: var(--accent-color);
			color: white;
			border-radius: 50%;
			padding: 0.2rem 0.5rem;
			font-size: 0.7rem;
		}

		.notification-dropdown {
			display: none;
			position: absolute;
			right: 0;
			top: 100%;
			width: 300px;
			background-color: white;
			border-radius: 5px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			z-index: 1000;
		}

		.notification-dropdown.show {
			display: block;
		}

		.notification-header {
			padding: 1rem;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.notification-header h3 {
			margin: 0;
			font-size: 1rem;
		}

		.mark-all-read {
			background: none;
			border: none;
			color: var(--primary-color);
			cursor: pointer;
			font-size: 0.8rem;
		}

		.notification-list {
			max-height: 300px;
			overflow-y: auto;
		}

		.notification-item {
			padding: 0.75rem 1rem;
			border-bottom: 1px solid #f0f0f0;
			cursor: pointer;
		}

		.notification-item:hover {
			background-color: #f8f9fa;
		}

		.notification-item.unread {
			background-color: #f0f8ff;
		}
		
		/* User Profile Styles */
		.profile-btn { background:none; border:none; cursor:pointer; padding:0; }
		.profile-btn img { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#eee; }
		.profile-dropdown { position:absolute; top:100%; right:0; background:#fff; border:1px solid #ddd; border-radius:6px; padding:0; display:none; min-width:220px; box-shadow:0 4px 12px rgba(0,0,0,0.12); }
		.profile-dropdown.show { display:block; }
		.profile-dropdown ul { list-style:none; }
		.profile-dropdown li a { display:flex; align-items:center; gap:8px; padding:10px 14px; text-decoration:none; color:#333; font-size:0.8rem; }
		.profile-dropdown li a:hover { background:#f5f5f5; }
		
		/* Person search dropdown styles */
		.person-search-container{position:relative;}
		.person-search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ced4da;border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
		.person-search-result{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s;}
		.person-search-result:hover{background:#f8f9fa;}
		.person-search-result:last-child{border-bottom:none;}
		.person-search-result .user-name{font-weight:600;color:#333;font-size:0.75rem;}
		.person-search-result .user-title{font-size:.65rem;color:#666;margin-top:2px;}
		
		/* Page header */
		.page-header { background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)); color:#fff; padding:0.75rem 1rem; margin:0 0 0.5rem 0; border-radius:0; display:flex; align-items:center; justify-content:space-between; box-shadow:0 4px 18px rgba(0,0,0,0.15); }
		.page-header h1 { font-size:0.95rem; font-weight:600; display:flex; align-items:center; gap:0.5rem; }
		.page-actions { display:flex; gap:0.5rem; }
		.btn-primary { background:var(--secondary-color); color:#fff; }
		.btn-outline { background:#fff; color:var(--secondary-color); border:1px solid var(--secondary-color); }
		.btn:hover { opacity:0.9; }
		/* Table */
		.table-container { background:#fff; border-radius:6px; box-shadow:0 12px 36px rgba(0,0,0,0.12),0 4px 12px rgba(0,0,0,0.08); overflow:hidden; display:flex; flex-direction:column; height:calc(100vh - 170px); }
		.table-wrapper { flex:1; overflow:auto; }
		table { width:100%; border-collapse:collapse; font-size:0.65rem; }
		thead th { position:sticky; top:0; background:#f0f2f5; text-align:left; padding:0.45rem 0.6rem; font-weight:600; border-bottom:2px solid #e2e6ea; white-space:nowrap; }
		tbody td { padding:0.4rem 0.6rem; border-bottom:1px solid #eee; }
		tbody tr:hover { background:#fafafa; }
		.status-chip { padding:0.2rem 0.5rem; border-radius:12px; font-size:0.55rem; font-weight:600; background:#e0e7ff; color:#1f3b7d; display:inline-block; }
		.actions { display:flex; gap:0.3rem; }
		.actions button { font-size:0.55rem; padding:0.25rem 0.45rem; border-radius:4px; border:none; cursor:pointer; background:#f0f0f0; }
		
		/* Modal Styles - A4 format (matching gate pass details modal) */
		.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:flex-start;justify-content:center;padding:20px;z-index:2000;overflow-y:auto;}
		.modal-backdrop.hidden{display:none;}
		.modal-panel{background:#f5f6fa;width:100%;max-width:240mm;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:90vh;}
		.modal-header-bar{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:12px 12px 0 0;}
		.modal-title-bar{font-weight:600;display:flex;align-items:center;gap:6px;font-size:0.9rem;color:#1f2937;}
		.modal-close-bar{background:none;border:none;font-size:1rem;cursor:pointer;color:#64748b;padding:.35rem;border-radius:6px;}
		.modal-close-bar:hover{background:#f1f5f9;color:#111;}
		.modal-body-bar{padding:18px 20px;overflow-y:auto;display:flex;flex-direction:column;gap:0;font-size:0.75rem;background:#f5f6fa;}
		
		/* A4-sized document inside modal */
		.a4-sheet{position:relative;width:190mm;min-height:auto;margin:0 auto;background:#fff;border:none;border-radius:0;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:2mm 2mm 18mm;box-sizing:border-box;color:#111827;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;}
		.a4-header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:0;page-break-inside:avoid;}
		.company-block{display:flex;flex-direction:column;align-items:flex-start;gap:8px;}
		.a4-logo{width:100px;height:100px;border-radius:8px;object-fit:contain;background:#fff;border:none;display:block;}
		.a4-company h1{margin:0;font-size:1.1rem;line-height:1.2;font-weight:700;}
		.a4-company .doc-title{font-size:.9rem;font-weight:700;margin:2px 0 0;color:#111827;text-align:left;}
		.divider{height:1px;background:#e5e7eb;margin:12px 0 18px;border-radius:1px;}
		.docmeta-row{display:flex;gap:6px;align-items:center;margin:6px 0 12px;font-size:.72rem;color:#111827;}
		
		/* Tables - matching gate pass modal design */
		.a4-info-table{width:100%;border-collapse:collapse;font-size:.66rem;}
		.a4-info-table th{background:var(--primary-color, #2c3e50);font-weight:600;text-transform:none;font-size:.58rem;letter-spacing:.01em;color:#ffffff;padding:6px;border:1px solid var(--primary-color, #2c3e50);text-align:left;}
		.a4-info-table td{padding:6px;border:1px solid #e5e7eb;vertical-align:top;background:#fff;color:#111827;}
		
		/* Sections - matching gate pass modal design */
		.a4-section{margin:4px 0;page-break-inside:avoid;}
		.a4-section-title{font-size:.75rem;margin:0 0 8px;display:flex;align-items:center;gap:8px;font-weight:600;color:#fff;background:var(--primary-color, #2c3e50);padding:6px 10px;border-radius:0;}
		.a4-section-title i{font-size:.8rem;color:#fff;}
		.a4-section-title .section-text{flex:1;}
		
		/* Status chips */
		.status-chip.approved{color:#166534;background:#dcfce7;} .status-chip.declined,.status-chip.rejected{color:#991b1b;background:#fee2e2;} .status-chip.pending,.status-chip.pendingapproval{color:#92400e;background:#fef3c7;} .status-chip.submitted{color:#1d4ed8;background:#dbeafe;} .status-chip.cancelled{color:#475569;background:#e2e8f0;}
		
		/* Signature and approver styling */
		.sig-img{max-width:150px;max-height:75px;object-fit:contain;display:block;}
		.approver-job{font-size:.55rem;color:#6b7280;display:block;margin-top:2px;}
		.approver-fullname{font-size:.66rem;color:#1f2937;display:block;font-weight:600;}
		
		/* Buttons */
		.btn-small{padding:.4rem .7rem;font-size:.6rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:.4rem;}
		.btn-outline{background:#fff;border:1px solid #d1d5db;color:#374151;}
		.btn-outline:hover{background:#f3f4f6;}
		.btn-primary{background:#2563eb;color:#fff;}
		.btn-primary:hover{background:#1d4ed8;}
		.btn-success{background:#10b981;color:#fff;}
		.btn-success:hover{background:#059669;}
		.btn-danger{background:#ef4444;color:#fff;}
		.btn-danger:hover{background:#dc2626;}
		.remove-person.btn-danger{background:transparent;color:#ef4444;border:1px solid #e5e7eb;}
		.remove-person.btn-danger:hover{background:#fee2e2;color:#dc2626;border:1px solid #fecaca;}
		.btn-warning{background:#f59e0b;color:#fff;}
		.btn-warning:hover{background:#d97706;}
		
		/* Modal Footer Button Styles - Matching Staff Position Details Modal */
		.modal-footer-bar{padding:12px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:.85rem;background:rgba(255,255,255,0.95);border-radius:0 0 12px 12px;align-items:center;flex-wrap:wrap;box-shadow:0 -2px 15px rgba(0,0,0,0.03);}
		.modal-footer-bar .btn-small{padding:0.5rem 1rem;font-size:0.875rem;font-weight:500;min-width:2.5rem;min-height:2.5rem;justify-content:center;transition:all 0.2s ease;}
		.modal-footer-bar .btn-small i{font-size:0.875rem;}
		.modal-footer-bar .btn-outline{background:transparent;border:none;color:#6b7280;box-shadow:none;}
		.modal-footer-bar .btn-outline:hover{background:#f9fafb;color:#374151;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.15);}
		.modal-footer-bar .btn-primary{background:transparent;border:none;color:#3b82f6;box-shadow:none;}
		.modal-footer-bar .btn-primary:hover{background:#dbeafe;color:#2563eb;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.15);}
		.modal-footer-bar .btn-success{background:transparent;border:none;color:#10b981;box-shadow:none;}
		.modal-footer-bar .btn-success:hover{background:#d1fae5;color:#059669;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.15);}
		.modal-footer-bar .btn-danger{background:transparent;border:none;color:#ef4444;box-shadow:none;}
		.modal-footer-bar .btn-danger:hover{background:#fee2e2;color:#dc2626;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.15);}
		.modal-footer-bar .btn-warning{background:transparent;border:none;color:#f59e0b;box-shadow:none;}
		.modal-footer-bar .btn-warning:hover{background:#fef3c7;color:#d97706;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.15);}
		
		/* Batch selection styles */
		.batch-checkbox{width:16px;height:16px;cursor:pointer;accent-color:var(--primary-color, #3b82f6);}
		.batch-action-bar{display:none;align-items:center;gap:12px;padding:10px 16px;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;margin-bottom:12px;}
		.batch-action-bar.visible{display:flex;}
		.batch-action-bar .selected-count{font-size:.75rem;font-weight:600;color:#92400e;}
		.batch-action-bar .batch-btn{padding:6px 12px;border:none;border-radius:6px;font-size:.7rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .2s;}
		.batch-action-bar .batch-btn-delete{background:#ef4444;color:#fff;}
		.batch-action-bar .batch-btn-delete:hover{background:#dc2626;}
		.batch-action-bar .batch-btn-cancel{background:#e5e7eb;color:#374151;}
		.batch-action-bar .batch-btn-cancel:hover{background:#d1d5db;}
		#travelRequestsTable tbody tr.selected{background:#fef9c3 !important;}
		#travelOrderTable tbody tr.selected{background:#fef9c3 !important;}
		/* Column Filter Styles */
		.column-filter-header{position:relative;cursor:pointer;}
		.column-filter-header:hover{background:#f3f4f6;}
		.column-filter-header.filter-active{color:var(--primary-color);font-weight:700;}
		.column-filter-dropdown{position:absolute;top:100%;left:0;min-width:150px;max-height:250px;overflow-y:auto;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;display:none;padding:6px 0;}
		.column-filter-dropdown.show{display:block;}
		.column-filter-dropdown .filter-option{padding:6px 12px;font-size:.7rem;cursor:pointer;display:flex;align-items:center;gap:6px;}
		.column-filter-dropdown .filter-option:hover{background:#f3f4f6;}
		.column-filter-dropdown .filter-option.selected{background:#e0e7ff;color:#3730a3;}
		.column-filter-dropdown .filter-search{padding:6px 10px;margin:0 6px 6px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;width:calc(100% - 12px);box-sizing:border-box;}
		.column-filter-dropdown .filter-clear{padding:6px 12px;font-size:.65rem;color:#6b7280;cursor:pointer;border-top:1px solid #e5e7eb;margin-top:4px;}
		.column-filter-dropdown .filter-clear:hover{background:#f3f4f6;color:#111827;}

		/* Legacy modal - keep for create/edit forms */
		.modal { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding:2rem 1rem; z-index:10000; }
		.modal.show { display:flex; }
		
		/* Travel Request Details Modal - A4 Page Style */
		.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:flex-start; justify-content:center; overflow:auto; padding:32px 20px; }
		.modal-overlay.show { display:flex; }
		.travel-preview-container { background:#fff; border-radius:12px; width:100%; max-width:940px; min-height:60vh; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:visible; }
		.travel-sheet { background:#fff; width:100%; padding:20px 24px 40px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827; }
		.travel-print-btn { position:absolute; top:10px; right:10px; background:#111827; color:#fff; border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; z-index:10; }
		.travel-close-btn { position:absolute; top:10px; right:120px; background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; z-index:10; }
		.travel-header { display:flex; justify-content:space-between; gap:20px; margin-bottom:0; align-items:flex-start; }
		.travel-logo { width:100px; height:100px; object-fit:contain; border:none; border-radius:8px; background:#fff; }
		.travel-logo-fallback { width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px; }
		
		/* Travel Section Title Styles */
		.travel-section-title { 
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
			color:#fff; 
			font-weight:600; 
			font-size:.75rem; 
			padding:10px 14px; 
			border:none; 
			border-radius:0; 
			display:flex; 
			align-items:center; 
			gap:10px;
			box-shadow: 0 2px 8px rgba(44,62,80,0.15);
		}
		.travel-section-title i { 
			font-size: 1rem; 
			width: 28px; 
			height: 28px; 
			background: rgba(255,255,255,0.2); 
			border-radius: 50%; 
			display: flex; 
			align-items: center; 
			justify-content: center;
			flex-shrink: 0;
		}
		.travel-section-title .section-text { flex: 1; }
		.travel-section-title.info-section i { background: rgba(52,152,219,0.3); }
		.travel-section-title.cost-section i { background: rgba(155,89,182,0.3); }
		.travel-section-title.people-section i { background: rgba(46,204,113,0.3); }
		.travel-section-title.approval-section i { background: rgba(231,76,60,0.3); }
		
		/* Define Grid Styles */
		.define-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px 14px; margin-top:8px; }
		.define-item { border:1px solid #e5e7eb; border-radius:6px; background:#fff; padding:10px 12px; display:flex; align-items:flex-start; column-gap:8px; }
		.define-item .label { font-size:.74rem; color:#374151; font-weight:700; text-transform:none; letter-spacing:.01em; min-width:140px; white-space:nowrap; }
		.define-item .label::after { content: ':'; margin-left:4px; }
		.define-item .value { font-size:.74rem; color:#111827; line-height:1.35; flex:1; }
		.define-item.stacked { flex-direction:column; gap:4px; grid-column: span 2; }
		.define-item.stacked .label { min-width:auto; }
		.define-item.stacked .label::after { content: ':'; }
		.define-item.stacked .value { width:100%; }
		
		/* Travel Info Table */
		.travel-info-table { width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px; }
		.travel-info-table td { padding:6px 12px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; }
		.travel-info-table td:first-child { width:180px; font-weight:600; color:#374151; white-space:nowrap; }
		
		/* Person Card Styles */
		.person-card { border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; margin-top:8px; overflow:hidden; }
		.person-card-header { background:linear-gradient(135deg, #f1f5f9, #e2e8f0); padding:8px 12px; font-weight:600; font-size:.72rem; color:#334155; display:flex; align-items:center; gap:8px; }
		.person-card-header i { color:#3498db; }
		.person-card-body { padding:10px 12px; }
		
		/* Print Styles for Travel Modal and Travel Order Modal */
		@media print {
			/* Hide everything by default */
			body * { visibility:hidden !important; }
			
			/* Remove main app container from flow to prevent blank pages */
			.app-container, #travelRequestModal, .sidebar, .main-content { display:none !important; }

			/* Reset page settings */
			html, body { 
				height:auto !important; 
				overflow:visible !important; 
				margin:0 !important; 
				padding:0 !important; 
				background:#fff !important;
			}

			/* Show ONLY the active modal (not hidden) */
			#travelDetailsModal:not(.hidden), #travelDetailsModal:not(.hidden) *,
			#viewTravelOrderModal:not(.hidden), #viewTravelOrderModal:not(.hidden) * { visibility:visible !important; }
			
			#travelDetailsModal:not(.hidden), #viewTravelOrderModal:not(.hidden) { 
				position:static !important; 
				left:0 !important; 
				top:0 !important; 
				width:100% !important; 
				height:auto !important;
				padding:0 !important; 
				background:transparent !important; 
				transform:none !important;
				display:block !important;
				overflow:visible !important;
			}
			
			.modal-panel { 
				box-shadow:none !important; 
				border-radius:0 !important; 
				width:100% !important; 
				max-width:100% !important; 
				height:auto !important;
				max-height:none !important;
				overflow:visible !important;
				position:static !important;
				margin:0 !important;
				padding:0 !important;
				border:none !important;
				/* zoom removed to increase text size */
			}
			
			.modal-body-bar {
				overflow:visible !important;
				height:auto !important;
				max-height:none !important;
				padding:0 !important;
			}
			
			.a4-sheet { 
				padding:0 !important; 
				margin:0 !important;
				height:auto !important;
				overflow:visible !important;
				width:100% !important;
				box-shadow:none !important;
			}
			
			/* Print styles - adjusted for readability */
			.a4-info-table th, .a4-info-table td {
				padding: 4px 6px !important;
				font-size: 0.75rem !important; /* Increased from 0.6rem */
			}
			.a4-section-title {
				padding: 4px 8px !important;
				margin-bottom: 6px !important;
				font-size: 0.8rem !important; /* Increased from 0.7rem */
			}
			.a4-section {
				margin-bottom: 10px !important;
			}
			
			.modal-header-bar, .modal-footer-bar { display:none !important; }
			
			.a4-section-title { background:var(--primary-color, #2c3e50) !important; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
			.status-chip { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
			.a4-info-table { page-break-inside:avoid; }
			
			/* Table headers for travelers and approval flow - match sidebar color */
			.a4-info-table thead,
			.a4-info-table thead tr,
			.a4-info-table thead th {
				background: var(--primary-color, #2c3e50) !important;
				color: #fff !important;
				-webkit-print-color-adjust: exact !important;
				print-color-adjust: exact !important;
			}
			
			/* Ensure hidden modals stay hidden */
			.modal-backdrop.hidden { 
				display:none !important;
			}
		}
		.modal-content { background:#fff; width:100%; max-width:1200px; border-radius:10px; padding:1.25rem 1.5rem 1.5rem; max-height:85vh; overflow:auto; box-shadow:0 18px 48px rgba(0,0,0,0.25); }
		.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem; }
		.modal-header h2 { font-size:0.85rem; font-weight:600; }
		.close-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666; }
		form .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:0.75rem; }
		.form-group { display:flex; flex-direction:column; gap:0.25rem; }
		.form-group label { font-size:0.6rem; font-weight:600; color:#444; text-transform:uppercase; letter-spacing:.5px; }
		.form-group input, .form-group select, .form-group textarea { padding:0.4rem 0.5rem; font-size:0.65rem; border:1px solid #d0d5db; border-radius:6px; background:#fff; height:36px; box-sizing:border-box; }
		.form-group textarea { resize:vertical; min-height:60px; height:auto; }
		.btn { border:none; cursor:pointer; border-radius:6px; padding:0.45rem 0.85rem; font-size:0.7rem; font-weight:500; display:inline-flex; align-items:center; gap:0.4rem; transition:.25s; height:36px; box-sizing:border-box; }
		.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--secondary-color); box-shadow:0 0 0 2px rgba(52,152,219,0.25); }
		.inline-tags { display:flex; gap:0.4rem; flex-wrap:wrap; }
		.inline-tags label { display:flex; align-items:center; gap:0.25rem; background:#f4f6f9; padding:0.3rem 0.55rem; border-radius:20px; font-size:0.55rem; cursor:pointer; border:1px solid #e0e4e8; }
		.cost-summary { background:#f8fafc; border:1px solid #e2e8f0; padding:0.6rem 0.8rem; border-radius:8px; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:0.5rem; margin-top:0.6rem; }
		.summary-item { font-size:0.6rem; display:flex; flex-direction:column; gap:0.15rem; }
		.summary-item span:first-child { font-weight:600; color:#444; }
		.form-actions { margin-top:0.9rem; display:flex; justify-content:flex-end; gap:0.5rem; }
		.empty-state { padding:2rem; text-align:center; color:#666; font-size:0.75rem; }
	.fieldset-title { grid-column:1/-1; font-size:0.55rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#6a6f75; margin-top:0.4rem; padding-top:0.4rem; border-top:1px dashed #d5dadd; display:flex; align-items:center; gap:0.35rem; }
	.fieldset-title i { font-size:0.6rem; opacity:0.7; }
	
	/* ===== Travel Request Modal - Fleet Maintenance Style ===== */
	.travel-summary-bar{
		display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:8px;align-items:flex-end;
	}
	.travel-summary-bar .form-field{flex:1 1 160px;min-width:160px;display:flex;flex-direction:column;gap:6px}
	.travel-summary-bar .form-field.wide{flex:2 1 240px;min-width:220px}
	.travel-block{border:1px solid #e0e0e0;border-radius:8px;padding:10px;background:#fff;margin-bottom:12px;}
	.travel-block>summary{cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px;font-size:.7rem;padding:4px 0;}
	.travel-block>summary::-webkit-details-marker{display:none;}
	.travel-block>summary::before{content:'\f107';font-family:'Font Awesome 6 Free';font-weight:900;font-size:.75rem;margin-right:6px;transition:transform .2s;}
	.travel-block:not([open])>summary::before{transform:rotate(-90deg);}
	.travel-block input[type="text"],
	.travel-block input[type="number"],
	.travel-block input[type="date"],
	.travel-block select,
	.travel-block textarea,
	.travel-summary-bar input,
	.travel-summary-bar select{
		border:1px solid #dfe3e8;background:#fff;padding:6px 8px;border-radius:6px;font-size:.7rem;color:#333;outline:none;transition:border-color .15s ease, box-shadow .15s ease;
	}
	.travel-block input:focus,
	.travel-block select:focus,
	.travel-block textarea:focus,
	.travel-summary-bar input:focus,
	.travel-summary-bar select:focus{
		border-color:#80bdff;box-shadow:0 0 0 2px rgba(0,123,255,.15);
	}
	#travelRequestForm label{font-size:.7rem;color:#334155;font-weight:600}
	.travel-modal-header{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:10px 10px 0 0;}
	.travel-modal-header h5{font-weight:600;display:flex;align-items:center;gap:8px;font-size:.85rem;color:#1f2937;margin:0;}
	.travel-modal-header h5 i{color:#3498db;}
	.travel-modal-body{padding:18px 20px;overflow-y:auto;max-height:72vh;background:#f5f6fa;}
	.travel-modal-footer{padding:12px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;background:#fff;border-radius:0 0 10px 10px;}
	.travel-modal-footer .btn{font-size:.7rem;padding:6px 14px;border-radius:6px;font-weight:600;}
	.travel-modal-footer .btn-secondary{background:#f3f4f6;border:1px solid #d1d5db;color:#374151;}
	.travel-modal-footer .btn-secondary:hover{background:#e5e7eb;}
	.travel-modal-footer .btn-success{background:#10b981;border:none;color:#fff;}
	.travel-modal-footer .btn-success:hover{background:#059669;}
	.error-msg { font-size:0.5rem; color:#b91c1c; display:none; }
	.has-error input, .has-error select, .has-error textarea { border-color:#dc2626; box-shadow:0 0 0 2px rgba(220,38,38,0.2); }
	.filter-bar { display:flex; flex-wrap:wrap; gap:0.5rem; margin:0 0 0.5rem 0; }
	.filter-bar .filter-group { display:flex; flex-direction:column; gap:0.2rem; }
	.filter-bar label { font-size:0.55rem; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:#555; }
	.filter-bar input, .filter-bar select { padding:0.35rem 0.45rem; font-size:0.6rem; border:1px solid #d0d5db; border-radius:5px; }
	.tag-chip { background:#eef2f7; border:1px solid #d4dae1; padding:0.18rem 0.5rem; font-size:0.55rem; border-radius:14px; font-weight:500; display:inline-flex; align-items:center; gap:0.35rem; }
	.tag-chip span { color:#334155; }
	.inline-note { font-size:0.5rem; color:#6b7280; }
	.hidden { display:none !important; }
	/* Mode fields removed */
	.badge-required { background:#fee2e2; color:#991b1b; padding:0.15rem 0.4rem; font-size:0.5rem; border-radius:4px; font-weight:600; }
	.status-chip.pending { background:#fef3c7; color:#92400e; }
	.status-chip.approved { background:#dcfce7; color:#166534; }
	.status-chip.declined, .status-chip.rejected { background:#fee2e2; color:#991b1b; }
	.status-chip.cancelled { background:#e2e8f0; color:#475569; }
	
	/* Settings Tab Styles */
	.settings-section { border:1px solid #e5e7eb; border-radius:8px; margin-bottom:1rem; overflow:hidden; }
	.settings-section h3 { font-size:.9rem; font-weight:600; color:#374151; padding:.8rem 1rem; margin:0; cursor:pointer; background:#f9fafb; display:flex; align-items:center; gap:8px; justify-content:space-between; transition:background .2s; }
	.settings-section h3:hover { background:#f3f4f6; }
	.settings-section h3 .toggle-icon { font-size:.7rem; color:#9ca3af; transition:transform .2s; }
	.settings-section.collapsed h3 .toggle-icon { transform:rotate(-90deg); }
	.settings-section-content { padding:1rem; border-top:1px solid #e5e7eb; }
	.settings-section.collapsed .settings-section-content { display:none; }
	.access-control-table { width:100%; border-collapse:collapse; font-size:.75rem; }
	.access-control-table th, .access-control-table td { padding:8px 10px; text-align:left; border-bottom:1px solid #e5e7eb; }
	.access-control-table th { background:#f9fafb; font-weight:600; color:#374151; font-size:.7rem; text-transform:uppercase; letter-spacing:.02em; }
	.access-control-table tbody tr:hover { background:#f9fafb; }
	.access-control-table input[type="checkbox"] { width:16px; height:16px; cursor:pointer; }
	.ac-add-btn { background:var(--primary-color); color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:.75rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
	.ac-add-btn:hover { opacity:.9; }
	.ac-modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:3000; }
	.ac-modal-content { background:#fff; border-radius:12px; width:100%; max-width:450px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
	.ac-modal-header { padding:16px 20px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
	.ac-modal-header h3 { margin:0; font-size:1rem; color:#111827; display:flex; align-items:center; gap:8px; }
	.ac-modal-close { background:none; border:none; font-size:1.4rem; color:#6b7280; cursor:pointer; }
	.ac-modal-body { padding:20px; }
	.ac-modal-body .form-group { margin-bottom:16px; }
	.ac-modal-body .form-group > label { display:block; font-size:.8rem; font-weight:600; color:#374151; margin-bottom:6px; }
	.ac-modal-body .checkbox-group { display:flex; flex-direction:column; gap:8px; }
	.ac-modal-body .checkbox-item { display:flex; align-items:center; gap:8px; font-size:.8rem; color:#374151; }
	.ac-modal-body .checkbox-item input { width:16px; height:16px; }
	.ac-modal-footer { padding:16px 20px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px; }
	.ac-modal-footer .btn { padding:8px 16px; border-radius:6px; font-size:.8rem; font-weight:600; cursor:pointer; }
	.ac-modal-footer .btn-cancel { background:#f3f4f6; border:1px solid #d1d5db; color:#374151; }
	.ac-modal-footer .btn-save { background:var(--primary-color); border:none; color:#fff; }
	.ac-user-autocomplete { position:relative; }
	.ac-user-autocomplete input { width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:.85rem; }
	.ac-user-dropdown { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #d1d5db; border-radius:6px; max-height:200px; overflow-y:auto; display:none; z-index:10; box-shadow:0 4px 12px rgba(0,0,0,.1); }
	.ac-user-dropdown .item { padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:.8rem; }
	.ac-user-dropdown .item:hover { background:#f3f4f6; }
	.delete-btn { background:#fee2e2; color:#dc2626; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:.7rem; }
	.delete-btn:hover { background:#fecaca; }

	/* Stamp Upload Styles */
	.stamp-upload-container { display:flex; align-items:center; gap:1.2rem; padding:1rem; border:2px dashed #d1d5db; border-radius:10px; cursor:pointer; transition:border-color .2s, background .2s; background:#fafbfc; }
	.stamp-upload-container:hover { border-color:var(--primary-color); background:#f8fafc; }
	.stamp-preview { width:120px; height:120px; object-fit:contain; border-radius:8px; display:none; background:#fff; border:1px solid #e5e7eb; }
	.stamp-preview.visible { display:block; }
	.stamp-placeholder { width:120px; height:120px; display:flex; align-items:center; justify-content:center; background:#f3f4f6; border-radius:8px; color:#9ca3af; font-size:2.5rem; }
	.stamp-upload-text { flex:1; }
	.stamp-upload-text h4 { margin:0 0 4px 0; font-size:.9rem; color:#374151; font-weight:600; }
	.stamp-upload-text p { margin:0; font-size:.75rem; color:#6b7280; line-height:1.5; }
	.stamp-file-input { display:none; }
	.stamp-actions { margin-top:.8rem; display:flex; gap:8px; }
	.stamp-actions.hidden { display:none; }
	.stamp-actions .btn-upload { background:var(--primary-color); color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:.75rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
	.stamp-actions .btn-remove { background:#fee2e2; color:#dc2626; border:none; padding:6px 12px; border-radius:6px; font-size:.75rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
	.stamp-actions .btn-upload:hover { opacity:.9; }
	.stamp-actions .btn-remove:hover { background:#fecaca; }

	/* Approval Flow Table Styles - Matching Access Board */
	.a4-info-table { width:100%; border-collapse:collapse; font-size:0.66rem; margin-top:8px; }
	.a4-info-table thead, .a4-info-table tbody, .a4-info-table tr { display:revert; }
	.a4-info-table th { background:var(--primary-color, #2c3e50); color:#ffffff; font-weight:600; font-size:0.58rem; padding:6px; border:1px solid var(--primary-color, #2c3e50); text-align:left; letter-spacing:.01em; text-transform:none; }
	.a4-info-table td { padding:6px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; }
	.a4-info-table tbody tr:nth-child(odd) td { background:#ffffff; }
	.a4-info-table tbody tr:nth-child(even) td { background:#ffffff; } /* Access board doesn't seem to have zebra striping in CSS provided */
	
	.approver-fullname { font-weight:600; font-size:0.7rem; color:#1f2937; display:block; line-height:1.2; }
	.approver-job { font-size:0.6rem; color:#6b7280; display:block; margin-top:0; line-height:1.2; }
	
	.sig-img { max-width:150px; max-height:75px; object-fit:contain; display:block; }
	.sig-stack { display:flex; flex-direction:column; gap:4px; }
	
	.status-chip { display:inline-block; font-size:0.55rem; font-weight:600; letter-spacing:0.02em; padding:2px 8px; border-radius:4px; }
	.status-chip.pending { background:#fef3c7; color:#92400e; }
	.status-chip.approved { background:#dcfce7; color:#166534; }
	.status-chip.declined, .status-chip.rejected { background:#fee2e2; color:#991b1b; }
	.status-chip.cancelled { background:#e2e8f0; color:#475569; }
	.status-chip.submitted { background:#dbeafe; color:#1d4ed8; }
	.btn-icon { background:#fff; border:1px solid #cfd6dd; color:#334155; }
	.btn-icon:hover { background:#f1f5f9; }
	.page-actions .btn-icon { padding:0.45rem 0.65rem; }
	.tooltip { position:relative; }
	.tooltip:hover::after { content:attr(data-tip); position:absolute; top:calc(100% + 4px); left:50%; transform:translateX(-50%); background:#1e293b; color:#fff; font-size:0.55rem; padding:0.25rem 0.4rem; border-radius:4px; white-space:nowrap; z-index:50; }
		/* Sidebar Collapse Functionality */
		.sidebar.collapsed {
			transform: translateX(-100%);
		}
		
		.main-content.sidebar-collapsed {
			margin-left: 0;
		}
		
		.main-content.sidebar-collapsed .top-nav {
			left: 0.5rem;
		}
		
		/* Responsive */
		@media (max-width:900px){ .main-content { margin-left:0; } .sidebar { transform:translateX(-100%); transition:transform .3s; } .sidebar.open { transform:translateX(0); } .top-nav { left:0.5rem; } }
		
		/* Attachment Display Styles */
		.attachment-item {
			transition: all 0.2s ease;
			border: 1px solid #e9ecef !important;
		}
		.attachment-item:hover {
			background-color: #f1f3f4 !important;
			border-color: #dee2e6 !important;
		}
		.attachment-item .fas {
			font-size: 1.2rem;
		}
		.attachment-item .fw-semibold {
			font-size: 0.85rem;
			color: #495057;
		}
		.attachment-item .text-muted {
			font-size: 0.75rem;
		}
		
		/* Approval Flow Styles */
		.approval-step {
			transition: all 0.2s ease;
		}
		.approval-step.current {
			background-color: #fef3c7 !important;
			border-left: 4px solid #f59e0b;
			padding-left: .6rem !important;
		}
		.approval-step.completed {
			background-color: #d1fae5 !important;
			border-left: 4px solid #10b981;
			padding-left: .6rem !important;
		}
		.approval-step.rejected {
			background-color: #fee2e2 !important;
			border-left: 4px solid #ef4444;
			padding-left: .6rem !important;
		}
		.btn-approve {
			background: #10b981;
			color: white;
			border: none;
		}
		.btn-approve:hover {
			background: #059669;
		}
		
		/* Tab Navigation Styles */
		.tab-navigation {
			display: flex;
			gap: 0;
			margin-bottom: 1.5rem;
			border-bottom: 2px solid #e2e8f0;
		}
		
		.tab-button {
			background: none;
			border: none;
			padding: 0.75rem 1.5rem;
			cursor: pointer;
			font-size: 0.9rem;
			font-weight: 500;
			color: #64748b;
			border-bottom: 3px solid transparent;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}
		
		.tab-button:hover {
			color: #334155;
			background: #f8fafc;
		}
		
		.tab-button.active {
			color: #3b82f6;
			border-bottom-color: #3b82f6;
			background: #eff6ff;
		}
		
		.tab-content {
			display: none;
		}
		
		.tab-content.active {
			display: block;
		}
		
		/* Travel Order Table Styles */
		#travelOrderTable th {
			font-size: 0.75rem;
			padding: 0.5rem;
		}
		
		#travelOrderTable td {
			font-size: 0.8rem;
			padding: 0.5rem;
		}
		
		/* Table Row Hover and Click Styles */
		#travelOrderTable tbody tr {
			cursor: pointer;
			transition: background-color 0.2s ease;
		}
		
		#travelOrderTable tbody tr:hover {
			background-color: #f8fafc;
		}
		
		/* Status Badge Styles */
		.status-badge {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			border-radius: 0.375rem;
			font-size: 0.75rem;
			font-weight: 500;
			text-transform: uppercase;
		}
		
		.status-draft {
			background-color: #f3f4f6;
			color: #374151;
		}
		
		.status-issued {
			background-color: #dbeafe;
			color: #1d4ed8;
		}
		
		.status-completed {
			background-color: #dcfce7;
			color: #166534;
		}
		
		.status-cancelled {
			background-color: #fecaca;
			color: #dc2626;
		}
		
		/* Traveler tag styling */
		.traveler-tag {
			background: #3498db;
			color: white;
			padding: 0.25rem 0.75rem;
			border-radius: 15px;
			font-size: 0.62rem;
			font-weight: 500;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
		}
		
		.traveler-tag .remove-tag {
			background: rgba(255, 255, 255, 0.3);
			border: none;
			color: white;
			border-radius: 50%;
			width: 16px;
			height: 16px;
			font-size: 0.6rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background-color 0.2s ease;
		}
		
		.traveler-tag .remove-tag:hover {
			background: rgba(255, 255, 255, 0.5);
		}
	</style>
</head>
<body>
	<div class="app-container">
		<nav class="sidebar menu-loading" id="sidebar">
			<div class="logo">
				<h2>Dreamex Datalab</h2>
			</div>
			<ul class="menu" id="roleBasedMenu">
				<li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
					<a href="index.html"><i class="fas fa-home"></i> Home</a>
				</li>
				<li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
					<a href="#"><i class="fas fa-medkit"></i> Health</a>
					<ul class="submenu">
						<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
						<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
						<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
					<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
					<ul class="submenu">
						<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
						<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
						<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
						<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
						<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
						<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
					</ul>
				</li>
					<li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
						<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
						<ul class="submenu">
						<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
						<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
						<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
						</ul>
					</li>
				<!-- Risk Management (separate section) -->
				<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
					<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
					<ul class="submenu">
						<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="fuel_management">
					<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
					<ul class="submenu">
						<li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
						<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
						<li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
						<li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
						<li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
						<li data-feature="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
						<li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
						<li data-feature="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="environment_view">
					<a href="#"><i class="fas fa-leaf"></i> Environment</a>
					<ul class="submenu">
						<li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="security_view">
					<a href="#"><i class="fas fa-lock"></i> Security</a>
					<ul class="submenu">
						<li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
						<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
						<li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
					
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
						<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
</ul>
				</li>
				<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
					<a href="#"><i class="fas fa-truck"></i> Logistics</a>
					<ul class="submenu">
						<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
						<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
						<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
						<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
					<a href="#"><i class="fas fa-users"></i> HR</a>
					<ul class="submenu">
						<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
						<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
						<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
						<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
						<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
						<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
						<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
						<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
						<li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
						<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
						<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
						<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
						<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
						<li data-feature="travel_request_view" data-requires-permission="travel_request_view"><a class="active" href="travel.html">Travel Requests</a></li>
					</ul>
				</li>
				<li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
				<li class="menu-dropdown" data-feature="settings_view">
					<a href="#"><i class="fas fa-cog"></i> Settings</a>
					<ul class="submenu">
						<li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
						<li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
						<li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
						<li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
						<li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
						<li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
						<li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
						<li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
						<li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
					</ul>
				</li>
			</ul>
		</nav>
		<main class="main-content" id="mainContent">
			<nav class="top-nav">
				<div class="top-nav-left">
					<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
					<div class="company-branding">
						<img id="headerCompanyLogo" alt="Company Logo" />
						<span id="headerCompanyName"></span>
					</div>
				</div>
				<div class="top-nav-right">
					<div class="notifications">
						<button id="notificationBtn" class="notification-btn">
							<i class="fas fa-bell"></i>
							<span class="notification-badge">0</span>
						</button>
						<div class="notification-dropdown">
							<div class="notification-header">
								<h3>Notifications</h3>
								<button class="mark-all-read">Mark all as read</button>
							</div>
							<div class="notification-list">
								<!-- Notifications will be dynamically added here -->
							</div>
						</div>
					</div>
					<div class="user-profile" style="position:relative;">
						<button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
						<div class="profile-dropdown"><ul></ul></div>
					</div>
				</div>
			</nav>

			<section class="travel-content">
				<div class="page-header">
					<h1><i class="fas fa-suitcase-rolling"></i> Travel Management</h1>
					<div class="page-actions">
						<button id="newTravelRequestBtn" class="btn" style="background:transparent;border:none;color:#fff;box-shadow:none;padding:0.5rem;"><i class="fas fa-plus"></i></button>
					</div>
				</div>

				<!-- Tab Navigation -->
				<div class="tab-navigation">
					<button class="tab-button active" data-tab="requestsTab" onclick="switchTab('requests')">
						<i class="fas fa-list"></i> Travel Requests
					</button>
					<button class="tab-button" data-tab="ordersTab" onclick="switchTab('orders')">
						<i class="fas fa-clipboard-list"></i> Travel Order
					</button>
					<button class="tab-button" data-tab="settingsTab" onclick="switchTab('settings')" style="display:none;">
						<i class="fas fa-cog"></i> Settings
					</button>
				</div>

				<!-- Travel Requests Tab -->
				<div id="requestsTab" class="tab-content active">
					<div class="table-container">
						<div class="filter-bar" id="filterBar" style="display:none;">
							<div class="filter-group">
								<label for="searchTerm">Search</label>
								<input type="text" id="searchTerm" placeholder="Destination / Purpose" />
							</div>
							<div class="filter-group">
								<label for="filterType">Type</label>
								<select id="filterType">
									<option value="">All</option>
									<option value="national">National</option>
									<option value="international">International</option>
								</select>
							</div>
							<div class="filter-group">
								<label for="filterStatus">Status</label>
								<select id="filterStatus">
									<option value="">All</option>
									<option value="Pending Approval">Pending</option>
									<option value="Approved">Approved</option>
									<option value="Declined">Declined</option>
								</select>
							</div>
							<div class="filter-group">
								<label for="fromDate">From</label>
								<input type="date" id="fromDate" />
							</div>
							<div class="filter-group">
								<label for="toDate">To</label>
								<input type="date" id="toDate" />
							</div>
						</div>
						<!-- Batch Action Bar -->
							<div class="batch-action-bar" id="travelBatchActionBar">
								<span class="selected-count"><span id="travelSelectedCount">0</span> selected</span>
								<button class="batch-btn batch-btn-delete" onclick="batchDeleteTravelRequests()"><i class="fas fa-trash"></i> Delete Selected</button>
								<button class="batch-btn batch-btn-cancel" onclick="clearTravelSelection()"><i class="fas fa-times"></i> Cancel</button>
							</div>
							<div class="table-wrapper">
							<table id="travelRequestsTable">
								<thead>
									<tr>
										<th style="width:30px;text-align:center;display:none;"><input type="checkbox" class="batch-checkbox" id="travelSelectAllCheckbox" title="Select all" onclick="toggleTravelSelectAll(this)"></th>
										<th class="column-filter-header" data-column="requestId" onclick="toggleRequestColumnFilter(event, 'requestId')">ID
											<div class="column-filter-dropdown" id="request-filter-requestId"></div>
										</th>
										<th class="column-filter-header" data-column="requester" onclick="toggleRequestColumnFilter(event, 'requester')">Requester
											<div class="column-filter-dropdown" id="request-filter-requester"></div>
										</th>
										<th class="column-filter-header" data-column="type" onclick="toggleRequestColumnFilter(event, 'type')">Type
											<div class="column-filter-dropdown" id="request-filter-type"></div>
										</th>
										<!-- Mode column removed -->
										<th>Travelers</th>
										<th>Per Diem</th>
										<th>Accom.</th>
										<th>Total</th>
										<th class="column-filter-header" data-column="status" onclick="toggleRequestColumnFilter(event, 'status')">Status
											<div class="column-filter-dropdown" id="request-filter-status"></div>
										</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div id="emptyState" class="empty-state" style="display:none;">
								<i class="fas fa-suitcase-rolling" style="font-size:2rem; margin-bottom:0.5rem; opacity:0.4;"></i>
								<div>No travel requests yet. Click "New Request" to create one.</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Travel Order Tab -->
				<div id="ordersTab" class="tab-content">
					<!-- Travel Orders header removed as requested -->
					
					<div class="table-container">
						<!-- Filter bar hidden as requested -->
						<div class="filter-bar" style="display:none;">
							<div class="filter-group">
								<label for="orderSearchTerm">Search</label>
								<input type="text" id="orderSearchTerm" placeholder="Order ID / Traveler Name" />
							</div>
							<div class="filter-group">
								<label for="orderFilterStatus">Status</label>
								<select id="orderFilterStatus">
									<option value="">All</option>
									<option value="Draft">Draft</option>
									<option value="Issued">Issued</option>
									<option value="Completed">Completed</option>
									<option value="Cancelled">Cancelled</option>
								</select>
							</div>
							<div class="filter-group">
								<label for="orderFromDate">From</label>
								<input type="date" id="orderFromDate" />
							</div>
							<div class="filter-group">
								<label for="orderToDate">To</label>
								<input type="date" id="orderToDate" />
							</div>
							<button id="refreshOrderBtn" class="btn btn-icon tooltip" data-tip="Refresh" title="Refresh">
								<i class="fas fa-rotate"></i>
							</button>
						</div>
						<!-- Order Batch Action Bar -->
						<div class="batch-action-bar" id="orderBatchActionBar">
							<span class="selected-count"><span id="orderSelectedCount">0</span> selected</span>
							<button class="batch-btn batch-btn-delete" onclick="batchDeleteTravelOrders()"><i class="fas fa-trash"></i> Delete Selected</button>
							<button class="batch-btn batch-btn-cancel" onclick="clearOrderSelection()"><i class="fas fa-times"></i> Cancel</button>
						</div>
						<div class="table-wrapper">
							<table id="travelOrderTable">
								<thead>
									<tr>
										<th style="width:30px;text-align:center;display:none;"><input type="checkbox" class="batch-checkbox" id="orderSelectAllCheckbox" title="Select all" onclick="toggleOrderSelectAll(this)"></th>
										<th class="column-filter-header" data-column="orderId" onclick="toggleOrderColumnFilter(event, 'orderId')">Order ID
											<div class="column-filter-dropdown" id="order-filter-orderId"></div>
										</th>
										<th class="column-filter-header" data-column="origin" onclick="toggleOrderColumnFilter(event, 'origin')">Origin
											<div class="column-filter-dropdown" id="order-filter-origin"></div>
										</th>
										<th class="column-filter-header" data-column="destination" onclick="toggleOrderColumnFilter(event, 'destination')">Destination
											<div class="column-filter-dropdown" id="order-filter-destination"></div>
										</th>
										<th class="column-filter-header" data-column="vehicle" onclick="toggleOrderColumnFilter(event, 'vehicle')">Vehicle
											<div class="column-filter-dropdown" id="order-filter-vehicle"></div>
										</th>
										<th class="column-filter-header" data-column="departure" onclick="toggleOrderColumnFilter(event, 'departure')">Departure
											<div class="column-filter-dropdown" id="order-filter-departure"></div>
										</th>
										<th class="column-filter-header" data-column="return" onclick="toggleOrderColumnFilter(event, 'return')">Return
											<div class="column-filter-dropdown" id="order-filter-return"></div>
										</th>
										<th class="column-filter-header" data-column="status" onclick="toggleOrderColumnFilter(event, 'status')">Status
											<div class="column-filter-dropdown" id="order-filter-status"></div>
										</th>
										<th>Created Date</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div id="orderEmptyState" class="empty-state" style="display:none;">
								<i class="fas fa-clipboard-list" style="font-size:2rem; margin-bottom:0.5rem; opacity:0.4;"></i>
								<div>No travel orders created yet. Click "Create Travel Order" to start.</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Settings Tab Content -->
				<div id="settingsTab" class="tab-content">
					<div class="card" style="padding:1.2rem; background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
						<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #e5e7eb;">
							<h2 style="margin:0;color:var(--primary-color);font-size:1.2rem;display:flex;align-items:center;gap:8px;">
								<i class="fas fa-cog"></i> Settings
							</h2>
						</div>

						<!-- Access Control Section -->
						<div class="settings-section">
							<h3 onclick="toggleSettingsSection(this)"><i class="fas fa-user-shield"></i> Access Control <i class="fas fa-chevron-down toggle-icon"></i></h3>
							<div class="settings-section-content">
								<p style="font-size:.75rem;color:#6b7280;margin-bottom:.8rem">Control which users can view all travel requests (regardless of creator), access the Travel Orders tab, and access the Settings tab.</p>
								<div style="margin-bottom:.8rem">
									<button type="button" class="ac-add-btn" onclick="openTravelAccessControlModal()"><i class="fas fa-plus"></i> Add User</button>
								</div>
								<div style="overflow-x:auto">
									<table class="access-control-table" id="travelAccessControlTable">
										<thead>
											<tr>
												<th>User</th>
												<th>Email</th>
												<th>Job Title</th>
												<th style="text-align:center">View All Requests</th>
												<th style="text-align:center">Travel Orders Tab</th>
												<th style="text-align:center">Approval Buttons</th>
												<th style="text-align:center">Batch Actions</th>
												<th style="text-align:center">Settings Tab</th>
												<th style="text-align:center">Actions</th>
											</tr>
										</thead>
										<tbody id="travelAccessControlTableBody">
											<tr><td colspan="9" style="text-align:center;color:#9ca3af">Loading...</td></tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>

						<!-- Travel Stamp Section -->
						<div class="settings-section">
							<h3 onclick="toggleSettingsSection(this)"><i class="fas fa-stamp"></i> Approval Stamp <i class="fas fa-chevron-down toggle-icon"></i></h3>
							<div class="settings-section-content">
								<p style="font-size:.75rem;color:#6b7280;margin-bottom:.8rem">Upload a stamp image that will be displayed on approved travel requests and travel orders.</p>
								<div class="stamp-upload-container" onclick="document.getElementById('travelStampFileInput').click()">
									<img id="travelStampPreview" class="stamp-preview" src="" alt="Travel Stamp Preview">
									<div id="travelStampPlaceholder" class="stamp-placeholder">
										<i class="fas fa-stamp"></i>
									</div>
									<div class="stamp-upload-text">
										<h4>Upload Approval Stamp</h4>
										<p>Click to browse or drag & drop<br>
										Supported: JPG, PNG, SVG (Max: 2MB)<br>
										Recommended: 400x400px transparent PNG</p>
									</div>
									<input type="file" id="travelStampFileInput" class="stamp-file-input" accept="image/*" onchange="handleTravelStampUpload(event)">
								</div>
								<div class="stamp-actions hidden" id="travelStampActions">
									<button type="button" class="btn-upload" onclick="event.stopPropagation(); document.getElementById('travelStampFileInput').click()">
										<i class="fas fa-upload"></i> Change Stamp
									</button>
									<button type="button" class="btn-remove" onclick="event.stopPropagation(); removeTravelStamp()">
										<i class="fas fa-trash"></i> Remove
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>

			</section>
		</main>
	</div>

	<!-- Travel Access Control Modal -->
	<div class="ac-modal" id="travelAccessControlModal" style="display:none;">
		<div class="ac-modal-content">
			<div class="ac-modal-header">
				<h3><i class="fas fa-user-shield"></i> <span id="travelAcModalTitle">Add User Access</span></h3>
				<button class="ac-modal-close" onclick="closeTravelAccessControlModal()">&times;</button>
			</div>
			<div class="ac-modal-body">
				<div class="form-group" id="travelAcUserSelectGroup">
					<label>Select User</label>
					<div class="ac-user-autocomplete">
						<input id="travelAcUserInput" type="text" placeholder="Type to search employee..." autocomplete="off" />
						<input id="travelAcUserId" type="hidden" />
						<div id="travelAcUserDropdown" class="ac-user-dropdown"></div>
					</div>
				</div>
				<div class="form-group" id="travelAcUserDisplayGroup" style="display:none;">
					<label>User</label>
					<div id="travelAcUserDisplay" style="padding:10px;background:#f3f4f6;border-radius:8px;font-size:.85rem;color:#111827;"></div>
				</div>
				<div class="form-group">
					<label>Permissions</label>
					<div class="checkbox-group">
						<label class="checkbox-item">
							<input type="checkbox" id="travelAcViewAll" checked>
							View All Requests (regardless of creator)
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="travelAcOrdersTab">
							Travel Orders Tab Access
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="travelAcApprovalButtons">
							Approval Buttons (Approve/Reject in Travel Order Details)
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="travelAcBatchActions">
							Request Batch Actions (Select/Delete multiple requests)
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="travelAcOrderBatchActions">
							Order Batch Actions (Select/Delete multiple orders)
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="travelAcSettingsTab">
							Settings Tab Access
						</label>
					</div>
				</div>
			</div>
			<div class="ac-modal-footer">
				<button class="btn btn-cancel" onclick="closeTravelAccessControlModal()">Cancel</button>
				<button class="btn btn-save" id="travelAcSaveBtn" onclick="saveTravelAccessControl()">Add</button>
			</div>
		</div>
	</div>

	<!-- Modal - Fleet Maintenance Style -->
	<div class="modal" id="travelRequestModal" aria-hidden="true" role="dialog">
		<div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="travelModalTitle" style="padding:0;">
			<div class="travel-modal-header">
				<h5 id="travelModalTitle"><i class="fas fa-plane"></i> Create Travel Request</h5>
				<button class="close-btn" id="closeModalBtn" type="button" aria-label="Close">&times;</button>
			</div>
			<div class="travel-modal-body">
				<form id="travelRequestForm" autocomplete="off" novalidate>
					<!-- Meta info bar (shown in edit mode) -->
					<div id="requestMetaBar" style="display:none; margin:0 0 .85rem; padding:.55rem .75rem; border:1px solid #e2e8f0; background:#fff; border-radius:6px; font-size:.7rem; line-height:1.3;">
						<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.5rem;">
							<div><strong>ID:</strong> <span id="metaReqId">—</span></div>
							<div><strong>Status:</strong> <span id="metaReqStatus" class="status-chip" style="padding:.15rem .45rem; border-radius:14px; background:#eef2f6;">—</span></div>
							<div><strong>Created At:</strong> <span id="metaReqCreatedAt">—</span></div>
							<div><strong>Created By:</strong> <span id="metaReqCreatedBy">—</span></div>
						</div>
					</div>

					<!-- SUMMARY BAR -->
					<section class="travel-summary-bar">
						<div class="form-field">
							<label for="origin">Origin</label>
							<select id="origin" name="origin" required>
								<option value="" disabled selected>Select Origin</option>
							</select>
						</div>
						<div class="form-field">
							<label for="destination">Destination</label>
							<select id="destination" name="destination" required>
								<option value="" disabled selected>Select Destination</option>
							</select>
						</div>
						<div class="form-field">
							<label for="travelType">Travel Type</label>
							<select id="travelType" name="travelType" required>
								<option value="national">National</option>
								<option value="international">International</option>
							</select>
						</div>
						<div class="form-field">
							<label for="costCenter">Cost Center / Dept</label>
							<input type="text" id="costCenter" name="costCenter" placeholder="e.g. FIN-OPS" />
						</div>
					</section>

					<!-- ACCORDION SECTIONS -->
					<div style="display:flex;flex-direction:column;gap:12px;">
						<!-- International Fields -->
						<details id="internationalFieldsBlock" class="travel-block" style="display:none;">
							<summary><i class="fas fa-globe"></i> International Specific</summary>
							<div style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
								<div class="form-field">
									<label for="passportExpiry">Passport Expiry</label>
									<input type="date" id="passportExpiry" name="passportExpiry" />
								</div>
								<div class="form-field">
									<label for="visaRequired">Visa Required</label>
									<select id="visaRequired" name="visaRequired">
										<option value="">Select</option>
										<option value="yes">Yes</option>
										<option value="no">No</option>
									</select>
								</div>
							</div>
						</details>

						<!-- People Traveling -->
						<details open class="travel-block">
							<summary><i class="fas fa-users"></i> People Traveling</summary>
							<div style="margin-top:10px;">
								<div id="peopleContainer">
									<table id="peopleTable" style="width:100%;border-collapse:collapse;font-size:.7rem;display:none;">
										<thead>
											<tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:left;min-width:250px;">Full Name</th>
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:left;min-width:100px;">Departure</th>
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:left;min-width:100px;">Return</th>
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:left;min-width:80px;">Stay</th>
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:left;min-width:45px;">Per Diem</th>
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:left;min-width:300px;">Justification</th>
												<th style="padding:8px;border:1px solid #e2e8f0;font-weight:600;text-align:center;width:40px;">Action</th>
											</tr>
										</thead>
										<tbody id="peopleTableBody"></tbody>
									</table>
								</div>
								<div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
									<button type="button" id="addPersonBtn" class="btn btn-sm btn-primary" style="font-size:.7rem;padding:6px 10px;display:flex;align-items:center;gap:4px;"><i class="fas fa-plus"></i> Add Person</button>
									<span style="font-size:.7rem;color:#6b7280;">Each person may have separate departure/return dates.</span>
								</div>
							</div>
						</details>

						<!-- Person Row Template (hidden) -->
						<template id="personRowTemplate">
							<tr class="person-container" style="background:#fff;">
								<td style="padding:8px;border:1px solid #e2e8f0;vertical-align:top;">
									<div class="person-search-container" style="position:relative;margin-bottom:4px;">
										<input type="text" name="personName" class="person-name" placeholder="Type to search..." autocomplete="off" required style="width:100%;font-size:.7rem;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;" />
										<input type="hidden" name="personId" class="person-id" />
										<input type="hidden" name="personTitle" class="person-title" />
										<input type="hidden" name="personContact" class="person-contact" />
										<div class="person-search-dropdown"></div>
									</div>
									<div style="font-size:.6rem;color:#6b7280;line-height:1.3;">
										<span class="person-title-display"></span>
										<span class="person-contact-display" style="margin-left:8px;"></span>
									</div>
								</td>
								<td style="padding:8px;border:1px solid #e2e8f0;vertical-align:top;">
									<input type="date" name="personDeparture" class="person-departure" style="width:100%;font-size:.7rem;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;" />
								</td>
								<td style="padding:8px;border:1px solid #e2e8f0;vertical-align:top;">
									<input type="date" name="personReturn" class="person-return" style="width:100%;font-size:.7rem;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;" />
								</td>
								<td style="padding:8px;border:1px solid #e2e8f0;vertical-align:top;">
									<select name="personStay" class="person-stay" style="width:100%;font-size:.7rem;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;">
										<option value="">Select</option>
										<option value="camp">Camp</option>
										<option value="hotel">Hotel</option>
										<option value="guesthouse">Guesthouse</option>
										<option value="other">Other</option>
									</select>
								</td>
								<td style="padding:8px;border:1px solid #e2e8f0;vertical-align:top;">
									<input type="number" step="0.01" min="0" name="personPerDiem" class="person-perdiem" placeholder="0.00" style="width:100%;font-size:.7rem;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;" />
								</td>
								<td style="padding:8px;border:1px solid #e2e8f0;vertical-align:top;">
									<input type="text" name="personJustification" class="person-justification" placeholder="Explain why this person needs to travel" style="width:100%;font-size:.7rem;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;" />
								</td>
								<td style="padding:8px;border:1px solid #e2e8f0;text-align:center;vertical-align:top;">
									<button type="button" class="btn btn-sm btn-danger remove-person" title="Remove Person" style="padding:4px 6px;font-size:.7rem;border:none;"><i class="fas fa-trash"></i></button>
								</td>
							</tr>
							<tr class="person-attachments-row" style="background:#f8fafc;">
								<td colspan="7" style="padding:8px;border:1px solid #e2e8f0;border-top:none;">
									<div style="display:flex;align-items:center;gap:8px;">
										<label style="font-size:.65rem;font-weight:600;color:#374151;white-space:nowrap;"><i class="fas fa-paperclip" style="margin-right:4px;"></i>Attachments</label>
										<label class="attachment-upload-zone" style="border:2px dashed #d1d5db;border-radius:6px;padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;min-width:200px;transition:all 0.3s ease;font-size:.65rem;color:#6b7280;" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#f8fafc'" onmouseout="this.style.borderColor='#d1d5db';this.style.background='transparent'">
											<i class="fas fa-cloud-upload-alt"></i>
											<span>Click to upload (PDF, DOC, JPG, PNG)</span>
											<input type="file" name="personAttachments" class="person-attachments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display:none;" />
										</label>
										<div class="attachment-preview-list" style="display:flex;flex-wrap:wrap;gap:6px;flex:1;"></div>
									</div>
								</td>
							</tr>
						</template>

						<!-- Cost Summary -->
						<details open class="travel-block">
							<summary><i class="fas fa-coins"></i> Cost Summary</summary>
							<div style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;">
								<div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px;text-align:center;">
									<span style="font-size:.65rem;color:#6b7280;display:block;">Days</span>
									<strong id="daysDisplay" style="font-size:.85rem;color:#111827;">0</strong>
								</div>
								<div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px;text-align:center;">
									<span style="font-size:.65rem;color:#6b7280;display:block;">Per Diem Total</span>
									<strong id="perDiemTotalDisplay" style="font-size:.85rem;color:#111827;">0.00</strong>
								</div>
								<div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px;text-align:center;">
									<span style="font-size:.65rem;color:#6b7280;display:block;">Accommodation</span>
									<strong id="accommodationTotalDisplay" style="font-size:.85rem;color:#111827;">0.00</strong>
								</div>
								<div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px;text-align:center;">
									<span style="font-size:.65rem;color:#6b7280;display:block;">Transport</span>
									<strong id="transportCostDisplay" style="font-size:.85rem;color:#111827;">0.00</strong>
								</div>
								<div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px;text-align:center;">
									<span style="font-size:.65rem;color:#6b7280;display:block;">Other</span>
									<strong id="otherCostDisplay" style="font-size:.85rem;color:#111827;">0.00</strong>
								</div>
								<div style="background:#e0f2fe;border:1px solid #7dd3fc;border-radius:6px;padding:8px;text-align:center;">
									<span style="font-size:.65rem;color:#0369a1;display:block;">Total Cost</span>
									<strong id="totalCostDisplay" style="font-size:.9rem;color:#0c4a6e;">0.00</strong>
								</div>
							</div>
						</details>
					</div>
				</form>
			</div>
			<div class="travel-modal-footer">
				<button type="button" class="btn btn-secondary" id="cancelFormBtn">Cancel</button>
				<button type="button" class="btn btn-success" id="submitTravelBtn"><i class="fas fa-paper-plane"></i> Submit Request</button>
			</div>
		</div>
	</div>

		<!-- View Details Modal - A4 Page Style (matching gate pass details modal) -->
		<div id="travelDetailsModal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
			<div class="modal-panel" role="document">
				<div class="modal-header-bar">
					<div class="modal-title-bar"><i class="fas fa-plane"></i><span id="modalTitle">Travel Request</span></div>
					<button class="modal-close-bar" type="button" aria-label="Close" id="travelModalCloseBtn"><i class="fas fa-times"></i></button>
				</div>
				<div class="modal-body-bar" id="travelModalBody">
					<!-- A4 sheet content will be rendered here -->
				</div>
				<div class="modal-footer-bar" id="travelModalFooter">
					<button type="button" class="btn-small btn-outline" id="travelModalCloseFooter">Close</button>
					<button type="button" class="btn-small btn-primary" id="travelModalPrintBtn"><i class="fas fa-print"></i> Print</button>
				</div>
			</div>
		</div>

		<!-- Create Travel Order Modal -->
		<div class="modal" id="createTravelOrderModal" aria-hidden="true" role="dialog">
			<div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="travelOrderModalTitle" style="padding:0;max-width:1200px;">
				<div class="travel-modal-header">
					<h5 id="travelOrderModalTitle"><i class="fas fa-file-alt"></i> Create Travel Order</h5>
					<button class="close-btn" id="closeTravelOrderModalBtn" type="button" aria-label="Close">&times;</button>
				</div>
				<div class="travel-modal-body">
					<form id="travelOrderForm" autocomplete="off" novalidate>
						<!-- Meta info bar -->
						<div id="orderMetaBar" style="display:none; margin:0 0 .85rem; padding:.55rem .75rem; border:1px solid #e2e8f0; background:#fff; border-radius:6px; font-size:.7rem; line-height:1.3;">
							<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.5rem;">
								<div><strong>Order ID:</strong> <span id="metaOrderId">—</span></div>
								<div><strong>Status:</strong> <span id="metaOrderStatus" class="status-chip" style="padding:.15rem .45rem; border-radius:14px; background:#eef2f6;">—</span></div>
								<div><strong>Created At:</strong> <span id="metaOrderCreatedAt">—</span></div>
								<div><strong>Created By:</strong> <span id="metaOrderCreatedBy">—</span></div>
							</div>
						</div>

						<!-- Travelers Section (Simulator) -->
						<details open class="travel-block" style="margin-bottom:12px;">
							<summary><i class="fas fa-users"></i> Select Travelers</summary>
							<div style="margin-top:10px;">
								<div id="simulatorResults" style="display:none;">
									<div id="simulatorSummary" style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;padding:10px;margin-bottom:10px;">
										<div style="font-size:.7rem;font-weight:600;color:#0369a1;margin-bottom:5px;">
											<i class="fas fa-chart-pie"></i> Travelers Summary
										</div>
										<div id="summaryStats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;font-size:.65rem;"></div>
									</div>
									<div id="groupedTravelersContainer" style="max-height:300px;overflow-y:auto;"></div>
								</div>
							</div>
						</details>

						<!-- SUMMARY BAR -->
						<section class="travel-summary-bar">
							<div class="form-field">
								<label for="orderOriginField">Origin</label>
								<input type="text" id="orderOriginField" name="orderOrigin" placeholder="Auto-filled from traveler" readonly required style="background:#f3f4f6;" />
							</div>
							<div class="form-field">
								<label for="orderDestinationField">Destination</label>
								<input type="text" id="orderDestinationField" name="orderDestination" placeholder="Auto-filled from traveler" readonly required style="background:#f3f4f6;" />
							</div>
							<div class="form-field">
								<label for="orderTripTypeField">Trip Type</label>
								<input type="text" id="orderTripTypeField" name="orderTripType" placeholder="Auto-filled from traveler" readonly required style="background:#f3f4f6;" />
							</div>
							<div class="form-field">
								<label for="orderDepartureDateField">Departure Date</label>
								<input type="text" id="orderDepartureDateField" name="orderDepartureDate" placeholder="Auto-filled from traveler" readonly required style="background:#f3f4f6;" />
							</div>
							<div class="form-field" id="returnDateContainer">
								<label for="orderReturnDateField">Return Date</label>
								<input type="text" id="orderReturnDateField" name="orderReturnDate" placeholder="Auto-filled from traveler" readonly style="background:#f3f4f6;" />
							</div>
							<div class="form-field">
								<label for="orderVehicleField">Vehicle</label>
								<select id="orderVehicleField" name="orderVehicle">
									<option value="">Select Vehicle</option>
								</select>
							</div>
							<div class="form-field">
								<label for="orderDriverField">Driver</label>
								<input type="text" id="orderDriverField" name="orderDriver" placeholder="Enter driver name" />
							</div>
							<div class="form-field">
								<label for="orderDriverContactField">Driver Contact</label>
								<input type="text" id="orderDriverContactField" name="orderDriverContact" placeholder="Enter contact number" />
							</div>
						</section>

						<!-- ACCORDION SECTIONS -->
						<div style="display:flex;flex-direction:column;gap:12px;">
							<!-- Notes Section -->
							<details open class="travel-block">
								<summary><i class="fas fa-sticky-note"></i> Notes</summary>
								<div style="margin-top:10px;">
									<textarea id="orderNotesField" name="orderNotes" rows="3" placeholder="Additional notes or instructions..." style="width:100%;font-size:.7rem;padding:8px;border:1px solid #d1d5db;border-radius:4px;resize:vertical;"></textarea>
								</div>
							</details>
						</div>
					</form>
				</div>
				<div class="travel-modal-footer">
					<button type="button" class="btn btn-secondary" id="cancelTravelOrderBtn">Cancel</button>
					<button type="submit" form="travelOrderForm" class="btn btn-success"><i class="fas fa-paper-plane"></i> Create Travel Order</button>
				</div>
			</div>
		</div>

		<!-- View Travel Order Modal - A4 Page Style (matching gate pass details modal) -->
		<div id="viewTravelOrderModal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
			<div class="modal-panel" role="document">
				<div class="modal-header-bar">
					<div class="modal-title-bar"><i class="fas fa-clipboard-list"></i><span>Travel Order Details</span></div>
					<button class="modal-close-bar" type="button" aria-label="Close" id="closeViewTravelOrderModalBtn"><i class="fas fa-times"></i></button>
				</div>
				<div class="modal-body-bar" id="viewTravelOrderBody">
					<!-- A4 sheet content will be rendered here -->
				</div>
				<div class="modal-footer-bar" id="viewTravelOrderFooter">
					<button type="button" class="btn-small btn-outline" id="closeViewTravelOrderBtn">Close</button>
					<button type="button" class="btn-small btn-danger" id="rejectTravelOrderBtn" style="display:none;"><i class="fas fa-times"></i> Reject</button>
					<button type="button" class="btn-small btn-success" id="approveTravelOrderBtn" style="display:none;"><i class="fas fa-check"></i> Approve</button>
					<button type="button" class="btn-small btn-primary" id="editFromViewBtn"><i class="fas fa-edit"></i> Edit Order</button>
					<button type="button" class="btn-small btn-primary" id="printTravelOrderBtn"><i class="fas fa-print"></i> Print</button>
				</div>
			</div>
		</div>

		<script>
		// Firebase configuration (same as staff.html)
		const firebaseConfig = {
			apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
			authDomain: "users-8be65.firebaseapp.com",
			databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
			projectId: "users-8be65",
			storageBucket: "users-8be65.firebasestorage.app",
			messagingSenderId: "909025468149",
			appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
			measurementId: "G-XHFMRCJQEZ"
		};
		function initializeFirebase(){ if(!window.firebase || !window.firebase.apps || !window.firebase.apps.length){ window.firebase.initializeApp(firebaseConfig); } return window.firebase; }
		initializeFirebase();

		function getDatabase(){ return initializeFirebase().database(); }
		function ref(db,path){ return db.ref(path); }
		function get(r){ return r.once('value'); }

		// Global database instance
		const database = getDatabase();

		class AuthManager {
			constructor(){ this.currentUser = this.getCurrentUser(); this.db = getDatabase(); this.currentCompany = null; this.initializeAuth(); }
			getCurrentUser(){ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
			setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
			async initializeAuth(){
				if(!this.currentUser){
					console.warn('AuthManager(travel): no user, continuing as guest (redirect disabled)');
					this.currentUser={ uid:'guest', displayName:'Guest User'};
				}
				await this.loadUserCompany();
				await this.updateUIForAuthenticatedUser();
			}
			async loadUserCompany(){ if(!this.currentUser) return; try { const companiesSnap = await get(ref(this.db,'companies')); if(companiesSnap.exists()){ const companies = companiesSnap.val(); for(const [companyId,company] of Object.entries(companies)){ if(company.status !== 'active') continue; if(company.users){ for(const [uid,user] of Object.entries(company.users)){ if(user.authUid === this.currentUser.uid || uid === this.currentUser.uid){ this.currentCompany = company; this.currentUser.companyId = companyId; this.currentUser.companyName = company.companyName; this.updateCompanyBranding(); break; } } } if(this.currentCompany) break; } } } catch(e){ console.error('Company load error', e); } }
			updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ if(logoEl) logoEl.style.display='none'; if(nameEl) nameEl.textContent=''; return; } if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo || this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.style.display='block'; } else { logoEl.style.display='none'; } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
			async updateUIForAuthenticatedUser(){ this.populateUserProfile(); await this.updateMenuVisibility(); }
			getUserDisplayName(){ if(!this.currentUser) return 'User'; return this.currentUser.displayName || this.currentUser.name || (this.currentUser.email? this.currentUser.email.split('@')[0]:'User'); }
			getUserInitials(){ const n=this.getUserDisplayName(); const parts=n.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
			async getUserAvatarUrl(){ try { const storage=window.firebase.storage(); const avatarRef = storage.ref(`avatars/${this.currentUser.uid}/profile.jpg`); return await avatarRef.getDownloadURL(); } catch(e){ return null; } }
			generateInitialsAvatar(name,img){ const initials=this.getUserInitials(); const bg=['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12'][initials.charCodeAt(0)%5]; const svg=`<svg width="40" height="40" xmlns='http://www.w3.org/2000/svg'><rect width='40' height='40' rx='20' fill='${bg}'/><text x='20' y='24' font-size='14' font-family='Arial' fill='#fff' text-anchor='middle' font-weight='600'>${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); }
			async populateUserProfile(){ const btn=document.getElementById('userProfileBtn'); if(!btn || !this.currentUser) return; const img=btn.querySelector('img'); const url=await this.getUserAvatarUrl(); if(url){ img.src=url; } else { this.generateInitialsAvatar(this.getUserDisplayName(), img); } const dropdown=document.querySelector('.profile-dropdown ul'); if(dropdown){ dropdown.innerHTML=`<li style='padding:10px 14px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;'><div style='width:32px;height:32px;border-radius:50%;overflow:hidden;'>${url? `<img src='${url}' style='width:32px;height:32px;object-fit:cover;'/>`: `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:600;">${this.getUserInitials()}</div>`}</div><div style='display:flex;flex-direction:column;'><strong style='font-size:12px;'>${this.getUserDisplayName()}</strong><span style='font-size:10px;color:#666;'>${this.currentUser.email||''}</span></div></li><li><a href='profile.html'><i class='fas fa-user'></i> Profile</a></li><li><a href='#' id='logoutLink'><i class='fas fa-sign-out-alt'></i> Logout</a></li>`; const logoutLink=document.getElementById('logoutLink'); if(logoutLink){ logoutLink.addEventListener('click', e=>{ e.preventDefault(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='index.html'; }); } } }
			resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=> i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=> d.classList.remove('menu-visible')); }
		}

		// Instantiate AuthManager after DOM loaded - make it globally available on window
		let authManager; document.addEventListener('DOMContentLoaded', ()=>{ authManager = new AuthManager(); window.authManager = authManager; setupUIInteractions(); initTravelModule(); initEmailJS(); loadTravelUsersList(); });

		// Global users list for person search
		let travelUsersList = [];
		
		async function loadTravelUsersList() {
			travelUsersList = [];
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) {
				console.warn('⚠️ No company ID available for loading users');
				return;
			}
			
			try {
				const usersRef = firebase.database().ref(`companies/${user.companyId}/users`);
				const snapshot = await usersRef.once('value');
				
				if (snapshot.exists()) {
					const users = snapshot.val();
					Object.entries(users).forEach(([uid, userData]) => {
						const displayName = userData.displayName || userData.name || userData.email || 'Unknown';
						const jobTitle = userData.jobTitle || userData.position || '';
						const email = userData.email || '';
						
						travelUsersList.push({
							id: uid,
							name: displayName,
							title: jobTitle,
							email: email,
							searchText: `${displayName} ${jobTitle} ${email}`.toLowerCase()
						});
					});
				}
				
				console.log(`✅ Loaded ${travelUsersList.length} users for travel person search`);
			} catch (error) {
				console.error('❌ Error loading users for travel:', error);
				travelUsersList = [];
			}
		}
		
		function searchTravelUsers(query) {
			if (!query || query.length < 2) return [];
			const searchTerm = query.toLowerCase();
			return travelUsersList.filter(user => 
				user.name.toLowerCase().includes(searchTerm) || 
				user.searchText.includes(searchTerm)
			).slice(0, 10);
		}
		
		// Function to update attachment preview when files are selected
		function updateAttachmentPreview(input, previewContainer) {
			previewContainer.innerHTML = '';
			const files = input.files;
			if (!files || files.length === 0) return;
			
			Array.from(files).forEach((file, index) => {
				const fileItem = document.createElement('div');
				fileItem.style.cssText = 'display:flex;align-items:center;gap:4px;background:#fff;border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;font-size:.6rem;';
				
				// Determine file icon based on type
				let icon = 'fa-file';
				if (file.type.includes('image')) icon = 'fa-file-image';
				else if (file.type.includes('pdf')) icon = 'fa-file-pdf';
				else if (file.type.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) icon = 'fa-file-word';
				
				// Format file size
				const size = file.size < 1024 ? file.size + ' B' : 
							 file.size < 1048576 ? (file.size / 1024).toFixed(1) + ' KB' : 
							 (file.size / 1048576).toFixed(1) + ' MB';
				
				fileItem.innerHTML = `
					<i class="fas ${icon}" style="color:#6b7280;"></i>
					<span style="max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${file.name}">${file.name}</span>
					<span style="color:#9ca3af;">(${size})</span>
					<button type="button" class="remove-file-btn" data-index="${index}" style="background:none;border:none;color:#ef4444;cursor:pointer;padding:0 2px;font-size:.65rem;" title="Remove">
						<i class="fas fa-times"></i>
					</button>
				`;
				
				previewContainer.appendChild(fileItem);
			});
			
			// Add click handlers for remove buttons
			previewContainer.querySelectorAll('.remove-file-btn').forEach(btn => {
				btn.addEventListener('click', function(e) {
					e.preventDefault();
					e.stopPropagation();
					// Create a new DataTransfer to modify the file list
					const dt = new DataTransfer();
					const removeIndex = parseInt(this.dataset.index);
					Array.from(input.files).forEach((file, i) => {
						if (i !== removeIndex) dt.items.add(file);
					});
					input.files = dt.files;
					updateAttachmentPreview(input, previewContainer);
				});
			});
		}
		
		function initPersonSearch(container) {
			const searchInput = container.querySelector('.person-name');
			const hiddenInput = container.querySelector('.person-id');
			const resultsDiv = container.querySelector('.person-search-dropdown');
			const titleInput = container.querySelector('.person-title');
			
			if (!searchInput || !resultsDiv) return;
			
			searchInput.addEventListener('input', (e) => {
				const query = e.target.value.trim();
				if (query.length >= 2) {
					const results = searchTravelUsers(query);
					showPersonSearchResults(results, resultsDiv, searchInput, hiddenInput, titleInput);
				} else {
					resultsDiv.style.display = 'none';
				}
			});
			
			searchInput.addEventListener('focus', (e) => {
				const query = e.target.value.trim();
				if (query.length >= 2) {
					const results = searchTravelUsers(query);
					showPersonSearchResults(results, resultsDiv, searchInput, hiddenInput, titleInput);
				}
			});
			
			searchInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') {
					e.preventDefault();
					const query = searchInput.value.trim();
					if (query.length >= 2) {
						const results = searchTravelUsers(query);
						if (results.length > 0) {
							selectPersonUser(results[0], searchInput, hiddenInput, titleInput, resultsDiv);
						}
					}
				}
			});
			
			document.addEventListener('click', (e) => {
				if (!container.querySelector('.person-search-container').contains(e.target)) {
					resultsDiv.style.display = 'none';
				}
			});
		}
		
		function showPersonSearchResults(users, resultsDiv, searchInput, hiddenInput, titleInput) {
			resultsDiv.innerHTML = '';
			
			if (users.length === 0) {
				resultsDiv.innerHTML = '<div class="person-search-result"><span class="user-name">No users found</span></div>';
			} else {
				users.forEach(user => {
					const div = document.createElement('div');
					div.className = 'person-search-result';
					div.innerHTML = `
						<div class="user-name">${user.name}</div>
						${user.title ? `<div class="user-title">${user.title}</div>` : ''}
					`;
					div.onclick = () => selectPersonUser(user, searchInput, hiddenInput, titleInput, resultsDiv);
					resultsDiv.appendChild(div);
				});
			}
			
			resultsDiv.style.display = 'block';
		}
		
		function selectPersonUser(user, searchInput, hiddenInput, titleInput, resultsDiv) {
			searchInput.value = user.name;
			if (hiddenInput) hiddenInput.value = user.id;
			if (titleInput) titleInput.value = user.title || '';
			
			// Update display elements
			const container = searchInput.closest('.person-container');
			if (container) {
				const titleDisplay = container.querySelector('.person-title-display');
				const contactDisplay = container.querySelector('.person-contact-display');
				
				// Display job title as-is from database (no formatting)
				const formattedTitle = user.title ? user.title.trim() : '';
				
				if (titleDisplay) titleDisplay.textContent = formattedTitle;
				if (contactDisplay) contactDisplay.textContent = user.contact || '';
				// Also update hidden contact field
				const contactInput = container.querySelector('.person-contact');
				if (contactInput) contactInput.value = user.contact || '';
			}
			
			resultsDiv.style.display = 'none';
		}

		// EmailJS Configuration and Service
		class EmailService {
			constructor() {
				// Working EmailJS configuration from staff.html
				this.emailJSPublicKey = 'fHs6oaqQgkcPoUwpv'; // Working public key
				this.emailJSPrivateKey = 'DYBlzuRorbsDIdU5wGBru'; // Working private key
				this.serviceId = 'service_p2e9swy'; // Your service ID
				this.templateId = 'template_uglh3g9'; // Travel order template
				this.isInitialized = false;
			}

			async initialize() {
				try {
					// Wait for EmailJS library to load
					let attempts = 0;
					while (typeof emailjs === 'undefined' && attempts < 50) {
						await new Promise(resolve => setTimeout(resolve, 100));
						attempts++;
					}
					
					if (typeof emailjs !== 'undefined') {
						emailjs.init(this.emailJSPublicKey);
						this.isInitialized = true;
					} else {
						console.error('EmailJS library failed to load');
						throw new Error('EmailJS library not available');
					}
				} catch (error) {
					console.error('Error initializing EmailJS:', error);
					this.isInitialized = false;
					throw error;
				}
			}

			async sendTravelOrderEmail(orderData, pdfBlob, recipientEmail) {
				if (!this.isInitialized) {
					throw new Error('EmailJS not initialized');
				}

				try {
					// Convert PDF blob to base64
					const pdfBase64 = await this.blobToBase64(pdfBlob);
					
					// Check if PDF is too large (EmailJS limit is around 3MB)
					if (pdfBase64.length > 3000000) {
						throw new Error('PDF file is too large for email. Please reduce the size.');
					}
					
					// Prepare email parameters matching position creation notification style
					const emailParams = {
						// Basic email configuration (matching staff.html notification style)
						to_email: recipientEmail,
						to_name: 'Travel Manager',
						from_name: 'Dreamex Datalab HSE System',
						subject: `Travel Order Document: ${orderData.orderId}`,
						
						// Position-style fields (adapted for travel orders)
						position_title: `Travel Order ${orderData.orderId}`,
						department: 'Travel Management Department',
						requesting_manager: orderData.createdBy || orderData.requestedBy || 'System Administrator',
						request_date: orderData.createdAt ? new Date(orderData.createdAt).toLocaleDateString() : new Date().toLocaleDateString(),
						position_id: orderData.orderId,
						position_code: orderData.orderId,
						
						// Travel-specific details formatted as notification content
						referenceNumber: orderData.orderId,
						requestedStartDate: orderData.departureDate ? new Date(orderData.departureDate).toLocaleDateString() : 'N/A',
						expectedStartDate: orderData.departureDate ? new Date(orderData.departureDate).toLocaleDateString() : 'N/A',
						priority: orderData.priority || 'Standard',
						employmentType: 'Travel Assignment',
						workLocation: `${orderData.origin || 'N/A'} to ${orderData.destination || 'N/A'}`,
						contractDuration: orderData.departureDate && orderData.returnDate ? 
							`${Math.ceil((new Date(orderData.returnDate) - new Date(orderData.departureDate)) / (1000 * 60 * 60 * 24))} days` : 'N/A',
						workingHours: 'As per travel schedule',
						reportingManager: orderData.createdBy || 'Travel Coordinator',
						
						// Compensation/budget details (adapted for travel)
						salaryMin: 'N/A',
						salaryMax: 'N/A',
						benefitsPackage: 'Travel allowances as per policy',
						annualBudgetImpact: orderData.estimatedCost || 'As per travel budget',
						departmentBudget: 'Travel Department Budget',
						availableBudget: 'Within approved limits',
						
						// Travel justification (formatted as business need)
						businessNeed: `Travel requirement for business operations from ${orderData.origin || 'N/A'} to ${orderData.destination || 'N/A'}`,
						keyResponsibilities: 'Travel to designated location and complete assigned business activities',
						requiredSkills: 'N/A',
						requiredExperience: 'N/A',
						requiredEducation: 'N/A',
						
						// Organizational impact (adapted for travel)
						teamSizeImpact: orderData.travelers ? `${orderData.travelers.length} traveler(s)` : '1 traveler',
						workflowChanges: 'Temporary travel assignment',
						trainingRequired: 'Travel safety briefing',
						equipmentNeeded: 'As per travel requirements',
						officeSpace: 'Temporary location',
						
						// Timeline information
						jobPostingStartDate: 'N/A',
						applicationDeadline: 'N/A',
						interviewPeriod: 'N/A',
						onboardingDuration: 'N/A',
						
						// Approval information
						approvalLink: `${window.location.origin}/travel.html?view=${orderData.firebaseKey || orderData.orderId}`,
						nextApproverRole: 'Travel Manager',
						approvalType: 'Travel Order Review',
						currentStage: '1',
						totalStages: '1',
						
						// Contact information
						requestingManagerEmail: orderData.createdByEmail || 'travel@dreamexdatalab.com',
						hrEmail: 'hr@dreamexdatalab.com',
						budgetTeamEmail: 'finance@dreamexdatalab.com',
						
						// Company information
						company_name: 'Dreamex Datalab',
						company_email: 'info@dreamexdatalab.com',
						
						// Comprehensive message content (matching notification template style)
						message: `================================================================================
🚗                    DREAMEX DATALAB HSE SYSTEM                    🚗
🚗                  TRAVEL ORDER DOCUMENT NOTIFICATION               🚗
🚗                         OFFICIAL CONFIRMATION                     🚗
================================================================================

Dear Travel Manager,

A travel order document has been generated and requires your attention.

TRAVEL ORDER DETAILS:
--------------------------------------------------------------------------------
Reference Number      : ${orderData.orderId}
Travel Purpose        : Business Assignment
Origin Location       : ${orderData.origin || 'N/A'}
Destination Location  : ${orderData.destination || 'N/A'}
Departure Date        : ${orderData.departureDate ? new Date(orderData.departureDate).toLocaleDateString() : 'N/A'}
Return Date           : ${orderData.returnDate ? new Date(orderData.returnDate).toLocaleDateString() : 'N/A'}
Duration              : ${orderData.departureDate && orderData.returnDate ? 
							Math.ceil((new Date(orderData.returnDate) - new Date(orderData.departureDate)) / (1000 * 60 * 60 * 24)) + ' days' : 'N/A'}
Order Status          : ${orderData.status || 'Pending'}

AUTHORIZED TRAVELERS:
--------------------------------------------------------------------------------${orderData.travelers ? orderData.travelers.map((traveler, index) => 
`
${index + 1}. ${traveler.name || 'N/A'} - ${traveler.title || 'Staff Member'}`).join('') : 
`
1. Travel details pending confirmation`}

TRANSPORT ARRANGEMENTS:
--------------------------------------------------------------------------------
Vehicle Assignment    : ${orderData.vehicle ? `${orderData.vehicle.plateNumber} - ${orderData.vehicle.vehicleName || orderData.vehicle.vehicleType}` : 'Not Assigned'}
Driver Assignment     : ${orderData.driver || 'Not Assigned'}
Driver Contact        : ${orderData.driverContact || 'N/A'}

ORDER INFORMATION:
--------------------------------------------------------------------------------
Created By            : ${orderData.createdBy || 'System Administrator'}
Creation Date         : ${orderData.createdAt ? new Date(orderData.createdAt).toLocaleDateString() : new Date().toLocaleDateString()}
Order ID              : ${orderData.orderId}
Current Status        : ${orderData.status || 'Pending'}

📋 TRAVEL ORDER DOCUMENT:
--------------------------------------------------------------------------------
The complete travel order document is attached to this email for your records
and approval processes.

📞 CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions about this travel order:
• Travel Coordinator: ${orderData.createdByEmail || 'travel@dreamexdatalab.com'}
• HR Team: hr@dreamexdatalab.com
• Finance Team: finance@dreamexdatalab.com

🔗 REVIEW LINK:
--------------------------------------------------------------------------------
To review this travel order online:
${window.location.origin}/travel.html?view=${orderData.firebaseKey || orderData.orderId}

Thank you for your attention to this travel order notification.

Best regards,
Dreamex Datalab HSE System
🚗 Automated Travel Order Notification System 🚗

================================================================================
This is an automated travel order notification.
Order ID: ${orderData.orderId} | Generated: ${new Date().toLocaleDateString()}
================================================================================`,
						
						// Dynamic travel order attachment
						travel_order: pdfBase64,
						travel_order_name: `Travel_Order_${orderData.orderId}.pdf`,
						travel_order_size: Math.round(pdfBase64.length / 1024) + ' KB'
					};
					
					// Use the same method as staff.html - send with public key parameter
					const response = await emailjs.send(
						this.serviceId,
						this.templateId,
						emailParams,
						this.emailJSPublicKey
					);
					
					return response;
				} catch (error) {
					console.error('EmailJS Error:', error.message || error);
					
					// Create a meaningful error message
					let meaningfulError = 'Travel order email sending failed';
					
					if (error.status === 400) {
						meaningfulError = 'Bad request - Check template parameters';
					} else if (error.status === 401) {
						meaningfulError = 'Unauthorized - Check EmailJS public key';
					} else if (error.status === 404) {
						meaningfulError = 'Not found - Check service ID and template ID';
					} else if (error.status === 413) {
						meaningfulError = 'File too large - PDF exceeds size limit';
					} else if (error.message) {
						meaningfulError = error.message;
					} else if (error.text) {
						meaningfulError = error.text;
					}
					
					throw new Error(meaningfulError);
				}
			}

			blobToBase64(blob) {
				return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = () => {
						const base64 = reader.result.split(',')[1];
						resolve(base64);
					};
					reader.onerror = reject;
					reader.readAsDataURL(blob);
				});
			}
		}

		// Simple working test function
		async function sendTestEmail() {
			try {
				const email = prompt('Enter your email address for testing:');
				if (!email) return;
				
				// Ensure EmailJS is ready
				if (!emailService || !emailService.isInitialized) {
					emailService = new EmailService();
					await emailService.initialize();
				}
				
				const testParams = {
					to_name: 'Test User',
					to_email: email,
					from_name: 'Travel System',
					message: 'This is a test email from the travel management system. If you receive this, the email service is working correctly!'
				};
				
				const response = await emailjs.send(
					emailService.serviceId,
					emailService.templateId,
					testParams
				);
				
				alert(`✅ Test email sent successfully to ${email}!\nCheck your inbox.`);
				return true;
				
			} catch (error) {
				console.error('Test email failed:', error);
				alert(`❌ Test failed: ${error.message}\nCheck console for details.`);
				return false;
			}
		}

		// Enhanced email function with better error handling
		async function emailTravelOrder(orderKey) {
			let loadingButton = null;
			try {
				const order = travelOrders.find(o => o.firebaseKey === orderKey);
				if (!order) {
					alert('Travel order not found');
					return;
				}

				// Ensure EmailJS is ready
				if (!emailService || !emailService.isInitialized) {
					emailService = new EmailService();
					await emailService.initialize();
				}

				if (!emailService.isInitialized) {
					throw new Error('EmailJS initialization failed');
				}

				const recipientEmail = prompt('Enter recipient email address:', '');
				if (!recipientEmail) return;

				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailRegex.test(recipientEmail)) {
					alert('Please enter a valid email address');
					return;
				}

				// Show loading
				loadingButton = event.target;
				loadingButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
				loadingButton.disabled = true;

				const pdfBlob = await generatePDFBlob(order);
				const response = await emailService.sendTravelOrderEmail(order, pdfBlob, recipientEmail);
				
				alert(`✅ Travel order emailed successfully to ${recipientEmail}!\n\nOrder ID: ${order.orderId}`);
				
			} catch (error) {
				console.error('Email error:', error.message || error);
				
				let errorMessage = 'Unknown error occurred';
				
				if (error && typeof error === 'object') {
					if (error.message) {
						errorMessage = error.message;
					} else if (error.text) {
						errorMessage = error.text;
					} else if (error.status) {
						errorMessage = `HTTP Error ${error.status}`;
					} else if (error.toString && error.toString() !== '[object Object]') {
						errorMessage = error.toString();
					}
				} else if (typeof error === 'string') {
					errorMessage = error;
				}
				
				console.error('❌ Final error message:', errorMessage);
				alert(`❌ Error sending email: ${errorMessage}\n\nCheck browser console for details.`);
			} finally {
				if (loadingButton) {
					loadingButton.innerHTML = '<i class="fas fa-envelope"></i>';
					loadingButton.disabled = false;
				}
			}
		}

		// Test EmailJS service readiness (minimal version)
		function testEmailService() {
			if (!emailService || !emailService.isInitialized) {
				return false;
			}
			return true;
		}

		// Initialize EmailJS
		let emailService;
		function initEmailJS() {
			try {
				emailService = new EmailService();
				emailService.initialize();
			} catch (error) {
				console.error('Error initializing EmailJS:', error);
			}
		}

		// Feature-based authorization system (exactly like staff.html)
		function resetMenuVisibility() {
			document.querySelectorAll('[data-feature]').forEach(item => {
				item.classList.remove('menu-visible');
			});
			document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
				dropdown.classList.remove('menu-visible');
			});
		}

		// Emergency fallback - show basic menu items
		function showBasicMenu() {
			resetMenuVisibility();
			
			// Remove loading class
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
			}
			
			const homeItem = document.querySelector('[data-feature="home_view"]');
			if (homeItem) {
				homeItem.classList.add('menu-visible');
			}
		}

		// NEW: Unrestricted menu visibility helper (does not reveal sidebar)
		function showAllMenus(){
			// Mark everything visible but do NOT remove loading state here.
			document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li=> li.classList.add('menu-visible'));
			document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(li=> li.classList.add('menu-visible'));
		}

		// Feature-based authorization system that takes priority over role permissions
		async function updateMenuWithFeatureAuthorization() {
			try {
				let currentUser = null;
				let companyId = null;
				
				// Get user and company info using authManager first
				if (window.authManager && window.authManager.currentUser) {
					currentUser = window.authManager.currentUser;
					companyId = currentUser.companyId;
				} else if (firebase.auth().currentUser) {
					currentUser = firebase.auth().currentUser;
				} else {
					resetMenuVisibility();
					return;
				}
				
				// If no company ID from authManager, search companies collection
				if (!companyId && currentUser) {
					const database = firebase.database();
					const companiesRef = database.ref('companies');
					const companiesSnapshot = await companiesRef.once('value');
					
					if (companiesSnapshot.exists()) {
						const companies = companiesSnapshot.val();
						
						for (const [cId, company] of Object.entries(companies)) {
							if (company.status !== 'active') continue;
							
							if (company.users && company.users[currentUser.uid]) {
								companyId = cId;
								console.log(`✅ Found user in company: ${companyId} (${company.name})`);
								break;
							}
						}
					}
				}
				
				if (!companyId) {
					console.error('❌ No company ID found, cannot determine authorized features');
					resetMenuVisibility();
					return;
				}
				
				// Apply feature-based authorization and get list of authorized pages
				const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
			
				// Determine user role (try currentUser.role, otherwise lookup in company users)
				let userRole = currentUser.role || null;
				if(!userRole){
					try{
						const db = firebase.database();
						const userSnap = await db.ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
						if(userSnap.exists()){
							const u = userSnap.val();
							userRole = u.role || u.userRole || 'user';
						}
					}catch(e){
						console.warn('Could not determine user role from company record, defaulting to user', e);
						userRole = 'user';
					}
				}
			
				// Apply role-based filtering within the authorized pages
				await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
				return;
			} catch (error) {
				console.error('❌ Error in feature-based menu authorization:', error);
				resetMenuVisibility();
			}
		}

		// Apply feature-based menu visibility
		async function applyFeatureBasedMenuVisibility(companyId) {
			try {
				// Get platform features
				const database = firebase.database();
				const featuresSnapshot = await database.ref('/platformFeatures').once('value');
				
				if (!featuresSnapshot.exists()) {
					resetMenuVisibility();
					return;
				}
				
				const featuresData = featuresSnapshot.val();
				
				// Get company's selected features
				const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
				const companyData = companySnapshot.val();
				
				if (!companyData) {
					resetMenuVisibility();
					return;
				}
				
				const subscribedFeatureIds = companyData.selectedFeatures || [];
				
				if (subscribedFeatureIds.length === 0) {
					resetMenuVisibility();
					return;
				}
				
				// Collect authorized pages from subscribed features
				const authorizedPages = [];
				subscribedFeatureIds.forEach(featureId => {
					const feature = featuresData[featureId];
					if (feature && feature.status === 'active' && feature.authorizedPages) {
						authorizedPages.push(...feature.authorizedPages);
					}
				});
				
				// Reset all menu items first
				resetMenuVisibility();
				
				// Create set of authorized features
				const authorizedFeatures = new Set();
				authorizedPages.forEach(pageInfo => {
					if (pageInfo.feature) {
						authorizedFeatures.add(pageInfo.feature);
					}
				});
				
				// Apply menu visibility
				const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
				let visibleCount = 0;
				
				allMenuItems.forEach(menuItem => {
					const featureAttribute = menuItem.getAttribute('data-feature');
					const isAuthorized = authorizedFeatures.has(featureAttribute);
					const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
					
					if (isDropdownContainer) {
						return; // Handle dropdowns separately after all items are processed
					}
					
					if (isAuthorized) {
						menuItem.classList.add('menu-visible');
						visibleCount++;
						console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
					} else {
						menuItem.classList.remove('menu-visible');
						console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
					}
				});
				
				// Handle dropdown menus - show if they have visible children
				const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
				dropdownMenus.forEach(dropdown => {
					const dropdownFeature = dropdown.getAttribute('data-feature');
					const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
					let hasVisibleChildren = false;
					
					submenuItems.forEach(submenuItem => {
						if (submenuItem.classList.contains('menu-visible')) {
							hasVisibleChildren = true;
						}
					});
					
					if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
						dropdown.classList.add('menu-visible');
						console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
					} else {
						dropdown.classList.remove('menu-visible');
					}
				});
			
				// Return authorizedPages to allow role-based filtering to run afterwards
				return authorizedPages;
			} catch (error) {
				console.error('Error applying feature-based menu visibility:', error);
				resetMenuVisibility();
			}
		}

		// Make updateMenuWithFeatureAuthorization available globally
		window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

		// Apply role-based filtering within company authorized features
		async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
			try {
				// Get user role permissions from company
				const database = firebase.database();
				const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
				const permissionsSnapshot = await permissionsRef.once('value');
				
				if (!permissionsSnapshot.exists()) {
					// CRITICAL: If user is administrator but no permissions found, provide full access as fallback
					if (userRole === 'administrator') {
						showSidebarAfterAuth();
						return;
					}
					
					// For other roles without permissions, hide all items with permission requirements
					hideItemsRequiringPermissions();
					showSidebarAfterAuth();
					return;
				}
				
				const permissions = permissionsSnapshot.val();
				
				// Apply permission-based filtering
				filterMenuByPermissions(permissions);
				
			} catch (error) {
				console.error('Error applying role-based filtering:', error);
				// Don't hide everything on error - keep company features visible
				showSidebarAfterAuth();
			}
		}

		// Filter currently visible menu items by role permissions
		function filterMenuByPermissions(permissions) {
			
			if (!permissions) {
				hideItemsRequiringPermissions();
				showSidebarAfterAuth();
				return;
			}
			
			// Only check items that are already visible from company features
			const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			
			visibleMenuItems.forEach(item => {
				const requiresPermission = item.getAttribute('data-requires-permission');
				const feature = item.getAttribute('data-feature');
				
				if (requiresPermission) {
					const hasPermission = permissions[requiresPermission];
					const hasViewPermission = hasPermission === true || 
							(hasPermission && hasPermission.view === true);
					
					if (!hasViewPermission) {
						item.classList.remove('menu-visible');
					}
				}
			});
			
			// Re-check dropdown menus after permission filtering
			const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
			dropdownMenus.forEach(dropdown => {
				const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
				
				if (submenuItems.length === 0) {
					dropdown.classList.remove('menu-visible');
				}
			});
			
			// Show sidebar after all filtering is complete
			showSidebarAfterAuth();
		}

		// Hide menu items that require permissions (for users without role permissions)
		function hideItemsRequiringPermissions() {
			const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			
			itemsRequiringPermissions.forEach(item => {
				item.classList.remove('menu-visible');
			});
		}

		// Show sidebar and remove loading state after authentication and filtering
		function showSidebarAfterAuth() {
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
			}
		}

		// Initialize menu visibility properly through authManager (like roles.html and dashboard.html)
		document.addEventListener('DOMContentLoaded', () => {
			// Wait for auth manager to be ready
			setTimeout(async () => {
				try {
					await updateMenuWithFeatureAuthorization();
				} catch (error) {
					console.error('❌ Error initializing feature-based menu:', error);
					showBasicMenu();
				}
			}, 1500);
		});

		// UI interactions (sidebar & profile)
		function setupUIInteractions(){ 
			const sidebarToggle = document.querySelector('#sidebarToggle');
			if (sidebarToggle) {
				sidebarToggle.addEventListener('click', toggleSidebar);
			}
			
			// Notification Bell functionality
			const notificationBtn = document.getElementById('notificationBtn');
			const notificationDropdown = document.querySelector('.notification-dropdown');
			if (notificationBtn && notificationDropdown) {
				notificationBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					notificationDropdown.classList.toggle('show');
				});
				
				// Close notification dropdown when clicking outside
				document.addEventListener('click', (e) => {
					if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
						notificationDropdown.classList.remove('show');
					}
				});
				
				// Mark all as read functionality
				const markAllReadBtn = document.querySelector('.mark-all-read');
				if (markAllReadBtn) {
					markAllReadBtn.addEventListener('click', () => {
						// Update badge count
						const badge = document.querySelector('.notification-badge');
						if (badge) badge.textContent = '0';
						
						// Mark all notifications as read
						const notifications = document.querySelectorAll('.notification-item.unread');
						notifications.forEach(notification => {
							notification.classList.remove('unread');
						});
					});
				}
			}
			
			const profileBtn=document.getElementById('userProfileBtn'); 
			const profileDropdown=document.querySelector('.profile-dropdown'); 
			profileBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); profileDropdown.classList.toggle('show'); }); 
			document.addEventListener('click', (e)=>{ if(!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)){ profileDropdown.classList.remove('show'); } }); 
			
			// Restore sidebar state on page load
			restoreSidebarState();
		}
		
		function toggleSidebar() {
			const sidebar = document.querySelector('.sidebar');
			const mainContent = document.querySelector('.main-content');
			
			if (sidebar && mainContent) {
				sidebar.classList.toggle('collapsed');
				mainContent.classList.toggle('sidebar-collapsed');
				
				// Store sidebar state in localStorage
				const isCollapsed = sidebar.classList.contains('collapsed');
				localStorage.setItem('sidebarCollapsed', isCollapsed);
			}
		}
		
		function restoreSidebarState() {
			const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
			const sidebar = document.querySelector('.sidebar');
			const mainContent = document.querySelector('.main-content');
			
			if (isCollapsed && sidebar && mainContent) {
				sidebar.classList.add('collapsed');
				mainContent.classList.add('sidebar-collapsed');
			}
		}

	// Travel module (Step 3 - Firebase persistence added)
	const travelRequests = []; // Render source
	let travelRequestsByKey = {}; // Map for quick duplicate avoidance
	let travelListenerAttached = false;
	let travelSyncInProgress = false;
	let currentCompanyId = null; // Global company ID for travel orders
	let cachedApprovalFlow = null; // Cache approval flow config
	let approvalFlowCacheTime = 0; // Timestamp for cache expiry
		function initTravelModule(){
			const newBtn = document.getElementById('newTravelRequestBtn');
			const modal = document.getElementById('travelRequestModal');
			const closeBtn = document.getElementById('closeModalBtn');
			const cancelBtn = document.getElementById('cancelFormBtn');
			const form = document.getElementById('travelRequestForm');
			const travelType = document.getElementById('travelType');
			const advanceReq = document.getElementById('advanceRequired');
			const searchTerm = document.getElementById('searchTerm');
			const filterType = document.getElementById('filterType');
			const filterStatus = document.getElementById('filterStatus');
			const fromDate = document.getElementById('fromDate');
			const toDate = document.getElementById('toDate');
			// Removed exportExcelBtn, exportPdfBtn, refreshBtn

			// Context-aware + button
			newBtn.addEventListener('click', () => {
				// Check which tab is active
				const requestsTabActive = document.getElementById('requestsTab').classList.contains('active');
				const ordersTabActive = document.getElementById('ordersTab').classList.contains('active');
				if (ordersTabActive) {
					// Open create travel order modal
					if (typeof openCreateTravelOrderModal === 'function') {
						openCreateTravelOrderModal();
					}
				} else {
					// Default: open create travel request modal
					openModal();
				}
			});

			closeBtn.addEventListener('click', ()=> closeModal());
			cancelBtn.addEventListener('click', ()=> closeModal());
			modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
			form.addEventListener('submit', handleSubmit);
			
			// Add click handler for submit button (since it's outside the form)
			const submitTravelBtn = document.getElementById('submitTravelBtn');
			if(submitTravelBtn) {
				submitTravelBtn.addEventListener('click', ()=> {
					// Directly call handleSubmit with a mock event
					handleSubmit({ preventDefault: ()=>{}, target: form });
				});
			}
			
			travelType.addEventListener('change', ()=> toggleInternational(travelType.value));
			[searchTerm, filterType, filterStatus, fromDate, toDate].forEach(el=> el.addEventListener('input', applyFilters));
			// Removed exportExcelBtn, exportPdfBtn, refreshBtn event listeners
			document.querySelector('#travelRequestsTable tbody').addEventListener('click', handleRowAction);
			recalcCosts();
			renderTravelRequests();
			waitForCompanyAndAttachListener();
		}
		function waitForCompanyAndAttachListener(attempt=0){ if(attempt>40) return; // ~20s max (500ms interval)
			if(authManager && authManager.currentUser && authManager.currentUser.companyId){ 
				currentCompanyId = authManager.currentUser.companyId; // Set global company ID
				attachTravelRealtimeListener(); 
				// Also initialize travel orders loading
				renderTravelOrders();
			} else { 
				setTimeout(()=> waitForCompanyAndAttachListener(attempt+1), 500); 
			} 
		}
		function attachTravelRealtimeListener(){ if(travelListenerAttached) return; if(!authManager.currentUser.companyId) return; const db=getDatabase(); const companyId=authManager.currentUser.companyId; const path=`companies/${companyId}/travelRequests`; const r=ref(db,path); travelListenerAttached=true; travelSyncInProgress=true; r.on('value', snap=>{ travelSyncInProgress=false; if(!snap.exists()){ travelRequests.length=0; travelRequestsByKey={}; renderTravelRequests(); return; } const data=snap.val(); travelRequestsByKey = data; // Build array sorted by createdAt desc
				const arr = Object.entries(data).map(([key,val])=> ({ firebaseKey:key, ...val }) ); arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0)); travelRequests.length=0; travelRequests.push(...arr); renderTravelRequests(); }, err=>{ console.error('Travel realtime listener error', err); travelListenerAttached=false; setTimeout(()=> attachTravelRealtimeListener(), 5000); }); }
	function toggleInternational(val){ const intl=document.getElementById('internationalFieldsBlock'); if(val==='international'){ intl.style.display=''; intl.setAttribute('open',''); } else { intl.style.display='none'; intl.removeAttribute('open'); } }
	// Mode fields removed — rebuildModeCostInputs no longer needed
	function validateTravelForm(){ let valid=true; const setError=(name, state)=>{ const msg=document.querySelector(`.error-msg[data-error-for="${name}"]`); const field = document.getElementById(name); if(!msg) return; if(state){ msg.style.display='none'; field?.classList.remove('has-error'); } else { msg.style.display='block'; field?.classList.add('has-error'); valid=false; } }; const origin=document.getElementById('origin').value.trim(); setError('origin', origin.length>0); const destination=document.getElementById('destination').value.trim(); setError('destination', destination.length>0); const travelType=document.getElementById('travelType').value; setError('travelType', !!travelType); 
		// Validate that at least one person is added - use global function
		const people = (window.collectPeopleFromForm) ? window.collectPeopleFromForm() : [];
		if(people.length === 0) {
			alert('Please add at least one person for this travel request.');
			valid = false;
		}
		// Validate people have required fields
		for(let i = 0; i < people.length; i++) {
			const person = people[i];
			if(!person.name || person.name.trim().length === 0) {
				alert(`Person ${i+1}: Name is required.`);
				valid = false;
				break;
			}
		}
		return valid; }
	function applyFilters(){ renderTravelRequests(); }
	function openModal(){ 
		document.getElementById('travelRequestModal').classList.add('show'); 
		document.getElementById('travelRequestModal').setAttribute('aria-hidden','false');
		// Set title for new request
		const titleEl = document.getElementById('travelModalTitle');
		if(titleEl) titleEl.innerHTML = '<i class="fas fa-plane"></i> Create Travel Request';
		// Auto-add first person if creating new request
		const form = document.getElementById('travelRequestForm');
		if(!form.dataset.editKey || form.dataset.editKey === '') {
			// Only add person if no people are present (new request)
			const peopleContainer = document.getElementById('peopleContainer');
			if(peopleContainer && peopleContainer.children.length === 0) {
				// Add first person automatically for new requests
				setTimeout(() => {
					const addPersonBtn = document.getElementById('addPersonBtn');
					if(addPersonBtn) {
						addPersonBtn.click();
					} else {
						// Fallback: manually add person if button not available yet
						window.addFirstPerson && window.addFirstPerson();
					}
				}, 200);
			}
		}
	}
	function closeModal(){ 
		document.getElementById('travelRequestModal').classList.remove('show'); 
		document.getElementById('travelRequestModal').setAttribute('aria-hidden','true'); 
		const form=document.getElementById('travelRequestForm'); 
		form.reset(); 
		form.dataset.editKey=''; 
		// Clear people section
		const peopleContainer = document.getElementById('peopleContainer');
		if(peopleContainer) peopleContainer.innerHTML = '';
		// Hide meta bar
		const metaBar=document.getElementById('requestMetaBar');
		if(metaBar) metaBar.style.display='none';
		recalcCosts(); 
	}
	// Upload attachments to Firebase Storage
	async function uploadPersonAttachments(companyId, requestId, personIndex, files) {
		if (!files || files.length === 0) return [];
		const storage = firebase.storage();
		const folderRef = storage.ref(`companies/${companyId}/travelRequests/${requestId}/person_${personIndex}`);
		const uploadedFiles = [];
		for (let i = 0; i < files.length; i++) {
			const file = files[i];
			const safeName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
			const fileRef = folderRef.child(safeName);
			await fileRef.put(file);
			const url = await fileRef.getDownloadURL();
			uploadedFiles.push({
				name: file.name,
				type: file.type,
				size: file.size,
				url: url,
				storagePath: fileRef.fullPath,
				uploadedAt: Date.now()
			});
		}
		return uploadedFiles;
	}
	// Collect people with their file inputs for upload
	function collectPeopleWithFiles() {
		const containers = Array.from(document.querySelectorAll('#peopleTableBody .person-container'));
		return containers.map(container => {
			const attachmentsRow = container.nextElementSibling;
			const attachmentInput = attachmentsRow?.querySelector('.person-attachments');
			const files = attachmentInput?.files || [];
			// Get existing attachments that were already uploaded
			let existingAttachments = [];
			try {
				existingAttachments = JSON.parse(attachmentsRow?.dataset?.existingAttachments || '[]');
			} catch(e) { existingAttachments = []; }
			return {
				name: container.querySelector('.person-name')?.value?.trim() || '',
				title: container.querySelector('.person-title')?.value?.trim() || '',
				contact: container.querySelector('.person-contact')?.value?.trim() || '',
				departureDate: container.querySelector('.person-departure')?.value || '',
				returnDate: container.querySelector('.person-return')?.value || '',
				stay: container.querySelector('.person-stay')?.value || '',
				perDiem: parseFloat(container.querySelector('.person-perdiem')?.value || '0'),
				justification: container.querySelector('.person-justification')?.value?.trim() || '',
				files: files, // Actual FileList for new uploads
				existingAttachments: existingAttachments // Already uploaded attachments
			};
		}).filter(p => p.name.length > 0);
	}
	async function handleSubmit(e){ e.preventDefault(); if(!validateTravelForm()) return; const form=e.target; const editKey=form.dataset.editKey || null; const submitBtn = document.getElementById('submitTravelBtn'); const originalText = submitBtn.innerHTML; submitBtn.disabled=true; submitBtn.innerHTML= editKey? '<i class="fas fa-spinner fa-spin"></i> Updating...' : '<i class="fas fa-spinner fa-spin"></i> Saving...'; try { const data=new FormData(form); const days = 1; // Default to 1 day since dates are now per person
const perDiemRate=0; // Removed field
const accommodationRate=0; // Removed field
const transportCost = 0; const otherCost=0; // Removed field
const perDiemTotal = perDiemRate * days; const accommodationTotal = accommodationRate * 0; // nights removed
const totalCost = perDiemTotal + accommodationTotal + transportCost + otherCost; const user = authManager.currentUser || {}; // collect people rows from the form with files for upload
const peopleWithFiles = collectPeopleWithFiles();
const companyId = authManager.currentUser?.companyId;
const requestId = editKey || ('TRV-' + Date.now());
// Upload attachments for each person
const people = [];
for (let i = 0; i < peopleWithFiles.length; i++) {
	const person = peopleWithFiles[i];
	// Start with existing attachments (already uploaded)
	let attachments = [...(person.existingAttachments || [])];
	// Upload new files and add to attachments
	if (person.files && person.files.length > 0) {
		const newAttachments = await uploadPersonAttachments(companyId, requestId, i, person.files);
		attachments = attachments.concat(newAttachments);
	}
	people.push({
		name: person.name,
		title: person.title,
		contact: person.contact,
		departureDate: person.departureDate,
		returnDate: person.returnDate,
		stay: person.stay,
		perDiem: person.perDiem,
		justification: person.justification,
		attachmentCount: attachments.length,
		attachments: attachments
	});
}

if(editKey){ const updated={ origin:data.get('origin'), destination:data.get('destination'), travelType:data.get('travelType'), days, perDiemRate, accommodationRate, perDiemTotal, accommodationTotal, transportCost, otherCost, totalCost, costCenter:data.get('costCenter')||'', passportExpiry:data.get('passportExpiry')||null, visaRequired:data.get('visaRequired')||null, people, updatedAt:Date.now() }; await updateExistingRequest(editKey, updated); } else { const createdAt=Date.now(); const request={ id:'TRV-'+createdAt, origin:data.get('origin'), destination:data.get('destination'), travelType:data.get('travelType'), days, perDiemRate, accommodationRate, perDiemTotal, accommodationTotal, transportCost, otherCost, totalCost, costCenter:data.get('costCenter')||'', passportExpiry:data.get('passportExpiry')||null, visaRequired:data.get('visaRequired')||null, people, status:'Pending Approval', currentApprovalStep: 1, approvalStatus: {}, createdAt, createdBy:{ uid:user.uid||null, email:user.email||null, name:user.displayName||user.name||'' } }; if(!travelListenerAttached){ travelRequests.unshift(request); renderTravelRequests(); } await saveTravelRequestToFirebase(request); } closeModal(); form.dataset.editKey=''; } catch(err){ console.error('Save travel request failed', err); alert('Failed to save travel request.'); } finally { submitBtn.disabled=false; submitBtn.innerHTML=originalText; } }
	async function saveTravelRequestToFirebase(request){ if(!authManager.currentUser || !authManager.currentUser.companyId){ console.warn('No company context for save'); return; } const db=getDatabase(); const companyId=authManager.currentUser.companyId; const path=`companies/${companyId}/travelRequests`; const collectionRef = ref(db, path); // Use push key for uniqueness
	    const newRef = collectionRef.push(); await newRef.set(request); }
		function recalcCosts(){ const days=1; // Default to 1 day since dates are now per person
			const perDiemRate=0; // Removed field
const accommodationRate=0; // Removed field
const otherCost=0; // Removed field
const transportCost = 0; const perDiemTotal=perDiemRate*days; const accommodationTotal=accommodationRate*0; // nights removed
const totalCost = perDiemTotal + accommodationTotal + transportCost + otherCost; document.getElementById('daysDisplay').textContent=days; document.getElementById('perDiemTotalDisplay').textContent=perDiemTotal.toFixed(2); document.getElementById('accommodationTotalDisplay').textContent=accommodationTotal.toFixed(2); document.getElementById('transportCostDisplay').textContent=transportCost.toFixed(2); document.getElementById('otherCostDisplay').textContent=otherCost.toFixed(2); document.getElementById('totalCostDisplay').textContent=totalCost.toFixed(2); }
	async function renderTravelRequests(){ const tbody=document.querySelector('#travelRequestsTable tbody'); tbody.innerHTML=''; if(travelRequests.length===0){ document.getElementById('emptyState').style.display='block'; return; } const searchTerm=document.getElementById('searchTerm').value.toLowerCase(); const typeFilter=document.getElementById('filterType').value; const statusFilter=document.getElementById('filterStatus').value; const fromDate=document.getElementById('fromDate').value; const toDate=document.getElementById('toDate').value; 
	
	// Get current user info once
	const currentUser = authManager.currentUser;
	if (!currentUser) { document.getElementById('emptyState').style.display='block'; return; }
	
	// Pre-load approval flow config once for visibility checks
	const approvalFlow = await getApprovalFlowConfigCached('travel_request');
	const userCanApproveAny = canUserApproveAnyLevel(approvalFlow, currentUser);
	
	// Check if user has "view all requests" permission
	const userCanViewAll = window._travelCanViewAll === true;
	
	// Filter requests synchronously using cached data
	const filteredRequests = [];
	for (const r of travelRequests) {
		const matchesSearch = !searchTerm || r.destination.toLowerCase().includes(searchTerm) || (r.id||'').toLowerCase().includes(searchTerm); 
		const matchesType = !typeFilter || r.travelType===typeFilter; 
		const matchesStatus = !statusFilter || r.status===statusFilter; 
		const depOk = true; 
		const retOk = true; 
		
		// Show if user is the submitter
		const isSubmitter = r.createdBy?.uid === currentUser.uid;
		
		// Show if user can approve any level (pre-calculated) OR has view all permission
		const visibilityOk = isSubmitter || userCanApproveAny || userCanViewAll;
		
		if (matchesSearch && matchesType && matchesStatus && depOk && retOk && visibilityOk) {
			filteredRequests.push(r);
		}
	} if(filteredRequests.length===0){ document.getElementById('emptyState').style.display='block'; } else { document.getElementById('emptyState').style.display='none'; } const showBatchCol = window._travelCanSeeBatchActions === true; filteredRequests.forEach(req=>{ const canEdit = authManager.currentUser && (req.createdBy?.uid === authManager.currentUser.uid); const statusClass=(req.status||'').toLowerCase().replace(/\s+/g,''); const currency=req.currency||''; const peopleSummary = Array.isArray(req.people) && req.people.length? req.people.map(p=>p.name).join(', '): ''; // Show people count instead of dates
const peopleInfo = Array.isArray(req.people) && req.people.length? `${req.people.length} person(s)` : 'No people'; const requesterName = req.createdBy?.name || req.createdBy?.email || 'Unknown'; const travelTypeCapitalized = req.travelType ? req.travelType.charAt(0).toUpperCase() + req.travelType.slice(1) : ''; const tr=document.createElement('tr'); tr.style.cursor='pointer'; tr.setAttribute('data-key', req.firebaseKey||req.id); tr.innerHTML=`<td style="text-align:center;${showBatchCol ? '' : 'display:none;'}" onclick="event.stopPropagation();"><input type="checkbox" class="batch-checkbox row-checkbox" data-key="${req.firebaseKey||req.id}" onchange="updateTravelSelection(this)"></td><td>${req.id}</td><td>${requesterName}</td><td>${travelTypeCapitalized}</td><td>${peopleInfo}</td><td>${currency} ${req.perDiemTotal.toFixed(2)}</td><td>${currency} ${req.accommodationTotal.toFixed(2)}</td><td>${currency} ${req.totalCost.toFixed(2)}</td><td><span class='status-chip ${statusClass}'>${req.status}</span></td>`; // attach people summary as title for hover
		if(peopleSummary) tr.querySelector('td').setAttribute('title', peopleSummary);
		// Add click handler to open view modal
		tr.addEventListener('click', async () => {
			const request = findRequestByKey(req.firebaseKey||req.id);
			if(request) await openViewModal(request);
		});
		tbody.appendChild(tr); }); 
		// Re-apply active column header filters for Requests tab
		updateRequestColumnFilterIcons();
		applyRequestColumnHeaderFilters(); }
	function findRequestByKey(key){ return travelRequests.find(r=> (r.firebaseKey===key) || (r.id===key)); }
	async function handleRowAction(e){ const btn=e.target.closest('button[data-action]'); if(!btn) return; const action=btn.getAttribute('data-action'); const key=btn.getAttribute('data-id'); const req=findRequestByKey(key); if(!req) return; if(action==='view'){ await openViewModal(req); } else if(action==='edit'){ if(req.createdBy?.uid !== authManager.currentUser?.uid){ alert('You can only edit your own requests.'); return; } openEditModal(req); } else if(action==='cancel'){ cancelRequest(req); } }
	// Helper function to get file icon based on file type
	function getFileIcon(fileName, fileType) {
		const extension = fileName.toLowerCase().split('.').pop();
		if (fileType && fileType.includes('pdf') || extension === 'pdf') {
			return 'fas fa-file-pdf';
		} else if (fileType && fileType.includes('image') || ['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
			return 'fas fa-file-image';
		} else if (['doc', 'docx'].includes(extension)) {
			return 'fas fa-file-word';
		} else if (['xls', 'xlsx'].includes(extension)) {
			return 'fas fa-file-excel';
		} else {
			return 'fas fa-file';
		}
	}

	async function openViewModal(req){
		// Store current request for approval actions
		window.currentViewRequest = req;
		
		const esc = (v) => {
			if (v === undefined || v === null || v === '') return '';
			return String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
		};
		const fmt = (v) => (v === undefined || v === null || v === '') ? '<span style="opacity:.5;">—</span>' : esc(v);
		const toCurrency = (v) => (Number(v) || 0).toFixed(2);
		const fmtDate = (d) => d ? new Date(d).toLocaleString() : '—';
		
		// Get company info for header
		const companyName = window.authManager?.currentCompany?.companyName || window.authManager?.currentUser?.companyName || 'Company';
		const companyLogo = window.authManager?.currentCompany?.logo || window.authManager?.currentCompany?.logoUrl || '';
		const logoInitials = companyName.split(' ').filter(w=>w).map(w=>w[0]).join('').substring(0,2).toUpperCase() || 'CO';
		
		// Generate SVG initials if no logo available
		const generateInitialsSVG = (initials) => {
			const svg = `<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="8" fill="#f8fafc"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="32">${initials}</text></svg>`;
			return 'data:image/svg+xml;base64,' + btoa(svg);
		};
		const logoSrc = companyLogo || generateInitialsSVG(logoInitials);
		
		// Status badge helper
		const statusBadge = (status) => {
			const s = (status || 'pending').toLowerCase().replace(/\s+/g, '');
			return `<span class="status-chip ${s}">${esc(status || 'Pending')}</span>`;
		};
		
		// Build travelers table rows
		let travelerRows = '';
		if (Array.isArray(req.people) && req.people.length) {
			req.people.forEach((p, i) => {
				// Build attachments display with clickable links
				let attachmentsHtml = '<span style="opacity:.5;">—</span>';
				if (Array.isArray(p.attachments) && p.attachments.length > 0) {
					attachmentsHtml = p.attachments.map(att => {
						const icon = getFileIcon(att.name, att.type);
						if (att.url) {
							return `<a href="${esc(att.url)}" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;background:#f1f5f9;padding:6px;border-radius:4px;margin:2px;text-decoration:none;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'" title="${esc(att.name)}"><i class="${icon}" style="color:#3b82f6;font-size:.85rem;"></i></a>`;
						} else {
							return `<span style="display:inline-flex;align-items:center;justify-content:center;background:#f1f5f9;padding:6px;border-radius:4px;margin:2px;" title="${esc(att.name)}"><i class="${icon}" style="color:#6b7280;font-size:.85rem;"></i></span>`;
						}
					}).join('');
				} else if (p.attachmentCount > 0) {
					attachmentsHtml = `<span style="color:#6b7280;font-size:.7rem;"><i class="fas fa-paperclip"></i> ${p.attachmentCount}</span>`;
				}
				// Display job title with hyphens removed and first word capitalized
				const formattedTitle = p.title ? formatJobTitle(p.title) : '';
				const nameWithTitle = formattedTitle 
					? `<div>${fmt(p.name)}</div><div style="font-size:.65rem;color:#6b7280;margin-top:2px;">${esc(formattedTitle)}</div>`
					: fmt(p.name);
				travelerRows += `
					<tr>
						<td>${i + 1}</td>
						<td>${nameWithTitle}</td>
						<td>${fmt(p.departureDate)}</td>
						<td>${fmt(p.returnDate)}</td>
						<td>${fmt(p.stay)}</td>
						<td>${toCurrency(p.perDiem || 0)}</td>
						<td>${attachmentsHtml}</td>
					</tr>
				`;
			});
		} else {
			travelerRows = '<tr><td colspan="7" style="text-align:center;opacity:.6;">No travelers</td></tr>';
		}
		
		// Build A4 sheet content
		const a4Content = `
<div class="a4-sheet printable">
	<div class="a4-header">
		<div class="company-block">
			<img src="${logoSrc}" class="a4-logo" alt="Company Logo" onerror="this.src='${generateInitialsSVG(logoInitials)}';" />
			<div class="a4-company">
				<h1>${esc(companyName)}</h1>
				<h2 class="doc-title">Travel Request</h2>
			</div>
		</div>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-plane-departure"></i><span class="section-text">Travel Information</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<tbody>
				<tr>
					<td style="width:50%;" colspan="2"><strong>Request ID:</strong> ${esc(req.id || '-')}</td>
					<td style="width:50%;" colspan="2"><strong>Status:</strong> ${statusBadge(req.status)}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Requested By:</strong> ${fmt(req.createdBy?.name || req.createdBy?.email)}</td>
					<td colspan="2"><strong>Created:</strong> ${esc(fmtDate(req.createdAt))}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Origin:</strong> ${fmt(req.origin)}</td>
					<td colspan="2"><strong>Destination:</strong> ${fmt(req.destination)}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Travel Type:</strong> ${fmt(req.travelType)}</td>
					<td colspan="2"><strong>Duration:</strong> ${fmt(req.days)} day(s)</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Cost Center:</strong> ${fmt(req.costCenter)}</td>
					<td colspan="2"><strong>Department:</strong> ${fmt(req.department)}</td>
				</tr>
				${req.travelType === 'international' ? `
				<tr>
					<td colspan="2"><strong>Passport Expiry:</strong> ${req.passportExpiry ? esc(new Date(req.passportExpiry).toLocaleDateString()) : '<span style="opacity:.5;">—</span>'}</td>
					<td colspan="2"><strong>Visa Required:</strong> ${fmt(req.visaRequired)}</td>
				</tr>
				` : ''}
			</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-coins"></i><span class="section-text">Cost Summary</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<tbody>
				<tr>
					<td style="width:50%;" colspan="2"><strong>Per Diem Total:</strong> ${toCurrency(req.perDiemTotal || 0)}</td>
					<td style="width:50%;" colspan="2"><strong>Accommodation Total:</strong> ${toCurrency(req.accommodationTotal || 0)}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Transport Cost:</strong> ${toCurrency(req.transportCost || 0)}</td>
					<td colspan="2"><strong>Other Costs:</strong> ${toCurrency(req.otherCost || 0)}</td>
				</tr>
				<tr style="background:#f8fafc;">
					<td colspan="4"><strong>Total Cost:</strong> <span style="font-size:.8rem;font-weight:700;color:#1e293b;">${toCurrency(req.totalCost || 0)}</span></td>
				</tr>
			</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-users"></i><span class="section-text">Travelers</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<thead><tr><th>#</th><th>Name</th><th>Departure</th><th>Return</th><th>Stay</th><th>Per Diem</th><th>Attachments</th></tr></thead>
			<tbody>${travelerRows}</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-clipboard"></i><span class="section-text">Purpose / Justification</span></div>
		<div style="background:#f9fafb;border:1px solid #d1d5db;padding:10px 12px;min-height:40px;font-size:.74rem;line-height:1.5;color:#374151;margin-top:8px;">${fmt(req.purpose || req.justification)}</div>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-stamp"></i><span class="section-text">Approval Flow</span></div>
		<div id="travelSectionApproval" style="margin-top:8px;"></div>
		<div id="travelRequestStampSection" style="display:none;text-align:left;margin-top:-10px;">
			<img id="travelRequestStampImg" src="" alt="Approval Stamp" style="max-width:150px;max-height:150px;opacity:.85;" />
		</div>
	</div>
</div>
`;
		
		// Render to modal body
		const modalBody = document.getElementById('travelModalBody');
		modalBody.innerHTML = a4Content;
		
		// Populate approval flow section
		await populateApprovalFlowA4(req);
		
		// Load and display stamp if request is Approved
		if (req.status === 'Approved') {
			loadAndDisplayRequestStamp();
		}
		
		// Update footer buttons based on permissions
		await updateModalFooterButtons(req);
		
		// Show the modal
		const modal = document.getElementById('travelDetailsModal');
		modal.classList.remove('hidden');
		modal.setAttribute('aria-hidden', 'false');
		
		// Attach close handlers
		document.getElementById('travelModalCloseBtn').onclick = closeTravelModal;
		document.getElementById('travelModalCloseFooter').onclick = closeTravelModal;
		document.getElementById('travelModalPrintBtn').onclick = () => {
			// Small delay to ensure content is fully rendered
			setTimeout(() => window.print(), 100);
		};
	}
	
	// Load and display stamp on approved travel request
	async function loadAndDisplayRequestStamp() {
		try {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;
			
			const snap = await firebase.database().ref(`companies/${user.companyId}/travelSettings/travelStamp`).once('value');
			const stampUrl = snap.val();
			
			const stampSection = document.getElementById('travelRequestStampSection');
			const stampImg = document.getElementById('travelRequestStampImg');
			
			if (stampUrl && stampSection && stampImg) {
				stampImg.src = stampUrl;
				stampSection.style.display = 'block';
			}
		} catch (error) {
			console.warn('Could not load travel stamp:', error);
		}
	}
	
	function closeTravelModal() {
		const modal = document.getElementById('travelDetailsModal');
		modal.classList.add('hidden');
		modal.setAttribute('aria-hidden', 'true');
		document.body.style.overflow = '';
	}
	
	// Update modal footer buttons based on user permissions
	async function updateModalFooterButtons(req) {
		const footer = document.getElementById('travelModalFooter');
		if (!footer) return;
		
		const currentUser = authManager?.currentUser;
		if (!currentUser) return;
		
		// Check if user is the owner of the request
		const isOwner = req.createdBy?.uid === currentUser.uid || req.createdBy?.email === currentUser.email;
		const canEdit = isOwner && (req.status === 'Draft' || req.status === 'Pending Approval');
		const canDelete = isOwner && (req.status === 'Draft' || req.status === 'Pending Approval');
		
		let buttons = `
			<button type="button" class="btn-small btn-outline" id="travelModalCloseFooter" title="Close"><i class="fas fa-times"></i></button>
		`;
		
		// Add Edit and Delete buttons for owner (only if Draft or Pending)
		if (canEdit) {
			buttons += `<button type="button" class="btn-small btn-warning" id="travelEditBtn" title="Edit"><i class="fas fa-edit"></i></button>`;
		}
		if (canDelete) {
			buttons += `<button type="button" class="btn-small btn-danger" id="travelDeleteBtn" title="Delete"><i class="fas fa-trash"></i></button>`;
		}
		
		buttons += `<button type="button" class="btn-small btn-primary" id="travelModalPrintBtn" title="Print"><i class="fas fa-print"></i></button>`;
		
		// Check if user can approve
		const canApprove = await canUserApproveRequest(req, currentUser);
		
		if (canApprove && req.status === 'Pending Approval') {
			buttons += `
				<button type="button" class="btn-small btn-danger" id="travelDeclineBtn" title="Decline"><i class="fas fa-times"></i></button>
				<button type="button" class="btn-small btn-success" id="travelApproveBtn" title="Approve"><i class="fas fa-check"></i></button>
			`;
		}
		
		footer.innerHTML = buttons;
		
		// Re-attach handlers
		document.getElementById('travelModalCloseFooter').onclick = closeTravelModal;
		document.getElementById('travelModalPrintBtn').onclick = () => {
			// Small delay to ensure content is fully rendered
			setTimeout(() => window.print(), 100);
		};
		
		// Edit button handler
		const editBtn = document.getElementById('travelEditBtn');
		if (editBtn) {
			editBtn.onclick = () => {
				closeTravelModal();
				openEditModal(req);
			};
		}
		
		// Delete button handler
		const deleteBtn = document.getElementById('travelDeleteBtn');
		if (deleteBtn) {
			deleteBtn.onclick = async () => {
				await cancelRequest(req);
				closeTravelModal();
			};
		}
		
		const declineBtn = document.getElementById('travelDeclineBtn');
		const approveBtn = document.getElementById('travelApproveBtn');
		if (declineBtn) declineBtn.onclick = () => declineRequest(req.firebaseKey);
		if (approveBtn) approveBtn.onclick = () => approveRequest(req.firebaseKey);
	}
	
	// Populate approval flow for A4 modal
	async function populateApprovalFlowA4(req) {
		const approvalContainer = document.getElementById('travelSectionApproval');
		if (!approvalContainer) return;
		approvalContainer.innerHTML = '<div style="text-align:center;color:#6b7280;padding:10px;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

		try {
			// Always fetch latest request data to ensure we have up-to-date approval fields (including signatures)
			let latestReq = req;
			try {
				const companyId = authManager?.currentUser?.companyId;
				const key = req?.firebaseKey || req?.id;
				if (companyId && key && window.firebase) {
					const snap = await get(ref(getDatabase(), `companies/${companyId}/travelRequests/${key}`));
					if (snap.exists()) latestReq = Object.assign({}, req, snap.val());
				}
			} catch(fetchErr){ /* continue with provided req if fetch fails */ }

			const approvalFlow = await getApprovalFlowConfigCached();
			if (!approvalFlow || !approvalFlow.selectedRoles || Object.keys(approvalFlow.selectedRoles).length === 0) {
				approvalContainer.innerHTML = '<div style="color:#6c757d; font-size:0.72rem;">No approval flow configured.</div>';
				return;
			}

			const approvalStatus = latestReq.approvalStatus || {};
			const approvalHistory = Array.isArray(latestReq.approvalHistory) ? latestReq.approvalHistory.slice() : [];
			approvalHistory.sort((a, b) => (a.submittedAt || 0) - (b.submittedAt || 0));

			// Fetch company users for name/signature resolution
			let companyUsers = {};
			// Build signature maps (same as leave modal)
			let signatureMap = {}; 
			let signatureMapById = {}; 
			// Also build job title maps (match investigation modal)
			let jobTitleById = {};
			let jobTitleByName = {};
			try {
				const companyId = authManager?.currentUser?.companyId;
				console.log('[Travel Modal Debug] Company ID:', companyId);
				if (companyId) {
					const usersSnap = await firebase.database().ref(`companies/${companyId}/users`).once('value');
					companyUsers = usersSnap.val() || {};
					console.log('[Travel Modal Debug] Company users count:', Object.keys(companyUsers).length);
					console.log('[Travel Modal Debug] Sample user data:', Object.entries(companyUsers).slice(0, 2).map(([k,v]) => ({uid: k, name: v?.name, jobTitle: v?.jobTitle, title: v?.title})));
					
					// Build signature lookup maps exactly like leave modal
					Object.entries(companyUsers).forEach(([uid, u]) => {
						if (!u) return;
						const nm = (u.displayName || u.name || u.fullName || u.email || '').trim();
						const sig = u.signatureUrl || null;
						if (nm && sig) signatureMap[nm.toLowerCase()] = sig;
						if (uid && sig) signatureMapById[uid] = sig;

						// Build job title maps - remove hyphens but keep original case
						const rawJob = (u.jobTitle || u.title || u.jobTitleName || u.position || u.designation || '').trim();
						const cleanJob = rawJob ? rawJob.replace(/-/g, ' ') : '';
						if (uid && cleanJob) {
							jobTitleById[uid] = cleanJob;
							console.log('[Travel Modal Debug] Job title by ID:', uid, '->', cleanJob);
						}
						if (nm && cleanJob) {
							jobTitleByName[nm.toLowerCase()] = cleanJob;
							console.log('[Travel Modal Debug] Job title by name:', nm.toLowerCase(), '->', cleanJob);
						}
					});
				}
				console.log('[Travel Modal Debug] Job title maps built:', { byId: Object.keys(jobTitleById).length, byName: Object.keys(jobTitleByName).length });
			} catch (e) { console.warn('[Travel Modal Debug] Error building maps:', e); }

			// Helper to format job title - remove hyphens and capitalize first word
			const formatJobTitle = (value) => {
				if (!value || value === '-') return '';
				const clean = value.trim().replace(/-/g, ' ');
				return clean.replace(/^[a-z]/, c => c.toUpperCase());
			};

			// Helper to get user job title (match gate pass logic - check multiple fields)
			const getUserJobTitle = (u) => {
				if (!u) return '';
				const rawTitle = (u.jobTitle || u.title || u.jobTitleName || u.position || u.designation || '').trim();
				console.log('[Travel Modal Debug] getUserJobTitle input:', { jobTitle: u.jobTitle, title: u.title, jobTitleName: u.jobTitleName, position: u.position, rawTitle });
				return formatJobTitle(rawTitle);
			};

			// Helper to find user by email
			const findUserByEmail = (email) => {
				if (!email) return null;
				const target = String(email).toLowerCase();
				for (const uid in companyUsers) {
					const u = companyUsers[uid];
					if (u && String(u.email || '').toLowerCase() === target) return { uid, ...u };
				}
				return null;
			};

			// Helper to find user by name
			const findUserByName = (name) => {
				if (!name) return null;
				const target = String(name).trim().toLowerCase();
				for (const uid in companyUsers) {
					const u = companyUsers[uid];
					const n = (u?.name || u?.displayName || u?.fullName || '').trim().toLowerCase();
					if (n && n === target) return { uid, ...u };
				}
				return null;
			};

			// Helper to escape HTML
			const escapeHtml = (str) => {
				if (!str) return '';
				return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
			};

			// Helper to format date
			const fmtDate = (d) => {
				if (!d) return '-';
				try { return new Date(d).toLocaleString(); } catch { return '-'; }
			};

			// Helper to resolve approver from history (match accessboard logic)
			const resolveApproverFromHistory = (h) => {
				let user = null;
				if (h && (h.approverId || h.approvedBy || h.userId || h.approverUid)) {
					user = companyUsers[h.approverId || h.approvedBy || h.userId || h.approverUid] || null;
				}
				if (!user && h && h.approverEmail) {
					user = findUserByEmail(h.approverEmail);
				}
				const name = (user?.name || user?.displayName || h?.approverName || h?.userName || '').trim() || 'Approver';
				let title = getUserJobTitle(user);
				
				// If no title from user object, try maps
				if (!title && user && jobTitleById[user.uid]) title = jobTitleById[user.uid];
				if (!title && name && jobTitleByName[name.toLowerCase()]) title = jobTitleByName[name.toLowerCase()];
				
				// IMPORTANT: Don't use title if it's the same as the name
				if (title && title.toLowerCase() === name.toLowerCase()) {
					title = '';
				}
				return { user, name, title, display: title ? `${name} — ${title}` : name };
			};

			const levelKeys = Object.keys(approvalFlow.selectedRoles).sort((a, b) => {
				const levelA = parseInt(a.replace('level', ''));
				const levelB = parseInt(b.replace('level', ''));
				return levelA - levelB;
			});

			// Build table rows
			const approvalRows = [];
			for (let i = 0; i < levelKeys.length; i++) {
				const levelKey = levelKeys[i];
				const levelNumber = i + 1;
				const levelConfig = approvalFlow.selectedRoles[levelKey];

				// Find approval record for this level
				const approvalRecord = approvalHistory.find(h => 
					h.level === levelKey || h.level === levelNumber || h.approvalLevel === levelNumber
				) || approvalStatus[levelKey];

				let approverName = 'Unknown Approver';
				let approverTitle = '';
				// Capture config-based approver details for reliable fallback
				let configApproverUid = '';
				let configApproverEmail = '';
				let configApproverName = '';
				let configApproverTitle = '';
				let statusText = 'Pending';
				let statusClass = 'pending';
				let timestamp = '-';
				let signature = '-';

				// Get approver info from config
				if (Array.isArray(levelConfig) && levelConfig.length > 0) {
					const approverConfig = levelConfig[0];
					const approverId = approverConfig.value || approverConfig.uid;
					configApproverName = approverConfig.text || approverConfig.value || '';
					configApproverEmail = approverConfig.email || '';
					configApproverUid = approverId || '';

					// Check if level-based approver (L+1, L+2, etc.)
					if (approverId && approverId.startsWith && approverId.startsWith('L+')) {
						approverName = approverConfig.text || `Line Manager (${approverId})`;
						approverTitle = 'Line Manager';
						// Try to get actual line manager info
						const submitterUid = req.submittedBy || req.createdBy || req.userId;
						if (submitterUid && companyUsers[submitterUid]) {
							const submitter = companyUsers[submitterUid];
							if (submitter.lineManagerId && companyUsers[submitter.lineManagerId]) {
								const manager = companyUsers[submitter.lineManagerId];
								approverName = manager.name || manager.displayName || approverName;
								approverTitle = getUserJobTitle(manager) || 'Line Manager';
								configApproverTitle = approverTitle;
							}
						}
					} else if (approverId && companyUsers[approverId]) {
						const approverData = companyUsers[approverId];
						console.log('[Travel Modal Debug] Approver data found:', { approverId, name: approverData.name, jobTitle: approverData.jobTitle, title: approverData.title });
						approverName = approverData.name || approverData.displayName || approverConfig.text || 'Unknown';
						const titleFromUser = getUserJobTitle(approverData);
						console.log('[Travel Modal Debug] Title from getUserJobTitle:', titleFromUser);
						// Always set approverTitle if we have a valid title, regardless of name comparison
						if (titleFromUser) {
							approverTitle = titleFromUser;
							configApproverTitle = titleFromUser;
						}
					} else {
						approverName = approverConfig.text || approverConfig.value || 'Unknown';
						// Try to resolve by email/name
						let resolved = approverConfig.email ? findUserByEmail(approverConfig.email) : null;
						if (!resolved && approverName) resolved = findUserByName(approverName);
						console.log('[Travel Modal Debug] Resolved user by email/name:', resolved ? { name: resolved.name, jobTitle: resolved.jobTitle } : 'not found');
						if (resolved) {
							const resolvedTitle = getUserJobTitle(resolved);
							// Always set approverTitle if we have a valid title
							if (resolvedTitle) {
								approverTitle = resolvedTitle;
								configApproverTitle = resolvedTitle;
							}
						}
						// If still no title, try the job title maps
						if (!approverTitle && approverId && jobTitleById[approverId]) {
							approverTitle = jobTitleById[approverId];
						}
						if (!approverTitle && approverName && jobTitleByName[approverName.toLowerCase()]) {
							approverTitle = jobTitleByName[approverName.toLowerCase()];
						}
					}
				}

				// Process approval record
				if (approvalRecord) {
					const status = (approvalRecord.status || '').toLowerCase();
					if (status === 'approved') {
						statusText = 'Approved';
						statusClass = 'approved';
						
						// Use robust resolver
						const r = resolveApproverFromHistory(approvalRecord);
						approverName = r.name || approverName;
						// Always try to get title from resolver or fallback
						if (r.title) approverTitle = r.title;
						
						// If still no title, try job title maps
						const approverUidForTitle = approvalRecord.userId || approvalRecord.approvedBy || approvalRecord.approverUid || approvalRecord.approverId || '';
						if (!approverTitle && approverUidForTitle && jobTitleById[approverUidForTitle]) {
							approverTitle = jobTitleById[approverUidForTitle];
						}
						if (!approverTitle && approverName && jobTitleByName[approverName.toLowerCase()]) {
							approverTitle = jobTitleByName[approverName.toLowerCase()];
						}
						
						timestamp = fmtDate(approvalRecord.approvedAt || approvalRecord.submittedAt || approvalRecord.timestamp);
						
						// Get signature - ALWAYS use real-time Firebase signature first, fallback to stored
						const approverUidValue = approvalRecord.userId || approvalRecord.approvedBy || approvalRecord.approverUid || approvalRecord.approverId || '';
						let signatureUrl = '';
						
						// Priority: 1) Real-time signature by UID, 2) Real-time signature by name, 3) Stored signature
						if (approverUidValue && signatureMapById[approverUidValue]) {
							signatureUrl = signatureMapById[approverUidValue];
						} else if (approverName && signatureMap[approverName.toLowerCase()]) {
							signatureUrl = signatureMap[approverName.toLowerCase()];
						} else {
							signatureUrl = approvalRecord.signature || '';
						}
						
						// Only show signature image if URL is valid and not empty (exact same check as leave modal)
						signature = (signatureUrl && signatureUrl.trim() && !signatureUrl.includes('undefined'))
							? `<img src="${signatureUrl}" class="sig-img" alt="${escapeHtml(approverName)} signature" onerror="this.style.display='none';"/>`
							: '<span style="color:#10b981;"><i class="fas fa-check-circle"></i></span>';
					} else if (status === 'rejected' || status === 'declined') {
						statusText = 'Rejected';
						statusClass = 'rejected';
						
						// Use robust resolver
						const r = resolveApproverFromHistory(approvalRecord);
						approverName = r.name || approverName;
						// Always try to get title from resolver or fallback
						if (r.title) approverTitle = r.title;
						
						// If still no title, try job title maps
						const approverUidForTitle = approvalRecord.userId || approvalRecord.approvedBy || approvalRecord.approverUid || approvalRecord.approverId || '';
						if (!approverTitle && approverUidForTitle && jobTitleById[approverUidForTitle]) {
							approverTitle = jobTitleById[approverUidForTitle];
						}
						if (!approverTitle && approverName && jobTitleByName[approverName.toLowerCase()]) {
							approverTitle = jobTitleByName[approverName.toLowerCase()];
						}
						
						timestamp = fmtDate(approvalRecord.rejectedAt || approvalRecord.declinedAt || approvalRecord.submittedAt || approvalRecord.timestamp);
						
						signature = '<span style="color:#ef4444;"><i class="fas fa-times-circle"></i></span>';
					}
				}

				// Final fallback: try job title maps one more time
				if (!approverTitle && configApproverUid && jobTitleById[configApproverUid]) {
					approverTitle = jobTitleById[configApproverUid];
				}
				if (!approverTitle && approverName && jobTitleByName[approverName.toLowerCase()]) {
					approverTitle = jobTitleByName[approverName.toLowerCase()];
				}
				
				// Use config title as final fallback
				if (!approverTitle && configApproverTitle) {
					approverTitle = configApproverTitle;
				}

				console.log('[Travel Modal Debug] Final row data:', {
					levelNumber,
					approverName,
					approverTitle,
					statusText,
					timestamp,
					approvalRecord: approvalRecord ? Object.keys(approvalRecord) : 'none'
				});

				approvalRows.push(`
					<tr>
						<td style="text-align:left;">
							<div>${escapeHtml(approverName)}</div>
							${approverTitle ? `<div style="font-size:.6rem;color:#6b7280;margin-top:2px;">${escapeHtml(approverTitle)}</div>` : ''}
						</td>
						<td><span class="status-chip ${statusClass}">${statusText}</span></td>
						<td>${timestamp}</td>
						<td style="text-align:center;">${signature}</td>
					</tr>
				`);
			}

			if (approvalRows.length === 0) {
				approvalRows.push('<tr><td colspan="4" style="text-align:center;color:#6b7280;">No approval flow configured</td></tr>');
			}

			approvalContainer.innerHTML = `
				<table class="a4-info-table" style="width:100%;">
					<thead>
						<tr>
							<th style="text-align:left;width:40%;">Approver(s)</th>
							<th style="width:20%;text-align:center;">Status</th>
							<th style="width:25%;text-align:center;">Timestamp</th>
							<th style="width:15%;text-align:center;">Signature</th>
						</tr>
					</thead>
					<tbody>
						${approvalRows.join('')}
					</tbody>
				</table>
			`;
		} catch (error) {
			approvalContainer.innerHTML = '<div style="color:#6c757d; font-size:0.72rem;">Error loading approval flow</div>';
		}
	}
	
	// Update approval action buttons for A4 modal
	async function updateApprovalActionsA4(req) {
		const actionsSection = document.getElementById('travelApprovalActionsSection');
		const approveBtn = document.getElementById('travelApproveBtn');
		const declineBtn = document.getElementById('travelDeclineBtn');
		
		if (!actionsSection || !approveBtn || !declineBtn) return;

		const currentUser = authManager.currentUser;
		if (!currentUser) {
			actionsSection.style.display = 'none';
			return;
		}

		const canApprove = await canUserApproveRequest(req, currentUser);
		
		if (canApprove && req.status === 'Pending Approval') {
			actionsSection.style.display = 'block';
			approveBtn.style.display = 'inline-flex';
			declineBtn.style.display = 'inline-flex';
			
			approveBtn.onclick = () => approveRequest(req.firebaseKey);
			declineBtn.onclick = () => declineRequest(req.firebaseKey);
		} else {
			actionsSection.style.display = 'none';
			approveBtn.style.display = 'none';
			declineBtn.style.display = 'none';
		}
	}

	// Populate approval flow section (keeping for backward compatibility)
	async function populateApprovalFlow(req) {
		const approvalStepsContainer = document.getElementById('approvalSteps');
		if (!approvalStepsContainer) return;
		// Redirect to A4 version
		await populateApprovalFlowA4(req);
	}

	// Update modal footer with approval actions (keeping for backward compatibility)
	async function updateViewModalFooter(req) {
		await updateApprovalActionsA4(req);
	}

	// Check if user can approve the request (for specific step)
	async function canUserApproveRequest(req, user) {
		if (!user || !user.companyId) return false;
		
		try {
			const approvalFlow = await getApprovalFlowConfigCached('travel_request');
			if (!approvalFlow || !approvalFlow.selectedRoles || Object.keys(approvalFlow.selectedRoles).length === 0) {
				return user.role === 'admin' || user.role === 'manager';
			}

			const currentStep = req.currentApprovalStep || 1;
			const currentLevelKey = `level${currentStep}`;
			const currentLevelApprovers = approvalFlow.selectedRoles[currentLevelKey];
			if (!currentLevelApprovers || !Array.isArray(currentLevelApprovers)) return false;

			for (const approver of currentLevelApprovers) {
				if (approver.value === `user_${user.uid}`) return true;
				if (approver.value.startsWith('function_')) {
					const requiredTitle = approver.value.replace('function_', '').toLowerCase();
					const userTitle = (user.jobTitle || user.title || '').toLowerCase();
					if (userTitle === requiredTitle) return true;
				}
				if (approver.value.startsWith('L+') && (user.role === 'admin' || user.role === 'manager')) return true;
			}
			return false;
		} catch (error) {
			return user.role === 'admin' || user.role === 'manager';
		}
	}

	// Get approval flow configuration (with caching for performance)
	async function getApprovalFlowConfigCached(processType) {
		const now = Date.now();
		// Use cache if valid (5 minute expiry)
		if (cachedApprovalFlow && (now - approvalFlowCacheTime) < 300000) {
			return cachedApprovalFlow;
		}
		try {
			if (!authManager.currentUser?.companyId) return null;
			const db = getDatabase();
			const flowRef = ref(db, `companies/${authManager.currentUser.companyId}/approvalFlows/${processType}`);
			const snapshot = await get(flowRef);
			cachedApprovalFlow = snapshot.exists() ? snapshot.val() : null;
			approvalFlowCacheTime = now;
			return cachedApprovalFlow;
		} catch (error) {
			console.error('Error getting approval flow config:', error);
			return null;
		}
	}
	
	// Get approval flow configuration (original for backward compatibility)
	async function getApprovalFlowConfig(processType) {
		return await getApprovalFlowConfigCached(processType);
	}
	
	// Check if user can approve any level (sync check for filtering)
	function canUserApproveAnyLevel(approvalFlow, user) {
		if (!user || !approvalFlow?.selectedRoles) {
			return user?.role === 'admin' || user?.role === 'manager';
		}
		const levelKeys = Object.keys(approvalFlow.selectedRoles);
		for (const levelKey of levelKeys) {
			const approvers = approvalFlow.selectedRoles[levelKey];
			if (!approvers || !Array.isArray(approvers)) continue;
			for (const approver of approvers) {
				if (approver.value === `user_${user.uid}`) return true;
				if (approver.value.startsWith('function_')) {
					const requiredTitle = approver.value.replace('function_', '').toLowerCase();
					const userTitle = (user.jobTitle || user.title || '').toLowerCase();
					if (userTitle === requiredTitle) return true;
				}
				if (approver.value.startsWith('L+') && (user.role === 'admin' || user.role === 'manager')) return true;
			}
		}
		return false;
	}

	// Get user full name from database
	async function getUserFullName(userId, fallbackEmail = '') {
		try {
			if (!authManager.currentUser?.companyId || !userId) {
				return fallbackEmail?.split('@')[0] || 'Unknown User';
			}

			const db = getDatabase();
			const userRef = ref(db, `companies/${authManager.currentUser.companyId}/users/${userId}`);
			const snapshot = await get(userRef);
			
			if (snapshot.exists()) {
				const userData = snapshot.val();
				const fullName = userData.displayName || 
								userData.name || 
								(userData.firstName && userData.lastName ? `${userData.firstName} ${userData.lastName}` : '') ||
								userData.email?.split('@')[0] ||
								fallbackEmail?.split('@')[0] ||
								'Unknown User';
				
				console.log(`👤 Retrieved user name for ${userId}: ${fullName}`);
				return fullName;
			}
			
			// Fallback to email username or unknown
			return fallbackEmail?.split('@')[0] || 'Unknown User';
		} catch (error) {
			console.error('Error getting user full name:', error);
			return fallbackEmail?.split('@')[0] || 'Unknown User';
		}
	}

	// Approve request function
	window.approveRequest = async function(requestKey) {
		if (!confirm('Are you sure you want to approve this travel request?')) return;
		
		try {
			const currentUser = authManager.currentUser;
			if (!currentUser?.companyId) return;

			const db = getDatabase();
			const requestRef = ref(db, `companies/${currentUser.companyId}/travelRequests/${requestKey}`);
			
			// Get current request
			const snapshot = await get(requestRef);
			if (!snapshot.exists()) {
				alert('Request not found');
				return;
			}

			const request = snapshot.val();
			const currentStep = request.currentApprovalStep || 1;
			const currentLevelKey = `level${currentStep}`;
			
			// Get better approver name - try multiple sources
			const approverName = currentUser.displayName || 
							   currentUser.name || 
							   (currentUser.firstName && currentUser.lastName ? `${currentUser.firstName} ${currentUser.lastName}` : '') ||
							   currentUser.email?.split('@')[0] || 
							   'Unknown Approver';
			
			// Get current user's signature URL from companyUsers
			// Users are stored by userId key, but have authUid field matching Firebase auth UID
			let signatureUrl = '';
			let userDbKey = null;
			try {
				const usersRef = ref(db, `companies/${currentUser.companyId}/users`);
				const usersSnap = await get(usersRef);
				if (usersSnap.exists()) {
					const users = usersSnap.val();
					// Find user by authUid or by key matching uid
					for (const [key, userData] of Object.entries(users)) {
						if (userData.authUid === currentUser.uid || key === currentUser.uid) {
							signatureUrl = userData.signatureUrl || userData.signature || '';
							userDbKey = key;
							console.log(`🔍 Found user in DB: key=${key}, hasSignature=${!!signatureUrl}`);
							break;
						}
					}
				}
			} catch (sigError) {
				console.warn('Could not fetch user signature:', sigError);
			}
			
			// Update approval status for current level
			const updates = {
				[`approvalStatus/${currentLevelKey}/status`]: 'approved',
				[`approvalStatus/${currentLevelKey}/approverName`]: approverName,
				[`approvalStatus/${currentLevelKey}/approverEmail`]: currentUser.email,
				[`approvalStatus/${currentLevelKey}/approverUid`]: currentUser.uid,
				[`approvalStatus/${currentLevelKey}/approvedBy`]: userDbKey || currentUser.uid,
				[`approvalStatus/${currentLevelKey}/userId`]: userDbKey || currentUser.uid,
				[`approvalStatus/${currentLevelKey}/approvedAt`]: Date.now(),
				[`approvalStatus/${currentLevelKey}/signature`]: signatureUrl,
				updatedAt: Date.now()
			};

			// Check if this is the final approval step
			const approvalFlow = await getApprovalFlowConfig('travel_request');
			const totalSteps = approvalFlow?.selectedRoles ? Object.keys(approvalFlow.selectedRoles).length : 1;
			
			console.log(`🔍 Approval: Current step ${currentStep}, Total steps ${totalSteps}`);
			console.log(`👤 Approver name: ${approverName}`);
			console.log(`🖊️ Signature URL: ${signatureUrl ? 'Found' : 'Not found'}`);
			
			if (currentStep >= totalSteps) {
				// Final approval - mark as approved
				updates.status = 'Approved';
				updates.finalApprovedAt = Date.now();
				updates.finalApprovedBy = approverName;
				console.log('✅ Final approval - marking request as Approved');
			} else {
				// Move to next approval step
				updates.currentApprovalStep = currentStep + 1;
				console.log(`📋 Moving to next step: ${currentStep + 1}`);
			}

			await requestRef.update(updates);
			
			// Immediately hide Edit and Delete buttons if final approval
			if (currentStep >= totalSteps) {
				const editBtn = document.getElementById('travelEditBtn');
				const deleteBtn = document.getElementById('travelDeleteBtn');
				const approveBtn = document.getElementById('travelApproveBtn');
				const declineBtn = document.getElementById('travelDeclineBtn');
				if (editBtn) editBtn.style.display = 'none';
				if (deleteBtn) deleteBtn.style.display = 'none';
				if (approveBtn) approveBtn.style.display = 'none';
				if (declineBtn) declineBtn.style.display = 'none';
			}
			
			// Refresh approval section in the currently open modal (keep it open)
			try {
				await populateApprovalFlowA4({ firebaseKey: requestKey });
			} catch(e) { /* ignore */ }
			// Optionally refresh list if available
			if (typeof renderTravelRequests === 'function') { try { renderTravelRequests(); } catch {} }
			
		} catch (error) {
			console.error('Error approving request:', error);
			alert('Failed to approve request');
		}
	};

	// Decline request function
	window.declineRequest = async function(requestKey) {
		const reason = prompt('Please provide a reason for declining this request:');
		if (!reason) return;
		
		try {
			const currentUser = authManager.currentUser;
			if (!currentUser?.companyId) return;

			const db = getDatabase();
			const requestRef = ref(db, `companies/${currentUser.companyId}/travelRequests/${requestKey}`);
			
			// Get current request to determine current step
			const snapshot = await get(requestRef);
			if (!snapshot.exists()) {
				alert('Request not found');
				return;
			}

			const request = snapshot.val();
			const currentStep = request.currentApprovalStep || 1;
			const currentLevelKey = `level${currentStep}`;
			
			// Get better approver name - try multiple sources
			const approverName = currentUser.displayName || 
							   currentUser.name || 
							   (currentUser.firstName && currentUser.lastName ? `${currentUser.firstName} ${currentUser.lastName}` : '') ||
							   currentUser.email?.split('@')[0] || 
							   'Unknown Approver';
			
			const updates = {
				status: 'Declined',
				[`approvalStatus/${currentLevelKey}/status`]: 'declined',
				[`approvalStatus/${currentLevelKey}/approverName`]: approverName,
				[`approvalStatus/${currentLevelKey}/approverEmail`]: currentUser.email,
				[`approvalStatus/${currentLevelKey}/approverUid`]: currentUser.uid,
				[`approvalStatus/${currentLevelKey}/declinedAt`]: Date.now(),
				[`approvalStatus/${currentLevelKey}/declineReason`]: reason,
				finalDeclinedAt: Date.now(),
				finalDeclinedBy: approverName,
				updatedAt: Date.now()
			};

			console.log(`❌ Declining request at step ${currentStep} (${currentLevelKey})`);
			console.log(`👤 Decliner name: ${approverName}`);

			await requestRef.update(updates);
			
			// Close modal and refresh
			document.getElementById('travelRequestViewModal').classList.remove('show');
			if (typeof renderTravelRequests === 'function') {
				renderTravelRequests();
			}
			
		} catch (error) {
			console.error('Error declining request:', error);
			alert('Failed to decline request');
		}
	};

	// Close handlers for view modal (A4 style)
	document.addEventListener('DOMContentLoaded',()=>{
		const modal = document.getElementById('travelDetailsModal');
		
		// Click outside to close
		modal?.addEventListener('click', (e)=>{ 
			if(e.target === modal){ 
				closeTravelModal(); 
			} 
		});
		
		// Listen for signature updates from profile.html (cross-tab communication)
		window.addEventListener('storage', async (e) => {
			if (e.key === 'signatureUpdated' && e.newValue) {
				try {
					const data = JSON.parse(e.newValue);
					console.log('[Travel] Signature updated in another tab:', data);
					// If the travel modal is open, refresh the approval flow section
					const modal = document.getElementById('travelDetailsModal');
					if (modal && !modal.classList.contains('hidden') && window.currentViewRequest) {
						console.log('[Travel] Refreshing approval flow for request:', window.currentViewRequest.firebaseKey);
						await populateApprovalFlowA4(window.currentViewRequest);
					}
				} catch(err) { console.warn('[Travel] Failed to process signature update:', err); }
			}
		});
	});
	function openEditModal(req){ populateForm(req,false); // ensure meta bar visible
		const form=document.getElementById('travelRequestForm');
		form.dataset.editKey = req.firebaseKey || '';
		document.getElementById('submitTravelBtn').style.display='';
		// Set title for edit mode
		const titleEl = document.getElementById('travelModalTitle');
		if(titleEl) titleEl.innerHTML = '<i class="fas fa-edit"></i> Edit Travel Request';
		const metaBar=document.getElementById('requestMetaBar');
		if(metaBar){
			metaBar.style.display='block';
			document.getElementById('metaReqId').textContent = req.id || req.firebaseKey || '—';
			document.getElementById('metaReqStatus').textContent = req.status || '—';
			const createdAt = req.createdAt? new Date(req.createdAt).toLocaleString(): '—';
			document.getElementById('metaReqCreatedAt').textContent = createdAt;
			document.getElementById('metaReqCreatedBy').textContent = (req.createdBy?.name)|| (req.createdBy?.email) || '—';
		}
		openModal();
	}
	function populateForm(req, readOnly){ const form=document.getElementById('travelRequestForm'); form.reset(); form.dataset.editKey='';
		// Hide meta unless explicitly enabled in edit path
		const metaBar=document.getElementById('requestMetaBar'); if(metaBar) metaBar.style.display='none';
		const map={ origin:'origin', destination:'destination', travelType:'travelType', costCenter:'costCenter', passportExpiry:'passportExpiry', visaRequired:'visaRequired' };
		Object.entries(map).forEach(([k,id])=>{ if(req && req[k]!==undefined && document.getElementById(id)){ document.getElementById(id).value=req[k]; } });
		// people - use global function with fallback
		if(window.populatePeopleSection) {
			window.populatePeopleSection(req?.people || []);
		} else if(document.populatePeopleSection) {
			document.populatePeopleSection(req?.people || []);
		}
		toggleInternational(req?.travelType); recalcCosts();
		Array.from(form.elements).forEach(el=>{ el.disabled=readOnly; });
	}
	async function cancelRequest(req){ if(!confirm('Cancel this travel request?')) return; if(!authManager.currentUser?.companyId) return; const db=getDatabase(); const path=`companies/${authManager.currentUser.companyId}/travelRequests/${req.firebaseKey}`; try { await ref(db,path).update({ status:'Cancelled', updatedAt: Date.now() }); } catch(err){ console.error('Cancel failed', err); alert('Failed to cancel request.'); } }
	async function updateExistingRequest(editKey, updated){ if(!authManager.currentUser?.companyId || !editKey) return; const db=getDatabase(); const path=`companies/${authManager.currentUser.companyId}/travelRequests/${editKey}`; try { await ref(db,path).update(updated); } catch(err){ console.error('Update failed', err); alert('Failed to update request.'); } }
	
	// Batch selection functions for travel requests
	let travelSelectedIds = new Set();
	
	function updateTravelSelection(checkbox) {
		const key = checkbox.dataset.key;
		const row = checkbox.closest('tr');
		if (checkbox.checked) {
			travelSelectedIds.add(key);
			row?.classList.add('selected');
		} else {
			travelSelectedIds.delete(key);
			row?.classList.remove('selected');
		}
		updateTravelBatchUI();
	}
	
	function toggleTravelSelectAll(checkbox) {
		const rowCheckboxes = document.querySelectorAll('#travelRequestsTable tbody .row-checkbox');
		rowCheckboxes.forEach(cb => {
			cb.checked = checkbox.checked;
			const key = cb.dataset.key;
			const row = cb.closest('tr');
			if (checkbox.checked) {
				travelSelectedIds.add(key);
				row?.classList.add('selected');
			} else {
				travelSelectedIds.delete(key);
				row?.classList.remove('selected');
			}
		});
		updateTravelBatchUI();
	}
	
	function clearTravelSelection() {
		travelSelectedIds.clear();
		const selectAllCb = document.getElementById('travelSelectAllCheckbox');
		if (selectAllCb) selectAllCb.checked = false;
		document.querySelectorAll('#travelRequestsTable tbody .row-checkbox').forEach(cb => {
			cb.checked = false;
			cb.closest('tr')?.classList.remove('selected');
		});
		updateTravelBatchUI();
	}
	
	function updateTravelBatchUI() {
		const count = travelSelectedIds.size;
		const countSpan = document.getElementById('travelSelectedCount');
		const batchBar = document.getElementById('travelBatchActionBar');
		if (countSpan) countSpan.textContent = count;
		if (batchBar) batchBar.classList.toggle('visible', count > 0);
		// Update select all checkbox state
		const rowCheckboxes = document.querySelectorAll('#travelRequestsTable tbody .row-checkbox');
		const allChecked = rowCheckboxes.length > 0 && Array.from(rowCheckboxes).every(cb => cb.checked);
		const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
		const selectAllCb = document.getElementById('travelSelectAllCheckbox');
		if (selectAllCb) {
			selectAllCb.checked = allChecked;
			selectAllCb.indeterminate = someChecked && !allChecked;
		}
	}
	
	async function batchDeleteTravelRequests() {
		const count = travelSelectedIds.size;
		if (count === 0) return;
		
		if (!confirm(`Are you sure you want to delete ${count} travel request(s)? This action cannot be undone.`)) {
			return;
		}
		
		const user = authManager?.currentUser;
		if (!user || !user.companyId) {
			alert('Not authenticated');
			return;
		}
		
		try {
			const db = getDatabase();
			const deletePromises = Array.from(travelSelectedIds).map(key => 
				db.ref(`companies/${user.companyId}/travelRequests/${key}`).remove()
			);
			
			await Promise.all(deletePromises);
			
			alert(`Successfully deleted ${count} request(s)`);
			clearTravelSelection();
		} catch (error) {
			console.error('Batch delete error:', error);
			alert('Failed to delete some requests');
		}
	}
	
	async function batchDeleteTravelOrders() {
		const count = orderSelectedIds.size;
		if (count === 0) return;
		
		if (!confirm(`Are you sure you want to delete ${count} travel order(s)? This action cannot be undone.`)) {
			return;
		}
		
		const user = authManager?.currentUser;
		if (!user || !user.companyId) {
			alert('Not authenticated');
			return;
		}
		
		try {
			const db = getDatabase();
			const deletePromises = Array.from(orderSelectedIds).map(key => 
				db.ref(`companies/${user.companyId}/travelOrders/${key}`).remove()
			);
			
			await Promise.all(deletePromises);
			
			alert(`Successfully deleted ${count} order(s)`);
			clearOrderSelection();
		} catch (error) {
			console.error('Batch delete error:', error);
			alert('Failed to delete some orders');
		}
	}
	
	// Travel Order batch selection functions
	let orderSelectedIds = new Set();
	
	function toggleOrderSelectAll(checkbox) {
		const rowCheckboxes = document.querySelectorAll('#travelOrderTable tbody .order-row-checkbox');
		rowCheckboxes.forEach(cb => {
			cb.checked = checkbox.checked;
			const key = cb.dataset.key;
			const row = cb.closest('tr');
			if (checkbox.checked) {
				orderSelectedIds.add(key);
				row?.classList.add('selected');
			} else {
				orderSelectedIds.delete(key);
				row?.classList.remove('selected');
			}
		});
		updateOrderBatchUI();
	}
	
	function updateOrderSelection(checkbox) {
		const key = checkbox.dataset.key;
		const row = checkbox.closest('tr');
		if (checkbox.checked) {
			orderSelectedIds.add(key);
			row?.classList.add('selected');
		} else {
			orderSelectedIds.delete(key);
			row?.classList.remove('selected');
		}
		updateOrderBatchUI();
	}
	
	function clearOrderSelection() {
		orderSelectedIds.clear();
		const selectAllCb = document.getElementById('orderSelectAllCheckbox');
		if (selectAllCb) selectAllCb.checked = false;
		document.querySelectorAll('#travelOrderTable tbody .order-row-checkbox').forEach(cb => {
			cb.checked = false;
			cb.closest('tr')?.classList.remove('selected');
		});
		updateOrderBatchUI();
	}
	
	function updateOrderBatchUI() {
		const count = orderSelectedIds.size;
		const countSpan = document.getElementById('orderSelectedCount');
		const batchBar = document.getElementById('orderBatchActionBar');
		if (countSpan) countSpan.textContent = count;
		if (batchBar) batchBar.classList.toggle('visible', count > 0);
		// Update select all checkbox state
		const rowCheckboxes = document.querySelectorAll('#travelOrderTable tbody .order-row-checkbox');
		const allChecked = rowCheckboxes.length > 0 && Array.from(rowCheckboxes).every(cb => cb.checked);
		const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
		const selectAllCb = document.getElementById('orderSelectAllCheckbox');
		if (selectAllCb) {
			selectAllCb.checked = allChecked;
			selectAllCb.indeterminate = someChecked && !allChecked;
		}
	}
	
	function exportTravelToExcel(){ try { const rowsCount=document.querySelectorAll('#travelRequestsTable tbody tr').length; if(rowsCount===0){ alert('No data to export'); return; } const table=document.getElementById('travelRequestsTable'); const wb = XLSX.utils.table_to_book(table, { sheet:'TravelRequests' }); XLSX.writeFile(wb, 'travel_requests.xlsx'); } catch(e){ console.error('Excel export failed', e); alert('Excel export failed'); } }
	function exportTravelToPDF(){ const jsPDFLib = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF; if(!jsPDFLib){ alert('PDF library not loaded'); return; } const doc = new jsPDFLib('l','pt','a4'); doc.setFontSize(14); doc.text('Travel Requests Report', 40,40); let y=70; const headers=['ID','Destination','Type','People','Per Diem','Accom','Total','Status']; doc.setFontSize(10); let xStart=40; const colWidths=[60,140,80,80,70,70,70,60]; let x = xStart; headers.forEach((h,i)=>{ doc.text(h, x, y); x+=colWidths[i]; }); y+=16; const rows = travelRequests.map(r=>[r.id,r.destination,r.travelType,Array.isArray(r.people) && r.people.length? `${r.people.length} person(s)` : 'No people',(r.currency||'')+' '+r.perDiemTotal.toFixed(2),(r.currency||'')+' '+r.accommodationTotal.toFixed(2),(r.currency||'')+' '+r.totalCost.toFixed(2),r.status]); rows.forEach(row=>{ if(y>520){ doc.addPage(); y=50; x=xStart; headers.forEach((h,i)=>{ doc.text(h,x,y); x+=colWidths[i]; }); y+=16; } x=xStart; row.forEach((cell,i)=>{ const text=String(cell); const lines=doc.splitTextToSize(text, colWidths[i]-4); lines.forEach((ln,li)=>{ doc.text(ln, x, y + li*10); }); x+=colWidths[i]; }); y+=14; }); doc.save('travel_requests.pdf'); }
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const originDropdown = document.getElementById('origin');
			const destinationDropdown = document.getElementById('destination');
			// Use explicit RTDB REST endpoint as requested
			const url = 'https://users-8be65-default-rtdb.firebaseio.com/companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area.json';

			fetch(url)
				.then(res => {
					if (!res.ok) throw new Error('Network response was not ok');
					return res.json();
				})
					.then(data => {
						if (!data) return;
						const appendOption = (val, label) => {
							const opt = document.createElement('option');
							opt.value = (val === undefined || val === null) ? String(label) : String(val);
							opt.textContent = String(label);
							originDropdown.appendChild(opt.cloneNode(true));
							destinationDropdown.appendChild(opt.cloneNode(true));
						};

						// Handle array of items
						if (Array.isArray(data)) {
							data.forEach(item => {
								if (item && typeof item === 'object') {
									const label = item.label || item.name || item.title || item.value || JSON.stringify(item);
									const value = item.value || item.id || item.key || label;
									appendOption(value, label);
								} else {
									appendOption(item, item);
								}
							});
						// Handle object map { key: labelOrObject }
						} else if (typeof data === 'object') {
							Object.keys(data).forEach(key => {
								const entry = data[key];
								if (entry && typeof entry === 'object') {
									const label = entry.label || entry.name || entry.title || entry.value || JSON.stringify(entry);
									const value = entry.value || entry.id || key;
									appendOption(value, label);
								} else {
									appendOption(key, entry);
								}
							});
						} else {
							appendOption(data, data);
						}
				})
				.catch(err => {
					console.error('Failed to load work areas from RTDB:', err);
				});
			
			// People section helpers
			const peopleContainer = document.getElementById('peopleContainer');
			const peopleTable = document.getElementById('peopleTable');
			const peopleTableBody = document.getElementById('peopleTableBody');
			const personTemplate = document.getElementById('personRowTemplate');
			const addPersonBtn = document.getElementById('addPersonBtn');
			function addPersonRow(person){
				const tpl = personTemplate.content.cloneNode(true);
				const container = tpl.querySelector('.person-container');
				const attachmentsRow = tpl.querySelector('.person-attachments-row');
				if(person){
					container.querySelector('.person-name').value = person.name || '';
					container.querySelector('.person-title').value = person.title || '';
					container.querySelector('.person-departure').value = person.departureDate || '';
					container.querySelector('.person-return').value = person.returnDate || '';
					container.querySelector('.person-stay').value = person.stay || '';
					container.querySelector('.person-perdiem').value = (person.perDiem !== undefined && person.perDiem !== null) ? person.perDiem : '';
					container.querySelector('.person-justification').value = person.justification || '';
					// Set contact field if present
					if (person.contact !== undefined) {
						container.querySelector('.person-contact').value = person.contact || '';
					}
					// Update display elements with proper formatting
					const formattedTitle = person.title ? person.title.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';
					container.querySelector('.person-title-display').textContent = formattedTitle;
					container.querySelector('.person-contact-display').textContent = person.contact || '';
				}
				container.querySelector('.remove-person').addEventListener('click', ()=>{ 
					container.remove(); 
					attachmentsRow.remove();
					// Hide table if no more rows
					if(peopleTableBody.children.length === 0) {
						peopleTable.style.display = 'none';
					}
				});
				
				// Initialize attachment file preview
				const attachmentInput = attachmentsRow.querySelector('.person-attachments');
				const previewList = attachmentsRow.querySelector('.attachment-preview-list');
				if (attachmentInput && previewList) {
					attachmentInput.addEventListener('change', function() {
						updateAttachmentPreview(this, previewList);
					});
					
					// Show existing attachments when editing
					if (person && Array.isArray(person.attachments) && person.attachments.length > 0) {
						previewList.innerHTML = person.attachments.map((att, idx) => {
							const icon = getFileIcon(att.name, att.type);
							const sizeKB = att.size ? (att.size / 1024).toFixed(1) : '?';
							const hasUrl = att.url ? 'true' : 'false';
							return `<div class="attachment-preview-item" data-existing="true" data-url="${att.url || ''}" data-name="${att.name}" data-type="${att.type || ''}" data-size="${att.size || 0}" style="display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;padding:4px 8px;border-radius:6px;font-size:.7rem;">
								<i class="${icon}" style="color:#3b82f6;"></i>
								<span style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${att.name}</span>
								<span style="color:#9ca3af;font-size:.6rem;">${sizeKB} KB</span>
								${att.url ? `<a href="${att.url}" target="_blank" style="color:#3b82f6;font-size:.6rem;text-decoration:none;" title="View file"><i class="fas fa-external-link-alt"></i></a>` : ''}
								<button type="button" class="remove-existing-attachment" data-idx="${idx}" style="background:none;border:none;color:#ef4444;cursor:pointer;padding:0;font-size:.7rem;" title="Remove"><i class="fas fa-times"></i></button>
							</div>`;
						}).join('');
						
						// Store existing attachments data on the row for later use
						attachmentsRow.dataset.existingAttachments = JSON.stringify(person.attachments);
						
						// Add remove handlers for existing attachments
						previewList.querySelectorAll('.remove-existing-attachment').forEach(btn => {
							btn.addEventListener('click', function(e) {
								e.preventDefault();
								const item = this.closest('.attachment-preview-item');
								item.remove();
								// Update stored existing attachments
								const remaining = Array.from(previewList.querySelectorAll('.attachment-preview-item[data-existing="true"]')).map(el => ({
									name: el.dataset.name,
									type: el.dataset.type,
									size: parseInt(el.dataset.size) || 0,
									url: el.dataset.url
								}));
								attachmentsRow.dataset.existingAttachments = JSON.stringify(remaining);
							});
						});
					}
				}
				
				peopleTableBody.appendChild(container);
				peopleTableBody.appendChild(attachmentsRow);
				// Show table when first person is added
				peopleTable.style.display = 'table';
				// Initialize user search for this person row
				initPersonSearch(container);
				return container;
			}
			function populatePeopleSection(people){ 
				peopleTableBody.innerHTML=''; 
				peopleTable.style.display = 'none';
				if(!Array.isArray(people) || people.length===0) return; 
				people.forEach(p=> addPersonRow(p)); 
			}
			function collectPeopleFromForm(){ 
				const containers = Array.from(peopleTableBody.querySelectorAll('.person-container')); 
				return containers.map(container=>{ 
					const attachmentInput = container.nextElementSibling?.querySelector('.person-attachments'); 
					const attachmentCount = attachmentInput?.files?.length || 0; 
				   // Collect attachment details instead of just count
				   const attachments = [];
				   if(attachmentInput && attachmentInput.files) {
					   for(let i = 0; i < attachmentInput.files.length; i++) {
						   const file = attachmentInput.files[i];
						   attachments.push({
							   name: file.name,
							   size: file.size,
							   type: file.type,
							   lastModified: file.lastModified
						   });
					   }
				   }
				   return {
					   name: container.querySelector('.person-name')?.value?.trim() || '',
					   title: container.querySelector('.person-title')?.value?.trim() || '',
					   contact: container.querySelector('.person-contact')?.value?.trim() || '',
					   departureDate: container.querySelector('.person-departure')?.value || '',
					   returnDate: container.querySelector('.person-return')?.value || '',
					   stay: container.querySelector('.person-stay')?.value || '',
					   perDiem: parseFloat(container.querySelector('.person-perdiem')?.value || '0'),
					   justification: container.querySelector('.person-justification')?.value?.trim() || '',
					   attachmentCount: attachmentCount,
					   attachments: attachments
				   };
			   }).filter(p=>p.name.length>0); }
			addPersonBtn?.addEventListener('click', ()=> addPersonRow({}));
			
			// Expose functions globally for access from other parts of the app
			window.addPersonRow = addPersonRow;
			window.populatePeopleSection = populatePeopleSection;
			window.collectPeopleFromForm = collectPeopleFromForm;
			
			// Global helper to add first person
			window.addFirstPerson = function() {
				const peopleContainer = document.getElementById('peopleContainer');
				if(peopleContainer && peopleContainer.children.length === 0) {
					addPersonRow({});
				}
			};
			
			// expose populate to outer scope (keep for backwards compatibility)
			document.populatePeopleSection = populatePeopleSection;
		});
		
		// Tab switching functionality
		function switchTab(tabName) {
			// Update tab buttons
			document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
			document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
			
			// Update tab content
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
			document.getElementById(tabName + 'Tab').classList.add('active');
			
			// Load data for the active tab
			if (tabName === 'orders') {
				renderTravelOrders();
			} else if (tabName === 'requests') {
				renderTravelRequests();
			} else if (tabName === 'settings') {
				loadTravelAccessControl();
				loadTravelStamp();
			}
		}

		// ===== SETTINGS TAB FUNCTIONS =====
		function toggleSettingsSection(header) {
			const section = header.parentElement;
			section.classList.toggle('collapsed');
		}

		// ===== TRAVEL STAMP FUNCTIONS =====
		async function handleTravelStampUpload(event) {
			try {
				const file = event?.target?.files?.[0];
				if (!file) return;

				const user = window.authManager?.currentUser;
				if (!user || !user.companyId) {
					alert('Unable to upload: Company not found');
					return;
				}

				// Validate file size (max 2MB)
				if (file.size > 2 * 1024 * 1024) {
					alert('File too large. Maximum size is 2MB.');
					return;
				}

				// Validate file type
				if (!file.type.startsWith('image/')) {
					alert('Please upload an image file (JPG, PNG, SVG).');
					return;
				}

				const storageRef = firebase.storage().ref(`company-travel-stamps/${user.companyId}/${file.name}`);
				const uploadTask = await storageRef.put(file);
				const downloadURL = await uploadTask.ref.getDownloadURL();

				await firebase.database().ref(`companies/${user.companyId}/travelSettings`).update({ travelStamp: downloadURL });

				// Update display
				updateTravelStampDisplay(downloadURL);

				window.notificationManager?.addNotification({ type: 'success', message: 'Travel stamp uploaded successfully!' });
			} catch (error) {
				console.error('Error uploading travel stamp:', error);
				alert('Error uploading stamp: ' + error.message);
			}
		}

		async function removeTravelStamp() {
			if (!confirm('Are you sure you want to remove the approval stamp?')) return;

			try {
				const user = window.authManager?.currentUser;
				if (!user || !user.companyId) return;

				await firebase.database().ref(`companies/${user.companyId}/travelSettings`).update({ travelStamp: null });

				updateTravelStampDisplay(null);

				window.notificationManager?.addNotification({ type: 'success', message: 'Travel stamp removed successfully!' });
			} catch (error) {
				console.error('Error removing travel stamp:', error);
				alert('Error removing stamp: ' + error.message);
			}
		}

		function updateTravelStampDisplay(stampUrl) {
			const stampPreview = document.getElementById('travelStampPreview');
			const stampPlaceholder = document.getElementById('travelStampPlaceholder');
			const stampActions = document.getElementById('travelStampActions');

			const hasStamp = !!stampUrl;

			if (stampPreview) {
				if (hasStamp) {
					stampPreview.src = stampUrl;
					stampPreview.classList.add('visible');
				} else {
					stampPreview.src = '';
					stampPreview.classList.remove('visible');
				}
			}

			if (stampPlaceholder) {
				stampPlaceholder.style.display = hasStamp ? 'none' : 'flex';
			}

			if (stampActions) {
				stampActions.classList.toggle('hidden', !hasStamp);
			}
		}

		async function loadTravelStamp() {
			try {
				const user = window.authManager?.currentUser;
				if (!user || !user.companyId) return;

				const snap = await firebase.database().ref(`companies/${user.companyId}/travelSettings/travelStamp`).once('value');
				const stampUrl = snap.val();
				updateTravelStampDisplay(stampUrl);
			} catch (error) {
				console.error('Error loading travel stamp:', error);
			}
		}

		// ===== TRAVEL ACCESS CONTROL FUNCTIONS =====
		let travelAccessControlCache = { users: {}, perms: {} };

		async function loadTravelAccessControl() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			try {
				const [usersSnap, permsSnap] = await Promise.all([
					firebase.database().ref(`companies/${user.companyId}/users`).once('value'),
					firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl`).once('value')
				]);
				travelAccessControlCache.users = usersSnap.val() || {};
				travelAccessControlCache.perms = permsSnap.val() || {};
				renderTravelAccessControlTable(travelAccessControlCache.users, travelAccessControlCache.perms);
			} catch (error) {
				console.error('Error loading travel access control:', error);
			}
		}

		function renderTravelAccessControlTable(users, perms) {
			const tbody = document.getElementById('travelAccessControlTableBody');
			if (!tbody) return;

			const permUserIds = Object.keys(perms || {});

			if (permUserIds.length === 0) {
				tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#9ca3af">No users configured. Click "Add User" to add access control.</td></tr>';
				return;
			}

			tbody.innerHTML = permUserIds.map(uid => {
				const u = users[uid] || {};
				const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
				const email = (u.accountType === 'without-account' || u.reportingOnly === true) ? '-' : (u.email || '-');
				const jobTitle = u.jobTitle || u.position || '-';
				const p = perms[uid] || {};

				return `
					<tr onclick="openTravelAccessControlModal('${uid}')" style="cursor:pointer;" title="Click to edit">
						<td>${escapeTravelHtml(name)}</td>
						<td>${escapeTravelHtml(email)}</td>
						<td>${escapeTravelHtml(jobTitle)}</td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="viewAll" ${p.canViewAll ? 'checked' : ''} onchange="updateTravelAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="ordersTab" ${p.canSeeOrdersTab ? 'checked' : ''} onchange="updateTravelAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="approvalButtons" ${p.canSeeApprovalButtons ? 'checked' : ''} onchange="updateTravelAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="batchActions" ${p.canSeeBatchActions ? 'checked' : ''} onchange="updateTravelAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="orderBatchActions" ${p.canSeeOrderBatchActions ? 'checked' : ''} onchange="updateTravelAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="settingsTab" ${p.canSeeSettingsTab ? 'checked' : ''} onchange="updateTravelAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><button class="delete-btn" onclick="removeTravelAccessUser('${uid}')" title="Remove user"><i class="fas fa-trash"></i></button></td>
					</tr>
				`;
			}).join('');
		}

		function escapeTravelHtml(str) {
			if (!str) return '';
			return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c] || c));
		}

		// Global helper to format job title - remove hyphens and capitalize first word
		function formatJobTitle(value) {
			if (!value || value === '-') return '';
			const clean = value.trim().replace(/-/g, ' ');
			return clean.replace(/^[a-z]/, c => c.toUpperCase());
		}

		async function updateTravelAccessPerm(checkbox) {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			const uid = checkbox.dataset.uid;
			const perm = checkbox.dataset.perm;
			const update = {};

			if (perm === 'viewAll') update.canViewAll = checkbox.checked;
			if (perm === 'ordersTab') update.canSeeOrdersTab = checkbox.checked;
			if (perm === 'approvalButtons') update.canSeeApprovalButtons = checkbox.checked;
			if (perm === 'batchActions') update.canSeeBatchActions = checkbox.checked;
			if (perm === 'orderBatchActions') update.canSeeOrderBatchActions = checkbox.checked;
			if (perm === 'settingsTab') update.canSeeSettingsTab = checkbox.checked;

			try {
				await firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl/${uid}`).update(update);
				
				// Update local cache
				if (!travelAccessControlCache.perms[uid]) travelAccessControlCache.perms[uid] = {};
				Object.assign(travelAccessControlCache.perms[uid], update);
				
				// Apply changes immediately if it's the current user
				if (uid === user.id || uid === user.uid) {
					applyTravelTabVisibility();
				}

				window.notificationManager?.addNotification({ type: 'success', message: 'Access updated' });
			} catch (error) {
				console.error('Failed to update travel access:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to update access' });
				checkbox.checked = !checkbox.checked;
			}
		}

		async function removeTravelAccessUser(uid) {
			if (!confirm('Remove this user from access control?')) return;

			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			try {
				await firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl/${uid}`).remove();
				loadTravelAccessControl();
				window.notificationManager?.addNotification({ type: 'success', message: 'User removed from access control' });
			} catch (error) {
				console.error('Failed to remove user:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to remove user' });
			}
		}

		// Track if we're in edit mode
		let editingTravelAccessControlUid = null;

		function openTravelAccessControlModal(editUid = null) {
			editingTravelAccessControlUid = editUid;
			
			const modal = document.getElementById('travelAccessControlModal');
			const input = document.getElementById('travelAcUserInput');
			const hidden = document.getElementById('travelAcUserId');
			const dropdown = document.getElementById('travelAcUserDropdown');
			const modalTitle = document.getElementById('travelAcModalTitle');
			const saveBtn = document.getElementById('travelAcSaveBtn');
			const userSelectGroup = document.getElementById('travelAcUserSelectGroup');
			const userDisplayGroup = document.getElementById('travelAcUserDisplayGroup');
			const userDisplay = document.getElementById('travelAcUserDisplay');

			if (input) input.value = '';
			if (hidden) hidden.value = '';
			if (dropdown) dropdown.innerHTML = '';

			const { users, perms } = travelAccessControlCache;
			
			if (editUid) {
				// Edit mode
				const u = users[editUid] || {};
				const p = perms[editUid] || {};
				const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
				const jobTitle = u.jobTitle || u.position || '';
				
				if (modalTitle) modalTitle.textContent = 'Edit User Access';
				if (saveBtn) saveBtn.textContent = 'Save';
				if (userSelectGroup) userSelectGroup.style.display = 'none';
				if (userDisplayGroup) userDisplayGroup.style.display = 'block';
				if (userDisplay) userDisplay.innerHTML = `<strong>${escapeTravelHtml(name)}</strong>${jobTitle ? `<br><span style="font-size:.75rem;color:#6b7280;">${escapeTravelHtml(jobTitle)}</span>` : ''}`;
				if (hidden) hidden.value = editUid;
				
				// Set current permissions
				document.getElementById('travelAcViewAll').checked = p.canViewAll === true;
				document.getElementById('travelAcOrdersTab').checked = p.canSeeOrdersTab === true;
				document.getElementById('travelAcApprovalButtons').checked = p.canSeeApprovalButtons === true;
				document.getElementById('travelAcBatchActions').checked = p.canSeeBatchActions === true;
				document.getElementById('travelAcOrderBatchActions').checked = p.canSeeOrderBatchActions === true;
				document.getElementById('travelAcSettingsTab').checked = p.canSeeSettingsTab === true;
			} else {
				// Add mode
				if (modalTitle) modalTitle.textContent = 'Add User Access';
				if (saveBtn) saveBtn.textContent = 'Add';
				if (userSelectGroup) userSelectGroup.style.display = 'block';
				if (userDisplayGroup) userDisplayGroup.style.display = 'none';
				
				document.getElementById('travelAcViewAll').checked = true;
				document.getElementById('travelAcOrdersTab').checked = false;
				document.getElementById('travelAcApprovalButtons').checked = false;
				document.getElementById('travelAcBatchActions').checked = false;
				document.getElementById('travelAcOrderBatchActions').checked = false;
				document.getElementById('travelAcSettingsTab').checked = false;
			}
			
			const existingUids = new Set(Object.keys(perms || {}));
			const baseList = Object.entries(users || {}).filter(([uid]) => !existingUids.has(uid)).map(([uid, u]) => {
				const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email || uid;
				const jobTitle = u.jobTitle || u.position || '';
				return { uid, name, jobTitle };
			});

			function renderList(items) {
				if (!dropdown) return;
				if (!items || items.length === 0) {
					dropdown.innerHTML = '<div class="item" style="color:#9ca3af;">No users found</div>';
					dropdown.style.display = 'block';
					return;
				}
				dropdown.innerHTML = items.slice(0, 50).map(it => {
					const right = it.jobTitle ? `<span style="color:#6b7280;font-size:.75rem;">${escapeTravelHtml(it.jobTitle)}</span>` : '';
					return `<div class="item" data-uid="${it.uid}"><span>${escapeTravelHtml(it.name)}</span>${right}</div>`;
				}).join('');
				dropdown.style.display = 'block';
			}

			function filterList(q) {
				const qq = (q || '').trim().toLowerCase();
				if (!qq) { renderList(baseList); return; }
				const res = baseList.filter(it =>
					it.name.toLowerCase().includes(qq) || (it.jobTitle || '').toLowerCase().includes(qq)
				);
				renderList(res);
			}

			if (input && !input._travelAcBound) {
				input._travelAcBound = true;
				input.addEventListener('input', () => filterList(input.value));
				input.addEventListener('focus', () => filterList(input.value));
				document.addEventListener('click', (e) => {
					if (!dropdown) return;
					const container = dropdown.parentElement;
					if (!container.contains(e.target)) dropdown.style.display = 'none';
				});
				if (dropdown) {
					dropdown.addEventListener('click', (e) => {
						const item = e.target.closest('.item');
						if (!item) return;
						const uid = item.getAttribute('data-uid');
						const name = item.querySelector('span')?.textContent || '';
						if (hidden) hidden.value = uid;
						if (input) input.value = name;
						dropdown.style.display = 'none';
					});
				}
			}

			modal.style.display = 'flex';
		}

		function closeTravelAccessControlModal() {
			document.getElementById('travelAccessControlModal').style.display = 'none';
			editingTravelAccessControlUid = null;
		}

		async function saveTravelAccessControl() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			const uid = (document.getElementById('travelAcUserId')?.value || '').trim();
			if (!uid) {
				alert('Please select a user');
				return;
			}

			const canViewAll = document.getElementById('travelAcViewAll').checked;
			const canSeeOrdersTab = document.getElementById('travelAcOrdersTab').checked;
			const canSeeApprovalButtons = document.getElementById('travelAcApprovalButtons').checked;
			const canSeeBatchActions = document.getElementById('travelAcBatchActions').checked;
			const canSeeOrderBatchActions = document.getElementById('travelAcOrderBatchActions').checked;
			const canSeeSettingsTab = document.getElementById('travelAcSettingsTab').checked;
			const isEditMode = editingTravelAccessControlUid !== null;

			try {
				const data = {
					canViewAll,
					canSeeOrdersTab,
					canSeeApprovalButtons,
					canSeeBatchActions,
					canSeeOrderBatchActions,
					canSeeSettingsTab
				};

				await firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl/${uid}`).set(data);

				closeTravelAccessControlModal();
				loadTravelAccessControl();
				// Reapply visibility in case current user's permissions changed
				applyTravelTabVisibility();
				window.notificationManager?.addNotification({ type: 'success', message: isEditMode ? 'User access updated' : 'User added to access control' });
			} catch (error) {
				console.error('Failed to save travel access control:', error);
				window.notificationManager?.addNotification({ type: 'error', message: isEditMode ? 'Failed to update user' : 'Failed to add user' });
			}
		}

		async function applyTravelTabVisibility() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) {
				const requestsBtn = document.querySelector('.tab-button[data-tab="requestsTab"]');
				const ordersBtn = document.querySelector('.tab-button[data-tab="ordersTab"]');
				const settingsBtn = document.querySelector('.tab-button[data-tab="settingsTab"]');
				if (requestsBtn) requestsBtn.style.display = '';
				if (ordersBtn) ordersBtn.style.display = 'none'; // Hide by default
				if (settingsBtn) settingsBtn.style.display = 'none'; // Hide by default
				// Hide batch actions column by default
				applyBatchActionsVisibility(false);
				return;
			}

			try {
				const snap = await firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl/${user.id || user.uid}`).once('value');
				const p = snap.val();

				const requestsBtn = document.querySelector('.tab-button[data-tab="requestsTab"]');
				const ordersBtn = document.querySelector('.tab-button[data-tab="ordersTab"]');
				const settingsBtn = document.querySelector('.tab-button[data-tab="settingsTab"]');
				const settingsTab = document.getElementById('settingsTab');
				const ordersTab = document.getElementById('ordersTab');

				// Requests tab - always visible to all users
				if (requestsBtn) requestsBtn.style.display = '';

				// Orders tab - HIDE by default, only show if explicitly allowed (canSeeOrdersTab === true)
				const allowOrders = p && p.canSeeOrdersTab === true;
				if (ordersBtn) {
					if (allowOrders) {
						ordersBtn.style.display = '';
					} else {
						ordersBtn.style.display = 'none';
					}
				}
				if (ordersTab && !allowOrders) ordersTab.classList.remove('active');

				// Settings tab - HIDE by default, only show if explicitly allowed (canSeeSettingsTab === true)
				const allowSettings = p && p.canSeeSettingsTab === true;
				if (settingsBtn) {
					if (allowSettings) {
						settingsBtn.style.display = '';
					} else {
						settingsBtn.style.display = 'none';
					}
				}
				if (settingsTab && !allowSettings) settingsTab.classList.remove('active');

				// Store view all permission globally
				window._travelCanViewAll = p && p.canViewAll === true;
				
				// Batch actions column visibility (for requests)
				const allowBatchActions = p && p.canSeeBatchActions === true;
				window._travelCanSeeBatchActions = allowBatchActions;
				applyBatchActionsVisibility(allowBatchActions);
				
				// Order batch actions column visibility
				const allowOrderBatchActions = p && p.canSeeOrderBatchActions === true;
				window._travelCanSeeOrderBatchActions = allowOrderBatchActions;
				applyOrderBatchActionsVisibility(allowOrderBatchActions);

				// If current active tab is hidden, switch to requests
				const activeTab = document.querySelector('.tab-button.active');
				if (activeTab && activeTab.style.display === 'none') {
					const requestsTabBtn = document.querySelector('.tab-button[data-tab="requestsTab"]');
					if (requestsTabBtn) requestsTabBtn.click();
				}
			} catch (error) {
				console.error('Error applying travel tab visibility:', error);
				const requestsBtn = document.querySelector('.tab-button[data-tab="requestsTab"]');
				const ordersBtn = document.querySelector('.tab-button[data-tab="ordersTab"]');
				const settingsBtn = document.querySelector('.tab-button[data-tab="settingsTab"]');
				if (requestsBtn) requestsBtn.style.display = '';
				if (ordersBtn) ordersBtn.style.display = 'none'; // Hide by default on error
				if (settingsBtn) settingsBtn.style.display = 'none'; // Hide by default on error
				applyBatchActionsVisibility(false); // Hide by default on error
				applyOrderBatchActionsVisibility(false); // Hide by default on error
			}
		}
		
		function applyBatchActionsVisibility(visible) {
			// Show/hide the checkbox column header
			const selectAllTh = document.querySelector('#travelRequestsTable thead th:first-child');
			if (selectAllTh) selectAllTh.style.display = visible ? '' : 'none';
			
			// Show/hide checkboxes in all rows
			document.querySelectorAll('#travelRequestsTable tbody tr td:first-child').forEach(td => {
				td.style.display = visible ? '' : 'none';
			});
			
			// Hide batch action bar if not allowed
			const batchBar = document.getElementById('travelBatchActionBar');
			if (batchBar && !visible) {
				batchBar.classList.remove('visible');
				clearTravelSelection();
			}
		}
		
		function applyOrderBatchActionsVisibility(visible) {
			// Show/hide the checkbox column header
			const selectAllTh = document.querySelector('#travelOrderTable thead th:first-child');
			if (selectAllTh) selectAllTh.style.display = visible ? '' : 'none';
			
			// Show/hide checkboxes in all rows
			document.querySelectorAll('#travelOrderTable tbody tr td:first-child').forEach(td => {
				td.style.display = visible ? '' : 'none';
			});
			
			// Hide batch action bar if not allowed
			const batchBar = document.getElementById('orderBatchActionBar');
			if (batchBar && !visible) {
				batchBar.classList.remove('visible');
				clearOrderSelection();
			}
		}

		async function checkTravelUserCanViewAll() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return false;
			
			try {
				const snap = await firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl/${user.id || user.uid}`).once('value');
				const p = snap.val() || {};
				return p.canViewAll === true;
			} catch (error) {
				console.error('Error checking travel view all permission:', error);
				return false;
			}
		}

		// Initialize tab visibility on page load
		document.addEventListener('DOMContentLoaded', () => {
			// Wait for auth to be ready before applying tab visibility
			if (window.authManager?.currentUser) {
				applyTravelTabVisibility();
			} else {
				// Retry after a short delay
				setTimeout(applyTravelTabVisibility, 1000);
			}
		});
		
		// Travel Order functionality
		let travelOrders = [];
		let orderColumnFilters = {};
		
		// Column Filter Functions for Travel Orders
		function toggleOrderColumnFilter(event, columnName) {
			event.stopPropagation();
			const dropdown = document.getElementById(`order-filter-${columnName}`);
			if (!dropdown) return;
			
			// Close all other dropdowns first
			document.querySelectorAll('.column-filter-dropdown.show').forEach(d => {
				if (d.id !== `order-filter-${columnName}`) d.classList.remove('show');
			});
			
			const isOpen = dropdown.classList.contains('show');
			if (isOpen) {
				dropdown.classList.remove('show');
			} else {
				populateOrderColumnFilter(columnName);
				dropdown.classList.add('show');
			}
		}
		
		function populateOrderColumnFilter(columnName) {
			const dropdown = document.getElementById(`order-filter-${columnName}`);
			if (!dropdown) return;
			
			// Check if this is a date column - show calendar picker instead
			if (columnName === 'departure' || columnName === 'return') {
				const currentFilter = orderColumnFilters[columnName] || '';
				let html = `
					<div style="padding:10px;">
						<label style="font-size:.65rem;color:#6b7280;display:block;margin-bottom:6px;">Select ${columnName === 'departure' ? 'Departure' : 'Return'} Date:</label>
						<input type="date" class="filter-date-picker" id="order-filter-date-${columnName}" value="${currentFilter}" 
							style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:.75rem;"
							onchange="applyOrderColumnFilter('${columnName}', this.value)" />
					</div>
				`;
				if (currentFilter) {
					html += `<div class="filter-clear" onclick="clearOrderColumnFilter('${columnName}')"><i class="fas fa-times"></i> Clear filter</div>`;
				}
				dropdown.innerHTML = html;
				return;
			}
			
			// Get unique values from travelOrders based on column
			const values = new Set();
			
			travelOrders.forEach(order => {
				let val = '';
				switch(columnName) {
					case 'orderId':
						val = order.orderId || '';
						break;
					case 'origin':
						val = order.origin || '';
						break;
					case 'destination':
						val = order.destination || '';
						break;
					case 'vehicle':
						val = order.vehicle?.plateNumber || '';
						break;
					case 'status':
						val = order.status || '';
						break;
				}
				if (val) values.add(val);
			});
			
			const sortedValues = [...values].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
			const currentFilter = orderColumnFilters[columnName] || '';
			
			const escapeHtml = (str) => String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
			
			let html = `<input type="text" class="filter-search" placeholder="Search..." oninput="filterOrderColumnOptions(event, '${columnName}')">`;
			html += `<div class="filter-options-list">`;
			sortedValues.forEach(val => {
				const selected = currentFilter === val ? 'selected' : '';
				html += `<div class="filter-option ${selected}" data-value="${escapeHtml(val)}" onclick="applyOrderColumnFilter('${columnName}', '${escapeHtml(val).replace(/'/g, "\\'")}')">${escapeHtml(val)}</div>`;
			});
			html += `</div>`;
			if (currentFilter) {
				html += `<div class="filter-clear" onclick="clearOrderColumnFilter('${columnName}')"><i class="fas fa-times"></i> Clear filter</div>`;
			}
			
			dropdown.innerHTML = html;
		}
		
		function filterOrderColumnOptions(event, columnName) {
			const searchVal = (event.target.value || '').toLowerCase();
			const dropdown = document.getElementById(`order-filter-${columnName}`);
			if (!dropdown) return;
			
			dropdown.querySelectorAll('.filter-option').forEach(opt => {
				const text = (opt.textContent || '').toLowerCase();
				opt.style.display = text.includes(searchVal) ? '' : 'none';
			});
		}
		
		function applyOrderColumnFilter(columnName, value) {
			orderColumnFilters[columnName] = value;
			updateOrderColumnFilterIcons();
			
			// Close dropdown
			const dropdown = document.getElementById(`order-filter-${columnName}`);
			if (dropdown) dropdown.classList.remove('show');
			
			// Apply column header filters to the currently rendered rows
			applyOrderColumnHeaderFilters();
		}
		
		function clearOrderColumnFilter(columnName) {
			delete orderColumnFilters[columnName];
			updateOrderColumnFilterIcons();
			
			// Close dropdown
			const dropdown = document.getElementById(`order-filter-${columnName}`);
			if (dropdown) dropdown.classList.remove('show');
			
			// Re-apply column header filters after clearing
			applyOrderColumnHeaderFilters();
		}
		
		function updateOrderColumnFilterIcons() {
			// Update filter icons to show active state
			document.querySelectorAll('#travelOrderTable .column-filter-header').forEach(header => {
				const col = header.dataset.column;
				if (orderColumnFilters[col]) {
					header.classList.add('filter-active');
				} else {
					header.classList.remove('filter-active');
				}
			});
		}

		function applyOrderColumnHeaderFilters() {
			const tbody = document.querySelector('#travelOrderTable tbody');
			if (!tbody) return;
			
			const rows = tbody.querySelectorAll('tr');
			rows.forEach(row => {
				let show = true;
				
				// Check each active filter
				for (const [columnName, filterValue] of Object.entries(orderColumnFilters)) {
					if (!filterValue) continue;
					
					let cellIndex;
					switch(columnName) {
						case 'orderId': cellIndex = 1; break;
						case 'origin': cellIndex = 2; break;
						case 'destination': cellIndex = 3; break;
						case 'vehicle': cellIndex = 4; break;
						case 'departure': cellIndex = 5; break;
						case 'return': cellIndex = 6; break;
						case 'status': cellIndex = 7; break;
						default: continue;
					}
					
					const cell = row.cells[cellIndex];
					if (cell) {
						const cellText = cell.textContent.trim();
						
						// For date columns, compare dates using data-date attribute
						if (columnName === 'departure' || columnName === 'return') {
							const cellDateRaw = cell.dataset.date || '';
							if (!cellDateRaw) {
								show = false;
								break;
							}
							// Normalize both dates to YYYY-MM-DD format for comparison
							const filterDateStr = filterValue; // Already in YYYY-MM-DD from date input
							let cellDateStr = cellDateRaw;
							
							// If cellDateRaw contains time info, extract just the date part
							if (cellDateRaw.includes('T')) {
								cellDateStr = cellDateRaw.split('T')[0];
							} else if (cellDateRaw.includes(' ')) {
								cellDateStr = cellDateRaw.split(' ')[0];
							}
							
							// Try to parse and reformat to ensure consistent format
							try {
								const cellDate = new Date(cellDateRaw);
								if (!isNaN(cellDate.getTime())) {
									cellDateStr = cellDate.toISOString().split('T')[0];
								}
							} catch (e) {
								// Keep original if parsing fails
							}
							
							if (filterDateStr !== cellDateStr) {
								show = false;
								break;
							}
						} else {
							if (!cellText.toLowerCase().includes(filterValue.toLowerCase())) {
								show = false;
								break;
							}
						}
					}
				}
				
				row.style.display = show ? '' : 'none';
			});
		}
		
		// Close dropdowns when clicking outside
		document.addEventListener('click', function(e) {
			if (!e.target.closest('.column-filter-header')) {
				document.querySelectorAll('.column-filter-dropdown.show').forEach(d => d.classList.remove('show'));
			}
		});

		// Request tab column filters (ID, Requester, Type, Status)
		const requestColumnFilters = {};

		function toggleRequestColumnFilter(event, columnName) {
			event.stopPropagation();
			const dropdown = document.getElementById(`request-filter-${columnName}`);
			if (!dropdown) return;
			// Close others
			document.querySelectorAll('.column-filter-dropdown.show').forEach(d => {
				if (d.id !== `request-filter-${columnName}`) d.classList.remove('show');
			});
			const isOpen = dropdown.classList.contains('show');
			if (isOpen) {
				dropdown.classList.remove('show');
			} else {
				populateRequestColumnFilter(columnName);
				dropdown.classList.add('show');
			}
		}

		function populateRequestColumnFilter(columnName) {
			const dropdown = document.getElementById(`request-filter-${columnName}`);
			if (!dropdown) return;

			// Collect unique values from travelRequests
			const values = new Set();
			travelRequests.forEach(req => {
				let val = '';
				switch(columnName) {
					case 'requestId':
						val = req.id || '';
						break;
					case 'requester':
						val = (req.createdBy?.name || req.createdBy?.email || '').trim();
						break;
					case 'type':
						val = req.travelType || '';
						break;
					case 'status':
						val = req.status || '';
						break;
				}
				if (val) values.add(val);
			});

			const sortedValues = [...values].sort((a,b)=> String(a).toLowerCase().localeCompare(String(b).toLowerCase()));
			const currentFilter = requestColumnFilters[columnName] || '';
			const escapeHtml = (str) => String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

			let html = `<input type="text" class="filter-search" placeholder="Search..." oninput="filterRequestColumnOptions(event, '${columnName}')">`;
			html += `<div class="filter-options-list">`;
			sortedValues.forEach(val => {
				const selected = currentFilter === val ? 'selected' : '';
				html += `<div class="filter-option ${selected}" data-value="${escapeHtml(val)}" onclick="applyRequestColumnFilter('${columnName}', '${escapeHtml(val).replace(/'/g, "\\'")}')">${escapeHtml(val)}</div>`;
			});
			html += `</div>`;
			if (currentFilter) {
				html += `<div class="filter-clear" onclick="clearRequestColumnFilter('${columnName}')"><i class="fas fa-times"></i> Clear filter</div>`;
			}
			dropdown.innerHTML = html;
		}

		function filterRequestColumnOptions(event, columnName) {
			const searchVal = (event.target.value || '').toLowerCase();
			const dropdown = document.getElementById(`request-filter-${columnName}`);
			if (!dropdown) return;
			dropdown.querySelectorAll('.filter-option').forEach(opt => {
				const text = (opt.textContent || '').toLowerCase();
				opt.style.display = text.includes(searchVal) ? '' : 'none';
			});
		}

		function applyRequestColumnFilter(columnName, value) {
			requestColumnFilters[columnName] = value;
			updateRequestColumnFilterIcons();
			const dropdown = document.getElementById(`request-filter-${columnName}`);
			if (dropdown) dropdown.classList.remove('show');
			applyRequestColumnHeaderFilters();
		}

		function clearRequestColumnFilter(columnName) {
			delete requestColumnFilters[columnName];
			updateRequestColumnFilterIcons();
			const dropdown = document.getElementById(`request-filter-${columnName}`);
			if (dropdown) dropdown.classList.remove('show');
			applyRequestColumnHeaderFilters();
		}

		function updateRequestColumnFilterIcons() {
			document.querySelectorAll('#travelRequestsTable .column-filter-header').forEach(header => {
				const col = header.dataset.column;
				if (requestColumnFilters[col]) {
					header.classList.add('filter-active');
				} else {
					header.classList.remove('filter-active');
				}
			});
		}

		function applyRequestColumnHeaderFilters() {
			const tbody = document.querySelector('#travelRequestsTable tbody');
			if (!tbody) return;
			const rows = tbody.querySelectorAll('tr');
			rows.forEach(row => {
				let show = true;
				for (const [columnName, filterValue] of Object.entries(requestColumnFilters)) {
					if (!filterValue) continue;
					let cellIndex;
					switch(columnName) {
						case 'requestId': cellIndex = 1; break;
						case 'requester': cellIndex = 2; break;
						case 'type': cellIndex = 3; break;
						case 'status': cellIndex = 8; break;
						default: continue;
					}
					const cell = row.cells[cellIndex];
					if (cell) {
						const cellText = (cell.textContent || '').toLowerCase();
						if (!cellText.includes(String(filterValue).toLowerCase())) {
							show = false;
							break;
						}
					}
				}
				row.style.display = show ? '' : 'none';
			});
		}

		async function renderTravelOrders() {
			try {
				// Get company ID
				const companyId = authManager?.currentUser?.companyId || currentCompanyId;
				if (!companyId) {
					console.warn('No company ID found for travel orders');
					return;
				}
				
				// Set up real-time listener for travel orders
				const travelOrdersRef = database.ref(`companies/${companyId}/travelOrders`);
				
				// Remove any existing listener
				travelOrdersRef.off();
				
				// Add real-time listener
				travelOrdersRef.on('value', (snapshot) => {
					const ordersData = snapshot.val() || {};
					
					travelOrders = Object.keys(ordersData).map(key => ({
						...ordersData[key],
						firebaseKey: key
					})).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
					
					// Apply filters and render table
					applyOrderFilters();
				});
				
			} catch (error) {
				console.error('Error loading travel orders:', error);
			}
		}
		
		function applyOrderFilters() {
			const searchTerm = document.getElementById('orderSearchTerm')?.value?.toLowerCase() || '';
			const statusFilter = document.getElementById('orderFilterStatus')?.value || '';
			const fromDate = document.getElementById('orderFromDate')?.value || '';
			const toDate = document.getElementById('orderToDate')?.value || '';
			
			const filteredOrders = travelOrders.filter(order => {
				const matchesSearch = !searchTerm || 
					order.orderId.toLowerCase().includes(searchTerm) ||
					order.travelers.some(traveler => traveler.name.toLowerCase().includes(searchTerm));
				const matchesStatus = !statusFilter || order.status === statusFilter;
				const matchesFromDate = !fromDate || order.departureDate >= fromDate;
				const matchesToDate = !toDate || order.returnDate <= toDate;
				
				return matchesSearch && matchesStatus && matchesFromDate && matchesToDate;
			});
			
			renderOrderTable(filteredOrders);
		}
		
		function renderOrderTable(orders) {
			const tbody = document.querySelector('#travelOrderTable tbody');
			const emptyState = document.getElementById('orderEmptyState');
			
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			if (orders.length === 0) {
				emptyState.style.display = 'block';
				return;
			}
			
			emptyState.style.display = 'none';
			
			const showOrderBatchCol = window._travelCanSeeOrderBatchActions === true;
			
			// Show/hide checkbox column header
			const orderSelectAllTh = document.querySelector('#travelOrderTable thead th:first-child');
			if (orderSelectAllTh) orderSelectAllTh.style.display = showOrderBatchCol ? '' : 'none';
			
			orders.forEach(order => {
				const tr = document.createElement('tr');
				tr.style.cursor = 'pointer';
				tr.setAttribute('data-key', order.firebaseKey);
				tr.addEventListener('click', (e) => {
					// Don't trigger row click if clicking on action buttons or checkbox
					if (!e.target.closest('.actions') && e.target.type !== 'checkbox') {
						viewTravelOrder(order.firebaseKey);
					}
				});
				
				const travelerNames = order.travelers.map(t => t.name).join(', ');
				const travelerCount = order.travelers.length;
				const displayNames = travelerCount > 2 ? 
					`${order.travelers[0].name}, ${order.travelers[1].name} (+${travelerCount - 2} more)` : 
					travelerNames;
				
				// Vehicle information display
				const vehicleDisplay = order.vehicle && order.vehicle.plateNumber ? 
					order.vehicle.plateNumber : '—';
				
				tr.innerHTML = `
					<td style="text-align:center;${showOrderBatchCol ? '' : 'display:none;'}" onclick="event.stopPropagation();"><input type="checkbox" class="batch-checkbox order-row-checkbox" data-key="${order.firebaseKey}" onchange="updateOrderSelection(this)"></td>
					<td>${order.orderId}</td>
					<td>${order.origin || '—'}</td>
					<td>${order.destination || '—'}</td>
					<td title="${order.vehicle ? `${order.vehicle.plateNumber} - ${order.vehicle.vehicleName || order.vehicle.vehicleType}` : 'No vehicle assigned'}">${vehicleDisplay}</td>
					<td data-date="${order.departureDate || ''}">${order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—'}</td>
					<td data-date="${order.returnDate || ''}">${order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—'}</td>
					<td><span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></td>
					<td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—'}</td>
				`;
				tbody.appendChild(tr);
			});

			// Re-apply active column header filters to the newly rendered rows
			updateOrderColumnFilterIcons();
			applyOrderColumnHeaderFilters();
		}
		
		function viewOriginalRequest(requestKey) {
			const req = findRequestByKey(requestKey);
			if (req) {
				openViewModal(req);
			}
		}
		
		function exportTravelOrder(requestKey, travelerName) {
			const order = travelOrders.find(o => o.requestKey === requestKey && o.travelerName === travelerName);
			if (!order) {
				alert('Travel order not found');
				return;
			}
			
			// Create a simple travel order export
			const content = `
TRAVEL ORDER

Request ID: ${order.requestId}
Traveler: ${order.travelerName}
Title: ${order.title || 'N/A'}
Destination: ${order.destination}
Travel Type: ${order.travelType}
Departure: ${order.departureDate ? new Date(order.departureDate).toLocaleDateString() : 'N/A'}
Return: ${order.returnDate ? new Date(order.returnDate).toLocaleDateString() : 'N/A'}
Duration: ${order.days} days
Per Diem: ${order.currency} ${order.perDiem.toFixed(2)}
Approved By: ${order.approvedBy}
Approved Date: ${order.approvedAt ? new Date(order.approvedAt).toLocaleDateString() : 'N/A'}
			`.trim();
			
			const blob = new Blob([content], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `travel_order_${order.requestId}_${order.travelerName.replace(/\s+/g, '_')}.txt`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}
		
		// Add event listeners for travel order filters
		document.addEventListener('DOMContentLoaded', function() {
			const orderSearchTerm = document.getElementById('orderSearchTerm');
			const orderFilterStatus = document.getElementById('orderFilterStatus');
			const orderFromDate = document.getElementById('orderFromDate');
			const orderToDate = document.getElementById('orderToDate');
			const refreshOrderBtn = document.getElementById('refreshOrderBtn');
			const newTravelOrderBtn = document.getElementById('newTravelOrderBtn');
			const closeTravelOrderModalBtn = document.getElementById('closeTravelOrderModalBtn');
			const cancelTravelOrderBtn = document.getElementById('cancelTravelOrderBtn');
			const travelOrderForm = document.getElementById('travelOrderForm');
			const createTravelOrderModal = document.getElementById('createTravelOrderModal');
			
			[orderSearchTerm, orderFilterStatus, orderFromDate, orderToDate].forEach(el => {
				if (el) {
					el.addEventListener('input', applyOrderFilters);
				}
			});
			
			if (refreshOrderBtn) {
				refreshOrderBtn.addEventListener('click', renderTravelOrders);
			}
			
			if (newTravelOrderBtn) {
				newTravelOrderBtn.addEventListener('click', openCreateTravelOrderModal);
			}
			
			[closeTravelOrderModalBtn, cancelTravelOrderBtn].forEach(btn => {
				if (btn) {
					btn.addEventListener('click', closeTravelOrderModal);
				}
			});
			
			if (createTravelOrderModal) {
				createTravelOrderModal.addEventListener('click', (e) => {
					if (e.target === createTravelOrderModal) {
						closeTravelOrderModal();
					}
				});
			}
			
			if (travelOrderForm) {
				travelOrderForm.addEventListener('submit', handleTravelOrderSubmit);
			}
			
			// Add event listeners for travel order form fields that affect vehicle availability
			const orderDepartureDateField = document.getElementById('orderDepartureDateField');
			const orderReturnDateField = document.getElementById('orderReturnDateField');
			const orderOriginField = document.getElementById('orderOriginField');
			const orderDestinationField = document.getElementById('orderDestinationField');
			const orderTripTypeField = document.getElementById('orderTripTypeField');
			
			// Refresh vehicle options when key fields change
			[orderDepartureDateField, orderReturnDateField, orderOriginField, orderDestinationField].forEach(field => {
				if (field) {
					field.addEventListener('change', () => {
						// Delay to ensure all fields are updated before checking availability
						setTimeout(() => {
							loadVehicleOptions();
						}, 100);
					});
				}
			});
			
			// Handle trip type changes
			if (orderTripTypeField && orderReturnDateField) {
				orderTripTypeField.addEventListener('change', () => {
					const tripType = orderTripTypeField.value;
					const returnDateContainer = document.getElementById('returnDateContainer');
					
					if (tripType === 'one-way') {
						// Hide return date field for one-way trips
						if (returnDateContainer) {
							returnDateContainer.style.display = 'none';
						}
						orderReturnDateField.removeAttribute('required');
						orderReturnDateField.value = ''; // Clear return date
					} else if (tripType === 'round-trip') {
						// Show return date field for round trips
						if (returnDateContainer) {
							returnDateContainer.style.display = 'block';
						}
						orderReturnDateField.setAttribute('required', 'required');
					} else {
						// Default state when no trip type selected - show return date field
						if (returnDateContainer) {
							returnDateContainer.style.display = 'block';
						}
						orderReturnDateField.setAttribute('required', 'required');
					}
					
					// Refresh vehicle options and traveler list after trip type change
					setTimeout(() => {
						loadVehicleOptions();
						filterTravelersByDates();
					}, 100);
				});
			}
			
			// View Travel Order Modal elements and listeners
			const closeViewTravelOrderModalBtn = document.getElementById('closeViewTravelOrderModalBtn');
			const closeViewTravelOrderBtn = document.getElementById('closeViewTravelOrderBtn');
			const viewTravelOrderModal = document.getElementById('viewTravelOrderModal');
			
			[closeViewTravelOrderModalBtn, closeViewTravelOrderBtn].forEach(btn => {
				if (btn) {
					btn.addEventListener('click', closeViewTravelOrderModal);
				}
			});
			
			if (viewTravelOrderModal) {
				viewTravelOrderModal.addEventListener('click', (e) => {
					if (e.target === viewTravelOrderModal) {
						closeViewTravelOrderModal();
					}
				});
			}

			// Add event listeners for date filtering
			const departureDateField = document.getElementById('orderDepartureDateField');
			const returnDateField = document.getElementById('orderReturnDateField');
			const tripTypeField = document.getElementById('orderTripTypeField');
			
			if (departureDateField) {
				departureDateField.addEventListener('change', filterTravelersByDates);
			}
			
			if (returnDateField) {
				returnDateField.addEventListener('change', filterTravelersByDates);
			}
			
			if (tripTypeField) {
				tripTypeField.addEventListener('change', filterTravelersByDates);
			}
		});
		
		// Travel Order Global Variables
		let selectedTravelers = [];
		let allApprovedTravelers = [];
		
		// Travel Order Creation Functions
		async function openCreateTravelOrderModal() {
			try {
				// Load travel requests from Firebase
				if (!currentCompanyId) {
					alert('Company information not available. Please refresh the page and try again.');
					return;
				}
				
				// Reset form first
				const form = document.getElementById('travelOrderForm');
				if (form) form.reset();
				
				// Reset selected travelers
				selectedTravelers = [];
				const selectedContainer = document.getElementById('selectedTravelersContainer');
				const tagsContainer = document.getElementById('selectedTravelersTags');
				if (selectedContainer) selectedContainer.style.display = 'none';
				if (tagsContainer) tagsContainer.innerHTML = '';
				
				// Generate order ID immediately when modal opens
				const orderPrefix = 'TO';
				const timestamp = Date.now().toString().slice(-6);
				const orderId = `${orderPrefix}-${timestamp}`;
				
				// Pre-populate the meta bar info
				const metaOrderId = document.getElementById('metaOrderId');
				const metaOrderStatus = document.getElementById('metaOrderStatus');
				const metaOrderCreatedBy = document.getElementById('metaOrderCreatedBy');
				const metaOrderCreatedAt = document.getElementById('metaOrderCreatedAt');
				const orderMetaBar = document.getElementById('orderMetaBar');
				
				if (metaOrderId) metaOrderId.textContent = orderId;
				if (metaOrderStatus) metaOrderStatus.textContent = 'Draft';
				if (metaOrderCreatedBy) metaOrderCreatedBy.textContent = authManager?.getUserDisplayName() || 'Current User';
				if (metaOrderCreatedAt) metaOrderCreatedAt.textContent = new Date().toLocaleDateString();
				if (orderMetaBar) orderMetaBar.style.display = 'block';
				
				// Reset the status dropdown to Draft
				const orderStatusField = document.getElementById('orderStatusField');
				if (orderStatusField) orderStatusField.value = 'Draft';
				
				// Store the order ID for form submission
				window.currentTravelOrderId = orderId;
				
				// Load vehicles and populate dropdown
				await loadVehicleOptions();
				
				// Load origin options and populate dropdown
				await loadOriginOptions();
				
				// Load destination options and populate dropdown
				await loadDestinationOptions();
				
				const database = firebase.database();
				const snapshot = await database.ref(`companies/${currentCompanyId}/travelRequests`).once('value');
				const requestsData = snapshot.val() || {};
				
				// Convert to array and filter for approved requests
				const allRequests = Object.keys(requestsData).map(key => ({
					...requestsData[key],
					firebaseKey: key
				}));
				
				const approvedRequests = allRequests.filter(req => req.status === 'Approved');
				
				if (approvedRequests.length === 0) {
					alert('No approved travel requests found. You need approved travel requests to create travel orders.');
					return;
				}
				
				console.log('Found approved requests:', approvedRequests.length);
				
				// Populate approved travelers dropdown
				populateApprovedTravelersDropdown(approvedRequests);
				
				// Show the modal
				const modal = document.getElementById('createTravelOrderModal');
				modal.classList.add('show');
				modal.setAttribute('aria-hidden', 'false');
				
				// Auto-run simulator to show travelers list
				setTimeout(() => {
					runTravelSimulation();
				}, 100);
			} catch (error) {
				console.error('Error opening create travel order modal:', error);
				alert('Error opening travel order creation. Please try again.');
			}
		}
		
		async function loadVehicleOptions() {
			try {
				if (!currentCompanyId) {
					console.warn('No company ID available for loading vehicles');
					return;
				}
				
				const database = firebase.database();
				const snapshot = await database.ref(`companies/${currentCompanyId}/vehicles`).once('value');
				const vehiclesData = snapshot.val() || {};
				
				const vehicleSelect = document.getElementById('orderVehicleField');
				if (!vehicleSelect) {
					console.warn('Vehicle select element not found');
					return;
				}
				
				// Clear existing options except the first one
				vehicleSelect.innerHTML = '<option value="">Select Vehicle</option>';
				
				// Convert vehicles data to array and sort by plate number
				const vehicles = Object.keys(vehiclesData).map(key => ({
					id: key,
					...vehiclesData[key]
				}))
				  // Only include vehicles with plate numbers
				  .filter(vehicle => vehicle.plateNumber)
				  // Only include Active vehicles (accept either vehicleStatus or status field)
				  .filter(vehicle => (vehicle.vehicleStatus || vehicle.status || '').toLowerCase() === 'active')
				  .sort((a, b) => (a.plateNumber || '').localeCompare(b.plateNumber || ''));
				
				// Get current form values for availability checking
				const departureDate = document.getElementById('orderDepartureDateField')?.value;
				const returnDate = document.getElementById('orderReturnDateField')?.value;
				const origin = document.getElementById('orderOriginField')?.value;
				const destination = document.getElementById('orderDestinationField')?.value;
				const tripType = document.getElementById('orderTripTypeField')?.value;
				
				// Filter out unavailable vehicles if dates and route are selected
				let availableVehicles = vehicles;
				const statusElement = document.getElementById('vehicleAvailabilityStatus');
				
				// Check availability if we have departure date, origin, destination, and either return date or one-way trip
				if (departureDate && origin && destination && (returnDate || tripType === 'one-way')) {
					const unavailableVehicleIds = await getUnavailableVehicles(departureDate, returnDate, origin, destination);
					availableVehicles = vehicles.filter(vehicle => !unavailableVehicleIds.includes(vehicle.id));
					
					// Show status message
					if (statusElement) {
						const filteredCount = vehicles.length - availableVehicles.length;
						if (filteredCount > 0) {
							statusElement.textContent = `${filteredCount} vehicle(s) unavailable for this period/route`;
							statusElement.style.color = '#ef4444';
							statusElement.style.display = 'block';
						} else if (availableVehicles.length > 0) {
							statusElement.textContent = `${availableVehicles.length} vehicle(s) available`;
							statusElement.style.color = '#10b981';
							statusElement.style.display = 'block';
						} else {
							statusElement.textContent = 'No vehicles available for this period/route';
							statusElement.style.color = '#ef4444';
							statusElement.style.display = 'block';
						}
					}
				} else {
					// Hide status message when not all required fields are selected
					if (statusElement) {
						statusElement.style.display = 'none';
					}
				}
				
				// Add vehicle options
				availableVehicles.forEach(vehicle => {
					const option = document.createElement('option');
					option.value = vehicle.id;
					option.textContent = `${vehicle.plateNumber} - ${vehicle.vehicleName || vehicle.vehicleType || 'Unknown Vehicle'}`;
					option.dataset.plateNumber = vehicle.plateNumber;
					option.dataset.vehicleName = vehicle.vehicleName || '';
					option.dataset.vehicleType = vehicle.vehicleType || '';
					option.dataset.status = vehicle.vehicleStatus || vehicle.status || '';
					vehicleSelect.appendChild(option);
				});
				
				const filteredCount = vehicles.length - availableVehicles.length;
				if (filteredCount > 0) {
					console.log(`Filtered out ${filteredCount} unavailable vehicles for the selected period and route`);
				}
				console.log(`Loaded ${availableVehicles.length} available vehicles for selection`);
				
			} catch (error) {
				console.error('Error loading vehicle options:', error);
			}
		}
		
		// Function to check which vehicles are unavailable for a given period and route
		async function getUnavailableVehicles(departureDate, returnDate, origin, destination) {
			try {
				if (!currentCompanyId) return [];
				
				const database = firebase.database();
				const snapshot = await database.ref(`companies/${currentCompanyId}/travelOrders`).once('value');
				const ordersData = snapshot.val() || {};
				
				const unavailableVehicleIds = new Set();
				
				// Convert dates to Date objects for comparison
				const requestDeparture = new Date(departureDate);
				// For one-way trips, use departure date as return date for comparison
				const requestReturn = returnDate ? new Date(returnDate) : new Date(departureDate);
				
				// Check each existing travel order
				Object.entries(ordersData).forEach(([orderKey, order]) => {
					// Skip the order being edited (if any)
					if (window.editingOrderKey && orderKey === window.editingOrderKey) {
						return;
					}
					
					// Skip orders that are cancelled or don't have vehicle assigned
					if (!order.vehicle || !order.vehicle.vehicleId || order.status === 'Cancelled') {
						return;
					}
					
					// Skip orders that don't have the same route
					if (order.origin !== origin || order.destination !== destination) {
						return;
					}
					
					// Check if dates overlap
					if (order.departureDate) {
						const orderDeparture = new Date(order.departureDate);
						// For existing orders, if no return date, use departure date
						const orderReturn = order.returnDate ? new Date(order.returnDate) : new Date(order.departureDate);
						
						// Check for date overlap - two periods overlap if:
						// requestDeparture <= orderReturn AND requestReturn >= orderDeparture
						if (requestDeparture <= orderReturn && requestReturn >= orderDeparture) {
							unavailableVehicleIds.add(order.vehicle.vehicleId);
						}
					}
				});
				
				return Array.from(unavailableVehicleIds);
				
			} catch (error) {
				console.error('Error checking vehicle availability:', error);
				return [];
			}
		}
		
		async function loadOriginOptions() {
			try {
				const originSelect = document.getElementById('orderOriginField');
				if (!originSelect) {
					console.warn('Origin select element not found');
					return;
				}
				
				// Clear existing options except the first one
				originSelect.innerHTML = '<option value="">Select Origin</option>';
				
				// Use the same URL as the travel request form
				const url = 'https://users-8be65-default-rtdb.firebaseio.com/companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area.json';
				
				const response = await fetch(url);
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				
				const data = await response.json();
				if (!data) return;
				
				const appendOption = (val, label) => {
					const option = document.createElement('option');
					option.value = (val === undefined || val === null) ? String(label) : String(val);
					option.textContent = String(label);
					originSelect.appendChild(option);
				};
				
				// Handle array of items
				if (Array.isArray(data)) {
					data.forEach(item => {
						if (item && typeof item === 'object') {
							const label = item.label || item.name || item.title || item.value || JSON.stringify(item);
							const value = item.value || item.id || item.key || label;
							appendOption(value, label);
						} else {
							appendOption(item, item);
						}
					});
				// Handle object map { key: labelOrObject }
				} else if (typeof data === 'object') {
					Object.keys(data).forEach(key => {
						const entry = data[key];
						if (entry && typeof entry === 'object') {
							const label = entry.label || entry.name || entry.title || entry.value || JSON.stringify(entry);
							const value = entry.value || entry.id || key;
							appendOption(value, label);
						} else {
							appendOption(key, entry);
						}
					});
				} else {
					appendOption(data, data);
				}
				
				console.log('Origin options loaded successfully');
				
			} catch (error) {
				console.error('Error loading origin options:', error);
			}
		}
		
		async function loadDestinationOptions() {
			try {
				const destinationSelect = document.getElementById('orderDestinationField');
				if (!destinationSelect) {
					console.warn('Destination select element not found');
					return;
				}
				
				// Clear existing options except the first one
				destinationSelect.innerHTML = '<option value="">Select Destination</option>';
				
				// Use the same URL as the travel request form
				const url = 'https://users-8be65-default-rtdb.firebaseio.com/companies/-OYL6cpeH7JnNLPBhCTH/fieldOptions/area.json';
				
				const response = await fetch(url);
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				
				const data = await response.json();
				if (!data) return;
				
				const appendOption = (val, label) => {
					const option = document.createElement('option');
					option.value = (val === undefined || val === null) ? String(label) : String(val);
					option.textContent = String(label);
					destinationSelect.appendChild(option);
				};
				
				// Handle array of items
				if (Array.isArray(data)) {
					data.forEach(item => {
						if (item && typeof item === 'object') {
							const label = item.label || item.name || item.title || item.value || JSON.stringify(item);
							const value = item.value || item.id || item.key || label;
							appendOption(value, label);
						} else {
							appendOption(item, item);
						}
					});
				// Handle object map { key: labelOrObject }
				} else if (typeof data === 'object') {
					Object.keys(data).forEach(key => {
						const entry = data[key];
						if (entry && typeof entry === 'object') {
							const label = entry.label || entry.name || entry.title || entry.value || JSON.stringify(entry);
							const value = entry.value || entry.id || key;
							appendOption(value, label);
						} else {
							appendOption(key, entry);
						}
					});
				} else {
					appendOption(data, data);
				}
				
				console.log('Destination options loaded successfully');
				
			} catch (error) {
				console.error('Error loading destination options:', error);
			}
		}
		
		function populateApprovedTravelersDropdown(approvedRequests) {
			// Reset global variables
			selectedTravelers = [];
			allApprovedTravelers = [];
			
			// Get today's date for filtering expired dates
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			// Extract all travelers from approved requests, include contact field
			window.allApprovedTravelersRequests = approvedRequests;
			approvedRequests.forEach(request => {
				if (request.people && Array.isArray(request.people)) {
					request.people.forEach(person => {
						if (person.name) {
							const departureDate = person.departureDate || '';
							const returnDate = person.returnDate || '';
							
							// Skip expired departure dates
							if (departureDate) {
								const depDate = new Date(departureDate);
								depDate.setHours(0, 0, 0, 0);
								if (depDate < today) {
									return; // Skip - expired
								}
							}
							
							// Check if APPROVED travel order already exists for this traveler
							// Check departure leg - has approved order with same departure date going to same destination
							const hasDepartureOrder = travelOrders.some(order => {
								if (!order.travelers || !Array.isArray(order.travelers)) return false;
								if (order.status !== 'Approved') return false;
								return order.travelers.some(t => 
									t.name === person.name && 
									t.departureDate === departureDate
								);
							});
							
							// Check return leg - has approved order covering the return date
							// Either: 1) same order has matching returnDate, or 2) separate return trip where departureDate = returnDate
							const hasReturnOrder = !returnDate || travelOrders.some(order => {
								if (!order.travelers || !Array.isArray(order.travelers)) return false;
								if (order.status !== 'Approved') return false;
								return order.travelers.some(t => 
									t.name === person.name && 
									(t.returnDate === returnDate || t.departureDate === returnDate)
								);
							});
							
							// Only filter out if BOTH departure and return are covered
							const fullyBooked = hasDepartureOrder && hasReturnOrder;
							
							if (!fullyBooked) {
								const travelerData = {
									id: `${request.firebaseKey}-${person.name}`,
									name: person.name,
									title: person.title || 'No Title',
									contact: person.contact || '',
									departureDate: departureDate,
									returnDate: returnDate,
									destination: request.destination || '',
									travelType: request.travelType || '',
									requestId: request.firebaseKey,
									needsDeparture: !hasDepartureOrder,
									needsReturn: !hasReturnOrder && !!returnDate
								};
								allApprovedTravelers.push(travelerData);
							}
						}
					});
				}
			});
			
			// Populate simulator data
			populateSimulatorData(approvedRequests);
		}
		
		// Schedule Simulator Functions
		function populateSimulatorData(approvedRequests) {
			window.simulatorApprovedRequests = approvedRequests;
		}
		
		function runTravelSimulation() {
			const approvedRequests = window.simulatorApprovedRequests || [];
			const resultsContainer = document.getElementById('simulatorResults');
			const groupedContainer = document.getElementById('groupedTravelersContainer');
			const summaryStats = document.getElementById('summaryStats');
			
			if (!approvedRequests || approvedRequests.length === 0) {
				groupedContainer.innerHTML = '<p style="font-size:.65rem;color:#6b7280;text-align:center;padding:20px;">No approved travel requests available for simulation.</p>';
				resultsContainer.style.display = 'block';
				return;
			}
			
			// Get today's date at midnight for comparison
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			// Extract all travelers with their travel details
			const allTravelers = [];
			approvedRequests.forEach(request => {
				if (request.people && Array.isArray(request.people)) {
					request.people.forEach(person => {
						if (person.name) {
							const departureDate = person.departureDate || request.departureDate || '';
							const returnDate = person.returnDate || request.returnDate || '';
							
							// If return date exists, check if it's expired
							if (returnDate) {
								const retDate = new Date(returnDate);
								retDate.setHours(0, 0, 0, 0);
								if (retDate < today) {
									return; // Skip - return date expired
								}
							} else if (departureDate) {
								// If no return date, check departure date
								const depDate = new Date(departureDate);
								depDate.setHours(0, 0, 0, 0);
								if (depDate < today) {
									return; // Skip - departure date expired
								}
							}
							
							// Check if APPROVED travel order already exists for this traveler
							// Check departure leg
							const hasDepartureOrder = travelOrders.some(order => {
								if (!order.travelers || !Array.isArray(order.travelers)) return false;
								if (order.status !== 'Approved') return false;
								return order.travelers.some(t => 
									t.name === person.name && 
									t.departureDate === departureDate
								);
							});
							
							// Check return leg - either:
							// 1. Same order has returnDate AND returnIncluded is true (or not explicitly false)
							// 2. Separate return trip (departureDate of another order matches this returnDate)
							const hasReturnOrder = !returnDate || travelOrders.some(order => {
								if (!order.travelers || !Array.isArray(order.travelers)) return false;
								if (order.status !== 'Approved') return false;
								return order.travelers.some(t => {
									if (t.name !== person.name) return false;
									// Check if this is a separate return trip order
									if (t.departureDate === returnDate) return true;
									// Check if return is covered in this order (returnIncluded must be true or undefined)
									if (t.returnDate === returnDate && t.returnIncluded !== false) return true;
									return false;
								});
							});
							
							// Skip only if BOTH departure and return are covered
							if (hasDepartureOrder && hasReturnOrder) {
								return;
							}
							
							allTravelers.push({
								name: person.name,
								title: person.title || 'N/A',
								departureDate: departureDate,
								returnDate: returnDate,
								destination: request.destination || '',
								origin: request.origin || '',
								travelType: request.travelType || '',
								tripType: request.tripType || '',
								requestId: request.id || request.firebaseKey,
								needsDeparture: !hasDepartureOrder,
								needsReturn: !hasReturnOrder && !!returnDate
							});
						}
					});
				}
			});
			
			// Check if all travelers were filtered out
			if (allTravelers.length === 0) {
				groupedContainer.innerHTML = '<p style="font-size:.65rem;color:#6b7280;text-align:center;padding:20px;"><i class="fas fa-calendar-times"></i> No upcoming travel dates found. All approved requests have expired departure dates.</p>';
				summaryStats.innerHTML = '';
				resultsContainer.style.display = 'block';
				return;
			}
			
			// Group travelers by departure date and destination
			const departureGroups = {};
			const returnGroups = {};
			
			allTravelers.forEach(traveler => {
				// Group by departure date + destination
				if (traveler.departureDate && traveler.destination) {
					const depKey = `${traveler.departureDate}|${traveler.destination}`;
					if (!departureGroups[depKey]) {
						departureGroups[depKey] = {
							date: traveler.departureDate,
							destination: traveler.destination,
							origin: traveler.origin,
							travelers: []
						};
					}
					departureGroups[depKey].travelers.push(traveler);
				}
				
				// Group by return date + origin (return trips) - only if return date is not expired
				if (traveler.returnDate && traveler.tripType === 'round-trip') {
					const retDate = new Date(traveler.returnDate);
					retDate.setHours(0, 0, 0, 0);
					
					// Only include if return date is today or in the future
					if (retDate >= today) {
						const retKey = `${traveler.returnDate}|${traveler.origin}`;
						if (!returnGroups[retKey]) {
							returnGroups[retKey] = {
								date: traveler.returnDate,
								destination: traveler.origin, // Return to origin
								origin: traveler.destination, // From destination
								travelers: [],
								isReturn: true
							};
						}
						returnGroups[retKey].travelers.push(traveler);
					}
				}
			});
			
			// Calculate optimization stats
			const totalTravelers = allTravelers.length;
			const departureGroupCount = Object.keys(departureGroups).length;
			const returnGroupCount = Object.keys(returnGroups).length;
			const groupsWithMultiple = Object.values(departureGroups).filter(g => g.travelers.length > 1).length +
									   Object.values(returnGroups).filter(g => g.travelers.length > 1).length;
			const potentialTripsOptimized = groupsWithMultiple;
			
			// Display summary stats
			summaryStats.innerHTML = `
				<div style="background:#fff;padding:6px 8px;border-radius:4px;border:1px solid #e2e8f0;">
					<div style="color:#64748b;font-size:.6rem;">Total Travelers</div>
					<div style="color:#0369a1;font-weight:600;">${totalTravelers}</div>
				</div>
				<div style="background:#fff;padding:6px 8px;border-radius:4px;border:1px solid #e2e8f0;">
					<div style="color:#64748b;font-size:.6rem;">Departure Groups</div>
					<div style="color:#0369a1;font-weight:600;">${departureGroupCount}</div>
				</div>
				<div style="background:#fff;padding:6px 8px;border-radius:4px;border:1px solid #e2e8f0;">
					<div style="color:#64748b;font-size:.6rem;">Return Groups</div>
					<div style="color:#0369a1;font-weight:600;">${returnGroupCount}</div>
				</div>
				<div style="background:#dcfce7;padding:6px 8px;border-radius:4px;border:1px solid #86efac;">
					<div style="color:#166534;font-size:.6rem;">Can Share Vehicle</div>
					<div style="color:#166534;font-weight:600;">${potentialTripsOptimized} trips</div>
				</div>
			`;
			
			// Render grouped travelers
			let html = '';
			
			// Store travelers data for selection
			window.simulatorTravelers = allTravelers;
			
			// Future Travelers Table
			html += `
				<div style="background:#fefce8;border:1px solid #fde047;border-radius:6px;padding:10px;margin-bottom:12px;">
					<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
						<div style="font-size:.7rem;font-weight:600;color:#854d0e;">
							<i class="fas fa-users"></i> Future Travelers (${allTravelers.length})
						</div>
					</div>
					<div style="overflow-x:auto;">
						<table style="width:100%;border-collapse:collapse;font-size:.65rem;">
							<thead>
								<tr style="background:#fef3c7;border-bottom:2px solid #fde047;">
									<th style="padding:6px 8px;text-align:center;color:#854d0e;font-weight:600;width:40px;">
										<i class="fas fa-check-square" style="color:#854d0e;"></i>
									</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Request ID</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Traveler</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Job Title</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Destination</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Departure</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Return</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Trip Type</th>
									<th style="padding:6px 8px;text-align:left;color:#854d0e;font-weight:600;">Needs Order</th>
									<th style="padding:6px 8px;text-align:center;color:#854d0e;font-weight:600;">Inc. Return</th>
								</tr>
							</thead>
							<tbody>
								${allTravelers.map((traveler, index) => `
									<tr style="background:${index % 2 === 0 ? '#fff' : '#fffbeb'};border-bottom:1px solid #fde68a;" data-departure="${traveler.departureDate || ''}" data-return="${traveler.returnDate || ''}">
										<td style="padding:6px 8px;text-align:center;">
											<input type="checkbox" class="simulator-traveler-checkbox" data-index="${index}" 
												data-departure="${traveler.departureDate || ''}" 
												data-return="${traveler.returnDate || ''}"
												data-needs-departure="${traveler.needsDeparture ? 'true' : 'false'}"
												data-needs-return="${traveler.needsReturn ? 'true' : 'false'}"
												onchange="handleSimulatorCheckboxChange(this)" style="cursor:pointer;" />
										</td>
										<td style="padding:6px 8px;color:#92400e;font-weight:500;">
											<i class="fas fa-file-alt" style="color:#d97706;"></i> ${traveler.requestId || 'N/A'}
										</td>
										<td style="padding:6px 8px;color:#1f2937;font-weight:500;">
											<i class="fas fa-user" style="color:#ca8a04;"></i> ${traveler.name}
										</td>
										<td style="padding:6px 8px;color:#6b7280;">${traveler.title ? formatJobTitle(traveler.title) : 'N/A'}</td>
										<td style="padding:6px 8px;color:#6b7280;">
											<i class="fas fa-map-marker-alt" style="color:#d97706;"></i> ${traveler.destination || 'N/A'}
										</td>
										<td style="padding:6px 8px;color:#059669;">
											<i class="fas fa-plane-departure" style="color:${traveler.needsDeparture ? '#059669' : '#9ca3af'};"></i> 
											<span style="${traveler.needsDeparture ? '' : 'color:#9ca3af;'}">${traveler.departureDate ? formatDateDisplay(traveler.departureDate) : 'N/A'}</span>
										</td>
										<td style="padding:6px 8px;color:#dc2626;">
											${traveler.returnDate ? `<i class="fas fa-plane-arrival" style="color:${traveler.needsReturn ? '#dc2626' : '#9ca3af'};"></i> <span style="${traveler.needsReturn ? '' : 'color:#9ca3af;'}">${formatDateDisplay(traveler.returnDate)}</span>` : '—'}
										</td>
										<td style="padding:6px 8px;color:#7c3aed;">
											<i class="fas fa-route" style="color:#7c3aed;"></i> ${traveler.tripType === 'round-trip' ? 'Round Trip' : traveler.tripType === 'one-way' ? 'One Way' : 'N/A'}
										</td>
										<td style="padding:6px 8px;">
											${traveler.needsDeparture && traveler.needsReturn ? '<span style="background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;font-size:.6rem;">Both</span>' : 
											  traveler.needsDeparture ? '<span style="background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px;font-size:.6rem;">Departure</span>' : 
											  traveler.needsReturn ? '<span style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:4px;font-size:.6rem;">Return</span>' : '—'}
										</td>
										<td style="padding:6px 8px;text-align:center;">
											${traveler.returnDate && traveler.needsReturn ? `<input type="checkbox" class="include-return-checkbox" data-index="${index}" data-return="${traveler.returnDate}" checked onchange="handleIncludeReturnChange(this)" style="cursor:pointer;" title="Include return trip in this order" />` : '<span style="color:#9ca3af;">—</span>'}
										</td>
									</tr>
								`).join('')}
							</tbody>
						</table>
					</div>
				</div>
			`;
			
			// Return groups
			const sortedReturnGroups = Object.values(returnGroups).sort((a, b) => 
				new Date(a.date) - new Date(b.date)
			);
			
			if (sortedReturnGroups.length > 0) {
				html += '<div style="font-size:.7rem;font-weight:600;color:#334155;margin:12px 0 8px;"><i class="fas fa-plane-arrival"></i> Return Groups</div>';
				
				sortedReturnGroups.forEach(group => {
					const canOptimize = group.travelers.length > 1;
					const borderColor = canOptimize ? '#22c55e' : '#e2e8f0';
					const bgColor = canOptimize ? '#f0fdf4' : '#fff';
					const badge = canOptimize ? `<span style="background:#22c55e;color:#fff;font-size:.55rem;padding:2px 6px;border-radius:10px;margin-left:5px;"><i class="fas fa-check"></i> Can share</span>` : '';
					
					html += `
						<div style="background:${bgColor};border:1px solid ${borderColor};border-radius:6px;padding:10px;margin-bottom:8px;">
							<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
								<div style="font-size:.7rem;font-weight:600;color:#334155;">
									<i class="fas fa-calendar"></i> ${formatDateDisplay(group.date)} 
									<span style="color:#6b7280;font-weight:400;">← ${group.origin} (Return)</span>
									${badge}
								</div>
								<button type="button" class="btn btn-sm" onclick="selectGroupTravelers(${JSON.stringify(group.travelers).replace(/"/g, '&quot;')})" 
									style="font-size:.6rem;padding:3px 8px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;">
									<i class="fas fa-plus"></i> Add All
								</button>
							</div>
							<div style="display:flex;flex-wrap:wrap;gap:4px;">
								${group.travelers.map(t => `
									<span style="background:#fff;border:1px solid #d1d5db;padding:3px 8px;border-radius:4px;font-size:.6rem;">
										<i class="fas fa-user" style="color:#6b7280;"></i> ${t.name}
										<span style="color:#9ca3af;">(${t.title})</span>
									</span>
								`).join('')}
							</div>
						</div>
					`;
				});
			}
			
			if (!html) {
				html = '<p style="font-size:.65rem;color:#6b7280;text-align:center;padding:20px;">No groupings found. Travelers may have different schedules or destinations.</p>';
			}
			
			groupedContainer.innerHTML = html;
			resultsContainer.style.display = 'block';
		}
		
		function formatDateDisplay(dateStr) {
			if (!dateStr) return 'N/A';
			const date = new Date(dateStr);
			return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
		}
		
		// Simulator checkbox functions
		function handleSimulatorCheckboxChange(checkbox) {
			const travelers = window.simulatorTravelers || [];
			const index = parseInt(checkbox.dataset.index);
			const traveler = travelers[index];
			
			if (checkbox.checked && traveler) {
				// Immediately add traveler when checked
				const travelerId = `${traveler.requestId}-${traveler.name}`;
				if (!selectedTravelers.some(t => t.id === travelerId)) {
					// Check if the include return checkbox is checked for this traveler
					const includeReturnCheckbox = document.querySelector(`.include-return-checkbox[data-index="${index}"]`);
					const returnIncluded = includeReturnCheckbox ? includeReturnCheckbox.checked : (traveler.needsReturn && !!traveler.returnDate);
					
					const travelerData = {
						id: travelerId,
						name: traveler.name,
						title: traveler.title,
						departureDate: traveler.departureDate,
						returnDate: traveler.returnDate,
						destination: traveler.destination,
						origin: traveler.origin,
						travelType: traveler.travelType,
						tripType: traveler.tripType,
						requestId: traveler.requestId,
						returnIncluded: returnIncluded
					};
					selectedTravelers.push(travelerData);
					updateTravelersDisplay();
					updateTravelersData();
					
					// Auto-fill form fields (only on first traveler or update fields)
					if (selectedTravelers.length === 1) {
						autoFillTravelOrderFields(travelerData);
					}
				}
			} else if (!checkbox.checked && traveler) {
				// Remove traveler when unchecked
				const travelerId = `${traveler.requestId}-${traveler.name}`;
				selectedTravelers = selectedTravelers.filter(t => t.id !== travelerId);
				updateTravelersDisplay();
				updateTravelersData();
				
				// If no travelers left, optionally clear fields
				if (selectedTravelers.length === 0) {
					// Reset all checkboxes to enabled state
					const allCheckboxes = document.querySelectorAll('.simulator-traveler-checkbox');
					allCheckboxes.forEach(cb => {
						cb.disabled = false;
						cb.closest('tr').style.opacity = '1';
					});
					return;
				} else {
					// Update auto-fill with first remaining traveler
					autoFillTravelOrderFields(selectedTravelers[0]);
				}
			}
			
			// Now handle date compatibility for remaining checkboxes
			const checkboxes = document.querySelectorAll('.simulator-traveler-checkbox');
			const checkedBoxes = document.querySelectorAll('.simulator-traveler-checkbox:checked');
			
			if (checkedBoxes.length === 0) {
				// No checkboxes checked - enable all
				checkboxes.forEach(cb => {
					cb.disabled = false;
					cb.closest('tr').style.opacity = '1';
				});
				return;
			}
			
			// Get the reference dates from the first checked checkbox
			const firstChecked = checkedBoxes[0];
			const refDeparture = firstChecked.dataset.departure || '';
			const refReturn = firstChecked.dataset.return || '';
			
			// Enable/disable checkboxes based on date matching
			checkboxes.forEach(cb => {
				if (cb.checked) {
					cb.disabled = false;
					cb.closest('tr').style.opacity = '1';
					return;
				}
				
				const cbDeparture = cb.dataset.departure || '';
				const cbReturn = cb.dataset.return || '';
				
				// Check if dates are compatible
				const isCompatible = areDatesCompatible(refDeparture, refReturn, cbDeparture, cbReturn);
				
				cb.disabled = !isCompatible;
				cb.closest('tr').style.opacity = isCompatible ? '1' : '0.4';
			});
		}
		
		// Handle Include Return checkbox change
		function handleIncludeReturnChange(checkbox) {
			const index = parseInt(checkbox.dataset.index);
			const travelers = window.simulatorTravelers || [];
			const traveler = travelers[index];
			
			if (traveler) {
				// Update the traveler's includeReturn flag
				traveler.includeReturn = checkbox.checked;
				
				// Also update the selected travelers if this traveler is selected
				const travelerId = `${traveler.requestId}-${traveler.name}`;
				const selectedTraveler = selectedTravelers.find(t => t.id === travelerId);
				if (selectedTraveler) {
					selectedTraveler.returnIncluded = checkbox.checked;
					updateTravelersData();
				}
			}
		}
		
		function areDatesCompatible(refDep, refRet, cbDep, cbRet) {
			// Both have same departure and same return
			if (refDep && cbDep && refDep === cbDep && refRet === cbRet) {
				return true;
			}
			// Both have same departure, neither has return
			if (refDep && cbDep && refDep === cbDep && !refRet && !cbRet) {
				return true;
			}
			// Both have same return, neither has departure
			if (refRet && cbRet && refRet === cbRet && !refDep && !cbDep) {
				return true;
			}
			// Same departure date only (return dates may differ or be empty)
			if (refDep && cbDep && refDep === cbDep) {
				return true;
			}
			return false;
		}
		
		function toggleAllSimulatorTravelers(checked) {
			const checkboxes = document.querySelectorAll('.simulator-traveler-checkbox:not(:disabled)');
			checkboxes.forEach(cb => {
				cb.checked = checked;
				handleSimulatorCheckboxChange(cb);
			});
		}
		
		function selectAllSimulatorTravelers() {
			// First, uncheck all and reset
			const allCheckboxes = document.querySelectorAll('.simulator-traveler-checkbox');
			allCheckboxes.forEach(cb => {
				cb.checked = false;
				cb.disabled = false;
				cb.closest('tr').style.opacity = '1';
			});
			
			// Then check all (they'll all be compatible since nothing is selected yet)
			// But we need to select only compatible ones - select by first traveler's dates
			if (allCheckboxes.length > 0) {
				const firstCb = allCheckboxes[0];
				firstCb.checked = true;
				handleSimulatorCheckboxChange(firstCb);
				
				// Now check all remaining enabled checkboxes
				document.querySelectorAll('.simulator-traveler-checkbox:not(:disabled)').forEach(cb => {
					cb.checked = true;
				});
			}
		}
		
		function addSelectedSimulatorTravelers() {
			const checkboxes = document.querySelectorAll('.simulator-traveler-checkbox:checked');
			const travelers = window.simulatorTravelers || [];
			let addedCount = 0;
			let firstTraveler = null;
			
			checkboxes.forEach(cb => {
				const index = parseInt(cb.dataset.index);
				const traveler = travelers[index];
				if (traveler) {
					const travelerId = `${traveler.requestId}-${traveler.name}`;
					if (!selectedTravelers.some(t => t.id === travelerId)) {
						// Check if the include return checkbox is checked for this traveler
						const includeReturnCheckbox = document.querySelector(`.include-return-checkbox[data-index="${index}"]`);
						const returnIncluded = includeReturnCheckbox ? includeReturnCheckbox.checked : (traveler.needsReturn && !!traveler.returnDate);
						
						const travelerData = {
							id: travelerId,
							name: traveler.name,
							title: traveler.title,
							departureDate: traveler.departureDate,
							returnDate: traveler.returnDate,
							destination: traveler.destination,
							origin: traveler.origin,
							travelType: traveler.travelType,
							tripType: traveler.tripType,
							requestId: traveler.requestId,
							returnIncluded: returnIncluded
						};
						selectedTravelers.push(travelerData);
						addedCount++;
						
						// Store first traveler for auto-fill
						if (!firstTraveler) {
							firstTraveler = travelerData;
						}
					}
				}
			});
			
			if (addedCount > 0) {
				updateTravelersDisplay();
				updateTravelersData();
				
				// Auto-fill form fields based on selected travelers
				autoFillTravelOrderFields(firstTraveler);
				
				showToast(`Added ${addedCount} traveler${addedCount > 1 ? 's' : ''} to the order`, 'success');
				
				// Uncheck all checkboxes and reset disabled states after adding
				const allCheckboxes = document.querySelectorAll('.simulator-traveler-checkbox');
				allCheckboxes.forEach(cb => {
					cb.checked = false;
					cb.disabled = false;
					cb.closest('tr').style.opacity = '1';
				});
			} else {
				showToast('No new travelers to add (already selected or none checked)', 'info');
			}
		}
		
		function autoFillTravelOrderFields(traveler) {
			if (!traveler) return;
			
			// Auto-fill Origin
			const originField = document.getElementById('orderOriginField');
			if (originField && traveler.origin) {
				originField.value = traveler.origin;
			}
			
			// Auto-fill Destination
			const destinationField = document.getElementById('orderDestinationField');
			if (destinationField && traveler.destination) {
				destinationField.value = traveler.destination;
			}
			
			// Auto-fill Departure Date
			const departureDateField = document.getElementById('orderDepartureDateField');
			if (departureDateField && traveler.departureDate) {
				// Format date for display (e.g., "Dec 29, 2025")
				const depDate = new Date(traveler.departureDate);
				const formattedDepDate = depDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
				departureDateField.value = formattedDepDate;
				departureDateField.dataset.rawDate = traveler.departureDate; // Store raw date for form submission
			}
			
			// Auto-fill Return Date
			const returnDateField = document.getElementById('orderReturnDateField');
			const returnDateContainer = document.getElementById('returnDateContainer');
			if (returnDateField && traveler.returnDate) {
				// Format date for display
				const retDate = new Date(traveler.returnDate);
				const formattedRetDate = retDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
				returnDateField.value = formattedRetDate;
				returnDateField.dataset.rawDate = traveler.returnDate; // Store raw date for form submission
				if (returnDateContainer) returnDateContainer.style.display = 'block';
			} else {
				if (returnDateField) {
					returnDateField.value = '';
					returnDateField.dataset.rawDate = '';
				}
				if (returnDateContainer) returnDateContainer.style.display = 'none';
			}
			
			// Auto-fill Trip Type
			const tripTypeField = document.getElementById('orderTripTypeField');
			if (tripTypeField && traveler.tripType) {
				// Convert trip type to display text
				const tripTypeDisplay = traveler.tripType === 'round-trip' ? 'Round Trip' : 
				                        traveler.tripType === 'one-way' ? 'One Way' : traveler.tripType;
				tripTypeField.value = tripTypeDisplay;
			} else if (tripTypeField && traveler.returnDate) {
				// If no tripType but has return date, assume round-trip
				tripTypeField.value = 'Round Trip';
			} else if (tripTypeField && !traveler.returnDate) {
				// If no return date, assume one-way
				tripTypeField.value = 'One Way';
			}
			
			// Refresh vehicle options after dates are filled
			setTimeout(() => {
				loadVehicleOptions();
			}, 100);
		}
		
		function selectGroupTravelers(travelers) {
			let firstTraveler = null;
			
			travelers.forEach(traveler => {
				// Check if traveler is already selected
				const travelerId = `${traveler.requestId}-${traveler.name}`;
				if (!selectedTravelers.some(t => t.id === travelerId)) {
					const travelerData = {
						id: travelerId,
						name: traveler.name,
						title: traveler.title,
						departureDate: traveler.departureDate,
						returnDate: traveler.returnDate,
						destination: traveler.destination,
						origin: traveler.origin,
						travelType: traveler.travelType,
						tripType: traveler.tripType,
						requestId: traveler.requestId,
						returnIncluded: traveler.needsReturn && !!traveler.returnDate
					};
					selectedTravelers.push(travelerData);
					
					// Store first traveler for auto-fill
					if (!firstTraveler) {
						firstTraveler = travelerData;
					}
				}
			});
			
			updateTravelersDisplay();
			updateTravelersData();
			
			// Auto-fill form fields based on selected travelers
			if (firstTraveler) {
				autoFillTravelOrderFields(firstTraveler);
			}
			
			// Show success message
			const count = travelers.length;
			showToast(`Added ${count} traveler${count > 1 ? 's' : ''} to the order`, 'success');
		}
		
		function showToast(message, type = 'info') {
			// Create toast if it doesn't exist
			let toast = document.getElementById('simulatorToast');
			if (!toast) {
				toast = document.createElement('div');
				toast.id = 'simulatorToast';
				toast.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:10px 16px;border-radius:6px;font-size:.75rem;z-index:10000;transition:opacity 0.3s;';
				document.body.appendChild(toast);
			}
			
			toast.textContent = message;
			toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
			toast.style.color = '#fff';
			toast.style.opacity = '1';
			
			setTimeout(() => {
				toast.style.opacity = '0';
			}, 3000);
		}
		
		// Initialize simulator button event listener
		document.addEventListener('DOMContentLoaded', function() {
			const simulatorBtn = document.getElementById('runSimulatorBtn');
			if (simulatorBtn) {
				simulatorBtn.addEventListener('click', runTravelSimulation);
			}
		});

		function addTraveler() {
			// No-op: Dropdown has been replaced by simulator section
			// Travelers are now added via addSelectedSimulatorTravelers()
		}
		
		function removeTraveler(travelerId) {
			selectedTravelers = selectedTravelers.filter(t => t.id !== travelerId);
			updateTravelersDisplay();
			updateTravelersData();
		}
		
		function updateTravelersDisplay() {
			// No-op: Selected travelers are now shown as checked checkboxes in the table
			// No separate display needed
		}
		
		function updateTravelersData() {
			// Store selected travelers data globally for form submission
			window.selectedTravelersData = selectedTravelers;
		}
		
		function filterTravelersByDates() {
			// No-op: Dropdown has been replaced by simulator section
			// This function is kept for backward compatibility with event listeners
		}
		
		// Function to filter out travelers who are already booked during the selected period
		function filterOutBookedTravelers(travelers, departureDate, returnDate) {
			if (!departureDate || !currentCompanyId) return travelers;
			
			try {
				// Get existing travel orders synchronously from the global array
				const bookedTravelerNames = new Set();
				
				// Convert dates to Date objects for comparison
				const requestDeparture = new Date(departureDate);
				const requestReturn = returnDate ? new Date(returnDate) : new Date(departureDate);
				
				// Check each existing travel order
				travelOrders.forEach(order => {
					// Skip the order being edited (if any)
					if (window.editingOrderKey && order.firebaseKey === window.editingOrderKey) {
						return;
					}
					
					// Skip cancelled orders
					if (order.status === 'Cancelled') {
						return;
					}
					
					// Check if dates overlap
					if (order.departureDate) {
						const orderDeparture = new Date(order.departureDate);
						const orderReturn = order.returnDate ? new Date(order.returnDate) : new Date(order.departureDate);
						
						// Check for date overlap
						if (requestDeparture <= orderReturn && requestReturn >= orderDeparture) {
							// Add all travelers from this overlapping order to the blocked list
							if (order.travelers && Array.isArray(order.travelers)) {
								order.travelers.forEach(traveler => {
									if (traveler.name) {
										bookedTravelerNames.add(traveler.name.trim().toLowerCase());
									}
								});
							}
						}
					}
				});
				
				// Filter out booked travelers
				return travelers.filter(traveler => {
					const travelerName = traveler.name.trim().toLowerCase();
					return !bookedTravelerNames.has(travelerName);
				});
				
			} catch (error) {
				console.error('Error filtering booked travelers:', error);
				return travelers; // Return original list if error occurs
			}
		}
		
		function showApprovedTravelersSelector(approvedRequests) {
			try {
				const modal = document.getElementById('createTravelOrderModal');
				const container = document.getElementById('selectedTravelersContainer');
				
				if (!modal || !container) {
					console.error('Modal or container element not found');
					alert('Modal elements not found. Please refresh the page and try again.');
					return;
				}
				
				console.log('Building traveler selector for', approvedRequests.length, 'approved requests');
				
				// Validate that requests have people array
				const validRequests = approvedRequests.filter(req => req.people && Array.isArray(req.people) && req.people.length > 0);
				
				if (validRequests.length === 0) {
					alert('No valid travelers found in approved requests.');
					return;
				}
				
				// Create traveler selection interface
				container.innerHTML = `
					<div style="margin-bottom: 1rem;">
						<h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Select Approved Travelers:</h4>
						<div id="approvedTravelersSelector" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem;">
							${validRequests.map(req => `
								<div class="request-group" style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb;">
									<div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem;">
										${req.destination || 'No destination'} - ${req.travelType || 'No type'} (${req.id || 'No ID'})
									</div>
									${req.people.map((person, index) => `
										<label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; cursor: pointer;">
											<input type="checkbox" 
												class="traveler-checkbox" 
												data-request-key="${req.firebaseKey || ''}"
												data-request-id="${req.id || ''}"
												data-person-index="${index}"
												data-destination="${req.destination || ''}"
												data-travel-type="${req.travelType || ''}"
												data-purpose="${req.purpose || ''}"
												data-departure="${person.departureDate || ''}"
												data-return="${person.returnDate || ''}"
												style="margin: 0;">
											<span style="font-size: 0.8rem;">
												${person.name || 'No name'} - ${person.title || 'No Title'} 
												(${person.departureDate || 'No departure'} to ${person.returnDate || 'No return'})
											</span>
										</label>
									`).join('')}
								</div>
							`).join('')}
						</div>
						<button type="button" id="confirmTravelerSelection" class="btn btn-primary" style="margin-top: 0.5rem;">
							Confirm Selection
						</button>
					</div>
				`;
				
				// Add event listener for confirm button
				const confirmBtn = document.getElementById('confirmTravelerSelection');
				if (confirmBtn) {
					confirmBtn.addEventListener('click', confirmTravelerSelection);
				}
				
				// Show modal
				modal.classList.add('show');
				modal.setAttribute('aria-hidden', 'false');
				
			} catch (error) {
				console.error('Error in showApprovedTravelersSelector:', error);
				alert('Error displaying traveler selection. Please try again.');
			}
		}
		
		function confirmTravelerSelection() {
			const checkboxes = document.querySelectorAll('.traveler-checkbox:checked');
			
			if (checkboxes.length === 0) {
				alert('Please select at least one traveler.');
				return;
			}
			
			   // Collect selected travelers data, including contact field
			   const selectedTravelers = Array.from(checkboxes).map(checkbox => {
				   const requestKey = checkbox.dataset.requestKey;
				   const requestId = checkbox.dataset.requestId;
				   const personIndex = parseInt(checkbox.dataset.personIndex);
				   // Use allApprovedTravelers to get the contact field for the traveler
				   const travelerId = `${requestKey}-${checkbox.nextElementSibling.textContent.split(' - ')[0]}`;
				   const traveler = allApprovedTravelers.find(t => t.id === travelerId);
				   return {
					   requestKey,
					   requestId,
					   personIndex,
					   name: traveler && traveler.name ? traveler.name : checkbox.nextElementSibling.textContent.split(' - ')[0],
					   title: traveler && traveler.title ? traveler.title : (checkbox.nextElementSibling.textContent.split(' - ')[1]?.split(' (')[0] || ''),
					   contact: traveler && traveler.contact ? traveler.contact : '',
					   destination: checkbox.dataset.destination,
					   travelType: checkbox.dataset.travelType,
					   purpose: checkbox.dataset.purpose,
					   departureDate: checkbox.dataset.departure,
					   returnDate: checkbox.dataset.return,
					   returnIncluded: true // By default include return when selected manually
				   };
			   });
			
			// Pre-fill the form with selected data
			populateTravelOrderForm(selectedTravelers);
		}
		
		function populateTravelOrderForm(travelers) {
			// Get common data from first traveler
			const firstTraveler = travelers[0];
			
			// Populate form fields (Order ID is already set when modal opens)
			// Set destination dropdown value
			const destinationField = document.getElementById('orderDestinationField');
			if (destinationField && firstTraveler.destination) {
				destinationField.value = firstTraveler.destination;
			}
			
			document.getElementById('orderDepartureDateField').value = firstTraveler.departureDate;
			document.getElementById('orderReturnDateField').value = firstTraveler.returnDate;
			
			// Display selected travelers with same styling as travel request details
			const container = document.getElementById('selectedTravelersContainer');
			container.innerHTML = `
				<div style="display:flex; flex-direction:column; gap:.6rem;">
					${travelers.map((traveler, index) => `
						<div style="display:grid; grid-template-columns:1fr auto; gap:.5rem; align-items:center; padding:.5rem; background:#ffffff; border:1px solid #e2e8f0; border-radius:6px;">
							<div style="display:flex; flex-direction:column; gap:.2rem;">
								<div style="font-weight:600; font-size:.65rem;">${traveler.name}</div>
								<div style="font-size:.6rem; color:#64748b;">${traveler.title || 'No Title'}</div>
								<div style="font-size:.55rem; color:#94a3b8;">
									${traveler.departureDate || 'No departure'} to ${traveler.returnDate || 'No return'}
								</div>
							</div>
							<button type="button" onclick="removeTraveler(${index})" style="background:#ef4444; color:white; border:none; padding:.25rem .5rem; border-radius:4px; font-size:.55rem; cursor:pointer;">
								Remove
							</button>
						</div>
					`).join('')}
				</div>
			`;
			
			// Store travelers data for form submission
			window.selectedTravelersData = travelers;
		}
		
		function removeTraveler(index) {
			if (window.selectedTravelersData) {
				window.selectedTravelersData.splice(index, 1);
				populateTravelOrderForm(window.selectedTravelersData);
			}
		}
		
		function closeTravelOrderModal() {
			const modal = document.getElementById('createTravelOrderModal');
			modal.classList.remove('show');
			modal.setAttribute('aria-hidden', 'true');
			
			// Clear form and reset state
			clearTravelOrderForm();
		}
		
		function closeViewTravelOrderModal() {
			const modal = document.getElementById('viewTravelOrderModal');
			modal.classList.add('hidden');
			modal.classList.remove('show');
			modal.setAttribute('aria-hidden', 'true');
			
			// Clear current viewing order key
			window.currentViewingOrderKey = null;
		}

		// Load and display stamp on approved travel order
		async function loadAndDisplayOrderStamp() {
			try {
				const user = window.authManager?.currentUser;
				if (!user || !user.companyId) return;
				
				const snap = await firebase.database().ref(`companies/${user.companyId}/travelSettings/travelStamp`).once('value');
				const stampUrl = snap.val();
				
				const stampSection = document.getElementById('travelOrderStampSection');
				const stampImg = document.getElementById('travelOrderStampImg');
				
				if (stampUrl && stampSection && stampImg) {
					stampImg.src = stampUrl;
					stampSection.style.display = 'block';
				}
			} catch (error) {
				console.warn('Could not load travel stamp:', error);
			}
		}

		// Check if current user has permission to see approval buttons
		async function checkTravelApprovalButtonsPermission() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return false;
			
			try {
				const snap = await firebase.database().ref(`companies/${user.companyId}/travelSettings/accessControl/${user.id || user.uid}`).once('value');
				const p = snap.val() || {};
				return p.canSeeApprovalButtons === true;
			} catch (error) {
				console.error('Error checking approval buttons permission:', error);
				return false;
			}
		}

		// Approve travel order
		async function approveTravelOrder(orderKey) {
			if (!confirm('Are you sure you want to approve this travel order?')) return;
			
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) {
				alert('User not authenticated');
				return;
			}

			try {
				const approverName = user.displayName || user.name || user.email || 'Unknown';
				const approverJobTitle = user.jobTitle || user.title || user.position || '';
				const approverSignature = user.signature || user.signatureUrl || '';
				const approvalData = {
					status: 'Approved',
					approvedBy: approverName,
					approvedById: user.id || user.uid,
					approverJobTitle: approverJobTitle,
					approverSignature: approverSignature,
					approvedAt: new Date().toISOString()
				};

				await firebase.database().ref(`companies/${user.companyId}/travelOrders/${orderKey}`).update(approvalData);

				window.notificationManager?.addNotification({ type: 'success', message: 'Travel order approved successfully' });
				
				closeViewTravelOrderModal();
				renderTravelOrders(); // Refresh the list
			} catch (error) {
				console.error('Error approving travel order:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to approve travel order' });
			}
		}

		// Reject travel order
		async function rejectTravelOrder(orderKey) {
			const reason = prompt('Please enter the reason for rejection:');
			if (reason === null) return; // User cancelled
			
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) {
				alert('User not authenticated');
				return;
			}

			try {
				const rejecterName = user.displayName || user.name || user.email || 'Unknown';
				const rejecterJobTitle = user.jobTitle || user.title || user.position || '';
				const rejecterSignature = user.signature || user.signatureUrl || '';
				const rejectionData = {
					status: 'Rejected',
					rejectedBy: rejecterName,
					rejectedById: user.id || user.uid,
					rejecterJobTitle: rejecterJobTitle,
					rejecterSignature: rejecterSignature,
					rejectedAt: new Date().toISOString(),
					rejectionReason: reason || 'No reason provided'
				};

				await firebase.database().ref(`companies/${user.companyId}/travelOrders/${orderKey}`).update(rejectionData);

				window.notificationManager?.addNotification({ type: 'success', message: 'Travel order rejected' });
				
				closeViewTravelOrderModal();
				renderTravelOrders(); // Refresh the list
			} catch (error) {
				console.error('Error rejecting travel order:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to reject travel order' });
			}
		}
		
		function clearTravelOrderForm() {
			// Reset the form
			const form = document.getElementById('travelOrderForm');
			if (form) {
				form.reset();
			}
			
			// Clear selected travelers
			window.selectedTravelersData = [];
			selectedTravelers = [];
			
			// Hide and clear travelers container
			const selectedTravelersContainer = document.getElementById('selectedTravelersContainer');
			const selectedTravelersTags = document.getElementById('selectedTravelersTags');
			
			if (selectedTravelersContainer) {
				selectedTravelersContainer.style.display = 'none';
			}
			if (selectedTravelersTags) {
				selectedTravelersTags.innerHTML = '';
			}
			
			// Reset dropdown
			const dropdown = document.getElementById('approvedTravelersDropdown');
			if (dropdown) {
				dropdown.selectedIndex = 0;
			}
			
			// Generate new Order ID for next time
			const orderIdField = document.getElementById('orderIdField');
			if (orderIdField) {
				orderIdField.value = 'TO-' + Date.now();
			}
			
			// Reset modal title and button text for create mode
			const modalTitle = document.querySelector('#createTravelOrderModal .modal-header h2');
			const submitButton = document.querySelector('#createTravelOrderModal .btn-primary');
			
			if (modalTitle) modalTitle.textContent = 'Create Travel Order';
			if (submitButton) submitButton.textContent = 'Create Travel Order';
			
			// Reset editing mode
			window.editingMode = false;
			window.editingOrderKey = null;
		}
		
		async function handleTravelOrderSubmit(e) {
			e.preventDefault();
			
			if (!window.selectedTravelersData || window.selectedTravelersData.length === 0) {
				alert('No travelers selected. Please select travelers first.');
				return;
			}
			
			try {
				const formData = new FormData(e.target);
				const database = firebase.database();
				
				// Get company ID from auth manager
				const companyId = authManager?.currentUser?.companyId || currentCompanyId;
				if (!companyId) {
					alert('Company not found. Please refresh the page and try again.');
					return;
				}
				
				// Get selected vehicle information
				const vehicleSelect = document.getElementById('orderVehicleField');
				const selectedVehicleId = vehicleSelect.value;
				const selectedVehicleOption = vehicleSelect.selectedOptions[0];
				const vehicleInfo = selectedVehicleId ? {
					vehicleId: selectedVehicleId,
					plateNumber: selectedVehicleOption?.dataset.plateNumber || '',
					vehicleName: selectedVehicleOption?.dataset.vehicleName || '',
					vehicleType: selectedVehicleOption?.dataset.vehicleType || ''
				} : null;
				
				const travelOrder = {
					orderId: document.getElementById('metaOrderId')?.textContent || window.currentTravelOrderId || `TO-${Date.now().toString().slice(-6)}`,
					status: document.getElementById('metaOrderStatus')?.textContent || 'Draft',
					origin: document.getElementById('orderOriginField').value,
					destination: document.getElementById('orderDestinationField').value,
					driver: document.getElementById('orderDriverField').value,
					driverContact: document.getElementById('orderDriverContactField').value,
					departureDate: document.getElementById('orderDepartureDateField').dataset.rawDate || document.getElementById('orderDepartureDateField').value,
					returnDate: document.getElementById('orderReturnDateField').dataset.rawDate || document.getElementById('orderReturnDateField').value,
					notes: document.getElementById('orderNotesField').value,
					vehicle: vehicleInfo,
					travelers: window.selectedTravelersData,
					createdBy: authManager?.getUserDisplayName() || 'Current User',
					updatedAt: new Date().toISOString(),
					companyId: companyId
				};
				
				// Check if we're editing or creating
				if (window.editingMode && window.editingOrderKey) {
					// Update existing order
					const orderRef = database.ref(`companies/${companyId}/travelOrders/${window.editingOrderKey}`);
					
					// Get existing data to preserve createdAt
					const existingSnapshot = await orderRef.once('value');
					const existingData = existingSnapshot.val();
					
					if (existingData) {
						travelOrder.createdAt = existingData.createdAt; // Preserve original creation date
					} else {
						travelOrder.createdAt = new Date().toISOString();
					}
					
					await orderRef.update(travelOrder);
					alert('Travel order updated successfully!');
				} else {
					// Create new order
					travelOrder.createdAt = new Date().toISOString();
					await database.ref(`companies/${companyId}/travelOrders`).push(travelOrder);
					alert('Travel order created successfully!');
				}
				
				// Reset editing mode
				window.editingMode = false;
				window.editingOrderKey = null;
				
				// Close modal and refresh table
				closeTravelOrderModal();
				
				// Refresh the travel orders table to show the changes
				await renderTravelOrders();
				
			} catch (error) {
				console.error('Error saving travel order:', error);
				alert('Error saving travel order. Please try again.');
			}
		}
		
		// Travel Order Action Functions
		async function viewTravelOrder(orderKey) {
			try {
				// Find the order in the travelOrders array
				const order = travelOrders.find(o => o.firebaseKey === orderKey);
				if (!order) {
					alert('Travel order not found');
					return;
				}
				
				// Store current order key for editing
				window.currentViewingOrderKey = orderKey;
				
				// Fetch company users to get signature URLs
				const user = window.authManager?.currentUser;
				let companyUsers = {};
				if (user && user.companyId) {
					try {
						const usersSnap = await firebase.database().ref(`companies/${user.companyId}/users`).once('value');
						companyUsers = usersSnap.val() || {};
					} catch (e) {
						console.warn('Could not fetch company users for signatures:', e);
					}
				}
				
				// Helper functions
				const esc = (v) => {
					if (v === undefined || v === null || v === '') return '';
					return String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
				};
				const fmt = (v) => (v === undefined || v === null || v === '') ? '<span style="opacity:.5;">—</span>' : esc(v);
				const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : '—';
				
				// Helper to get signature URL from companyUsers
				const getSignatureUrl = (userId, userName) => {
					// First try direct from saved approverSignature/rejecterSignature
					if (order.approverSignature && order.status === 'Approved') return order.approverSignature;
					if (order.rejecterSignature && order.status === 'Rejected') return order.rejecterSignature;
					
					// Try to get from companyUsers by ID
					if (userId && companyUsers[userId]) {
						const sigUrl = companyUsers[userId].signatureUrl || companyUsers[userId].signature || '';
						if (sigUrl) return sigUrl;
					}
					
					// Fallback: try to find by name
					if (userName) {
						const nameLower = userName.toLowerCase();
						for (const [uid, userData] of Object.entries(companyUsers)) {
							const uName = (userData.name || userData.displayName || userData.fullName || '').toLowerCase();
							if (uName === nameLower && (userData.signatureUrl || userData.signature)) {
								return userData.signatureUrl || userData.signature;
							}
						}
					}
					
					return '';
				};
				
				// Get company info for header
				const companyName = window.authManager?.currentCompany?.companyName || window.authManager?.currentUser?.companyName || 'Company';
				const companyLogo = window.authManager?.currentCompany?.logo || window.authManager?.currentCompany?.logoUrl || '';
				const logoInitials = companyName.split(' ').filter(w=>w).map(w=>w[0]).join('').substring(0,2).toUpperCase() || 'CO';
				
				// Generate SVG initials if no logo available
				const generateInitialsSVG = (initials) => {
					const svg = `<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="8" fill="#f8fafc"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="32">${initials}</text></svg>`;
					return 'data:image/svg+xml;base64,' + btoa(svg);
				};
				const logoSrc = companyLogo || generateInitialsSVG(logoInitials);
				
				// Status badge helper
				const statusBadge = (status) => {
					const s = (status || 'draft').toLowerCase().replace(/\s+/g, '');
					return `<span class="status-chip ${s}">${esc(status || 'Draft')}</span>`;
				};
				
				// Build travelers table rows
				let travelerRows = '';
				if (Array.isArray(order.travelers) && order.travelers.length) {
					order.travelers.forEach((t, i) => {
						const depDate = t.departureDate ? new Date(t.departureDate).toLocaleDateString() : '—';
						const retDate = t.returnDate ? new Date(t.returnDate).toLocaleDateString() : '—';
						
						// Check if departure is already covered by another travel order
						const departureAlreadyBooked = t.departureDate && travelOrders.some(otherOrder => {
							if (otherOrder.firebaseKey === orderKey) return false; // Skip current order
							if (!otherOrder.travelers || !Array.isArray(otherOrder.travelers)) return false;
							if (otherOrder.status === 'Cancelled') return false;
							return otherOrder.travelers.some(ot => 
								ot.name === t.name && 
								ot.departureDate === t.departureDate
							);
						});
						const depDateStyle = departureAlreadyBooked ? 'color:#9ca3af;' : '';
						const depDateTitle = departureAlreadyBooked ? ' title="Departure already covered by another travel order"' : '';
						const depDateSuffix = departureAlreadyBooked ? ' <span style="color:#10b981;font-size:.6rem;font-weight:500;"><i class="fas fa-check-circle"></i> Booked</span>' : '';
						
						// Check if return is not included in this order
						const returnNotIncluded = t.returnDate && t.returnIncluded === false;
						const retDateStyle = returnNotIncluded ? 'color:#dc2626;font-weight:600;' : '';
						const retDateTitle = returnNotIncluded ? ' title="Return trip not included in this order - needs separate return travel order"' : '';
						travelerRows += `
							<tr>
								<td>${i + 1}</td>
								<td>${fmt(t.name)}</td>
								<td>${esc(formatJobTitle(t.title))}</td>
									<td style="${depDateStyle}"${depDateTitle}>${depDate}${depDateSuffix}</td>
									<td style="${retDateStyle}"${retDateTitle}>${retDate}${returnNotIncluded ? ' <i class="fas fa-exclamation-circle" style="color:#dc2626;font-size:.65rem;"></i>' : ''}</td>
								<td>${fmt(t.contact)}</td>
							</tr>
						`;
					});
				} else {
					travelerRows = '<tr><td colspan="6" style="text-align:center;opacity:.6;">No travelers assigned</td></tr>';
				}
				
				// Vehicle info
				const vehicleText = order.vehicle && order.vehicle.plateNumber ? 
					`${order.vehicle.plateNumber} - ${order.vehicle.vehicleName || order.vehicle.vehicleType || 'Vehicle'}` : '—';
				
				// Build approval flow section
				const buildApprovalFlowSection = () => {
					// Check if order has approval data
					const hasApproval = order.approvedBy || order.rejectedBy;
					if (!hasApproval && order.status !== 'Approved' && order.status !== 'Rejected') {
						return `
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-tasks"></i><span class="section-text">Approval Flow</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<thead style="background:var(--primary-color,#2563eb);color:#fff;">
				<tr><th style="color:#fff;">Status</th><th style="color:#fff;">Approver</th><th style="color:#fff;">Date</th><th style="color:#fff;">Comments</th><th style="color:#fff;">Signature</th></tr>
			</thead>
			<tbody>
				<tr><td colspan="5" style="text-align:center;opacity:.6;padding:12px;">Pending approval</td></tr>
			</tbody>
		</table>
	</div>`;
					}
					
					let rows = '';
					
					if (order.status === 'Approved' && order.approvedBy) {
						const approvedDate = order.approvedAt ? new Date(order.approvedAt).toLocaleDateString() + ' ' + new Date(order.approvedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '—';
						const approverUserId = order.approvedById || '';
						const signatureUrl = getSignatureUrl(approverUserId, order.approvedBy);
						const signatureHtml = (signatureUrl && signatureUrl.trim() && !signatureUrl.includes('undefined'))
							? `<img src="${signatureUrl}" class="sig-img" alt="${esc(order.approvedBy)} signature" style="max-width:200px;max-height:100px;" onerror="this.style.display='none';"/>`
							: '<span style="color:#10b981;"><i class="fas fa-check-circle"></i></span>';
						rows += `
							<tr>
								<td><span class="status-chip approved" style="font-size:.65rem;">Approved</span></td>
								<td>
									<span class="approver-fullname">${esc(order.approvedBy)}</span>
									${order.approverJobTitle ? `<span class="approver-job">${esc(order.approverJobTitle)}</span>` : ''}
								</td>
								<td style="font-size:.7rem;">${approvedDate}</td>
								<td style="font-size:.7rem;">${fmt(order.approvalComments || '—')}</td>
								<td style="text-align:center;">${signatureHtml}</td>
							</tr>`;
					} else if (order.status === 'Rejected' && order.rejectedBy) {
						const rejectedDate = order.rejectedAt ? new Date(order.rejectedAt).toLocaleDateString() + ' ' + new Date(order.rejectedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '—';
						const rejecterUserId = order.rejectedById || '';
						const signatureUrl = getSignatureUrl(rejecterUserId, order.rejectedBy);
						// For rejected, show X icon instead of signature (matching gate pass behavior)
						const signatureHtml = '<span style="color:#ef4444;"><i class="fas fa-times-circle"></i></span>';
						rows += `
							<tr>
								<td><span class="status-chip rejected" style="font-size:.65rem;">Rejected</span></td>
								<td>
									<span class="approver-fullname">${esc(order.rejectedBy)}</span>
									${order.rejecterJobTitle ? `<span class="approver-job">${esc(order.rejecterJobTitle)}</span>` : ''}
								</td>
								<td style="font-size:.7rem;">${rejectedDate}</td>
								<td style="font-size:.7rem;">${fmt(order.rejectionReason || '—')}</td>
								<td style="text-align:center;">${signatureHtml}</td>
							</tr>`;
					}
					
					return `
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-tasks"></i><span class="section-text">Approval Flow</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<thead style="background:var(--primary-color,#2563eb);color:#fff;">
				<tr><th style="color:#fff;">Status</th><th style="color:#fff;">Approver</th><th style="color:#fff;">Date</th><th style="color:#fff;">Comments</th><th style="color:#fff;">Signature</th></tr>
			</thead>
			<tbody>${rows}</tbody>
		</table>
		<div id="travelOrderStampSection" style="display:none;text-align:left;margin-top:-10px;">
			<img id="travelOrderStampImg" src="" alt="Approval Stamp" style="max-width:150px;max-height:150px;opacity:.85;" />
		</div>
	</div>`;
				};
				
				// Build A4 sheet content
				const a4Content = `
<div class="a4-sheet printable">
	<div class="a4-header">
		<div class="company-block">
			<img src="${logoSrc}" class="a4-logo" alt="Company Logo" onerror="this.src='${generateInitialsSVG(logoInitials)}';" />
			<div class="a4-company">
				<h1>${esc(companyName)}</h1>
				<h2 class="doc-title">Travel Order</h2>
			</div>
		</div>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-info-circle"></i><span class="section-text">Order Information</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<tbody>
				<tr>
					<td style="width:50%;" colspan="2"><strong>Order ID:</strong> ${fmt(order.orderId)}</td>
					<td style="width:50%;" colspan="2"><strong>Status:</strong> ${statusBadge(order.status)}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Created By:</strong> ${fmt(order.createdBy)}</td>
					<td colspan="2"><strong>Created Date:</strong> ${fmtDate(order.createdAt)}</td>
				</tr>
			</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-route"></i><span class="section-text">Travel Information</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<tbody>
				<tr>
					<td style="width:50%;" colspan="2"><strong>Origin:</strong> ${fmt(order.origin)}</td>
					<td style="width:50%;" colspan="2"><strong>Destination:</strong> ${fmt(order.destination)}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Departure Date:</strong> ${fmtDate(order.departureDate)}</td>
					<td colspan="2"><strong>Return Date:</strong> ${fmtDate(order.returnDate)}</td>
				</tr>
			</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-car"></i><span class="section-text">Vehicle & Driver</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<tbody>
				<tr>
					<td style="width:33%;"><strong>Vehicle:</strong> ${fmt(vehicleText)}</td>
					<td style="width:33%;"><strong>Driver:</strong> ${fmt(order.driver)}</td>
					<td style="width:34%;"><strong>Driver Contact:</strong> ${fmt(order.driverContact)}</td>
				</tr>
			</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-users"></i><span class="section-text">Travelers</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<thead><tr><th>#</th><th>Name</th><th>Job Title</th><th>Departure</th><th>Return</th><th>Contact</th></tr></thead>
			<tbody>${travelerRows}</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title"><i class="fas fa-sticky-note"></i><span class="section-text">Notes</span></div>
		<div style="background:#f9fafb;border:1px solid #d1d5db;padding:10px 12px;min-height:40px;font-size:.74rem;line-height:1.5;color:#374151;margin-top:8px;">${fmt(order.notes || 'No notes provided')}</div>
	</div>
	
	${buildApprovalFlowSection()}
</div>
`;
				
				// Render to modal body
				const modalBody = document.getElementById('viewTravelOrderBody');
				modalBody.innerHTML = a4Content;
				
				// Load and display stamp if order is Approved
				if (order.status === 'Approved') {
					loadAndDisplayOrderStamp();
				}
				
				// Attach event handlers
				document.getElementById('closeViewTravelOrderModalBtn').onclick = closeViewTravelOrderModal;
				document.getElementById('closeViewTravelOrderBtn').onclick = closeViewTravelOrderModal;
				document.getElementById('printTravelOrderBtn').onclick = () => window.print();
				
				// Hide edit button if order is approved
				const editBtn = document.getElementById('editFromViewBtn');
				if (order.status === 'Approved') {
					editBtn.style.display = 'none';
				} else {
					editBtn.style.display = '';
					editBtn.onclick = () => editTravelOrderFromView();
				}
				
				// Setup approval buttons
				const approveBtn = document.getElementById('approveTravelOrderBtn');
				const rejectBtn = document.getElementById('rejectTravelOrderBtn');
				
				// Check if user has permission to see approval buttons
				checkTravelApprovalButtonsPermission().then(canSeeButtons => {
					if (canSeeButtons && order.status !== 'Approved' && order.status !== 'Rejected') {
						approveBtn.style.display = '';
						rejectBtn.style.display = '';
						approveBtn.onclick = () => approveTravelOrder(orderKey);
						rejectBtn.onclick = () => rejectTravelOrder(orderKey);
					} else {
						approveBtn.style.display = 'none';
						rejectBtn.style.display = 'none';
					}
				});
				
				// Show modal
				const modal = document.getElementById('viewTravelOrderModal');
				modal.classList.remove('hidden');
				modal.setAttribute('aria-hidden', 'false');
				
			} catch (error) {
				console.error('Error viewing travel order:', error);
				alert('Error loading travel order details');
			}
		}
		
		function editTravelOrder(orderKey) {
			try {
				// Find the order in the travelOrders array
				const order = travelOrders.find(o => o.firebaseKey === orderKey);
				if (!order) {
					alert('Travel order not found');
					return;
				}
				
				// Set editing mode
				window.editingOrderKey = orderKey;
				window.editingMode = true;
				
				// Open the create modal (which will serve as edit modal)
				openCreateTravelOrderModal().then(() => {
					// Populate form with existing data
					populateEditForm(order);
				});
				
			} catch (error) {
				console.error('Error editing travel order:', error);
				alert('Error loading travel order for editing');
			}
		}
		
		async function populateEditForm(order) {
			try {
				// Basic order information
				document.getElementById('orderIdField').value = order.orderId || '';
				document.getElementById('orderStatusField').value = order.status || 'Draft';
				document.getElementById('orderCreatedByField').value = order.createdBy || '';
				
				// Travel information
				document.getElementById('orderOriginField').value = order.origin || '';
				document.getElementById('orderDestinationField').value = order.destination || '';
				document.getElementById('orderDepartureDateField').value = order.departureDate || '';
				document.getElementById('orderReturnDateField').value = order.returnDate || '';
				
				// Vehicle and driver
				if (order.vehicle && order.vehicle.vehicleId) {
					document.getElementById('orderVehicleField').value = order.vehicle.vehicleId;
				}
				document.getElementById('orderDriverField').value = order.driver || '';
				document.getElementById('orderDriverContactField').value = order.driverContact || '';
				
				// Notes
				document.getElementById('orderNotesField').value = order.notes || '';
				
				// Populate travelers
				if (order.travelers && order.travelers.length > 0) {
					window.selectedTravelersData = [...order.travelers];
					selectedTravelers = [...order.travelers];
					updateTravelersDisplay();
				}
				
				// Change modal title and button text for editing
				const modalTitle = document.querySelector('#createTravelOrderModal .modal-header h2');
				const submitButton = document.querySelector('#createTravelOrderModal .btn-primary');
				
				if (modalTitle) modalTitle.textContent = 'Edit Travel Order';
				if (submitButton) submitButton.textContent = 'Update Travel Order';
				
			} catch (error) {
				console.error('Error populating edit form:', error);
			}
		}
		
		function editTravelOrderFromView() {
			if (window.currentViewingOrderKey) {
				closeViewTravelOrderModal();
				editTravelOrder(window.currentViewingOrderKey);
			}
		}
		
		   async function printTravelOrder(orderKey) {
			   try {
				   // Find the order in the travelOrders array
				   const order = travelOrders.find(o => o.firebaseKey === orderKey);
				   if (!order) {
					   alert('Travel order not found');
					   return;
				   }

				   // Fetch latest contact values for each traveler from Firebase
				   if (order.travelers && order.travelers.length > 0 && order.firebaseKey) {
					   const companyId = authManager?.currentUser?.companyId || currentCompanyId;
					   if (companyId) {
						   const db = getDatabase();
						   const basePath = `companies/${companyId}/travelOrders/${order.firebaseKey}/travelers`;
						   // Fetch all travelers' contact fields in parallel
						   const contactPromises = order.travelers.map((_, idx) => {
							   const travelerRef = ref(db, `${basePath}/${idx}/contact`);
							   return get(travelerRef).then(snap => snap.exists() ? snap.val() : (order.travelers[idx].contact || '—')).catch(() => order.travelers[idx].contact || '—');
						   });
						   const contacts = await Promise.all(contactPromises);
						   // Overwrite contact fields for PDF export
						   order.travelers = order.travelers.map((trav, idx) => ({ ...trav, contact: contacts[idx] }));
					   }
				   }

				   // Create new jsPDF instance
				   const { jsPDF } = window.jspdf;
				   const doc = new jsPDF();

				   // Simplified professional color scheme
				   const primaryColor = [45, 55, 72]; // Dark gray
				   const secondaryColor = [113, 128, 150]; // Medium gray
				   const lightGray = [247, 250, 252]; // Very light gray

				   // Company information
				   const companyName = authManager?.currentCompany?.companyName || 'Company Name';
				   let yPosition = 25;

				   // Simple header with minimal background
					  // doc.setFillColor(...lightGray);
					  // doc.rect(0, 0, 210, 35, 'F');

				   // Add company logo if available
				const logoUrl = authManager?.currentCompany?.logo || authManager?.currentCompany?.logoUrl;
				   if (logoUrl) {
					   try {
						   // Create a temporary image element to load the logo
						   const img = new Image();
						   img.crossOrigin = 'anonymous';
						   // Use Promise to handle async image loading
						   const loadImage = new Promise((resolve, reject) => {
							   img.onload = () => {
								   try {
									   // Add logo to PDF (professional size and positioning)
									   doc.addImage(img, 'JPEG', 15, 8, 20, 20);
									   resolve();
								   } catch (err) {
									   reject(err);
								   }
							   };
							   img.onerror = reject;
							   img.src = logoUrl;
						   });
						   // Wait for image to load or use fallback
						   loadImage.catch(() => {
							   // Fallback to company initials if logo fails to load
							   doc.setTextColor(255, 255, 255);
							   doc.setFontSize(12);
							   doc.setFont(undefined, 'bold');
							   const initials = companyName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
							   doc.text(initials, 20, 22);
						   });
					   } catch (error) {
						   console.warn('Error loading logo:', error);
						   // Fallback to company initials
						   doc.setTextColor(255, 255, 255);
						   doc.setFontSize(12);
						   doc.setFont(undefined, 'bold');
						   const initials = companyName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
						   doc.text(initials, 20, 22);
					   }
				   } else {
					   // Fallback to company initials when no logo is available
					   doc.setTextColor(255, 255, 255);
					   doc.setFontSize(12);
					   doc.setFont(undefined, 'bold');
					   const initials = companyName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
					   doc.text(initials, 20, 22);
				   }
				
				// Company name in header
				   doc.setTextColor(...primaryColor);
				   doc.setFontSize(22);
				   doc.setFont(undefined, 'bold');
				   doc.text(companyName, 20, 20); // align left
				   // Travel Order title
				   doc.setFontSize(14);
				   doc.setFont(undefined, 'normal');
				   doc.text('TRAVEL ORDER DOCUMENT', 20, 28); // align left
				   yPosition = 50;
				   // Removed order information box border
				
				// Order details header
				doc.setFontSize(14);
				doc.setFont(undefined, 'bold');
				doc.text('ORDER INFORMATION', 20, yPosition + 3);
				
				yPosition += 12;
				
				// Order details in single column layout (left-aligned)
				const leftColumn = 20;
				
				doc.setFontSize(10);
				doc.setFont(undefined, 'bold');
				doc.text('Order ID:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.orderId || '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Status:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.status || '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Created By:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.createdBy || '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Created Date:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—', leftColumn + 35, yPosition);
				
				yPosition += 12;
				
				   // Travel Information Section
				   // doc.setFillColor(...lightGray);
				   // doc.rect(15, yPosition - 3, 180, 8, 'F');
				   doc.setTextColor(...primaryColor);
				   doc.setFontSize(12);
				   doc.setFont(undefined, 'bold');
				   doc.text('TRAVEL INFORMATION', 20, yPosition + 2);
				   yPosition += 12;
				   // Removed travel info bordered box
				
				doc.setFontSize(10);
				doc.setFont(undefined, 'bold');
				doc.text('From:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.origin || '—', leftColumn + 15, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('To:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.destination || '—', leftColumn + 15, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Departure:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—', leftColumn + 25, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Return:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—', leftColumn + 20, yPosition);
				yPosition += 5;
				
				// Duration calculation
				if (order.departureDate && order.returnDate) {
					const depDate = new Date(order.departureDate);
					const retDate = new Date(order.returnDate);
					const diffTime = Math.abs(retDate - depDate);
					const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
					
					doc.setFont(undefined, 'bold');
					doc.text('Duration:', leftColumn, yPosition);
					doc.setFont(undefined, 'normal');
					doc.text(`${diffDays} day(s)`, leftColumn + 25, yPosition);
				}
				
				yPosition += 12;
				
				// Vehicle & Driver Section
				   // doc.setFillColor(...lightGray);
				   // doc.rect(15, yPosition - 3, 180, 8, 'F');
				   doc.setTextColor(...primaryColor);
				   doc.setFontSize(12);
				   doc.setFont(undefined, 'bold');
				   doc.text('VEHICLE & DRIVER DETAILS', 20, yPosition + 2);
				
				yPosition += 12;
				
				   // Vehicle info (no bordered box)
				
				doc.setFontSize(10);
				const vehicleText = order.vehicle && order.vehicle.plateNumber ? 
					`${order.vehicle.plateNumber}${order.vehicle.vehicleName ? ` - ${order.vehicle.vehicleName}` : ''}` : 'Not Assigned';
				
				doc.setFont(undefined, 'bold');
				doc.text('Vehicle:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(vehicleText, leftColumn + 20, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Driver:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.driver || 'Not Assigned', leftColumn + 20, yPosition);
				yPosition += 5;
				
				doc.setFont(undefined, 'bold');
				doc.text('Contact:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(order.driverContact || 'Not Provided', leftColumn + 20, yPosition);
				
				yPosition += 12;
				
				// Travelers Section
				doc.setFillColor(...lightGray);
				doc.rect(15, yPosition - 3, 180, 8, 'F');
				doc.setTextColor(...primaryColor);
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.text('AUTHORIZED TRAVELERS', 20, yPosition + 2);
				
				yPosition += 12;
				
				// Travelers table
				if (order.travelers && order.travelers.length > 0) {
					// Table header
					doc.setFillColor(...lightGray);
					doc.rect(15, yPosition - 3, 180, 6, 'F');
					doc.setFontSize(10);
					doc.setFont(undefined, 'bold');
					   doc.text('No.', 20, yPosition + 1);
					   doc.text('Name', 35, yPosition + 1);
					   doc.text('Title/Position', 100, yPosition + 1);
					   doc.text('Phone Number', 150, yPosition + 1);
					
					yPosition += 8;
					
					// Table rows with simple alternating background
					order.travelers.forEach((traveler, index) => {
						if (index % 2 === 0) {
							doc.setFillColor(250, 250, 250);
							doc.rect(15, yPosition - 3, 180, 6, 'F');
						}
						doc.setTextColor(...primaryColor);
						doc.setFont(undefined, 'normal');
						doc.text(`${index + 1}.`, 20, yPosition + 1);
						doc.text(traveler.name || '—', 35, yPosition + 1);
						doc.text(formatJobTitle(traveler.title || '') || '—', 100, yPosition + 1);
						doc.text(traveler.contact || '—', 150, yPosition + 1);
						yPosition += 6;
					});
				} else {
					doc.setFont(undefined, 'italic');
					doc.setTextColor(...secondaryColor);
					doc.text('No travelers assigned to this order', leftColumn, yPosition);
					yPosition += 6;
				}
				
				yPosition += 10;
				
				// Notes Section
				doc.setFillColor(...lightGray);
				doc.rect(15, yPosition - 3, 180, 8, 'F');
				doc.setTextColor(...primaryColor);
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.text('ADDITIONAL NOTES', 20, yPosition + 2);
				
				yPosition += 12;
				
				// Notes box
				const notesHeight = 18;
				doc.setFillColor(252, 252, 252);
				   // doc.rect(15, yPosition - 5, 180, notesHeight, 'FD');
				
				   doc.setFontSize(9);
				   doc.setFont(undefined, 'normal');
				   const notes = order.notes || 'No additional notes provided for this travel order.';
				   const splitNotes = doc.splitTextToSize(notes, 170);
				   doc.text(splitNotes, 20, yPosition, { align: 'left' });
				
				yPosition += notesHeight + 10;
				
				// Approval Section
				doc.setFillColor(...lightGray);
				doc.rect(15, yPosition - 3, 180, 8, 'F');
				doc.setTextColor(...primaryColor);
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.text('APPROVALS & SIGNATURES', 20, yPosition + 2, { align: 'left' });

				yPosition += 12;

				// Display current user name and status
				doc.setFontSize(10);
				doc.setFont(undefined, 'bold');
				doc.text('Approved By:', 20, yPosition);
				doc.setFont(undefined, 'normal');
				var approverName = (authManager && authManager.getUserDisplayName) ? authManager.getUserDisplayName() : 'Current User';
				doc.text(approverName, 50, yPosition);
				yPosition += 6;
				doc.setFont(undefined, 'bold');
				doc.text('Status:', 20, yPosition);
				// Set green color for 'Approved'
				doc.setFont(undefined, 'normal');
				doc.setTextColor(16, 101, 52); // green
				doc.text('Approved', 50, yPosition);
				doc.setTextColor(...primaryColor); // reset to default for next section
				yPosition += 14;
				
				// Simple footer
				doc.setFillColor(...primaryColor);
				doc.rect(0, yPosition, 210, 12, 'F');
				
				   doc.setTextColor(255, 255, 255);
				   doc.setFontSize(8);
				   doc.setFont(undefined, 'normal');
				   const footerText = `Generated on ${new Date().toLocaleDateString()} | Order ID: ${order.orderId || 'N/A'}`;
				   doc.text(footerText, 20, yPosition + 7, { align: 'left' });
				
				// Save the PDF
				const fileName = `Travel_Order_${order.orderId || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
				doc.save(fileName);
				
			} catch (error) {
				console.error('Error generating PDF:', error);
				alert('Error generating PDF. Please try again.');
			}
		}
		
		// Generate OPTIMIZED PDF as Blob for email attachment (reduced size)
		async function generatePDFBlob(order) {
			const { jsPDF } = window.jspdf;
			
			// Use minimal PDF settings for smaller file size
			const doc = new jsPDF({
				orientation: 'portrait',
				unit: 'mm',
				format: 'a4',
				compress: true,
				precision: 2
			});
			
			// Minimal color scheme (reduces file size)
			const black = [0, 0, 0];
			const gray = [128, 128, 128];
			
			// Company information
			const companyName = authManager?.currentCompany?.companyName || 'Company Name';
			let yPosition = 15;
			
			// MINIMAL HEADER - no background fills to reduce size
			doc.setTextColor(...black);
			doc.setFontSize(16);
			doc.setFont('helvetica', 'bold');
			doc.text(companyName, 20, yPosition);
			
			yPosition += 8;
			doc.setFontSize(12);
			doc.setFont('helvetica', 'normal');
			doc.text('TRAVEL ORDER', 20, yPosition);
			
			yPosition += 15;
			
			// MINIMAL Order information - simple text only
			doc.setFontSize(10);
			doc.setFont('helvetica', 'bold');
			doc.text('ORDER DETAILS', 20, yPosition);
			yPosition += 6;
			
			// Order details in compact format
			doc.setFont('helvetica', 'normal');
			doc.setFontSize(9);
			
			doc.text(`Order ID: ${order.orderId || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Status: ${order.status || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Created: ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`By: ${order.createdBy || '—'}`, 20, yPosition);
			yPosition += 8;
			
			// Travel Information - compact format
			doc.setFont('helvetica', 'bold');
			doc.setFontSize(10);
			doc.text('TRAVEL DETAILS', 20, yPosition);
			yPosition += 6;
			
			doc.setFont('helvetica', 'normal');
			doc.setFontSize(9);
			doc.text(`From: ${order.origin || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`To: ${order.destination || '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Departure: ${order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—'}`, 20, yPosition);
			yPosition += 4;
			doc.text(`Return: ${order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—'}`, 20, yPosition);
			yPosition += 4;
			
			// Duration calculation (compact)
			if (order.departureDate && order.returnDate) {
				const depDate = new Date(order.departureDate);
				const retDate = new Date(order.returnDate);
				const diffTime = Math.abs(retDate - depDate);
				const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
				doc.text(`Duration: ${diffDays} day(s)`, 20, yPosition);
				yPosition += 4;
			}
			yPosition += 4;
			
			// Vehicle & Driver (compact)
			if (order.vehicle || order.driver) {
				doc.setFont('helvetica', 'bold');
				doc.setFontSize(10);
				doc.text('TRANSPORT', 20, yPosition);
				yPosition += 6;
				
				doc.setFont('helvetica', 'normal');
				doc.setFontSize(9);
				if (order.vehicle) {
					const vehicleInfo = `${order.vehicle.plateNumber || ''} ${order.vehicle.vehicleName || order.vehicle.vehicleType || ''}`.trim();
					doc.text(`Vehicle: ${vehicleInfo || '—'}`, 20, yPosition);
					yPosition += 4;
				}
				if (order.driver) {
					doc.text(`Driver: ${order.driver}`, 20, yPosition);
					yPosition += 4;
				}
				yPosition += 4;
			}
			
			// Travelers (compact format)
			if (order.travelers && order.travelers.length > 0) {
				doc.setFont('helvetica', 'bold');
				doc.setFontSize(10);
				doc.text('TRAVELERS', 20, yPosition);
				yPosition += 6;
				
				doc.setFont('helvetica', 'normal');
				doc.setFontSize(9);
				order.travelers.forEach((traveler, index) => {
					const travelerInfo = `${index + 1}. ${traveler.name || '—'}`;
					doc.text(travelerInfo, 20, yPosition);
					yPosition += 4;
					
					// Prevent page overflow with minimal spacing
					if (yPosition > 270) {
						doc.addPage();
						yPosition = 20;
					}
				});
				yPosition += 4;
			}
			
			// Footer (minimal)
			const pageHeight = doc.internal.pageSize.height;
			doc.setFontSize(8);
			doc.setTextColor(...gray);
			doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, pageHeight - 10);
			
			// Convert to blob with compression
			const pdfBlob = doc.output('blob');
			console.log('✅ Optimized PDF generated, size:', Math.round(pdfBlob.size / 1024), 'KB');
			
			return pdfBlob;
		}
			
			// Order information box with simple border
			doc.setTextColor(...primaryColor);
			doc.setDrawColor(...secondaryColor);
			doc.setLineWidth(0.5);
			doc.rect(15, yPosition - 5, 180, 25);
			
			// Order details header
			doc.setFontSize(14);
			doc.setFont(undefined, 'bold');
			doc.text('ORDER INFORMATION', 20, yPosition + 3);
			
			yPosition += 12;
			
			// Order details in single column layout (left-aligned)
			const leftColumn = 20;
			
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('Order ID:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.orderId || '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Status:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.status || '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Created By:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.createdBy || '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Created Date:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '—', leftColumn + 35, yPosition);
			
			yPosition += 12;
			
			// Travel Information Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('TRAVEL INFORMATION', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Travel info in a simple bordered box
			doc.setDrawColor(...secondaryColor);
			doc.setLineWidth(0.5);
			doc.rect(15, yPosition - 5, 180, 30);
			
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('From:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.origin || '—', leftColumn + 15, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('To:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.destination || '—', leftColumn + 15, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Departure:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.departureDate ? new Date(order.departureDate).toLocaleDateString() : '—', leftColumn + 25, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Return:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.returnDate ? new Date(order.returnDate).toLocaleDateString() : '—', leftColumn + 20, yPosition);
			yPosition += 5;
			
			// Duration calculation
			if (order.departureDate && order.returnDate) {
				const depDate = new Date(order.departureDate);
				const retDate = new Date(order.returnDate);
				const diffTime = Math.abs(retDate - depDate);
				const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
				
				doc.setFont(undefined, 'bold');
				doc.text('Duration:', leftColumn, yPosition);
				doc.setFont(undefined, 'normal');
				doc.text(`${diffDays} day(s)`, leftColumn + 25, yPosition);
			}
			
			yPosition += 12;
			
			// Vehicle & Driver Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('VEHICLE & DRIVER DETAILS', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Vehicle info in bordered box
			doc.rect(15, yPosition - 5, 180, 22);
			
			doc.setFontSize(10);
			const vehicleText = order.vehicle && order.vehicle.plateNumber ? 
				`${order.vehicle.plateNumber}${order.vehicle.vehicleName ? ` - ${order.vehicle.vehicleName}` : ''}` : 'Not Assigned';
			
			doc.setFont(undefined, 'bold');
			doc.text('Vehicle:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(vehicleText, leftColumn + 20, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Driver:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.driver || 'Not Assigned', leftColumn + 20, yPosition);
			yPosition += 5;
			
			doc.setFont(undefined, 'bold');
			doc.text('Contact:', leftColumn, yPosition);
			doc.setFont(undefined, 'normal');
			doc.text(order.driverContact || 'Not Provided', leftColumn + 20, yPosition);
			
			yPosition += 12;
			
			// Travelers Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('AUTHORIZED TRAVELERS', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Travelers table
			if (order.travelers && order.travelers.length > 0) {
				   // Table header
				   doc.setFillColor(...lightGray);
				   doc.rect(15, yPosition - 3, 180, 6, 'F');
				   doc.setFontSize(10);
				   doc.setFont(undefined, 'bold');
				   doc.text('No.', 20, yPosition + 1);
				   doc.text('Name', 35, yPosition + 1);
				   doc.text('Title/Position', 100, yPosition + 1);
				   doc.text('Contact', 160, yPosition + 1);

				   yPosition += 8;

				   // Table rows with simple alternating background
				   order.travelers.forEach((traveler, index) => {
					   if (index % 2 === 0) {
						   doc.setFillColor(250, 250, 250);
						   doc.rect(15, yPosition - 3, 180, 6, 'F');
					   }

					   doc.setTextColor(...primaryColor);
					   doc.setFont(undefined, 'normal');
					   doc.text(`${index + 1}.`, 20, yPosition + 1);
					   doc.text(traveler.name || '—', 35, yPosition + 1);
					   doc.text(formatJobTitle(traveler.title || '') || '—', 100, yPosition + 1);
					   doc.text(traveler.contact || '—', 160, yPosition + 1);

					   yPosition += 6;
				   });
			} else {
				doc.setFont(undefined, 'italic');
				doc.setTextColor(...secondaryColor);
				doc.text('No travelers assigned to this order', leftColumn, yPosition);
				yPosition += 6;
			}
			
			yPosition += 10;
			
			// Notes Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('ADDITIONAL NOTES', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Notes box
			const notesHeight = 18;
			doc.setFillColor(252, 252, 252);
			doc.rect(15, yPosition - 5, 180, notesHeight, 'FD');
			
			doc.setFontSize(9);
			doc.setFont(undefined, 'normal');
			const notes = order.notes || 'No additional notes provided for this travel order.';
			const splitNotes = doc.splitTextToSize(notes, 170);
			doc.text(splitNotes, 20, yPosition);
			
			yPosition += notesHeight + 10;
			
			// Approval Section
			doc.setFillColor(...lightGray);
			doc.rect(15, yPosition - 3, 180, 8, 'F');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.text('APPROVALS & SIGNATURES', 20, yPosition + 2);
			
			yPosition += 12;
			
			// Approval boxes with simple styling
			const approvalBoxHeight = 20;
			doc.setFillColor(250, 250, 250);
			
			// Manager Approval
			doc.rect(15, yPosition, 85, approvalBoxHeight, 'FD');
			doc.setTextColor(...primaryColor);
			doc.setFontSize(9);
			doc.setFont(undefined, 'bold');
			doc.text('Manager Approval:', 20, yPosition + 4);
			doc.setFont(undefined, 'normal');
			doc.text('Name: ____________________', 20, yPosition + 8);
			doc.text('Signature: ________________', 20, yPosition + 12);
			doc.text('Date: ____________________', 20, yPosition + 16);
			
			// Finance Approval
			doc.rect(110, yPosition, 85, approvalBoxHeight, 'FD');
			doc.setFont(undefined, 'bold');
			doc.text('Finance Approval:', 115, yPosition + 4);
			doc.setFont(undefined, 'normal');
			doc.text('Name: ____________________', 115, yPosition + 8);
			doc.text('Signature: ________________', 115, yPosition + 12);
			doc.text('Date: ____________________', 115, yPosition + 16);
			
			yPosition += approvalBoxHeight + 8;
			
			// Simple footer
			doc.setFillColor(...primaryColor);
			doc.rect(0, yPosition, 210, 12, 'F');
		
		// Enhanced Test Email Function with Diagnostics
		async function testEmailToSpecificAddress() {
			try {
				console.log('🧪 Starting enhanced email test with diagnostics...');
				
				// Check EmailJS initialization
				console.log('🔍 Checking EmailJS status...');
				console.log('EmailJS library loaded:', typeof emailjs !== 'undefined');
				console.log('EmailService initialized:', emailService?.isInitialized);
				console.log('EmailJS Public Key:', emailService?.emailJSPublicKey);
				console.log('Service ID:', emailService?.serviceId);
				console.log('Template ID:', emailService?.templateId);
				
				if (!emailService || !emailService.isInitialized) {
					throw new Error('EmailJS service not initialized properly');
				}

				// Create test travel order data
				const testOrder = {
					firebaseKey: 'test-order-123',
					orderId: 'TO-TEST-001',
					status: 'Issued',
					createdBy: 'Test User',
					createdAt: new Date().toISOString(),
					origin: 'New York Office',
					destination: 'Los Angeles Branch',
					departureDate: '2025-09-15',
					returnDate: '2025-09-20',
					vehicle: {
						plateNumber: 'ABC-123',
						vehicleName: 'Toyota Camry',
						vehicleType: 'Sedan'
					},
					driver: 'John Smith',
					driverContact: '+1-555-0123',
					travelers: [
						{
							name: 'Test Traveler 1',
							title: 'Manager'
						},
						{
							name: 'Test Traveler 2', 
							title: 'Assistant'
						}
					],
					notes: 'This is a test travel order for EmailJS functionality testing.'
				};

				console.log('📝 Test order created:', testOrder);

				// Generate PDF blob
				console.log('📄 Generating PDF...');
				const pdfBlob = await generatePDFBlob(testOrder);
				console.log('✅ PDF generated successfully, size:', pdfBlob.size, 'bytes');

				// Convert PDF to base64 for logging
				const pdfBase64 = await emailService.blobToBase64(pdfBlob);
				console.log('� PDF converted to base64, length:', pdfBase64.length);

				// Prepare template parameters
				const templateParams = {
					to_email: 'imoudreamentreprises@gmail.com',
					from_name: 'Travel Management System',
					order_id: testOrder.orderId,
					traveler_names: testOrder.travelers.map(t => t.name).join(', '),
					departure_date: new Date(testOrder.departureDate).toLocaleDateString(),
					return_date: new Date(testOrder.returnDate).toLocaleDateString(),
					origin: testOrder.origin,
					destination: testOrder.destination,
					vehicle: `${testOrder.vehicle.plateNumber} - ${testOrder.vehicle.vehicleName}`,
					driver: testOrder.driver,
					status: testOrder.status,
					attachment: pdfBase64,
					attachment_name: 'tr_file.pdf'
				};

				console.log('📋 Template parameters prepared:', {
					...templateParams,
					attachment: `[BASE64 PDF - ${pdfBase64.length} chars]`
				});

				// Send test email with detailed logging
				console.log('📧 Sending test email to imoudreamentreprises@gmail.com...');
				console.log('Using EmailJS service:', emailService.serviceId);
				console.log('Using template:', emailService.templateId);
				
				const response = await emailjs.send(
					emailService.serviceId, 
					emailService.templateId, 
					templateParams
				);
				
				console.log('✅ EmailJS response received:', response);
				console.log('Response status:', response.status);
				console.log('Response text:', response.text);
				
				alert(`✅ Test email sent successfully to imoudreamentreprises@gmail.com!\n\nResponse: ${response.text}\nStatus: ${response.status}\n\nCheck your inbox and spam folder.`);
				
				return response;
				
			} catch (error) {
				console.error('❌ Test email failed:', error);
				console.error('Error details:', error.name, error.message);
				if (error.text) console.error('EmailJS error text:', error.text);
				if (error.status) console.error('EmailJS error status:', error.status);
				
				alert(`❌ Test email failed!\n\nError: ${error.message}\nType: ${error.name}\n\nCheck console for details.`);
				throw error;
			}
		}

		// Simple test without PDF attachment for troubleshooting
		async function testSimpleEmail() {
			try {
				console.log('🧪 Testing simple email without PDF...');
				
				const simpleParams = {
					to_email: 'imoudreamentreprises@gmail.com',
					from_name: 'Travel Management System',
					order_id: 'SIMPLE-TEST-001',
					traveler_names: 'Test User',
					departure_date: '2025-09-15',
					return_date: '2025-09-20',
					origin: 'Test Origin',
					destination: 'Test Destination',
					vehicle: 'Test Vehicle',
					driver: 'Test Driver',
					status: 'Test Status'
					// No attachment for this test
				};

				console.log('📧 Sending simple test email...');
				const response = await emailjs.send(
					emailService.serviceId, 
					emailService.templateId, 
					simpleParams
				);
				
				console.log('✅ Simple email sent successfully:', response);
				alert(`✅ Simple test email sent successfully!\n\nResponse: ${response.text}\nStatus: ${response.status}`);
				
				return response;
				
			} catch (error) {
				console.error('❌ Simple email test failed:', error);
				alert(`❌ Simple email test failed: ${error.message}`);
				throw error;
			}
		}
		
		// Make functions globally available
		window.switchTab = switchTab;
		window.renderTravelOrders = renderTravelOrders;
		window.viewTravelOrder = viewTravelOrder;
		window.editTravelOrder = editTravelOrder;
		window.printTravelOrder = printTravelOrder;
		window.emailTravelOrder = emailTravelOrder;
		window.sendTestEmail = sendTestEmail;
		window.testEmailToSpecificAddress = testEmailToSpecificAddress;
		window.testSimpleEmail = testSimpleEmail;
		window.testEmailService = testEmailService;
		window.diagnoseEmailJSIssues = diagnoseEmailJSIssues;
		window.testBasicEmail = testBasicEmail;
		window.removeTraveler = removeTraveler;
	</script>
</body>
</html>
