<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Camp Settings - Dreamex Datalab</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<!-- Tailwind CSS (for analytics builder visual parity with fueldist) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Firebase v8 Scripts for Centralized Authentication -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root { --primary-color:#2c3e50; --secondary-color:#34495e; --accent-color:#e74c3c; --success-color:#27ae60; --warning-color:#f39c12; --info-color:#3498db; --light-color:#ecf0f1; --dark-color:#2c3e50; --sidebar-width:250px; --transition-speed:.25s; }
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
.app-container { display:flex; min-height:100vh; }
.sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; transition:transform .3s ease; z-index:1000; }
.sidebar.collapsed { transform:translateX(-100%); }
.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.3rem; padding-top:3.2rem; transition:margin-left .3s ease; }
.main-content.sidebar-collapsed { margin-left:0; }
.main-content.sidebar-collapsed .top-nav { left:0.5rem; }
.logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:1.05rem; letter-spacing:.5px; }
.menu { list-style:none; margin-top:2rem; }
.menu li { margin-bottom:0.45rem; }
.menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.6rem 0.75rem; border-radius:6px; font-size:0.82rem; font-weight:500; transition:background .25s; }
.menu a:hover, .menu a.active { background:rgba(255,255,255,0.12); }
.submenu { list-style:none; margin-left:0.75rem; display:none; margin-top:0.25rem; }
.menu-dropdown:hover .submenu { display:block; }
.submenu a { font-size:0.75rem; padding:0.45rem 0.65rem; }
[data-feature]:not(.menu-visible) { display:none !important; }
.menu-dropdown:not(.menu-visible) { display:none !important; }

/* Hide ALL menu items by default during loading */
.sidebar.menu-loading .menu-item,
.sidebar.menu-loading .menu-dropdown,
.sidebar.menu-loading li[data-feature],
.sidebar.menu-loading [data-feature] {
    display: none !important;
}

/* Allow menu-visible items to show even during loading */
.sidebar.menu-loading .menu-visible,
.sidebar.menu-loading li.menu-visible,
.sidebar.menu-loading [data-feature].menu-visible {
    display: block !important;
}

.menu-loading [data-feature] {
    display: none !important;
}

.menu-loading .menu-dropdown {
    display: none !important;
}

/* Ensure menu-visible items are always shown */
.menu-visible {
    display: block !important;
}

li.menu-visible,
[data-feature].menu-visible {
    display: block !important;
}
.top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
.sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
.top-nav-left { display:flex; align-items:center; gap:0.75rem; }
.company-branding { display:flex; align-items:center; gap:0.5rem; }
#headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
#headerCompanyName { font-weight:600; font-size:0.85rem; }
.header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }
.top-nav-right { display:flex; align-items:center; gap:1rem; }
.notifications { position:relative; display:flex; align-items:center; }
.notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
.notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; }
.notification-dropdown { display:none; position:absolute; right:0; top:100%; width:300px; background-color:white; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.1); z-index:1000; }
.notification-dropdown.show { display:block; }
.notification-dropdown .notification-header { display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid #eee; }
.notification-header h3 { margin:0; font-size:1rem; }
.mark-all-read { background:none; border:none; color:var(--primary-color); cursor:pointer; font-size:0.8rem; }
.notification-list { max-height:300px; overflow-y:auto; }
.notification-item { padding:0.75rem 1rem; border-bottom:1px solid #f0f0f0; cursor:pointer; }
.notification-item:hover { background-color:#f8f9fa; }
.notification-item.unread { background-color:#f0f8ff; }
.user-profile { position:relative; }
.profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
.profile-btn img { width:100%; height:100%; object-fit:cover; }
.profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
.profile-dropdown.show { display:block; }
.profile-dropdown ul { list-style:none; }
.profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
.profile-dropdown li a:hover { background:#f1f5f9; }
.page-header { 
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
    color: #fff; 
    padding: 0.55rem 0.75rem; 
    margin: 0.35rem 0 0.5rem 0; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); 
    font-size: 0.9rem; 
}
.page-header h1 { 
    color: #fff; 
    font-size: 0.9rem; 
    display: flex; 
    align-items: center; 
    gap: 0.5rem; 
    letter-spacing: 0.5px; 
    margin: 0; 
    font-weight: 600; 
}
.page-header i { 
    font-size: 1rem; 
}
/* Add New Button */
.btn-add-new {
    background: none;
    border: none;
    color: #fff;
    padding: 0.4rem;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}
.btn-add-new:hover {
    color: rgba(255,255,255,0.8);
    transform: scale(1.1);
}
.btn-add-new i {
    font-size: 1.2rem;
}
.page-actions { display:flex; gap:0.4rem; flex-wrap:wrap; }
.btn { border:none; border-radius:6px; padding:0.45rem 0.75rem; font-size:0.68rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:0.4rem; letter-spacing:.5px; background:#eef2f6; color:#1e293b; transition:.2s; }
.btn:hover { background:#e2e8f0; }
.btn-primary { background:var(--primary-color); color:#fff; }
.btn-primary:hover { background:#1f2f3d; }
.btn-accent { background:var(--accent-color); color:#fff; }
.btn-accent:hover { background:#c0392b; }
.btn-success { background:var(--success-color); color:#fff; }
.btn-success:hover { background:#218c4f; }
.btn-outline { background:#fff; border:1px solid #cbd5e1; }
.btn-outline:hover { background:#f1f5f9; }
.section { background:#fff; padding:0.7rem; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.06); margin-bottom:0.3rem; }
.section-title { font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:0.5rem; color:#334155; display:flex; align-items:center; justify-content:space-between; gap:0.4rem; position:relative; }
.title-left { display:flex; align-items:center; gap:0.4rem; }
.title-right { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }

/* Enhanced compact filter controls */
.title-left input, .title-left select {
    padding: 0.25rem 0.4rem;
    font-size: 0.7rem;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    background: #fff;
    min-width: 0;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.title-left input:focus, .title-left select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.title-left input[type="text"] {
    width: 160px;
}
.title-left select {
    width: 100px;
    cursor: pointer;
}
.filters { display:flex; gap:0.5rem; flex-wrap:wrap; margin:0 0 0.4rem 0; }
.filters select, .filters input { padding:0.35rem 0.5rem; font-size:0.65rem; border:1px solid #cbd5e1; border-radius:5px; }
.table-wrapper { 
    overflow: hidden;
    border: 1px solid #e2e8f0; 
    border-radius: 0; 
    background: white;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.08);
    height: calc(100vh - 420px); /* Reduced height to fit screen better */
    max-height: 500px; /* Maximum height to prevent overflow */
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.3s ease;
}
.table-wrapper:hover {
    box-shadow: 0 12px 32px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.12);
}
.table-scrollable {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
}
table { 
    width: 100%; 
    border-collapse: collapse;
    margin: 0;
    table-layout: fixed;
}
table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f8f9fa;
}
table thead th {
    background: #f8f9fa;
    color: #495057;
    padding: 0.8rem;
    font-weight: 600;
    font-size: 0.75rem;
    border-bottom: 2px solid #e9ecef;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
table tbody td {
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.75rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
th, td { padding:0.55rem 0.6rem; font-size:0.62rem; text-align:left; border-bottom:1px solid #e2e8f0; }
th { background:#f1f5f9; font-weight:600; color:#475569; font-size:0.6rem; letter-spacing:.5px; text-transform:uppercase; }
tr.editing-row { background-color:#fef3c7 !important; border-left:3px solid #f59e0b; }
tr.editing-row td { background-color:#fef3c7; }
tbody tr:hover { background:#f8fafc; }
.badge { display:inline-block; padding:0.15rem 0.5rem; font-size:0.55rem; background:#e2e8f0; border-radius:20px; font-weight:600; letter-spacing:.5px; }
.badge.green { background:#dcfce7; color:#166534; }
.badge.red { background:#fee2e2; color:#991b1b; }
.badge.amber { background:#fef3c7; color:#92400e; }
.badge.blue { background:#dbeafe; color:#1e40af; }
.inline-actions { display:flex; gap:0.3rem; }
.inline-actions .btn { padding:0.3rem 0.5rem; font-size:0.55rem; }
/* Stats (legacy pills retained for compatibility) */
.stats-bar { display:flex; align-items:center; gap:0.35rem; flex-wrap:wrap; }
.stat-pill { display:inline-flex; align-items:center; gap:0.35rem; padding:0.2rem 0.5rem; border:1px solid #e2e8f0; border-radius:999px; font-size:0.6rem; color:#334155; background:#f8fafc; }
.stat-pill i { opacity:0.7; }
.stat-num { font-weight:700; color:#0f172a; }
/* Stats cards (match contract.html visual style) */
/* Responsive grid exactly like contract.html */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
}
.stat-card {
    background: white;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
.stat-card .stat-number {
    font-size: 1.4rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 0.25rem;
    line-height: 1;
    background: none;
    padding: 0;
    border-radius: 0;
}
/* Labels inside stat cards (same as contract: target the last div) */
.stat-card div:last-child {
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: 500;
    line-height: 1.2;
}
/* Keep explicit class for label where present */
.stat-card .stat-label { font-size:0.75rem; color:#6c757d; font-weight:500; line-height:1.2; }
/* List inside stat cards */
.stat-list { margin-top:0.25rem; display:flex; flex-direction:column; gap:0.25rem; max-height:160px; overflow:auto; text-align:left; }
.stat-row { display:flex; align-items:center; justify-content:space-between; gap:0.5rem; font-size:0.75rem; color:#2c3e50; }
.stat-row strong { font-weight:800; color:#2c3e50; }
/* Responsive breakpoints for grid columns */
@media (max-width: 900px){ .stats-cards { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 520px){ .stats-cards { grid-template-columns: 1fr; } }
/* Modal */
.modal { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.45); z-index:3000; align-items:flex-start; justify-content:center; overflow:auto; padding:2rem 1rem; }
.modal.show { display:flex; }
.modal-dialog { background:#fff; border-radius:12px; width:100%; max-width:720px; box-shadow:0 12px 40px -6px rgba(0,0,0,0.25); animation:fadeIn .25s ease; display:flex; flex-direction:column; max-height:90vh; }
@keyframes fadeIn { from { opacity:0; transform:translateY(12px);} to { opacity:1; transform:translateY(0);} }
.modal-header { padding:0.85rem 1rem; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between; }
.modal-header h3 { font-size:0.9rem; letter-spacing:.5px; }
.modal-close { background:none; border:none; font-size:1.1rem; cursor:pointer; color:#475569; }
.modal-body { padding:1rem; overflow-y:auto; }
.modal-footer { padding:0.8rem 1rem; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:0.5rem; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:0.7rem; }
.form-group { display:flex; flex-direction:column; gap:0.25rem; }
.form-group label { font-size:0.58rem; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:#334155; }
.form-group input, .form-group select, .form-group textarea { padding:0.4rem 0.5rem; font-size:0.62rem; border:1px solid #cbd5e1; border-radius:6px; background:#fff; }
.form-group textarea { resize:vertical; min-height:70px; }
.form-group small { font-size:0.5rem; color:#64748b; }
.divider { height:1px; background:#e2e8f0; margin:0.8rem 0; }
.toggle-chip { display:inline-flex; align-items:center; gap:0.35rem; background:#f1f5f9; border:1px solid #cbd5e1; padding:0.25rem 0.55rem; border-radius:20px; font-size:0.55rem; cursor:pointer; font-weight:600; }
.toggle-chip.active { background:#1e3a8a; border-color:#1e3a8a; color:#fff; }
.amenities-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:0.45rem; }
.amenity-badge { display:inline-flex; align-items:center; gap:0.3rem; background:#e2e8f0; color:#334155; padding:0.3rem 0.6rem; border-radius:15px; font-size:0.65rem; font-weight:500; }
.amenity-badge .remove-btn { background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.8rem; padding:0; margin-left:0.2rem; }
.amenity-badge .remove-btn:hover { color:#dc2626; }
.amenity-badge.small { padding:0.2rem 0.4rem; font-size:0.55rem; gap:0.2rem; margin:0.1rem; }
.site-badge { display:inline-block; background:#f1f5f9; color:#475569; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.7rem; font-weight:500; border:1px solid #e2e8f0; }
.empty-state { padding:1.2rem; text-align:center; font-size:0.6rem; color:#64748b; }
/* Multi-select dropdown (like meal type sites) */
.multi-dropdown { position: relative; display: inline-block; width: 100%; }
.multi-select-toggle { width: 100%; display:flex; align-items:center; justify-content:space-between; gap:0.4rem; border:1px solid #cbd5e1; background:#fff; border-radius:6px; padding:0.4rem 0.5rem; font-size:0.62rem; cursor:pointer; }
.multi-select-toggle .label { display:flex; align-items:center; gap:0.4rem; color:#334155; }
.multi-select-toggle .count { font-weight:600; color:#0f172a; }
.multi-select-menu { position:absolute; top: calc(100% + 6px); left:0; right:0; max-height: 220px; overflow:auto; border:1px solid #e2e8f0; background:#fff; border-radius:8px; box-shadow:0 12px 28px rgba(0,0,0,0.12); z-index: 4000; padding:0.35rem; display:none; }
.multi-select-menu.show { display:block; }
.multi-option { display:flex; align-items:center; gap:0.5rem; padding:0.35rem 0.4rem; border-radius:6px; cursor:pointer; }
.multi-option:hover { background:#f1f5f9; }
.multi-option input { pointer-events:none; }
.selected-chips { margin-top:0.4rem; display:flex; flex-wrap:wrap; gap:0.35rem; }
.selected-chip { display:inline-flex; align-items:center; gap:0.25rem; background:#eef2f6; border:1px solid #e2e8f0; color:#334155; padding:0.2rem 0.45rem; border-radius:999px; font-size:0.6rem; }

/* Tab Navigation */
.tab-navigation { display:flex; gap:0.5rem; margin-bottom:1rem; background:#fff; padding:0.5rem; border-radius:0; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
.tab-nav-btn { padding:0.7rem 1.2rem; border:none; background:transparent; border-radius:0; cursor:pointer; font-size:0.72rem; font-weight:600; transition:.3s; display:flex; align-items:center; gap:0.5rem; color:#64748b; flex:1; justify-content:center; }
.tab-nav-btn:hover { background:#f1f5f9; color:#475569; }
.tab-nav-btn.active { background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)); color:#fff; box-shadow:0 3px 12px rgba(44,62,80,0.25); }
.tab-content { display:none; }
.tab-content.active { display:block; }
/* FAB (Floating Action Button) */
.fab {position:static; width:32px; height:32px; border-radius:50%; background:var(--success-color); color:#fff; font-size:1rem; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,.25); z-index:1000; transition:all 0.3s ease;}
.fab:hover {transform:translateY(-2px); box-shadow:0 6px 15px rgba(0,0,0,.35);}
/* Analytics layout */
.charts-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:0.75rem; }
.chart-card { grid-column: span 6; background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
.chart-card.large { grid-column: span 12; }
.chart-title { font-size:0.75rem; font-weight:700; color:#334155; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.35rem; }
@media (max-width: 900px) { .chart-card { grid-column: span 12; } }
/* Responsive */
@media (max-width: 1200px) {
    .tab-navigation { 
        flex-wrap: wrap; 
    }
    .tab-nav-btn { 
        flex: 1 1 auto; 
        min-width: 140px; 
    }
    .table-controls { 
        flex-direction: column; 
        gap: 0.5rem; 
    }
    .search-filters { 
        width: 100%; 
        justify-content: space-between; 
    }
}

@media (max-width: 900px) { 
    .main-content { 
        margin-left: 0; 
    } 
    .sidebar { 
        transform: translateX(-100%); 
    } 
    .sidebar.open { 
        transform: translateX(0); 
    } 
    .top-nav { 
        left: 0.5rem; 
    }
    .page-header {
        padding: 0.5rem;
        font-size: 0.85rem;
        margin: 0.25rem 0 0.4rem 0;
    }
    .tab-nav-btn {
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
    }
}

@media (max-width: 768px) {
    .top-nav {
        padding: 0.4rem 0.5rem;
        height: 45px;
        min-height: 45px;
    }
    .main-content {
        padding: 0.2rem;
        padding-top: 3rem;
    }
    .page-header {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
    }
    .tab-navigation {
        border-radius: 0;
    }
    .tab-nav-btn {
        padding: 0.6rem 0.8rem;
        font-size: 0.7rem;
        min-width: 120px;
    }
    .table-wrapper {
        height: calc(100vh - 340px);
        border-radius: 0;
    }
    .table-header {
        padding: 0.75rem;
    }
    .table-title {
        font-size: 1rem;
    }
    table thead th {
        padding: 0.6rem 0.4rem;
        font-size: 0.7rem;
    }
    table tbody td {
        padding: 0.5rem 0.4rem;
        font-size: 0.7rem;
    }
    .btn {
        padding: 0.35rem 0.6rem;
        font-size: 0.65rem;
    }
    .modal-content {
        width: 95%;
        margin: 1rem;
    }
    .modal-body {
        padding: 0.75rem;
    }
    .form-row {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .top-nav {
        padding: 0.3rem 0.4rem;
        height: 40px;
        min-height: 40px;
    }
    .main-content {
        padding-top: 2.5rem;
        padding: 0.15rem;
    }
    .page-header {
        padding: 0.35rem 0.5rem;
        font-size: 0.75rem;
    }
    .tab-nav-btn {
        padding: 0.5rem 0.6rem;
        font-size: 0.65rem;
        min-width: 100px;
        gap: 0.3rem;
    }
    .tab-nav-btn i {
        font-size: 0.8rem;
    }
    .table-wrapper {
        height: calc(100vh - 300px);
        border-radius: 0;
    }
    table thead th {
        padding: 0.5rem 0.3rem;
        font-size: 0.65rem;
    }
    table tbody td {
        padding: 0.4rem 0.3rem;
    /* Column filters in header */
    .column-filters th { background:#f8fafc; position: sticky; top: 0; z-index: 1; display:flex; flex-direction:column; align-items:stretch; gap:0.35rem; }
    .column-filters select { width:100%; padding:0.3rem 0.4rem; font-size:0.6rem; border:1px solid #cbd5e1; border-radius:4px; background:#fff; }
    .column-filters .th-label { font-weight:600; font-size:0.6rem; letter-spacing:.5px; text-transform:uppercase; color:#475569; }
        font-size: 0.65rem;
    }
    .search-filters {
        flex-direction: column;
        align-items: stretch;
    }
    .search-filters input,
    .search-filters select {
        width: 100%;
        margin-bottom: 0.25rem;
        font-size: 0.7rem;
        padding: 0.4rem;
    }
    .btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.6rem;
    }
    .status-badge {
        font-size: 0.6rem;
        padding: 0.15rem 0.3rem;
    }
    .modal-header {
        padding: 0.7rem 0.9rem;
    }
    .modal-title {
        font-size: 1.1rem;
    }
    .form-group label {
        font-size: 0.8rem;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        font-size: 0.8rem;
        padding: 0.4rem;
    }
}
</style>
</head>
<body>
<div class="app-container">
	<nav class="sidebar menu-loading" id="sidebar">
		<div class="logo"><h2>Dreamex Datalab</h2></div>
		<ul class="menu" id="roleBasedMenu">
			<li class="menu-item" data-feature="home_view" data-requires-permission="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
				
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
                <ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                </ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html" class="active">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
					<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                    <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                    <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                    <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                    <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                </ul>
            </li>
            <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
	</nav>
    <main class="main-content" id="mainContent">
        <nav class="top-nav">
            <div class="top-nav-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                <div class="company-branding">
                    <img id="headerCompanyLogo" alt="Company Logo" />
                    <span id="headerCompanyName"></span>
                </div>
            </div>
            <div class="top-nav-right">
                <div class="notifications">
                    <button id="notificationBtn" class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <div class="user-profile" style="position:relative;">
                    <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                    <div class="profile-dropdown"><ul></ul></div>
                </div>
            </div>
        </nav>
        <div class="page-header">
            <h1><i class="fas fa-sliders-h"></i> Camp Settings</h1>
            <div class="page-actions" style="display:flex; gap:.4rem; align-items:center;">
                <button id="deleteSelectedBtn" class="btn-add-new" title="Delete selected rooms" aria-label="Delete selected rooms" onclick="deleteSelectedRooms()" disabled>
                    <i class="fa fa-trash"></i>
                </button>
                <button class="btn-add-new" title="Add" aria-label="Add" onclick="onAddNewClick()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

		<!-- Tab Navigation -->
		<div class="tab-navigation">
			<button class="tab-nav-btn active" data-tab="rooms">
				<i class="fas fa-bed"></i>
				Rooms Inventory
			</button>
            <button class="tab-nav-btn" data-tab="analytics">
                <i class="fas fa-chart-pie"></i>
                Analytics
            </button>
			<button class="tab-nav-btn" data-tab="amenities">
				<i class="fas fa-fan"></i>
				Amenity Catalog
			</button>
            <button class="tab-nav-btn" data-tab="settings">
                <i class="fas fa-user-shield"></i>
                Settings
            </button>
		</div>

		<!-- Rooms Inventory Tab -->
        <div class="tab-content active" id="roomsTab">
            <section class="section">
                <div class="section-title">
                    <div class="title-left">
                        <div id="roomsBulkActions" style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
                            
                            <span id="tempFilterNotice" style="display:none;font-size:0.7rem;color:#0f766e;background:#ecfdf5;border:1px solid #99f6e4;border-radius:6px;padding:2px 6px;">
                                Showing newly created (<span id="tempFilterCount">0</span>)
                                <button class="btn btn-outline" style="margin-left:6px;padding:2px 6px;" onclick="clearTemporaryCodeFilter()">Clear</button>
                            </span>
                        </div>
                    </div>
                    <div class="title-right">
                        <div id="roomStats" class="stats-cards" aria-live="polite"></div>
					</div>
				</div>
				<div class="table-wrapper">
					<div class="table-scrollable">
                        <table id="roomsTable">
                            <thead>
                                <tr class="column-filters">
                                    <th style="width:28px; text-align:center;">
                                        <input type="checkbox" id="selectAllRoomsChk" onchange="toggleSelectAllRooms(this.checked)" title="Select/Deselect all on this page" />
                                    </th>
                                    <th>
                                        <div class="th-label">Room</div>
                                        <select id="filterRoomSel">
                                            <option value="">All Rooms</option>
                                        </select>
                                    </th>
                                    <th>
                                        <div class="th-label">Type</div>
                                        <select id="filterTypeSel">
                                            <option value="">All Types</option>
                                        </select>
                                    </th>
                                    <th>
                                        <div class="th-label">Location</div>
                                        <select id="filterLocationSel">
                                            <option value="">All Locations</option>
                                        </select>
                                    </th>
                                    <th>
                                        <div class="th-label">Company</div>
                                        <select id="filterCompanySel">
                                            <option value="">All Companies</option>
                                        </select>
                                    </th>
                                    <th>
                                        <div class="th-label">Status</div>
                                        <select id="filterStatusSel">
                                            <option value="">All Statuses</option>
                                        </select>
                                    </th>
                                    <th>
                                        <div class="th-label">Updated</div>
                                        <select id="filterUpdatedSel">
                                            <option value="">Any Date</option>
                                        </select>
                                    </th>
                                    <th>
                                        <div class="th-label">Actions</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="roomsTbody"><tr><td colspan="8" class="empty-state">Loading rooms...</td></tr></tbody>
						</table>
					</div>
				</div>
			</section>
		</div>


        <!-- Analytics Tab -->
        <div class="tab-content" id="analyticsTab">
            <div id="analyticsSection" style="margin-top:0.75rem;">
                <!-- Custom Multi Chart/Table Builder Placeholder -->
                <div id="analyticsMultiBuilderMount"></div>
                <!-- Hidden controls stub to mirror fueldist layout -->
                <div id="analyticsControlsStub" style="display:none">
                    <select id="analyticsCategory"><option value="day" selected>By Day</option></select>
                    <input id="analyticsDateStart" type="date" />
                    <input id="analyticsDateEnd" type="date" />
                    <div id="analyticsInlineKpis"></div>
                    <div id="categoryValueFilter"></div>
                    <div id="analyticsValueDropdown"></div>
                    <div id="analyticsValueDropdownMenu"></div>
                </div>
                <div id="analyticsStatus" style="font-size:0.6rem;color:#475569;margin:0.2rem 0 0.6rem 0;"></div>

                <!-- Saved Analytics Models -->
                <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem;margin-top:0.8rem;">
                    <h4 style="margin:0 0 0.4rem 0;font-size:0.6rem;font-weight:600;color:#334155;letter-spacing:0.5px;">SAVED ANALYTICS MODELS</h4>
                    <div class="table-scroll" style="max-height:220px;">
                        <table class="data-table" style="font-size:0.6rem;min-width:700px;">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Date Range</th>
                                    <th>Values</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="analyticsModelsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div> <!-- end analyticsSection -->
        </div>


		<!-- Amenity Catalog Tab -->
		<div class="tab-content" id="amenitiesTab">
			<section class="section">
				<div class="section-title">
					<i class="fas fa-fan"></i> Amenity Catalog
					<div style="margin-left:auto;">
						<button class="btn btn-outline" onclick="openModal('amenityModal')"><i class="fas fa-fan"></i> Manage Amenities</button>
					</div>
				</div>
				<div class="table-wrapper">
					<div class="table-scrollable">
						<table id="amenitiesTable"><thead><tr><th>Amenity</th><th>Code</th><th>Description</th><th>Active</th><th>Actions</th></tr></thead><tbody id="amenitiesTbody"><tr><td colspan="5" class="empty-state">No amenities defined</td></tr></tbody></table>
					</div>
				</div>
			</section>
		</div>

        <!-- Settings Tab: User Room Visibility by Location -->
        <div class="tab-content" id="settingsTab">
            <section class="section">
                <div class="section-title">
                    <div class="title-left" style="font-weight:700; font-size:0.8rem; color:#334155; display:flex; align-items:center; gap:0.4rem;">
                        <i class="fas fa-user-shield"></i> User Room Visibility
                    </div>
                    <div class="title-right"></div>
                </div>

                <div class="table-wrapper">
                    <div class="table-scrollable">
                        <table id="visibilityTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Job Title</th>
                                    <th>Allowed Locations</th>
                                    <th>Action Perms</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="visibilityTbody">
                                <tr><td colspan="4" class="empty-state">Loading mappings...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
	</main>
</div>
<!-- Modals -->
<div id="roomModal" class="modal"><div class="modal-dialog"><div class="modal-header"><h3>Room</h3><button class="modal-close" onclick="closeModal('roomModal')">&times;</button></div><div class="modal-body"><form id="roomForm"><div class="form-grid"><div class="form-group"><label>Room Code</label><input name="code" required placeholder="E.g. A-101" /></div><div class="form-group"><label>Name</label><input name="name" placeholder="Room Name" /></div><div class="form-group"><label>Type</label><select name="type" id="roomTypeSelect" required onchange="onRoomTypeChange(this.value)"></select></div><div class="form-group"><label>Company</label><select name="forCompanyId" id="roomCompanySelect"><option value="">Loading companies...</option></select><small>Assign this room to a company/subcontractor</small></div><div class="form-group"><label>Location Block</label><select name="block" id="roomBlockSelect"><option value="">Select Area</option></select></div><div class="form-group"><label>Status</label><select name="status"><option>Available</option><option>Occupied</option><option>Maintenance</option><option>Inactive</option></select></div><div class="form-group" style="grid-column:1/-1;"><label>Amenities</label><select id="amenityDropdown" onchange="addAmenityToRoom(this.value)"><option value="">-- Add Amenity --</option></select><div id="roomAmenitiesContainer" style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.3rem;"></div><small>Select amenities to add to this room</small></div><div class="form-group" style="grid-column:1/-1;"><label>Notes</label><textarea name="notes" placeholder="Condition, maintenance cycle, etc"></textarea></div></div></form></div><div class="modal-footer"><button class="btn" onclick="closeModal('roomModal')">Cancel</button><button class="btn btn-primary" onclick="saveRoom()">Save Room</button></div></div></div>
<!-- Room Type modal removed as Room Types tab is no longer available -->
<div id="amenityModal" class="modal"><div class="modal-dialog"><div class="modal-header"><h3>Amenities</h3><button class="modal-close" onclick="closeModal('amenityModal')">&times;</button></div><div class="modal-body"><form id="amenityForm"><div class="form-grid"><div class="form-group"><label>Active</label><select name="active"><option value="true">Active</option><option value="false">Inactive</option></select></div><div class="form-group" style="grid-column:1/-1;"><label>Description</label><textarea name="description" placeholder="Short description"></textarea></div></div></form><div class="divider"></div><div style="display:flex; justify-content:flex-end; gap:0.4rem;"><button class="btn" type="button" onclick="resetAmenityForm()">Reset</button><button class="btn btn-primary" type="button" onclick="saveAmenity()">Update</button></div></div><div class="modal-footer"><button class="btn" onclick="closeModal('amenityModal')">Close</button></div></div></div>

<!-- Settings: Assign Locations to User Modal -->
<div id="visibilityModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>Allow Locations to User</h3>
            <button class="modal-close" onclick="closeModal('visibilityModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="visibilityForm">
                <div class="form-grid">
                    <div class="form-group" style="grid-column:1/-1;">
                        <label for="visibilityUserModalSelect">User</label>
                        <select id="visibilityUserModalSelect"><option value="">Loading users...</option></select>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label for="visibilityCompanySelect">Company</label>
                        <select id="visibilityCompanySelect">
                            <option value="">Loading companies...</option>
                        </select>
                        <small>Select the company scope (main company or subcontractor)</small>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Allowed Locations</label>
                        <div class="multi-dropdown" id="visibilityLocationsDropdown">
                            <button type="button" class="multi-select-toggle" onclick="toggleLocationsMenu(event)">
                                <span class="label"><i class="fa fa-map-marker-alt"></i> <span id="locationsToggleText">Select locations</span></span>
                                <i class="fa fa-caret-down"></i>
                            </button>
                            <div class="multi-select-menu" id="locationsMenu"></div>
                        </div>
                        <div class="selected-chips" id="locationsSelectedChips"></div>
                        <small>Select the locations this user can see in Camp.</small>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Camp Page Actions</label>
                        <div style="display:flex;flex-wrap:wrap;gap:0.75rem;font-size:0.75rem;">
                            <label style="display:flex;align-items:center;gap:0.35rem;"><input type="checkbox" id="modalPermAssign" /> Assign (+)</label>
                            <label style="display:flex;align-items:center;gap:0.35rem;"><input type="checkbox" id="modalPermEdit" /> Edit</label>
                            <label style="display:flex;align-items:center;gap:0.35rem;"><input type="checkbox" id="modalPermCheckIn" /> Check In</label>
                            <label style="display:flex;align-items:center;gap:0.35rem;"><input type="checkbox" id="modalPermCheckOut" /> Check Out</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('visibilityModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveUserVisibilityMappingFromModal()">Save</button>
        </div>
    </div>
    </div>
<script>
// Centralized Firebase Configuration (from firebase-config-v8.js)
const firebaseConfig = {
    apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
    authDomain: "users-8be65.firebaseapp.com",
    databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
    projectId: "users-8be65",
    storageBucket: "users-8be65.firebasestorage.app",
    messagingSenderId: "909025468149",
    appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
    measurementId: "G-XHFMRCJQEZ"
};

// Initialize Firebase v8 if not already initialized
function initializeFirebase() {
    if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
        window.firebase.initializeApp(firebaseConfig);
        console.log(' Firebase v8 initialized successfully for centralized auth');
    }
    return window.firebase;
}

// Prefer authenticated DB from authManager, fallback to firebase.database()
function getDb(){
    try {
        if (window.authManager && window.authManager.db) return window.authManager.db;
        if (window.firebase && window.firebase.database) return window.firebase.database();
    } catch (e) { console.warn('getDb failed', e); }
    return null;
}

// Force storing under a specific company path if provided
// Set to the requested company for rooms inventory page
window.__FORCE_COMPANY_ID = '-OYL6cpeH7JnNLPBhCTH';
// Include Kamsar rooms by default in this view so data isn't hidden by location
try { window.__includeKamsar = true; } catch(_) {}

// Centralized company ID resolver
function getActiveCompanyId(){
    try {
        if (window.__FORCE_COMPANY_ID && typeof window.__FORCE_COMPANY_ID === 'string') return window.__FORCE_COMPANY_ID;
        if (window.CompanyStorage && typeof CompanyStorage.getCompanyId === 'function') return CompanyStorage.getCompanyId();
    } catch(_){}
    return null;
}
window.getActiveCompanyId = getActiveCompanyId;

// Realtime rooms subscription
let __roomsListenerRef = null;
let __roomsPollTimer = null;
function unsubscribeRooms(){ try { if(__roomsListenerRef){ __roomsListenerRef.off(); __roomsListenerRef = null; } } catch(_){} try { if(__roomsPollTimer){ clearInterval(__roomsPollTimer); __roomsPollTimer=null; } } catch(_){} }

// Normalize Firebase rooms payload to array of room objects with stable id
function transformRoomsData(data){
    try {
        if (!data) return [];
        // If already an array
        if (Array.isArray(data)) {
            return data
                .map((v, i) => (v && typeof v === 'object') ? ({ id: v.id || String(i), ...v }) : null)
                .filter(Boolean);
        }
        // If it's an object (map)
        if (typeof data === 'object') {
            return Object.keys(data)
                .map(k => {
                    const v = data[k];
                    if (!v || typeof v !== 'object') return null;
                    return { id: v.id || k, ...v };
                })
                .filter(Boolean);
        }
        return [];
    } catch(_) { return []; }
}
function subscribeToRooms(companyId){
    try {
        const db = getDb();
        if (!db || !companyId) return;
        // replace existing
        unsubscribeRooms();
        const path = `companies/${companyId}/rooms`;
        __roomsListenerRef = db.ref(path);
        __roomsListenerRef.on('value', (snap) => {
            const data = snap.val();
            rooms = transformRoomsData(data);
            renderRooms();
            updateRoomStats();
        }, (err) => { 
            console.warn('Rooms realtime listener error', err);
            // Fallback: start REST polling if permissions block SDK listener
            try { if(__roomsPollTimer) clearInterval(__roomsPollTimer); } catch(_){}
            const base = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}`;
            const fetchOnce = async () => {
                try { 
                    let auth = '';
                    try { const u = firebase.auth().currentUser; if (u) { const t = await u.getIdToken(/*forceRefresh*/false); if (t) auth = `?auth=${t}`; } } catch(_){}
                    const resp = await fetch(`${base}/rooms.json${auth}`);
                    if (resp.ok){
                        const data = await resp.json();
                        rooms = transformRoomsData(data);
                        renderRooms();
                        updateRoomStats();
                    }
                } catch(_e){}
            };
            fetchOnce();
            __roomsPollTimer = setInterval(fetchOnce, 5000);
        });
        console.log(' Subscribed to realtime rooms at', path);
    } catch(e){ console.warn('subscribeToRooms error', e); }
}

// Initialize Firebase
const firebase = initializeFirebase();
// Centralized AuthManager Class (integrated from js/auth.js)
class AuthManager {
    constructor() {
        this.currentUser = this.getCurrentUser();
        this.currentCompany = null;
        this.db = null;
        this.auth = null;
        this.storage = null;
        this.initializeAuth();
    }

    getCurrentUser() {
        try {
            const user = localStorage.getItem('currentUser');
            return user ? JSON.parse(user) : null;
        } catch (error) {
            console.error('Error getting current user:', error);
            return null;
        }
    }

    async initializeAuth() {
        console.log(' Starting centralized authentication initialization...');
        
        try {
            // Initialize Firebase services
            this.auth = firebase.auth();
            this.db = firebase.database();
            this.storage = firebase.storage();
            
            console.log(' Firebase services initialized for centralized auth');

            // Set up auth state listener
            this.auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log(' User authenticated via Firebase:', user.email);
                    await this.loadUserData(user);
                } else {
                    console.log(' No Firebase user, setting guest mode');
                    this.currentUser = { 
                        uid: 'guest', 
                        displayName: 'Guest User',
                        email: 'guest@dreamex-datalab.com'
                    };
                    this.updateUIForAuthenticatedUser();
                    // Try to obtain an auth context for RTDB operations
                    try { await this.auth.signInAnonymously(); console.log(' Signed in anonymously (auth state listener)'); } catch(e){ console.warn('Anonymous sign-in (auth state) failed', e); }
                }
            });

            // Check if we have stored user data
            if (this.currentUser && this.currentUser.uid !== 'guest') {
                await this.loadUserRole(this.currentUser);
                await this.loadUserCompany();
                this.updateUIForAuthenticatedUser();
            } else if (!this.currentUser) {
                // Set guest mode
                this.currentUser = { 
                    uid: 'guest', 
                    displayName: 'Guest User',
                    email: 'guest@dreamex-datalab.com'
                };
                this.updateUIForAuthenticatedUser();
                // Ensure we have an auth context for RTDB (anonymous)
                try { await this.auth.signInAnonymously(); console.log(' Signed in anonymously for RTDB access'); } catch(e){ console.warn('Anonymous sign-in failed', e); }
            }
            
        } catch (error) {
            console.error(' Error initializing centralized authentication:', error);
            // Fallback to guest mode
            this.currentUser = { 
                uid: 'guest', 
                displayName: 'Guest User',
                email: 'guest@dreamex-datalab.com'
            };
            this.updateUIForAuthenticatedUser();
        }
    }

    async loadUserData(user) {
        try {
            const snap = await this.db.ref(`users/${user.uid}`).once('value');
            const data = snap.val();
            
            if (data && data.companyId) {
                this.currentUser = { ...user, ...data };
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                await this.loadCompanyData(data.companyId);
                this.updateUIForAuthenticatedUser();
            } else {
                this.currentUser = user;
                this.updateUIForAuthenticatedUser();
            }
        } catch (e) {
            console.error('User load error', e);
        }
    }

    async loadCompanyData(cid) {
        try {
            const snap = await this.db.ref(`companies/${cid}`).once('value');
            this.currentCompany = snap.val();
        } catch (e) {
            console.error('Company load error', e);
        }
    }

    async loadUserRole(user) {
        try {
            if (!user || user.uid === 'guest') return;
            
            const userRef = this.db.ref(`users/${user.uid}`);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                this.currentUser = { ...user, ...userData };
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                console.log(' User role and data loaded:', userData.role);
            }
        } catch (error) {
            console.error('Error loading user role:', error);
        }
    }

    async loadUserCompany() {
        try {
            if (!this.currentUser || this.currentUser.uid === 'guest') return;
            
            const companyId = this.currentUser.companyId;
            if (companyId) {
                const companyRef = this.db.ref(`companies/${companyId}`);
                const snapshot = await companyRef.once('value');
                
                if (snapshot.exists()) {
                    this.currentCompany = snapshot.val();
                    this.updateCompanyBranding();
                    console.log(' Company data loaded:', this.currentCompany.companyName);
                }
            }
        } catch (error) {
            console.error('Error loading company data:', error);
        }
    }

    updateUIForAuthenticatedUser() {
        this.updateCompanyBranding();
        this.populateUserProfile();
        console.log(' UI updated for authenticated user');
    }

    updateCompanyBranding() {
        const logo = document.getElementById('headerCompanyLogo');
        const name = document.getElementById('headerCompanyName');
        
        if (!this.currentCompany) {
            if (logo) logo.style.display = 'none';
            if (name) name.textContent = 'Dreamex Datalab';
            return;
        }
        
        if (name) name.textContent = this.currentCompany.companyName || 'Dreamex Datalab';
        
        const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
        if (logo) {
            if (logoUrl) {
                logo.src = logoUrl;
                logo.style.display = 'block';
            } else {
                logo.style.display = 'none';
            }
        }
        
        // Apply company branding colors
        if (this.currentCompany.branding) {
            const root = document.documentElement;
            if (this.currentCompany.branding.primaryColor) {
                root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
            }
            if (this.currentCompany.branding.secondaryColor) {
                root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
            }
        }
    }

    getUserDisplayName() {
        if (!this.currentUser) return 'User';
        return this.currentUser.displayName || 
               (this.currentUser.firstName ? 
                `${this.currentUser.firstName} ${this.currentUser.lastName || ''}`.trim() : 
                (this.currentUser.email ? this.currentUser.email.split('@')[0] : 'User'));
    }

    getUserInitials() {
        const name = this.getUserDisplayName();
        const parts = name.split(' ').filter(Boolean);
        if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    async getUserAvatarUrl() {
        try {
            if (!this.currentUser || this.currentUser.uid === 'guest') return null;
            const uid = this.currentUser.uid;
            const companyId = this.currentUser.companyId;

            // 1) Auth photoURL
            if (this.auth?.currentUser?.photoURL) return this.auth.currentUser.photoURL;

            // 2) Database-provided URL fields
            try {
                const userSnap = await this.db.ref(`users/${uid}`).once('value');
                if (userSnap.exists()) {
                    const u = userSnap.val();
                    if (u?.avatarUrl) return u.avatarUrl;
                    if (u?.profilePhotoUrl) return u.profilePhotoUrl;
                    if (u?.photoURL) return u.photoURL;
                }
            } catch (_) {}

            // 3) Storage paths to try
            const exts = ['jpg','png','jpeg','webp'];
            const names = ['profile','avatar'];
            const candidates = [];
            if (companyId) {
                names.forEach(n => exts.forEach(ext => candidates.push(`companies/${companyId}/avatars/${uid}/${n}.${ext}`)));
                names.forEach(n => exts.forEach(ext => candidates.push(`companies/${companyId}/users/${uid}/${n}.${ext}`)));
            }
            names.forEach(n => exts.forEach(ext => candidates.push(`avatars/${uid}/${n}.${ext}`)));
            exts.forEach(ext => candidates.push(`profiles/${uid}/profile.${ext}`));
            names.forEach(n => exts.forEach(ext => candidates.push(`users/${uid}/${n}.${ext}`)));

            for (const path of candidates) {
                try {
                    const url = await this.storage.ref(path).getDownloadURL();
                    if (url) return url;
                } catch (_) { /* continue */ }
            }
            console.warn('Avatar not found for user:', uid);
            return null;
        } catch (e) {
            console.warn('getUserAvatarUrl error:', e);
            return null;
        }
    }

    generateInitialsAvatar(name, img) {
        const initials = this.getUserInitials();
        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12'];
        const bg = colors[initials.charCodeAt(0) % 5];
        const svg = `<svg width="40" height="40" xmlns='http://www.w3.org/2000/svg'>
            <rect width='40' height='40' rx='20' fill='${bg}'/>
            <text x='20' y='24' font-size='14' font-family='Arial' fill='#fff' text-anchor='middle' font-weight='600'>${initials}</text>
        </svg>`;
        img.src = 'data:image/svg+xml;base64,' + btoa(svg);
        img.style.display = 'block';
    }

    async populateUserProfile() {
        const btn = document.getElementById('userProfileBtn');
        if (!btn || !this.currentUser) return;
        const displayName = this.getUserDisplayName();
        const email = this.currentUser.email || '';
        let avatarUrl = null;
        try { avatarUrl = await this.getUserAvatarUrl(); } catch (e) { avatarUrl = null; }

        const btnImg = btn.querySelector('img');
        if (btnImg) {
            btnImg.onerror = () => this.generateInitialsAvatar(displayName, btnImg);
            if (avatarUrl) {
                btnImg.src = avatarUrl;
                btnImg.alt = displayName + ' Avatar';
                btnImg.style.display = 'block';
            } else {
                this.generateInitialsAvatar(displayName, btnImg);
            }
        } else {
            // ensure we render some initials inside the button if image tag missing
            btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
        }

        // Populate dropdown header with avatar/initials + quick links
        const list = document.querySelector('.profile-dropdown ul');
        if (list) {
            const avatarHtml = avatarUrl
                ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`
                : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
            list.innerHTML = `
                <li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        ${avatarHtml}
                        <div>
                            <div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div>
                            <div style="color:#666;font-size:12px;">${email}</div>
                        </div>
                    </div>
                </li>
                <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
                <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
            `;
            list.querySelector('#logoutLink')?.addEventListener('click', (e) => {
                e.preventDefault();
                this.logout();
            });
        }
    }

    async logout() {
        try {
            await this.auth.signOut();
            localStorage.removeItem('currentUser');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Logout error:', error);
            // Force logout even if Firebase fails
            localStorage.removeItem('currentUser');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    }

    // Load user role from Firebase
    async loadUserRole(user) {
        if (!user) return null;
        
        try {
            const companyId = await this.getCompanyId();
            if (!companyId) return null;
            
            const userRef = this.db.ref(`companies/${companyId}/users/${user.uid}`);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                this.currentUser.role = userData.role;
                console.log(' User role loaded:', userData.role);
                return userData.role;
            }
        } catch (error) {
            console.error('Error loading user role:', error);
        }
        
        return null;
    }

    // Apply role-based filtering to menu items
    async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
        try {
            console.log(' Applying role-based filtering for role:', userRole);
            
            // Get user role permissions from company
            const permissionsRef = this.db.ref(`companies/${companyId}/roles/${userRole}/permissions`);
            const permissionsSnapshot = await permissionsRef.once('value');
            
            if (!permissionsSnapshot.exists()) {
                console.log(` No permissions found for role ${userRole} in company ${companyId}`);
                
                // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                if (userRole === 'administrator') {
                    console.log(' ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                    return;
                }
                
                // For other roles without permissions, hide all items with permission requirements
                console.log(' No valid permissions found - filtering out items requiring permissions');
                this.hideItemsRequiringPermissions();
                return;
            }
            
            const permissions = permissionsSnapshot.val();
            console.log(' Loaded role permissions:', permissions);
            
            // Apply permission-based filtering
            this.filterMenuByPermissions(permissions);
            
        } catch (error) {
            console.error(' Error applying role-based filtering:', error);
            // Don't hide everything on error - keep company features visible
        }
    }

    // Filter currently visible menu items by role permissions
    filterMenuByPermissions(permissions) {
        console.log(' Filtering visible menu items by role permissions...');
        
        if (!permissions) {
            console.log(' No permissions object provided');
            this.hideItemsRequiringPermissions();
            return;
        }
        
        // Only check items that are already visible from company features
        const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
        console.log(` Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
        
        let hiddenCount = 0;
        visibleMenuItems.forEach(item => {
            const requiredPermission = item.getAttribute('data-requires-permission');
            if (requiredPermission) {
                const permVal = permissions[requiredPermission];
                const hasPermission = permVal === true || (permVal && permVal.view === true);
                if (!hasPermission) {
                    item.classList.remove('menu-visible');
                    hiddenCount++;
                    console.log(` Hidden menu item requiring permission: ${requiredPermission}`);
                } else {
                    console.log(` Kept menu item (permission granted): ${requiredPermission}`);
                }
            }
        });
        
        // Also check for dropdown menus that might now be empty
        this.hideEmptyDropdowns();
        
        console.log(` Role-based filtering complete: ${hiddenCount} items hidden`);
    }

    // Hide items that require permissions when no permissions are available
    hideItemsRequiringPermissions() {
        const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
        console.log(` Hiding ${itemsRequiringPermissions.length} items requiring permissions`);
        
        itemsRequiringPermissions.forEach(item => {
            item.classList.remove('menu-visible');
        });
        
        this.hideEmptyDropdowns();
    }

    // Hide dropdown menus that have no visible children
    hideEmptyDropdowns() {
        const dropdowns = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdowns.forEach(dropdown => {
            const visibleChildren = dropdown.querySelectorAll('.submenu li.menu-visible');
            if (visibleChildren.length === 0) {
                dropdown.classList.remove('menu-visible');
                console.log(' Hidden empty dropdown menu');
            }
        });
    }
}
// Feature-based menu visibility
function resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=> i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=> d.classList.remove('menu-visible')); }
// Only used as a last-resort fallback when feature/role loading truly fails
function showBasicMenu(){ 
    resetMenuVisibility();
    const sidebar=document.querySelector('.sidebar');
    if(sidebar) sidebar.classList.remove('menu-loading');
    console.log(' Fallback basic menu suppressed (no items made visible)');
}
// NEW: Unrestricted menu visibility once user is authenticated
function showAllMenus(){ const sidebar=document.querySelector('.sidebar'); document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(li=> li.classList.add('menu-visible')); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(li=> li.classList.add('menu-visible')); if(sidebar) sidebar.classList.remove('menu-loading'); }
async function updateMenuWithFeatureAuthorization(){ try { let user=null, companyId=null; if(window.authManager && window.authManager.currentUser){ user=window.authManager.currentUser; companyId=user.companyId; } else if(firebase.auth().currentUser){ user=firebase.auth().currentUser; } else { resetMenuVisibility(); return; } if(!companyId && user){ const db=firebase.database(); const companiesSnap=await db.ref('companies').once('value'); if(companiesSnap.exists()){ for(const [cid,comp] of Object.entries(companiesSnap.val())){ if(comp.status!=='active') continue; if(comp.users && comp.users[user.uid]){ companyId=cid; break; } } } } if(!companyId){ resetMenuVisibility(); return; } await applyFeatureBasedMenuVisibility(companyId); } catch(e){ console.error('Auth menu error',e); resetMenuVisibility(); } }
async function applyFeatureBasedMenuVisibility(companyId){ 
    try { 
        const db=firebase.database(); 
        const featuresSnap=await db.ref('/platformFeatures').once('value'); 
        if(!featuresSnap.exists()){ 
            resetMenuVisibility(); 
            return []; 
        } 
        
        const features=featuresSnap.val(); 
        const companySnap=await db.ref(`/companies/${companyId}`).once('value'); 
        const company=companySnap.val(); 
        if(!company){ 
            resetMenuVisibility(); 
            return []; 
        } 
        
        const selected=company.selectedFeatures||[]; 
        if(selected.length===0){ 
            resetMenuVisibility(); 
            return []; 
        } 
        
        const authorizedPages=[]; 
        selected.forEach(fid=>{ 
            const f=features[fid]; 
            if(f && f.status==='active' && f.authorizedPages){ 
                authorizedPages.push(...f.authorizedPages); 
            } 
        }); 
        
        resetMenuVisibility(); 
        const authFeatures=new Set(); 
        authorizedPages.forEach(p=>{ 
            if(p.feature) authFeatures.add(p.feature); 
        }); 
        
        const allItems=document.querySelectorAll('#roleBasedMenu li[data-feature]'); 
        allItems.forEach(it=>{ 
            const feat=it.getAttribute('data-feature'); 
            const isDrop=it.classList.contains('menu-dropdown'); 
            if(isDrop) return; 
            if(authFeatures.has(feat)) it.classList.add('menu-visible'); 
        }); 
        
        document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ 
            const feat=drop.getAttribute('data-feature'); 
            const hasChild=[...drop.querySelectorAll('.submenu li[data-feature]')].some(c=> c.classList.contains('menu-visible')); 
            if(hasChild || authFeatures.has(feat)) drop.classList.add('menu-visible'); 
        }); 
        
        // STEP 2: Apply role-based filtering after feature authorization
        if (window.authManager && window.authManager.currentUser) {
            console.log(' STEP 2: Applying role-based filtering within authorized features...');
            const userRole = window.authManager.currentUser.role;
            if (userRole && authorizedPages.length > 0) {
                await window.authManager.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
            } else {
                console.log(' STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
            }
        }
        
        document.querySelector('.sidebar')?.classList.remove('menu-loading'); 
        return authorizedPages;
    } catch(e){ 
        console.error('Apply feature visibility error',e); 
        resetMenuVisibility(); 
        return []; 
    } 
}
window.updateMenuWithFeatureAuthorization=updateMenuWithFeatureAuthorization;
// UI Interactions
function setupUIInteractions() {
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // Notification Bell functionality
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationDropdown = document.querySelector('.notification-dropdown');
    if (notificationBtn && notificationDropdown) {
        notificationBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown.classList.toggle('show');
        });
        
        document.addEventListener('click', (e) => {
            if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                notificationDropdown.classList.remove('show');
            }
        });
        
        const markAllReadBtn = document.querySelector('.mark-all-read');
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', () => {
                const badge = document.querySelector('.notification-badge');
                if (badge) badge.textContent = '0';
                
                const notifications = document.querySelectorAll('.notification-item.unread');
                notifications.forEach(notification => {
                    notification.classList.remove('unread');
                });
            });
        }
    }
    
    const profileBtn = document.getElementById('userProfileBtn');
    const profileDropdown = document.querySelector('.profile-dropdown');
    if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('show');
        });
        
        document.addEventListener('click', (e) => {
            if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
                profileDropdown.classList.remove('show');
            }
        });
    }
    
    restoreSidebarState();
}
async function toggleSidebar(){ 
    const s=document.querySelector('.sidebar'); 
    const m=document.querySelector('.main-content'); 
    if(s&&m){ 
        s.classList.toggle('collapsed'); 
        m.classList.toggle('sidebar-collapsed'); 
        const isCollapsed = s.classList.contains('collapsed');
        
        // Save to Firebase
        try {
            await CompanyStorage.saveData('sidebarCollapsed', isCollapsed);
        } catch (error) {
            console.error('Error saving sidebar state:', error);
            // Fallback to localStorage
            const key = `company_${CompanyStorage.getCompanyId()}_sidebarCollapsed`;
            localStorage.setItem(key, isCollapsed);
        }
    } 
}
async function restoreSidebarState(){ 
    try {
        const isCollapsed = await CompanyStorage.loadData('sidebarCollapsed', false);
        if(isCollapsed === true) {
            document.querySelector('.sidebar')?.classList.add('collapsed'); 
            document.querySelector('.main-content')?.classList.add('sidebar-collapsed'); 
        }
    } catch (error) {
        console.error('Error restoring sidebar state:', error);
        // Fallback to localStorage
        const key = `company_${CompanyStorage.getCompanyId()}_sidebarCollapsed`;
        if(localStorage.getItem(key)==='true'){ 
            document.querySelector('.sidebar')?.classList.add('collapsed'); 
            document.querySelector('.main-content')?.classList.add('sidebar-collapsed'); 
        }
    }
}
// Company-Scoped Data Storage with Firebase
const CompanyStorage = {
    getCompanyId() {
        const authManager = window.authManager;
        if (authManager && authManager.currentCompany && authManager.currentCompany.companyId) {
            return authManager.currentCompany.companyId;
        }
        if (authManager && authManager.currentUser && authManager.currentUser.companyId) {
            return authManager.currentUser.companyId;
        }
        return 'default'; // Fallback for guest mode
    },
    
    getFirebasePath(dataType) {
        const companyId = this.getCompanyId();
        return `companies/${companyId}/campData/${dataType}`;
    },
    
    async saveData(dataType, data) {
        try {
            const companyId = this.getCompanyId();
            const path = this.getFirebasePath(dataType);
            console.log(` Company-scoped save for company: ${companyId}`);
            console.log(` Firebase path: ${path}`);
            console.log(` Data type: ${dataType}, Records: ${Array.isArray(data) ? data.length : 'N/A'}`);
            
            const database = firebase.database();
            await database.ref(path).set(data);
            console.log(` Successfully saved ${dataType} to company-scoped Firebase`);
            
            // Also save to localStorage as backup
            const localKey = `company_${companyId}_${dataType}`;
            localStorage.setItem(localKey, JSON.stringify(data));
            console.log(` Backup saved to localStorage: ${localKey}`);
        } catch (error) {
            console.error(` Error saving ${dataType} to Firebase:`, error);
            console.log(` Falling back to localStorage only...`);
            // Fallback to localStorage only
            const localKey = `company_${this.getCompanyId()}_${dataType}`;
            localStorage.setItem(localKey, JSON.stringify(data));
        }
    },
    
    async loadData(dataType, defaultValue = []) {
        try {
            const path = this.getFirebasePath(dataType);
            const database = firebase.database();
            const snapshot = await database.ref(path).once('value');
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                console.log(` Loaded ${dataType} from Firebase:`, path);
                
                // Save to localStorage as cache
                const localKey = `company_${this.getCompanyId()}_${dataType}`;
                localStorage.setItem(localKey, JSON.stringify(data));
                
                return data;
            } else {
                console.log(` No Firebase data for ${dataType}, checking localStorage...`);
                // Try localStorage as fallback
                const localKey = `company_${this.getCompanyId()}_${dataType}`;
                const stored = localStorage.getItem(localKey);
                if (stored) {
                    console.log(` Loaded ${dataType} from localStorage fallback`);
                    return JSON.parse(stored);
                }
            }
        } catch (error) {
            console.error(` Error loading ${dataType} from Firebase:`, error);
            // Fallback to localStorage
            const localKey = `company_${this.getCompanyId()}_${dataType}`;
            const stored = localStorage.getItem(localKey);
            if (stored) {
                console.log(` Loaded ${dataType} from localStorage fallback`);
                return JSON.parse(stored);
            }
        }
        return defaultValue;
    },
    
    async clearCompanyData() {
        try {
            const companyId = this.getCompanyId();
            const database = firebase.database();
            await database.ref(`companies/${companyId}/campData`).remove();
            console.log(` Cleared Firebase data for company: ${companyId}`);
            
            // Also clear localStorage
            const keys = ['rooms', 'roomTypes', 'amenities', 'sidebarCollapsed'];
            keys.forEach(key => {
                const storageKey = `company_${companyId}_${key}`;
                localStorage.removeItem(storageKey);
            });
        } catch (error) {
            console.error(' Error clearing company data from Firebase:', error);
        }
    },
    
    async getStorageInfo() {
        try {
            const companyId = this.getCompanyId();
            const database = firebase.database();
            const snapshot = await database.ref(`companies/${companyId}/campData`).once('value');
            
            const info = { companyId, storage: {} };
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                info.storage.rooms = Array.isArray(data.rooms) ? data.rooms.length : 0;
                info.storage.roomTypes = Array.isArray(data.roomTypes) ? data.roomTypes.length : 0;
                info.storage.amenities = Array.isArray(data.amenities) ? data.amenities.length : 0;
            } else {
                info.storage = { rooms: 0, roomTypes: 0, amenities: 0 };
            }
            
            return info;
        } catch (error) {
            console.error(' Error getting storage info:', error);
            return { companyId: this.getCompanyId(), storage: { rooms: 0, roomTypes: 0, amenities: 0 } };
        }
    }
};

// Data (company-scoped storage)
let roomTypes=[]; let rooms=[]; let amenities=[]; let editingRoomId=null; let editingRoomTypeId=null; let editingAmenityCode=null;
// Holds the Rooms Inventory tab's current visible list (post-filters)
window.visibleRooms = Array.isArray(window.visibleRooms) ? window.visibleRooms : undefined;

// Shared getter so Analytics always uses the same data source as Rooms Inventory
function getVisibleRooms(){
    if (Array.isArray(window.visibleRooms)) return window.visibleRooms;
    // Fallback excludes Kamsar as per requirement
    return Array.isArray(rooms) ? rooms.filter(r => !isExcludedByLocation(r)) : [];
}
async function initCampSettings(){ 
    // Load only from company-scoped Firebase; do not seed hardcoded rooms
    await loadCompanyData();
    await seedDefaults(); 
    renderRoomTypes(); 
    renderAmenities(); 
    renderRooms(); 
    populateFilters(); 
    // Populate room type selects from settings
    await populateRoomTypeSelects();
    // Populate area dropdown from settings (fieldOptions/area)
    await populateAreaDropdown();
    // Subscribe to realtime rooms updates
    const cid = getActiveCompanyId();
    if (cid) subscribeToRooms(cid);
}

async function loadCompanyData() {
    try {
        roomTypes = await CompanyStorage.loadData('roomTypes', []);
        amenities = await CompanyStorage.loadData('amenities', []);
        
        // Load rooms from legacy company path (primary), fallback to campData/rooms
        console.log(' Loading rooms from Firebase (company legacy path)...');
    const companyId = getActiveCompanyId();
    if (!companyId){ console.warn('No active companyId; skipping rooms load'); rooms = []; renderRooms(); updateRoomStats(); return; }
        let roomsData = null;
        const db = getDb();
        if (db){
            try {
                let snap = await db.ref(`companies/${companyId}/rooms`).once('value');
                if (!snap.exists()) {
                    console.log(' Legacy path empty; trying campData/rooms');
                    snap = await db.ref(`companies/${companyId}/campData/rooms`).once('value');
                }
                if (snap.exists()) roomsData = snap.val();
            } catch (e){ console.warn(' SDK rooms fetch failed; will try REST', e); }
        }
        if (!roomsData){
            try {
                const base = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}`;
                let auth = '';
                try { const u = firebase.auth().currentUser; if (u) { const t = await u.getIdToken(false); if (t) auth = `?auth=${t}`; } } catch(_){}
                let resp = await fetch(`${base}/rooms.json${auth}`);
                if (!resp.ok) resp = await fetch(`${base}/campData/rooms.json${auth}`);
                if (resp.ok) roomsData = await resp.json();
            } catch(e){ console.warn(' REST rooms fetch failed:', e); }
        }

        if (roomsData && typeof roomsData === 'object') {
            rooms = Object.keys(roomsData).map(key => ({ id: key, ...roomsData[key] }));
            console.log(' Loaded rooms from Firebase:', rooms.length);
        } else {
            console.warn(' No rooms data in Firebase for company; using empty list');
            rooms = [];
        }
        
        console.log(' Loaded company data - Rooms:', rooms.length, 'Room Types:', roomTypes.length, 'Amenities:', amenities.length);
        
        // Force re-render rooms after loading
        setTimeout(() => {
            console.log(' Force rendering rooms after data load...');
            renderRooms();
            updateRoomStats();
        }, 100);
        
    } catch (error) {
        console.error(' Error loading company data:', error);
        // Use empty arrays as fallback
        roomTypes = [];
        rooms = [];
        amenities = [];
        updateRoomStats([]);
    }
}

async function saveCompanyData() {
    try {
        console.log(' Saving company data to Firebase...');
        console.log(' Data being saved - Room Types:', roomTypes.length, 'Rooms:', rooms.length, 'Amenities:', amenities.length);
        
        // Save room types and amenities to company storage
        await Promise.all([
            CompanyStorage.saveData('roomTypes', roomTypes),
            CompanyStorage.saveData('amenities', amenities)
        ]);
        
        // Save rooms to specific Firebase paths (SDK preferred, fallback to REST)
        console.log(' Saving rooms to Firebase (campData/rooms and legacy rooms)...');
        const roomsObject = {};
        rooms.forEach(room => { const { id, ...roomData } = room; roomsObject[id] = roomData; });
    const companyId = getActiveCompanyId();
    if (!companyId){ alert('No active company selected. Cannot save rooms.'); return; }
        let saved = false;
        const db = getDb();
        if (db){
            try {
                await Promise.all([
                    db.ref(`companies/${companyId}/campData/rooms`).set(roomsObject),
                    db.ref(`companies/${companyId}/rooms`).set(roomsObject)
                ]);
                saved = true;
            } catch(e){ console.warn(' SDK save failed; trying REST', e); }
        }
        if (!saved){
            const base = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}`;
            let auth = '';
            try { const u = firebase.auth().currentUser; if (u) { const t = await u.getIdToken(false); if (t) auth = `?auth=${t}`; } } catch(_){}
            const [respCampData, respLegacy] = await Promise.all([
                fetch(`${base}/campData/rooms.json${auth}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(roomsObject) }),
                fetch(`${base}/rooms.json${auth}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(roomsObject) })
            ]);
            if (respCampData.ok && respLegacy.ok) saved = true; else console.warn(' REST save failed', { campDataStatus: respCampData.status, legacyStatus: respLegacy.status });
        }
        if (!saved){
            console.warn(' Failed to save rooms remotely, saving to local storage as fallback');
            await CompanyStorage.saveData('rooms', rooms);
        } else {
            console.log(' Rooms saved successfully to Firebase (both paths)');
        }
        
        console.log(' All company data saved successfully to Firebase');
    } catch (error) {
        console.error(' Error saving company data to Firebase:', error);
        throw error; // Re-throw to see if this causes issues
    }
}

// Upsert a subset of rooms directly to Firebase (company scope)
// Accepts array of room objects with id field; builds a PATCH payload
async function upsertRoomsToFirebase(roomSubset){
    try{
        const list = Array.isArray(roomSubset) ? roomSubset.filter(r => r && r.id) : [];
        if (list.length === 0) return;
        const payload = {};
        list.forEach(r => {
            const { id, ...data } = r;
            payload[id] = data;
        });
    const companyId = getActiveCompanyId();
    if (!companyId){ console.warn('No active companyId; skipping upsert'); return; }
        const db = getDb();
        let ok = false;
        if (db){
            try {
                await Promise.all([
                    db.ref(`companies/${companyId}/campData/rooms`).update(payload),
                    db.ref(`companies/${companyId}/rooms`).update(payload)
                ]);
                ok = true;
            } catch(e){ console.warn(' SDK upsert failed; trying REST', e); }
        }
        if (!ok){
            const base = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}`;
            let auth = '';
            try { const u = firebase.auth().currentUser; if (u) { const t = await u.getIdToken(false); if (t) auth = `?auth=${t}`; } } catch(_){}
            const [respCampData, respLegacy] = await Promise.all([
                fetch(`${base}/campData/rooms.json${auth}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }),
                fetch(`${base}/rooms.json${auth}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
            ]);
            ok = respCampData.ok && respLegacy.ok;
        }
        if (ok) console.log(` Upserted ${list.length} room(s) to Firebase (campData/rooms and rooms)`);
        else console.warn(' upsertRoomsToFirebase partial/failed');
    } catch(e){ console.error(' upsertRoomsToFirebase error', e); }
}

// Delete a set of room IDs directly from Firebase (company scope); removes from both paths
async function deleteRoomsFromFirebase(ids){
    try{
        const list = Array.isArray(ids) ? ids.filter(Boolean) : [];
        if (list.length === 0) return;
        const companyId = getActiveCompanyId();
        if (!companyId){ console.warn('No active companyId; skipping remote delete'); return; }
        // Build a multi-path null update payload
        const payload = {};
        list.forEach(id => { payload[id] = null; });
        const db = getDb();
        let ok = false;
        if (db){
            try {
                await Promise.all([
                    db.ref(`companies/${companyId}/campData/rooms`).update(payload),
                    db.ref(`companies/${companyId}/rooms`).update(payload)
                ]);
                ok = true;
            } catch(e){ console.warn(' SDK bulk delete failed; trying REST', e); }
        }
        if (!ok){
            const base = `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}`;
            let auth = '';
            try { const u = firebase.auth().currentUser; if (u) { const t = await u.getIdToken(false); if (t) auth = `?auth=${t}`; } } catch(_){}
            const body = JSON.stringify(payload);
            const [respCamp, respLegacy] = await Promise.all([
                fetch(`${base}/campData/rooms.json${auth}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body }),
                fetch(`${base}/rooms.json${auth}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body })
            ]);
            ok = respCamp.ok && respLegacy.ok;
        }
        if (ok) console.log(` Deleted ${list.length} room(s) from Firebase (campData/rooms and rooms)`);
        else console.warn(' deleteRoomsFromFirebase partial/failed');
    } catch(e){ console.error(' deleteRoomsFromFirebase error', e); }
}

// Verification function to check Firebase data after deletion
async function verifyFirebaseData() {
    try {
        console.log(' Verifying Firebase data...');
        const firebaseRoomTypes = await CompanyStorage.loadData('roomTypes', []);
        console.log(' Firebase room types count:', firebaseRoomTypes.length);
        console.log(' Firebase room types:', firebaseRoomTypes.map(rt => ({ name: rt.name, code: rt.code, id: rt.id })));
        console.log(' Local room types count:', roomTypes.length);
        console.log(' Local room types:', roomTypes.map(rt => ({ name: rt.name, code: rt.code, id: rt.id })));
        
        if (firebaseRoomTypes.length === roomTypes.length) {
            console.log(' Firebase and local data match!');
        } else {
            console.warn(' Firebase and local data counts do not match!');
        }
        
        return firebaseRoomTypes;
    } catch (error) {
        console.error(' Error verifying Firebase data:', error);
        return null;
    }
}

// Work Areas / Sites Management
async function loadWorkAreas() {
    try {
        const companyId = CompanyStorage.getCompanyId();
        const database = firebase.database();
        
        // Try to load from companies/{companyId}/fieldOptions/area first
        let snapshot = await database.ref(`companies/${companyId}/fieldOptions/area`).once('value');
        
        if (!snapshot.exists()) {
            // Fallback to companies/{companyId}/settings/fieldOptions/area
            snapshot = await database.ref(`companies/${companyId}/settings/fieldOptions/area`).once('value');
        }
        
        if (snapshot.exists()) {
            const workAreas = snapshot.val();
            console.log(' Loaded work areas from Firebase:', workAreas);
            return workAreas.filter(area => area.enabled !== false); // Only return enabled areas
        } else {
            // Fallback to default work areas
            console.log(' Using default work areas');
            return [
                { label: 'Production', value: 'production', color: '#0d6efd', enabled: true },
                { label: 'Warehouse', value: 'warehouse', color: '#6f42c1', enabled: true },
                { label: 'Laboratory', value: 'laboratory', color: '#fd7e14', enabled: true },
                { label: 'Office', value: 'office', color: '#198754', enabled: true }
            ];
        }
    } catch (error) {
        console.error(' Error loading work areas:', error);
        // Return default work areas as fallback
        return [
            { label: 'Production', value: 'production', color: '#0d6efd', enabled: true },
            { label: 'Warehouse', value: 'warehouse', color: '#6f42c1', enabled: true },
            { label: 'Laboratory', value: 'laboratory', color: '#fd7e14', enabled: true },
            { label: 'Office', value: 'office', color: '#198754', enabled: true }
        ];
    }
}

// Room Types Management from Settings
async function loadRoomTypesFromSettings() {
    try {
        const companyId = CompanyStorage.getCompanyId();
        const database = firebase.database();
        
        console.log(' Loading room types from settings system...');
        
        // Try to load from companies/{companyId}/fieldOptions/room-type first
        let snapshot = await database.ref(`companies/${companyId}/fieldOptions/room-type`).once('value');
        
        if (!snapshot.exists()) {
            // Fallback to companies/{companyId}/settings/fieldOptions/room-type
            snapshot = await database.ref(`companies/${companyId}/settings/fieldOptions/room-type`).once('value');
        }
        
        if (snapshot.exists()) {
            const roomTypeOptions = snapshot.val();
            console.log(' Loaded room types from settings Firebase:', roomTypeOptions);
            
            // Convert settings format to campset format
            const convertedRoomTypes = roomTypeOptions
                .filter(option => option.enabled !== false)
                .map(option => ({
                    code: option.value,
                    name: option.label,
                    color: option.color || '#0d6efd',
                    enabled: option.enabled !== false
                }));
                
            return convertedRoomTypes;
        } else {
            // Fallback to default room types from settings
            console.log(' Using default room types from settings');
            return [
                { code: 'single', name: 'Single Room', color: '#0d6efd', enabled: true },
                { code: 'double', name: 'Double Room', color: '#198754', enabled: true },
                { code: 'triple', name: 'Triple Room', color: '#fd7e14', enabled: true },
                { code: 'dormitory', name: 'Dormitory', color: '#6f42c1', enabled: true },
                { code: 'suite', name: 'Suite', color: '#20c997', enabled: true },
                { code: 'executive', name: 'Executive Room', color: '#dc3545', enabled: true }
            ];
        }
    } catch (error) {
        console.error(' Error loading room types from settings:', error);
        
        // Try localStorage fallback
        try {
            const storageKey = `fieldOptions_room-type`;
            const localData = localStorage.getItem(storageKey);
            
            if (localData) {
                const roomTypeOptions = JSON.parse(localData);
                console.log(' Loaded room types from localStorage:', roomTypeOptions);
                
                const convertedRoomTypes = roomTypeOptions
                    .filter(option => option.enabled !== false)
                    .map(option => ({
                        code: option.value,
                        name: option.label,
                        color: option.color || '#0d6efd',
                        enabled: option.enabled !== false
                    }));
                    
                return convertedRoomTypes;
            }
        } catch (localError) {
            console.error(' Error loading from localStorage:', localError);
        }
        
        // Final fallback to default room types
        return [
            { code: 'single', name: 'Single Room', color: '#0d6efd', enabled: true },
            { code: 'double', name: 'Double Room', color: '#198754', enabled: true },
            { code: 'triple', name: 'Triple Room', color: '#fd7e14', enabled: true },
            { code: 'dormitory', name: 'Dormitory', color: '#6f42c1', enabled: true },
            { code: 'suite', name: 'Suite', color: '#20c997', enabled: true },
            { code: 'executive', name: 'Executive Room', color: '#dc3545', enabled: true }
        ];
    }
}

async function populateRoomTypeSiteSelect() {
    try {
        const siteSelect = document.getElementById('roomTypeSiteSelect');
        if (!siteSelect) return;
        
        console.log(' Populating site select dropdown...');
        const workAreas = await loadWorkAreas();
        
        siteSelect.innerHTML = '<option value="">Select Site</option>' + 
            workAreas.map(area => 
                `<option value="${area.value}">${area.label}</option>`
            ).join('');
            
        console.log(' Site dropdown populated with', workAreas.length, 'work areas');
    } catch (error) {
        console.error(' Error populating site select:', error);
    }
}

async function seedDefaults(){ if(roomTypes.length===0){ roomTypes=[{id:genId(), name:'Single', code:'SGL', site:'office', capacity:1, beds:1, defaultAmenities:['AC','BED','DESK'], description:'Single occupancy standard room.'},{id:genId(), name:'Double', code:'DBL', site:'warehouse', capacity:2, beds:2, defaultAmenities:['AC','BED','WARDROBE'], description:'Double shared accommodation.'}]; }
 if(amenities.length===0){ amenities=[
        // Essential Comfort & Climate
        {code:'AC', name:'Air Conditioning', category:'climate', icon:'fa-snowflake', isDefault:true, active:true, description:'Individual room air conditioning unit'},
        {code:'HTR', name:'Heating', category:'climate', icon:'fa-fire', isDefault:true, active:true, description:'Room heating system for cold climates'},
        {code:'FAN', name:'Ceiling Fan', category:'climate', icon:'fa-fan', isDefault:false, active:true, description:'Ceiling-mounted ventilation fan'},
        {code:'BED', name:'Bed', category:'comfort', icon:'fa-bed', isDefault:true, active:true, description:'Single or double bed with mattress'},
        {code:'PILLOW', name:'Pillows & Bedding', category:'comfort', icon:'fa-bed', isDefault:true, active:true, description:'Complete bedding set with pillows'},
        {code:'DESK', name:'Work Desk', category:'utility', icon:'fa-chair', isDefault:true, active:true, description:'Personal work desk with chair'},
        {code:'CHAIR', name:'Seating', category:'comfort', icon:'fa-chair', isDefault:false, active:true, description:'Additional seating furniture'},
        
        // Storage & Organization
        {code:'WARDROBE', name:'Wardrobe', category:'utility', icon:'fa-tshirt', isDefault:true, active:true, description:'Built-in clothing storage'},
        {code:'DRAWERS', name:'Chest of Drawers', category:'utility', icon:'fa-box', isDefault:false, active:true, description:'Personal item storage drawers'},
        {code:'LOCKER', name:'Personal Locker', category:'utility', icon:'fa-lock', isDefault:true, active:true, description:'Secure personal storage locker'},
        {code:'SHELF', name:'Shelving', category:'utility', icon:'fa-list', isDefault:false, active:true, description:'Wall-mounted or freestanding shelves'},
        {code:'HOOK', name:'Wall Hooks', category:'utility', icon:'fa-coat-hanger', isDefault:false, active:true, description:'Wall hooks for clothing and bags'},
        
        // Technology & Connectivity
        {code:'WIFI', name:'WiFi', category:'media', icon:'fa-wifi', isDefault:true, active:true, description:'High-speed wireless internet'},
        {code:'TV', name:'Television', category:'media', icon:'fa-tv', isDefault:false, active:true, description:'Flat screen TV with cable/satellite'},
        {code:'USB', name:'USB Charging', category:'media', icon:'fa-usb', isDefault:true, active:true, description:'Multiple USB charging ports'},
        {code:'OUTLET', name:'Power Outlets', category:'utility', icon:'fa-plug', isDefault:true, active:true, description:'Adequate electrical outlets'},
        {code:'LAMP', name:'Reading Lamp', category:'utility', icon:'fa-lightbulb', isDefault:false, active:true, description:'Personal reading/work lamp'},
        {code:'PHONE', name:'Telephone', category:'media', icon:'fa-phone', isDefault:false, active:true, description:'Room telephone for communication'},
        
        // Bathroom & Hygiene
        {code:'ENSUITE', name:'Ensuite Bathroom', category:'hygiene', icon:'fa-bath', isDefault:false, active:true, description:'Private bathroom facility'},
        {code:'SINK', name:'Washbasin', category:'hygiene', icon:'fa-hand-sparkles', isDefault:true, active:true, description:'Personal washbasin'},
        {code:'SHOWER', name:'Private Shower', category:'hygiene', icon:'fa-shower', isDefault:false, active:true, description:'Individual shower facility'},
        {code:'MIRROR', name:'Mirror', category:'hygiene', icon:'fa-mirror', isDefault:true, active:true, description:'Personal grooming mirror'},
        {code:'TOWEL', name:'Towel Rail', category:'hygiene', icon:'fa-hand-paper', isDefault:false, active:true, description:'Towel hanging rail'},
        {code:'TOILET', name:'Private Toilet', category:'hygiene', icon:'fa-toilet', isDefault:false, active:true, description:'Individual toilet facility'},
        
        // Safety & Security
        {code:'SMOKE', name:'Smoke Detector', category:'safety', icon:'fa-fire-extinguisher', isDefault:true, active:true, description:'Smoke detection system'},
        {code:'FIRE', name:'Fire Extinguisher', category:'safety', icon:'fa-fire-extinguisher', isDefault:false, active:true, description:'Personal fire extinguisher'},
        {code:'FIRSTAID', name:'First Aid Kit', category:'safety', icon:'fa-medkit', isDefault:false, active:true, description:'Basic first aid supplies'},
        {code:'KEYCARD', name:'Keycard Access', category:'safety', icon:'fa-key', isDefault:true, active:true, description:'Electronic keycard entry system'},
        {code:'DEADBOLT', name:'Security Lock', category:'safety', icon:'fa-lock', isDefault:true, active:true, description:'Additional security deadbolt'},
        {code:'SAFE', name:'Personal Safe', category:'safety', icon:'fa-vault', isDefault:false, active:true, description:'Personal valuables safe'},
        {code:'EMERGENCY', name:'Emergency Lighting', category:'safety', icon:'fa-lightbulb', isDefault:true, active:true, description:'Battery backup emergency lighting'},
        
        // Kitchen & Food Prep
        {code:'FRIDGE', name:'Mini Refrigerator', category:'kitchen', icon:'fa-cube', isDefault:false, active:true, description:'Personal mini fridge'},
        {code:'MICRO', name:'Microwave', category:'kitchen', icon:'fa-microchip', isDefault:false, active:true, description:'Shared or personal microwave'},
        {code:'KETTLE', name:'Electric Kettle', category:'kitchen', icon:'fa-coffee', isDefault:false, active:true, description:'Hot water kettle'},
        {code:'COFFEE', name:'Coffee Maker', category:'kitchen', icon:'fa-coffee', isDefault:false, active:true, description:'Personal coffee/tea making facility'},
        {code:'WATER', name:'Water Dispenser', category:'kitchen', icon:'fa-tint', isDefault:false, active:true, description:'Filtered water access'},
        
        // Laundry & Maintenance
        {code:'LAUNDRY', name:'Laundry Bag', category:'utility', icon:'fa-tshirt', isDefault:false, active:true, description:'Personal laundry collection'},
        {code:'IRON', name:'Iron & Board', category:'utility', icon:'fa-tshirt', isDefault:false, active:true, description:'Ironing facilities'},
        {code:'VACUUM', name:'Vacuum Access', category:'utility', icon:'fa-broom', isDefault:false, active:true, description:'Room cleaning equipment access'},
        
        // Comfort & Recreation
        {code:'CURTAIN', name:'Blackout Curtains', category:'comfort', icon:'fa-window-maximize', isDefault:true, active:true, description:'Light-blocking window coverings'},
        {code:'CARPET', name:'Carpet/Rug', category:'comfort', icon:'fa-square', isDefault:false, active:true, description:'Floor covering for comfort'},
        {code:'AIRPUR', name:'Air Purifier', category:'climate', icon:'fa-wind', isDefault:false, active:true, description:'Room air purification system'},
        {code:'BALCONY', name:'Balcony/Patio', category:'comfort', icon:'fa-tree', isDefault:false, active:true, description:'Private outdoor space'},
        {code:'READING', name:'Reading Area', category:'comfort', icon:'fa-book', isDefault:false, active:true, description:'Dedicated reading space'},
        
        // Environmental Controls
        {code:'THERMO', name:'Thermostat', category:'climate', icon:'fa-thermometer-half', isDefault:false, active:true, description:'Individual temperature control'},
        {code:'HUMID', name:'Humidifier', category:'climate', icon:'fa-tint', isDefault:false, active:true, description:'Room humidity control'},
        {code:'VENT', name:'Ventilation', category:'climate', icon:'fa-wind', isDefault:true, active:true, description:'Proper room ventilation system'},
        
        // Accessibility & Special Needs
        {code:'WHEEL', name:'Wheelchair Access', category:'accessibility', icon:'fa-wheelchair', isDefault:false, active:true, description:'Wheelchair accessible features'},
        {code:'GRAB', name:'Grab Bars', category:'accessibility', icon:'fa-hand-paper', isDefault:false, active:true, description:'Safety grab bars in bathroom'},
        {code:'MEDICAL', name:'Medical Equipment Space', category:'accessibility', icon:'fa-medkit', isDefault:false, active:true, description:'Space for medical equipment'},
        
        // Communication & Information
        {code:'NOTICE', name:'Notice Board', category:'utility', icon:'fa-clipboard', isDefault:false, active:true, description:'Personal information display'},
        {code:'CALENDAR', name:'Calendar/Planner', category:'utility', icon:'fa-calendar', isDefault:false, active:true, description:'Personal scheduling aid'},
        
        // Luxury & Premium
        {code:'MINI', name:'Mini Bar', category:'luxury', icon:'fa-wine-glass', isDefault:false, active:true, description:'Premium mini bar facility'},
        {code:'PREMIUM', name:'Premium Bedding', category:'luxury', icon:'fa-crown', isDefault:false, active:true, description:'High-quality bedding package'},
        {code:'SOUND', name:'Sound System', category:'luxury', icon:'fa-music', isDefault:false, active:true, description:'Personal audio entertainment'},
        {code:'GAME', name:'Gaming Setup', category:'luxury', icon:'fa-gamepad', isDefault:false, active:true, description:'Gaming console or setup'}
    ]; }
 // Keep rooms array empty - no hardcoded simulation data
 // Save initial data if any defaults were created
 if(roomTypes.length > 0 || amenities.length > 0) {
     await saveCompanyData();
 }
}
function genId(){ return 'id_'+Math.random().toString(36).slice(2,10); }
// Rendering
// Track selected room IDs for bulk actions
window.selectedRoomIds = window.selectedRoomIds || new Set();
// Temporary code filter applied right after creation to limit view strictly to new rooms
window.__tempCodesFilter = window.__tempCodesFilter || null;

function renderRooms(){ 
    // keep dropdown options synced to current data
    populateRoomFilterDropdowns();
    console.log(' renderRooms called - rooms array length:', rooms.length);
    console.log(' Current rooms data:', rooms);
    
    const tbody=document.getElementById('roomsTbody'); 
    if(!tbody) {
        console.error(' roomsTbody element not found!');
        return;
    }
    
    if(!rooms.length){ 
        console.log(' No rooms to display');
        window.visibleRooms = [];
        tbody.innerHTML='<tr><td colspan="8" class="empty-state">No rooms defined</td></tr>'; 
        updateSelectionUi();
        return;
    } 
    
    const typeMap=Object.fromEntries(roomTypes.map(t=>[t.code,t])); 
    // Column filters - dropdowns
    const getSel = id => (document.getElementById(id)?.value || '').trim();
    const fRoom = getSel('filterRoomSel');
    const fType = getSel('filterTypeSel');
    const fLoc = getSel('filterLocationSel');
    const fComp = getSel('filterCompanySel');
    const fStatus = getSel('filterStatusSel');
    const fUpdated = getSel('filterUpdatedSel'); // exact date (YYYY-MM-DD)

    // Start from non-excluded dataset (remove Kamsar)
    let filtered = rooms.slice().filter(r => !isExcludedByLocation(r)).filter(r => {
        const roomDisplay = (r.name ? `${r.code}  ${r.name}` : (r.code || '')).trim();
        const roomText = roomDisplay.toLowerCase();
        const typeText = (r.type || '').toLowerCase();
        const locText = ((r.location && r.location.block) ? r.location.block : '').toLowerCase();
        const compText = (r.forCompanyName || (r.forCompany && r.forCompany.name) || '').toLowerCase();
        const statusText = (r.status || '').toLowerCase();
        const updatedIso = r.updated ? new Date(r.updated).toISOString().slice(0,10) : '';
        const updatedText = r.updated ? updatedIso.toLowerCase() : '';

        return (!fRoom || roomText === fRoom.toLowerCase())
            && (!fType || typeText === fType.toLowerCase())
            && (!fLoc || locText === fLoc.toLowerCase())
            && (!fComp || compText === fComp.toLowerCase())
            && (!fStatus || statusText === fStatus.toLowerCase())
            && (!fUpdated || updatedText === fUpdated.toLowerCase());
    }); 

    // Apply temporary code filter if present (e.g., right after bulk create)
    try {
        if (window.__tempCodesFilter && window.__tempCodesFilter.size > 0) {
            const set = window.__tempCodesFilter;
            filtered = filtered.filter(r => r && r.code && set.has(String(r.code).toLowerCase()));
        }
    } catch(_){}
    
    // Sort by natural order of the room label (e.g., NMC-DTP-2 before NMC-DTP-10)
    filtered.sort((a,b)=>{
        const aLabel = (a.name ? `${a.code}  ${a.name}` : (a.code || '')).trim();
        const bLabel = (b.name ? `${b.code}  ${b.name}` : (b.code || '')).trim();
        return naturalCompare(aLabel, bLabel);
    });
    console.log(' Filtered rooms:', filtered.length, 'out of', rooms.length);
    
    // Expose filtered list for Analytics data source parity
    window.visibleRooms = filtered.slice();

    if(!filtered.length){ 
        tbody.innerHTML='<tr><td colspan="8" class="empty-state">No rooms match filters</td></tr>'; 
        // Update stats even when empty to reflect filters
        updateRoomStats(filtered);
        updateSelectionUi();
        return;
    } 
    
    tbody.innerHTML=filtered.map(r=>{ 
        const t=typeMap[r.type]; 
        const statusBadge= badgeForStatus(r.status || 'Unknown'); 
        const roomLabel = r.name ? `${r.code}  ${r.name}` : (r.code || 'No Code'); 
    const locationBlock = (r.location && r.location.block) ? r.location.block : '';
    const companyName = r.forCompanyName || (r.forCompany && r.forCompany.name) || '';
        const updatedTime = r.updated ? timeAgo(r.updated) : 'Unknown';
        
        // Capitalize first letter of type name
        const typeDisplay = t ? capitalizeFirst(t.name) : capitalizeFirst(r.type || 'Unknown');
        
        const checked = window.selectedRoomIds.has(r.id) ? 'checked' : '';
        return `<tr>
            <td style='text-align:center;'><input type='checkbox' data-room-id='${r.id}' ${checked} onchange='onRowSelectChange(this)' /></td>
            <td>${roomLabel}</td>
            <td>${typeDisplay}</td>
            <td>${locationBlock}</td>
            <td>${companyName}</td>
            <td>${statusBadge}</td>
            <td>${updatedTime}</td>
            <td>
                <div class='inline-actions'>
                    <button class='btn btn-outline' onclick="editRoom('${r.id}')"><i class='fa fa-pen'></i></button>
                    <button class='btn btn-outline' onclick="duplicateRoom('${r.id}')"><i class='fa fa-copy'></i></button>
                    <button class='btn btn-outline' onclick="deleteRoom('${r.id}')"><i class='fa fa-trash'></i></button>
                </div>
            </td>
        </tr>`; 
    }).join(''); 
    
    // Update stats based on the same filtered dataset
    updateRoomStats(filtered);
    // Also refresh analytics if Analytics tab is visible
    maybeRenderAnalytics();
    // Sync master checkbox state and selection UI
    syncSelectAllCheckbox();
    updateSelectionUi();
    
    console.log(' Rooms table rendered successfully');
}
// Populate and hook up dropdown filters once, and refresh before each render
function populateRoomFilterDropdowns(){
    try {
        const by = (arr, mapFn) => Array.from(new Set(arr.map(mapFn).filter(v => v && v.trim()))).sort((a,b)=>a.localeCompare(b));
        const dateStr = ts => ts ? new Date(ts).toISOString().slice(0,10) : '';
        const src = rooms.filter(r => !isExcludedByLocation(r));
        const values = {
            room: by(src, r => (r.name ? `${r.code}  ${r.name}` : (r.code || '')).trim()).sort(naturalCompare),
            type: by(src, r => (r.type || '').trim()),
            location: by(src, r => ((r.location && r.location.block) ? r.location.block : '').trim()),
            company: by(src, r => (r.forCompanyName || (r.forCompany && r.forCompany.name) || '').trim()),
            status: by(src, r => (r.status || '').trim()),
            updated: by(src, r => dateStr(r.updated))
        };
        const setOptions = (id, opts, placeholder) => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const current = sel.value; // preserve selection if possible
            const options = [ `<option value="">${placeholder}</option>`, ...opts.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`) ].join('');
            sel.innerHTML = options;
            // restore selection if still present
            if (current && opts.includes(current)) sel.value = current;
        };
        setOptions('filterRoomSel', values.room, 'All Rooms');
        setOptions('filterTypeSel', values.type, 'All Types');
        setOptions('filterLocationSel', values.location, 'All Locations');
        setOptions('filterCompanySel', values.company, 'All Companies');
        setOptions('filterStatusSel', values.status, 'All Statuses');
        setOptions('filterUpdatedSel', values.updated, 'Any Date');
    } catch(e){ console.warn('Failed to populate dropdown filters', e); }
}

// Hook up change listeners once
(function(){
    const ids = ['filterRoomSel','filterTypeSel','filterLocationSel','filterCompanySel','filterStatusSel','filterUpdatedSel'];
    const handler = () => renderRooms();
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el._roomFilterAttached) {
            el.addEventListener('change', () => {
                // Any manual filter change clears the temporary code filter
                try { window.__tempCodesFilter = null; const n = document.getElementById('tempFilterNotice'); if(n) n.style.display='none'; } catch(_){ }
                handler();
            });
            el._roomFilterAttached = true;
        }
    });
})();
function badgeForStatus(s){ const map={Available:'green', Occupied:'amber', Maintenance:'red', Inactive:'blue'}; return `<span class='badge ${map[s]||''}'>${s}</span>`; }
function timeAgo(ts){ const diff=Date.now()-ts; const m=Math.floor(diff/60000); if(m<1) return 'now'; if(m<60) return m+'m'; const h=Math.floor(m/60); if(h<24) return h+'h'; const d=Math.floor(h/24); return d+'d'; }
function capitalizeFirst(str){ 
    if (!str || typeof str !== 'string') return str || ''; 
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase(); 
}
function escapeHtml(s){
    if (s == null) return '';
    return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
}
// Exclusion helper: remove rooms located in Kamsar from UI (table, filters, stats, analytics)
function isExcludedByLocation(r){
    // Console override: set window.__includeKamsar = true to preview Kamsar rooms in UI
    try { if (window && window.__includeKamsar === true) return false; } catch(_){}
    const block = (r && r.location && r.location.block) ? String(r.location.block).trim().toLowerCase() : '';
    return block === 'kamsar';
}

// ===== Bulk selection helpers =====
function onRowSelectChange(checkbox){
    const id = checkbox?.getAttribute('data-room-id');
    if(!id) return;
    if(checkbox.checked){ window.selectedRoomIds.add(id); }
    else { window.selectedRoomIds.delete(id); }
    syncSelectAllCheckbox();
    updateSelectionUi();
}

function toggleSelectAllRooms(checked){
    try{
        const tbody = document.getElementById('roomsTbody');
        if(!tbody) return;
        const boxes = tbody.querySelectorAll("input[type='checkbox'][data-room-id]");
        boxes.forEach(cb => {
            cb.checked = !!checked;
            const id = cb.getAttribute('data-room-id');
            if(checked) window.selectedRoomIds.add(id); else window.selectedRoomIds.delete(id);
        });
    } finally {
        updateSelectionUi();
    }
}

function syncSelectAllCheckbox(){
    const headerCb = document.getElementById('selectAllRoomsChk');
    const tbody = document.getElementById('roomsTbody');
    if(!headerCb || !tbody){ return; }
    const boxes = Array.from(tbody.querySelectorAll("input[type='checkbox'][data-room-id]"));
    if(boxes.length === 0){ headerCb.checked = false; headerCb.indeterminate = false; return; }
    const checkedCount = boxes.filter(b => b.checked).length;
    headerCb.checked = checkedCount === boxes.length;
    headerCb.indeterminate = checkedCount > 0 && checkedCount < boxes.length;
}

function updateSelectionUi(){
    const tbody = document.getElementById('roomsTbody');
    const boxes = tbody ? Array.from(tbody.querySelectorAll("input[type='checkbox'][data-room-id]")) : [];
    const count = boxes.filter(b => b.checked).length;
    const countEl = document.getElementById('selectedCount');
    const delBtn = document.getElementById('deleteSelectedBtn');
    // optional badge removed; leave no-op if missing
    if(countEl){ countEl.textContent = `${count} selected`; }
    if(delBtn){ delBtn.disabled = count === 0; }
}

async function deleteSelectedRooms(){
    const tbody = document.getElementById('roomsTbody');
    const boxes = tbody ? Array.from(tbody.querySelectorAll("input[type='checkbox'][data-room-id]:checked")) : [];
    const ids = boxes.map(b => b.getAttribute('data-room-id')).filter(Boolean);
    if(ids.length === 0){ alert('No rooms selected.'); return; }
    if(!confirm(`Delete ${ids.length} selected room(s)? This cannot be undone.`)) return;
    // Remove from in-memory list (only currently visible selections)
    const set = new Set(ids);
    rooms = rooms.filter(r => !set.has(r.id));
    // Clear selection for those removed
    ids.forEach(id => window.selectedRoomIds.delete(id));
    // Re-render and persist and remove from Firebase
    renderRooms(); updateRoomStats();
    try { await deleteRoomsFromFirebase(ids); } catch(e){ console.error('Remote bulk delete failed', e); }
    try { await saveCompanyData(); } catch(e){ console.error('Failed to save after bulk delete', e); }
}
// Expose for console usage
window.deleteSelectedRooms = deleteSelectedRooms;
// Natural comparator: compares strings by alternating text and numeric chunks
function naturalCompare(a, b){
    const aa = (a || '').toString().toLowerCase();
    const bb = (b || '').toString().toLowerCase();
    if (aa === bb) return 0;
    const ax = aa.match(/\d+|\D+/g) || [aa];
    const bx = bb.match(/\d+|\D+/g) || [bb];
    const len = Math.max(ax.length, bx.length);
    for (let i=0;i<len;i++){
        const x = ax[i] || '';
        const y = bx[i] || '';
        const nx = x.match(/^\d+$/) ? parseInt(x,10) : NaN;
        const ny = y.match(/^\d+$/) ? parseInt(y,10) : NaN;
        if (!Number.isNaN(nx) && !Number.isNaN(ny)){
            if (nx !== ny) return nx - ny;
        } else {
            if (x !== y) return x < y ? -1 : 1;
        }
    }
    return 0;
}
// Stats updater
function updateRoomStats(currentList){
    try {
        const statsEl = document.getElementById('roomStats');
        if (!statsEl) return;
    // If not provided, use full dataset excluding Kamsar
    const list = Array.isArray(currentList) ? currentList : rooms.filter(r => !isExcludedByLocation(r));
        // Build counts per location (block)
        const locMap = new Map();
        for (const r of list) {
            const key = (r && r.location && r.location.block) ? r.location.block : 'Unknown';
            locMap.set(key, (locMap.get(key) || 0) + 1);
        }
        const locPairs = Array.from(locMap.entries())
            .sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])));

        // Build counts per company
        const compMap = new Map();
        for (const r of list) {
            const key = r.forCompanyName || (r.forCompany && r.forCompany.name) || 'Unassigned';
            compMap.set(key, (compMap.get(key) || 0) + 1);
        }
        const compPairs = Array.from(compMap.entries())
            .sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])));

        const total = list.length;
        // Render three cards: locations (list), companies (list), total
        statsEl.innerHTML = `
            <div class="stat-card" title="Rooms by Location">
                <div class="stat-label">Rooms by Location</div>
                <div class="stat-list">
                    ${locPairs.map(([name,count])=>`<div class="stat-row"><span>${escapeHtml(name)}</span><strong>${count}</strong></div>`).join('')}
                </div>
            </div>
            <div class="stat-card" title="Rooms by Company">
                <div class="stat-label">Rooms by Company</div>
                <div class="stat-list">
                    ${compPairs.map(([name,count])=>`<div class="stat-row"><span>${escapeHtml(name)}</span><strong>${count}</strong></div>`).join('')}
                </div>
            </div>
            <div class="stat-card" title="Total Rooms (after filters)">
                <div class="stat-number">${total}</div>
                <div>Total Rooms</div>
            </div>
        `;
    } catch (e) { console.warn('Stats update failed', e); }
    // =============== Analytics (Charts) ===============
let roomsCharts = { status: null, type: null, block: null };

function getCountsBy(arr, keyFn) {
    const map = new Map();
    for (const item of arr) {
        const key = keyFn(item) || 'Unknown';
        map.set(key, (map.get(key) || 0) + 1);
    }
    return map;
}

function destroyChartIfExists(ch) { try { if (ch) { ch.destroy(); } } catch(_){} }

function palette(n) {
    const base = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#f43f5e','#84cc16','#06b6d4','#f97316','#22c55e','#eab308'];
    const out = [];
    for (let i=0;i<n;i++) out.push(base[i % base.length]);
    return out;
}

function renderAnalyticsCharts() {
    const visible = document.getElementById('analyticsTab')?.classList.contains('active');
    if (!visible) return; // render only when visible to size canvases correctly

    const sourceRooms = getVisibleRooms();
    // Status chart
    const byStatus = getCountsBy(sourceRooms, r => r.status || 'Unknown');
    const statusLabels = Array.from(byStatus.keys());
    const statusData = Array.from(byStatus.values());
    const statusCtx = document.getElementById('roomsStatusChart')?.getContext('2d');
    if (statusCtx) {
        destroyChartIfExists(roomsCharts.status);
        roomsCharts.status = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{ data: statusData, backgroundColor: palette(statusLabels.length) }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
    }

    // Type chart
    const byType = getCountsBy(sourceRooms, r => r.type || 'Unknown');
    const typeLabels = Array.from(byType.keys());
    const typeData = Array.from(byType.values());
    const typeCtx = document.getElementById('roomsTypeChart')?.getContext('2d');
    if (typeCtx) {
        destroyChartIfExists(roomsCharts.type);
        roomsCharts.type = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: typeLabels,
                datasets: [{ label: 'Rooms', data: typeData, backgroundColor: palette(typeLabels.length) }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { precision:0 } } }, plugins: { legend: { display:false } } }
        });
    }

    // Location block chart
    const byBlock = getCountsBy(sourceRooms, r => (r.location && r.location.block) || 'Unknown');
    const blockLabels = Array.from(byBlock.keys());
    const blockData = Array.from(byBlock.values());
    const blockCtx = document.getElementById('roomsBlockChart')?.getContext('2d');
    if (blockCtx) {
        destroyChartIfExists(roomsCharts.block);
        roomsCharts.block = new Chart(blockCtx, {
            type: 'bar',
            data: {
                labels: blockLabels,
                datasets: [{ label: 'Rooms', data: blockData, backgroundColor: palette(blockLabels.length) }]
            },
            options: { indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { precision:0 } } }, plugins: { legend: { display:false } } }
        });
    }
}

function maybeRenderAnalytics() {
    if (typeof Chart === 'undefined') return;
    const active = document.getElementById('analyticsTab')?.classList.contains('active');
    if (active) renderAnalyticsCharts();
}
    // After saving, refresh analytics if needed
    maybeRenderAnalytics();
}
// ======================= Multi Chart/Table Builder (Rooms) =======================
(function(){
    let builderInitialized = false;
    const analysisSets = new Map();
    let analysisSetSeq = 0;

    function palette(i){ const c=['#f39c12','#3498db','#2ecc71','#9b59b6','#e74c3c','#16a085','#8e44ad','#d35400','#27ae60','#c0392b']; return c[i % c.length]; }
    function getRooms(){ return Array.isArray(window.getVisibleRooms?.()) ? window.getVisibleRooms() : (Array.isArray(window.visibleRooms) ? window.visibleRooms : (Array.isArray(window.rooms)? window.rooms : [])); }
    // Groupable fields helper (Rooms Inventory columns)
    function getRoomsGroupableFields(){
        return [
            { value: 'room', label: 'Room' },                 // room code
            { value: 'type', label: 'Type' },
            { value: 'block', label: 'Location Block' },
            { value: 'company', label: 'Company' },
            { value: 'status', label: 'Status' },
            { value: 'updatedDate', label: 'Updated (Date)' }
        ];
    }
    function getGroupLabel(v){ const f=getRoomsGroupableFields().find(x=>x.value===v); return f?f.label:(v||'').toString(); }
    function buildGroupByOptionsHtml(selected='status'){
        return getRoomsGroupableFields().map(f=>`<option value='${f.value}' ${selected===f.value? 'selected':''}>${f.label}</option>`).join('');
    }

    function aggregateRooms(groupBy){
        const list = getRooms();
        const keyFn = {
            status: r=> r.status || 'Unknown',
            type: r=> r.type || 'Unknown',
            block: r=> (r.location && r.location.block) || 'Unknown',
            company: r=> r.forCompanyName || (r.forCompany && r.forCompany.name) || 'Unassigned',
            room: r=> r.code || r.name || 'Unknown',
            updatedDate: r=> (r.updated ? new Date(r.updated).toISOString().slice(0,10) : 'Unknown')
        }[groupBy] || (r=> 'Unknown');
        const map = new Map();
        for(const r of list){ const k = String(keyFn(r) || 'Unknown'); map.set(k, (map.get(k)||0)+1); }
        const rows = Array.from(map.entries()).map(([key,count])=> ({ key, count })).sort((a,b)=> b.count-a.count);
        const totalCount = list.length;
        return { rows, totalCount };
    }

    function ensureCampAnalyticsBuilderSection(){
        if (builderInitialized) return;
        const mount = document.getElementById('analyticsMultiBuilderMount') || document.querySelector('#analyticsSection');
        if (!mount) return;
        const section = document.createElement('section');
        section.id = 'multiBuilderSection';
        section.innerHTML = `
            <div class="mb-3 p-3 rounded-md shadow-sm border border-slate-200 bg-white">
                <h2 class="text-sm font-semibold tracking-wide text-slate-700 mb-3 flex items-center gap-2"><i class="fa fa-layer-group text-amber-500"></i> Custom Tables & Charts</h2>
                <div class="flex flex-wrap gap-2 items-end" id="multiBuilderControls">
                    <button id="mbClearAll" type="button" class="px-3 py-1.5 bg-red-500/80 hover:bg-red-600 text-white text-xs font-semibold rounded shadow-sm">Clear All</button>
                    <button id="mbAddPrimary" type="button" class="px-3 py-1.5 bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold rounded shadow-sm">Add Analysis Set</button>
                    <button id="mbSaveModel" type="button" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-semibold rounded shadow-sm">Save Model</button>
                    <button id="mbUpdateModel" type="button" style="display:none;" class="px-3 py-1.5 bg-teal-600 hover:bg-teal-700 text-white text-xs font-semibold rounded shadow-sm">Update Model</button>
                </div>
                <p class="mt-2 text-[10px] text-slate-500">Group by any Rooms Inventory column. Each set stores its own parameters.</p>
            </div>
            <div id="customPrimaryContainer" class="flex flex-wrap gap-4 items-stretch mb-6"></div>
        `;
        mount.prepend(section);
        wireBuilderEvents();
        builderInitialized = true;
    }

    function wireBuilderEvents(){
        document.getElementById('mbClearAll')?.addEventListener('click', ()=> clearAllSets());
        document.getElementById('mbAddPrimary')?.addEventListener('click', ()=> addAnalysisSet());
        document.getElementById('mbSaveModel')?.addEventListener('click', ()=> setCampAnalyticsStatus('Save Model not implemented yet')); 
        document.getElementById('mbUpdateModel')?.addEventListener('click', ()=> setCampAnalyticsStatus('Update Model not implemented yet'));
    }

    function clearAllSets(){
        analysisSets.forEach(entry=>{ try{ entry.chart?.destroy(); }catch(_){} });
        analysisSets.clear();
        const pc = document.getElementById('customPrimaryContainer'); if (pc) pc.innerHTML='';
    }

    function addAnalysisSet(){
        const id = 'as'+(++analysisSetSeq);
        const primaryContainer = document.getElementById('customPrimaryContainer'); if(!primaryContainer) return;
        const setWrap = document.createElement('div');
        setWrap.className='analysis-set border border-slate-300 rounded-md p-2 bg-white shadow-sm flex flex-col gap-2 w-full';
        setWrap.dataset.analysisSet = id;
        setWrap.innerHTML = `
            <div class='flex items-center justify-between'>
                <h3 class='text-[11px] font-semibold text-slate-700'>Analysis Set</h3>
                <div class='flex gap-1'>
                    <button data-act='refresh-set' class='text-[10px] px-2 py-0.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-600' title='Refresh'><i class="fa fa-rotate"></i></button>
                    <button data-act='remove-set' class='text-[10px] px-2 py-0.5 rounded bg-red-100 hover:bg-red-200 text-red-600' title='Remove'><i class="fa fa-times"></i></button>
                </div>
            </div>
            <div class='flex flex-wrap gap-2 items-end text-[10px] bg-slate-50/60 rounded-md p-2 border border-slate-200'>
                <label class='flex flex-col gap-0.5'>Group
                    <select data-filt='groupBy' class='border rounded px-1 py-0.5 bg-white'>${buildGroupByOptionsHtml('status')}</select>
                </label>
                <label class='flex flex-col gap-0.5'>Chart
                    <select data-filt='chartType' class='border rounded px-1 py-0.5 bg-white'>
                        <option value='bar' selected>Bar</option>
                        <option value='line'>Line</option>
                        <option value='pie'>Pie</option>
                        <option value='doughnut'>Doughnut</option>
                    </select>
                </label>
            </div>
            <div class='text-[10px] text-slate-500 italic -mt-1 mb-1' data-role='summary'>Rooms grouped by Status</div>
            <div class='flex flex-wrap gap-2 items-stretch'>
                <div class='flex flex-col border border-slate-200 rounded-md p-2 flex-1 min-w-[340px]' data-role='tableBox'>
                    <h4 class='text-[10px] font-semibold text-slate-600 mb-1'>TABLE</h4>
                    <div class='overflow-auto'>
                        <table class='w-full text-[10px] border-collapse'>
                            <thead><tr><th class='text-left px-1 py-0.5'>Group</th><th class='text-right px-1 py-0.5'>Count</th></tr></thead>
                            <tbody></tbody>
                            <tfoot><tr><td class='px-1 py-0.5 font-semibold'>Totals</td><td class='text-right px-1 py-0.5 font-semibold' data-ft-count></td></tr></tfoot>
                        </table>
                    </div>
                </div>
                <div class='flex flex-col border border-slate-200 rounded-md p-2 flex-1 min-w-[320px]' data-role='chartBox'>
                    <h4 class='text-[10px] font-semibold text-slate-600 mb-1'>CHART</h4>
                    <div style='flex:1;min-height:160px;display:flex;'>
                        <canvas></canvas>
                    </div>
                </div>
            </div>
        `;
        primaryContainer.appendChild(setWrap);

        const cfg = { groupBy: 'status', chartType: 'bar' };
        const chartCanvas = setWrap.querySelector('canvas');
        const chartCtx = chartCanvas?.getContext('2d');
        let chart = null;

        function render(){
            const agg = aggregateRooms(cfg.groupBy);
            // Update summary
            const summary = setWrap.querySelector('[data-role="summary"]');
            if (summary){ summary.textContent = `Rooms grouped by ${getGroupLabel(cfg.groupBy)}`; }
            // Table
            const tbody = setWrap.querySelector('tbody');
            const ftCount = setWrap.querySelector('[data-ft-count]');
            if (tbody){ tbody.innerHTML = agg.rows.map(r=>`<tr class='odd:bg-slate-50'><td class='px-1 py-0.5 font-medium text-slate-700'>${r.key}</td><td class='px-1 py-0.5 text-right'>${r.count}</td></tr>`).join('') || `<tr><td colspan='2' class='text-center px-2 py-2 text-[10px] text-slate-500'>No rows</td></tr>`; }
            if (ftCount){ ftCount.textContent = agg.totalCount || 0; }
            // Chart
            if (chartCtx){
                const labels = agg.rows.map(r=> String(r.key));
                const vals = agg.rows.map(r=> r.count);
                try{ chart?.destroy(); }catch(_){ }
                const ds = [{ label:'Rooms', data:vals, backgroundColor: vals.map((_,i)=>palette(i)), borderColor: vals.map((_,i)=>palette(i)), borderWidth:1, tension: cfg.chartType==='line'?0.25:0 }];
                const scales = (['pie','doughnut'].includes(cfg.chartType)? {} : { y:{ beginAtZero:true, ticks:{ font:{ size:9 }, color:'#334155' } }, x:{ ticks:{ font:{ size:9 }, color:'#334155' } } });
                if (typeof Chart === 'undefined') return; // wait until loaded
                chart = new Chart(chartCtx, { type: (cfg.chartType==='pie'||cfg.chartType==='doughnut')? cfg.chartType : cfg.chartType, data: { labels, datasets: ds }, options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ font:{ size:9 }, color:'#334155' } } }, scales } });
            }
        }

        setWrap.addEventListener('change', (e)=>{
            const gb = e.target?.getAttribute('data-filt'); if(!gb) return;
            if (gb==='groupBy'){ cfg.groupBy = e.target.value; render(); }
            if (gb==='chartType'){ cfg.chartType = e.target.value; render(); }
        });
        setWrap.addEventListener('click', (e)=>{
            const btn = e.target.closest('button[data-act]'); if(!btn) return;
            const act = btn.getAttribute('data-act');
            if (act==='refresh-set'){ render(); }
            if (act==='remove-set'){ try{ chart?.destroy(); }catch(_){ } setWrap.remove(); analysisSets.delete(id); }
        });

        analysisSets.set(id, { cfg, chart, wrap:setWrap });
        render();
    }

    // expose ensure function to tab switcher
    window.ensureCampAnalyticsBuilderSection = ensureCampAnalyticsBuilderSection;
})();
// ====== Analytics Models (fueldist-style UI parity) ======
let __campAnalyticsModelsClickBound = false;
function setCampAnalyticsStatus(msg, isError){ const el=document.getElementById('analyticsStatus'); if(el){ el.textContent=msg||''; el.style.color = isError ? '#b91c1c' : '#475569'; } }
function renderCampAnalyticsModelRow(m){
    const range = (m.start||m.end) ? `${m.start||''} - ${m.end||''}` : 'All Time';
    const values = (m.values||[]).join(', ');
    const created = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
    const esc = (s)=> (s||'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    return `<tr data-id="${m.id||''}" style="cursor:pointer;">
        <td>${esc(m.title||'')}</td>
        <td>${esc(m.category||'')}</td>
        <td>${esc(range)}</td>
        <td>${esc(values)}</td>
        <td>${esc(created)}</td>
        <td>
            <button class="action-btn" style="padding:2px 6px;font-size:.6rem;background:#6366f1;color:#fff;" onclick="event.stopPropagation(); previewCampAnalyticsModel('${m.id||''}')">Preview</button>
            <button class="action-btn" style="padding:2px 6px;font-size:.6rem;" onclick="event.stopPropagation(); applyCampAnalyticsModel('${m.id||''}')">Use</button>
            <button class="action-btn btn-delete" style="padding:2px 6px;font-size:.6rem;" onclick="event.stopPropagation(); deleteCampAnalyticsModel('${m.id||''}')">Delete</button>
        </td>
    </tr>`;
}
async function loadCampAnalyticsModels(){
    try {
        const body=document.getElementById('analyticsModelsBody'); if(!body) return; body.innerHTML='';
        if (!window.firebase || !firebase.database) { setCampAnalyticsStatus('Firebase not available', true); return; }
        const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
        const snap = await firebase.database().ref(`analyticsModels/camp/${companyId}`).once('value');
        const val = snap.val()||{}; const rows = Object.entries(val).map(([id,m])=> ({ id, ...m })).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
        body.innerHTML = rows.map(renderCampAnalyticsModelRow).join('');
        if (!__campAnalyticsModelsClickBound){
            body.addEventListener('click', (e)=>{
                const tr = e.target.closest('tr[data-id]'); const id = tr?.getAttribute('data-id'); if (id){ previewCampAnalyticsModel(id); }
            });
            __campAnalyticsModelsClickBound = true;
        }
        setCampAnalyticsStatus(rows.length? '' : 'No saved analytics models');
    } catch(e){ console.warn('loadCampAnalyticsModels failed', e); setCampAnalyticsStatus('Failed to load analytics models', true); }
}
function applyCampAnalyticsModel(id){
    try { window.__editingCampAnalyticsModelId = id; /* Placeholder: wire to builder when available */ setCampAnalyticsStatus('Model applied.'); }
    catch(e){ setCampAnalyticsStatus('Failed to apply model', true); }
}
async function previewCampAnalyticsModel(id){ try{ setCampAnalyticsStatus('Preview not implemented yet.'); }catch(e){}}
async function deleteCampAnalyticsModel(id){
    try {
        if (!confirm('Delete this analytics model?')) return;
        const companyId = window.authManager?.getCurrentUser()?.companyId || 'global';
        await firebase.database().ref(`analyticsModels/camp/${companyId}/${id}`).remove();
        await loadCampAnalyticsModels();
        setCampAnalyticsStatus('Deleted.');
    } catch(e){ setCampAnalyticsStatus('Failed to delete model: '+e.message, true); }
}
function renderRoomTypes(){ 
    const tbody=document.getElementById('roomTypesTbody'); 
    if(!tbody){ 
        // Room Types UI removed; keep data for dependent features
        return; 
    }
    if(!roomTypes.length){ 
        tbody.innerHTML='<tr><td colspan="6" class="empty-state">No room types yet</td></tr>'; 
        return;
    } 
    
    const amenityMap = Object.fromEntries(amenities.map(a => [a.code, a]));
    
    tbody.innerHTML=roomTypes.map(t=> {
        const defaultAmenities = t.defaultAmenities || [];
        const amenityDisplay = defaultAmenities.length > 0 
            ? defaultAmenities.map(code => {
                const amenity = amenityMap[code];
                return amenity ? `<span class="amenity-badge small"><i class="fa ${amenity.icon||'fa-circle'}"></i> ${amenity.name}</span>` : '';
              }).filter(Boolean).join('')
            : '<span style="color:#64748b; font-size:0.7rem;">None</span>';
            
        const siteDisplay = t.site ? `<span class="site-badge">${t.site}</span>` : '<span style="color:#64748b; font-size:0.7rem;">Not set</span>';
            
        return `<tr>
            <td>${t.name}</td>
            <td>${siteDisplay}</td>
            <td>${t.capacity}</td>
            <td>${t.beds}</td>
            <td style="max-width:200px;">${amenityDisplay}</td>
            <td>
                <div class='inline-actions'>
                    <button class='btn btn-outline' onclick="editRoomType('${t.id}')"><i class='fa fa-pen'></i></button>
                    <button class='btn btn-outline' onclick="deleteRoomType('${t.id}')"><i class='fa fa-trash'></i></button>
                </div>
            </td>
        </tr>`;
    }).join(''); 
    
    // Call async function properly
    populateRoomTypeSelects().catch(error => {
        console.error('Error populating room type selects:', error);
    });
}
function renderAmenities(){ const tbody=document.getElementById('amenitiesTbody'); if(!amenities.length){ tbody.innerHTML='<tr><td colspan="5" class="empty-state">No amenities defined</td></tr>'; return;} tbody.innerHTML=amenities.map(a=> `<tr><td><i class='fa ${a.icon||'fa-circle'}' style='opacity:.6;'></i> ${a.name}</td><td>${a.code}</td><td>${a.description||'-'}</td><td>${a.active? '<span class="badge green">Active</span>':'<span class="badge red">Inactive</span>'}</td><td><div class='inline-actions'><button class='btn btn-outline' onclick="editAmenity('${a.code}')"><i class='fa fa-pen'></i></button></div></td></tr>`).join(''); rebuildAmenityCheckboxes(); }
function populateFilters(){ /* Filters removed */ }

// Updated function to populate room type selects from settings
async function populateRoomTypeSelects(){ 
    const sel = document.getElementById('roomTypeSelect'); 
    if (!sel) return;
    
    try {
        console.log(' Populating room type select from settings...');
        
        // Load room types from settings system
        const settingsRoomTypes = await loadRoomTypesFromSettings();
        
        // Populate the select element
        sel.innerHTML = '<option value="">Select Type</option>' + 
            settingsRoomTypes.map(t => `<option value="${t.code}">${t.name}</option>`).join('');
        
        console.log(' Room type select populated with', settingsRoomTypes.length, 'types from settings');
        
        // Also update the filter dropdown
        const filterTypeSel = document.getElementById('filterType');
        if (filterTypeSel) {
            filterTypeSel.innerHTML = '<option value="">All Types</option>' + 
                settingsRoomTypes.map(t => `<option value="${t.code}">${t.name}</option>`).join('');
        }
        
        // Store the settings room types globally for compatibility with existing code
        window.settingsRoomTypes = settingsRoomTypes;
        
    } catch (error) {
        console.error(' Error populating room type selects from settings:', error);
        
        // Fallback to local roomTypes array if settings fail
        sel.innerHTML = '<option value="">Select Type</option>' + 
            roomTypes.map(t => `<option value="${t.code}">${t.name}</option>`).join('');
    }
}

// Populate Location Block (Area) dropdown from settings fieldOptions/area
async function populateAreaDropdown() {
    try {
        const sel = document.getElementById('roomBlockSelect');
        if (!sel) return; // Modal may not be in DOM yet

        // Load areas via existing loader with Firebase + local fallbacks
        const areas = await loadWorkAreas();
        const enabledAreas = Array.isArray(areas) ? areas.filter(a => a && a.enabled !== false) : [];
        // Ensure 'Kamsar' exists in dropdown options
        const hasKamsar = enabledAreas.some(a => (a.value || a.code || a.label) === 'Kamsar');
        if (!hasKamsar) {
            enabledAreas.push({ label: 'Kamsar', value: 'Kamsar', color: '#0d6efd', enabled: true });
        }
        // Ensure 'Tinguilinta' exists in dropdown options
        const hasTing = enabledAreas.some(a => (a.value || a.code || a.label) === 'Tinguilinta');
        if (!hasTing) {
            enabledAreas.push({ label: 'Tinguilinta', value: 'Tinguilinta', color: '#0d6efd', enabled: true });
        }

        sel.innerHTML = '<option value="">Select Area</option>' +
            enabledAreas.map(a => `<option value="${a.value || a.code || a.label}">${a.label || a.name || a.value}</option>`).join('');

        // If a value was previously typed or set, keep it if it exists
        const currentForm = document.getElementById('roomForm');
        if (currentForm && currentForm.block && currentForm.block.value) {
            const keepVal = currentForm.block.value;
            const matchOption = Array.from(sel.options).some(o => o.value === keepVal);
            if (matchOption) sel.value = keepVal;
        }
    } catch (error) {
        console.error(' Error populating area dropdown:', error);
        const sel = document.getElementById('roomBlockSelect');
        if (sel) sel.innerHTML = '<option value="">Select Area</option>';
    }
}


// Ensure rooms with a given prefix exist (idempotent) and set their location
async function ensurePrefixedRooms({ prefix, start = 1, count = 1, locationBlock = '', padLength = 0 }) {
    try {
        if (!prefix || count <= 0) return;
        const companyId = CompanyStorage.getCompanyId();
        const flagKey = `company_${companyId}_roomsCreated_${prefix}_${start}_${count}_${locationBlock}_${padLength}`;
        if (localStorage.getItem(flagKey) === 'true') return; // Already created

        // Determine a valid default room type code from settings
        let defaultType = 'single';
        try {
            const types = await loadRoomTypesFromSettings();
            if (Array.isArray(types) && types.length > 0) {
                const single = types.find(t => (t.code||'').toLowerCase() === 'single');
                defaultType = single ? single.code : (types[0].code || defaultType);
            }
        } catch (e) { /* keep fallback */ }

        const existedByCode = new Map((rooms||[]).map(r => [String(r.code||'').toLowerCase(), r]));
        let created = 0, updated = 0;
        for (let i = start; i < start + count; i++) {
            const numStr = padLength > 0 ? String(i).padStart(padLength, '0') : String(i);
            const code = `${prefix}${numStr}`;
            const lc = code.toLowerCase();
            const existing = existedByCode.get(lc);
            if (existing) {
                // Update location to requested block if different
                const prevBlock = existing.location && existing.location.block;
                if (prevBlock !== locationBlock) {
                    existing.location = { block: locationBlock };
                    existing.updated = Date.now();
                    updated++;
                }
                continue;
            }
            const newRoom = {
                id: genId(), code, name: '', type: defaultType,
                location: { block: locationBlock }, status: 'Available',
                amenities: [], notes: '', updated: Date.now()
            };
            rooms.push(newRoom);
            existedByCode.set(lc, newRoom);
            created++;
        }
        if (created > 0 || updated > 0) {
            console.log(` Rooms ensured for prefix ${prefix}: ${created} created, ${updated} updated (location: ${locationBlock})`);
            populateRoomFilterDropdowns();
            renderRooms();
            updateRoomStats();
            await saveCompanyData();
        }
        localStorage.setItem(flagKey, 'true');
    } catch (e) {
        console.warn('ensurePrefixedRooms failed:', e);
    }
}

// Ensure specific codes exist and are set to the provided location (idempotent)
async function ensureRoomsByCodes(codes, locationBlock = '') {
    try {
        if (!Array.isArray(codes) || codes.length === 0) return;
        // Determine a valid default room type code from settings
        let defaultType = 'single';
        try {
            const types = await loadRoomTypesFromSettings();
            if (Array.isArray(types) && types.length > 0) {
                const single = types.find(t => (t.code||'').toLowerCase() === 'single');
                defaultType = single ? single.code : (types[0].code || defaultType);
            }
        } catch (e) { /* keep fallback */ }

        const existedByCode = new Map((rooms||[]).map(r => [String(r.code||'').toLowerCase(), r]));
        let created = 0, updated = 0;
        for (const code of codes) {
            const lc = String(code).toLowerCase();
            const existing = existedByCode.get(lc);
            if (existing) {
                const prevBlock = existing.location && existing.location.block;
                if (prevBlock !== locationBlock) {
                    existing.location = { block: locationBlock };
                    existing.updated = Date.now();
                    updated++;
                }
                continue;
            }
            const newRoom = {
                id: genId(), code, name: '', type: defaultType,
                location: { block: locationBlock }, status: 'Available',
                amenities: [], notes: '', updated: Date.now()
            };
            rooms.push(newRoom);
            existedByCode.set(lc, newRoom);
            created++;
        }
        if (created > 0 || updated > 0) {
            console.log(` Rooms ensured for explicit list: ${created} created, ${updated} updated (location: ${locationBlock})`);
        }
    } catch (e) {
        console.warn('ensureRoomsByCodes failed:', e);
    }
}

// Find a company scope record (main company or subcontractor) by name
async function findCompanyScopeByName(companyName){
    const nameLc = String(companyName||'').trim().toLowerCase();
    if (!nameLc) return null;
    try {
        const companyId = CompanyStorage.getCompanyId();
        const db = (window.authManager && window.authManager.db) || firebase.database();
        // Check main company first
        const mainSnap = await db.ref(`companies/${companyId}`).once('value');
        if (mainSnap.exists()){
            const main = mainSnap.val();
            const mainName = (main.companyName || main.name || '').toLowerCase();
            if (mainName === nameLc) return { id: companyId, name: main.companyName || main.name };
        }
        // Check subcontractors
        const subsSnap = await db.ref(`companies/${companyId}/subcontractors`).once('value');
        if (subsSnap.exists()){
            const subs = subsSnap.val();
            for (const [sid, sc] of Object.entries(subs)){
                const scName = (sc.name || sc.companyName || '').toLowerCase();
                if (scName === nameLc){
                    return { id: sid, name: sc.name || sc.companyName };
                }
            }
        }
    } catch(e){ console.warn('findCompanyScopeByName failed:', e); }
    return { id: null, name: companyName };
}

// Assign company, status, and optionally location for rooms matching code prefix
async function setRoomsCompanyByPrefix(prefix, { companyName, locationBlock = null, status = null }){
    try {
        const companyId = CompanyStorage.getCompanyId();
        const flagKey = `company_${companyId}_roomsCompanySet_${prefix}_${(companyName||'').replace(/\W+/g,'_')}_${locationBlock||''}_${status||''}`;
        if (localStorage.getItem(flagKey) === 'true') return; // Already applied
        const scope = await findCompanyScopeByName(companyName);
        let changed = 0;
        rooms = (rooms||[]).map(r => {
            if (!r || !r.code || !String(r.code).startsWith(prefix)) return r;
            const updated = { ...r };
            if (companyName){ updated.forCompanyName = companyName; if (scope && scope.id) updated.forCompanyId = scope.id; }
            if (locationBlock){ updated.location = { block: locationBlock }; }
            if (status){ updated.status = status; }
            updated.updated = Date.now();
            changed++;
            return updated;
        });
        if (changed > 0){
            populateRoomFilterDropdowns();
            renderRooms();
            updateRoomStats();
            await saveCompanyData();
        }
        localStorage.setItem(flagKey, 'true');
    } catch(e){ console.warn('setRoomsCompanyByPrefix failed:', e); }
}

// Set all rooms' company to the current company scope (idempotent overwrite)
async function setAllRoomsCompanyToCurrent(companyNameOverride) {
    try {
        const companyId = CompanyStorage.getCompanyId();
        const scopeName = companyNameOverride || (window.authManager && authManager.currentCompany && authManager.currentCompany.companyName) || '';
        if (!companyId) {
            console.warn('setAllRoomsCompanyToCurrent: No companyId found');
            return;
        }
        let changed = 0;
        rooms = (rooms || []).map(r => {
            // Non-destructive: dont overwrite if room already has an explicit company assignment
            if (r.forCompanyId || r.forCompanyName) return r;
            const updated = { ...r, forCompanyId: companyId };
            if (scopeName) updated.forCompanyName = scopeName;
            if (r.forCompanyId !== updated.forCompanyId || r.forCompanyName !== updated.forCompanyName) {
                updated.updated = Date.now();
                changed++;
            }
            return updated;
        });
        if (changed > 0) {
            console.log(` Updated company on ${changed} room(s) to`, scopeName || companyId);
            await saveCompanyData();
        }
    } catch (e) {
        console.warn('setAllRoomsCompanyToCurrent failed:', e);
    }
}

function onRoomTypeChange(roomTypeCode) {
    if (!roomTypeCode) return;
    
    // Find the room type from settings first, then local roomTypes as fallback
    let roomType = null;
    
    // Check settings room types first
    if (window.settingsRoomTypes) {
        roomType = window.settingsRoomTypes.find(rt => rt.code === roomTypeCode);
    }
    
    // Fallback to local roomTypes array
    if (!roomType) {
        roomType = roomTypes.find(rt => rt.code === roomTypeCode);
    }
    
    if (!roomType) {
        console.warn(' Room type not found:', roomTypeCode);
        return;
    }
    
    // Only add default amenities if we're creating a new room (not editing)
    if (!editingRoomId && roomType.defaultAmenities) {
        // Add default amenities to the current selection
        roomType.defaultAmenities.forEach(amenityCode => {
            if (!selectedRoomAmenities.includes(amenityCode)) {
                selectedRoomAmenities.push(amenityCode);
            }
        });
        
        // Update the UI
        renderRoomAmenities();
        populateAmenityDropdown();
    }
    
    // Also populate beds if not already set and available from room type
    const form = document.getElementById('roomForm');
    // beds field removed
    
    console.log(' Room type changed to:', roomType.name || roomTypeCode);
}

// ==================== One-off seeding utility (manual) ====================
// Creates rooms at Kamsar for the following ranges:
// - NMC-50MC-K1..K10
// - NMC-50MC-L1..L8
// - NMC-50MC-M1..M16
// Note: Not auto-invoked. Run from the browser console when on this page:
//   await seedKamsar50MCRooms()
// Rooms at Kamsar are excluded from this UI by design, but they will be saved to Firebase.
async function seedKamsar50MCRooms(){
    try {
        const mk = (prefix, start, end) => Array.from({ length: (end - start + 1) }, (_, i) => `${prefix}${start + i}`);
        const codesK = mk('NMC-50MC-K', 1, 10);
        const codesL = mk('NMC-50MC-L', 1, 8);
        const codesM = mk('NMC-50MC-M', 1, 16);
        const all = [...codesK, ...codesL, ...codesM];
        console.log(' Seeding Kamsar 50MC rooms:', all.length, 'codes');
        await ensureRoomsByCodes(all, 'Kamsar');
        // ensureRoomsByCodes triggers render + saveCompanyData internally
        console.log(' Kamsar 50MC rooms ensured in Firebase (UI excludes Kamsar by design).');
        return { count: all.length, location: 'Kamsar' };
    } catch(e){
        console.warn('seedKamsar50MCRooms failed:', e);
        throw e;
    }
}
// Expose for console usage
window.seedKamsar50MCRooms = seedKamsar50MCRooms;
function rebuildAmenityCheckboxes(){ const container=document.getElementById('roomAmenitiesContainer'); const build=(target, selected=[])=>{ target.innerHTML=amenities.map(a=> `<label class='toggle-chip ${selected.includes(a.code)?'active':''}' data-code='${a.code}' onclick='toggleChip(this)'><i class='fa ${a.icon||'fa-circle'}'></i> ${a.code}</label>`).join(''); }; if(container) build(container, []); }
function toggleChip(el){ el.classList.toggle('active'); }
// CRUD Logic (local only currently)
function openModal(id){ 
    document.getElementById(id).classList.add('show'); 
    if(id==='roomModal'){ 
    // Ensure bulk-create controls exist and are wired
    try { ensureBulkControls(); } catch(e){ console.warn('bulk controls init failed', e); }
    // Note: dropdowns will be populated once within populateRoomForm
    // Determine if we're editing an existing room
    const roomToEdit = editingRoomId ? (rooms.find(x=> x.id===editingRoomId) || null) : null;
    // Populate company scope options for the room modal, then populate form to safely set value
    try { 
        const sel = document.getElementById('roomCompanySelect'); 
        if (sel && typeof loadCompanyScopeOptions === 'function') { 
            Promise.resolve(loadCompanyScopeOptions(sel)).then(() => populateRoomForm(roomToEdit));
        } else { 
            populateRoomForm(roomToEdit); 
        }
    } catch(e){ 
        console.warn('Could not populate room company select', e); 
        populateRoomForm(roomToEdit); 
    }
    } 
    // Room Type modal removed
    if(id==='amenityModal'){ 
        // Only reset the form if we're not editing an existing amenity
        if(!editingAmenityCode) {
            resetAmenityForm(); 
        }
    } 
}
function closeModal(id){ 
    console.log(' closeModal called for:', id);
    console.log(' Before reset - editingAmenityCode was:', editingAmenityCode);
    
    const modalEl = document.getElementById(id);
    if(modalEl){ modalEl.classList.remove('show'); }
    editingRoomId=null; 
    editingRoomTypeId=null; 
    editingAmenityCode=null; 
    // reset per-open guard for room form
    try { window.__roomFormInitInProgress = false; } catch(_){}
    
    console.log(' After reset - editingAmenityCode is now:', editingAmenityCode);
    
    // Clear any row highlighting
    document.querySelectorAll('.amenities-table tr').forEach(row => row.classList.remove('editing-row'));
    
    // Reset modal titles
    if(id === 'amenityModal') {
        const modalTitle = document.querySelector('#amenityModal .modal-header h3');
        if(modalTitle) {
            modalTitle.textContent = 'Amenities';
        }
    }
}
function populateRoomForm(room){ 
    // prevent duplicate initialization in fast/double opens
    if (window.__roomFormInitInProgress) { console.log(' Skipping duplicate populateRoomForm'); return; }
    window.__roomFormInitInProgress = true;
    console.log(' Populating room form with data:', room);
    
    const form=document.getElementById('roomForm'); 
    form.reset(); 
    selectedRoomAmenities = []; // Reset selected amenities
    populateAmenityDropdown(); 
    
    // Always populate dropdowns when form is populated
    Promise.all([
        populateRoomTypeSelects(),
        populateAreaDropdown()
    ]).then(() => {
    console.log(' Dropdowns populated, now setting values...');
        
        if(room){ 
            // Basic fields
            form.code.value = room.code || ''; 
            form.name.value = room.name || ''; 
            
            // Room type - set after dropdowns are populated
            const typeSelect = document.getElementById('roomTypeSelect');
            if (typeSelect && room.type) {
                typeSelect.value = room.type;
                console.log(' Set room type to:', room.type);
            } else {
                console.warn(' Room type select not found or no type value');
            }
            
            // Location block - set after dropdowns are populated
            const blockSelect = document.getElementById('roomBlockSelect');
            if (blockSelect && room.location && room.location.block) {
                blockSelect.value = room.location.block;
                console.log(' Set location block to:', room.location.block);
            } else {
                console.warn(' Block select not found or no location data. Available options:', 
                    blockSelect ? Array.from(blockSelect.options).map(o => o.value) : 'no select');
            }

            // Company scope
            const companySel = document.getElementById('roomCompanySelect');
            if (companySel) {
                const companyId = room.forCompanyId || (room.forCompany && room.forCompany.id);
                if (companyId) {
                    companySel.value = companyId;
                } else if (typeof CompanyStorage?.getCompanyId === 'function') {
                    companySel.value = CompanyStorage.getCompanyId();
                }
            }
            
            // Status
            form.status.value = room.status || 'Available'; 
            
            // Amenities
            selectedRoomAmenities = [...(room.amenities || [])]; // Set selected amenities
            renderRoomAmenities();
            populateAmenityDropdown();
            
            // Notes
            form.notes.value = room.notes || ''; 
            
            console.log(' Room form populated successfully');
        }
        // release guard once done
        window.__roomFormInitInProgress = false;
    }).catch(error => {
        console.error(' Error populating room form dropdowns:', error);
        window.__roomFormInitInProgress = false;
    });
    
    // Handle the case when room is null (new room)
    if (!room) {
        renderRoomAmenities();
        // Default company to main company for new rooms
        const companySel = document.getElementById('roomCompanySelect');
        if (companySel && typeof CompanyStorage?.getCompanyId === 'function') {
            companySel.value = CompanyStorage.getCompanyId();
        }
    }
}
// Injects bulk-create UI controls into the Room modal form (idempotent)
function ensureBulkControls(){
    const form = document.getElementById('roomForm');
    if (!form) return;
    // Only add once
    if (form.querySelector('[data-role="bulk-create-wrap"]')) return;
    const grid = form.querySelector('.form-grid');
    if (!grid) return;
    const wrap = document.createElement('div');
    wrap.setAttribute('data-role','bulk-create-wrap');
    wrap.className = 'form-group';
    wrap.style.gridColumn = '1 / -1';
    wrap.innerHTML = `
        <div style="display:flex; gap:.5rem; align-items:end; flex-wrap:wrap; border-bottom:1px dashed #cbd5e1; padding-bottom:.5rem; margin-bottom:.5rem;">
            <label class="flex flex-col" style="min-width:180px;">
                <span style="font-size:.75rem; color:#334155; font-weight:600;">Create Mode</span>
                <select id="roomCreateMode">
                    <option value="single" selected>Single room</option>
                    <option value="range">Bulk range</option>
                </select>
                <small>Switch to create many rooms</small>
            </label>
            <div id="bulkInputs" style="display:none; gap:.5rem; align-items:end; flex-wrap:wrap;">
                <label class="flex flex-col">
                    <span style="font-size:.75rem; color:#334155; font-weight:600;">Prefix</span>
                    <input id="bulkPrefix" placeholder="e.g. NMC-50MC-K" />
                </label>
                <label class="flex flex-col">
                    <span style="font-size:.75rem; color:#334155; font-weight:600;">From</span>
                    <input id="bulkFrom" type="number" min="0" placeholder="1" />
                </label>
                <label class="flex flex-col">
                    <span style="font-size:.75rem; color:#334155; font-weight:600;">To</span>
                    <input id="bulkTo" type="number" min="0" placeholder="10" />
                </label>
                <label class="flex flex-col">
                    <span style="font-size:.75rem; color:#334155; font-weight:600;">Zero pad</span>
                    <input id="bulkPad" type="number" min="0" max="6" value="0" />
                </label>
                <div style="font-size:.7rem; color:#64748b;">Codes like: <code id="bulkPreview">N/A</code></div>
            </div>
        </div>`;
    // Put Create Mode at the very top
    grid.insertBefore(wrap, grid.firstChild);
    const modeSel = wrap.querySelector('#roomCreateMode');
    const bulkBox = wrap.querySelector('#bulkInputs');
    const fields = {
        prefix: wrap.querySelector('#bulkPrefix'),
        from: wrap.querySelector('#bulkFrom'),
        to: wrap.querySelector('#bulkTo'),
        pad: wrap.querySelector('#bulkPad'),
        preview: wrap.querySelector('#bulkPreview')
    };
    // Fields to show/hide depending on mode
    const codeInput = form.querySelector('input[name="code"]');
    const nameInput = form.querySelector('input[name="name"]');
    const codeGroup = codeInput ? codeInput.closest('.form-group') : null;
    const nameGroup = nameInput ? nameInput.closest('.form-group') : null;
    const updatePreview = () => {
        const p = (fields.prefix.value||'').trim();
        const a = parseInt(fields.from.value||'');
        const b = parseInt(fields.to.value||'');
        const z = Math.max(0, parseInt(fields.pad.value||'0'));
        if (!p || !Number.isFinite(a) || !Number.isFinite(b) || a>b) { fields.preview.textContent = 'N/A'; return; }
        const s = String(a).padStart(z,'0');
        const e = String(b).padStart(z,'0');
        fields.preview.textContent = `${p}${s}..${p}${e}`;
    };
    const applyModeUI = () => {
        const bulk = modeSel.value === 'range';
        bulkBox.style.display = bulk ? 'flex' : 'none';
        if (codeGroup) codeGroup.style.display = bulk ? 'none' : '';
        if (nameGroup) nameGroup.style.display = bulk ? 'none' : '';
        if (codeInput) {
            if (bulk) { codeInput.removeAttribute('required'); }
            else { codeInput.setAttribute('required',''); }
        }
    };
    modeSel.addEventListener('change', applyModeUI);
    ['input','change'].forEach(evt=>{
        fields.prefix.addEventListener(evt, updatePreview);
        fields.from.addEventListener(evt, updatePreview);
        fields.to.addEventListener(evt, updatePreview);
        fields.pad.addEventListener(evt, updatePreview);
    });
    // Initialize mode-dependent UI on insert
    applyModeUI();
}
// Room Types modal/form UI removed; keep no-op to avoid errors if referenced
function populateRoomTypeForm(rt){ return; }
function resetAmenityForm(){ const form=document.getElementById('amenityForm'); form.reset(); editingAmenityCode=null; }
async function saveRoom(){
    const form=document.getElementById('roomForm');
    const data=Object.fromEntries(new FormData(form).entries());
    const modeEl = document.getElementById('roomCreateMode');
    const mode = modeEl ? modeEl.value : 'single';
    const bulkBoxEl = document.getElementById('bulkInputs');
    // Fallback: if bulk UI is visible, treat as bulk even if select not found
    const uiBulkVisible = (()=>{ try{ if(!bulkBoxEl) return false; const ds = getComputedStyle(bulkBoxEl).display; return !!bulkBoxEl && ds && ds !== 'none'; }catch(_){ return false; }})();
    const companySel=document.getElementById('roomCompanySelect');
    const selectedCompanyId=companySel? companySel.value: '';
    let selectedCompanyName=''; if(companySel){ const opt=companySel.options[companySel.selectedIndex]; selectedCompanyName = opt? opt.text : ''; }

    if (mode === 'range' || uiBulkVisible){
        // Validate shared fields for bulk create
        if(!data.type){ alert('Type is required'); return; }
        const block = data.block;
        const status = data.status || 'Available';
        const prefix = (document.getElementById('bulkPrefix')?.value||'').trim();
        const from = parseInt(document.getElementById('bulkFrom')?.value||'');
        const to = parseInt(document.getElementById('bulkTo')?.value||'');
        const pad = Math.max(0, parseInt(document.getElementById('bulkPad')?.value||'0'));
        if (!prefix || !Number.isFinite(from) || !Number.isFinite(to) || from>to){ alert('Please provide a valid prefix and a valid range (from <= to)'); return; }
    // Generate codes
    const codes = Array.from({length: (to-from+1)}, (_,i)=> `${prefix}${String(from+i).padStart(pad,'0')}`);
    // Ensure in memory then push company/status and save (do not rely on any localStorage skip flags)
    await ensureRoomsByCodes(codes, block||'');
        // Apply type/company/status/amenities/notes to the affected codes
        const lcSet = new Set(codes.map(c=> String(c).toLowerCase()));
        let changed = 0; const changedRooms = [];
        rooms = rooms.map(r => {
            if (!r || !r.code || !lcSet.has(String(r.code).toLowerCase())) return r;
            const updated = { ...r };
            updated.type = data.type;
            updated.status = status;
            updated.amenities = [...selectedRoomAmenities];
            updated.notes = data.notes || '';
            updated.forCompanyId = selectedCompanyId||CompanyStorage?.getCompanyId?.();
            updated.forCompanyName = selectedCompanyName||undefined;
            updated.updated = Date.now();
            changedRooms.push(updated);
            changed++;
            return updated;
        });
        closeModal('roomModal');
        // Focus filters to show the created rooms
        try {
            // Limit table to newly created codes until user clears
            window.__tempCodesFilter = new Set(codes.map(c => String(c).toLowerCase()));
            focusRoomsAfterSave({ mode:'range', codes, type:data.type, block, companyName:selectedCompanyName, status });
        } catch(_){ }
        // Upsert to Firebase immediately for changed rooms
        try { await upsertRoomsToFirebase(changedRooms); } catch(_){}
        await saveCompanyData();
        return;
    }

    // Single create/update path
    if(!data.code || !data.type){ alert('Code & Type required'); return;}
    const existing=rooms.find(r=> r.id===editingRoomId);
    if(existing){
        existing.code=data.code; existing.name=data.name||''; existing.type=data.type;
        existing.location={block:data.block}; existing.status=data.status;
        existing.amenities=[...selectedRoomAmenities]; existing.notes=data.notes||'';
        existing.updated=Date.now();
        existing.forCompanyId=selectedCompanyId||CompanyStorage?.getCompanyId?.();
        existing.forCompanyName=selectedCompanyName||undefined;
    } else {
        rooms.push({ id:genId(), code:data.code, name:data.name||'', type:data.type, location:{block:data.block}, status:data.status, amenities:[...selectedRoomAmenities], notes:data.notes||'', updated:Date.now(), forCompanyId: selectedCompanyId||CompanyStorage?.getCompanyId?.(), forCompanyName: selectedCompanyName||undefined });
    }
    closeModal('roomModal');
    try {
        // Limit table to the single newly created/updated code
        window.__tempCodesFilter = new Set([String(data.code).toLowerCase()]);
        focusRoomsAfterSave({ mode:'single', codes:[data.code], type:data.type, block:data.block, companyName:selectedCompanyName, status:data.status, name:data.name||'' });
    } catch(_){ }
    // Upsert just the affected room to Firebase first for near-real-time persistence
    try {
        const last = rooms.find(r => r.code === data.code);
        if (last) await upsertRoomsToFirebase([last]);
    } catch(_){ }
    await saveCompanyData();
}

// After saving, adjust filters so the newly created rooms are visible immediately
function focusRoomsAfterSave({ mode, codes=[], type, block, companyName, status, name }){
    // If Kamsar, temporarily allow showing them
    if (String(block||'').trim().toLowerCase() === 'kamsar') { try { window.__includeKamsar = true; } catch(_){} }
    const setSel = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    if (mode === 'single'){
        // Match the Room dropdown value exactly (label is code or "code  name")
        const label = (name && name.trim()) ? `${codes[0]}  ${name}` : `${codes[0]}`;
        setSel('filterRoomSel', label);
        // Clear other filters to avoid hiding
        setSel('filterTypeSel',''); setSel('filterLocationSel',''); setSel('filterCompanySel',''); setSel('filterStatusSel',''); setSel('filterUpdatedSel','');
        renderRooms(); updateRoomStats();
        // Show temporary notice of scoped results
        try { showTemporaryCodeFilterNotice(1); } catch(_){ }
        return;
    }
    // Bulk: filter by chosen attributes to surface all created rooms
    // Tighten the view: on bulk, set Room filter to the first created label only if a single code, otherwise leave empty but show notice
    setSel('filterRoomSel','');
    if (type) setSel('filterTypeSel', type);
    if (block) setSel('filterLocationSel', block);
    if (companyName) setSel('filterCompanySel', companyName);
    if (status) setSel('filterStatusSel', status);
    // Leave date unset
    renderRooms(); updateRoomStats();
    try { showTemporaryCodeFilterNotice(codes.length); } catch(_){ }
}

// Show a small banner telling how many newly created rooms are currently being shown
function showTemporaryCodeFilterNotice(count){
    const el = document.getElementById('tempFilterNotice');
    const n = document.getElementById('tempFilterCount');
    if (!el || !n) return;
    n.textContent = String(count||0);
    el.style.display = 'inline-flex';
}
function clearTemporaryCodeFilter(){
    const el = document.getElementById('tempFilterNotice');
    if (el) el.style.display = 'none';
    // Clear Room filter only; keep other filters as the user set
    const setSel = (id, val) => { const el2 = document.getElementById(id); if (el2) el2.value = val || ''; };
    setSel('filterRoomSel','');
    renderRooms(); updateRoomStats();
}
// Room Types creation UI removed; keep function to avoid runtime errors if called elsewhere
async function saveRoomType(){ console.warn('Room Types UI is disabled.'); }
async function saveAmenity(){ 
    console.log(' saveAmenity called - editingAmenityCode:', editingAmenityCode);
    
    const form=document.getElementById('amenityForm'); 
    const data=Object.fromEntries(new FormData(form).entries()); 
    
    if(!editingAmenityCode){ 
        console.log(' No amenity selected for editing - editingAmenityCode is:', editingAmenityCode);
        alert('No amenity selected for editing'); 
        return;
    } 
    
    const existing=amenities.find(a=> a.code===editingAmenityCode); 
    if(existing){ 
        // Store the amenity name for feedback
        const amenityName = existing.name;
        
        // Update the amenity
        existing.active=data.active==='true'; 
        existing.description=data.description||''; 
        
        // Show success feedback
        console.log(` Updated amenity: ${amenityName} (${editingAmenityCode})`);
        
        // Optional: Show a brief success message
        const modalTitle = document.querySelector('#amenityModal .modal-header h3');
        if(modalTitle) {
            const originalTitle = modalTitle.textContent;
            modalTitle.textContent = ` Updated: ${amenityName}`;
            setTimeout(() => {
                modalTitle.textContent = 'Amenities';
            }, 1500);
        }
    } else {
        alert(`Error: Could not find amenity with code: ${editingAmenityCode}`);
        return;
    }
    
    // Clear row highlighting
    document.querySelectorAll('.amenities-table tr').forEach(row => row.classList.remove('editing-row'));
    
    form.reset(); 
    renderAmenities(); 
    populateFilters(); 
    await saveCompanyData(); 
}
// ================= Removal Utilities =================
// Remove all rooms belonging to a specific company (by company name)
async function removeRoomsByCompany(companyName){
    try{
        const target = String(companyName||'').trim().toLowerCase();
        if (!target){ alert('Please provide a company name'); return; }
        const before = rooms.length;
        // Try to resolve scope id to be thorough
        let scope = null;
        try { scope = await findCompanyScopeByName(companyName); } catch(_){ scope = null; }
        const scopeId = scope && scope.id ? String(scope.id) : null;
        const deleteIds = [];
        rooms = (rooms||[]).filter(r => {
            const nm = (r.forCompanyName||'').toString().trim().toLowerCase();
            const id = r.forCompanyId ? String(r.forCompanyId) : null;
            const nameMatches = nm && nm === target;
            const idMatches = scopeId && id && id === scopeId;
            const match = (nameMatches || idMatches);
            if (match && r.id) deleteIds.push(r.id);
            return !match;
        });
        const removed = before - rooms.length;
        console.log(` Removed ${removed} room(s) for company: ${companyName}`);
        renderRooms(); updateRoomStats();
        try { if (deleteIds.length) await deleteRoomsFromFirebase(deleteIds); } catch(e){ console.error('Remote delete (by company) failed', e); }
        await saveCompanyData();
        return removed;
    } catch(e){ console.warn('removeRoomsByCompany failed:', e); throw e; }
}
window.removeRoomsByCompany = removeRoomsByCompany;
// Delete all rooms currently visible in the Rooms table (respects active filters and Kamsar override)
async function deleteVisibleRooms(){
    try{
        const list = Array.isArray(window.visibleRooms) ? window.visibleRooms : [];
        if (!list.length){ alert('No rooms to delete. Adjust filters if needed.'); return 0; }
        if (!confirm(`Delete ${list.length} room(s) currently displayed? This action cannot be undone.`)) return 0;
        const ids = new Set(list.map(r=> r.id));
        const before = rooms.length;
        rooms = rooms.filter(r => !ids.has(r.id));
        const removed = before - rooms.length;
        console.log(` Deleted ${removed} visible room(s).`);
    renderRooms(); updateRoomStats();
    try { await deleteRoomsFromFirebase(Array.from(ids)); } catch(e){ console.error('Remote delete (visible) failed', e); }
    await saveCompanyData();
        return removed;
    } catch(e){ console.warn('deleteVisibleRooms failed:', e); throw e; }
}
window.deleteVisibleRooms = deleteVisibleRooms;
function editRoom(id){ const r=rooms.find(x=> x.id===id); if(!r) return; editingRoomId=id; openModal('roomModal'); }
async function duplicateRoom(id){ const r=rooms.find(x=> x.id===id); if(!r) return; const copy={...r, id:genId(), code:r.code+'-COPY', name: r.name? r.name+' Copy' : '', status:'Available', updated:Date.now()}; rooms.push(copy); renderRooms(); updateRoomStats(); await saveCompanyData(); }
async function deleteRoom(id){
    if(!confirm('Delete this room?')) return;
    rooms=rooms.filter(r=> r.id!==id);
    renderRooms(); updateRoomStats();
    try { await deleteRoomsFromFirebase([id]); } catch(e){ console.error('Remote single delete failed', e); }
    await saveCompanyData();
}
function editRoomType(id){ console.warn('Room Types UI is disabled.'); }
async function deleteRoomType(id){ 
    if(!confirm('Delete this room type?')) return; 
    
    console.log(' Starting deletion of room type with ID:', id);
    
    // Find the room type being deleted for logging
    const roomTypeToDelete = roomTypes.find(r => r.id === id);
    if (roomTypeToDelete) {
        console.log(' Deleting room type:', roomTypeToDelete.name, '(', roomTypeToDelete.code, ')');
    }
    
    console.log(' Room types count before deletion:', roomTypes.length);
    console.log(' Room types before:', roomTypes.map(rt => `${rt.name} (${rt.id})`));
    
    // Remove from local array
    roomTypes = roomTypes.filter(r => r.id !== id); 
    
    console.log(' Room types count after deletion:', roomTypes.length);
    console.log(' Room types after:', roomTypes.map(rt => `${rt.name} (${rt.id})`));
    console.log(' Re-rendering tables...');
    
    // Update UI
    renderRoomTypes(); 
    renderRooms(); 
    
    try {
        console.log(' Attempting to save to Firebase...');
        console.log(' Data being saved to Firebase:', {
            roomTypesCount: roomTypes.length,
            roomTypes: roomTypes.map(rt => ({ name: rt.name, code: rt.code, id: rt.id }))
        });
        
        await saveCompanyData(); 
        
        console.log(' Room type deletion completed successfully');
        console.log(' Data should now be persisted in Firebase');
        
        // Verify Firebase path
        const companyId = CompanyStorage.getCompanyId();
        const firebasePath = `companies/${companyId}/campData/roomTypes`;
        console.log(' Firebase path used:', firebasePath);
        
        // Optional: Verify the data was actually saved (with a small delay)
        setTimeout(async () => {
            console.log(' Verifying deletion was persisted...');
            await verifyFirebaseData();
        }, 1000);
        
    } catch (error) {
        console.error(' ERROR: Failed to save deletion to Firebase:', error);
        alert('Warning: Room type was removed from the table but may not have been saved to the database. Please refresh the page to verify.');
        throw error;
    }
}
function editAmenity(code){ 
    console.log(' editAmenity called with code:', code);
    
    const a=amenities.find(x=> x.code===code); 
    if(!a) {
        console.log(' Amenity not found for code:', code);
        return;
    } 
    
    // Clear any previous highlights
    document.querySelectorAll('.amenities-table tr').forEach(row => row.classList.remove('editing-row'));
    
    // Highlight the row being edited
    const rows = document.querySelectorAll('.amenities-table tr');
    rows.forEach(row => {
        if(row.innerHTML.includes(`onclick="editAmenity('${code}')"`) && !row.classList.contains('editing-row')) {
            row.classList.add('editing-row');
        }
    });
    
    editingAmenityCode=code;
    console.log(' Set editingAmenityCode to:', editingAmenityCode);
    
    openModal('amenityModal'); 
    const form=document.getElementById('amenityForm'); 
    form.active.value=a.active? 'true':'false'; 
    form.description.value=a.description||''; 
    
    // Update modal title to show which amenity is being edited
    const modalTitle = document.querySelector('#amenityModal .modal-header h3');
    if(modalTitle) {
        modalTitle.textContent = `Edit Amenity: ${a.name}`;
    }
}

// Room Amenities Dropdown Functions
let selectedRoomAmenities = [];

function populateAmenityDropdown() {
    const dropdown = document.getElementById('amenityDropdown');
    if (!dropdown) return;
    
    const availableAmenities = amenities.filter(a => a.active && !selectedRoomAmenities.includes(a.code));
    dropdown.innerHTML = '<option value="">-- Add Amenity --</option>' + 
        availableAmenities.map(a => `<option value="${a.code}"><i class="fa ${a.icon||'fa-circle'}"></i> ${a.name}</option>`).join('');
}

function addAmenityToRoom(amenityCode) {
    if (!amenityCode || selectedRoomAmenities.includes(amenityCode)) return;
    
    selectedRoomAmenities.push(amenityCode);
    renderRoomAmenities();
    populateAmenityDropdown();
    
    // Reset dropdown
    document.getElementById('amenityDropdown').value = '';
}

function removeRoomAmenity(amenityCode) {
    selectedRoomAmenities = selectedRoomAmenities.filter(code => code !== amenityCode);
    renderRoomAmenities();
    populateAmenityDropdown();
}

function renderRoomAmenities() {
    const container = document.getElementById('roomAmenitiesContainer');
    if (!container) return;
    
    if (selectedRoomAmenities.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-size:0.7rem; padding:0.5rem 0;">No amenities selected</div>';
        return;
    }
    
    const amenMap = Object.fromEntries(amenities.map(a => [a.code, a]));
    container.innerHTML = selectedRoomAmenities.map(code => {
        const amenity = amenMap[code];
        if (!amenity) return '';
        return `<div class="amenity-badge">
            <i class="fa ${amenity.icon||'fa-circle'}"></i>
            ${amenity.name}
            <button class="remove-btn" onclick="removeRoomAmenity('${code}')" title="Remove">&times;</button>
        </div>`;
    }).filter(Boolean).join('');
}

// Room Type Amenity Management
let selectedRoomTypeAmenities = [];

function addAmenityToRoomType(amenityCode) {
    // No-op if UI removed
    if (!amenityCode || selectedRoomTypeAmenities.includes(amenityCode)) return;
    
    selectedRoomTypeAmenities.push(amenityCode);
    renderRoomTypeAmenities();
    populateRoomTypeAmenityDropdown();
    
    // Reset dropdown
    const dd = document.getElementById('roomTypeAmenityDropdown');
    if(dd) dd.value = '';
}

function removeRoomTypeAmenity(amenityCode) {
    selectedRoomTypeAmenities = selectedRoomTypeAmenities.filter(code => code !== amenityCode);
    renderRoomTypeAmenities();
    populateRoomTypeAmenityDropdown();
}

function renderRoomTypeAmenities() {
    const container = document.getElementById('roomTypeAmenitiesContainer');
    if (!container) return;
    
    if (selectedRoomTypeAmenities.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-size:0.7rem; padding:0.5rem 0;">No default amenities selected</div>';
        return;
    }
    
    const amenMap = Object.fromEntries(amenities.map(a => [a.code, a]));
    container.innerHTML = selectedRoomTypeAmenities.map(code => {
        const amenity = amenMap[code];
        if (!amenity) return '';
        return `<div class="amenity-badge">
            <i class="fa ${amenity.icon||'fa-circle'}"></i>
            ${amenity.name}
            <button class="remove-btn" onclick="removeRoomTypeAmenity('${code}')" title="Remove">&times;</button>
        </div>`;
    }).filter(Boolean).join('');
}

function populateRoomTypeAmenityDropdown() {
    const dropdown = document.getElementById('roomTypeAmenityDropdown');
    if (!dropdown) return;
    
    const available = amenities.filter(a => 
        a.active && !selectedRoomTypeAmenities.includes(a.code)
    );
    
    dropdown.innerHTML = '<option value="">-- Add Amenity --</option>' + 
        available.map(a => `<option value="${a.code}">${a.name}</option>`).join('');
}

// Refresh helpers
function refreshRooms(){ renderRooms(); }

async function refreshRoomsFromFirebase() {
    console.log(' Manual refresh from Firebase triggered...');
    try {
        const tbody = document.getElementById('roomsTbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Loading rooms from Firebase...</td></tr>';
        }
        
        // Load rooms from current company legacy path with fallback to campData/rooms
        const companyId = CompanyStorage.getCompanyId();
        let roomsData = null;
        try {
            let auth = '';
            try { const u = firebase.auth().currentUser; if (u) { const t = await u.getIdToken(false); if (t) auth = `?auth=${t}`; } } catch(_){}
            let resp = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/rooms.json${auth}`);
            if (!resp.ok) resp = await fetch(`https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/campData/rooms.json${auth}`);
            if (resp.ok) roomsData = await resp.json();
        } catch (e) {
            console.warn(' Manual refresh - company rooms fetch failed:', e);
        }

        // No cross-company fallback here; show only the active company's rooms

        if (roomsData && typeof roomsData === 'object') {
            rooms = Object.keys(roomsData).map(key => ({ id: key, ...roomsData[key] }));
            console.log(' Manual refresh - Loaded rooms from Firebase:', rooms.length, rooms);
            renderRooms();
            updateRoomStats();
            maybeRenderAnalytics();
        } else {
            rooms = [];
            console.log(' Manual refresh - No rooms data found');
            renderRooms();
            updateRoomStats([]);
            maybeRenderAnalytics();
        }
    } catch (error) {
        console.error(' Manual refresh error:', error);
        const tbody = document.getElementById('roomsTbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error loading rooms</td></tr>';
        }
    }
}
// Initialize Centralized Authentication
let authManager; 
document.addEventListener('DOMContentLoaded', async () => {
    console.log(' Creating centralized AuthManager instance...');
    authManager = new AuthManager();
    window.authManager = authManager; // Make available globally
    
    // Initialize basic UI first
    setupUIInteractions();
    setupTabNavigation();
    
    // Initialize Firebase auth state listener
    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            console.log(' User authenticated:', user.email);
            // Update auth manager
            if (authManager) {
                authManager.currentUser = user;
                
                // Load user role for role-based filtering
                await authManager.loadUserRole(user);
                
                authManager.updateUIForAuthenticatedUser();
            }
            
            // Load menu with permissions
            try {
                await updateMenuWithFeatureAuthorization();
            } catch (error) {
                console.warn(' Menu authorization failed, showing basic menu:', error);
                showBasicMenu();
            }

            // Re-initialize Settings tab data now that company context is known
            try {
                await initUserVisibilitySettings();
                // Initialize camp settings once company context is available
                await initCampSettings();
            } catch (e) {
                console.warn(' Could not initialize visibility settings after auth:', e);
            }
        } else {
            console.log(' No user authenticated; leaving sidebar hidden (no fallback items)');
            const sidebar=document.querySelector('.sidebar');
            sidebar?.classList.remove('menu-loading');
        }
    });
    
    // Also trigger init if auth state listener doesn't fire quickly (guest/anon)
    setTimeout(async () => { try { if (!window.__campInitDone){ await initCampSettings(); window.__campInitDone=true; } } catch(_){} }, 500);
    
    // Restore sidebar state
    await restoreSidebarState();
    
    // Enhanced profile initialization with centralized auth
    setTimeout(() => {
        if (authManager && authManager.currentUser) {
            console.log(' Force calling updateUIForAuthenticatedUser...');
            authManager.updateUIForAuthenticatedUser();
            
            // Force refresh of profile image
            const profileImg = document.querySelector('#userProfileBtn img');
            if (profileImg && (!profileImg.src || profileImg.src === '' || profileImg.src.endsWith('/') || profileImg.src === window.location.href)) {
                authManager.generateInitialsAvatar(authManager.getUserDisplayName(), profileImg);
            }
        }
    }, 1000);
    
    // Setup event listeners
    // Filters removed: no listeners to attach
    // Draw initial stats once UI is ready
    updateRoomStats();
    
    // Force menu visibility after short delay if still loading
    setTimeout(() => {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar && sidebar.classList.contains('menu-loading')) {
            console.log(' Timeout reached - removing loading class without showing unauthorized items');
            sidebar.classList.remove('menu-loading');
        }
    }, 3000);

    // Initialize visibility settings (Settings tab)
    try {
        await initUserVisibilitySettings();
    } catch (e) {
        console.warn(' Visibility settings initialization failed:', e);
    }
});

// Enhanced Tab Navigation
function setupTabNavigation() {
    console.log(' Setting up tab navigation...');
    document.querySelectorAll('.tab-nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = btn.dataset.tab;
            console.log(' Tab clicked:', tabId);
            if (tabId) {
                switchTab(tabId);
            }
        });
    });
    
    // Initialize first tab as active if none are active
    const activeTabs = document.querySelectorAll('.tab-nav-btn.active');
    if (activeTabs.length === 0) {
        const firstTab = document.querySelector('.tab-nav-btn');
        if (firstTab) {
            const firstTabId = firstTab.dataset.tab;
            if (firstTabId) {
                switchTab(firstTabId);
            }
        }
    }
}

function switchTab(tabId) {
    console.log(' Switching to tab:', tabId);
    
    // Remove active class from all buttons and content
    document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to selected button and content
    const activeBtn = document.querySelector(`.tab-nav-btn[data-tab="${tabId}"]`);
    const activeContent = document.getElementById(`${tabId}Tab`);
    
    if (activeBtn) {
        activeBtn.classList.add('active');
        console.log(' Tab button activated:', tabId);
    } else {
        console.warn(' Tab button not found:', tabId);
    }
    
    if (activeContent) {
        activeContent.classList.add('active');
        console.log(' Tab content activated:', tabId);
    } else {
        console.warn(' Tab content not found:', `${tabId}Tab`);
    }
    // If analytics tab is activated, render charts now (delay so layout paints)
    if (tabId === 'analytics') {
        setTimeout(()=>{ 
            try{ window.ensureCampAnalyticsBuilderSection?.(); }catch(e){}
            try{ renderAnalyticsCharts(); }catch(e){}
            try{ loadCampAnalyticsModels(); }catch(e){}
        }, 50);
    }
}
// Close modal when clicking outside dialog
window.addEventListener('click',e=>{ if(e.target.classList.contains('modal')) e.target.classList.remove('show'); });

// Context-aware + button handler in page header
function onAddNewClick() {
    // Determine active tab
    const activeBtn = document.querySelector('.tab-nav-btn.active');
    const activeTab = activeBtn ? activeBtn.getAttribute('data-tab') : 'rooms';
    if (activeTab === 'settings') {
        openVisibilityModal();
    } else if (activeTab === 'amenities') {
        openModal('amenityModal');
    } else {
        openModal('roomModal');
    }
}

function openVisibilityModal(selectedUid = null) {
    // Sync users and locations into modal controls
    const userSel = document.getElementById('visibilityUserModalSelect');
    if (!userSel) return;
    // Populate users
    const users = __visibility_users || [];
    userSel.innerHTML = '<option value="">Select user</option>' + users.map(u => `<option value="${u.uid}">${u.fullName}${u.jobTitle? ' ('+u.jobTitle+')':''}</option>`).join('');
    // Populate company scope (main company + subcontractors)
    const companySel = document.getElementById('visibilityCompanySelect');
    if (companySel) {
        loadCompanyScopeOptions(companySel);
    }
    // Preselect user if provided (edit flow) or if a settings select exists
    if (selectedUid) {
        userSel.value = selectedUid;
    } else {
        const settingsSel = document.getElementById('visibilityUserSelect');
        if (settingsSel && settingsSel.value) userSel.value = settingsSel.value;
    }
    // Build location chips
    const uidForChips = userSel.value || selectedUid;
    const selected = (uidForChips && __userLocationVisibility[uidForChips] && Array.isArray(__userLocationVisibility[uidForChips].locations))
        ? __userLocationVisibility[uidForChips].locations
        : [];
    buildLocationsMenu(selected);
    renderSelectedLocationChips(selected);
    updateLocationsToggleText(selected);
    // Populate action permission checkboxes for initially selected user
    const visObjInitial = uidForChips && __userLocationVisibility[uidForChips] ? __userLocationVisibility[uidForChips] : null;
    const actsInitial = visObjInitial && visObjInitial.actions ? visObjInitial.actions : {};
    [['modalPermAssign','assign'], ['modalPermEdit','edit'], ['modalPermCheckIn','checkin'], ['modalPermCheckOut','checkout']]
        .forEach(([id,key]) => { const el = document.getElementById(id); if (el) el.checked = !!actsInitial[key]; });
    // Respond to user change inside modal
    userSel.onchange = () => {
        const uid = userSel.value;
        const selected2 = (uid && __userLocationVisibility[uid] && Array.isArray(__userLocationVisibility[uid].locations)) ? __userLocationVisibility[uid].locations : [];
        buildLocationsMenu(selected2);
        renderSelectedLocationChips(selected2);
        updateLocationsToggleText(selected2);
        const visObj = uid && __userLocationVisibility[uid] ? __userLocationVisibility[uid] : null;
        const acts = visObj && visObj.actions ? visObj.actions : {};
        [['modalPermAssign','assign'], ['modalPermEdit','edit'], ['modalPermCheckIn','checkin'], ['modalPermCheckOut','checkout']]
            .forEach(([id,key]) => { const el = document.getElementById(id); if (el) el.checked = !!acts[key]; });
    };
    document.getElementById('visibilityModal')?.classList.add('show');
}

// Load main company and subcontractors as "company scope" options
async function loadCompanyScopeOptions(selectEl) {
    try {
        if (!selectEl) return;
        const companyId = (window.CompanyStorage && CompanyStorage.getCompanyId && CompanyStorage.getCompanyId()) || (window.authManager && window.authManager.currentUser && window.authManager.currentUser.companyId) || null;
        if (!companyId) {
            selectEl.innerHTML = '<option value="">No company context</option>';
            return;
        }
        const db = (window.authManager && window.authManager.db) || firebase.database();
        // Fetch main company (for display name)
        const companySnap = await db.ref(`companies/${companyId}`).once('value');
        const company = companySnap.exists() ? (companySnap.val() || {}) : {};
        const options = [];
        // Main company option
        options.push({ id: companyId, name: company.companyName || 'Main Company' });
        // Subcontractors under company scope
        const subsSnap = await db.ref(`companies/${companyId}/subcontractors`).once('value');
        if (subsSnap.exists()) {
            const subs = subsSnap.val() || {};
            Object.values(subs).forEach(sc => {
                if (!sc) return;
                const id = sc.id || sc.uid || sc.key; // be tolerant to schema
                const name = sc.name || sc.companyName || 'Subcontractor';
                if (id && name) options.push({ id, name });
            });
        }
        // Render options and default-select main company
        selectEl.innerHTML = options.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
        selectEl.value = companyId;
    } catch (err) {
        console.error('Failed to load company scope options:', err);
        if (selectEl) selectEl.innerHTML = '<option value="">Failed to load companies</option>';
    }
}

function buildLocationsMenu(selectedValues = []) {
    const menu = document.getElementById('locationsMenu');
    if (!menu) return;
    const optionsHtml = (__visibility_locations || []).map(loc => {
        const checked = selectedValues.includes(loc.value) ? 'checked' : '';
        return `<div class="multi-option" onclick=\"onLocationOptionClick(event,'${loc.value}')\">\n<input type=\"checkbox\" ${checked}/>\n<span>${loc.label}</span>\n</div>`;
    }).join('');
    menu.innerHTML = optionsHtml;
}

function toggleLocationsMenu(e) {
    e?.stopPropagation?.();
    const menu = document.getElementById('locationsMenu');
    if (!menu) return;
    menu.classList.toggle('show');
    // Close on outside click
    const closeHandler = (ev) => {
        const dd = document.getElementById('visibilityLocationsDropdown');
        if (dd && !dd.contains(ev.target)) {
            menu.classList.remove('show');
            document.removeEventListener('click', closeHandler);
        }
    };
    if (menu.classList.contains('show')) {
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }
}

function onLocationOptionClick(event, value) {
    event.stopPropagation();
    const userSel = document.getElementById('visibilityUserModalSelect');
    const uid = userSel?.value;
    // Determine current selection from UI chips
    const chips = document.getElementById('locationsSelectedChips');
    let selected = Array.from(chips?.querySelectorAll('[data-val]') || []).map(el => el.getAttribute('data-val'));
    if (selected.includes(value)) {
        selected = selected.filter(v => v !== value);
    } else {
        selected.push(value);
    }
    buildLocationsMenu(selected);
    renderSelectedLocationChips(selected);
    updateLocationsToggleText(selected);
}

function updateLocationsToggleText(selectedValues = []) {
    const textEl = document.getElementById('locationsToggleText');
    if (!textEl) return;
    if (!selectedValues || selectedValues.length === 0) {
        textEl.textContent = 'Select locations';
    } else {
        textEl.textContent = `${selectedValues.length} selected`;
    }
}

function renderSelectedLocationChips(selectedValues = []) {
    const chips = document.getElementById('locationsSelectedChips');
    if (!chips) return;
    const map = new Map((__visibility_locations || []).map(l => [l.value, l.label]));
    chips.innerHTML = (selectedValues || []).map(v => `<span class=\"selected-chip\" data-val=\"${v}\">${map.get(v) || v}</span>`).join('');
}

async function saveUserVisibilityMappingFromModal() {
    const userSel = document.getElementById('visibilityUserModalSelect');
    const chips = document.getElementById('locationsSelectedChips');
    if (!userSel || !chips) return;
    const uid = userSel.value;
    if (!uid) { alert('Please select a user'); return; }
    const checked = Array.from(chips.querySelectorAll('[data-val]')).map(el => el.getAttribute('data-val'));
    try {
        const companyId = CompanyStorage.getCompanyId();
        const ref = window.authManager.db.ref(`companies/${companyId}/campSettings/userLocationVisibility/${uid}`);
        const assignAllowed = document.getElementById('modalPermAssign')?.checked || false;
        const editAllowed = document.getElementById('modalPermEdit')?.checked || false;
        const checkInAllowed = document.getElementById('modalPermCheckIn')?.checked || false;
        const checkOutAllowed = document.getElementById('modalPermCheckOut')?.checked || false;
        const payload = { locations: checked, actions: { assign: assignAllowed, edit: editAllowed, checkin: checkInAllowed, checkout: checkOutAllowed } };
        await ref.set(payload);
        __userLocationVisibility[uid] = payload;
        renderVisibilityTable();
        closeModal('visibilityModal');
    } catch (e) {
        console.error('Failed to save mapping:', e);
        alert('Failed to save mapping');
    }
}

// ================= User Room Visibility (Settings Tab) =================
let __visibility_users = [];
let __visibility_locations = [];
let __userLocationVisibility = {}; // { userId: { locations: [..], actions:{assign,edit,checkin,checkout} } }

async function initUserVisibilitySettings() {
    // Build UI controls
    await Promise.all([
        loadUsersForVisibility(),
        loadLocationsForVisibility(),
        loadVisibilityMappings()
    ]);
    buildLocationCheckboxes();
    bindVisibilityUserSelect();
    renderVisibilityTable();
}

function bindVisibilityUserSelect() {
    const sel = document.getElementById('visibilityUserSelect');
    if (!sel) return;
    sel.addEventListener('change', () => {
        // Refresh checkboxes to reflect mapping for selected user
        buildLocationCheckboxes();
    });
}

async function loadUsersForVisibility() {
    try {
        const sel = document.getElementById('visibilityUserSelect');
        if (!window.authManager || !window.authManager.db) return;
        const companyId = CompanyStorage.getCompanyId();
        const snap = await window.authManager.db.ref(`companies/${companyId}/users`).once('value');
        const users = [];
        if (snap.exists()) {
            const data = snap.val();
            Object.keys(data).forEach(uid => {
                const u = data[uid] || {};
                users.push({
                    uid,
                    fullName: [u.firstName, u.lastName].filter(Boolean).join(' ') || (u.displayName || u.name || uid),
                    jobTitle: u.jobTitle || u.title || ''
                });
            });
        }
        users.sort((a,b) => a.fullName.localeCompare(b.fullName));
        __visibility_users = users;
        if (sel) {
            sel.innerHTML = '<option value="">Select user</option>' + users.map(u => `<option value=\"${u.uid}\">${u.fullName}${u.jobTitle? ' ('+u.jobTitle+')':''}</option>`).join('');
        }
    } catch (e) {
        console.warn('Users load failed:', e);
        const sel = document.getElementById('visibilityUserSelect');
        if (sel) sel.innerHTML = '<option value=\"\">No users found</option>';
    }
}

async function loadLocationsForVisibility() {
    try {
        const areas = await loadWorkAreas();
        // Normalize to simple list of values/labels
        __visibility_locations = (areas || [])
            .filter(a => a && a.enabled !== false)
            .map(a => ({ value: a.value || a.code || a.label, label: a.label || a.name || a.value }))
            .filter(a => a.value);
        // Ensure defaults
        if (!__visibility_locations.some(a => a.value === 'Kamsar')) __visibility_locations.push({ value: 'Kamsar', label: 'Kamsar' });
        if (!__visibility_locations.some(a => a.value === 'Tinguilinta')) __visibility_locations.push({ value: 'Tinguilinta', label: 'Tinguilinta' });
    } catch (e) {
        console.warn('Areas load failed:', e);
        __visibility_locations = [ { value:'Kamsar', label:'Kamsar' }, { value:'Tinguilinta', label:'Tinguilinta' } ];
    }
}

async function loadVisibilityMappings() {
    try {
        const companyId = CompanyStorage.getCompanyId();
        const ref = window.authManager.db.ref(`companies/${companyId}/campSettings/userLocationVisibility`);
        const snap = await ref.once('value');
        __userLocationVisibility = snap.exists() ? (snap.val() || {}) : {};
    } catch (e) {
        console.warn('Visibility mappings load failed:', e);
        __userLocationVisibility = {};
    }
}

function buildLocationCheckboxes() {
    const container = document.getElementById('visibilityLocationsContainer');
    const userId = document.getElementById('visibilityUserSelect')?.value || '';
    if (!container) return;
    const selected = (userId && __userLocationVisibility[userId] && Array.isArray(__userLocationVisibility[userId].locations))
        ? __userLocationVisibility[userId].locations
        : [];
    container.innerHTML = __visibility_locations.map(loc => {
        const checked = selected.includes(loc.value) ? 'checked' : '';
        return `<label class="toggle-chip ${checked? 'active':''}" style="cursor:pointer;">
            <input type="checkbox" value="${loc.value}" onchange="onToggleVisibilityLocation(this)" ${checked} style="display:none;" />
            <i class="fa fa-map-marker-alt"></i> ${loc.label}
        </label>`;
    }).join('');
}

function onToggleVisibilityLocation(inputEl) {
    const chip = inputEl.closest('.toggle-chip');
    if (chip) {
        if (inputEl.checked) chip.classList.add('active'); else chip.classList.remove('active');
    }
}

async function saveUserVisibilityMapping() {
    try {
        const userId = document.getElementById('visibilityUserSelect')?.value || '';
        if (!userId) { alert('Please select a user first.'); return; }
        const container = document.getElementById('visibilityLocationsContainer');
        const checked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
        const companyId = CompanyStorage.getCompanyId();
        const ref = window.authManager.db.ref(`companies/${companyId}/campSettings/userLocationVisibility/${userId}`);
    // Gather action permission checkboxes (if present)
    const assignAllowed = document.getElementById('permAssign')?.checked || false;
    const editAllowed = document.getElementById('permEdit')?.checked || false;
    const checkInAllowed = document.getElementById('permCheckIn')?.checked || false;
    const checkOutAllowed = document.getElementById('permCheckOut')?.checked || false;
    const payload = { locations: checked, actions: { assign: assignAllowed, edit: editAllowed, checkin: checkInAllowed, checkout: checkOutAllowed } };
    await ref.set(payload);
    __userLocationVisibility[userId] = payload;
        renderVisibilityTable();
        alert('Mapping saved');
    } catch (e) {
        console.error('Failed to save mapping:', e);
        alert('Failed to save mapping');
    }
}

async function clearUserVisibilityMapping() {
    try {
        const userId = document.getElementById('visibilityUserSelect')?.value || '';
        if (!userId) { alert('Please select a user first.'); return; }
        const companyId = CompanyStorage.getCompanyId();
        const ref = window.authManager.db.ref(`companies/${companyId}/campSettings/userLocationVisibility/${userId}`);
    await ref.remove();
    delete __userLocationVisibility[userId];
        buildLocationCheckboxes();
        renderVisibilityTable();
        alert('Mapping cleared');
    } catch (e) {
        console.error('Failed to clear mapping:', e);
        alert('Failed to clear mapping');
    }
}

function renderVisibilityTable() {
    const tbody = document.getElementById('visibilityTbody');
    if (!tbody) return;
    const byUser = __userLocationVisibility || {};
    const rows = Object.keys(byUser).map(uid => {
        const user = __visibility_users.find(u => u.uid === uid) || { fullName: uid, jobTitle: '' };
        const userVis = byUser[uid] || {};
        const locs = (userVis && Array.isArray(userVis.locations)) ? userVis.locations : [];
        const acts = (userVis.actions) || {};
        const actionBadges = ['assign','edit','checkin','checkout']
            .filter(a => acts[a])
            .map(a => `<span class='site-badge' style="background:#eef; color:#223;">${a}</span>`)
            .join(' ') || '<span style="color:#94a3b8;">none</span>';
        return `<tr>
            <td>${user.fullName}</td>
            <td>${user.jobTitle || '-'}</td>
            <td>${locs.length ? locs.map(v => `<span class='site-badge'>${v}</span>`).join(' ') : '<span style="color:#64748b;">All (no restriction)</span>'}</td>
            <td>${actionBadges}</td>
            <td>
                <div class='inline-actions'>
                    <button class='btn btn-outline' onclick="editVisibilityUser('${uid}')"><i class='fa fa-pen'></i></button>
                    <button class='btn btn-outline' onclick="deleteVisibilityUser('${uid}')"><i class='fa fa-trash'></i></button>
                </div>
            </td>
        </tr>`;
    });
    tbody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan=\"5\" class=\"empty-state\">No mappings yet. Click the + button to add one.</td></tr>`;
}

function editVisibilityUser(uid) {
    // Ensure we are on the settings tab
    switchTab('settings');
    // Open modal pre-selecting this user
    openVisibilityModal(uid);
}

async function deleteVisibilityUser(uid) {
    if (!confirm('Remove this user\'s visibility mapping?')) return;
    try {
        const companyId = CompanyStorage.getCompanyId();
        const ref = window.authManager.db.ref(`companies/${companyId}/campSettings/userLocationVisibility/${uid}`);
        await ref.remove();
        delete __userLocationVisibility[uid];
        renderVisibilityTable();
        const currentSel = document.getElementById('visibilityUserSelect');
        if (currentSel && currentSel.value === uid) buildLocationCheckboxes();
    } catch (e) {
        console.error('Failed to delete mapping:', e);
        alert('Failed to delete mapping');
    }
}
</script>

<!-- Excel import removed by request -->

</body>
</html>
