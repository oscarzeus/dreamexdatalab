<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Security Level Evaluation - Dreamex Datalab</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<!-- Firebase v8 Scripts for Centralized Authentication -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root { --primary-color:#2c3e50; --secondary-color:#34495e; --accent-color:#e74c3c; --success-color:#27ae60; --warning-color:#f39c12; --info-color:#3498db; --light-color:#ecf0f1; --dark-color:#2c3e50; --sidebar-width:250px; --transition-speed:.25s; }
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
.app-container { display:flex; min-height:100vh; }
.sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; transition:transform .3s ease; z-index:1000; }
.sidebar.collapsed { transform:translateX(-100%); }
.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.3rem; padding-top:3.2rem; transition:margin-left .3s ease; }
.main-content.sidebar-collapsed { margin-left:0; }
.main-content.sidebar-collapsed .top-nav { left:0.5rem; }
.logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:1.05rem; letter-spacing:.5px; }
.menu { list-style:none; margin-top:2rem; }
.menu li { margin-bottom:0.45rem; }
.menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.6rem 0.75rem; border-radius:6px; font-size:0.82rem; font-weight:500; transition:background .25s; }
.menu a:hover, .menu a.active { background:rgba(255,255,255,0.12); }
.submenu { list-style:none; margin-left:0.75rem; display:none; margin-top:0.25rem; }
.menu-dropdown:hover .submenu { display:block; }
.submenu a { font-size:0.75rem; padding:0.45rem 0.65rem; }
[data-feature]:not(.menu-visible) { display:none !important; }
.menu-dropdown:not(.menu-visible) { display:none !important; }
.sidebar.menu-loading .menu-item,
.sidebar.menu-loading .menu-dropdown,
.sidebar.menu-loading li[data-feature],
.sidebar.menu-loading [data-feature] {
    display: none !important;
}
.sidebar.menu-loading .menu-visible,
.sidebar.menu-loading li.menu-visible,
.sidebar.menu-loading [data-feature].menu-visible {
    display: block !important;
}
.menu-loading [data-feature] {
    display: none !important;
}
.menu-loading .menu-dropdown {
    display: none !important;
}
.menu-visible {
    display: block !important;
}
li.menu-visible,
[data-feature].menu-visible {
    display: block !important;
}
.top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
.sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
.top-nav-left { display:flex; align-items:center; gap:0.75rem; }
.company-branding { display:flex; align-items:center; gap:0.5rem; }
#headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
#headerCompanyName { font-weight:600; font-size:0.85rem; }
.header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }
.top-nav-right { display:flex; align-items:center; gap:1rem; }
.profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
.profile-btn img { width:100%; height:100%; object-fit:cover; display:none; }
.profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; z-index:1000; }
.profile-dropdown.show { display:block; }
.profile-dropdown ul { list-style:none; margin:0; padding:0; }
.profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
.profile-dropdown li a:hover { background:#f1f5f9; }
.notifications { position:relative; display:flex; align-items:center; }
.notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
.notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; display:none; }
.notification-dropdown { display:none; position:absolute; right:0; top:100%; width:320px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:1000; border:1px solid #e9ecef; max-height:400px; overflow:hidden; }
.notification-dropdown.show { display:block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
/* Removed invalid ...existing code... marker and duplicate CSS */
.menu { list-style: none; margin-top: 2rem; }
.menu li { margin-bottom: 0.45rem; }
.menu a {
	display: flex; align-items: center; gap: 10px;
	color: #fff; text-decoration: none;
	padding: 0.6rem 0.75rem;
	border-radius: 6px;
	font-size: 0.92rem; font-weight: 500;
	transition: background .25s;
}
.menu a:hover, .menu a.active { background: rgba(255,255,255,0.12); }
.page-header {
	background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
	color: #fff;
	padding: 0.85rem 1.2rem;
	margin: 0.35rem 0 0.5rem 0;
	display: flex; align-items: center; justify-content: space-between;
	box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
	font-size: 1.1rem;
	border-radius: 12px;
}
.page-header h1 {
	color: #fff;
	font-size: 1.2rem;
	display: flex; align-items: center; gap: 0.7rem;
	letter-spacing: 0.5px; margin: 0; font-weight: 700;
}
.section {
	background: #fff;
	padding: 1.2rem 1.5rem;
	border-radius: 16px;
	box-shadow: 0 2px 12px rgba(44,62,80,0.08);
	margin-bottom: 1.2rem;
	max-width: 600px;
	margin-left: auto;
	margin-right: auto;
}
.toolbar { display:flex; flex-wrap:nowrap; gap:0.6rem; align-items:center; justify-content:space-between; margin: 0.6rem 0 0.9rem 0; width: 100%; }
.toolbar-left { display:flex; gap:0.6rem; align-items:center; }
.toolbar input[type="text"] { padding:0.5rem 0.6rem; border:1px solid #cbd5e1; border-radius:8px; min-width: 220px; }
.toolbar select { padding:0.5rem 0.6rem; border:1px solid #cbd5e1; border-radius:8px; min-width: 220px; background:#fff; }
.btn-secondary { background:#64748b; color:#fff; }
.btn-secondary:hover { background:#475569; }
.btn-outline { background:#fff; color:#1f2937; border:1px solid #cbd5e1; }
.btn-outline:hover { background:#f1f5f9; }
.toolbar-right { display:flex; gap:0.5rem; flex-wrap:nowrap; align-items:center; white-space:nowrap; }
.weights-panel { display:none; background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:1rem; width:100%; margin:0 0 1rem 0; }
.weights-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:0.8rem; }
.weight-item { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:0.75rem; }
.weight-item label { font-weight:600; font-size:0.9rem; color:#334155; display:block; margin-bottom:0.35rem; }
.weight-item input[type="range"] { width:100%; }
.weight-value { font-size:0.85rem; color:#475569; }
.weights-total { text-align:right; font-weight:700; margin-top:0.5rem; color:#111827; }
.criteria-meta { font-size:0.8rem; color:#475569; margin-top:0.25rem; display:flex; gap:0.4rem; align-items:center; }
.status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
.dot-green { background:#22c55e; }
.dot-orange { background:#f59e0b; }
.dot-red { background:#ef4444; }
.result-grid { display:grid; grid-template-columns: 1fr; gap:1rem; }
.card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.card h3 { margin:0 0 0.6rem 0; font-size:1rem; color:#1f2937; }
.breakdown-table { width:100%; border-collapse:collapse; }
.breakdown-table th, .breakdown-table td { padding:0.4rem; border-bottom:1px solid #e5e7eb; text-align:left; font-size:0.86rem; }
.breakdown-table th { color:#374151; font-weight:700; }
.suggestions li { margin-left:1.2rem; list-style:disc; margin-bottom:0.35rem; }
/* Table + FAB + Modal */
.table-section { width: 100%; max-width: none; margin: 0 0 1rem 0; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:1rem; }
.table-section h2 { margin:0 0 0.75rem 0; font-size:1.1rem; color:#111827; }
table.eval-table { width:100%; border-collapse:collapse; }
table.eval-table th, table.eval-table td { text-align:left; padding:0.6rem 0.5rem; border-bottom:1px solid #e5e7eb; font-size:0.92rem; }
table.eval-table th { color:#374151; font-weight:700; }
.fab { position:fixed; right:24px; bottom:24px; width:56px; height:56px; border-radius:50%; background:#3498db; color:#fff; border:none; box-shadow:0 8px 16px rgba(0,0,0,0.2); font-size:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.fab:hover { background:#2c81ba; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
.modal.show { display: flex; }
.modal-content { background-color: white; border-radius: 10px; padding: 1.25rem; max-width: 1100px; width: 95%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.modal-header h5 { margin: 0; }
.close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
.close-btn:hover { color: #333; }

/* Fit fields within modal view */
.modal .section { max-width: none; margin-left: 0; margin-right: 0; padding: 0.8rem 1rem; }
.modal .toolbar { margin: 0 0 0.6rem 0; }
.modal .criteria-list { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 0.6rem; }
.modal .criteria-item input[type="number"] { width: calc(50% - 4px); }
@media (max-width: 1200px){ .modal .criteria-list { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
@media (max-width: 900px){ .modal .criteria-list { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.modal .criteria-item { padding: 0.5rem; }
.modal .criteria-item input[type="number"] { width: calc(50% - 6px); display: inline-block; }
.modal .criteria-meta { margin-top: 0.15rem; font-size: 0.75rem; }
.section-title {
	font-size: 1.05rem;
	font-weight: 700;
	text-transform: uppercase;
	letter-spacing: .5px;
	margin-bottom: 1.2rem;
	color: var(--info-color);
	display: flex; align-items: center; gap: 0.6rem;
}
.criteria-list {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 1.2rem 2rem;
	margin-bottom: 1.2rem;
}
.criteria-item {
	background: #f8f9fa;
	border-radius: 10px;
	padding: 1rem 0.8rem;
	box-shadow: 0 1px 4px rgba(44,62,80,0.04);
	display: flex; flex-direction: column; align-items: flex-start;
}
.criteria-item label {
	font-size: 0.98rem;
	font-weight: 600;
	color: var(--primary-color);
	margin-bottom: 0.3rem;
	display: flex; align-items: center; gap: 0.5rem;
}
.criteria-item input {
	width: 100%;
	padding: 0.45rem 0.6rem;
	font-size: 1rem;
	border: 1px solid #cbd5e1;
	border-radius: 6px;
	background: #fff;
	margin-bottom: 0.2rem;
}
.btn {
	border: none;
	border-radius: 8px;
	padding: 0.7rem 1.2rem;
	font-size: 1.05rem;
	font-weight: 700;
	cursor: pointer;
	display: inline-flex; align-items: center; gap: 0.6rem;
	letter-spacing: .5px;
	background: var(--info-color);
	color: #fff;
	transition: .2s;
	box-shadow: 0 2px 8px rgba(44,62,80,0.08);
}
.btn-primary { background: var(--success-color); color: #fff; }
.btn-primary:hover { background: #218c4f; }
.result-box {
	background: #f8f9fa;
	border-radius: 12px;
	padding: 1.5rem;
	margin-top: 1.5rem;
	box-shadow: 0 2px 12px rgba(44,62,80,0.08);
	text-align: center;
}
.result-grade {
	font-size: 2.2rem;
	font-weight: 800;
	color: var(--success-color);
	margin-bottom: 0.5rem;
	display: block;
}
.result-label {
	font-size: 1.2rem;
	font-weight: 700;
	margin-bottom: 0.5rem;
}
.progress-bar {
	width: 100%;
	height: 18px;
	background: #e2e8f0;
	border-radius: 10px;
	overflow: hidden;
	margin: 1.2rem 0 0.7rem 0;
	box-shadow: 0 1px 4px rgba(44,62,80,0.04);
}
.progress-fill {
	height: 100%;
	background: linear-gradient(90deg, var(--success-color), var(--info-color));
	transition: width 0.3s ease;
}
.grade-badge {
	display: inline-block;
	padding: 0.4rem 1.2rem;
	border-radius: 20px;
	font-size: 1.1rem;
	font-weight: 700;
	color: #fff;
	background: var(--success-color);
	margin-top: 0.7rem;
}
.grade-badge.green { background: var(--success-color); }
.grade-badge.blue { background: var(--info-color); }
.grade-badge.orange { background: var(--warning-color); }
.grade-badge.red { background: var(--accent-color); }
@media (max-width: 700px) {
	.section { padding: 1rem 0.5rem; }
	.criteria-list { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="app-container">
	<nav class="sidebar menu-loading" id="sidebar">
		<div class="logo"><h2>Dreamex Datalab</h2></div>
		<ul class="menu" id="roleBasedMenu">
			<li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
			<li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
				<li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
					<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
					<ul class="submenu">
					<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
					<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
					<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
					</ul>
				</li>
			<!-- Risk Management (separate section) -->
			<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
				<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
				<ul class="submenu">
					<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
					<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
					<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
					<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
					<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
					<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
					<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
					<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
					<li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
					<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
					<li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
					<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
					<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
					<li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html" class="active">Security Level Evaluation</a></li>
						<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
					<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
					<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
					<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
					<li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
					<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="project_management_section">
				<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
				<ul class="submenu">
					<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
					<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
					<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
					<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
				<a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
				<ul class="submenu">
					<li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
					<li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
					<li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
					<li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
				</ul>
			</li>
			<li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
			<li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
					<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
					<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
					<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
					<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
					<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
					<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
					<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
					<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
					<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
	</nav>
	<main class="main-content" id="mainContent">
		<nav class="top-nav">
			<div class="top-nav-left">
				<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
				<div class="company-branding">
					<img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo" />
					<span id="headerCompanyName"></span>
				</div>
			</div>
			<div class="top-nav-right">
				<div class="notifications">
					<button id="notificationBtn" class="notification-btn">
						<i class="fas fa-bell"></i>
						<span class="notification-badge">0</span>
					</button>
					<div class="notification-dropdown">
						<div class="notification-header">
							<h3>Notifications</h3>
							<button class="mark-all-read">Mark all as read</button>
						</div>
						<div class="notification-list"></div>
						<div class="notification-empty">
							<i class="fas fa-inbox"></i>
							<div class="notification-empty-title">No notifications</div>
							<div class="notification-empty-message">You're all caught up</div>
						</div>
					</div>
				</div>
				<div class="user-profile" style="position:relative;">
					<button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
					<div class="profile-dropdown"><ul></ul></div>
				</div>
			</div>
		</nav>
		<div class="page-header">
			<h1><i class="fas fa-shield-alt"></i> Security Level Evaluation</h1>
		</div>
		<!-- toolbar moved into modal -->
		<!-- Evaluations list section -->
		<section class="table-section" id="evalListSection">
			<h2><i class="fas fa-table"></i> Saved Evaluations</h2>
			<table class="eval-table" id="evalTable">
				<thead>
					<tr>
						<th>Date</th>
						<th>Site</th>
						<th>Score</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					<tr><td colspan="4">No evaluations yet.</td></tr>
				</tbody>
			</table>
		</section>

		<!-- Modal -->
			<div class="modal" id="evalModal">
				<div class="modal-content">
					<div class="modal-header">
						<h5><i class="fas fa-clipboard-list"></i> Site Security Evaluation Criteria</h5>
						<button class="close-btn" id="closeModal" aria-label="Close">&times;</button>
					</div>
					<div class="modal-body">
			<div class="toolbar">
				<div class="toolbar-left">
					<select id="siteSelect">
						<option value="">Select area...</option>
						<option value="__other__">Other (enter name)</option>
					</select>
					<button id="toggleWeights" class="btn btn-outline" type="button"><i class="fas fa-sliders-h"></i> Customize Weights</button>
				</div>
					<!-- actions moved to modal footer to match position details modal -->
			</div>

			<div id="weightsPanel" class="weights-panel">
				<div class="weights-grid" id="weightsGrid"></div>
				<div class="weights-total">Total: <span id="weightsTotal">100</span>%</div>
			</div>
		<section class="section">
			<div class="section-title"><i class="fas fa-shield-alt"></i> Site Security Evaluation Criteria</div>
			<form id="securityForm">
				<div class="criteria-list">
					<div class="criteria-item">
						<label><i class="fas fa-video"></i> Cameras (Active / Total)</label>
						<input type="number" id="activeCameras" placeholder="Active Cameras" min="0" required />
						<input type="number" id="totalCameras" placeholder="Total Cameras" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_cameras">0%</span> <span id="dot_cameras" class="status-dot dot-red"></span></div>
					</div>
					<div class="criteria-item">
						<label><i class="fas fa-user-shield"></i> Agent Posts (Secure / Total)</label>
						<input type="number" id="securePosts" placeholder="Secure Posts" min="0" required />
						<input type="number" id="totalPosts" placeholder="Total Posts" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_posts">0%</span> <span id="dot_posts" class="status-dot dot-red"></span></div>
					</div>
					<div class="criteria-item">
						<label><i class="fas fa-door-closed"></i> ACP Devices (Active / Total)</label>
						<input type="number" id="activeACP" placeholder="Active ACP Devices" min="0" required />
						<input type="number" id="totalACP" placeholder="Total ACP Devices" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_acp">0%</span> <span id="dot_acp" class="status-dot dot-red"></span></div>
					</div>
					<div class="criteria-item">
						<label><i class="fas fa-broadcast-tower"></i> Perimeter Sensors (Active / Total)</label>
						<input type="number" id="activeSensors" placeholder="Active Sensors" min="0" required />
						<input type="number" id="totalSensors" placeholder="Total Sensors" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_sensors">0%</span> <span id="dot_sensors" class="status-dot dot-red"></span></div>
					</div>
					<div class="criteria-item">
						<label><i class="fas fa-user-check"></i> Visitors (Registered / Total)</label>
						<input type="number" id="registeredVisitors" placeholder="Registered Visitors" min="0" required />
						<input type="number" id="totalVisitors" placeholder="Total Visitors" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_visitors">0%</span> <span id="dot_visitors" class="status-dot dot-red"></span></div>
					</div>
					<div class="criteria-item">
						<label><i class="fas fa-key"></i> Keys (Accounted / Total)</label>
						<input type="number" id="accountedKeys" placeholder="Accounted Keys" min="0" required />
						<input type="number" id="totalKeys" placeholder="Total Keys" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_keys">0%</span> <span id="dot_keys" class="status-dot dot-red"></span></div>
					</div>
					<div class="criteria-item">
						<label><i class="fas fa-battery-full"></i> Power Backup (Available / Total)</label>
						<input type="number" id="availablePower" placeholder="Available Power Backup" min="0" required />
						<input type="number" id="totalPower" placeholder="Total Power Backup Units" min="1" required />
						<div class="criteria-meta">Rate: <span id="rate_power">0%</span> <span id="dot_power" class="status-dot dot-red"></span></div>
					</div>
				</div>
				<button type="submit" class="btn btn-primary" style="display:none;"><i class="fas fa-chart-line"></i> Evaluate Security Level</button>
			</form>
			<div id="result" class="result-box" style="display:none;"></div>
		</section>

			<section class="result-grid" id="insights" style="display:none;">
					<div class="card">
						<h3><i class="fas fa-chart-radar"></i> Score Profile</h3>
						<canvas id="scoreChart" height="110"></canvas>
					</div>
			<div class="card">
				<h3><i class="fas fa-list-check"></i> Breakdown</h3>
				<table class="breakdown-table" id="breakdownTable">
					<thead><tr><th>Criterion</th><th>Rate</th><th>Weight</th><th>Contribution</th></tr></thead>
					<tbody></tbody>
				</table>
			</div>
			<div class="card">
				<h3><i class="fas fa-lightbulb"></i> Recommendations</h3>
				<ul class="suggestions" id="suggestions"></ul>
			</div>
			</section>
					</div>
					<div class="modal-footer">
						<button id="evaluateBtn" class="btn btn-primary" type="button" title="Evaluate"><i class="fas fa-chart-line"></i></button>
						<button id="saveEval" class="btn btn-secondary" type="button" title="Save"><i class="fas fa-save"></i></button>
						<button id="exportCsv" class="btn btn-secondary" type="button" title="Export CSV"><i class="fas fa-file-export"></i></button>
						<button id="printEval" class="btn btn-secondary" type="button" title="Print"><i class="fas fa-print"></i></button>
						<button id="loadHistory" class="btn btn-secondary" type="button" title="History"><i class="fas fa-history"></i></button>
					</div>
				</div>
			</div>

		<!-- Floating Add Button -->
		<button class="fab" id="openModal" title="Add Evaluation">+</button>
	</main>
</div>
<script>
// FontAwesome icons (standalone)
(function(){var link=document.createElement('link');link.rel='stylesheet';link.href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';document.head.appendChild(link);})();

// Firebase configuration (same project as other pages)
const firebaseConfig = {
	apiKey: "AIzaSyCJxisIn1DERr9VxH5mKTyYQpWkVBDTl7w",
	authDomain: "users-8be65.firebaseapp.com",
	databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
	projectId: "users-8be65",
	storageBucket: "users-8be65.firebasestorage.app",
	messagingSenderId: "909025468149",
	appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
	measurementId: "G-XHFMRCJQEZ"
};

function initializeFirebase() {
	if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
		window.firebase.initializeApp(firebaseConfig);
		console.log('? Firebase v8 initialized for seclevel.html');
	}
	return window.firebase;
}

const firebase = initializeFirebase();

const DEFAULT_WEIGHTS = {
	cameras: 18, posts: 16, acp: 14, sensors: 14, visitors: 10, keys: 14, power: 14
};

function getWeights(companyId){
	try{
		const raw = localStorage.getItem(`seclevel_weights_${companyId||'global'}`);
		const obj = raw? JSON.parse(raw) : DEFAULT_WEIGHTS;
		return normalizeWeights(obj);
	}catch{return normalizeWeights(DEFAULT_WEIGHTS);}    
}
function saveWeights(companyId, weights){
	localStorage.setItem(`seclevel_weights_${companyId||'global'}` , JSON.stringify(weights));
}
function normalizeWeights(w){
	const sum = Object.values(w).reduce((a,b)=>a+Number(b||0),0) || 1;
	const norm = {}; Object.keys(w).forEach(k=> norm[k] = (Number(w[k]||0)/sum));
	norm.__sum = 1; return norm;
}
function calculateSecurityLevel(data, weights){
	const capped = v => Math.max(0, Math.min(1, v));
	const score = (
		capped(data.activeCameras/data.totalCameras) * weights.cameras +
		capped(data.securePosts/data.totalPosts) * weights.posts +
		capped(data.activeACP/data.totalACP) * weights.acp +
		capped(data.activeSensors/data.totalSensors) * weights.sensors +
		capped(data.registeredVisitors/data.totalVisitors) * weights.visitors +
		capped(data.accountedKeys/data.totalKeys) * weights.keys +
		capped(data.availablePower/data.totalPower) * weights.power
	);
	return Math.round(score * 100);
}

function getGrade(score) {
	if(score >= 90) return {grade:'A+ (Excellent)', color:'green'};
	if(score >= 80) return {grade:'A (Very Good)', color:'green'};
	if(score >= 70) return {grade:'B (Good)', color:'blue'};
	if(score >= 60) return {grade:'C (Fair)', color:'orange'};
	if(score >= 50) return {grade:'D (Poor)', color:'red'};
	return {grade:'F (Critical)', color:'red'};
}

document.getElementById('securityForm').onsubmit = async function(e) {
	e.preventDefault();
	const data = {
		activeCameras: Number(document.getElementById('activeCameras').value),
		totalCameras: Number(document.getElementById('totalCameras').value),
		securePosts: Number(document.getElementById('securePosts').value),
		totalPosts: Number(document.getElementById('totalPosts').value),
		activeACP: Number(document.getElementById('activeACP').value),
		totalACP: Number(document.getElementById('totalACP').value),
		activeSensors: Number(document.getElementById('activeSensors').value),
		totalSensors: Number(document.getElementById('totalSensors').value),
		registeredVisitors: Number(document.getElementById('registeredVisitors').value),
		totalVisitors: Number(document.getElementById('totalVisitors').value),
		accountedKeys: Number(document.getElementById('accountedKeys').value),
		totalKeys: Number(document.getElementById('totalKeys').value),
		availablePower: Number(document.getElementById('availablePower').value),
		totalPower: Number(document.getElementById('totalPower').value)
	};
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	const weights = getWeights(companyId);
	const score = calculateSecurityLevel(data, weights);
	const grade = getGrade(score);
	document.getElementById('result').style.display = 'block';
	document.getElementById('result').innerHTML = `
		<div class='result-label'>Security Level Score</div>
		<div class='result-grade'>${score}%</div>
		<div class='progress-bar'><div class='progress-fill' style='width:${score}%;'></div></div>
		<div class='grade-badge ${grade.color}'>${grade.grade}</div>
	`;
	updateInsights(data, weights, score);
	// Auto-save evaluation and refresh table
	try { await saveEvaluation(); } catch(err) { console.error('Auto-save failed', err); }
};

function setRate(idPair, value){
	const pct = isFinite(value) && value>=0? Math.max(0,Math.min(1,value))*100 : 0;
	const span = document.getElementById(`rate_${idPair}`);
	const dot = document.getElementById(`dot_${idPair}`);
	if(span) span.textContent = `${pct.toFixed(0)}%`;
	if(dot){ dot.classList.remove('dot-green','dot-orange','dot-red'); if(pct>=85) dot.classList.add('dot-green'); else if(pct>=60) dot.classList.add('dot-orange'); else dot.classList.add('dot-red'); }
}
function liveUpdate(){
	const n = id=> Number(document.getElementById(id).value);
	setRate('cameras', n('activeCameras')/n('totalCameras'));
	setRate('posts', n('securePosts')/n('totalPosts'));
	setRate('acp', n('activeACP')/n('totalACP'));
	setRate('sensors', n('activeSensors')/n('totalSensors'));
	setRate('visitors', n('registeredVisitors')/n('totalVisitors'));
	setRate('keys', n('accountedKeys')/n('totalKeys'));
	setRate('power', n('availablePower')/n('totalPower'));
}
['activeCameras','totalCameras','securePosts','totalPosts','activeACP','totalACP','activeSensors','totalSensors','registeredVisitors','totalVisitors','accountedKeys','totalKeys','availablePower','totalPower']
	.forEach(id=> document.getElementById(id).addEventListener('input', liveUpdate));

let chart;
function updateInsights(data, weights, score){
	const capped = v=> Math.max(0, Math.min(1,v));
	const labels = ['Cameras','Posts','ACP','Sensors','Visitors','Keys','Power'];
	const values = [
		capped(data.activeCameras/data.totalCameras),
		capped(data.securePosts/data.totalPosts),
		capped(data.activeACP/data.totalACP),
		capped(data.activeSensors/data.totalSensors),
		capped(data.registeredVisitors/data.totalVisitors),
		capped(data.accountedKeys/data.totalKeys),
		capped(data.availablePower/data.totalPower)
	].map(v=> Math.round(v*100));
	const weightPct = [weights.cameras,weights.posts,weights.acp,weights.sensors,weights.visitors,weights.keys,weights.power].map(w=> Math.round((w||0)*100));
	const contrib = values.map((v,i)=> (v/100)*(weightPct[i]/100));

	const ctx = document.getElementById('scoreChart').getContext('2d');
	if(chart) chart.destroy();
	chart = new Chart(ctx, {
		type: 'radar',
		data: { labels, datasets: [
			{ label:'Rates', data: values, backgroundColor:'rgba(52,152,219,0.2)', borderColor:'#3498db' },
			{ label:'Weights (%)', data: weightPct, backgroundColor:'rgba(39,174,96,0.2)', borderColor:'#27ae60' }
		] },
		options: { scales: { r: { suggestedMin:0, suggestedMax:100 } }, plugins:{ legend:{ position:'bottom' } } }
	});

	const tbody = document.querySelector('#breakdownTable tbody');
	tbody.innerHTML = '';
	labels.forEach((label, i)=>{
		const tr = document.createElement('tr');
		tr.innerHTML = `<td>${label}</td><td>${values[i]}%</td><td>${weightPct[i]}%</td><td>${(contrib[i]*100).toFixed(1)}%</td>`;
		tbody.appendChild(tr);
	});

	const sugg = document.getElementById('suggestions');
	sugg.innerHTML = '';
	labels.forEach((label,i)=>{
		if(values[i] < 70){
			const li = document.createElement('li');
			li.textContent = `${label}: raise performance above 85% to meet best-practice threshold.`;
			sugg.appendChild(li);
		}
	});
	if(!sugg.children.length){
		const li = document.createElement('li'); li.textContent = 'All criteria meet or exceed recommended benchmarks.'; sugg.appendChild(li);
	}
	document.getElementById('insights').style.display = 'grid';
}

function buildWeightsUI(companyId){
	const raw = localStorage.getItem(`seclevel_weights_${companyId||'global'}`);
	const current = raw? JSON.parse(raw) : DEFAULT_WEIGHTS;
	const grid = document.getElementById('weightsGrid');
	grid.innerHTML = '';
	const items = [
		['cameras','Cameras'],['posts','Agent Posts'],['acp','ACP Devices'],['sensors','Perimeter Sensors'],['visitors','Visitors'],['keys','Keys'],['power','Power Backup']
	];
	items.forEach(([key,label])=>{
		const val = Number(current[key]||0);
		const wrap = document.createElement('div'); wrap.className='weight-item';
		wrap.innerHTML = `
			<label>${label}</label>
			<input type="range" min="0" max="40" step="1" value="${val}" data-key="${key}" />
			<div class="weight-value">Weight: <span id="w_${key}">${val}</span>%</div>`;
		grid.appendChild(wrap);
	});
	const updateTotal = ()=>{
		const sliders = grid.querySelectorAll('input[type="range"]');
		const w = {}; let total=0;
		sliders.forEach(sl=>{ const k=sl.dataset.key; const v=Number(sl.value); w[k]=v; total += v; document.getElementById(`w_${k}`).textContent = v; });
		document.getElementById('weightsTotal').textContent = total;
		saveWeights(companyId, w);
	};
	grid.querySelectorAll('input[type="range"]').forEach(sl=> sl.addEventListener('input', updateTotal));
	updateTotal();
}

async function saveEvaluation(){
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	console.log('Attempting to save evaluation for company:', companyId);
	
	if(!companyId){ 
		alert('Cannot determine company to save evaluation. Please ensure you are logged in.'); 
		return; 
	}
	
	const n = id=> Number(document.getElementById(id).value);
	const siteSelect = document.getElementById('siteSelect');
	const selectedSiteId = siteSelect ? siteSelect.value : '';
	let siteName = null;
	if(selectedSiteId === '__other__'){
		const entered = window.prompt('Enter custom site/area name:','');
		siteName = (entered||'').trim() || null;
	} else if(selectedSiteId){
		try{ siteName = siteSelect.options[siteSelect.selectedIndex].text || null; }catch(e){ siteName = null; }
	}
	
	// Collect input data
	const inputs = {
		activeCameras:n('activeCameras'), totalCameras:n('totalCameras'),
		securePosts:n('securePosts'), totalPosts:n('totalPosts'),
		activeACP:n('activeACP'), totalACP:n('totalACP'),
		activeSensors:n('activeSensors'), totalSensors:n('totalSensors'),
		registeredVisitors:n('registeredVisitors'), totalVisitors:n('totalVisitors'),
		accountedKeys:n('accountedKeys'), totalKeys:n('totalKeys'),
		availablePower:n('availablePower'), totalPower:n('totalPower')
	};
	
	// Calculate score if not already calculated
	const weights = getWeights(companyId);
	const score = calculateSecurityLevel(inputs, weights);
	
	const data = {
		siteId: selectedSiteId && selectedSiteId !== '__other__' ? selectedSiteId : null,
		siteName,
		inputs,
		weights: JSON.parse(localStorage.getItem(`seclevel_weights_${companyId||'global'}`) || JSON.stringify(DEFAULT_WEIGHTS)),
		score,
		createdAt: Date.now()
	};
	
	console.log('Saving evaluation data:', data);
	
	try{
		const ref = firebase.database().ref(`companies/${companyId}/securityLevelEvaluations`).push();
		await ref.set(data);
		console.log('Evaluation saved successfully');
		alert('Evaluation saved successfully!');
	}catch(err){ 
		console.error('Save error details:', err); 
		alert(`Failed to save evaluation: ${err.message || err}`); 
	}
}

async function loadHistoryList(){
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	if(!companyId){ alert('No company context.'); return; }
	try{
		const snap = await firebase.database().ref(`companies/${companyId}/securityLevelEvaluations`).orderByChild('createdAt').limitToLast(10).once('value');
		if(!snap.exists()){ alert('No saved evaluations yet.'); return; }
		const list = Object.entries(snap.val()).sort((a,b)=>a[1].createdAt-b[1].createdAt);
		const names = list.map(([key,v],i)=> `${new Date(v.createdAt).toLocaleString()} - ${v.siteName||'Unnamed'} - ${v.score}%`);
		alert('Recent evaluations:\n\n' + names.map((n,i)=> `${i+1}. ${n}`).join('\n'));
	}catch(err){ console.error(err); alert('Failed to load history.'); }
}

function exportCsv(){
	const headers = ['Criterion','Active/Registered','Total','Rate (%)'];
	const rows = [];
	const add = (label, aId, tId)=>{
		const a = Number(document.getElementById(aId).value||0);
		const t = Number(document.getElementById(tId).value||0);
		const r = t>0? ((a/t)*100).toFixed(0) : '0';
		rows.push([label, a, t, r]);
	};
	add('Cameras','activeCameras','totalCameras');
	add('Agent Posts','securePosts','totalPosts');
	add('ACP Devices','activeACP','totalACP');
	add('Perimeter Sensors','activeSensors','totalSensors');
	add('Visitors','registeredVisitors','totalVisitors');
	add('Keys','accountedKeys','totalKeys');
	add('Power Backup','availablePower','totalPower');
	const score = document.querySelector('.result-grade')?.textContent || '';
	let csv = headers.join(',') + '\n' + rows.map(r=> r.join(',')).join('\n');
	csv += `\nOverall Score,${score}`;
	const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
	const url = URL.createObjectURL(blob);
	const a = document.createElement('a'); a.href = url; a.download = `security-evaluation-${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
}

document.getElementById('toggleWeights').addEventListener('click', ()=>{
	const p = document.getElementById('weightsPanel');
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	if(p.style.display==='block'){ p.style.display='none'; } else { buildWeightsUI(companyId); p.style.display='block'; }
});
document.getElementById('evaluateBtn').addEventListener('click', ()=>{
	document.getElementById('securityForm').dispatchEvent(new Event('submit'));
});
document.getElementById('saveEval').addEventListener('click', saveEvaluation);
document.getElementById('exportCsv').addEventListener('click', exportCsv);
document.getElementById('printEval').addEventListener('click', ()=> window.print());
document.getElementById('loadHistory').addEventListener('click', loadHistoryList);

// Modal logic
const modal = document.getElementById('evalModal');
const openBtn = document.getElementById('openModal');
const closeBtn = document.getElementById('closeModal');

function clearModalForm(){
	// Clear all input fields
	document.getElementById('activeCameras').value = '';
	document.getElementById('totalCameras').value = '';
	document.getElementById('securePosts').value = '';
	document.getElementById('totalPosts').value = '';
	document.getElementById('activeACP').value = '';
	document.getElementById('totalACP').value = '';
	document.getElementById('activeSensors').value = '';
	document.getElementById('totalSensors').value = '';
	document.getElementById('registeredVisitors').value = '';
	document.getElementById('totalVisitors').value = '';
	document.getElementById('accountedKeys').value = '';
	document.getElementById('totalKeys').value = '';
	document.getElementById('availablePower').value = '';
	document.getElementById('totalPower').value = '';
	
	// Reset site selection
	const siteSelect = document.getElementById('siteSelect');
	if(siteSelect) siteSelect.value = '';
	
	// Hide results and insights
	document.getElementById('result').style.display = 'none';
	document.getElementById('insights').style.display = 'none';
	
	// Reset live rates
	liveUpdate();
	
	// Hide weights panel
	document.getElementById('weightsPanel').style.display = 'none';
}

openBtn.addEventListener('click', ()=>{ 
	clearModalForm();
	modal.classList.add('show'); 
});
closeBtn.addEventListener('click', ()=>{ modal.classList.remove('show'); });
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

// Evaluations table rendering
async function fetchEvaluations(){
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	if(!companyId) return [];
	try{
		const snap = await firebase.database().ref(`companies/${companyId}/securityLevelEvaluations`).once('value');
		if(!snap.exists()) return [];
		return Object.entries(snap.val()).map(([id, v])=> ({ id, ...v })).sort((a,b)=> b.createdAt - a.createdAt);
	}catch(err){ console.error('fetchEvaluations error', err); return []; }
}

function renderTable(list){
	console.log('renderTable called with:', list);
	const tbody = document.querySelector('#evalTable tbody');
	if(!tbody) {
		console.error('Table tbody not found!');
		return;
	}
	tbody.innerHTML = '';
	if(!list.length){
		const tr = document.createElement('tr'); 
		tr.innerHTML = `<td colspan="4">No evaluations yet.</td>`; 
		tbody.appendChild(tr); 
		console.log('Showing empty table message');
		return;
	}
	list.forEach(item=>{
		const tr = document.createElement('tr');
		const dateStr = item.createdAt? new Date(item.createdAt).toLocaleString() : '';
		tr.innerHTML = `
			<td>${dateStr}</td>
			<td>${item.siteName || ''}</td>
			<td>${item.score != null ? item.score + '%' : ''}</td>
			<td>
				<button class="btn btn-outline" data-action="view" data-id="${item.id}"><i class="fas fa-eye"></i></button>
			</td>`;
		tbody.appendChild(tr);
		console.log('Added row for evaluation:', item.id, item.siteName, item.score);
	});
	tbody.querySelectorAll('button[data-action="view"]').forEach(btn=> btn.addEventListener('click', ()=> openForView(btn.dataset.id)));
	console.log('Table rendered with', list.length, 'rows');
}

async function openForView(id){
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	if(!companyId) return;
	try{
		const snap = await firebase.database().ref(`companies/${companyId}/securityLevelEvaluations/${id}`).once('value');
		if(!snap.exists()) return;
		const v = snap.val();
		// Ensure sites are loaded then set selection
		await loadSitesForCompany(companyId);
		const siteSelect = document.getElementById('siteSelect');
		if(v.siteId && siteSelect){
			siteSelect.value = v.siteId;
		} else if(siteSelect) {
			siteSelect.value = '';
		}
		// No siteName input; nothing to set for custom label during view
		const set = (id,val)=>{ const el = document.getElementById(id); if(el){ el.value = Number(val)||0; } };
		set('activeCameras', v.inputs?.activeCameras); set('totalCameras', v.inputs?.totalCameras);
		set('securePosts', v.inputs?.securePosts); set('totalPosts', v.inputs?.totalPosts);
		set('activeACP', v.inputs?.activeACP); set('totalACP', v.inputs?.totalACP);
		set('activeSensors', v.inputs?.activeSensors); set('totalSensors', v.inputs?.totalSensors);
		set('registeredVisitors', v.inputs?.registeredVisitors); set('totalVisitors', v.inputs?.totalVisitors);
		set('accountedKeys', v.inputs?.accountedKeys); set('totalKeys', v.inputs?.totalKeys);
		set('availablePower', v.inputs?.availablePower); set('totalPower', v.inputs?.totalPower);
		liveUpdate();
		const weights = normalizeWeights(v.weights || DEFAULT_WEIGHTS);
		// show results
		const score = calculateSecurityLevel({
			activeCameras: v.inputs?.activeCameras, totalCameras: v.inputs?.totalCameras,
			securePosts: v.inputs?.securePosts, totalPosts: v.inputs?.totalPosts,
			activeACP: v.inputs?.activeACP, totalACP: v.inputs?.totalACP,
			activeSensors: v.inputs?.activeSensors, totalSensors: v.inputs?.totalSensors,
			registeredVisitors: v.inputs?.registeredVisitors, totalVisitors: v.inputs?.totalVisitors,
			accountedKeys: v.inputs?.accountedKeys, totalKeys: v.inputs?.totalKeys,
			availablePower: v.inputs?.availablePower, totalPower: v.inputs?.totalPower
		}, weights);
		const grade = getGrade(score);
		const res = document.getElementById('result');
		res.style.display='block';
		res.innerHTML = `
			<div class='result-label'>Security Level Score</div>
			<div class='result-grade'>${score}%</div>
			<div class='progress-bar'><div class='progress-fill' style='width:${score}%;'></div></div>
			<div class='grade-badge ${grade.color}'>${grade.grade}</div>`;
		updateInsights(v.inputs, weights, score);
		modal.classList.add('show');
	}catch(err){ console.error(err); }
}

async function refreshTable(){
	const list = await fetchEvaluations();
	renderTable(list);
}

let realtimeListener = null;

function setupRealtimeListener(){
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	console.log('Setting up real-time listener for company:', companyId);
	if(!companyId) {
		console.warn('No company ID available for real-time listener');
		return;
	}
	
	// Remove existing listener if any
	if(realtimeListener) {
		realtimeListener.off();
		realtimeListener = null;
	}
	
	// Setup new real-time listener
	realtimeListener = firebase.database().ref(`companies/${companyId}/securityLevelEvaluations`);
	realtimeListener.on('value', (snapshot) => {
		console.log('Real-time data received:', snapshot.exists(), snapshot.val());
		if(!snapshot.exists()) {
			console.log('No evaluations found, showing empty table');
			renderTable([]);
			return;
		}
		const data = snapshot.val();
		const list = Object.entries(data).map(([id, v]) => ({ id, ...v })).sort((a,b) => b.createdAt - a.createdAt);
		console.log('Rendering table with', list.length, 'evaluations:', list);
		renderTable(list);
	});
}

document.addEventListener('DOMContentLoaded', () => {
	console.log('DOM loaded, initializing table and real-time listener');
	// Initial load and setup real-time updates
	refreshTable();
	setupRealtimeListener();
	
	// Also ensure auth manager is available
	if(window.authManager) {
		console.log('Auth manager available:', window.authManager.currentUser?.companyId || window.authManager.currentCompany?.companyId);
	} else {
		console.warn('Auth manager not available yet');
		// Try again after a short delay
		setTimeout(() => {
			console.log('Retrying real-time listener setup');
			setupRealtimeListener();
		}, 1000);
	}
});

// After save, refresh the table and keep modal open
const _origSave = saveEvaluation;
saveEvaluation = async function(){
	await _origSave();
	// No need to manually refresh since real-time listener handles it
};

// Load sites into dropdown
async function loadSitesForCompany(companyId){
	const siteSelect = document.getElementById('siteSelect');
	if(!siteSelect || !companyId) return;
	// If already loaded (more than 2 options), skip
	if(siteSelect.options.length > 2) return;
	const addOptions = (sitesMap)=>{
		const frag = document.createDocumentFragment();
		if(Array.isArray(sitesMap)){
			sitesMap.forEach((item, idx)=>{
				if(item && typeof item === 'object'){
					if(item.enabled === false) return;
					const txt = item.label || item.name || item.siteName || item.title || item.value || `Area ${idx+1}`;
					const val = item.value || String(idx);
					const opt = document.createElement('option'); opt.value = val; opt.textContent = txt; frag.appendChild(opt);
				} else if(typeof item === 'string'){
					const opt = document.createElement('option'); opt.value = item; opt.textContent = item; frag.appendChild(opt);
				}
			});
		} else {
			Object.entries(sitesMap).forEach(([id, site])=>{
				if(site && typeof site === 'object' && ('label' in site || 'value' in site)){
					if(site.enabled === false) return;
					const txt = site.label || site.name || site.siteName || site.title || site.value || id;
					const val = site.value || id;
					const opt = document.createElement('option'); opt.value = val; opt.textContent = txt; frag.appendChild(opt);
				} else {
					const name = typeof site === 'string' ? site : (site?.name || site?.siteName || site?.title || id);
					if(!name) return;
					const opt = document.createElement('option'); opt.value = id; opt.textContent = name; frag.appendChild(opt);
				}
			});
		}
		// Insert after the first placeholder option
		const other = siteSelect.querySelector('option[value="__other__"]');
		// Remove and re-add placeholder/other to keep order
		const placeholder = siteSelect.querySelector('option[value=""]');
		siteSelect.innerHTML = '';
		if(placeholder){ siteSelect.appendChild(placeholder); } else { const p = document.createElement('option'); p.value=''; p.textContent='Select area...'; siteSelect.appendChild(p); }
		siteSelect.appendChild(frag);
		if(other){ siteSelect.appendChild(other); } else { const o = document.createElement('option'); o.value='__other__'; o.textContent='Other (enter name)'; siteSelect.appendChild(o); }
	};
	try{
		const db = firebase.database();
		// 1) Try Form Field Config: fieldOptions/area
		let snap = await db.ref(`companies/${companyId}/fieldOptions/area`).once('value');
		if(snap.exists()){
			const val = snap.val();
			addOptions(val);
			return;
		}
		// 2) Try settings/fieldOptions/area
		snap = await db.ref(`companies/${companyId}/settings/fieldOptions/area`).once('value');
		if(snap.exists()){
			const val = snap.val(); addOptions(val); return;
		}
		// 3) Legacy fallbacks
		snap = await db.ref(`companies/${companyId}/sites`).once('value');
		if(snap.exists()){
			const val = snap.val();
			const map = Array.isArray(val) ? Object.fromEntries(val.map((n,i)=>[String(i), n])) : val;
			addOptions(map);
			return;
		}
		// Fallbacks
		snap = await db.ref(`companies/${companyId}/locations`).once('value');
		if(snap.exists()){
			const map = snap.val(); addOptions(map); return;
		}
		snap = await db.ref(`companies/${companyId}/facilities`).once('value');
		if(snap.exists()){
			const map = snap.val(); addOptions(map); return;
		}
	}catch(err){ console.error('loadSitesForCompany error', err); }
}

// No siteName input; selection handled on save

// Ensure sites load when opening modal
openBtn.addEventListener('click', async ()=>{
	const companyId = window.authManager?.currentUser?.companyId || window.authManager?.currentCompany?.companyId || null;
	await loadSitesForCompany(companyId);
});

// ===== FEATURE-BASED MENU AUTHORIZATION (from project-list.html) =====
let isMenuUpdateInProgress = false;
function resetMenuVisibility(){
	document.querySelectorAll('[data-feature]').forEach(el=>el.classList.remove('menu-visible'));
	document.querySelectorAll('.menu-dropdown').forEach(el=>el.classList.remove('menu-visible'));
}
function ensureHomeIsVisible(){
	const homeItem=document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
	if(homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
}
function showSidebarAfterAuth(){
	const sidebar=document.querySelector('.sidebar');
	if(sidebar) sidebar.classList.remove('menu-loading');
}
async function updateMenuWithFeatureAuthorization(){
	if(isMenuUpdateInProgress){ console.log('?? Menu update in progress'); return; }
	isMenuUpdateInProgress = true;
	console.log('?? Starting feature-based menu authorization for seclevel.html...');
	try{
		let currentUser=null, companyId=null, userRole=null;
		if(window.authManager && window.authManager.currentUser){
			currentUser = window.authManager.currentUser;
			companyId = currentUser.companyId;
			userRole = currentUser.role;
		} else if (firebase.auth().currentUser){
			currentUser = firebase.auth().currentUser;
		}
		if(!companyId && currentUser){
			const companiesSnap = await firebase.database().ref('companies').once('value');
			if(companiesSnap.exists()){
				const companies = companiesSnap.val();
				for(const [cid, comp] of Object.entries(companies)){
					if(comp.status!=='active') continue;
					if(comp.users && comp.users[currentUser.uid]){
						companyId = cid;
						userRole = comp.users[currentUser.uid].role || comp.users[currentUser.uid].userRole;
						break;
					}
				}
			}
		}
		if(!companyId){ resetMenuVisibility(); ensureHomeIsVisible(); showSidebarAfterAuth(); return; }
		const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
		if(userRole){ await applyRoleBasedFiltering(companyId, userRole, authorizedPages); }
	}catch(err){
		console.error('? Error updating menu authorization:', err);
		resetMenuVisibility(); ensureHomeIsVisible(); showSidebarAfterAuth();
	} finally { isMenuUpdateInProgress = false; }
}
async function applyFeatureBasedMenuVisibility(companyId){
	try{
		const db = firebase.database();
		const featuresSnap = await db.ref('/platformFeatures').once('value');
		if(!featuresSnap.exists()){ resetMenuVisibility(); ensureHomeIsVisible(); return []; }
		const features = featuresSnap.val();
		const companySnap = await db.ref(`/companies/${companyId}`).once('value');
		const company = companySnap.val();
		if(!company){ resetMenuVisibility(); ensureHomeIsVisible(); return []; }
		const subscribed = company.selectedFeatures || [];
		const authorizedPages = [];
		subscribed.forEach(fid=>{ const f=features[fid]; if(f && f.status==='active' && f.authorizedPages){ authorizedPages.push(...f.authorizedPages); } });
		resetMenuVisibility();
		const authorizedFeatures = new Set();
		authorizedPages.forEach(p=>{ if(p.feature) authorizedFeatures.add(p.feature); });
		document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(item=>{
			const feat = item.getAttribute('data-feature');
			const isDropdown = item.classList.contains('menu-dropdown');
			if(isDropdown) return;
			if(authorizedFeatures.has(feat)) item.classList.add('menu-visible');
		});
		document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{
			const feat = drop.getAttribute('data-feature');
			const hasChild = drop.querySelectorAll('.submenu li.menu-visible').length>0;
			if(hasChild || authorizedFeatures.has(feat)) drop.classList.add('menu-visible');
		});
		return authorizedPages;
	}catch(err){ console.error('Feature visibility error:', err); resetMenuVisibility(); ensureHomeIsVisible(); return []; }
}
async function applyRoleBasedFiltering(companyId, userRole){
	try{
		const db = firebase.database();
		const snap = await db.ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
		const permissions = snap.exists()? snap.val(): null;
		if(!permissions){ if(userRole==='administrator'){ showSidebarAfterAuth(); return; } hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
		filterMenuByPermissions(permissions);
	}catch(err){ console.error('Role filtering error:', err); showSidebarAfterAuth(); }
}
function hideItemsRequiringPermissions(){
	document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]').forEach(item=>item.classList.remove('menu-visible'));
	document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{
		if(drop.querySelectorAll('.submenu li.menu-visible').length===0) drop.classList.remove('menu-visible');
	});
	ensureHomeIsVisible();
}
function filterMenuByPermissions(permissions){
	const visible = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
	visible.forEach(item=>{
		const req = item.getAttribute('data-requires-permission');
		const allow = permissions[req]===true || (permissions[req] && permissions[req].view===true);
		if(!allow) item.classList.remove('menu-visible');
	});
	document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{
		const hasChild = drop.querySelectorAll('.submenu li.menu-visible').length>0;
		const req = drop.getAttribute('data-requires-permission');
		if(!hasChild){
			if(req){ const allow = permissions[req]===true || (permissions[req] && permissions[req].view===true); if(!allow) drop.classList.remove('menu-visible'); }
			else { drop.classList.remove('menu-visible'); }
		}
	});
	ensureHomeIsVisible();
	showSidebarAfterAuth();
}
function initializeMenuAuthorization(){
	const sidebar=document.querySelector('.sidebar');
	if(sidebar) sidebar.classList.add('menu-loading');
	setTimeout(()=>{ updateMenuWithFeatureAuthorization(); }, 400);
}
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
// ===== END FEATURE-BASED MENU AUTHORIZATION =====

// Minimal AuthManager to populate company branding in header
class AuthManagerMini {
	constructor(){ this.currentUser = this.getCurrentUser(); this.db = null; this.currentCompany = null; }
	getCurrentUser(){ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
	async initialize(){
		// Try to read currentCompany from localStorage (some pages store it)
		try { this.currentCompany = JSON.parse(localStorage.getItem('currentCompany')||'null'); } catch(e){ this.currentCompany = null; }
		this.updateCompanyBranding();
		await this.updateUIForAuthenticatedUser();
		this.bindProfileDropdown();
	}
	updateCompanyBranding(){
		const logoEl = document.getElementById('headerCompanyLogo');
		const nameEl = document.getElementById('headerCompanyName');
		if(!this.currentCompany){ if(logoEl) logoEl.style.display='none'; if(nameEl) nameEl.textContent=''; return; }
		if(nameEl) nameEl.textContent = this.currentCompany.companyName || 'Dreamex Datalab';
		const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl;
		if(logoEl){ if(logoUrl){ logoEl.src = logoUrl; logoEl.style.display = 'block'; logoEl.classList.add('header-company-logo'); } else { logoEl.style.display = 'none'; } }
		if(this.currentCompany.branding){ const root = document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); }
	}

	getUserDisplayName(){
		if(!this.currentUser) return 'User';
		const norm = v => typeof v==='string'? v.trim().replace(/\s+/g,' ') : '';
		const cand = [this.currentUser.displayName, this.currentUser.name, this.currentUser.username];
		for(const c of cand){ const s = norm(c); if(s) return s; }
		if(this.currentUser.email){ return norm(this.currentUser.email.split('@')[0]) || 'User'; }
		return 'User';
	}
	getUserInitials(){
		const dn = this.getUserDisplayName();
		const parts = dn.split(' ').filter(Boolean);
		if(parts.length===1) return parts[0].substring(0,2).toUpperCase();
		return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase();
	}
	async getUserAvatarUrl(){
		if(!this.currentUser) return null;
		const companyId = this.currentUser.companyId || 'default';
		const paths = [
			`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
			`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
			`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
			`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
			`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
			`avatars/${this.currentUser.uid}/profile.jpg`,
			`avatars/${this.currentUser.uid}/profile.png`,
			`avatars/${this.currentUser.uid}/avatar.jpg`,
			`avatars/${this.currentUser.uid}/avatar.png`,
			`profiles/${this.currentUser.uid}/profile.jpg`,
			`profiles/${this.currentUser.uid}/profile.png`
		];
		for(const p of paths){
			try { const ref = firebase.storage().ref(p); const url = await ref.getDownloadURL(); return url; } catch(e){ continue; }
		}
		return null;
	}
	async updateUIForAuthenticatedUser(){
		const btn = document.getElementById('userProfileBtn');
		const list = document.querySelector('.profile-dropdown ul');
		if(!btn || !list || !this.currentUser) return;
		const displayName = this.getUserDisplayName();
		const email = this.currentUser.email || '';
		let avatarUrl = null;
		try { avatarUrl = await this.getUserAvatarUrl(); } catch(e) {}
		const btnImg = btn.querySelector('img');
		if(avatarUrl && btnImg){
			btnImg.src = avatarUrl;
			btnImg.alt = displayName + ' Avatar';
			btnImg.style.display = 'block';
			btnImg.onerror = () => {
				btnImg.style.display = 'none';
				btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
			};
		} else {
			btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
		}
		const avatarHtml = avatarUrl
			? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`
			: `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
		list.innerHTML = `
			<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;">
				<div style="display:flex;align-items:center;gap:12px;">${avatarHtml}
					<div>
						<div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div>
						<div style="color:#666;font-size:12px;">${email}</div>
					</div>
				</div>
			</li>
			<li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
			<li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
			<li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>`;
		list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); });
	}
	bindProfileDropdown(){
		const btn = document.getElementById('userProfileBtn');
		const dd = document.querySelector('.profile-dropdown');
		if(btn && dd){
			btn.addEventListener('click', e=>{ e.stopPropagation(); dd.classList.toggle('show'); });
			document.addEventListener('click', e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); });
		}
	}
	async logout(){
		try{ await firebase.auth().signOut(); } catch(e){}
		localStorage.removeItem('currentUser');
		localStorage.removeItem('user');
		window.location.href = 'login.html';
	}
}

document.addEventListener('DOMContentLoaded', ()=>{
	const authMini = new AuthManagerMini();
	window.authManager = authMini;
	authMini.initialize();
	// Initialize role-based/feature-based menu visibility like project-list
	try { initializeMenuAuthorization(); } catch(e) { /* noop */ }
	// Wire sidebar toggle
	const sidebarToggle = document.getElementById('sidebarToggle');
	const sidebar = document.getElementById('sidebar');
	const mainContent = document.getElementById('mainContent');
	if (sidebarToggle && sidebar && mainContent) {
		sidebarToggle.addEventListener('click', function(){
			sidebar.classList.toggle('collapsed');
			mainContent.classList.toggle('sidebar-collapsed');
		});
	}
});
</script>
</body>
</html>
