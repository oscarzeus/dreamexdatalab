<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management - Dreamex Datalab HSE</title>
    <!-- Firebase v8 (same as staff.html) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Pre-hide all fleet tabs & navigation to prevent unauthorized flicker on initial load
        (function(){ document.documentElement.classList.add('fleet-prehide'); })();
    </script>
    <style>
        /* Prevent initial flash of all tabs before permissions apply */
        .fleet-prehide .tab-navigation,
        .fleet-prehide .tab-content { display:none !important; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="js/emailjs-service.js"></script>
    <!-- SheetJS for Excel file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Icons / Fonts / (Font Awesome already imported via @import in staff) -->
    <style>
        /* --- COPIED CORE STYLE BLOCKS FROM staff.html (trimmed to essentials but class names kept identical) --- */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
        :root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --purple:#9b59b6; --orange:#e67e22; --red:#e74c3c; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333333; --text-secondary:#666666; --border-color:#e0e0e0; --spacing-unit:1rem; --padding-sm:.5rem; --padding-md:1rem; --padding-lg:1.5rem; --transition-speed:.2s; }
        [data-theme="dark"] { --bg-primary:#1a1a1a; --bg-secondary:#2d2d2d; --text-primary:#ffffff; --text-secondary:#cccccc; --border-color:#404040; }
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:var(--font-family); font-size:var(--base-font-size); line-height:calc(1.5 * var(--font-scale)); color:var(--text-primary); background:#f8f9fa;}
        .app-container {display:flex; min-height:100vh;}
        .sidebar {width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; height:100vh; overflow-y:auto; z-index:1000; transition:transform .3s ease;}
        .sidebar.collapsed {transform:translateX(-100%);} 
        .main-content {flex:1; margin-left:var(--sidebar-width); padding:.5rem; padding-top:4rem; width:calc(100% - var(--sidebar-width));}
    /* Smoothly adjust layout when collapsing the sidebar */
    .main-content { transition: margin-left .3s ease, width .3s ease; }
    .main-content.sidebar-collapsed { margin-left: 0; width: 100%; }
        .top-nav {display:flex; justify-content:space-between; align-items:center; padding:.5rem .75rem; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); margin-bottom:.3rem; position:fixed; top:.25rem; right:.5rem; left:calc(var(--sidebar-width) + .5rem); height:50px; min-height:50px; z-index:100; transition:left .3s ease;}
    .top-nav.sidebar-collapsed { left: .5rem; }
        .top-nav-left {display:flex; align-items:center; gap:1rem;}
        .sidebar-toggle-btn {background:none; border:none; cursor:pointer; font-size:1.2rem; padding:.5rem; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);} 
        .menu {list-style:none; margin-top:2rem;}
        .menu li {margin-bottom:.5rem;}
        .menu a {color:#fff; text-decoration:none; display:flex; align-items:center; padding:.75rem 1rem; border-radius:5px; transition:background-color .3s;}
        .menu a i {margin-right:10px;}
        .menu a:hover, .menu a.active {background:var(--secondary-color);} 
        .menu-dropdown .submenu {display:none; list-style:none; margin-left:2rem; margin-top:.5rem;}
        .menu-dropdown:hover .submenu {display:block;}
        .content {width:100%; margin:0; padding:.75rem; background:#fff; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.08);} 
        table {width:100%; border-collapse:collapse; margin-top:.75rem; font-size: 0.7rem;} 
        th,td {padding:.4rem; text-align:left; border-bottom:1px solid #e9ecef; font-size:.7rem;} 
        th {background:#f8f9fa; font-weight:600; color:#495057; border-bottom: 2px solid #e9ecef; white-space: nowrap; transition: background-color 0.3s ease, color 0.3s ease; position: sticky; top: 0; z-index: 10; border-radius: 0 !important;}
        
        /* Dynamic table header colors based on active tab */
        .tab-content.active .staff-table th {
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Vehicles tab - Blue headers */
        #vehiclesTabContent.active .staff-table th {
            background: #007bff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Analytics tab - Purple headers */
        #analyticsTabContent.active .staff-table th {
            background: #6f42c1;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Tab Content Display Control */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Analytics Tab Content Height Optimization */
        #analyticsTabContent {
            height: calc(100vh - 140px); /* Full height minus header and padding */
            flex-direction: column;
            overflow: hidden;
        }
        
        #analyticsTabContent.active {
            height: calc(100vh - 140px);
            display: flex;
        }
        
        .staff-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .staff-table td {
            padding: 0.4rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            color: #495057;
            font-size: 0.7rem;
        }

        .staff-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .staff-table tbody tr {
            transition: all 0.2s ease;
        } 
        /* Hide Tank Capacity column (updated for new Name column) */
        #vehicleTable th:nth-child(11), #vehicleTable td:nth-child(11) { display: none; }
        
        /* Table wrapper with horizontal scroll */
        .table-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px); /* Limit table height for vertical scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        
        /* Ensure table takes full width of container */
        .staff-table {
            min-width: 100%;
            white-space: nowrap;
        }
        
        /* Sticky table header */
        .staff-table thead th {
            position: sticky;
            top: 0;
            background: #007bff;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Make table cells not wrap text */
        .staff-table th,
        .staff-table td {
            white-space: nowrap;
            padding: 8px 12px;
        }
        
        /* Scrollbar styling for webkit browsers */
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        } 
        /* Enhanced Modal Styles (exact copy from staff.html) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            top: 0;
            z-index: 2;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.03);
        }
        .modal-header h5 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-header h5::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: #3b82f6;
            border-radius: 2px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 1.25rem 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
            scrollbar-width: thin;
            scrollbar-color: #ddd transparent;
            position: relative;
        }
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background-color: #ddd;
            border-radius: 3px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background-color: #bbb;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }
        /* Form Layout Optimization */
        .form-row {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        .form-row-3 {
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
        }
        .form-row-3 .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        .form-row-4 {
            display: flex;
            gap: 0.6rem;
            align-items: flex-start;
        }
        .form-row-4 .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        .form-row-5 {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }
        .form-row-5 .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        @media (max-width: 1024px) {
            .form-row-3 {
                flex-wrap: wrap;
            }
            .form-row-3 .form-group {
                flex: 1 1 calc(50% - 0.4rem);
            }
            .form-row-4 {
                flex-wrap: wrap;
            }
            .form-row-4 .form-group {
                flex: 1 1 calc(50% - 0.3rem);
            }
            .form-row-5 {
                flex-wrap: wrap;
            }
            .form-row-5 .form-group {
                flex: 1 1 calc(50% - 0.25rem);
            }
        }
        @media (max-width: 768px) {
            .form-row, .form-row-3, .form-row-4, .form-row-5 {
                flex-direction: column;
                gap: 0;
            }
            .form-row-3 .form-group, .form-row-4 .form-group, .form-row-5 .form-group {
                flex: 1 1 100%;
            }
        } 
        .form-group {margin-bottom:.9rem;} 
        .form-group label {display:block; margin-bottom:.45rem; font-weight:600; font-size:.65rem; text-transform:uppercase; letter-spacing:.5px;} 
        .form-group input, .form-group select, .form-group textarea {width:100%; padding:.55rem .6rem; border:1px solid #ddd; border-radius:6px; font-size:.75rem; font-family: inherit;} 
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline:none; border-color:var(--secondary-color); box-shadow:0 0 0 2px rgba(52,152,219,.2);} 
        .form-group textarea {resize: vertical; min-height: 70px;} 
        .btn {padding:.45rem .85rem; border:none; border-radius:6px; cursor:pointer; font-size:.7rem; font-weight:600; transition:.2s;} 
        .btn-primary {background:var(--primary-color); color:#fff;} 
        .btn-secondary {background:var(--secondary-color); color:#fff;} 
        .btn-danger {background:var(--red); color:#fff;} 
        .btn:hover {opacity:.9; transform:translateY(-1px);} 
        
        /* Import Controls Styles */
        .import-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-link {
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .btn-link:hover {
            background-color: rgba(52, 152, 219, 0.1);
            text-decoration: none;
        }
        
        .import-progress {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .import-results {
            margin-top: 1rem;
        }
        
        .import-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        
        .import-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }
        
        .import-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        } 
        .fab {position:fixed; right:1.5rem; bottom:1.5rem; width:40px; height:40px; border-radius:50%; background:var(--secondary-color); color:#fff; font-size:1.2rem; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,.25);} 
        .error {color:#e74c3c; font-size:.6rem; margin-top:.25rem; display:none;} 
        .invalid {border-color:#e74c3c !important;} 
        
        /* Vehicle Details Modal Styles */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 0.5rem 0;
        }
        .detail-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }
        .detail-section.full-width {
            grid-column: 1 / -1;
        }
        .detail-section h4 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.4rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75rem;
            flex: 0 0 40%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-value {
            color: #212529;
            text-align: right;
            flex: 1;
            font-size: 0.8rem;
            word-wrap: break-word;
        }
        .detail-value.status-active {
            color: #28a745;
            font-weight: 600;
        }
        .detail-value.status-inactive {
            color: #dc3545;
            font-weight: 600;
        }
        .detail-value.status-maintenance {
            color: #ffc107;
            font-weight: 600;
        }
        .detail-notes {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.8rem;
            line-height: 1.4;
            color: #495057;
            white-space: pre-wrap;
        }
        
        /* Attachment Styles */
        .attachment-info {
            width: 100%;
        }
        .attachment-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .attachment-name {
            flex: 1;
            color: #495057;
            font-weight: 500;
        }
        .attachment-actions {
            display: flex;
            gap: 0.25rem;
        }
        .btn-link {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .btn-link:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-1px);
        }
        .no-attachment {
            color: #6c757d;
            font-style: italic;
            font-size: 0.75rem;
        }
        
        /* Image Viewer Modal Styles */
        .image-viewer-modal {
            z-index: 1060;
        }
        .image-viewer-content {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
        }
        .image-viewer-body {
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 70vh;
            overflow: hidden;
        }
        .viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        
        /* Action Buttons Styles */
        .actions-cell {
            text-align: center;
            padding: 0.5rem;
            white-space: nowrap;
        }
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
            align-items: center;
        }
        .btn-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-edit {
            color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        .btn-edit:hover {
            background: #007bff;
            color: white;
        }
        .btn-view {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .btn-view:hover {
            background: #28a745;
            color: white;
        }
        .btn-delete {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        .btn-delete:hover {
            background: #dc3545;
            color: white;
        }
        
        /* Delete Confirmation Modal Styles */
        .confirmation-modal {
            z-index: 1070;
        }
        .delete-confirmation-content {
            text-align: center;
        }
        .vehicle-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
        }
        .vehicle-info h6 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 0.9rem;
        }
        .vehicle-details {
            font-size: 1rem;
            color: #212529;
        }
        .vehicle-details strong {
            color: #dc3545;
        }
        .vehicle-details small {
            color: #6c757d;
            display: block;
            margin-top: 0.25rem;
        }
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 0.75rem;
            color: #856404;
            font-size: 0.9rem;
        }
        .warning-message i {
            color: #f39c12;
            margin-right: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .detail-row {
                flex-direction: column;
                gap: 0.25rem;
            }
            .detail-label {
                flex: none;
            }
            .detail-value {
                text-align: left;
            }
        }
        
        /* Header Company Logo Styles (match project-list.html) */
        .header-company-logo {
            height: 32px;
            width: auto;
            border-radius: 6px;
            object-fit: contain;
            box-shadow: none !important;
            background: transparent !important;
            border: none !important;
            display: none;
        }
        .header-company-logo.visible { display: block; }
        .company-name-header {
            font-weight: 700;
            color: var(--dark-color);
            font-size: 1rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
            display: inline-block;
        }
        /* Page Header Styles */
        .staff-management-content {
            padding: 0.5rem 0;
            width: 100%;
            margin: 0;
            max-width: none;
        }
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.5rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 0.5rem;
            margin: 0 0 0.5rem 0;
            transition: box-shadow 0.3s ease;
        }
        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }
        .page-title {
            font-size: 0.9rem;
            color: white;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            flex: 1;
            text-align: center;
        }
        .page-title i {
            font-size: 0.9rem;
        }
        .header-top-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0;
            min-height: 1.5rem;
        }
        .header-left {
            flex: 1;
            display: flex;
            justify-content: center;
        }
        .header-right {
            position: absolute;
            right: 0;
        }
        /* Notification & Profile Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }
        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }
        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .notification-dropdown.show {
            display: block;
        }
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }
        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }
        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }
        .profile-dropdown.show {
            display: block;
        }
        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-dropdown ul li {
            padding: 0;
        }
        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }
        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }
        /* Permission visibility */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }
        
        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }
        
        /* Hide ALL menu items by default during loading */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature] {
            display: none !important;
        }
        
        .menu-loading [data-feature] {
            display: none !important;
        }
        
        .menu-loading .menu-dropdown {
            display: none !important;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin: 0 0 1rem 0;
            background: white;
            padding: 0.5rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            flex: 1;
            justify-content: center;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .tab-nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* Active Tab Button Colors matching fleet theme */
        #vehiclesTabBtn.active {
            background: #007bff;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }
        #analyticsTabBtn.active {
            background: #6f42c1;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.4);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Analytics Styles */
        .controls-section {
            background: #f8f9fa;
            padding: 0.75rem; /* Reduced padding */
            border-radius: 6px;
            margin-bottom: 0.75rem; /* Reduced margin */
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Reduced minimum width */
            gap: 0.75rem; /* Reduced gap */
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
        }
        
        .chart-actions .actions-wrapper {
            display: flex;
            justify-content: flex-end;
        }
        
        .view-toggles {
            display: flex;
            gap: 1rem;
        }
        
        .view-toggles i:hover {
            color: var(--primary-color) !important;
        }
        
        .visualization-container {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            height: calc(100vh - 200px); /* Fit to screen height */
            display: flex;
            flex-direction: column;
        }
        
        .chart-container {
            /* Further reduce height for fleet distribution chart */
            height: 280px; /* Previously calc(40vh - 80px); now fixed for consistency */
            margin-bottom: 1rem;
            position: relative;
            flex: 0 0 auto; /* Do not stretch */
        }
        /* Ensure canvas respects container height */
        #fleetMainChart { height:100% !important; width:100% !important; }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: auto; /* Push to bottom */
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem; /* Reduced padding */
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Reduced gap */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 60px; /* Set minimum height */
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 40px; /* Reduced size */
            height: 40px; /* Reduced size */
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem; /* Reduced font size */
        }
        
        .stat-details h3 {
            margin: 0;
            font-size: 1.5rem; /* Reduced font size */
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-details p {
            margin: 0;
            color: #6c757d;
            font-size: 0.75rem; /* Reduced font size */
            font-weight: 500;
        }
        @media (max-width:768px){ .sidebar{width:100%; height:auto; position:relative;} .main-content{margin-left:0; width:100%; padding-top:1rem;} .top-nav{position:relative; left:0; right:0; top:0; margin-bottom:1rem;} .sidebar.collapsed{display:none;} .header-company-logo{width:32px;height:32px;} .company-name-header{font-size:1rem;} }
        /* --- Added: Select2 CSS (from staff.html) --- */
        .select2-container{box-sizing:border-box;display:inline-block;margin:0;position:relative;vertical-align:middle}.select2-container .select2-selection--single{box-sizing:border-box;cursor:pointer;display:block;height:28px;user-select:none;-webkit-user-select:none}.select2-container .select2-selection--single .select2-selection__rendered{color:#444;line-height:28px;padding-left:8px;padding-right:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.select2-container .select2-selection--single .select2-selection__clear{cursor:pointer;float:right;font-weight:bold}.select2-container .select2-selection--single .select2-selection__placeholder{color:#999}.select2-container .select2-selection--single .select2-selection__arrow{height:26px;position:absolute;top:1px;right:1px;width:20px}.select2-container .select2-selection--single .select2-selection__arrow b{border-color:#888 transparent transparent transparent;border-style:solid;border-width:5px 4px 0 4px;height:0;left:50%;margin-left:-4px;margin-top:-2px;position:absolute;top:50%;width:0}.select2-container[dir="rtl"] .select2-selection--single .select2-selection__clear{float:left}.select2-container[dir="rtl"] .select2-selection--single .select2-selection__rendered{padding-left:20px;padding-right:8px}.select2-container .select2-selection--multiple{box-sizing:border-box;cursor:pointer;display:block;min-height:32px;user-select:none;-webkit-user-select:none}.select2-container .select2-selection--multiple .select2-selection__rendered{color:#444;cursor:text;overflow:hidden;padding-left:8px;text-overflow:ellipsis;white-space:nowrap}.select2-container .select2-selection--multiple .select2-selection__rendered li{list-style:none}.select2-container .select2-selection--multiple .select2-selection__clear{cursor:pointer;float:right;font-weight:bold;margin-top:5px;margin-right:10px}.select2-container .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;cursor:default;float:left;margin-right:5px;margin-top:5px;padding:0 5px}.select2-container .select2-selection--multiple .select2-selection__choice__remove{color:#999;cursor:pointer;display:inline-block;font-weight:bold;margin-right:2px}.select2-container .select2-selection--multiple .select2-selection__choice__remove:hover{color:#333}.select2-container .select2-search--inline{float:left}.select2-container .select2-search--inline .select2-search__field{box-sizing:border-box;border:none;font-size:100%;margin-top:5px;padding:0}.select2-container .select2-search--inline .select2-search__field::-webkit-search-cancel-button{-webkit-appearance:none}.select2-dropdown{background-color:#fff;border:1px solid #aaa;border-radius:4px;box-sizing:border-box;display:block;position:absolute;left:-100000px;width:100%;z-index:1051}.select2-results{display:block}.select2-results__options{list-style:none;margin:0;padding:0}.select2-results__option{padding:6px;user-select:none;-webkit-user-select:none}.select2-results__option[aria-selected]{cursor:pointer}.select2-results__option[aria-selected=true]{background-color:#5897fb;color:#fff}.select2-results__option[aria-selected=false]:hover{background-color:#f5f5f5}.select2-results__option--highlighted[aria-selected]{background-color:#5897fb;color:#fff}.select2-results__option--highlighted[aria-selected=false]{background-color:#5897fb;color:#fff}.select2-results__group{cursor:default;display:block;padding:6px}.select2-container--default .select2-selection--single{background-color:#fff;border:1px solid #aaa;border-radius:4px}.select2-container--default .select2-selection--single .select2-selection__rendered{color:#444;line-height:28px}.select2-container--default .select2-selection--single .select2-selection__clear{cursor:pointer;float:right;font-weight:bold}.select2-container--default .select2-selection--single .select2-selection__placeholder{color:#999}.select2-container--default .select2-selection--single .select2-selection__arrow{height:26px;position:absolute;top:1px;right:1px;width:20px}.select2-container--default .select2-selection--single .select2-selection__arrow b{border-color:#888 transparent transparent transparent;border-style:solid;border-width:5px 4px 0 4px;height:0;left:50%;margin-left:-4px;margin-top:-2px;position:absolute;top:50%;width:0}.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__clear{float:left}.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__rendered{padding-left:20px;padding-right:8px}.select2-container--default .select2-selection--multiple{background-color:#fff;border:1px solid #aaa;border-radius:4px;cursor:text}.select2-container--default .select2-selection--multiple .select2-selection__rendered{box-sizing:border-box;list-style:none;margin:0;padding:0 5px;width:100%}.select2-container--default .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;cursor:default;float:left;margin-right:5px;margin-top:5px;padding:0 5px}.select2-container--default .select2-selection--multiple .select2-selection__choice__remove{color:#999;cursor:pointer;display:inline-block;font-weight:bold;margin-right:2px}.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover{color:#333}.select2-container--default.select2-container--focus .select2-selection--multiple{border:solid black 1px;outline:0}.select2-container--default.select2-container--disabled .select2-selection--multiple,.select2-container--default.select2-container--disabled .select2-selection--single{background-color:#eee;cursor:default}.select2-container--default.select2-container--disabled .select2-selection__clear{display:none}.select2-container--default.select2-container--disabled .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;color:#999}.select2-container--default.select2-container--disabled .select2-selection--multiple .select2-selection__choice__remove{display:none}.select2-container--default.select2-container--open.select2-container--above .select2-selection--single,.select2-container--default.select2-container--open.select2-container--above .select2-selection--multiple{border-top-left-radius:0;border-top-right-radius:0}.select2-container--default.select2-container--open.select2-container--below .select2-selection--single,.select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple{border-bottom-left-radius:0;border-bottom-right-radius:0}.select2-container--default .select2-search--dropdown .select2-search__field{border:1px solid #aaa}.select2-container--default .select2-results>.select2-results__options{max-height:200px;overflow-y:auto}.select2-container--default .select2-results__option[role=group]{padding:0}.select2-container--default .select2-results__option[aria-disabled=true]{color:#999}.select2-container--default .select2-results__option[aria-selected=true]{background-color:#5897fb}.select2-container--default .select2-results__option .select2-results__option{padding-left:1em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option{margin-left:-1em;padding-left:2em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-2em;padding-left:3em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-3em;padding-left:4em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-4em;padding-left:5em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-5em;padding-left:6em}.select2-container--default .select2-results__option--highlighted[aria-selected]{background-color:#5897fb;color:#fff}.select2-container--default .select2-results__group{cursor:default;display:block;padding:6px}
        /* --- Added: Enhanced Modal Styles (from staff.html) --- */
        .modal.show .modal-content {animation:modalSlide .25s ease-out;} @keyframes modalSlide{from{transform:translateY(15px);opacity:0;}to{transform:translateY(0);opacity:1;}}
        /* --- Added: Top Nav Right Styling --- */
        .top-nav-right { display: flex; align-items: center; gap: 1.5rem; }
        /* Notification System */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }
        .notification-success { border-left: 4px solid #28a745; }
        .notification-error { border-left: 4px solid #dc3545; }
        .notification-warning { border-left: 4px solid #ffc107; }
        .notification-info { border-left: 4px solid #17a2b8; }
        .notification-content {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #000000;
        }
        .notification-close {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        .notification-close:hover {
            color: #333;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== Fleet tables aligned with jobscreen design ===== */
        .table-container {
            background: #ffffff;
            border-radius: 0;
            box-shadow: 0 16px 48px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.06);
            overflow: hidden;
            width: 100%;
            margin: 0 0 .75rem 0;
            transition: box-shadow 0.3s ease;
        }
        .table-container:hover {
            box-shadow: 0 20px 60px rgba(0,0,0,0.18), 0 12px 32px rgba(0,0,0,0.12), 0 6px 16px rgba(0,0,0,0.08);
        }
        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .jobs-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Dynamic header colors (mirror jobscreen) */
        #vehiclesTabContent.active .jobs-table th { background: #28a745; color: #ffffff; }
        #maintenanceTabContent.active .jobs-table th { background: #17a2b8; color: #ffffff; }
        .jobs-table th:first-child { width: 40px; text-align: center; }
        .jobs-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            font-size: 0.9rem;
            color: #495057;
        }
        .jobs-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .jobs-table tbody tr { transition: all 0.2s ease; }
        /* Badges & pills for visual parity */
        .fleet-badge { display:inline-block; font-size:.65rem; padding:3px 6px; border-radius:12px; font-weight:600; letter-spacing:.3px; }
        .fleet-badge.status-pass { background:#28a745; color:#fff; }
        .fleet-badge.status-fail { background:#dc3545; color:#fff; }
        .fleet-badge.status-needs { background:#ffc107; color:#212529; }
        .fleet-badge.status-out { background:#6c757d; color:#fff; }
        .fleet-badge.type-routine { background:#6f42c1; color:#fff; }
        .fleet-badge.type-preventive { background:#20c997; color:#fff; }
        .fleet-badge.type-corrective { background:#e67e22; color:#fff; }
        .fleet-badge.type-emergency { background:#d63384; color:#fff; }
        .fleet-badge.attachments { background:#007bff; color:#fff; }
        .fleet-badge.followup { background:#fd7e14; color:#fff; }
        .risk-score-pill { display:inline-flex; align-items:center; gap:4px; padding:3px 7px; border-radius:14px; font-size:.65rem; font-weight:600; }
        .risk-low { background:#d1e7dd; color:#0f5132; }
        .risk-med { background:#fff3cd; color:#664d03; }
        .risk-high { background:#f8d7da; color:#842029; }
        
        /* ===== Maintain modal fields styled similar to staff position details ===== */
        .maint-summary-bar{
            display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:8px;align-items:flex-end;
        }
        .maint-summary-bar .form-field{flex:1 1 160px;min-width:160px;display:flex;flex-direction:column;gap:6px}
        .maint-summary-bar .form-field.wide{flex:2 1 240px;min-width:220px}
        .maint-block{border:1px solid #e0e0e0;border-radius:8px;padding:10px;background:#fff}
        .maint-block>summary{cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px;font-size:.85rem}
        .inline-field{display:flex;flex-direction:column;font-size:.7rem}
        .tiny-label{font-size:.65rem;font-weight:600;display:block;margin-bottom:4px}
        .compact-select{width:100%;font-size:.65rem}
        .maint-block input[type="text"],
        .maint-block input[type="number"],
        .maint-block input[type="date"],
        .maint-block select,
        .maint-summary-bar input,
        .maint-summary-bar select,
        #maintenanceForm textarea{
            border:1px solid #dfe3e8; background:#fff; padding:8px 10px; border-radius:6px; font-size:.85rem; color:#333; outline:none; transition:border-color .15s ease, box-shadow .15s ease;
        }
        .maint-block input:focus,
        .maint-block select:focus,
        .maint-summary-bar input:focus,
        .maint-summary-bar select:focus,
        #maintenanceForm textarea:focus{
            border-color:#80bdff; box-shadow:0 0 0 2px rgba(0,123,255,.15);
        }
        #maintenanceForm label{font-size:.75rem;color:#334155;font-weight:600}
    </style>
    <!-- jsPDF / XLSX / Chart.js (kept for parity; vehicle page may not use yet) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
<div class="app-container">
    <!-- Sidebar (copied from staff.html) -->
    <nav class="sidebar menu-loading" id="sidebarMenu">
        <div class="logo"><h2>Dreamex Datalab</h2></div>
        <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view" data-requires-permission="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                <a href="#"><i class="fas fa-medkit"></i> Health</a>
                <ul class="submenu">
                    <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                    <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                    <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                <ul class="submenu">
                    <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                    <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                    <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                    <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                    <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                    <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                <!-- Risk Management (separate section) -->
<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
<ul class="submenu">
<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
</ul>
</li></ul>
            </li>
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                	<ul class="submenu">
                    <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                    <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                    <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                	</ul>
                </li>
            <li class="menu-dropdown" data-feature="fuel_management">
                <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                <ul class="submenu">
                    <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="environment_view">
                <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                <ul class="submenu"><li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li></ul>
            </li>
            <li class="menu-dropdown" data-feature="security_view">
                <a href="#"><i class="fas fa-lock"></i> Security</a>
                <ul class="submenu">
                    <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
						<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
</ul>
            </li>
            <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                <ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                <ul class="submenu">
                    <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                <a href="#"><i class="fas fa-users"></i> HR</a>
                <ul class="submenu">
                    <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html">Human HR</a></li>
                    <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                    <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                    <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                    <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                    <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                    <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                    <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                    <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                    <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                    <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                    <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                    <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                    <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                </ul>
            </li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <ul class="submenu">
                    <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <!-- Main area -->
    <main class="main-content" id="mainContent">
        <!-- Top Navigation (exact copy from staff.html) -->
        <header class="top-nav">
            <div class="top-nav-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                <span id="headerCompanyName" class="company-name-header"></span>
            </div>
            <div class="top-nav-right">
                <div class="notifications">
                    <button id="notificationBtn" class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list"></div>
                    </div>
                </div>
                <div class="user-profile">
                    <button id="userProfileBtn" class="profile-btn">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzM0OThkYiIvPjx0ZXh0IHg9IjIwIiB5PSIyNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSI2MDAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiI+VTwvdGV4dD48c3ZnPjwvc3ZnPg==" alt="User Avatar">
                    </button>
                    <div class="profile-dropdown">
                        <ul>
                            <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        <!-- Fleet Page Content -->
        <section class="content" id="fleetContent">
            <div class="staff-management-content">
                <div class="page-header">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:.6rem; flex-wrap:wrap;">
                        <div style="display:flex; align-items:center; gap:0.6rem;">
                            <i class="fas fa-truck"></i>
                            <span>Fleet / Vehicles</span>
                        </div>
                        <div class="page-header-actions" style="display:flex; align-items:center; gap:.5rem;">
                            <button id="addVehicleHeaderBtn" class="btn" style="background:#28a745;color:#fff;font-size:.8rem;padding:.45rem .8rem;border-radius:6px; display:inline-flex; align-items:center; gap:.4rem;" onclick="openAddVehicleModal()">
                                <i class="fas fa-plus"></i>
                                <span>Add Vehicle</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-nav-btn active" id="vehiclesTabBtn" onclick="switchToTab('vehicles')">
                        <i class="fas fa-truck"></i>
                        Vehicles
                    </button>
                    <button class="tab-nav-btn" id="analyticsTabBtn" onclick="switchToTab('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                    <button class="tab-nav-btn" id="deepAnalyticsTabBtn" onclick="switchToTab('deepAnalytics')">
                        <i class="fas fa-chart-line"></i>
                        Deep Analytics
                    </button>
                    <button class="tab-nav-btn" id="maintenanceTabBtn" onclick="switchToTab('maintenance')">
                        <i class="fas fa-tools"></i>
                        Maintenance
                    </button>
                    <button class="tab-nav-btn" id="assignmentTabBtn" onclick="switchToTab('assignment')">
                        <i class="fas fa-exchange-alt"></i>
                        Assignment
                    </button>
                    <button class="tab-nav-btn" id="settingsTabBtn" onclick="switchToTab('settings')">
                        <i class="fas fa-sliders-h"></i>
                        Settings
                    </button>
                </div>

                <!-- Vehicles Tab Content -->
                <div class="tab-content active" id="vehiclesTabContent">
                    <div class="table-container fleet-table-container">
                    <table id="vehicleTable" class="jobs-table fleet-jobs-style">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Plate Number</th>
                                <th>Type</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Department</th>
                                <th>Site</th>
                                <th>Fuel Type</th>
                                <th>Securing Status</th>
                                <th>Tank</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicleTableBody"></tbody>
                    </table>
                    <div id="vehicleEmptyState" class="empty-state d-none" style="text-align:center; padding:2rem; display:none;">
                        <i class="fas fa-truck" style="font-size:2rem; color:#6c757d;"></i>
                        <i class="fas fa-plus" title="Add Vehicle" style="cursor:pointer; font-size:1.5rem; color:#6c757d;" onclick="openAddVehicleModal()"></i>
                    </div>
                </div>
                </div>

                <!-- Assignment Tab Content -->
                <div class="tab-content" id="assignmentTabContent" style="padding:1rem;">
                    <style>
                        .assignment-modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:2000; }
                        .assignment-modal{ width:min(920px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
                        .assignment-modal header{ display:flex; align-items:center; justify-content:space-between; padding:.8rem 1rem; border-bottom:1px solid #e2e8f0; position:sticky; top:0; background:#fff; z-index:1; }
                        .assignment-modal .body{ padding:1rem; }
                        .assignment-modal footer{ display:flex; gap:.5rem; justify-content:flex-end; padding: .8rem 1rem; border-top:1px solid #e2e8f0; position:sticky; bottom:0; background:#fff; }
                        .btn-icon{ display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .7rem; border-radius:6px; cursor:pointer; border:1px solid #cbd5e1; background:#f8fafc; color:#334155; font-size:.75rem; font-weight:600; }
                        .btn-primary{ background:#3498db; color:#fff; border-color:#2980b9; }
                        .btn-light{ background:#f1f3f5; color:#495057; border-color:#ced4da; }
                        /* Full-width assignment card aligns with page header container */
                        #assignmentTabContent .assignment-card{ width:100%; max-width:none; }
                        /* Ensure table wrapper stretches full width */
                        #assignmentTabContent .assignment-table-wrapper{ width:100%; }
                        /* Responsive tweaks */
                        @media (min-width:1200px){
                            #assignmentTabContent{ padding:1rem 1.25rem; }
                        }
                    </style>
                    <div class="card assignment-card" style="margin:0 auto;">
                        <div class="card-header" style="display:flex;align-items:center;gap:.5rem;">
                            <h3 class="card-title" style="margin:0;font-size:.95rem;display:flex;align-items:center;gap:.5rem;"><i class="fas fa-exchange-alt"></i> Vehicle Assignments</h3>
                            <div style="flex:1"></div>
                            <button id="newAssignmentBtn" type="button" class="btn-icon" title="New assignment request"><i class="fas fa-plus"></i> New</button>
                        </div>
                        <div class="card-body">
                            <div>
                                <div class="table-container fleet-table-container assignment-table-wrapper" style="width:100%;">
                                    <table class="jobs-table fleet-jobs-style assignment-table" style="width:100%;">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Date</th>
                                                <th>Vehicle</th>
                                                <th>Assignee</th>
                                                <th>Period</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="assignmentTableBody"></tbody>
                                    </table>
                                    <div id="assignmentEmpty" style="display:none;text-align:center;padding:.75rem;color:#666;">No assignment requests yet.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal -->
                    <div id="assignmentModalBackdrop" class="assignment-modal-backdrop" onclick="onAssignmentBackdropClick(event)">
                        <div class="assignment-modal" role="dialog" aria-modal="true" aria-labelledby="assignmentModalTitle" onclick="event.stopPropagation()">
                            <header>
                                <h3 id="assignmentModalTitle" style="margin:0; font-size:.95rem; display:flex; align-items:center; gap:.5rem;"><i class="fas fa-exchange-alt"></i> New Vehicle Assignment Request</h3>
                                <button type="button" class="btn-icon" onclick="closeAssignmentModal()" title="Close"><i class="fas fa-times"></i></button>
                            </header>
                            <div class="body">
                                <form id="assignmentForm" onsubmit="submitAssignmentRequest(event)">
                                    <!-- SUMMARY BAR: match maintenance style -->
                                    <section class="maint-summary-bar" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.75rem;margin-bottom:.75rem;">
                                        <div class="form-field">
                                            <label for="assignAssignee">Assignee</label>
                                            <select id="assignAssignee" required>
                                                <option value="">Select assignee</option>
                                            </select>
                                        </div>
                                        <div class="form-field">
                                            <label for="assignDepartment">Department</label>
                                            <input id="assignDepartment" type="text" placeholder="e.g. Operations" />
                                        </div>
                                        <div class="form-field">
                                            <label for="assignSupervisor">Line Manager</label>
                                            <input id="assignSupervisor" type="text" placeholder="Auto-filled from assignee's line manager" readonly style="background:#f9fafb;" />
                                        </div>
                                    </section>

                                    <!-- SECTIONS: match maintenance accordion style -->
                                    <div class="maintenance-accordion" style="display:flex;flex-direction:column;gap:12px;margin-bottom:12px;">
                                        <!-- Work Area & Geofence -->
                                        <details open class="maint-block">
                                            <summary><i class="fas fa-map-marker-alt"></i> Work Areas & Geofences</summary>
                                            <div style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;align-items:start;">
                                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                                    <label for="assignSite" style="font-size:.8rem;font-weight:600;">Site / Work Area</label>
                                                    <select id="assignSite" style="display:none;">
                                                        <option value="">Select site / work area</option>
                                                    </select>
                                                    <div id="assignSiteMulti" style="position:relative;">
                                                        <button type="button" id="assignSiteToggle" aria-haspopup="listbox" aria-expanded="false" style="width:100%;text-align:left;padding:.5rem;border:1px solid #ced4da;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:.5rem;cursor:pointer;">
                                                            <span id="assignSiteSummary" style="color:#111827;">Select site / work area</span>
                                                            <span style="color:#6b7280;">?</span>
                                                        </button>
                                                        <div id="assignSitePanel" role="listbox" style="display:none;position:absolute;z-index:50;left:0;right:0;margin-top:.25rem;background:#fff;border:1px solid #e5e7eb;border-radius:6px;max-height:220px;overflow:auto;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);">
                                                            <div id="assignSiteOptions" style="padding:.35rem .5rem;display:flex;flex-direction:column;gap:.35rem;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                                    <label for="assignGeofence" style="font-size:.8rem;font-weight:600;">Geofence</label>
                                                    <select id="assignGeofence">
                                                        <option value="">Select geofence</option>
                                                    </select>
                                                    <div id="assignGeofenceSelected" style="display:none;margin-top:.35rem;font-size:.75rem;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;padding:.4rem .5rem;border-radius:6px;">
                                                        <div id="assignGeofenceChips" style="display:flex;flex-wrap:wrap;gap:.35rem;"></div>
                                                        <div id="assignGeofenceHint" style="margin-top:.25rem;font-size:.7rem;color:#64748b;">Select a location to add it below. Click  on a chip to remove.</div>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                                    <label for="assignDrivers" style="font-size:.8rem;font-weight:600;">Drivers</label>
                                                    <select id="assignDrivers">
                                                        <option value="">Select driver</option>
                                                    </select>
                                                    <div id="assignDriversSelected" style="display:none;margin-top:.35rem;font-size:.75rem;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;padding:.4rem .5rem;border-radius:6px;">
                                                        <div id="assignDriversChips" style="display:flex;flex-wrap:wrap;gap:.35rem;"></div>
                                                        <div id="assignDriversHint" style="margin-top:.25rem;font-size:.7rem;color:#64748b;">Select a driver to add it below. Click  on a chip to remove.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- Activities -->
                                        <details class="maint-block">
                                            <summary><i class="fas fa-list-ul"></i> Activities</summary>
                                            <div style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
                                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                                    <label for="assignStart" style="font-size:.8rem;font-weight:600;">Start</label>
                                                    <input id="assignStart" type="datetime-local" required style="padding:.5rem;border:1px solid #ced4da;border-radius:6px;" />
                                                </div>
                                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                                    <label for="assignRequestType" style="font-size:.8rem;font-weight:600;">Type of request</label>
                                                    <select id="assignRequestType" style="padding:.5rem;border:1px solid #ced4da;border-radius:6px;">
                                                        <option value="New">New</option>
                                                        <option value="Renewal">Renewal</option>
                                                        <option value="Temporary">Temporary</option>
                                                        <option value="Replacement">Replacement</option>
                                                    </select>
                                                </div>
                                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                                    <label for="assignActivities" style="font-size:.8rem;font-weight:600;">Activities</label>
                                                    <select id="assignActivities" style="display:none;">
                                                        <option value="">Select activities</option>
                                                    </select>
                                                    <div id="assignActivitiesMulti" style="position:relative;">
                                                        <button type="button" id="assignActivitiesToggle" aria-haspopup="listbox" aria-expanded="false" style="width:100%;text-align:left;padding:.5rem;border:1px solid #ced4da;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:.5rem;cursor:pointer;">
                                                            <span id="assignActivitiesSummary" style="color:#111827;">Select activities</span>
                                                            <span style="color:#6b7280;">?</span>
                                                        </button>
                                                        <div id="assignActivitiesPanel" role="listbox" style="display:none;position:absolute;z-index:50;left:0;right:0;margin-top:.25rem;background:#fff;border:1px solid #e5e7eb;border-radius:6px;max-height:220px;overflow:auto;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);">
                                                            <div id="assignActivitiesOptions" style="padding:.35rem .5rem;display:flex;flex-direction:column;gap:.35rem;text-align:left;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- Reason / Notes -->
                                        <details class="maint-block">
                                            <summary><i class="fas fa-align-left"></i> Reason</summary>
                                            <div style="margin-top:10px;">
                                                <label for="assignReason" style="font-size:.8rem;font-weight:600;display:block;margin-bottom:.25rem;">Reason of assignment</label>
                                                <textarea id="assignReason" rows="3" placeholder="Describe why the vehicle is needed..." required style="width:100%;padding:.5rem;border:1px solid #ced4da;border-radius:6px;resize:vertical;"></textarea>
                                            </div>
                                        </details>
                                    </div>

                                    <div id="assignmentStatus" style="font-size:.8rem;color:#64748b;display:none;"></div>
                                </form>
                            </div>
                            <footer>
                                <button type="button" class="btn-icon btn-light" onclick="closeAssignmentModal()">Cancel</button>
                                <button type="button" class="btn-icon btn-primary" onclick="document.getElementById('assignmentForm')?.requestSubmit?.()">Submit Request</button>
                            </footer>
                        </div>
                    </div>
                </div>

                <style>
                    /* Match Deep Analytics multi-dropdown style for Site/Work Area */
                    #assignmentModalBackdrop #assignSiteMulti { position: relative; }
                    #assignmentModalBackdrop #assignSiteToggle { background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:0.5rem; display:flex; align-items:center; justify-content:space-between; gap:0.5rem; cursor:pointer; font-size:0.85rem; min-height:38px; }
                    #assignmentModalBackdrop #assignSitePanel { position:absolute; z-index:2100; top:calc(100% + 4px); left:0; right:0; background:#fff; border:1px solid #cbd5e1; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); padding:0.25rem; max-height:260px; overflow:auto; display:none; }
                    #assignmentModalBackdrop #assignSiteOptions { display:grid; grid-template-columns:1fr; gap:2px; text-align:left; }
                    #assignmentModalBackdrop #assignSiteOptions label { display:flex; align-items:center; justify-content:flex-start; gap:0.3rem; padding:0.22rem 0.28rem; border-radius:4px; cursor:pointer; line-height:1.15; font-size:0.82rem; }
                    #assignmentModalBackdrop #assignSiteOptions label:hover { background:#f1f5f9; }
                    #assignmentModalBackdrop #assignSiteOptions input[type="checkbox"]{ width:14px; height:14px; margin:0; }
                    #assignmentModalBackdrop #assignSiteOptions label span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; }

                    /* Apply the same style to Activities multi-dropdown */
                    #assignmentModalBackdrop #assignActivitiesMulti { position: relative; }
                    #assignmentModalBackdrop #assignActivitiesToggle { background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:0.5rem; display:flex; align-items:center; justify-content:space-between; gap:0.5rem; cursor:pointer; font-size:0.85rem; min-height:38px; }
                    #assignmentModalBackdrop #assignActivitiesPanel { position:absolute; z-index:2100; top:calc(100% + 4px); left:0; right:0; background:#fff; border:1px solid #cbd5e1; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); padding:0.25rem; max-height:260px; overflow:auto; display:none; }
                    #assignmentModalBackdrop #assignActivitiesOptions { display:grid; grid-template-columns:1fr; gap:2px; text-align:left; }
                    #assignmentModalBackdrop #assignActivitiesOptions label { display:flex; align-items:center; justify-content:flex-start; gap:0.3rem; padding:0.22rem 0.28rem; border-radius:4px; cursor:pointer; line-height:1.15; font-size:0.82rem; }
                    #assignmentModalBackdrop #assignActivitiesOptions label:hover { background:#f1f5f9; }
                    #assignmentModalBackdrop #assignActivitiesOptions input[type="checkbox"]{ width:14px; height:14px; margin:0; }
                    #assignmentModalBackdrop #assignActivitiesOptions label span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; }

                    /* Assignment Details footer action buttons - color-only (no background) */
                    #assignmentViewModalBackdrop .assignment-modal footer{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
                    #assignmentViewModalBackdrop .assignment-modal footer .footer-right{ display:flex; align-items:center; gap:.5rem; }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon{ gap:.4rem; font-weight:600; }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-approve,
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-reject {
                        background: transparent;
                        border: none;
                        box-shadow: none;
                        padding: .35rem .5rem;
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon:focus-visible{ outline:2px solid currentColor; outline-offset:2px; border-radius:6px; }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon[disabled]{ opacity:.5; cursor:not-allowed; }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon i{ font-size:1rem; }
                    /* Make entire button adopt the action color */
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-approve {
                        color: #16a34a; /* green-600 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-approve:hover {
                        color: #15803d; /* green-700 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-reject {
                        color: #dc2626; /* red-600 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-reject:hover {
                        color: #b91c1c; /* red-700 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-approve i {
                        color: #16a34a; /* green-600 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-approve:hover i {
                        color: #15803d; /* green-700 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-reject i {
                        color: #dc2626; /* red-600 */
                    }
                    #assignmentViewModalBackdrop .assignment-modal footer .btn-icon.btn-reject:hover i {
                        color: #b91c1c; /* red-700 */
                    }
                </style>

                <!-- Assignment Details Modal (view-only) -->
                <div id="assignmentViewModalBackdrop" class="assignment-modal-backdrop" style="display:none;" onclick="onAssignmentViewBackdropClick(event)">
                    <div class="assignment-modal" role="dialog" aria-modal="true" aria-labelledby="assignmentViewTitle" onclick="event.stopPropagation()">
                        <header>
                            <h3 id="assignmentViewTitle" style="margin:0; font-size:.95rem; display:flex; align-items:center; gap:.5rem;"><i class="fas fa-clipboard-list"></i> Assignment Details</h3>
                            <button type="button" class="btn-icon" onclick="closeAssignmentViewModal()" title="Close"><i class="fas fa-times"></i></button>
                        </header>
                        <div class="body">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Created</label>
                                    <div id="viewAsgCreated" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Status</label>
                                    <div id="viewAsgStatus" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Decision</label>
                                    <div id="viewAsgDecision" style="white-space:pre-wrap;padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;">-</div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Type of request</label>
                                    <div id="viewAsgRequestType" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Assignee</label>
                                    <div id="viewAsgAssignee" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Department</label>
                                    <div id="viewAsgDept" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Site / Work Area</label>
                                    <div id="viewAsgSite" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Geofence</label>
                                    <div id="viewAsgGeofence" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Activities</label>
                                    <div id="viewAsgActivities" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Start</label>
                                    <div id="viewAsgStart" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;grid-column:1/-1;">
                                    <label style="font-size:.8rem;font-weight:600;">Reason</label>
                                    <div id="viewAsgReason" style="white-space:pre-wrap;padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Line Manager</label>
                                    <div id="viewAsgSupervisor" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label style="font-size:.8rem;font-weight:600;">Created By</label>
                                    <div id="viewAsgCreatedBy" style="padding:.5rem;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;"></div>
                                </div>
                            </div>
                        </div>
                        <footer>
                            <button type="button" class="btn-icon btn-light" onclick="closeAssignmentViewModal()">Close</button>
                        </footer>
                    </div>
                </div>

                <!-- Analytics Tab Content -->
                <div class="tab-content" id="analyticsTabContent">
                    <!-- Visualization Controls -->
                    <div class="controls-section">
                        <div class="controls-grid">
                            <div class="filter-group">
                                <select class="filter-select" id="chartTypeSelect" onchange="updateFleetVisualization()" style="display: block;">
                                    <option value="bar">Bar Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="doughnut">Doughnut Chart</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select class="filter-select" id="dataSourceSelect" onchange="updateFleetVisualization()" style="display: block;">
                                    <option value="all">All Vehicles</option>
                                    <option value="active">Active Vehicles</option>
                                    <option value="inactive">Inactive Vehicles</option>
                                    <option value="maintenance">Under Maintenance</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select class="filter-select" id="groupBySelect" onchange="updateFleetVisualization()" style="display: block;">
                                    <option value="status">Status</option>
                                    <option value="department">Department</option>
                                    <option value="vehicleType">Vehicle Type</option>
                                    <option value="fuelType">Fuel Type</option>
                                    <option value="site">Site Assignment</option>
                                </select>
                            </div>
                            
                            <div class="filter-group chart-actions">
                                <div class="actions-wrapper">
                                    <div class="view-toggles">
                                        <i class="fas fa-sync" onclick="refreshFleetVisualization()" title="Refresh Charts" style="cursor: pointer; font-size: 1.1rem; color: #6c757d;"></i>
                                        <i class="fas fa-download" onclick="exportFleetChartData()" title="Export Chart Data" style="cursor: pointer; font-size: 1.1rem; color: #6c757d;"></i>
                                        <i class="fas fa-image" onclick="exportFleetChartImage()" title="Export Chart as Image" style="cursor: pointer; font-size: 1.1rem; color: #6c757d;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Container -->
                    <div class="visualization-container">
                        <!-- Main Chart -->
                        <div class="chart-container">
                            <canvas id="fleetMainChart" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%;"></canvas>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-truck"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="totalVehicles">0</h3>
                                    <p>Total Vehicles</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="activeVehicles">0</h3>
                                    <p>Active Vehicles</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="maintenanceVehicles">0</h3>
                                    <p>Under Maintenance</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-building"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="uniqueDepartments">0</h3>
                                    <p>Departments</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deep Analytics Tab Content -->
                <div class="tab-content" id="deepAnalyticsTabContent" style="padding:1rem;">
                    <style>
                        /* Match camp.html employee select styling */
                        #deepAnalyticsTabContent .select-with-search {
                            display: grid;
                            grid-template-columns: 1fr;
                            gap: 0.35rem;
                        }
                        #deepAnalyticsTabContent .select-with-search select {
                            width: 100%;
                            padding: 0.45rem 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 0.85rem;
                            background: #fff;
                        }
                        /* Multi-dropdown styles (scoped) */
                        #deepAnalyticsTabContent .multi-dropdown { position: relative; }
                        #deepAnalyticsTabContent .multi-dropdown-toggle { background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:0.5rem; display:flex; align-items:center; justify-content:space-between; gap:0.5rem; cursor:pointer; font-size:0.85rem; min-height:38px; }
                        #deepAnalyticsTabContent .multi-dropdown-toggle::after { content:'\25BC'; font-size:0.7rem; color:#475569; }
                        #deepAnalyticsTabContent .multi-dropdown-panel { position:absolute; z-index:2100; top:calc(100% + 4px); left:0; right:0; background:#fff; border:1px solid #cbd5e1; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); padding:0.25rem; max-height:260px; overflow:auto; display:none; }
                        #deepAnalyticsTabContent .multi-dropdown.open .multi-dropdown-panel { display:block; }
                        #deepAnalyticsTabContent .multi-dropdown-search { width:100%; padding:0.35rem 0.45rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.85rem; margin-bottom:0.35rem; }
                        #deepAnalyticsTabContent .multi-dropdown-options { display:grid; grid-template-columns: 1fr; gap:2px; }
                        #deepAnalyticsTabContent .multi-dropdown-option { display:flex; align-items:center; gap:0.3rem; padding:0.22rem 0.28rem; border-radius:4px; cursor:pointer; line-height:1.15; font-size:0.82rem; }
                        #deepAnalyticsTabContent .multi-dropdown-option input[type="checkbox"]{ width:14px; height:14px; }
                        #deepAnalyticsTabContent .multi-dropdown-option span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
                        #deepAnalyticsTabContent .multi-dropdown-option:hover { background:#f1f5f9; }
                        #deepAnalyticsTabContent .multi-dropdown-empty { color:#64748b; font-size:0.85rem; padding:0.3rem; }
                    </style>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;align-items:end;">
                            <div>
                                <select id="deepTypeFilter" class="filter-select" style="width:100%;">
                                    <option value="">All types</option>
                                </select>
                            </div>
                            <div>
                                <select id="deepVehicleFilter" class="filter-select" style="width:100%;">
                                    <option value="">All vehicles</option>
                                </select>
                            </div>
                            <div>
                                <input type="date" id="deepStartDate" style="width:100%;padding:.45rem .6rem;border:1px solid #ced4da;border-radius:6px;">
                            </div>
                            <div>
                                <input type="date" id="deepEndDate" style="width:100%;padding:.45rem .6rem;border:1px solid #ced4da;border-radius:6px;">
                            </div>
                            <div>
                                <select id="deepFieldSelect" class="filter-select" style="width:100%;">
                                    <option value="">All types</option>
                                </select>
                            </div>
                            <div id="deepComplianceItemsWrap" style="display:none;">
                                <label style="font-size:.7rem;font-weight:600;">Inspection items</label>
                                <div id="deepComplianceDropdown" class="multi-dropdown">
                                    <div id="deepComplianceToggle" class="multi-dropdown-toggle">All items</div>
                                    <div id="deepCompliancePanel" class="multi-dropdown-panel">
                                        <input id="deepComplianceSearch" type="text" class="multi-dropdown-search" placeholder="Search items..." />
                                        <div id="deepComplianceOptions" class="multi-dropdown-options"></div>
                                    </div>
                                </div>
                                
                            </div>
                            <div>
                                <button id="deepClearFilters" type="button" class="filter-clear-btn" style="width:100%;padding:.5rem .6rem;border:1px solid #cbd5e1;border-radius:6px;background:#f8fafc;font-size:.75rem;font-weight:600;cursor:pointer;">Clear filters</button>
                            </div>
                        </div>
                        <div class="chart-container" style="height:260px;border:1px solid #e9ecef;border-radius:8px;padding:10px;background:#fff;">
                            <canvas id="deepParetoChart"></canvas>
                        </div>
                        <div class="table-container fleet-table-container" style="margin-top:.5rem;">
                            <table class="jobs-table fleet-jobs-style" style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Date</th>
                                        <th>Vehicle</th>
                                        <th>Status</th>
                                        <th>Action items</th>
                                        <th>Compliance issues</th>
                                        <th>Risk</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody id="deepAnalyticsTableBody"></tbody>
                            </table>
                            <div id="deepAnalyticsEmpty" style="display:none;text-align:center;padding:1rem;color:#666;">No inspections match your filters.</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab Content -->
                <div class="tab-content" id="settingsTabContent" style="padding:1rem;">
                    <!-- Fleet Access Control Card: per-user granular tab permissions -->
                    <div class="card" id="fleetAccessControlCard" style="margin-top:2rem;">
                        <div class="card-header" style="display:flex;align-items:center;gap:.75rem;">
                            <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:.5rem;font-size:.9rem;">
                                <i class="fas fa-user-shield"></i>
                                Fleet Access Control
                            </h3>
                            <button type="button" class="btn btn-primary" title="Add user permissions" onclick="window.openFleetAccessControlModal()" style="font-size:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:4px;">
                                <i class="fas fa-plus"></i>
                                Add
                            </button>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <div class="table-wrapper" style="padding:1rem;">
                                <table class="users-table" id="fleetAccessControlTable" style="font-size:.65rem;">
                                    <thead>
                                        <tr>
                                            <th style="width:220px;">User</th>
                            <th>Email</th>
                                <th>Job Title</th>
                                            <th style="white-space:nowrap;">Permissions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fleetAccessControlTableBody">
                                        <!-- Per-user permissions loaded here -->
                                    </tbody>
                                </table>
                                <div id="fleetAccessControlEmpty" style="display:none;text-align:center;color:#64748b;padding:.75rem;font-size:.65rem;">No fleet access control users added yet.</div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Work Area Locations Management -->
                    <div class="card" id="workAreaLocationsCard" style="margin-top:1.25rem;">
                            <div class="card-header" style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">
                            <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:.5rem;font-size:.9rem;">
                                <i class="fas fa-map-marker-alt"></i>
                                Work Area Locations
                            </h3>
                            <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
                                <button type="button" class="btn" id="addLocationBtn" style="background:#28a745;color:#fff;font-size:.75rem;padding:.4rem .7rem;border-radius:6px;">
                                    <i class="fas fa-plus"></i> Add Location
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <div class="table-wrapper" style="padding:1rem;">
                                <table class="users-table" id="locationsTable" style="font-size:.7rem;">
                                    <thead>
                                        <tr>
                                            <th style="width:60px;">#</th>
                                            <th>Work Area</th>
                                            <th>Location Name</th>
                                            <th style="width:120px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="locationsTableBody"></tbody>
                                </table>
                                <div id="locationsEmpty" style="display:none;text-align:center;color:#64748b;padding:.75rem;font-size:.7rem;">No locations for this work area yet.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add Location Modal -->
                <div id="locationModalBackdrop" class="assignment-modal-backdrop" style="display:none;" onclick="onLocationModalBackdropClick(event)">
                    <div class="assignment-modal" role="dialog" aria-modal="true" aria-labelledby="locationModalTitle" onclick="event.stopPropagation()">
                        <header>
                            <h3 id="locationModalTitle" style="margin:0; font-size:.95rem; display:flex; align-items:center; gap:.5rem;"><i class="fas fa-map-marker-alt"></i> Add Location</h3>
                            <button type="button" class="btn-icon" onclick="closeLocationModal()" title="Close"><i class="fas fa-times"></i></button>
                        </header>
                        <div class="body">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label for="locationModalArea" style="font-size:.8rem;font-weight:600;">Work Area</label>
                                    <select id="locationModalArea" style="padding:.5rem;border:1px solid #ced4da;border-radius:6px;"></select>
                                </div>
                                <div class="form-group" style="display:flex;flex-direction:column;gap:.25rem;">
                                    <label for="locationModalName" style="font-size:.8rem;font-weight:600;">Location Name</label>
                                    <input id="locationModalName" type="text" placeholder="e.g. North Gate" style="padding:.5rem;border:1px solid #ced4da;border-radius:6px;" />
                                </div>
                                <div id="locationModalStatus" style="grid-column:1/-1;font-size:.8rem;color:#64748b;display:none;"></div>
                            </div>
                        </div>
                        <footer>
                            <button type="button" class="btn-icon btn-light" onclick="closeLocationModal()">Cancel</button>
                            <button id="locationModalPrimaryBtn" type="button" class="btn-icon btn-primary" onclick="submitNewLocation()">Add Location</button>
                        </footer>
                    </div>
                </div>
                <!-- Maintenance Tab Content -->
                <div class="tab-content" id="maintenanceTabContent">
                    <div class="maintenance-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:.75rem;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:.5rem;flex:1;min-width:240px;">
                            <button id="backToVehiclesBtn" type="button" onclick="backToVehicles()" title="Back to Vehicles" style="display:inline-flex;align-items:center;gap:.4rem;background:#f1f3f5;color:#495057;border:1px solid #ced4da;padding:.4rem .65rem;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;transition:all .2s;">
                                <i class="fas fa-arrow-left" style="font-size:.7rem;"></i>
                                <span>Back to Vehicles</span>
                            </button>
                            <h3 style="margin:0; font-size:1rem; font-weight:600; display:flex; align-items:center; gap:.5rem;"><i class="fas fa-tools"></i> Maintenance & Inspections</h3>
                        </div>
                        <div style="display:flex;align-items:center;gap:.5rem;">
                            <button id="newInspectionBtn" class="btn" style="background:#3498db;color:#fff;font-size:.8rem;padding:.45rem .8rem;border-radius:6px;" onclick="openInspectionModal()"><i class="fas fa-plus"></i> New Inspection</button>
                        </div>
                    </div>
                    <div class="inspection-table-wrapper" style="background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:1rem;">
                        <!-- Jobscreen-like sub-tab navigation for inspections -->
                        <style>
                            /* Scoped styles for inspections sub-tabs (modeled after jobscreen.html) */
                            .inspection-content-tabs { margin-bottom: .75rem; }
                            .inspection-tabs-nav {
                                display: flex;
                                background: #fff;
                                border-radius: 8px;
                                border: 1px solid #e9ecef;
                                overflow: hidden;
                            }
                            .inspection-tab-btn {
                                flex: 1;
                                padding: .6rem 1rem;
                                border: none;
                                background: none;
                                color: #6c757d;
                                font-size: .95rem;
                                font-weight: 500;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: .5rem;
                                transition: all .2s;
                            }
                            .inspection-tab-btn:hover { color: #28a745; background: #f8f9fa; }
                            .inspection-tab-btn.active { color: #fff; background: #28a745; }
                        </style>
                        <div class="inspection-content-tabs">
                            <div class="inspection-tabs-nav">
                                <button class="inspection-tab-btn active" id="inspAllTabBtn" onclick="showAllInspectionsTab()">
                                    <i class="fas fa-list"></i>
                                    All Records
                                </button>
                                <button class="inspection-tab-btn" id="inspVehicleTabBtn" style="display:none;" onclick="showVehicleInspectionsTab()">
                                    <i class="fas fa-car-side"></i>
                                    <span id="inspVehicleTabText">Vehicle</span>
                                </button>
                            </div>
                        </div>
                        <div id="inspectionFilterBar" style="display:none;margin-bottom:.75rem;">
                            <span id="activeInspectionFilter" style="display:inline-flex;align-items:center;gap:.4rem;background:#eef7ff;border:1px solid #cfe7ff;color:#1b6fbf;padding:4px 8px;border-radius:16px;font-size:.8rem;">
                                <i class="fas fa-car-side"></i>
                                <span id="activeInspectionFilterText"></span>
                                <button id="clearInspectionFilterBtn" class="btn" style="padding:2px 6px;font-size:.75rem;background:transparent;color:#1b6fbf;border:none;cursor:pointer;" title="Clear filter">?</button>
                            </span>
                        </div>
                        <div class="table-container fleet-table-container" style="margin-top:.5rem;">
                        <table id="inspectionTable" class="jobs-table fleet-jobs-style" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Vehicle</th>
                                    <th>Odometer</th>
                                    <th>Status</th>
                                    <th>Checks</th>
                                    <th>Severity</th>
                                    <th>Follow-up</th>
                                    <th>Risk</th>
                                    <th>Files</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inspectionTableBody"></tbody>
                        </table>
                        </div>
                        <div id="inspectionEmptyState" style="display:none; text-align:center; padding:1.5rem; color:#666;">
                            <p style="margin:.5rem 0;">No inspections recorded yet.</p>
                            <button id="addFirstInspectionBtn" class="btn" style="background:#3498db;color:#fff;font-size:.75rem;padding:.4rem .7rem;border-radius:6px;" onclick="openInspectionModal()"><i class="fas fa-plus"></i> Add First Inspection</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Vehicle Modal (created dynamically to mirror staff pattern) -->
<script>
// Firebase config reused
const firebaseConfig = { apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain: "users-8be65.firebaseapp.com", databaseURL: "https://users-8be65-default-rtdb.firebaseio.com", projectId: "users-8be65", storageBucket: "users-8be65.firebasestorage.app", messagingSenderId: "909025468149", appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d", measurementId: "G-XHFMRCJQEZ" };
function initializeFirebase(){ if(!window.firebase || !window.firebase.apps || window.firebase.apps.length===0){ window.firebase.initializeApp(firebaseConfig);} return window.firebase; }
initializeFirebase();

// Initialize Firebase Storage
const storage = firebase.storage();
const storageRef = storage.ref();

// Extended AuthManager (subset from staff.html with branding + logout + permissions)
class AuthManager {
    constructor(){ this.firebase = initializeFirebase(); this.currentUser = this.getCurrentUser(); this.db = this.firebase.database(); this.currentCompany=null; if(!this.currentUser){ console.warn('Fleet Auth: no user, guest mode (redirect disabled)'); this.currentUser={ uid:'guest', email:'guest@example.com'}; } this.initializeAuth(); }
  getCurrentUser(){ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
  async initializeAuth(){ 
    await this.loadUserCompany(); 
    await this.updateUIForAuthenticatedUser(); 
    this.setupProfileDropdown(); 
    
    // Initialize menu visibility system using new feature-based authorization
    console.log('?? Initializing menu visibility system...');
    try {
        // Wait a moment for authentication and company context to be fully established
        setTimeout(async () => {
            try {
                await updateMenuWithFeatureAuthorization();
                console.log('? Menu visibility system initialized');
            } catch (authError) {
                console.error('? Menu authorization failed:', authError);
                // Only show basic menu if we're sure there's no authentication
                setTimeout(() => {
                    console.log('?? Final fallback: showing basic menu after failed authorization');
                    showBasicMenu();
                }, 2000); // Give it more time before fallback
            }
        }, 500);
    } catch (menuError) {
        console.warn('?? Could not initialize menu visibility:', menuError);
        // Don't immediately fall back - let the timeout handle it
    }
  }
  setupProfileDropdown(){ const userProfileBtn = document.getElementById('userProfileBtn'); const profileDropdown = document.querySelector('.profile-dropdown'); if (userProfileBtn && profileDropdown) { userProfileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('show'); }); document.addEventListener('click', (e) => { if (!userProfileBtn.contains(e.target)) { profileDropdown.classList.remove('show'); } }); } }
  resetMenuVisibility(){ 
    // Legacy method - now delegated to global two-phase system to prevent conflicts
    console.log('?? Legacy resetMenuVisibility called - delegating to global system');
  }
  async updateMenuVisibility(){ 
    // Legacy method - now delegated to global two-phase system to prevent conflicts
    console.log('?? Legacy updateMenuVisibility called - delegating to global system');
    // Do not manipulate menu here - let the new two-phase system handle it
  }
  async loadUserCompany(){ if(!this.currentUser) return; try { const companiesSnap = await this.db.ref('companies').once('value'); if(!companiesSnap.exists()) return; const companies = companiesSnap.val(); for(const [cid, company] of Object.entries(companies)){ if(company.status!=='active') continue; if(company.users){ for(const [uid, u] of Object.entries(company.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId = cid; this.currentCompany = company; localStorage.setItem('currentUser', JSON.stringify(this.currentUser)); this.applyBranding(); this.loadDynamicLists(); return; } } } } } catch(e){ console.error('Company load error',e); } }
  applyBranding(){ if(!this.currentCompany) return; const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.style.display='block'; } else { logoEl.style.display='none'; } } if(this.currentCompany.branding){ const b=this.currentCompany.branding; const root=document.documentElement; if(b.primaryColor) root.style.setProperty('--primary-color', b.primaryColor); if(b.secondaryColor) root.style.setProperty('--secondary-color', b.secondaryColor); } }
  async loadDynamicLists(){ 
    if(!this.currentCompany) return; 
    const cid = this.currentUser.companyId; 
    try { 
        // Load departments from settings.html field options configuration
        await loadDepartmentsFromSettings(cid);
        
        // Load work areas from settings.html field options configuration
        await loadWorkAreasFromSettings(cid);

                // Load geofences from company scope field options
                await loadGeofencesFromSettings(cid);
        
    populateVehicleSelects(); 
    // Prepare Locations management UI now that siteOptions is ready
    setupWorkAreaLocationsUI();
        
        // Initialize vehicle data loading
        await initializeVehicleData();
        
    } catch(e){ 
        console.warn('Dynamic list load failed', e); 
    } 
  }
  getUserDisplayName(){ if(!this.currentUser) return 'User'; const potential=[this.currentUser.displayName,this.currentUser.fullName,this.currentUser.name,this.currentUser.firstName && this.currentUser.lastName ? `${this.currentUser.firstName} ${this.currentUser.lastName}`:null]; const clean=n=> n && typeof n==='string' ? n.trim():''; for(const n of potential){ const c=clean(n); if(c) return c; } if(this.currentUser.email){ const userPart=this.currentUser.email.split('@')[0]; const c=clean(userPart); if(c) return c; } return 'User'; }
  getUserInitials(){ const name=this.getUserDisplayName(); if(!name || name==='User') return 'U'; const words=name.split(' ').filter(w=>w.length>0); if(words.length===1) return words[0].substring(0,2).toUpperCase(); return words.slice(0,2).map(w=>w[0]).join('').toUpperCase(); }
  getUserEmail(){ return this.currentUser?.email || ''; }
  generateInitialsAvatar(name,img){ if(!img||!name) return; const initials=this.getUserInitials(); const colors=['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c']; const bg=colors[name.length % colors.length]; const svg=`<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="${bg}"/><text x="20" y="25" text-anchor="middle" fill="#fff" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); img.alt=name+' Avatar'; }
  async getUserAvatarUrl(){ if(!this.currentUser) return null; try { const storage=this.firebase.storage(); const path=`avatars/${this.currentUser.uid}/profile.jpg`; const url= await storage.ref(path).getDownloadURL(); return url; } catch(e){ return null; } }
    async updateUIForAuthenticatedUser(){ const profileBtn=document.querySelector('.profile-btn'); const profileImg=profileBtn ? profileBtn.querySelector('img'):null; const profileDropdown=document.querySelector('.profile-dropdown ul'); if(!profileBtn||!profileDropdown||!this.currentUser) return; const initials = this.getUserInitials(); const displayName = this.getUserDisplayName(); const email = this.getUserEmail(); const avatarUrl = await this.getUserAvatarUrl(); if(profileImg){ if(avatarUrl){ profileImg.src=avatarUrl; profileImg.alt=displayName+' Avatar'; } else { this.generateInitialsAvatar(displayName, profileImg); } } let dropdownAvatarHtml; if (avatarUrl) { dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`; } else { dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`; } const userInfoHtml = `<li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;"><div style="display: flex; align-items: center; gap: 12px;">${dropdownAvatarHtml}<div><div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">${displayName}</div><div style="color: #666; font-size: 12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`; profileDropdown.innerHTML = userInfoHtml; const logoutBtn = profileDropdown.querySelector('#logoutLink'); if (logoutBtn) { logoutBtn.addEventListener('click', (e) => { e.preventDefault(); this.logout(); }); } }
  async logout(){ try { await this.firebase.auth().signOut(); } catch(e){ console.warn('Signout issue',e); } localStorage.removeItem('currentUser'); window.location.href='index.html'; }
}
window.authManager = new AuthManager();

// Sidebar toggle (match staff.html behavior: expand content/top bar when collapsed)
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebarMenu');
const mainContent = document.getElementById('mainContent');
const topNav = document.querySelector('.top-nav');
if (sidebarToggle && sidebar && mainContent && topNav) {
    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
        topNav.classList.toggle('sidebar-collapsed');
    });
}

// Departments / Sites placeholder (overridden when dynamic lists load)
let departmentOptions = []; // filled from Firebase company scope
let siteOptions = []; // filled from Firebase company scope
let geofenceOptions = []; // filled from Firebase company scope
let workAreaLocations = {}; // { sanitizedAreaKey: { id: {name}, ... } }
let __selectedSites = []; // currently checked work areas in assignment modal
let __selectedActivities = []; // currently checked activities in assignment modal
let currentLocationsArea = '';
let __locationModalMode = 'add'; // 'add' | 'edit'
let __editingLocation = null;   // { area, id }

// Load work areas from Firebase company scope field options
async function loadWorkAreasFromSettings(companyId) {
    try {
        console.log('?? Loading work areas from Firebase company scope for company:', companyId);
        
        // Priority 1: Try Firebase field options first (company scope)
        let fieldOptionsRef = firebase.database().ref(`companies/${companyId}/fieldOptions/area`);
        
        try {
            const snapshot = await fieldOptionsRef.once('value');
            const firebaseOptions = snapshot.val();
            
            if (firebaseOptions) {
                if (Array.isArray(firebaseOptions)) {
                    siteOptions = firebaseOptions
                        .filter(option => option && option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                } else if (typeof firebaseOptions === 'object') {
                    siteOptions = Object.values(firebaseOptions)
                        .filter(option => option && option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                }
                
                if (siteOptions && siteOptions.length > 0) {
                    console.log('? Work areas loaded from Firebase company scope:', siteOptions);
                    populateAssignmentSiteSelect();
                    return;
                }
            }
        } catch (firebaseError) {
            console.warn('Error loading from Firebase company scope:', firebaseError);
        }
        
        // Priority 2: Try company-specific localStorage (fallback company scope)
        const companyStorageKey = `fieldOptions_${companyId}_area`;
        let savedOptions = localStorage.getItem(companyStorageKey);
        
        if (savedOptions) {
            try {
                const localOptions = JSON.parse(savedOptions);
                if (Array.isArray(localOptions) && localOptions.length > 0) {
                    siteOptions = localOptions
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log('? Work areas loaded from company scope localStorage:', siteOptions);
                    populateAssignmentSiteSelect();
                    return;
                }
            } catch (error) {
                console.warn('Error parsing company scope localStorage area options:', error);
            }
        }
        
        // Priority 3: Try global localStorage (final fallback)
        const globalStorageKey = `fieldOptions_area`;
        savedOptions = localStorage.getItem(globalStorageKey);
        
        if (savedOptions) {
            try {
                const localOptions = JSON.parse(savedOptions);
                if (Array.isArray(localOptions) && localOptions.length > 0) {
                    siteOptions = localOptions
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log('? Work areas loaded from global localStorage:', siteOptions);
                    populateAssignmentSiteSelect();
                    return;
                }
            } catch (error) {
                console.warn('Error parsing global localStorage area options:', error);
            }
        }
        
        // Priority 4: Fallback to legacy Firebase settings location
        fieldOptionsRef = firebase.database().ref(`companies/${companyId}/settings/fieldOptions/area`);
        snapshot = await fieldOptionsRef.once('value');
        
        if (snapshot.exists() && snapshot.val()) {
            const areaOptions = snapshot.val();
            console.log('? Loaded work areas from Firebase field options:', areaOptions);
            
            // Extract enabled area options
            if (Array.isArray(areaOptions)) {
                siteOptions = areaOptions
                    .filter(option => option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log('? Work areas loaded from Firebase settings:', siteOptions);
                
                // Cache to company scope localStorage for future use
                localStorage.setItem(companyStorageKey, JSON.stringify(areaOptions));
                console.log('?? Cached work areas to company scope localStorage');
                populateAssignmentSiteSelect();
                return;
            } else {
                console.warn('?? Area field options is not in expected array format');
            }
        }
        
        // Priority 5: Final fallback to legacy sites location
        console.log('?? No area field options found in company scope, trying legacy sites location...');
        await loadSitesFromLegacyLocation(companyId);
        
    } catch (error) {
        console.error('? Error loading work areas from company scope:', error);
        // Final fallback to legacy site loading method
        await loadSitesFromLegacyLocation(companyId);
    }
}

// Fallback function to load from legacy sites location
async function loadSitesFromLegacyLocation(companyId) {
    try {
        const siteSnap = await firebase.database().ref(`companies/${companyId}/sites`).once('value'); 
        if (siteSnap.exists()) {
            siteOptions = Object.values(siteSnap.val()).map(s => s.name || s).filter(Boolean);
                console.log('?? Work areas loaded from legacy sites location:', siteOptions);
                populateAssignmentSiteSelect();
        }
    } catch (error) {
        console.error('? Error loading from legacy sites location:', error);
    }
}

function populateAssignmentSiteSelect(){
    try {
        const sel = document.getElementById('assignSite');
        const optsContainer = document.getElementById('assignSiteOptions');
        const toggleBtn = document.getElementById('assignSiteToggle');
        const panel = document.getElementById('assignSitePanel');
        const summaryEl = document.getElementById('assignSiteSummary');
        if(!sel) return;
        const opts = ['<option value="">Select site / work area</option>'];
        (siteOptions||[]).forEach(area=>{
            const val = (area && typeof area === 'object') ? (area.value || area.label || area.name || area) : area;
            const label = (area && typeof area === 'object') ? (area.label || area.name || area.value || val) : area;
            if(label) opts.push(`<option value="${escapeHtml(val)}">${escapeHtml(label)}</option>`);
        });
        sel.innerHTML = opts.join('');

        // Build checkbox options for custom multi-select
        if(optsContainer){
            const items = [];
            (siteOptions||[]).forEach((area, idx)=>{
                const val = (area && typeof area === 'object') ? (area.value || area.label || area.name || area) : area;
                const label = (area && typeof area === 'object') ? (area.label || area.name || area.value || val) : area;
                if(!label) return;
                const checked = (__selectedSites||[]).includes(val) ? 'checked' : '';
                const id = `assignSiteChk_${idx}`;
                items.push(
                    `<label for="${id}" style="display:flex;align-items:center;justify-content:flex-start;text-align:left;gap:.5rem;cursor:pointer;padding:.25rem .25rem;border-radius:4px;">
                        <input id="${id}" type="checkbox" class="siteOptionChk" data-value="${escapeHtml(val)}" data-label="${escapeHtml(label)}" ${checked} style="margin:0;" />
                        <span style="text-align:left;">${escapeHtml(label)}</span>
                    </label>`
                );
            });
            optsContainer.innerHTML = items.join('');
            // Ensure left alignment regardless of parent styles
            optsContainer.style.textAlign = 'left';

            // Delegated change handler for checkboxes
            if(!optsContainer.__bound){
                optsContainer.addEventListener('change', async (e)=>{
                    const t = e.target;
                    if(!t || !t.classList || !t.classList.contains('siteOptionChk')) return;
                    const val = t.getAttribute('data-value') || '';
                    if(!val) return;
                    if(t.checked){
                        if(!__selectedSites.includes(val)) __selectedSites.push(val);
                    } else {
                        __selectedSites = __selectedSites.filter(v=> v!==val);
                    }
                    // Keep hidden select in sync with first selection for backward compatibility
                    sel.value = __selectedSites[0] || '';
                    updateAssignSiteSummary();
                    await updateAssignmentGeofenceFromSite();
                });
                optsContainer.__bound = true;
            }
        }

        // Toggle open/close behavior
        if(toggleBtn && panel && !toggleBtn.__bound){
            toggleBtn.addEventListener('click', (e)=>{
                e.stopPropagation();
                const open = panel.style.display === 'block';
                panel.style.display = open ? 'none' : 'block';
                toggleBtn.setAttribute('aria-expanded', open ? 'false' : 'true');
            });
            // Close on outside click
            if(!document.__assignSiteOutsideBound){
                document.addEventListener('click', (e)=>{
                    try{
                        const multi = document.getElementById('assignSiteMulti');
                        if(!multi) return;
                        if(!multi.contains(e.target)){
                            const pnl = document.getElementById('assignSitePanel');
                            const tgl = document.getElementById('assignSiteToggle');
                            if(pnl){ pnl.style.display = 'none'; }
                            if(tgl){ tgl.setAttribute('aria-expanded','false'); }
                        }
                    }catch(_){}
                });
                document.__assignSiteOutsideBound = true;
            }
            toggleBtn.__bound = true;
        }

        // Initial summary
        if(summaryEl){ updateAssignSiteSummary(); }
    }catch(e){ console.warn('populateAssignmentSiteSelect failed', e); }
}

function populateAssignmentActivitiesSelect(){
    try{
        const sel = document.getElementById('assignActivities');
        const optsContainer = document.getElementById('assignActivitiesOptions');
        const toggleBtn = document.getElementById('assignActivitiesToggle');
        const panel = document.getElementById('assignActivitiesPanel');
        const summaryEl = document.getElementById('assignActivitiesSummary');
        if(!sel) return;
        const ACTS = ['Personnel transport','Material transport','Field inspection','Administrative errands'];
        // Build hidden select
        const opts = ['<option value="">Select activities</option>'].concat(ACTS.map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`));
        sel.innerHTML = opts.join('');
        // Build checkbox options
        if(optsContainer){
            optsContainer.innerHTML = ACTS.map((label, idx)=>{
                const val = label;
                const checked = (__selectedActivities||[]).includes(val) ? 'checked' : '';
                const id = `assignActivitiesChk_${idx}`;
                return `<label for="${id}" style="display:flex;align-items:center;justify-content:flex-start;text-align:left;gap:.5rem;cursor:pointer;padding:.25rem .25rem;border-radius:4px;">
                            <input id="${id}" type="checkbox" class="activitiesOptionChk" data-value="${escapeHtml(val)}" data-label="${escapeHtml(label)}" ${checked} style="margin:0;" />
                            <span style="text-align:left;">${escapeHtml(label)}</span>
                        </label>`;
            }).join('');
            if(!optsContainer.__bound){
                optsContainer.addEventListener('change', (e)=>{
                    const t = e.target;
                    if(!t || !t.classList || !t.classList.contains('activitiesOptionChk')) return;
                    const val = t.getAttribute('data-value')||'';
                    if(!val) return;
                    if(t.checked){ if(!__selectedActivities.includes(val)) __selectedActivities.push(val); }
                    else { __selectedActivities = __selectedActivities.filter(v=> v!==val); }
                    sel.value = __selectedActivities[0] || '';
                    updateAssignActivitiesSummary();
                });
                optsContainer.__bound = true;
            }
        }
        // Toggle panel behavior
        if(toggleBtn && panel && !toggleBtn.__bound){
            toggleBtn.addEventListener('click', (e)=>{
                e.stopPropagation();
                const open = panel.style.display === 'block';
                panel.style.display = open ? 'none' : 'block';
                toggleBtn.setAttribute('aria-expanded', open ? 'false' : 'true');
            });
            if(!document.__assignActivitiesOutsideBound){
                document.addEventListener('click', (e)=>{
                    try{
                        const multi = document.getElementById('assignActivitiesMulti');
                        if(!multi) return;
                        if(!multi.contains(e.target)){
                            const pnl = document.getElementById('assignActivitiesPanel');
                            const tgl = document.getElementById('assignActivitiesToggle');
                            if(pnl){ pnl.style.display = 'none'; }
                            if(tgl){ tgl.setAttribute('aria-expanded','false'); }
                        }
                    }catch(_){ }
                });
                document.__assignActivitiesOutsideBound = true;
            }
            toggleBtn.__bound = true;
        }
        if(summaryEl){ updateAssignActivitiesSummary(); }
    }catch(e){ console.warn('populateAssignmentActivitiesSelect failed', e); }
}

function updateAssignActivitiesSummary(){
    try{
        const summaryEl = document.getElementById('assignActivitiesSummary');
        const optsContainer = document.getElementById('assignActivitiesOptions');
        const sel = document.getElementById('assignActivities');
        if(!summaryEl || !optsContainer) return;
        const checked = Array.from(optsContainer.querySelectorAll('input.activitiesOptionChk:checked'));
        if(checked.length===0){ summaryEl.textContent = 'Select activities'; if(sel) sel.value=''; return; }
        if(checked.length===1){
            const lbl = checked[0].getAttribute('data-label') || checked[0].value || '1 selected';
            summaryEl.textContent = lbl;
        } else {
            summaryEl.textContent = `${checked.length} selected`;
        }
    }catch(e){ console.warn('updateAssignActivitiesSummary failed', e); }
}
function updateAssignSiteSummary(){
    try{
        const summaryEl = document.getElementById('assignSiteSummary');
        const optsContainer = document.getElementById('assignSiteOptions');
        const sel = document.getElementById('assignSite');
        if(!summaryEl || !optsContainer) return;
        const checked = Array.from(optsContainer.querySelectorAll('input.siteOptionChk:checked'));
        if(checked.length===0){ summaryEl.textContent = 'Select site / work area'; if(sel) sel.value=''; return; }
        if(checked.length===1){
            const lbl = checked[0].getAttribute('data-label') || checked[0].value || '1 selected';
            summaryEl.textContent = lbl;
        } else {
            summaryEl.textContent = `${checked.length} selected`;
        }
    }catch(e){ console.warn('updateAssignSiteSummary failed', e); }
}

// Load geofences (areas with GPS boundaries) from company scope
async function loadGeofencesFromSettings(companyId){
    try {
        console.log('??? Loading geofences for company:', companyId);
        // Primary location: companies/{companyId}/fieldOptions/geofence
        let ref = firebase.database().ref(`companies/${companyId}/fieldOptions/geofence`);
        try {
            const snap = await ref.once('value');
            const val = snap.val();
            if(val){
                if(Array.isArray(val)){
                    geofenceOptions = val.filter(o=>o && o.enabled!==false).map(o=> o.label||o.name||o.value||o).filter(Boolean);
                }else if(typeof val==='object'){
                    geofenceOptions = Object.values(val).filter(o=>o && o.enabled!==false).map(o=> o.label||o.name||o.value||o).filter(Boolean);
                }
                if(geofenceOptions.length){ console.log('? Geofences loaded (company scope fieldOptions):', geofenceOptions); populateAssignmentGeofenceSelect(); return; }
            }
        }catch(e){ console.warn('Geofence primary load failed', e); }

        // Secondary location: companies/{companyId}/settings/fieldOptions/geofence
        ref = firebase.database().ref(`companies/${companyId}/settings/fieldOptions/geofence`);
        try {
            const snap = await ref.once('value');
            const val = snap.val();
            if(val){
                if(Array.isArray(val)){
                    geofenceOptions = val.filter(o=>o && o.enabled!==false).map(o=> o.label||o.name||o.value||o).filter(Boolean);
                }else if(typeof val==='object'){
                    geofenceOptions = Object.values(val).filter(o=>o && o.enabled!==false).map(o=> o.label||o.name||o.value||o).filter(Boolean);
                }
                if(geofenceOptions.length){ console.log('? Geofences loaded (settings fieldOptions):', geofenceOptions); populateAssignmentGeofenceSelect(); return; }
            }
        }catch(e){ console.warn('Geofence secondary load failed', e); }

        // Legacy location: companies/{companyId}/geofences
        ref = firebase.database().ref(`companies/${companyId}/geofences`);
        try {
            const snap = await ref.once('value');
            const val = snap.val();
            if(val){
                if(Array.isArray(val)){
                    geofenceOptions = val.map(o=> o.label||o.name||o.value||o).filter(Boolean);
                } else if(typeof val==='object'){
                    geofenceOptions = Object.values(val).map(o=> o.label||o.name||o.value||o).filter(Boolean);
                }
                if(geofenceOptions.length){ console.log('? Geofences loaded (legacy geofences):', geofenceOptions); populateAssignmentGeofenceSelect(); return; }
            }
        }catch(e){ console.warn('Geofence legacy load failed', e); }

        console.log('?? No geofences found');
        populateAssignmentGeofenceSelect(); // still ensure select shows default
    }catch(err){ console.error('loadGeofencesFromSettings failed', err); populateAssignmentGeofenceSelect(); }
}

function populateAssignmentGeofenceSelect(){
    try {
        const sel = document.getElementById('assignGeofence');
        if(!sel) return;
        const opts = ['<option value="">Select geofence</option>'];
        (geofenceOptions||[]).forEach(g=>{
            const value = (g && typeof g==='object') ? (g.value||g.id||g.name||g.label||g) : g;
            const label = (g && typeof g==='object') ? (g.label||g.name||g.value||value) : g;
            if(label) opts.push(`<option value="${escapeHtml(value)}">${escapeHtml(label)}</option>`);
        });
        sel.innerHTML = opts.join('');
        updateSelectedGeofenceDisplay();
    }catch(e){ console.warn('populateAssignmentGeofenceSelect failed', e); }
}

// Populate geofence select using locations for the currently selected work area (site)
async function updateAssignmentGeofenceFromSite(){
    try {
        const geoSel = document.getElementById('assignGeofence');
        if(!geoSel) return;
        const selectedAreas = Array.isArray(__selectedSites) ? __selectedSites.slice() : [];
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId){ return; }
        if(!selectedAreas.length){
            geoSel.innerHTML = '<option value="">Select geofence</option>';
            __assignGeofenceSelections = [];
            updateSelectedGeofenceDisplay();
            return;
        }
        // Load any missing areas in parallel
        const uniqueAreas = Array.from(new Set(selectedAreas.filter(Boolean)));
        const missing = uniqueAreas.filter(a=> !workAreaLocations[sanitizeAreaKey(a)]);
        if(missing.length){ await Promise.all(missing.map(a=> loadLocationsForArea(companyId, a))); }
        // Build union of locations across selected areas
        const namesSet = new Set();
        uniqueAreas.forEach(a=>{
            const key = sanitizeAreaKey(a);
            const locs = Object.entries(workAreaLocations[key]||{});
            locs.forEach(([id,obj])=>{ const nm = (obj && obj.name) ? obj.name : id; if(nm) namesSet.add(nm); });
        });
        if(namesSet.size===0){
            geoSel.innerHTML = '<option value="">No locations defined</option>';
            __assignGeofenceSelections = [];
            updateSelectedGeofenceDisplay();
            return;
        }
        const opts = ['<option value="">Select location</option>'];
        Array.from(namesSet).sort((a,b)=> a.localeCompare(b)).forEach(name=>{
            opts.push(`<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`);
        });
        geoSel.innerHTML = opts.join('');
        // Clear previous selections when site changes to avoid cross-site mixing
        __assignGeofenceSelections = [];
        updateSelectedGeofenceDisplay();
    }catch(e){ console.warn('updateAssignmentGeofenceFromSite failed', e); }
}

function updateSelectedGeofenceDisplay(){
    try{
        const wrap = document.getElementById('assignGeofenceSelected');
        const chips = document.getElementById('assignGeofenceChips');
        if(!wrap || !chips) return;
        // Remove duplicates and falsy
        const unique = Array.from(new Set((__assignGeofenceSelections||[]).filter(Boolean)));
        __assignGeofenceSelections = unique;
        if(unique.length===0){ wrap.style.display='none'; chips.innerHTML=''; return; }
        const chipHtml = unique.map(name=>{
            const safe = escapeHtml(name);
            return `<span class="chip" style="display:inline-flex;align-items:center;gap:.35rem;background:#e2e8f0;color:#1f2937;padding:.2rem .45rem;border-radius:999px;">
                        <span>${safe}</span>
                        <button type="button" aria-label="Remove ${safe}" title="Remove" onclick="removeSelectedGeofence('${safe}')" style="background:#fff;border:1px solid #cbd5e1;color:#334155;width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;line-height:0;">
                            &times;
                        </button>
                    </span>`;
        }).join('');
        chips.innerHTML = chipHtml;
        wrap.style.display = 'block';
    }catch(e){ console.warn('updateSelectedGeofenceDisplay failed', e); }
}

function removeSelectedGeofence(name){
    try{
        __assignGeofenceSelections = (__assignGeofenceSelections||[]).filter(n=> n!==name);
        updateSelectedGeofenceDisplay();
    }catch(e){ console.warn('removeSelectedGeofence failed', e); }
}

function onGeofenceSelectChange(){
    try{
        const sel = document.getElementById('assignGeofence');
        if(!sel) return;
        const val = sel.value || '';
        if(val){
            if(!__assignGeofenceSelections.includes(val)) __assignGeofenceSelections.push(val);
            sel.value = '';
            updateSelectedGeofenceDisplay();
        }
    }catch(e){ console.warn('onGeofenceSelectChange failed', e); }
}

// ===== Work Area Locations Management =====
function sanitizeAreaKey(area){
    return (area||'').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
}

async function loadLocationsForArea(companyId, area){
    const key = sanitizeAreaKey(area);
    if(!key) return {};
    try {
        const ref = firebase.database().ref(`companies/${companyId}/workAreaLocations/${key}`);
        const snap = await ref.once('value');
        const data = snap.val()||{};
        workAreaLocations[key] = data;
        return data;
    }catch(e){ console.warn('loadLocationsForArea failed', e); return {}; }
}

async function addLocationToArea(companyId, area, name){
    const key = sanitizeAreaKey(area);
    if(!key || !name) return;
    try {
        const ref = firebase.database().ref(`companies/${companyId}/workAreaLocations/${key}`).push();
        await ref.set({ name, createdAt: new Date().toISOString() });
        if(!workAreaLocations[key]) workAreaLocations[key]={};
        workAreaLocations[key][ref.key] = { name };
        // Refresh the aggregated view so the new location appears immediately
        initializeLocationsTableView();
    }catch(e){ console.error('addLocationToArea failed', e); }
}

async function deleteLocationFromArea(companyId, area, id){
    const key = sanitizeAreaKey(area);
    if(!key || !id) return;
    try {
        const ref = firebase.database().ref(`companies/${companyId}/workAreaLocations/${key}/${id}`);
        await ref.remove();
        if(workAreaLocations[key]) delete workAreaLocations[key][id];
        // Refresh the aggregated view so the table reflects deletion
        initializeLocationsTableView();
    }catch(e){ console.error('deleteLocationFromArea failed', e); }
}

function populateLocationsAreaSelect(){
    const sel = document.getElementById('locationsAreaSelect');
    if(!sel) return;
    const current = sel.value;
    const areas = siteOptions || [];
    sel.innerHTML = '<option value="">Select work area</option>' + areas.map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
    if(current && areas.includes(current)) sel.value = current;
}

function renderLocationsTable(area){
    const tbody = document.getElementById('locationsTableBody');
    const empty = document.getElementById('locationsEmpty');
    if(!tbody || !empty){ return; }
    const entries = Object.entries(workAreaLocations[sanitizeAreaKey(area)] || {});
    if(!entries.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';
    tbody.innerHTML = entries.map(([id,loc],idx)=>`<tr><td>${idx+1}</td><td>${escapeHtml(area)}</td><td>${escapeHtml(loc.name||'-')}</td><td><div style=\"display:flex;gap:.35rem;\"><button type=\"button\" title=\"Edit\" style=\"background:#6c757d;color:#fff;border:none;padding:.3rem .55rem;border-radius:4px;font-size:.65rem;cursor:pointer;\" onclick=\"openEditLocationModal('${escapeHtml(area)}','${id}')\"><i class='fas fa-edit'></i></button><button type=\"button\" title=\"Delete\" style=\"background:#dc3545;color:#fff;border:none;padding:.3rem .55rem;border-radius:4px;font-size:.65rem;cursor:pointer;\" onclick=\"deleteLocationFromArea(window.authManager?.currentUser?.companyId,'${escapeHtml(area)}','${id}')\"><i class='fas fa-trash'></i></button></div></td></tr>`).join('');
}

async function renderAllLocationsTable(){
    const tbody = document.getElementById('locationsTableBody');
    const empty = document.getElementById('locationsEmpty');
    if(!tbody || !empty){ return; }
    const companyId = window.authManager?.currentUser?.companyId;
    const areas = Array.isArray(siteOptions) ? siteOptions : [];
    // Ensure all areas are loaded
    await Promise.all(areas.map(area=> loadLocationsForArea(companyId, area)));
    const rows = [];
    let idx = 0;
    areas.forEach(area=>{
        const key = sanitizeAreaKey(area);
        const entries = Object.entries(workAreaLocations[key] || {});
        entries.forEach(([id,loc])=>{
            rows.push(`<tr><td>${++idx}</td><td>${escapeHtml(area)}</td><td>${escapeHtml(loc.name||'-')}</td><td><div style=\"display:flex;gap:.35rem;\"><button type=\"button\" title=\"Edit\" style=\"background:#6c757d;color:#fff;border:none;padding:.3rem .55rem;border-radius:4px;font-size:.65rem;cursor:pointer;\" onclick=\"openEditLocationModal('${escapeHtml(area)}','${id}')\"><i class='fas fa-edit'></i></button><button type=\"button\" title=\"Delete\" style=\"background:#dc3545;color:#fff;border:none;padding:.3rem .55rem;border-radius:4px;font-size:.65rem;cursor:pointer;\" onclick=\"deleteLocationFromArea(window.authManager?.currentUser?.companyId,'${escapeHtml(area)}','${id}')\"><i class='fas fa-trash'></i></button></div></td></tr>`);
        });
    });
    if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';
    tbody.innerHTML = rows.join('');
}

async function onWorkAreaSelectChange(){
    const areaSel = document.getElementById('locationsAreaSelect');
    const area = areaSel?.value || '';
    const companyId = window.authManager?.currentUser?.companyId;
    if(!companyId || !area) { renderLocationsTable(''); return; }
    await loadLocationsForArea(companyId, area);
    renderLocationsTable(area);
}

function setupWorkAreaLocationsUI(){
    const btn = document.getElementById('addLocationBtn');
    if(btn){
        btn.onclick = openLocationModal;
    }
    initializeLocationsTableView();
}

// ===== Add Location Modal =====
function openLocationModal(){
    try{
        const backdrop = document.getElementById('locationModalBackdrop');
        if(!backdrop) return;
        // Configure modal for add mode by default
        configureLocationModal('add');
        // Populate area select
        populateLocationModalAreaSelect();
        // Default to currently selected work area
        const currentArea = currentLocationsArea || '';
        const areaSel = document.getElementById('locationModalArea');
        if(areaSel && currentArea && Array.from(areaSel.options).some(o=>o.value===currentArea)){
            areaSel.value = currentArea;
        }
        // Reset name input and status
        const nameInput = document.getElementById('locationModalName');
        if(nameInput) nameInput.value = '';
        const status = document.getElementById('locationModalStatus');
        if(status){ status.style.display='none'; status.textContent=''; }
        backdrop.style.display = 'flex';
    }catch(e){ console.warn('openLocationModal failed', e); }
}

function closeLocationModal(){
    const backdrop = document.getElementById('locationModalBackdrop');
    if(backdrop) backdrop.style.display = 'none';
}

function onLocationModalBackdropClick(e){
    if(e && e.target && e.target.id === 'locationModalBackdrop') closeLocationModal();
}

function populateLocationModalAreaSelect(){
    const sel = document.getElementById('locationModalArea');
    if(!sel) return;
    const opts = ['<option value="">Select work area</option>'];
    (siteOptions||[]).forEach(a=>{ opts.push(`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`); });
    sel.innerHTML = opts.join('');
}

async function submitNewLocation(){
    const companyId = window.authManager?.currentUser?.companyId;
    const area = document.getElementById('locationModalArea')?.value || '';
    const name = document.getElementById('locationModalName')?.value?.trim() || '';
    const status = document.getElementById('locationModalStatus');
    if(!companyId){ if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Not authenticated'; } return; }
    if(!area){ if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Please select a work area'; } return; }
    if(!name){ if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Please enter a location name'; } return; }
    try{
        await addLocationToArea(companyId, area, name);
        currentLocationsArea = area;
        try{ localStorage.setItem('fleet.currentLocationsArea', currentLocationsArea); }catch(_){ }
        if(status){ status.style.display='block'; status.style.color='#2e7d32'; status.textContent='Location added'; }
        // If managing current area, refresh table already handled in addLocationToArea
        setTimeout(()=>{ closeLocationModal(); }, 400);
    }catch(err){
        console.error('submitNewLocation failed', err);
        if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Failed to add location'; }
    }
}

// ----- Edit Location support -----
function configureLocationModal(mode, opts){
    __locationModalMode = mode === 'edit' ? 'edit' : 'add';
    if(__locationModalMode === 'edit'){
        __editingLocation = opts && opts.area && opts.id ? { area: opts.area, id: opts.id } : __editingLocation;
    } else {
        __editingLocation = null;
    }
    const title = document.getElementById('locationModalTitle');
    const areaSel = document.getElementById('locationModalArea');
    const primaryBtn = document.getElementById('locationModalPrimaryBtn');
    if(title){ title.innerHTML = __locationModalMode==='edit' ? "<i class=\"fas fa-map-marker-alt\"></i> Edit Location" : "<i class=\"fas fa-map-marker-alt\"></i> Add Location"; }
    if(areaSel){ areaSel.disabled = (__locationModalMode==='edit'); }
    if(primaryBtn){
        primaryBtn.textContent = (__locationModalMode==='edit') ? 'Save Changes' : 'Add Location';
        primaryBtn.onclick = (__locationModalMode==='edit') ? submitEditLocation : submitNewLocation;
    }
}

async function openEditLocationModal(area, id){
    try{
        const backdrop = document.getElementById('locationModalBackdrop');
        if(!backdrop) return;
        // Ensure area options are populated and select the given area
        populateLocationModalAreaSelect();
        const areaSel = document.getElementById('locationModalArea');
        if(areaSel){ areaSel.value = area || ''; }
        // Load current name from cache or DB
        const companyId = window.authManager?.currentUser?.companyId;
        const key = sanitizeAreaKey(area);
        if(companyId && key && !workAreaLocations[key]){
            await loadLocationsForArea(companyId, area);
        }
        const nameInput = document.getElementById('locationModalName');
        const currentName = (workAreaLocations[key] && workAreaLocations[key][id] && workAreaLocations[key][id].name) ? workAreaLocations[key][id].name : '';
        if(nameInput) nameInput.value = currentName;
        const status = document.getElementById('locationModalStatus');
        if(status){ status.style.display='none'; status.textContent=''; }
        // Configure as edit mode and show
        configureLocationModal('edit', { area, id });
        backdrop.style.display = 'flex';
    }catch(e){ console.warn('openEditLocationModal failed', e); }
}

async function submitEditLocation(){
    const companyId = window.authManager?.currentUser?.companyId;
    const areaSel = document.getElementById('locationModalArea');
    const area = __editingLocation?.area || (areaSel?.value || '');
    const id = __editingLocation?.id || '';
    const name = document.getElementById('locationModalName')?.value?.trim() || '';
    const status = document.getElementById('locationModalStatus');
    if(!companyId){ if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Not authenticated'; } return; }
    if(!area || !id){ if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Missing location context'; } return; }
    if(!name){ if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Please enter a location name'; } return; }
    try{
        const key = sanitizeAreaKey(area);
        const ref = firebase.database().ref(`companies/${companyId}/workAreaLocations/${key}/${id}`);
        await ref.update({ name, updatedAt: new Date().toISOString() });
        if(!workAreaLocations[key]) workAreaLocations[key] = {};
        if(!workAreaLocations[key][id]) workAreaLocations[key][id] = {};
        workAreaLocations[key][id].name = name;
        // Refresh aggregated view so changes reflect immediately
        await initializeLocationsTableView();
        // If assignment modal is open and selected site matches, refresh geofence options
        try{
            const selected = Array.isArray(__selectedSites) ? __selectedSites : [];
            if(selected.includes(area)){ await updateAssignmentGeofenceFromSite(); }
        }catch(_){ }
        if(status){ status.style.display='block'; status.style.color='#2e7d32'; status.textContent='Location updated'; }
        setTimeout(()=>{ closeLocationModal(); }, 400);
    }catch(err){
        console.error('submitEditLocation failed', err);
        if(status){ status.style.display='block'; status.style.color='#b36b00'; status.textContent='Failed to update location'; }
    }
}

async function initializeLocationsTableView(){
    try{
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId) return;
        // Default view: show all areas so nothing appears missing
        await renderAllLocationsTable();
    }catch(e){ console.warn('initializeLocationsTableView failed', e); }
}

// Load departments from Firebase company scope field options
async function loadDepartmentsFromSettings(companyId) {
    try {
        console.log('?? Loading departments from Firebase company scope for company:', companyId);
        
        // Priority 1: Try Firebase company scope field options (PRIMARY)
        const fieldOptionsRef = firebase.database().ref(`companies/${companyId}/fieldOptions/department`);
        const snapshot = await fieldOptionsRef.once('value');
        
        if (snapshot.exists() && snapshot.val()) {
            const deptOptions = snapshot.val();
            console.log('? Loaded departments from Firebase company scope:', deptOptions);
            
            // Extract enabled department options from array or object
            if (Array.isArray(deptOptions)) {
                departmentOptions = deptOptions
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log('??? Departments loaded from Firebase company scope:', departmentOptions);
                return;
            } else if (typeof deptOptions === 'object') {
                departmentOptions = Object.values(deptOptions)
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                console.log('??? Departments loaded from Firebase company scope (object):', departmentOptions);
                return;
            } else {
                console.warn('?? Department field options is not in expected array or object format');
            }
        } else {
            console.log('?? No department field options found in Firebase company scope');
        }
        
        // Priority 2: Try secondary Firebase location (backup)
        const settingsFieldOptionsRef = firebase.database().ref(`companies/${companyId}/settings/fieldOptions/department`);
        const settingsSnapshot = await settingsFieldOptionsRef.once('value');
        
        if (settingsSnapshot.exists() && settingsSnapshot.val()) {
            const deptOptions = settingsSnapshot.val();
            console.log('? Loaded departments from Firebase settings company scope:', deptOptions);
            
            if (Array.isArray(deptOptions)) {
                departmentOptions = deptOptions
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log('??? Departments loaded from Firebase settings company scope:', departmentOptions);
                return;
            } else if (typeof deptOptions === 'object') {
                departmentOptions = Object.values(deptOptions)
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                console.log('??? Departments loaded from Firebase settings company scope (object):', departmentOptions);
                return;
            }
        }
        
        // Priority 3: Fallback to legacy departments location
        console.log('?? No department field options found in Firebase company scope, trying legacy departments location...');
        await loadDepartmentsFromLegacyLocation(companyId);
        
    } catch (error) {
        console.error('? Error loading departments from Firebase company scope:', error);
        // Final fallback to legacy department loading method
        await loadDepartmentsFromLegacyLocation(companyId);
    }
}

// Fallback function to load from legacy departments location
async function loadDepartmentsFromLegacyLocation(companyId) {
    try {
        const deptSnap = await firebase.database().ref(`companies/${companyId}/departments`).once('value'); 
        if (deptSnap.exists()) {
            departmentOptions = Object.values(deptSnap.val()).map(d => d.name || d).filter(Boolean);
            console.log('??? Departments loaded from legacy departments location:', departmentOptions);
        }
    } catch (error) {
        console.error('? Error loading from legacy departments location:', error);
    }
}

function openAddVehicleModal(){ showAddVehicleModal(); }

// Permission guard wrappers for vehicle actions
function __fleet_hasActionPerm(key){ const perms=window.__fleet_action_perms||{}; return perms.isAdmin || !!perms[key]; }
const __orig_openAddVehicleModal = openAddVehicleModal;
openAddVehicleModal = function(){ if(!__fleet_hasActionPerm('canAddVehicle')){ window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to add vehicles'}); return; } __orig_openAddVehicleModal(); };

function showAddVehicleModal(){ 
    let modal=document.querySelector('#addVehicleModal'); 
    if(!modal){ 
        modal=createAddVehicleModal(); 
    } 
    modal.classList.add('show'); 
    setTimeout(()=>{ 
        const first=modal.querySelector('input,select,button'); 
        if(first) first.focus(); 
    },50); 
    trapFocus(modal); 
}

function createAddVehicleModal(){ 
    const modal=document.createElement('div'); 
    modal.id='addVehicleModal'; 
    modal.className='modal'; 
    modal.innerHTML = `
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="vehicleModalTitle">
            <div class="modal-header">
                <h5 id="vehicleModalTitle">Add Vehicle</h5>
                <button class="close-btn" type="button" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addVehicleForm" novalidate>
                    <!-- Row 1: Name, Plate Number, Type, Mark, and Model -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="vehicleName">Name *</label>
                            <input type="text" id="vehicleName" required placeholder="Vehicle name/identifier">
                            <div class="error" data-error-for="vehicleName">Vehicle name is required</div>
                        </div>
                        <div class="form-group">
                            <label for="plateNumber">Plate Number *</label>
                            <input type="text" id="plateNumber" required>
                            <div class="error" data-error-for="plateNumber">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleType">Type *</label>
                            <select id="vehicleType" required>
                                <option value="">Select Vehicle Type</option>
                                <!-- Heavy Mining Equipment -->
                                <option value="Haul Truck">Haul Truck</option>
                                <option value="Dump Truck">Dump Truck</option>
                                <option value="Articulated Dump Truck">Articulated Dump Truck</option>
                                <option value="Off-Highway Truck">Off-Highway Truck</option>
                                <option value="Water Truck">Water Truck</option>
                                <option value="Fuel Truck">Fuel Truck</option>
                                <option value="Service Truck">Service Truck</option>
                                <!-- Excavation Equipment -->
                                <option value="Excavator">Excavator</option>
                                <option value="Hydraulic Excavator">Hydraulic Excavator</option>
                                <option value="Mining Excavator">Mining Excavator</option>
                                <option value="Backhoe">Backhoe</option>
                                <option value="Shovel">Shovel</option>
                                <option value="Electric Shovel">Electric Shovel</option>
                                <!-- Loading Equipment -->
                                <option value="Wheel Loader">Wheel Loader</option>
                                <option value="Front-End Loader">Front-End Loader</option>
                                <option value="Payloader">Payloader</option>
                                <option value="Skid Steer">Skid Steer</option>
                                <!-- Earthmoving Equipment -->
                                <option value="Bulldozer">Bulldozer</option>
                                <option value="Dozer">Dozer</option>
                                <option value="Motor Grader">Motor Grader</option>
                                <option value="Scraper">Scraper</option>
                                <option value="Compactor">Compactor</option>
                                <!-- Drilling Equipment -->
                                <option value="Drill Rig">Drill Rig</option>
                                <option value="Blast Hole Drill">Blast Hole Drill</option>
                                <option value="Rotary Drill">Rotary Drill</option>
                                <option value="DTH Drill">DTH Drill</option>
                                <!-- Underground Equipment -->
                                <option value="Locomotive">Locomotive</option>
                                <option value="Underground Truck">Underground Truck</option>
                                <option value="Load-Haul-Dump (LHD)">Load-Haul-Dump (LHD)</option>
                                <option value="Scoop Tram">Scoop Tram</option>
                                <option value="Jumbo">Jumbo</option>
                                <option value="Bolter">Bolter</option>
                                <!-- Support Vehicles -->
                                <option value="Pickup Truck">Pickup Truck</option>
                                <option value="Utility Vehicle">Utility Vehicle</option>
                                <option value="Personnel Carrier">Personnel Carrier</option>
                                <option value="Ambulance">Ambulance</option>
                                <option value="Fire Truck">Fire Truck</option>
                                <option value="Crane">Crane</option>
                                <option value="Mobile Crane">Mobile Crane</option>
                                <option value="Forklift">Forklift</option>
                                <option value="Generator Truck">Generator Truck</option>
                                <option value="Workshop Truck">Workshop Truck</option>
                                <option value="Tire Handler">Tire Handler</option>
                                <!-- Specialized Mining Equipment -->
                                <option value="Conveyor">Conveyor</option>
                                <option value="Crusher">Crusher</option>
                                <option value="Screening Plant">Screening Plant</option>
                                <option value="Wash Plant">Wash Plant</option>
                                <option value="Highwall Miner">Highwall Miner</option>
                                <!-- Other -->
                                <option value="Bus">Bus</option>
                                <option value="Van">Van</option>
                                <option value="ATV/UTV">ATV/UTV</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error" data-error-for="vehicleType">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleMake">Mark *</label>
                            <select id="vehicleMake" required>
                                <option value="">Select Vehicle Mark</option>
                                <!-- Heavy Equipment & Mining Manufacturers -->
                                <option value="Caterpillar">Caterpillar</option>
                                <option value="Komatsu">Komatsu</option>
                                <option value="Liebherr">Liebherr</option>
                                <option value="Hitachi">Hitachi</option>
                                <option value="Volvo">Volvo</option>
                                <option value="John Deere">John Deere</option>
                                <option value="Case">Case</option>
                                <option value="New Holland">New Holland</option>
                                <option value="JCB">JCB</option>
                                <option value="Bobcat">Bobcat</option>
                                <option value="Doosan">Doosan</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="Kobelco">Kobelco</option>
                                <option value="Kubota">Kubota</option>
                                <option value="Terex">Terex</option>
                                <option value="Atlas Copco">Atlas Copco</option>
                                <option value="Sandvik">Sandvik</option>
                                <option value="Epiroc">Epiroc</option>
                                <option value="Joy Global">Joy Global</option>
                                <option value="P&H Mining">P&H Mining</option>
                                <option value="Bucyrus">Bucyrus</option>
                                <option value="Wirtgen">Wirtgen</option>
                                <option value="Bomag">Bomag</option>
                                <option value="Hamm">Hamm</option>
                                <option value="Dynapac">Dynapac</option>
                                <!-- Commercial Truck Manufacturers -->
                                <option value="Mack">Mack</option>
                                <option value="Peterbilt">Peterbilt</option>
                                <option value="Kenworth">Kenworth</option>
                                <option value="Freightliner">Freightliner</option>
                                <option value="International">International</option>
                                <option value="Western Star">Western Star</option>
                                <option value="Volvo Trucks">Volvo Trucks</option>
                                <option value="Scania">Scania</option>
                                <option value="MAN">MAN</option>
                                <option value="Mercedes-Benz">Mercedes-Benz</option>
                                <option value="Iveco">Iveco</option>
                                <option value="DAF">DAF</option>
                                <option value="Renault">Renault</option>
                                <option value="Isuzu">Isuzu</option>
                                <option value="Hino">Hino</option>
                                <option value="UD Trucks">UD Trucks</option>
                                <!-- Automotive Manufacturers -->
                                <option value="Toyota">Toyota</option>
                                <option value="Ford">Ford</option>
                                <option value="Chevrolet">Chevrolet</option>
                                <option value="GMC">GMC</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Ram">Ram</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Honda">Honda</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="Mazda">Mazda</option>
                                <option value="Subaru">Subaru</option>
                                <option value="Jeep">Jeep</option>
                                <option value="Land Rover">Land Rover</option>
                                <option value="BMW">BMW</option>
                                <option value="Audi">Audi</option>
                                <option value="Volkswagen">Volkswagen</option>
                                <!-- Specialty Mining Equipment -->
                                <option value="Bell Equipment">Bell Equipment</option>
                                <option value="Komatsu Mining">Komatsu Mining</option>
                                <option value="Caterpillar Mining">Caterpillar Mining</option>
                                <option value="Liebherr Mining">Liebherr Mining</option>
                                <option value="Hitachi Mining">Hitachi Mining</option>
                                <option value="SANY">SANY</option>
                                <option value="XCMG">XCMG</option>
                                <option value="LiuGong">LiuGong</option>
                                <option value="Lonking">Lonking</option>
                                <option value="SDLG">SDLG</option>
                                <!-- Railway/Locomotive -->
                                <option value="GE Transportation">GE Transportation</option>
                                <option value="EMD">EMD</option>
                                <option value="Wabtec">Wabtec</option>
                                <option value="Siemens">Siemens</option>
                                <option value="Alstom">Alstom</option>
                                <option value="Bombardier">Bombardier</option>
                                <!-- Other/Custom -->
                                <option value="Other">Other</option>
                                <option value="Custom Built">Custom Built</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                            <div class="error" data-error-for="vehicleMake">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleModel">Model *</label>
                            <select id="vehicleModel" required>
                                <option value="">Select Mark first</option>
                            </select>
                            <div class="error" data-error-for="vehicleModel">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleStatus">Status *</label>
                            <select id="vehicleStatus" required>
                                <option value="">Select</option>
                                <option>Active</option>
                                <option>In Maintenance</option>
                                <option>Inactive</option>
                            </select>
                            <div class="error" data-error-for="vehicleStatus">Required</div>
                        </div>
                    </div>
                    
                    <!-- Company Row: Company selector -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companySelect">Company *</label>
                            <select id="companySelect" required>
                                <option value="">Select Company</option>
                            </select>
                            <div class="error" data-error-for="companySelect">Required</div>
                        </div>
                    </div>

                    <!-- Row 2: Department, Site, Fuel Type, Securing Status, and Tank Capacity -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="assignmentDept">Department *</label>
                            <select id="assignmentDept" required></select>
                            <div class="error" data-error-for="assignmentDept">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="siteAssignment">Site *</label>
                            <select id="siteAssignment" required></select>
                            <div class="error" data-error-for="siteAssignment">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="fuelType">Fuel Type *</label>
                            <select id="fuelType" required>
                                <option value="">Select</option>
                                <option>Diesel</option>
                                <option>Gasoline</option>
                                <option>Jet A-1</option>
                                <option>HFO</option>
                            </select>
                            <div class="error" data-error-for="fuelType">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="securingStatus">Securing Status *</label>
                            <select id="securingStatus" required>
                                <option value="">Select</option>
                                <option>Secured</option>
                                <option>Unsecured</option>
                                <option>Unknown</option>
                            </select>
                            <div class="error" data-error-for="securingStatus">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="tankCapacity">Tank *</label>
                            <input type="number" id="tankCapacity" min="0" step="1" required>
                            <div class="error" data-error-for="tankCapacity">Integer >= 0</div>
                        </div>
                    </div>
                    
                    <!-- Row 3: VIN, Year, Mileage, Average Consumption, and Assigned Driver -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="vinNumber">VIN Number</label>
                            <input type="text" id="vinNumber" maxlength="17" placeholder="17-character VIN">
                            <div class="error" data-error-for="vinNumber">Invalid VIN format</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleYear">Year *</label>
                            <input type="number" id="vehicleYear" min="1900" max="2030" required>
                            <div class="error" data-error-for="vehicleYear">Valid year required</div>
                        </div>
                        <div class="form-group">
                            <label for="currentMileage">Current Mileage (km)</label>
                            <input type="number" id="currentMileage" min="0" step="1" placeholder="Current odometer reading">
                            <div class="error" data-error-for="currentMileage">Must be positive number</div>
                        </div>
                        <div class="form-group">
                            <label for="engineSize">Average Consumption</label>
                            <select id="engineSize" required>
                                <option value="">Select consumption unit</option>
                                <option value="L/100Km">L/100Km</option>
                                <option value="L/H">L/H</option>
                            </select>
                            <div class="error" data-error-for="engineSize">Please select consumption unit</div>
                        </div>
                        <div class="form-group">
                            <label for="averageValue">Average</label>
                            <input type="number" id="averageValue" min="0" step="0.1" placeholder="e.g., 8.5">
                            <div class="error" data-error-for="averageValue">Must be positive number</div>
                        </div>
                    </div>
                    
                    <!-- Row 4: Insurance, Registration, Asset Value, Attachment, and Assigned Driver -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="insuranceExpiry">Insurance Expiry</label>
                            <input type="date" id="insuranceExpiry">
                            <div class="error" data-error-for="insuranceExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="registrationExpiry">Registration Expiry</label>
                            <input type="date" id="registrationExpiry">
                            <div class="error" data-error-for="registrationExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="assetValue">Asset Value ($)</label>
                            <input type="number" id="assetValue" min="0" step="0.01" placeholder="Current asset value">
                            <div class="error" data-error-for="assetValue">Must be positive number</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleAttachment">Attachment</label>
                            <input type="file" id="vehicleAttachment" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                            <div class="error" data-error-for="vehicleAttachment">Invalid file type</div>
                        </div>
                        <div class="form-group">
                            <label for="assignedDriver">Assigned Driver</label>
                            <input type="text" id="assignedDriver" placeholder="Driver name">
                            <div class="error" data-error-for="assignedDriver">Invalid driver name</div>
                        </div>
                    </div>
                    
                    <!-- Row 5: Safety Equipment - Radio, GPS, Vignet, First Aid Kit -->
                    <div class="form-row-4">
                        <div class="form-group">
                            <label for="radioStatus">Radio</label>
                            <select id="radioStatus">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Under Repair">Under Repair</option>
                            </select>
                            <div class="error" data-error-for="radioStatus">Invalid radio status</div>
                        </div>
                        <div class="form-group">
                            <label for="gpsStatus">GPS</label>
                            <select id="gpsStatus">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Under Repair">Under Repair</option>
                            </select>
                            <div class="error" data-error-for="gpsStatus">Invalid GPS status</div>
                        </div>
                        <div class="form-group">
                            <label for="vignetDate">Vignet (Date)</label>
                            <input type="date" id="vignetDate">
                            <div class="error" data-error-for="vignetDate">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="firstAidKit">First Aid Kit</label>
                            <select id="firstAidKit">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Expired">Expired</option>
                            </select>
                            <div class="error" data-error-for="firstAidKit">Invalid first aid kit status</div>
                        </div>
                    </div>
                    
                    <!-- Row 6: Safety Equipment Expiry - First Aid Kit Expiry, Extinguisher Status, Extinguisher Expiry, Certificate, Certificate Expiry -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="firstAidKitExpiry">First Aid Kit Expiry</label>
                            <input type="date" id="firstAidKitExpiry">
                            <div class="error" data-error-for="firstAidKitExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="extinguisherStatus">Extinguisher Status</label>
                            <select id="extinguisherStatus">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Under Inspection">Under Inspection</option>
                                <option value="Expired">Expired</option>
                            </select>
                            <div class="error" data-error-for="extinguisherStatus">Invalid extinguisher status</div>
                        </div>
                        <div class="form-group">
                            <label for="extinguisherExpiry">Extinguisher Expiry</label>
                            <input type="date" id="extinguisherExpiry">
                            <div class="error" data-error-for="extinguisherExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="certificateDate">Certificate (Date)</label>
                            <input type="date" id="certificateDate">
                            <div class="error" data-error-for="certificateDate">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="certificateExpiry">Certificate Expiry</label>
                            <input type="date" id="certificateExpiry">
                            <div class="error" data-error-for="certificateExpiry">Invalid date</div>
                        </div>
                    </div>
                    
                    <!-- Row 7: Notes (full width) -->
                    <div class="form-group">
                        <label for="vehicleNotes">Notes</label>
                        <textarea id="vehicleNotes" rows="3" placeholder="Additional notes about the vehicle..."></textarea>
                        <div class="error" data-error-for="vehicleNotes">Notes too long</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="cancel">Cancel</button>
                <button type="submit" class="btn btn-primary" form="addVehicleForm">Save</button>
            </div>
        </div>
    `; 
    document.body.appendChild(modal); 
    const closeBtn=modal.querySelector('.close-btn'); 
    const cancelBtn=modal.querySelector('[data-action="cancel"]'); 
    const form=modal.querySelector('#addVehicleForm'); 
    closeBtn.addEventListener('click',()=>closeVehicleModal()); 
    cancelBtn.addEventListener('click',()=>closeVehicleModal()); 
    form.addEventListener('submit',e=>{ e.preventDefault(); handleVehicleSubmit(form); }); 
    populateVehicleSelects(); 
    populateModelsByMark();
    return modal; 
}

// Create Vehicle Details Modal
function createVehicleDetailsModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'vehicleDetailsModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-car"></i> Vehicle Details</h5>
                <button class="close-btn" onclick="closeVehicleDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="vehicleDetailsContent">
                <!-- Dynamic content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeVehicleDetailsModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportVehicleToPDF()" id="exportPDFBtn">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button type="button" class="btn btn-success" onclick="openFullInspectionModal()" id="openInspectionBtn">
                    <i class="fas fa-clipboard-check"></i> Inspection
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

async function populateVehicleSelects() {
    const user = window.authManager?.currentUser;
    
    if (!user || !user.companyId) {
        console.error('? No user or company ID available for populateVehicleSelects');
        return;
    }

    try {
        // Populate company dropdown with current company (extendable later)
        const compSel = document.getElementById('companySelect');
        if (compSel) {
            const currCompanyId = user.companyId;
            const currCompanyName = window.authManager?.currentCompany?.companyName || 'Current Company';
            compSel.innerHTML = `<option value="">Select Company</option>` +
                `<option value="${currCompanyId}" selected>${currCompanyName}</option>`;
        }

        // Load departments from settings if not already loaded
        if (!departmentOptions || departmentOptions.length === 0) {
            console.log('?? Loading departments from settings...');
            await loadDepartmentsFromSettings(user.companyId);
        }
        
        // Load work areas from settings if not already loaded
        if (!siteOptions || siteOptions.length === 0) {
            console.log('?? Loading work areas from settings...');
            await loadWorkAreasFromSettings(user.companyId);
        }

        // Populate department dropdown with departments from settings
        const deptSel = document.getElementById('assignmentDept');
        if (deptSel) {
            if (departmentOptions && departmentOptions.length > 0) {
                deptSel.innerHTML = '<option value="">Select Department</option>' + 
                    departmentOptions.map(d => `<option value="${d}">${d}</option>`).join('');
                console.log('? Departments loaded in department dropdown:', departmentOptions);
            } else {
                deptSel.innerHTML = '<option value="">No departments configured</option>';
                console.warn('?? No departments found, check settings configuration');
            }
        }

        // Populate site dropdown with work areas from settings
        const siteSel = document.getElementById('siteAssignment');
        if (siteSel) {
            if (siteOptions && siteOptions.length > 0) {
                siteSel.innerHTML = '<option value="">Select Site</option>' + 
                    siteOptions.map(s => `<option value="${s}">${s}</option>`).join('');
                console.log('? Work areas loaded in site dropdown:', siteOptions);
            } else {
                siteSel.innerHTML = '<option value="">No work areas configured</option>';
                console.warn('?? No work areas found, check settings configuration');
            }
        }
    } catch (error) {
        console.error('? Error in populateVehicleSelects:', error);
        // Fallback to original behavior if there's an error
        const siteSel = document.getElementById('siteAssignment');
        if (siteSel && siteOptions) {
            siteSel.innerHTML = '<option value="">Select</option>' + 
                siteOptions.map(s => `<option>${s}</option>`).join('');
        }
    }
}

// Vehicle models mapping by manufacturer
const vehicleModels = {
    "Caterpillar": ["777F", "789C", "793F", "797F", "MT4400D", "MT5300D", "336", "349", "374", "390", "6020B", "7495", "980M", "988K", "993K", "994K", "D6", "D8", "D9", "D10", "D11", "16M", "24M", "777G", "785C", "789D", "793D", "797B", "830M", "836K", "844K", "854K", "966M", "972M", "980K", "988H"],
    "Komatsu": ["930E", "960E", "980E", "HD785", "HD1500", "HD605", "PC1250", "PC2000", "PC3000", "PC4000", "PC5500", "PC8000", "WA380", "WA470", "WA500", "WA600", "WA700", "WA800", "WA900", "D155", "D275", "D375", "D475", "D575", "D655", "D85", "D155A", "GD655", "GD825"],
    "Liebherr": ["T236", "T264", "T274", "T282B", "T284", "R9150", "R9200", "R9250", "R9350", "R9400", "R9800", "L550", "L566", "L580", "L586", "PR734", "PR744", "PR754", "PR764", "PR776"],
    "Hitachi": ["EH1100", "EH1700", "EH3500", "EH4000", "EH5000", "EX1200", "EX2500", "EX3600", "EX5500", "EX8000", "ZW220", "ZW310", "ZW370", "ZW550", "ZW370-6"],
    "Volvo": ["A25G", "A30G", "A35G", "A40G", "A45G", "A60H", "R100E", "R70D", "EC380E", "EC480E", "EC750E", "EC950E", "L120H", "L150H", "L180H", "L220H", "L260H", "G940", "G946", "G960", "G970", "G990"],
    "John Deere": ["310SL", "315SL", "350G", "370E", "410E", "460E", "550K", "650K", "750K", "850K", "950K", "1050K", "624K", "644K", "724K", "744K", "824K", "844K", "872G", "970G"],
    "Toyota": ["Hilux", "Land Cruiser", "Hiace", "Coaster", "Dyna", "Prado", "4Runner", "Tacoma", "Tundra", "Sequoia", "Sienna", "Camry", "Corolla", "RAV4", "Highlander"],
    "Ford": ["F-150", "F-250", "F-350", "F-450", "F-550", "Ranger", "Transit", "E-Series", "Explorer", "Expedition", "Escape", "Edge", "Bronco", "Mustang", "Focus"],
    "Chevrolet": ["Silverado 1500", "Silverado 2500", "Silverado 3500", "Colorado", "Express", "Suburban", "Tahoe", "Traverse", "Equinox", "Malibu", "Cruze", "Camaro"],
    "Mack": ["Granite", "TerraPro", "LR", "LEU", "MRU", "Anthem", "Pinnacle", "Titan", "Trident", "MP7", "MP8", "MP10"],
    "Peterbilt": ["367", "378", "379", "386", "387", "388", "389", "520", "567", "579", "320", "330", "337", "348"],
    "Kenworth": ["T680", "T880", "W900", "T370", "T470", "T800", "C500", "T408SAR", "T909", "T610", "T659"],
    "Freightliner": ["Cascadia", "Century Class", "Columbia", "Coronado", "Argosy", "FLD120", "M2 106", "114SD", "Condor"],
    "Mercedes-Benz": ["Actros", "Arocs", "Atego", "Axor", "Econic", "Sprinter", "Vito", "Metris", "G-Class", "Unimog"],
    "Scania": ["R-Series", "S-Series", "P-Series", "G-Series", "L-Series", "XT-Series", "R730", "R770", "S730", "S770"],
    "Volvo Trucks": ["FH", "FM", "FMX", "FL", "FE", "VNL", "VNR", "VHD", "VAH", "VNX"],
    "Isuzu": ["D-Max", "MU-X", "NPR", "NQR", "FRR", "FVR", "GXR", "CXZ", "EXR", "FXR"],
    "Hino": ["300 Series", "500 Series", "700 Series", "Dutro", "Ranger", "Profia"],
    "International": ["HX Series", "LT Series", "RH Series", "HV Series", "CV Series", "MV Series", "DuraStar", "WorkStar", "TranStar"],
    "Western Star": ["4700", "4800", "4900", "5700", "6900"],
    "Bobcat": ["S70", "S450", "S510", "S530", "S550", "S570", "S590", "S630", "S650", "S740", "S750", "S770", "S850", "T450", "T550", "T590", "T630", "T650", "T740", "T770", "T870"],
    "JCB": ["3CX", "4CX", "5CX", "JS130", "JS160", "JS200", "JS220", "JS330", "435S", "444", "456", "467", "531-70", "540-140", "540-170", "541-70"],
    "Case": ["580N", "590SN", "695SN", "770EX", "870", "970", "1070", "1170", "CX130D", "CX160D", "CX210D", "CX245D", "CX290D", "CX350D", "CX470D", "CX490D"],
    "New Holland": ["B90B", "B95B", "B110B", "B115B", "E145", "E175", "E215", "E245", "E305", "C227", "C232", "C238", "L213", "L216", "L218", "L220", "L223", "L225", "L230"],
    "Hyundai": ["R140LC", "R160LC", "R180LC", "R210LC", "R260LC", "R300LC", "R380LC", "R450LC", "R520LC", "HL730", "HL740", "HL757", "HL760", "HL770", "HL780"],
    "Doosan": ["DX140", "DX160", "DX180", "DX190", "DX225", "DX255", "DX300", "DX340", "DX380", "DX420", "DX480", "DX520", "DL200", "DL220", "DL250", "DL300", "DL420", "DL450"],
    "Atlas Copco": ["Boomer E1", "Boomer E2", "Boomer M2", "Boomer S1", "Boomer S2", "Boomer XE3", "Rocket Boomer", "Simba M4", "Simba M6", "Simba W6", "Simba W7"],
    "Sandvik": ["DD320", "DD421", "DD422", "DL330", "DL431", "DL432", "LH209", "LH307", "LH410", "LH514", "LH517", "LH621", "TH320", "TH430", "TH540", "TH545", "TH663"],
    "Epiroc": ["Boomer E1", "Boomer E2", "Boomer M2", "Boomer S1", "Boomer S2", "Boomer XE3", "Minetruck MT42", "Minetruck MT65", "Scooptram ST14", "Scooptram ST18"],
    "SANY": ["SY75C", "SY135C", "SY215C", "SY235C", "SY335C", "SY365C", "SY385H", "SY465H", "SY485H", "SY500H", "SY750H", "SY850H"],
    "XCMG": ["XE75DA", "XE135B", "XE200DA", "XE215DA", "XE270DK", "XE335DK", "XE370DK", "XE490DK", "XE700DK", "XE950E", "LW300KN", "LW500KN", "LW600KN"],
    "Bell Equipment": ["B20E", "B25E", "B30E", "B35E", "B40E", "B45E", "B50E", "L1206E", "L1306E", "L1406E", "L1506E", "L1806E", "L2106E"],
    "Terex": ["TA250", "TA300", "TA400", "TR35", "TR40", "TR45", "TR50", "TR60", "TR100", "RH120", "RH170", "RH200", "RH340", "RH400"],
    "Wirtgen": ["W35DC", "W50DC", "W100H", "W120H", "W150", "W200H", "W210", "2100DC", "2200SM", "3800CR"],
    "Other": ["Custom Model", "Unknown Model", "Prototype", "Modified", "Legacy Model"]
};

// Function to populate model dropdown based on selected mark
function populateModelsByMark() {
    const markSelect = document.getElementById('vehicleMake');
    const modelSelect = document.getElementById('vehicleModel');
    
    if (!markSelect || !modelSelect) return;
    
    markSelect.addEventListener('change', function() {
        const selectedMark = this.value;
        
        // Clear existing options
        modelSelect.innerHTML = '';
        
        if (!selectedMark) {
            modelSelect.innerHTML = '<option value="">Select Mark first</option>';
            modelSelect.disabled = true;
            return;
        }
        
        // Enable model dropdown
        modelSelect.disabled = false;
        
        // Add default option
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        
        // Get models for selected mark
        const models = vehicleModels[selectedMark] || [];
        
        if (models.length === 0) {
            modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
        } else {
            // Add all models for the selected mark
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // Add "Other" option at the end
            modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
        }
    });
}

function updateModelsForMake(selectedMark) {
    const modelSelect = document.getElementById('vehicleModel');
    
    if (!modelSelect || !selectedMark) return;
    
    // Clear existing options
    modelSelect.innerHTML = '';
    
    // Enable model dropdown
    modelSelect.disabled = false;
    
    // Add default option
    modelSelect.innerHTML = '<option value="">Select Model</option>';
    
    // Get models for selected mark
    const models = vehicleModels[selectedMark] || [];
    
    if (models.length === 0) {
        modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
    } else {
        // Add all models for the selected mark
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
        });
        
        // Add "Other" option at the end
        modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
    }
}

function closeVehicleModal(){ 
    const modal=document.getElementById('addVehicleModal'); 
    if(!modal) return; 
    
    // Reset edit mode attributes
    modal.removeAttribute('data-edit-mode');
    modal.removeAttribute('data-vehicle-id');
    
    // Reset modal title and button text
    const modalTitle = modal.querySelector('.modal-header h5');
    if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-plus"></i> Add New Vehicle';
    }
    
    const submitBtn = modal.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.textContent = 'Save';
    }
    
    modal.classList.remove('show'); 
    const focusTarget = document.getElementById('addVehicleHeaderBtn') || document.getElementById('addVehicleFab');
    if (focusTarget) focusTarget.focus();
}

function validateField(field) {
    const error = document.querySelector(`.error[data-error-for="${field.id}"]`);
    let value = field.value.trim();
    let valid = true;
    
    // Required field validation
    if (field.required && !value) {
        valid = false;
    }
    
    // Field-specific validations
    if (valid && value) {
        switch (field.id) {
            case 'vehicleName':
                if (value && value.length < 2) valid = false;
                break;
                
            case 'tankCapacity':
            case 'currentMileage':
                const intNum = Number(value);
                if (!Number.isInteger(intNum) || intNum < 0) valid = false;
                break;
                
            case 'engineSize':
                // Now a dropdown for consumption unit, just check if selected
                if (!value || (value !== 'L/100Km' && value !== 'L/H')) valid = false;
                break;
                
            case 'assetValue':
                const floatNum = Number(value);
                if (isNaN(floatNum) || floatNum < 0) valid = false;
                break;
                
            case 'vehicleYear':
                const year = Number(value);
                const currentYear = new Date().getFullYear();
                if (!Number.isInteger(year) || year < 1900 || year > currentYear + 10) valid = false;
                break;
                
            case 'vinNumber':
                if (value && !/^[A-HJ-NPR-Z0-9]{17}$/i.test(value)) valid = false;
                break;
                
            case 'plateNumber':
                if (valid) field.value = value.toUpperCase();
                break;
                
            case 'vehicleMake':
            case 'assignedDriver':
                if (value && value.length < 2) valid = false;
                break;
                
            case 'averageValue':
                if (value && (isNaN(value) || parseFloat(value) <= 0)) valid = false;
                break;
                
            case 'insuranceExpiry':
            case 'registrationExpiry':
                if (value && !isValidDate(value)) valid = false;
                break;
                
            case 'vehicleAttachment':
                if (value) {
                    const allowedTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif'];
                    const fileExtension = value.toLowerCase().substring(value.lastIndexOf('.'));
                    if (!allowedTypes.includes(fileExtension)) valid = false;
                }
                break;
                
            case 'vehicleNotes':
                if (value && value.length > 500) valid = false;
                break;
        }
    }
    
    // Update UI
    if (!valid) {
        field.classList.add('invalid');
        if (error) error.style.display = 'block';
    } else {
        field.classList.remove('invalid');
        if (error) error.style.display = 'none';
    }
    
    return valid;
}

function isValidDate(dateString) {
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

function handleVehicleSubmit(form) {
    // All field IDs including new standard fields
    const requiredIds = ['vehicleName', 'plateNumber', 'vehicleType', 'vehicleModel', 'vehicleStatus', 'assignmentDept', 'siteAssignment', 'fuelType', 'securingStatus', 'tankCapacity', 'vehicleMake', 'vehicleYear', 'companySelect'];
    const optionalIds = ['vinNumber', 'currentMileage', 'engineSize', 'averageValue', 'assignedDriver', 'insuranceExpiry', 'registrationExpiry', 'assetValue', 'vehicleAttachment', 'vehicleNotes', 'radioStatus', 'gpsStatus', 'vignetDate', 'firstAidKit', 'firstAidKitExpiry', 'extinguisherStatus', 'extinguisherExpiry'];
    
    // Validate all fields
    const allFields = [...requiredIds, ...optionalIds].map(id => form.querySelector('#' + id)).filter(Boolean);
    const allValid = allFields.map(validateField).every(v => v);
    
    if (!allValid) {
        showNotification('Please correct the highlighted errors before saving.', 'warning');
        return;
    }
    
    // Collect form data (excluding file input which is handled separately)
    const vehicleData = {};
    allFields.forEach(field => {
        // Skip file input fields as they're handled separately in save functions
        if (field.type === 'file') {
            return;
        }
        
        if (field.value.trim()) {
            vehicleData[field.id] = field.value.trim();
        }
    });

    // Normalize keys for backward/forward compatibility
    if (vehicleData.assignmentDept) {
        vehicleData.department = vehicleData.assignmentDept; // legacy/alt key
        vehicleData.assignmentDepartment = vehicleData.assignmentDept; // alt naming
    }
    if (vehicleData.siteAssignment) {
        vehicleData.site = vehicleData.siteAssignment; // legacy/alt key
        vehicleData.workArea = vehicleData.siteAssignment; // alt naming from settings
    }
    // Company selection normalization (store both id and name)
    if (vehicleData.companySelect) {
        const compEl = document.getElementById('companySelect');
        const selectedOption = compEl ? compEl.options[compEl.selectedIndex] : null;
        vehicleData.selectedCompanyId = vehicleData.companySelect;
        vehicleData.selectedCompanyName = selectedOption ? selectedOption.textContent : (window.authManager?.currentCompany?.companyName || '');
    }
    
    // Check if we're in edit mode
    const modal = document.getElementById('addVehicleModal');
    const isEditMode = modal && modal.getAttribute('data-edit-mode') === 'true';
    const vehicleId = modal ? modal.getAttribute('data-vehicle-id') : null;
    
    if (isEditMode && vehicleId) {
        // Update existing vehicle
        updateVehicleInFirebase(vehicleData, vehicleId);
    } else {
        // Add new vehicle
        addVehicleRow(vehicleData);
    }
}

function addVehicleRow(data) {
    // Save to Firebase first
    saveVehicleToFirebase(data);
}

// Upload file to Firebase Storage
async function uploadFileToFirebaseStorage(file, vehicleId, companyId) {
    if (!file) return null;
    
    try {
        console.log('?? Uploading file to Firebase Storage:', file.name);
        
        // Create a unique file path: companies/companyId/vehicles/vehicleId/attachments/filename
        const fileName = `${Date.now()}_${file.name}`;
        const filePath = `companies/${companyId}/vehicles/${vehicleId}/attachments/${fileName}`;
        const fileRef = storageRef.child(filePath);
        
        // Show upload progress
        const uploadTask = fileRef.put(file);
        
        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Track upload progress
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(`?? Upload progress: ${progress.toFixed(1)}%`);
                    
                    // Update UI with progress (you can add a progress bar here)
                    showNotification(`Uploading: ${progress.toFixed(1)}%`, 'info');
                },
                (error) => {
                    console.error('? Upload failed:', error);
                    showNotification('File upload failed', 'error');
                    reject(error);
                },
                async () => {
                    // Upload completed successfully, get download URL
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        console.log('? File uploaded successfully. Download URL:', downloadURL);
                        
                        // Store file metadata
                        const fileMetadata = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            uploadDate: new Date().toISOString(),
                            downloadURL: downloadURL,
                            storagePath: filePath
                        };
                        
                        showNotification('File uploaded successfully', 'success');
                        resolve(fileMetadata);
                    } catch (error) {
                        console.error('? Error getting download URL:', error);
                        reject(error);
                    }
                }
            );
        });
    } catch (error) {
        console.error('? Error uploading file:', error);
        showNotification('File upload failed', 'error');
        throw error;
    }
}

async function saveVehicleToFirebase(vehicleData) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            console.error('? No company context available for saving vehicle');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        
        // Generate unique vehicle ID
        const vehicleRef = database.ref(`companies/${companyId}/vehicles`).push();
        const vehicleId = vehicleRef.key;
        
        // Handle file upload if there's an attachment
        let attachmentMetadata = null;
        const fileInput = document.getElementById('vehicleAttachment');
        if (fileInput && fileInput.files && fileInput.files[0]) {
            try {
                console.log('?? Processing attachment upload...');
                attachmentMetadata = await uploadFileToFirebaseStorage(fileInput.files[0], vehicleId, companyId);
            } catch (uploadError) {
                console.error('? File upload failed:', uploadError);
                showNotification('Vehicle saved but file upload failed', 'warning');
            }
        }
        
        // Prepare vehicle data with metadata
        const vehicleRecord = {
            ...vehicleData,
            id: vehicleId,
            createdAt: new Date().toISOString(),
            createdBy: window.authManager.currentUser.uid,
            updatedAt: new Date().toISOString(),
            status: vehicleData.vehicleStatus || 'Active',
            // Store attachment metadata instead of local path
            vehicleAttachment: attachmentMetadata ? attachmentMetadata.downloadURL : null,
            attachmentMetadata: attachmentMetadata
        };
        
        // Save to Firebase
        await vehicleRef.set(vehicleRecord);
        
        console.log('? Vehicle saved successfully:', vehicleId);
        showNotification('Vehicle saved successfully', 'success');
        
        // Clear the form
        clearVehicleForm();
        
        // Close modal
        closeModal('addVehicleModal');
        
    } catch (error) {
        console.error('? Error saving vehicle to Firebase:', error);
        // Show user-friendly error message
        showNotification('Error saving vehicle. Please try again.', 'error');
    }
}

async function updateVehicleInFirebase(vehicleData, vehicleId) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            showNotification('Authentication required to update vehicle', 'error');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehicleRef = database.ref(`companies/${companyId}/vehicles/${vehicleId}`);
        
        console.log('?? Updating vehicle in Firebase:', vehicleId);
        
        // Handle file upload if there's a new attachment
        let attachmentMetadata = null;
        const fileInput = document.getElementById('vehicleAttachment');
        if (fileInput && fileInput.files && fileInput.files[0]) {
            try {
                console.log('?? Processing new attachment upload...');
                attachmentMetadata = await uploadFileToFirebaseStorage(fileInput.files[0], vehicleId, companyId);
            } catch (uploadError) {
                console.error('? File upload failed during update:', uploadError);
                showNotification('Vehicle updated but file upload failed', 'warning');
            }
        }
        
        // Prepare updated vehicle data with metadata
        const updatedVehicleData = {
            ...vehicleData,
            id: vehicleId,
            updatedAt: new Date().toISOString(),
            updatedBy: window.authManager.currentUser.uid,
            status: vehicleData.vehicleStatus || 'Active'
        };

        // Normalize keys for backward/forward compatibility
        if (updatedVehicleData.assignmentDept) {
            updatedVehicleData.department = updatedVehicleData.assignmentDept;
            updatedVehicleData.assignmentDepartment = updatedVehicleData.assignmentDept;
        }
        if (updatedVehicleData.siteAssignment) {
            updatedVehicleData.site = updatedVehicleData.siteAssignment;
            updatedVehicleData.workArea = updatedVehicleData.siteAssignment;
        }
        
        // Only update attachment if a new file was uploaded
        if (attachmentMetadata) {
            updatedVehicleData.vehicleAttachment = attachmentMetadata.downloadURL;
            updatedVehicleData.attachmentMetadata = attachmentMetadata;
        }
        
        // Update in Firebase (this will trigger real-time listeners)
        await vehicleRef.update(updatedVehicleData);
        
        console.log('? Vehicle updated successfully:', vehicleId);
        showNotification('Vehicle updated successfully', 'success');
        
        // Clear the form and close modal
        clearVehicleForm();
        closeModal('addVehicleModal');
        
    } catch (error) {
        console.error('? Error updating vehicle in Firebase:', error);
        showNotification('Error updating vehicle. Please try again.', 'error');
    }
}

function clearVehicleForm() {
    const form = document.getElementById('addVehicleForm');
    if (form) {
        form.reset();
        
        // Clear any error states
        const errorElements = form.querySelectorAll('.error.show');
        errorElements.forEach(error => {
            error.classList.remove('show');
        });
        
        // Remove any current attachment info
        const attachmentInfos = form.querySelectorAll('.current-attachment-info');
        attachmentInfos.forEach(info => info.remove());
        
        // Reset modal to add mode
        const modal = document.getElementById('addVehicleModal');
        if (modal) {
            modal.removeAttribute('data-edit-mode');
            modal.removeAttribute('data-vehicle-id');
            
            // Reset modal title
            const modalTitle = modal.querySelector('.modal-header h5');
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-plus"></i> Add New Vehicle';
            }
            
            // Reset submit button text
            const submitBtn = modal.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Save Vehicle';
            }
        }
        
        // Repopulate dropdowns
        populateVehicleSelects();
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
    }
}

function displayVehicleInTable(vehicleData, vehicleId) {
    const tbody = document.getElementById('vehicleTableBody');
    
    // Check if vehicle already exists in table
    const existingRow = tbody.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
    if (existingRow) {
        // Update existing row
        updateVehicleRow(existingRow, vehicleData, vehicleId);
        return;
    }
    
    // Create new row
    const row = document.createElement('tr');
    const idx = tbody.children.length + 1;
    
    row.setAttribute('data-vehicle-id', vehicleId);
    row.setAttribute('data-vehicle-info', JSON.stringify(vehicleData));
    
    // Use original table columns for compatibility
    row.innerHTML = `
        <td>${idx}</td>
        <td class="vehicle-name-cell" style="color:#3498db;text-decoration:underline;cursor:pointer;" onclick="event.stopPropagation(); showVehicleInspections('${vehicleId}')" title="View inspections for this vehicle">${vehicleData.vehicleName || vehicleData.name || ''}</td>
        <td>${vehicleData.plateNumber || ''}</td>
        <td>${vehicleData.vehicleType || ''}</td>
        <td>${vehicleData.vehicleModel || ''}</td>
        <td>${vehicleData.vehicleStatus || vehicleData.status || ''}</td>
    <td>${vehicleData.assignmentDept || vehicleData.assignmentDepartment || vehicleData.department || ''}</td>
    <td>${vehicleData.siteAssignment || vehicleData.workArea || vehicleData.site || ''}</td>
        <td>${vehicleData.fuelType || ''}</td>
        <td>${vehicleData.securingStatus || ''}</td>
        <td>${vehicleData.tankCapacity || ''}</td>
        <td class="actions-cell">
            <div class="action-buttons">
                <button class="btn-action btn-edit" onclick="editVehicleFromTable('${vehicleId}')" title="Edit Vehicle">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-action btn-delete" onclick="deleteVehicle('${vehicleId}')" title="Delete Vehicle">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    // Add click event listener for vehicle details
    row.addEventListener('click', function(event) {
        // Prevent row click when clicking on interactive elements
        if (!event.target.closest('input') && 
            !event.target.closest('.action-buttons') && 
            !event.target.closest('button') &&
            !event.target.closest('.vehicle-name-cell')) {
            openVehicleDetailsModal(vehicleId);
        }
    });
    
    // Mark as having click listener and add styling
    row.setAttribute('data-click-listener', 'true');
    row.title = 'Click to view vehicle details';
    row.style.cursor = 'pointer';
    
    tbody.appendChild(row);
    updateEmptyState();
}

function updateVehicleRow(row, vehicleData, vehicleId) {
    row.setAttribute('data-vehicle-info', JSON.stringify(vehicleData));
    
    const cells = row.querySelectorAll('td');
    if (cells.length >= 12) {
    // Ensure name cell retains click behavior
    const nameHtml = `${vehicleData.vehicleName || vehicleData.name || ''}`;
    cells[1].innerHTML = `<span class="vehicle-name-cell" style="color:#3498db;text-decoration:underline;cursor:pointer;" onclick="event.stopPropagation(); showVehicleInspections('${vehicleId}')" title="View inspections for this vehicle">${nameHtml}</span>`;
        cells[2].textContent = vehicleData.plateNumber || '';
        cells[3].textContent = vehicleData.vehicleType || '';
        cells[4].textContent = vehicleData.vehicleModel || '';
        cells[5].textContent = vehicleData.vehicleStatus || vehicleData.status || '';
    cells[6].textContent = vehicleData.assignmentDept || vehicleData.assignmentDepartment || vehicleData.department || '';
    cells[7].textContent = vehicleData.siteAssignment || vehicleData.workArea || vehicleData.site || '';
        cells[8].textContent = vehicleData.fuelType || '';
        cells[9].textContent = vehicleData.securingStatus || '';
        cells[10].textContent = vehicleData.tankCapacity || '';
        
        // Update actions column if it doesn't exist
        if (!cells[11].querySelector('.action-buttons')) {
            cells[11].className = 'actions-cell';
            cells[11].innerHTML = `
                <div class="action-buttons">
                    <button class="btn-action btn-edit" onclick="editVehicleFromTable('${vehicleId}')" title="Edit Vehicle">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action btn-view" onclick="openVehicleDetailsModal('${vehicleId}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteVehicle('${vehicleId}')" title="Delete Vehicle">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
    }
    
    // Ensure click event listener exists
    if (!row.hasAttribute('data-click-listener')) {
        row.addEventListener('click', function(event) {
            if (!event.target.closest('input') && 
                !event.target.closest('.action-buttons') && 
                !event.target.closest('button') &&
                !event.target.closest('.vehicle-name-cell')) {
                openVehicleDetailsModal(vehicleId);
            }
        });
        row.setAttribute('data-click-listener', 'true');
        row.title = 'Click to view vehicle details';
        row.style.cursor = 'pointer';
    }
}

function updateEmptyState(){ 
    const tbody=document.getElementById('vehicleTableBody'); 
    const empty=document.getElementById('vehicleEmptyState'); 
    if(!empty) return; 
    if(tbody.rows.length===0){ 
        empty.style.display='block'; 
    } else { 
        empty.style.display='none'; 
    } 
}

// Real-time vehicle data loading and listening
async function initializeVehicleData() {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            console.log('? Waiting for authentication...');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehiclesRef = database.ref(`companies/${companyId}/vehicles`);
        
        console.log('?? Setting up real-time vehicle data for company:', companyId);
        
        // Listen for vehicle changes in real-time
        vehiclesRef.on('child_added', (snapshot) => {
            const vehicleData = snapshot.val();
            const vehicleId = snapshot.key;
            console.log('? Vehicle added:', vehicleId, vehicleData);
            displayVehicleInTable(vehicleData, vehicleId);
        });
        
        vehiclesRef.on('child_changed', (snapshot) => {
            const vehicleData = snapshot.val();
            const vehicleId = snapshot.key;
            console.log('?? Vehicle updated:', vehicleId, vehicleData);
            displayVehicleInTable(vehicleData, vehicleId);
        });
        
        vehiclesRef.on('child_removed', (snapshot) => {
            const vehicleId = snapshot.key;
            console.log('??? Vehicle removed:', vehicleId);
            removeVehicleFromTable(vehicleId);
        });
        
        console.log('? Real-time vehicle listeners established');
        
    } catch (error) {
        console.error('? Error setting up vehicle data:', error);
    }
}

function removeVehicleFromTable(vehicleId) {
    const tbody = document.getElementById('vehicleTableBody');
    const row = tbody.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
    if (row) {
        row.remove();
        // Re-number the remaining rows
        renumberTableRows();
        updateEmptyState();
    }
}

function renumberTableRows() {
    const tbody = document.getElementById('vehicleTableBody');
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const firstCell = row.querySelector('td');
        if (firstCell) {
            firstCell.textContent = index + 1;
        }
    });
}

// Notification system for user feedback
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Close button functionality
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

function getNotificationIcon(type) {
    switch (type) {
        case 'success': return 'fa-check-circle';
        case 'error': return 'fa-exclamation-circle';
        case 'warning': return 'fa-exclamation-triangle';
        default: return 'fa-info-circle';
    }
}
updateEmptyState();

// Vehicle Details Modal Functions
let currentVehicleId = null;
let currentVehicleData = null;

function openVehicleDetailsModal(vehicleId) {
    console.log('?? Opening vehicle details modal for vehicleId:', vehicleId);
    currentVehicleId = vehicleId;
    console.log('? Set currentVehicleId to:', currentVehicleId);
    
    // Create modal if it doesn't exist
    let modal = document.getElementById('vehicleDetailsModal');
    if (!modal) {
        modal = createVehicleDetailsModal();
    }
    
    // Show modal with loading state
    const content = document.getElementById('vehicleDetailsContent');
    content.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
            <p style="margin-top: 1rem; color: #666;">Loading vehicle details...</p>
        </div>
    `;
    
    modal.classList.add('show');
    
    // Fetch fresh data from Firebase
    fetchVehicleFromFirebase(vehicleId)
        .then(vehicleData => {
            if (!vehicleData) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #e74c3c;"></i>
                        <p style="margin-top: 1rem; color: #e74c3c;">Vehicle not found</p>
                    </div>
                `;
                return;
            }
            
            console.log('?? Fresh vehicle data for details:', vehicleData);
            // Store vehicle data globally for PDF export
            currentVehicleData = vehicleData;
            // Populate modal content with fresh data
            content.innerHTML = generateVehicleDetailsHTML(vehicleData);
            
            // Set focus for accessibility
            const firstFocusable = modal.querySelector('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) firstFocusable.focus();
        })
        .catch(error => {
            console.error('? Error loading vehicle details:', error);
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #e74c3c;"></i>
                    <p style="margin-top: 1rem; color: #e74c3c;">Error loading vehicle details</p>
                </div>
            `;
        });
}

function closeVehicleDetailsModal() {
    const modal = document.getElementById('vehicleDetailsModal');
    if (modal) {
        modal.classList.remove('show');
    }
    currentVehicleId = null;
    currentVehicleData = null;
}

// PDF Export Function
function exportVehicleToPDF() {
    try {
        // Get current vehicle data from the modal
        const modal = document.getElementById('vehicleDetailsModal');
        if (!modal || !currentVehicleData) {
            showNotification('No vehicle data available for export', 'error');
            return;
        }

        showNotification('Generating PDF...', 'info');

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Company header
        doc.setFontSize(20);
        doc.setTextColor(44, 62, 80);
        doc.text('Dreamex Datalab HSE', 20, 25);
        
        doc.setFontSize(16);
        doc.text('Vehicle Details Report', 20, 35);

        // Vehicle title
        doc.setFontSize(14);
        doc.setTextColor(52, 73, 94);
        const vehicleTitle = `${currentVehicleData.plateNumber || 'N/A'} - ${currentVehicleData.vehicleType || 'Vehicle'}`;
        doc.text(vehicleTitle, 20, 50);

        // Current date
        doc.setFontSize(10);
        doc.setTextColor(127, 140, 141);
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(`Generated on: ${currentDate}`, 20, 60);

        // Vehicle Information Section
        let yPosition = 80;
        doc.setFontSize(12);
        doc.setTextColor(44, 62, 80);
        doc.text('Vehicle Information', 20, yPosition);
        
        // Draw line under section header
        doc.setDrawColor(52, 73, 94);
        doc.line(20, yPosition + 2, 190, yPosition + 2);
        
        yPosition += 15;
        doc.setFontSize(10);
        doc.setTextColor(85, 85, 85);

        // Vehicle details in two columns
        const leftColumnX = 20;
        const rightColumnX = 110;
        
        const vehicleInfo = [
            ['Plate Number:', currentVehicleData.plateNumber || 'N/A'],
            ['Vehicle Type:', currentVehicleData.vehicleType || 'N/A'],
            ['Make:', currentVehicleData.vehicleMake || 'N/A'],
            ['Model:', currentVehicleData.vehicleModel || 'N/A'],
            ['Year:', currentVehicleData.vehicleYear || 'N/A'],
            ['Status:', currentVehicleData.vehicleStatus || currentVehicleData.status || 'N/A']
        ];

        const assignmentInfo = [
            ['Department:', currentVehicleData.assignmentDept || 'N/A'],
            ['Site Assignment:', currentVehicleData.siteAssignment || 'N/A'],
            ['Assigned Driver:', currentVehicleData.assignedDriver || 'N/A'],
            ['Fuel Type:', currentVehicleData.fuelType || 'N/A'],
            ['Securing Status:', currentVehicleData.securingStatus || 'N/A'],
            ['Tank:', currentVehicleData.tankCapacity || 'N/A']
        ];

        // Left column
        vehicleInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], leftColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], leftColumnX + 35, yPosition + (index * 8));
        });

        // Right column
        assignmentInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], rightColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], rightColumnX + 35, yPosition + (index * 8));
        });

        // Technical Information Section
        yPosition += 60;
        doc.setFontSize(12);
        doc.setTextColor(44, 62, 80);
        doc.text('Technical Information', 20, yPosition);
        doc.line(20, yPosition + 2, 190, yPosition + 2);
        
        yPosition += 15;
        doc.setFontSize(10);
        doc.setTextColor(85, 85, 85);

        const technicalInfo = [
            ['VIN Number:', currentVehicleData.vinNumber || 'N/A'],
            ['Current Mileage:', currentVehicleData.currentMileage || 'N/A'],
            ['Engine Size:', currentVehicleData.engineSize || 'N/A'],
            ['Average Value:', currentVehicleData.averageValue || 'N/A']
        ];

        const documentInfo = [
            ['Insurance Expiry:', currentVehicleData.insuranceExpiry || 'N/A'],
            ['Registration Expiry:', currentVehicleData.registrationExpiry || 'N/A'],
            ['Asset Value:', currentVehicleData.assetValue || 'N/A'],
            ['Attachment:', currentVehicleData.vehicleAttachment ? 'Yes' : 'No']
        ];

        // Left column
        technicalInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], leftColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], leftColumnX + 35, yPosition + (index * 8));
        });

        // Right column
        documentInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], rightColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], rightColumnX + 35, yPosition + (index * 8));
        });

        // Notes Section
        if (currentVehicleData.vehicleNotes && currentVehicleData.vehicleNotes.trim()) {
            yPosition += 50;
            doc.setFontSize(12);
            doc.setTextColor(44, 62, 80);
            doc.text('Notes', 20, yPosition);
            doc.line(20, yPosition + 2, 190, yPosition + 2);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setTextColor(85, 85, 85);
            
            // Split notes into lines to fit page width
            const splitNotes = doc.splitTextToSize(currentVehicleData.vehicleNotes, 170);
            doc.text(splitNotes, 20, yPosition);
        }

        // Footer
        doc.setFontSize(8);
        doc.setTextColor(127, 140, 141);
        doc.text('Confidential - Dreamex Datalab HSE Fleet Management System', 20, 280);

        // Generate filename
        const plateNumber = currentVehicleData.plateNumber || 'Unknown';
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `Vehicle_${plateNumber}_${timestamp}.pdf`;

        // Save the PDF
        doc.save(filename);
        
        showNotification('PDF exported successfully', 'success');

    } catch (error) {
        console.error('Error generating PDF:', error);
        showNotification('Error generating PDF. Please try again.', 'error');
    }
}

function generateVehicleDetailsHTML(vehicle) {
    const formatValue = (value, fallback = 'Not specified') => value || fallback;
    const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric' 
    }) : 'Not specified';
    
    return `
        <div class="details-grid">
            <!-- Basic Vehicle Information -->
            <div class="detail-section">
                <h4><i class="fas fa-car"></i> Vehicle Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleName || vehicle.name)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Plate Number:</span>
                    <span class="detail-value">${formatValue(vehicle.plateNumber)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleType)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Make:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleMake)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Model:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleModel)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Year:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleYear)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value status-${(vehicle.vehicleStatus || '').toLowerCase()}">${formatValue(vehicle.vehicleStatus)}</span>
                </div>
            </div>
            
            <!-- Assignment Information -->
            <div class="detail-section">
                <h4><i class="fas fa-building"></i> Assignment</h4>
                <div class="detail-row">
                    <span class="detail-label">Company:</span>
                    <span class="detail-value">${formatValue(vehicle.selectedCompanyName)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Department:</span>
                    <span class="detail-value">${formatValue(vehicle.assignmentDept || vehicle.assignmentDepartment || vehicle.department)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Site:</span>
                    <span class="detail-value">${formatValue(vehicle.siteAssignment || vehicle.workArea || vehicle.site)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Assigned Driver:</span>
                    <span class="detail-value">${formatValue(vehicle.assignedDriver)}</span>
                </div>
            </div>
            
            <!-- Technical Specifications -->
            <div class="detail-section">
                <h4><i class="fas fa-cogs"></i> Technical Details</h4>
                <div class="detail-row">
                    <span class="detail-label">VIN Number:</span>
                    <span class="detail-value">${formatValue(vehicle.vinNumber)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Fuel Type:</span>
                    <span class="detail-value">${formatValue(vehicle.fuelType)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tank:</span>
                    <span class="detail-value">${formatValue(vehicle.tankCapacity)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Current Mileage:</span>
                    <span class="detail-value">${formatValue(vehicle.currentMileage)} km</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Average Consumption:</span>
                    <span class="detail-value">${formatValue(vehicle.engineSize)} - ${formatValue(vehicle.averageValue)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Securing Status:</span>
                    <span class="detail-value">${formatValue(vehicle.securingStatus)}</span>
                </div>
            </div>
            
            <!-- Safety Equipment -->
            <div class="detail-section">
                <h4><i class="fas fa-shield-alt"></i> Safety Equipment</h4>
                <div class="detail-row">
                    <span class="detail-label">Radio:</span>
                    <span class="detail-value">${formatValue(vehicle.radioStatus)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">GPS:</span>
                    <span class="detail-value">${formatValue(vehicle.gpsStatus)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Vignet Date:</span>
                    <span class="detail-value">${formatDate(vehicle.vignetDate)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Aid Kit:</span>
                    <span class="detail-value">${formatValue(vehicle.firstAidKit)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Aid Kit Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.firstAidKitExpiry)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Extinguisher Status:</span>
                    <span class="detail-value">${formatValue(vehicle.extinguisherStatus)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Extinguisher Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.extinguisherExpiry)}</span>
                </div>
            </div>
            
            <!-- Financial & Documentation -->
            <div class="detail-section">
                <h4><i class="fas fa-file-alt"></i> Documentation & Finance</h4>
                <div class="detail-row">
                    <span class="detail-label">Insurance Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.insuranceExpiry)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Registration Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.registrationExpiry)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Asset Value:</span>
                    <span class="detail-value">${vehicle.assetValue ? '$' + parseFloat(vehicle.assetValue).toLocaleString() : 'Not specified'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Attachment:</span>
                    <span class="detail-value">
                        ${vehicle.vehicleAttachment ? 
                            `<div class="attachment-info">
                                <div class="attachment-item">
                                    <i class="fas fa-paperclip"></i>
                                    <span class="attachment-name">${getAttachmentName(vehicle.vehicleAttachment)}</span>
                                    <div class="attachment-actions">
                                        <button class="btn-link" onclick="viewAttachment('${vehicle.vehicleAttachment}', '${getAttachmentName(vehicle.vehicleAttachment)}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn-link" onclick="downloadAttachment('${vehicle.vehicleAttachment}', '${getAttachmentName(vehicle.vehicleAttachment)}')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>` 
                            : '<span class="no-attachment">No attachment</span>'
                        }
                    </span>
                </div>
            </div>
            
            <!-- Additional Notes -->
            ${vehicle.vehicleNotes ? `
            <div class="detail-section full-width">
                <h4><i class="fas fa-sticky-note"></i> Notes</h4>
                <div class="detail-notes">
                    ${vehicle.vehicleNotes}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

function editVehicle() {
    console.log('?? Edit vehicle called, currentVehicleId:', currentVehicleId);
    
    if (!currentVehicleId) {
        showNotification('No vehicle selected for editing', 'error');
        return;
    }
    
    // Close the details modal first
    closeVehicleDetailsModal();
    
    // Fetch fresh data from Firebase
    fetchVehicleFromFirebase(currentVehicleId)
        .then(vehicleData => {
            if (!vehicleData) {
                showNotification('Vehicle data not found in database', 'error');
                return;
            }
            
            console.log('?? Fresh vehicle data from Firebase:', vehicleData);
            // Open the edit modal with fresh data
            openEditVehicleModal(vehicleData, currentVehicleId);
        })
        .catch(error => {
            console.error('? Error fetching vehicle data:', error);
            showNotification('Error loading vehicle data', 'error');
        });
}

async function fetchVehicleFromFirebase(vehicleId) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            throw new Error('Authentication required');
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehicleRef = database.ref(`companies/${companyId}/vehicles/${vehicleId}`);
        
        console.log('? Fetching vehicle from Firebase:', vehicleId);
        
        const snapshot = await vehicleRef.once('value');
        const vehicleData = snapshot.val();
        
        console.log('?? Firebase returned:', vehicleData);
        return vehicleData;
        
    } catch (error) {
        console.error('? Error fetching vehicle from Firebase:', error);
        throw error;
    }
}

function openEditVehicleModal(vehicleData, vehicleId) {
    // Create or get the modal
    let modal = document.getElementById('addVehicleModal');
    if (!modal) {
        modal = createAddVehicleModal();
    }
    
    // Update modal title to indicate edit mode
    const modalTitle = modal.querySelector('.modal-header h5');
    if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Vehicle';
    }
    
    // Update submit button text
    const submitBtn = modal.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.textContent = 'Update Vehicle';
    }
    
    // Populate form fields with existing data
    populateEditForm(vehicleData);
    
    // Set edit mode flag and vehicle ID
    modal.setAttribute('data-edit-mode', 'true');
    modal.setAttribute('data-vehicle-id', vehicleId);
    
    // Show the modal
    modal.classList.add('show');
    
    // Focus first input
    const firstInput = modal.querySelector('input, select');
    if (firstInput) firstInput.focus();
}

function populateEditForm(vehicleData) {
    console.log('?? Populating edit form with data:', vehicleData);
    
    // Populate all form fields with existing vehicle data
    const fieldMappings = {
        'vehicleName': vehicleData.vehicleName || vehicleData.name,
        'plateNumber': vehicleData.plateNumber,
        'vehicleType': vehicleData.vehicleType,
        'vehicleMake': vehicleData.vehicleMake,
        'vehicleModel': vehicleData.vehicleModel,
        'vehicleYear': vehicleData.vehicleYear,
        'vehicleStatus': vehicleData.vehicleStatus || vehicleData.status,
        'assignmentDept': vehicleData.assignmentDept,
        'siteAssignment': vehicleData.siteAssignment,
        'fuelType': vehicleData.fuelType,
        'securingStatus': vehicleData.securingStatus,
        'tankCapacity': vehicleData.tankCapacity,
        'vinNumber': vehicleData.vinNumber,
        'currentMileage': vehicleData.currentMileage,
        'engineSize': vehicleData.engineSize,
        'averageValue': vehicleData.averageValue,
        'assignedDriver': vehicleData.assignedDriver,
        'insuranceExpiry': vehicleData.insuranceExpiry,
        'registrationExpiry': vehicleData.registrationExpiry,
        'assetValue': vehicleData.assetValue,
        'vehicleNotes': vehicleData.vehicleNotes,
        'radioStatus': vehicleData.radioStatus,
        'gpsStatus': vehicleData.gpsStatus,
        'vignetDate': vehicleData.vignetDate,
        'firstAidKit': vehicleData.firstAidKit,
        'firstAidKitExpiry': vehicleData.firstAidKitExpiry,
        'extinguisherStatus': vehicleData.extinguisherStatus,
        'extinguisherExpiry': vehicleData.extinguisherExpiry
    };
    
    // Handle attachment display for edit mode
    handleAttachmentInEditMode(vehicleData.vehicleAttachment);
    
    // Repopulate dropdowns first, then set values
    populateVehicleSelects().then(() => {
        // Set each field value after dropdowns are populated
        Object.keys(fieldMappings).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const value = fieldMappings[fieldId];
            
            if (field && value !== undefined && value !== null && value !== '') {
                field.value = value;
                console.log(`? Set ${fieldId} = ${value}`);
            }
        });

        // Set company selection if present
        const compSel = document.getElementById('companySelect');
        const selectedCompanyId = vehicleData.selectedCompanyId || vehicleData.companySelect || window.authManager?.currentUser?.companyId;
        if (compSel && selectedCompanyId) {
            compSel.value = selectedCompanyId;
        }
        
        // Handle make/model relationship with proper timing
        if (vehicleData.vehicleMake) {
            console.log('?? Setting vehicle make:', vehicleData.vehicleMake);
            
            // Set the make first
            const makeField = document.getElementById('vehicleMake');
            if (makeField) {
                makeField.value = vehicleData.vehicleMake;
                
                // Then update models and set the model
                updateModelsForMake(vehicleData.vehicleMake);
                
                // Set model after a brief delay to ensure options are populated
                setTimeout(() => {
                    const modelField = document.getElementById('vehicleModel');
                    if (modelField && vehicleData.vehicleModel) {
                        modelField.value = vehicleData.vehicleModel;
                        console.log(`? Set vehicleModel = ${vehicleData.vehicleModel}`);
                    }
                }, 100);
            }
        }
    });
}

function handleAttachmentInEditMode(attachmentUrl) {
    const attachmentInput = document.getElementById('vehicleAttachment');
    const attachmentContainer = attachmentInput?.parentElement;
    
    if (!attachmentContainer) return;
    
    // Remove any existing attachment info
    const existingInfo = attachmentContainer.querySelector('.current-attachment-info');
    if (existingInfo) {
        existingInfo.remove();
    }
    
    if (attachmentUrl) {
        // Create attachment info display
        const attachmentInfo = document.createElement('div');
        attachmentInfo.className = 'current-attachment-info';
        attachmentInfo.style.cssText = `
            margin-top: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        `;
        
        const attachmentName = getAttachmentName(attachmentUrl);
        attachmentInfo.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <i class="fas fa-paperclip" style="margin-right: 5px; color: #6c757d;"></i>
                    <strong>Current:</strong> ${attachmentName}
                </div>
                <div>
                    <button type="button" class="btn-link" onclick="viewAttachment('${attachmentUrl}', '${attachmentName}')" style="font-size: 11px; padding: 2px 6px; margin-right: 5px;">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button type="button" class="btn-link" onclick="downloadAttachment('${attachmentUrl}', '${attachmentName}')" style="font-size: 11px; padding: 2px 6px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
            <div style="margin-top: 4px; font-size: 11px; color: #6c757d;">
                Select a new file to replace the current attachment
            </div>
        `;
        
        // Insert after the input field
        attachmentContainer.insertBefore(attachmentInfo, attachmentInput.nextSibling);
    }
}

// Edit vehicle directly from table action button
function editVehicleFromTable(vehicleId) {
    if(!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canEditVehicle)){ window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to edit vehicles'}); return; }
    console.log('?? Edit vehicle from table, vehicleId:', vehicleId);
    currentVehicleId = vehicleId;
    fetchVehicleFromFirebase(vehicleId)
        .then(vehicleData => {
            if (!vehicleData) { showNotification('Vehicle data not found in database', 'error'); return; }
            console.log('?? Fresh vehicle data from Firebase:', vehicleData);
            openEditVehicleModal(vehicleData, vehicleId);
        })
        .catch(error => { console.error('? Error fetching vehicle data:', error); showNotification('Error loading vehicle data', 'error'); });
}

// Delete vehicle function
function deleteVehicle(vehicleId) {
    if(!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canDeleteVehicle)){ window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to delete vehicles'}); return; }
    fetchVehicleFromFirebase(vehicleId)
        .then(vehicleData => {
            if (!vehicleData) { showNotification('Vehicle not found', 'error'); return; }
            const vehicleName = vehicleData.plateNumber || 'Unknown Vehicle';
            const vehicleType = vehicleData.vehicleType || 'Vehicle';
            showDeleteConfirmation(vehicleId, vehicleName, vehicleType, vehicleData);
        })
        .catch(error => { console.error('? Error fetching vehicle for deletion:', error); showNotification('Error loading vehicle data', 'error'); });
}

function showDeleteConfirmation(vehicleId, vehicleName, vehicleType, vehicleData) {
    // Create confirmation modal
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal confirmation-modal';
    confirmModal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Confirm Deletion</h5>
                <button class="close-btn" onclick="closeDeleteConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation-content">
                    <div class="vehicle-info">
                        <h6>You are about to delete:</h6>
                        <div class="vehicle-details">
                            <strong>${vehicleName}</strong> (${vehicleType})<br>
                            <small>Make: ${vehicleData.vehicleMake || 'N/A'} | Model: ${vehicleData.vehicleModel || 'N/A'}</small>
                        </div>
                    </div>
                    <div class="warning-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone. All vehicle data will be permanently removed.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmation()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete('${vehicleId}', '${vehicleName}')">
                    <i class="fas fa-trash"></i> Delete Vehicle
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmModal);
    confirmModal.classList.add('show');
    
    // Focus the delete button for keyboard navigation
    setTimeout(() => {
        const deleteBtn = confirmModal.querySelector('.btn-danger');
        if (deleteBtn) deleteBtn.focus();
    }, 100);
}

function closeDeleteConfirmation() {
    const modal = document.querySelector('.confirmation-modal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        }, 300);
    }
}

function confirmDelete(vehicleId, vehicleName) {
    closeDeleteConfirmation();
    deleteVehicleFromFirebase(vehicleId, vehicleName);
}

async function deleteVehicleFromFirebase(vehicleId, vehicleName) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            showNotification('Authentication required to delete vehicle', 'error');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehicleRef = database.ref(`companies/${companyId}/vehicles/${vehicleId}`);
        
        console.log('??? Deleting vehicle from Firebase:', vehicleId);
        
        // Delete from Firebase (this will trigger real-time listeners)
        await vehicleRef.remove();
        
        console.log('? Vehicle deleted successfully:', vehicleId);
        showNotification(`Vehicle "${vehicleName}" deleted successfully`, 'success');
        
    } catch (error) {
        console.error('? Error deleting vehicle from Firebase:', error);
        showNotification('Error deleting vehicle. Please try again.', 'error');
    }
}

// Attachment handling functions
function getAttachmentName(attachmentPath) {
    if (!attachmentPath) return 'Attachment';
    
    // If it's an object with name property (metadata)
    if (typeof attachmentPath === 'object' && attachmentPath.name) {
        return attachmentPath.name;
    }
    
    // If it's a Firebase Storage URL, extract filename
    if (typeof attachmentPath === 'string') {
        // Handle Firebase Storage URLs
        if (attachmentPath.includes('firebasestorage.googleapis.com')) {
            try {
                // Extract filename from Firebase Storage URL
                const url = new URL(attachmentPath);
                const pathname = decodeURIComponent(url.pathname);
                
                // Firebase Storage URLs have format: /v0/b/bucket/o/path%2Fto%2Ffile.ext
                const parts = pathname.split('/');
                if (parts.length > 4) {
                    const filePath = parts[parts.length - 1];
                    // Remove Firebase prefixes and get actual filename
                    const fileName = filePath.split('/').pop();
                    
                    // Remove timestamp prefix if present (e.g., "1234567890_filename.pdf" -> "filename.pdf")
                    if (fileName.includes('_')) {
                        const withoutTimestamp = fileName.substring(fileName.indexOf('_') + 1);
                        return withoutTimestamp || fileName;
                    }
                    
                    return fileName;
                }
            } catch (error) {
                console.warn('Error parsing Firebase Storage URL:', error);
            }
        }
        
        // Fallback for regular URLs or paths
        const parts = attachmentPath.split('/');
        const fileName = parts[parts.length - 1];
        // Remove any query parameters
        return fileName.split('?')[0] || 'Attachment';
    }
    
    return 'Attachment';
}

function viewAttachment(attachmentUrl, fileName) {
    if (!attachmentUrl) {
        showNotification('No attachment available', 'warning');
        return;
    }
    
    try {
        // Get file extension to determine how to handle viewing
        const fileExtension = fileName.toLowerCase().split('.').pop();
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
        const documentExtensions = ['pdf', 'doc', 'docx', 'txt'];
        
        if (imageExtensions.includes(fileExtension)) {
            // For images, create a modal viewer
            openImageViewer(attachmentUrl, fileName);
        } else if (documentExtensions.includes(fileExtension)) {
            // For documents, open in new tab with view intent
            const viewUrl = attachmentUrl + '#view=FitH';
            const newWindow = window.open(viewUrl, '_blank', 'noopener,noreferrer');
            
            if (!newWindow) {
                showNotification('Please allow popups to view attachments', 'warning');
                // Fallback: try to open in same tab
                window.open(attachmentUrl, '_blank');
            } else {
                showNotification('Opening document viewer...', 'info');
            }
        } else {
            // For other file types, open in new tab
            const newWindow = window.open(attachmentUrl, '_blank', 'noopener,noreferrer');
            
            if (!newWindow) {
                showNotification('Please allow popups to view attachments', 'warning');
                // Fallback: try direct download
                downloadAttachment(attachmentUrl, fileName);
            } else {
                showNotification('Opening file viewer...', 'info');
            }
        }
    } catch (error) {
        console.error('Error viewing attachment:', error);
        showNotification('Error opening attachment', 'error');
    }
}

function openImageViewer(imageUrl, fileName) {
    // Create image viewer modal
    const imageModal = document.createElement('div');
    imageModal.className = 'modal image-viewer-modal';
    imageModal.innerHTML = `
        <div class="modal-content image-viewer-content">
            <div class="modal-header">
                <h5><i class="fas fa-image"></i> ${fileName}</h5>
                <button class="close-btn" onclick="closeImageViewer()">&times;</button>
            </div>
            <div class="modal-body image-viewer-body">
                <img src="${imageUrl}" alt="${fileName}" class="viewer-image" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageViewer()">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadAttachment('${imageUrl}', '${fileName}')">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(imageModal);
    imageModal.classList.add('show');
    
    // Close on click outside
    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            closeImageViewer();
        }
    });
    
    // Close on Escape key
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            closeImageViewer();
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}

function closeImageViewer() {
    const imageModal = document.querySelector('.image-viewer-modal');
    if (imageModal) {
        imageModal.classList.remove('show');
        setTimeout(() => {
            if (imageModal.parentNode) {
                imageModal.parentNode.removeChild(imageModal);
            }
        }, 300);
    }
}

function downloadAttachment(attachmentUrl, fileName) {
    if (!attachmentUrl) {
        showNotification('No attachment available', 'warning');
        return;
    }
    
    try {
        // Create temporary link element for download
        const link = document.createElement('a');
        link.href = attachmentUrl;
        link.download = fileName || 'vehicle-attachment';
        link.target = '_blank';
        
        // Append to body, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Download started', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showNotification('Error downloading attachment', 'error');
    }
}

// FAB open
// Legacy FAB initialization removed; header button now handles Add Vehicle
const addVehicleFab=document.getElementById('addVehicleFab');
if(addVehicleFab){
    // In case cached HTML still contains FAB, keep it functional
    addVehicleFab.addEventListener('click',()=>openAddVehicleModal());
}

// Global dismissal
window.addEventListener('click',e=>{ const modal=document.getElementById('addVehicleModal'); if(modal && e.target===modal){ closeVehicleModal(); }});
window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ const modal=document.getElementById('addVehicleModal'); if(modal && modal.classList.contains('show')){ closeVehicleModal(); }} });

function trapFocus(container){ const focusableSelectors='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'; const focusable=Array.from(container.querySelectorAll(focusableSelectors)); if(focusable.length===0) return; let first=focusable[0]; let last=focusable[focusable.length-1]; container.addEventListener('keydown',e=>{ if(e.key==='Tab'){ if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } } }); }

// Enhanced menu visibility system based on roles.html template

// Reset all menu items to hidden
function resetMenuVisibility() {
    document.querySelectorAll('[data-feature]').forEach(item => {
        item.classList.remove('menu-visible');
    });
    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
        dropdown.classList.remove('menu-visible');
    });
}

// Emergency fallback - show basic menu items
function showBasicMenu() {
    console.log('?? Emergency fallback: Showing basic menu items');
    resetMenuVisibility();
    
    // Remove loading class
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.remove('menu-loading');
    }
    
    const homeItem = document.querySelector('[data-feature="home_view"]');
    if (homeItem) {
        homeItem.classList.add('menu-visible');
    }
}

// Feature-based authorization system that takes priority over role permissions
async function updateMenuWithFeatureAuthorization() {
    console.log('?? Starting feature-based menu authorization for fleet.html...');
    
    try {
        let currentUser = null;
        let companyId = null;
        
        // Get user and company info using authManager first
        if (window.authManager && window.authManager.currentUser) {
            currentUser = window.authManager.currentUser;
            companyId = currentUser.companyId;
            console.log('?? Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
        } else if (firebase.auth().currentUser) {
            currentUser = firebase.auth().currentUser;
            console.log('?? Using Firebase auth - will search for company');
        } else {
            console.log('? No authenticated user found');
            resetMenuVisibility();
            return;
        }
        
        // If no company ID from authManager, search companies collection
        if (!companyId && currentUser) {
            console.log('?? Searching for user company...');
            const database = firebase.database();
            const companiesRef = database.ref('companies');
            const companiesSnapshot = await companiesRef.once('value');
            
            if (companiesSnapshot.exists()) {
                const companies = companiesSnapshot.val();
                
                for (const [cId, company] of Object.entries(companies)) {
                    if (company.status !== 'active') continue;
                    
                    if (company.users && company.users[currentUser.uid]) {
                        companyId = cId;
                        console.log(`? Found user in company: ${companyId} (${company.name})`);
                        break;
                    }
                }
            }
        }
        
        if (!companyId) {
            console.error('? No company ID found, cannot determine authorized features');
            resetMenuVisibility();
            return;
        }
        
        // Apply feature-based authorization first (company subscription)
        await applyFeatureBasedMenuVisibility(companyId);

        // Then refine with role-based permissions (intersection)
        try {
            await applyRoleBasedFiltering(companyId, currentUser);
        } catch (rbErr) {
            console.warn('?? Role-based filtering failed, keeping feature-based visibility only:', rbErr);
        }
        
    } catch (error) {
        console.error('? Error in feature-based menu authorization:', error);
        resetMenuVisibility();
    }
}

async function applyFeatureBasedMenuVisibility(companyId) {
    try {
        console.log('?? Applying feature-based menu visibility for company:', companyId);
        
        // Get platform features
        const database = firebase.database();
        const featuresSnapshot = await database.ref('/platformFeatures').once('value');
        
        if (!featuresSnapshot.exists()) {
            console.log('?? No platform features found');
            resetMenuVisibility();
            return;
        }
        
        const featuresData = featuresSnapshot.val();
        
        // Get company's selected features
        const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
        const companyData = companySnapshot.val();
        
        if (!companyData) {
            console.error('? Company data not found');
            resetMenuVisibility();
            return;
        }
        
        const subscribedFeatureIds = companyData.selectedFeatures || [];
        console.log('?? Company subscribed features:', subscribedFeatureIds);
        
        if (subscribedFeatureIds.length === 0) {
            console.log('?? Company has no subscribed features');
            resetMenuVisibility();
            return;
        }
        
        // Collect authorized pages from subscribed features
        const authorizedPages = [];
        subscribedFeatureIds.forEach(featureId => {
            const feature = featuresData[featureId];
            if (feature && feature.status === 'active' && feature.authorizedPages) {
                console.log(`?? Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                authorizedPages.push(...feature.authorizedPages);
            } else {
                console.log(`?? Feature ${featureId} not found or inactive`);
            }
        });
        
        console.log('?? All authorized pages:', authorizedPages);
        
        // Reset all menu items first
        resetMenuVisibility();
        
        // Create set of authorized features
        const authorizedFeatures = new Set();
        authorizedPages.forEach(pageInfo => {
            if (pageInfo.feature) {
                authorizedFeatures.add(pageInfo.feature);
            }
        });
        
        console.log('?? Authorized features for fleet.html:', Array.from(authorizedFeatures));
        
        // Apply menu visibility
        const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
        let visibleCount = 0;
        
        allMenuItems.forEach(menuItem => {
            const featureAttribute = menuItem.getAttribute('data-feature');
            const isAuthorized = authorizedFeatures.has(featureAttribute);
            const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
            
            if (isDropdownContainer) {
                return; // Handle dropdowns separately after all items are processed
            }
            
            if (isAuthorized) {
                menuItem.classList.add('menu-visible');
                visibleCount++;
                console.log(`? Authorized: ${featureAttribute}`);
            } else {
                console.log(`? Not authorized: ${featureAttribute}`);
            }
        });
        
        // Handle dropdown menus - show dropdown if any child is visible
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            const children = dropdown.querySelectorAll('li[data-feature].menu-visible');
            if (children.length > 0) {
                dropdown.classList.add('menu-visible');
                console.log(`? Dropdown visible (${children.length} visible children)`);
            }
        });
        
    // Do not remove loading class here; wait for role-based filtering to finish to avoid flicker
    console.log(`? Feature-based authorization complete. Candidate visible items: ${visibleCount}`);
        
    } catch (error) {
        console.error('? Error applying feature-based menu visibility:', error);
        resetMenuVisibility();
    }
}

// Role-based filtering: keep only items allowed by the user's role
async function applyRoleBasedFiltering(companyId, currentUser) {
    const database = firebase.database();
    let role = currentUser && currentUser.role;
    const uid = currentUser && (currentUser.uid || currentUser.authUid || currentUser.userId);

    try {
        // Try to resolve role from company user record if not present
        if (!role && uid) {
            const userSnap = await database.ref(`/companies/${companyId}/users/${uid}`).once('value');
            const userRec = userSnap.val() || {};
            role = userRec.role || userRec.assignedRole || userRec.userRole || role;
        }

        if (!role) {
            console.warn('?? No role found for current user; skipping role filter');
            return;
        }

        // Fetch permissions for the role
        const permsSnap = await database.ref(`companies/${companyId}/roles/${role}/permissions`).once('value');
        const permissions = permsSnap.val() || {};

        // Build set of allowed features by role
        const allowedByRole = new Set();
        Object.entries(permissions).forEach(([featureKey, value]) => {
            if (value === true) allowedByRole.add(featureKey);
            else if (value && typeof value === 'object' && value.view === true) allowedByRole.add(featureKey);
        });

        // Intersect: only keep items already visible (feature-based) AND allowed by role
        const visibleItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-feature]');
        let kept = 0, removed = 0;
        visibleItems.forEach(item => {
            const featureKey = item.getAttribute('data-feature');
            const requires = item.getAttribute('data-requires-permission');
            const okByFeature = allowedByRole.has(featureKey);
            const okByRequires = requires ? allowedByRole.has(requires) : true;
            if (okByFeature && okByRequires) {
                kept++;
            } else {
                item.classList.remove('menu-visible');
                removed++;
            }
        });

    // Recompute dropdown visibility based on remaining children
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            const children = dropdown.querySelectorAll('li[data-feature].menu-visible');
            if (children.length > 0) dropdown.classList.add('menu-visible');
            else dropdown.classList.remove('menu-visible');
        });

        // Always keep Home visible
        const homeItem = document.querySelector('[data-feature="home_view"]');
        if (homeItem) homeItem.classList.add('menu-visible');

    // Remove loading class now that both phases are done
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.remove('menu-loading');

        if (kept === 0) {
            console.log('?? After role filter, no items visible; showing basic menu');
            showBasicMenu();
        } else {
            console.log(`? Role-based filtering applied. Kept: ${kept}, Removed: ${removed}`);
        }
    } catch (err) {
        console.error('? Error during role-based filtering:', err);
        // On error, fall back to feature-based result already applied
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.remove('menu-loading');
    }
}

// Make updateMenuWithFeatureAuthorization available globally
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

// Initialize menu system when page loads
document.addEventListener('DOMContentLoaded', async function() {
    console.log('?? Fleet.html DOM loaded - menu authorization will be handled by AuthManager');
    
    // Set up listener for field options changes from settings.html
    setupFieldOptionsListener();
    
    // Load departments and work areas from company scope for current company
    const user = window.authManager?.currentUser;
    if (user && user.companyId) {
        console.log('?? Initializing company scope field options for fleet management...');
        try {
            // Check for latest version data from company scope first
            const latestDepartments = localStorage.getItem(`fieldOptionsLatest_${user.companyId}_department`);
            const latestAreas = localStorage.getItem(`fieldOptionsLatest_${user.companyId}_area`);
            
            if (latestDepartments) {
                try {
                    const latestDeptData = JSON.parse(latestDepartments);
                    if (latestDeptData.options && Array.isArray(latestDeptData.options)) {
                        departmentOptions = latestDeptData.options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        console.log('? Departments loaded from company scope latest version:', departmentOptions);
                    }
                } catch (error) {
                    console.warn('Error parsing latest department data:', error);
                }
            }
            
            if (latestAreas) {
                try {
                    const latestAreaData = JSON.parse(latestAreas);
                    if (latestAreaData.options && Array.isArray(latestAreaData.options)) {
                        siteOptions = latestAreaData.options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        console.log('? Work areas loaded from company scope latest version:', siteOptions);
                    }
                } catch (error) {
                    console.warn('Error parsing latest area data:', error);
                }
            }
            
            // Load from company scope if latest versions not available
            if (!departmentOptions || departmentOptions.length === 0) {
                await loadDepartmentsFromSettings(user.companyId);
            }
            if (!siteOptions || siteOptions.length === 0) {
                await loadWorkAreasFromSettings(user.companyId);
            }
            
            console.log('? Company scope field options initialized for fleet');
        } catch (error) {
            console.error('? Error loading company scope field options:', error);
        }
    }
});

// Set up listener for real-time field options updates
function setupFieldOptionsListener() {
    // Listen for BroadcastChannel updates from settings.html
    if (typeof BroadcastChannel !== 'undefined') {
        try {
            const channel = new BroadcastChannel('fieldOptionsUpdates');
            channel.addEventListener('message', (event) => {
                const { fieldType, companyId, options } = event.data;
                
                // Handle area field updates
                if (fieldType === 'area' && 
                    companyId === window.authManager?.currentUser?.companyId) {
                    console.log('?? Received work areas update from settings.html');
                    
                    // Update site options
                    if (Array.isArray(options)) {
                        siteOptions = options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        
                        console.log('?? Updated work areas in fleet management:', siteOptions);
                        
                        // Refresh the dropdown if modal is open
                        populateVehicleSelects();
                    }
                }
                
                // Handle department field updates
                if (fieldType === 'department' && 
                    companyId === window.authManager?.currentUser?.companyId) {
                    console.log('?? Received departments update from settings.html');
                    
                    // Update department options
                    if (Array.isArray(options)) {
                        departmentOptions = options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        
                        console.log('?? Updated departments in fleet management:', departmentOptions);
                        
                        // Refresh the dropdown if modal is open
                        populateVehicleSelects();
                    }
                }
            });
            console.log('?? Field options listener set up for fleet management');
        } catch (error) {
            console.warn('BroadcastChannel not available:', error);
        }
    }
    
    // Listen for localStorage changes (fallback)
    window.addEventListener('storage', (event) => {
        const companyId = window.authManager?.currentUser?.companyId;
        
        // Handle area field changes
        if (event.key && event.key.startsWith('fieldOptionsChange_area_')) {
            try {
                const changeData = JSON.parse(event.newValue);
                if (changeData.companyId === companyId) {
                    console.log('?? Received work areas update via localStorage');
                    // Reload work areas from settings
                    if (companyId) {
                        loadWorkAreasFromSettings(companyId);
                    }
                }
            } catch (error) {
                console.warn('Error parsing localStorage change event:', error);
            }
        }
        
        // Handle department field changes
        if (event.key && event.key.startsWith('fieldOptionsChange_department_')) {
            try {
                const changeData = JSON.parse(event.newValue);
                if (changeData.companyId === companyId) {
                    console.log('?? Received departments update via localStorage');
                    // Reload departments from settings
                    if (companyId) {
                        loadDepartmentsFromSettings(companyId);
                    }
                }
            } catch (error) {
                console.warn('Error parsing localStorage change event:', error);
            }
        }
        
        // Handle latest version updates from company scope (settings.html creates these)
        if (event.key && companyId && event.key === `fieldOptionsLatest_${companyId}_area`) {
            try {
                const latestData = JSON.parse(event.newValue);
                if (latestData.options && Array.isArray(latestData.options)) {
                    siteOptions = latestData.options
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log('?? Updated work areas from company scope latest version:', siteOptions);
                    populateVehicleSelects();
                }
            } catch (error) {
                console.warn('Error parsing latest area options from company scope:', error);
            }
        }
        
        if (event.key && companyId && event.key === `fieldOptionsLatest_${companyId}_department`) {
            try {
                const latestData = JSON.parse(event.newValue);
                if (latestData.options && Array.isArray(latestData.options)) {
                    departmentOptions = latestData.options
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log('?? Updated departments from company scope latest version:', departmentOptions);
                    populateVehicleSelects();
                }
            } catch (error) {
                console.warn('Error parsing latest department options from company scope:', error);
            }
        }
    });
    
    // Listen for custom events within the same page
    document.addEventListener('fieldOptionsChanged', (event) => {
        const { fieldType, companyId, options } = event.detail;
        
        if (fieldType === 'area' && 
            companyId === window.authManager?.currentUser?.companyId) {
            console.log('?? Received work areas update via custom event');
            
            if (Array.isArray(options)) {
                siteOptions = options
                    .filter(option => option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log('?? Updated work areas in fleet management:', siteOptions);
                populateVehicleSelects();
            }
        }
        
        if (fieldType === 'department' && 
            companyId === window.authManager?.currentUser?.companyId) {
            console.log('?? Received departments update via custom event');
            
            if (Array.isArray(options)) {
                departmentOptions = options
                    .filter(option => option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log('?? Updated departments in fleet management:', departmentOptions);
                populateVehicleSelects();
            }
        }
    });
}

// Initialize vehicle data with fallback
updateEmptyState();
setTimeout(() => {
    if (window.authManager && window.authManager.currentUser && window.authManager.currentUser.companyId) {
        initializeVehicleData();
    }
}, 2000);

// Tab switching functionality
function switchToTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + 'TabContent').classList.add('active');
    document.getElementById(tabName + 'TabBtn').classList.add('active');
    // Toggle Add Vehicle header button visibility based on active tab
    const addHeaderBtn = document.getElementById('addVehicleHeaderBtn');
    if (addHeaderBtn) {
        addHeaderBtn.style.display = (tabName === 'vehicles') ? 'inline-flex' : 'none';
    }
    
    // Initialize chart if switching to analytics
    if (tabName === 'analytics') {
        setTimeout(() => {
            initializeFleetCharts();
        }, 100);
    }
    // Initialize deep analytics when switching to that tab
    if (tabName === 'deepAnalytics') {
        setTimeout(() => {
            initializeDeepAnalytics();
        }, 100);
    }
    // Initialize assignment tab
    if (tabName === 'assignment') {
        setTimeout(() => {
            initializeAssignmentTab();
        }, 60);
    }
    // Load inspections when switching to maintenance
    if (tabName === 'maintenance') {
        setTimeout(() => {
            loadInspections();
        }, 50);
    }

    // Lazy init for settings tab: load visibility config and populate form if first time
    if (tabName === 'settings') {
        setTimeout(() => {
            ensureFleetVisibilityLoaded();
        }, 30);
    }
}

// Fleet Analytics Variables
let fleetChart = null;
let vehicleData = [];
let inspectionsData = [];
let fleetVisibilityConfig = null; // {showVehicles:true,...}
let fleetVisibilityLoaded = false;
let deepParetoChart = null;
let deepComplianceSelected = new Set();
let __assignmentLoaded = false;
let __assignments_cache = {};
let __vehicles_cache = {};
let __assignGeofenceSelections = [];
let __assignDriversSelections = [];

async function initializeAssignmentTab(){
    try{
        // Bind + New button
        const btn = document.getElementById('newAssignmentBtn');
        if(btn){ btn.onclick = openAssignmentModal; }
        // Load existing recent assignments
        await loadAssignments();
        __assignmentLoaded = true;
    }catch(err){ console.warn('initializeAssignmentTab failed', err); }
}

function toLocalISODateTime(d){
    const pad=(n)=> (n<10?'0':'')+n;
    const yyyy=d.getFullYear(); const mm=pad(d.getMonth()+1); const dd=pad(d.getDate()); const hh=pad(d.getHours()); const mi=pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}

async function populateAssignmentVehicles(){
    const sel = document.getElementById('assignVehicle'); if(!sel) return;
    const user = window.authManager?.currentUser; const companyId = user?.companyId; if(!companyId){ return; }
    try{
        const snap = await firebase.database().ref(`companies/${companyId}/vehicles`).once('value');
        const data = snap.val()||{}; const opts = ['<option value="">Select vehicle</option>'];
        __vehicles_cache = {};
        Object.keys(data).forEach(id=>{
            const v = data[id] || {};
            const rawName = (v.name || v.model || '').toString().trim();
            const plate = (v.plateNumber || v.plate || '').toString().trim();
            let base = rawName;
            if (!base) {
                // Prefer a meaningful fallback over "Untitled"
                if (plate) base = `Vehicle ${plate}`; else base = `Vehicle ${String(id).slice(-6)}`;
            }
            // Append plate if available and not already present in base
            const label = plate && !base.includes(plate) ? `${base} (${plate})` : base;
            __vehicles_cache[id] = label;
            opts.push(`<option value="${id}">${escapeHtml(label)}</option>`);
        });
        sel.innerHTML = opts.join('');
    }catch(err){ console.error('populateAssignmentVehicles failed', err); }
}

async function populateAssignmentAssignees(){
    const sel = document.getElementById('assignAssignee'); if(!sel) return;
    const companyId = window.authManager?.currentUser?.companyId; if(!companyId){ sel.innerHTML = '<option value="">Select assignee</option>'; return; }
    try{
        const snap = await firebase.database().ref(`companies/${companyId}/users`).once('value');
        const users = snap.val() || {};
        // Cache full user objects for quick lookup on assignee change
        window.__users_cache = users;
        const entries = Object.entries(users).map(([uid,u])=>{
            const name = (u.displayName || u.name || ((u.firstName||'') + ' ' + (u.lastName||'')).trim() || u.email || '(No name)').trim();
            const job = (u.jobTitle || u.positionTitle || u.position || '').trim();
            const label = job ? `${name} - ${job}` : name;
            return { uid, label };
        }).sort((a,b)=> a.label.localeCompare(b.label, undefined, {sensitivity:'base'}));
        const current = sel.value;
        sel.innerHTML = '<option value="">Select assignee</option>' + entries.map(e=>`<option value="${e.uid}">${escapeHtml(e.label)}</option>`).join('');
        // Try default to current user
        const myUid = window.authManager?.currentUser?.uid || '';
        if(!current && myUid && entries.some(e=>e.uid===myUid)) sel.value = myUid;
        // Bind change handler to auto-fill department based on selected assignee
        sel.onchange = updateAssignmentDepartmentFromAssignee;
        // Initialize department value immediately for current selection
        updateAssignmentDepartmentFromAssignee();
    }catch(err){ console.warn('populateAssignmentAssignees failed', err); sel.innerHTML = '<option value="">Select assignee</option>'; }
}

// Build a label like "Full Name - Job Title" from users cache
function renderUserLabel(uid){
    try{
        const users = window.__users_cache || {};
        const u = users[uid];
        if(!u) return uid||'-';
        const name = (u.name || u.displayName || `${(u.firstName||'').trim()} ${(u.lastName||'').trim()}`.trim() || u.email || uid || '').trim();
        const job = (u.jobTitle || u.position || u.title || '').trim();
        return job ? `${name} - ${job}` : name || '-';
    }catch(_){ return uid||'-'; }
}

// Populate Drivers select from users cache
function populateDriversSelect(){
    try{
        const sel = document.getElementById('assignDrivers'); if(!sel) return;
        const users = window.__users_cache || {};
        const entries = Object.entries(users);
        entries.sort((a,b)=>{
            const an = (a[1].name || a[1].displayName || `${(a[1].firstName||'').trim()} ${(a[1].lastName||'').trim()}` || a[1].email || '').toLowerCase();
            const bn = (b[1].name || b[1].displayName || `${(b[1].firstName||'').trim()} ${(b[1].lastName||'').trim()}` || b[1].email || '').toLowerCase();
            return an.localeCompare(bn);
        });
        const opts = ['<option value="">Select driver</option>'];
        entries.forEach(([uid])=>{
            const label = renderUserLabel(uid);
            opts.push(`<option value="${uid}">${escapeHtml(label)}</option>`);
        });
        sel.innerHTML = opts.join('');
    }catch(e){ console.warn('populateDriversSelect failed', e); }
}

function onDriverSelectChange(){
    try{
        const sel = document.getElementById('assignDrivers'); if(!sel) return;
        const uid = sel.value;
        if(uid){
            if(!__assignDriversSelections.includes(uid)) __assignDriversSelections.push(uid);
            updateSelectedDriversDisplay();
            sel.value = '';
        }
    }catch(e){ console.warn('onDriverSelectChange failed', e); }
}

function updateSelectedDriversDisplay(){
    try{
        const wrap = document.getElementById('assignDriversSelected');
        const chips = document.getElementById('assignDriversChips');
        if(!wrap || !chips) return;
        const unique = Array.from(new Set((__assignDriversSelections||[]).filter(Boolean)));
        __assignDriversSelections = unique;
        chips.innerHTML = unique.map(uid=>{
            const label = renderUserLabel(uid);
            const safe = escapeHtml(label);
            return `<span class="chip" style="display:inline-flex;align-items:center;gap:.35rem;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:999px;padding:.2rem .5rem;">
                        <span>${safe}</span>
                        <button type="button" aria-label="Remove ${safe}" title="Remove" onclick="removeSelectedDriver('${uid.replace(/'/g,"&#39;")}')" style="background:#fff;border:1px solid #cbd5e1;color:#334155;width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;line-height:0;">
                            <span style="font-size:12px;"></span>
                        </button>
                    </span>`;
        }).join('');
        wrap.style.display = unique.length ? 'block' : 'none';
    }catch(e){ console.warn('updateSelectedDriversDisplay failed', e); }
}

function removeSelectedDriver(uid){
    try{
        __assignDriversSelections = (__assignDriversSelections||[]).filter(id=> id!==uid);
        updateSelectedDriversDisplay();
    }catch(e){ console.warn('removeSelectedDriver failed', e); }
}

function updateAssignmentDepartmentFromAssignee(){
    try{
        const sel = document.getElementById('assignAssignee');
        const deptInput = document.getElementById('assignDepartment');
        const supInput = document.getElementById('assignSupervisor');
        if(!sel || !deptInput) return;
        const uid = sel.value || '';
        const users = window.__users_cache || {};
        const u = users[uid] || null;
        // Use the exact department value stored on the user record as in company management
        const dept = (u && typeof u.department === 'string') ? u.department : '';
        deptInput.value = dept || '';

        // Also autofill Line Manager with the assignee's line manager name and job title
        if(supInput){
            const toName = (m)=> (m.displayName || m.name || (((m.firstName||'') + ' ' + (m.lastName||'')).trim()) || m.email || '').trim();
            const toJob = (m)=> (m.jobTitle || m.positionTitle || m.position || m.role || m.title || '').trim();

            let managerName = '';
            let managerJob = '';
            let mUser = null;

            // Gather possible references from assignee record
            const candKeys = ['managerUid','managerId','lineManagerUid','lineManagerId','line_manager_uid','supervisorUid','supervisorId','reportsTo','reportsToUid','reportsToId'];
            const emailKeys = ['lineManagerEmail','managerEmail','supervisorEmail'];
            let refVal = '';
            if(u){
                for(const k of candKeys){ if(u[k]){ refVal = (u[k]+'').trim(); if(refVal) break; } }
            }
            // If direct UID match
            if(refVal && users[refVal]){ mUser = users[refVal]; }
            // If looks like email
            if(!mUser && refVal && /@/.test(refVal)){
                const entries = Object.values(users||{});
                mUser = entries.find(x=> (x.email||'').toLowerCase() === refVal.toLowerCase()) || null;
            }
            // Try explicit email keys
            if(!mUser && u){
                for(const ek of emailKeys){ const ev=(u[ek]||'').trim(); if(ev){ const entries=Object.values(users||{}); mUser = entries.find(x=> (x.email||'').toLowerCase()===ev.toLowerCase()) || null; if(mUser) break; } }
            }
            // Try name matching as last resort
            if(!mUser && u){
                const nameGuess = (u.lineManagerName || u.lineManager || u.managerName || u.manager || u.supervisorName || u.supervisor || '').trim();
                if(nameGuess){
                    const entries = Object.values(users||{});
                    mUser = entries.find(x=> toName(x).toLowerCase() === nameGuess.toLowerCase()) || null;
                }
            }

            if(mUser){
                managerName = toName(mUser);
                managerJob = toJob(mUser);
            }

            // Fallbacks if not found via user object
            if(!managerName && u){
                managerName = (u.lineManagerName || u.lineManager || u.managerName || u.manager || u.supervisorName || u.supervisor || '').trim();
            }
            if(!managerJob && u){
                managerJob = (u.lineManagerJobTitle || u.managerJobTitle || u.supervisorJobTitle || '').trim();
            }

            const display = managerName && managerJob ? `${managerName} - ${managerJob}` : (managerName || '');
            supInput.value = display;
            supInput.title = display;
        }
    }catch(e){ console.warn('updateAssignmentDepartmentFromAssignee failed', e); }
}

function resetAssignmentForm(){
    const form = document.getElementById('assignmentForm'); if(form){ form.reset(); }
    const status = document.getElementById('assignmentStatus'); if(status){ status.style.display='none'; status.textContent=''; }
    const disp = document.getElementById('assignGeofenceSelected'); if(disp){ disp.style.display='none'; }
    const chips = document.getElementById('assignGeofenceChips'); if(chips){ chips.innerHTML=''; }
    __assignGeofenceSelections = [];
    // Reset selected drivers
    try{
        const dWrap = document.getElementById('assignDriversSelected'); if(dWrap){ dWrap.style.display='none'; }
        const dChips = document.getElementById('assignDriversChips'); if(dChips){ dChips.innerHTML=''; }
    }catch(_){ }
    __assignDriversSelections = [];
    // Reset selected sites (work areas)
    try{
        __selectedSites = [];
        const sel = document.getElementById('assignSite'); if(sel) sel.value='';
        const optsContainer = document.getElementById('assignSiteOptions');
        if(optsContainer){ Array.from(optsContainer.querySelectorAll('input.siteOptionChk')).forEach(i=>{ i.checked = false; }); }
        updateAssignSiteSummary();
        const panel = document.getElementById('assignSitePanel'); if(panel) panel.style.display='none';
        const toggle = document.getElementById('assignSiteToggle'); if(toggle) toggle.setAttribute('aria-expanded','false');
    }catch(_){ }
    // Reset selected activities
    try{
        __selectedActivities = [];
        const actSel = document.getElementById('assignActivities'); if(actSel) actSel.value='';
        const actOpts = document.getElementById('assignActivitiesOptions');
        if(actOpts){ Array.from(actOpts.querySelectorAll('input.activitiesOptionChk')).forEach(i=>{ i.checked = false; }); }
        if(typeof updateAssignActivitiesSummary === 'function') updateAssignActivitiesSummary();
        const pnl = document.getElementById('assignActivitiesPanel'); if(pnl) pnl.style.display='none';
        const tgl = document.getElementById('assignActivitiesToggle'); if(tgl) tgl.setAttribute('aria-expanded','false');
    }catch(_){ }
}

async function submitAssignmentRequest(e){
    e.preventDefault();
    const statusEl = document.getElementById('assignmentStatus');
    const get = (id)=> document.getElementById(id);
    const assigneeSel = get('assignAssignee');
    const assigneeUid = assigneeSel?.value?.trim() || '';
    const assignee = (assigneeSel && assigneeSel.options && assigneeSel.selectedIndex>=0) ? (assigneeSel.options[assigneeSel.selectedIndex].text || '').trim() : '';
    const dept = get('assignDepartment')?.value?.trim()||'';
    const requestType = get('assignRequestType')?.value || '';
    const site = get('assignSite')?.value?.trim()||'';
    const geofences = Array.isArray(__assignGeofenceSelections) ? __assignGeofenceSelections.slice() : [];
    const activities = Array.isArray(__selectedActivities) ? __selectedActivities.slice() : [];
    const driverUids = Array.isArray(__assignDriversSelections) ? __assignDriversSelections.slice() : [];
    const driverLabels = (driverUids||[]).map(uid=> renderUserLabel(uid));
    const start = get('assignStart')?.value;
    const reason = get('assignReason')?.value?.trim();
    const supervisor = get('assignSupervisor')?.value?.trim()||'';
    // phone field removed

    // Basic validation
    const errors = [];
    if(!assigneeUid) errors.push('Please select an assignee');
    if(!start) errors.push('Please choose a start date/time');
    if(!reason) errors.push('Please provide a reason for assignment');
    if(errors.length){
        if(statusEl){ statusEl.style.display='block'; statusEl.style.color='#b36b00'; statusEl.textContent = errors.join('  '); }
        return;
    }

    const user = window.authManager?.currentUser; const companyId = user?.companyId; if(!companyId){ if(statusEl){ statusEl.style.display='block'; statusEl.style.color='#b36b00'; statusEl.textContent = 'Not authenticated'; } return; }
    const req = {
        assignee,
    assigneeUid: assigneeUid || null,
        department: dept,
    requestType: requestType || 'New',
    site,
    geofence: geofences.join(', '),
    geofences,
    activities,
    activitiesText: activities.join(', '),
    drivers: driverLabels,
    driverUids,
    driversText: driverLabels.join(', '),
        startAt: start,
        reason,
        supervisor,
    // phone removed
        status: 'Pending',
        createdAt: new Date().toISOString(),
        createdBy: { uid: user.uid||null, name: user.name || user.displayName || user.email || 'Unknown' }
    };
    try{
        const ref = firebase.database().ref(`companies/${companyId}/vehicleAssignments`).push();
        await ref.set(req);
        if(statusEl){ statusEl.style.display='block'; statusEl.style.color='#2e7d32'; statusEl.textContent = 'Assignment request submitted.'; }
        // Close modal and refresh list
        closeAssignmentModal();
        resetAssignmentForm();
        await loadAssignments(true);
    }catch(err){ console.error('submitAssignmentRequest failed', err); if(statusEl){ statusEl.style.display='block'; statusEl.style.color='#b36b00'; statusEl.textContent = 'Failed to submit. Please try again.'; } }
}

async function loadAssignments(force){
    const tbody = document.getElementById('assignmentTableBody'); const empty = document.getElementById('assignmentEmpty'); if(!tbody) return;
    const user = window.authManager?.currentUser; const companyId = user?.companyId; if(!companyId){ return; }
    try{
        const snap = await firebase.database().ref(`companies/${companyId}/vehicleAssignments`).orderByChild('createdAt').limitToLast(100).once('value');
        const data = snap.val()||{}; __assignments_cache = data; const rows = [];
        const keys = Object.keys(data).sort((a,b)=> (data[b].createdAt||'').localeCompare(data[a].createdAt||''));
        keys.forEach((id, idx)=>{
            const r = data[id];
            const period = r && r.startAt ? `${formatShortDT(r.startAt)}` : '-';
            const vehLabel = (__vehicles_cache[r.vehicleId]||r.vehicleId||'-');
            rows.push(`<tr style="cursor:pointer;" onclick="openAssignmentDetails('${id}')"><td>${idx+1}</td><td>${formatShortDT(r.createdAt)}</td><td>${escapeHtml(vehLabel)}</td><td>${escapeHtml(r.assignee||'-')}</td><td>${escapeHtml(period)}</td><td>${escapeHtml(r.reason||'-')}</td><td>${escapeHtml(r.status||'-')}</td></tr>`);
        });
        tbody.innerHTML = rows.join('');
        if(empty){ empty.style.display = rows.length? 'none' : 'block'; }
    }catch(err){ console.error('loadAssignments failed', err); }
}

function formatShortDT(dt){ if(!dt) return '-'; try{ const d=new Date(dt); return d.toLocaleString(); }catch{ return dt; } }

function openAssignmentModal(){
    // Permission guard
    try{
        const perms = window.__fleet_action_perms || {};
        if(perms && perms.isAdmin!==true && perms.canAddAssignment===false){
            window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to create assignments.'});
            return;
        }
    }catch(e){ /* noop */ }
    const backdrop = document.getElementById('assignmentModalBackdrop');
    if(!backdrop) return;
    // Populate assignees and selects, then set defaults
    Promise.all([populateAssignmentAssignees()]).then(()=>{
        // Ensure selects have latest options
        populateAssignmentSiteSelect();
        populateAssignmentGeofenceSelect(); // base geofence options (generic)
        populateAssignmentActivitiesSelect();
        populateDriversSelect();
        // Bind cascading logic if not already
        const siteSel = document.getElementById('assignSite');
        if(siteSel && !siteSel.__geofenceBound){
            siteSel.addEventListener('change', updateAssignmentGeofenceFromSite);
            siteSel.__geofenceBound = true;
        }
        const geoSel = document.getElementById('assignGeofence');
        if(geoSel && !geoSel.__displayBound){
            geoSel.addEventListener('change', onGeofenceSelectChange);
            geoSel.__displayBound = true;
        }
        const drvSel = document.getElementById('assignDrivers');
        if(drvSel && !drvSel.__displayBound){
            drvSel.addEventListener('change', onDriverSelectChange);
            drvSel.__displayBound = true;
        }
        // Initialize geofence list according to current (possibly blank) site
    __assignGeofenceSelections = [];
    updateAssignmentGeofenceFromSite();
    updateSelectedGeofenceDisplay();
    __assignDriversSelections = [];
    updateSelectedDriversDisplay();
        // Initialize drivers list
        __assignDriversSelections = [];
        updateSelectedDriversDisplay();
        const now = new Date();
        const isoNow = toLocalISODateTime(now);
        const s = document.getElementById('assignStart'); if(s) s.value = isoNow;
        const rt = document.getElementById('assignRequestType'); if(rt) rt.value = 'New';
    });
    resetAssignmentForm();
    backdrop.style.display = 'flex';
    // Focus first input
    setTimeout(()=>{ document.getElementById('assignAssignee')?.focus?.(); }, 50);
}

// ===== Assignment Details (View) =====
let __currentAssignmentId = null;

function closeAssignmentViewModal(){ const b=document.getElementById('assignmentViewModalBackdrop'); if(b) b.style.display='none'; __currentAssignmentId=null; }
function onAssignmentViewBackdropClick(e){ if(e && e.target && e.target.id==='assignmentViewModalBackdrop') closeAssignmentViewModal(); }

async function openAssignmentDetails(id){
    try{
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId) return;
        __currentAssignmentId = id;
        let r = __assignments_cache && __assignments_cache[id];
        if(!r){
            const snap = await firebase.database().ref(`companies/${companyId}/vehicleAssignments/${id}`).once('value');
            r = snap.val()||null;
        }
        if(!r){ window.notificationManager?.addNotification?.({type:'warning', message:'Assignment not found'}); return; }
        // Populate view fields
        const set = (id, val)=>{ const el=document.getElementById(id); if(el){ el.textContent = (val==null || val==='')? '-' : String(val); } };
        set('viewAsgCreated', formatShortDT(r.createdAt));
        set('viewAsgStatus', r.status||'-');
        // Decision summary (approved/rejected metadata)
        try{
            let decisionText = '-';
            const status = (r.status||'').toLowerCase();
            if(status==='approved' && r.approvedBy){
                const who = r.approvedBy?.name || r.approvedBy?.email || r.approvedBy?.uid || 'Unknown';
                const when = r.approvedAt ? formatShortDT(r.approvedAt) : '';
                decisionText = `Approved by ${who}${when?` on ${when}`:''}`;
            }else if(status==='rejected' && r.rejectedBy){
                const who = r.rejectedBy?.name || r.rejectedBy?.email || r.rejectedBy?.uid || 'Unknown';
                const when = r.rejectedAt ? formatShortDT(r.rejectedAt) : '';
                const reason = r.rejectedReason ? `\nReason: ${r.rejectedReason}` : '';
                decisionText = `Rejected by ${who}${when?` on ${when}`:''}${reason}`;
            }
            const decEl = document.getElementById('viewAsgDecision');
            if(decEl) decEl.textContent = decisionText;
        }catch(_e){ /* ignore */ }
    set('viewAsgRequestType', r.requestType||'-');
        set('viewAsgAssignee', r.assignee||'-');
        set('viewAsgDept', r.department||'-');
        set('viewAsgSite', r.site||'-');
    const gf = Array.isArray(r.geofences) && r.geofences.length ? r.geofences.join('  ') : (r.geofence||'-');
    set('viewAsgGeofence', gf);
    const acts = Array.isArray(r.activities) && r.activities.length ? r.activities.join('  ') : (r.activitiesText || '-');
    set('viewAsgActivities', acts);
    set('viewAsgStart', formatShortDT(r.startAt));
        set('viewAsgReason', r.reason||'-');
        set('viewAsgSupervisor', r.supervisor||'-');
        const createdBy = r.createdBy && (r.createdBy.name || r.createdBy.email || r.createdBy.uid) ? (r.createdBy.name || r.createdBy.email || r.createdBy.uid) : '-';
        set('viewAsgCreatedBy', createdBy);
        // Build footer action buttons (Close + Approve/Reject)
        try{
            const footer = document.querySelector('#assignmentViewModalBackdrop .assignment-modal footer');
            if(footer){
                const left = `<div class=\"footer-left\"><button type=\"button\" class=\"btn-icon btn-light\" onclick=\"closeAssignmentViewModal()\">Close</button></div>`;
                let right = '';
                try{
                    const status = (r.status||'').toLowerCase();
                    const isFinal = status==='approved' || status==='rejected';
                    const hasPerm = (typeof __fleet_hasActionPerm==='function') ? __fleet_hasActionPerm('canApproveAssignment') : !!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canApproveAssignment);
                    if(hasPerm && !isFinal){
                        right = `
                        <div class=\"footer-right\">\
                            <button type=\"button\" class=\"btn-icon btn-approve\" onclick=\"approveAssignment('${id}')\" title=\"Approve\" aria-label=\"Approve assignment\">\
                                <i class=\\\"fas fa-check\\\"></i>\
                                <span class=\\\"btn-label\\\">Approve</span>\
                            </button>\
                            <button type=\"button\" class=\"btn-icon btn-reject\" onclick=\"rejectAssignment('${id}')\" title=\"Reject\" aria-label=\"Reject assignment\">\
                                <i class=\\\"fas fa-times\\\"></i>\
                                <span class=\\\"btn-label\\\">Reject</span>\
                            </button>\
                        </div>`;
                    }
                }catch(_e){ /* ignore */ }
                footer.innerHTML = left + right;
            }
        }catch(_e){ /* ignore footer rendering issues */ }
        const b = document.getElementById('assignmentViewModalBackdrop'); if(b) b.style.display='flex';
    }catch(err){ console.warn('openAssignmentDetails failed', err); }
}

// Approve assignment
async function approveAssignment(id){
    try{
        // Permission guard
        if(!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canApproveAssignment)){
            window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to approve assignments'});
            return;
        }
        const user = window.authManager?.currentUser; const companyId = user?.companyId; if(!companyId||!user){ return; }
        // Disable buttons to prevent double click
        const footer = document.querySelector('#assignmentViewModalBackdrop .assignment-modal footer');
        if(footer){ Array.from(footer.querySelectorAll('button')).forEach(b=> b.disabled = true); }
        const updates = {
            status: 'Approved',
            approvedAt: new Date().toISOString(),
            approvedBy: { uid: user.uid||null, name: user.displayName || user.name || user.email || 'Unknown' }
        };
        await firebase.database().ref(`companies/${companyId}/vehicleAssignments/${id}`).update(updates);
        // Update cache and UI
        if(__assignments_cache && __assignments_cache[id]){ Object.assign(__assignments_cache[id], updates); }
        const sEl = document.getElementById('viewAsgStatus'); if(sEl) sEl.textContent = 'Approved';
        window.notificationManager?.addNotification?.({type:'success', message:'Assignment approved'});
        // Rebuild buttons after decision
        openAssignmentDetails(id);
        // Refresh list
        try{ await loadAssignments(true); }catch(_){ }
    }catch(err){ console.error('approveAssignment failed', err); window.notificationManager?.addNotification?.({type:'warning', message:'Failed to approve'}); }
}

// Reject assignment
async function rejectAssignment(id){
    try{
        // Permission guard
        if(!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canApproveAssignment)){
            window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to reject assignments'});
            return;
        }
        const reason = window.prompt('Add a rejection reason (optional):', '') || '';
        const user = window.authManager?.currentUser; const companyId = user?.companyId; if(!companyId||!user){ return; }
        const footer = document.querySelector('#assignmentViewModalBackdrop .assignment-modal footer');
        if(footer){ Array.from(footer.querySelectorAll('button')).forEach(b=> b.disabled = true); }
        const updates = {
            status: 'Rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: { uid: user.uid||null, name: user.displayName || user.name || user.email || 'Unknown' },
            rejectedReason: reason || null
        };
        await firebase.database().ref(`companies/${companyId}/vehicleAssignments/${id}`).update(updates);
        if(__assignments_cache && __assignments_cache[id]){ Object.assign(__assignments_cache[id], updates); }
        const sEl = document.getElementById('viewAsgStatus'); if(sEl) sEl.textContent = 'Rejected';
        window.notificationManager?.addNotification?.({type:'success', message:'Assignment rejected'});
        openAssignmentDetails(id);
        try{ await loadAssignments(true); }catch(_){ }
    }catch(err){ console.error('rejectAssignment failed', err); window.notificationManager?.addNotification?.({type:'warning', message:'Failed to reject'}); }
}

function closeAssignmentModal(){
    const backdrop = document.getElementById('assignmentModalBackdrop');
    if(backdrop){ backdrop.style.display='none'; }
}

function onAssignmentBackdropClick(e){ closeAssignmentModal(); }

function getDefaultFleetVisibility(){
    return { showVehicles:true, showAnalytics:true, showMaintenance:true, showSettings:true, showAssignment:true };
}

async function ensureFleetVisibilityLoaded(){
    if(fleetVisibilityLoaded) return;
    const form = document.getElementById('fleetSettingsForm');
    if(!form) return;
    try {
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId){ return; }
        const snap = await firebase.database().ref(`companies/${companyId}/fleetVisibility`).once('value');
        fleetVisibilityConfig = snap.val() || getDefaultFleetVisibility();
        applyFleetVisibilityToUI();
        populateFleetVisibilityForm();
        fleetVisibilityLoaded = true;
        updateFleetSettingsStatus('Visibility settings loaded.', 'ok');
    } catch(err){
        console.warn('Failed loading fleet visibility', err);
        fleetVisibilityConfig = getDefaultFleetVisibility();
        applyFleetVisibilityToUI();
        populateFleetVisibilityForm();
        updateFleetSettingsStatus('Using default visibility (load failed).', 'warn');
    }
}

function populateFleetVisibilityForm(){
    const form = document.getElementById('fleetSettingsForm');
    if(!form || !fleetVisibilityConfig) return;
    form.showVehicles.checked = !!fleetVisibilityConfig.showVehicles;
    form.showAnalytics.checked = !!fleetVisibilityConfig.showAnalytics;
    form.showMaintenance.checked = !!fleetVisibilityConfig.showMaintenance;
    form.showSettings.checked = !!fleetVisibilityConfig.showSettings;
}

function applyFleetVisibilityToUI(){
    const cfg = fleetVisibilityConfig || getDefaultFleetVisibility();
    const vehiclesBtn = document.getElementById('vehiclesTabBtn');
    const analyticsBtn = document.getElementById('analyticsTabBtn');
    const maintenanceBtn = document.getElementById('maintenanceTabBtn');
    const settingsBtn = document.getElementById('settingsTabBtn');
    const assignmentBtn = document.getElementById('assignmentTabBtn');
    if(vehiclesBtn) vehiclesBtn.style.display = cfg.showVehicles? '' : 'none';
    if(analyticsBtn) analyticsBtn.style.display = cfg.showAnalytics? '' : 'none';
    if(maintenanceBtn) maintenanceBtn.style.display = cfg.showMaintenance? '' : 'none';
    if(settingsBtn) settingsBtn.style.display = cfg.showSettings? '' : 'none';
    if(assignmentBtn) assignmentBtn.style.display = (('showAssignment' in cfg)? !!cfg.showAssignment : !!cfg.showMaintenance) ? '' : 'none';
    // If current active tab is hidden now, switch to first visible
    const active = document.querySelector('.tab-nav-btn.active');
    if(active && active.style.display==='none'){
        const firstVisible = [vehiclesBtn, analyticsBtn, maintenanceBtn, assignmentBtn, settingsBtn].find(b=>b && b.style.display!=='none');
        if(firstVisible){ switchToTab(firstVisible.id.replace('TabBtn','')); }
    }
}

function updateFleetSettingsStatus(msg, type){
    const el = document.getElementById('fleetSettingsStatus');
    if(!el) return;
    el.textContent = msg;
    el.style.color = type==='ok'? '#2e7d32' : type==='warn'? '#b36b00' : '#555';
}

async function saveFleetVisibility(e){
    e.preventDefault();
    const form = document.getElementById('fleetSettingsForm');
    if(!form) return;
    const companyId = window.authManager?.currentUser?.companyId;
    if(!companyId){ updateFleetSettingsStatus('Not authenticated','warn'); return; }
    const newCfg = {
        showVehicles: !!form.showVehicles.checked,
        showAnalytics: !!form.showAnalytics.checked,
        showMaintenance: !!form.showMaintenance.checked,
        showSettings: !!form.showSettings.checked
    };
    try {
        await firebase.database().ref(`companies/${companyId}/fleetVisibility`).set(newCfg);
        fleetVisibilityConfig = newCfg;
        applyFleetVisibilityToUI();
        updateFleetSettingsStatus('Saved visibility settings.', 'ok');
    } catch(err){
        console.error('Save fleet visibility failed', err);
        updateFleetSettingsStatus('Save failed.', 'warn');
    }
}

function resetFleetVisibility(){
    fleetVisibilityConfig = getDefaultFleetVisibility();
    populateFleetVisibilityForm();
    applyFleetVisibilityToUI();
    updateFleetSettingsStatus('Reset to defaults (unsaved).','warn');
}

document.addEventListener('DOMContentLoaded', ()=>{
    const form = document.getElementById('fleetSettingsForm');
    if(form){
        form.addEventListener('submit', saveFleetVisibility);
    }
    const resetBtn = document.getElementById('resetFleetVisibilityBtn');
    if(resetBtn){ resetBtn.addEventListener('click', resetFleetVisibility); }
    // Attempt early load so tabs hide quickly
    ensureFleetVisibilityLoaded();
    // Initialize fleet access control system (after auth/company resolves)
    setTimeout(initializeFleetAccessControlSystem, 900);
    // Preload assignment vehicles if tab is defaulted later
    setTimeout(()=>{ if(document.getElementById('assignmentTabBtn')){ /* no-op */ } }, 500);
});

// Initialize fleet charts
function initializeFleetCharts() {
    if (fleetChart) {
        fleetChart.destroy();
    }
    
    loadVehicleDataForCharts().then(() => {
        updateFleetVisualization();
        updateFleetStats();
    });
}

// Load vehicle data for charts
async function loadVehicleDataForCharts() {
    try {
        const user = window.authManager?.currentUser;
        if (!user || !user.companyId) {
            console.warn('No user or company ID for chart data');
            return;
        }
        
        const snapshot = await firebase.database().ref(`companies/${user.companyId}/vehicles`).once('value');
        const data = snapshot.val();
        
        vehicleData = [];
        if (data) {
            Object.keys(data).forEach(key => {
                vehicleData.push({
                    id: key,
                    ...data[key]
                });
            });
        }
        
        console.log('Loaded vehicle data for charts:', vehicleData.length, 'vehicles');
    } catch (error) {
        console.error('Error loading vehicle data for charts:', error);
    }
}
/* ================= Fleet Access Control (Per-User Tab Visibility Overrides) ================= */
(function(){
    const FLEET_AC_PATH = (companyId) => `companies/${companyId}/fleetAccessControl/tabVisibility`;
    let __fleet_ac_users_cache = {}; let __fleet_ac_perms_cache = {};
    async function loadFleetAccessControlData(companyId){
        const db = firebase.database();
        const [usersSnap, permsSnap] = await Promise.all([
            db.ref(`companies/${companyId}/users`).once('value'),
            db.ref(FLEET_AC_PATH(companyId)).once('value')
        ]);
        return { users: usersSnap.val() || {}, perms: permsSnap.val() || {} };
    }
    function renderFleetAccessControlTable(companyId, users, perms){
        const tbody = document.getElementById('fleetAccessControlTableBody');
        const empty = document.getElementById('fleetAccessControlEmpty');
        if(!tbody) return; tbody.innerHTML='';
        const permUserIds = Object.keys(perms||{});
        if(permUserIds.length===0){ if(empty) empty.style.display='block'; return; } else { if(empty) empty.style.display='none'; }
        permUserIds.forEach(uid=>{
            const u = users[uid] || {}; const name = u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || '(No name)';
            const email = (u.accountType==='without-account' || u.reportingOnly===true || u.canSignIn===false) ? '-' : (u.email || '-');
            const role = u.role || 'User';
            const jobTitle = (u.jobTitle||u.positionTitle||u.position||'').trim();
            const p = perms[uid] || {};
            const tabsSummary = [p.showVehicles!==false? 'V':'', p.showMaintenance!==false? 'M':'', p.showAnalytics!==false? 'A':'', p.showDeepAnalytics!==false? 'D':'', (p.showAssignment!==false? 'Asg':''), p.showSettings!==false? 'S':''].join('');
            const actionsSummary = [p.canAddVehicle!==false? '+':'', p.canEditVehicle!==false? 'E':'', p.canDeleteVehicle!==false? 'Del':''].join('/');
            const inspSummary = [p.canAddInspection!==false? '+':'', p.canDeleteInspection!==false? 'Del':''].join('/');
            const assignSummary = [p.canAddAssignment!==false? '+':'', p.canApproveAssignment!==false? 'Appr':''].join('/');
            const mainTr = document.createElement('tr');
            mainTr.className = 'fleet-ac-user-row';
            mainTr.setAttribute('data-uid', uid);
            mainTr.innerHTML = `
                <td style="position:relative;">
                    <button type="button" class="perm-toggle" data-uid="${uid}" title="Toggle permissions" style="background:none;border:none;cursor:pointer;padding:0;margin-right:6px;font-size:.7rem;color:#555;">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <span>${name}</span>
                </td>
                <td>${email}</td>
                <td>${jobTitle || '-'}</td>
                <td style="font-size:.6rem;text-align:center;white-space:nowrap;">
                    <strong>Tabs:</strong> ${tabsSummary} &nbsp; <strong>Vehicles:</strong> ${actionsSummary} &nbsp; <strong>Insp:</strong> ${inspSummary} &nbsp; <strong>Assign:</strong> ${assignSummary}
                </td>`;
            tbody.appendChild(mainTr);
            const subTr = document.createElement('tr');
            subTr.className = 'fleet-ac-perms-row';
            subTr.setAttribute('data-uid', uid);
            subTr.style.display = 'none';
            subTr.innerHTML = `
                <td colspan="4" style="background:#f8fafc;border-top:1px solid #e2e8f0;">
                    <div style="display:flex;flex-wrap:wrap;gap:2rem;padding:.75rem .5rem;font-size:.65rem;">
                        <div style="min-width:180px;">
                            <h4 style="margin:0 0 .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Tab Visibility</h4>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="vehicles" data-uid="${uid}" ${p.showVehicles!==false ? 'checked':''}> Vehicles</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="maintenance" data-uid="${uid}" ${p.showMaintenance!==false ? 'checked':''}> Maintenance</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="analytics" data-uid="${uid}" ${p.showAnalytics!==false ? 'checked':''}> Analytics</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="deepAnalytics" data-uid="${uid}" ${p.showDeepAnalytics!==false ? 'checked':''}> Deep Analytics</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="assignment" data-uid="${uid}" ${p.showAssignment!==false ? 'checked':''}> Assignment</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="settings" data-uid="${uid}" ${p.showSettings!==false ? 'checked':''}> Settings</label>
                        </div>
                        <div style="min-width:180px;">
                            <h4 style="margin:0 0 .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Vehicle Actions</h4>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="addVehicle" data-uid="${uid}" ${p.canAddVehicle!==false ? 'checked':''}> Add Vehicle</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="editVehicle" data-uid="${uid}" ${p.canEditVehicle!==false ? 'checked':''}> Edit Vehicle</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="deleteVehicle" data-uid="${uid}" ${p.canDeleteVehicle!==false ? 'checked':''}> Delete Vehicle</label>
                        </div>
                        <div style="min-width:200px;">
                            <h4 style="margin:0 0 .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Maintenance Actions</h4>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="addInspection" data-uid="${uid}" ${p.canAddInspection!==false ? 'checked':''}> Add Inspection</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="deleteInspection" data-uid="${uid}" ${p.canDeleteInspection!==false ? 'checked':''}> Delete Inspection</label>
                        </div>
                        <div style="min-width:200px;">
                            <h4 style="margin:0 0 .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Assignment Actions</h4>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="addAssignment" data-uid="${uid}" ${p.canAddAssignment!==false ? 'checked':''}> Add Assignment</label>
                            <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-perm="approveAssignment" data-uid="${uid}" ${p.canApproveAssignment!==false ? 'checked':''}> Approve/Reject Assignment</label>
                        </div>
                    </div>
                </td>`;
            tbody.appendChild(subTr);
        });
        // Toggle handler
        tbody.onclick = (e)=>{
            const toggle = e.target.closest('.perm-toggle');
            if(toggle){
                const uid = toggle.getAttribute('data-uid');
                const sub = tbody.querySelector(`.fleet-ac-perms-row[data-uid="${uid}"]`);
                if(sub){
                    const icon = toggle.querySelector('i');
                    const isHidden = sub.style.display==='none';
                    sub.style.display = isHidden? 'table-row':'none';
                    if(icon){ icon.className = isHidden? 'fas fa-chevron-up' : 'fas fa-chevron-down'; }
                }
            }
        };
        // Checkbox persistence handler
        tbody.onchange = async (e)=>{
            const t = e.target; if(!t || !t.matches('input[type="checkbox"][data-uid]')) return;
            const uid=t.getAttribute('data-uid'); const permKey=t.getAttribute('data-perm'); const companyId=window.authManager?.currentUser?.companyId; if(!companyId||!uid) return;
            const update={};
            if(permKey==='vehicles') update.showVehicles=t.checked;
            if(permKey==='maintenance') update.showMaintenance=t.checked;
            if(permKey==='analytics') update.showAnalytics=t.checked;
            if(permKey==='deepAnalytics') update.showDeepAnalytics=t.checked;
            if(permKey==='settings') update.showSettings=t.checked;
            if(permKey==='assignment') update.showAssignment=t.checked;
            if(permKey==='addVehicle') update.canAddVehicle=t.checked;
            if(permKey==='editVehicle') update.canEditVehicle=t.checked;
            if(permKey==='deleteVehicle') update.canDeleteVehicle=t.checked;
            if(permKey==='addInspection') update.canAddInspection=t.checked;
            if(permKey==='deleteInspection') update.canDeleteInspection=t.checked;
            if(permKey==='addAssignment') update.canAddAssignment=t.checked;
            if(permKey==='approveAssignment') update.canApproveAssignment=t.checked;
            try {
                await firebase.database().ref(`${FLEET_AC_PATH(companyId)}/${uid}`).update(update);
                if(uid===window.authManager?.currentUser?.uid){ await applyFleetTabVisibilityForCurrentUser(companyId); }
                // Re-render to refresh summaries
                const {users,perms} = await loadFleetAccessControlData(companyId);
                cacheFleetAccess(users,perms);
                renderFleetAccessControlTable(companyId, users, perms);
            } catch(err){ console.error('Fleet access control update failed', err); }
        };
    }
    function cacheFleetAccess(users, perms){ __fleet_ac_users_cache=users||{}; __fleet_ac_perms_cache=perms||{}; }
    async function populateFleetAccessControlCard(){ const companyId=window.authManager?.currentUser?.companyId; if(!companyId) return; try{ const {users,perms}=await loadFleetAccessControlData(companyId); cacheFleetAccess(users,perms); renderFleetAccessControlTable(companyId,users,perms); }catch(e){ console.warn('Fleet access control load failed', e); } }
    async function applyFleetTabVisibilityForCurrentUser(companyId){ if(!companyId) return; const userId=window.authManager?.currentUser?.uid; if(!userId) return; const role=window.authManager?.currentCompany?.users?.[userId]?.role||''; const isAdmin=/admin/i.test(role); let override=null; if(!isAdmin){ const snap=await firebase.database().ref(`${FLEET_AC_PATH(companyId)}/${userId}`).once('value'); override=snap.val()||null; }
        const baseCfg=fleetVisibilityConfig||getDefaultFleetVisibility(); const effective=isAdmin?{showVehicles:true,showAnalytics:true,showMaintenance:true,showSettings:true,showDeepAnalytics:true,showAssignment:true}:{ showVehicles: override&&'showVehicles' in override? !!override.showVehicles: !!baseCfg.showVehicles, showAnalytics: override&&'showAnalytics' in override? !!override.showAnalytics: !!baseCfg.showAnalytics, showMaintenance: override&&'showMaintenance' in override? !!override.showMaintenance: !!baseCfg.showMaintenance, showSettings: override&&'showSettings' in override? !!override.showSettings: !!baseCfg.showSettings, showDeepAnalytics: override&&'showDeepAnalytics' in override? !!override.showDeepAnalytics: true, showAssignment: override&&'showAssignment' in override? !!override.showAssignment : (('showAssignment' in baseCfg)? !!baseCfg.showAssignment : !!baseCfg.showMaintenance) };
        // Compute action permissions (default allow for non-admins unless explicitly set to false)
        const actionPerms = isAdmin ? { canAddVehicle:true, canEditVehicle:true, canDeleteVehicle:true, canAddInspection:true, canDeleteInspection:true, canAddAssignment:true, canApproveAssignment:true } : {
            canAddVehicle: !(override && ('canAddVehicle' in override) && override.canAddVehicle===false),
            canEditVehicle: !(override && ('canEditVehicle' in override) && override.canEditVehicle===false),
            canDeleteVehicle: !(override && ('canDeleteVehicle' in override) && override.canDeleteVehicle===false),
            canAddInspection: !(override && ('canAddInspection' in override) && override.canAddInspection===false),
            canDeleteInspection: !(override && ('canDeleteInspection' in override) && override.canDeleteInspection===false),
            canAddAssignment: !(override && ('canAddAssignment' in override) && override.canAddAssignment===false),
            canApproveAssignment: !(override && ('canApproveAssignment' in override) && override.canApproveAssignment===false)
        };
        // cache for click-time checks
        window.__fleet_action_perms = { ...actionPerms, isAdmin };
        // Tab button + content mapping
        const tabDefs = [
            {key:'showVehicles', btnId:'vehiclesTabBtn', contentId:'vehiclesTabContent'},
            {key:'showAnalytics', btnId:'analyticsTabBtn', contentId:'analyticsTabContent'},
            {key:'showDeepAnalytics', btnId:'deepAnalyticsTabBtn', contentId:'deepAnalyticsTabContent', depends:'showAnalytics'},
            {key:'showMaintenance', btnId:'maintenanceTabBtn', contentId:'maintenanceTabContent'},
            {key:'showAssignment', btnId:'assignmentTabBtn', contentId:'assignmentTabContent'},
            {key:'showSettings', btnId:'settingsTabBtn', contentId:'settingsTabContent'}
        ];
        let firstAllowed=null; let activeStillPresent=false;
        tabDefs.forEach(def=>{
            const allowed = effective[def.key] && (!def.depends || effective[def.depends]);
            const btn = document.getElementById(def.btnId);
            const content = document.getElementById(def.contentId);
            if(!btn || !content) return;
            if(allowed){
                btn.style.display='';
                if(!firstAllowed) firstAllowed=def;
                if(btn.classList.contains('active')) activeStillPresent=true;
            } else {
                // Remove unauthorized tabs entirely
                btn.parentNode && btn.parentNode.removeChild(btn);
                content.parentNode && content.parentNode.removeChild(content);
            }
        });
        // Ensure we have an active tab that is allowed
        if(!activeStillPresent && firstAllowed){
            // Clear any lingering active classes
            document.querySelectorAll('.tab-nav-btn.active').forEach(b=> b.classList.remove('active'));
            const firstBtn=document.getElementById(firstAllowed.btnId);
            if(firstBtn){ firstBtn.classList.add('active'); switchToTab(firstAllowed.btnId.replace('TabBtn','')); }
        }
        // Enforce action button permissions now that tabs are finalized
        const addHeaderBtn = document.getElementById('addVehicleHeaderBtn');
        if(addHeaderBtn){ addHeaderBtn.style.display = actionPerms.canAddVehicle ? addHeaderBtn.style.display : 'none'; if(!actionPerms.canAddVehicle && document.getElementById('vehiclesTabBtn')?.classList.contains('active')){ addHeaderBtn.style.display = 'none'; } }
        document.querySelectorAll('.btn-edit').forEach(btn=>{ btn.style.display = actionPerms.canEditVehicle ? '' : 'none'; });
        document.querySelectorAll('.btn-delete').forEach(btn=>{ btn.style.display = actionPerms.canDeleteVehicle ? '' : 'none'; });
        const newInspBtn = document.getElementById('newInspectionBtn'); if(newInspBtn){ newInspBtn.style.display = actionPerms.canAddInspection ? '' : 'none'; }
        const addFirstInspBtn = document.getElementById('addFirstInspectionBtn'); if(addFirstInspBtn){ addFirstInspBtn.style.display = actionPerms.canAddInspection ? '' : 'none'; }
        document.querySelectorAll('#inspectionTableBody .btn-action.btn-danger').forEach(btn=>{ btn.style.display = actionPerms.canDeleteInspection ? '' : 'none'; });
        const newAssignBtn = document.getElementById('newAssignmentBtn'); if(newAssignBtn){ newAssignBtn.style.display = actionPerms.canAddAssignment ? '' : 'none'; }
        // Reveal UI after pruning
        document.documentElement.classList.remove('fleet-prehide');
    }
    function populateFleetAccessControlModalOptions(searchTerm){
        const select=document.getElementById('fleetAcUserSelect');
        if(!select) return;
        const existing=new Set(Object.keys(__fleet_ac_perms_cache||{}));
        select.innerHTML='<option value="">-- Choose user --</option>';
        Object.entries(__fleet_ac_users_cache||{}).forEach(([uid,u])=>{
            if(existing.has(uid)) return;
            const name=(u.displayName||u.name||`${u.firstName||''} ${u.lastName||''}`.trim()||'(No name)').trim();
            const jobTitle=(u.jobTitle||u.positionTitle||u.position||u.role||'').trim();
            const filter=(searchTerm||'').toLowerCase();
            if(filter){
                const hay=(name+' '+jobTitle).toLowerCase();
                if(!hay.includes(filter)) return;
            }
            const label = jobTitle ? `${name} - ${jobTitle}` : name;
            const opt=document.createElement('option');
            opt.value=uid;
            opt.textContent=label;
            select.appendChild(opt);
        });
    }
    window.openFleetAccessControlModal = async function(){ const companyId=window.authManager?.currentUser?.companyId; if(!companyId) return; try { const {users,perms}=await loadFleetAccessControlData(companyId); cacheFleetAccess(users,perms); populateFleetAccessControlModalOptions(''); ['fleetAcVehicles','fleetAcMaintenance','fleetAcAnalytics','fleetAcDeepAnalytics','fleetAcAssignment','fleetAcSettings','fleetAcAddVehicle','fleetAcEditVehicle','fleetAcDeleteVehicle','fleetAcAddInspection','fleetAcDeleteInspection','fleetAcAddAssignment','fleetAcApproveAssignment'].forEach(id=>{ const el=document.getElementById(id); if(el) el.checked=true; }); const modal=document.getElementById('fleetAccessControlModal'); if(modal){ modal.style.display='flex'; modal.classList.add('show'); } const search=document.getElementById('fleetAcUserSearch'); if(search){ search.value=''; search.oninput=()=> populateFleetAccessControlModalOptions(search.value); } } catch(e){ console.warn('Open fleet AC modal failed', e); } };
    window.saveFleetAccessControlFromModal = async function(){ const companyId=window.authManager?.currentUser?.companyId; if(!companyId) return; const uid=document.getElementById('fleetAcUserSelect')?.value||''; if(!uid){ window.notificationManager?.addNotification?.({type:'warning', message:'Choose a user'}); return; } const cfg={ showVehicles: !!document.getElementById('fleetAcVehicles')?.checked, showMaintenance: !!document.getElementById('fleetAcMaintenance')?.checked, showAnalytics: !!document.getElementById('fleetAcAnalytics')?.checked, showDeepAnalytics: !!document.getElementById('fleetAcDeepAnalytics')?.checked, showAssignment: !!document.getElementById('fleetAcAssignment')?.checked, showSettings: !!document.getElementById('fleetAcSettings')?.checked, canAddVehicle: !!document.getElementById('fleetAcAddVehicle')?.checked, canEditVehicle: !!document.getElementById('fleetAcEditVehicle')?.checked, canDeleteVehicle: !!document.getElementById('fleetAcDeleteVehicle')?.checked, canAddInspection: !!document.getElementById('fleetAcAddInspection')?.checked, canDeleteInspection: !!document.getElementById('fleetAcDeleteInspection')?.checked, canAddAssignment: !!document.getElementById('fleetAcAddAssignment')?.checked, canApproveAssignment: !!document.getElementById('fleetAcApproveAssignment')?.checked }; try { await firebase.database().ref(`${FLEET_AC_PATH(companyId)}/${uid}`).set(cfg); await populateFleetAccessControlCard(); closeModal('fleetAccessControlModal'); window.notificationManager?.addNotification?.({type:'success', message:'Fleet access control added'}); if(uid===window.authManager?.currentUser?.uid){ await applyFleetTabVisibilityForCurrentUser(companyId); } } catch(err){ console.error('Save fleet AC failed', err); window.notificationManager?.addNotification?.({type:'error', message:'Save failed'}); } };
    document.addEventListener('click', async (e)=>{ const btn=e.target.closest?.('.tab-nav-btn'); if(!btn) return; const tab=btn.id?.replace('TabBtn','')||''; if(!tab) return; const companyId=window.authManager?.currentUser?.companyId; const userId=window.authManager?.currentUser?.uid; if(!companyId||!userId) return; const role=window.authManager?.currentCompany?.users?.[userId]?.role||''; if(/admin/i.test(role)) return; const snap=await firebase.database().ref(`${FLEET_AC_PATH(companyId)}/${userId}`).once('value'); const override=snap.val()||{}; const baseCfg=fleetVisibilityConfig||getDefaultFleetVisibility(); const allow=(k)=> k in override ? !!override[k] : !!baseCfg[k]; const map={vehicles:'showVehicles',maintenance:'showMaintenance',analytics:'showAnalytics',deepAnalytics:'showDeepAnalytics',assignment:'showAssignment',settings:'showSettings'}; const permKey=map[tab]; if(permKey && !allow(permKey)){ e.preventDefault(); window.notificationManager?.addNotification?.({type:'warning', message:'You do not have access to this tab'}); } });
    window.initializeFleetAccessControlSystem = async function(){ const companyId=window.authManager?.currentUser?.companyId; if(!companyId){ setTimeout(initializeFleetAccessControlSystem,600); return; } await populateFleetAccessControlCard(); await applyFleetTabVisibilityForCurrentUser(companyId); };
})();
// Inject Fleet Access Control Modal markup
document.addEventListener('DOMContentLoaded', ()=>{ if(!document.getElementById('fleetAccessControlModal')){ const modal=document.createElement('div'); modal.id='fleetAccessControlModal'; modal.className='modal'; modal.innerHTML=`<div class="modal-content" style="max-width:640px;"><div class="modal-header"><h5 style="font-size:.95rem;display:flex;align-items:center;gap:.5rem;"><i class="fas fa-user-shield"></i> Add Fleet Access Control User</h5><button type="button" onclick="closeModal('fleetAccessControlModal')" style="background:none;border:none;font-size:1rem;cursor:pointer;">&times;</button></div><div class="modal-body" style="padding:1rem;display:flex;flex-direction:column;gap:1rem;"><div style="display:flex;flex-direction:column;gap:.35rem;"><label style="font-size:.65rem;font-weight:600;">User</label><div style="display:flex;gap:.5rem;align-items:stretch;"><input id="fleetAcUserSearch" type="text" placeholder="Search by name or job title" style="flex:0 0 40%;min-width:160px;padding:.4rem .55rem;border:1px solid #ced4da;border-radius:6px;font-size:.7rem;"/><select id="fleetAcUserSelect" style="flex:1 1 auto;min-width:220px;padding:.45rem .6rem;border:1px solid #ced4da;border-radius:6px;font-size:.7rem;"></select></div><small style="font-size:.55rem;color:#64748b;">Type to filter. Only users not already added will appear.</small></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.6rem;">
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcVehicles" checked> Vehicles Tab</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcMaintenance" checked> Maintenance Tab</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcAnalytics" checked> Analytics Tab</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcDeepAnalytics" checked> Deep Analytics Tab</label>
 <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcAssignment" checked> Assignment Tab</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcSettings" checked> Settings Tab</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcAddVehicle" checked> Add Vehicle</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcEditVehicle" checked> Edit Vehicle</label>
<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcDeleteVehicle" checked> Delete Vehicle</label>
 <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcAddInspection" checked> Add Inspection</label>
 <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcDeleteInspection" checked> Delete Inspection</label>
    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcAddAssignment" checked> Add Assignment</label>
    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="fleetAcApproveAssignment" checked> Approve/Reject Assignment</label>
</div></div><div class="modal-footer" style="padding:1rem;display:flex;justify-content:flex-end;gap:.5rem;"><button type="button" class="btn btn-secondary" style="font-size:.65rem;" onclick="closeModal('fleetAccessControlModal')">Cancel</button><button type="button" class="btn btn-success" style="font-size:.65rem;display:inline-flex;align-items:center;gap:6px;" onclick="saveFleetAccessControlFromModal()"><i class="fas fa-save"></i> Save</button></div></div>`; document.body.appendChild(modal); } });

// Update fleet visualization
function updateFleetVisualization() {
    const chartType = document.getElementById('chartTypeSelect').value;
    const dataSource = document.getElementById('dataSourceSelect').value;
    const groupBy = document.getElementById('groupBySelect').value;
    
    const filteredData = filterVehicleData(dataSource);
    const chartData = groupVehicleData(filteredData, groupBy);
    
    createFleetChart(chartType, chartData, groupBy);
}

// Filter vehicle data based on source
function filterVehicleData(source) {
    switch (source) {
        case 'active':
            return vehicleData.filter(v => v.vehicleStatus === 'Active' || v.status === 'Active');
        case 'inactive':
            return vehicleData.filter(v => v.vehicleStatus === 'Inactive' || v.status === 'Inactive');
        case 'maintenance':
            return vehicleData.filter(v => v.vehicleStatus === 'Maintenance' || v.status === 'Maintenance');
        default:
            return vehicleData;
    }
}

// Group vehicle data for charts
function groupVehicleData(data, groupBy) {
    const groups = {};
    
    data.forEach(vehicle => {
        let key;
        switch (groupBy) {
            case 'status':
                key = vehicle.vehicleStatus || vehicle.status || 'Unknown';
                break;
            case 'department':
                key = vehicle.assignmentDept || vehicle.assignmentDepartment || vehicle.department || 'Unassigned';
                break;
            case 'vehicleType':
                key = vehicle.vehicleType || 'Unknown Type';
                break;
            case 'fuelType':
                key = vehicle.fuelType || 'Unknown Fuel';
                break;
            case 'site':
                key = vehicle.siteAssignment || vehicle.workArea || vehicle.site || 'Unassigned';
                break;
            default:
                key = 'Other';
        }
        
        groups[key] = (groups[key] || 0) + 1;
    });
    
    return groups;
}

// Create fleet chart
function createFleetChart(type, data, groupBy) {
    const ctx = document.getElementById('fleetMainChart').getContext('2d');
    
    if (fleetChart) {
        fleetChart.destroy();
    }
    
    const labels = Object.keys(data);
    const values = Object.values(data);
    
    const colors = [
        '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#16a085'
    ];
    
    const config = {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: getChartLabel(groupBy),
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: colors.slice(0, labels.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: type === 'pie' || type === 'doughnut' ? 'right' : 'top'
                },
                title: {
                    display: true,
                    text: `Fleet Distribution by ${getChartLabel(groupBy)}`
                }
            },
            scales: type === 'pie' || type === 'doughnut' ? {} : {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };
    
    fleetChart = new Chart(ctx, config);
}

// =============================
// Deep Analytics: Filters, Data, Pareto Chart, Table
// =============================
function initializeDeepAnalytics(){
    try{
        // Ensure vehicle list and inspections are available
        const ensureVehicles = async ()=>{
            if(!vehicleData || vehicleData.length===0){ await loadVehicleDataForCharts(); }
        };
        const ensureInspections = async ()=>{
            // Reuse loader; it renders table but that's fine
            await loadInspections(true);
        };
        Promise.all([ensureVehicles(), ensureInspections()]).then(()=>{
            populateDeepVehicleOptions();
            populateDeepTypeFilter();
            populateDeepFieldSelectWithTypes();
            populateDeepComplianceItems();
            setDefaultDeepDateRange();
            attachDeepAnalyticsListeners();
            updateDeepAnalytics();
        });
    } catch(e){ console.warn('Deep analytics init failed', e); }
}

function populateDeepVehicleOptions(){
    const sel = document.getElementById('deepVehicleFilter');
    if(!sel) return;
    // Preserve first option (All vehicles)
    const first = sel.querySelector('option');
    sel.innerHTML = '';
    if(first){ sel.appendChild(first); }
    (vehicleData||[]).forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.id || v.vehicleId || v.plateNumber || v.plate || '';
        opt.textContent = `${v.name||v.vehicleName||v.plateNumber||v.plate||'Vehicle'} (${v.plateNumber||v.plate||'n/a'})`;
        sel.appendChild(opt);
    });
}

function setDefaultDeepDateRange(){
    const end = document.getElementById('deepEndDate');
    const start = document.getElementById('deepStartDate');
    if(!start || !end) return;
    const today = new Date();
    const past = new Date();
    past.setDate(today.getDate()-90);
    end.value = today.toISOString().slice(0,10);
    start.value = past.toISOString().slice(0,10);
}

function getRecordTypeLabel(rec){
    const mt = (rec?.maintenanceType || '').toString();
    if(mt){
        if(/routine/i.test(mt)) return 'Compliance';
        if(/preventive/i.test(mt)) return 'Preventive Maintenance';
        if(/corrective/i.test(mt)) return 'Corrective Maintenance';
        if(/emergency/i.test(mt)) return 'General Inspection';
        return mt; // fallback: show as-is
    }
    const rt = (rec?.reportType || '').toString();
    if(rt){
        if(/full/i.test(rt)) return 'Full Inspection';
        if(/maintenance/i.test(rt)) return 'Maintenance';
        if(/quick/i.test(rt)) return 'Quick Check';
        return rt;
    }
    const generic = (rec?.type || rec?.category || rec?.inspectionType || '').toString();
    return generic || 'Unknown';
}

function normalizeTypeKey(label){
    return (label||'').toString().trim().toLowerCase();
}

function populateDeepTypeFilter(){
    const sel = document.getElementById('deepTypeFilter');
    if(!sel) return;
    const first = sel.querySelector('option');
    sel.innerHTML = '';
    if(first){ sel.appendChild(first); }
    const types = new Set();
    (inspectionsData||[]).forEach(r=>{
        const label = getRecordTypeLabel(r);
        if(label && label!=='Unknown') types.add(label);
    });
    Array.from(types).sort((a,b)=> a.localeCompare(b)).forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
    });
}

// Populate the "deepFieldSelect" with the same Type options as the maintenance modal
function populateDeepFieldSelectWithTypes(){
    const sel = document.getElementById('deepFieldSelect');
    if(!sel) return;
    const first = sel.querySelector('option');
    sel.innerHTML = '';
    if(first){ sel.appendChild(first); }
    const types = new Set();
    (inspectionsData||[]).forEach(r=>{
        const label = getRecordTypeLabel(r);
        if(label && label!== 'Unknown') types.add(label);
    });
    Array.from(types).sort((a,b)=> a.localeCompare(b)).forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
    });
}

function attachDeepAnalyticsListeners(){
    const ids = ['deepTypeFilter','deepVehicleFilter','deepStartDate','deepEndDate','deepFieldSelect'];
    // Ensure immediate updates on both change and input events
    ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.onchange = ()=> updateDeepAnalytics();
        el.addEventListener('input', ()=> updateDeepAnalytics());
    });
    const clearBtn = document.getElementById('deepClearFilters');
    if(clearBtn){ clearBtn.addEventListener('click', clearDeepAnalyticsFilters); }
    const fieldSel = document.getElementById('deepFieldSelect');
    if(fieldSel){
        fieldSel.addEventListener('change', ()=>{
            const wrap = document.getElementById('deepComplianceItemsWrap');
            const primaryType = document.getElementById('deepTypeFilter');
            const selectedType = (primaryType?.value||'') || (fieldSel.value||'');
            if(wrap){ wrap.style.display = selectedType ? '' : 'none'; }
            if(selectedType){
                populateDeepComplianceItems();
            }
            // Always update immediately after any filter change
            updateDeepAnalytics();
        });
    }
    // Also react to primary Type filter
    const primaryType = document.getElementById('deepTypeFilter');
    if(primaryType){
        primaryType.addEventListener('change', ()=>{
            const wrap = document.getElementById('deepComplianceItemsWrap');
            const secondary = document.getElementById('deepFieldSelect');
            const selectedType = (primaryType.value||'') || (secondary?.value||'');
            if(wrap){ wrap.style.display = selectedType ? '' : 'none'; }
            if(selectedType){
                populateDeepComplianceItems();
            }
            // Always update immediately after any filter change
            updateDeepAnalytics();
        });
    }
    // Dropdown toggle
    const dd = document.getElementById('deepComplianceDropdown');
    const toggle = document.getElementById('deepComplianceToggle');
    const options = document.getElementById('deepComplianceOptions');
    const search = document.getElementById('deepComplianceSearch');
    if(toggle && dd){
        toggle.addEventListener('click', (e)=>{
            e.stopPropagation();
            dd.classList.toggle('open');
            if(dd.classList.contains('open') && search){ search.focus(); }
        });
        document.addEventListener('click', (e)=>{
            if(!dd.contains(e.target)){ dd.classList.remove('open'); }
        });
    }
    // Options change via delegation
    if(options){
        options.addEventListener('change', (e)=>{
            const cb = e.target;
            if(cb && cb.matches('input[type="checkbox"][data-key]')){
                const key = cb.getAttribute('data-key');
                if(cb.checked){ deepComplianceSelected.add(key); } else { deepComplianceSelected.delete(key); }
                updateDeepComplianceToggle();
                updateDeepAnalytics();
            }
        });
    }
    // Search filter
    if(search){
        search.addEventListener('input', ()=> filterDeepComplianceOptions(search.value||''));
    }
}

function clearDeepAnalyticsFilters(){
    try{
        const typeSel = document.getElementById('deepTypeFilter');
        const vehSel = document.getElementById('deepVehicleFilter');
        const start = document.getElementById('deepStartDate');
        const end = document.getElementById('deepEndDate');
        const fieldSel = document.getElementById('deepFieldSelect');
        const itemsWrap = document.getElementById('deepComplianceItemsWrap');
        const options = document.getElementById('deepComplianceOptions');
        const toggle = document.getElementById('deepComplianceToggle');
        const search = document.getElementById('deepComplianceSearch');

        if(typeSel) typeSel.value = '';
        if(vehSel) vehSel.value = '';
        if(start) start.value = '';
        if(end) end.value = '';
        if(fieldSel) fieldSel.value = '';

        // Clear selected inspection items
        if(typeof deepComplianceSelected !== 'undefined'){
            deepComplianceSelected.clear?.();
        }
        if(options){
            Array.from(options.querySelectorAll('input[type="checkbox"][data-key]')).forEach(cb=> cb.checked = false);
        }
        if(toggle){ toggle.textContent = 'All items'; }
        if(search){ search.value = ''; }
        if(itemsWrap){ itemsWrap.style.display = 'none'; }

        updateDeepAnalytics();
    }catch(err){ console.error('Failed to clear filters', err); }
}

function getSelectedComplianceItems(){
    return Array.from(deepComplianceSelected);
}

function populateDeepComplianceItems(){
    const options = document.getElementById('deepComplianceOptions');
    if(!options) return;
    const keys = new Set();
    (inspectionsData||[]).forEach(r=>{
        const comp = r.compliance || {};
        Object.values(comp).forEach(group=>{
            if(!group) return;
            Object.keys(group).forEach(k=> keys.add(k));
        });
    });
    const allKeys = Array.from(keys).sort((a,b)=> humanizeKey(a).localeCompare(humanizeKey(b)));
    // Preserve previously selected keys that still exist
    deepComplianceSelected = new Set(Array.from(deepComplianceSelected).filter(k=> keys.has(k)));
    // Render
    if(allKeys.length===0){
        options.innerHTML = `<div class="multi-dropdown-empty">No compliance items found</div>`;
    } else {
        options.innerHTML = allKeys.map(k=>{
            const checked = deepComplianceSelected.has(k) ? 'checked' : '';
            const label = escapeHtml(humanizeKey(k));
            return `<label class="multi-dropdown-option"><input type="checkbox" data-key="${escapeHtml(k)}" ${checked}> <span>${label}</span></label>`;
        }).join('');
    }
    updateDeepComplianceToggle();
}

function updateDeepComplianceToggle(){
    const toggle = document.getElementById('deepComplianceToggle');
    const count = deepComplianceSelected.size;
    if(toggle){ toggle.textContent = count ? `${count} selected` : 'All items'; }
}

function filterDeepComplianceOptions(query){
    const q = (query||'').toLowerCase();
    const options = document.getElementById('deepComplianceOptions');
    if(!options) return;
    Array.from(options.children).forEach(row=>{
        const span = row.querySelector('span');
        const txt = span ? span.textContent.toLowerCase() : '';
        row.style.display = txt.includes(q) ? '' : 'none';
    });
}

function updateDeepAnalytics(){
    const typeSel = document.getElementById('deepTypeFilter');
    // Prefer the explicit Type filter; if empty, fall back to the second select (now showing Type options)
    const selType = ((typeSel?.value || '').trim()) || ((document.getElementById('deepFieldSelect')?.value || '').trim());
    const vehicleId = document.getElementById('deepVehicleFilter')?.value || '';
    const startStr = document.getElementById('deepStartDate')?.value || '';
    const endStr = document.getElementById('deepEndDate')?.value || '';
    const breakdown = 'status';

    const start = startStr? new Date(startStr+'T00:00:00') : null;
    const end = endStr? new Date(endStr+'T23:59:59') : null;

    // Filter inspections by type, date and vehicle
    const filtered = (inspectionsData||[]).filter(r=>{
        if(selType){
            const recLabel = getRecordTypeLabel(r);
            if(normalizeTypeKey(recLabel) !== normalizeTypeKey(selType)) return false;
        }
        if(vehicleId && r.vehicleId !== vehicleId) return false;
        if(start || end){
            const d = r.date ? new Date(r.date+'T12:00:00') : (r.createdAt? new Date(r.createdAt) : null);
            if(!d) return false;
            if(start && d < start) return false;
            if(end && d > end) return false;
        }
        return true;
    });

    // If inspection items are selected, filter to records that contain any of those items in compliance groups
    const selectedItems = getSelectedComplianceItems();
    const allowedItems = (selectedItems && selectedItems.length) ? new Set(selectedItems) : null;
    const filteredWithItems = allowedItems ? filtered.filter(r=>{
        const comp = r.compliance || {};
        let matched = false;
        Object.values(comp).forEach(group=>{
            if(matched || !group) return;
            Object.keys(group).some(k=>{
                if(allowedItems.has(k)){ matched = true; return true; }
                return false;
            });
        });
        return matched;
    }) : filtered;

    // Build breakdown counts
    let counts = {};
    if(allowedItems && allowedItems.size){
        // When specific inspection items are selected, show a Pareto by item on the chart
        counts = aggregateComplianceIssues(filtered, allowedItems);
        renderDeepPareto(counts, 'complianceIssues');
    } else {
        // Default: show status distribution
        counts = aggregateByStatus(filteredWithItems);
        renderDeepPareto(counts, 'status');
    }

    renderDeepTable(filteredWithItems);
}

function aggregateActionItemTitles(records){
    const map = {};
    (records||[]).forEach(r=>{
        (r.actionItems||[]).forEach(a=>{
            const key = (a.title||'').trim().toLowerCase();
            if(!key) return;
            map[key] = (map[key]||0)+1;
        });
    });
    return map;
}

function aggregateComplianceIssues(records){
    const badStatuses = new Set(['Issue','Missing','Expired']);
    const map = {};
    (records||[]).forEach(r=>{
        const comp = r.compliance || {};
        Object.values(comp).forEach(group=>{
            if(!group) return;
            Object.entries(group).forEach(([k,v])=>{
                const st = v && v.status;
                if(badStatuses.has(st)){
                    if(!arguments[1] || (arguments[1] && arguments[1].has && arguments[1].has(k))){
                        map[k] = (map[k]||0)+1; // use raw key; label later
                    }
                }
            });
        });
    });
    return map;
}

function aggregateByStatus(records){
    const map = {};
    (records||[]).forEach(r=>{
        const key = r.status || 'Unknown';
        map[key] = (map[key]||0)+1;
    });
    return map;
}

function humanizeKey(key){
    if(!key) return '';
    return String(key)
        .replace(/([a-z])([A-Z])/g,'$1 $2')
        .replace(/_/g,' ')
        .replace(/\s+/g,' ')
        .trim()
        .replace(/\b\w/g, c=> c.toUpperCase());
}

function renderDeepPareto(counts, breakdown){
    const ctx = document.getElementById('deepParetoChart')?.getContext('2d');
    if(!ctx) return;
    if(deepParetoChart){ deepParetoChart.destroy(); }

    const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
    const labels = entries.map(([k])=> (breakdown==='complianceIssues' ? humanizeKey(k) : k));
    const values = entries.map(([,v])=> v);
    const total = values.reduce((s,v)=> s+v, 0) || 1;
    let cum = 0;
    const cumulative = values.map(v=>{ cum += v; return +(cum/total*100).toFixed(1); });

    deepParetoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Count',
                    data: values,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: 'Cumulative %',
                    data: cumulative,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231,76,60,0.15)',
                    yAxisID: 'y1',
                    tension: 0.3,
                    pointRadius: 2,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: getDeepChartTitle(breakdown) }
            },
            scales: {
                x: {
                    ticks: {
                        autoSkip: false,
                        minRotation: 90,
                        maxRotation: 90,
                        font: { size: 10 }
                    }
                },
                y: { beginAtZero: true, title: { display:true, text:'Count' } },
                y1: { beginAtZero: true, min:0, max:100, position: 'right', grid: { drawOnChartArea: false }, title: { display:true, text:'Cumulative %' } }
            }
        }
    });
}

function getDeepChartTitle(breakdown){
    if(breakdown==='actionTitles') return 'Pareto: Action Items by Title';
    if(breakdown==='complianceIssues') return 'Pareto: Compliance Issues by Item';
    if(breakdown==='status') return 'Distribution: Inspection Status';
    return 'Deep Analytics';
}

function renderDeepTable(records){
    const tbody = document.getElementById('deepAnalyticsTableBody');
    const empty = document.getElementById('deepAnalyticsEmpty');
    if(!tbody) return;
    tbody.innerHTML = '';
    if(!records || !records.length){ if(empty) empty.style.display='block'; return; }
    if(empty) empty.style.display='none';
    records.forEach((r,i)=>{
        const tr = document.createElement('tr');
        const actionsCount = Array.isArray(r.actionItems) ? r.actionItems.length : 0;
        const compIssuesCount = (()=>{
            const comp = r.compliance || {}; let c=0;
            Object.values(comp).forEach(group=>{ if(!group) return; Object.values(group).forEach(v=>{ if(v && ['Issue','Missing','Expired'].includes(v.status)) c++; }); });
            return c;
        })();
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${escapeHtml(r.date||'')}</td>
            <td>${escapeHtml(r.vehiclePlate||r.vehicleId||'')}</td>
            <td>${escapeHtml(r.status||'-')}</td>
            <td>${actionsCount}</td>
            <td>${compIssuesCount}</td>
            <td>${r.riskScore!=null? escapeHtml(r.riskScore): '-'}</td>
            <td>${escapeHtml(getRecordTypeLabel(r))}</td>`;
        tbody.appendChild(tr);
    });
}

// Get chart label
function getChartLabel(groupBy) {
    const labels = {
        'status': 'Status',
        'department': 'Department',
        'vehicleType': 'Vehicle Type',
        'fuelType': 'Fuel Type',
        'site': 'Site Assignment'
    };
    return labels[groupBy] || 'Category';
}

// Update fleet statistics
function updateFleetStats() {
    document.getElementById('totalVehicles').textContent = vehicleData.length;
    
    const activeCount = vehicleData.filter(v => 
        v.vehicleStatus === 'Active' || v.status === 'Active'
    ).length;
    document.getElementById('activeVehicles').textContent = activeCount;
    
    const maintenanceCount = vehicleData.filter(v => 
        v.vehicleStatus === 'Maintenance' || v.status === 'Maintenance'
    ).length;
    document.getElementById('maintenanceVehicles').textContent = maintenanceCount;
    
    const departments = new Set();
    vehicleData.forEach(v => {
        const dept = v.assignmentDept || v.assignmentDepartment || v.department;
        if (dept && dept !== 'Unassigned') {
            departments.add(dept);
        }
    });
    document.getElementById('uniqueDepartments').textContent = departments.size;
}

// Refresh visualization
function refreshFleetVisualization() {
    loadVehicleDataForCharts().then(() => {
        updateFleetVisualization();
        updateFleetStats();
    });
}

// Export chart data
function exportFleetChartData() {
    if (!vehicleData.length) {
        alert('No data to export');
        return;
    }
    
    const csv = convertToCSV(vehicleData);
    downloadCSV(csv, 'fleet_data.csv');
}

// Export chart image
function exportFleetChartImage() {
    if (!fleetChart) {
        alert('No chart to export');
        return;
    }
    
    const link = document.createElement('a');
    link.download = 'fleet_chart.png';
    link.href = fleetChart.toBase64Image();
    link.click();
}

// Helper functions
function convertToCSV(data) {
    if (!data.length) return '';
    
    const headers = Object.keys(data[0]).join(',');
    const rows = data.map(row => 
        Object.values(row).map(value => 
            typeof value === 'string' ? `"${value}"` : value
        ).join(',')
    );
    
    return [headers, ...rows].join('\n');
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    window.URL.revokeObjectURL(url);
}

// Excel Import Functionality
function triggerExcelImport() {
    document.getElementById('excelFileInput').click();
}

function downloadExcelTemplate() {
    // Create a comprehensive Excel template with all vehicle modal fields
    const templateData = [
        [
            // Basic Information
            'Name', 'Plate Number', 'Type', 'Mark', 'Model', 'Status',
            // Assignment
            'Department', 'Site', 'Fuel Type', 'Securing Status', 'Tank',
            // Vehicle Details
            'VIN Number', 'Year', 'Current Mileage (km)', 'Average Consumption Unit', 'Average Consumption Value',
            // Financial & Legal
            'Insurance Expiry', 'Registration Expiry', 'Asset Value ($)', 'Assigned Driver',
            // Safety Equipment
            'Radio', 'GPS', 'Vignet Date', 'First Aid Kit', 'First Aid Kit Expiry', 
            'Extinguisher Status', 'Extinguisher Expiry',
            // Certificates
            'Certificate (Date)', 'Certificate Expiry',
            // Additional Information
            'Notes'
        ],
        [
            // Sample data row 1
            'Mining Truck 001', 'MT-001', 'Haul Truck', 'Caterpillar', '789C', 'Active',
            'Mining Operations', 'Main Pit', 'Diesel', 'Secured', '500',
            '1HGBH41JXMN109186', '2020', '15000', 'L/H', '25.5',
            '2025-12-31', '2025-06-30', '250000', 'John Smith',
            'Available', 'Available', '2025-12-31', 'Available', '2025-03-15',
            'Available', '2025-09-30',
            '2024-01-15', '2026-01-15',
            'Heavy duty mining truck for ore transportation'
        ],
        [
            // Sample data row 2
            'Service Vehicle 002', 'SV-002', 'Pickup Truck', 'Ford', 'F-350', 'Active',
            'Maintenance', 'Workshop Area', 'Gasoline', 'Secured', '100',
            '1FTFW1ET5DFC12345', '2019', '45000', 'L/100Km', '12.8',
            '2025-08-15', '2025-11-20', '35000', 'Mike Johnson',
            'Available', 'Not Available', '', 'Available', '2025-01-10',
            'Available', '2025-07-15',
            '2023-06-20', '2025-06-20',
            'Maintenance support vehicle'
        ]
    ];
    
    // Create workbook and worksheet
    const ws = XLSX.utils.aoa_to_sheet(templateData);
    
    // Set column widths for better readability
    const colWidths = [
        {wch: 15}, {wch: 12}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 10},
        {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 8},
        {wch: 18}, {wch: 6}, {wch: 15}, {wch: 18}, {wch: 15},
        {wch: 12}, {wch: 15}, {wch: 12}, {wch: 15},
        {wch: 10}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15},
        {wch: 15}, {wch: 15},
        {wch: 15}, {wch: 15},
        {wch: 30}
    ];
    ws['!cols'] = colWidths;
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Fleet Template');
    
    // Download the file
    XLSX.writeFile(wb, 'fleet_import_template.xlsx');
    
    showToast('Excel template downloaded successfully!', 'success');
}

function handleExcelImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show progress
    document.getElementById('importProgress').style.display = 'block';
    document.getElementById('importResults').style.display = 'none';
    document.getElementById('importStatusText').textContent = 'Reading Excel file...';
    document.getElementById('importProgressBar').style.width = '20%';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // Update progress
            document.getElementById('importStatusText').textContent = 'Processing data...';
            document.getElementById('importProgressBar').style.width = '50%';
            
            // Read the Excel file
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Process the data
            processExcelData(jsonData);
            
        } catch (error) {
            console.error('Error reading Excel file:', error);
            showImportError('Error reading Excel file: ' + error.message);
        }
    };
    
    reader.onerror = function() {
        showImportError('Error reading file. Please try again.');
    };
    
    reader.readAsArrayBuffer(file);
    
    // Clear the input
    event.target.value = '';
}

function processExcelData(data) {
    document.getElementById('importStatusText').textContent = 'Validating data...';
    document.getElementById('importProgressBar').style.width = '70%';
    
    if (data.length < 2) {
        showImportError('Excel file must contain at least a header row and one data row.');
        return;
    }
    
    // Get headers (assuming first row contains headers)
    const headers = data[0].map(h => h ? h.toString().trim() : '');
    const dataRows = data.slice(1);
    
    // Expected column mapping
    const columnMapping = {
        'Name': ['name', 'vehicle name', 'vehicle_name'],
        'Plate Number': ['plate number', 'plate_number', 'license plate', 'registration'],
        'Type': ['type', 'vehicle type', 'vehicle_type'],
        'Mark': ['mark', 'make', 'brand', 'manufacturer'],
        'Model': ['model', 'vehicle model', 'vehicle_model'],
        'Status': ['status', 'vehicle status', 'vehicle_status'],
        'Department': ['department', 'dept'],
        'Site': ['site', 'location', 'site location'],
        'Fuel Type': ['fuel type', 'fuel_type', 'fuel'],
        'Securing Status': ['securing status', 'securing_status', 'security status', 'security_status'],
        'Tank': ['tank', 'tank assignment', 'tank_assignment', 'tank capacity'],
        'VIN Number': ['vin number', 'vin_number', 'vin', 'chassis number'],
        'Year': ['year', 'vehicle year', 'model year', 'manufacturing year'],
        'Current Mileage (km)': ['current mileage (km)', 'current_mileage', 'mileage', 'odometer'],
        'Average Consumption Unit': ['average consumption unit', 'consumption_unit', 'fuel consumption unit'],
        'Average Consumption Value': ['average consumption value', 'consumption_value', 'average', 'fuel consumption'],
        'Insurance Expiry': ['insurance expiry', 'insurance_expiry', 'insurance expiration'],
        'Registration Expiry': ['registration expiry', 'registration_expiry', 'registration expiration'],
        'Asset Value ($)': ['asset value ($)', 'asset_value', 'value', 'purchase price'],
        'Assigned Driver': ['assigned driver', 'assigned_driver', 'driver', 'operator'],
        'Radio': ['radio', 'radio status', 'radio_status'],
        'GPS': ['gps', 'gps status', 'gps_status'],
        'Vignet Date': ['vignet date', 'vignet_date', 'vignet', 'toll date'],
        'First Aid Kit': ['first aid kit', 'first_aid_kit', 'first aid kit status'],
        'First Aid Kit Expiry': ['first aid kit expiry', 'first_aid_kit_expiry', 'first aid expiry'],
        'Extinguisher Status': ['extinguisher status', 'extinguisher_status', 'fire extinguisher'],
        'Extinguisher Expiry': ['extinguisher expiry', 'extinguisher_expiry', 'fire extinguisher expiry'],
        'Certificate (Date)': ['certificate (date)', 'certificate_date', 'certificate', 'cert date'],
        'Certificate Expiry': ['certificate expiry', 'certificate_expiry', 'cert expiry', 'certification expiry'],
        'Notes': ['notes', 'comments', 'remarks', 'description']
    };
    
    // Find column indices
    const columnIndices = {};
    Object.keys(columnMapping).forEach(requiredCol => {
        const possibleNames = [requiredCol.toLowerCase(), ...columnMapping[requiredCol]];
        const index = headers.findIndex(h => 
            possibleNames.includes(h.toLowerCase())
        );
        columnIndices[requiredCol] = index;
    });
    
    // Validate required columns
    const missingColumns = [];
    ['Name', 'Plate Number', 'Type'].forEach(col => {
        if (columnIndices[col] === -1) {
            missingColumns.push(col);
        }
    });
    
    if (missingColumns.length > 0) {
        showImportError(`Missing required columns: ${missingColumns.join(', ')}. Please check your Excel file headers.`);
        return;
    }
    
    // Process each row
    const vehicles = [];
    const errors = [];
    const warnings = [];
    
    dataRows.forEach((row, index) => {
        const rowNum = index + 2; // +2 because of header and 0-based index
        
        // Skip empty rows
        if (!row || row.every(cell => !cell || cell.toString().trim() === '')) {
            return;
        }
        
        const vehicle = {};
        
        // Extract data based on column mapping
        Object.keys(columnIndices).forEach(col => {
            const colIndex = columnIndices[col];
            if (colIndex !== -1 && row[colIndex] !== undefined) {
                vehicle[col.toLowerCase().replace(/\s+/g, '_').replace(/[()$]/g, '')] = row[colIndex] ? row[colIndex].toString().trim() : '';
            }
        });
        
        // Validate required fields
        if (!vehicle.name || !vehicle.plate_number || !vehicle.type) {
            errors.push(`Row ${rowNum}: Missing required fields (Name, Plate Number, or Type)`);
            return;
        }
        
        // Set defaults for basic fields
        vehicle.mark = vehicle.mark || 'Unknown';
        vehicle.model = vehicle.model || 'Not Specified';
        vehicle.status = vehicle.status || 'Active';
        vehicle.department = vehicle.department || 'General';
        vehicle.site = vehicle.site || 'Main Site';
        vehicle.fuel_type = vehicle.fuel_type || 'Diesel';
        vehicle.securing_status = vehicle.securing_status || 'Secured';
        vehicle.tank = vehicle.tank || '0';
        
        // Set defaults for additional fields
        vehicle.vin_number = vehicle.vin_number || '';
        vehicle.year = vehicle.year || '';
        vehicle.current_mileage_km = vehicle.current_mileage_km || '';
        vehicle.average_consumption_unit = vehicle.average_consumption_unit || '';
        vehicle.average_consumption_value = vehicle.average_consumption_value || '';
        vehicle.insurance_expiry = vehicle.insurance_expiry || '';
        vehicle.registration_expiry = vehicle.registration_expiry || '';
        vehicle.asset_value = vehicle.asset_value || '';
        vehicle.assigned_driver = vehicle.assigned_driver || '';
        vehicle.radio = vehicle.radio || '';
        vehicle.gps = vehicle.gps || '';
        vehicle.vignet_date = vehicle.vignet_date || '';
        vehicle.first_aid_kit = vehicle.first_aid_kit || '';
        vehicle.first_aid_kit_expiry = vehicle.first_aid_kit_expiry || '';
        vehicle.extinguisher_status = vehicle.extinguisher_status || '';
        vehicle.extinguisher_expiry = vehicle.extinguisher_expiry || '';
        vehicle.certificate_date = vehicle.certificate_date || '';
        vehicle.certificate_expiry = vehicle.certificate_expiry || '';
        vehicle.notes = vehicle.notes || '';
        
        // Validate status values
        const validStatuses = ['Active', 'In Maintenance', 'Inactive'];
        if (vehicle.status && !validStatuses.includes(vehicle.status)) {
            warnings.push(`Row ${rowNum}: Invalid status "${vehicle.status}". Setting to "Active".`);
            vehicle.status = 'Active';
        }
        
        // Validate fuel type
        const validFuelTypes = ['Diesel', 'Gasoline', 'Jet A-1', 'HFO'];
        if (vehicle.fuel_type && !validFuelTypes.includes(vehicle.fuel_type)) {
            warnings.push(`Row ${rowNum}: Invalid fuel type "${vehicle.fuel_type}". Setting to "Diesel".`);
            vehicle.fuel_type = 'Diesel';
        }
        
        // Validate securing status
        const validSecuringStatuses = ['Secured', 'Unsecured', 'Unknown'];
        if (vehicle.securing_status && !validSecuringStatuses.includes(vehicle.securing_status)) {
            warnings.push(`Row ${rowNum}: Invalid securing status "${vehicle.securing_status}". Setting to "Secured".`);
            vehicle.securing_status = 'Secured';
        }
        
        // Validate year
        if (vehicle.year && vehicle.year !== '') {
            const year = parseInt(vehicle.year);
            if (isNaN(year) || year < 1900 || year > 2030) {
                warnings.push(`Row ${rowNum}: Invalid year "${vehicle.year}". Clearing field.`);
                vehicle.year = '';
            }
        }
        
        // Validate numeric fields
        if (vehicle.current_mileage_km && vehicle.current_mileage_km !== '') {
            const mileage = parseFloat(vehicle.current_mileage_km);
            if (isNaN(mileage) || mileage < 0) {
                warnings.push(`Row ${rowNum}: Invalid mileage "${vehicle.current_mileage_km}". Clearing field.`);
                vehicle.current_mileage_km = '';
            }
        }
        
        if (vehicle.average_consumption_value && vehicle.average_consumption_value !== '') {
            const consumption = parseFloat(vehicle.average_consumption_value);
            if (isNaN(consumption) || consumption < 0) {
                warnings.push(`Row ${rowNum}: Invalid consumption value "${vehicle.average_consumption_value}". Clearing field.`);
                vehicle.average_consumption_value = '';
            }
        }
        
        if (vehicle.asset_value && vehicle.asset_value !== '') {
            const value = parseFloat(vehicle.asset_value);
            if (isNaN(value) || value < 0) {
                warnings.push(`Row ${rowNum}: Invalid asset value "${vehicle.asset_value}". Clearing field.`);
                vehicle.asset_value = '';
            }
        }
        
        if (vehicle.tank && vehicle.tank !== '') {
            const tank = parseFloat(vehicle.tank);
            if (isNaN(tank) || tank < 0) {
                warnings.push(`Row ${rowNum}: Invalid tank capacity "${vehicle.tank}". Setting to 0.`);
                vehicle.tank = '0';
            }
        }
        
        // Validate date fields
        const dateFields = ['insurance_expiry', 'registration_expiry', 'vignet_date', 'first_aid_kit_expiry', 'extinguisher_expiry', 'certificate_date', 'certificate_expiry'];
        dateFields.forEach(field => {
            if (vehicle[field] && vehicle[field] !== '') {
                const date = new Date(vehicle[field]);
                if (isNaN(date.getTime())) {
                    warnings.push(`Row ${rowNum}: Invalid date format in ${field.replace(/_/g, ' ')} "${vehicle[field]}". Clearing field.`);
                    vehicle[field] = '';
                }
            }
        });
        
        // Validate VIN (basic check for 17 characters if provided)
        if (vehicle.vin_number && vehicle.vin_number !== '' && vehicle.vin_number.length !== 17) {
            warnings.push(`Row ${rowNum}: VIN should be 17 characters. Current: "${vehicle.vin_number}".`);
        }
        
        // Validate equipment status fields
        const validEquipmentStatuses = {
            radio: ['Available', 'Not Available', 'Under Repair'],
            gps: ['Available', 'Not Available', 'Under Repair'],
            first_aid_kit: ['Available', 'Not Available', 'Expired'],
            extinguisher_status: ['Available', 'Not Available', 'Under Inspection', 'Expired']
        };
        
        Object.keys(validEquipmentStatuses).forEach(field => {
            if (vehicle[field] && !validEquipmentStatuses[field].includes(vehicle[field])) {
                warnings.push(`Row ${rowNum}: Invalid ${field.replace(/_/g, ' ')} status "${vehicle[field]}". Clearing field.`);
                vehicle[field] = '';
            }
        });
        
        vehicles.push(vehicle);
    });
    
    if (errors.length > 0) {
        showImportError('Import failed due to validation errors:<br>' + errors.join('<br>'));
        return;
    }
    
    // Import the vehicles
    importVehiclesToFirebase(vehicles, warnings);
}

async function importVehiclesToFirebase(vehicles, warnings) {
    document.getElementById('importStatusText').textContent = 'Saving vehicles to database...';
    document.getElementById('importProgressBar').style.width = '90%';
    
    try {
        const auth = authManager.getCurrentUser();
        if (!auth || !authManager.currentCompany) {
            throw new Error('Authentication required');
        }
        
        const vehicleRef = firebase.database().ref(`companies/${authManager.currentCompany.id}/fleet`);
        
        let successCount = 0;
        let errorCount = 0;
        const importErrors = [];
        
        for (let i = 0; i < vehicles.length; i++) {
            try {
                const vehicle = vehicles[i];
                
                // Check for duplicate plate numbers
                const existingVehicles = await vehicleRef.orderByChild('plateNumber').equalTo(vehicle.plate_number).once('value');
                if (existingVehicles.exists()) {
                    importErrors.push(`Vehicle with plate number "${vehicle.plate_number}" already exists. Skipped.`);
                    errorCount++;
                    continue;
                }
                
                // Generate a unique ID
                const vehicleId = vehicleRef.push().key;
                
                // Prepare vehicle data
                const vehicleData = {
                    id: vehicleId,
                    name: vehicle.name,
                    plateNumber: vehicle.plate_number,
                    vehicleType: vehicle.type,
                    vehicleMake: vehicle.mark,
                    model: vehicle.model,
                    status: vehicle.status,
                    department: vehicle.department,
                    siteAssignment: vehicle.site,
                    fuelType: vehicle.fuel_type,
                    securingStatus: vehicle.securing_status,
                    tankAssignment: vehicle.tank,
                    
                    // Additional vehicle details
                    vinNumber: vehicle.vin_number,
                    vehicleYear: vehicle.year,
                    currentMileage: vehicle.current_mileage_km,
                    averageConsumptionUnit: vehicle.average_consumption_unit,
                    averageConsumptionValue: vehicle.average_consumption_value,
                    
                    // Financial and legal
                    insuranceExpiry: vehicle.insurance_expiry,
                    registrationExpiry: vehicle.registration_expiry,
                    assetValue: vehicle.asset_value,
                    assignedDriver: vehicle.assigned_driver,
                    
                    // Safety equipment
                    radioStatus: vehicle.radio,
                    gpsStatus: vehicle.gps,
                    vignetDate: vehicle.vignet_date,
                    firstAidKit: vehicle.first_aid_kit,
                    firstAidKitExpiry: vehicle.first_aid_kit_expiry,
                    extinguisherStatus: vehicle.extinguisher_status,
                    extinguisherExpiry: vehicle.extinguisher_expiry,
                    
                    // Certificate information
                    certificateDate: vehicle.certificate_date,
                    certificateExpiry: vehicle.certificate_expiry,
                    
                    // Additional information
                    notes: vehicle.notes,
                    
                    // Metadata
                    dateAdded: new Date().toISOString(),
                    addedBy: auth.email,
                    importedFromExcel: true
                };
                
                // Save to Firebase
                await vehicleRef.child(vehicleId).set(vehicleData);
                successCount++;
                
            } catch (error) {
                console.error('Error importing vehicle:', error);
                importErrors.push(`Error importing vehicle "${vehicles[i].name}": ${error.message}`);
                errorCount++;
            }
        }
        
        // Complete progress
        document.getElementById('importProgressBar').style.width = '100%';
        document.getElementById('importStatusText').textContent = 'Import completed!';
        
        // Hide progress after a short delay
        setTimeout(() => {
            document.getElementById('importProgress').style.display = 'none';
        }, 1500);
        
        // Show results
        showImportResults(successCount, errorCount, importErrors, warnings);
        
        // Refresh the table
        if (successCount > 0) {
            setTimeout(() => {
                loadVehicles();
            }, 1000);
        }
        
    } catch (error) {
        console.error('Import error:', error);
        showImportError('Failed to import vehicles: ' + error.message);
    }
}

function showImportResults(successCount, errorCount, importErrors, warnings) {
    const resultsDiv = document.getElementById('importResults');
    const contentDiv = document.getElementById('importResultsContent');
    
    let html = '';
    
    if (successCount > 0) {
        html += `<div class="import-success">
            <h6><i class="fas fa-check-circle"></i> Import Successful</h6>
            <p>${successCount} vehicle${successCount !== 1 ? 's' : ''} imported successfully.</p>
        </div>`;
    }
    
    if (warnings.length > 0) {
        html += `<div class="import-warning" style="margin-top: 0.5rem;">
            <h6><i class="fas fa-exclamation-triangle"></i> Warnings</h6>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                ${warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
        </div>`;
    }
    
    if (errorCount > 0) {
        html += `<div class="import-error" style="margin-top: 0.5rem;">
            <h6><i class="fas fa-exclamation-circle"></i> Errors</h6>
            <p>${errorCount} vehicle${errorCount !== 1 ? 's' : ''} failed to import.</p>
            ${importErrors.length > 0 ? `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                ${importErrors.map(e => `<li>${e}</li>`).join('')}
            </ul>` : ''}
        </div>`;
    }
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        resultsDiv.style.display = 'none';
    }, 10000);
}

function showImportError(message) {
    document.getElementById('importProgress').style.display = 'none';
    
    const resultsDiv = document.getElementById('importResults');
    const contentDiv = document.getElementById('importResultsContent');
    
    contentDiv.innerHTML = `<div class="import-error">
        <h6><i class="fas fa-exclamation-circle"></i> Import Failed</h6>
        <p>${message}</p>
    </div>`;
    
    resultsDiv.style.display = 'block';
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
        resultsDiv.style.display = 'none';
    }, 8000);
}

// =============================
// Vehicle Inspection (Maintenance Tab)
// =============================
// Modal creation + CRUD for vehicle inspections stored under
// companies/{companyId}/vehicleInspections
// Simple checklist & status capture

function openInspectionModal(){
    if(!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canAddInspection)){
        window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to add inspections'});
        return;
    }
    let modal = document.getElementById('maintenanceModal');
    if(!modal){ modal = createMaintenanceModal(); }
    resetMaintenanceForm();
    populateMaintenanceVehicleSelect();
    modal.classList.add('show');
    const first = modal.querySelector('input,select,textarea,button');
    if(first) first.focus();
    trapFocus(modal);
}

// =============================
// Maintenance Modal & Logic (from + button in Maintenance tab)
// =============================
function createMaintenanceModal(){
    const modal = document.createElement('div');
    modal.id = 'maintenanceModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="maintenanceModalTitle">
            <div class="modal-header">
                <h5 id="maintenanceModalTitle"><i class="fas fa-wrench"></i> Vehicle Maintenance Inspection</h5>
                <button class="close-btn" type="button" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="max-height:72vh;overflow:auto;">
                <!-- Advanced Maintenance Inspection Form -->
                <form id="maintenanceForm" autocomplete="off">
                    <!-- SUMMARY BAR -->
                    <section class="maint-summary-bar">
                        <div class="form-field">
                            <label for="maintenanceDate">Date</label>
                            <input type="date" id="maintenanceDate" name="date" required />
                        </div>
                        <div class="form-field">
                            <label for="maintenanceRef">Reference Number</label>
                            <input type="text" id="maintenanceRef" name="referenceNumber" readonly title="Auto-generated" />
                        </div>
                        <div class="form-field wide">
                            <label for="maintenanceVehicleSelect">Vehicle</label>
                            <select id="maintenanceVehicleSelect" name="vehicleId" required>
                                <option value="">Select vehicle...</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Plate</label>
                            <input type="text" id="maintenancePlate" name="plate" readonly placeholder="Auto" />
                        </div>
                        <div class="form-field">
                            <label for="maintenanceOdometer">Odometer (km)</label>
                            <input type="number" id="maintenanceOdometer" name="odometer" min="0" step="1" placeholder="e.g. 15230" />
                        </div>
                        <div class="form-field">
                            <label for="maintenanceType">Type</label>
                            <select id="maintenanceType" name="maintenanceType" required>
                                <option value="Routine">Compliance</option>
                                <option value="Preventive">Preventive Maintenance</option>
                                <option value="Corrective">Corrective Maintenance</option>
                                <option value="Emergency">General Inspection</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="maintenanceStatus">Overall Status</label>
                            <select id="maintenanceStatus" name="status" required>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                                <option value="Needs Attention">Needs Attention</option>
                                <option value="Out of Service">Out of Service</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="maintenanceRiskScore">Risk Score (auto)</label>
                            <input type="text" id="maintenanceRiskScore" name="riskScore" readonly style="background:#eef2f7;" placeholder="--" />
                        </div>
                    </section>

                    <!-- ACCORDION SECTIONS -->
                    <div class="maintenance-accordion" style="display:flex;flex-direction:column;gap:12px;margin-bottom:18px;">
                        <!-- Engine & Fluids -->
                        <details open class="maint-block" data-block="fluids">
                            <summary><i class="fas fa-oil-can"></i> Engine & Fluids</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Engine Oil Level','Within optimal range','engineoillevel', ['OK','Low','Empty']],
                                    ['Engine Oil Quality','Clear, not degraded','engineoilquality', ['Good','Fair','Change Required']],
                                    ['Coolant Level','Adequate, no leaks','coolantlevel', ['OK','Low','Empty']],
                                    ['Brake Fluid','Proper level, uncontaminated','brakefluid', ['OK','Low','Contaminated']],
                                    ['Hydraulic Fluid','Correct level, no leaks','hydraulicfluid', ['OK','Low','Leak Detected']],
                                    ['Washer Fluid','Adequate level','washerfluid', ['OK','Low','Empty']]
                                ].map(([label, req, name, options])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='fluid_${name}_requirement' value='${req}'>
                                    <select name='${name}' style='font-size:.7rem;'>
                                        ${options.map(o=>`<option value='${o}'>${o}</option>`).join('')}
                                    </select>
                                    <input type='text' name='${name}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Tires & Wheels -->
                        <details class="maint-block" data-block="tires">
                            <summary><i class="fas fa-truck"></i> Tires & Wheels</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Front Left Tire','Proper tread, no damage','tire_frontLeft',['Good','Worn','Replace','Punctured']],
                                    ['Front Right Tire','Proper tread, no damage','tire_frontRight',['Good','Worn','Replace','Punctured']],
                                    ['Rear Left Tire','Proper tread, no damage','tire_rearLeft',['Good','Worn','Replace','Punctured']],
                                    ['Rear Right Tire','Proper tread, no damage','tire_rearRight',['Good','Worn','Replace','Punctured']],
                                    ['Wheel Nuts Torque','All nuts correctly tightened','wheelnutstorque',['OK','Issue']],
                                    ['Spare Tire','Present & inflated','sparetire',['OK','Issue']],
                                    ['Jack & Tools','Complete & usable','jacktools',['OK','Issue']],
                                    ['Steering Wheel','Proper play, alignment','steeringWheel',['OK','Issue']]
                                ].map(([label, req, name, options])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='tires_${name}_requirement' value='${req}'>
                                    <select name='${name}' style='font-size:.7rem;'>
                                        ${options.map(o=>`<option value='${o}'>${o}</option>`).join('')}
                                    </select>
                                    <input type='text' name='${name}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Safety & Equipment section removed (merged into Safety Equipment Extended) -->

                        <!-- Issues & Actions (moved after Operational Readiness) -->

                        <!-- Documentation & Legal Compliance -->
                        <details class="maint-block" data-block="documentation">
                            <summary><i class="fas fa-file-alt"></i> Documentation Compliance</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Vehicle registration certificate','Valid and present','vehicleRegistrationCertificate','doc'],
                                    ['Insurance certificate','Valid and up to date','insuranceCertificate','doc'],
                                    ['Technical inspection certificate','Valid (not expired)','technicalInspectionCertificate','doc'],
                                    ['Service sticker / next service','Present and up to date','serviceSticker','doc'],
                                    ['Vehicle logbook / movement sheet','Completed and signed','vehicleLogbook','doc'],
                                    ['Fuel card / permit','Available and valid','fuelCardPermit','doc'],
                                    ["Drivers license",'Appropriate class and valid','driversLicense','doc']
                                ].map(([label, req, key, prefix])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='${prefix}_${key}_requirement' value='${req}'>
                                    <select name='${prefix}_${key}_status' style='font-size:.7rem;'>
                                        <option value='OK'>? OK</option>
                                        <option value='Issue'>Issue</option>
                                        <option value='Missing'>Missing</option>
                                        <option value='Expired'>Expired</option>
                                        <option value='N/A'>N/A</option>
                                    </select>
                                    <input type='text' name='${prefix}_${key}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Safety Equipment (Extended) -->
                        <details class="maint-block" data-block="safetyExtended">
                            <summary><i class="fas fa-shield-virus"></i> Safety Equipment (Extended)</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Fire extinguisher','Present and within validity','fireExtinguisher','safetyEquip'],
                                    ['First aid kit','Complete and within expiry','firstAidKit','safetyEquip'],
                                    ['Reflective triangles','Two present and functional','reflectiveTriangles','safetyEquip'],
                                    ['Emergency exit','Accessible and functional','emergencyExit','safetyEquip'],
                                    ['Seat belts','All operational','seatBelts','safetyEquip'],
                                    ['Horn','Functional','horn','safetyEquip'],
                                    ['Warning lights / indicators','Functional','warningLightsIndicators','safetyEquip'],
                                    ['Reverse alarm','Functional','reverseAlarm','safetyEquip'],
                                    ['Radio','Operational for communication','radio','safetyEquip']
                                ].map(([label, req, key, prefix])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='${prefix}_${key}_requirement' value='${req}'>
                                    <select name='${prefix}_${key}_status' style='font-size:.7rem;'>
                                        <option value='OK'>? OK</option>
                                        <option value='Issue'>Issue</option>
                                        <option value='Missing'>Missing</option>
                                        <option value='Expired'>Expired</option>
                                        <option value='N/A'>N/A</option>
                                    </select>
                                    <input type='text' name='${prefix}_${key}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Mechanical Condition -->
                        <details class="maint-block" data-block="mechanical">
                            <summary><i class="fas fa-cogs"></i> Mechanical Condition</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Foot Brake','Responsive and safe','footBrakes','mech'],
                                    ['Hand Brake','Responsive and safe','handBrakes','mech'],
                                    ['Steering system','No play, no leaks','steeringSystem','mech'],
                                    ['Tires','Proper tread depth, no damage','tires','mech'],
                                    ['Windshield wipers','Operational, fluid present','windshieldWipers','mech'],
                                    ['Lights (head, brake, tail)','All working','lights','mech'],
                                    ['Mirrors','Clean, not broken','mirrors','mech'],
                                    ['Suspension','Stable, no noise','suspension','mech'],
                                    ['Battery','Secure, terminals clean','battery','mech'],
                                    ['Body damage','No dents or damage affecting safety','bodyDamage','mech']
                                ].map(([label, req, key, prefix])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='${prefix}_${key}_requirement' value='${req}'>
                                    <select name='${prefix}_${key}_status' style='font-size:.7rem;'>
                                        <option value='OK'>? OK</option>
                                        <option value='Issue'>Issue</option>
                                        <option value='Missing'>Missing</option>
                                        <option value='Expired'>Expired</option>
                                        <option value='N/A'>N/A</option>
                                    </select>
                                    <input type='text' name='${prefix}_${key}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Environmental & Cleanliness -->
                        <details class="maint-block" data-block="environmental">
                            <summary><i class="fas fa-leaf"></i> Environmental & Cleanliness</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Vehicle cleanliness','Interior/exterior clean','vehicleCleanliness','env'],
                                    ['Oil leaks','None visible','oilLeaks','env'],
                                    ['Exhaust smoke','Within acceptable limit','exhaustSmoke','env'],
                                    ['Waste disposal (no litter)','Compliant','wasteDisposal','env']
                                ].map(([label, req, key, prefix])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='${prefix}_${key}_requirement' value='${req}'>
                                    <select name='${prefix}_${key}_status' style='font-size:.7rem;'>
                                        <option value='OK'>? OK</option>
                                        <option value='Issue'>Issue</option>
                                        <option value='Missing'>Missing</option>
                                        <option value='Expired'>Expired</option>
                                        <option value='N/A'>N/A</option>
                                    </select>
                                    <input type='text' name='${prefix}_${key}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Operational Readiness -->
                        <details class="maint-block" data-block="operational">
                            <summary><i class="fas fa-play-circle"></i> Operational Readiness</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
                                ${[
                                    ['Fuel level','Sufficient for operation','fuelLevel','oper'],
                                    ['Odometer reading','Recorded','odometerReading','oper'],
                                    ['GPS tracking / RFID','Operational','gpsTracking','oper'],
                                    ['Daily checklist completed','Signed by driver','dailyChecklistCompleted','oper'],
                                    ['Previous defects corrected','Verified','previousDefectsCorrected','oper']
                                ].map(([label, req, key, prefix])=>`
                                <div style='display:grid;grid-template-columns:220px 1fr 140px 1fr;gap:6px;align-items:center;'>
                                    <div><strong style='font-size:.65rem;'>${label}</strong><br><small style='font-size:.6rem;color:#555;'>${req}</small></div>
                                    <input type='hidden' name='${prefix}_${key}_requirement' value='${req}'>
                                    <select name='${prefix}_${key}_status' style='font-size:.7rem;'>
                                        <option value='OK'>? OK</option>
                                        <option value='Issue'>Issue</option>
                                        <option value='Missing'>Missing</option>
                                        <option value='Expired'>Expired</option>
                                        <option value='N/A'>N/A</option>
                                    </select>
                                    <input type='text' name='${prefix}_${key}_remarks' placeholder='Remarks' style='font-size:.7rem;'>
                                </div>`).join('')}
                            </div>
                        </details>

                        <!-- Issues & Actions (moved here) -->
                        <details open class="maint-block" data-block="issues">
                            <summary><i class="fas fa-exclamation-triangle"></i> Issues & Actions</summary>
                            <!-- Action Items List -->
                            <div style="margin-top:16px;">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                                    <h6 style="margin:0;font-size:.75rem;font-weight:600;display:flex;align-items:center;gap:6px;"><i class="fas fa-tasks"></i> Individual Action Items</h6>
                                    <button type="button" id="addActionItemBtn" class="btn btn-sm btn-primary" style="font-size:.6rem;padding:4px 8px;display:flex;align-items:center;gap:4px;"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div id="actionItemsContainer" style="display:flex;flex-direction:column;gap:10px;"></div>
                                <small style="color:#555;font-size:.6rem;display:block;margin-top:4px;">Add granular follow-up actions, assign a responsible user and deadline. Empty description rows are ignored.</small>
                            </div>
                        </details>

                        <!-- Corrective Issues (visible only when Type = Corrective) -->
                        <details class="maint-block" data-block="corrective" id="correctiveIssuesBlock" style="display:none;">
                            <summary><i class="fas fa-tools"></i> Corrective Issues</summary>
                            <div style="margin-top:16px;">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                                    <h6 style="margin:0;font-size:.75rem;font-weight:600;display:flex;align-items:center;gap:6px;"><i class="fas fa-wrench"></i> Report Issues</h6>
                                    <button type="button" id="addCorrectiveIssueBtn" class="btn btn-sm btn-primary" style="font-size:.6rem;padding:4px 8px;display:flex;align-items:center;gap:4px;"><i class="fas fa-plus"></i> Add Issue</button>
                                </div>
                                <div id="correctiveIssuesContainer" style="display:flex;flex-direction:column;gap:10px;"></div>
                                <small style="color:#555;font-size:.6rem;display:block;margin-top:4px;">Use standardized categories and failure modes. Empty rows are ignored.</small>
                            </div>
                        </details>

                        <!-- Scheduling -->
                        <details class="maint-block" data-block="schedule">
                            <summary><i class="fas fa-calendar-alt"></i> Scheduling</summary>
                            <div style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                                <div>
                                    <label for="maintenanceNextService">Next Service Date</label>
                                    <input type="date" id="maintenanceNextService" name="nextServiceDate" />
                                </div>
                                <div>
                                    <label for="maintenanceNextOdometer">Next Service Odometer</label>
                                    <input type="number" id="maintenanceNextOdometer" name="nextServiceOdometer" min="0" step="1" placeholder="e.g. 20000" />
                                </div>
                            </div>
                        </details>

                        <!-- Attachments -->
                        <details class="maint-block" data-block="attachments">
                            <summary><i class="fas fa-paperclip"></i> Photos & Attachments</summary>
                            <div style="margin-top:10px;">
                                <input type="file" id="maintenanceAttachmentInput" multiple accept="image/*,.pdf,.doc,.docx" style="margin-bottom:8px;" />
                                <div id="maintenanceAttachmentPreview" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                                <small style="display:block;color:#555;margin-top:4px;">Max 10 files, each up to 5MB.</small>
                            </div>
                        </details>

                        <!-- Sign-off -->
                        <details class="maint-block" data-block="signoff">
                            <summary><i class="fas fa-signature"></i> Sign-off</summary>
                            <div style="margin-top:10px;display:flex;flex-direction:column;gap:12px;">
                                <div>
                                    <label for="maintenanceSignerSelect">Signers (Team)</label>
                                    <div class="input-with-button" style="display:flex;gap:6px;align-items:center;">
                                        <select id="maintenanceSignerSelect" style="flex:1;min-width:200px;font-size:.75rem;">
                                            <option value="">Select user...</option>
                                        </select>
                                        <button type="button" id="addSignerBtn" class="btn btn-sm btn-primary" style="font-size:.6rem;padding:4px 8px;display:flex;align-items:center;gap:4px;">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="selectedSigners" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
                                    <input type="hidden" id="maintenanceSignersInput" name="signers" value="" />
                                    <small style="color:#555;display:block;margin-top:4px;">Add multiple signers; first becomes primary signature for backward compatibility.</small>
                                </div>
                            </div>
                        </details>
                    </div>

                    <input type="hidden" id="maintenanceRecordId" name="recordId" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="cancel">Cancel</button>
                <button type="submit" form="maintenanceForm" class="btn btn-success"><i class="fas fa-save"></i> Save Maintenance Report</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    
    // Event listeners
    modal.querySelector('.close-btn').addEventListener('click', ()=>closeMaintenanceModal());
    modal.querySelector('[data-action="cancel"]').addEventListener('click', ()=>closeMaintenanceModal());
    modal.querySelector('#maintenanceVehicleSelect').addEventListener('change', syncMaintenancePlate);
    modal.querySelector('#maintenanceForm').addEventListener('submit', e=>{ e.preventDefault(); saveMaintenanceReport(); });
    // Breakdown taxonomy (grouped) for standardized selections
    const breakdownTaxonomy = [
        { group: 'Powertrain', items: [
            { code: 'engine', label: 'Engine' },
            { code: 'transmission', label: 'Transmission' },
            { code: 'drivetrain', label: 'Drivetrain' },
            { code: 'clutch', label: 'Clutch' },
            { code: 'differential', label: 'Differential' }
        ]},
        { group: 'Cooling & Lubrication', items: [
            { code: 'cooling_system', label: 'Cooling System' },
            { code: 'radiator', label: 'Radiator' },
            { code: 'water_pump', label: 'Water Pump' },
            { code: 'lubrication', label: 'Lubrication System' },
            { code: 'belts_hoses', label: 'Belts & Hoses' }
        ]},
        { group: 'Fuel & Air', items: [
            { code: 'fuel_system', label: 'Fuel System' },
            { code: 'fuel_injection', label: 'Fuel Injection' },
            { code: 'air_intake', label: 'Air Intake' },
            { code: 'turbocharger', label: 'Turbocharger' },
            { code: 'filters', label: 'Filters' }
        ]},
        { group: 'Chassis & Dynamics', items: [
            { code: 'brakes', label: 'Brake System' },
            { code: 'steering', label: 'Steering' },
            { code: 'suspension', label: 'Suspension' },
            { code: 'tires', label: 'Tires' },
            { code: 'wheels', label: 'Wheels' },
            { code: 'alignment', label: 'Alignment' }
        ]},
        { group: 'Electrical & Electronics', items: [
            { code: 'electrical', label: 'Electrical System' },
            { code: 'battery_charging', label: 'Battery/Charging' },
            { code: 'lighting', label: 'Lighting' },
            { code: 'sensors', label: 'Sensors' },
            { code: 'ecu_software', label: 'ECU/Software' },
            { code: 'instrumentation', label: 'Instrumentation' },
            { code: 'telemetry_gps', label: 'Telemetry/GPS' }
        ]},
        { group: 'Body & Safety', items: [
            { code: 'body_frame', label: 'Body & Frame' },
            { code: 'doors_windows', label: 'Doors & Windows' },
            { code: 'windscreen_wipers', label: 'Wipers/Washers' },
            { code: 'safety_equipment', label: 'Safety Equipment' }
        ]},
        { group: 'Environment & Emissions', items: [
            { code: 'exhaust', label: 'Exhaust System' },
            { code: 'emissions', label: 'Emissions Control' }
        ]},
        { group: 'Hydraulics & HVAC', items: [
            { code: 'hydraulic', label: 'Hydraulic System' },
            { code: 'hvac', label: 'HVAC/Climate Control' },
            { code: 'air_system', label: 'Compressed Air System' }
        ]},
        { group: 'Towing & Auxiliary', items: [
            { code: 'pto', label: 'PTO' },
            { code: 'load_handling', label: 'Load Handling' },
            { code: 'coupling_trailer', label: 'Coupling/Trailer' }
        ]},
        { group: 'EV (if applicable)', items: [
            { code: 'ev_hv_battery', label: 'High-voltage Battery' },
            { code: 'ev_inverter', label: 'Inverter' },
            { code: 'ev_motor', label: 'Electric Motor' },
            { code: 'ev_charging_port', label: 'Charging Port' }
        ]}
    ];
    function buildBreakdownOptionsHtml() {
        return breakdownTaxonomy.map(g=>`<optgroup label="${g.group}">` + g.items.map(i=>`<option value="${i.code}">${i.label}</option>`).join('') + `</optgroup>`).join('');
    }
    const flattenedBreakdown = breakdownTaxonomy.flatMap(g => g.items.map(i => ({ code: i.code, label: i.label, group: g.group })));
    function wireTaxonomyCombobox(wrapper){
        if(!wrapper) return;
        const input = wrapper.querySelector('input[type="text"]');
        const hidden = wrapper.querySelector('input[type="hidden"]');
        const panel = wrapper.querySelector('.taxonomy-options');
        if(!input || !hidden || !panel) return;
        function renderOptions(q=''){
            const query = q.trim().toLowerCase();
            const matched = flattenedBreakdown.filter(o => !query || o.label.toLowerCase().includes(query) || o.group.toLowerCase().includes(query));
            if(matched.length===0){
                panel.innerHTML = `<div style="padding:6px 8px;color:#777;font-size:.75rem;">No matches</div>`;
                return;
            }
            panel.innerHTML = matched.map(o=>
                `<div class="tax-opt" data-code="${o.code}" data-label="${o.label}" style="padding:6px 8px;cursor:pointer;display:flex;justify-content:space-between;gap:8px;">
                    <span>${o.label}</span>
                    <small style="color:#666;">${o.group}</small>
                </div>`
            ).join('');
            panel.querySelectorAll('.tax-opt').forEach(el=>{
                el.addEventListener('mousedown', (e)=>{ // mousedown to fire before input blur
                    e.preventDefault();
                    const code = el.dataset.code||''; const label = el.dataset.label||'';
                    input.value = label; hidden.value = code; panel.style.display='none';
                });
            });
        }
        function openPanel(){ panel.style.display = 'block'; renderOptions(input.value); }
        function closePanel(){ panel.style.display = 'none'; }
        input.addEventListener('focus', openPanel);
        input.addEventListener('input', ()=>{ hidden.value=''; openPanel(); });
        input.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closePanel(); input.blur(); } });
        document.addEventListener('click', (e)=>{ if(!wrapper.contains(e.target)){ closePanel(); } });
    }
    // Action items dynamic rows
    const actionItemsContainer = modal.querySelector('#actionItemsContainer');
    const addActionItemBtn = modal.querySelector('#addActionItemBtn');
    const companyUsers = (window.authManager?.currentCompany?.users) || {};
    const userOptionsHtml = Object.entries(companyUsers).map(([uid,u])=>{
        const name = u.displayName || u.name || u.email || uid;
        return `<option value="${uid}" data-email="${u.email||''}">${name}</option>`;
    }).join('');
    // Populate inspector signer dropdown
    // Multi-signer setup
    const signerSelect = modal.querySelector('#maintenanceSignerSelect');
    const addSignerBtn = modal.querySelector('#addSignerBtn');
    const selectedSignersCont = modal.querySelector('#selectedSigners');
    const signersHiddenInput = modal.querySelector('#maintenanceSignersInput');
    if(signerSelect){
        signerSelect.innerHTML = `<option value="">Select user...</option>` + userOptionsHtml;
        const currentUid = window.authManager?.currentUser?.uid || '';
        if(currentUid && signerSelect.querySelector(`option[value="${currentUid}"]`)){
            signerSelect.value = currentUid;
        }
    }
    let selectedSignerIds = [];
    function renderSignerChips(){
        selectedSignersCont.innerHTML='';
        selectedSignerIds.forEach(uid=>{
            const opt = signerSelect.querySelector(`option[value="${uid}"]`);
            const label = opt ? opt.textContent : uid;
            const chip = document.createElement('div');
            chip.style.cssText='display:flex;align-items:center;gap:4px;background:#f1f4f7;border:1px solid #d0d7de;padding:4px 8px;border-radius:16px;font-size:.65rem;';
            chip.innerHTML = `<span>${label}</span><button type='button' aria-label='Remove signer' style='background:none;border:none;color:#c33;cursor:pointer;font-size:.65rem;'><i class='fas fa-times'></i></button>`;
            chip.querySelector('button').addEventListener('click',()=>{
                selectedSignerIds = selectedSignerIds.filter(id=>id!==uid);
                renderSignerChips();
            });
            selectedSignersCont.appendChild(chip);
        });
        signersHiddenInput.value = selectedSignerIds.join(',');
    }
    if(addSignerBtn){
        addSignerBtn.addEventListener('click', ()=>{
            const uid = signerSelect.value;
            if(!uid || selectedSignerIds.includes(uid)) return;
            selectedSignerIds.push(uid);
            renderSignerChips();
            signerSelect.value='';
        });
    }
    function createActionItemRow(){
        const row = document.createElement('div');
        row.className = 'action-item-row';
        row.style.cssText = 'display:grid;grid-template-columns:1fr 220px 160px 32px;gap:8px;align-items:center;';
        row.innerHTML = `
            <div class="taxonomy-combobox" style="position:relative;">
                <input type="text" name="action_title_label" placeholder="Search breakdown..." autocomplete="off" style="font-size:.75rem;" />
                <input type="hidden" name="action_title_key" />
                <div class="taxonomy-options" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;max-height:220px;overflow:auto;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.08);z-index:1000;"></div>
            </div>
            <select name="action_assignee" style="font-size:.75rem;">
                <option value="">Unassigned</option>
                ${userOptionsHtml}
            </select>
            <input type="date" name="action_due" style="font-size:.75rem;" />
            <button type="button" class="btn btn-sm btn-danger" title="Remove" aria-label="Remove action" style="padding:4px 6px;"><i class="fas fa-times"></i></button>
        `;
        row.querySelector('button').addEventListener('click', ()=> row.remove());
        actionItemsContainer.appendChild(row);
        wireTaxonomyCombobox(row.querySelector('.taxonomy-combobox'));
    }
    if(addActionItemBtn){ addActionItemBtn.addEventListener('click', createActionItemRow); }
    // Start with one empty row for convenience
    if(actionItemsContainer && actionItemsContainer.childElementCount===0){ createActionItemRow(); }
    // Corrective issues dynamic rows (only when maintenance type is Corrective)
    const correctiveBlock = modal.querySelector('#correctiveIssuesBlock');
    const issuesBlock = modal.querySelector('details[data-block="issues"]');
    const correctiveContainer = modal.querySelector('#correctiveIssuesContainer');
    const addCorrectiveIssueBtn = modal.querySelector('#addCorrectiveIssueBtn');
    const commonFailureModes = [
        'Wear/Degradation','Leak','Overheating','Electrical Fault','Alignment/Calibration','Corrosion','Noise/Vibration','Crack/Fracture','Deformation','Blockage/Restriction','Software/Config','Sensor Fault'
    ];
    function createCorrectiveIssueRow(){
        const row = document.createElement('div');
        row.className = 'corrective-issue-row';
        row.style.cssText = 'display:grid;grid-template-columns:1.2fr 1fr 140px 1fr 32px;gap:8px;align-items:center;';
        row.innerHTML = `
            <div class="taxonomy-combobox" style="position:relative;">
                <input type="text" name="corr_category_label" placeholder="Search category..." autocomplete="off" style="font-size:.75rem;" />
                <input type="hidden" name="corr_category" />
                <div class="taxonomy-options" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;max-height:220px;overflow:auto;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.08);z-index:1000;"></div>
            </div>
            <select name="corr_failureMode" style="font-size:.75rem;">
                <option value="">Failure mode...</option>
                ${commonFailureModes.map(m=>`<option value="${m}">${m}</option>`).join('')}
            </select>
            <select name="corr_severity" style="font-size:.75rem;">
                <option value="Minor">Minor</option>
                <option value="Major">Major</option>
                <option value="Critical">Critical</option>
            </select>
            <input type="text" name="corr_remarks" placeholder="Remarks (optional)" style="font-size:.75rem;" />
            <button type="button" class="btn btn-sm btn-danger" title="Remove" aria-label="Remove issue" style="padding:4px 6px;"><i class="fas fa-times"></i></button>
        `;
        row.querySelector('button').addEventListener('click', ()=> row.remove());
        correctiveContainer.appendChild(row);
        wireTaxonomyCombobox(row.querySelector('.taxonomy-combobox'));
    }
    if(addCorrectiveIssueBtn){ addCorrectiveIssueBtn.addEventListener('click', createCorrectiveIssueRow); }
    const maintTypeSel = modal.querySelector('#maintenanceType');
    function updateCorrectiveVisibility(){
        if(!maintTypeSel || !correctiveBlock) return;
        const val = maintTypeSel.value;
        const isCorrective = val === 'Corrective';
        const isCompliance = val === 'Routine'; // "Routine" labeled as Compliance in UI
        correctiveBlock.style.display = isCorrective ? '' : 'none';
        if(issuesBlock){ issuesBlock.style.display = isCompliance ? 'none' : ''; }
        if(isCorrective && correctiveContainer && correctiveContainer.childElementCount===0){
            createCorrectiveIssueRow();
        }
    }
    if(maintTypeSel){
        maintTypeSel.addEventListener('change', updateCorrectiveVisibility);
        updateCorrectiveVisibility();
    }
    // Attachments preview (client-side)
    const attInput = modal.querySelector('#maintenanceAttachmentInput');
    if(attInput){
        attInput.addEventListener('change', ()=>{
            const cont = modal.querySelector('#maintenanceAttachmentPreview');
            if(!cont) return;
            cont.innerHTML = '';
            const files = Array.from(attInput.files||[]).slice(0,10);
            files.forEach(file=>{
                const el = document.createElement('div');
                el.style.cssText = 'width:84px;height:84px;border:1px solid #e0e0e0;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f9fafb;';
                if(file.type.startsWith('image/')){
                    const img = document.createElement('img');
                    img.alt = file.name; img.style.maxWidth='100%'; img.style.maxHeight='100%';
                    const reader = new FileReader();
                    reader.onload = e=> img.src = e.target.result;
                    reader.readAsDataURL(file);
                    el.appendChild(img);
                } else {
                    el.textContent = file.name.split('.')?.pop()?.toUpperCase()||'FILE';
                    el.style.fontSize = '.7rem'; el.style.padding='4px'; el.style.textAlign='center';
                }
                cont.appendChild(el);
            });
        });
    }
    return modal;
}

function closeMaintenanceModal(){
    const modal = document.getElementById('maintenanceModal');
    if(modal){ modal.classList.remove('show'); }
}

function resetMaintenanceForm(){
    const form = document.getElementById('maintenanceForm');
    if(!form) return;
    form.reset();
    const today = new Date().toISOString().slice(0,10);
    const dateInput = document.getElementById('maintenanceDate');
    if(dateInput) dateInput.value = today;
    // Generate a new reference number each time the modal opens/resets
    try {
        const sel = document.getElementById('maintenanceVehicleSelect');
        const vid = sel && sel.value ? String(sel.value) : '';
        const dt = new Date();
        const y = dt.getFullYear();
        const m = String(dt.getMonth()+1).padStart(2,'0');
        const d = String(dt.getDate()).padStart(2,'0');
        const ymd = `${y}${m}${d}`;
        const tailRaw = (vid||'').slice(-4).toUpperCase().replace(/[^A-Z0-9]/g,'');
        
        // Get next sequential number for today
        const seqKey = `maintenanceRefSeq_${ymd}`;
        let seq = parseInt(localStorage.getItem(seqKey) || '0', 10) + 1;
        localStorage.setItem(seqKey, seq.toString());
        
        const ref = `INSP-${ymd}${tailRaw? '-' + tailRaw : ''}-${String(seq).padStart(3, '0')}`;
        const refInput = document.getElementById('maintenanceRef');
        if(refInput) refInput.value = ref;
    } catch(e) { /* ignore */ }
    document.getElementById('maintenancePlate').value = '';
    document.getElementById('maintenanceRecordId').value = '';
}

function syncMaintenancePlate(){
    const sel = document.getElementById('maintenanceVehicleSelect');
    const plateInput = document.getElementById('maintenancePlate');
    if(!sel || !plateInput) return;
    const opt = sel.selectedOptions && sel.selectedOptions[0];
    plateInput.value = opt ? (opt.dataset.plate || '') : '';
}

function populateMaintenanceVehicleSelect(){
    const sel = document.getElementById('maintenanceVehicleSelect');
    if(!sel) return;
    // Preserve first placeholder option
    sel.querySelectorAll('option:not(:first-child)').forEach(o=>o.remove());
    
    const addOptions = (list)=>{
        if(!list || !list.length){
            const opt = document.createElement('option');
            opt.disabled = true; opt.value=''; opt.textContent='No vehicles available';
            sel.appendChild(opt);
            return;
        }
        list.forEach(v=>{
            const opt = document.createElement('option');
            opt.value = v.id || v.vehicleId || v.plateNumber || v.plate || v.name || '';
            opt.textContent = `${v.name||v.vehicleName||v.plateNumber||v.plate||'Vehicle'} (${v.plateNumber||v.plate||'n/a'})`;
            opt.dataset.plate = v.plateNumber || v.plate || '';
            opt.dataset.vehicleName = v.name || v.vehicleName || '';
            sel.appendChild(opt);
        });
    };
    
    if(!vehicleData || vehicleData.length===0){
        // Fallback: fetch once from DB
        try{
            const user = window.authManager?.currentUser;
            if(user?.companyId){
                firebase.database().ref(`companies/${user.companyId}/vehicles`).once('value').then(snap=>{
                    const data = snap.val()||{};
                    const list = Object.keys(data).map(id=>({id, ...data[id]}));
                    // cache for later use
                    if(Array.isArray(vehicleData)) vehicleData = list;
                    addOptions(list);
                });
            } else {
                addOptions([]);
            }
        } catch{ addOptions([]); }
        return;
    }
    addOptions(vehicleData);
}

async function saveMaintenanceReport(){
    if(!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId){
        showToast('Not authenticated', 'error'); return;
    }
    const companyId = window.authManager.currentUser.companyId;
    const form = document.getElementById('maintenanceForm');
    if(!form) return;
    // Ensure we can access the hidden signers input (was previously scoped only inside createMaintenanceModal)
    const signersHiddenInput = document.getElementById('maintenanceSignersInput');
    
    const vehicleId = form.vehicleId.value.trim();
    const date = form.date.value.trim();
    const status = form.status.value;
    const maintenanceType = form.maintenanceType.value;
    
    if(!vehicleId || !date){ showToast('Date & vehicle are required','warning'); return; }
    
    // Build safety checklist
    const safetyItems = ['Lights','Brakes','Horn','SeatBelts','Mirrors','WarningLights','FireExtinguisher','FirstAidKit'];
    const safetyResults = safetyItems.reduce((acc,item)=>{ 
        acc[item]= !!form[`safety_${item}`]?.checked; 
        return acc; 
    },{});
    const safetyPassCount = Object.values(safetyResults).filter(Boolean).length;
    
    // Compute risk score heuristic (simple weighting example)
    const severity = form.severity?.value || 'None';
    const severityWeight = {None:0,Low:1,Moderate:2,High:3,Critical:5}[severity] || 0;
    const tireStatuses = ['tire_frontLeft','tire_frontRight','tire_rearLeft','tire_rearRight'].map(n=>form[n]?.value||'');
    const wornCount = tireStatuses.filter(s=>['Worn','Replace','Punctured'].includes(s)).length;
    // Form field names are lowercased without spaces: engineoillevel, coolantlevel
    const fluidAlerts = ['engineoillevel','coolantlevel','washerfluid'].filter(n=>['Low','Empty'].includes(form[n]?.value||'' )).length;
    const safetyFails = safetyItems.length - safetyPassCount;
    const rawScore = severityWeight*10 + wornCount*5 + fluidAlerts*7 + safetyFails*4;
    // Compliance issue weighting (penalize non-OK statuses)
        const complianceGroups = {
    documentation: ['vehicleRegistrationCertificate','insuranceCertificate','technicalInspectionCertificate','serviceSticker','vehicleLogbook','fuelCardPermit','driversLicense'],
    safetyEquipment: ['fireExtinguisher','firstAidKit','reflectiveTriangles','emergencyExit','seatBelts','horn','warningLightsIndicators','reverseAlarm','radio'],
    mechanicalCondition: ['footBrakes','handBrakes','steeringSystem','tires','windshieldWipers','lights','mirrors','suspension','battery','bodyDamage'],
        environmental: ['vehicleCleanliness','oilLeaks','exhaustSmoke','wasteDisposal'],
        operational: ['fuelLevel','odometerReading','gpsTracking','dailyChecklistCompleted','previousDefectsCorrected']
    };
    let complianceIssuesCount = 0;
    const problematic = ['Issue','Missing','Expired'];
    Object.entries(complianceGroups).forEach(([group, items])=>{
        items.forEach(key=>{
            const statusEl = form[`${group.startsWith('documentation')? 'doc': group.startsWith('safetyEquipment')? 'safetyEquip': group.startsWith('mechanicalCondition')? 'mech': group.startsWith('environmental')? 'env': 'oper'}_${key}_status`];
            if(statusEl && problematic.includes(statusEl.value)) complianceIssuesCount++;
        });
    });
    const adjustedRawScore = rawScore + complianceIssuesCount * 6; // each compliance issue adds weight
    
    const riskScore = Math.min(100, adjustedRawScore);
    if(document.getElementById('maintenanceRiskScore')) document.getElementById('maintenanceRiskScore').value = riskScore;

    // Collect attachments (already uploaded or to be uploaded) - for now store metadata from preview container dataset
    const attachmentContainer = document.getElementById('maintenanceAttachmentPreview');
    const attachments = Array.from(attachmentContainer?.querySelectorAll('[data-file-meta]')||[]).map(el=>{
        try { return JSON.parse(el.dataset.fileMeta); } catch { return null; }
    }).filter(Boolean);

        // Gather granular action items (ignore blank descriptions)
        const actionItems = Array.from(document.querySelectorAll('#actionItemsContainer .action-item-row')).map(row=>{
            const labelInput = row.querySelector('input[name="action_title_label"]');
            const keyInput = row.querySelector('input[name="action_title_key"]');
            const label = labelInput?.value?.trim() || '';
            const value = keyInput?.value || '';
            const assignee = row.querySelector('select[name="action_assignee"]')?.value || '';
            const due = row.querySelector('input[name="action_due"]')?.value || '';
            if(!label) return null;
            // Store human-friendly title; include key if selected from taxonomy
            return { title: label, titleKey: value, assignee, due };
        }).filter(Boolean);

        // Gather corrective issues if any
        const correctiveIssues = Array.from(document.querySelectorAll('#correctiveIssuesContainer .corrective-issue-row')).map(row=>{
            const category = row.querySelector('input[name="corr_category"]')?.value || '';
            const categoryLabel = row.querySelector('input[name="corr_category_label"]')?.value?.trim() || '';
            const failureMode = row.querySelector('select[name="corr_failureMode"]')?.value || '';
            const severityVal = row.querySelector('select[name="corr_severity"]')?.value || '';
            const remarks = row.querySelector('input[name="corr_remarks"]')?.value?.trim() || '';
            if(!category && !failureMode && !remarks) return null; // ignore completely empty
            return { category, categoryLabel, failureMode, severity: severityVal, remarks };
        }).filter(Boolean);

        // Build extended record
        const record = {
        reportType: 'maintenance',
    referenceNumber: form.referenceNumber?.value || '',
        vehicleId,
        vehiclePlate: form.plate.value || '',
        vehicleName: form.maintenanceVehicleSelect.selectedOptions[0]?.dataset.vehicleName || '',
        date,
        odometer: form.odometer.value? parseInt(form.odometer.value,10): null,
        maintenanceType,
        status,
        severity,
        followupRequired: form.followupRequired?.value || 'No',
        followupDue: form.followupDue?.value || '',
        intervalDays: form.intervalDays?.value? parseInt(form.intervalDays.value,10): null,
        riskScore,
            reviewer: form.reviewer?.value?.trim() || '',
            signer: (signersHiddenInput?.value?.split(',').filter(Boolean)[0]) || '',
            signers: signersHiddenInput?.value ? signersHiddenInput.value.split(',').filter(Boolean) : [],
            signedAt: (signersHiddenInput?.value && signersHiddenInput.value.split(',').filter(Boolean)[0]) ? new Date().toISOString(): '',
            correctiveIssues: correctiveIssues,
        // Fluids (status + remarks)
        fluids: {
            engineOilLevel: { value: form.engineoillevel?.value || '', remarks: form.engineoillevel_remarks?.value || '' },
            engineOilQuality: { value: form.engineoilquality?.value || '', remarks: form.engineoilquality_remarks?.value || '' },
            coolantLevel: { value: form.coolantlevel?.value || '', remarks: form.coolantlevel_remarks?.value || '' },
            brakeFluid: { value: form.brakefluid?.value || '', remarks: form.brakefluid_remarks?.value || '' },
            hydraulicFluid: { value: form.hydraulicfluid?.value || '', remarks: form.hydraulicfluid_remarks?.value || '' },
            washerFluid: { value: form.washerfluid?.value || '', remarks: form.washerfluid_remarks?.value || '' }
        },
        // Tires (status + remarks)
        tires: {
            frontLeft: { value: form.tire_frontLeft?.value || '', remarks: form.tire_frontLeft_remarks?.value || '' },
            frontRight: { value: form.tire_frontRight?.value || '', remarks: form.tire_frontRight_remarks?.value || '' },
            rearLeft: { value: form.tire_rearLeft?.value || '', remarks: form.tire_rearLeft_remarks?.value || '' },
            rearRight: { value: form.tire_rearRight?.value || '', remarks: form.tire_rearRight_remarks?.value || '' }
        },
        // Wheels & Tools (status + remarks)
        wheels: {
            wheelnutstorque: { value: form.wheelnutstorque?.value || '', remarks: form.wheelnutstorque_remarks?.value || '' },
            sparetire: { value: form.sparetire?.value || '', remarks: form.sparetire_remarks?.value || '' },
            jacktools: { value: form.jacktools?.value || '', remarks: form.jacktools_remarks?.value || '' },
            steeringWheel: { value: form.steeringWheel?.value || '', remarks: form.steeringWheel_remarks?.value || '' }
        },
        // Safety checklist
        safety: safetyResults,
        extras: {
            emergencyexit: form.emergencyexit?.value || '',
            reflectivetriangles: form.reflectivetriangles?.value || '',
            backupalarm: form.backupalarm?.value || ''
        },
        // Compliance & extended categories
        compliance: {
            documentation: complianceGroups.documentation.reduce((acc,key)=>{
                const prefix='doc_'+key;
                acc[key] = {
                    requirement: form[`${prefix}_requirement`]?.value || '',
                    status: form[`${prefix}_status`]?.value || '',
                    remarks: form[`${prefix}_remarks`]?.value || ''
                }; return acc; }, {}),
            safetyEquipment: complianceGroups.safetyEquipment.reduce((acc,key)=>{
                const prefix='safetyEquip_'+key;
                acc[key] = {
                    requirement: form[`${prefix}_requirement`]?.value || '',
                    status: form[`${prefix}_status`]?.value || '',
                    remarks: form[`${prefix}_remarks`]?.value || ''
                }; return acc; }, {}),
            mechanicalCondition: complianceGroups.mechanicalCondition.reduce((acc,key)=>{
                const prefix='mech_'+key;
                acc[key] = {
                    requirement: form[`${prefix}_requirement`]?.value || '',
                    status: form[`${prefix}_status`]?.value || '',
                    remarks: form[`${prefix}_remarks`]?.value || ''
                }; return acc; }, {}),
            environmental: complianceGroups.environmental.reduce((acc,key)=>{
                const prefix='env_'+key;
                acc[key] = {
                    requirement: form[`${prefix}_requirement`]?.value || '',
                    status: form[`${prefix}_status`]?.value || '',
                    remarks: form[`${prefix}_remarks`]?.value || ''
                }; return acc; }, {}),
            operational: complianceGroups.operational.reduce((acc,key)=>{
                const prefix='oper_'+key;
                acc[key] = {
                    requirement: form[`${prefix}_requirement`]?.value || '',
                    status: form[`${prefix}_status`]?.value || '',
                    remarks: form[`${prefix}_remarks`]?.value || ''
                }; return acc; }, {})
        },
        issues: (form.issues?.value || '').trim(),
    actions: (form.actions?.value || '').trim(),
    actionItems,
        nextServiceDate: form.nextServiceDate.value || '',
        nextServiceOdometer: form.nextServiceOdometer.value? parseInt(form.nextServiceOdometer.value,10): null,
    technician: (form.technician?.value?.trim()) || window.authManager?.currentUser?.email || 'unknown',
        checklistPass: safetyPassCount,
        checklistTotal: safetyItems.length,
        attachments, // array of {name,size,type,downloadURL,storagePath}
        createdAt: new Date().toISOString(),
        inspector: window.authManager.currentUser.uid || window.authManager.currentUser.email || 'unknown'
    };
    
    try {
        // Pre-create DB ref to get key for attachment upload paths
        const ref = firebase.database().ref(`companies/${companyId}/vehicleInspections`).push();
        const key = ref.key;

        // Upload attachments if any
        const files = (document.getElementById('maintenanceAttachmentInput')?.files)||[];
        const maxFiles = Math.min(files.length||0, 10);
        const uploads = [];
        const storageRoot = firebase.storage().ref();
        for(let i=0;i<maxFiles;i++){
            const file = files[i];
            if(!file) continue;
            if(file.size > 5*1024*1024){ showToast(`File too large: ${file.name}`,'warning'); continue; }
            const safeName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9_.-]/g,'_')}`;
            const path = `companies/${companyId}/vehicleInspections/${key}/attachments/${safeName}`;
            const sref = storageRoot.child(path);
            uploads.push(sref.put(file).then(()=> sref.getDownloadURL()).then(downloadURL => ({
                name: file.name,
                size: file.size,
                type: file.type,
                uploadDate: new Date().toISOString(),
                downloadURL,
                storagePath: path
            })).catch(err=>{ console.error('Attachment upload failed', err); return null; }));
        }
        const uploaded = (await Promise.all(uploads)).filter(Boolean);
        record.attachments = uploaded;

        await ref.set(record);
        showToast('Maintenance report saved','success');
        closeMaintenanceModal();
        // Refresh list
        loadInspections(true);
    } catch(err){
        console.error('Failed to save maintenance report', err);
        showToast('Save failed','error');
    }
}
    const modal = document.createElement('div');
    modal.id = 'vehicleInspectionModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="inspectionModalTitle">
            <div class="modal-header">
                <h5 id="inspectionModalTitle"><i class="fas fa-tools"></i> New Vehicle Inspection</h5>
                <button class="close-btn" type="button" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="max-height:65vh;overflow:auto;">
                <form id="inspectionForm" autocomplete="off">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:10px;">
                        <div>
                            <label for="inspectionDate">Date</label>
                            <input type="date" id="inspectionDate" name="date" required />
                        </div>
                        <div>
                            <label for="inspectionVehicleSelect">Vehicle</label>
                            <select id="inspectionVehicleSelect" name="vehicleId" required>
                                <option value="">Select vehicle...</option>
                            </select>
                        </div>
                        <div>
                            <label>Plate</label>
                            <input type="text" id="inspectionPlate" name="plate" readonly placeholder="Auto" />
                        </div>
                        <div>
                            <label for="inspectionOdometer">Odometer (km)</label>
                            <input type="number" id="inspectionOdometer" name="odometer" min="0" step="1" placeholder="e.g. 15230" />
                        </div>
                        <div>
                            <label for="inspectionStatus">Overall Status</label>
                            <select id="inspectionStatus" name="status" required>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                                <option value="Needs Attention">Needs Attention</option>
                            </select>
                        </div>
                    </div>
                    <fieldset style="border:1px solid #e0e0e0;border-radius:6px;padding:10px 12px;margin-bottom:12px;">
                        <legend style="font-size:.75rem;font-weight:600;padding:0 6px;">Checklist</legend>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:6px;">
                            ${['Brakes','Lights','Tires','Fluids','Battery','Horn'].map(item => `
                            <label style="display:flex;gap:6px;align-items:center;font-size:.75rem;">
                                <input type="checkbox" name="check_${item}" value="1" /> ${item}
                            </label>`).join('')}
                        </div>
                    </fieldset>
                    <div style="margin-bottom:10px;">
                        <label for="inspectionNotes">Notes / Findings</label>
                        <textarea id="inspectionNotes" name="notes" rows="3" placeholder="Observations, defects, actions required..." style="width:100%;resize:vertical;"></textarea>
                    </div>
                    <input type="hidden" id="inspectionRecordId" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="cancel">Cancel</button>
                <button type="submit" form="inspectionForm" class="btn btn-primary"><i class="fas fa-save"></i> Save Inspection</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    // Events
// =============================
// Original Simple Inspection Modal (kept for compatibility)
// =============================
function createInspectionModal(){
    const modal = document.createElement('div');
    modal.id = 'vehicleInspectionModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="inspectionModalTitle">
            <div class="modal-header">
                <h5 id="inspectionModalTitle"><i class="fas fa-tools"></i> New Vehicle Inspection</h5>
                <button class="close-btn" type="button" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="max-height:65vh;overflow:auto;">
                <form id="inspectionForm" autocomplete="off">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:10px;">
                        <div>
                            <label for="inspectionDate">Date</label>
                            <input type="date" id="inspectionDate" name="date" required />
                        </div>
                        <div>
                            <label for="inspectionVehicleSelect">Vehicle</label>
                            <select id="inspectionVehicleSelect" name="vehicleId" required>
                                <option value="">Select vehicle...</option>
                            </select>
                        </div>
                        <div>
                            <label>Plate</label>
                            <input type="text" id="inspectionPlate" name="plate" readonly placeholder="Auto" />
                        </div>
                        <div>
                            <label for="inspectionOdometer">Odometer (km)</label>
                            <input type="number" id="inspectionOdometer" name="odometer" min="0" step="1" placeholder="e.g. 15230" />
                        </div>
                        <div>
                            <label for="inspectionStatus">Overall Status</label>
                            <select id="inspectionStatus" name="status" required>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                                <option value="Needs Attention">Needs Attention</option>
                            </select>
                        </div>
                    </div>
                    <fieldset style="border:1px solid #e0e0e0;border-radius:6px;padding:10px 12px;margin-bottom:12px;">
                        <legend style="font-size:.75rem;font-weight:600;padding:0 6px;">Checklist</legend>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:6px;">
                            ${['Brakes','Lights','Tires','Fluids','Battery','Horn'].map(item => `
                            <label style="display:flex;gap:6px;align-items:center;font-size:.75rem;">
                                <input type="checkbox" name="check_${item}" value="1" /> ${item}
                            </label>`).join('')}
                        </div>
                    </fieldset>
                    <div style="margin-bottom:10px;">
                        <label for="inspectionNotes">Notes / Findings</label>
                        <textarea id="inspectionNotes" name="notes" rows="3" placeholder="Observations, defects, actions required..." style="width:100%;resize:vertical;"></textarea>
                    </div>
                    <input type="hidden" id="inspectionRecordId" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="cancel">Cancel</button>
                <button type="submit" form="inspectionForm" class="btn btn-primary"><i class="fas fa-save"></i> Save Inspection</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    // Events
    modal.querySelector('.close-btn').addEventListener('click', ()=>closeInspectionModal());
    modal.querySelector('[data-action="cancel"]').addEventListener('click', ()=>closeInspectionModal());
    modal.querySelector('#inspectionVehicleSelect').addEventListener('change', syncInspectionPlate);
    modal.querySelector('#inspectionForm').addEventListener('submit', e=>{ e.preventDefault(); saveInspection(); });
    return modal;
}

function closeInspectionModal(){
    const modal = document.getElementById('vehicleInspectionModal');
    if(modal){ modal.classList.remove('show'); }
}

function resetInspectionForm(){
    const form = document.getElementById('inspectionForm');
    if(!form) return;
    form.reset();
    const today = new Date().toISOString().slice(0,10);
    const dateInput = document.getElementById('inspectionDate');
    if(dateInput) dateInput.value = today;
    document.getElementById('inspectionPlate').value = '';
    document.getElementById('inspectionRecordId').value='';
}

function populateInspectionVehicleSelect(){
    const sel = document.getElementById('inspectionVehicleSelect');
    if(!sel) return;
    // Preserve first placeholder option
    sel.querySelectorAll('option:not(:first-child)').forEach(o=>o.remove());
    const addOptions = (list)=>{
        if(!list || !list.length){
            const opt = document.createElement('option');
            opt.disabled = true; opt.value=''; opt.textContent='No vehicles available';
            sel.appendChild(opt);
            return;
        }
        list.forEach(v=>{
            const opt = document.createElement('option');
            opt.value = v.id || v.vehicleId || v.plateNumber || v.plate || v.name || '';
            opt.textContent = `${v.name||v.vehicleName||v.plateNumber||v.plate||'Vehicle'} (${v.plateNumber||v.plate||'n/a'})`;
            opt.dataset.plate = v.plateNumber || v.plate || '';
            sel.appendChild(opt);
        });
    };
    if(!vehicleData || vehicleData.length===0){
        // Fallback: fetch once from DB
        try{
            const user = window.authManager?.currentUser;
            if(user?.companyId){
                firebase.database().ref(`companies/${user.companyId}/vehicles`).once('value').then(snap=>{
                    const data = snap.val()||{};
                    const list = Object.keys(data).map(id=>({id, ...data[id]}));
                    // cache for later use
                    if(Array.isArray(vehicleData)) vehicleData = list;
                    addOptions(list);
                });
            } else {
                addOptions([]);
            }
        } catch{ addOptions([]); }
        return;
    }
    vehicleData.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.id || v.vehicleId || v.plateNumber || v.plate || v.name || '';
        opt.textContent = `${v.name||v.vehicleName||v.plateNumber||v.plate||'Vehicle'} (${v.plateNumber||v.plate||'n/a'})`;
        opt.dataset.plate = v.plateNumber || v.plate || '';
        sel.appendChild(opt);
    });
}

function syncInspectionPlate(){
    const sel = document.getElementById('inspectionVehicleSelect');
    const plateInput = document.getElementById('inspectionPlate');
    if(!sel || !plateInput) return;
    const opt = sel.selectedOptions[0];
    plateInput.value = opt? (opt.dataset.plate || '') : '';
}

async function saveInspection(){
    if(!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId){
        showToast('Not authenticated', 'error'); return;
    }
    const companyId = window.authManager.currentUser.companyId;
    const form = document.getElementById('inspectionForm');
    if(!form) return;
    const vehicleId = form.vehicleId.value.trim();
    const date = form.date.value.trim();
    const status = form.status.value;
    if(!vehicleId || !date){ showToast('Date & vehicle are required','warning'); return; }
    const record = {
        vehicleId,
        vehiclePlate: form.plate.value || '',
        date,
        odometer: form.odometer.value? parseInt(form.odometer.value,10): null,
        status,
        notes: form.notes.value.trim(),
        checklist: ['Brakes','Lights','Tires','Fluids','Battery','Horn'].reduce((acc,item)=>{ acc[item]= !!form[`check_${item}`]?.checked; return acc; },{}),
        createdAt: new Date().toISOString(),
        inspector: window.authManager.currentUser.uid || window.authManager.currentUser.email || 'unknown'
    };
    try {
        const ref = firebase.database().ref(`companies/${companyId}/vehicleInspections`).push();
        await ref.set(record);
        showToast('Inspection saved','success');
        closeInspectionModal();
        // Refresh list
        loadInspections(true);
    } catch(err){
        console.error('Failed to save inspection', err);
        showToast('Save failed','error');
    }
}

// Load inspections (optionally force reload)
let inspectionsLoadedOnce = false;
async function loadInspections(force=false){
    if(!document.getElementById('maintenanceTabContent')) return; // ensure tab exists
    if(!force && inspectionsLoadedOnce && inspectionsData.length){ renderInspectionsTable(); return; }
    if(!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId){
        // show empty state
        inspectionsData = [];
        renderInspectionsTable();
        return;
    }
    const companyId = window.authManager.currentUser.companyId;
    try {
        const snap = await firebase.database().ref(`companies/${companyId}/vehicleInspections`).once('value');
        const data = snap.val() || {};
    inspectionsData = Object.keys(data).map(id => ({ id, ...data[id] }));
        // Sort newest first
        inspectionsData.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
        inspectionsLoadedOnce = true;
        renderInspectionsTable();
    // Refresh deep analytics filters based on new data
    populateDeepTypeFilter?.();
    populateDeepComplianceItems?.();
        // If a vehicle filter is active, show the filter chip
        updateInspectionFilterUI();
    } catch(err){
        console.error('Error loading inspections', err);
        inspectionsData = [];
        renderInspectionsTable();
        updateInspectionFilterUI();
    }
}

function renderInspectionsTable(){
    const tbody = document.getElementById('inspectionTableBody');
    const empty = document.getElementById('inspectionEmptyState');
    if(!tbody) return;
    tbody.innerHTML = '';
    // Apply active vehicle filter if set
    let dataToRender = inspectionsData;
    if (window.activeInspectionVehicleFilter && typeof window.activeInspectionVehicleFilter === 'object') {
        const { vehicleId } = window.activeInspectionVehicleFilter;
        if (vehicleId) {
            dataToRender = inspectionsData.filter(rec => rec.vehicleId === vehicleId);
        }
    }

    if(!dataToRender.length){
        if(empty) empty.style.display='block';
        return;
    }
    if(empty) empty.style.display='none';
    dataToRender.forEach((rec, idx)=>{
        const tr = document.createElement('tr');
        const checklistCount = rec.checklist ? Object.values(rec.checklist).filter(Boolean).length
                              : (typeof rec.checklistPass==='number' ? rec.checklistPass : 0);
        const checklistTotal = rec.checklist ? Object.keys(rec.checklist).length
                               : (typeof rec.checklistTotal==='number' ? rec.checklistTotal : 6);
        
        // Determine type badge
        const typeDisplay = rec.reportType === 'maintenance' 
            ? `<span style="font-size:.65rem;background:#17a2b8;color:#fff;padding:2px 6px;border-radius:8px;">${escapeHtml(rec.maintenanceType||'Maintenance')}</span>`
            : rec.reportType === 'full'
            ? `<span style="font-size:.65rem;background:#6f42c1;color:#fff;padding:2px 6px;border-radius:8px;">Full Inspection</span>`
            : `<span style="font-size:.65rem;background:#6c757d;color:#fff;padding:2px 6px;border-radius:8px;">Quick Check</span>`;
        
        tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${escapeHtml(rec.date||'')}</td>
            <td>${escapeHtml(rec.vehiclePlate||rec.vehicleId||'')}</td>
            <td style="white-space:nowrap;">${rec.odometer!=null? rec.odometer:'-'}</td>
            <td>${getInspectionStatusBadge(rec.status)}</td>
            <td>${checklistCount}/${checklistTotal}</td>
            <td>${getSeverityBadge(rec.severity||'None')}</td>
            <td>${getFollowupBadge(rec.followupRequired, rec.followupDue)}</td>
            <td>${getRiskPill(rec.riskScore)}</td>
            <td>${getAttachmentsBadge(rec.attachments)}</td>
            <td>${typeDisplay}</td>
            <td style="display:flex;gap:6px;">
                <button class="btn-action btn-view" title="Details" onclick="viewVehicleInspection('${rec.id}')"><i class="fas fa-eye"></i></button>
                <button class="btn-action btn-danger" title="Delete" onclick="deleteVehicleInspection('${rec.id}')"><i class="fas fa-trash"></i></button>
            </td>`;
        // Row click opens details modal (except when clicking action buttons)
        tr.addEventListener('click', (e)=>{
            const target = e.target.closest('button');
            if(target) return; // ignore action buttons
            viewVehicleInspection(rec.id);
        });
        tbody.appendChild(tr);
    });
}

function getInspectionStatusBadge(status){
    const map = { 'Pass':'#2ecc71','Fail':'#e74c3c','Needs Attention':'#f39c12' };
    const color = map[status] || '#95a5a6';
    return `<span style="display:inline-block;padding:3px 8px;border-radius:12px;font-size:.65rem;font-weight:600;background:${color};color:#fff;">${escapeHtml(status||'N/A')}</span>`;
}

// Severity badge for inspection severity
function getSeverityBadge(severity){
    if(!severity) return '<span class="fleet-badge status-out">-</span>';
    const map = {
        'Critical': { bg:'#dc3545', cls:'status-fail' },
        'High': { bg:'#e67e22', cls:'type-corrective' },
        'Medium': { bg:'#ffc107', cls:'status-needs' },
        'Low': { bg:'#2ecc71', cls:'status-pass' },
        'None': { bg:'#6c757d', cls:'status-out' }
    };
    const m = map[severity] || map['None'];
    return `<span class="fleet-badge ${m.cls}" style="background:${m.bg};">${escapeHtml(severity)}</span>`;
}

// Follow-up badge shows if required and optional due date
function getFollowupBadge(required, due){
    if(required===undefined || required===null) return '<span class="fleet-badge status-out">-</span>';
    if(required){
        const title = due ? ` title="Due: ${escapeHtml(due)}"` : '';
        return `<span class="fleet-badge followup"${title}>Req${due? ' '+escapeHtml(due):''}</span>`;
    }
    return '<span class="fleet-badge status-pass" style="background:#2ecc71;">None</span>';
}

// Risk score pill visual
function getRiskPill(score){
    if(score==null || score==='') return '<span class="risk-score-pill" style="background:#ddd;color:#444;">N/A</span>';
    const cls = score < 35 ? 'risk-low' : score < 70 ? 'risk-med' : 'risk-high';
    return `<span class="risk-score-pill ${cls}">R ${escapeHtml(score)}</span>`;
}

// Attachments count badge
function getAttachmentsBadge(list){
    if(Array.isArray(list) && list.length){
        return `<span class="fleet-badge attachments" title="${list.length} attachment(s)">${list.length}</span>`;
    }
    return '<span class="fleet-badge status-out">0</span>';
}

function viewVehicleInspection(id){
        const rec = inspectionsData.find(r=>r.id===id);
        if(!rec){ showToast('Record not found','warning'); return; }
        let modal = document.getElementById('inspectionDetailsModal');
            if(!modal){
                modal = document.createElement('div');
                modal.id = 'inspectionDetailsModal';
                modal.className = 'modal';
                modal.innerHTML = `
                        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="inspectionDetailsTitle" style="max-width:1100px;">
                        <div class="modal-header">
                            <h5 id="inspectionDetailsTitle"><i class="fas fa-file-search"></i> Inspection Report Details</h5>
                            <button class="close-btn" type="button" aria-label="Close">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height:72vh;overflow:auto;">
                            <div id="inspectionDetailsContainer"></div>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-action="print"><i class="fas fa-print"></i> Print</button>
                                <button type="button" class="btn btn-light" data-action="template"><i class="fas fa-file-alt"></i> Template</button>
                                <button type="button" class="btn btn-secondary" data-action="close">Close</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
                modal.querySelector('.close-btn').addEventListener('click', ()=> modal.classList.remove('show'));
                modal.querySelector('[data-action="close"]').addEventListener('click', ()=> modal.classList.remove('show'));
                // Bind footer actions once
                const printBtn = modal.querySelector('[data-action="print"]');
                if (printBtn && !printBtn.__bound) {
                    printBtn.addEventListener('click', ()=>{ window.print(); });
                    printBtn.__bound = true;
                }
                const tmplBtn = modal.querySelector('[data-action="template"]');
                if (tmplBtn && !tmplBtn.__bound) {
                    tmplBtn.addEventListener('click', ()=>{
                        const cont = modal.querySelector('#inspectionDetailsContainer');
                        if (!cont) { window.print(); return; }
                        const before = cont.innerHTML;
                        // Convert value/status/remarks cells into empty placeholders for a clean template print
                        cont.classList.add('template-mode');
                        cont.querySelectorAll('.comp-status, .comp-remarks').forEach(el=>{ el.innerHTML = "<div class='template-empty'>&nbsp;</div>"; });
                        // Print, then restore original content
                        setTimeout(()=>{
                            try { window.print(); } finally {
                                setTimeout(()=>{ cont.innerHTML = before; cont.classList.remove('template-mode'); }, 50);
                            }
                        }, 0);
                    });
                    tmplBtn.__bound = true;
                }
        }

        // Helper renderers
        const pillForRisk = (score)=>{
                if(score==null) return '<span class="risk-score-pill" style="background:#ddd;color:#444;">N/A</span>';
                const cls = score < 35 ? 'risk-low' : score < 70 ? 'risk-med' : 'risk-high';
                return `<span class="risk-score-pill ${cls}">Risk ${score}</span>`;
        };
    const badge = (text, color='#6c757d')=> `<span style="display:inline-block;padding:3px 8px;border-radius:12px;font-size:.6rem;font-weight:600;background:${color};color:#fff;">${escapeHtml(text || 'N/A')}</span>`;
        const compStatusColor = (st)=> ({'OK':'#28a745','Issue':'#fd7e14','Missing':'#dc3545','Expired':'#6f42c1','N/A':'#6c757d'}[st]||'#6c757d');
    const fmtYesNo = (v)=> (v===true || v==='true' || v==='Yes' || v==='yes' || v===1 || v==='1') ? 'Yes' : 'No';
    const fmtTextOrDash = (v)=> (v===undefined || v===null || v==='') ? '-' : v;

        // Build compliance sections if present
    const renderComplianceGroup = (groupName, obj)=>{
                if(!obj) return '<em style="font-size:.7rem;color:#666;">No data</em>';
        return `<div class='comp-group'>${Object.entries(obj).map(([key,val])=>{
            return `<div class='comp-row'>
        <div class='comp-item'><strong>${escapeHtml(humanizeFieldKey(key))}</strong><br><small>${escapeHtml(val?.requirement||'')}</small></div>
                <div class='comp-status'>${badge((val&&val.status)||'N/A', compStatusColor((val&&val.status)||'N/A'))}</div>
                <div class='comp-remarks'>${escapeHtml((val&&val.remarks) ? val.remarks : '-')}</div>
            </div>`;
                }).join('')}</div>`;
        };

        const container = modal.querySelector('#inspectionDetailsContainer');
        if(!container) return;
        const attachmentsHtml = (rec.attachments && rec.attachments.length)
                ? `<div class='attach-grid'>${rec.attachments.map(att=>{
                        const isImg = att.type && att.type.startsWith('image/');
                        return `<div class='attach-item'>
                             ${isImg? `<img src='${att.downloadURL}' alt='${escapeHtml(att.name)}'/>` : `<div class='file-icon'><i class='fas fa-file'></i></div>`}
                             <div class='attach-meta'>
                                     <div class='attach-name' title='${escapeHtml(att.name)}'>${escapeHtml(att.name)}</div>
                                     <a href='${att.downloadURL}' target='_blank' rel='noopener' class='attach-link'>Open</a>
                             </div>
                        </div>`; }).join('')}</div>`
                : '<em style="font-size:.7rem;color:#666;">No attachments</em>';

        // Basic checklist summary
        const checklistCount = rec.checklist ? Object.values(rec.checklist).filter(Boolean).length
                                                    : (typeof rec.checklistPass==='number' ? rec.checklistPass : 0);
        const checklistTotal = rec.checklist ? Object.keys(rec.checklist).length
                                                     : (typeof rec.checklistTotal==='number' ? rec.checklistTotal : 6);

        // Compliance summary counts
        const compliance = rec.compliance || {};
        const allCompItems = Object.values(compliance).flatMap(group => group? Object.values(group): []);
        const compIssues = allCompItems.filter(i => ['Issue','Missing','Expired'].includes(i.status)).length;
        const compTotal = allCompItems.length;

        // Company branding data for header logo
        const currCompany = window.authManager?.currentCompany || {};
        const companyName = currCompany.companyName || window.authManager?.currentUser?.companyName || 'Company';
        const logoUrl = rec.companyLogoUrl || currCompany.logo || currCompany.logoUrl || null;
        const companyInitials = (()=>{
            const letters = (companyName||'').trim().split(/\s+/).map(w=>w[0]).filter(Boolean);
            return (letters.slice(0,2).join('') || 'CO').toUpperCase();
        })();

    // Generic row builder to mimic compliance styling for other sections
    const compRowHtml = (label, value, remarks='-') => `<div class='comp-row'>
        <div class='comp-item'><strong>${escapeHtml(label)}</strong><br><small>${''}</small></div>
        <div class='comp-status'>${(value && typeof value === 'string' && value.startsWith('<'))? value : escapeHtml(value==null||value===''? 'N/A': value)}</div>
        <div class='comp-remarks'>${escapeHtml(remarks==null||remarks===''? '-': remarks)}</div>
    </div>`;

    // Resolve a user ID to a friendly name using current company users
    const userNameFor = (uid) => {
        if (!uid) return '';
        const users = (window.authManager?.currentCompany?.users) || {};
        const u = users[uid];
        return (u?.displayName || u?.name || u?.email || uid);
    };

    // Human-friendly labels for raw field keys in fluids / tires / wheels / extras sections
    const fieldLabelMap = {
        engineoillevel: 'Engine Oil Level',
        engineoilquality: 'Engine Oil Quality',
        coolantlevel: 'Coolant Level',
        brakefluid: 'Brake Fluid',
        hydraulicfluid: 'Hydraulic Fluid',
    washerfluid: 'Washer Fluid',
        tire_frontLeft: 'Front Left Tire',
        tire_frontRight: 'Front Right Tire',
        tire_rearLeft: 'Rear Left Tire',
        tire_rearRight: 'Rear Right Tire',
        wheelnutstorque: 'Wheel Nut Torque',
        sparetire: 'Spare Tire',
    jacktools: 'Jack & Tools',
    steeringWheel: 'Steering Wheel',
        emergencyExit: 'Emergency Exit',
        // Compliance: Documentation
        vehicleRegistrationCertificate: 'Vehicle Registration Certificate',
        insuranceCertificate: 'Insurance Certificate',
        technicalInspectionCertificate: 'Technical Inspection Certificate',
        vehicleLogbook: 'Vehicle Logbook',
        fuelCardPermit: 'Fuel Card Permit',
        driversLicense: 'Driver License',
    serviceSticker: 'Service Sticker / Next Service',
        // Compliance: Safety Equipment
        fireExtinguisher: 'Fire Extinguisher',
        firstAidKit: 'First Aid Kit',
        reflectiveTriangles: 'Reflective Triangles',
        seatBelts: 'Seat Belts',
        horn: 'Horn',
        warningLightsIndicators: 'Warning Lights / Indicators',
        reverseAlarm: 'Reverse Alarm',
	radio: 'Radio',
    // Compliance: Mechanical Condition
    footBrakes: 'Foot Brake',
    handBrakes: 'Hand Brake',
        steeringSystem: 'Steering System',
        tires: 'Tires',
        windshieldWipers: 'Windshield Wipers',
        lights: 'Lights',
        mirrors: 'Mirrors',
        suspension: 'Suspension',
        battery: 'Battery',
	bodyDamage: 'Body Damage',
        // Compliance: Environmental & Cleanliness
        vehicleCleanliness: 'Vehicle Cleanliness',
        oilLeaks: 'Oil Leaks',
        exhaustSmoke: 'Exhaust Smoke',
        wasteDisposal: 'Waste Disposal',
        // Compliance: Operational Readiness
        fuelLevel: 'Fuel Level',
        odometerReading: 'Odometer Reading',
        gpsTracking: 'GPS Tracking',
        dailyChecklistCompleted: 'Daily Checklist Completed',
        previousDefectsCorrected: 'Previous Defects Corrected'
    };
    const humanizeFieldKey = (key)=> fieldLabelMap[key] || key
        .replace(/([a-z])([A-Z])/g,'$1 $2')
        .replace(/_/g,' ')
        .replace(/\b\w/g, c=> c.toUpperCase());

    const summaryGroupHtml = `<div class='comp-group'>${[
        compRowHtml('Date', escapeHtml(rec.date||'-')),
        (rec.referenceNumber ? compRowHtml('Reference #', escapeHtml(rec.referenceNumber)) : ''),
        compRowHtml('Vehicle', escapeHtml(rec.vehicleName||rec.vehiclePlate||rec.vehicleId||'-')),
        compRowHtml('Plate', escapeHtml(rec.vehiclePlate||'-')),
        compRowHtml('Company', window.authManager?.currentUser?.companyName||'-'),
        compRowHtml('Odometer', rec.odometer!=null? rec.odometer: '-'),
        compRowHtml('Status', badge(rec.status, compStatusColor(rec.status))),
        compRowHtml('Type', rec.maintenanceType|| (rec.reportType==='maintenance'? 'Maintenance':'Inspection')), 
        compRowHtml('Checklist', `${checklistCount}/${checklistTotal}`),
        compRowHtml('Risk', pillForRisk(rec.riskScore)),
        compRowHtml('Compliance Issues', `${compIssues}/${compTotal||0}`),
        compRowHtml('Severity', rec.severity||'None'),
        compRowHtml('Service Interval (days)', rec.intervalDays!=null? rec.intervalDays : '-'),
        (Array.isArray(rec.signers) && rec.signers.length
            ? compRowHtml('Signers', rec.signers.map(userNameFor).join(', '))
            : (rec.signer ? compRowHtml('Signer', userNameFor(rec.signer)) : ''))
    ].join('')}</div>`;

    // Issues & Actions section: show Issues/Actions text fields (if present) and granular Action Items
    const issuesRows = [];
    // Fields removed from modal; keep legacy display only if data exists and a feature flag is set
    const showLegacyIssues = false; // set true if you want to show old issues/actions text
    if (showLegacyIssues && rec.issues) issuesRows.push(compRowHtml('Issues Found', rec.issues));
    if (showLegacyIssues && rec.actions) issuesRows.push(compRowHtml('Actions / Repairs', rec.actions));
    const issuesHtml = issuesRows.length ? `<div class='comp-group'>${issuesRows.join('')}</div>` : '';

    const actionItemsHtml = (rec.actionItems && rec.actionItems.length)
        ? `<div class='comp-group'>${rec.actionItems.map((a,i)=> {
                const title = a.title || '';
                const parts = [];
                if (a.assignee) parts.push(`Assignee: ${userNameFor(a.assignee)}`);
                if (a.due) parts.push(`Due: ${a.due}`);
                const remarks = parts.join('  ');
                return compRowHtml(`Action ${i+1}`, title, remarks || '-');
            }).join('')}</div>`
        : '';

    const issuesActionsGroupHtml = (issuesHtml || actionItemsHtml)
        ? `${issuesHtml}${issuesHtml && actionItemsHtml ? "<div style='margin-top:6px;'></div>" : ''}${actionItemsHtml}`
        : `<div class='comp-group'><div style='font-size:.65rem;color:#666;padding:6px 8px;'>No issues or actions recorded</div></div>`;

    // Backward compatibility: if old combined 'brakes' key exists in mechanicalCondition, map it to footBrakes if new keys absent
    if(rec.compliance && rec.compliance.mechanicalCondition){
        const mech = rec.compliance.mechanicalCondition;
        if(mech.brakes && !mech.footBrakes && !mech.handBrakes){
            mech.footBrakes = mech.brakes; // duplicate to foot
            mech.handBrakes = { requirement: mech.brakes.requirement||'Responsive and safe', status: mech.brakes.status||'OK', remarks: mech.brakes.remarks||'' };
        }
    }
    const fluidsGroupHtml = `<div class='comp-group'>${ rec.fluids && Object.keys(rec.fluids).length ?
        Object.entries(rec.fluids).map(([k,v])=> {
            if (v && typeof v === 'object' && ('value' in v || 'remarks' in v)) {
                return compRowHtml(humanizeFieldKey(k), fmtTextOrDash(v.value), fmtTextOrDash(v.remarks));
            } else {
                return compRowHtml(humanizeFieldKey(k), fmtTextOrDash(v));
            }
        }).join('') :
        `<div style='font-size:.65rem;color:#666;padding:6px 8px;'>No fluids data</div>`}
    </div>`;

    const tiresGroupHtml = `<div class='comp-group'>${ rec.tires && Object.keys(rec.tires).length ?
        Object.entries(rec.tires).map(([k,v])=> {
            if (v && typeof v === 'object' && ('value' in v || 'remarks' in v)) {
                return compRowHtml(humanizeFieldKey(k), fmtTextOrDash(v.value), fmtTextOrDash(v.remarks));
            } else {
                return compRowHtml(humanizeFieldKey(k), fmtTextOrDash(v));
            }
        }).join('') :
        `<div style='font-size:.65rem;color:#666;padding:6px 8px;'>No tire data</div>`}
    </div>`;

            // Build A4 paginated report (multi-page) with headers/footers
            // We'll split content into three logical pages for readability
            const headerHtml = `
                <div class='report-header'>
                    <div class='report-title-block'>
                        <div class='report-company'>${escapeHtml(companyName)}</div>
                        <div class='report-title'>Vehicle Inspection Report</div>
                    </div>
                    <div class='report-brand'>
                        ${logoUrl ? `<img class='company-logo' src='${escapeHtml(logoUrl)}' alt='${escapeHtml(companyName)} Logo' onerror="this.style.display='none'">`
                        : `<div class='company-logo-fallback' title='${escapeHtml(companyName)}'>${escapeHtml(companyInitials)}</div>`}
                    </div>
                </div>`;

            const pageFooter = (page, total) => `
                <div class='report-footer'>
                    <div>Generated: ${new Date().toLocaleString()}</div>
                    <div>Page ${page} / ${total}</div>
                </div>`;

            const page1Body = `
                ${headerHtml}
                <div class='section'>
                    <h6><i class='fas fa-info-circle'></i> Summary</h6>
                    ${summaryGroupHtml}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-oil-can'></i> Fluids</h6>
                    ${fluidsGroupHtml}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-truck'></i> Tires</h6>
                    ${tiresGroupHtml}
                </div>`;

            const page2Body = `
                ${headerHtml}
                <div class='section'>
                    <h6><i class='fas fa-tools'></i> Wheels & Tools</h6>
                    ${`<div class='comp-group'>${Object.entries(rec.wheels||{}).map(([k,v])=> {
                        if (v && typeof v === 'object' && ('value' in v || 'remarks' in v)) {
                            return compRowHtml(humanizeFieldKey(k), fmtTextOrDash(v.value), fmtTextOrDash(v.remarks));
                        } else {
                            return compRowHtml(humanizeFieldKey(k), fmtTextOrDash(v));
                        }
                    }).join('') || `<div style='font-size:.65rem;color:#666;padding:6px 8px;'>No wheels/tools data</div>`}</div>`}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-clipboard-check'></i> Compliance</h6>
                    ${renderComplianceGroup('documentation', compliance.documentation)}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-shield-alt'></i> Safety Equipment</h6>
                    ${renderComplianceGroup('safetyEquipment', compliance.safetyEquipment)}
                </div>`;

            const page3Body = `
                ${headerHtml}
                <div class='section'>
                    <h6><i class='fas fa-tools'></i> Mechanical Condition</h6>
                    ${renderComplianceGroup('mechanicalCondition', compliance.mechanicalCondition)}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-leaf'></i> Environmental & Cleanliness</h6>
                    ${renderComplianceGroup('environmental', compliance.environmental)}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-play-circle'></i> Operational Readiness</h6>
                    ${renderComplianceGroup('operational', compliance.operational)}
                </div>
                <div class='section'>
                    <h6><i class='fas fa-exclamation-triangle'></i> Issues & Actions</h6>
                    ${issuesActionsGroupHtml}
                </div>
                <div class='section attachments-print-hide'>
                    <h6><i class='fas fa-paperclip'></i> Attachments</h6>
                    ${attachmentsHtml}
                </div>`;

            const pageBodies = [page1Body, page2Body, page3Body];
            const totalPages = pageBodies.length;
            const pagesMarkup = pageBodies.map((body, idx) => `
                <div class='a4-report a4-page' data-page='${idx+1}' data-total='${totalPages}'>
                    <div class='page-body'>${body}</div>
                    ${pageFooter(idx+1, totalPages)}
                </div>
            `).join('');

            container.innerHTML = `
                <style>
                #inspectionDetailsContainer .section {border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:14px;background:#fff;}
                #inspectionDetailsContainer h6 {margin:0 0 8px 0;font-size:.8rem;font-weight:600;display:flex;align-items:center;gap:6px;}
                #inspectionDetailsContainer .grid-2 {display:grid;grid-template-columns:1fr;gap:8px;font-size:.7rem;}
                #inspectionDetailsContainer .value-box {background:#f8f9fa;padding:8px;border-radius:6px;border:1px solid #e2e8f0;}
                #inspectionDetailsContainer .comp-row {display:grid;grid-template-columns:200px 120px 1fr;gap:8px;padding:6px 8px;border-bottom:1px solid #eee;align-items:center;font-size:.65rem;}
                #inspectionDetailsContainer .comp-row:last-child {border-bottom:none;}
                /* Ensure dark text for compliance-related content on screen */
                #inspectionDetailsContainer .comp-group,
                #inspectionDetailsContainer .comp-group *,
                #inspectionDetailsContainer .comp-row,
                #inspectionDetailsContainer .comp-row * { color:#111; }
                #inspectionDetailsContainer .attach-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;}
                #inspectionDetailsContainer .attach-item {border:1px solid #e0e0e0;border-radius:6px;overflow:hidden;background:#fafafa;display:flex;flex-direction:column;}
                #inspectionDetailsContainer .attach-item img {width:100%;height:90px;object-fit:cover;}
                #inspectionDetailsContainer .attach-item .file-icon {height:90px;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;}
                #inspectionDetailsContainer .attach-meta {padding:6px;display:flex;flex-direction:column;gap:4px;}
                #inspectionDetailsContainer .attach-name {font-size:.6rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
                #inspectionDetailsContainer .attach-link {font-size:.6rem;color:#007bff;text-decoration:none;}
                #inspectionDetailsContainer .attach-link:hover {text-decoration:underline;}
                #inspectionDetailsContainer .section small {color:#555;}
                /* Inline key-value rows */
                #inspectionDetailsContainer .kv-row {display:flex;align-items:center;gap:8px;font-size:.72rem;}
                #inspectionDetailsContainer .kv-label {flex:0 0 180px;font-weight:600;color:#111;}
                #inspectionDetailsContainer .kv-value {flex:1;color:#111;}

                    /* Placeholder for Template print mode */
                    #inspectionDetailsContainer .template-empty { display:block; width:100%; min-height:14px; border-bottom:1px dotted #999; }

                    /* A4 Report layout */
                    #inspectionDetailsContainer .a4-report { width: 210mm; min-height: 297mm; margin: 0 auto; background: #ffffff; color:#000; padding: 12mm; box-shadow: 0 1mm 6mm rgba(0,0,0,0.15); }
                    #inspectionDetailsContainer .a4-page { width: 210mm; min-height: 297mm; margin: 0 auto 12px; background: #ffffff; color:#000; padding: 12mm; box-shadow: 0 1mm 6mm rgba(0,0,0,0.15); display:flex; flex-direction:column; }
                    #inspectionDetailsContainer .a4-page .page-body { flex:1; display:block; }
                    #inspectionDetailsContainer .report-header { display:flex; flex-direction:row; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; border-bottom:2px solid #e5e7eb; padding-bottom:8px; }
                    #inspectionDetailsContainer .report-title-block { display:flex; flex-direction:column; gap:2px; }
                    #inspectionDetailsContainer .report-company { font-size: 1.25rem; font-weight: 700; letter-spacing:.2px; color:#111; }
                    #inspectionDetailsContainer .report-title { font-size: 1rem; font-weight: 700; }
                    #inspectionDetailsContainer .report-brand { display:flex; align-items:center; justify-content:flex-end; }
                    #inspectionDetailsContainer .company-logo { height:44px; max-width:200px; object-fit:contain; display:block; }
                    #inspectionDetailsContainer .company-logo-fallback { height:44px; width:44px; border-radius:6px; background:#eef2f7; color:#111; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.9rem; border:1px solid #e2e8f0; }
                    #inspectionDetailsContainer .report-meta { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:6px; font-size:.7rem; align-items:start; }
                    @media (max-width: 900px) {
                        #inspectionDetailsContainer .report-meta { grid-template-columns: repeat(2, minmax(0, 1fr)); }
                    }
                    @media (max-width: 600px) {
                        #inspectionDetailsContainer .report-meta { grid-template-columns: 1fr; }
                    }
                    #inspectionDetailsContainer .report-meta .meta-box { background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:6px; }
                    #inspectionDetailsContainer .report-footer { margin-top:10px; font-size:.6rem; color:#555; display:flex; justify-content:space-between; }

                    /* Print styles - refined multi-page support, remove blanks & reduce empty spaces */
                    @media print { 
                        /* Tighter page margins to reduce outer whitespace */
                        @page { size: A4 portrait; margin: 6mm; }
                        html, body { margin:0 !important; padding:0 !important; }

                        /* Hide everything except the modal holding the report and the printable wrapper */
                        body * { visibility:hidden !important; }
                        body > *:not(#inspectionDetailsModal) { display:none !important; }
                        #inspectionDetailsModal, #inspectionDetailsModal * { visibility:visible !important; }
                        #inspectionDetailsModal .modal-header,
                        #inspectionDetailsModal .modal-footer { display:none !important; }
                        .printable, .printable * { visibility:visible !important; }

                        /* Neutralize modal constraints so full height content prints */
                        .modal, .modal-content, .modal-body { 
                            position:static !important; 
                            inset:auto !important; 
                            width:auto !important; 
                            max-width:none !important; 
                            height:auto !important; 
                            max-height:none !important; 
                            overflow:visible !important; 
                            box-shadow:none !important; 
                            background:transparent !important; 
                        }

                        .printable { 
                            position:static !important; 
                            margin:0 !important; 
                            padding:0 !important; 
                            box-shadow:none !important; 
                            border:none !important; 
                            width:100% !important; 
                        }
                        #inspectionDetailsContainer { 
                            position:static !important; 
                            padding:0 !important; 
                            margin:0 !important; 
                            width:100% !important; 
                        }
                        /* Page blocks */
                        #inspectionDetailsContainer .a4-page { 
                            width:210mm !important; 
                            min-height:297mm !important; 
                            margin:0 auto 2mm auto !important; /* minimal gap between pages */
                            padding:6mm !important; /* tighter inner padding */
                            border:none !important; 
                            box-shadow:none !important; 
                            display:block !important; 
                            page-break-after:always !important; 
                            page-break-inside:avoid !important;
                            overflow:visible !important;
                        }
                        /* Prevent extra blank sheet after scaling */
                        #inspectionDetailsContainer .a4-page:last-child { 
                            page-break-after:auto !important; 
                            margin-bottom:0 !important; 
                        }
                        /* Ensure inner sections don't fragment */
                        #inspectionDetailsContainer .page-body,
                        #inspectionDetailsContainer .section,
                        #inspectionDetailsContainer .comp-row,
                        #inspectionDetailsContainer .attach-item { 
                            page-break-inside:avoid !important; 
                            break-inside:avoid !important; 
                        }
                        #inspectionDetailsContainer .section { 
                            border:1px solid #ddd !important; 
                            margin-bottom:4px !important; /* tighter vertical rhythm */
                            padding:8px !important; /* reduce inner spacing within sections */
                            background:#fff !important; 
                        }
                        #inspectionDetailsContainer h6 { margin:0 0 4px 0 !important; }
                        #inspectionDetailsContainer .report-header { margin-bottom:6px !important; border-bottom:1px solid #e5e7eb !important; }
                        #inspectionDetailsContainer .report-footer { margin-top:4px !important; }
                        /* Explicit page break before pages after first (helps some browsers) */
                        #inspectionDetailsContainer .a4-page:not(:first-child) { 
                            page-break-before:always !important; 
                        }
                        /* Avoid accidental blank due to scale pushing height */
                        /* Ensure overflow visible without scaling to prevent clipped or missing pages */
                        #inspectionDetailsContainer .a4-page { overflow:visible !important; }
                        /* Force text color for print clarity */
                        #inspectionDetailsContainer h6,
                        #inspectionDetailsContainer .report-header,
                        #inspectionDetailsContainer .report-title,
                        #inspectionDetailsContainer .report-company,
                        #inspectionDetailsContainer .report-footer { color:#000 !important; }
                        /* Force dark text inside all compliance-related sections in print */
                        #inspectionDetailsContainer .comp-group,
                        #inspectionDetailsContainer .comp-group *,
                        #inspectionDetailsContainer .comp-row,
                        #inspectionDetailsContainer .comp-row * { color:#000 !important; }
                        /* Hide attachments section in print */
                        #inspectionDetailsContainer .attachments-print-hide { display:none !important; }
                    }
            </style>
                <div class='printable'>
                ${pagesMarkup}
                </div>
        `;
        modal.classList.add('show');
        trapFocus(modal);
}

// =============================
// Vehicle Inspection Filtering Helpers
// =============================
window.activeInspectionVehicleFilter = null; // { vehicleId, vehicleName }

function showVehicleInspections(vehicleId){
    try {
        // Try to derive vehicle name from table row
        const row = document.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
        let vehicleName = ''; 
        if(row){
            const info = row.getAttribute('data-vehicle-info');
            if(info){
                try { const parsed = JSON.parse(info); vehicleName = parsed.vehicleName || parsed.name || parsed.plateNumber || vehicleId; } catch(e){}
            }
            if(!vehicleName){
                const nameCell = row.querySelector('.vehicle-name-cell');
                if(nameCell){ vehicleName = nameCell.textContent.trim(); }
            }
        }
        if(!vehicleName) vehicleName = vehicleId;
        window.activeInspectionVehicleFilter = { vehicleId, vehicleName };
        // Switch to maintenance tab (this will trigger loadInspections)
        switchToTab('maintenance');
        // Ensure inspections refreshed (avoid delay stale data)
        loadInspections(true);
        updateInspectionFilterUI();
    } catch(err){ console.warn('Failed to set inspection filter', err); }
}

function clearVehicleInspectionFilter(){
    window.activeInspectionVehicleFilter = null;
    loadInspections(false); // re-render with original data
    updateInspectionFilterUI();
}

function updateInspectionFilterUI(){
    const bar = document.getElementById('inspectionFilterBar');
    const textEl = document.getElementById('activeInspectionFilterText');
    const clearBtn = document.getElementById('clearInspectionFilterBtn');
    const tabAllBtn = document.getElementById('inspAllTabBtn');
    const tabVehBtn = document.getElementById('inspVehicleTabBtn');
    const tabVehText = document.getElementById('inspVehicleTabText');
    if(!bar || !textEl || !clearBtn) return;
    // Prefer the sub-tabs visual instead of chip; keep chip hidden
    bar.style.display = 'none';
    textEl.textContent = '';
    clearBtn.onclick = null;

    // Manage sub-tabs state
    if (tabAllBtn && tabVehBtn && tabVehText) {
        const hasFilter = !!(window.activeInspectionVehicleFilter && window.activeInspectionVehicleFilter.vehicleId);
        if (hasFilter) {
            tabVehText.textContent = window.activeInspectionVehicleFilter.vehicleName?.length > 26
                ? (window.activeInspectionVehicleFilter.vehicleName.slice(0, 24) + '')
                : (window.activeInspectionVehicleFilter.vehicleName || 'Vehicle');
            tabVehBtn.style.display = '';
            tabVehBtn.classList.add('active');
            tabAllBtn.classList.remove('active');
        } else {
            tabVehBtn.style.display = 'none';
            tabVehBtn.classList.remove('active');
            tabAllBtn.classList.add('active');
        }
    }
}

// Sub-tab switching helpers
function showAllInspectionsTab(){
    clearVehicleInspectionFilter();
}
function showVehicleInspectionsTab(){
    // Already filtered; just ensure UI reflects it
    updateInspectionFilterUI();
}

// Back to Vehicles navigation from Maintenance
function backToVehicles(){
    try { clearVehicleInspectionFilter(); } catch (e) { /* ignore */ }
    switchToTab('vehicles');
}

async function deleteVehicleInspection(id){
    if(!(window.__fleet_action_perms?.isAdmin || window.__fleet_action_perms?.canDeleteInspection)){
        window.notificationManager?.addNotification?.({type:'warning', message:'You do not have permission to delete inspections'});
        return;
    }
    if(!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId){ showToast('Not authenticated','error'); return; }
    if(!confirm('Delete this inspection record?')) return;
    const companyId = window.authManager.currentUser.companyId;
    try {
        await firebase.database().ref(`companies/${companyId}/vehicleInspections/${id}`).remove();
        inspectionsData = inspectionsData.filter(r=>r.id!==id);
        renderInspectionsTable();
        showToast('Inspection deleted','success');
    } catch(err){ console.error(err); showToast('Delete failed','error'); }
}

// Utility for escaping HTML (if not present already)
function escapeHtml(str){
    if(str==null) return '';
    return String(str).replace(/[&<>"]/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
}

// =============================
// Full Inspection Modal & Logic (from Vehicle Details)
// =============================
function openFullInspectionModal(){
    if(!currentVehicleId){ showToast('No vehicle selected','warning'); return; }
    let modal = document.getElementById('fullVehicleInspectionModal');
    if(!modal){ modal = createFullInspectionModal(); }
    populateFullInspectionVehicle(currentVehicleData, currentVehicleId);
    modal.classList.add('show');
    const first = modal.querySelector('input,select,textarea');
    if(first) first.focus();
    trapFocus(modal);
}

function createFullInspectionModal(){
    const modal = document.createElement('div');
    modal.id = 'fullVehicleInspectionModal';
    modal.className='modal';
    modal.innerHTML = `
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="fullInspectionTitle">
            <div class="modal-header">
                <h5 id="fullInspectionTitle"><i class="fas fa-clipboard-check"></i> Vehicle Full Inspection</h5>
                <button class="close-btn" type="button" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow:auto;">
                <form id="fullInspectionForm">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px;margin-bottom:12px;">
                        <div><label>Date</label><input type="date" name="date" required></div>
                        <div><label>Reference Number</label><input type="text" name="referenceNumber" readonly title="Auto-generated"></div>
                        <div><label>Vehicle Name</label><input type="text" name="vehicleName" readonly></div>
                        <div><label>Plate</label><input type="text" name="vehiclePlate" readonly></div>
                        <div><label>Odometer (km)</label><input type="number" name="odometer" min="0" step="1" placeholder="e.g. 15230"></div>
                        <div><label>Overall Status</label>
                            <select name="status" required>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                                <option value="Needs Attention">Needs Attention</option>
                            </select>
                        </div>
                        <div><label>Next Inspection Date</label><input type="date" name="nextInspection"></div>
                    </div>
                    <fieldset style="border:1px solid #e0e0e0;border-radius:6px;padding:10px 12px;margin-bottom:14px;">
                        <legend style="font-size:.7rem;font-weight:600;padding:0 6px;">Fluids</legend>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;">
                            ${['engineOil','coolant','brakeFluid'].map(f=>`<label style='display:flex;flex-direction:column;font-size:.7rem;'>${f.replace(/([A-Z])/g,' $1')}
                                <select name='${f}'><option value='OK'>OK</option><option value='Low'>Low</option><option value='Leak'>Leak</option></select></label>`).join('')}
                        </div>
                    </fieldset>
                    <fieldset style="border:1px solid #e0e0e0;border-radius:6px;padding:10px 12px;margin-bottom:14px;">
                        <legend style="font-size:.7rem;font-weight:600;padding:0 6px;">Tires Condition</legend>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;">
                            ${['LF','RF','LR','RR'].map(t=>`<label style='display:flex;flex-direction:column;font-size:.7rem;'>${t} Tire
                                <select name='tire_${t}'><option value='OK'>OK</option><option value='Worn'>Worn</option><option value='Damaged'>Damaged</option></select></label>`).join('')}
                        </div>
                    </fieldset>
                    <fieldset style="border:1px solid #e0e0e0;border-radius:6px;padding:10px 12px;margin-bottom:14px;">
                        <legend style="font-size:.7rem;font-weight:600;padding:0 6px;">Functional Checks</legend>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;">
                            ${['Brakes','Lights','Battery','Horn','Extinguisher','FirstAidKit'].map(it=>`<label style='display:flex;gap:6px;align-items:center;font-size:.7rem;'><input type='checkbox' name='func_${it}' value='1'> ${it}</label>`).join('')}
                        </div>
                    </fieldset>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;">
                        <div><label>Defects Found</label><textarea name="defects" rows="3" placeholder="List defects..." style="width:100%;resize:vertical;"></textarea></div>
                        <div><label>Corrective Actions</label><textarea name="actions" rows="3" placeholder="Planned actions..." style="width:100%;resize:vertical;"></textarea></div>
                    </div>
                    <input type="hidden" name="vehicleId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="cancel">Cancel</button>
                <button type="submit" form="fullInspectionForm" class="btn btn-success"><i class="fas fa-save"></i> Save Report</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    modal.querySelector('.close-btn').addEventListener('click', ()=>closeFullInspectionModal());
    modal.querySelector('[data-action="cancel"]').addEventListener('click', ()=>closeFullInspectionModal());
    modal.querySelector('#fullInspectionForm').addEventListener('submit', e=>{ e.preventDefault(); saveFullInspection(); });
    return modal;
}

function closeFullInspectionModal(){
    const m = document.getElementById('fullVehicleInspectionModal');
    if(m) m.classList.remove('show');
}

function populateFullInspectionVehicle(vehicleData, vehicleId){
    const form = document.getElementById('fullInspectionForm');
    if(!form) return;
    const today = new Date().toISOString().slice(0,10);
    form.date.value = today;
    // Generate reference number once when opening
    try {
        const genRef = (()=>{
            const dt = new Date();
            const y = dt.getFullYear();
            const m = String(dt.getMonth()+1).padStart(2,'0');
            const d = String(dt.getDate()).padStart(2,'0');
            const ymd = `${y}${m}${d}`;
            const tail = (vehicleId||'').toString().slice(-4).toUpperCase().replace(/[^A-Z0-9]/g,'');
            const rand = Math.random().toString(36).slice(2,6).toUpperCase();
            return `INSP-${ymd}${tail? '-' + tail : ''}`; // removed random suffix per request
        })();
        if (form.referenceNumber && !form.referenceNumber.value) {
            form.referenceNumber.value = genRef;
        }
    } catch(e) { /* ignore generation errors */ }
    form.vehicleId.value = vehicleId || '';
    form.vehicleName.value = vehicleData?.name || vehicleData?.vehicleName || 'Vehicle';
    form.vehiclePlate.value = vehicleData?.plateNumber || vehicleData?.plate || 'N/A';
}

async function saveFullInspection(){
    if(!window.authManager?.currentUser?.companyId){ showToast('Not authenticated','error'); return; }
    const companyId = window.authManager.currentUser.companyId;
    const form = document.getElementById('fullInspectionForm');
    if(!form) return;
    const vehicleId = form.vehicleId.value.trim();
    const date = form.date.value.trim();
    const status = form.status.value;
    if(!vehicleId || !date){ showToast('Date & vehicle required','warning'); return; }
    // Build record
    const functionalItems = ['Brakes','Lights','Battery','Horn','Extinguisher','FirstAidKit'];
    const funcResults = functionalItems.reduce((acc,it)=>{ acc[it]= !!form[`func_${it}`]?.checked; return acc; },{});
    const passCount = Object.values(funcResults).filter(Boolean).length;
    const totalCount = functionalItems.length;
    const record = {
        reportType: 'full',
        referenceNumber: form.referenceNumber?.value || '',
        vehicleId,
        vehiclePlate: form.vehiclePlate.value || '',
        vehicleName: form.vehicleName.value || '',
        date,
        odometer: form.odometer.value? parseInt(form.odometer.value,10): null,
        status,
        nextInspection: form.nextInspection.value || '',
        fluids: { engineOil: form.engineOil.value, coolant: form.coolant.value, brakeFluid: form.brakeFluid.value },
        tires: { LF: form.tire_LF.value, RF: form.tire_RF.value, LR: form.tire_LR.value, RR: form.tire_RR.value },
        functional: funcResults,
        defects: form.defects.value.trim(),
        correctiveActions: form.actions.value.trim(),
        checklistPass: passCount,
        checklistTotal: totalCount,
        createdAt: new Date().toISOString(),
        inspector: window.authManager.currentUser.uid || window.authManager.currentUser.email || 'unknown'
    };
    try {
        const ref = firebase.database().ref(`companies/${companyId}/vehicleInspections`).push();
        await ref.set(record);
        showToast('Full inspection saved','success');
        closeFullInspectionModal();
        loadInspections(true);
    } catch(err){ console.error(err); showToast('Save failed','error'); }
}

// Toast notification function (if not already defined)
function showToast(message, type = 'info') {
    // Create toast element if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(toast);
    }
    
    // Set style based on type
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    toast.style.backgroundColor = colors[type] || colors.info;
    toast.textContent = message;
    toast.style.opacity = '1';
    
    // Hide after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
    }, 3000);
}
</script>
</body>
</html>
