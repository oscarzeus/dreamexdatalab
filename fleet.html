<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management - Dreamex Datalab HSE</title>
    <!-- Firebase v8 (same as staff.html) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="js/emailjs-service.js"></script>
    <!-- SheetJS for Excel file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Icons / Fonts / (Font Awesome already imported via @import in staff) -->
    <style>
        /* --- COPIED CORE STYLE BLOCKS FROM staff.html (trimmed to essentials but class names kept identical) --- */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
        :root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --purple:#9b59b6; --orange:#e67e22; --red:#e74c3c; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333333; --text-secondary:#666666; --border-color:#e0e0e0; --spacing-unit:1rem; --padding-sm:.5rem; --padding-md:1rem; --padding-lg:1.5rem; --transition-speed:.2s; }
        [data-theme="dark"] { --bg-primary:#1a1a1a; --bg-secondary:#2d2d2d; --text-primary:#ffffff; --text-secondary:#cccccc; --border-color:#404040; }
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:var(--font-family); font-size:var(--base-font-size); line-height:calc(1.5 * var(--font-scale)); color:var(--text-primary); background:#f8f9fa;}
        .app-container {display:flex; min-height:100vh;}
        .sidebar {width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; height:100vh; overflow-y:auto; z-index:1000; transition:transform .3s ease;}
        .sidebar.collapsed {transform:translateX(-100%);} 
        .main-content {flex:1; margin-left:var(--sidebar-width); padding:.5rem; padding-top:4rem; width:calc(100% - var(--sidebar-width));}
    /* Smoothly adjust layout when collapsing the sidebar */
    .main-content { transition: margin-left .3s ease, width .3s ease; }
    .main-content.sidebar-collapsed { margin-left: 0; width: 100%; }
        .top-nav {display:flex; justify-content:space-between; align-items:center; padding:.5rem .75rem; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); margin-bottom:.3rem; position:fixed; top:.25rem; right:.5rem; left:calc(var(--sidebar-width) + .5rem); height:50px; min-height:50px; z-index:100; transition:left .3s ease;}
    .top-nav.sidebar-collapsed { left: .5rem; }
        .top-nav-left {display:flex; align-items:center; gap:1rem;}
        .sidebar-toggle-btn {background:none; border:none; cursor:pointer; font-size:1.2rem; padding:.5rem; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);} 
        .menu {list-style:none; margin-top:2rem;}
        .menu li {margin-bottom:.5rem;}
        .menu a {color:#fff; text-decoration:none; display:flex; align-items:center; padding:.75rem 1rem; border-radius:5px; transition:background-color .3s;}
        .menu a i {margin-right:10px;}
        .menu a:hover, .menu a.active {background:var(--secondary-color);} 
        .menu-dropdown .submenu {display:none; list-style:none; margin-left:2rem; margin-top:.5rem;}
        .menu-dropdown:hover .submenu {display:block;}
        .content {width:100%; margin:0; padding:.75rem; background:#fff; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.08);} 
        table {width:100%; border-collapse:collapse; margin-top:.75rem; font-size: 0.7rem;} 
        th,td {padding:.4rem; text-align:left; border-bottom:1px solid #e9ecef; font-size:.7rem;} 
        th {background:#f8f9fa; font-weight:600; color:#495057; border-bottom: 2px solid #e9ecef; white-space: nowrap; transition: background-color 0.3s ease, color 0.3s ease; position: sticky; top: 0; z-index: 10; border-radius: 0 !important;}
        
        /* Dynamic table header colors based on active tab */
        .tab-content.active .staff-table th {
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Vehicles tab - Blue headers */
        #vehiclesTabContent.active .staff-table th {
            background: #007bff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Analytics tab - Purple headers */
        #analyticsTabContent.active .staff-table th {
            background: #6f42c1;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Tab Content Display Control */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Analytics Tab Content Height Optimization */
        #analyticsTabContent {
            height: calc(100vh - 140px); /* Full height minus header and padding */
            flex-direction: column;
            overflow: hidden;
        }
        
        #analyticsTabContent.active {
            height: calc(100vh - 140px);
            display: flex;
        }
        
        .staff-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .staff-table td {
            padding: 0.4rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            color: #495057;
            font-size: 0.7rem;
        }

        .staff-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .staff-table tbody tr {
            transition: all 0.2s ease;
        } 
        /* Hide Tank Capacity column (updated for new Name column) */
        #vehicleTable th:nth-child(11), #vehicleTable td:nth-child(11) { display: none; }
        
        /* Table wrapper with horizontal scroll */
        .table-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px); /* Limit table height for vertical scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        
        /* Ensure table takes full width of container */
        .staff-table {
            min-width: 100%;
            white-space: nowrap;
        }
        
        /* Sticky table header */
        .staff-table thead th {
            position: sticky;
            top: 0;
            background: #007bff;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Make table cells not wrap text */
        .staff-table th,
        .staff-table td {
            white-space: nowrap;
            padding: 8px 12px;
        }
        
        /* Scrollbar styling for webkit browsers */
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        } 
        /* Enhanced Modal Styles (exact copy from staff.html) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            top: 0;
            z-index: 2;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.03);
        }
        .modal-header h5 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-header h5::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: #3b82f6;
            border-radius: 2px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 1.25rem 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
            scrollbar-width: thin;
            scrollbar-color: #ddd transparent;
            position: relative;
        }
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background-color: #ddd;
            border-radius: 3px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background-color: #bbb;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }
        /* Form Layout Optimization */
        .form-row {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        .form-row-3 {
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
        }
        .form-row-3 .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        .form-row-4 {
            display: flex;
            gap: 0.6rem;
            align-items: flex-start;
        }
        .form-row-4 .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        .form-row-5 {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }
        .form-row-5 .form-group {
            flex: 1;
            margin-bottom: 0.9rem;
        }
        @media (max-width: 1024px) {
            .form-row-3 {
                flex-wrap: wrap;
            }
            .form-row-3 .form-group {
                flex: 1 1 calc(50% - 0.4rem);
            }
            .form-row-4 {
                flex-wrap: wrap;
            }
            .form-row-4 .form-group {
                flex: 1 1 calc(50% - 0.3rem);
            }
            .form-row-5 {
                flex-wrap: wrap;
            }
            .form-row-5 .form-group {
                flex: 1 1 calc(50% - 0.25rem);
            }
        }
        @media (max-width: 768px) {
            .form-row, .form-row-3, .form-row-4, .form-row-5 {
                flex-direction: column;
                gap: 0;
            }
            .form-row-3 .form-group, .form-row-4 .form-group, .form-row-5 .form-group {
                flex: 1 1 100%;
            }
        } 
        .form-group {margin-bottom:.9rem;} 
        .form-group label {display:block; margin-bottom:.45rem; font-weight:600; font-size:.65rem; text-transform:uppercase; letter-spacing:.5px;} 
        .form-group input, .form-group select, .form-group textarea {width:100%; padding:.55rem .6rem; border:1px solid #ddd; border-radius:6px; font-size:.75rem; font-family: inherit;} 
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline:none; border-color:var(--secondary-color); box-shadow:0 0 0 2px rgba(52,152,219,.2);} 
        .form-group textarea {resize: vertical; min-height: 70px;} 
        .btn {padding:.45rem .85rem; border:none; border-radius:6px; cursor:pointer; font-size:.7rem; font-weight:600; transition:.2s;} 
        .btn-primary {background:var(--primary-color); color:#fff;} 
        .btn-secondary {background:var(--secondary-color); color:#fff;} 
        .btn-danger {background:var(--red); color:#fff;} 
        .btn:hover {opacity:.9; transform:translateY(-1px);} 
        
        /* Import Controls Styles */
        .import-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-link {
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .btn-link:hover {
            background-color: rgba(52, 152, 219, 0.1);
            text-decoration: none;
        }
        
        .import-progress {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .import-results {
            margin-top: 1rem;
        }
        
        .import-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        
        .import-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }
        
        .import-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        } 
        .fab {position:fixed; right:1.5rem; bottom:1.5rem; width:40px; height:40px; border-radius:50%; background:var(--secondary-color); color:#fff; font-size:1.2rem; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,.25);} 
        .error {color:#e74c3c; font-size:.6rem; margin-top:.25rem; display:none;} 
        .invalid {border-color:#e74c3c !important;} 
        
        /* Vehicle Details Modal Styles */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 0.5rem 0;
        }
        .detail-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }
        .detail-section.full-width {
            grid-column: 1 / -1;
        }
        .detail-section h4 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.4rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75rem;
            flex: 0 0 40%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-value {
            color: #212529;
            text-align: right;
            flex: 1;
            font-size: 0.8rem;
            word-wrap: break-word;
        }
        .detail-value.status-active {
            color: #28a745;
            font-weight: 600;
        }
        .detail-value.status-inactive {
            color: #dc3545;
            font-weight: 600;
        }
        .detail-value.status-maintenance {
            color: #ffc107;
            font-weight: 600;
        }
        .detail-notes {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.8rem;
            line-height: 1.4;
            color: #495057;
            white-space: pre-wrap;
        }
        
        /* Attachment Styles */
        .attachment-info {
            width: 100%;
        }
        .attachment-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .attachment-name {
            flex: 1;
            color: #495057;
            font-weight: 500;
        }
        .attachment-actions {
            display: flex;
            gap: 0.25rem;
        }
        .btn-link {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .btn-link:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-1px);
        }
        .no-attachment {
            color: #6c757d;
            font-style: italic;
            font-size: 0.75rem;
        }
        
        /* Image Viewer Modal Styles */
        .image-viewer-modal {
            z-index: 1060;
        }
        .image-viewer-content {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
        }
        .image-viewer-body {
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 70vh;
            overflow: hidden;
        }
        .viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        
        /* Action Buttons Styles */
        .actions-cell {
            text-align: center;
            padding: 0.5rem;
            white-space: nowrap;
        }
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
            align-items: center;
        }
        .btn-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-edit {
            color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        .btn-edit:hover {
            background: #007bff;
            color: white;
        }
        .btn-view {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .btn-view:hover {
            background: #28a745;
            color: white;
        }
        .btn-delete {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        .btn-delete:hover {
            background: #dc3545;
            color: white;
        }
        
        /* Delete Confirmation Modal Styles */
        .confirmation-modal {
            z-index: 1070;
        }
        .delete-confirmation-content {
            text-align: center;
        }
        .vehicle-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
        }
        .vehicle-info h6 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 0.9rem;
        }
        .vehicle-details {
            font-size: 1rem;
            color: #212529;
        }
        .vehicle-details strong {
            color: #dc3545;
        }
        .vehicle-details small {
            color: #6c757d;
            display: block;
            margin-top: 0.25rem;
        }
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 0.75rem;
            color: #856404;
            font-size: 0.9rem;
        }
        .warning-message i {
            color: #f39c12;
            margin-right: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .detail-row {
                flex-direction: column;
                gap: 0.25rem;
            }
            .detail-label {
                flex: none;
            }
            .detail-value {
                text-align: left;
            }
        }
        
        /* Header Company Logo Styles */
        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }
        .header-company-logo.visible {
            display: block;
        }
        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }
        /* Page Header Styles */
        .staff-management-content {
            padding: 0.5rem 0;
            width: 100%;
            margin: 0;
            max-width: none;
        }
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.5rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 0.5rem;
            margin: 0 0 0.5rem 0;
            transition: box-shadow 0.3s ease;
        }
        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }
        .page-title {
            font-size: 0.9rem;
            color: white;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            flex: 1;
            text-align: center;
        }
        .page-title i {
            font-size: 0.9rem;
        }
        .header-top-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0;
            min-height: 1.5rem;
        }
        .header-left {
            flex: 1;
            display: flex;
            justify-content: center;
        }
        .header-right {
            position: absolute;
            right: 0;
        }
        /* Notification & Profile Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }
        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }
        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .notification-dropdown.show {
            display: block;
        }
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }
        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }
        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }
        .profile-dropdown.show {
            display: block;
        }
        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-dropdown ul li {
            padding: 0;
        }
        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }
        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }
        /* Permission visibility */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }
        
        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }
        
        /* Hide ALL menu items by default during loading */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature] {
            display: none !important;
        }
        
        .menu-loading [data-feature] {
            display: none !important;
        }
        
        .menu-loading .menu-dropdown {
            display: none !important;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin: 0 0 1rem 0;
            background: white;
            padding: 0.5rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            flex: 1;
            justify-content: center;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .tab-nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* Active Tab Button Colors matching fleet theme */
        #vehiclesTabBtn.active {
            background: #007bff;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }
        #analyticsTabBtn.active {
            background: #6f42c1;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.4);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Analytics Styles */
        .controls-section {
            background: #f8f9fa;
            padding: 0.75rem; /* Reduced padding */
            border-radius: 6px;
            margin-bottom: 0.75rem; /* Reduced margin */
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Reduced minimum width */
            gap: 0.75rem; /* Reduced gap */
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
        }
        
        .chart-actions .actions-wrapper {
            display: flex;
            justify-content: flex-end;
        }
        
        .view-toggles {
            display: flex;
            gap: 1rem;
        }
        
        .view-toggles i:hover {
            color: var(--primary-color) !important;
        }
        
        .visualization-container {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            height: calc(100vh - 200px); /* Fit to screen height */
            display: flex;
            flex-direction: column;
        }
        
        .chart-container {
            height: calc(40vh - 80px); /* Reduced chart height */
            margin-bottom: 1rem;
            position: relative;
            flex: 1;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: auto; /* Push to bottom */
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem; /* Reduced padding */
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Reduced gap */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 60px; /* Set minimum height */
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 40px; /* Reduced size */
            height: 40px; /* Reduced size */
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem; /* Reduced font size */
        }
        
        .stat-details h3 {
            margin: 0;
            font-size: 1.5rem; /* Reduced font size */
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-details p {
            margin: 0;
            color: #6c757d;
            font-size: 0.75rem; /* Reduced font size */
            font-weight: 500;
        }
        @media (max-width:768px){ .sidebar{width:100%; height:auto; position:relative;} .main-content{margin-left:0; width:100%; padding-top:1rem;} .top-nav{position:relative; left:0; right:0; top:0; margin-bottom:1rem;} .sidebar.collapsed{display:none;} .header-company-logo{width:32px;height:32px;} .company-name-header{font-size:1rem;} }
        /* --- Added: Select2 CSS (from staff.html) --- */
        .select2-container{box-sizing:border-box;display:inline-block;margin:0;position:relative;vertical-align:middle}.select2-container .select2-selection--single{box-sizing:border-box;cursor:pointer;display:block;height:28px;user-select:none;-webkit-user-select:none}.select2-container .select2-selection--single .select2-selection__rendered{color:#444;line-height:28px;padding-left:8px;padding-right:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.select2-container .select2-selection--single .select2-selection__clear{cursor:pointer;float:right;font-weight:bold}.select2-container .select2-selection--single .select2-selection__placeholder{color:#999}.select2-container .select2-selection--single .select2-selection__arrow{height:26px;position:absolute;top:1px;right:1px;width:20px}.select2-container .select2-selection--single .select2-selection__arrow b{border-color:#888 transparent transparent transparent;border-style:solid;border-width:5px 4px 0 4px;height:0;left:50%;margin-left:-4px;margin-top:-2px;position:absolute;top:50%;width:0}.select2-container[dir="rtl"] .select2-selection--single .select2-selection__clear{float:left}.select2-container[dir="rtl"] .select2-selection--single .select2-selection__rendered{padding-left:20px;padding-right:8px}.select2-container .select2-selection--multiple{box-sizing:border-box;cursor:pointer;display:block;min-height:32px;user-select:none;-webkit-user-select:none}.select2-container .select2-selection--multiple .select2-selection__rendered{color:#444;cursor:text;overflow:hidden;padding-left:8px;text-overflow:ellipsis;white-space:nowrap}.select2-container .select2-selection--multiple .select2-selection__rendered li{list-style:none}.select2-container .select2-selection--multiple .select2-selection__clear{cursor:pointer;float:right;font-weight:bold;margin-top:5px;margin-right:10px}.select2-container .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;cursor:default;float:left;margin-right:5px;margin-top:5px;padding:0 5px}.select2-container .select2-selection--multiple .select2-selection__choice__remove{color:#999;cursor:pointer;display:inline-block;font-weight:bold;margin-right:2px}.select2-container .select2-selection--multiple .select2-selection__choice__remove:hover{color:#333}.select2-container .select2-search--inline{float:left}.select2-container .select2-search--inline .select2-search__field{box-sizing:border-box;border:none;font-size:100%;margin-top:5px;padding:0}.select2-container .select2-search--inline .select2-search__field::-webkit-search-cancel-button{-webkit-appearance:none}.select2-dropdown{background-color:#fff;border:1px solid #aaa;border-radius:4px;box-sizing:border-box;display:block;position:absolute;left:-100000px;width:100%;z-index:1051}.select2-results{display:block}.select2-results__options{list-style:none;margin:0;padding:0}.select2-results__option{padding:6px;user-select:none;-webkit-user-select:none}.select2-results__option[aria-selected]{cursor:pointer}.select2-results__option[aria-selected=true]{background-color:#5897fb;color:#fff}.select2-results__option[aria-selected=false]:hover{background-color:#f5f5f5}.select2-results__option--highlighted[aria-selected]{background-color:#5897fb;color:#fff}.select2-results__option--highlighted[aria-selected=false]{background-color:#5897fb;color:#fff}.select2-results__group{cursor:default;display:block;padding:6px}.select2-container--default .select2-selection--single{background-color:#fff;border:1px solid #aaa;border-radius:4px}.select2-container--default .select2-selection--single .select2-selection__rendered{color:#444;line-height:28px}.select2-container--default .select2-selection--single .select2-selection__clear{cursor:pointer;float:right;font-weight:bold}.select2-container--default .select2-selection--single .select2-selection__placeholder{color:#999}.select2-container--default .select2-selection--single .select2-selection__arrow{height:26px;position:absolute;top:1px;right:1px;width:20px}.select2-container--default .select2-selection--single .select2-selection__arrow b{border-color:#888 transparent transparent transparent;border-style:solid;border-width:5px 4px 0 4px;height:0;left:50%;margin-left:-4px;margin-top:-2px;position:absolute;top:50%;width:0}.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__clear{float:left}.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__rendered{padding-left:20px;padding-right:8px}.select2-container--default .select2-selection--multiple{background-color:#fff;border:1px solid #aaa;border-radius:4px;cursor:text}.select2-container--default .select2-selection--multiple .select2-selection__rendered{box-sizing:border-box;list-style:none;margin:0;padding:0 5px;width:100%}.select2-container--default .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;cursor:default;float:left;margin-right:5px;margin-top:5px;padding:0 5px}.select2-container--default .select2-selection--multiple .select2-selection__choice__remove{color:#999;cursor:pointer;display:inline-block;font-weight:bold;margin-right:2px}.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover{color:#333}.select2-container--default.select2-container--focus .select2-selection--multiple{border:solid black 1px;outline:0}.select2-container--default.select2-container--disabled .select2-selection--multiple,.select2-container--default.select2-container--disabled .select2-selection--single{background-color:#eee;cursor:default}.select2-container--default.select2-container--disabled .select2-selection__clear{display:none}.select2-container--default.select2-container--disabled .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;color:#999}.select2-container--default.select2-container--disabled .select2-selection--multiple .select2-selection__choice__remove{display:none}.select2-container--default.select2-container--open.select2-container--above .select2-selection--single,.select2-container--default.select2-container--open.select2-container--above .select2-selection--multiple{border-top-left-radius:0;border-top-right-radius:0}.select2-container--default.select2-container--open.select2-container--below .select2-selection--single,.select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple{border-bottom-left-radius:0;border-bottom-right-radius:0}.select2-container--default .select2-search--dropdown .select2-search__field{border:1px solid #aaa}.select2-container--default .select2-results>.select2-results__options{max-height:200px;overflow-y:auto}.select2-container--default .select2-results__option[role=group]{padding:0}.select2-container--default .select2-results__option[aria-disabled=true]{color:#999}.select2-container--default .select2-results__option[aria-selected=true]{background-color:#5897fb}.select2-container--default .select2-results__option .select2-results__option{padding-left:1em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option{margin-left:-1em;padding-left:2em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-2em;padding-left:3em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-3em;padding-left:4em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-4em;padding-left:5em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-5em;padding-left:6em}.select2-container--default .select2-results__option--highlighted[aria-selected]{background-color:#5897fb;color:#fff}.select2-container--default .select2-results__group{cursor:default;display:block;padding:6px}
        /* --- Added: Enhanced Modal Styles (from staff.html) --- */
        .modal.show .modal-content {animation:modalSlide .25s ease-out;} @keyframes modalSlide{from{transform:translateY(15px);opacity:0;}to{transform:translateY(0);opacity:1;}}
        /* --- Added: Top Nav Right Styling --- */
        .top-nav-right { display: flex; align-items: center; gap: 1.5rem; }
        /* Notification System */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }
        .notification-success { border-left: 4px solid #28a745; }
        .notification-error { border-left: 4px solid #dc3545; }
        .notification-warning { border-left: 4px solid #ffc107; }
        .notification-info { border-left: 4px solid #17a2b8; }
        .notification-content {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #000000;
        }
        .notification-close {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        .notification-close:hover {
            color: #333;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
    <!-- jsPDF / XLSX / Chart.js (kept for parity; vehicle page may not use yet) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
<div class="app-container">
    <!-- Sidebar (copied from staff.html) -->
    <nav class="sidebar menu-loading" id="sidebarMenu">
        <div class="logo"><h2>Dreamex Datalab</h2></div>
        <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view" data-requires-permission="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                <a href="#"><i class="fas fa-medkit"></i> Health</a>
                <ul class="submenu">
                    <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                    <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                    <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                <ul class="submenu">
                    <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                    <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                    <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                    <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                    <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                    <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                    <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="fuel_management">
                <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                <ul class="submenu">
                    <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="environment_view">
                <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                <ul class="submenu"><li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li></ul>
            </li>
            <li class="menu-dropdown" data-feature="security_view">
                <a href="#"><i class="fas fa-lock"></i> Security</a>
                <ul class="submenu">
                    <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
            </li>
            <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                <ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                <ul class="submenu">
                    <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                <a href="#"><i class="fas fa-users"></i> HR</a>
                <ul class="submenu">
                    <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html">Human HR</a></li>
                    <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                    <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                    <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                    <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                    <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                    <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                    <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                    <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                    <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                    <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                    <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                    <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                    <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                </ul>
            </li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <ul class="submenu">
                    <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <!-- Main area -->
    <main class="main-content" id="mainContent">
        <!-- Top Navigation (exact copy from staff.html) -->
        <header class="top-nav">
            <div class="top-nav-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                <span id="headerCompanyName" class="company-name-header"></span>
            </div>
            <div class="top-nav-right">
                <div class="notifications">
                    <button id="notificationBtn" class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list"></div>
                    </div>
                </div>
                <div class="user-profile">
                    <button id="userProfileBtn" class="profile-btn">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzM0OThkYiIvPjx0ZXh0IHg9IjIwIiB5PSIyNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSI2MDAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiI+VTwvdGV4dD48c3ZnPjwvc3ZnPg==" alt="User Avatar">
                    </button>
                    <div class="profile-dropdown">
                        <ul>
                            <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        <!-- Fleet Page Content -->
        <section class="content" id="fleetContent">
            <div class="staff-management-content">
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 0.6rem;">
                        <i class="fas fa-truck"></i>
                        <span>Fleet / Vehicles</span>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-nav-btn active" id="vehiclesTabBtn" onclick="switchToTab('vehicles')">
                        <i class="fas fa-truck"></i>
                        Vehicles
                    </button>
                    <button class="tab-nav-btn" id="analyticsTabBtn" onclick="switchToTab('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                </div>

                <!-- Vehicles Tab Content -->
                <div class="tab-content active" id="vehiclesTabContent">
                    <div class="table-wrapper">
                    <table id="vehicleTable" class="staff-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Plate Number</th>
                                <th>Type</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Department</th>
                                <th>Site</th>
                                <th>Fuel Type</th>
                                <th>Securing Status</th>
                                <th>Tank</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicleTableBody"></tbody>
                    </table>
                    <div id="vehicleEmptyState" class="empty-state d-none" style="text-align:center; padding:2rem; display:none;">
                        <i class="fas fa-truck" style="font-size:2rem; color:#6c757d;"></i>
                        <i class="fas fa-plus" title="Add Vehicle" style="cursor:pointer; font-size:1.5rem; color:#6c757d;" onclick="openAddVehicleModal()"></i>
                    </div>
                </div>
                </div>

                <!-- Analytics Tab Content -->
                <div class="tab-content" id="analyticsTabContent">
                    <!-- Visualization Controls -->
                    <div class="controls-section">
                        <div class="controls-grid">
                            <div class="filter-group">
                                <select class="filter-select" id="chartTypeSelect" onchange="updateFleetVisualization()" style="display: block;">
                                    <option value="bar">Bar Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="doughnut">Doughnut Chart</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select class="filter-select" id="dataSourceSelect" onchange="updateFleetVisualization()" style="display: block;">
                                    <option value="all">All Vehicles</option>
                                    <option value="active">Active Vehicles</option>
                                    <option value="inactive">Inactive Vehicles</option>
                                    <option value="maintenance">Under Maintenance</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select class="filter-select" id="groupBySelect" onchange="updateFleetVisualization()" style="display: block;">
                                    <option value="status">Status</option>
                                    <option value="department">Department</option>
                                    <option value="vehicleType">Vehicle Type</option>
                                    <option value="fuelType">Fuel Type</option>
                                    <option value="site">Site Assignment</option>
                                </select>
                            </div>
                            
                            <div class="filter-group chart-actions">
                                <div class="actions-wrapper">
                                    <div class="view-toggles">
                                        <i class="fas fa-sync" onclick="refreshFleetVisualization()" title="Refresh Charts" style="cursor: pointer; font-size: 1.1rem; color: #6c757d;"></i>
                                        <i class="fas fa-download" onclick="exportFleetChartData()" title="Export Chart Data" style="cursor: pointer; font-size: 1.1rem; color: #6c757d;"></i>
                                        <i class="fas fa-image" onclick="exportFleetChartImage()" title="Export Chart as Image" style="cursor: pointer; font-size: 1.1rem; color: #6c757d;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Container -->
                    <div class="visualization-container">
                        <!-- Main Chart -->
                        <div class="chart-container">
                            <canvas id="fleetMainChart" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%;"></canvas>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-truck"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="totalVehicles">0</h3>
                                    <p>Total Vehicles</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="activeVehicles">0</h3>
                                    <p>Active Vehicles</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="maintenanceVehicles">0</h3>
                                    <p>Under Maintenance</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-building"></i>
                                </div>
                                <div class="stat-details">
                                    <h3 id="uniqueDepartments">0</h3>
                                    <p>Departments</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>
<button class="fab" id="addVehicleFab" aria-label="Add Vehicle" title="Add Vehicle">+</button>

<!-- Vehicle Modal (created dynamically to mirror staff pattern) -->
<script>
// Firebase config reused
const firebaseConfig = { apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain: "users-8be65.firebaseapp.com", databaseURL: "https://users-8be65-default-rtdb.firebaseio.com", projectId: "users-8be65", storageBucket: "users-8be65.firebasestorage.app", messagingSenderId: "909025468149", appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d", measurementId: "G-XHFMRCJQEZ" };
function initializeFirebase(){ if(!window.firebase || !window.firebase.apps || window.firebase.apps.length===0){ window.firebase.initializeApp(firebaseConfig);} return window.firebase; }
initializeFirebase();

// Initialize Firebase Storage
const storage = firebase.storage();
const storageRef = storage.ref();

// Extended AuthManager (subset from staff.html with branding + logout + permissions)
class AuthManager {
    constructor(){ this.firebase = initializeFirebase(); this.currentUser = this.getCurrentUser(); this.db = this.firebase.database(); this.currentCompany=null; if(!this.currentUser){ console.warn('Fleet Auth: no user, guest mode (redirect disabled)'); this.currentUser={ uid:'guest', email:'guest@example.com'}; } this.initializeAuth(); }
  getCurrentUser(){ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
  async initializeAuth(){ 
    await this.loadUserCompany(); 
    await this.updateUIForAuthenticatedUser(); 
    this.setupProfileDropdown(); 
    
    // Initialize menu visibility system using new feature-based authorization
    console.log(' Initializing menu visibility system...');
    try {
        // Wait a moment for authentication and company context to be fully established
        setTimeout(async () => {
            try {
                await updateMenuWithFeatureAuthorization();
                console.log(' Menu visibility system initialized');
            } catch (authError) {
                console.error(' Menu authorization failed:', authError);
                // Only show basic menu if we're sure there's no authentication
                setTimeout(() => {
                    console.log(' Final fallback: showing basic menu after failed authorization');
                    showBasicMenu();
                }, 2000); // Give it more time before fallback
            }
        }, 500);
    } catch (menuError) {
        console.warn(' Could not initialize menu visibility:', menuError);
        // Don't immediately fall back - let the timeout handle it
    }
  }
  setupProfileDropdown(){ const userProfileBtn = document.getElementById('userProfileBtn'); const profileDropdown = document.querySelector('.profile-dropdown'); if (userProfileBtn && profileDropdown) { userProfileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('show'); }); document.addEventListener('click', (e) => { if (!userProfileBtn.contains(e.target)) { profileDropdown.classList.remove('show'); } }); } }
  resetMenuVisibility(){ 
    // Legacy method - now delegated to global two-phase system to prevent conflicts
    console.log(' Legacy resetMenuVisibility called - delegating to global system');
  }
  async updateMenuVisibility(){ 
    // Legacy method - now delegated to global two-phase system to prevent conflicts
    console.log(' Legacy updateMenuVisibility called - delegating to global system');
    // Do not manipulate menu here - let the new two-phase system handle it
  }
  async loadUserCompany(){ if(!this.currentUser) return; try { const companiesSnap = await this.db.ref('companies').once('value'); if(!companiesSnap.exists()) return; const companies = companiesSnap.val(); for(const [cid, company] of Object.entries(companies)){ if(company.status!=='active') continue; if(company.users){ for(const [uid, u] of Object.entries(company.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId = cid; this.currentCompany = company; localStorage.setItem('currentUser', JSON.stringify(this.currentUser)); this.applyBranding(); this.loadDynamicLists(); return; } } } } } catch(e){ console.error('Company load error',e); } }
  applyBranding(){ if(!this.currentCompany) return; const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.style.display='block'; } else { logoEl.style.display='none'; } } if(this.currentCompany.branding){ const b=this.currentCompany.branding; const root=document.documentElement; if(b.primaryColor) root.style.setProperty('--primary-color', b.primaryColor); if(b.secondaryColor) root.style.setProperty('--secondary-color', b.secondaryColor); } }
  async loadDynamicLists(){ 
    if(!this.currentCompany) return; 
    const cid = this.currentUser.companyId; 
    try { 
        // Load departments from settings.html field options configuration
        await loadDepartmentsFromSettings(cid);
        
        // Load work areas from settings.html field options configuration
        await loadWorkAreasFromSettings(cid);
        
        populateVehicleSelects(); 
        
        // Initialize vehicle data loading
        await initializeVehicleData();
        
    } catch(e){ 
        console.warn('Dynamic list load failed', e); 
    } 
  }
  getUserDisplayName(){ if(!this.currentUser) return 'User'; const potential=[this.currentUser.displayName,this.currentUser.fullName,this.currentUser.name,this.currentUser.firstName && this.currentUser.lastName ? `${this.currentUser.firstName} ${this.currentUser.lastName}`:null]; const clean=n=> n && typeof n==='string' ? n.trim():''; for(const n of potential){ const c=clean(n); if(c) return c; } if(this.currentUser.email){ const userPart=this.currentUser.email.split('@')[0]; const c=clean(userPart); if(c) return c; } return 'User'; }
  getUserInitials(){ const name=this.getUserDisplayName(); if(!name || name==='User') return 'U'; const words=name.split(' ').filter(w=>w.length>0); if(words.length===1) return words[0].substring(0,2).toUpperCase(); return words.slice(0,2).map(w=>w[0]).join('').toUpperCase(); }
  getUserEmail(){ return this.currentUser?.email || ''; }
  generateInitialsAvatar(name,img){ if(!img||!name) return; const initials=this.getUserInitials(); const colors=['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c']; const bg=colors[name.length % colors.length]; const svg=`<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="${bg}"/><text x="20" y="25" text-anchor="middle" fill="#fff" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); img.alt=name+' Avatar'; }
  async getUserAvatarUrl(){ if(!this.currentUser) return null; try { const storage=this.firebase.storage(); const path=`avatars/${this.currentUser.uid}/profile.jpg`; const url= await storage.ref(path).getDownloadURL(); return url; } catch(e){ return null; } }
    async updateUIForAuthenticatedUser(){ const profileBtn=document.querySelector('.profile-btn'); const profileImg=profileBtn ? profileBtn.querySelector('img'):null; const profileDropdown=document.querySelector('.profile-dropdown ul'); if(!profileBtn||!profileDropdown||!this.currentUser) return; const initials = this.getUserInitials(); const displayName = this.getUserDisplayName(); const email = this.getUserEmail(); const avatarUrl = await this.getUserAvatarUrl(); if(profileImg){ if(avatarUrl){ profileImg.src=avatarUrl; profileImg.alt=displayName+' Avatar'; } else { this.generateInitialsAvatar(displayName, profileImg); } } let dropdownAvatarHtml; if (avatarUrl) { dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`; } else { dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`; } const userInfoHtml = `<li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;"><div style="display: flex; align-items: center; gap: 12px;">${dropdownAvatarHtml}<div><div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">${displayName}</div><div style="color: #666; font-size: 12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`; profileDropdown.innerHTML = userInfoHtml; const logoutBtn = profileDropdown.querySelector('#logoutLink'); if (logoutBtn) { logoutBtn.addEventListener('click', (e) => { e.preventDefault(); this.logout(); }); } }
  async logout(){ try { await this.firebase.auth().signOut(); } catch(e){ console.warn('Signout issue',e); } localStorage.removeItem('currentUser'); window.location.href='index.html'; }
}
window.authManager = new AuthManager();

// Sidebar toggle (match staff.html behavior: expand content/top bar when collapsed)
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebarMenu');
const mainContent = document.getElementById('mainContent');
const topNav = document.querySelector('.top-nav');
if (sidebarToggle && sidebar && mainContent && topNav) {
    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
        topNav.classList.toggle('sidebar-collapsed');
    });
}

// Departments / Sites placeholder (overridden when dynamic lists load)
let departmentOptions = []; // filled from Firebase company scope
let siteOptions = []; // filled from Firebase company scope

// Load work areas from Firebase company scope field options
async function loadWorkAreasFromSettings(companyId) {
    try {
        console.log(' Loading work areas from Firebase company scope for company:', companyId);
        
        // Priority 1: Try Firebase field options first (company scope)
        let fieldOptionsRef = firebase.database().ref(`companies/${companyId}/fieldOptions/area`);
        
        try {
            const snapshot = await fieldOptionsRef.once('value');
            const firebaseOptions = snapshot.val();
            
            if (firebaseOptions) {
                if (Array.isArray(firebaseOptions)) {
                    siteOptions = firebaseOptions
                        .filter(option => option && option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                } else if (typeof firebaseOptions === 'object') {
                    siteOptions = Object.values(firebaseOptions)
                        .filter(option => option && option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                }
                
                if (siteOptions && siteOptions.length > 0) {
                    console.log(' Work areas loaded from Firebase company scope:', siteOptions);
                    return;
                }
            }
        } catch (firebaseError) {
            console.warn('Error loading from Firebase company scope:', firebaseError);
        }
        
        // Priority 2: Try company-specific localStorage (fallback company scope)
        const companyStorageKey = `fieldOptions_${companyId}_area`;
        let savedOptions = localStorage.getItem(companyStorageKey);
        
        if (savedOptions) {
            try {
                const localOptions = JSON.parse(savedOptions);
                if (Array.isArray(localOptions) && localOptions.length > 0) {
                    siteOptions = localOptions
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log(' Work areas loaded from company scope localStorage:', siteOptions);
                    return;
                }
            } catch (error) {
                console.warn('Error parsing company scope localStorage area options:', error);
            }
        }
        
        // Priority 3: Try global localStorage (final fallback)
        const globalStorageKey = `fieldOptions_area`;
        savedOptions = localStorage.getItem(globalStorageKey);
        
        if (savedOptions) {
            try {
                const localOptions = JSON.parse(savedOptions);
                if (Array.isArray(localOptions) && localOptions.length > 0) {
                    siteOptions = localOptions
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log(' Work areas loaded from global localStorage:', siteOptions);
                    return;
                }
            } catch (error) {
                console.warn('Error parsing global localStorage area options:', error);
            }
        }
        
        // Priority 4: Fallback to legacy Firebase settings location
        fieldOptionsRef = firebase.database().ref(`companies/${companyId}/settings/fieldOptions/area`);
        snapshot = await fieldOptionsRef.once('value');
        
        if (snapshot.exists() && snapshot.val()) {
            const areaOptions = snapshot.val();
            console.log(' Loaded work areas from Firebase field options:', areaOptions);
            
            // Extract enabled area options
            if (Array.isArray(areaOptions)) {
                siteOptions = areaOptions
                    .filter(option => option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log(' Work areas loaded from Firebase settings:', siteOptions);
                
                // Cache to company scope localStorage for future use
                localStorage.setItem(companyStorageKey, JSON.stringify(areaOptions));
                console.log(' Cached work areas to company scope localStorage');
                return;
            } else {
                console.warn(' Area field options is not in expected array format');
            }
        }
        
        // Priority 5: Final fallback to legacy sites location
        console.log(' No area field options found in company scope, trying legacy sites location...');
        await loadSitesFromLegacyLocation(companyId);
        
    } catch (error) {
        console.error(' Error loading work areas from company scope:', error);
        // Final fallback to legacy site loading method
        await loadSitesFromLegacyLocation(companyId);
    }
}

// Fallback function to load from legacy sites location
async function loadSitesFromLegacyLocation(companyId) {
    try {
        const siteSnap = await firebase.database().ref(`companies/${companyId}/sites`).once('value'); 
        if (siteSnap.exists()) {
            siteOptions = Object.values(siteSnap.val()).map(s => s.name || s).filter(Boolean);
            console.log(' Work areas loaded from legacy sites location:', siteOptions);
        }
    } catch (error) {
        console.error(' Error loading from legacy sites location:', error);
    }
}

// Load departments from Firebase company scope field options
async function loadDepartmentsFromSettings(companyId) {
    try {
        console.log(' Loading departments from Firebase company scope for company:', companyId);
        
        // Priority 1: Try Firebase company scope field options (PRIMARY)
        const fieldOptionsRef = firebase.database().ref(`companies/${companyId}/fieldOptions/department`);
        const snapshot = await fieldOptionsRef.once('value');
        
        if (snapshot.exists() && snapshot.val()) {
            const deptOptions = snapshot.val();
            console.log(' Loaded departments from Firebase company scope:', deptOptions);
            
            // Extract enabled department options from array or object
            if (Array.isArray(deptOptions)) {
                departmentOptions = deptOptions
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log(' Departments loaded from Firebase company scope:', departmentOptions);
                return;
            } else if (typeof deptOptions === 'object') {
                departmentOptions = Object.values(deptOptions)
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                console.log(' Departments loaded from Firebase company scope (object):', departmentOptions);
                return;
            } else {
                console.warn(' Department field options is not in expected array or object format');
            }
        } else {
            console.log(' No department field options found in Firebase company scope');
        }
        
        // Priority 2: Try secondary Firebase location (backup)
        const settingsFieldOptionsRef = firebase.database().ref(`companies/${companyId}/settings/fieldOptions/department`);
        const settingsSnapshot = await settingsFieldOptionsRef.once('value');
        
        if (settingsSnapshot.exists() && settingsSnapshot.val()) {
            const deptOptions = settingsSnapshot.val();
            console.log(' Loaded departments from Firebase settings company scope:', deptOptions);
            
            if (Array.isArray(deptOptions)) {
                departmentOptions = deptOptions
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log(' Departments loaded from Firebase settings company scope:', departmentOptions);
                return;
            } else if (typeof deptOptions === 'object') {
                departmentOptions = Object.values(deptOptions)
                    .filter(option => option && option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                console.log(' Departments loaded from Firebase settings company scope (object):', departmentOptions);
                return;
            }
        }
        
        // Priority 3: Fallback to legacy departments location
        console.log(' No department field options found in Firebase company scope, trying legacy departments location...');
        await loadDepartmentsFromLegacyLocation(companyId);
        
    } catch (error) {
        console.error(' Error loading departments from Firebase company scope:', error);
        // Final fallback to legacy department loading method
        await loadDepartmentsFromLegacyLocation(companyId);
    }
}

// Fallback function to load from legacy departments location
async function loadDepartmentsFromLegacyLocation(companyId) {
    try {
        const deptSnap = await firebase.database().ref(`companies/${companyId}/departments`).once('value'); 
        if (deptSnap.exists()) {
            departmentOptions = Object.values(deptSnap.val()).map(d => d.name || d).filter(Boolean);
            console.log(' Departments loaded from legacy departments location:', departmentOptions);
        }
    } catch (error) {
        console.error(' Error loading from legacy departments location:', error);
    }
}

function openAddVehicleModal(){ showAddVehicleModal(); }

function showAddVehicleModal(){ 
    let modal=document.querySelector('#addVehicleModal'); 
    if(!modal){ 
        modal=createAddVehicleModal(); 
    } 
    modal.classList.add('show'); 
    setTimeout(()=>{ 
        const first=modal.querySelector('input,select,button'); 
        if(first) first.focus(); 
    },50); 
    trapFocus(modal); 
}

function createAddVehicleModal(){ 
    const modal=document.createElement('div'); 
    modal.id='addVehicleModal'; 
    modal.className='modal'; 
    modal.innerHTML = `
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="vehicleModalTitle">
            <div class="modal-header">
                <h5 id="vehicleModalTitle">Add Vehicle</h5>
                <button class="close-btn" type="button" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addVehicleForm" novalidate>
                    <!-- Row 1: Name, Plate Number, Type, Mark, and Model -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="vehicleName">Name *</label>
                            <input type="text" id="vehicleName" required placeholder="Vehicle name/identifier">
                            <div class="error" data-error-for="vehicleName">Vehicle name is required</div>
                        </div>
                        <div class="form-group">
                            <label for="plateNumber">Plate Number *</label>
                            <input type="text" id="plateNumber" required>
                            <div class="error" data-error-for="plateNumber">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleType">Type *</label>
                            <select id="vehicleType" required>
                                <option value="">Select Vehicle Type</option>
                                <!-- Heavy Mining Equipment -->
                                <option value="Haul Truck">Haul Truck</option>
                                <option value="Dump Truck">Dump Truck</option>
                                <option value="Articulated Dump Truck">Articulated Dump Truck</option>
                                <option value="Off-Highway Truck">Off-Highway Truck</option>
                                <option value="Water Truck">Water Truck</option>
                                <option value="Fuel Truck">Fuel Truck</option>
                                <option value="Service Truck">Service Truck</option>
                                <!-- Excavation Equipment -->
                                <option value="Excavator">Excavator</option>
                                <option value="Hydraulic Excavator">Hydraulic Excavator</option>
                                <option value="Mining Excavator">Mining Excavator</option>
                                <option value="Backhoe">Backhoe</option>
                                <option value="Shovel">Shovel</option>
                                <option value="Electric Shovel">Electric Shovel</option>
                                <!-- Loading Equipment -->
                                <option value="Wheel Loader">Wheel Loader</option>
                                <option value="Front-End Loader">Front-End Loader</option>
                                <option value="Payloader">Payloader</option>
                                <option value="Skid Steer">Skid Steer</option>
                                <!-- Earthmoving Equipment -->
                                <option value="Bulldozer">Bulldozer</option>
                                <option value="Dozer">Dozer</option>
                                <option value="Motor Grader">Motor Grader</option>
                                <option value="Scraper">Scraper</option>
                                <option value="Compactor">Compactor</option>
                                <!-- Drilling Equipment -->
                                <option value="Drill Rig">Drill Rig</option>
                                <option value="Blast Hole Drill">Blast Hole Drill</option>
                                <option value="Rotary Drill">Rotary Drill</option>
                                <option value="DTH Drill">DTH Drill</option>
                                <!-- Underground Equipment -->
                                <option value="Locomotive">Locomotive</option>
                                <option value="Underground Truck">Underground Truck</option>
                                <option value="Load-Haul-Dump (LHD)">Load-Haul-Dump (LHD)</option>
                                <option value="Scoop Tram">Scoop Tram</option>
                                <option value="Jumbo">Jumbo</option>
                                <option value="Bolter">Bolter</option>
                                <!-- Support Vehicles -->
                                <option value="Pickup Truck">Pickup Truck</option>
                                <option value="Utility Vehicle">Utility Vehicle</option>
                                <option value="Personnel Carrier">Personnel Carrier</option>
                                <option value="Ambulance">Ambulance</option>
                                <option value="Fire Truck">Fire Truck</option>
                                <option value="Crane">Crane</option>
                                <option value="Mobile Crane">Mobile Crane</option>
                                <option value="Forklift">Forklift</option>
                                <option value="Generator Truck">Generator Truck</option>
                                <option value="Workshop Truck">Workshop Truck</option>
                                <option value="Tire Handler">Tire Handler</option>
                                <!-- Specialized Mining Equipment -->
                                <option value="Conveyor">Conveyor</option>
                                <option value="Crusher">Crusher</option>
                                <option value="Screening Plant">Screening Plant</option>
                                <option value="Wash Plant">Wash Plant</option>
                                <option value="Highwall Miner">Highwall Miner</option>
                                <!-- Other -->
                                <option value="Bus">Bus</option>
                                <option value="Van">Van</option>
                                <option value="ATV/UTV">ATV/UTV</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error" data-error-for="vehicleType">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleMake">Mark *</label>
                            <select id="vehicleMake" required>
                                <option value="">Select Vehicle Mark</option>
                                <!-- Heavy Equipment & Mining Manufacturers -->
                                <option value="Caterpillar">Caterpillar</option>
                                <option value="Komatsu">Komatsu</option>
                                <option value="Liebherr">Liebherr</option>
                                <option value="Hitachi">Hitachi</option>
                                <option value="Volvo">Volvo</option>
                                <option value="John Deere">John Deere</option>
                                <option value="Case">Case</option>
                                <option value="New Holland">New Holland</option>
                                <option value="JCB">JCB</option>
                                <option value="Bobcat">Bobcat</option>
                                <option value="Doosan">Doosan</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="Kobelco">Kobelco</option>
                                <option value="Kubota">Kubota</option>
                                <option value="Terex">Terex</option>
                                <option value="Atlas Copco">Atlas Copco</option>
                                <option value="Sandvik">Sandvik</option>
                                <option value="Epiroc">Epiroc</option>
                                <option value="Joy Global">Joy Global</option>
                                <option value="P&H Mining">P&H Mining</option>
                                <option value="Bucyrus">Bucyrus</option>
                                <option value="Wirtgen">Wirtgen</option>
                                <option value="Bomag">Bomag</option>
                                <option value="Hamm">Hamm</option>
                                <option value="Dynapac">Dynapac</option>
                                <!-- Commercial Truck Manufacturers -->
                                <option value="Mack">Mack</option>
                                <option value="Peterbilt">Peterbilt</option>
                                <option value="Kenworth">Kenworth</option>
                                <option value="Freightliner">Freightliner</option>
                                <option value="International">International</option>
                                <option value="Western Star">Western Star</option>
                                <option value="Volvo Trucks">Volvo Trucks</option>
                                <option value="Scania">Scania</option>
                                <option value="MAN">MAN</option>
                                <option value="Mercedes-Benz">Mercedes-Benz</option>
                                <option value="Iveco">Iveco</option>
                                <option value="DAF">DAF</option>
                                <option value="Renault">Renault</option>
                                <option value="Isuzu">Isuzu</option>
                                <option value="Hino">Hino</option>
                                <option value="UD Trucks">UD Trucks</option>
                                <!-- Automotive Manufacturers -->
                                <option value="Toyota">Toyota</option>
                                <option value="Ford">Ford</option>
                                <option value="Chevrolet">Chevrolet</option>
                                <option value="GMC">GMC</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Ram">Ram</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Honda">Honda</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="Mazda">Mazda</option>
                                <option value="Subaru">Subaru</option>
                                <option value="Jeep">Jeep</option>
                                <option value="Land Rover">Land Rover</option>
                                <option value="BMW">BMW</option>
                                <option value="Audi">Audi</option>
                                <option value="Volkswagen">Volkswagen</option>
                                <!-- Specialty Mining Equipment -->
                                <option value="Bell Equipment">Bell Equipment</option>
                                <option value="Komatsu Mining">Komatsu Mining</option>
                                <option value="Caterpillar Mining">Caterpillar Mining</option>
                                <option value="Liebherr Mining">Liebherr Mining</option>
                                <option value="Hitachi Mining">Hitachi Mining</option>
                                <option value="SANY">SANY</option>
                                <option value="XCMG">XCMG</option>
                                <option value="LiuGong">LiuGong</option>
                                <option value="Lonking">Lonking</option>
                                <option value="SDLG">SDLG</option>
                                <!-- Railway/Locomotive -->
                                <option value="GE Transportation">GE Transportation</option>
                                <option value="EMD">EMD</option>
                                <option value="Wabtec">Wabtec</option>
                                <option value="Siemens">Siemens</option>
                                <option value="Alstom">Alstom</option>
                                <option value="Bombardier">Bombardier</option>
                                <!-- Other/Custom -->
                                <option value="Other">Other</option>
                                <option value="Custom Built">Custom Built</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                            <div class="error" data-error-for="vehicleMake">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleModel">Model *</label>
                            <select id="vehicleModel" required>
                                <option value="">Select Mark first</option>
                            </select>
                            <div class="error" data-error-for="vehicleModel">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleStatus">Status *</label>
                            <select id="vehicleStatus" required>
                                <option value="">Select</option>
                                <option>Active</option>
                                <option>In Maintenance</option>
                                <option>Inactive</option>
                            </select>
                            <div class="error" data-error-for="vehicleStatus">Required</div>
                        </div>
                    </div>
                    
                    <!-- Company Row: Company selector -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companySelect">Company *</label>
                            <select id="companySelect" required>
                                <option value="">Select Company</option>
                            </select>
                            <div class="error" data-error-for="companySelect">Required</div>
                        </div>
                    </div>

                    <!-- Row 2: Department, Site, Fuel Type, Securing Status, and Tank Capacity -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="assignmentDept">Department *</label>
                            <select id="assignmentDept" required></select>
                            <div class="error" data-error-for="assignmentDept">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="siteAssignment">Site *</label>
                            <select id="siteAssignment" required></select>
                            <div class="error" data-error-for="siteAssignment">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="fuelType">Fuel Type *</label>
                            <select id="fuelType" required>
                                <option value="">Select</option>
                                <option>Diesel</option>
                                <option>Gasoline</option>
                                <option>Jet A-1</option>
                                <option>HFO</option>
                            </select>
                            <div class="error" data-error-for="fuelType">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="securingStatus">Securing Status *</label>
                            <select id="securingStatus" required>
                                <option value="">Select</option>
                                <option>Secured</option>
                                <option>Unsecured</option>
                                <option>Unknown</option>
                            </select>
                            <div class="error" data-error-for="securingStatus">Required</div>
                        </div>
                        <div class="form-group">
                            <label for="tankCapacity">Tank *</label>
                            <input type="number" id="tankCapacity" min="0" step="1" required>
                            <div class="error" data-error-for="tankCapacity">Integer >= 0</div>
                        </div>
                    </div>
                    
                    <!-- Row 3: VIN, Year, Mileage, Average Consumption, and Assigned Driver -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="vinNumber">VIN Number</label>
                            <input type="text" id="vinNumber" maxlength="17" placeholder="17-character VIN">
                            <div class="error" data-error-for="vinNumber">Invalid VIN format</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleYear">Year *</label>
                            <input type="number" id="vehicleYear" min="1900" max="2030" required>
                            <div class="error" data-error-for="vehicleYear">Valid year required</div>
                        </div>
                        <div class="form-group">
                            <label for="currentMileage">Current Mileage (km)</label>
                            <input type="number" id="currentMileage" min="0" step="1" placeholder="Current odometer reading">
                            <div class="error" data-error-for="currentMileage">Must be positive number</div>
                        </div>
                        <div class="form-group">
                            <label for="engineSize">Average Consumption</label>
                            <select id="engineSize" required>
                                <option value="">Select consumption unit</option>
                                <option value="L/100Km">L/100Km</option>
                                <option value="L/H">L/H</option>
                            </select>
                            <div class="error" data-error-for="engineSize">Please select consumption unit</div>
                        </div>
                        <div class="form-group">
                            <label for="averageValue">Average</label>
                            <input type="number" id="averageValue" min="0" step="0.1" placeholder="e.g., 8.5">
                            <div class="error" data-error-for="averageValue">Must be positive number</div>
                        </div>
                    </div>
                    
                    <!-- Row 4: Insurance, Registration, Asset Value, Attachment, and Assigned Driver -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="insuranceExpiry">Insurance Expiry</label>
                            <input type="date" id="insuranceExpiry">
                            <div class="error" data-error-for="insuranceExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="registrationExpiry">Registration Expiry</label>
                            <input type="date" id="registrationExpiry">
                            <div class="error" data-error-for="registrationExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="assetValue">Asset Value ($)</label>
                            <input type="number" id="assetValue" min="0" step="0.01" placeholder="Current asset value">
                            <div class="error" data-error-for="assetValue">Must be positive number</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleAttachment">Attachment</label>
                            <input type="file" id="vehicleAttachment" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                            <div class="error" data-error-for="vehicleAttachment">Invalid file type</div>
                        </div>
                        <div class="form-group">
                            <label for="assignedDriver">Assigned Driver</label>
                            <input type="text" id="assignedDriver" placeholder="Driver name">
                            <div class="error" data-error-for="assignedDriver">Invalid driver name</div>
                        </div>
                    </div>
                    
                    <!-- Row 5: Safety Equipment - Radio, GPS, Vignet, First Aid Kit -->
                    <div class="form-row-4">
                        <div class="form-group">
                            <label for="radioStatus">Radio</label>
                            <select id="radioStatus">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Under Repair">Under Repair</option>
                            </select>
                            <div class="error" data-error-for="radioStatus">Invalid radio status</div>
                        </div>
                        <div class="form-group">
                            <label for="gpsStatus">GPS</label>
                            <select id="gpsStatus">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Under Repair">Under Repair</option>
                            </select>
                            <div class="error" data-error-for="gpsStatus">Invalid GPS status</div>
                        </div>
                        <div class="form-group">
                            <label for="vignetDate">Vignet (Date)</label>
                            <input type="date" id="vignetDate">
                            <div class="error" data-error-for="vignetDate">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="firstAidKit">First Aid Kit</label>
                            <select id="firstAidKit">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Expired">Expired</option>
                            </select>
                            <div class="error" data-error-for="firstAidKit">Invalid first aid kit status</div>
                        </div>
                    </div>
                    
                    <!-- Row 6: Safety Equipment Expiry - First Aid Kit Expiry, Extinguisher Status, Extinguisher Expiry, Certificate, Certificate Expiry -->
                    <div class="form-row-5">
                        <div class="form-group">
                            <label for="firstAidKitExpiry">First Aid Kit Expiry</label>
                            <input type="date" id="firstAidKitExpiry">
                            <div class="error" data-error-for="firstAidKitExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="extinguisherStatus">Extinguisher Status</label>
                            <select id="extinguisherStatus">
                                <option value="">Select</option>
                                <option value="Available">Available</option>
                                <option value="Not Available">Not Available</option>
                                <option value="Under Inspection">Under Inspection</option>
                                <option value="Expired">Expired</option>
                            </select>
                            <div class="error" data-error-for="extinguisherStatus">Invalid extinguisher status</div>
                        </div>
                        <div class="form-group">
                            <label for="extinguisherExpiry">Extinguisher Expiry</label>
                            <input type="date" id="extinguisherExpiry">
                            <div class="error" data-error-for="extinguisherExpiry">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="certificateDate">Certificate (Date)</label>
                            <input type="date" id="certificateDate">
                            <div class="error" data-error-for="certificateDate">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="certificateExpiry">Certificate Expiry</label>
                            <input type="date" id="certificateExpiry">
                            <div class="error" data-error-for="certificateExpiry">Invalid date</div>
                        </div>
                    </div>
                    
                    <!-- Row 7: Notes (full width) -->
                    <div class="form-group">
                        <label for="vehicleNotes">Notes</label>
                        <textarea id="vehicleNotes" rows="3" placeholder="Additional notes about the vehicle..."></textarea>
                        <div class="error" data-error-for="vehicleNotes">Notes too long</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="cancel">Cancel</button>
                <button type="submit" class="btn btn-primary" form="addVehicleForm">Save</button>
            </div>
        </div>
    `; 
    document.body.appendChild(modal); 
    const closeBtn=modal.querySelector('.close-btn'); 
    const cancelBtn=modal.querySelector('[data-action="cancel"]'); 
    const form=modal.querySelector('#addVehicleForm'); 
    closeBtn.addEventListener('click',()=>closeVehicleModal()); 
    cancelBtn.addEventListener('click',()=>closeVehicleModal()); 
    form.addEventListener('submit',e=>{ e.preventDefault(); handleVehicleSubmit(form); }); 
    populateVehicleSelects(); 
    populateModelsByMark();
    return modal; 
}

// Create Vehicle Details Modal
function createVehicleDetailsModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'vehicleDetailsModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-car"></i> Vehicle Details</h5>
                <button class="close-btn" onclick="closeVehicleDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="vehicleDetailsContent">
                <!-- Dynamic content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeVehicleDetailsModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportVehicleToPDF()" id="exportPDFBtn">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

async function populateVehicleSelects() {
    const user = window.authManager?.currentUser;
    
    if (!user || !user.companyId) {
        console.error(' No user or company ID available for populateVehicleSelects');
        return;
    }

    try {
        // Populate company dropdown with current company (extendable later)
        const compSel = document.getElementById('companySelect');
        if (compSel) {
            const currCompanyId = user.companyId;
            const currCompanyName = window.authManager?.currentCompany?.companyName || 'Current Company';
            compSel.innerHTML = `<option value="">Select Company</option>` +
                `<option value="${currCompanyId}" selected>${currCompanyName}</option>`;
        }

        // Load departments from settings if not already loaded
        if (!departmentOptions || departmentOptions.length === 0) {
            console.log(' Loading departments from settings...');
            await loadDepartmentsFromSettings(user.companyId);
        }
        
        // Load work areas from settings if not already loaded
        if (!siteOptions || siteOptions.length === 0) {
            console.log(' Loading work areas from settings...');
            await loadWorkAreasFromSettings(user.companyId);
        }

        // Populate department dropdown with departments from settings
        const deptSel = document.getElementById('assignmentDept');
        if (deptSel) {
            if (departmentOptions && departmentOptions.length > 0) {
                deptSel.innerHTML = '<option value="">Select Department</option>' + 
                    departmentOptions.map(d => `<option value="${d}">${d}</option>`).join('');
                console.log(' Departments loaded in department dropdown:', departmentOptions);
            } else {
                deptSel.innerHTML = '<option value="">No departments configured</option>';
                console.warn(' No departments found, check settings configuration');
            }
        }

        // Populate site dropdown with work areas from settings
        const siteSel = document.getElementById('siteAssignment');
        if (siteSel) {
            if (siteOptions && siteOptions.length > 0) {
                siteSel.innerHTML = '<option value="">Select Site</option>' + 
                    siteOptions.map(s => `<option value="${s}">${s}</option>`).join('');
                console.log(' Work areas loaded in site dropdown:', siteOptions);
            } else {
                siteSel.innerHTML = '<option value="">No work areas configured</option>';
                console.warn(' No work areas found, check settings configuration');
            }
        }
    } catch (error) {
        console.error(' Error in populateVehicleSelects:', error);
        // Fallback to original behavior if there's an error
        const siteSel = document.getElementById('siteAssignment');
        if (siteSel && siteOptions) {
            siteSel.innerHTML = '<option value="">Select</option>' + 
                siteOptions.map(s => `<option>${s}</option>`).join('');
        }
    }
}

// Vehicle models mapping by manufacturer
const vehicleModels = {
    "Caterpillar": ["777F", "789C", "793F", "797F", "MT4400D", "MT5300D", "336", "349", "374", "390", "6020B", "7495", "980M", "988K", "993K", "994K", "D6", "D8", "D9", "D10", "D11", "16M", "24M", "777G", "785C", "789D", "793D", "797B", "830M", "836K", "844K", "854K", "966M", "972M", "980K", "988H"],
    "Komatsu": ["930E", "960E", "980E", "HD785", "HD1500", "HD605", "PC1250", "PC2000", "PC3000", "PC4000", "PC5500", "PC8000", "WA380", "WA470", "WA500", "WA600", "WA700", "WA800", "WA900", "D155", "D275", "D375", "D475", "D575", "D655", "D85", "D155A", "GD655", "GD825"],
    "Liebherr": ["T236", "T264", "T274", "T282B", "T284", "R9150", "R9200", "R9250", "R9350", "R9400", "R9800", "L550", "L566", "L580", "L586", "PR734", "PR744", "PR754", "PR764", "PR776"],
    "Hitachi": ["EH1100", "EH1700", "EH3500", "EH4000", "EH5000", "EX1200", "EX2500", "EX3600", "EX5500", "EX8000", "ZW220", "ZW310", "ZW370", "ZW550", "ZW370-6"],
    "Volvo": ["A25G", "A30G", "A35G", "A40G", "A45G", "A60H", "R100E", "R70D", "EC380E", "EC480E", "EC750E", "EC950E", "L120H", "L150H", "L180H", "L220H", "L260H", "G940", "G946", "G960", "G970", "G990"],
    "John Deere": ["310SL", "315SL", "350G", "370E", "410E", "460E", "550K", "650K", "750K", "850K", "950K", "1050K", "624K", "644K", "724K", "744K", "824K", "844K", "872G", "970G"],
    "Toyota": ["Hilux", "Land Cruiser", "Hiace", "Coaster", "Dyna", "Prado", "4Runner", "Tacoma", "Tundra", "Sequoia", "Sienna", "Camry", "Corolla", "RAV4", "Highlander"],
    "Ford": ["F-150", "F-250", "F-350", "F-450", "F-550", "Ranger", "Transit", "E-Series", "Explorer", "Expedition", "Escape", "Edge", "Bronco", "Mustang", "Focus"],
    "Chevrolet": ["Silverado 1500", "Silverado 2500", "Silverado 3500", "Colorado", "Express", "Suburban", "Tahoe", "Traverse", "Equinox", "Malibu", "Cruze", "Camaro"],
    "Mack": ["Granite", "TerraPro", "LR", "LEU", "MRU", "Anthem", "Pinnacle", "Titan", "Trident", "MP7", "MP8", "MP10"],
    "Peterbilt": ["367", "378", "379", "386", "387", "388", "389", "520", "567", "579", "320", "330", "337", "348"],
    "Kenworth": ["T680", "T880", "W900", "T370", "T470", "T800", "C500", "T408SAR", "T909", "T610", "T659"],
    "Freightliner": ["Cascadia", "Century Class", "Columbia", "Coronado", "Argosy", "FLD120", "M2 106", "114SD", "Condor"],
    "Mercedes-Benz": ["Actros", "Arocs", "Atego", "Axor", "Econic", "Sprinter", "Vito", "Metris", "G-Class", "Unimog"],
    "Scania": ["R-Series", "S-Series", "P-Series", "G-Series", "L-Series", "XT-Series", "R730", "R770", "S730", "S770"],
    "Volvo Trucks": ["FH", "FM", "FMX", "FL", "FE", "VNL", "VNR", "VHD", "VAH", "VNX"],
    "Isuzu": ["D-Max", "MU-X", "NPR", "NQR", "FRR", "FVR", "GXR", "CXZ", "EXR", "FXR"],
    "Hino": ["300 Series", "500 Series", "700 Series", "Dutro", "Ranger", "Profia"],
    "International": ["HX Series", "LT Series", "RH Series", "HV Series", "CV Series", "MV Series", "DuraStar", "WorkStar", "TranStar"],
    "Western Star": ["4700", "4800", "4900", "5700", "6900"],
    "Bobcat": ["S70", "S450", "S510", "S530", "S550", "S570", "S590", "S630", "S650", "S740", "S750", "S770", "S850", "T450", "T550", "T590", "T630", "T650", "T740", "T770", "T870"],
    "JCB": ["3CX", "4CX", "5CX", "JS130", "JS160", "JS200", "JS220", "JS330", "435S", "444", "456", "467", "531-70", "540-140", "540-170", "541-70"],
    "Case": ["580N", "590SN", "695SN", "770EX", "870", "970", "1070", "1170", "CX130D", "CX160D", "CX210D", "CX245D", "CX290D", "CX350D", "CX470D", "CX490D"],
    "New Holland": ["B90B", "B95B", "B110B", "B115B", "E145", "E175", "E215", "E245", "E305", "C227", "C232", "C238", "L213", "L216", "L218", "L220", "L223", "L225", "L230"],
    "Hyundai": ["R140LC", "R160LC", "R180LC", "R210LC", "R260LC", "R300LC", "R380LC", "R450LC", "R520LC", "HL730", "HL740", "HL757", "HL760", "HL770", "HL780"],
    "Doosan": ["DX140", "DX160", "DX180", "DX190", "DX225", "DX255", "DX300", "DX340", "DX380", "DX420", "DX480", "DX520", "DL200", "DL220", "DL250", "DL300", "DL420", "DL450"],
    "Atlas Copco": ["Boomer E1", "Boomer E2", "Boomer M2", "Boomer S1", "Boomer S2", "Boomer XE3", "Rocket Boomer", "Simba M4", "Simba M6", "Simba W6", "Simba W7"],
    "Sandvik": ["DD320", "DD421", "DD422", "DL330", "DL431", "DL432", "LH209", "LH307", "LH410", "LH514", "LH517", "LH621", "TH320", "TH430", "TH540", "TH545", "TH663"],
    "Epiroc": ["Boomer E1", "Boomer E2", "Boomer M2", "Boomer S1", "Boomer S2", "Boomer XE3", "Minetruck MT42", "Minetruck MT65", "Scooptram ST14", "Scooptram ST18"],
    "SANY": ["SY75C", "SY135C", "SY215C", "SY235C", "SY335C", "SY365C", "SY385H", "SY465H", "SY485H", "SY500H", "SY750H", "SY850H"],
    "XCMG": ["XE75DA", "XE135B", "XE200DA", "XE215DA", "XE270DK", "XE335DK", "XE370DK", "XE490DK", "XE700DK", "XE950E", "LW300KN", "LW500KN", "LW600KN"],
    "Bell Equipment": ["B20E", "B25E", "B30E", "B35E", "B40E", "B45E", "B50E", "L1206E", "L1306E", "L1406E", "L1506E", "L1806E", "L2106E"],
    "Terex": ["TA250", "TA300", "TA400", "TR35", "TR40", "TR45", "TR50", "TR60", "TR100", "RH120", "RH170", "RH200", "RH340", "RH400"],
    "Wirtgen": ["W35DC", "W50DC", "W100H", "W120H", "W150", "W200H", "W210", "2100DC", "2200SM", "3800CR"],
    "Other": ["Custom Model", "Unknown Model", "Prototype", "Modified", "Legacy Model"]
};

// Function to populate model dropdown based on selected mark
function populateModelsByMark() {
    const markSelect = document.getElementById('vehicleMake');
    const modelSelect = document.getElementById('vehicleModel');
    
    if (!markSelect || !modelSelect) return;
    
    markSelect.addEventListener('change', function() {
        const selectedMark = this.value;
        
        // Clear existing options
        modelSelect.innerHTML = '';
        
        if (!selectedMark) {
            modelSelect.innerHTML = '<option value="">Select Mark first</option>';
            modelSelect.disabled = true;
            return;
        }
        
        // Enable model dropdown
        modelSelect.disabled = false;
        
        // Add default option
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        
        // Get models for selected mark
        const models = vehicleModels[selectedMark] || [];
        
        if (models.length === 0) {
            modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
        } else {
            // Add all models for the selected mark
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // Add "Other" option at the end
            modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
        }
    });
}

function updateModelsForMake(selectedMark) {
    const modelSelect = document.getElementById('vehicleModel');
    
    if (!modelSelect || !selectedMark) return;
    
    // Clear existing options
    modelSelect.innerHTML = '';
    
    // Enable model dropdown
    modelSelect.disabled = false;
    
    // Add default option
    modelSelect.innerHTML = '<option value="">Select Model</option>';
    
    // Get models for selected mark
    const models = vehicleModels[selectedMark] || [];
    
    if (models.length === 0) {
        modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
    } else {
        // Add all models for the selected mark
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
        });
        
        // Add "Other" option at the end
        modelSelect.innerHTML += '<option value="Other">Other/Custom Model</option>';
    }
}

function closeVehicleModal(){ 
    const modal=document.getElementById('addVehicleModal'); 
    if(!modal) return; 
    
    // Reset edit mode attributes
    modal.removeAttribute('data-edit-mode');
    modal.removeAttribute('data-vehicle-id');
    
    // Reset modal title and button text
    const modalTitle = modal.querySelector('.modal-header h5');
    if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-plus"></i> Add New Vehicle';
    }
    
    const submitBtn = modal.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.textContent = 'Save';
    }
    
    modal.classList.remove('show'); 
    document.getElementById('addVehicleFab').focus(); 
}

function validateField(field) {
    const error = document.querySelector(`.error[data-error-for="${field.id}"]`);
    let value = field.value.trim();
    let valid = true;
    
    // Required field validation
    if (field.required && !value) {
        valid = false;
    }
    
    // Field-specific validations
    if (valid && value) {
        switch (field.id) {
            case 'vehicleName':
                if (value && value.length < 2) valid = false;
                break;
                
            case 'tankCapacity':
            case 'currentMileage':
                const intNum = Number(value);
                if (!Number.isInteger(intNum) || intNum < 0) valid = false;
                break;
                
            case 'engineSize':
                // Now a dropdown for consumption unit, just check if selected
                if (!value || (value !== 'L/100Km' && value !== 'L/H')) valid = false;
                break;
                
            case 'assetValue':
                const floatNum = Number(value);
                if (isNaN(floatNum) || floatNum < 0) valid = false;
                break;
                
            case 'vehicleYear':
                const year = Number(value);
                const currentYear = new Date().getFullYear();
                if (!Number.isInteger(year) || year < 1900 || year > currentYear + 10) valid = false;
                break;
                
            case 'vinNumber':
                if (value && !/^[A-HJ-NPR-Z0-9]{17}$/i.test(value)) valid = false;
                break;
                
            case 'plateNumber':
                if (valid) field.value = value.toUpperCase();
                break;
                
            case 'vehicleMake':
            case 'assignedDriver':
                if (value && value.length < 2) valid = false;
                break;
                
            case 'averageValue':
                if (value && (isNaN(value) || parseFloat(value) <= 0)) valid = false;
                break;
                
            case 'insuranceExpiry':
            case 'registrationExpiry':
                if (value && !isValidDate(value)) valid = false;
                break;
                
            case 'vehicleAttachment':
                if (value) {
                    const allowedTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif'];
                    const fileExtension = value.toLowerCase().substring(value.lastIndexOf('.'));
                    if (!allowedTypes.includes(fileExtension)) valid = false;
                }
                break;
                
            case 'vehicleNotes':
                if (value && value.length > 500) valid = false;
                break;
        }
    }
    
    // Update UI
    if (!valid) {
        field.classList.add('invalid');
        if (error) error.style.display = 'block';
    } else {
        field.classList.remove('invalid');
        if (error) error.style.display = 'none';
    }
    
    return valid;
}

function isValidDate(dateString) {
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

function handleVehicleSubmit(form) {
    // All field IDs including new standard fields
    const requiredIds = ['vehicleName', 'plateNumber', 'vehicleType', 'vehicleModel', 'vehicleStatus', 'assignmentDept', 'siteAssignment', 'fuelType', 'securingStatus', 'tankCapacity', 'vehicleMake', 'vehicleYear', 'companySelect'];
    const optionalIds = ['vinNumber', 'currentMileage', 'engineSize', 'averageValue', 'assignedDriver', 'insuranceExpiry', 'registrationExpiry', 'assetValue', 'vehicleAttachment', 'vehicleNotes', 'radioStatus', 'gpsStatus', 'vignetDate', 'firstAidKit', 'firstAidKitExpiry', 'extinguisherStatus', 'extinguisherExpiry'];
    
    // Validate all fields
    const allFields = [...requiredIds, ...optionalIds].map(id => form.querySelector('#' + id)).filter(Boolean);
    const allValid = allFields.map(validateField).every(v => v);
    
    if (!allValid) {
        showNotification('Please correct the highlighted errors before saving.', 'warning');
        return;
    }
    
    // Collect form data (excluding file input which is handled separately)
    const vehicleData = {};
    allFields.forEach(field => {
        // Skip file input fields as they're handled separately in save functions
        if (field.type === 'file') {
            return;
        }
        
        if (field.value.trim()) {
            vehicleData[field.id] = field.value.trim();
        }
    });

    // Normalize keys for backward/forward compatibility
    if (vehicleData.assignmentDept) {
        vehicleData.department = vehicleData.assignmentDept; // legacy/alt key
        vehicleData.assignmentDepartment = vehicleData.assignmentDept; // alt naming
    }
    if (vehicleData.siteAssignment) {
        vehicleData.site = vehicleData.siteAssignment; // legacy/alt key
        vehicleData.workArea = vehicleData.siteAssignment; // alt naming from settings
    }
    // Company selection normalization (store both id and name)
    if (vehicleData.companySelect) {
        const compEl = document.getElementById('companySelect');
        const selectedOption = compEl ? compEl.options[compEl.selectedIndex] : null;
        vehicleData.selectedCompanyId = vehicleData.companySelect;
        vehicleData.selectedCompanyName = selectedOption ? selectedOption.textContent : (window.authManager?.currentCompany?.companyName || '');
    }
    
    // Check if we're in edit mode
    const modal = document.getElementById('addVehicleModal');
    const isEditMode = modal && modal.getAttribute('data-edit-mode') === 'true';
    const vehicleId = modal ? modal.getAttribute('data-vehicle-id') : null;
    
    if (isEditMode && vehicleId) {
        // Update existing vehicle
        updateVehicleInFirebase(vehicleData, vehicleId);
    } else {
        // Add new vehicle
        addVehicleRow(vehicleData);
    }
}

function addVehicleRow(data) {
    // Save to Firebase first
    saveVehicleToFirebase(data);
}

// Upload file to Firebase Storage
async function uploadFileToFirebaseStorage(file, vehicleId, companyId) {
    if (!file) return null;
    
    try {
        console.log(' Uploading file to Firebase Storage:', file.name);
        
        // Create a unique file path: companies/companyId/vehicles/vehicleId/attachments/filename
        const fileName = `${Date.now()}_${file.name}`;
        const filePath = `companies/${companyId}/vehicles/${vehicleId}/attachments/${fileName}`;
        const fileRef = storageRef.child(filePath);
        
        // Show upload progress
        const uploadTask = fileRef.put(file);
        
        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Track upload progress
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(` Upload progress: ${progress.toFixed(1)}%`);
                    
                    // Update UI with progress (you can add a progress bar here)
                    showNotification(`Uploading: ${progress.toFixed(1)}%`, 'info');
                },
                (error) => {
                    console.error(' Upload failed:', error);
                    showNotification('File upload failed', 'error');
                    reject(error);
                },
                async () => {
                    // Upload completed successfully, get download URL
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        console.log(' File uploaded successfully. Download URL:', downloadURL);
                        
                        // Store file metadata
                        const fileMetadata = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            uploadDate: new Date().toISOString(),
                            downloadURL: downloadURL,
                            storagePath: filePath
                        };
                        
                        showNotification('File uploaded successfully', 'success');
                        resolve(fileMetadata);
                    } catch (error) {
                        console.error(' Error getting download URL:', error);
                        reject(error);
                    }
                }
            );
        });
    } catch (error) {
        console.error(' Error uploading file:', error);
        showNotification('File upload failed', 'error');
        throw error;
    }
}

async function saveVehicleToFirebase(vehicleData) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            console.error(' No company context available for saving vehicle');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        
        // Generate unique vehicle ID
        const vehicleRef = database.ref(`companies/${companyId}/vehicles`).push();
        const vehicleId = vehicleRef.key;
        
        // Handle file upload if there's an attachment
        let attachmentMetadata = null;
        const fileInput = document.getElementById('vehicleAttachment');
        if (fileInput && fileInput.files && fileInput.files[0]) {
            try {
                console.log(' Processing attachment upload...');
                attachmentMetadata = await uploadFileToFirebaseStorage(fileInput.files[0], vehicleId, companyId);
            } catch (uploadError) {
                console.error(' File upload failed:', uploadError);
                showNotification('Vehicle saved but file upload failed', 'warning');
            }
        }
        
        // Prepare vehicle data with metadata
        const vehicleRecord = {
            ...vehicleData,
            id: vehicleId,
            createdAt: new Date().toISOString(),
            createdBy: window.authManager.currentUser.uid,
            updatedAt: new Date().toISOString(),
            status: vehicleData.vehicleStatus || 'Active',
            // Store attachment metadata instead of local path
            vehicleAttachment: attachmentMetadata ? attachmentMetadata.downloadURL : null,
            attachmentMetadata: attachmentMetadata
        };
        
        // Save to Firebase
        await vehicleRef.set(vehicleRecord);
        
        console.log(' Vehicle saved successfully:', vehicleId);
        showNotification('Vehicle saved successfully', 'success');
        
        // Clear the form
        clearVehicleForm();
        
        // Close modal
        closeModal('addVehicleModal');
        
    } catch (error) {
        console.error(' Error saving vehicle to Firebase:', error);
        // Show user-friendly error message
        showNotification('Error saving vehicle. Please try again.', 'error');
    }
}

async function updateVehicleInFirebase(vehicleData, vehicleId) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            showNotification('Authentication required to update vehicle', 'error');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehicleRef = database.ref(`companies/${companyId}/vehicles/${vehicleId}`);
        
        console.log(' Updating vehicle in Firebase:', vehicleId);
        
        // Handle file upload if there's a new attachment
        let attachmentMetadata = null;
        const fileInput = document.getElementById('vehicleAttachment');
        if (fileInput && fileInput.files && fileInput.files[0]) {
            try {
                console.log(' Processing new attachment upload...');
                attachmentMetadata = await uploadFileToFirebaseStorage(fileInput.files[0], vehicleId, companyId);
            } catch (uploadError) {
                console.error(' File upload failed during update:', uploadError);
                showNotification('Vehicle updated but file upload failed', 'warning');
            }
        }
        
        // Prepare updated vehicle data with metadata
        const updatedVehicleData = {
            ...vehicleData,
            id: vehicleId,
            updatedAt: new Date().toISOString(),
            updatedBy: window.authManager.currentUser.uid,
            status: vehicleData.vehicleStatus || 'Active'
        };

        // Normalize keys for backward/forward compatibility
        if (updatedVehicleData.assignmentDept) {
            updatedVehicleData.department = updatedVehicleData.assignmentDept;
            updatedVehicleData.assignmentDepartment = updatedVehicleData.assignmentDept;
        }
        if (updatedVehicleData.siteAssignment) {
            updatedVehicleData.site = updatedVehicleData.siteAssignment;
            updatedVehicleData.workArea = updatedVehicleData.siteAssignment;
        }
        
        // Only update attachment if a new file was uploaded
        if (attachmentMetadata) {
            updatedVehicleData.vehicleAttachment = attachmentMetadata.downloadURL;
            updatedVehicleData.attachmentMetadata = attachmentMetadata;
        }
        
        // Update in Firebase (this will trigger real-time listeners)
        await vehicleRef.update(updatedVehicleData);
        
        console.log(' Vehicle updated successfully:', vehicleId);
        showNotification('Vehicle updated successfully', 'success');
        
        // Clear the form and close modal
        clearVehicleForm();
        closeModal('addVehicleModal');
        
    } catch (error) {
        console.error(' Error updating vehicle in Firebase:', error);
        showNotification('Error updating vehicle. Please try again.', 'error');
    }
}

function clearVehicleForm() {
    const form = document.getElementById('addVehicleForm');
    if (form) {
        form.reset();
        
        // Clear any error states
        const errorElements = form.querySelectorAll('.error.show');
        errorElements.forEach(error => {
            error.classList.remove('show');
        });
        
        // Remove any current attachment info
        const attachmentInfos = form.querySelectorAll('.current-attachment-info');
        attachmentInfos.forEach(info => info.remove());
        
        // Reset modal to add mode
        const modal = document.getElementById('addVehicleModal');
        if (modal) {
            modal.removeAttribute('data-edit-mode');
            modal.removeAttribute('data-vehicle-id');
            
            // Reset modal title
            const modalTitle = modal.querySelector('.modal-header h5');
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-plus"></i> Add New Vehicle';
            }
            
            // Reset submit button text
            const submitBtn = modal.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Save Vehicle';
            }
        }
        
        // Repopulate dropdowns
        populateVehicleSelects();
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
    }
}

function displayVehicleInTable(vehicleData, vehicleId) {
    const tbody = document.getElementById('vehicleTableBody');
    
    // Check if vehicle already exists in table
    const existingRow = tbody.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
    if (existingRow) {
        // Update existing row
        updateVehicleRow(existingRow, vehicleData, vehicleId);
        return;
    }
    
    // Create new row
    const row = document.createElement('tr');
    const idx = tbody.children.length + 1;
    
    row.setAttribute('data-vehicle-id', vehicleId);
    row.setAttribute('data-vehicle-info', JSON.stringify(vehicleData));
    
    // Use original table columns for compatibility
    row.innerHTML = `
        <td>${idx}</td>
        <td>${vehicleData.vehicleName || vehicleData.name || ''}</td>
        <td>${vehicleData.plateNumber || ''}</td>
        <td>${vehicleData.vehicleType || ''}</td>
        <td>${vehicleData.vehicleModel || ''}</td>
        <td>${vehicleData.vehicleStatus || vehicleData.status || ''}</td>
    <td>${vehicleData.assignmentDept || vehicleData.assignmentDepartment || vehicleData.department || ''}</td>
    <td>${vehicleData.siteAssignment || vehicleData.workArea || vehicleData.site || ''}</td>
        <td>${vehicleData.fuelType || ''}</td>
        <td>${vehicleData.securingStatus || ''}</td>
        <td>${vehicleData.tankCapacity || ''}</td>
        <td class="actions-cell">
            <div class="action-buttons">
                <button class="btn-action btn-edit" onclick="editVehicleFromTable('${vehicleId}')" title="Edit Vehicle">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-action btn-delete" onclick="deleteVehicle('${vehicleId}')" title="Delete Vehicle">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    // Add click event listener for vehicle details
    row.addEventListener('click', function(event) {
        // Prevent row click when clicking on interactive elements
        if (!event.target.closest('input') && 
            !event.target.closest('.action-buttons') && 
            !event.target.closest('button')) {
            openVehicleDetailsModal(vehicleId);
        }
    });
    
    // Mark as having click listener and add styling
    row.setAttribute('data-click-listener', 'true');
    row.title = 'Click to view vehicle details';
    row.style.cursor = 'pointer';
    
    tbody.appendChild(row);
    updateEmptyState();
}

function updateVehicleRow(row, vehicleData, vehicleId) {
    row.setAttribute('data-vehicle-info', JSON.stringify(vehicleData));
    
    const cells = row.querySelectorAll('td');
    if (cells.length >= 12) {
        cells[1].textContent = vehicleData.vehicleName || vehicleData.name || '';
        cells[2].textContent = vehicleData.plateNumber || '';
        cells[3].textContent = vehicleData.vehicleType || '';
        cells[4].textContent = vehicleData.vehicleModel || '';
        cells[5].textContent = vehicleData.vehicleStatus || vehicleData.status || '';
    cells[6].textContent = vehicleData.assignmentDept || vehicleData.assignmentDepartment || vehicleData.department || '';
    cells[7].textContent = vehicleData.siteAssignment || vehicleData.workArea || vehicleData.site || '';
        cells[8].textContent = vehicleData.fuelType || '';
        cells[9].textContent = vehicleData.securingStatus || '';
        cells[10].textContent = vehicleData.tankCapacity || '';
        
        // Update actions column if it doesn't exist
        if (!cells[11].querySelector('.action-buttons')) {
            cells[11].className = 'actions-cell';
            cells[11].innerHTML = `
                <div class="action-buttons">
                    <button class="btn-action btn-edit" onclick="editVehicleFromTable('${vehicleId}')" title="Edit Vehicle">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action btn-view" onclick="openVehicleDetailsModal('${vehicleId}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteVehicle('${vehicleId}')" title="Delete Vehicle">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
    }
    
    // Ensure click event listener exists
    if (!row.hasAttribute('data-click-listener')) {
        row.addEventListener('click', function(event) {
            if (!event.target.closest('input') && 
                !event.target.closest('.action-buttons') && 
                !event.target.closest('button')) {
                openVehicleDetailsModal(vehicleId);
            }
        });
        row.setAttribute('data-click-listener', 'true');
        row.title = 'Click to view vehicle details';
        row.style.cursor = 'pointer';
    }
}

function updateEmptyState(){ 
    const tbody=document.getElementById('vehicleTableBody'); 
    const empty=document.getElementById('vehicleEmptyState'); 
    if(!empty) return; 
    if(tbody.rows.length===0){ 
        empty.style.display='block'; 
    } else { 
        empty.style.display='none'; 
    } 
}

// Real-time vehicle data loading and listening
async function initializeVehicleData() {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            console.log(' Waiting for authentication...');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehiclesRef = database.ref(`companies/${companyId}/vehicles`);
        
        console.log(' Setting up real-time vehicle data for company:', companyId);
        
        // Listen for vehicle changes in real-time
        vehiclesRef.on('child_added', (snapshot) => {
            const vehicleData = snapshot.val();
            const vehicleId = snapshot.key;
            console.log(' Vehicle added:', vehicleId, vehicleData);
            displayVehicleInTable(vehicleData, vehicleId);
        });
        
        vehiclesRef.on('child_changed', (snapshot) => {
            const vehicleData = snapshot.val();
            const vehicleId = snapshot.key;
            console.log(' Vehicle updated:', vehicleId, vehicleData);
            displayVehicleInTable(vehicleData, vehicleId);
        });
        
        vehiclesRef.on('child_removed', (snapshot) => {
            const vehicleId = snapshot.key;
            console.log(' Vehicle removed:', vehicleId);
            removeVehicleFromTable(vehicleId);
        });
        
        console.log(' Real-time vehicle listeners established');
        
    } catch (error) {
        console.error(' Error setting up vehicle data:', error);
    }
}

function removeVehicleFromTable(vehicleId) {
    const tbody = document.getElementById('vehicleTableBody');
    const row = tbody.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
    if (row) {
        row.remove();
        // Re-number the remaining rows
        renumberTableRows();
        updateEmptyState();
    }
}

function renumberTableRows() {
    const tbody = document.getElementById('vehicleTableBody');
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const firstCell = row.querySelector('td');
        if (firstCell) {
            firstCell.textContent = index + 1;
        }
    });
}

// Notification system for user feedback
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Close button functionality
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

function getNotificationIcon(type) {
    switch (type) {
        case 'success': return 'fa-check-circle';
        case 'error': return 'fa-exclamation-circle';
        case 'warning': return 'fa-exclamation-triangle';
        default: return 'fa-info-circle';
    }
}
updateEmptyState();

// Vehicle Details Modal Functions
let currentVehicleId = null;
let currentVehicleData = null;

function openVehicleDetailsModal(vehicleId) {
    console.log(' Opening vehicle details modal for vehicleId:', vehicleId);
    currentVehicleId = vehicleId;
    console.log(' Set currentVehicleId to:', currentVehicleId);
    
    // Create modal if it doesn't exist
    let modal = document.getElementById('vehicleDetailsModal');
    if (!modal) {
        modal = createVehicleDetailsModal();
    }
    
    // Show modal with loading state
    const content = document.getElementById('vehicleDetailsContent');
    content.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
            <p style="margin-top: 1rem; color: #666;">Loading vehicle details...</p>
        </div>
    `;
    
    modal.classList.add('show');
    
    // Fetch fresh data from Firebase
    fetchVehicleFromFirebase(vehicleId)
        .then(vehicleData => {
            if (!vehicleData) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #e74c3c;"></i>
                        <p style="margin-top: 1rem; color: #e74c3c;">Vehicle not found</p>
                    </div>
                `;
                return;
            }
            
            console.log(' Fresh vehicle data for details:', vehicleData);
            // Store vehicle data globally for PDF export
            currentVehicleData = vehicleData;
            // Populate modal content with fresh data
            content.innerHTML = generateVehicleDetailsHTML(vehicleData);
            
            // Set focus for accessibility
            const firstFocusable = modal.querySelector('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) firstFocusable.focus();
        })
        .catch(error => {
            console.error(' Error loading vehicle details:', error);
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #e74c3c;"></i>
                    <p style="margin-top: 1rem; color: #e74c3c;">Error loading vehicle details</p>
                </div>
            `;
        });
}

function closeVehicleDetailsModal() {
    const modal = document.getElementById('vehicleDetailsModal');
    if (modal) {
        modal.classList.remove('show');
    }
    currentVehicleId = null;
    currentVehicleData = null;
}

// PDF Export Function
function exportVehicleToPDF() {
    try {
        // Get current vehicle data from the modal
        const modal = document.getElementById('vehicleDetailsModal');
        if (!modal || !currentVehicleData) {
            showNotification('No vehicle data available for export', 'error');
            return;
        }

        showNotification('Generating PDF...', 'info');

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Company header
        doc.setFontSize(20);
        doc.setTextColor(44, 62, 80);
        doc.text('Dreamex Datalab HSE', 20, 25);
        
        doc.setFontSize(16);
        doc.text('Vehicle Details Report', 20, 35);

        // Vehicle title
        doc.setFontSize(14);
        doc.setTextColor(52, 73, 94);
        const vehicleTitle = `${currentVehicleData.plateNumber || 'N/A'} - ${currentVehicleData.vehicleType || 'Vehicle'}`;
        doc.text(vehicleTitle, 20, 50);

        // Current date
        doc.setFontSize(10);
        doc.setTextColor(127, 140, 141);
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(`Generated on: ${currentDate}`, 20, 60);

        // Vehicle Information Section
        let yPosition = 80;
        doc.setFontSize(12);
        doc.setTextColor(44, 62, 80);
        doc.text('Vehicle Information', 20, yPosition);
        
        // Draw line under section header
        doc.setDrawColor(52, 73, 94);
        doc.line(20, yPosition + 2, 190, yPosition + 2);
        
        yPosition += 15;
        doc.setFontSize(10);
        doc.setTextColor(85, 85, 85);

        // Vehicle details in two columns
        const leftColumnX = 20;
        const rightColumnX = 110;
        
        const vehicleInfo = [
            ['Plate Number:', currentVehicleData.plateNumber || 'N/A'],
            ['Vehicle Type:', currentVehicleData.vehicleType || 'N/A'],
            ['Make:', currentVehicleData.vehicleMake || 'N/A'],
            ['Model:', currentVehicleData.vehicleModel || 'N/A'],
            ['Year:', currentVehicleData.vehicleYear || 'N/A'],
            ['Status:', currentVehicleData.vehicleStatus || currentVehicleData.status || 'N/A']
        ];

        const assignmentInfo = [
            ['Department:', currentVehicleData.assignmentDept || 'N/A'],
            ['Site Assignment:', currentVehicleData.siteAssignment || 'N/A'],
            ['Assigned Driver:', currentVehicleData.assignedDriver || 'N/A'],
            ['Fuel Type:', currentVehicleData.fuelType || 'N/A'],
            ['Securing Status:', currentVehicleData.securingStatus || 'N/A'],
            ['Tank:', currentVehicleData.tankCapacity || 'N/A']
        ];

        // Left column
        vehicleInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], leftColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], leftColumnX + 35, yPosition + (index * 8));
        });

        // Right column
        assignmentInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], rightColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], rightColumnX + 35, yPosition + (index * 8));
        });

        // Technical Information Section
        yPosition += 60;
        doc.setFontSize(12);
        doc.setTextColor(44, 62, 80);
        doc.text('Technical Information', 20, yPosition);
        doc.line(20, yPosition + 2, 190, yPosition + 2);
        
        yPosition += 15;
        doc.setFontSize(10);
        doc.setTextColor(85, 85, 85);

        const technicalInfo = [
            ['VIN Number:', currentVehicleData.vinNumber || 'N/A'],
            ['Current Mileage:', currentVehicleData.currentMileage || 'N/A'],
            ['Engine Size:', currentVehicleData.engineSize || 'N/A'],
            ['Average Value:', currentVehicleData.averageValue || 'N/A']
        ];

        const documentInfo = [
            ['Insurance Expiry:', currentVehicleData.insuranceExpiry || 'N/A'],
            ['Registration Expiry:', currentVehicleData.registrationExpiry || 'N/A'],
            ['Asset Value:', currentVehicleData.assetValue || 'N/A'],
            ['Attachment:', currentVehicleData.vehicleAttachment ? 'Yes' : 'No']
        ];

        // Left column
        technicalInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], leftColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], leftColumnX + 35, yPosition + (index * 8));
        });

        // Right column
        documentInfo.forEach((item, index) => {
            doc.setFont(undefined, 'bold');
            doc.text(item[0], rightColumnX, yPosition + (index * 8));
            doc.setFont(undefined, 'normal');
            doc.text(item[1], rightColumnX + 35, yPosition + (index * 8));
        });

        // Notes Section
        if (currentVehicleData.vehicleNotes && currentVehicleData.vehicleNotes.trim()) {
            yPosition += 50;
            doc.setFontSize(12);
            doc.setTextColor(44, 62, 80);
            doc.text('Notes', 20, yPosition);
            doc.line(20, yPosition + 2, 190, yPosition + 2);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setTextColor(85, 85, 85);
            
            // Split notes into lines to fit page width
            const splitNotes = doc.splitTextToSize(currentVehicleData.vehicleNotes, 170);
            doc.text(splitNotes, 20, yPosition);
        }

        // Footer
        doc.setFontSize(8);
        doc.setTextColor(127, 140, 141);
        doc.text('Confidential - Dreamex Datalab HSE Fleet Management System', 20, 280);

        // Generate filename
        const plateNumber = currentVehicleData.plateNumber || 'Unknown';
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `Vehicle_${plateNumber}_${timestamp}.pdf`;

        // Save the PDF
        doc.save(filename);
        
        showNotification('PDF exported successfully', 'success');

    } catch (error) {
        console.error('Error generating PDF:', error);
        showNotification('Error generating PDF. Please try again.', 'error');
    }
}

function generateVehicleDetailsHTML(vehicle) {
    const formatValue = (value, fallback = 'Not specified') => value || fallback;
    const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric' 
    }) : 'Not specified';
    
    return `
        <div class="details-grid">
            <!-- Basic Vehicle Information -->
            <div class="detail-section">
                <h4><i class="fas fa-car"></i> Vehicle Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleName || vehicle.name)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Plate Number:</span>
                    <span class="detail-value">${formatValue(vehicle.plateNumber)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleType)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Make:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleMake)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Model:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleModel)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Year:</span>
                    <span class="detail-value">${formatValue(vehicle.vehicleYear)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value status-${(vehicle.vehicleStatus || '').toLowerCase()}">${formatValue(vehicle.vehicleStatus)}</span>
                </div>
            </div>
            
            <!-- Assignment Information -->
            <div class="detail-section">
                <h4><i class="fas fa-building"></i> Assignment</h4>
                <div class="detail-row">
                    <span class="detail-label">Company:</span>
                    <span class="detail-value">${formatValue(vehicle.selectedCompanyName)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Department:</span>
                    <span class="detail-value">${formatValue(vehicle.assignmentDept || vehicle.assignmentDepartment || vehicle.department)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Site:</span>
                    <span class="detail-value">${formatValue(vehicle.siteAssignment || vehicle.workArea || vehicle.site)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Assigned Driver:</span>
                    <span class="detail-value">${formatValue(vehicle.assignedDriver)}</span>
                </div>
            </div>
            
            <!-- Technical Specifications -->
            <div class="detail-section">
                <h4><i class="fas fa-cogs"></i> Technical Details</h4>
                <div class="detail-row">
                    <span class="detail-label">VIN Number:</span>
                    <span class="detail-value">${formatValue(vehicle.vinNumber)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Fuel Type:</span>
                    <span class="detail-value">${formatValue(vehicle.fuelType)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tank:</span>
                    <span class="detail-value">${formatValue(vehicle.tankCapacity)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Current Mileage:</span>
                    <span class="detail-value">${formatValue(vehicle.currentMileage)} km</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Average Consumption:</span>
                    <span class="detail-value">${formatValue(vehicle.engineSize)} - ${formatValue(vehicle.averageValue)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Securing Status:</span>
                    <span class="detail-value">${formatValue(vehicle.securingStatus)}</span>
                </div>
            </div>
            
            <!-- Safety Equipment -->
            <div class="detail-section">
                <h4><i class="fas fa-shield-alt"></i> Safety Equipment</h4>
                <div class="detail-row">
                    <span class="detail-label">Radio:</span>
                    <span class="detail-value">${formatValue(vehicle.radioStatus)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">GPS:</span>
                    <span class="detail-value">${formatValue(vehicle.gpsStatus)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Vignet Date:</span>
                    <span class="detail-value">${formatDate(vehicle.vignetDate)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Aid Kit:</span>
                    <span class="detail-value">${formatValue(vehicle.firstAidKit)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Aid Kit Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.firstAidKitExpiry)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Extinguisher Status:</span>
                    <span class="detail-value">${formatValue(vehicle.extinguisherStatus)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Extinguisher Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.extinguisherExpiry)}</span>
                </div>
            </div>
            
            <!-- Financial & Documentation -->
            <div class="detail-section">
                <h4><i class="fas fa-file-alt"></i> Documentation & Finance</h4>
                <div class="detail-row">
                    <span class="detail-label">Insurance Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.insuranceExpiry)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Registration Expiry:</span>
                    <span class="detail-value">${formatDate(vehicle.registrationExpiry)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Asset Value:</span>
                    <span class="detail-value">${vehicle.assetValue ? '$' + parseFloat(vehicle.assetValue).toLocaleString() : 'Not specified'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Attachment:</span>
                    <span class="detail-value">
                        ${vehicle.vehicleAttachment ? 
                            `<div class="attachment-info">
                                <div class="attachment-item">
                                    <i class="fas fa-paperclip"></i>
                                    <span class="attachment-name">${getAttachmentName(vehicle.vehicleAttachment)}</span>
                                    <div class="attachment-actions">
                                        <button class="btn-link" onclick="viewAttachment('${vehicle.vehicleAttachment}', '${getAttachmentName(vehicle.vehicleAttachment)}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn-link" onclick="downloadAttachment('${vehicle.vehicleAttachment}', '${getAttachmentName(vehicle.vehicleAttachment)}')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>` 
                            : '<span class="no-attachment">No attachment</span>'
                        }
                    </span>
                </div>
            </div>
            
            <!-- Additional Notes -->
            ${vehicle.vehicleNotes ? `
            <div class="detail-section full-width">
                <h4><i class="fas fa-sticky-note"></i> Notes</h4>
                <div class="detail-notes">
                    ${vehicle.vehicleNotes}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

function editVehicle() {
    console.log(' Edit vehicle called, currentVehicleId:', currentVehicleId);
    
    if (!currentVehicleId) {
        showNotification('No vehicle selected for editing', 'error');
        return;
    }
    
    // Close the details modal first
    closeVehicleDetailsModal();
    
    // Fetch fresh data from Firebase
    fetchVehicleFromFirebase(currentVehicleId)
        .then(vehicleData => {
            if (!vehicleData) {
                showNotification('Vehicle data not found in database', 'error');
                return;
            }
            
            console.log(' Fresh vehicle data from Firebase:', vehicleData);
            // Open the edit modal with fresh data
            openEditVehicleModal(vehicleData, currentVehicleId);
        })
        .catch(error => {
            console.error(' Error fetching vehicle data:', error);
            showNotification('Error loading vehicle data', 'error');
        });
}

async function fetchVehicleFromFirebase(vehicleId) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            throw new Error('Authentication required');
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehicleRef = database.ref(`companies/${companyId}/vehicles/${vehicleId}`);
        
        console.log(' Fetching vehicle from Firebase:', vehicleId);
        
        const snapshot = await vehicleRef.once('value');
        const vehicleData = snapshot.val();
        
        console.log(' Firebase returned:', vehicleData);
        return vehicleData;
        
    } catch (error) {
        console.error(' Error fetching vehicle from Firebase:', error);
        throw error;
    }
}

function openEditVehicleModal(vehicleData, vehicleId) {
    // Create or get the modal
    let modal = document.getElementById('addVehicleModal');
    if (!modal) {
        modal = createAddVehicleModal();
    }
    
    // Update modal title to indicate edit mode
    const modalTitle = modal.querySelector('.modal-header h5');
    if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Vehicle';
    }
    
    // Update submit button text
    const submitBtn = modal.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.textContent = 'Update Vehicle';
    }
    
    // Populate form fields with existing data
    populateEditForm(vehicleData);
    
    // Set edit mode flag and vehicle ID
    modal.setAttribute('data-edit-mode', 'true');
    modal.setAttribute('data-vehicle-id', vehicleId);
    
    // Show the modal
    modal.classList.add('show');
    
    // Focus first input
    const firstInput = modal.querySelector('input, select');
    if (firstInput) firstInput.focus();
}

function populateEditForm(vehicleData) {
    console.log(' Populating edit form with data:', vehicleData);
    
    // Populate all form fields with existing vehicle data
    const fieldMappings = {
        'vehicleName': vehicleData.vehicleName || vehicleData.name,
        'plateNumber': vehicleData.plateNumber,
        'vehicleType': vehicleData.vehicleType,
        'vehicleMake': vehicleData.vehicleMake,
        'vehicleModel': vehicleData.vehicleModel,
        'vehicleYear': vehicleData.vehicleYear,
        'vehicleStatus': vehicleData.vehicleStatus || vehicleData.status,
        'assignmentDept': vehicleData.assignmentDept,
        'siteAssignment': vehicleData.siteAssignment,
        'fuelType': vehicleData.fuelType,
        'securingStatus': vehicleData.securingStatus,
        'tankCapacity': vehicleData.tankCapacity,
        'vinNumber': vehicleData.vinNumber,
        'currentMileage': vehicleData.currentMileage,
        'engineSize': vehicleData.engineSize,
        'averageValue': vehicleData.averageValue,
        'assignedDriver': vehicleData.assignedDriver,
        'insuranceExpiry': vehicleData.insuranceExpiry,
        'registrationExpiry': vehicleData.registrationExpiry,
        'assetValue': vehicleData.assetValue,
        'vehicleNotes': vehicleData.vehicleNotes,
        'radioStatus': vehicleData.radioStatus,
        'gpsStatus': vehicleData.gpsStatus,
        'vignetDate': vehicleData.vignetDate,
        'firstAidKit': vehicleData.firstAidKit,
        'firstAidKitExpiry': vehicleData.firstAidKitExpiry,
        'extinguisherStatus': vehicleData.extinguisherStatus,
        'extinguisherExpiry': vehicleData.extinguisherExpiry
    };
    
    // Handle attachment display for edit mode
    handleAttachmentInEditMode(vehicleData.vehicleAttachment);
    
    // Repopulate dropdowns first, then set values
    populateVehicleSelects().then(() => {
        // Set each field value after dropdowns are populated
        Object.keys(fieldMappings).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const value = fieldMappings[fieldId];
            
            if (field && value !== undefined && value !== null && value !== '') {
                field.value = value;
                console.log(` Set ${fieldId} = ${value}`);
            }
        });

        // Set company selection if present
        const compSel = document.getElementById('companySelect');
        const selectedCompanyId = vehicleData.selectedCompanyId || vehicleData.companySelect || window.authManager?.currentUser?.companyId;
        if (compSel && selectedCompanyId) {
            compSel.value = selectedCompanyId;
        }
        
        // Handle make/model relationship with proper timing
        if (vehicleData.vehicleMake) {
            console.log(' Setting vehicle make:', vehicleData.vehicleMake);
            
            // Set the make first
            const makeField = document.getElementById('vehicleMake');
            if (makeField) {
                makeField.value = vehicleData.vehicleMake;
                
                // Then update models and set the model
                updateModelsForMake(vehicleData.vehicleMake);
                
                // Set model after a brief delay to ensure options are populated
                setTimeout(() => {
                    const modelField = document.getElementById('vehicleModel');
                    if (modelField && vehicleData.vehicleModel) {
                        modelField.value = vehicleData.vehicleModel;
                        console.log(` Set vehicleModel = ${vehicleData.vehicleModel}`);
                    }
                }, 100);
            }
        }
    });
}

function handleAttachmentInEditMode(attachmentUrl) {
    const attachmentInput = document.getElementById('vehicleAttachment');
    const attachmentContainer = attachmentInput?.parentElement;
    
    if (!attachmentContainer) return;
    
    // Remove any existing attachment info
    const existingInfo = attachmentContainer.querySelector('.current-attachment-info');
    if (existingInfo) {
        existingInfo.remove();
    }
    
    if (attachmentUrl) {
        // Create attachment info display
        const attachmentInfo = document.createElement('div');
        attachmentInfo.className = 'current-attachment-info';
        attachmentInfo.style.cssText = `
            margin-top: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        `;
        
        const attachmentName = getAttachmentName(attachmentUrl);
        attachmentInfo.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <i class="fas fa-paperclip" style="margin-right: 5px; color: #6c757d;"></i>
                    <strong>Current:</strong> ${attachmentName}
                </div>
                <div>
                    <button type="button" class="btn-link" onclick="viewAttachment('${attachmentUrl}', '${attachmentName}')" style="font-size: 11px; padding: 2px 6px; margin-right: 5px;">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button type="button" class="btn-link" onclick="downloadAttachment('${attachmentUrl}', '${attachmentName}')" style="font-size: 11px; padding: 2px 6px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
            <div style="margin-top: 4px; font-size: 11px; color: #6c757d;">
                Select a new file to replace the current attachment
            </div>
        `;
        
        // Insert after the input field
        attachmentContainer.insertBefore(attachmentInfo, attachmentInput.nextSibling);
    }
}

// Edit vehicle directly from table action button
function editVehicleFromTable(vehicleId) {
    console.log(' Edit vehicle from table, vehicleId:', vehicleId);
    currentVehicleId = vehicleId;
    
    // Fetch fresh data from Firebase and open edit modal
    fetchVehicleFromFirebase(vehicleId)
        .then(vehicleData => {
            if (!vehicleData) {
                showNotification('Vehicle data not found in database', 'error');
                return;
            }
            
            console.log(' Fresh vehicle data from Firebase:', vehicleData);
            // Open the edit modal with fresh data
            openEditVehicleModal(vehicleData, vehicleId);
        })
        .catch(error => {
            console.error(' Error fetching vehicle data:', error);
            showNotification('Error loading vehicle data', 'error');
        });
}

// Delete vehicle function
function deleteVehicle(vehicleId) {
    // Get vehicle data for confirmation message
    fetchVehicleFromFirebase(vehicleId)
        .then(vehicleData => {
            if (!vehicleData) {
                showNotification('Vehicle not found', 'error');
                return;
            }
            
            const vehicleName = vehicleData.plateNumber || 'Unknown Vehicle';
            const vehicleType = vehicleData.vehicleType || 'Vehicle';
            
            // Show custom confirmation modal
            showDeleteConfirmation(vehicleId, vehicleName, vehicleType, vehicleData);
        })
        .catch(error => {
            console.error(' Error fetching vehicle for deletion:', error);
            showNotification('Error loading vehicle data', 'error');
        });
}

function showDeleteConfirmation(vehicleId, vehicleName, vehicleType, vehicleData) {
    // Create confirmation modal
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal confirmation-modal';
    confirmModal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Confirm Deletion</h5>
                <button class="close-btn" onclick="closeDeleteConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation-content">
                    <div class="vehicle-info">
                        <h6>You are about to delete:</h6>
                        <div class="vehicle-details">
                            <strong>${vehicleName}</strong> (${vehicleType})<br>
                            <small>Make: ${vehicleData.vehicleMake || 'N/A'} | Model: ${vehicleData.vehicleModel || 'N/A'}</small>
                        </div>
                    </div>
                    <div class="warning-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone. All vehicle data will be permanently removed.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmation()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete('${vehicleId}', '${vehicleName}')">
                    <i class="fas fa-trash"></i> Delete Vehicle
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmModal);
    confirmModal.classList.add('show');
    
    // Focus the delete button for keyboard navigation
    setTimeout(() => {
        const deleteBtn = confirmModal.querySelector('.btn-danger');
        if (deleteBtn) deleteBtn.focus();
    }, 100);
}

function closeDeleteConfirmation() {
    const modal = document.querySelector('.confirmation-modal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        }, 300);
    }
}

function confirmDelete(vehicleId, vehicleName) {
    closeDeleteConfirmation();
    deleteVehicleFromFirebase(vehicleId, vehicleName);
}

async function deleteVehicleFromFirebase(vehicleId, vehicleName) {
    try {
        if (!window.authManager || !window.authManager.currentUser || !window.authManager.currentUser.companyId) {
            showNotification('Authentication required to delete vehicle', 'error');
            return;
        }
        
        const companyId = window.authManager.currentUser.companyId;
        const database = firebase.database();
        const vehicleRef = database.ref(`companies/${companyId}/vehicles/${vehicleId}`);
        
        console.log(' Deleting vehicle from Firebase:', vehicleId);
        
        // Delete from Firebase (this will trigger real-time listeners)
        await vehicleRef.remove();
        
        console.log(' Vehicle deleted successfully:', vehicleId);
        showNotification(`Vehicle "${vehicleName}" deleted successfully`, 'success');
        
    } catch (error) {
        console.error(' Error deleting vehicle from Firebase:', error);
        showNotification('Error deleting vehicle. Please try again.', 'error');
    }
}

// Attachment handling functions
function getAttachmentName(attachmentPath) {
    if (!attachmentPath) return 'Attachment';
    
    // If it's an object with name property (metadata)
    if (typeof attachmentPath === 'object' && attachmentPath.name) {
        return attachmentPath.name;
    }
    
    // If it's a Firebase Storage URL, extract filename
    if (typeof attachmentPath === 'string') {
        // Handle Firebase Storage URLs
        if (attachmentPath.includes('firebasestorage.googleapis.com')) {
            try {
                // Extract filename from Firebase Storage URL
                const url = new URL(attachmentPath);
                const pathname = decodeURIComponent(url.pathname);
                
                // Firebase Storage URLs have format: /v0/b/bucket/o/path%2Fto%2Ffile.ext
                const parts = pathname.split('/');
                if (parts.length > 4) {
                    const filePath = parts[parts.length - 1];
                    // Remove Firebase prefixes and get actual filename
                    const fileName = filePath.split('/').pop();
                    
                    // Remove timestamp prefix if present (e.g., "1234567890_filename.pdf" -> "filename.pdf")
                    if (fileName.includes('_')) {
                        const withoutTimestamp = fileName.substring(fileName.indexOf('_') + 1);
                        return withoutTimestamp || fileName;
                    }
                    
                    return fileName;
                }
            } catch (error) {
                console.warn('Error parsing Firebase Storage URL:', error);
            }
        }
        
        // Fallback for regular URLs or paths
        const parts = attachmentPath.split('/');
        const fileName = parts[parts.length - 1];
        // Remove any query parameters
        return fileName.split('?')[0] || 'Attachment';
    }
    
    return 'Attachment';
}

function viewAttachment(attachmentUrl, fileName) {
    if (!attachmentUrl) {
        showNotification('No attachment available', 'warning');
        return;
    }
    
    try {
        // Get file extension to determine how to handle viewing
        const fileExtension = fileName.toLowerCase().split('.').pop();
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
        const documentExtensions = ['pdf', 'doc', 'docx', 'txt'];
        
        if (imageExtensions.includes(fileExtension)) {
            // For images, create a modal viewer
            openImageViewer(attachmentUrl, fileName);
        } else if (documentExtensions.includes(fileExtension)) {
            // For documents, open in new tab with view intent
            const viewUrl = attachmentUrl + '#view=FitH';
            const newWindow = window.open(viewUrl, '_blank', 'noopener,noreferrer');
            
            if (!newWindow) {
                showNotification('Please allow popups to view attachments', 'warning');
                // Fallback: try to open in same tab
                window.open(attachmentUrl, '_blank');
            } else {
                showNotification('Opening document viewer...', 'info');
            }
        } else {
            // For other file types, open in new tab
            const newWindow = window.open(attachmentUrl, '_blank', 'noopener,noreferrer');
            
            if (!newWindow) {
                showNotification('Please allow popups to view attachments', 'warning');
                // Fallback: try direct download
                downloadAttachment(attachmentUrl, fileName);
            } else {
                showNotification('Opening file viewer...', 'info');
            }
        }
    } catch (error) {
        console.error('Error viewing attachment:', error);
        showNotification('Error opening attachment', 'error');
    }
}

function openImageViewer(imageUrl, fileName) {
    // Create image viewer modal
    const imageModal = document.createElement('div');
    imageModal.className = 'modal image-viewer-modal';
    imageModal.innerHTML = `
        <div class="modal-content image-viewer-content">
            <div class="modal-header">
                <h5><i class="fas fa-image"></i> ${fileName}</h5>
                <button class="close-btn" onclick="closeImageViewer()">&times;</button>
            </div>
            <div class="modal-body image-viewer-body">
                <img src="${imageUrl}" alt="${fileName}" class="viewer-image" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageViewer()">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadAttachment('${imageUrl}', '${fileName}')">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(imageModal);
    imageModal.classList.add('show');
    
    // Close on click outside
    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            closeImageViewer();
        }
    });
    
    // Close on Escape key
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            closeImageViewer();
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}

function closeImageViewer() {
    const imageModal = document.querySelector('.image-viewer-modal');
    if (imageModal) {
        imageModal.classList.remove('show');
        setTimeout(() => {
            if (imageModal.parentNode) {
                imageModal.parentNode.removeChild(imageModal);
            }
        }, 300);
    }
}

function downloadAttachment(attachmentUrl, fileName) {
    if (!attachmentUrl) {
        showNotification('No attachment available', 'warning');
        return;
    }
    
    try {
        // Create temporary link element for download
        const link = document.createElement('a');
        link.href = attachmentUrl;
        link.download = fileName || 'vehicle-attachment';
        link.target = '_blank';
        
        // Append to body, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Download started', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showNotification('Error downloading attachment', 'error');
    }
}

// FAB open
const addVehicleFab=document.getElementById('addVehicleFab'); addVehicleFab.addEventListener('click',()=>openAddVehicleModal());

// Global dismissal
window.addEventListener('click',e=>{ const modal=document.getElementById('addVehicleModal'); if(modal && e.target===modal){ closeVehicleModal(); }});
window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ const modal=document.getElementById('addVehicleModal'); if(modal && modal.classList.contains('show')){ closeVehicleModal(); }} });

function trapFocus(container){ const focusableSelectors='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'; const focusable=Array.from(container.querySelectorAll(focusableSelectors)); if(focusable.length===0) return; let first=focusable[0]; let last=focusable[focusable.length-1]; container.addEventListener('keydown',e=>{ if(e.key==='Tab'){ if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } } }); }

// Enhanced menu visibility system based on roles.html template

// Reset all menu items to hidden
function resetMenuVisibility() {
    document.querySelectorAll('[data-feature]').forEach(item => {
        item.classList.remove('menu-visible');
    });
    document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
        dropdown.classList.remove('menu-visible');
    });
}

// Emergency fallback - show basic menu items
function showBasicMenu() {
    console.log(' Emergency fallback: Showing basic menu items');
    resetMenuVisibility();
    
    // Remove loading class
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.remove('menu-loading');
    }
    
    const homeItem = document.querySelector('[data-feature="home_view"]');
    if (homeItem) {
        homeItem.classList.add('menu-visible');
    }
}

// Feature-based authorization system that takes priority over role permissions
async function updateMenuWithFeatureAuthorization() {
    console.log(' Starting feature-based menu authorization for fleet.html...');
    
    try {
        let currentUser = null;
        let companyId = null;
        
        // Get user and company info using authManager first
        if (window.authManager && window.authManager.currentUser) {
            currentUser = window.authManager.currentUser;
            companyId = currentUser.companyId;
            console.log(' Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
        } else if (firebase.auth().currentUser) {
            currentUser = firebase.auth().currentUser;
            console.log(' Using Firebase auth - will search for company');
        } else {
            console.log(' No authenticated user found');
            resetMenuVisibility();
            return;
        }
        
        // If no company ID from authManager, search companies collection
        if (!companyId && currentUser) {
            console.log(' Searching for user company...');
            const database = firebase.database();
            const companiesRef = database.ref('companies');
            const companiesSnapshot = await companiesRef.once('value');
            
            if (companiesSnapshot.exists()) {
                const companies = companiesSnapshot.val();
                
                for (const [cId, company] of Object.entries(companies)) {
                    if (company.status !== 'active') continue;
                    
                    if (company.users && company.users[currentUser.uid]) {
                        companyId = cId;
                        console.log(` Found user in company: ${companyId} (${company.name})`);
                        break;
                    }
                }
            }
        }
        
        if (!companyId) {
            console.error(' No company ID found, cannot determine authorized features');
            resetMenuVisibility();
            return;
        }
        
        // Apply feature-based authorization first (company subscription)
        await applyFeatureBasedMenuVisibility(companyId);

        // Then refine with role-based permissions (intersection)
        try {
            await applyRoleBasedFiltering(companyId, currentUser);
        } catch (rbErr) {
            console.warn(' Role-based filtering failed, keeping feature-based visibility only:', rbErr);
        }
        
    } catch (error) {
        console.error(' Error in feature-based menu authorization:', error);
        resetMenuVisibility();
    }
}

async function applyFeatureBasedMenuVisibility(companyId) {
    try {
        console.log(' Applying feature-based menu visibility for company:', companyId);
        
        // Get platform features
        const database = firebase.database();
        const featuresSnapshot = await database.ref('/platformFeatures').once('value');
        
        if (!featuresSnapshot.exists()) {
            console.log(' No platform features found');
            resetMenuVisibility();
            return;
        }
        
        const featuresData = featuresSnapshot.val();
        
        // Get company's selected features
        const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
        const companyData = companySnapshot.val();
        
        if (!companyData) {
            console.error(' Company data not found');
            resetMenuVisibility();
            return;
        }
        
        const subscribedFeatureIds = companyData.selectedFeatures || [];
        console.log(' Company subscribed features:', subscribedFeatureIds);
        
        if (subscribedFeatureIds.length === 0) {
            console.log(' Company has no subscribed features');
            resetMenuVisibility();
            return;
        }
        
        // Collect authorized pages from subscribed features
        const authorizedPages = [];
        subscribedFeatureIds.forEach(featureId => {
            const feature = featuresData[featureId];
            if (feature && feature.status === 'active' && feature.authorizedPages) {
                console.log(` Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                authorizedPages.push(...feature.authorizedPages);
            } else {
                console.log(` Feature ${featureId} not found or inactive`);
            }
        });
        
        console.log(' All authorized pages:', authorizedPages);
        
        // Reset all menu items first
        resetMenuVisibility();
        
        // Create set of authorized features
        const authorizedFeatures = new Set();
        authorizedPages.forEach(pageInfo => {
            if (pageInfo.feature) {
                authorizedFeatures.add(pageInfo.feature);
            }
        });
        
        console.log(' Authorized features for fleet.html:', Array.from(authorizedFeatures));
        
        // Apply menu visibility
        const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
        let visibleCount = 0;
        
        allMenuItems.forEach(menuItem => {
            const featureAttribute = menuItem.getAttribute('data-feature');
            const isAuthorized = authorizedFeatures.has(featureAttribute);
            const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
            
            if (isDropdownContainer) {
                return; // Handle dropdowns separately after all items are processed
            }
            
            if (isAuthorized) {
                menuItem.classList.add('menu-visible');
                visibleCount++;
                console.log(` Authorized: ${featureAttribute}`);
            } else {
                console.log(` Not authorized: ${featureAttribute}`);
            }
        });
        
        // Handle dropdown menus - show dropdown if any child is visible
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            const children = dropdown.querySelectorAll('li[data-feature].menu-visible');
            if (children.length > 0) {
                dropdown.classList.add('menu-visible');
                console.log(` Dropdown visible (${children.length} visible children)`);
            }
        });
        
    // Do not remove loading class here; wait for role-based filtering to finish to avoid flicker
    console.log(` Feature-based authorization complete. Candidate visible items: ${visibleCount}`);
        
    } catch (error) {
        console.error(' Error applying feature-based menu visibility:', error);
        resetMenuVisibility();
    }
}

// Role-based filtering: keep only items allowed by the user's role
async function applyRoleBasedFiltering(companyId, currentUser) {
    const database = firebase.database();
    let role = currentUser && currentUser.role;
    const uid = currentUser && (currentUser.uid || currentUser.authUid || currentUser.userId);

    try {
        // Try to resolve role from company user record if not present
        if (!role && uid) {
            const userSnap = await database.ref(`/companies/${companyId}/users/${uid}`).once('value');
            const userRec = userSnap.val() || {};
            role = userRec.role || userRec.assignedRole || userRec.userRole || role;
        }

        if (!role) {
            console.warn(' No role found for current user; skipping role filter');
            return;
        }

        // Fetch permissions for the role
        const permsSnap = await database.ref(`companies/${companyId}/roles/${role}/permissions`).once('value');
        const permissions = permsSnap.val() || {};

        // Build set of allowed features by role
        const allowedByRole = new Set();
        Object.entries(permissions).forEach(([featureKey, value]) => {
            if (value === true) allowedByRole.add(featureKey);
            else if (value && typeof value === 'object' && value.view === true) allowedByRole.add(featureKey);
        });

        // Intersect: only keep items already visible (feature-based) AND allowed by role
        const visibleItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-feature]');
        let kept = 0, removed = 0;
        visibleItems.forEach(item => {
            const featureKey = item.getAttribute('data-feature');
            const requires = item.getAttribute('data-requires-permission');
            const okByFeature = allowedByRole.has(featureKey);
            const okByRequires = requires ? allowedByRole.has(requires) : true;
            if (okByFeature && okByRequires) {
                kept++;
            } else {
                item.classList.remove('menu-visible');
                removed++;
            }
        });

    // Recompute dropdown visibility based on remaining children
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            const children = dropdown.querySelectorAll('li[data-feature].menu-visible');
            if (children.length > 0) dropdown.classList.add('menu-visible');
            else dropdown.classList.remove('menu-visible');
        });

        // Always keep Home visible
        const homeItem = document.querySelector('[data-feature="home_view"]');
        if (homeItem) homeItem.classList.add('menu-visible');

    // Remove loading class now that both phases are done
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.remove('menu-loading');

        if (kept === 0) {
            console.log(' After role filter, no items visible; showing basic menu');
            showBasicMenu();
        } else {
            console.log(` Role-based filtering applied. Kept: ${kept}, Removed: ${removed}`);
        }
    } catch (err) {
        console.error(' Error during role-based filtering:', err);
        // On error, fall back to feature-based result already applied
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.remove('menu-loading');
    }
}

// Make updateMenuWithFeatureAuthorization available globally
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

// Initialize menu system when page loads
document.addEventListener('DOMContentLoaded', async function() {
    console.log(' Fleet.html DOM loaded - menu authorization will be handled by AuthManager');
    
    // Set up listener for field options changes from settings.html
    setupFieldOptionsListener();
    
    // Load departments and work areas from company scope for current company
    const user = window.authManager?.currentUser;
    if (user && user.companyId) {
        console.log(' Initializing company scope field options for fleet management...');
        try {
            // Check for latest version data from company scope first
            const latestDepartments = localStorage.getItem(`fieldOptionsLatest_${user.companyId}_department`);
            const latestAreas = localStorage.getItem(`fieldOptionsLatest_${user.companyId}_area`);
            
            if (latestDepartments) {
                try {
                    const latestDeptData = JSON.parse(latestDepartments);
                    if (latestDeptData.options && Array.isArray(latestDeptData.options)) {
                        departmentOptions = latestDeptData.options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        console.log(' Departments loaded from company scope latest version:', departmentOptions);
                    }
                } catch (error) {
                    console.warn('Error parsing latest department data:', error);
                }
            }
            
            if (latestAreas) {
                try {
                    const latestAreaData = JSON.parse(latestAreas);
                    if (latestAreaData.options && Array.isArray(latestAreaData.options)) {
                        siteOptions = latestAreaData.options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        console.log(' Work areas loaded from company scope latest version:', siteOptions);
                    }
                } catch (error) {
                    console.warn('Error parsing latest area data:', error);
                }
            }
            
            // Load from company scope if latest versions not available
            if (!departmentOptions || departmentOptions.length === 0) {
                await loadDepartmentsFromSettings(user.companyId);
            }
            if (!siteOptions || siteOptions.length === 0) {
                await loadWorkAreasFromSettings(user.companyId);
            }
            
            console.log(' Company scope field options initialized for fleet');
        } catch (error) {
            console.error(' Error loading company scope field options:', error);
        }
    }
});

// Set up listener for real-time field options updates
function setupFieldOptionsListener() {
    // Listen for BroadcastChannel updates from settings.html
    if (typeof BroadcastChannel !== 'undefined') {
        try {
            const channel = new BroadcastChannel('fieldOptionsUpdates');
            channel.addEventListener('message', (event) => {
                const { fieldType, companyId, options } = event.data;
                
                // Handle area field updates
                if (fieldType === 'area' && 
                    companyId === window.authManager?.currentUser?.companyId) {
                    console.log(' Received work areas update from settings.html');
                    
                    // Update site options
                    if (Array.isArray(options)) {
                        siteOptions = options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        
                        console.log(' Updated work areas in fleet management:', siteOptions);
                        
                        // Refresh the dropdown if modal is open
                        populateVehicleSelects();
                    }
                }
                
                // Handle department field updates
                if (fieldType === 'department' && 
                    companyId === window.authManager?.currentUser?.companyId) {
                    console.log(' Received departments update from settings.html');
                    
                    // Update department options
                    if (Array.isArray(options)) {
                        departmentOptions = options
                            .filter(option => option.enabled !== false)
                            .map(option => option.label || option.value || option)
                            .filter(Boolean);
                        
                        console.log(' Updated departments in fleet management:', departmentOptions);
                        
                        // Refresh the dropdown if modal is open
                        populateVehicleSelects();
                    }
                }
            });
            console.log(' Field options listener set up for fleet management');
        } catch (error) {
            console.warn('BroadcastChannel not available:', error);
        }
    }
    
    // Listen for localStorage changes (fallback)
    window.addEventListener('storage', (event) => {
        const companyId = window.authManager?.currentUser?.companyId;
        
        // Handle area field changes
        if (event.key && event.key.startsWith('fieldOptionsChange_area_')) {
            try {
                const changeData = JSON.parse(event.newValue);
                if (changeData.companyId === companyId) {
                    console.log(' Received work areas update via localStorage');
                    // Reload work areas from settings
                    if (companyId) {
                        loadWorkAreasFromSettings(companyId);
                    }
                }
            } catch (error) {
                console.warn('Error parsing localStorage change event:', error);
            }
        }
        
        // Handle department field changes
        if (event.key && event.key.startsWith('fieldOptionsChange_department_')) {
            try {
                const changeData = JSON.parse(event.newValue);
                if (changeData.companyId === companyId) {
                    console.log(' Received departments update via localStorage');
                    // Reload departments from settings
                    if (companyId) {
                        loadDepartmentsFromSettings(companyId);
                    }
                }
            } catch (error) {
                console.warn('Error parsing localStorage change event:', error);
            }
        }
        
        // Handle latest version updates from company scope (settings.html creates these)
        if (event.key && companyId && event.key === `fieldOptionsLatest_${companyId}_area`) {
            try {
                const latestData = JSON.parse(event.newValue);
                if (latestData.options && Array.isArray(latestData.options)) {
                    siteOptions = latestData.options
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log(' Updated work areas from company scope latest version:', siteOptions);
                    populateVehicleSelects();
                }
            } catch (error) {
                console.warn('Error parsing latest area options from company scope:', error);
            }
        }
        
        if (event.key && companyId && event.key === `fieldOptionsLatest_${companyId}_department`) {
            try {
                const latestData = JSON.parse(event.newValue);
                if (latestData.options && Array.isArray(latestData.options)) {
                    departmentOptions = latestData.options
                        .filter(option => option.enabled !== false)
                        .map(option => option.label || option.value || option)
                        .filter(Boolean);
                    console.log(' Updated departments from company scope latest version:', departmentOptions);
                    populateVehicleSelects();
                }
            } catch (error) {
                console.warn('Error parsing latest department options from company scope:', error);
            }
        }
    });
    
    // Listen for custom events within the same page
    document.addEventListener('fieldOptionsChanged', (event) => {
        const { fieldType, companyId, options } = event.detail;
        
        if (fieldType === 'area' && 
            companyId === window.authManager?.currentUser?.companyId) {
            console.log(' Received work areas update via custom event');
            
            if (Array.isArray(options)) {
                siteOptions = options
                    .filter(option => option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log(' Updated work areas in fleet management:', siteOptions);
                populateVehicleSelects();
            }
        }
        
        if (fieldType === 'department' && 
            companyId === window.authManager?.currentUser?.companyId) {
            console.log(' Received departments update via custom event');
            
            if (Array.isArray(options)) {
                departmentOptions = options
                    .filter(option => option.enabled !== false)
                    .map(option => option.label || option.value || option)
                    .filter(Boolean);
                
                console.log(' Updated departments in fleet management:', departmentOptions);
                populateVehicleSelects();
            }
        }
    });
}

// Initialize vehicle data with fallback
updateEmptyState();
setTimeout(() => {
    if (window.authManager && window.authManager.currentUser && window.authManager.currentUser.companyId) {
        initializeVehicleData();
    }
}, 2000);

// Tab switching functionality
function switchToTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + 'TabContent').classList.add('active');
    document.getElementById(tabName + 'TabBtn').classList.add('active');
    
    // Initialize chart if switching to analytics
    if (tabName === 'analytics') {
        setTimeout(() => {
            initializeFleetCharts();
        }, 100);
    }
}

// Fleet Analytics Variables
let fleetChart = null;
let vehicleData = [];

// Initialize fleet charts
function initializeFleetCharts() {
    if (fleetChart) {
        fleetChart.destroy();
    }
    
    loadVehicleDataForCharts().then(() => {
        updateFleetVisualization();
        updateFleetStats();
    });
}

// Load vehicle data for charts
async function loadVehicleDataForCharts() {
    try {
        const user = window.authManager?.currentUser;
        if (!user || !user.companyId) {
            console.warn('No user or company ID for chart data');
            return;
        }
        
        const snapshot = await firebase.database().ref(`companies/${user.companyId}/vehicles`).once('value');
        const data = snapshot.val();
        
        vehicleData = [];
        if (data) {
            Object.keys(data).forEach(key => {
                vehicleData.push({
                    id: key,
                    ...data[key]
                });
            });
        }
        
        console.log('Loaded vehicle data for charts:', vehicleData.length, 'vehicles');
    } catch (error) {
        console.error('Error loading vehicle data for charts:', error);
    }
}

// Update fleet visualization
function updateFleetVisualization() {
    const chartType = document.getElementById('chartTypeSelect').value;
    const dataSource = document.getElementById('dataSourceSelect').value;
    const groupBy = document.getElementById('groupBySelect').value;
    
    const filteredData = filterVehicleData(dataSource);
    const chartData = groupVehicleData(filteredData, groupBy);
    
    createFleetChart(chartType, chartData, groupBy);
}

// Filter vehicle data based on source
function filterVehicleData(source) {
    switch (source) {
        case 'active':
            return vehicleData.filter(v => v.vehicleStatus === 'Active' || v.status === 'Active');
        case 'inactive':
            return vehicleData.filter(v => v.vehicleStatus === 'Inactive' || v.status === 'Inactive');
        case 'maintenance':
            return vehicleData.filter(v => v.vehicleStatus === 'Maintenance' || v.status === 'Maintenance');
        default:
            return vehicleData;
    }
}

// Group vehicle data for charts
function groupVehicleData(data, groupBy) {
    const groups = {};
    
    data.forEach(vehicle => {
        let key;
        switch (groupBy) {
            case 'status':
                key = vehicle.vehicleStatus || vehicle.status || 'Unknown';
                break;
            case 'department':
                key = vehicle.assignmentDept || vehicle.assignmentDepartment || vehicle.department || 'Unassigned';
                break;
            case 'vehicleType':
                key = vehicle.vehicleType || 'Unknown Type';
                break;
            case 'fuelType':
                key = vehicle.fuelType || 'Unknown Fuel';
                break;
            case 'site':
                key = vehicle.siteAssignment || vehicle.workArea || vehicle.site || 'Unassigned';
                break;
            default:
                key = 'Other';
        }
        
        groups[key] = (groups[key] || 0) + 1;
    });
    
    return groups;
}

// Create fleet chart
function createFleetChart(type, data, groupBy) {
    const ctx = document.getElementById('fleetMainChart').getContext('2d');
    
    if (fleetChart) {
        fleetChart.destroy();
    }
    
    const labels = Object.keys(data);
    const values = Object.values(data);
    
    const colors = [
        '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#16a085'
    ];
    
    const config = {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: getChartLabel(groupBy),
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: colors.slice(0, labels.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: type === 'pie' || type === 'doughnut' ? 'right' : 'top'
                },
                title: {
                    display: true,
                    text: `Fleet Distribution by ${getChartLabel(groupBy)}`
                }
            },
            scales: type === 'pie' || type === 'doughnut' ? {} : {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };
    
    fleetChart = new Chart(ctx, config);
}

// Get chart label
function getChartLabel(groupBy) {
    const labels = {
        'status': 'Status',
        'department': 'Department',
        'vehicleType': 'Vehicle Type',
        'fuelType': 'Fuel Type',
        'site': 'Site Assignment'
    };
    return labels[groupBy] || 'Category';
}

// Update fleet statistics
function updateFleetStats() {
    document.getElementById('totalVehicles').textContent = vehicleData.length;
    
    const activeCount = vehicleData.filter(v => 
        v.vehicleStatus === 'Active' || v.status === 'Active'
    ).length;
    document.getElementById('activeVehicles').textContent = activeCount;
    
    const maintenanceCount = vehicleData.filter(v => 
        v.vehicleStatus === 'Maintenance' || v.status === 'Maintenance'
    ).length;
    document.getElementById('maintenanceVehicles').textContent = maintenanceCount;
    
    const departments = new Set();
    vehicleData.forEach(v => {
        const dept = v.assignmentDept || v.assignmentDepartment || v.department;
        if (dept && dept !== 'Unassigned') {
            departments.add(dept);
        }
    });
    document.getElementById('uniqueDepartments').textContent = departments.size;
}

// Refresh visualization
function refreshFleetVisualization() {
    loadVehicleDataForCharts().then(() => {
        updateFleetVisualization();
        updateFleetStats();
    });
}

// Export chart data
function exportFleetChartData() {
    if (!vehicleData.length) {
        alert('No data to export');
        return;
    }
    
    const csv = convertToCSV(vehicleData);
    downloadCSV(csv, 'fleet_data.csv');
}

// Export chart image
function exportFleetChartImage() {
    if (!fleetChart) {
        alert('No chart to export');
        return;
    }
    
    const link = document.createElement('a');
    link.download = 'fleet_chart.png';
    link.href = fleetChart.toBase64Image();
    link.click();
}

// Helper functions
function convertToCSV(data) {
    if (!data.length) return '';
    
    const headers = Object.keys(data[0]).join(',');
    const rows = data.map(row => 
        Object.values(row).map(value => 
            typeof value === 'string' ? `"${value}"` : value
        ).join(',')
    );
    
    return [headers, ...rows].join('\n');
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    window.URL.revokeObjectURL(url);
}

// Excel Import Functionality
function triggerExcelImport() {
    document.getElementById('excelFileInput').click();
}

function downloadExcelTemplate() {
    // Create a comprehensive Excel template with all vehicle modal fields
    const templateData = [
        [
            // Basic Information
            'Name', 'Plate Number', 'Type', 'Mark', 'Model', 'Status',
            // Assignment
            'Department', 'Site', 'Fuel Type', 'Securing Status', 'Tank',
            // Vehicle Details
            'VIN Number', 'Year', 'Current Mileage (km)', 'Average Consumption Unit', 'Average Consumption Value',
            // Financial & Legal
            'Insurance Expiry', 'Registration Expiry', 'Asset Value ($)', 'Assigned Driver',
            // Safety Equipment
            'Radio', 'GPS', 'Vignet Date', 'First Aid Kit', 'First Aid Kit Expiry', 
            'Extinguisher Status', 'Extinguisher Expiry',
            // Certificates
            'Certificate (Date)', 'Certificate Expiry',
            // Additional Information
            'Notes'
        ],
        [
            // Sample data row 1
            'Mining Truck 001', 'MT-001', 'Haul Truck', 'Caterpillar', '789C', 'Active',
            'Mining Operations', 'Main Pit', 'Diesel', 'Secured', '500',
            '1HGBH41JXMN109186', '2020', '15000', 'L/H', '25.5',
            '2025-12-31', '2025-06-30', '250000', 'John Smith',
            'Available', 'Available', '2025-12-31', 'Available', '2025-03-15',
            'Available', '2025-09-30',
            '2024-01-15', '2026-01-15',
            'Heavy duty mining truck for ore transportation'
        ],
        [
            // Sample data row 2
            'Service Vehicle 002', 'SV-002', 'Pickup Truck', 'Ford', 'F-350', 'Active',
            'Maintenance', 'Workshop Area', 'Gasoline', 'Secured', '100',
            '1FTFW1ET5DFC12345', '2019', '45000', 'L/100Km', '12.8',
            '2025-08-15', '2025-11-20', '35000', 'Mike Johnson',
            'Available', 'Not Available', '', 'Available', '2025-01-10',
            'Available', '2025-07-15',
            '2023-06-20', '2025-06-20',
            'Maintenance support vehicle'
        ]
    ];
    
    // Create workbook and worksheet
    const ws = XLSX.utils.aoa_to_sheet(templateData);
    
    // Set column widths for better readability
    const colWidths = [
        {wch: 15}, {wch: 12}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 10},
        {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 8},
        {wch: 18}, {wch: 6}, {wch: 15}, {wch: 18}, {wch: 15},
        {wch: 12}, {wch: 15}, {wch: 12}, {wch: 15},
        {wch: 10}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15},
        {wch: 15}, {wch: 15},
        {wch: 15}, {wch: 15},
        {wch: 30}
    ];
    ws['!cols'] = colWidths;
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Fleet Template');
    
    // Download the file
    XLSX.writeFile(wb, 'fleet_import_template.xlsx');
    
    showToast('Excel template downloaded successfully!', 'success');
}

function handleExcelImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show progress
    document.getElementById('importProgress').style.display = 'block';
    document.getElementById('importResults').style.display = 'none';
    document.getElementById('importStatusText').textContent = 'Reading Excel file...';
    document.getElementById('importProgressBar').style.width = '20%';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // Update progress
            document.getElementById('importStatusText').textContent = 'Processing data...';
            document.getElementById('importProgressBar').style.width = '50%';
            
            // Read the Excel file
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Process the data
            processExcelData(jsonData);
            
        } catch (error) {
            console.error('Error reading Excel file:', error);
            showImportError('Error reading Excel file: ' + error.message);
        }
    };
    
    reader.onerror = function() {
        showImportError('Error reading file. Please try again.');
    };
    
    reader.readAsArrayBuffer(file);
    
    // Clear the input
    event.target.value = '';
}

function processExcelData(data) {
    document.getElementById('importStatusText').textContent = 'Validating data...';
    document.getElementById('importProgressBar').style.width = '70%';
    
    if (data.length < 2) {
        showImportError('Excel file must contain at least a header row and one data row.');
        return;
    }
    
    // Get headers (assuming first row contains headers)
    const headers = data[0].map(h => h ? h.toString().trim() : '');
    const dataRows = data.slice(1);
    
    // Expected column mapping
    const columnMapping = {
        'Name': ['name', 'vehicle name', 'vehicle_name'],
        'Plate Number': ['plate number', 'plate_number', 'license plate', 'registration'],
        'Type': ['type', 'vehicle type', 'vehicle_type'],
        'Mark': ['mark', 'make', 'brand', 'manufacturer'],
        'Model': ['model', 'vehicle model', 'vehicle_model'],
        'Status': ['status', 'vehicle status', 'vehicle_status'],
        'Department': ['department', 'dept'],
        'Site': ['site', 'location', 'site location'],
        'Fuel Type': ['fuel type', 'fuel_type', 'fuel'],
        'Securing Status': ['securing status', 'securing_status', 'security status', 'security_status'],
        'Tank': ['tank', 'tank assignment', 'tank_assignment', 'tank capacity'],
        'VIN Number': ['vin number', 'vin_number', 'vin', 'chassis number'],
        'Year': ['year', 'vehicle year', 'model year', 'manufacturing year'],
        'Current Mileage (km)': ['current mileage (km)', 'current_mileage', 'mileage', 'odometer'],
        'Average Consumption Unit': ['average consumption unit', 'consumption_unit', 'fuel consumption unit'],
        'Average Consumption Value': ['average consumption value', 'consumption_value', 'average', 'fuel consumption'],
        'Insurance Expiry': ['insurance expiry', 'insurance_expiry', 'insurance expiration'],
        'Registration Expiry': ['registration expiry', 'registration_expiry', 'registration expiration'],
        'Asset Value ($)': ['asset value ($)', 'asset_value', 'value', 'purchase price'],
        'Assigned Driver': ['assigned driver', 'assigned_driver', 'driver', 'operator'],
        'Radio': ['radio', 'radio status', 'radio_status'],
        'GPS': ['gps', 'gps status', 'gps_status'],
        'Vignet Date': ['vignet date', 'vignet_date', 'vignet', 'toll date'],
        'First Aid Kit': ['first aid kit', 'first_aid_kit', 'first aid kit status'],
        'First Aid Kit Expiry': ['first aid kit expiry', 'first_aid_kit_expiry', 'first aid expiry'],
        'Extinguisher Status': ['extinguisher status', 'extinguisher_status', 'fire extinguisher'],
        'Extinguisher Expiry': ['extinguisher expiry', 'extinguisher_expiry', 'fire extinguisher expiry'],
        'Certificate (Date)': ['certificate (date)', 'certificate_date', 'certificate', 'cert date'],
        'Certificate Expiry': ['certificate expiry', 'certificate_expiry', 'cert expiry', 'certification expiry'],
        'Notes': ['notes', 'comments', 'remarks', 'description']
    };
    
    // Find column indices
    const columnIndices = {};
    Object.keys(columnMapping).forEach(requiredCol => {
        const possibleNames = [requiredCol.toLowerCase(), ...columnMapping[requiredCol]];
        const index = headers.findIndex(h => 
            possibleNames.includes(h.toLowerCase())
        );
        columnIndices[requiredCol] = index;
    });
    
    // Validate required columns
    const missingColumns = [];
    ['Name', 'Plate Number', 'Type'].forEach(col => {
        if (columnIndices[col] === -1) {
            missingColumns.push(col);
        }
    });
    
    if (missingColumns.length > 0) {
        showImportError(`Missing required columns: ${missingColumns.join(', ')}. Please check your Excel file headers.`);
        return;
    }
    
    // Process each row
    const vehicles = [];
    const errors = [];
    const warnings = [];
    
    dataRows.forEach((row, index) => {
        const rowNum = index + 2; // +2 because of header and 0-based index
        
        // Skip empty rows
        if (!row || row.every(cell => !cell || cell.toString().trim() === '')) {
            return;
        }
        
        const vehicle = {};
        
        // Extract data based on column mapping
        Object.keys(columnIndices).forEach(col => {
            const colIndex = columnIndices[col];
            if (colIndex !== -1 && row[colIndex] !== undefined) {
                vehicle[col.toLowerCase().replace(/\s+/g, '_').replace(/[()$]/g, '')] = row[colIndex] ? row[colIndex].toString().trim() : '';
            }
        });
        
        // Validate required fields
        if (!vehicle.name || !vehicle.plate_number || !vehicle.type) {
            errors.push(`Row ${rowNum}: Missing required fields (Name, Plate Number, or Type)`);
            return;
        }
        
        // Set defaults for basic fields
        vehicle.mark = vehicle.mark || 'Unknown';
        vehicle.model = vehicle.model || 'Not Specified';
        vehicle.status = vehicle.status || 'Active';
        vehicle.department = vehicle.department || 'General';
        vehicle.site = vehicle.site || 'Main Site';
        vehicle.fuel_type = vehicle.fuel_type || 'Diesel';
        vehicle.securing_status = vehicle.securing_status || 'Secured';
        vehicle.tank = vehicle.tank || '0';
        
        // Set defaults for additional fields
        vehicle.vin_number = vehicle.vin_number || '';
        vehicle.year = vehicle.year || '';
        vehicle.current_mileage_km = vehicle.current_mileage_km || '';
        vehicle.average_consumption_unit = vehicle.average_consumption_unit || '';
        vehicle.average_consumption_value = vehicle.average_consumption_value || '';
        vehicle.insurance_expiry = vehicle.insurance_expiry || '';
        vehicle.registration_expiry = vehicle.registration_expiry || '';
        vehicle.asset_value = vehicle.asset_value || '';
        vehicle.assigned_driver = vehicle.assigned_driver || '';
        vehicle.radio = vehicle.radio || '';
        vehicle.gps = vehicle.gps || '';
        vehicle.vignet_date = vehicle.vignet_date || '';
        vehicle.first_aid_kit = vehicle.first_aid_kit || '';
        vehicle.first_aid_kit_expiry = vehicle.first_aid_kit_expiry || '';
        vehicle.extinguisher_status = vehicle.extinguisher_status || '';
        vehicle.extinguisher_expiry = vehicle.extinguisher_expiry || '';
        vehicle.certificate_date = vehicle.certificate_date || '';
        vehicle.certificate_expiry = vehicle.certificate_expiry || '';
        vehicle.notes = vehicle.notes || '';
        
        // Validate status values
        const validStatuses = ['Active', 'In Maintenance', 'Inactive'];
        if (vehicle.status && !validStatuses.includes(vehicle.status)) {
            warnings.push(`Row ${rowNum}: Invalid status "${vehicle.status}". Setting to "Active".`);
            vehicle.status = 'Active';
        }
        
        // Validate fuel type
        const validFuelTypes = ['Diesel', 'Gasoline', 'Jet A-1', 'HFO'];
        if (vehicle.fuel_type && !validFuelTypes.includes(vehicle.fuel_type)) {
            warnings.push(`Row ${rowNum}: Invalid fuel type "${vehicle.fuel_type}". Setting to "Diesel".`);
            vehicle.fuel_type = 'Diesel';
        }
        
        // Validate securing status
        const validSecuringStatuses = ['Secured', 'Unsecured', 'Unknown'];
        if (vehicle.securing_status && !validSecuringStatuses.includes(vehicle.securing_status)) {
            warnings.push(`Row ${rowNum}: Invalid securing status "${vehicle.securing_status}". Setting to "Secured".`);
            vehicle.securing_status = 'Secured';
        }
        
        // Validate year
        if (vehicle.year && vehicle.year !== '') {
            const year = parseInt(vehicle.year);
            if (isNaN(year) || year < 1900 || year > 2030) {
                warnings.push(`Row ${rowNum}: Invalid year "${vehicle.year}". Clearing field.`);
                vehicle.year = '';
            }
        }
        
        // Validate numeric fields
        if (vehicle.current_mileage_km && vehicle.current_mileage_km !== '') {
            const mileage = parseFloat(vehicle.current_mileage_km);
            if (isNaN(mileage) || mileage < 0) {
                warnings.push(`Row ${rowNum}: Invalid mileage "${vehicle.current_mileage_km}". Clearing field.`);
                vehicle.current_mileage_km = '';
            }
        }
        
        if (vehicle.average_consumption_value && vehicle.average_consumption_value !== '') {
            const consumption = parseFloat(vehicle.average_consumption_value);
            if (isNaN(consumption) || consumption < 0) {
                warnings.push(`Row ${rowNum}: Invalid consumption value "${vehicle.average_consumption_value}". Clearing field.`);
                vehicle.average_consumption_value = '';
            }
        }
        
        if (vehicle.asset_value && vehicle.asset_value !== '') {
            const value = parseFloat(vehicle.asset_value);
            if (isNaN(value) || value < 0) {
                warnings.push(`Row ${rowNum}: Invalid asset value "${vehicle.asset_value}". Clearing field.`);
                vehicle.asset_value = '';
            }
        }
        
        if (vehicle.tank && vehicle.tank !== '') {
            const tank = parseFloat(vehicle.tank);
            if (isNaN(tank) || tank < 0) {
                warnings.push(`Row ${rowNum}: Invalid tank capacity "${vehicle.tank}". Setting to 0.`);
                vehicle.tank = '0';
            }
        }
        
        // Validate date fields
        const dateFields = ['insurance_expiry', 'registration_expiry', 'vignet_date', 'first_aid_kit_expiry', 'extinguisher_expiry', 'certificate_date', 'certificate_expiry'];
        dateFields.forEach(field => {
            if (vehicle[field] && vehicle[field] !== '') {
                const date = new Date(vehicle[field]);
                if (isNaN(date.getTime())) {
                    warnings.push(`Row ${rowNum}: Invalid date format in ${field.replace(/_/g, ' ')} "${vehicle[field]}". Clearing field.`);
                    vehicle[field] = '';
                }
            }
        });
        
        // Validate VIN (basic check for 17 characters if provided)
        if (vehicle.vin_number && vehicle.vin_number !== '' && vehicle.vin_number.length !== 17) {
            warnings.push(`Row ${rowNum}: VIN should be 17 characters. Current: "${vehicle.vin_number}".`);
        }
        
        // Validate equipment status fields
        const validEquipmentStatuses = {
            radio: ['Available', 'Not Available', 'Under Repair'],
            gps: ['Available', 'Not Available', 'Under Repair'],
            first_aid_kit: ['Available', 'Not Available', 'Expired'],
            extinguisher_status: ['Available', 'Not Available', 'Under Inspection', 'Expired']
        };
        
        Object.keys(validEquipmentStatuses).forEach(field => {
            if (vehicle[field] && !validEquipmentStatuses[field].includes(vehicle[field])) {
                warnings.push(`Row ${rowNum}: Invalid ${field.replace(/_/g, ' ')} status "${vehicle[field]}". Clearing field.`);
                vehicle[field] = '';
            }
        });
        
        vehicles.push(vehicle);
    });
    
    if (errors.length > 0) {
        showImportError('Import failed due to validation errors:<br>' + errors.join('<br>'));
        return;
    }
    
    // Import the vehicles
    importVehiclesToFirebase(vehicles, warnings);
}

async function importVehiclesToFirebase(vehicles, warnings) {
    document.getElementById('importStatusText').textContent = 'Saving vehicles to database...';
    document.getElementById('importProgressBar').style.width = '90%';
    
    try {
        const auth = authManager.getCurrentUser();
        if (!auth || !authManager.currentCompany) {
            throw new Error('Authentication required');
        }
        
        const vehicleRef = firebase.database().ref(`companies/${authManager.currentCompany.id}/fleet`);
        
        let successCount = 0;
        let errorCount = 0;
        const importErrors = [];
        
        for (let i = 0; i < vehicles.length; i++) {
            try {
                const vehicle = vehicles[i];
                
                // Check for duplicate plate numbers
                const existingVehicles = await vehicleRef.orderByChild('plateNumber').equalTo(vehicle.plate_number).once('value');
                if (existingVehicles.exists()) {
                    importErrors.push(`Vehicle with plate number "${vehicle.plate_number}" already exists. Skipped.`);
                    errorCount++;
                    continue;
                }
                
                // Generate a unique ID
                const vehicleId = vehicleRef.push().key;
                
                // Prepare vehicle data
                const vehicleData = {
                    id: vehicleId,
                    name: vehicle.name,
                    plateNumber: vehicle.plate_number,
                    vehicleType: vehicle.type,
                    vehicleMake: vehicle.mark,
                    model: vehicle.model,
                    status: vehicle.status,
                    department: vehicle.department,
                    siteAssignment: vehicle.site,
                    fuelType: vehicle.fuel_type,
                    securingStatus: vehicle.securing_status,
                    tankAssignment: vehicle.tank,
                    
                    // Additional vehicle details
                    vinNumber: vehicle.vin_number,
                    vehicleYear: vehicle.year,
                    currentMileage: vehicle.current_mileage_km,
                    averageConsumptionUnit: vehicle.average_consumption_unit,
                    averageConsumptionValue: vehicle.average_consumption_value,
                    
                    // Financial and legal
                    insuranceExpiry: vehicle.insurance_expiry,
                    registrationExpiry: vehicle.registration_expiry,
                    assetValue: vehicle.asset_value,
                    assignedDriver: vehicle.assigned_driver,
                    
                    // Safety equipment
                    radioStatus: vehicle.radio,
                    gpsStatus: vehicle.gps,
                    vignetDate: vehicle.vignet_date,
                    firstAidKit: vehicle.first_aid_kit,
                    firstAidKitExpiry: vehicle.first_aid_kit_expiry,
                    extinguisherStatus: vehicle.extinguisher_status,
                    extinguisherExpiry: vehicle.extinguisher_expiry,
                    
                    // Certificate information
                    certificateDate: vehicle.certificate_date,
                    certificateExpiry: vehicle.certificate_expiry,
                    
                    // Additional information
                    notes: vehicle.notes,
                    
                    // Metadata
                    dateAdded: new Date().toISOString(),
                    addedBy: auth.email,
                    importedFromExcel: true
                };
                
                // Save to Firebase
                await vehicleRef.child(vehicleId).set(vehicleData);
                successCount++;
                
            } catch (error) {
                console.error('Error importing vehicle:', error);
                importErrors.push(`Error importing vehicle "${vehicles[i].name}": ${error.message}`);
                errorCount++;
            }
        }
        
        // Complete progress
        document.getElementById('importProgressBar').style.width = '100%';
        document.getElementById('importStatusText').textContent = 'Import completed!';
        
        // Hide progress after a short delay
        setTimeout(() => {
            document.getElementById('importProgress').style.display = 'none';
        }, 1500);
        
        // Show results
        showImportResults(successCount, errorCount, importErrors, warnings);
        
        // Refresh the table
        if (successCount > 0) {
            setTimeout(() => {
                loadVehicles();
            }, 1000);
        }
        
    } catch (error) {
        console.error('Import error:', error);
        showImportError('Failed to import vehicles: ' + error.message);
    }
}

function showImportResults(successCount, errorCount, importErrors, warnings) {
    const resultsDiv = document.getElementById('importResults');
    const contentDiv = document.getElementById('importResultsContent');
    
    let html = '';
    
    if (successCount > 0) {
        html += `<div class="import-success">
            <h6><i class="fas fa-check-circle"></i> Import Successful</h6>
            <p>${successCount} vehicle${successCount !== 1 ? 's' : ''} imported successfully.</p>
        </div>`;
    }
    
    if (warnings.length > 0) {
        html += `<div class="import-warning" style="margin-top: 0.5rem;">
            <h6><i class="fas fa-exclamation-triangle"></i> Warnings</h6>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                ${warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
        </div>`;
    }
    
    if (errorCount > 0) {
        html += `<div class="import-error" style="margin-top: 0.5rem;">
            <h6><i class="fas fa-exclamation-circle"></i> Errors</h6>
            <p>${errorCount} vehicle${errorCount !== 1 ? 's' : ''} failed to import.</p>
            ${importErrors.length > 0 ? `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                ${importErrors.map(e => `<li>${e}</li>`).join('')}
            </ul>` : ''}
        </div>`;
    }
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        resultsDiv.style.display = 'none';
    }, 10000);
}

function showImportError(message) {
    document.getElementById('importProgress').style.display = 'none';
    
    const resultsDiv = document.getElementById('importResults');
    const contentDiv = document.getElementById('importResultsContent');
    
    contentDiv.innerHTML = `<div class="import-error">
        <h6><i class="fas fa-exclamation-circle"></i> Import Failed</h6>
        <p>${message}</p>
    </div>`;
    
    resultsDiv.style.display = 'block';
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
        resultsDiv.style.display = 'none';
    }, 8000);
}

// Toast notification function (if not already defined)
function showToast(message, type = 'info') {
    // Create toast element if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(toast);
    }
    
    // Set style based on type
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    toast.style.backgroundColor = colors[type] || colors.info;
    toast.textContent = message;
    toast.style.opacity = '1';
    
    // Hide after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
    }, 3000);
}
</script>
</body>
</html>
