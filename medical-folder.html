<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Folder - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        .menu-loading [data-feature] {
            display: block !important;
        }

        .menu-loading .menu-dropdown {
            display: block !important;
        }

        .sidebar.menu-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            pointer-events: none;
        }
    </style>

    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- GitHub Pages Fix Script -->
    <script src="github-pages-fix.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#" class="active"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html" class="active">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="search-bar">
                    <input type="text" placeholder="Search medical records...">
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="assets/default-avatar.png" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <div class="content-header">
                    <h1>Medical Folder</h1>
                </div>
                
                <!-- Medical Records Content -->
                <div class="medical-folder">
                    <!-- Add your medical folder content here -->
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/notifications.js"></script>
    <script src="js/main.js"></script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});
</script>
    <script>
        // Initialize Firebase (v8 compatibility)
        const db = firebase.database();
        const auth = firebase.auth();

        // Menu visibility management system
        let platformFeatures = {};
        let userRole = '';
        let companyId = '';

        // Initialize menu state
        function resetMenuVisibility() {
            const menuElement = document.getElementById('roleBasedMenu');
            if (menuElement) {
                menuElement.classList.add('menu-loading');
                
                // Hide all feature-based menu items initially
                const featureItems = menuElement.querySelectorAll('[data-feature]');
                featureItems.forEach(item => {
                    item.classList.remove('menu-visible');
                });
            }
        }

        // Show basic menu for unauthenticated users
        function showBasicMenu() {
            const menuElement = document.getElementById('roleBasedMenu');
            if (menuElement) {
                menuElement.classList.remove('menu-loading');
                
                // Show only basic navigation items (those without data-feature)
                const basicItems = menuElement.querySelectorAll(':not([data-feature])');
                basicItems.forEach(item => {
                    if (item.tagName === 'LI' || item.tagName === 'A') {
                        item.style.display = 'block';
                    }
                });
            }
        }

        // Apply feature-based menu visibility
        function applyFeatureBasedMenuVisibility() {
            const menuElement = document.getElementById('roleBasedMenu');
            if (!menuElement) return;

            try {
                const featureItems = menuElement.querySelectorAll('[data-feature]');
                
                featureItems.forEach(item => {
                    const requiredFeature = item.getAttribute('data-feature');
                    
                    if (requiredFeature && platformFeatures[requiredFeature] === true) {
                        item.classList.add('menu-visible');
                    } else {
                        item.classList.remove('menu-visible');
                    }
                });

                // Handle dropdowns - show if any child is visible
                const dropdowns = menuElement.querySelectorAll('.menu-dropdown');
                dropdowns.forEach(dropdown => {
                    const visibleChildren = dropdown.querySelectorAll('.menu-visible, :not([data-feature])');
                    if (visibleChildren.length > 0) {
                        dropdown.classList.add('menu-visible');
                    } else {
                        dropdown.classList.remove('menu-visible');
                    }
                });

                menuElement.classList.remove('menu-loading');
                console.log('Feature-based menu visibility applied successfully');
            } catch (error) {
                console.error('Error applying feature-based menu visibility:', error);
                menuElement.classList.remove('menu-loading');
            }
        }

        // Main menu update function
        function updateMenuWithFeatureAuthorization() {
            resetMenuVisibility();

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        // Get user data
                        const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
                        const userData = userSnapshot.val();
                        
                        if (userData && userData.companyId) {
                            companyId = userData.companyId;
                            userRole = userData.role || '';

                            // Get platform features
                            const featuresSnapshot = await db.ref(`companies/${companyId}/platformFeatures`).once('value');
                            platformFeatures = featuresSnapshot.val() || {};
                            
                            console.log('Platform features loaded:', platformFeatures);
                            console.log('User role:', userRole);
                            
                            applyFeatureBasedMenuVisibility();
                        } else {
                            console.warn('User data incomplete');
                            showBasicMenu();
                        }
                    } catch (error) {
                        console.error('Error loading menu data:', error);
                        showBasicMenu();
                    }
                } else {
                    console.log('User not authenticated');
                    showBasicMenu();
                }
            });
        }

        // Initialize menu system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateMenuWithFeatureAuthorization();
        });

        // Medical folder specific functionality
        let medicalRecords = [];
        let currentSort = { field: null, direction: 'asc' };

        function loadMedicalRecords() {
            if (!companyId) {
                setTimeout(loadMedicalRecords, 1000);
                return;
            }

            db.ref(`companies/${companyId}/medical-records`).on('value', (snapshot) => {
                medicalRecords = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(id => {
                        medicalRecords.push({
                            id: id,
                            ...data[id]
                        });
                    });
                }
                
                displayMedicalRecords();
            });
        }

        function displayMedicalRecords() {
            const tbody = document.getElementById('medicalRecordsBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            medicalRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.employeeName || 'N/A'}</td>
                    <td>${record.employeeId || 'N/A'}</td>
                    <td>${record.recordType || 'N/A'}</td>
                    <td>${record.dateCreated ? new Date(record.dateCreated).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <span class="status-badge status-${(record.status || 'pending').toLowerCase()}">
                            ${record.status || 'Pending'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewRecord('${record.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="downloadRecord('${record.id}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewRecord(recordId) {
            const record = medicalRecords.find(r => r.id === recordId);
            if (record) {
                // Implement view record functionality
                alert(`Viewing record for ${record.employeeName}`);
            }
        }

        function downloadRecord(recordId) {
            const record = medicalRecords.find(r => r.id === recordId);
            if (record) {
                // Implement download record functionality
                alert(`Downloading record for ${record.employeeName}`);
            }
        }

        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }

            medicalRecords.sort((a, b) => {
                let aVal = a[field] || '';
                let bVal = b[field] || '';
                
                if (field === 'dateCreated') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            displayMedicalRecords();
        }

        // Initialize medical records when authentication is ready
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadMedicalRecords();
            }
        });
    </script>
</body>
</html>
