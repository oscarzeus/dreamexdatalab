<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>HSE System - Incident Board</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
	<style>
		:root{ --primary-color:#2c3e50; --secondary-color:#34495e; --sidebar-width:250px; --border-color:#e0e0e0; --bg:#f8f9fa }
		*{box-sizing:border-box;margin:0;padding:0}
		body{font-family:Inter,system-ui,Arial,sans-serif;font-size:14px;background:var(--bg);color:#333}
		.app-container{display:flex;min-height:100vh}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;transition:transform .3s ease;z-index:1000}
		.sidebar.collapsed{transform:translateX(-100%)}
		.logo h2{font-size:1.05rem;text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1)}
		.menu{list-style:none;margin-top:1rem}
		.menu a{color:#fff;display:flex;align-items:center;gap:.5rem;text-decoration:none;font-size:.8rem;border-radius:6px;padding:.5rem .6rem}
		.menu a:hover,.menu a.active{background:rgba(255,255,255,0.12)}
		/* Match project-list submenu behavior */
		.submenu{list-style:none;margin-left:.75rem;display:none;margin-top:.25rem}
		.menu-dropdown:hover .submenu{display:block}
		.submenu a{font-size:.75rem;padding:.45rem .65rem}
		/* Role/feature-based visibility rules to match project-list */
		[data-feature]:not(.menu-visible){display:none!important}
		.menu-dropdown:not(.menu-visible){display:none!important}
		/* Hide ALL menu items by default during loading - no exceptions */
		.sidebar.menu-loading .menu-item,
		.sidebar.menu-loading .menu-dropdown,
		.sidebar.menu-loading li[data-feature],
		.sidebar.menu-loading [data-feature],
		.sidebar.menu-loading .menu-visible,
		.sidebar.menu-loading li.menu-visible,
		.sidebar.menu-loading [data-feature].menu-visible{display:none!important}
		/* Ensure menu-visible items are shown only after loading completes */
		.sidebar:not(.menu-loading) .menu-visible{display:block!important}
		.sidebar:not(.menu-loading) li.menu-visible,
		.sidebar:not(.menu-loading) [data-feature].menu-visible{display:block!important}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.3rem; padding-top:3.2rem; transition:margin-left .3s ease}
		.main-content.sidebar-collapsed{margin-left:0}
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease}
		.main-content.sidebar-collapsed .top-nav{left:.5rem}
		.sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;color:#666;padding:.45rem;border-radius:6px}
		#headerCompanyLogo{width:40px;height:40px;border-radius:6px;object-fit:contain;display:none}
		#headerCompanyLogo.visible{display:block}
		#headerCompanyName{font-weight:600;color:var(--primary-color);font-size:.85rem;display:none}
		#headerCompanyName.visible{display:block}
		/* Match project-list avatar button styling */
		.profile-btn{background:none;border:none;border-radius:50%;overflow:hidden;width:38px;height:38px;cursor:pointer}
		.profile-btn img{width:100%;height:100%;object-fit:cover}
		.user-profile{position:relative}
		/* User profile dropdown (match project-list) */
		.profile-dropdown{display:none;position:absolute;right:0;top:110%;background:#fff;border-radius:8px;min-width:200px;box-shadow:0 6px 18px rgba(0,0,0,0.12);overflow:hidden;border:1px solid #e9ecef;z-index:1000}
		.profile-dropdown.show{display:block}
		.profile-dropdown ul{list-style:none;margin:0;padding:0}
		.profile-dropdown li a{display:block;padding:.65rem .85rem;font-size:.72rem;text-decoration:none;color:#1e293b;font-weight:500}
		.profile-dropdown li a:hover{background:#f1f5f9}
		/* Notifications styles (match project-list) */
		.notifications{position:relative;display:flex;align-items:center}
		.notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.2rem;padding:.5rem;display:flex;align-items:center;justify-content:center}
		.notification-badge{position:absolute;top:-5px;right:-5px;background:#e74c3c;color:#fff;border-radius:50%;padding:.15rem .45rem;font-size:.7rem;display:none}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:320px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:1000;border:1px solid #e9ecef;max-height:400px;overflow:hidden}
		.notification-dropdown.show{display:block;animation:slideDown .2s ease-out}
		@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
		.notification-header{padding:12px 16px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%);display:flex;justify-content:space-between;align-items:center}
		.notification-header h3{margin:0;color:#333;font-size:14px;font-weight:600}
		.mark-all-read{background:none;border:none;color:#3498db;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px}
		.mark-all-read:hover{background:#e3f2fd;color:#1976d2}
		.notification-list{max-height:320px;overflow-y:auto;padding:0}
		.notification-list::-webkit-scrollbar{width:4px}
		.notification-list::-webkit-scrollbar-track{background:#f1f1f1}
		.notification-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:2px}
		.notification-item{padding:12px 16px;border-bottom:1px solid #f1f1f1;cursor:pointer;transition:background-color .2s ease;position:relative}
		.notification-item:hover{background:#f8f9fa}
		.notification-item.unread{background:#e8f4fd;border-left:3px solid #3498db}
		.notification-empty{padding:40px 20px;text-align:center;color:#999;display:none}
		.notification-empty i{font-size:32px;margin-bottom:12px;color:#ddd}
		.notification-empty-title{font-size:14px;font-weight:500;margin-bottom:4px;color:#666}
		.notification-empty-message{font-size:12px;color:#999}
		.page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.6rem .75rem;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14)}
		.btn{display:inline-block;padding:.4rem .8rem;border-radius:6px;border:1px solid transparent;font-size:.8rem;cursor:pointer;text-decoration:none}
		.btn-primary{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
		.btn-outline{background:transparent;color:#fff;border-color:rgba(255,255,255,.6)}
		.card{background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:12px;margin:.5rem 0}
		.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
		.filters .form-control{padding:8px 10px;border:1px solid #ced4da;border-radius:6px}
		table{width:100%;border-collapse:collapse}
		th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
		th{font-weight:700;color:#444;background:#fafafa}
		tr:hover{background:#f9fbff}
		.badge{display:inline-block;padding:.12rem .5rem;border-radius:999px;font-size:.75rem;color:#fff}
		.badge.low{background:#2ecc71}.badge.medium{background:#f39c12}.badge.high{background:#e74c3c}
		.status{padding:.12rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid #ccc;background:#fff;color:#555}
		.status.open{border-color:#0d6efd;color:#0d6efd}
		.status.in-progress{border-color:#fd7e14;color:#fd7e14}
		.status.closed{border-color:#198754;color:#198754}
		.status.draft{border-color:#6c757d;color:#6c757d}
		.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
		.pagination{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:8px}
		.pagination button{padding:.3rem .6rem;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer}
		.pagination button:disabled{opacity:.5;cursor:not-allowed}
		/* Tab Navigation */
		.tab-nav{display:flex;gap:0;border-bottom:2px solid #e5e7eb;margin-bottom:1rem}
		.tab-btn{padding:.6rem 1.2rem;font-size:.85rem;font-weight:500;color:#6b7280;background:transparent;border:none;cursor:pointer;position:relative;transition:color .2s;display:none}
		.tab-btn.tab-authorized{display:inline-flex;align-items:center;gap:6px}
		.tab-btn:hover{color:#111827}
		.tab-btn.active{color:var(--primary-color);font-weight:600}
		.tab-btn.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--primary-color)}
		.tab-content{display:none}
		.tab-content.active{display:block}
		/* Action Plan Tab Styles */
		.action-plan-table{width:100%;border-collapse:collapse;font-size:.75rem}
		.action-plan-table th{background:#f3f4f6;color:#374151;font-weight:600;text-align:left;padding:10px 12px;border:1px solid #e5e7eb}
		.action-plan-table td{padding:10px 12px;border:1px solid #e5e7eb;color:#1f2937}
		.action-plan-table td.responsible-cell{white-space:nowrap}
		.action-plan-table tr:hover{background:#f9fafb}
		.action-plan-table tr.clickable-row{cursor:pointer}
		.action-status{display:inline-block;padding:3px 10px;border-radius:999px;font-size:.7rem;font-weight:500;white-space:nowrap}
		.action-status.pending{background:#fef3c7;color:#92400e}
		.action-status.in-progress{background:#dbeafe;color:#1e40af}
		.action-status.completed{background:#d1fae5;color:#065f46}
		.action-status.overdue{background:#fee2e2;color:#991b1b}
		.action-source-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.68rem;font-weight:500}
		.action-source-badge.incident{background:#fee2e2;color:#991b1b}
		.action-source-badge.near-miss{background:#fef3c7;color:#92400e}
		.action-source-badge.observation{background:#dbeafe;color:#1e40af}
		.action-plan-empty{text-align:center;padding:40px;color:#9ca3af}
		.action-plan-empty i{font-size:2.5rem;margin-bottom:12px;display:block;color:#d1d5db}
		.action-plan-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
		.action-plan-filters .form-control{padding:8px 10px;border:1px solid #ced4da;border-radius:6px;font-size:.75rem}
		/* Incident list table font sizing */
		#incidentsTable{font-size:.7rem}
		#incidentsTable th{font-size:.72rem}
		#incidentsTable td{font-size:.7rem}
		/* Filters UI sizing */
		.toolbar .filters .form-control{font-size:.75rem;padding:.35rem .5rem}
		.toolbar .filters .btn{font-size:.75rem;padding:.35rem .6rem}
		#refreshBtn.btn{font-size:.75rem;padding:.35rem .6rem}
		/* Hide Actions column in incident list */
		#incidentsTable th:last-child,#incidentsTable td:last-child{display:none}
		/* Settings Styles */
		.settings-section{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:1.2rem;margin-bottom:1rem}
		.settings-section h3{font-size:.75rem;font-weight:600;color:#111827;margin:0;display:flex;align-items:center;gap:.5rem;cursor:pointer;user-select:none}
		.settings-section h3 i{color:var(--primary-color);font-size:.7rem}
		.settings-section h3 .toggle-icon{margin-left:auto;font-size:.65rem;color:#9ca3af;transition:transform .2s}
		.settings-section.collapsed h3 .toggle-icon{transform:rotate(-90deg)}
		.settings-section-content{margin-top:.8rem;overflow:hidden;transition:max-height .3s ease}
		.settings-section.collapsed .settings-section-content{max-height:0!important;margin-top:0}
		.option-list{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.8rem;max-height:200px;overflow-y:auto}
		.option-item{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .7rem;background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;font-size:.8rem;color:#374151}
		.option-item span{flex:1}
		.option-item button{padding:.25rem .5rem;font-size:.7rem;border:none;border-radius:4px;cursor:pointer;transition:background .2s}
		.option-item .edit-btn{background:#e0f2fe;color:#0369a1}
		.option-item .edit-btn:hover{background:#bae6fd}
		.option-item .delete-btn{background:#fee2e2;color:#dc2626}
		.option-item .delete-btn:hover{background:#fecaca}
		.add-option-form{display:flex;gap:.5rem}
		.add-option-form input{flex:1;padding:.5rem .7rem;font-size:.8rem;border:1px solid #d1d5db;border-radius:6px}
		.add-option-form button{padding:.5rem 1rem;font-size:.8rem;background:var(--primary-color);color:#fff;border:none;border-radius:6px;cursor:pointer;white-space:nowrap}
		.add-option-form button:hover{opacity:.9}
		.empty-options{text-align:center;padding:1rem;color:#9ca3af;font-size:.8rem}
		/* Access Control Table */
		.access-control-table{width:100%;border-collapse:collapse;font-size:.75rem}
		.access-control-table th{background:#f3f4f6;color:#374151;font-weight:600;text-align:left;padding:8px 10px;border:1px solid #e5e7eb;white-space:nowrap}
		.access-control-table td{padding:8px 10px;border:1px solid #e5e7eb;color:#1f2937}
		.access-control-table td input[type="checkbox"]{width:16px;height:16px;cursor:pointer}
		.access-control-table .role-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:500;background:#e0f2fe;color:#0369a1}
		.access-control-table .delete-btn{background:none;border:none;color:#dc2626;cursor:pointer;font-size:.85rem;padding:.25rem}
		.access-control-table .delete-btn:hover{color:#b91c1c}
		.ac-add-btn{padding:.4rem .8rem;font-size:.75rem;background:var(--primary-color);color:#fff;border:none;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem}
		.ac-add-btn:hover{opacity:.9}
		/* Access Control Modal */
		.ac-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center}
		.ac-modal-content{background:#fff;border-radius:10px;width:100%;max-width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
		.ac-modal-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.2rem;border-bottom:1px solid #e5e7eb}
		.ac-modal-header h3{margin:0;font-size:.9rem;font-weight:600;color:#111827;display:flex;align-items:center;gap:.5rem}
		.ac-modal-header h3 i{color:var(--primary-color)}
		.ac-modal-close{background:none;border:none;font-size:1.2rem;color:#6b7280;cursor:pointer}
		.ac-modal-body{padding:1.2rem}
		.ac-modal-body .form-group{margin-bottom:1rem}
		.ac-modal-body .form-group label{display:block;font-size:.75rem;font-weight:600;color:#374151;margin-bottom:.4rem}
		.ac-modal-body .form-group select{width:100%;padding:.5rem;font-size:.8rem;border:1px solid #d1d5db;border-radius:6px}
		.ac-modal-body .checkbox-group{display:flex;flex-wrap:wrap;gap:.8rem}
		.ac-modal-body .checkbox-item{display:flex;align-items:center;gap:.4rem;font-size:.75rem;color:#374151}
		.ac-modal-footer{display:flex;justify-content:flex-end;gap:.5rem;padding:1rem 1.2rem;border-top:1px solid #e5e7eb}
		.ac-modal-footer .btn{padding:.5rem 1rem;font-size:.8rem;border-radius:6px;cursor:pointer}
		.ac-modal-footer .btn-cancel{background:#f3f4f6;border:1px solid #d1d5db;color:#374151}
		.ac-modal-footer .btn-save{background:var(--primary-color);border:none;color:#fff}
		/* Incident Details Modal Styles - Matching Investigation Modal */
		.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:2000;display:flex;align-items:flex-start;justify-content:center;overflow:auto;padding:32px 20px}
		.modal-content.inc-preview-container{background:#fff;border-radius:12px;width:100%;max-width:940px;min-height:60vh;box-shadow:0 18px 42px rgba(0,0,0,0.22);position:relative;overflow:visible}
		.inc-sheet{background:#fff;width:100%;padding:20px 24px 40px;box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;position:relative;line-height:1.4;color:#111827}
		.inc-header{display:flex;justify-content:space-between;gap:20px;margin-bottom:0;align-items:flex-start}
		.inc-logo{width:100px;height:100px;object-fit:contain;border:none;border-radius:8px;background:#fff}
		.inc-logo-fallback{width:100px;height:100px;display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:600;color:#444;background:#f8fafc;border-radius:8px}
		.inc-company h1{margin:0;font-size:1.1rem;line-height:1.2;font-weight:700}
		.inc-company .doc-title{font-size:.9rem;font-weight:700;margin:2px 0 0;color:#111827;text-align:left}
		.inc-meta{font-size:.63rem;color:#374151;text-align:right;line-height:1.35;min-width:150px}
		.inc-meta .generated{font-size:.55rem;color:#6b7280;font-weight:500}
		.inc-divider{height:1px;background:#e5e7eb;margin:12px 0 18px;border-radius:1px}
		.inc-docmeta-row{font-size:.75rem;color:#111827;margin:6px 0 12px}
		.inc-docmeta-row span:first-child{font-weight:700;color:#374151;margin-right:6px}
		.inc-sections{display:flex;flex-direction:column;gap:16px}
		.inc-section-title{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;font-weight:600;font-size:.75rem;padding:10px 14px;border:none;border-radius:0;display:flex;align-items:center;gap:10px;box-shadow:0 2px 8px rgba(44,62,80,0.15)}
		.inc-section-title i{font-size:1rem;width:28px;height:28px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
		.inc-section-title .section-text{flex:1}
		/* Clean field display - inline layout */
		.inc-fields-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px 24px}
		.inc-field{display:flex;align-items:baseline;gap:8px}
		.inc-field.full-width{grid-column:span 2}
		.inc-field-label{font-size:.75rem;font-weight:700;color:#6b7280;white-space:nowrap}
		.inc-field-label::after{content:':'}
		.inc-field-value{font-size:.75rem;color:#111827;line-height:1.4}
		.inc-field-value.description{background:#f9fafb;padding:10px 12px;border:1px solid #e5e7eb;font-size:.75rem;color:#374151;display:block;width:100%}
		.inc-field.full-width.has-description{flex-direction:column;align-items:flex-start;gap:4px}
		.inc-field.full-width.has-description .inc-field-label::after{content:''}
		/* Person/Equipment items - tables */
		.inc-items-section{margin-top:8px}
		/* Ensure tables span full width even inside grid containers */
		.inc-fields-grid > .inc-items-section{grid-column:1 / -1}
		.inc-items-section-title{font-size:.75rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px}
		.inc-items-section-title i{color:var(--primary-color)}
		.inc-items-table{width:100%;border-collapse:collapse;font-size:.75rem}
		.inc-items-table th{background:#f3f4f6;color:#374151;font-weight:700;text-align:left;padding:8px 12px;border:1px solid #e5e7eb}
		.inc-items-table td{padding:8px 12px;border:1px solid #e5e7eb;color:#1f2937}
		.inc-items-table tr:hover{background:#f9fafb}
		/* Action items */
		.inc-action-card{background:#fff;border:1px solid #e5e7eb;border-radius:0;padding:12px 14px;margin-bottom:8px}
		.inc-action-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
		.inc-action-card-number{font-weight:600;color:#1f2937;font-size:.75rem}
		.inc-action-status{padding:3px 10px;border-radius:999px;font-size:.75rem;font-weight:500}
		.inc-action-status.pending{background:#fef3c7;color:#92400e}
		.inc-action-status.in-progress{background:#dbeafe;color:#1e40af}
		.inc-action-status.completed{background:#d1fae5;color:#065f46}
		.inc-action-status.overdue{background:#fee2e2;color:#991b1b}
		.inc-action-card-fields{display:flex;flex-wrap:wrap;gap:6px 20px}
		.inc-action-card-field{display:flex;align-items:baseline;gap:6px}
		.inc-action-card-field-label{font-size:.75rem;color:#6b7280;font-weight:700;white-space:nowrap}
		.inc-action-card-field-label::after{content:':'}
		.inc-action-card-field-value{font-size:.75rem;color:#1f2937}
		/* Buttons */
		.inc-print-btn,.inc-close-btn{position:absolute;top:10px;border-radius:6px;padding:7px 10px;font-size:.75rem;cursor:pointer;z-index:10;display:inline-flex;align-items:center;gap:6px}
		.inc-print-btn{right:10px;background:#111827;color:#fff;border:none}
		.inc-close-btn{right:120px;background:#fff;border:1px solid #d1d5db;color:#111827}
		/* Attachments */
		.inc-attachment-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-radius:6px;margin-bottom:6px}
		.inc-attachment-item i{color:#6b7280}
		.inc-attachment-item a{color:#3b82f6;text-decoration:none;font-size:.75rem;flex:1}
		.inc-attachment-item a:hover{text-decoration:underline}
		.inc-attachment-item .size{color:#9ca3af;font-size:.75rem}
		tr.clickable-row{cursor:pointer}
		tr.clickable-row:hover{background:#f0f4ff}
		/* Help Guide Button */
		.guide-start-btn { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(59,130,246,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
		.guide-start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59,130,246,0.5); }
		.guide-start-btn i { font-size: 1.2rem; }
		/* Demo Button */
		.video-btn { position: fixed; bottom: 20px; right: 80px; background: linear-gradient(135deg, #ef4444, #f97316); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(239,68,68,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
		.video-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239,68,68,0.5); }
		/* Demo Dropdown */
		.demo-dropdown { position: fixed; bottom: 80px; right: 80px; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1001; min-width: 220px; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; }
		.demo-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }
		.demo-dropdown-header { padding: 0.75rem 1rem; background: linear-gradient(135deg, #ef4444, #f97316); color: #fff; font-weight: 600; font-size: 0.85rem; }
		.demo-dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f1f5f9; }
		.demo-dropdown-item:last-child { border-bottom: none; }
		.demo-dropdown-item:hover { background: #f8fafc; }
		.demo-dropdown-item i { width: 20px; font-size: 1rem; }
		.demo-dropdown-item .demo-icon-create { color: #3b82f6; }
		.demo-dropdown-item .demo-icon-view { color: #10b981; }
		.demo-dropdown-item span { font-size: 0.85rem; color: #334155; }
		/* Guide Overlay */
		.guide-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9998; }
		.guide-highlight { position: absolute; border: 3px solid #3b82f6; border-radius: 8px; background: transparent; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); z-index: 9999; pointer-events: none; transition: all 0.3s ease; }
		.guide-tooltip { position: absolute; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10000; width: 340px; overflow: hidden; }
		.guide-tooltip::before { content: ''; position: absolute; width: 12px; height: 12px; background: #fff; }
		.guide-tooltip-header { background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 1rem; color: #fff; }
		.guide-tooltip-header .step-badge { background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-bottom: 0.5rem; display: inline-block; }
		.guide-tooltip-header h4 { margin: 0.5rem 0 0 0; font-size: 1rem; }
		.guide-tooltip-body { padding: 1rem; color: #334155; font-size: 0.9rem; line-height: 1.5; }
		.guide-tooltip-footer { padding: 0.75rem 1rem; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }
		.guide-progress { font-size: 0.8rem; color: #64748b; }
		.guide-buttons { display: flex; gap: 0.5rem; }
		.guide-btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
		.guide-btn-skip { background: transparent; border: 1px solid #e2e8f0; color: #64748b; }
		.guide-btn-skip:hover { background: #f1f5f9; }
		.guide-btn-prev { background: #f1f5f9; border: none; color: #475569; }
		.guide-btn-prev:hover { background: #e2e8f0; }
		.guide-btn-next, .guide-btn-finish { background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; color: #fff; }
		.guide-btn-next:hover, .guide-btn-finish:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
		/* Video Tutorial Modal */
		.video-tutorial-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; }
		.video-tutorial-overlay.active { display: flex; }
		.video-tutorial-container { background: #1a1a2e; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.5); }
		.video-tutorial-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
		.video-tutorial-header h3 { margin: 0; color: #fff; font-size: 1.1rem; display: flex; align-items: center; gap: 0.75rem; }
		.video-tutorial-close { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.4rem; transition: all 0.2s; }
		.video-tutorial-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
		.video-tutorial-screen { background: #0f0f1a; position: relative; aspect-ratio: 16/9; }
		.video-tutorial-controls { background: #16162a; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; }
		.video-tutorial-progress { flex: 1; height: 6px; background: #2a2a4a; border-radius: 3px; overflow: hidden; cursor: pointer; }
		.video-tutorial-progress-bar { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 3px; transition: width 0.3s ease; }
		.video-tutorial-btn { background: transparent; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; transition: all 0.2s; }
		.video-tutorial-btn:hover { color: #3b82f6; }
		.video-tutorial-time { color: #94a3b8; font-size: 0.8rem; min-width: 80px; }
		.scene-caption { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 2rem 1.5rem 1rem; }
		.scene-caption p { color: #fff; font-size: 1rem; margin: 0; text-align: center; }
		@media print{body *{visibility:hidden}#incidentDetailsOverlay,#incidentDetailsOverlay *,.printable,.printable *{visibility:visible!important}#incidentDetailsOverlay{position:absolute!important;left:0!important;top:0!important;width:100%!important;padding:0!important;background:transparent!important;display:block!important;overflow:visible!important}.modal-content.inc-preview-container{box-shadow:none!important;border-radius:0!important;width:100%!important;max-width:100%!important}.inc-sheet{width:100%!important;margin:0!important;padding:10mm!important;border:none!important;box-shadow:none!important}.inc-print-btn,.inc-close-btn{display:none!important}.inc-section-title{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}
	</style>
</head>
<body>
<div class="app-container">
	<nav class="sidebar menu-loading" id="sidebar">
		<div class="logo"><h2>Dreamex Datalab</h2></div>
		<ul class="menu" id="roleBasedMenu">
			<li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
			<li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
				<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
				<ul class="submenu">
					<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
					<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
				<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
				<ul class="submenu">
					<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
					<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
					<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
					<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
					<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
					<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
					<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
					<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
					<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
					<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
					<li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
					<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
					<li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
					<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
					<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
					<li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
					<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
					<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
					<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
					<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
					<li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
					<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
					<li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="project_management_section">
				<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
				<ul class="submenu">
					<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
					<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
					<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
					<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
				<a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
				<ul class="submenu">
					<li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
					<li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
					<li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
					<li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
					<li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
					<li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
				<a href="#"><i class="fas fa-utensils"></i> Workspaces â€” Catering</a>
				<ul class="submenu">
					<li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
					<li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
					<li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
					<li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
					<li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
				</ul>
			</li>
			<li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
			<li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
			<li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
					<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
					<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
					<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
					<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
					<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
					<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
					<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
					<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
					<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
	</nav>

	<main class="main-content" id="mainContent">
		<header class="top-nav">
			<div style="display:flex;align-items:center;gap:.7rem">
				<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
				<img id="headerCompanyLogo" alt="Company Logo"/>
				<span id="headerCompanyName"></span>
			</div>
			<div style="display:flex;align-items:center;gap:1rem;position:relative">
				<div class="notifications">
					<button id="notificationBtn" class="notification-btn">
						<i class="fas fa-bell"></i>
						<span class="notification-badge">0</span>
					</button>
					<div class="notification-dropdown">
						<div class="notification-header">
							<h3>Notifications</h3>
							<button class="mark-all-read" type="button">Mark all as read</button>
						</div>
						<div class="notification-list">
							<div class="notification-empty">
								<i class="fas fa-inbox"></i>
								<div class="notification-empty-title">No notifications</div>
								<div class="notification-empty-message">You're all caught up</div>
							</div>
						</div>
					</div>
				</div>
				<div class="user-profile"><button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar"/></button><div class="profile-dropdown"><ul></ul></div></div>
			</div>
		</header>

		<div class="page-header">
			<div style="display:flex;align-items:center;gap:.6rem">
				<i class="fas fa-table-list"></i>
				<span>Incident Board</span>
			</div>
			<div>
				<a href="incident.html" class="btn" style="background:transparent;border:none;color:#fff;font-size:1rem;"><i class="fas fa-plus"></i></a>
			</div>
		</div>

		<!-- Tab Navigation -->
		<div class="tab-nav">
			<button class="tab-btn active" data-tab="incidents"><i class="fas fa-list"></i> Incidents</button>
			<button class="tab-btn" data-tab="actionPlan"><i class="fas fa-tasks"></i> Action Plan</button>
			<button class="tab-btn" data-tab="settings"><i class="fas fa-cog"></i> Settings</button>
		</div>

		<!-- Incidents Tab Content -->
		<div class="tab-content active" id="incidentsTab">
			<div class="card">
				<div class="toolbar">
					<div class="filters">
						<input id="searchInput" class="form-control" placeholder="Search title, ref, location"/>
						<select id="severityFilter" class="form-control">
							<option value="">All Severities</option>
							<option value="low">Low</option>
							<option value="medium">Medium</option>
							<option value="high">High</option>
						</select>
						<select id="statusFilter" class="form-control">
							<option value="">All Status</option>
							<option value="open">Open</option>
							<option value="in-progress">In Progress</option>
							<option value="closed">Closed</option>
							<option value="draft">Draft</option>
						</select>
						<input type="date" id="fromDate" class="form-control"/>
						<input type="date" id="toDate" class="form-control"/>
						<button id="clearFilters" class="btn" style="border:1px solid #ddd;background:#fff">Clear</button>
					</div>
				</div>

				<div style="overflow:auto">
					<table id="incidentsTable">
						<thead>
						<tr>
							<th style="min-width:110px">Reference</th>
							<th style="min-width:220px">Title</th>
							<th style="min-width:110px">Type</th>
							<th>Severity</th>
							<th>Status</th>
							<th style="min-width:110px">Date</th>
							<th>Location</th>
							<th>Department</th>
							<th>Assigned</th>
							<th style="min-width:110px">Actions</th>
						</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>

				<div class="pagination">
					<button id="prevPage">&laquo;</button>
					<span id="pageInfo" style="min-width:120px;text-align:center"></span>
					<button id="nextPage">&raquo;</button>
				</div>
			</div>
		</div>

		<!-- Action Plan Tab Content -->
		<div class="tab-content" id="actionPlanTab">
			<div class="card">
				<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
					<h2 style="font-size:1rem;font-weight:600;color:#111827;margin:0;display:flex;align-items:center;gap:.5rem">
						<i class="fas fa-tasks" style="color:var(--primary-color)"></i> My Action Plan
					</h2>
					<button id="refreshActionPlanBtn" class="btn btn-primary" style="font-size:.75rem;padding:.35rem .6rem" onclick="loadActionPlanData()">
						<i class="fas fa-rotate"></i> Refresh
					</button>
				</div>
				<p style="font-size:.8rem;color:#6b7280;margin-bottom:12px">All corrective actions assigned to you from incidents, near misses, and observations.</p>
				
				<div class="action-plan-filters">
					<select id="actionSourceFilter" class="form-control" onchange="filterActionPlan()">
						<option value="">All Sources</option>
						<option value="incident">Incidents</option>
						<option value="near-miss">Near Misses</option>
						<option value="observation">Observations</option>
					</select>
					<select id="actionStatusFilter" class="form-control" onchange="filterActionPlan()">
						<option value="">All Status</option>
						<option value="pending">Pending</option>
						<option value="in-progress">In Progress</option>
						<option value="completed">Completed</option>
						<option value="overdue">Overdue</option>
					</select>
					<button class="btn" style="border:1px solid #ddd;background:#fff;font-size:.75rem" onclick="clearActionPlanFilters()">Clear</button>
				</div>
				
				<div style="overflow:auto">
					<table class="action-plan-table" id="actionPlanTable">
						<thead>
							<tr>
								<th style="width:100px">Source</th>
								<th style="width:120px">Reference</th>
								<th>Action Title</th>
								<th style="width:160px">Responsible</th>
								<th style="width:100px">Due Date</th>
								<th style="width:100px">Status</th>
								<th style="width:80px">Priority</th>
							</tr>
						</thead>
						<tbody id="actionPlanTableBody"></tbody>
					</table>
				</div>
				
				<div id="actionPlanEmpty" class="action-plan-empty" style="display:none">
					<i class="fas fa-clipboard-check"></i>
					<p style="font-size:.9rem;font-weight:500;color:#6b7280">No actions assigned to you</p>
					<p style="font-size:.8rem;color:#9ca3af">When corrective actions are assigned to you, they will appear here.</p>
				</div>
			</div>
		</div>

		<!-- Settings Tab Content -->
		<div class="tab-content" id="settingsTab">
			<div class="card" style="padding:1.2rem">
				<!-- Settings Header with Toggle All Button -->
				<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #e5e7eb;">
					<h2 style="margin:0;color:var(--primary-color);font-size:1.2rem;display:flex;align-items:center;gap:8px;">
						<i class="fas fa-cog"></i> Settings
					</h2>
					<button type="button" id="toggleAllSettingsBtn" onclick="toggleAllSettingsSections()" style="background:var(--primary-color);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:6px;transition:background 0.2s;">
						<i class="fas fa-compress-alt"></i> Collapse All
					</button>
				</div>
				
				<!-- Dropdown Options Section -->
				<div class="settings-section">
					<h3 onclick="toggleSettingsSection(this)"><i class="fas fa-sliders-h"></i> Dropdown Options <i class="fas fa-chevron-down toggle-icon"></i></h3>
					<div class="settings-section-content">
						<p style="font-size:.75rem;color:#6b7280;margin-bottom:1rem">
							Manage the dropdown options that appear in the incident report form. These settings apply to all users in your company.
						</p>
						
						<!-- Location Options -->
						<div style="margin-bottom:1rem;padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
							<div style="font-size:.8rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
								<i class="fas fa-map-marker-alt" style="color:var(--primary-color);"></i> Location Options
							</div>
							<div id="locationOptionsList" class="option-list" style="margin-bottom:10px;">
								<div class="empty-options">Loading...</div>
							</div>
							<div class="add-option-form">
								<input type="text" id="newLocationInput" placeholder="Enter new location..." />
								<button type="button" onclick="addLocationOption()"><i class="fas fa-plus"></i> Add</button>
							</div>
						</div>

						<!-- Observation Type Options -->
						<div style="margin-bottom:1rem;padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
							<div style="font-size:.8rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
								<i class="fas fa-eye" style="color:var(--primary-color);"></i> Observation Type Options
							</div>
							<div id="observationTypeOptionsList" class="option-list" style="margin-bottom:10px;">
								<div class="empty-options">Loading...</div>
							</div>
							<div class="add-option-form">
								<input type="text" id="newObservationTypeInput" placeholder="Enter new observation type..." />
								<button type="button" onclick="addObservationTypeOption()"><i class="fas fa-plus"></i> Add</button>
							</div>
						</div>

						<!-- Category Options -->
						<div style="margin-bottom:1rem;padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
							<div style="font-size:.8rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
								<i class="fas fa-tags" style="color:var(--primary-color);"></i> Category Options
							</div>
							<div id="categoryOptionsList" class="option-list" style="margin-bottom:10px;">
								<div class="empty-options">Loading...</div>
							</div>
							<div class="add-option-form">
								<input type="text" id="newCategoryInput" placeholder="Enter new category..." />
								<button type="button" onclick="addCategoryOption()"><i class="fas fa-plus"></i> Add</button>
							</div>
						</div>

						<!-- Incident Category Options -->
						<div style="margin-bottom:1rem;padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
							<div style="font-size:.8rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
								<i class="fas fa-exclamation-triangle" style="color:var(--primary-color);"></i> Incident Category Options
							</div>
							<div id="incidentCategoryOptionsList" class="option-list" style="margin-bottom:10px;">
								<div class="empty-options">Loading...</div>
							</div>
							<div class="add-option-form">
								<input type="text" id="newIncidentCategoryInput" placeholder="Enter new incident category..." />
								<button type="button" onclick="addIncidentCategoryOption()"><i class="fas fa-plus"></i> Add</button>
							</div>
						</div>

						<!-- Injury Type Options -->
						<div style="margin-bottom:1rem;padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
							<div style="font-size:.8rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
								<i class="fas fa-band-aid" style="color:var(--primary-color);"></i> Injury Type Options
							</div>
							<div id="injuryTypeOptionsList" class="option-list" style="margin-bottom:10px;">
								<div class="empty-options">Loading...</div>
							</div>
							<div class="add-option-form">
								<input type="text" id="newInjuryTypeInput" placeholder="Enter new injury type..." />
								<button type="button" onclick="addInjuryTypeOption()"><i class="fas fa-plus"></i> Add</button>
							</div>
						</div>

						<!-- Treatment Provided Options -->
						<div style="padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
							<div style="font-size:.8rem;font-weight:600;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
								<i class="fas fa-medkit" style="color:var(--primary-color);"></i> Treatment Provided Options
							</div>
							<div id="treatmentProvidedOptionsList" class="option-list" style="margin-bottom:10px;">
								<div class="empty-options">Loading...</div>
							</div>
							<div class="add-option-form">
								<input type="text" id="newTreatmentProvidedInput" placeholder="Enter new treatment type..." />
								<button type="button" onclick="addTreatmentProvidedOption()"><i class="fas fa-plus"></i> Add</button>
							</div>
						</div>
					</div>
				</div>

				<div class="settings-section">
					<h3 onclick="toggleSettingsSection(this)"><i class="fas fa-bell"></i> Notification Settings <i class="fas fa-chevron-down toggle-icon"></i></h3>
					<div class="settings-section-content">
						<p style="font-size:.75rem;color:#6b7280;margin-bottom:1rem">Configure which users receive email notifications for each event type. Each event type has its own distribution list and action reminder settings.</p>
						
						<!-- Incident Notifications -->
						<div style="margin-bottom:1.5rem;padding:16px;background:#fff;border:1px solid #fee2e2;border-radius:8px;">
							<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
								<div style="display:flex;align-items:center;gap:8px;">
									<i class="fas fa-exclamation-triangle" style="color:#dc2626;font-size:1rem;"></i>
									<span style="font-weight:600;color:#991b1b;font-size:.85rem;">Incident Notifications</span>
								</div>
								<div style="display:flex;align-items:center;gap:12px;">
									<label style="display:flex;align-items:center;gap:5px;font-size:.75rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="incidentOnSubmission" checked onchange="saveNotificationSettings()">
										<span>On Submission</span>
									</label>
									<label style="display:flex;align-items:center;gap:5px;font-size:.75rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="incidentOnUpdate" onchange="saveNotificationSettings()">
										<span>On Update</span>
									</label>
								</div>
							</div>
							<div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px;">
								<div style="flex:1;min-width:200px;">
									<select id="incidentRecipientSelect" style="width:100%;padding:8px 10px;font-size:.8rem;border:1px solid #d1d5db;border-radius:6px;background:#fff;">
										<option value="">Select user to add...</option>
									</select>
								</div>
								<button type="button" onclick="addEventRecipient('incident')" style="padding:8px 14px;font-size:.75rem;background:#dc2626;color:#fff;border:none;border-radius:6px;cursor:pointer;">
									<i class="fas fa-plus"></i> Add
								</button>
							</div>
							<div id="incidentRecipientsList" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;margin-bottom:12px;">
								<span style="font-size:.75rem;color:#9ca3af;font-style:italic;">No recipients configured</span>
							</div>
							
							<!-- Incident Action Reminders -->
							<div style="padding-top:12px;border-top:1px solid #fecaca;">
								<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
									<span style="font-size:.75rem;font-weight:600;color:#991b1b;"><i class="fas fa-clock"></i> Action Plan Reminders</span>
									<div style="display:flex;align-items:center;gap:8px;">
										<span id="autoReminderStatus" style="font-size:.6rem;padding:2px 6px;border-radius:10px;background:#fef3c7;color:#92400e;">â³ Initializing...</span>
										<label style="display:flex;align-items:center;gap:5px;font-size:.7rem;color:#374151;cursor:pointer;">
											<input type="checkbox" id="incidentReminderEnabled" onchange="saveEventReminderSettings('incident')">
											<span>Enable</span>
										</label>
									</div>
								</div>
								<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:8px;margin-bottom:8px;">
									<div>
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Frequency</label>
										<select id="incidentReminderFrequency" onchange="toggleWeekDays('incident');toggleDaysBeforeField('incident');saveEventReminderSettings('incident')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
											<option value="daily">Daily</option>
											<option value="weekly" selected>Weekly</option>
											<option value="bi-weekly">Bi-Weekly</option>
											<option value="monthly">Monthly</option>
											<option value="before-due">Before due date</option>
										</select>
									</div>
									<div>
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Time</label>
										<input type="time" id="incidentReminderTime" value="09:00" onchange="saveEventReminderSettings('incident')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
									</div>
									<div id="incidentDaysBeforeContainer" style="display:none;">
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Days Before Due</label>
										<select id="incidentReminderDaysBefore" onchange="saveEventReminderSettings('incident')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
											<option value="1">1 day before</option>
											<option value="3" selected>3 days before</option>
											<option value="5">5 days before</option>
											<option value="7">7 days before</option>
											<option value="14">14 days before</option>
										</select>
									</div>
								</div>
								<div id="incidentWeekDaysContainer" style="margin-bottom:8px;">
									<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:4px;">Send on Days:</label>
									<div style="display:flex;flex-wrap:wrap;gap:4px;">
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_mon" checked onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Mon
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_tue" onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Tue
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_wed" onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Wed
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_thu" onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Thu
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_fri" onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Fri
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_sat" onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Sat
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="incidentDay_sun" onchange="saveEventReminderSettings('incident')" style="width:12px;height:12px;"> Sun
										</label>
									</div>
								</div>
								<div style="margin-bottom:8px;">
									<label style="display:block;font-size:.65rem;color:#6b7280;margin-bottom:4px;">Reminder Message:</label>
									<textarea id="incidentReminderMessage" onchange="saveEventReminderSettings('incident')" placeholder="Enter custom reminder message for action owners..." style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;min-height:50px;resize:vertical;box-sizing:border-box;">You have pending incident action(s) that require your attention. Please review and complete them before the due date.</textarea>
								</div>
								<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
									<span id="incidentLastReminderSent" style="font-size:.65rem;color:#9ca3af;"></span>
									<div style="display:flex;gap:4px;">
										<button type="button" onclick="saveEventReminderSettings('incident')" style="padding:4px 8px;font-size:.65rem;background:#10b981;color:#fff;border:none;border-radius:3px;cursor:pointer;" title="Save reminder settings">
											<i class="fas fa-save"></i> Save Settings
										</button>
										<button type="button" onclick="testAutoReminder('incident')" style="padding:4px 8px;font-size:.65rem;background:#059669;color:#fff;border:none;border-radius:3px;cursor:pointer;" title="Test automatic reminder system">
											<i class="fas fa-bug"></i> Test Auto
										</button>
										<button type="button" onclick="sendEventReminders('incident')" style="padding:5px 10px;font-size:.7rem;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer;">
											<i class="fas fa-paper-plane"></i> Send Now
										</button>
									</div>
								</div>
							</div>
						</div>
						
						<!-- Near Miss Notifications -->
						<div style="margin-bottom:1.5rem;padding:16px;background:#fff;border:1px solid #fef3c7;border-radius:8px;">
							<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
								<div style="display:flex;align-items:center;gap:8px;">
									<i class="fas fa-exclamation-circle" style="color:#f59e0b;font-size:1rem;"></i>
									<span style="font-weight:600;color:#92400e;font-size:.85rem;">Near Miss Notifications</span>
								</div>
								<div style="display:flex;align-items:center;gap:12px;">
									<label style="display:flex;align-items:center;gap:5px;font-size:.75rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="nearMissOnSubmission" checked onchange="saveNotificationSettings()">
										<span>On Submission</span>
									</label>
									<label style="display:flex;align-items:center;gap:5px;font-size:.75rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="nearMissOnUpdate" onchange="saveNotificationSettings()">
										<span>On Update</span>
									</label>
								</div>
							</div>
							<div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px;">
								<div style="flex:1;min-width:200px;">
									<select id="nearMissRecipientSelect" style="width:100%;padding:8px 10px;font-size:.8rem;border:1px solid #d1d5db;border-radius:6px;background:#fff;">
										<option value="">Select user to add...</option>
									</select>
								</div>
								<button type="button" onclick="addEventRecipient('nearMiss')" style="padding:8px 14px;font-size:.75rem;background:#f59e0b;color:#fff;border:none;border-radius:6px;cursor:pointer;">
									<i class="fas fa-plus"></i> Add
								</button>
							</div>
							<div id="nearMissRecipientsList" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;margin-bottom:12px;">
								<span style="font-size:.75rem;color:#9ca3af;font-style:italic;">No recipients configured</span>
							</div>
							
							<!-- Near Miss Action Reminders -->
							<div style="padding-top:12px;border-top:1px solid #fde68a;">
								<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
									<span style="font-size:.75rem;font-weight:600;color:#92400e;"><i class="fas fa-clock"></i> Action Plan Reminders</span>
									<label style="display:flex;align-items:center;gap:5px;font-size:.7rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="nearMissReminderEnabled" onchange="saveEventReminderSettings('nearMiss')">
										<span>Enable</span>
									</label>
								</div>
								<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:8px;margin-bottom:8px;">
									<div>
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Frequency</label>
										<select id="nearMissReminderFrequency" onchange="toggleWeekDays('nearMiss');toggleDaysBeforeField('nearMiss');saveEventReminderSettings('nearMiss')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
											<option value="daily">Daily</option>
											<option value="weekly" selected>Weekly</option>
											<option value="bi-weekly">Bi-Weekly</option>
											<option value="monthly">Monthly</option>
											<option value="before-due">Before due date</option>
										</select>
									</div>
									<div>
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Time</label>
										<input type="time" id="nearMissReminderTime" value="09:00" onchange="saveEventReminderSettings('nearMiss')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
									</div>
									<div id="nearMissDaysBeforeContainer" style="display:none;">
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Days Before Due</label>
										<select id="nearMissReminderDaysBefore" onchange="saveEventReminderSettings('nearMiss')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
											<option value="1">1 day before</option>
											<option value="3" selected>3 days before</option>
											<option value="5">5 days before</option>
											<option value="7">7 days before</option>
											<option value="14">14 days before</option>
										</select>
									</div>
								</div>
								<div id="nearMissWeekDaysContainer" style="margin-bottom:8px;">
									<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:4px;">Send on Days:</label>
									<div style="display:flex;flex-wrap:wrap;gap:4px;">
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_mon" checked onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Mon
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_tue" onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Tue
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_wed" onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Wed
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_thu" onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Thu
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_fri" onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Fri
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_sat" onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Sat
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="nearMissDay_sun" onchange="saveEventReminderSettings('nearMiss')" style="width:12px;height:12px;"> Sun
										</label>
									</div>
								</div>
								<div style="margin-bottom:8px;">
									<label style="display:block;font-size:.65rem;color:#6b7280;margin-bottom:4px;">Reminder Message:</label>
									<textarea id="nearMissReminderMessage" onchange="saveEventReminderSettings('nearMiss')" placeholder="Enter custom reminder message for action owners..." style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;min-height:50px;resize:vertical;box-sizing:border-box;">You have pending near miss action(s) that require your attention. Please review and complete them before the due date.</textarea>
								</div>
								<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
									<span id="nearMissLastReminderSent" style="font-size:.65rem;color:#9ca3af;"></span>
									<div style="display:flex;gap:4px;">
										<button type="button" onclick="saveEventReminderSettings('nearMiss')" style="padding:4px 8px;font-size:.65rem;background:#10b981;color:#fff;border:none;border-radius:3px;cursor:pointer;" title="Save reminder settings">
											<i class="fas fa-save"></i> Save Settings
										</button>
										<button type="button" onclick="testAutoReminder('nearMiss')" style="padding:4px 8px;font-size:.65rem;background:#059669;color:#fff;border:none;border-radius:3px;cursor:pointer;" title="Test automatic reminder system">
											<i class="fas fa-bug"></i> Test Auto
										</button>
										<button type="button" onclick="sendEventReminders('nearMiss')" style="padding:5px 10px;font-size:.7rem;background:#f59e0b;color:#fff;border:none;border-radius:4px;cursor:pointer;">
											<i class="fas fa-paper-plane"></i> Send Now
										</button>
									</div>
								</div>
							</div>
						</div>
						
						<!-- Observation Notifications -->
						<div style="margin-bottom:1.5rem;padding:16px;background:#fff;border:1px solid #dbeafe;border-radius:8px;">
							<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
								<div style="display:flex;align-items:center;gap:8px;">
									<i class="fas fa-eye" style="color:#3b82f6;font-size:1rem;"></i>
									<span style="font-weight:600;color:#1e40af;font-size:.85rem;">Observation Notifications</span>
								</div>
								<div style="display:flex;align-items:center;gap:12px;">
									<label style="display:flex;align-items:center;gap:5px;font-size:.75rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="observationOnSubmission" checked onchange="saveNotificationSettings()">
										<span>On Submission</span>
									</label>
									<label style="display:flex;align-items:center;gap:5px;font-size:.75rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="observationOnUpdate" onchange="saveNotificationSettings()">
										<span>On Update</span>
									</label>
								</div>
							</div>
							<div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px;">
								<div style="flex:1;min-width:200px;">
									<select id="observationRecipientSelect" style="width:100%;padding:8px 10px;font-size:.8rem;border:1px solid #d1d5db;border-radius:6px;background:#fff;">
										<option value="">Select user to add...</option>
									</select>
								</div>
								<button type="button" onclick="addEventRecipient('observation')" style="padding:8px 14px;font-size:.75rem;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;">
									<i class="fas fa-plus"></i> Add
								</button>
							</div>
							<div id="observationRecipientsList" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;margin-bottom:12px;">
								<span style="font-size:.75rem;color:#9ca3af;font-style:italic;">No recipients configured</span>
							</div>
							
							<!-- Observation Action Reminders -->
							<div style="padding-top:12px;border-top:1px solid #bfdbfe;">
								<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
									<span style="font-size:.75rem;font-weight:600;color:#1e40af;"><i class="fas fa-clock"></i> Action Plan Reminders</span>
									<label style="display:flex;align-items:center;gap:5px;font-size:.7rem;color:#374151;cursor:pointer;">
										<input type="checkbox" id="observationReminderEnabled" onchange="saveEventReminderSettings('observation')">
										<span>Enable</span>
									</label>
								</div>
								<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:8px;margin-bottom:8px;">
									<div>
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Frequency</label>
										<select id="observationReminderFrequency" onchange="toggleWeekDays('observation');toggleDaysBeforeField('observation');saveEventReminderSettings('observation')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
											<option value="daily">Daily</option>
											<option value="weekly" selected>Weekly</option>
											<option value="bi-weekly">Bi-Weekly</option>
											<option value="monthly">Monthly</option>
											<option value="before-due">Before due date</option>
										</select>
									</div>
									<div>
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Time</label>
										<input type="time" id="observationReminderTime" value="09:00" onchange="saveEventReminderSettings('observation')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
									</div>
									<div id="observationDaysBeforeContainer" style="display:none;">
										<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:2px;">Days Before Due</label>
										<select id="observationReminderDaysBefore" onchange="saveEventReminderSettings('observation')" style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
											<option value="1">1 day before</option>
											<option value="3" selected>3 days before</option>
											<option value="5">5 days before</option>
											<option value="7">7 days before</option>
											<option value="14">14 days before</option>
										</select>
									</div>
								</div>
								<div id="observationWeekDaysContainer" style="margin-bottom:8px;">
									<label style="display:block;font-size:.6rem;color:#6b7280;margin-bottom:4px;">Send on Days:</label>
									<div style="display:flex;flex-wrap:wrap;gap:4px;">
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_mon" checked onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Mon
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_tue" onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Tue
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_wed" onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Wed
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_thu" onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Thu
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_fri" onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Fri
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_sat" onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Sat
										</label>
										<label style="display:flex;align-items:center;gap:2px;font-size:.65rem;color:#374151;cursor:pointer;padding:3px 6px;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;">
											<input type="checkbox" id="observationDay_sun" onchange="saveEventReminderSettings('observation')" style="width:12px;height:12px;"> Sun
										</label>
									</div>
								</div>
								<div style="margin-bottom:8px;">
									<label style="display:block;font-size:.65rem;color:#6b7280;margin-bottom:4px;">Reminder Message:</label>
									<textarea id="observationReminderMessage" onchange="saveEventReminderSettings('observation')" placeholder="Enter custom reminder message for action owners..." style="width:100%;padding:6px 8px;font-size:.7rem;border:1px solid #d1d5db;border-radius:4px;background:#fff;min-height:50px;resize:vertical;box-sizing:border-box;">You have pending observation action(s) that require your attention. Please review and complete them before the due date.</textarea>
								</div>
								<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
									<span id="observationLastReminderSent" style="font-size:.65rem;color:#9ca3af;"></span>
									<div style="display:flex;gap:4px;">
										<button type="button" onclick="saveEventReminderSettings('observation')" style="padding:4px 8px;font-size:.65rem;background:#10b981;color:#fff;border:none;border-radius:3px;cursor:pointer;" title="Save reminder settings">
											<i class="fas fa-save"></i> Save Settings
										</button>
										<button type="button" onclick="testAutoReminder('observation')" style="padding:4px 8px;font-size:.65rem;background:#059669;color:#fff;border:none;border-radius:3px;cursor:pointer;" title="Test automatic reminder system">
											<i class="fas fa-bug"></i> Test Auto
										</button>
										<button type="button" onclick="sendEventReminders('observation')" style="padding:5px 10px;font-size:.7rem;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;">
											<i class="fas fa-paper-plane"></i> Send Now
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="settings-section">
					<h3 onclick="toggleSettingsSection(this)"><i class="fas fa-user-shield"></i> Access Control <i class="fas fa-chevron-down toggle-icon"></i></h3>
					<div class="settings-section-content">
						<p style="font-size:.75rem;color:#6b7280;margin-bottom:.8rem">Control which users can access the Incidents tab and Settings tab on this page.</p>
						<div style="margin-bottom:.8rem">
							<button type="button" class="ac-add-btn" onclick="openIncidentAccessControlModal()"><i class="fas fa-plus"></i> Add User</button>
						</div>
						<div style="overflow-x:auto">
							<table class="access-control-table" id="incidentAccessControlTable">
								<thead>
									<tr>
										<th>User</th>
										<th>Email</th>
										<th>Job Title</th>
										<th style="text-align:center">Incidents Tab</th>
										<th style="text-align:center">Settings Tab</th>
										<th style="text-align:center">Edit/Delete All</th>
										<th style="text-align:center">Actions</th>
									</tr>
								</thead>
								<tbody id="incidentAccessControlTableBody">
									<tr><td colspan="6" style="text-align:center;color:#9ca3af">Loading...</td></tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
</div>

<!-- Access Control Modal -->
<div class="ac-modal" id="incidentAccessControlModal" style="display:none;">
	<div class="ac-modal-content">
		<div class="ac-modal-header">
			<h3><i class="fas fa-user-shield"></i> Add User Access</h3>
			<button class="ac-modal-close" onclick="closeIncidentAccessControlModal()">&times;</button>
		</div>
		<div class="ac-modal-body">
			<div class="form-group">
				<label>Select User</label>
				<select id="acIncidentUserSelect">
					<option value="">Loading users...</option>
				</select>
			</div>
			<div class="form-group">
				<label>Tab Permissions</label>
				<div class="checkbox-group">
					<label class="checkbox-item">
						<input type="checkbox" id="acIncidentsTab" checked>
						Incidents Tab
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="acSettingsTab">
						Settings Tab
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="acEditDeleteTab">
						Edit/Delete All Incidents
					</label>
				</div>
			</div>
		</div>
		<div class="ac-modal-footer">
			<button class="btn btn-cancel" onclick="closeIncidentAccessControlModal()">Cancel</button>
			<button class="btn btn-save" onclick="saveIncidentAccessControl()">Add</button>
		</div>
	</div>
</div>

<!-- Incident Details Modal - Clean Redesign -->
<div class="modal-overlay" id="incidentDetailsOverlay" style="display:none;">
	<div class="modal-content inc-preview-container">
		<button id="incPrintBtn" class="inc-print-btn"><i class="fas fa-print"></i> Print / PDF</button>
		<button id="incCloseBtn" class="inc-close-btn">Close</button>
		
		<div class="inc-sheet printable">
			<!-- Header with Company Logo and Name -->
			<div class="inc-header">
				<div class="company-block" style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;">
					<img id="incModalLogo" class="inc-logo" src="" alt="Company Logo" style="display:none;">
					<div id="incModalLogoFallback" class="inc-logo-fallback"></div>
					<div class="inc-company">
						<h1 id="incModalCompanyName"></h1>
						<h2 class="doc-title">Incident Report</h2>
					</div>
				</div>
				<div class="inc-meta">
					<div id="incModalGenerated" class="generated"></div>
				</div>
			</div>
			
			<div class="inc-divider"></div>
			
			<!-- Document Number -->
			<div class="inc-docmeta-row">
				<span>Reference Number:</span>
				<span id="incModalRef"></span>
			</div>
			
			<!-- Sections -->
			<div class="inc-sections">
				<!-- Basic Information -->
				<div class="section">
					<div class="inc-section-title"><i class="fas fa-clipboard-list"></i><span class="section-text">Basic Information</span></div>
					<div id="incSectionBasic" class="inc-fields-grid"></div>
				</div>
				
				<!-- Event Details -->
				<div class="section">
					<div class="inc-section-title"><i class="fas fa-info-circle"></i><span class="section-text">Event Details</span></div>
					<div id="incSectionEvent"></div>
				</div>
				
				<!-- Injury Details -->
				<div class="section" id="incInjurySection" style="display:none;">
					<div class="inc-section-title"><i class="fas fa-user-injured"></i><span class="section-text">Injury Details</span></div>
					<div id="incSectionInjury" class="inc-fields-grid"></div>
				</div>
				
				<!-- Property Damage -->
				<div class="section" id="incDamageSection" style="display:none;">
					<div class="inc-section-title"><i class="fas fa-building"></i><span class="section-text">Property Damage</span></div>
					<div id="incSectionDamage" class="inc-fields-grid"></div>
				</div>
				
				<!-- Actions -->
				<div class="section" id="incActionsSection" style="display:none;">
					<div class="inc-section-title"><i class="fas fa-tasks"></i><span class="section-text">Actions</span></div>
					<div id="incSectionActions"></div>
				</div>
				
				<!-- Attachments -->
				<div class="section" id="incAttachmentsSection" style="display:none;">
					<div class="inc-section-title"><i class="fas fa-paperclip"></i><span class="section-text">Attachments</span></div>
					<div id="incSectionAttachments"></div>
				</div>
				
				<!-- Modal Actions -->
				<div id="incModalActions" class="section" style="display:none;padding-top:16px;border-top:1px solid #e5e7eb;margin-top:8px;">
					<div style="display:flex;gap:10px;">
						<button type="button" onclick="editCurrentIncident()" style="background:var(--primary-color);color:#fff;border:none;font-size:.8rem;padding:8px 16px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">
							<i class="fas fa-edit"></i> Edit
						</button>
						<button type="button" onclick="deleteCurrentIncident()" style="background:#dc2626;color:#fff;border:none;font-size:.8rem;padding:8px 16px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">
							<i class="fas fa-trash"></i> Delete
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Action Plan Details Modal -->
<div class="modal-overlay" id="actionPlanDetailsOverlay" style="display:none;">
	<div class="modal-content" style="max-width:600px;background:#fff;border-radius:0;padding:0;overflow:hidden;">
		<div style="background:var(--primary-color);color:#fff;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;">
			<h3 style="margin:0;font-size:1.1rem;display:flex;align-items:center;gap:10px;">
				<i class="fas fa-clipboard-check"></i> Action Plan Details
			</h3>
			<button onclick="closeActionPlanDetails()" style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;opacity:0.8;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
				<i class="fas fa-times"></i>
			</button>
		</div>
		
		<div style="padding:20px;">
			<!-- Source & Reference -->
			<div style="display:flex;gap:12px;margin-bottom:16px;">
				<div id="apDetailSource" style="display:inline-flex;align-items:center;"></div>
				<div style="font-size:.85rem;color:#6b7280;">
					<span style="font-weight:500;">Reference:</span>
					<span id="apDetailReference" style="color:#111827;font-weight:600;"></span>
				</div>
			</div>
			
			<!-- Incident Title -->
			<div style="margin-bottom:16px;padding:12px;background:#f9fafb;border-radius:8px;border-left:3px solid var(--primary-color);">
				<div style="font-size:.75rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Incident Title</div>
				<div id="apDetailTitle" style="font-size:.9rem;color:#111827;font-weight:500;"></div>
			</div>
			
			<!-- Action Description -->
			<div style="margin-bottom:16px;">
				<div style="font-size:.75rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Action Description</div>
				<div id="apDetailDescription" style="font-size:.9rem;color:#111827;line-height:1.5;padding:12px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;"></div>
			</div>
			
			<!-- Responsible -->
			<div style="margin-bottom:16px;">
				<div style="font-size:.75rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Responsible Person</div>
				<div id="apDetailResponsible" style="font-size:.9rem;color:#111827;padding:10px 12px;background:#f9fafb;border-radius:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-user" style="color:#6b7280;"></i> <span></span></div>
			</div>
			
			<!-- Status, Priority, Due Date Grid -->
			<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
				<div style="text-align:center;padding:12px;background:#f9fafb;border-radius:8px;">
					<div style="font-size:.7rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Status</div>
					<div id="apDetailStatus"></div>
				</div>
				<div style="text-align:center;padding:12px;background:#f9fafb;border-radius:8px;">
					<div style="font-size:.7rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Priority</div>
					<div id="apDetailPriority"></div>
				</div>
				<div style="text-align:center;padding:12px;background:#f9fafb;border-radius:8px;">
					<div style="font-size:.7rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Due Date</div>
					<div id="apDetailDueDate" style="font-size:.9rem;font-weight:600;color:#111827;"></div>
				</div>
			</div>
			
			<!-- Action Buttons -->
			<div style="display:flex;gap:10px;justify-content:flex-end;padding-top:16px;border-top:1px solid #e5e7eb;">
				<button onclick="viewFullIncident()" style="background:#fff;color:#374151;border:1px solid #d1d5db;padding:10px 20px;border-radius:6px;font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:6px;">
					<i class="fas fa-external-link-alt"></i> View Full Incident
				</button>
				<button onclick="sendManualActionReminder()" style="background:#10b981;color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:6px;">
					<i class="fas fa-envelope"></i> Send Reminder
				</button>
				<button onclick="closeActionPlanDetails()" style="background:var(--primary-color);color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:.85rem;cursor:pointer;">
					Close
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Guide Container -->
<div id="guideContainer"></div>

<!-- Help Guide Button -->
<button class="guide-start-btn" id="startGuideBtn" onclick="startInteractiveGuide()" title="Help Guide">
	<i class="fas fa-question-circle"></i>
</button>

<!-- Demo Video Button -->
<button class="video-btn" id="demoMenuBtn" onclick="toggleDemoDropdown()" title="Watch Demo">
	<i class="fas fa-play-circle"></i>
</button>

<!-- Demo Dropdown Menu -->
<div class="demo-dropdown" id="demoDropdown">
	<div class="demo-dropdown-header"><i class="fas fa-video"></i> Available Demos</div>
	<div class="demo-dropdown-item" onclick="showIncidentDemo('near-miss'); closeDemoDropdown();">
		<i class="fas fa-exclamation-triangle demo-icon-create" style="color:#f59e0b"></i>
		<span>How to Report a Near Miss</span>
	</div>
	<div class="demo-dropdown-item" onclick="showIncidentDemo('observation'); closeDemoDropdown();">
		<i class="fas fa-eye demo-icon-view" style="color:#3b82f6"></i>
		<span>How to Report an Observation</span>
	</div>
	<div class="demo-dropdown-item" onclick="showIncidentDemo('incident'); closeDemoDropdown();">
		<i class="fas fa-file-alt demo-icon-create" style="color:#ef4444"></i>
		<span>How to Report an Incident</span>
	</div>
</div>

<!-- Near Miss Demo Video Tutorial -->
<div class="video-tutorial-overlay" id="nearMissDemoOverlay">
	<div class="video-tutorial-container" style="max-width:1000px; width:95%;">
		<div class="video-tutorial-header" style="background:linear-gradient(135deg, #f59e0b, #d97706);">
			<h3><i class="fas fa-exclamation-triangle"></i> How to Report a Near Miss</h3>
			<button class="video-tutorial-close" onclick="closeNearMissDemo()">&times;</button>
		</div>
		<div class="video-tutorial-screen" id="nearMissVideoScreen" style="position:relative; overflow:hidden;">
			<div id="nearMissDemoSceneContainer" style="width:100%; height:100%; position:relative; background:#f1f5f9;"></div>
			<div class="scene-caption" id="nearMissDemoCaption">
				<p id="nearMissDemoCaptionText"><strong>Welcome!</strong> Let's learn how to report a near miss</p>
			</div>
		</div>
		<div class="video-tutorial-controls">
			<button class="video-tutorial-btn" id="nearMissPlayPauseBtn" onclick="toggleNearMissPlayPause()">
				<i class="fas fa-pause"></i>
			</button>
			<div class="video-tutorial-progress" onclick="seekNearMissVideo(event)">
				<div class="video-tutorial-progress-bar" id="nearMissProgressBar" style="width:0%"></div>
			</div>
			<span class="video-tutorial-time" id="nearMissVideoTime">0:00 / 0:30</span>
			<button class="video-tutorial-btn" onclick="restartNearMissVideo()">
				<i class="fas fa-redo"></i>
			</button>
		</div>
	</div>
</div>

<!-- Observation Demo Video Tutorial -->
<div class="video-tutorial-overlay" id="observationDemoOverlay">
	<div class="video-tutorial-container" style="max-width:1000px; width:95%;">
		<div class="video-tutorial-header" style="background:linear-gradient(135deg, #3b82f6, #2563eb);">
			<h3><i class="fas fa-eye"></i> How to Report an Observation</h3>
			<button class="video-tutorial-close" onclick="closeObservationDemo()">&times;</button>
		</div>
		<div class="video-tutorial-screen" id="observationVideoScreen" style="position:relative; overflow:hidden;">
			<div id="observationDemoSceneContainer" style="width:100%; height:100%; position:relative; background:#f1f5f9;"></div>
			<div class="scene-caption" id="observationDemoCaption">
				<p id="observationDemoCaptionText"><strong>Welcome!</strong> Let's learn how to report an observation</p>
			</div>
		</div>
		<div class="video-tutorial-controls">
			<button class="video-tutorial-btn" id="observationPlayPauseBtn" onclick="toggleObservationPlayPause()">
				<i class="fas fa-pause"></i>
			</button>
			<div class="video-tutorial-progress" onclick="seekObservationVideo(event)">
				<div class="video-tutorial-progress-bar" id="observationProgressBar" style="width:0%"></div>
			</div>
			<span class="video-tutorial-time" id="observationVideoTime">0:00 / 0:30</span>
			<button class="video-tutorial-btn" onclick="restartObservationVideo()">
				<i class="fas fa-redo"></i>
			</button>
		</div>
	</div>
</div>

<!-- Incident Demo Video Tutorial -->
<div class="video-tutorial-overlay" id="incidentDemoOverlay">
	<div class="video-tutorial-container" style="max-width:1000px; width:95%;">
		<div class="video-tutorial-header" style="background:linear-gradient(135deg, #ef4444, #dc2626);">
			<h3><i class="fas fa-file-alt"></i> How to Report an Incident</h3>
			<button class="video-tutorial-close" onclick="closeIncidentDemoVideo()">&times;</button>
		</div>
		<div class="video-tutorial-screen" id="incidentVideoScreen" style="position:relative; overflow:hidden;">
			<div id="incidentDemoSceneContainer" style="width:100%; height:100%; position:relative; background:#f1f5f9;"></div>
			<div class="scene-caption" id="incidentDemoCaption">
				<p id="incidentDemoCaptionText"><strong>Welcome!</strong> Let's learn how to report an incident</p>
			</div>
		</div>
		<div class="video-tutorial-controls">
			<button class="video-tutorial-btn" id="incidentPlayPauseBtn" onclick="toggleIncidentPlayPause()">
				<i class="fas fa-pause"></i>
			</button>
			<div class="video-tutorial-progress" onclick="seekIncidentVideo(event)">
				<div class="video-tutorial-progress-bar" id="incidentProgressBar" style="width:0%"></div>
			</div>
			<span class="video-tutorial-time" id="incidentVideoTime">0:00 / 0:30</span>
			<button class="video-tutorial-btn" onclick="restartIncidentDemoVideo()">
				<i class="fas fa-redo"></i>
			</button>
		</div>
	</div>
</div>

<!-- Firebase v8 Scripts for Centralized Authentication (match project-list) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<!-- EmailJS CDN for email notifications -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
// Firebase configuration (match project-list centralized auth)
const firebaseConfig={
	apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
	authDomain:"users-8be65.firebaseapp.com",
	databaseURL:"https://users-8be65-default-rtdb.firebaseio.com",
	projectId:"users-8be65",
	storageBucket:"users-8be65.firebasestorage.app",
	messagingSenderId:"909025468149",
	appId:"1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
	measurementId:"G-XHFMRCJQEZ"
};
function initializeFirebase(){ if(!window.firebase || !window.firebase.apps || window.firebase.apps.length===0){ window.firebase.initializeApp(firebaseConfig); } return window.firebase; }
const firebase=initializeFirebase();
const db=firebase.database(), auth=firebase.auth(), storage=firebase.storage();

// Centralized AuthManager (copied to match project-list)
class AuthManager{
	constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; this.init(); }
	getCurrentUser(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch{ return null; } }
	setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
	async init(){ if(!this.currentUser){ window.location.href='login.html'; return; } await this.loadUserCompany(); this.updateCompanyBranding(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); }
	async loadUserCompany(){ if(!this.currentUser) return; try{ const snap=await firebase.database().ref('companies').once('value'); if(!snap.exists()) return; const companies=snap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users){ for(const [uid,u] of Object.entries(comp.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId=cid; this.currentUser.companyName=comp.companyName; this.currentUser.role=u.role||u.userRole||'user'; this.currentCompany=comp; this.setCurrentUser(this.currentUser); return; } } } } }catch(e){} }
	updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ return; } if(nameEl){ nameEl.textContent=this.currentCompany.companyName||''; nameEl.classList.add('visible'); } const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else if(this.currentCompany.companyName) { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
	showFallbackBranding(){ /* Do nothing - don't show fallback branding */ }
	getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
	generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
	getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
	getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
	async getUserAvatarUrl(){ if(!this.currentUser) return null; const companyId=this.currentUser.companyId||'default'; const paths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`]; for(const p of paths){ try{ const ref=firebase.storage().ref(p); const url=await ref.getDownloadURL(); return url; }catch(err){ continue; } } return null; }
	async updateUIForAuthenticatedUser(){ const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.currentUser.email||''; let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); }catch(e){} const btnImg=btn.querySelector('img'); if(avatarUrl&&btnImg){ btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }; } else { btn.innerHTML=`<div style=\"width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem;\">${this.getUserInitials()}</div>`; }
		const avatarHtml= avatarUrl? `<img src=\"${avatarUrl}\" alt=\"${displayName} Avatar\" style=\"width:32px;height:32px;border-radius:50%;object-fit:cover;\">` : `<div style=\"width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;\">${this.getUserInitials()}</div>`; list.innerHTML=`<li style=\"border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;\"><div style=\"display:flex;align-items:center;gap:12px;\">${avatarHtml}<div><div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${displayName}</div><div style=\"color:#666;font-size:12px;\">${email}</div></div></div></li><li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`; list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); }); }
	bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click', e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click', e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
	async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; }catch(error){ console.error('Logout error:',error); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } }
}

// ===== ROLE-BASED MENU AUTHORIZATION SYSTEM (copied from project-list) =====
let isMenuUpdateInProgress=false;
function resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
function showSidebarAfterAuth(){ const sidebar=document.querySelector('.sidebar'); if(sidebar){ sidebar.classList.remove('menu-loading'); } }
function ensureHomeIsVisible(){ const homeItem=document.querySelector('#roleBasedMenu li[data-feature="home_view"]'); if(homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible'); }
function hideItemsRequiringPermissions(){ const items=document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]'); items.forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(d=>{ const vis=d.querySelectorAll('.submenu li.menu-visible'); if(vis.length===0) d.classList.remove('menu-visible'); }); ensureHomeIsVisible(); }
async function applyFeatureBasedMenuVisibility(companyId){ try{ const database=firebase.database(); const featuresSnapshot=await database.ref('/platformFeatures').once('value'); if(!featuresSnapshot.exists()){ resetMenuVisibility(); return []; } const featuresData=featuresSnapshot.val(); const companySnapshot=await database.ref(`/companies/${companyId}`).once('value'); const companyData=companySnapshot.val(); if(!companyData){ resetMenuVisibility(); return []; } const subscribedFeatureIds=companyData.selectedFeatures||[]; if(subscribedFeatureIds.length===0){ resetMenuVisibility(); return []; } const authorizedPages=[]; subscribedFeatureIds.forEach(fid=>{ const feature=featuresData[fid]; if(feature && feature.status==='active' && feature.authorizedPages){ authorizedPages.push(...feature.authorizedPages); } }); resetMenuVisibility(); const authorizedFeatures=new Set(); const authorizedHrefs=new Set(); const featureAlias=(key)=>{ if(!key) return key; if(key==='risk_view') return 'risk_management_section'; if(key==='risk_management_section') return 'risk_view'; return null; }; const normalizeHref=(href)=>{ if(!href) return ''; try{ const u=new URL(href, window.location.origin); return (u.pathname||'').replace(/^\//,''); }catch{ return String(href).replace(/^\//,''); } }; authorizedPages.forEach(p=>{ if(p.feature){ authorizedFeatures.add(p.feature); const alias=featureAlias(p.feature); if(alias) authorizedFeatures.add(alias); } if(p.href) authorizedHrefs.add(normalizeHref(p.href)); if(p.page) authorizedHrefs.add(normalizeHref(p.page)); if(p.url) authorizedHrefs.add(normalizeHref(p.url)); }); const allMenuItems=document.querySelectorAll('#roleBasedMenu li[data-feature]'); allMenuItems.forEach(mi=>{ const feat=mi.getAttribute('data-feature'); const isDropdown=mi.classList.contains('menu-dropdown'); const a=mi.querySelector('a[href]'); const href=a?a.getAttribute('href'):''; const normalized=href?href.replace(/^\//,''):''; const isAuthorized=authorizedFeatures.has(feat) || (normalized && authorizedHrefs.has(normalized)); if(!isDropdown){ if(isAuthorized) mi.classList.add('menu-visible'); else mi.classList.remove('menu-visible'); } }); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ const df=drop.getAttribute('data-feature'); const hasVisible=[...drop.querySelectorAll('.submenu li[data-feature]')].some(li=>li.classList.contains('menu-visible')); if(hasVisible || authorizedFeatures.has(df)) drop.classList.add('menu-visible'); else drop.classList.remove('menu-visible'); }); return authorizedPages; }catch(e){ resetMenuVisibility(); return []; } }
async function applyRoleBasedFiltering(companyId, userRole){ try{ const database=firebase.database(); const permissionsRef=database.ref(`companies/${companyId}/roles/${userRole}/permissions`); const snap=await permissionsRef.once('value'); if(!snap.exists()){ if(userRole==='administrator'){ showSidebarAfterAuth(); return; } hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; } const permissions=snap.val(); filterMenuByPermissions(permissions); }catch(e){ showSidebarAfterAuth(); }
}
function filterMenuByPermissions(permissions){ const permissionAlias=(key)=>{ if(!key) return key; if(key==='risk_view') return 'risk_management_section'; if(key==='risk_management_section') return 'risk_view'; return null; }; const items=document.querySelectorAll('#roleBasedMenu li[data-requires-permission]'); items.forEach(item=>{ const req=item.getAttribute('data-requires-permission'); const perm=permissions[req]; const aliasKey=permissionAlias(req); const aliasPerm=aliasKey?permissions[aliasKey]:undefined; const hasView=(p)=> p===true || (p && p.view===true); const allowed=hasView(perm) || hasView(aliasPerm); if(allowed) item.classList.add('menu-visible'); else item.classList.remove('menu-visible'); }); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ const submenuVisible=drop.querySelectorAll('.submenu li.menu-visible').length>0; const req=drop.getAttribute('data-requires-permission'); if(submenuVisible) { drop.classList.add('menu-visible'); } else if(req){ const perm=permissions[req]; const aliasKey=permissionAlias(req); const aliasPerm=aliasKey?permissions[aliasKey]:undefined; const hasView=(p)=> p===true || (p && p.view===true); if(hasView(perm)||hasView(aliasPerm)) drop.classList.add('menu-visible'); else drop.classList.remove('menu-visible'); } else { drop.classList.remove('menu-visible'); } }); ensureHomeIsVisible(); showSidebarAfterAuth(); }
async function updateMenuWithFeatureAuthorization(){ if(isMenuUpdateInProgress) return; isMenuUpdateInProgress=true; try{ let cu=null, companyId=null, userRole=null; if(window.authManager && window.authManager.currentUser){ cu=window.authManager.currentUser; companyId=cu.companyId; userRole=cu.role; } else if(firebase.auth().currentUser){ cu=firebase.auth().currentUser; } if(!companyId && cu){ const companies=(await firebase.database().ref('companies').once('value')).val()||{}; for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users && comp.users[cu.uid]){ companyId=cid; userRole=comp.users[cu.uid].role||comp.users[cu.uid].userRole; break; } } } if(!companyId){ resetMenuVisibility(); return; } const pages=await applyFeatureBasedMenuVisibility(companyId); if(userRole){ await applyRoleBasedFiltering(companyId, userRole, pages); } } finally { isMenuUpdateInProgress=false; } }
function initializeMenuAuthorization(){ const sidebar=document.querySelector('.sidebar'); if(sidebar) sidebar.classList.add('menu-loading'); setTimeout(()=>{ updateMenuWithFeatureAuthorization(); }, 300); }
// ===== END ROLE-BASED MENU AUTHORIZATION SYSTEM =====

function bindSidebarToggle(){
	const btn=document.getElementById('sidebarToggle'), sidebar=document.querySelector('.sidebar'), main=document.getElementById('mainContent');
	if(!btn||!sidebar||!main) return;
	btn.addEventListener('click',()=>{
		const collapsed=sidebar.classList.toggle('collapsed');
		if(collapsed){
			main.classList.add('sidebar-collapsed');
		} else {
			main.classList.remove('sidebar-collapsed');
		}
	});
}
function svgInitials(name='U'){ const initials=(name.trim().split(/\s+/).slice(0,2).map(p=>p[0]).join('')||'U').toUpperCase(); const svg=`<svg width="38" height="38" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="#3498db"/><text x="20" y="25" text-anchor="middle" fill="#fff" font-size="14" font-weight="600" font-family="Inter, Arial, sans-serif">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
function setBranding(company){ const logo=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl && company?.companyName){ nameEl.textContent=company.companyName; nameEl.classList.add('visible'); } if(logo && company){ if(company.logo||company.logoUrl){ logo.src=company.logo||company.logoUrl; logo.classList.add('visible'); } else if(company.companyName) { logo.src=svgInitials(company.companyName); logo.classList.add('visible'); } } if(company?.branding){ const root=document.documentElement; if(company.branding.primaryColor) root.style.setProperty('--primary-color',company.branding.primaryColor); if(company.branding.secondaryColor) root.style.setProperty('--secondary-color',company.branding.secondaryColor); } }
// Avatar helpers (matching project-list)
function getUserDisplayName(u){ if(!u) return 'User'; const n=v=>typeof v==='string'?v.trim().replace(/\s+/g,' '):''; const cand=[u.displayName,u.name,u.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(u.email){ return n(u.email.split('@')[0])||'User'; } return 'User'; }
function getUserInitials(u){ const dn=getUserDisplayName(u); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
async function getUserAvatarUrl(u){ if(!u) return null; const companyId=await getCompanyIdFor(u.uid) || 'default'; const paths=[`companies/${companyId}/avatars/${u.uid}/profile.jpg`,`companies/${companyId}/avatars/${u.uid}/profile.png`,`companies/${companyId}/avatars/${u.uid}/profile.jpeg`,`companies/${companyId}/avatars/${u.uid}/avatar.jpg`,`companies/${companyId}/avatars/${u.uid}/avatar.png`,`avatars/${u.uid}/profile.jpg`,`avatars/${u.uid}/profile.png`,`avatars/${u.uid}/avatar.jpg`,`avatars/${u.uid}/avatar.png`,`profiles/${u.uid}/profile.jpg`,`profiles/${u.uid}/profile.png`]; for(const p of paths){ try{ const ref=storage.ref(p); const url=await ref.getDownloadURL(); return url; }catch(e){ } } return null; }
async function getCompanyIdFor(uid){ const snap=await db.ref('users/'+uid).once('value'); const u=snap.val()||{}; return u.companyId||u.companyID||u.company||u.company_id||null; }
async function getCompany(companyId){ if(!companyId) return null; const snap=await db.ref('companies/'+companyId).once('value'); const c=snap.val()||null; if(c) c.companyId=companyId; return c; }

const state={ items:[], filtered:[], page:1, pageSize:20, users:{}, departments:{} };

function badge(sev){ return `<span class="badge ${sev||'low'}">${(sev||'low').replace(/\b\w/g,m=>m.toUpperCase())}</span>`; }
function statusChip(s){ return `<span class="status ${s}">${(s||'open').replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase())}</span>`; }
function eventTypeLabel(t){ const v=(t||'incident'); if(v==='near-miss') return 'Near Miss'; return v.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); }

function applyFilters(){
	const q=document.getElementById('searchInput').value.trim().toLowerCase();
	const sev=document.getElementById('severityFilter').value;
	const st=document.getElementById('statusFilter').value;
	const from=document.getElementById('fromDate').value;
	const to=document.getElementById('toDate').value;
	state.filtered=state.items.filter(x=>{
		if(sev && x.severity!==sev) return false;
		if(st && x.status!==st) return false;
		if(from && (x.date||'')<from) return false;
		if(to && (x.date||'')>to) return false;
		if(q){
			const hay=[x.referenceNumber,x.title,x.location,x.department].filter(Boolean).join(' ').toLowerCase();
			if(!hay.includes(q)) return false;
		}
		return true;
	});
	state.page=1;
	renderTable();
}

function renderTable(){
	const tbody=document.querySelector('#incidentsTable tbody'); tbody.innerHTML='';
	const start=(state.page-1)*state.pageSize; const end=start+state.pageSize;
	const pageItems=state.filtered.slice(start,end);
	pageItems.forEach(x=>{
		const tr=document.createElement('tr');
		tr.className='clickable-row';
		tr.dataset.incidentId=x.id;
		tr.innerHTML=`
			<td>${x.referenceNumber||'-'}</td>
			<td>${x.title||'-'}</td>
			<td>${eventTypeLabel(x.eventType)}</td>
			<td>${badge(x.severity)}</td>
			<td>${statusChip(x.status||'open')}</td>
			<td>${x.date||'-'}</td>
			<td>${x.location||'-'}</td>
			<td>${getDepartmentLabel(x.department)}</td>
			<td>${state.users[x.assignedTo]?.name||'-'}</td>
			<td>
				<a class="btn" style="border:1px solid #ddd;background:#fff" href="incident.html?id=${x.id}" onclick="event.stopPropagation()"><i class="fas fa-pen"></i> Edit</a>
			</td>`;
		tr.addEventListener('click', ()=> openIncidentDetails(x.id));
		tbody.appendChild(tr);
	});
	const pageInfo=document.getElementById('pageInfo'); const total=state.filtered.length;
	const pages=Math.max(1, Math.ceil(total/state.pageSize));
	pageInfo.textContent=`Page ${state.page} of ${pages} â€¢ ${total} items`;
	document.getElementById('prevPage').disabled=state.page<=1;
	document.getElementById('nextPage').disabled=state.page>=pages;
}

async function loadUsersMap(){
	const snap=await db.ref('users').once('value'); const map={};
	if(snap.exists()) snap.forEach(s=>{ const u=s.val()||{}; map[s.key]={ name:(u.firstName&&u.lastName)?`${u.firstName} ${u.lastName}`:(u.name||u.email||s.key) }; });
	state.users=map;
}

async function loadDepartmentsMap(companyId){
	const map={};
	if(companyId){
		const snap=await db.ref(`companies/${companyId}/fieldOptions/department`).once('value');
		const arr=snap.val();
		if(Array.isArray(arr)){
			arr.filter(x=>x?.enabled!==false).forEach(x=>{
				const val=x.value||x.key||x.label;
				const label=x.label||x.value;
				map[val]=label;
			});
		}
	}
	state.departments=map;
}

function getDepartmentLabel(deptValue){
	if(!deptValue) return '-';
	if(state.departments[deptValue]) return state.departments[deptValue];
	// Fallback: convert hyphenated to title case
	return deptValue.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
}

async function loadIncidents(companyId){
	// Load departments map first
	await loadDepartmentsMap(companyId);
	
	const snap=await db.ref(`companies/${companyId}/incidents`).once('value');
	const items=[];
	if(snap.exists()) snap.forEach(s=>{
		const v=s.val()||{};
		items.push({ id:s.key, ...v });
	});
	// sort: newest first by createdAt/date
	items.sort((a,b)=> (b.createdAt||b.date||'').localeCompare(a.createdAt||a.date||''));
	state.items=items; state.filtered=items;
	renderTable();
}

// ===== INCIDENT DETAILS MODAL =====
let currentIncidentId = null;

function openIncidentDetails(incidentId) {
	const incident = state.items.find(x => x.id === incidentId);
	if (!incident) return;
	
	currentIncidentId = incidentId;
	const overlay = document.getElementById('incidentDetailsOverlay');
	
	// Set company branding
	setModalBranding();
	
	// Set reference number
	document.getElementById('incModalRef').textContent = incident.referenceNumber || '-';
	document.getElementById('incModalGenerated').textContent = `Generated: ${new Date().toLocaleString()}`;
	
	// Populate Basic Information
	populateBasicInfo(incident);
	
	// Populate Event Details
	populateEventDetails(incident);
	
	// Populate Injury Details
	populateInjuryDetails(incident);
	
	// Populate Property Damage
	populatePropertyDamage(incident);
	
	// Populate Actions
	populateActions(incident);
	
	// Populate Attachments
	populateAttachments(incident);
	
	// Show Edit/Delete buttons if user is creator OR has edit/delete permissions in access control
	const user = authManager?.currentUser;
	const isCreator = user && (incident.createdBy === user.uid || incident.reportedBy === user.uid);
	
	// Check access control permissions
	checkIncidentEditDeletePermission(user, isCreator);
	
	// Show modal
	overlay.style.display = 'flex';
}

async function checkIncidentEditDeletePermission(user, isCreator) {
	let hasEditDeletePermission = false;
	
	if (user && user.companyId) {
		try {
			const permsSnap = await db.ref(`companies/${user.companyId}/incidentSettings/accessControl/${user.uid}`).once('value');
			const perms = permsSnap.val() || {};
			hasEditDeletePermission = perms.canEditDeleteAll === true;
		} catch (error) {
			console.error('Error checking edit/delete permission:', error);
		}
	}
	
	const canEditDelete = isCreator || hasEditDeletePermission;
	document.getElementById('incModalActions').style.display = canEditDelete ? 'block' : 'none';
}

function setModalBranding() {
	const company = authManager?.currentCompany || {};
	const logoEl = document.getElementById('incModalLogo');
	const fallbackEl = document.getElementById('incModalLogoFallback');
	const nameEl = document.getElementById('incModalCompanyName');
	
	if (nameEl) nameEl.textContent = company.companyName || 'Company';
	
	if (company.logo || company.logoUrl) {
		logoEl.src = company.logo || company.logoUrl;
		logoEl.style.display = 'block';
		fallbackEl.style.display = 'none';
	} else {
		logoEl.style.display = 'none';
		const initials = getCompanyInitials(company.companyName || 'CO');
		fallbackEl.textContent = initials;
		fallbackEl.style.display = 'flex';
	}
}

function getCompanyInitials(name) {
	if (!name) return 'CO';
	const parts = name.trim().split(/\s+/);
	if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
	return (parts[0][0] + parts[1][0]).toUpperCase();
}

function escapeHtml(str) {
	if (!str) return '';
	return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDate(dateStr) {
	if (!dateStr || dateStr === '-') return '-';
	try {
		const date = new Date(dateStr);
		if (isNaN(date.getTime())) return dateStr;
		return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
	} catch (e) {
		return dateStr;
	}
}

function formatInvolvement(value) {
	const map = {
		'directly-involved': 'Directly Involved',
		'witness': 'Witness',
		'supervisor': 'Supervisor',
		'other': 'Other'
	};
	return map[value] || value || '-';
}

function formatCondition(value) {
	const map = {
		'good': 'Good',
		'needs-repair': 'Needs Repair',
		'damaged': 'Damaged',
		'unsafe': 'Unsafe'
	};
	return map[value] || value || '-';
}

function formatStatus(value) {
	const map = {
		'pending': 'Pending',
		'in-progress': 'In Progress',
		'completed': 'Completed',
		'overdue': 'Overdue'
	};
	return map[value] || value || '-';
}

function formatObservationType(value) {
	const map = {
		'safe': 'Safe',
		'at-risk': 'At Risk'
	};
	return map[value] || value || '-';
}

function formatObservationCategory(value) {
	const map = {
		'behavior': 'Behavior',
		'condition': 'Condition'
	};
	return map[value] || value || '-';
}

function formatJobTitle(value) {
	if (!value || value === '-') return '-';
	// Convert hyphenated values to title case (e.g., 'software-engineer' -> 'Software Engineer')
	return value.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
}

function formatLabel(label) {
	return label.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim();
}

function populateBasicInfo(inc) {
	const container = document.getElementById('incSectionBasic');
	const items = [
		{ label: 'Title', value: inc.title },
		{ label: 'Event Type', value: eventTypeLabel(inc.eventType) },
		{ label: 'Date', value: inc.date },
		{ label: 'Time', value: inc.time },
		{ label: 'Location', value: inc.location },
		{ label: 'Department', value: inc.department },
		{ label: 'Severity', value: inc.severity ? inc.severity.charAt(0).toUpperCase() + inc.severity.slice(1) : '-' },
		{ label: 'Status', value: inc.status ? inc.status.replace(/-/g, ' ').replace(/\b\w/g, m => m.toUpperCase()) : '-' },
		{ label: 'Reported By', value: inc.reportedByName || state.users[inc.reportedBy]?.name || inc.reportedBy || '-' },
		{ label: 'Date Reported', value: inc.dateReported || '-' },
		{ label: 'Assigned To', value: inc.assignedToName || state.users[inc.assignedTo]?.name || '-' }
	];
	
	// Add observation type and category if event type is observation
	if (inc.eventType === 'observation' && inc.eventDetails?.observation) {
		const obs = inc.eventDetails.observation;
		if (obs.type) items.push({ label: 'Observation Type', value: formatObservationType(obs.type) });
		if (obs.category) items.push({ label: 'Category', value: formatObservationCategory(obs.category) });
	}
	
	container.innerHTML = items.map(item => `
		<div class="inc-field">
			<span class="inc-field-label">${escapeHtml(item.label)}</span>
			<span class="inc-field-value">${escapeHtml(item.value || '-')}</span>
		</div>
	`).join('');
	
	// Add description as full-width item
	if (inc.description) {
		container.innerHTML += `
			<div class="inc-field full-width has-description">
				<span class="inc-field-label"><i class="fas fa-align-left"></i> Description</span>
				<span class="inc-field-value description">${escapeHtml(inc.description)}</span>
			</div>
		`;
	}
}

function populateEventDetails(inc) {
	const container = document.getElementById('incSectionEvent');
	container.innerHTML = '';
	
	const eventDetails = inc.eventDetails || {};
	const eventType = inc.eventType || 'incident';
	
	let items = [];
	let html = '<div class="inc-fields-grid">';
	
	if (eventType === 'near-miss' && eventDetails.nearMiss) {
		const nm = eventDetails.nearMiss;
		items = [
			{ label: 'Potential Outcome', value: nm.potentialOutcome },
			{ label: 'Likelihood', value: nm.likelihood },
			{ label: 'Potential Severity', value: nm.potentialSeverity }
		].filter(i => i.value);
	} else if (eventType === 'observation' && eventDetails.observation) {
		const obs = eventDetails.observation;
		items = []; // Observation type and category moved to Basic Info
		
		// Add grid items first (empty for observation since fields moved)
		html += items.map(item => `
			<div class="inc-field">
				<span class="inc-field-label">${escapeHtml(item.label)}</span>
				<span class="inc-field-value">${escapeHtml(item.value || '-')}</span>
			</div>
		`).join('');
		html += '</div>';
		
		// Persons involved
		if (obs.personsInvolved && obs.personsInvolved.length > 0) {
			html += `<div class="inc-items-section">
				<div class="inc-items-section-title"><i class="fas fa-user"></i> Persons Involved</div>
				<table class="inc-items-table">
					<thead>
						<tr>
							<th>#</th>
							<th>Name</th>
							<th>Role</th>
							<th>Involvement</th>
							<th>Notes</th>
						</tr>
					</thead>
					<tbody>`;
			obs.personsInvolved.forEach((p, idx) => {
				html += `
					<tr>
						<td>${idx + 1}</td>
						<td>${escapeHtml(p.name || '-')}</td>
						<td>${escapeHtml(p.role || '-')}</td>
						<td>${formatInvolvement(p.involvement)}</td>
						<td>${escapeHtml(p.notes || '-')}</td>
					</tr>
				`;
			});
			html += `</tbody></table></div>`;
		}
		
		// Equipment involved
		if (obs.equipmentInvolved && obs.equipmentInvolved.length > 0) {
			html += `<div class="inc-items-section">
				<div class="inc-items-section-title"><i class="fas fa-tools"></i> Equipment Involved</div>
				<table class="inc-items-table">
					<thead>
						<tr>
							<th>#</th>
							<th>Name</th>
							<th>Type</th>
							<th>Condition</th>
							<th>Notes</th>
						</tr>
					</thead>
					<tbody>`;
			obs.equipmentInvolved.forEach((e, idx) => {
				html += `
					<tr>
						<td>${idx + 1}</td>
						<td>${escapeHtml(e.name || '-')}</td>
						<td>${escapeHtml(e.type || '-')}</td>
						<td>${formatCondition(e.condition)}</td>
						<td>${escapeHtml(e.notes || '-')}</td>
					</tr>
				`;
			});
			html += `</tbody></table></div>`;
		}
		
		// Observation corrective actions
		if (obs.correctiveActions && obs.correctiveActions.length > 0) {
			html += `<div class="inc-items-section">
				<div class="inc-items-section-title"><i class="fas fa-check-circle"></i> Corrective Actions</div>
				<table class="inc-items-table">
					<thead>
						<tr>
							<th>#</th>
							<th>Description</th>
							<th>Responsible</th>
							<th>Due Date</th>
							<th>Status</th>
						</tr>
					</thead>
					<tbody>`;
			obs.correctiveActions.forEach((action, idx) => {
				const statusClass = (action.status || 'pending').toLowerCase().replace(/\s+/g, '-');
				html += `
					<tr>
						<td>${idx + 1}</td>
						<td>${escapeHtml(action.description || '-')}</td>
						<td>${escapeHtml(action.responsibleName || '-')}</td>
						<td>${escapeHtml(action.dueDate || '-')}</td>
						<td><span class="inc-action-status ${statusClass}">${formatStatus(action.status)}</span></td>
					</tr>
				`;
			});
			html += `</tbody></table></div>`;
		}
		
		container.innerHTML = html;
		return;
	} else if (eventType === 'incident' && eventDetails.incident) {
		const ic = eventDetails.incident;
		items = [
			{ label: 'Injured Person', value: ic.injuredPerson },
			{ label: 'Lost Time', value: ic.lostTime },
			{ label: 'Days Lost', value: ic.daysLost },
			{ label: 'Equipment', value: ic.equipment },
			{ label: 'Witnesses', value: ic.witnesses }
		].filter(i => i.value);
		
		html += items.map(item => `
			<div class="inc-field">
				<span class="inc-field-label">${escapeHtml(item.label)}</span>
				<span class="inc-field-value">${escapeHtml(item.value || '-')}</span>
			</div>
		`).join('');
		
		// Add stacked items
		if (ic.rootCause) {
			html += `<div class="inc-field full-width has-description"><span class="inc-field-label">Root Cause</span><span class="inc-field-value description">${escapeHtml(ic.rootCause)}</span></div>`;
		}
		if (ic.contributingFactors) {
			html += `<div class="inc-field full-width has-description"><span class="inc-field-label">Contributing Factors</span><span class="inc-field-value description">${escapeHtml(ic.contributingFactors)}</span></div>`;
		}
		html += '</div>';
		container.innerHTML = html;
		return;
	}
	
	// Default rendering for other types
	html += items.map(item => `
		<div class="inc-field">
			<span class="inc-field-label">${escapeHtml(item.label)}</span>
			<span class="inc-field-value">${escapeHtml(item.value || '-')}</span>
		</div>
	`).join('');
	html += '</div>';
	container.innerHTML = html;
}

function populateInjuryDetails(inc) {
	const section = document.getElementById('incInjurySection');
	const container = document.getElementById('incSectionInjury');
	
	const injury = inc.injuryData;
	if (!injury || !injury.hasInjury) {
		section.style.display = 'none';
		return;
	}
	
	section.style.display = 'block';
	// Render dynamic injured persons if present
	if (Array.isArray(injury.injuredPersons) && injury.injuredPersons.length > 0) {
		let html = `<div class="inc-items-section">
			<div class="inc-items-section-title"><i class="fas fa-user-injured"></i> Injured Persons</div>
			<table class="inc-items-table">
				<thead>
					<tr>
						<th>#</th>
						<th>Name</th>
						<th>Injury Type</th>
						<th>Body Part</th>
						<th>Treatment</th>
						<th>Lost Time</th>
						<th>Days Lost</th>
					</tr>
				</thead>
				<tbody>`;
		injury.injuredPersons.forEach((p, idx) => {
			html += `
				<tr>
					<td>${idx + 1}</td>
					<td>${escapeHtml(p.name || '-')}</td>
					<td>${escapeHtml(p.injuryType || '-')}</td>
					<td>${escapeHtml(p.bodyPart || '-')}</td>
					<td>${escapeHtml(p.treatment || '-')}</td>
					<td>${escapeHtml(p.lostTime || '-')}</td>
					<td>${escapeHtml(p.daysLost || '-')}</td>
				</tr>`;
		});
		html += `</tbody></table></div>`;
		container.innerHTML = html;
		return;
	}

	// Fallback to legacy single-person fields
	const items = [
		{ label: 'Injury Type', value: injury.injuryType },
		{ label: 'Injured Person', value: injury.injuredPerson },
		{ label: 'Body Part', value: injury.bodyPart },
		{ label: 'Treatment', value: injury.treatment },
		{ label: 'Lost Time', value: injury.lostTime },
		{ label: 'Days Lost', value: injury.daysLost }
	].filter(i => i.value);
	container.innerHTML = items.map(item => `
		<div class="inc-field">
			<span class="inc-field-label">${escapeHtml(item.label)}</span>
			<span class="inc-field-value">${escapeHtml(item.value || '-')}</span>
		</div>
	`).join('');
}

function populatePropertyDamage(inc) {
	const section = document.getElementById('incDamageSection');
	const container = document.getElementById('incSectionDamage');
	
	const damage = inc.propertyDamageData;
	if (!damage || !damage.hasPropertyDamage) {
		section.style.display = 'none';
		return;
	}
	
	section.style.display = 'block';
	// Render dynamic damaged items if present
	if (Array.isArray(damage.damagedItems) && damage.damagedItems.length > 0) {
		let html = `<div class="inc-items-section">
			<div class="inc-items-section-title"><i class="fas fa-building"></i> Damaged Items</div>
			<table class="inc-items-table">
				<thead>
					<tr>
						<th>#</th>
						<th>Damage Type</th>
						<th>Asset/Equipment</th>
						<th>Estimated Cost</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>`;
		damage.damagedItems.forEach((d, idx) => {
			html += `
				<tr>
					<td>${idx + 1}</td>
					<td>${escapeHtml(d.damageType || '-')}</td>
					<td>${escapeHtml(d.damagedAsset || '-')}</td>
					<td>${escapeHtml(d.estimatedCost || '-')}</td>
					<td>${escapeHtml(d.description || '-')}</td>
				</tr>`;
		});
		html += `</tbody></table></div>`;
		container.innerHTML = html;
		return;
	}

	// Fallback to legacy single-item fields
	const items = [
		{ label: 'Damage Type', value: damage.damageType },
		{ label: 'Damaged Asset', value: damage.damagedAsset },
		{ label: 'Estimated Cost', value: damage.estimatedCost }
	].filter(i => i.value);
	container.innerHTML = items.map(item => `
		<div class="inc-field">
			<span class="inc-field-label">${escapeHtml(item.label)}</span>
			<span class="inc-field-value">${escapeHtml(item.value || '-')}</span>
		</div>
	`).join('');
	if (damage.description) {
		container.innerHTML += `
			<div class="inc-field full-width has-description">
				<span class="inc-field-label"><i class="fas fa-align-left"></i> Description</span>
				<span class="inc-field-value description">${escapeHtml(damage.description)}</span>
			</div>
		`;
	}
}

function populateActions(inc) {
	const section = document.getElementById('incActionsSection');
	const container = document.getElementById('incSectionActions');
	
	const hasImmediate = inc.immediateActions;
	const hasCorrective = inc.correctiveActions && inc.correctiveActions.length > 0;
	
	if (!hasImmediate && !hasCorrective) {
		section.style.display = 'none';
		return;
	}
	
	section.style.display = 'block';
	let html = '';
	
	// Immediate Actions
	if (hasImmediate) {
		html += `
			<div class="inc-field full-width has-description" style="margin-bottom:16px;">
				<span class="inc-field-label"><i class="fas fa-bolt"></i> Immediate Actions Taken</span>
				<span class="inc-field-value description">${escapeHtml(inc.immediateActions)}</span>
			</div>
		`;
	}
	
	// Corrective Actions
	if (hasCorrective) {
		html += `<div class="inc-items-section">
			<div class="inc-items-section-title"><i class="fas fa-check-circle"></i> Corrective Actions</div>
			<table class="inc-items-table">
				<thead>
					<tr>
						<th>#</th>
						<th>Description</th>
						<th>Responsible</th>
						<th>Due Date</th>
						<th>Status</th>
					</tr>
				</thead>
				<tbody>`;
		inc.correctiveActions.forEach((action, idx) => {
			const statusClass = (action.status || 'pending').toLowerCase().replace(/\s+/g, '-');
			html += `
				<tr>
					<td>${idx + 1}</td>
					<td>${escapeHtml(action.description || '-')}</td>
					<td>${escapeHtml(action.responsibleName || '-')}</td>
					<td>${escapeHtml(action.dueDate || '-')}</td>
					<td><span class="inc-action-status ${statusClass}">${formatStatus(action.status)}</span></td>
				</tr>
			`;
		});
		html += `</tbody></table></div>`;
	}
	
	container.innerHTML = html;
}

function populateAttachments(inc) {
	const section = document.getElementById('incAttachmentsSection');
	const container = document.getElementById('incSectionAttachments');
	
	const attachments = inc.attachments || [];
	if (attachments.length === 0) {
		section.style.display = 'none';
		return;
	}
	
	section.style.display = 'block';
	container.innerHTML = attachments.map((att, idx) => {
		const url = att.url || att.dataUrl || '#';
		const name = att.name || `Attachment ${idx + 1}`;
		return `
			<div class="inc-attachment-item">
				<i class="fas fa-file"></i>
				<a href="${escapeHtml(url)}" target="_blank">${escapeHtml(name)}</a>
				${att.size ? `<span class="size">${escapeHtml(att.size)}</span>` : ''}
			</div>
		`;
	}).join('');
}

function closeIncidentDetails() {
	document.getElementById('incidentDetailsOverlay').style.display = 'none';
	currentIncidentId = null;
}

function editCurrentIncident() {
	if (!currentIncidentId) return;
	
	const incident = state.items.find(x => x.id === currentIncidentId);
	const user = authManager?.currentUser;
	const isCreator = user && (incident.createdBy === user.uid || incident.reportedBy === user.uid);
	
	// Check permissions from access control cache or database
	const { perms } = incidentAccessControlCache;
	let hasEditDeletePermission = false;
	
	if (user && perms && perms[user.uid] && perms[user.uid].canEditDeleteAll) {
		hasEditDeletePermission = true;
	}
	
	const canEdit = isCreator || hasEditDeletePermission;
	
	if (!canEdit) {
		alert('You can only edit incidents that you created or have been granted permission to edit.');
		return;
	}
	
	window.location.href = `incident.html?id=${currentIncidentId}`;
}

async function deleteCurrentIncident() {
	if (!currentIncidentId) return;
	
	const incident = state.items.find(x => x.id === currentIncidentId);
	const user = authManager?.currentUser;
	const isCreator = user && (incident.createdBy === user.uid || incident.reportedBy === user.uid);
	
	// Check permissions from access control cache or database
	const { perms } = incidentAccessControlCache;
	let hasEditDeletePermission = false;
	
	if (user && perms && perms[user.uid] && perms[user.uid].canEditDeleteAll) {
		hasEditDeletePermission = true;
	}
	
	const canDelete = isCreator || hasEditDeletePermission;
	
	if (!canDelete) {
		alert('You can only delete incidents that you created or have been granted permission to delete.');
		return;
	}
	
	if (!confirm('Are you sure you want to delete this incident? This action cannot be undone.')) return;
	
	try {
		if (!user || !user.companyId) {
			alert('User not authenticated');
			return;
		}
		
		await db.ref(`companies/${user.companyId}/incidents/${currentIncidentId}`).remove();
		closeIncidentDetails();
		await loadIncidents(user.companyId);
		alert('Incident deleted successfully');
	} catch (error) {
		console.error('Error deleting incident:', error);
		alert('Failed to delete incident. Please try again.');
	}
}

function printIncidentDetails() {
	window.print();
}

// ===== END INCIDENT DETAILS MODAL =====

// ===== SETTINGS TAB MANAGEMENT =====
const settingsState = {
	locations: [],
	observationTypes: [],
	categories: [],
	incidentCategories: [],
	injuryTypes: [],
	treatmentProvided: []
};

function toggleSettingsSection(header) {
	const section = header.closest('.settings-section');
	section.classList.toggle('collapsed');
}

// Toggle week days visibility based on frequency selection
function toggleWeekDays(eventType) {
	const frequencyEl = document.getElementById(`${eventType}ReminderFrequency`);
	const weekDaysContainer = document.getElementById(`${eventType}WeekDaysContainer`);
	if (!frequencyEl || !weekDaysContainer) return;
	
	const frequency = frequencyEl.value;
	// Show week days only for weekly and bi-weekly frequencies
	if (frequency === 'weekly' || frequency === 'bi-weekly') {
		weekDaysContainer.style.display = 'block';
	} else {
		weekDaysContainer.style.display = 'none';
	}
}

// Toggle days before field visibility based on frequency selection
function toggleDaysBeforeField(eventType) {
	const frequencyEl = document.getElementById(`${eventType}ReminderFrequency`);
	const daysBeforeContainer = document.getElementById(`${eventType}DaysBeforeContainer`);
	if (!frequencyEl || !daysBeforeContainer) return;
	
	const frequency = frequencyEl.value;
	// Show days before field only for "before-due" frequency
	if (frequency === 'before-due') {
		daysBeforeContainer.style.display = 'block';
	} else {
		daysBeforeContainer.style.display = 'none';
	}
}

// Toggle reminder settings panel visibility for event types
function toggleReminderPanel(eventType) {
	const panel = document.getElementById(`${eventType}ReminderPanel`);
	if (!panel) return;
	
	const isCollapsed = panel.style.display === 'none';
	panel.style.display = isCollapsed ? 'block' : 'none';
	
	// Update the toggle button icon
	const toggleBtn = panel.previousElementSibling;
	if (toggleBtn) {
		const icon = toggleBtn.querySelector('i.fa-chevron-down, i.fa-chevron-up');
		if (icon) {
			icon.classList.toggle('fa-chevron-down', !isCollapsed);
			icon.classList.toggle('fa-chevron-up', isCollapsed);
		}
	}
}

function toggleAllSettingsSections() {
	const sections = document.querySelectorAll('#settingsTab .settings-section');
	const btn = document.getElementById('toggleAllSettingsBtn');
	
	// Check if any section is expanded (not collapsed)
	const anyExpanded = Array.from(sections).some(s => !s.classList.contains('collapsed'));
	
	if (anyExpanded) {
		// Collapse all
		sections.forEach(section => section.classList.add('collapsed'));
		if (btn) btn.innerHTML = '<i class="fas fa-expand-alt"></i> Expand All';
	} else {
		// Expand all
		sections.forEach(section => section.classList.remove('collapsed'));
		if (btn) btn.innerHTML = '<i class="fas fa-compress-alt"></i> Collapse All';
	}
}

function initTabNavigation() {
	const tabBtns = document.querySelectorAll('.tab-btn');
	tabBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			// Only allow clicking on authorized tabs
			if (!btn.classList.contains('tab-authorized')) return;
			const targetTab = btn.dataset.tab;
			switchToTab(targetTab);
		});
	});
	
	// Check URL hash to switch to specific tab (after authorization is applied)
	if (window.location.hash === '#actionPlan') {
		setTimeout(() => {
			const actionPlanBtn = document.querySelector('.tab-btn[data-tab="actionPlan"]');
			if (actionPlanBtn && actionPlanBtn.classList.contains('tab-authorized')) {
				switchToTab('actionPlan');
			}
		}, 600);
	}
}

function switchToTab(targetTab) {
	const tabBtns = document.querySelectorAll('.tab-btn');
	
	// Update tab buttons
	tabBtns.forEach(b => b.classList.remove('active'));
	const activeBtn = document.querySelector(`.tab-btn[data-tab="${targetTab}"]`);
	if (activeBtn) activeBtn.classList.add('active');
	
	// Update tab content
	document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
	const tabContent = document.getElementById(targetTab + 'Tab');
	if (tabContent) tabContent.classList.add('active');
	
	// Load data when switching tabs
	if (targetTab === 'settings') {
		loadIncidentSettings();
	} else if (targetTab === 'actionPlan') {
		loadActionPlanData();
	}
}

// ========== Action Plan Functions ==========
let actionPlanState = { allActions: [], filtered: [] };

async function loadActionPlanData() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	const tbody = document.getElementById('actionPlanTableBody');
	const emptyState = document.getElementById('actionPlanEmpty');
	const table = document.getElementById('actionPlanTable');
	
	tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#9ca3af"><i class="fas fa-spinner fa-spin"></i> Loading actions...</td></tr>';
	table.style.display = 'table';
	emptyState.style.display = 'none';
	
	try {
		const snap = await db.ref(`companies/${user.companyId}/incidents`).once('value');
		const incidents = snap.val() || {};
		
		const currentUserId = user.uid;
		const actions = [];
		
		// Extract corrective actions assigned to current user
		Object.entries(incidents).forEach(([incidentId, inc]) => {
			if (!inc.correctiveActions || !Array.isArray(inc.correctiveActions)) return;
			
			inc.correctiveActions.forEach((action, idx) => {
				// Check if action is assigned to current user (using correct field names from incident.html)
				const assignedToId = action.responsibleId || action.responsiblePersonId || action.assignedToId || '';
				const assignedToName = action.responsibleName || action.responsiblePerson || action.assignedTo || action.responsible || '';
				
				// Match by ID first (most reliable), then by name
				const userName = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : (user.name || user.email || '');
				const isAssignedToMe = assignedToId === currentUserId || 
					(userName && assignedToName && assignedToName.toLowerCase().includes(userName.toLowerCase()));
				
				console.log('Action check:', {
					actionIndex: idx,
					assignedToId,
					assignedToName,
					currentUserId,
					userName,
					isAssignedToMe
				});
				
				if (isAssignedToMe) {
					// Determine if overdue
					let status = (action.status || 'pending').toLowerCase();
					if (status !== 'completed' && action.dueDate) {
						const dueDate = new Date(action.dueDate);
						const today = new Date();
						today.setHours(0,0,0,0);
						if (dueDate < today) {
							status = 'overdue';
						}
					}
					
					actions.push({
						incidentId,
						actionIndex: idx,
						source: inc.eventType || 'incident',
						reference: inc.referenceNumber || incidentId.substring(0, 8),
						title: inc.title || 'Untitled',
						description: action.description || action.action || '-',
						responsible: assignedToName || '-',
						responsibleUid: assignedToId || '',
						dueDate: action.dueDate || '-',
						status: status,
						priority: action.priority || inc.severity || 'medium'
					});
				}
			});
		});
		
		// Sort by due date (earliest first), then by status (overdue first)
		actions.sort((a, b) => {
			if (a.status === 'overdue' && b.status !== 'overdue') return -1;
			if (b.status === 'overdue' && a.status !== 'overdue') return 1;
			if (a.dueDate === '-' && b.dueDate !== '-') return 1;
			if (b.dueDate === '-' && a.dueDate !== '-') return -1;
			return (a.dueDate || '').localeCompare(b.dueDate || '');
		});
		
		actionPlanState.allActions = actions;
		actionPlanState.filtered = actions;
		renderActionPlanTable();
		
	} catch (error) {
		console.error('Error loading action plan:', error);
		tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#dc2626"><i class="fas fa-exclamation-triangle"></i> Error loading actions</td></tr>';
	}
}

function renderActionPlanTable() {
	const tbody = document.getElementById('actionPlanTableBody');
	const emptyState = document.getElementById('actionPlanEmpty');
	const table = document.getElementById('actionPlanTable');
	
	if (actionPlanState.filtered.length === 0) {
		tbody.innerHTML = '';
		table.style.display = 'none';
		emptyState.style.display = 'block';
		return;
	}
	
	table.style.display = 'table';
	emptyState.style.display = 'none';
	
	tbody.innerHTML = actionPlanState.filtered.map((action, idx) => {
		const sourceLabel = action.source === 'near-miss' ? 'Near Miss' : 
			action.source.charAt(0).toUpperCase() + action.source.slice(1);
		const sourceClass = action.source.toLowerCase().replace(/\s+/g, '-');
		const statusClass = action.status.toLowerCase().replace(/\s+/g, '-');
		const statusLabel = action.status.replace(/-/g, ' ').replace(/\b\w/g, m => m.toUpperCase());
		const priorityBadge = `<span class="badge ${action.priority}">${(action.priority || 'medium').replace(/\b\w/g, m => m.toUpperCase())}</span>`;
		
		return `
			<tr class="clickable-row" onclick="openActionPlanDetails(${idx})">
				<td><span class="action-source-badge ${sourceClass}">${sourceLabel}</span></td>
				<td>${escapeHtml(action.reference)}</td>
				<td>${escapeHtml(action.title)}</td>
				<td class="responsible-cell">${escapeHtml(action.responsible)}</td>
				<td>${action.dueDate}</td>
				<td><span class="action-status ${statusClass}">${statusLabel}</span></td>
				<td>${priorityBadge}</td>
			</tr>
		`;
	}).join('');
}

// Currently selected action for modal
let currentActionPlanItem = null;

function openActionPlanDetails(idx) {
	const action = actionPlanState.filtered[idx];
	if (!action) return;
	
	currentActionPlanItem = action;
	
	// Source badge
	const sourceLabel = action.source === 'near-miss' ? 'Near Miss' : 
		action.source.charAt(0).toUpperCase() + action.source.slice(1);
	const sourceClass = action.source.toLowerCase().replace(/\s+/g, '-');
	document.getElementById('apDetailSource').innerHTML = `<span class="action-source-badge ${sourceClass}">${sourceLabel}</span>`;
	
	// Reference
	document.getElementById('apDetailReference').textContent = action.reference;
	
	// Title
	document.getElementById('apDetailTitle').textContent = action.title || 'Untitled Incident';
	
	// Description
	document.getElementById('apDetailDescription').textContent = action.description || '-';
	
	// Responsible
	document.getElementById('apDetailResponsible').querySelector('span').textContent = action.responsible || '-';
	
	// Status
	const statusClass = action.status.toLowerCase().replace(/\s+/g, '-');
	const statusLabel = action.status.replace(/-/g, ' ').replace(/\b\w/g, m => m.toUpperCase());
	document.getElementById('apDetailStatus').innerHTML = `<span class="action-status ${statusClass}">${statusLabel}</span>`;
	
	// Priority
	const priorityLabel = (action.priority || 'medium').replace(/\b\w/g, m => m.toUpperCase());
	document.getElementById('apDetailPriority').innerHTML = `<span class="badge ${action.priority}">${priorityLabel}</span>`;
	
	// Due Date
	const dueDateDisplay = action.dueDate && action.dueDate !== '-' ? formatDate(action.dueDate) : 'Not set';
	document.getElementById('apDetailDueDate').textContent = dueDateDisplay;
	
	// Show modal
	document.getElementById('actionPlanDetailsOverlay').style.display = 'flex';
}

function closeActionPlanDetails() {
	document.getElementById('actionPlanDetailsOverlay').style.display = 'none';
	currentActionPlanItem = null;
}

function viewFullIncident() {
	if (currentActionPlanItem && currentActionPlanItem.incidentId) {
		// Pass action index so incident.html knows which action to allow editing
		const actionIdx = currentActionPlanItem.actionIndex;
		window.location.href = `incident.html?id=${currentActionPlanItem.incidentId}&editAction=${actionIdx}`;
	}
}

async function sendManualActionReminder() {
	if (!currentActionPlanItem) return;
	
	const responsibleUid = currentActionPlanItem.responsibleUid;
	if (!responsibleUid) {
		alert('No responsible person assigned to this action.');
		return;
	}
	
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		alert('User not authenticated.');
		return;
	}
	
	try {
		// Ensure user cache is loaded
		if (Object.keys(notificationUsersCache).length === 0) {
			await loadNotificationUsers();
		}
		
		const ownerData = notificationUsersCache[responsibleUid];
		if (!ownerData || !ownerData.email) {
			alert('Responsible person not found or has no email address.');
			return;
		}
		
		// Get company name
		const companyName = authManager.currentCompany?.companyName || 'Company';
		
		// Format the action
		const formattedAction = {
			title: currentActionPlanItem.description,
			incidentRef: currentActionPlanItem.reference,
			incidentTitle: currentActionPlanItem.title,
			eventType: currentActionPlanItem.source,
			dueDate: currentActionPlanItem.dueDate,
			status: currentActionPlanItem.status,
			priority: currentActionPlanItem.priority
		};
		
		// Send the email
		await sendActionReminderEmail(ownerData.email, ownerData.name, [formattedAction], companyName, currentActionPlanItem.source, '');
		
		alert('Reminder sent successfully to ' + ownerData.email);
		
	} catch (error) {
		console.error('Error sending manual reminder:', error);
		alert('Failed to send reminder. Please try again.');
	}
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', () => {
	const overlay = document.getElementById('actionPlanDetailsOverlay');
	if (overlay) {
		overlay.addEventListener('click', (e) => {
			if (e.target.id === 'actionPlanDetailsOverlay') {
				closeActionPlanDetails();
			}
		});
	}
});

function filterActionPlan() {
	const sourceFilter = document.getElementById('actionSourceFilter').value;
	const statusFilter = document.getElementById('actionStatusFilter').value;
	
	actionPlanState.filtered = actionPlanState.allActions.filter(action => {
		if (sourceFilter && action.source !== sourceFilter) return false;
		if (statusFilter && action.status !== statusFilter) return false;
		return true;
	});
	
	renderActionPlanTable();
}

function clearActionPlanFilters() {
	document.getElementById('actionSourceFilter').value = '';
	document.getElementById('actionStatusFilter').value = '';
	actionPlanState.filtered = actionPlanState.allActions;
	renderActionPlanTable();
}

async function loadIncidentSettings() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	try {
		const snap = await db.ref(`companies/${user.companyId}/incidentSettings`).once('value');
		const settings = snap.val() || {};
		
		settingsState.locations = settings.locations || [];
		settingsState.observationTypes = settings.observationTypes || [];
		settingsState.categories = settings.categories || [];
		settingsState.incidentCategories = settings.incidentCategories || [];
		settingsState.injuryTypes = settings.injuryTypes || [];
		settingsState.treatmentProvided = settings.treatmentProvided || [];
		
		renderLocationOptions();
		renderObservationTypeOptions();
		renderCategoryOptions();
		renderIncidentCategoryOptions();
		renderInjuryTypeOptions();
		renderTreatmentProvidedOptions();
		loadIncidentAccessControl();
		loadNotificationSettings();
	} catch (error) {
		console.error('Error loading incident settings:', error);
	}
}

// ========== Access Control Functions ==========
let incidentAccessControlCache = { users: {}, perms: {} };

async function loadIncidentAccessControl() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	try {
		const [usersSnap, permsSnap, rolesSnap] = await Promise.all([
			db.ref(`companies/${user.companyId}/users`).once('value'),
			db.ref(`companies/${user.companyId}/incidentSettings/accessControl`).once('value'),
			db.ref(`companies/${user.companyId}/roles`).once('value')
		]);
		
		const users = usersSnap.val() || {};
		const perms = permsSnap.val() || {};
		const roles = rolesSnap.val() || {};
		
		incidentAccessControlCache = { users, perms, roles };
		renderIncidentAccessControlTable(users, perms, roles);
	} catch (error) {
		console.error('Error loading access control:', error);
	}
}

function renderIncidentAccessControlTable(users, perms, roles) {
	const tbody = document.getElementById('incidentAccessControlTableBody');
	if (!tbody) return;
	
	const permUserIds = Object.keys(perms || {});
	
	if (permUserIds.length === 0) {
		tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af">No users configured. Click "Add User" to add access control.</td></tr>';
		return;
	}
	
	tbody.innerHTML = permUserIds.map(uid => {
		const u = users[uid] || {};
		const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
		const email = (u.accountType === 'without-account' || u.reportingOnly === true) ? '-' : (u.email || '-');
		const jobTitle = formatJobTitle(u.jobTitle || u.position || '-');
		const p = perms[uid] || {};
		
		return `
			<tr>
				<td>${escapeHtml(name)}</td>
				<td>${escapeHtml(email)}</td>
				<td>${escapeHtml(jobTitle)}</td>
				<td style="text-align:center"><input type="checkbox" data-uid="${uid}" data-perm="incidents" ${p.canSeeIncidentsTab !== false ? 'checked' : ''} onchange="updateIncidentAccessPerm(this)"></td>
				<td style="text-align:center"><input type="checkbox" data-uid="${uid}" data-perm="settings" ${p.canSeeSettingsTab ? 'checked' : ''} onchange="updateIncidentAccessPerm(this)"></td>
				<td style="text-align:center"><input type="checkbox" data-uid="${uid}" data-perm="editDelete" ${p.canEditDeleteAll ? 'checked' : ''} onchange="updateIncidentAccessPerm(this)" title="Can edit/delete all incidents"></td>
				<td style="text-align:center"><button class="delete-btn" onclick="removeIncidentAccessUser('${uid}')" title="Remove user"><i class="fas fa-trash"></i></button></td>
			</tr>
		`;
	}).join('');
}

async function updateIncidentAccessPerm(checkbox) {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	const uid = checkbox.dataset.uid;
	const perm = checkbox.dataset.perm;
	const update = {};
	
	if (perm === 'incidents') update.canSeeIncidentsTab = checkbox.checked;
	if (perm === 'settings') update.canSeeSettingsTab = checkbox.checked;
	if (perm === 'editDelete') update.canEditDeleteAll = checkbox.checked;
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings/accessControl/${uid}`).update(update);
		
		// Apply changes immediately if it's the current user
		if (uid === user.id || uid === user.uid) {
			applyIncidentTabVisibility();
		}
		
		window.notificationManager?.addNotification({ type: 'success', message: 'Access updated' });
	} catch (error) {
		console.error('Failed to update access:', error);
		window.notificationManager?.addNotification({ type: 'error', message: 'Failed to update access' });
		checkbox.checked = !checkbox.checked; // Revert
	}
}

async function removeIncidentAccessUser(uid) {
	if (!confirm('Remove this user from access control?')) return;
	
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings/accessControl/${uid}`).remove();
		loadIncidentAccessControl();
		window.notificationManager?.addNotification({ type: 'success', message: 'User removed from access control' });
	} catch (error) {
		console.error('Failed to remove user:', error);
		window.notificationManager?.addNotification({ type: 'error', message: 'Failed to remove user' });
	}
}

function openIncidentAccessControlModal() {
	const modal = document.getElementById('incidentAccessControlModal');
	const select = document.getElementById('acIncidentUserSelect');
	
	// Populate user dropdown (exclude users already in access control)
	const { users, perms } = incidentAccessControlCache;
	const existingUids = Object.keys(perms || {});
	
	const options = Object.entries(users || {})
		.filter(([uid]) => !existingUids.includes(uid))
		.map(([uid, u]) => {
			const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email || uid;
			return `<option value="${uid}">${escapeHtml(name)}</option>`;
		});
	
	if (options.length === 0) {
		select.innerHTML = '<option value="">All users already added</option>';
	} else {
		select.innerHTML = '<option value="">Select a user...</option>' + options.join('');
	}
	
	// Reset checkboxes
	document.getElementById('acIncidentsTab').checked = true;
	document.getElementById('acSettingsTab').checked = false;
	document.getElementById('acEditDeleteTab').checked = false;
	
	modal.style.display = 'flex';
}

function closeIncidentAccessControlModal() {
	document.getElementById('incidentAccessControlModal').style.display = 'none';
}

async function saveIncidentAccessControl() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	const uid = document.getElementById('acIncidentUserSelect').value;
	if (!uid) {
		alert('Please select a user');
		return;
	}
	
	const canSeeIncidentsTab = document.getElementById('acIncidentsTab').checked;
	const canSeeSettingsTab = document.getElementById('acSettingsTab').checked;
	const canEditDeleteAll = document.getElementById('acEditDeleteTab').checked;
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings/accessControl/${uid}`).set({
			canSeeIncidentsTab,
			canSeeSettingsTab,
			canEditDeleteAll
		});
		
		closeIncidentAccessControlModal();
		loadIncidentAccessControl();
		window.notificationManager?.addNotification({ type: 'success', message: 'User added to access control' });
	} catch (error) {
		console.error('Failed to save access control:', error);
		window.notificationManager?.addNotification({ type: 'error', message: 'Failed to add user' });
	}
}

async function applyIncidentTabVisibility() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		// If no user, show at least the incidents tab as default
		const incidentsBtn = document.querySelector('.tab-btn[data-tab="incidents"]');
		const actionPlanBtn = document.querySelector('.tab-btn[data-tab="actionPlan"]');
		if (incidentsBtn) incidentsBtn.classList.add('tab-authorized');
		if (actionPlanBtn) actionPlanBtn.classList.add('tab-authorized');
		return;
	}
	
	try {
		const snap = await db.ref(`companies/${user.companyId}/incidentSettings/accessControl/${user.id || user.uid}`).once('value');
		const p = snap.val() || {};
		
		const incidentsBtn = document.querySelector('.tab-btn[data-tab="incidents"]');
		const actionPlanBtn = document.querySelector('.tab-btn[data-tab="actionPlan"]');
		const settingsBtn = document.querySelector('.tab-btn[data-tab="settings"]');
		const incidentsTab = document.getElementById('incidentsTab');
		const settingsTab = document.getElementById('settingsTab');
		
		// Incidents tab - default ALLOW unless explicitly disabled
		const allowIncidents = p.canSeeIncidentsTab !== false;
		if (incidentsBtn) {
			if (allowIncidents) {
				incidentsBtn.classList.add('tab-authorized');
			} else {
				incidentsBtn.classList.remove('tab-authorized');
			}
		}
		if (incidentsTab && !allowIncidents) incidentsTab.classList.remove('active');
		
		// Action Plan tab - always allowed (user's own actions)
		if (actionPlanBtn) actionPlanBtn.classList.add('tab-authorized');
		
		// Settings tab - default DENY unless explicitly granted
		const allowSettings = p.canSeeSettingsTab === true;
		if (settingsBtn) {
			if (allowSettings) {
				settingsBtn.classList.add('tab-authorized');
			} else {
				settingsBtn.classList.remove('tab-authorized');
			}
		}
		if (settingsTab && !allowSettings) settingsTab.classList.remove('active');
		
		// If current active tab is hidden, switch to the first visible one
		const activeTab = document.querySelector('.tab-btn.active');
		if (activeTab && !activeTab.classList.contains('tab-authorized')) {
			const firstVisible = document.querySelector('.tab-btn.tab-authorized');
			if (firstVisible) firstVisible.click();
		}
	} catch (error) {
		console.error('Error applying tab visibility:', error);
		// On error, show default tabs
		const incidentsBtn = document.querySelector('.tab-btn[data-tab="incidents"]');
		const actionPlanBtn = document.querySelector('.tab-btn[data-tab="actionPlan"]');
		if (incidentsBtn) incidentsBtn.classList.add('tab-authorized');
		if (actionPlanBtn) actionPlanBtn.classList.add('tab-authorized');
	}
}

// ========== End Access Control Functions ==========

// ========== Email Notification Functions ==========
// EmailJS Configuration
const EMAILJS_CONFIG = {
	publicKey: 'fHs6oaqQgkcPoUwpv',
	serviceId: 'service_p2e9swy',
	templateId: 'template_rew55vo'
};

// Cache for users data
let notificationUsersCache = {};

// Load notification users cache
async function loadNotificationUsers() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	try {
		const usersSnap = await db.ref(`companies/${user.companyId}/users`).once('value');
		notificationUsersCache = usersSnap.val() || {};
		console.log('Notification users cache loaded:', Object.keys(notificationUsersCache).length, 'users');
	} catch (err) {
		console.error('Failed to load notification users:', err);
	}
}

// Initialize EmailJS
function initEmailJS() {
	if (typeof emailjs !== 'undefined') {
		emailjs.init(EMAILJS_CONFIG.publicKey);
		console.log('EmailJS initialized for incident notifications');
	} else {
		console.warn('EmailJS library not loaded');
	}
}

// Load notification settings from Firebase
async function loadNotificationSettings() {
	console.log('loadNotificationSettings called');
	
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		console.log('No user or companyId in loadNotificationSettings');
		return;
	}
	
	console.log('Loading notification settings for company:', user.companyId);
	
	try {
		// Load users first for caching
		const usersSnap = await db.ref(`companies/${user.companyId}/users`).once('value');
		notificationUsersCache = usersSnap.val() || {};
		
		const snap = await db.ref(`companies/${user.companyId}/incidentSettings/notifications`).once('value');
		const settings = snap.val() || {};
		console.log('Notification settings loaded:', settings);
		
		// Load event type checkboxes (submission and update)
		document.getElementById('incidentOnSubmission').checked = settings.incidentOnSubmission !== false;
		document.getElementById('incidentOnUpdate').checked = settings.incidentOnUpdate === true;
		document.getElementById('nearMissOnSubmission').checked = settings.nearMissOnSubmission !== false;
		document.getElementById('nearMissOnUpdate').checked = settings.nearMissOnUpdate === true;
		document.getElementById('observationOnSubmission').checked = settings.observationOnSubmission !== false;
		document.getElementById('observationOnUpdate').checked = settings.observationOnUpdate === true;
		
		// Load recipients for each event type
		renderEventRecipients('incident', settings.incidentRecipients || {});
		renderEventRecipients('nearMiss', settings.nearMissRecipients || {});
		renderEventRecipients('observation', settings.observationRecipients || {});
		
		// Populate user dropdowns
		populateEventUserSelects();
		
		// Load Action Plan Reminder settings for EACH event type
		loadEventReminderSettings('incident', settings.incidentReminders || {});
		loadEventReminderSettings('nearMiss', settings.nearMissReminders || {});
		loadEventReminderSettings('observation', settings.observationReminders || {});
	} catch (error) {
		console.error('Error loading notification settings:', error);
	}
}

// Save notification event settings (enabled/disabled checkboxes)
async function saveNotificationSettings() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	const settings = {
		incidentOnSubmission: document.getElementById('incidentOnSubmission').checked,
		incidentOnUpdate: document.getElementById('incidentOnUpdate').checked,
		nearMissOnSubmission: document.getElementById('nearMissOnSubmission').checked,
		nearMissOnUpdate: document.getElementById('nearMissOnUpdate').checked,
		observationOnSubmission: document.getElementById('observationOnSubmission').checked,
		observationOnUpdate: document.getElementById('observationOnUpdate').checked
	};
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings/notifications`).update(settings);
		console.log('Notification settings saved');
	} catch (error) {
		console.error('Error saving notification settings:', error);
		alert('Failed to save settings');
	}
}

// Populate all event type user dropdowns
function populateEventUserSelects() {
	const selectIds = ['incidentRecipientSelect', 'nearMissRecipientSelect', 'observationRecipientSelect'];
	
	// Get users with email
	const availableUsers = Object.entries(notificationUsersCache)
		.filter(([uid, u]) => {
			const email = u.email;
			return email && email !== '-' && u.accountType !== 'without-account' && u.reportingOnly !== true;
		})
		.map(([uid, u]) => {
			const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email;
			return { uid, name, email: u.email };
		})
		.sort((a, b) => a.name.localeCompare(b.name));
	
	selectIds.forEach(selectId => {
		const select = document.getElementById(selectId);
		if (!select) return;
		
		if (availableUsers.length === 0) {
			select.innerHTML = '<option value="">No available users</option>';
		} else {
			select.innerHTML = '<option value="">Select user to add...</option>' + 
				availableUsers.map(u => `<option value="${u.uid}" data-email="${u.email}" data-name="${escapeHtml(u.name)}">${escapeHtml(u.name)} (${u.email})</option>`).join('');
		}
	});
}

// Render recipients as badges for an event type
function renderEventRecipients(eventType, recipients) {
	const containerId = `${eventType}RecipientsList`;
	const container = document.getElementById(containerId);
	if (!container) return;
	
	const recipientIds = Object.keys(recipients || {});
	
	if (recipientIds.length === 0) {
		container.innerHTML = '<span style="font-size:.75rem;color:#9ca3af;font-style:italic;">No recipients configured</span>';
		return;
	}
	
	// Color schemes for each event type
	const colors = {
		incident: { bg: '#fee2e2', text: '#991b1b', border: '#fecaca' },
		nearMiss: { bg: '#fef3c7', text: '#92400e', border: '#fde68a' },
		observation: { bg: '#dbeafe', text: '#1e40af', border: '#bfdbfe' }
	};
	const color = colors[eventType] || colors.incident;
	
	container.innerHTML = recipientIds.map(uid => {
		const r = recipients[uid] || {};
		const u = notificationUsersCache[uid] || {};
		const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || r.email || 'Unknown';
		const email = r.email || u.email || '';
		
		return `
			<div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:${color.bg};border:1px solid ${color.border};border-radius:16px;font-size:.75rem;color:${color.text};">
				<i class="fas fa-user" style="font-size:.65rem;"></i>
				<span title="${escapeHtml(email)}">${escapeHtml(name)}</span>
				<button onclick="removeEventRecipient('${eventType}', '${uid}')" style="background:none;border:none;color:${color.text};cursor:pointer;padding:0;margin-left:2px;opacity:0.7;" title="Remove">
					<i class="fas fa-times" style="font-size:.65rem;"></i>
				</button>
			</div>
		`;
	}).join('');
}

// Add recipient to an event type
async function addEventRecipient(eventType) {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	const selectId = `${eventType}RecipientSelect`;
	const select = document.getElementById(selectId);
	if (!select) return;
	
	const uid = select.value;
	if (!uid) {
		alert('Please select a user');
		return;
	}
	
	const selectedOption = select.options[select.selectedIndex];
	const email = selectedOption.dataset.email;
	const name = selectedOption.dataset.name;
	
	// Map eventType to Firebase path
	const pathMap = {
		incident: 'incidentRecipients',
		nearMiss: 'nearMissRecipients',
		observation: 'observationRecipients'
	};
	const path = pathMap[eventType];
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings/notifications/${path}/${uid}`).set({
			email: email,
			name: name,
			addedAt: new Date().toISOString(),
			addedBy: user.id || user.uid
		});
		
		// Reload settings to refresh UI
		await loadNotificationSettings();
		
		console.log(`Recipient added to ${eventType}`);
	} catch (error) {
		console.error('Error adding recipient:', error);
		alert('Failed to add recipient');
	}
}

// Remove recipient from an event type
async function removeEventRecipient(eventType, uid) {
	if (!confirm('Remove this recipient?')) return;
	
	const user = authManager?.currentUser;
	if (!user || !user.companyId) return;
	
	// Map eventType to Firebase path
	const pathMap = {
		incident: 'incidentRecipients',
		nearMiss: 'nearMissRecipients',
		observation: 'observationRecipients'
	};
	const path = pathMap[eventType];
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings/notifications/${path}/${uid}`).remove();
		
		// Reload settings to refresh UI
		await loadNotificationSettings();
		
		console.log(`Recipient removed from ${eventType}`);
	} catch (error) {
		console.error('Error removing recipient:', error);
		alert('Failed to remove recipient');
	}
}

// Send incident notification (called when incident is submitted or updated)
// isUpdate: true if this is an update to existing incident, false if new submission
async function sendIncidentNotification(companyId, incident, eventType, isUpdate = false) {
	if (!companyId || !incident) return;
	
	try {
		// Check if notifications are enabled for this event type and action
		const settingsSnap = await db.ref(`companies/${companyId}/incidentSettings/notifications`).once('value');
		const settings = settingsSnap.val() || {};
		
		// Map event types to settings and recipient paths
		const typeConfig = {
			'incident': { onSubmission: 'incidentOnSubmission', onUpdate: 'incidentOnUpdate', recipients: 'incidentRecipients', label: 'Incident' },
			'near-miss': { onSubmission: 'nearMissOnSubmission', onUpdate: 'nearMissOnUpdate', recipients: 'nearMissRecipients', label: 'Near Miss' },
			'observation': { onSubmission: 'observationOnSubmission', onUpdate: 'observationOnUpdate', recipients: 'observationRecipients', label: 'Observation' }
		};
		
		const config = typeConfig[eventType?.toLowerCase()] || typeConfig['incident'];
		
		// Check if notification should be sent based on submission/update setting
		const settingKey = isUpdate ? config.onUpdate : config.onSubmission;
		const isEnabled = isUpdate ? (settings[settingKey] === true) : (settings[settingKey] !== false);
		
		if (!isEnabled) {
			console.log(`Notifications disabled for ${eventType} ${isUpdate ? 'updates' : 'submissions'}`);
			return;
		}
		
		// Get recipients for this event type
		const recipients = settings[config.recipients] || {};
		const emails = Object.values(recipients).map(r => r.email).filter(e => e);
		
		if (emails.length === 0) {
			console.log(`No notification recipients configured for ${eventType}`);
			return;
		}
		
		// Get company info
		const companySnap = await db.ref(`companies/${companyId}`).once('value');
		const company = companySnap.val() || {};
		const companyName = company.companyName || 'Company';
		
		if (typeof emailjs === 'undefined') {
			console.warn('EmailJS not loaded, cannot send notification');
			return;
		}
		
		// Send to each recipient individually
		for (const email of emails) {
			try {
				// Get reporter name if available
				const reporterName = incident.reportedByName || incident.reportedBy || incident.createdBy || 'HSE System';
				const eventDate = incident.date || incident.incidentDate || new Date().toLocaleDateString();
				const refNumber = incident.referenceNumber || incident.id || 'N/A';
				const severityText = (incident.severity || 'Not specified').charAt(0).toUpperCase() + (incident.severity || 'Not specified').slice(1);
				
				// Determine action text based on submission/update
				const actionText = isUpdate ? 'has been updated' : 'has been reported';
				const subjectPrefix = isUpdate ? 'Updated' : 'New';
				const notificationContext = isUpdate ? 'HSE Event Update Notification' : 'New HSE Event Notification';
				
				// Format message to match Position Approval Request design
				const messageBody = `Dear HSE Team,

${isUpdate ? 'An existing' : 'A new'} ${config.label.toLowerCase()} ${actionText} and requires your attention.

EVENT DETAILS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Event Type: ${config.label}
Title: ${incident.title || 'Untitled'}
Reference Number: ${refNumber}
Date of Event: ${eventDate}
Location: ${incident.location || 'Not specified'}
Severity Level: ${severityText}
Department: ${incident.department || 'Not specified'}
Reported By: ${reporterName}
Status: ${incident.status || (isUpdate ? 'Updated' : 'Open')}

DESCRIPTION:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${incident.description || 'No description provided'}

${incident.immediateActions ? `IMMEDIATE ACTIONS TAKEN:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${incident.immediateActions}\n\n` : ''}Please review this ${config.label.toLowerCase()} through the HSE System and take appropriate action.

Review Link: ${window.location.origin}/incidentboard.html

Best regards,
${companyName} HSE System

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
This is an automated notification from the HSE Management System.
If you have questions, please contact your HSE department.`;

				// EmailJS template variables - matching position approval template structure
				const emailData = {
					// Basic email configuration
					to_email: email,
					to_name: 'HSE Team',
					from_name: companyName + ' HSE System',
					subject: `[HSE Alert] ${subjectPrefix} ${config.label}: ${incident.title || 'Untitled'} - ${refNumber}`,
					
					// Main message content
					message: messageBody,
					
					// Position approval template compatible variables
					position_title: `${config.label}: ${incident.title || 'Untitled'}`,
					position_code: refNumber,
					department: incident.department || config.label,
					requesting_manager: reporterName,
					request_date: eventDate,
					
					// Employment/Event details (mapped for template compatibility)
					employment_type: config.label,
					work_location: incident.location || 'Not specified',
					working_hours: eventDate,
					contract_duration: severityText,
					reporting_manager: reporterName,
					budget_code: refNumber,
					
					// Severity as salary fields for visual display
					salary_min: severityText,
					salary_max: incident.status || (isUpdate ? 'Updated' : 'Open'),
					annual_budget_impact: config.label,
					benefits_package: incident.department || 'HSE',
					department_budget: isUpdate ? 'Event Updated' : 'New Event',
					
					// Approval workflow fields
					current_stage: '1',
					total_stages: '1',
					approver_role: 'HSE Reviewer',
					approval_type: 'Review Required',
					notification_context: notificationContext,
					
					// Business justification (event details)
					business_need: incident.description || 'No description provided',
					key_responsibilities: incident.immediateActions || 'Review and take appropriate action',
					required_skills: `Location: ${incident.location || 'Not specified'}`,
					required_experience: `Severity: ${severityText}`,
					priority_level: incident.severity || 'medium',
					
					// Action links
					approval_link: `${window.location.origin}/incidentboard.html`,
					system_link: `${window.location.origin}/incidentboard.html`,
					
					// Company information
					company_name: companyName,
					company_email: 'info@dreamexdatalab.com',
					company_initial: companyName.charAt(0).toUpperCase(),
					
					// Contact information
					hr_email: 'hse@dreamexdatalab.com',
					budget_team_email: 'hse@dreamexdatalab.com',
					
					// System information
					request_id: refNumber,
					generation_timestamp: new Date().toLocaleString(),
					submission_date: eventDate,
					
					// HSE specific variables (for custom templates)
					incident_type: config.label,
					incident_title: incident.title || 'Untitled',
					incident_date: eventDate,
					incident_location: incident.location || 'Not specified',
					incident_severity: severityText,
					incident_description: incident.description || 'No description provided',
					incident_status: incident.status || (isUpdate ? 'Updated' : 'Open'),
					incident_department: incident.department || 'Not specified',
					incident_reporter: reporterName,
					immediate_actions: incident.immediateActions || 'N/A',
					reference_number: refNumber,
					is_update: isUpdate ? 'Yes' : 'No',
					event_action: isUpdate ? 'Updated' : 'New Submission'
				};
				
				const response = await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, emailData);
				console.log('Notification sent to:', email, response);
			} catch (err) {
				console.error('Failed to send notification to:', email, err);
			}
		}
	} catch (error) {
		console.error('Error sending incident notification:', error);
	}
}

// ========== Action Plan Reminder Functions ==========

// Load action plan reminder settings into the UI
// Load action plan reminder settings for a specific event type
function loadEventReminderSettings(eventType, settings) {
	// Get element ID prefix based on event type
	const prefix = eventType; // incident, nearMiss, or observation
	
	// Set enable checkbox
	const enableEl = document.getElementById(`${prefix}ReminderEnabled`);
	if (enableEl) enableEl.checked = settings.enabled === true;
	
	// Set select values
	const frequencyEl = document.getElementById(`${prefix}ReminderFrequency`);
	if (frequencyEl) frequencyEl.value = settings.frequency || 'weekly';
	
	const timeEl = document.getElementById(`${prefix}ReminderTime`);
	if (timeEl) timeEl.value = settings.time || '09:00';
	
	const daysBeforeEl = document.getElementById(`${prefix}ReminderDaysBefore`);
	if (daysBeforeEl) daysBeforeEl.value = settings.daysBefore !== undefined ? settings.daysBefore : '3';
	
	// Load week days
	const weekDays = settings.weekDays || { mon: true, tue: false, wed: false, thu: false, fri: false, sat: false, sun: false };
	['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
		const dayEl = document.getElementById(`${prefix}Day_${day}`);
		if (dayEl) dayEl.checked = weekDays[day] === true;
	});
	
	// Toggle week days visibility based on frequency
	toggleWeekDays(eventType);
	
	// Toggle days before field visibility based on frequency
	toggleDaysBeforeField(eventType);
	
	// Load custom message
	const messageEl = document.getElementById(`${prefix}ReminderMessage`);
	if (messageEl && settings.message) messageEl.value = settings.message;
	
	// Update last sent info if available (prefer auto, then manual, then general)
	const lastSentEl = document.getElementById(`${prefix}LastReminderSent`);
	if (lastSentEl) {
		const ts = settings.lastAutoSent || settings.lastManualSent || settings.lastSent;
		if (ts) {
			const d = new Date(ts);
			lastSentEl.innerHTML = `<i class="fas fa-check-circle" style="color:#059669;"></i> Last: ${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
		} else {
			lastSentEl.textContent = '';
		}
	}
}

// Save action plan reminder settings for a specific event type
async function saveEventReminderSettings(eventType) {
	console.log(`Starting to save ${eventType} reminder settings`);
	
	const user = authManager?.currentUser;
	console.log('Current user:', user);
	
	if (!user || !user.companyId) {
		console.log('No user or companyId found');
		alert('User not authenticated or company not found');
		return;
	}
	
	const prefix = eventType; // incident, nearMiss, or observation
	console.log(`Using prefix: ${prefix}`);
	
	// Get settings from form elements that actually exist
	const enableEl = document.getElementById(`${prefix}ReminderEnabled`);
	const frequencyEl = document.getElementById(`${prefix}ReminderFrequency`);
	const timeEl = document.getElementById(`${prefix}ReminderTime`);
	const daysBeforeEl = document.getElementById(`${prefix}ReminderDaysBefore`);
	const messageEl = document.getElementById(`${prefix}ReminderMessage`);
	
	console.log('Form elements found:', {
		enable: !!enableEl,
		frequency: !!frequencyEl,
		time: !!timeEl,
		daysBefore: !!daysBeforeEl,
		message: !!messageEl
	});
	
	// Get week days
	const weekDays = {};
	['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
		const dayEl = document.getElementById(`${prefix}Day_${day}`);
		weekDays[day] = dayEl ? dayEl.checked : false;
	});
	
	// Get frequency to determine if daysBefore is needed
	const frequency = frequencyEl ? frequencyEl.value : 'weekly';
	console.log('Selected frequency:', frequency);
	
	let daysBefore = 3; // default
	if (frequency === 'before-due' && daysBeforeEl) {
		daysBefore = parseInt(daysBeforeEl.value);
	}
	
	const settings = {
		enabled: enableEl ? enableEl.checked : false,
		frequency: frequency,
		time: timeEl ? timeEl.value : '09:00',
		daysBefore: daysBefore,
		weekDays: weekDays,
		message: messageEl ? messageEl.value : ''
	};
	
	console.log('Settings to save:', settings);
	
	// Determine the Firebase path based on event type
	const pathKey = `${eventType}Reminders`; // incidentReminders, nearMissReminders, observationReminders
	const fullPath = `companies/${user.companyId}/incidentSettings/notifications/${pathKey}`;
	console.log('Firebase path:', fullPath);
	
	try {
		console.log('ðŸ’¾ Attempting to save to Firebase...');
		await db.ref(fullPath).update(settings);
		console.log(`âœ… ${eventType} reminder settings saved successfully`);
		
		// Show brief success message
		const btn = document.querySelector(`button[onclick="saveEventReminderSettings('${eventType}')"]`);
		if (btn) {
			const originalText = btn.innerHTML;
			btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
			btn.style.background = '#059669';
			setTimeout(() => {
				btn.innerHTML = originalText;
				btn.style.background = '#10b981';
			}, 2000);
		}

		// Immediately re-check schedules so changes take effect without waiting
		try {
			console.log('ðŸ”„ Triggering immediate schedule check after save...');
			checkAndSendScheduledReminders();
			console.log('âœ… Triggered immediate schedule check after save');
		} catch(scheduleErr) {
			console.warn('âš ï¸ Failed to trigger immediate schedule check:', scheduleErr);
		}
	} catch (error) {
		console.error(`Error saving ${eventType} reminder settings:`, error);
		console.error('Error details:', error.message, error.code);
		alert(`Failed to save reminder settings: ${error.message}`);
	}
}

// ========== AUTOMATIC REMINDER SYSTEM ==========
let reminderCheckInterval = null;

// Initialize automatic reminder checking system
function initAutoReminderSystem() {
	console.log('ðŸš€ Initializing automatic reminder system...');
	
	const updateStatus = (text, bgColor, textColor) => {
		const statusEl = document.getElementById('autoReminderStatus');
		if (statusEl) {
			statusEl.textContent = text;
			statusEl.style.background = bgColor;
			statusEl.style.color = textColor;
		}
	};
	
	// Clear any existing interval
	if (reminderCheckInterval) {
		clearInterval(reminderCheckInterval);
		console.log('âœ… Cleared existing reminder interval');
	}
	
	// Check authentication first
	const checkAuth = () => {
		const user = authManager?.currentUser;
		if (!user || !user.companyId) {
			console.log('â³ Auto-reminder: Waiting for authentication...');
			updateStatus('â³ Waiting for login...', '#fef3c7', '#92400e');
			return false;
		}
		console.log('âœ… Auto-reminder: User authenticated:', user.email || user.uid);
		return true;
	};
	
	// Wait for authentication and then start checking
	const startAfterAuth = () => {
		if (checkAuth()) {
			console.log('ðŸŽ¯ Auto-reminder: Starting reminder checks');
			updateStatus('âœ… Auto-check ACTIVE', '#d1fae5', '#065f46');
			
			// Check immediately
			setTimeout(() => {
				console.log('ðŸ”„ Running initial schedule check...');
				checkAndSendScheduledReminders();
			}, 1000);
			
			// Then check every 30 seconds (more frequent for better reliability)
			reminderCheckInterval = setInterval(() => {
				if (checkAuth()) {
					checkAndSendScheduledReminders();
				} else {
					console.log('âŒ Auto-reminder: User no longer authenticated, stopping checks');
					clearInterval(reminderCheckInterval);
					reminderCheckInterval = null;
					updateStatus('âŒ Stopped (logged out)', '#fee2e2', '#991b1b');
				}
			}, 30000); // Check every 30 seconds for better reliability
			
			console.log('âœ… Automatic reminder system ACTIVE - checking every 30 seconds');
			console.log('ðŸ’¡ Use debugAutoReminder() in console for debugging');
		} else {
			// Retry authentication check after 2 seconds
			setTimeout(startAfterAuth, 2000);
		}
	};
	
	// Start the authentication check
	startAfterAuth();
}

// Check if reminders should be sent based on schedule
async function checkAndSendScheduledReminders() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		console.log('Auto-reminder: No authenticated user');
		return;
	}
	
	const now = new Date();
	const currentTime = now.toTimeString().slice(0, 5); // HH:MM format
	const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
	const currentDayOfMonth = now.getDate();
	const currentHour = now.getHours();
	const currentMinute = now.getMinutes();
	
	console.log(`Auto-reminder: Checking at ${currentTime} on ${currentDay} (${now.toLocaleDateString()})`);
	
	const eventTypes = ['incident', 'nearMiss', 'observation'];
	
	for (const eventType of eventTypes) {
		try {
			await checkEventTypeReminder(user.companyId, eventType, now, currentTime, currentDay, currentDayOfMonth, currentHour, currentMinute);
		} catch (err) {
			console.error(`Auto-reminder error for ${eventType}:`, err);
		}
	}
}

// Check and send reminders for a specific event type
async function checkEventTypeReminder(companyId, eventType, now, currentTime, currentDay, currentDayOfMonth, currentHour, currentMinute) {
	const pathKey = `${eventType}Reminders`;
	
	console.log(`Auto-reminder: Checking ${eventType} settings...`);
	
	// Get reminder settings
	const settingsSnap = await db.ref(`companies/${companyId}/incidentSettings/notifications/${pathKey}`).once('value');
	const settings = settingsSnap.val();
	
	console.log(`Auto-reminder: ${eventType} settings:`, settings);
	
	if (!settings || !settings.enabled) {
		console.log(`Auto-reminder: ${eventType} reminders not enabled`);
		return;
	}
	
	const frequency = settings.frequency || 'weekly';
	const scheduledTime = settings.time || '09:00';
	const weekDays = settings.weekDays || { mon: true };
	const lastAutoSent = settings.lastAutoSent ? new Date(settings.lastAutoSent) : null;
	
	console.log(`Auto-reminder: ${eventType} - Frequency: ${frequency}, Scheduled: ${scheduledTime}, Current: ${currentTime}, Day: ${currentDay}`);
	console.log(`Auto-reminder: ${eventType} - Week days enabled:`, weekDays);
	console.log(`Auto-reminder: ${eventType} - Last auto sent:`, lastAutoSent);
	
	// Check if we already sent an AUTOMATIC reminder within the last minute - CHECK THIS FIRST
	if (lastAutoSent && (now - lastAutoSent) < 60 * 1000) {
		console.log(`Auto-reminder: ${eventType} already auto-sent within last minute (${lastAutoSent.toLocaleString()}), skipping`);
		return;
	}
	
	// Parse scheduled time
	const [schedHour, schedMinute] = scheduledTime.split(':').map(Number);
	
	// Check if current time is AT or PAST scheduled time today (catch-up mode)
	// This allows sending if the page was opened after the scheduled time
	const scheduledMinutesOfDay = schedHour * 60 + schedMinute;
	const currentMinutesOfDay = currentHour * 60 + currentMinute;
	
	const isAtOrPastScheduledTime = currentMinutesOfDay >= scheduledMinutesOfDay;
	const isWithinSameHour = currentHour === schedHour; // More relaxed: within same hour
	const isExactMatch = currentMinutesOfDay === scheduledMinutesOfDay; // Exact minute match
	
	console.log(`Auto-reminder: ${eventType} - Scheduled: ${schedHour}:${schedMinute}, Current: ${currentHour}:${currentMinute}`);
	console.log(`Auto-reminder: ${eventType} - At/Past scheduled: ${isAtOrPastScheduledTime}, Within hour: ${isWithinSameHour}, Exact match: ${isExactMatch}`);
	
	// Send if: exact time match OR (past scheduled time today AND not sent yet today)
	const shouldCheckFurther = isExactMatch || (isAtOrPastScheduledTime && !lastAutoSent);
	
	if (!shouldCheckFurther) {
		console.log(`Auto-reminder: ${eventType} - Time conditions not met, skipping`);
		return;
	}
	
	// Check frequency conditions
	let shouldSend = false;
	
	switch (frequency) {
		case 'daily':
			shouldSend = true;
			console.log(`Auto-reminder: ${eventType} - Daily frequency, should send: ${shouldSend}`);
			break;
			
		case 'weekly':
			shouldSend = weekDays[currentDay] === true;
			console.log(`Auto-reminder: ${eventType} - Weekly frequency, today (${currentDay}) enabled: ${shouldSend}`);
			break;
			
		case 'bi-weekly':
			// Send on selected days, but only every other week
			if (weekDays[currentDay] === true) {
				const weekNumber = getWeekNumber(now);
				shouldSend = weekNumber % 2 === 0; // Even weeks
				console.log(`Auto-reminder: ${eventType} - Bi-weekly frequency, week ${weekNumber}, should send: ${shouldSend}`);
			} else {
				console.log(`Auto-reminder: ${eventType} - Bi-weekly frequency, today (${currentDay}) not enabled`);
			}
			break;
			
		case 'monthly':
			// Send on the 1st of each month (or configured day)
			shouldSend = currentDayOfMonth === 1;
			console.log(`Auto-reminder: ${eventType} - Monthly frequency, day ${currentDayOfMonth}, should send: ${shouldSend}`);
			break;
			
		case 'before-due':
			// This is handled differently - send based on action due dates
			shouldSend = true; // Always check, filtering is done in sendEventReminders
			console.log(`Auto-reminder: ${eventType} - Before-due frequency, checking actions...`);
			break;
			
		default:
			shouldSend = false;
			console.log(`Auto-reminder: ${eventType} - Unknown frequency: ${frequency}`);
	}
	
	if (shouldSend) {
		console.log(`Auto-reminder: Conditions met! Sending ${eventType} reminders...`);
		await sendAutoReminders(companyId, eventType, settings);
	} else {
		console.log(`Auto-reminder: ${eventType} - Conditions not met, not sending`);
	}
}

// Check if two times match (within 2 minute tolerance for reliability)
function isTimeMatch(currentTime, scheduledTime) {
	try {
		const [currentH, currentM] = currentTime.split(':').map(Number);
		const [schedH, schedM] = scheduledTime.split(':').map(Number);
		
		const currentMinutes = currentH * 60 + currentM;
		const schedMinutes = schedH * 60 + schedM;
		
		const diff = Math.abs(currentMinutes - schedMinutes);
		const isMatch = diff <= 2; // Increased to 2 minute tolerance
		
		console.log(`Time match check: ${currentTime} vs ${scheduledTime} = ${isMatch} (diff: ${diff} minutes)`);
		
		return isMatch;
	} catch (err) {
		console.error('Error in isTimeMatch:', err);
		return false;
	}
}

// Check if two dates are the same day
function isSameDay(date1, date2) {
	return date1.getFullYear() === date2.getFullYear() &&
		   date1.getMonth() === date2.getMonth() &&
		   date1.getDate() === date2.getDate();
}

// Get ISO week number
function getWeekNumber(date) {
	const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
	const dayNum = d.getUTCDay() || 7;
	d.setUTCDate(d.getUTCDate() + 4 - dayNum);
	const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
	return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// Send automatic reminders for an event type
async function sendAutoReminders(companyId, eventType, settings) {
	const eventTypeMap = {
		'incident': { filter: 'incident', label: 'Incident', pathKey: 'incidentReminders' },
		'nearMiss': { filter: 'near-miss', label: 'Near Miss', pathKey: 'nearMissReminders' },
		'observation': { filter: 'observation', label: 'Observation', pathKey: 'observationReminders' }
	};
	const eventConfig = eventTypeMap[eventType] || eventTypeMap['incident'];
	
	try {
		// Get all incidents
		const incidentsSnap = await db.ref(`companies/${companyId}/incidents`).once('value');
		const incidents = incidentsSnap.val() || {};
		
		console.log(`Auto-reminder: Found ${Object.keys(incidents).length} total incidents`);
		
		// Get company info
		const companySnap = await db.ref(`companies/${companyId}`).once('value');
		const company = companySnap.val() || {};
		const companyName = company.companyName || 'Company';
		
		// Ensure user cache is loaded
		if (Object.keys(notificationUsersCache).length === 0) {
			console.log('Auto-reminder: Loading notification users cache...');
			await loadNotificationUsers();
		}
		console.log(`Auto-reminder: User cache has ${Object.keys(notificationUsersCache).length} users`);
		
		// Collect actions needing reminders grouped by owner email
		const actionsByOwner = {};
		const today = new Date();
		today.setHours(0, 0, 0, 0);
		
		const frequency = settings.frequency || 'weekly';
		const daysBefore = settings.daysBefore || 3;
		
		let totalActions = 0;
		let matchingTypeActions = 0;
		let pendingActions = 0;
		let actionsWithOwner = 0;
		
		Object.entries(incidents).forEach(([incidentId, incident]) => {
			// Filter by event type
			const incidentType = incident.incidentType || incident.eventType || 'incident';
			if (incidentType !== eventConfig.filter) return;
			
			const actions = incident.correctiveActions || [];
			totalActions += actions.length;
			
			actions.forEach((action, idx) => {
				matchingTypeActions++;
				
				// Skip completed actions
				if (action.status === 'completed' || action.status === 'closed') return;
				pendingActions++;
				
				// Get action owner info
				const ownerUid = action.responsiblePerson || action.assignedTo || incident.assignedTo;
				if (!ownerUid) {
					console.log(`Auto-reminder: Action "${action.description || 'untitled'}" has no owner assigned`);
					return;
				}
				
				const ownerData = notificationUsersCache[ownerUid];
				if (!ownerData || !ownerData.email) {
					console.log(`Auto-reminder: Owner ${ownerUid} not found in cache or has no email`);
					return;
				}
				actionsWithOwner++;
				
				// For "before-due" frequency, check if within days before window
				if (frequency === 'before-due') {
					const dueDate = action.dueDate ? new Date(action.dueDate) : null;
					if (!dueDate) return; // Skip actions without due date
					
					dueDate.setHours(0, 0, 0, 0);
					const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
					
					// Only include if within the daysBefore window (and not overdue more than 7 days)
					if (daysUntilDue > daysBefore || daysUntilDue < -7) return;
				}
				
				// Add to owner's action list
				if (!actionsByOwner[ownerData.email]) {
					actionsByOwner[ownerData.email] = {
						name: ownerData.name || `${ownerData.firstName || ''} ${ownerData.lastName || ''}`.trim() || ownerData.email,
						actions: []
					};
				}
				
				actionsByOwner[ownerData.email].actions.push({
					title: action.description || action.action || 'Untitled Action',
					incidentRef: incident.referenceNumber || incidentId,
					incidentTitle: incident.title || 'Untitled Incident',
					eventType: eventConfig.label,
					dueDate: action.dueDate || 'Not set',
					status: action.status || 'open',
					priority: action.priority || incident.severity || 'medium'
				});
			});
		});
		
		// If no actions found and frequency is not before-due, send reminders for incidents themselves
		if (frequency !== 'before-due' && Object.keys(actionsByOwner).length === 0) {
			Object.entries(incidents).forEach(([incidentId, incident]) => {
				const incidentType = incident.incidentType || incident.eventType || 'incident';
				if (incidentType !== eventConfig.filter) return;
				const ownerUid = incident.assignedTo;
				if (!ownerUid) return;
				const ownerData = notificationUsersCache[ownerUid];
				if (!ownerData || !ownerData.email) return;
				if (!actionsByOwner[ownerData.email]) {
					actionsByOwner[ownerData.email] = {
						name: ownerData.name || `${ownerData.firstName || ''} ${ownerData.lastName || ''}`.trim() || ownerData.email,
						actions: []
					};
				}
				actionsByOwner[ownerData.email].actions.push({
					title: incident.title || 'Untitled Incident',
					incidentRef: incident.referenceNumber || incidentId,
					incidentTitle: incident.title || 'Untitled Incident',
					eventType: eventConfig.label,
					dueDate: 'N/A',
					status: incident.status || 'open',
					priority: incident.severity || 'medium'
				});
			});
		}
		
		console.log(`Auto-reminder: Stats - Total actions: ${totalActions}, Matching type: ${matchingTypeActions}, Pending: ${pendingActions}, With owner: ${actionsWithOwner}`);
		
		// Send emails to each owner
		const ownerEmails = Object.keys(actionsByOwner);
		if (ownerEmails.length === 0) {
			console.log(`Auto-reminder: No pending ${eventConfig.label} actions require reminders (no valid recipients found)`);
			return;
		}
		
		console.log(`Auto-reminder: Will send to ${ownerEmails.length} owners:`, ownerEmails);
		
		let successCount = 0;
		let failCount = 0;
		const customMessage = settings.message || '';
		
		for (const email of ownerEmails) {
			const owner = actionsByOwner[email];
			try {
				await sendActionReminderEmail(email, owner.name, owner.actions, companyName, eventConfig.label, customMessage);
				successCount++;
				console.log(`Auto-reminder: Sent ${eventConfig.label} reminder to ${email}`);
			} catch (err) {
				console.error(`Auto-reminder: Failed to send to ${email}:`, err);
				failCount++;
			}
		}
		
		// Update last sent timestamps (auto-specific and general)
		const nowIso = new Date().toISOString();
		await db.ref(`companies/${companyId}/incidentSettings/notifications/${eventConfig.pathKey}/lastAutoSent`).set(nowIso);
		await db.ref(`companies/${companyId}/incidentSettings/notifications/${eventConfig.pathKey}/lastSent`).set(nowIso);
		
		// Update UI if visible
		const lastSentEl = document.getElementById(`${eventType}LastReminderSent`);
		if (lastSentEl) {
			lastSentEl.innerHTML = `<i class="fas fa-check-circle" style="color:#059669;"></i> Last: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
		}
		
		console.log(`Auto-reminder: ${eventConfig.label} - Sent to ${successCount} owners, ${failCount} failed`);
		
	} catch (error) {
		console.error(`Auto-reminder error for ${eventType}:`, error);
	}
}

// Test function for automatic reminders (bypasses time/frequency checks)
async function testAutoReminder(eventType) {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		alert('User not authenticated');
		return;
	}
	
	console.log(`Testing automatic reminder for ${eventType}...`);
	
	const pathKey = `${eventType}Reminders`;
	
	try {
		// Get settings
		const settingsSnap = await db.ref(`companies/${user.companyId}/incidentSettings/notifications/${pathKey}`).once('value');
		const settings = settingsSnap.val();
		
		if (!settings) {
			alert(`No settings found for ${eventType} reminders`);
			return;
		}
		
		if (!settings.enabled) {
			alert(`${eventType} reminders are not enabled. Please enable them first.`);
			return;
		}
		
		// Force send regardless of time/frequency
		console.log(`Force sending ${eventType} reminders for testing...`);
		await sendAutoReminders(user.companyId, eventType, settings);
		
		alert(`Test completed! Check browser console for detailed logs.`);
		
	} catch (error) {
		console.error(`Test auto-reminder error for ${eventType}:`, error);
		alert(`Test failed: ${error.message}`);
	}
}

// Debug function to check current state and force schedule check
window.debugAutoReminder = async function() {
	console.log('=== DEBUG AUTO REMINDER SYSTEM ===');
	
	const user = authManager?.currentUser;
	console.log('Current user:', user);
	
	if (!user || !user.companyId) {
		console.log('âŒ No authenticated user or company ID');
		return;
	}
	
	const now = new Date();
	console.log('Current time:', now.toTimeString().slice(0, 8), 'on', now.toLocaleDateString());
	console.log('Current day:', ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()]);
	
	console.log('\nChecking reminder interval...');
	console.log('Reminder check interval active:', !!reminderCheckInterval);
	
	console.log('\nForcing immediate schedule check...');
	await checkAndSendScheduledReminders();
	
	console.log('=== END DEBUG ===');
};

// ========== END AUTOMATIC REMINDER SYSTEM ==========

// Send manual action plan reminders for a specific event type
async function sendEventReminders(eventType) {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		alert('User not authenticated');
		return;
	}
	
	const btn = event.target.closest('button');
	const originalText = btn.innerHTML;
	btn.disabled = true;
	btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
	
	// Map event type to incident type filter and path key
	const eventTypeMap = {
		'incident': { filter: 'incident', label: 'Incident', pathKey: 'incidentReminders' },
		'nearMiss': { filter: 'near-miss', label: 'Near Miss', pathKey: 'nearMissReminders' },
		'observation': { filter: 'observation', label: 'Observation', pathKey: 'observationReminders' }
	};
	const eventConfig = eventTypeMap[eventType] || eventTypeMap['incident'];
	
	try {
		// Get reminder settings for this event type
		const settingsSnap = await db.ref(`companies/${user.companyId}/incidentSettings/notifications/${eventConfig.pathKey}`).once('value');
		const settings = settingsSnap.val() || {};
		const statuses = settings.statuses || { open: true, inProgress: true, pending: true, overdue: true };
		
		// Get all incidents filtered by event type
		const incidentsSnap = await db.ref(`companies/${user.companyId}/incidents`).once('value');
		const incidents = incidentsSnap.val() || {};
		
		// Get company info
		const companySnap = await db.ref(`companies/${user.companyId}`).once('value');
		const company = companySnap.val() || {};
		const companyName = company.companyName || 'Company';
		
		// Collect actions needing reminders grouped by owner email
		const actionsByOwner = {};
		const today = new Date();
		today.setHours(0, 0, 0, 0);
		
		Object.entries(incidents).forEach(([incidentId, incident]) => {
			// Filter by event type (incident type)
			const incidentType = incident.incidentType || 'incident';
			if (incidentType !== eventConfig.filter) return;
			
			const actions = incident.correctiveActions || [];
			actions.forEach((action, idx) => {
				// Skip completed actions
				if (action.status === 'completed' || action.status === 'closed') return;
				
				// Check if this status should be included
				const statusKey = action.status?.replace(/-/g, '') || 'open';
				const statusMap = {
					'open': 'open',
					'inprogress': 'inProgress',
					'in-progress': 'inProgress',
					'pending': 'pending',
					'overdue': 'overdue'
				};
				const mappedStatus = statusMap[statusKey.toLowerCase()] || 'open';
				if (!statuses[mappedStatus]) return;
				
				// Get action owner info
				const ownerUid = action.responsiblePerson || action.assignedTo || incident.assignedTo;
				if (!ownerUid) return;
				
				const ownerData = notificationUsersCache[ownerUid];
				if (!ownerData || !ownerData.email) return;
				
				// Check due date criteria
				const dueDate = action.dueDate ? new Date(action.dueDate) : null;
				if (dueDate) {
					dueDate.setHours(0, 0, 0, 0);
					const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
					const daysBefore = settings.daysBefore || 3;
					
					// Check if within reminder window
					if (daysUntilDue > daysBefore) return; // Not yet in reminder window
					
					// Check overdue settings
					if (daysUntilDue < 0) {
						const includeOverdue = settings.includeOverdue || 'always';
						if (includeOverdue === 'never') return;
						if (includeOverdue === '7-days' && daysUntilDue < -7) return;
						if (includeOverdue === '14-days' && daysUntilDue < -14) return;
						if (includeOverdue === '30-days' && daysUntilDue < -30) return;
					}
				}
				
				// Add to owner's action list
				if (!actionsByOwner[ownerData.email]) {
					actionsByOwner[ownerData.email] = {
						name: ownerData.name || `${ownerData.firstName || ''} ${ownerData.lastName || ''}`.trim() || ownerData.email,
						actions: []
					};
				}
				
				actionsByOwner[ownerData.email].actions.push({
					title: action.description || action.action || 'Untitled Action',
					incidentRef: incident.referenceNumber || incidentId,
					incidentTitle: incident.title || 'Untitled Incident',
					eventType: eventConfig.label,
					dueDate: action.dueDate || 'Not set',
					status: action.status || 'open',
					priority: action.priority || incident.severity || 'medium'
				});
			});
		});
		
		// Send emails to each owner
		const ownerEmails = Object.keys(actionsByOwner);
		if (ownerEmails.length === 0) {
			alert(`No pending ${eventConfig.label} actions require reminders at this time.`);
			btn.disabled = false;
			btn.innerHTML = originalText;
			return;
		}
		
		let successCount = 0;
		let failCount = 0;
		
		// Get custom message for this event type
		const customMessage = settings.message || '';
		
		for (const email of ownerEmails) {
			const owner = actionsByOwner[email];
			try {
				await sendActionReminderEmail(email, owner.name, owner.actions, companyName, eventConfig.label, customMessage);
				successCount++;
			} catch (err) {
				console.error('Failed to send reminder to:', email, err);
				failCount++;
			}
		}
		
		// Update last sent timestamp for this event type (manual trigger)
		const nowIso = new Date().toISOString();
		await db.ref(`companies/${user.companyId}/incidentSettings/notifications/${eventConfig.pathKey}/lastManualSent`).set(nowIso);
		await db.ref(`companies/${user.companyId}/incidentSettings/notifications/${eventConfig.pathKey}/lastSent`).set(nowIso);
		const lastSentEl = document.getElementById(`${eventType}LastReminderSent`);
		if (lastSentEl) {
			lastSentEl.innerHTML = `<i class="fas fa-check-circle" style="color:#059669;"></i> Last: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
		}
		
		alert(`${eventConfig.label} reminders sent to ${successCount} action owner(s)${failCount > 0 ? `. ${failCount} failed.` : '.'}`);
	} catch (error) {
		console.error('Error sending action reminders:', error);
		alert('Failed to send reminders: ' + error.message);
	} finally {
		btn.disabled = false;
		btn.innerHTML = originalText;
	}
}

// Send individual action reminder email
async function sendActionReminderEmail(email, ownerName, actions, companyName, eventTypeLabel, customMessage) {
	if (typeof emailjs === 'undefined') {
		throw new Error('EmailJS not loaded');
	}
	
	const eventLabel = eventTypeLabel || 'HSE';
	
	// Use custom message if provided, otherwise use default
	const introMessage = customMessage || `You have ${actions.length} pending ${eventLabel} corrective action(s) that require your attention.`;
	
	// Build action list HTML
	const actionListText = actions.map((a, i) => {
		const dueDateFormatted = a.dueDate && a.dueDate !== 'Not set' 
			? new Date(a.dueDate).toLocaleDateString() 
			: 'Not set';
		const isOverdue = a.dueDate && a.dueDate !== 'Not set' && new Date(a.dueDate) < new Date();
		const overdueText = isOverdue ? ' (OVERDUE)' : '';
		
		return `${i + 1}. ${a.title}
   Reference: ${a.incidentRef} - ${a.incidentTitle}
   Type: ${a.eventType || eventLabel}
   Due Date: ${dueDateFormatted}${overdueText}
   Status: ${a.status.replace(/-/g, ' ').replace(/\b\w/g, m => m.toUpperCase())}
   Priority: ${a.priority.charAt(0).toUpperCase() + a.priority.slice(1)}`;
	}).join('\n\n');
	
	const messageBody = `Dear ${ownerName},

${introMessage}

PENDING ${eventLabel.toUpperCase()} ACTIONS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${actionListText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Please review and complete these actions through the HSE System.

Review Actions: ${window.location.origin}/incidentboard.html#actionPlan

Best regards,
${companyName} HSE System

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
This is an automated reminder from the HSE Management System.
To adjust reminder settings, please contact your HSE administrator.`;

	const emailData = {
		to_email: email,
		to_name: ownerName,
		from_name: companyName + ' HSE System',
		subject: `[${eventLabel} Reminder] You have ${actions.length} pending action(s) - ${companyName}`,
		message: messageBody,
		// Template compatibility variables
		position_title: `${eventLabel} Action Plan Reminder - ${actions.length} Pending`,
		department: 'HSE',
		requesting_manager: 'HSE System',
		request_date: new Date().toLocaleDateString(),
		approval_link: `${window.location.origin}/incidentboard.html#actionPlan`,
		company_name: companyName,
		company_email: 'info@dreamexdatalab.com',
		notification_context: `${eventLabel} Action Plan Reminder`
	};
	
	return await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, emailData);
}

// ========== End Action Plan Reminder Functions ==========

// ========== End Email Notification Functions ==========

function renderLocationOptions() {
	const container = document.getElementById('locationOptionsList');
	if (settingsState.locations.length === 0) {
		container.innerHTML = '<div class="empty-options"><i class="fas fa-info-circle"></i> No locations added yet. Add your first location below.</div>';
		return;
	}
	
	container.innerHTML = settingsState.locations.map((loc, idx) => `
		<div class="option-item" data-index="${idx}">
			<span>${escapeHtml(loc)}</span>
			<button type="button" class="edit-btn" onclick="editLocationOption(${idx})"><i class="fas fa-pen"></i></button>
			<button type="button" class="delete-btn" onclick="deleteLocationOption(${idx})"><i class="fas fa-trash"></i></button>
		</div>
	`).join('');
}

function renderObservationTypeOptions() {
	const container = document.getElementById('observationTypeOptionsList');
	if (settingsState.observationTypes.length === 0) {
		container.innerHTML = '<div class="empty-options"><i class="fas fa-info-circle"></i> No observation types added yet. Add your first type below.</div>';
		return;
	}
	
	container.innerHTML = settingsState.observationTypes.map((type, idx) => `
		<div class="option-item" data-index="${idx}">
			<span>${escapeHtml(type)}</span>
			<button type="button" class="edit-btn" onclick="editObservationTypeOption(${idx})"><i class="fas fa-pen"></i></button>
			<button type="button" class="delete-btn" onclick="deleteObservationTypeOption(${idx})"><i class="fas fa-trash"></i></button>
		</div>
	`).join('');
}

async function saveIncidentSettings() {
	const user = authManager?.currentUser;
	if (!user || !user.companyId) {
		alert('User not authenticated');
		return false;
	}
	
	try {
		await db.ref(`companies/${user.companyId}/incidentSettings`).update({
			locations: settingsState.locations,
			observationTypes: settingsState.observationTypes,
			categories: settingsState.categories,
			incidentCategories: settingsState.incidentCategories,
			injuryTypes: settingsState.injuryTypes,
			treatmentProvided: settingsState.treatmentProvided,
			updatedAt: new Date().toISOString(),
			updatedBy: user.uid
		});
		return true;
	} catch (error) {
		console.error('Error saving incident settings:', error);
		alert('Failed to save settings. Please try again.');
		return false;
	}
}

async function addLocationOption() {
	const input = document.getElementById('newLocationInput');
	const value = input.value.trim();
	
	if (!value) {
		alert('Please enter a location name');
		return;
	}
	
	if (settingsState.locations.includes(value)) {
		alert('This location already exists');
		return;
	}
	
	settingsState.locations.push(value);
	if (await saveIncidentSettings()) {
		input.value = '';
		renderLocationOptions();
	} else {
		settingsState.locations.pop();
	}
}

function editLocationOption(idx) {
	const currentValue = settingsState.locations[idx];
	const newValue = prompt('Edit location name:', currentValue);
	
	if (newValue === null || newValue.trim() === '') return;
	if (newValue.trim() === currentValue) return;
	
	if (settingsState.locations.includes(newValue.trim()) && newValue.trim() !== currentValue) {
		alert('This location already exists');
		return;
	}
	
	const oldValue = settingsState.locations[idx];
	settingsState.locations[idx] = newValue.trim();
	saveIncidentSettings().then(success => {
		if (success) {
			renderLocationOptions();
		} else {
			settingsState.locations[idx] = oldValue;
		}
	});
}

async function deleteLocationOption(idx) {
	if (!confirm('Are you sure you want to delete this location?')) return;
	
	const removed = settingsState.locations.splice(idx, 1)[0];
	if (await saveIncidentSettings()) {
		renderLocationOptions();
	} else {
		settingsState.locations.splice(idx, 0, removed);
	}
}

async function addObservationTypeOption() {
	const input = document.getElementById('newObservationTypeInput');
	const value = input.value.trim();
	
	if (!value) {
		alert('Please enter an observation type');
		return;
	}
	
	if (settingsState.observationTypes.includes(value)) {
		alert('This observation type already exists');
		return;
	}
	
	settingsState.observationTypes.push(value);
	if (await saveIncidentSettings()) {
		input.value = '';
		renderObservationTypeOptions();
	} else {
		settingsState.observationTypes.pop();
	}
}

function editObservationTypeOption(idx) {
	const currentValue = settingsState.observationTypes[idx];
	const newValue = prompt('Edit observation type:', currentValue);
	
	if (newValue === null || newValue.trim() === '') return;
	if (newValue.trim() === currentValue) return;
	
	if (settingsState.observationTypes.includes(newValue.trim()) && newValue.trim() !== currentValue) {
		alert('This observation type already exists');
		return;
	}
	
	const oldValue = settingsState.observationTypes[idx];
	settingsState.observationTypes[idx] = newValue.trim();
	saveIncidentSettings().then(success => {
		if (success) {
			renderObservationTypeOptions();
		} else {
			settingsState.observationTypes[idx] = oldValue;
		}
	});
}

async function deleteObservationTypeOption(idx) {
	if (!confirm('Are you sure you want to delete this observation type?')) return;
	
	const removed = settingsState.observationTypes.splice(idx, 1)[0];
	if (await saveIncidentSettings()) {
		renderObservationTypeOptions();
	} else {
		settingsState.observationTypes.splice(idx, 0, removed);
	}
}

// ===== CATEGORY OPTIONS =====
function renderCategoryOptions() {
	const container = document.getElementById('categoryOptionsList');
	if (!container) return;
	
	if (settingsState.categories.length === 0) {
		container.innerHTML = '';
		return;
	}
	
	container.innerHTML = settingsState.categories.map((cat, idx) => `
		<div class="option-item" data-index="${idx}">
			<span>${escapeHtml(cat)}</span>
			<button type="button" class="edit-btn" onclick="editCategoryOption(${idx})"><i class="fas fa-pen"></i></button>
			<button type="button" class="delete-btn" onclick="deleteCategoryOption(${idx})"><i class="fas fa-trash"></i></button>
		</div>
	`).join('');
}

async function addCategoryOption() {
	const input = document.getElementById('newCategoryInput');
	const value = input.value.trim();
	
	if (!value) {
		alert('Please enter a category name');
		return;
	}
	
	if (settingsState.categories.includes(value)) {
		alert('This category already exists');
		return;
	}
	
	settingsState.categories.push(value);
	if (await saveIncidentSettings()) {
		input.value = '';
		renderCategoryOptions();
	} else {
		settingsState.categories.pop();
	}
}

function editCategoryOption(idx) {
	const currentValue = settingsState.categories[idx];
	const newValue = prompt('Edit category name:', currentValue);
	
	if (newValue === null || newValue.trim() === '') return;
	if (newValue.trim() === currentValue) return;
	
	if (settingsState.categories.includes(newValue.trim()) && newValue.trim() !== currentValue) {
		alert('This category already exists');
		return;
	}
	
	const oldValue = settingsState.categories[idx];
	settingsState.categories[idx] = newValue.trim();
	saveIncidentSettings().then(success => {
		if (success) {
			renderCategoryOptions();
		} else {
			settingsState.categories[idx] = oldValue;
		}
	});
}

async function deleteCategoryOption(idx) {
	if (!confirm('Are you sure you want to delete this category?')) return;
	
	const removed = settingsState.categories.splice(idx, 1)[0];
	if (await saveIncidentSettings()) {
		renderCategoryOptions();
	} else {
		settingsState.categories.splice(idx, 0, removed);
	}
}

// ===== INCIDENT CATEGORY OPTIONS =====
function renderIncidentCategoryOptions() {
	const container = document.getElementById('incidentCategoryOptionsList');
	if (!container) return;
	
	if (settingsState.incidentCategories.length === 0) {
		container.innerHTML = '<div class="empty-options">No incident categories defined. Add one below.</div>';
		return;
	}
	
	container.innerHTML = settingsState.incidentCategories.map((cat, idx) => `
		<div class="option-item" data-index="${idx}">
			<span>${escapeHtml(cat)}</span>
			<button type="button" class="edit-btn" onclick="editIncidentCategoryOption(${idx})"><i class="fas fa-pen"></i></button>
			<button type="button" class="delete-btn" onclick="deleteIncidentCategoryOption(${idx})"><i class="fas fa-trash"></i></button>
		</div>
	`).join('');
}

async function addIncidentCategoryOption() {
	const input = document.getElementById('newIncidentCategoryInput');
	const value = input.value.trim();
	
	if (!value) {
		alert('Please enter an incident category');
		return;
	}
	
	if (settingsState.incidentCategories.includes(value)) {
		alert('This incident category already exists');
		return;
	}
	
	settingsState.incidentCategories.push(value);
	if (await saveIncidentSettings()) {
		input.value = '';
		renderIncidentCategoryOptions();
	} else {
		settingsState.incidentCategories.pop();
	}
}

function editIncidentCategoryOption(idx) {
	const currentValue = settingsState.incidentCategories[idx];
	const newValue = prompt('Edit incident category:', currentValue);
	
	if (newValue === null || newValue.trim() === '') return;
	if (newValue.trim() === currentValue) return;
	
	if (settingsState.incidentCategories.includes(newValue.trim()) && newValue.trim() !== currentValue) {
		alert('This incident category already exists');
		return;
	}
	
	const oldValue = settingsState.incidentCategories[idx];
	settingsState.incidentCategories[idx] = newValue.trim();
	saveIncidentSettings().then(success => {
		if (success) {
			renderIncidentCategoryOptions();
		} else {
			settingsState.incidentCategories[idx] = oldValue;
		}
	});
}

async function deleteIncidentCategoryOption(idx) {
	if (!confirm('Are you sure you want to delete this incident category?')) return;
	
	const removed = settingsState.incidentCategories.splice(idx, 1)[0];
	if (await saveIncidentSettings()) {
		renderIncidentCategoryOptions();
	} else {
		settingsState.incidentCategories.splice(idx, 0, removed);
	}
}

// ===== INJURY TYPE OPTIONS =====
function renderInjuryTypeOptions() {
	const container = document.getElementById('injuryTypeOptionsList');
	if (!container) return;
	
	if (settingsState.injuryTypes.length === 0) {
		container.innerHTML = '<div class="empty-options">No injury types defined. Add one below.</div>';
		return;
	}
	
	container.innerHTML = settingsState.injuryTypes.map((type, idx) => `
		<div class="option-item" data-index="${idx}">
			<span>${escapeHtml(type)}</span>
			<button type="button" class="edit-btn" onclick="editInjuryTypeOption(${idx})"><i class="fas fa-pen"></i></button>
			<button type="button" class="delete-btn" onclick="deleteInjuryTypeOption(${idx})"><i class="fas fa-trash"></i></button>
		</div>
	`).join('');
}

async function addInjuryTypeOption() {
	const input = document.getElementById('newInjuryTypeInput');
	const value = input.value.trim();
	
	if (!value) {
		alert('Please enter an injury type');
		return;
	}
	
	if (settingsState.injuryTypes.includes(value)) {
		alert('This injury type already exists');
		return;
	}
	
	settingsState.injuryTypes.push(value);
	if (await saveIncidentSettings()) {
		input.value = '';
		renderInjuryTypeOptions();
	} else {
		settingsState.injuryTypes.pop();
	}
}

function editInjuryTypeOption(idx) {
	const currentValue = settingsState.injuryTypes[idx];
	const newValue = prompt('Edit injury type:', currentValue);
	
	if (newValue === null || newValue.trim() === '') return;
	if (newValue.trim() === currentValue) return;
	
	if (settingsState.injuryTypes.includes(newValue.trim()) && newValue.trim() !== currentValue) {
		alert('This injury type already exists');
		return;
	}
	
	const oldValue = settingsState.injuryTypes[idx];
	settingsState.injuryTypes[idx] = newValue.trim();
	saveIncidentSettings().then(success => {
		if (success) {
			renderInjuryTypeOptions();
		} else {
			settingsState.injuryTypes[idx] = oldValue;
		}
	});
}

async function deleteInjuryTypeOption(idx) {
	if (!confirm('Are you sure you want to delete this injury type?')) return;
	
	const removed = settingsState.injuryTypes.splice(idx, 1)[0];
	if (await saveIncidentSettings()) {
		renderInjuryTypeOptions();
	} else {
		settingsState.injuryTypes.splice(idx, 0, removed);
	}
}

// ===== TREATMENT PROVIDED OPTIONS =====
function renderTreatmentProvidedOptions() {
	const container = document.getElementById('treatmentProvidedOptionsList');
	if (!container) return;
	
	if (settingsState.treatmentProvided.length === 0) {
		container.innerHTML = '<div class="empty-options">No treatment types defined. Add one below.</div>';
		return;
	}
	
	container.innerHTML = settingsState.treatmentProvided.map((treatment, idx) => `
		<div class="option-item" data-index="${idx}">
			<span>${escapeHtml(treatment)}</span>
			<button type="button" class="edit-btn" onclick="editTreatmentProvidedOption(${idx})"><i class="fas fa-pen"></i></button>
			<button type="button" class="delete-btn" onclick="deleteTreatmentProvidedOption(${idx})"><i class="fas fa-trash"></i></button>
		</div>
	`).join('');
}

async function addTreatmentProvidedOption() {
	const input = document.getElementById('newTreatmentProvidedInput');
	const value = input.value.trim();
	
	if (!value) {
		alert('Please enter a treatment type');
		return;
	}
	
	if (settingsState.treatmentProvided.includes(value)) {
		alert('This treatment type already exists');
		return;
	}
	
	settingsState.treatmentProvided.push(value);
	if (await saveIncidentSettings()) {
		input.value = '';
		renderTreatmentProvidedOptions();
	} else {
		settingsState.treatmentProvided.pop();
	}
}

function editTreatmentProvidedOption(idx) {
	const currentValue = settingsState.treatmentProvided[idx];
	const newValue = prompt('Edit treatment type:', currentValue);
	
	if (newValue === null || newValue.trim() === '') return;
	if (newValue.trim() === currentValue) return;
	
	if (settingsState.treatmentProvided.includes(newValue.trim()) && newValue.trim() !== currentValue) {
		alert('This treatment type already exists');
		return;
	}
	
	const oldValue = settingsState.treatmentProvided[idx];
	settingsState.treatmentProvided[idx] = newValue.trim();
	saveIncidentSettings().then(success => {
		if (success) {
			renderTreatmentProvidedOptions();
		} else {
			settingsState.treatmentProvided[idx] = oldValue;
		}
	});
}

async function deleteTreatmentProvidedOption(idx) {
	if (!confirm('Are you sure you want to delete this treatment type?')) return;
	
	const removed = settingsState.treatmentProvided.splice(idx, 1)[0];
	if (await saveIncidentSettings()) {
		renderTreatmentProvidedOptions();
	} else {
		settingsState.treatmentProvided.splice(idx, 0, removed);
	}
}

// Allow Enter key to submit in input fields
document.addEventListener('DOMContentLoaded', () => {
	document.getElementById('newLocationInput')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') addLocationOption();
	});
	document.getElementById('newObservationTypeInput')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') addObservationTypeOption();
	});
	document.getElementById('newCategoryInput')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') addCategoryOption();
	});
	document.getElementById('newIncidentCategoryInput')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') addIncidentCategoryOption();
	});
	document.getElementById('newInjuryTypeInput')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') addInjuryTypeOption();
	});
	document.getElementById('newTreatmentProvidedInput')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') addTreatmentProvidedOption();
	});
});
// ===== END SETTINGS TAB MANAGEMENT =====

document.addEventListener('DOMContentLoaded',()=>{
	bindSidebarToggle();
	initTabNavigation();
	
	// Apply tab visibility based on access control
	setTimeout(() => applyIncidentTabVisibility(), 500);
	
	// Initialize automatic reminder system
	setTimeout(() => initAutoReminderSystem(), 3000);
	
	// Modal event bindings
	document.getElementById('incCloseBtn').addEventListener('click', closeIncidentDetails);
	document.getElementById('incPrintBtn').addEventListener('click', printIncidentDetails);
	document.getElementById('incidentDetailsOverlay').addEventListener('click', (e) => {
		if (e.target.id === 'incidentDetailsOverlay') closeIncidentDetails();
	});
	
	// Notification dropdown toggle
	(function bindNotifications(){
		const btn=document.getElementById('notificationBtn');
		const dropdown=document.querySelector('.notification-dropdown');
		const badge=document.querySelector('.notification-badge');
		if(badge) badge.style.display='none';
		if(btn && dropdown){
			btn.addEventListener('click', (e)=>{ e.stopPropagation(); dropdown.classList.toggle('show'); });
			document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && !btn.contains(e.target)) dropdown.classList.remove('show'); });
		}
		const markAll=document.querySelector('.mark-all-read');
		if(markAll){ markAll.addEventListener('click', ()=>{ dropdown?.classList.remove('show'); if(badge) badge.style.display='none'; }); }
	})();
	document.getElementById('clearFilters').onclick=()=>{ ['searchInput','severityFilter','statusFilter','fromDate','toDate'].forEach(id=>document.getElementById(id).value=''); applyFilters(); };
	['searchInput','severityFilter','statusFilter','fromDate','toDate'].forEach(id=>document.getElementById(id).addEventListener('input',applyFilters));
	document.getElementById('prevPage').onclick=()=>{ if(state.page>1){ state.page--; renderTable(); } };
	document.getElementById('nextPage').onclick=()=>{ const pages=Math.max(1, Math.ceil(state.filtered.length/state.pageSize)); if(state.page<pages){ state.page++; renderTable(); } };
	document.getElementById('refreshBtn').onclick=()=>{ auth.currentUser && getCompanyIdFor(auth.currentUser.uid).then(id=>id&&loadIncidents(id)); };
});

// ===== DEMO AND HELP GUIDE FUNCTIONS =====
function toggleDemoDropdown() {
	const dropdown = document.getElementById('demoDropdown');
	dropdown.classList.toggle('active');
}

function closeDemoDropdown() {
	const dropdown = document.getElementById('demoDropdown');
	dropdown.classList.remove('active');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
	const dropdown = document.getElementById('demoDropdown');
	const btn = document.getElementById('demoMenuBtn');
	if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
		dropdown.classList.remove('active');
	}
});

function showIncidentDemo(type) {
	if (type === 'near-miss') {
		openNearMissDemo();
	} else if (type === 'observation') {
		openObservationDemo();
	} else if (type === 'incident') {
		openIncidentDemoVideo();
	}
}

// ========== NEAR MISS DEMO VIDEO ==========
let nearMissPlaying = false;
let nearMissCurrentStep = 0;
let nearMissInterval = null;
let nearMissProgress = 0;

const nearMissScenes = [
	{ id: 'welcome', caption: '<strong>Welcome!</strong> This is the <span style="color:#fbbf24;">Near Miss</span> reporting form from incident.html', duration: 2500, scrollTo: 0 },
	{ id: 'fill-title', caption: '<strong>Step 1:</strong> Enter a descriptive <span style="color:#fbbf24;">Title</span> for the near miss', duration: 2500, scrollTo: 0 },
	{ id: 'fill-severity', caption: '<strong>Step 2:</strong> Select the <span style="color:#fbbf24;">Severity</span> level', duration: 2500, scrollTo: 5 },
	{ id: 'fill-date', caption: '<strong>Step 3:</strong> Select the <span style="color:#fbbf24;">Date & Time</span> it occurred', duration: 2500, scrollTo: 10 },
	{ id: 'fill-status', caption: '<strong>Step 4:</strong> Status is <span style="color:#fbbf24;">Open</span> by default', duration: 2000, scrollTo: 15 },
	{ id: 'fill-location', caption: '<strong>Step 5:</strong> Choose the <span style="color:#fbbf24;">Location</span> where it happened', duration: 2500, scrollTo: 18 },
	{ id: 'fill-department', caption: '<strong>Step 6:</strong> Select the <span style="color:#fbbf24;">Department</span>', duration: 2500, scrollTo: 22 },
	{ id: 'fill-assigned', caption: '<strong>Step 7:</strong> Search and select <span style="color:#fbbf24;">Assigned To</span> employee', duration: 2500, scrollTo: 28 },
	{ id: 'fill-reported', caption: '<strong>Step 8:</strong> <span style="color:#fbbf24;">Reported By</span> and <span style="color:#fbbf24;">Date Reported</span> are auto-filled', duration: 2500, scrollTo: 32 },
	{ id: 'fill-description', caption: '<strong>Step 9:</strong> Provide a detailed <span style="color:#fbbf24;">Description</span> of what almost happened', duration: 3000, scrollTo: 45 },
	{ id: 'fill-actions', caption: '<strong>Step 10:</strong> Describe the <span style="color:#fbbf24;">Immediate Actions</span> taken', duration: 2500, scrollTo: 55 },
	{ id: 'click-add-action', caption: '<strong>Step 11:</strong> Click <span style="color:#fbbf24;">Add Action</span> to add a corrective action', duration: 2000, scrollTo: 60 },
	{ id: 'fill-action-desc', caption: '<strong>Step 12:</strong> Enter the <span style="color:#fbbf24;">Action Description</span>', duration: 2500, scrollTo: 62 },
	{ id: 'fill-action-person', caption: '<strong>Step 13:</strong> Assign a <span style="color:#fbbf24;">Responsible Person</span>', duration: 2500, scrollTo: 64 },
	{ id: 'fill-action-due', caption: '<strong>Step 14:</strong> Set the <span style="color:#fbbf24;">Action Due Date</span>', duration: 2500, scrollTo: 66 },
	{ id: 'save-action', caption: '<strong>Step 15:</strong> <span style="color:#22c55e;">Corrective Action Saved!</span>', duration: 2000, scrollTo: 68 },
	{ id: 'fill-duedate', caption: '<strong>Step 16:</strong> Set the overall <span style="color:#fbbf24;">Due Date</span> for follow-up', duration: 2500, scrollTo: 75 },
	{ id: 'fill-attachments', caption: '<strong>Step 17:</strong> Upload any <span style="color:#fbbf24;">Attachments</span> (photos, documents)', duration: 2500, scrollTo: 85 },
	{ id: 'submit', caption: '<strong>Step 18:</strong> Click <span style="color:#fbbf24;">Submit Incident</span> to save the report', duration: 2500, scrollTo: 100 },
	{ id: 'success', caption: '<strong>Done!</strong> Near miss reported successfully! <span style="color:#22c55e;">Reference: NM-2024-0015</span>', duration: 3000, scrollTo: 100 }
];

const nearMissTotalDuration = nearMissScenes.reduce((sum, s) => sum + s.duration, 0);

function openNearMissDemo() {
	document.getElementById('nearMissDemoOverlay').classList.add('active');
	buildNearMissScenes();
	restartNearMissVideo();
}

function closeNearMissDemo() {
	document.getElementById('nearMissDemoOverlay').classList.remove('active');
	if (nearMissInterval) clearInterval(nearMissInterval);
	nearMissPlaying = false;
}

function buildNearMissScenes() {
	const container = document.getElementById('nearMissDemoSceneContainer');
	if (!container) return;
	container.innerHTML = generateNearMissSceneHTML();
	addDemoAnimationStyles();
}

function generateNearMissSceneHTML() {
	// Displays the exact incident.html form page for Near Miss reporting
	return `
		<div style="width:100%; height:100%; display:flex; font-family:Inter,system-ui,sans-serif; font-size:14px;">
			<!-- Sidebar (250px like incident.html) -->
			<div style="width:120px; background:#2c3e50; color:#fff; flex-shrink:0; overflow-y:auto;">
				<div style="text-align:center; padding:0.5rem; border-bottom:1px solid rgba(255,255,255,0.1);">
					<h2 style="font-size:0.6rem; margin:0;">Dreamex Datalab</h2>
				</div>
				<ul style="list-style:none; margin:0.5rem 0; padding:0; font-size:0.55rem;">
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-home"></i> Home</a></li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-medkit"></i> Health</a></li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-exclamation-triangle"></i> Risk Management</a></li>
					<li>
						<a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; background:#3498db; border-radius:4px;"><i class="fas fa-shield-alt"></i> Safety</a>
						<ul style="list-style:none; margin-left:0.5rem; padding:0; font-size:0.5rem;">
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; opacity:0.7;">Training</a></li>
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; opacity:0.7;">Job Safety Analysis</a></li>
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; opacity:0.7;">Permit to Work</a></li>
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; background:rgba(255,255,255,0.15); border-radius:3px;">Incident Reports</a></li>
						</ul>
					</li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-search-plus"></i> Investigation</a></li>
				</ul>
			</div>
			<!-- Main Content Area -->
			<div style="flex:1; display:flex; flex-direction:column; background:#f8f9fa; overflow:hidden;">
				<!-- Top Nav -->
				<header style="display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0.5rem; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:sticky; top:0; z-index:20;">
					<div style="display:flex; align-items:center; gap:0.4rem;">
						<button style="background:none; border:none; font-size:0.7rem; color:#666; padding:0.2rem;"><i class="fas fa-bars"></i></button>
						<div style="width:20px; height:20px; background:#f59e0b; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.5rem; font-weight:600;">DX</div>
						<span style="font-weight:600; color:#2c3e50; font-size:0.6rem;">Company Name</span>
					</div>
					<div style="display:flex; align-items:center; gap:0.5rem;">
						<button style="background:none; border:none; font-size:0.7rem; color:#555; position:relative;"><i class="fas fa-bell"></i></button>
						<div style="width:20px; height:20px; background:#64748b; border-radius:50%; overflow:hidden;"></div>
					</div>
				</header>
				<!-- Page Header -->
				<div style="background:#fff; color:#2c3e50; padding:0.5rem; margin:0.4rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); border:1px solid #e0e0e0;">
					<h1 style="margin:0; font-size:0.8rem; display:flex; align-items:center; gap:0.4rem;"><i class="fas fa-exclamation-triangle"></i> Report Incident</h1>
					<a href="#" style="background:#2c3e50; color:#fff; border:none; padding:0.3rem 0.5rem; border-radius:4px; font-size:0.55rem; text-decoration:none;"><i class="fas fa-table-list"></i></a>
				</div>
				<!-- Form Content (scrollable) -->
				<div id="nmFormScroll" style="flex:1; overflow-y:auto; padding:0 0.4rem 0.4rem;">
					<form style="font-size:0.6rem;">
						<!-- Basic Information Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Basic Information</h3>
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem;">
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Reference</label>
									<input id="nmReference" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa;" placeholder="Auto-generated" readonly value="NM-2024-0015"/>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Title *</label>
									<div id="nmTitle" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af; min-height:1.2rem;">Brief title...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Severity *</label>
									<div id="nmSeverity" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Severity</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Event Type</label>
									<div id="nmEventType" style="width:100%; padding:0.3rem; border:1px solid #f59e0b; border-radius:4px; font-size:0.55rem; background:#fffbeb; color:#d97706; font-weight:600;">Near Miss</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Date & Time *</label>
									<div id="nmDate" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select date...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Status</label>
									<div id="nmStatus" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#374151;">Open</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Location *</label>
									<div id="nmLocation" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Location</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Department *</label>
									<div id="nmDepartment" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Department</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Assigned To</label>
									<div id="nmAssigned" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Search employee...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Reported By</label>
									<div id="nmReportedBy" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#374151;">John Doe</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Date Reported</label>
									<div id="nmDateReported" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#374151;">2024-12-17</div>
								</div>
							</div>
						</div>
						<!-- Event-specific Details Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Event-specific Details</h3>
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Description *</label>
								<div id="nmDescription" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:2.5rem; color:#9ca3af;">Describe what happened...</div>
							</div>
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Immediate Actions</label>
								<div id="nmActions" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:1.5rem; color:#9ca3af;">Actions taken immediately...</div>
							</div>
							<!-- Corrective Actions -->
							<div style="margin-bottom:0.4rem;">
								<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">
									<h4 style="margin:0; font-size:0.6rem; color:#2c3e50;"><i class="fas fa-tasks"></i> Corrective Actions</h4>
									<button id="nmAddAction" type="button" style="background:#2c3e50; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.5rem;"><i class="fas fa-plus"></i> Add Action</button>
								</div>
								<div id="nmCorrectiveActions" style="color:#666; font-style:italic; text-align:center; padding:0.5rem; font-size:0.5rem;">No corrective actions added.</div>
							</div>
							<div style="flex:1 1 45%;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Due Date</label>
								<div id="nmDueDate" style="width:50%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select date...</div>
							</div>
						</div>
						<!-- Attachments Section -->
						<div id="nmAttachmentsSection" style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Attachments</h3>
							<label id="nmUploadBtn" style="display:inline-flex; align-items:center; gap:0.2rem; background:#6c757d; color:#fff; padding:0.25rem 0.5rem; border-radius:4px; font-size:0.5rem; cursor:pointer;">
								<i class="fas fa-upload"></i> Choose Files
							</label>
							<small style="margin-left:0.3rem; color:#666; font-size:0.45rem;">Max 5MB each</small>
							<div id="nmFileList" style="margin-top:0.3rem;"></div>
						</div>
						<!-- Action Buttons -->
						<div style="display:flex; gap:0.3rem; justify-content:flex-end; padding:0.3rem 0;">
							<button type="button" style="padding:0.3rem 0.6rem; background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:0.55rem;">Cancel</button>
							<button type="button" style="padding:0.3rem 0.6rem; background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:0.55rem;">Save Draft</button>
							<button id="nmSubmitBtn" type="button" style="padding:0.3rem 0.6rem; background:#2c3e50; color:#fff; border:none; border-radius:4px; font-size:0.55rem; font-weight:600;">Submit Incident</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Success Message Overlay -->
		<div id="nmSuccessMsg" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100; display:flex; align-items:center; justify-content:center;">
			<div style="background:#fff; width:85%; max-width:280px; border-radius:8px; padding:1rem; text-align:center;">
				<div style="width:40px; height:40px; background:#dcfce7; border-radius:50%; margin:0 auto 0.5rem; display:flex; align-items:center; justify-content:center;">
					<i class="fas fa-check" style="font-size:1.2rem; color:#22c55e;"></i>
				</div>
				<h3 style="color:#1f2937; margin:0 0 0.2rem; font-size:0.8rem;">Near Miss Reported!</h3>
				<p style="color:#6b7280; font-size:0.65rem; margin:0;">Reference: <strong style="color:#f59e0b;">NM-2024-0015</strong></p>
				<div style="margin-top:0.5rem; padding:0.3rem; background:#fef3c7; border-radius:4px; border-left:3px solid #f59e0b;">
					<p style="margin:0; font-size:0.55rem; color:#92400e;"><i class="fas fa-info-circle"></i> Your report has been submitted successfully!</p>
				</div>
			</div>
		</div>
	`;
}

function restartNearMissVideo() {
	nearMissCurrentStep = 0;
	nearMissProgress = 0;
	nearMissPlaying = true;
	document.getElementById('nearMissPlayPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
	buildNearMissScenes();
	playNearMissVideo();
}

function playNearMissVideo() {
	if (nearMissInterval) clearInterval(nearMissInterval);
	
	let elapsed = 0;
	let sceneStart = 0;
	
	// Calculate starting point based on current step
	for (let i = 0; i < nearMissCurrentStep; i++) {
		sceneStart += nearMissScenes[i].duration;
	}
	elapsed = sceneStart;
	
	updateNearMissScene(nearMissCurrentStep);
	
	nearMissInterval = setInterval(() => {
		if (!nearMissPlaying) return;
		
		elapsed += 100;
		nearMissProgress = (elapsed / nearMissTotalDuration) * 100;
		document.getElementById('nearMissProgressBar').style.width = nearMissProgress + '%';
		
		const mins = Math.floor(elapsed / 60000);
		const secs = Math.floor((elapsed % 60000) / 1000);
		const totalMins = Math.floor(nearMissTotalDuration / 60000);
		const totalSecs = Math.floor((nearMissTotalDuration % 60000) / 1000);
		document.getElementById('nearMissVideoTime').textContent = `${mins}:${secs.toString().padStart(2,'0')} / ${totalMins}:${totalSecs.toString().padStart(2,'0')}`;
		
		// Check if we should move to next scene
		let cumulative = 0;
		for (let i = 0; i < nearMissScenes.length; i++) {
			cumulative += nearMissScenes[i].duration;
			if (elapsed < cumulative) {
				if (i !== nearMissCurrentStep) {
					nearMissCurrentStep = i;
					updateNearMissScene(i);
				}
				break;
			}
		}
		
		if (elapsed >= nearMissTotalDuration) {
			clearInterval(nearMissInterval);
			nearMissPlaying = false;
			document.getElementById('nearMissPlayPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
		}
	}, 100);
}

function updateNearMissScene(stepIndex) {
	const scene = nearMissScenes[stepIndex];
	document.getElementById('nearMissDemoCaptionText').innerHTML = scene.caption;
	
	// Auto-scroll the form container
	if (scene.scrollTo !== undefined) {
		setTimeout(() => {
			const scrollEl = document.getElementById('nmFormScroll');
			if (scrollEl) {
				const maxScroll = scrollEl.scrollHeight - scrollEl.clientHeight;
				const targetScroll = (scene.scrollTo / 100) * maxScroll;
				scrollEl.scrollTo({ top: targetScroll, behavior: 'smooth' });
			}
		}, 100);
	}
	
	// Get all form field elements
	const title = document.getElementById('nmTitle');
	const severity = document.getElementById('nmSeverity');
	const date = document.getElementById('nmDate');
	const status = document.getElementById('nmStatus');
	const location = document.getElementById('nmLocation');
	const department = document.getElementById('nmDepartment');
	const assigned = document.getElementById('nmAssigned');
	const reportedBy = document.getElementById('nmReportedBy');
	const dateReported = document.getElementById('nmDateReported');
	const description = document.getElementById('nmDescription');
	const actions = document.getElementById('nmActions');
	const correctiveActions = document.getElementById('nmCorrectiveActions');
	const addActionBtn = document.getElementById('nmAddAction');
	const dueDate = document.getElementById('nmDueDate');
	const attachmentsSection = document.getElementById('nmAttachmentsSection');
	const uploadBtn = document.getElementById('nmUploadBtn');
	const fileList = document.getElementById('nmFileList');
	const submitBtn = document.getElementById('nmSubmitBtn');
	const success = document.getElementById('nmSuccessMsg');
	
	// All highlightable elements
	const allFields = [title, severity, date, status, location, department, assigned, reportedBy, dateReported, description, actions, addActionBtn, dueDate, uploadBtn, submitBtn];
	
	// Reset all highlights
	allFields.forEach(el => {
		if (el) {
			el.style.boxShadow = 'none';
			el.style.transition = 'all 0.3s ease';
		}
	});
	
	// Hide success message unless final step (step 19 = success)
	if (success) {
		success.style.display = (stepIndex >= 19) ? 'flex' : 'none';
	}
	
	// Apply highlighting and fill fields progressively
	// Step 0: Welcome - just show the form
	
	// Step 1: Highlight Title field
	if (stepIndex >= 1 && title) {
		title.style.boxShadow = stepIndex === 1 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		title.style.borderColor = '#22c55e';
		title.style.color = '#1f2937';
		title.style.background = '#f0fdf4';
		title.textContent = 'Forklift near collision in Warehouse B';
	}
	
	// Step 2: Highlight Severity field
	if (stepIndex >= 2 && severity) {
		severity.style.boxShadow = stepIndex === 2 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		severity.style.borderColor = '#22c55e';
		severity.style.color = '#1f2937';
		severity.style.background = '#f0fdf4';
		severity.textContent = 'Medium';
	}
	
	// Step 3: Highlight Date field
	if (stepIndex >= 3 && date) {
		date.style.boxShadow = stepIndex === 3 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		date.style.borderColor = '#22c55e';
		date.style.color = '#1f2937';
		date.style.background = '#f0fdf4';
		date.textContent = '2024-12-17 10:30';
	}
	
	// Step 4: Show Status as highlighted (already Open)
	if (stepIndex >= 4 && status) {
		status.style.boxShadow = stepIndex === 4 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		status.style.borderColor = '#22c55e';
		status.style.background = '#f0fdf4';
	}
	
	// Step 5: Highlight Location field
	if (stepIndex >= 5 && location) {
		location.style.boxShadow = stepIndex === 5 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		location.style.borderColor = '#22c55e';
		location.style.color = '#1f2937';
		location.style.background = '#f0fdf4';
		location.textContent = 'Warehouse B - Aisle 3';
	}
	
	// Step 6: Highlight Department field
	if (stepIndex >= 6 && department) {
		department.style.boxShadow = stepIndex === 6 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		department.style.borderColor = '#22c55e';
		department.style.color = '#1f2937';
		department.style.background = '#f0fdf4';
		department.textContent = 'Operations';
	}
	
	// Step 7: Highlight Assigned To field
	if (stepIndex >= 7 && assigned) {
		assigned.style.boxShadow = stepIndex === 7 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		assigned.style.borderColor = '#22c55e';
		assigned.style.color = '#1f2937';
		assigned.style.background = '#f0fdf4';
		assigned.textContent = 'Mike Wilson (Safety Officer)';
	}
	
	// Step 8: Highlight Reported By and Date Reported fields (auto-filled)
	if (stepIndex >= 8) {
		if (reportedBy) {
			reportedBy.style.boxShadow = stepIndex === 8 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		}
		if (dateReported) {
			dateReported.style.boxShadow = stepIndex === 8 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		}
	}
	
	// Step 9: Highlight Description field
	if (stepIndex >= 9 && description) {
		description.style.boxShadow = stepIndex === 9 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		description.style.borderColor = '#22c55e';
		description.style.color = '#1f2937';
		description.style.background = '#f0fdf4';
		description.textContent = 'Forklift operator nearly collided with pedestrian while reversing in aisle 3. No contact made but potential for serious injury. Pedestrian was not in designated walkway.';
	}
	
	// Step 10: Highlight Immediate Actions field
	if (stepIndex >= 10 && actions) {
		actions.style.boxShadow = stepIndex === 10 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		actions.style.borderColor = '#22c55e';
		actions.style.color = '#1f2937';
		actions.style.background = '#f0fdf4';
		actions.textContent = 'Area cordoned off. Verbal warning given to operator. Pedestrian traffic rerouted through designated walkway.';
	}
	
	// Step 11: Click Add Action button
	if (stepIndex >= 11 && addActionBtn) {
		addActionBtn.style.boxShadow = stepIndex === 11 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		if (stepIndex === 11) {
			addActionBtn.style.background = '#fbbf24';
		}
	}
	
	// Step 12-15: Show corrective action form being filled (matching original incident.html layout)
	if (stepIndex >= 12 && correctiveActions) {
		let actionFormHTML = '<div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; text-align:left;">';
		
		// Action Header
		actionFormHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">';
		actionFormHTML += '<span style="font-weight:600; color:#2c3e50; font-size:0.5rem;">Action #1</span>';
		actionFormHTML += '<button type="button" style="background:#e74c3c; color:#fff; border:none; padding:0.1rem 0.25rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-trash"></i> Remove</button>';
		actionFormHTML += '</div>';
		
		// Row 1: Description (full width) - matches incident.html form-row with flex:1 1 100%
		actionFormHTML += '<div style="margin-bottom:0.3rem;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.45rem; font-weight:600; color:#374151;">Description *</label>';
		const descHighlight = stepIndex === 12 ? 'box-shadow:0 0 0 2px rgba(251,191,36,0.6);' : '';
		const descFilled = stepIndex >= 13 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const descText = stepIndex >= 13 ? 'Install additional warning signs and floor markings in Warehouse B aisles' : 'Describe the corrective action...';
		actionFormHTML += '<div style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.45rem; min-height:1.2rem; ' + descHighlight + descFilled + '">' + descText + '</div>';
		actionFormHTML += '</div>';
		
		// Row 2: Responsible Person | Due Date | Status (3 columns side by side)
		actionFormHTML += '<div style="display:flex; gap:0.3rem; flex-wrap:wrap;">';
		
		// Responsible Person
		actionFormHTML += '<div style="flex:1 1 30%;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.45rem; font-weight:600; color:#374151;">Responsible Person *</label>';
		const personHighlight = stepIndex === 13 ? 'box-shadow:0 0 0 2px rgba(251,191,36,0.6);' : '';
		const personFilled = stepIndex >= 14 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const personText = stepIndex >= 14 ? 'John Smith' : 'Type to search...';
		actionFormHTML += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:4px; font-size:0.45rem; ' + personHighlight + personFilled + '">' + personText + '</div>';
		actionFormHTML += '</div>';
		
		// Due Date
		actionFormHTML += '<div style="flex:1 1 30%;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.45rem; font-weight:600; color:#374151;">Due Date *</label>';
		const dueDateHighlight = stepIndex === 14 ? 'box-shadow:0 0 0 2px rgba(251,191,36,0.6);' : '';
		const dueDateFilled = stepIndex >= 15 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const dueDateText = stepIndex >= 15 ? '2024-12-24' : 'Select date...';
		actionFormHTML += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:4px; font-size:0.45rem; ' + dueDateHighlight + dueDateFilled + '">' + dueDateText + '</div>';
		actionFormHTML += '</div>';
		
		// Status
		actionFormHTML += '<div style="flex:1 1 30%;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.45rem; font-weight:600; color:#374151;">Status *</label>';
		const statusFilled = stepIndex >= 15 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const statusText = stepIndex >= 15 ? 'Pending' : 'Select Status...';
		actionFormHTML += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:4px; font-size:0.45rem; ' + statusFilled + '">' + statusText + '</div>';
		actionFormHTML += '</div>';
		
		actionFormHTML += '</div>'; // Close row 2
		
		// Action Saved indicator
		if (stepIndex === 15) {
			actionFormHTML += '<div style="text-align:center; padding:0.2rem; background:#dcfce7; border-radius:3px; margin-top:0.25rem;"><i class="fas fa-check" style="color:#22c55e;"></i> <span style="font-size:0.45rem; color:#166534; font-weight:600;">Action Saved!</span></div>';
		}
		
		actionFormHTML += '</div>'; // Close action item container
		
		// Show saved action card after step 15
		if (stepIndex >= 16) {
			actionFormHTML = '<div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:0.4rem; text-align:left;">';
			actionFormHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.2rem;">';
			actionFormHTML += '<span style="font-weight:600; color:#2c3e50; font-size:0.5rem;">Action #1</span>';
			actionFormHTML += '<span style="background:#fef9c3; color:#854d0e; padding:1px 6px; border-radius:9999px; font-size:0.4rem; font-weight:600;">PENDING</span>';
			actionFormHTML += '</div>';
			actionFormHTML += '<div style="font-size:0.45rem; color:#1f2937; margin-bottom:0.15rem;">Install additional warning signs and floor markings in Warehouse B aisles</div>';
			actionFormHTML += '<div style="display:flex; gap:0.5rem; font-size:0.4rem; color:#6b7280;">';
			actionFormHTML += '<span><i class="fas fa-user"></i> John Smith</span>';
			actionFormHTML += '<span><i class="fas fa-calendar"></i> 2024-12-24</span>';
			actionFormHTML += '</div>';
			actionFormHTML += '</div>';
		}
		
		correctiveActions.innerHTML = actionFormHTML;
	}
	
	// Step 16: Highlight Due Date field
	if (stepIndex >= 16 && dueDate) {
		dueDate.style.boxShadow = stepIndex === 16 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		dueDate.style.borderColor = '#22c55e';
		dueDate.style.color = '#1f2937';
		dueDate.style.background = '#f0fdf4';
		dueDate.textContent = '2024-12-24';
	}
	
	// Step 17: Highlight Attachments section
	if (stepIndex >= 17) {
		if (uploadBtn) {
			uploadBtn.style.boxShadow = stepIndex === 17 ? '0 0 0 3px rgba(251,191,36,0.6)' : 'none';
		}
		if (fileList) {
			fileList.innerHTML = '<div style="display:flex; align-items:center; gap:0.3rem; background:#f9f9f9; border:1px solid #eee; border-radius:4px; padding:0.2rem 0.3rem; font-size:0.45rem;"><i class="fas fa-image" style="color:#3b82f6;"></i> warehouse_aisle3_photo.jpg <span style="color:#666;">(1.2 MB)</span></div>';
		}
	}
	
	// Step 18: Highlight Submit button
	if (stepIndex === 18 && submitBtn) {
		submitBtn.style.boxShadow = '0 0 0 3px rgba(251,191,36,0.6)';
		submitBtn.style.background = '#22c55e';
	}
}

function toggleNearMissPlayPause() {
	nearMissPlaying = !nearMissPlaying;
	document.getElementById('nearMissPlayPauseBtn').innerHTML = nearMissPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
	if (nearMissPlaying) playNearMissVideo();
}

function seekNearMissVideo(event) {
	const progressBar = event.currentTarget;
	const rect = progressBar.getBoundingClientRect();
	const percent = (event.clientX - rect.left) / rect.width;
	
	let cumulative = 0;
	for (let i = 0; i < nearMissScenes.length; i++) {
		cumulative += nearMissScenes[i].duration;
		if (percent * nearMissTotalDuration < cumulative) {
			nearMissCurrentStep = i;
			break;
		}
	}
	
	nearMissProgress = percent * 100;
	document.getElementById('nearMissProgressBar').style.width = nearMissProgress + '%';
	buildNearMissScenes();
	updateNearMissScene(nearMissCurrentStep);
	if (nearMissPlaying) playNearMissVideo();
}

// ========== OBSERVATION DEMO VIDEO ==========
let observationPlaying = false;
let observationCurrentStep = 0;
let observationInterval = null;

const observationScenes = [
	{ id: 'welcome', caption: '<strong>Welcome!</strong> This is the <span style="color:#3b82f6;">Observation</span> reporting form from incident.html', duration: 2500, scrollTo: 0 },
	{ id: 'fill-title', caption: '<strong>Step 1:</strong> Enter a descriptive <span style="color:#3b82f6;">Title</span> for the observation', duration: 2500, scrollTo: 0 },
	{ id: 'fill-severity', caption: '<strong>Step 2:</strong> Select the <span style="color:#3b82f6;">Severity</span> level', duration: 2500, scrollTo: 5 },
	{ id: 'fill-date', caption: '<strong>Step 3:</strong> Select the <span style="color:#3b82f6;">Date & Time</span>', duration: 2500, scrollTo: 10 },
	{ id: 'fill-status', caption: '<strong>Step 4:</strong> Status is <span style="color:#3b82f6;">Open</span> by default', duration: 2000, scrollTo: 15 },
	{ id: 'fill-location', caption: '<strong>Step 5:</strong> Choose the <span style="color:#3b82f6;">Location</span> observed', duration: 2500, scrollTo: 18 },
	{ id: 'fill-department', caption: '<strong>Step 6:</strong> Select the <span style="color:#3b82f6;">Department</span>', duration: 2500, scrollTo: 22 },
	{ id: 'fill-assigned', caption: '<strong>Step 7:</strong> Search and select <span style="color:#3b82f6;">Assigned To</span> employee', duration: 2500, scrollTo: 28 },
	{ id: 'fill-reported', caption: '<strong>Step 8:</strong> <span style="color:#3b82f6;">Reported By</span> and <span style="color:#3b82f6;">Date Reported</span> are auto-filled', duration: 2500, scrollTo: 32 },
	{ id: 'fill-description', caption: '<strong>Step 9:</strong> Describe what you <span style="color:#3b82f6;">observed</span> in detail', duration: 3000, scrollTo: 42 },
	{ id: 'fill-obs-type', caption: '<strong>Step 10:</strong> Select <span style="color:#3b82f6;">Observation Type</span> (Safe or At-Risk)', duration: 2500, scrollTo: 50 },
	{ id: 'fill-category', caption: '<strong>Step 11:</strong> Choose the <span style="color:#3b82f6;">Category</span> (Behavior/Condition)', duration: 2500, scrollTo: 55 },
	// Person Involved detailed steps
	{ id: 'check-person', caption: '<strong>Step 12:</strong> Check <span style="color:#3b82f6;">Person Involved</span> checkbox', duration: 2000, scrollTo: 58 },
	{ id: 'fill-person-name', caption: '<strong>Step 13:</strong> Enter <span style="color:#3b82f6;">Person Name</span>', duration: 2500, scrollTo: 60 },
	{ id: 'fill-person-role', caption: '<strong>Step 14:</strong> Enter <span style="color:#3b82f6;">Role/Position</span> and <span style="color:#3b82f6;">Involvement Type</span>', duration: 2500, scrollTo: 62 },
	{ id: 'fill-person-notes', caption: '<strong>Step 15:</strong> Add <span style="color:#3b82f6;">Notes</span> about person involvement', duration: 2500, scrollTo: 64 },
	// Equipment Involved detailed steps
	{ id: 'check-equipment', caption: '<strong>Step 16:</strong> Check <span style="color:#3b82f6;">Equipment Involved</span> checkbox', duration: 2000, scrollTo: 66 },
	{ id: 'fill-equip-name', caption: '<strong>Step 17:</strong> Enter <span style="color:#3b82f6;">Equipment Name/ID</span>', duration: 2500, scrollTo: 68 },
	{ id: 'fill-equip-type', caption: '<strong>Step 18:</strong> Select <span style="color:#3b82f6;">Equipment Type</span> and <span style="color:#3b82f6;">Condition</span>', duration: 2500, scrollTo: 70 },
	{ id: 'fill-equip-notes', caption: '<strong>Step 19:</strong> Add <span style="color:#3b82f6;">Notes</span> about equipment', duration: 2500, scrollTo: 72 },
	// Corrective Action detailed steps
	{ id: 'click-add-action', caption: '<strong>Step 20:</strong> Click <span style="color:#3b82f6;">Add Corrective Action</span> button', duration: 2000, scrollTo: 75 },
	{ id: 'fill-action-desc', caption: '<strong>Step 21:</strong> Enter the <span style="color:#3b82f6;">Action Description</span>', duration: 2500, scrollTo: 77 },
	{ id: 'fill-action-person', caption: '<strong>Step 22:</strong> Assign a <span style="color:#3b82f6;">Responsible Person</span>', duration: 2500, scrollTo: 79 },
	{ id: 'fill-action-due', caption: '<strong>Step 23:</strong> Set the <span style="color:#3b82f6;">Due Date</span> and <span style="color:#3b82f6;">Status</span>', duration: 2500, scrollTo: 81 },
	{ id: 'save-action', caption: '<strong>Step 24:</strong> <span style="color:#22c55e;">Corrective Action Saved!</span>', duration: 2000, scrollTo: 83 },
	{ id: 'fill-attachments', caption: '<strong>Step 25:</strong> Upload any <span style="color:#3b82f6;">Attachments</span> (photos, documents)', duration: 2500, scrollTo: 90 },
	{ id: 'submit', caption: '<strong>Step 26:</strong> Click <span style="color:#3b82f6;">Submit Incident</span> to save', duration: 2500, scrollTo: 100 },
	{ id: 'success', caption: '<strong>Done!</strong> Observation reported! <span style="color:#22c55e;">Reference: OBS-2024-0042</span>', duration: 3000, scrollTo: 100 }
];

const observationTotalDuration = observationScenes.reduce((sum, s) => sum + s.duration, 0);

function openObservationDemo() {
	document.getElementById('observationDemoOverlay').classList.add('active');
	buildObservationScenes();
	restartObservationVideo();
}

function closeObservationDemo() {
	document.getElementById('observationDemoOverlay').classList.remove('active');
	if (observationInterval) clearInterval(observationInterval);
	observationPlaying = false;
}

function buildObservationScenes() {
	const container = document.getElementById('observationDemoSceneContainer');
	if (!container) return;
	container.innerHTML = generateObservationSceneHTML();
}

function generateObservationSceneHTML() {
	// Displays the exact incident.html form page for Observation reporting
	return `
		<div style="width:100%; height:100%; display:flex; font-family:Inter,system-ui,sans-serif; font-size:14px;">
			<!-- Sidebar (250px like incident.html) -->
			<div style="width:120px; background:#2c3e50; color:#fff; flex-shrink:0; overflow-y:auto;">
				<div style="text-align:center; padding:0.5rem; border-bottom:1px solid rgba(255,255,255,0.1);">
					<h2 style="font-size:0.6rem; margin:0;">Dreamex Datalab</h2>
				</div>
				<ul style="list-style:none; margin:0.5rem 0; padding:0; font-size:0.55rem;">
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-home"></i> Home</a></li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-medkit"></i> Health</a></li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-exclamation-triangle"></i> Risk Management</a></li>
					<li>
						<a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; background:#3498db; border-radius:4px;"><i class="fas fa-shield-alt"></i> Safety</a>
						<ul style="list-style:none; margin-left:0.5rem; padding:0; font-size:0.5rem;">
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; opacity:0.7;">Training</a></li>
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; opacity:0.7;">Job Safety Analysis</a></li>
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; opacity:0.7;">Permit to Work</a></li>
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; background:rgba(255,255,255,0.15); border-radius:3px;">Incident Reports</a></li>
						</ul>
					</li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-search-plus"></i> Investigation</a></li>
				</ul>
			</div>
			<!-- Main Content Area -->
			<div style="flex:1; display:flex; flex-direction:column; background:#f8f9fa; overflow:hidden;">
				<!-- Top Nav -->
				<header style="display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0.5rem; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:sticky; top:0; z-index:20;">
					<div style="display:flex; align-items:center; gap:0.4rem;">
						<button style="background:none; border:none; font-size:0.7rem; color:#666; padding:0.2rem;"><i class="fas fa-bars"></i></button>
						<div style="width:20px; height:20px; background:#3b82f6; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.5rem; font-weight:600;">DX</div>
						<span style="font-weight:600; color:#2c3e50; font-size:0.6rem;">Company Name</span>
					</div>
					<div style="display:flex; align-items:center; gap:0.5rem;">
						<button style="background:none; border:none; font-size:0.7rem; color:#555; position:relative;"><i class="fas fa-bell"></i></button>
						<div style="width:20px; height:20px; background:#64748b; border-radius:50%; overflow:hidden;"></div>
					</div>
				</header>
				<!-- Page Header -->
				<div style="background:#fff; color:#2c3e50; padding:0.5rem; margin:0.4rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); border:1px solid #e0e0e0;">
					<h1 style="margin:0; font-size:0.8rem; display:flex; align-items:center; gap:0.4rem;"><i class="fas fa-exclamation-triangle"></i> Report Incident</h1>
					<a href="#" style="background:#2c3e50; color:#fff; border:none; padding:0.3rem 0.5rem; border-radius:4px; font-size:0.55rem; text-decoration:none;"><i class="fas fa-table-list"></i></a>
				</div>
				<!-- Form Content (scrollable) -->
				<div id="obsFormScroll" style="flex:1; overflow-y:auto; padding:0 0.4rem 0.4rem;">
					<form style="font-size:0.6rem;">
						<!-- Basic Information Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Basic Information</h3>
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem;">
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Reference</label>
									<input id="obsReference" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa;" placeholder="Auto-generated" readonly value="OBS-2024-0042"/>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Title *</label>
									<div id="obsTitle" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af; min-height:1.2rem;">Brief title...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Severity *</label>
									<div id="obsSeverity" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Severity</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Event Type</label>
									<div id="obsEventType" style="width:100%; padding:0.3rem; border:1px solid #3b82f6; border-radius:4px; font-size:0.55rem; background:#eff6ff; color:#2563eb; font-weight:600;">Observation</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Date & Time *</label>
									<div id="obsDate" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select date...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Status</label>
									<div id="obsStatus" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#374151;">Open</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Location *</label>
									<div id="obsLocation" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Location</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Department *</label>
									<div id="obsDepartment" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Department</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Assigned To</label>
									<div id="obsAssignedTo" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Search employee...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Reported By</label>
									<div id="obsReportedBy" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#374151;">John Doe</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Date Reported</label>
									<div id="obsDateReported" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#374151;">2024-12-17</div>
								</div>
							</div>
						</div>
						<!-- Event-specific Details Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Event-specific Details</h3>
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Description *</label>
								<div id="obsDescription" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:2rem; color:#9ca3af;">Describe what you observed...</div>
							</div>
							<!-- Observation-specific fields -->
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.4rem; padding:0.4rem; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0;">
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem; color:#3b82f6;">Observation Type *</label>
									<div id="obsObsType" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select (Safe/At-Risk)</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem; color:#3b82f6;">Category *</label>
									<div id="obsCategory" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select (Behavior/Condition)</div>
								</div>
							</div>
							<!-- Person Involved Checkbox Toggle -->
							<div style="margin-bottom:0.4rem;">
								<div style="display:flex; align-items:center; gap:0.3rem; margin-bottom:0.3rem;">
									<input type="checkbox" id="obsPersonToggle" style="width:14px; height:14px; accent-color:#3b82f6;"/>
									<label style="font-weight:600; font-size:0.55rem; color:#374151;">Person Involved</label>
								</div>
								<div id="obsPersonList" style="display:none; padding:0.4rem; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0;">
									<div id="obsPersonsContainer" style="color:#666; font-style:italic; font-size:0.5rem; margin-bottom:0.3rem;">No persons added. Click "Add Person" to add one.</div>
									<button id="obsAddPersonBtn" type="button" style="background:#2c3e50; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.45rem;"><i class="fas fa-plus"></i> Add Person</button>
								</div>
							</div>
							<!-- Equipment Involved Checkbox Toggle -->
							<div style="margin-bottom:0.4rem;">
								<div style="display:flex; align-items:center; gap:0.3rem; margin-bottom:0.3rem;">
									<input type="checkbox" id="obsEquipmentToggle" style="width:14px; height:14px; accent-color:#3b82f6;"/>
									<label style="font-weight:600; font-size:0.55rem; color:#374151;">Equipment Involved</label>
								</div>
								<div id="obsEquipmentList" style="display:none; padding:0.4rem; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0;">
									<div id="obsEquipmentContainer" style="color:#666; font-style:italic; font-size:0.5rem; margin-bottom:0.3rem;">No equipment added. Click "Add Equipment" to add one.</div>
									<button id="obsAddEquipmentBtn" type="button" style="background:#2c3e50; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.45rem;"><i class="fas fa-plus"></i> Add Equipment</button>
								</div>
							</div>
							<!-- Corrective Actions -->
							<div style="margin-bottom:0.4rem;">
								<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">
									<label style="font-weight:600; font-size:0.55rem;">Corrective Actions</label>
									<button id="obsAddActionBtn" type="button" style="background:#2c3e50; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.5rem;"><i class="fas fa-plus"></i> Add</button>
								</div>
								<div id="obsCorrectiveActions" style="color:#666; text-align:center; padding:0.5rem; font-size:0.55rem;">No corrective actions added.</div>
							</div>
						</div>
						<!-- Attachments Section -->
						<div id="obsAttachmentsSection" style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Attachments</h3>
							<label id="obsUploadBtn" style="display:inline-flex; align-items:center; gap:0.2rem; background:#6c757d; color:#fff; padding:0.25rem 0.5rem; border-radius:4px; font-size:0.5rem; cursor:pointer;">
								<i class="fas fa-upload"></i> Choose Files
							</label>
							<small style="margin-left:0.3rem; color:#666; font-size:0.45rem;">Max 5MB each</small>
							<div id="obsFileList" style="margin-top:0.3rem;"></div>
						</div>
						<!-- Action Buttons -->
						<div style="display:flex; gap:0.3rem; justify-content:flex-end; padding:0.3rem 0;">
							<button type="button" style="padding:0.3rem 0.6rem; background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:0.55rem;">Cancel</button>
							<button type="button" style="padding:0.3rem 0.6rem; background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:0.55rem;">Save Draft</button>
							<button id="obsSubmitBtn" type="button" style="padding:0.3rem 0.6rem; background:#2c3e50; color:#fff; border:none; border-radius:4px; font-size:0.55rem; font-weight:600;">Submit Incident</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Success Message Overlay -->
		<div id="obsSuccessMsg" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100; display:flex; align-items:center; justify-content:center;">
			<div style="background:#fff; width:85%; max-width:280px; border-radius:8px; padding:1rem; text-align:center;">
				<div style="width:40px; height:40px; background:#dcfce7; border-radius:50%; margin:0 auto 0.5rem; display:flex; align-items:center; justify-content:center;">
					<i class="fas fa-check" style="font-size:1.2rem; color:#22c55e;"></i>
				</div>
				<h3 style="color:#1f2937; margin:0 0 0.2rem; font-size:0.8rem;">Observation Reported!</h3>
				<p style="color:#6b7280; font-size:0.65rem; margin:0;">Reference: <strong style="color:#3b82f6;">OBS-2024-0042</strong></p>
				<div style="margin-top:0.5rem; padding:0.3rem; background:#dbeafe; border-radius:4px; border-left:3px solid #3b82f6;">
					<p style="margin:0; font-size:0.55rem; color:#1e40af;"><i class="fas fa-info-circle"></i> Your observation has been submitted successfully!</p>
				</div>
			</div>
		</div>
	`;
}

function restartObservationVideo() {
	observationCurrentStep = 0;
	observationPlaying = true;
	document.getElementById('observationPlayPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
	buildObservationScenes();
	playObservationVideo();
}

function playObservationVideo() {
	if (observationInterval) clearInterval(observationInterval);
	
	let elapsed = 0;
	for (let i = 0; i < observationCurrentStep; i++) elapsed += observationScenes[i].duration;
	
	updateObservationScene(observationCurrentStep);
	
	observationInterval = setInterval(() => {
		if (!observationPlaying) return;
		
		elapsed += 100;
		const progress = (elapsed / observationTotalDuration) * 100;
		document.getElementById('observationProgressBar').style.width = progress + '%';
		
		const mins = Math.floor(elapsed / 60000);
		const secs = Math.floor((elapsed % 60000) / 1000);
		const totalMins = Math.floor(observationTotalDuration / 60000);
		const totalSecs = Math.floor((observationTotalDuration % 60000) / 1000);
		document.getElementById('observationVideoTime').textContent = `${mins}:${secs.toString().padStart(2,'0')} / ${totalMins}:${totalSecs.toString().padStart(2,'0')}`;
		
		let cumulative = 0;
		for (let i = 0; i < observationScenes.length; i++) {
			cumulative += observationScenes[i].duration;
			if (elapsed < cumulative) {
				if (i !== observationCurrentStep) {
					observationCurrentStep = i;
					updateObservationScene(i);
				}
				break;
			}
		}
		
		if (elapsed >= observationTotalDuration) {
			clearInterval(observationInterval);
			observationPlaying = false;
			document.getElementById('observationPlayPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
		}
	}, 100);
}

function updateObservationScene(stepIndex) {
	const scene = observationScenes[stepIndex];
	document.getElementById('observationDemoCaptionText').innerHTML = scene.caption;
	
	// Handle scroll
	const scrollEl = document.getElementById('obsFormScroll');
	if (scene.scrollTo !== undefined && scrollEl) {
		const maxScroll = scrollEl.scrollHeight - scrollEl.clientHeight;
		const targetScroll = (scene.scrollTo / 100) * maxScroll;
		scrollEl.scrollTo({ top: targetScroll, behavior: 'smooth' });
	}
	
	// Get all form field elements
	const reference = document.getElementById('obsReference');
	const title = document.getElementById('obsTitle');
	const severity = document.getElementById('obsSeverity');
	const eventType = document.getElementById('obsEventType');
	const date = document.getElementById('obsDate');
	const status = document.getElementById('obsStatus');
	const location = document.getElementById('obsLocation');
	const department = document.getElementById('obsDepartment');
	const assignedTo = document.getElementById('obsAssignedTo');
	const reportedBy = document.getElementById('obsReportedBy');
	const dateReported = document.getElementById('obsDateReported');
	const description = document.getElementById('obsDescription');
	const obsType = document.getElementById('obsObsType');
	const category = document.getElementById('obsCategory');
	const personToggle = document.getElementById('obsPersonToggle');
	const personList = document.getElementById('obsPersonList');
	const equipToggle = document.getElementById('obsEquipmentToggle');
	const equipList = document.getElementById('obsEquipmentList');
	const addActionBtn = document.getElementById('obsAddActionBtn');
	const correctiveActions = document.getElementById('obsCorrectiveActions');
	const uploadBtn = document.getElementById('obsUploadBtn');
	const fileList = document.getElementById('obsFileList');
	const submitBtn = document.getElementById('obsSubmitBtn');
	const success = document.getElementById('obsSuccessMsg');
	
	// All highlightable elements
	const allFields = [reference, title, severity, eventType, date, status, location, department, assignedTo, reportedBy, dateReported, description, obsType, category, personToggle, equipToggle, addActionBtn, uploadBtn, submitBtn];
	
	// Reset all highlights
	allFields.forEach(el => {
		if (el) {
			el.style.boxShadow = 'none';
			el.style.transition = 'all 0.3s ease';
		}
	});
	
	// Hide success message unless final step (step 27 = success)
	if (success) {
		success.style.display = (stepIndex >= 27) ? 'flex' : 'none';
	}
	
	// Step 1: Fill Title
	if (stepIndex >= 1 && title) {
		title.style.boxShadow = stepIndex === 1 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		title.style.borderColor = '#22c55e';
		title.style.color = '#1f2937';
		title.style.background = '#f0fdf4';
		title.textContent = 'Worker not wearing safety glasses';
	}
	
	// Step 2: Fill Severity
	if (stepIndex >= 2 && severity) {
		severity.style.boxShadow = stepIndex === 2 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		severity.style.borderColor = '#22c55e';
		severity.style.color = '#1f2937';
		severity.style.background = '#f0fdf4';
		severity.textContent = 'Low';
	}
	
	// Step 3: Fill Date & Time
	if (stepIndex >= 3 && date) {
		date.style.boxShadow = stepIndex === 3 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		date.style.borderColor = '#22c55e';
		date.style.color = '#1f2937';
		date.style.background = '#f0fdf4';
		date.textContent = '2024-12-17 14:15';
	}
	
	// Step 4: Status (Open by default)
	if (stepIndex >= 4 && status) {
		status.style.boxShadow = stepIndex === 4 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		status.style.borderColor = '#22c55e';
		status.style.color = '#1f2937';
		status.style.background = '#f0fdf4';
	}
	
	// Step 5: Fill Location
	if (stepIndex >= 5 && location) {
		location.style.boxShadow = stepIndex === 5 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		location.style.borderColor = '#22c55e';
		location.style.color = '#1f2937';
		location.style.background = '#f0fdf4';
		location.textContent = 'Workshop Area A';
	}
	
	// Step 6: Fill Department
	if (stepIndex >= 6 && department) {
		department.style.boxShadow = stepIndex === 6 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		department.style.borderColor = '#22c55e';
		department.style.color = '#1f2937';
		department.style.background = '#f0fdf4';
		department.textContent = 'Maintenance';
	}
	
	// Step 7: Fill Assigned To
	if (stepIndex >= 7 && assignedTo) {
		assignedTo.style.boxShadow = stepIndex === 7 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		assignedTo.style.borderColor = '#22c55e';
		assignedTo.style.color = '#1f2937';
		assignedTo.style.background = '#f0fdf4';
		assignedTo.textContent = 'Safety Officer - James Wilson';
	}
	
	// Step 8: Reported By and Date Reported (auto-filled)
	if (stepIndex >= 8) {
		if (reportedBy) {
			reportedBy.style.boxShadow = stepIndex === 8 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		}
		if (dateReported) {
			dateReported.style.boxShadow = stepIndex === 8 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		}
	}
	
	// Step 9: Fill Description
	if (stepIndex >= 9 && description) {
		description.style.boxShadow = stepIndex === 9 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		description.style.borderColor = '#22c55e';
		description.style.color = '#1f2937';
		description.style.background = '#f0fdf4';
		description.textContent = 'Observed worker operating grinding equipment without required safety glasses. Stopped work and reminded about PPE requirements.';
	}
	
	// Step 10: Fill Observation Type
	if (stepIndex >= 10 && obsType) {
		obsType.style.boxShadow = stepIndex === 10 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		obsType.style.borderColor = '#22c55e';
		obsType.style.color = '#dc2626';
		obsType.style.background = '#fef2f2';
		obsType.textContent = 'At-Risk';
	}
	
	// Step 11: Fill Category
	if (stepIndex >= 11 && category) {
		category.style.boxShadow = stepIndex === 11 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		category.style.borderColor = '#22c55e';
		category.style.color = '#1f2937';
		category.style.background = '#f0fdf4';
		category.textContent = 'Behavior';
	}
	
	// Steps 12-15: Person Involved - detailed field filling
	if (stepIndex >= 12 && personToggle && personList) {
		personToggle.checked = true;
		personToggle.style.boxShadow = stepIndex === 12 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		personList.style.display = 'block';
		const personsContainer = document.getElementById('obsPersonsContainer');
		if (personsContainer) {
			let personHTML = '<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.4rem; margin-bottom:0.3rem;">';
			// Header
			personHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">';
			personHTML += '<span style="font-weight:600; color:#2c3e50; font-size:0.5rem;">Person #1</span>';
			personHTML += '<button type="button" style="background:#e74c3c; color:#fff; border:none; padding:0.1rem 0.25rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-trash"></i> Remove</button>';
			personHTML += '</div>';
			// Row 1: Person Name | Role/Position | Involvement Type
			personHTML += '<div style="display:flex; gap:0.25rem; flex-wrap:wrap; margin-bottom:0.2rem;">';
			// Person Name
			const nameHighlight = stepIndex === 13 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const nameFilled = stepIndex >= 14 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const nameText = stepIndex >= 14 ? 'Michael Thompson' : 'Name of person involved...';
			personHTML += '<div style="flex:1 1 30%;"><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Person Name *</label>';
			personHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; ' + nameHighlight + nameFilled + '">' + nameText + '</div></div>';
			// Role/Position
			const roleHighlight = stepIndex === 14 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const roleFilled = stepIndex >= 15 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const roleText = stepIndex >= 15 ? 'Maintenance Technician' : 'Their role or position...';
			personHTML += '<div style="flex:1 1 30%;"><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Role/Position</label>';
			personHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; ' + roleHighlight + roleFilled + '">' + roleText + '</div></div>';
			// Involvement Type
			const invHighlight = stepIndex === 14 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const invFilled = stepIndex >= 15 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const invText = stepIndex >= 15 ? 'Directly Involved' : 'Select...';
			personHTML += '<div style="flex:1 1 30%;"><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Involvement Type</label>';
			personHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; ' + invHighlight + invFilled + '">' + invText + '</div></div>';
			personHTML += '</div>';
			// Row 2: Notes (full width)
			const notesHighlight = stepIndex === 15 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const notesFilled = stepIndex >= 16 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const notesText = stepIndex >= 16 ? 'Was operating the grinder without safety glasses when observed.' : 'Additional details about involvement...';
			personHTML += '<div><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Notes</label>';
			personHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; min-height:0.8rem; ' + notesHighlight + notesFilled + '">' + notesText + '</div></div>';
			personHTML += '</div>';
			personsContainer.innerHTML = personHTML;
		}
	}
	
	// Steps 16-19: Equipment Involved - detailed field filling
	if (stepIndex >= 16 && equipToggle && equipList) {
		equipToggle.checked = true;
		equipToggle.style.boxShadow = stepIndex === 16 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		equipList.style.display = 'block';
		const equipmentContainer = document.getElementById('obsEquipmentContainer');
		if (equipmentContainer) {
			let equipHTML = '<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.4rem; margin-bottom:0.3rem;">';
			// Header
			equipHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">';
			equipHTML += '<span style="font-weight:600; color:#2c3e50; font-size:0.5rem;">Equipment #1</span>';
			equipHTML += '<button type="button" style="background:#e74c3c; color:#fff; border:none; padding:0.1rem 0.25rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-trash"></i> Remove</button>';
			equipHTML += '</div>';
			// Row 1: Equipment Name/ID | Equipment Type | Condition
			equipHTML += '<div style="display:flex; gap:0.25rem; flex-wrap:wrap; margin-bottom:0.2rem;">';
			// Equipment Name/ID
			const equipNameHighlight = stepIndex === 17 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const equipNameFilled = stepIndex >= 18 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const equipNameText = stepIndex >= 18 ? 'Angle Grinder XG-450' : 'Equipment name or ID...';
			equipHTML += '<div style="flex:1 1 30%;"><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Equipment Name/ID *</label>';
			equipHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; ' + equipNameHighlight + equipNameFilled + '">' + equipNameText + '</div></div>';
			// Equipment Type
			const equipTypeHighlight = stepIndex === 18 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const equipTypeFilled = stepIndex >= 19 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const equipTypeText = stepIndex >= 19 ? 'Power Tool' : 'Select...';
			equipHTML += '<div style="flex:1 1 30%;"><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Equipment Type</label>';
			equipHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; ' + equipTypeHighlight + equipTypeFilled + '">' + equipTypeText + '</div></div>';
			// Condition
			const condHighlight = stepIndex === 18 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const condFilled = stepIndex >= 19 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const condText = stepIndex >= 19 ? 'Good' : 'Select...';
			equipHTML += '<div style="flex:1 1 30%;"><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Condition</label>';
			equipHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; ' + condHighlight + condFilled + '">' + condText + '</div></div>';
			equipHTML += '</div>';
			// Row 2: Notes (full width)
			const equipNotesHighlight = stepIndex === 19 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
			const equipNotesFilled = stepIndex >= 20 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
			const equipNotesText = stepIndex >= 20 ? 'Equipment was functioning properly. Issue was PPE compliance, not equipment.' : 'Additional details about equipment...';
			equipHTML += '<div><label style="display:block; font-size:0.4rem; font-weight:600; color:#374151; margin-bottom:0.1rem;">Notes</label>';
			equipHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:3px; font-size:0.4rem; min-height:0.8rem; ' + equipNotesHighlight + equipNotesFilled + '">' + equipNotesText + '</div></div>';
			equipHTML += '</div>';
			equipmentContainer.innerHTML = equipHTML;
		}
	}
	
	// Step 20: Click Add Corrective Action button
	if (stepIndex >= 20 && addActionBtn) {
		addActionBtn.style.boxShadow = stepIndex === 20 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		addActionBtn.style.background = '#3b82f6';
		addActionBtn.style.color = 'white';
	}
	
	// Steps 21-24: Show corrective action form being filled
	if (stepIndex >= 21 && correctiveActions) {
		correctiveActions.style.display = 'block';
		correctiveActions.style.textAlign = 'left';
		
		let actionFormHTML = '<div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:0.4rem;">';
		
		// Action Header
		actionFormHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">';
		actionFormHTML += '<span style="font-weight:600; color:#2c3e50; font-size:0.5rem;">Action #1</span>';
		actionFormHTML += '<button type="button" style="background:#e74c3c; color:#fff; border:none; padding:0.1rem 0.25rem; border-radius:3px; font-size:0.4rem;"><i class="fas fa-trash"></i> Remove</button>';
		actionFormHTML += '</div>';
		
		// Row 1: Description (full width)
		actionFormHTML += '<div style="margin-bottom:0.25rem;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.4rem; font-weight:600; color:#374151;">Description *</label>';
		const descHighlight = stepIndex === 21 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
		const descFilled = stepIndex >= 22 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const descText = stepIndex >= 22 ? 'Conduct toolbox talk on mandatory PPE requirements for grinding operations' : 'Describe the corrective action...';
		actionFormHTML += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:4px; font-size:0.4rem; min-height:0.8rem; ' + descHighlight + descFilled + '">' + descText + '</div>';
		actionFormHTML += '</div>';
		
		// Row 2: Responsible Person | Due Date | Status
		actionFormHTML += '<div style="display:flex; gap:0.25rem; flex-wrap:wrap;">';
		
		// Responsible Person
		actionFormHTML += '<div style="flex:1 1 30%;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.4rem; font-weight:600; color:#374151;">Responsible Person *</label>';
		const personHighlight = stepIndex === 22 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
		const personFilled = stepIndex >= 23 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const personText = stepIndex >= 23 ? 'James Wilson' : 'Type to search...';
		actionFormHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:4px; font-size:0.4rem; ' + personHighlight + personFilled + '">' + personText + '</div>';
		actionFormHTML += '</div>';
		
		// Due Date
		actionFormHTML += '<div style="flex:1 1 30%;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.4rem; font-weight:600; color:#374151;">Due Date *</label>';
		const dueDateHighlight = stepIndex === 23 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
		const dueDateFilled = stepIndex >= 24 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const dueDateText = stepIndex >= 24 ? '2024-12-20' : 'Select date...';
		actionFormHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:4px; font-size:0.4rem; ' + dueDateHighlight + dueDateFilled + '">' + dueDateText + '</div>';
		actionFormHTML += '</div>';
		
		// Status
		actionFormHTML += '<div style="flex:1 1 30%;">';
		actionFormHTML += '<label style="display:block; margin-bottom:0.1rem; font-size:0.4rem; font-weight:600; color:#374151;">Status *</label>';
		const statusHighlight = stepIndex === 23 ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.6);' : '';
		const statusFilled = stepIndex >= 24 ? 'background:#f0fdf4; border-color:#22c55e; color:#1f2937;' : 'background:#fff; color:#9ca3af;';
		const statusText = stepIndex >= 24 ? 'Pending' : 'Select Status...';
		actionFormHTML += '<div style="padding:0.15rem; border:1px solid #ced4da; border-radius:4px; font-size:0.4rem; ' + statusHighlight + statusFilled + '">' + statusText + '</div>';
		actionFormHTML += '</div>';
		
		actionFormHTML += '</div>'; // Close row 2
		
		// Action Saved indicator
		if (stepIndex === 24) {
			actionFormHTML += '<div style="text-align:center; padding:0.2rem; background:#dcfce7; border-radius:3px; margin-top:0.25rem;"><i class="fas fa-check" style="color:#22c55e;"></i> <span style="font-size:0.4rem; color:#166534; font-weight:600;">Action Saved!</span></div>';
		}
		
		actionFormHTML += '</div>'; // Close action item container
		
		// Show saved action card after step 24
		if (stepIndex >= 25) {
			actionFormHTML = '<div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:0.4rem;">';
			actionFormHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.2rem;">';
			actionFormHTML += '<span style="font-weight:600; color:#2c3e50; font-size:0.5rem;">Action #1</span>';
			actionFormHTML += '<span style="background:#fef9c3; color:#854d0e; padding:1px 6px; border-radius:9999px; font-size:0.4rem; font-weight:600;">PENDING</span>';
			actionFormHTML += '</div>';
			actionFormHTML += '<div style="font-size:0.4rem; color:#1f2937; margin-bottom:0.15rem;">Conduct toolbox talk on mandatory PPE requirements for grinding operations</div>';
			actionFormHTML += '<div style="display:flex; gap:0.5rem; font-size:0.35rem; color:#6b7280;">';
			actionFormHTML += '<span><i class="fas fa-user"></i> James Wilson</span>';
			actionFormHTML += '<span><i class="fas fa-calendar"></i> 2024-12-20</span>';
			actionFormHTML += '</div>';
			actionFormHTML += '</div>';
		}
		
		correctiveActions.innerHTML = actionFormHTML;
	}
	
	// Step 25: Upload Attachment
	if (stepIndex >= 25 && uploadBtn && fileList) {
		uploadBtn.style.boxShadow = stepIndex === 25 ? '0 0 0 3px rgba(59,130,246,0.6)' : 'none';
		uploadBtn.style.background = '#3b82f6';
		uploadBtn.style.color = 'white';
		fileList.style.display = 'block';
		fileList.innerHTML = '<div style="display:flex;align-items:center;gap:0.3rem;padding:0.25rem;background:#eff6ff;border-radius:4px;border:1px solid #bfdbfe;"><i class="fas fa-image" style="color:#3b82f6;font-size:0.5rem;"></i><span style="font-size:0.5rem;color:#1e40af;flex:1;">observation_photo.jpg</span><span style="font-size:0.45rem;color:#6b7280;">245 KB</span></div>';
	}
	
	// Step 26: Highlight Submit button
	if (stepIndex === 26 && submitBtn) {
		submitBtn.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.6)';
		submitBtn.style.background = '#22c55e';
	}
}

function toggleObservationPlayPause() {
	observationPlaying = !observationPlaying;
	document.getElementById('observationPlayPauseBtn').innerHTML = observationPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
	if (observationPlaying) playObservationVideo();
}

function seekObservationVideo(event) {
	const rect = event.currentTarget.getBoundingClientRect();
	const percent = (event.clientX - rect.left) / rect.width;
	let cumulative = 0;
	for (let i = 0; i < observationScenes.length; i++) {
		cumulative += observationScenes[i].duration;
		if (percent * observationTotalDuration < cumulative) { observationCurrentStep = i; break; }
	}
	document.getElementById('observationProgressBar').style.width = (percent * 100) + '%';
	buildObservationScenes();
	updateObservationScene(observationCurrentStep);
	if (observationPlaying) playObservationVideo();
}

// ========== INCIDENT DEMO VIDEO ==========
let incidentDemoPlaying = false;
let incidentDemoCurrentStep = 0;
let incidentDemoInterval = null;

const incidentDemoScenes = [
	{ id: 'welcome', caption: '<strong>Welcome!</strong> This is the <span style="color:#ef4444;">Incident</span> reporting form', duration: 2500, scrollTo: 0 },
	{ id: 'fill-title', caption: '<strong>Step 1:</strong> Enter a descriptive <span style="color:#ef4444;">Title</span>', duration: 2000, scrollTo: 0 },
	{ id: 'fill-severity', caption: '<strong>Step 2:</strong> Select the <span style="color:#ef4444;">Severity</span> level', duration: 2000, scrollTo: 0 },
	{ id: 'fill-date', caption: '<strong>Step 3:</strong> Select the <span style="color:#ef4444;">Date & Time</span>', duration: 2000, scrollTo: 5 },
	{ id: 'fill-location', caption: '<strong>Step 4:</strong> Choose the <span style="color:#ef4444;">Location</span>', duration: 2000, scrollTo: 8 },
	{ id: 'fill-department', caption: '<strong>Step 5:</strong> Select the <span style="color:#ef4444;">Department</span>', duration: 2000, scrollTo: 10 },
	{ id: 'fill-assigned', caption: '<strong>Step 6:</strong> Assign to a <span style="color:#ef4444;">Responsible Person</span>', duration: 2000, scrollTo: 12 },
	{ id: 'fill-description', caption: '<strong>Step 7:</strong> Provide a detailed <span style="color:#ef4444;">Description</span>', duration: 2500, scrollTo: 18 },
	{ id: 'fill-category', caption: '<strong>Step 8:</strong> Select the <span style="color:#ef4444;">Incident Category</span>', duration: 2000, scrollTo: 22 },
	{ id: 'injury-toggle', caption: '<strong>Step 9:</strong> Toggle <span style="color:#ef4444;">Injury Occurred</span> ON', duration: 2000, scrollTo: 26 },
	{ id: 'injury-type', caption: '<strong>Step 10:</strong> Select <span style="color:#ef4444;">Injury Type</span>', duration: 2000, scrollTo: 28 },
	{ id: 'injury-person', caption: '<strong>Step 11:</strong> Enter <span style="color:#ef4444;">Injured Person</span> name', duration: 2000, scrollTo: 30 },
	{ id: 'injury-bodypart', caption: '<strong>Step 12:</strong> Enter <span style="color:#ef4444;">Body Part Affected</span>', duration: 2000, scrollTo: 32 },
	{ id: 'injury-treatment', caption: '<strong>Step 13:</strong> Select <span style="color:#ef4444;">Treatment Provided</span>', duration: 2000, scrollTo: 34 },
	{ id: 'injury-losttime', caption: '<strong>Step 14:</strong> Select <span style="color:#ef4444;">Lost Time Injury</span>', duration: 2000, scrollTo: 36 },
	{ id: 'injury-dayslost', caption: '<strong>Step 15:</strong> Enter <span style="color:#ef4444;">Days Lost</span>', duration: 2000, scrollTo: 38 },
	{ id: 'property-toggle', caption: '<strong>Step 16:</strong> Toggle <span style="color:#ef4444;">Property Damage</span> ON', duration: 2000, scrollTo: 42 },
	{ id: 'property-type', caption: '<strong>Step 17:</strong> Select <span style="color:#ef4444;">Damage Type</span>', duration: 2000, scrollTo: 44 },
	{ id: 'property-asset', caption: '<strong>Step 18:</strong> Enter <span style="color:#ef4444;">Damaged Asset</span>', duration: 2000, scrollTo: 46 },
	{ id: 'property-cost', caption: '<strong>Step 19:</strong> Enter <span style="color:#ef4444;">Estimated Cost</span>', duration: 2000, scrollTo: 48 },
	{ id: 'property-desc', caption: '<strong>Step 20:</strong> Enter <span style="color:#ef4444;">Damage Description</span>', duration: 2000, scrollTo: 50 },
	{ id: 'immediate-actions', caption: '<strong>Step 21:</strong> Enter <span style="color:#ef4444;">Immediate Actions</span> taken', duration: 2500, scrollTo: 54 },
	{ id: 'add-corrective', caption: '<strong>Step 22:</strong> Click <span style="color:#ef4444;">Add Corrective Action</span>', duration: 2000, scrollTo: 58 },
	{ id: 'corrective-desc', caption: '<strong>Step 23:</strong> Enter <span style="color:#ef4444;">Action Description</span>', duration: 2000, scrollTo: 60 },
	{ id: 'corrective-person', caption: '<strong>Step 24:</strong> Enter <span style="color:#ef4444;">Responsible Person</span>', duration: 2000, scrollTo: 62 },
	{ id: 'corrective-due', caption: '<strong>Step 25:</strong> Select <span style="color:#ef4444;">Due Date</span> and <span style="color:#ef4444;">Status</span>', duration: 2000, scrollTo: 64 },
	{ id: 'corrective-save', caption: '<strong>Step 26:</strong> Corrective Action <span style="color:#22c55e;">Saved</span>', duration: 2000, scrollTo: 66 },
	{ id: 'duedate', caption: '<strong>Step 27:</strong> Set overall <span style="color:#ef4444;">Due Date</span>', duration: 2000, scrollTo: 68 },
	{ id: 'extra-injured', caption: '<strong>Step 28:</strong> Enter additional <span style="color:#ef4444;">Injured Person</span> info', duration: 2000, scrollTo: 72 },
	{ id: 'extra-losttime', caption: '<strong>Step 29:</strong> Select <span style="color:#ef4444;">Lost Time</span>', duration: 2000, scrollTo: 74 },
	{ id: 'extra-dayslost', caption: '<strong>Step 30:</strong> Enter <span style="color:#ef4444;">Days Lost</span>', duration: 2000, scrollTo: 76 },
	{ id: 'rootcause', caption: '<strong>Step 31:</strong> Provide <span style="color:#ef4444;">Root Cause</span> analysis', duration: 2500, scrollTo: 78 },
	{ id: 'contributing', caption: '<strong>Step 32:</strong> List <span style="color:#ef4444;">Contributing Factors</span>', duration: 2500, scrollTo: 82 },
	{ id: 'equipment', caption: '<strong>Step 33:</strong> Enter <span style="color:#ef4444;">Equipment Involved</span>', duration: 2000, scrollTo: 86 },
	{ id: 'witnesses', caption: '<strong>Step 34:</strong> Enter <span style="color:#ef4444;">Witnesses</span> names', duration: 2000, scrollTo: 88 },
	{ id: 'attachments', caption: '<strong>Step 35:</strong> <span style="color:#ef4444;">Upload</span> supporting documents', duration: 2000, scrollTo: 92 },
	{ id: 'submit', caption: '<strong>Step 36:</strong> Click <span style="color:#ef4444;">Submit Incident</span>', duration: 2000, scrollTo: 100 },
	{ id: 'success', caption: '<strong>Done!</strong> Incident reported! <span style="color:#22c55e;">Reference: INC-2024-0108</span>', duration: 3000, scrollTo: 100 }
];

const incidentDemoTotalDuration = incidentDemoScenes.reduce((sum, s) => sum + s.duration, 0);

function openIncidentDemoVideo() {
	document.getElementById('incidentDemoOverlay').classList.add('active');
	buildIncidentDemoScenes();
	restartIncidentDemoVideo();
}

function closeIncidentDemoVideo() {
	document.getElementById('incidentDemoOverlay').classList.remove('active');
	if (incidentDemoInterval) clearInterval(incidentDemoInterval);
	incidentDemoPlaying = false;
}

function buildIncidentDemoScenes() {
	const container = document.getElementById('incidentDemoSceneContainer');
	if (!container) return;
	container.innerHTML = generateIncidentDemoSceneHTML();
}

function generateIncidentDemoSceneHTML() {
	// Displays the exact incident.html form page for Incident reporting
	return `
		<div style="width:100%; height:100%; display:flex; font-family:Inter,system-ui,sans-serif; font-size:14px;">
			<!-- Sidebar -->
			<div style="width:120px; background:#2c3e50; color:#fff; flex-shrink:0; overflow-y:auto;">
				<div style="text-align:center; padding:0.5rem; border-bottom:1px solid rgba(255,255,255,0.1);">
					<h2 style="font-size:0.6rem; margin:0;">Dreamex Datalab</h2>
				</div>
				<ul style="list-style:none; margin:0.5rem 0; padding:0; font-size:0.55rem;">
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-home"></i> Home</a></li>
					<li><a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; opacity:0.7;"><i class="fas fa-medkit"></i> Health</a></li>
					<li>
						<a href="#" style="color:#fff; text-decoration:none; display:flex; align-items:center; gap:0.3rem; padding:0.3rem 0.4rem; background:#3498db; border-radius:4px;"><i class="fas fa-shield-alt"></i> Safety</a>
						<ul style="list-style:none; margin-left:0.5rem; padding:0; font-size:0.5rem;">
							<li><a href="#" style="color:#fff; text-decoration:none; padding:0.2rem 0.4rem; display:block; background:rgba(255,255,255,0.15); border-radius:3px;">Incident Reports</a></li>
						</ul>
					</li>
				</ul>
			</div>
			<!-- Main Content Area -->
			<div style="flex:1; display:flex; flex-direction:column; background:#f8f9fa; overflow:hidden;">
				<!-- Top Nav -->
				<header style="display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0.5rem; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:sticky; top:0; z-index:20;">
					<div style="display:flex; align-items:center; gap:0.4rem;">
						<div style="width:20px; height:20px; background:#ef4444; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.5rem; font-weight:600;">DX</div>
						<span style="font-weight:600; color:#2c3e50; font-size:0.6rem;">Company Name</span>
					</div>
					<div style="display:flex; align-items:center; gap:0.5rem;">
						<button style="background:none; border:none; font-size:0.7rem; color:#555;"><i class="fas fa-bell"></i></button>
						<div style="width:20px; height:20px; background:#64748b; border-radius:50%;"></div>
					</div>
				</header>
				<!-- Page Header -->
				<div style="background:#fff; color:#2c3e50; padding:0.5rem; margin:0.4rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); border:1px solid #e0e0e0;">
					<h1 style="margin:0; font-size:0.8rem; display:flex; align-items:center; gap:0.4rem;"><i class="fas fa-exclamation-triangle" style="color:#ef4444;"></i> Report Incident</h1>
					<a href="#" style="background:#2c3e50; color:#fff; border:none; padding:0.3rem 0.5rem; border-radius:4px; font-size:0.55rem; text-decoration:none;"><i class="fas fa-table-list"></i></a>
				</div>
				<!-- Form Content (scrollable) -->
				<div id="incFormScroll" style="flex:1; overflow-y:auto; padding:0 0.4rem 0.4rem;">
					<form style="font-size:0.6rem;">
						<!-- Basic Information Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Basic Information</h3>
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem;">
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Reference</label>
									<div id="incReference" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#6b7280;">INC-2024-0108</div>
								</div>
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Title *</label>
									<div id="incTitle" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af; min-height:1.2rem;">Brief title...</div>
								</div>
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Severity *</label>
									<div id="incSeverity" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Severity</div>
								</div>
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Event Type</label>
									<div id="incEventType" style="width:100%; padding:0.3rem; border:1px solid #ef4444; border-radius:4px; font-size:0.55rem; background:#fef2f2; color:#dc2626; font-weight:600;">Incident</div>
								</div>
							</div>
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.4rem;">
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Date & Time *</label>
									<div id="incDate" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select date...</div>
								</div>
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Status</label>
									<div id="incStatus" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#374151;">Open</div>
								</div>
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Location *</label>
									<div id="incLocation" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Location</div>
								</div>
								<div style="flex:1 1 22%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Department *</label>
									<div id="incDepartment" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Department</div>
								</div>
							</div>
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.4rem;">
								<div style="flex:1 1 30%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Assigned To</label>
									<div id="incAssignedTo" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Type to search...</div>
								</div>
								<div style="flex:1 1 30%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Reported By</label>
									<div id="incReportedBy" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#6b7280;">John Smith</div>
								</div>
								<div style="flex:1 1 30%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Date Reported</label>
									<div id="incDateReported" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#f8f9fa; color:#6b7280;">2024-12-17</div>
								</div>
							</div>
						</div>
						
						<!-- Event-specific Details Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Event-specific Details</h3>
							
							<!-- Description -->
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Description *</label>
								<div id="incDescription" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:2rem; color:#9ca3af;">Describe what happened...</div>
							</div>
							
							<!-- Incident Category -->
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Incident Category</label>
								<div id="incCategory" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select Category</div>
							</div>
							
							<!-- Injury Checkbox Toggle (matching original incident.html) -->
							<div class="form-group" style="margin-bottom:0.4rem;">
								<div id="incInjuryCheckboxRow" style="display:flex; align-items:center; gap:0.4rem; margin-bottom:0.4rem;">
									<input type="checkbox" id="incInjuryCheckbox" style="width:14px; height:14px; cursor:pointer; accent-color:#ef4444;">
									<label style="font-weight:600; font-size:0.55rem; cursor:pointer; margin:0;">Injury Occurred</label>
								</div>
								<div id="incInjuryFields" style="display:none; padding:0.5rem; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px;">
									<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.4rem;">
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Injury Type *</label>
											<div id="incInjuryType" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select Injury Type</div>
										</div>
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Injured Person *</label>
											<div id="incInjuredPerson" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">Name of injured person</div>
										</div>
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Body Part Affected</label>
											<div id="incBodyPart" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">e.g., Hand, Back, Head</div>
										</div>
									</div>
									<div style="display:flex; flex-wrap:wrap; gap:0.4rem;">
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Treatment Provided</label>
											<div id="incTreatment" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select</div>
										</div>
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Lost Time Injury</label>
											<div id="incLostTimeInjury" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select</div>
										</div>
										<div style="flex:1 1 30%;" id="incDaysLostGroup" style="display:none;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Days Lost *</label>
											<div id="incDaysLostInjury" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">0</div>
										</div>
									</div>
								</div>
							</div>
							
							<!-- Property Damage Checkbox Toggle (matching original incident.html) -->
							<div class="form-group" style="margin-bottom:0.4rem;">
								<div id="incPropertyCheckboxRow" style="display:flex; align-items:center; gap:0.4rem; margin-bottom:0.4rem;">
									<input type="checkbox" id="incPropertyCheckbox" style="width:14px; height:14px; cursor:pointer; accent-color:#eab308;">
									<label style="font-weight:600; font-size:0.55rem; cursor:pointer; margin:0;">Property Damage Occurred</label>
								</div>
								<div id="incPropertyFields" style="display:none; padding:0.5rem; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px;">
									<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.4rem;">
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Damage Type *</label>
											<div id="incDamageType" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select Property Damage</div>
										</div>
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Damaged Asset/Equipment *</label>
											<div id="incDamagedAsset" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">Describe the damaged asset</div>
										</div>
										<div style="flex:1 1 30%;">
											<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Estimated Cost</label>
											<div id="incEstimatedCost" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af;">0.00</div>
										</div>
									</div>
									<div>
										<label style="display:block; font-size:0.5rem; font-weight:600; margin-bottom:0.1rem;">Damage Description</label>
										<div id="incDamageDesc" style="padding:0.25rem; border:1px solid #ced4da; border-radius:4px; font-size:0.5rem; background:#fff; color:#9ca3af; min-height:1.5rem;">Describe the extent of damage</div>
									</div>
								</div>
							</div>
						</div>
						
						<!-- Actions Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Actions</h3>
							
							<!-- Immediate Actions -->
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Immediate Actions</label>
								<div id="incImmediateActions" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:1.5rem; color:#9ca3af;">Actions taken immediately...</div>
							</div>
							
							<!-- Corrective Actions -->
							<div style="margin-bottom:0.4rem;">
								<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">
									<label style="font-weight:600; font-size:0.55rem;"><i class="fas fa-tasks"></i> Corrective Actions</label>
									<button id="incAddActionBtn" type="button" style="background:#2c3e50; color:#fff; border:none; padding:0.2rem 0.4rem; border-radius:4px; font-size:0.5rem;"><i class="fas fa-plus"></i> Add Action</button>
								</div>
								<div id="incCorrectiveActions" style="color:#666; font-style:italic; text-align:center; padding:0.5rem; font-size:0.5rem;">No corrective actions added.</div>
							</div>
							
							<!-- Due Date -->
							<div>
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Due Date</label>
								<div id="incDueDate" style="width:30%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select date...</div>
							</div>
						</div>
						
						<!-- Incident Extra Fields Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Additional Incident Details</h3>
							
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.4rem;">
								<div style="flex:1 1 30%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Injured Person</label>
									<div id="incExtraInjured" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Name (if any)...</div>
								</div>
								<div style="flex:1 1 30%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Lost Time</label>
									<div id="incExtraLostTime" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Select...</div>
								</div>
								<div style="flex:1 1 30%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Days Lost</label>
									<div id="incExtraDaysLost" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">0</div>
								</div>
							</div>
							
							<!-- Root Cause -->
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Root Cause *</label>
								<div id="incRootCause" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:1.5rem; color:#9ca3af;">Root cause analysis...</div>
							</div>
							
							<!-- Contributing Factors -->
							<div style="margin-bottom:0.4rem;">
								<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Contributing Factors</label>
								<div id="incContributing" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; min-height:1.5rem; color:#9ca3af;">List contributing factors...</div>
							</div>
							
							<div style="display:flex; flex-wrap:wrap; gap:0.4rem;">
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Equipment Involved</label>
									<div id="incEquipment" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Equipment or asset...</div>
								</div>
								<div style="flex:1 1 45%;">
									<label style="display:block; margin-bottom:0.15rem; font-weight:600; font-size:0.55rem;">Witnesses</label>
									<div id="incWitnesses" style="width:100%; padding:0.3rem; border:1px solid #ced4da; border-radius:4px; font-size:0.55rem; background:#fff; color:#9ca3af;">Names of witnesses...</div>
								</div>
							</div>
						</div>
						
						<!-- Attachments Section -->
						<div style="background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:0.5rem; margin-bottom:0.4rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
							<h3 style="margin:0 0 0.4rem; color:#2c3e50; font-size:0.7rem; border-bottom:1px solid #eee; padding-bottom:0.3rem;">Attachments</h3>
							<button id="incUploadBtn" type="button" style="display:inline-flex; align-items:center; gap:0.2rem; background:#6c757d; color:#fff; padding:0.25rem 0.5rem; border-radius:4px; font-size:0.5rem; cursor:pointer; border:none;">
								<i class="fas fa-upload"></i> Choose Files
							</button>
							<small style="margin-left:0.3rem; color:#666; font-size:0.45rem;">Max 5MB each</small>
							<div id="incFileList" style="display:none; margin-top:0.5rem;"></div>
						</div>
						
						<!-- Action Buttons -->
						<div style="display:flex; gap:0.3rem; justify-content:flex-end; padding:0.3rem 0;">
							<button type="button" style="padding:0.3rem 0.6rem; background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:0.55rem;">Cancel</button>
							<button type="button" style="padding:0.3rem 0.6rem; background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:0.55rem;">Save Draft</button>
							<button id="incSubmitBtn" type="button" style="padding:0.3rem 0.6rem; background:#2c3e50; color:#fff; border:none; border-radius:4px; font-size:0.55rem; font-weight:600;">Submit Incident</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Success Message Overlay -->
		<div id="incSuccessMsg" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center;">
			<div style="background:#fff; width:85%; max-width:280px; border-radius:8px; padding:1rem; text-align:center;">
				<div style="width:40px; height:40px; background:#dcfce7; border-radius:50%; margin:0 auto 0.5rem; display:flex; align-items:center; justify-content:center;">
					<i class="fas fa-check" style="font-size:1.2rem; color:#22c55e;"></i>
				</div>
				<h3 style="color:#1f2937; margin:0 0 0.2rem; font-size:0.8rem;">Incident Reported!</h3>
				<p style="color:#6b7280; font-size:0.65rem; margin:0;">Reference: <strong style="color:#ef4444;">INC-2024-0108</strong></p>
			</div>
		</div>
	`;
}

function restartIncidentDemoVideo() {
	incidentDemoCurrentStep = 0;
	incidentDemoPlaying = true;
	document.getElementById('incidentPlayPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
	buildIncidentDemoScenes();
	playIncidentDemoVideo();
}

function playIncidentDemoVideo() {
	if (incidentDemoInterval) clearInterval(incidentDemoInterval);
	
	let elapsed = 0;
	for (let i = 0; i < incidentDemoCurrentStep; i++) elapsed += incidentDemoScenes[i].duration;
	
	updateIncidentDemoScene(incidentDemoCurrentStep);
	
	incidentDemoInterval = setInterval(() => {
		if (!incidentDemoPlaying) return;
		
		elapsed += 100;
		const progress = (elapsed / incidentDemoTotalDuration) * 100;
		document.getElementById('incidentProgressBar').style.width = progress + '%';
		
		const mins = Math.floor(elapsed / 60000);
		const secs = Math.floor((elapsed % 60000) / 1000);
		const totalMins = Math.floor(incidentDemoTotalDuration / 60000);
		const totalSecs = Math.floor((incidentDemoTotalDuration % 60000) / 1000);
		document.getElementById('incidentVideoTime').textContent = `${mins}:${secs.toString().padStart(2,'0')} / ${totalMins}:${totalSecs.toString().padStart(2,'0')}`;
		
		let cumulative = 0;
		for (let i = 0; i < incidentDemoScenes.length; i++) {
			cumulative += incidentDemoScenes[i].duration;
			if (elapsed < cumulative) {
				if (i !== incidentDemoCurrentStep) {
					incidentDemoCurrentStep = i;
					updateIncidentDemoScene(i);
				}
				break;
			}
		}
		
		if (elapsed >= incidentDemoTotalDuration) {
			clearInterval(incidentDemoInterval);
			incidentDemoPlaying = false;
			document.getElementById('incidentPlayPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
		}
	}, 100);
}

function updateIncidentDemoScene(stepIndex) {
	const scene = incidentDemoScenes[stepIndex];
	document.getElementById('incidentDemoCaptionText').innerHTML = scene.caption;
	
	// Handle scroll
	const scrollEl = document.getElementById('incFormScroll');
	if (scene.scrollTo !== undefined && scrollEl) {
		const maxScroll = scrollEl.scrollHeight - scrollEl.clientHeight;
		const targetScroll = (scene.scrollTo / 100) * maxScroll;
		scrollEl.scrollTo({ top: targetScroll, behavior: 'smooth' });
	}
	
	// Get all form field elements
	const title = document.getElementById('incTitle');
	const severity = document.getElementById('incSeverity');
	const date = document.getElementById('incDate');
	const location = document.getElementById('incLocation');
	const department = document.getElementById('incDepartment');
	const assignedTo = document.getElementById('incAssignedTo');
	const description = document.getElementById('incDescription');
	const category = document.getElementById('incCategory');
	const injuryCheckbox = document.getElementById('incInjuryCheckbox');
	const injuryCheckboxRow = document.getElementById('incInjuryCheckboxRow');
	const injuryFields = document.getElementById('incInjuryFields');
	const injuryType = document.getElementById('incInjuryType');
	const injuredPerson = document.getElementById('incInjuredPerson');
	const bodyPart = document.getElementById('incBodyPart');
	const treatment = document.getElementById('incTreatment');
	const lostTimeInjury = document.getElementById('incLostTimeInjury');
	const daysLostInjury = document.getElementById('incDaysLostInjury');
	const propertyCheckbox = document.getElementById('incPropertyCheckbox');
	const propertyCheckboxRow = document.getElementById('incPropertyCheckboxRow');
	const propertyFields = document.getElementById('incPropertyFields');
	const damageType = document.getElementById('incDamageType');
	const damagedAsset = document.getElementById('incDamagedAsset');
	const estimatedCost = document.getElementById('incEstimatedCost');
	const damageDesc = document.getElementById('incDamageDesc');
	const immediateActions = document.getElementById('incImmediateActions');
	const addActionBtn = document.getElementById('incAddActionBtn');
	const correctiveActions = document.getElementById('incCorrectiveActions');
	const dueDate = document.getElementById('incDueDate');
	const extraInjured = document.getElementById('incExtraInjured');
	const extraLostTime = document.getElementById('incExtraLostTime');
	const extraDaysLost = document.getElementById('incExtraDaysLost');
	const rootCause = document.getElementById('incRootCause');
	const contributing = document.getElementById('incContributing');
	const equipment = document.getElementById('incEquipment');
	const witnesses = document.getElementById('incWitnesses');
	const uploadBtn = document.getElementById('incUploadBtn');
	const fileList = document.getElementById('incFileList');
	const submitBtn = document.getElementById('incSubmitBtn');
	const success = document.getElementById('incSuccessMsg');
	
	// All highlightable elements
	const allFields = [title, severity, date, location, department, assignedTo, description, category, 
		injuryCheckboxRow, injuryType, injuredPerson, bodyPart, treatment, lostTimeInjury, daysLostInjury,
		propertyCheckboxRow, damageType, damagedAsset, estimatedCost, damageDesc, immediateActions,
		addActionBtn, dueDate, extraInjured, extraLostTime, extraDaysLost, rootCause, contributing,
		equipment, witnesses, uploadBtn, submitBtn];
	
	// Reset all highlights
	allFields.forEach(el => {
		if (el) {
			el.style.boxShadow = 'none';
			el.style.transition = 'all 0.3s ease';
		}
	});
	
	// Hide success message unless final step (step 37)
	if (success) {
		success.style.display = (stepIndex >= 37) ? 'flex' : 'none';
	}
	
	// Helper function for filled field style
	const fillField = (el, value, isActive) => {
		if (!el) return;
		el.style.boxShadow = isActive ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
		el.style.borderColor = '#22c55e';
		el.style.color = '#1f2937';
		el.style.background = '#f0fdf4';
		el.textContent = value;
	};
	
	// Step 1: Fill Title
	if (stepIndex >= 1) fillField(title, 'Slip and fall in cafeteria', stepIndex === 1);
	
	// Step 2: Fill Severity
	if (stepIndex >= 2) {
		if (severity) {
			severity.style.boxShadow = stepIndex === 2 ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
			severity.style.borderColor = '#22c55e';
			severity.style.color = '#dc2626';
			severity.style.background = '#fef2f2';
			severity.style.fontWeight = '600';
			severity.textContent = 'High';
		}
	}
	
	// Step 3: Fill Date
	if (stepIndex >= 3) fillField(date, '2024-12-17 12:15', stepIndex === 3);
	
	// Step 4: Fill Location
	if (stepIndex >= 4) fillField(location, 'Main Building - Cafeteria', stepIndex === 4);
	
	// Step 5: Fill Department
	if (stepIndex >= 5) fillField(department, 'Operations', stepIndex === 5);
	
	// Step 6: Fill Assigned To
	if (stepIndex >= 6) fillField(assignedTo, 'Safety Manager - David Lee', stepIndex === 6);
	
	// Step 7: Fill Description
	if (stepIndex >= 7) fillField(description, 'Employee slipped on wet floor near the food service area. Minor knee injury reported. First aid was administered on site.', stepIndex === 7);
	
	// Step 8: Fill Category
	if (stepIndex >= 8) fillField(category, 'Slip/Trip/Fall', stepIndex === 8);
	
	// Step 9: Check Injury Occurred checkbox
	if (stepIndex >= 9 && injuryCheckbox && injuryFields && injuryCheckboxRow) {
		injuryCheckboxRow.style.boxShadow = stepIndex === 9 ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
		injuryCheckboxRow.style.borderRadius = '4px';
		injuryCheckbox.checked = true;
		injuryFields.style.display = 'block';
	}
	
	// Step 10: Fill Injury Type
	if (stepIndex >= 10) fillField(injuryType, 'Sprain', stepIndex === 10);
	
	// Step 11: Fill Injured Person
	if (stepIndex >= 11) fillField(injuredPerson, 'Sarah Johnson', stepIndex === 11);
	
	// Step 12: Fill Body Part
	if (stepIndex >= 12) fillField(bodyPart, 'Knee', stepIndex === 12);
	
	// Step 13: Fill Treatment
	if (stepIndex >= 13) fillField(treatment, 'First Aid', stepIndex === 13);
	
	// Step 14: Fill Lost Time Injury
	if (stepIndex >= 14) fillField(lostTimeInjury, 'Yes', stepIndex === 14);
	
	// Step 15: Fill Days Lost
	if (stepIndex >= 15) fillField(daysLostInjury, '3', stepIndex === 15);
	
	// Step 16: Check Property Damage Occurred checkbox
	if (stepIndex >= 16 && propertyCheckbox && propertyFields && propertyCheckboxRow) {
		propertyCheckboxRow.style.boxShadow = stepIndex === 16 ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
		propertyCheckboxRow.style.borderRadius = '4px';
		propertyCheckbox.checked = true;
		propertyFields.style.display = 'block';
	}
	
	// Step 17: Fill Damage Type
	if (stepIndex >= 17) fillField(damageType, 'Equipment', stepIndex === 17);
	
	// Step 18: Fill Damaged Asset
	if (stepIndex >= 18) fillField(damagedAsset, 'Floor tile cracked', stepIndex === 18);
	
	// Step 19: Fill Estimated Cost
	if (stepIndex >= 19) fillField(estimatedCost, '$250.00', stepIndex === 19);
	
	// Step 20: Fill Damage Description
	if (stepIndex >= 20) fillField(damageDesc, 'Floor tile cracked from impact during the fall', stepIndex === 20);
	
	// Step 21: Fill Immediate Actions
	if (stepIndex >= 21) fillField(immediateActions, 'Area cordoned off, wet floor signs placed, cleaning scheduled, injured person received first aid', stepIndex === 21);
	
	// Step 22: Click Add Corrective Action
	if (stepIndex >= 22 && addActionBtn) {
		addActionBtn.style.boxShadow = stepIndex === 22 ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
		addActionBtn.style.background = stepIndex === 22 ? '#ef4444' : '#2c3e50';
	}
	
	// Steps 23-26: Corrective Action form building
	if (stepIndex >= 23 && correctiveActions) {
		let html = '<div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:0.4rem; text-align:left;">';
		html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">';
		html += '<span style="font-weight:600; color:#2c3e50; font-size:0.55rem;">Action #1</span>';
		html += '<button type="button" style="background:#dc2626; color:#fff; border:none; width:16px; height:16px; border-radius:50%; font-size:0.4rem; cursor:pointer;">Ã—</button>';
		html += '</div>';
		
		// Description field (full width)
		html += '<div style="margin-bottom:0.3rem;">';
		html += '<label style="display:block; font-size:0.45rem; color:#666; margin-bottom:0.1rem;">Action Description *</label>';
		if (stepIndex >= 24) {
			html += '<div id="incActionDesc" style="padding:0.25rem; border:1px solid ' + (stepIndex === 23 ? '#ef4444' : '#22c55e') + '; border-radius:3px; font-size:0.5rem; background:' + (stepIndex >= 24 ? '#f0fdf4' : '#fff') + '; color:' + (stepIndex >= 24 ? '#1f2937' : '#9ca3af') + '; min-height:1rem;' + (stepIndex === 23 ? 'box-shadow:0 0 0 3px rgba(239,68,68,0.6);' : '') + '">Install Wet Floor Warning Signs at all entry points when cleaning</div>';
		} else {
			html += '<div id="incActionDesc" style="padding:0.25rem; border:1px solid #ef4444; border-radius:3px; font-size:0.5rem; background:#fff; color:#9ca3af; min-height:1rem; box-shadow:0 0 0 3px rgba(239,68,68,0.6);">Enter description...</div>';
		}
		html += '</div>';
		
		// 3-column row: Responsible Person | Due Date | Status
		html += '<div style="display:flex; gap:0.3rem; flex-wrap:wrap;">';
		
		// Responsible Person
		html += '<div style="flex:1 1 30%;">';
		html += '<label style="display:block; font-size:0.45rem; color:#666; margin-bottom:0.1rem;">Responsible Person *</label>';
		if (stepIndex >= 25) {
			html += '<div style="padding:0.2rem; border:1px solid ' + (stepIndex === 24 ? '#ef4444' : '#22c55e') + '; border-radius:3px; font-size:0.5rem; background:' + (stepIndex >= 25 ? '#f0fdf4' : '#fff') + '; color:' + (stepIndex >= 25 ? '#1f2937' : '#9ca3af') + ';' + (stepIndex === 24 ? 'box-shadow:0 0 0 3px rgba(239,68,68,0.6);' : '') + '">David Lee</div>';
		} else {
			html += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:3px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select...</div>';
		}
		html += '</div>';
		
		// Due Date
		html += '<div style="flex:1 1 30%;">';
		html += '<label style="display:block; font-size:0.45rem; color:#666; margin-bottom:0.1rem;">Due Date *</label>';
		if (stepIndex >= 26) {
			html += '<div style="padding:0.2rem; border:1px solid ' + (stepIndex === 25 ? '#ef4444' : '#22c55e') + '; border-radius:3px; font-size:0.5rem; background:' + (stepIndex >= 26 ? '#f0fdf4' : '#fff') + '; color:' + (stepIndex >= 26 ? '#1f2937' : '#9ca3af') + ';' + (stepIndex === 25 ? 'box-shadow:0 0 0 3px rgba(239,68,68,0.6);' : '') + '">2024-12-20</div>';
		} else {
			html += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:3px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select...</div>';
		}
		html += '</div>';
		
		// Status
		html += '<div style="flex:1 1 30%;">';
		html += '<label style="display:block; font-size:0.45rem; color:#666; margin-bottom:0.1rem;">Status</label>';
		if (stepIndex >= 26) {
			html += '<div style="padding:0.2rem; border:1px solid #22c55e; border-radius:3px; font-size:0.5rem; background:#fef9c3; color:#854d0e; font-weight:600;">Pending</div>';
		} else {
			html += '<div style="padding:0.2rem; border:1px solid #ced4da; border-radius:3px; font-size:0.5rem; background:#fff; color:#9ca3af;">Select...</div>';
		}
		html += '</div>';
		
		html += '</div>'; // end row
		html += '</div>'; // end card
		
		correctiveActions.innerHTML = html;
	}
	
	// Step 27: Fill Due Date
	if (stepIndex >= 27) fillField(dueDate, '2024-12-24', stepIndex === 27);
	
	// Step 28: Fill Extra Injured Person
	if (stepIndex >= 28) fillField(extraInjured, 'Sarah Johnson', stepIndex === 28);
	
	// Step 29: Fill Extra Lost Time
	if (stepIndex >= 29) fillField(extraLostTime, 'Yes', stepIndex === 29);
	
	// Step 30: Fill Extra Days Lost
	if (stepIndex >= 30) fillField(extraDaysLost, '3', stepIndex === 30);
	
	// Step 31: Fill Root Cause
	if (stepIndex >= 31) fillField(rootCause, 'Wet floor from spilled beverage. No warning signs were placed. Cleaning staff not notified promptly.', stepIndex === 31);
	
	// Step 32: Fill Contributing Factors
	if (stepIndex >= 32) fillField(contributing, 'Inadequate floor drainage, delayed spill response, lack of non-slip mats in high-traffic area', stepIndex === 32);
	
	// Step 33: Fill Equipment
	if (stepIndex >= 33) fillField(equipment, 'Beverage dispenser, floor tiles', stepIndex === 33);
	
	// Step 34: Fill Witnesses
	if (stepIndex >= 34) fillField(witnesses, 'Mike Brown, Jane Wilson', stepIndex === 34);
	
	// Step 35: Upload Attachment
	if (stepIndex >= 35 && uploadBtn && fileList) {
		uploadBtn.style.boxShadow = stepIndex === 35 ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
		uploadBtn.style.background = stepIndex === 35 ? '#ef4444' : '#6c757d';
		fileList.style.display = 'block';
		fileList.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:#fef2f2;border-radius:6px;border:1px solid #fecaca;"><i class="fas fa-image" style="color:#ef4444;"></i><span style="font-size:0.55rem;color:#991b1b;flex:1;">incident_scene_photo.jpg</span><span style="font-size:0.5rem;color:#6b7280;">1.2 MB</span></div>';
	}
	
	// Step 36: Highlight Submit button
	if (stepIndex >= 36 && submitBtn) {
		submitBtn.style.boxShadow = stepIndex === 36 ? '0 0 0 3px rgba(239,68,68,0.6)' : 'none';
		submitBtn.style.background = stepIndex === 36 ? '#22c55e' : '#2c3e50';
	}
}

function toggleIncidentPlayPause() {
	incidentDemoPlaying = !incidentDemoPlaying;
	document.getElementById('incidentPlayPauseBtn').innerHTML = incidentDemoPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
	if (incidentDemoPlaying) playIncidentDemoVideo();
}

function seekIncidentVideo(event) {
	const rect = event.currentTarget.getBoundingClientRect();
	const percent = (event.clientX - rect.left) / rect.width;
	let cumulative = 0;
	for (let i = 0; i < incidentDemoScenes.length; i++) {
		cumulative += incidentDemoScenes[i].duration;
		if (percent * incidentDemoTotalDuration < cumulative) { incidentDemoCurrentStep = i; break; }
	}
	document.getElementById('incidentProgressBar').style.width = (percent * 100) + '%';
	buildIncidentDemoScenes();
	updateIncidentDemoScene(incidentDemoCurrentStep);
	if (incidentDemoPlaying) playIncidentDemoVideo();
}

function addDemoAnimationStyles() {
	if (!document.getElementById('demoAnimStyles')) {
		const style = document.createElement('style');
		style.id = 'demoAnimStyles';
		style.textContent = `
			@keyframes highlightPulse { 0%, 100% { box-shadow: 0 0 0 3px rgba(251,191,36,0.4); } 50% { box-shadow: 0 0 12px 6px rgba(251,191,36,0.6); } }
		`;
		document.head.appendChild(style);
	}
}

// Interactive Guide
const guideSteps = [
	{
		target: '.tab-btn[data-tab="incidents"]',
		title: 'Incidents Tab',
		content: 'This tab shows all reported incidents. You can filter, search, and view detailed information about each incident.',
		position: 'bottom'
	},
	{
		target: '#searchInput',
		title: 'Search Incidents',
		content: 'Use this search box to quickly find incidents by reference number, title, location, or department.',
		position: 'bottom'
	},
	{
		target: '.filter-row',
		title: 'Filter Options',
		content: 'Filter incidents by severity, status, and date range to narrow down your search results.',
		position: 'bottom'
	},
	{
		target: '#incidentsTable',
		title: 'Incidents Table',
		content: 'Click on any row to view the full incident details. The table shows key information like reference number, title, date, severity, and status.',
		position: 'top'
	},
	{
		target: '.tab-btn[data-tab="settings"]',
		title: 'Settings Tab',
		content: 'Access settings to configure dropdown options, observation types, and user access control for the incident module.',
		position: 'bottom'
	}
];

let currentGuideStep = 0;
let guideActive = false;

function startInteractiveGuide() {
	currentGuideStep = 0;
	guideActive = true;
	document.getElementById('startGuideBtn').style.display = 'none';
	showGuideStep(currentGuideStep);
}

function showGuideStep(stepIndex) {
	const container = document.getElementById('guideContainer');
	container.innerHTML = '';

	if (stepIndex < 0 || stepIndex >= guideSteps.length) {
		endGuide();
		return;
	}

	const step = guideSteps[stepIndex];
	const targetEl = document.querySelector(step.target);
	
	if (!targetEl) {
		currentGuideStep++;
		if (currentGuideStep < guideSteps.length) {
			showGuideStep(currentGuideStep);
		} else {
			endGuide();
		}
		return;
	}

	targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

	setTimeout(() => {
		const rect = targetEl.getBoundingClientRect();
		const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
		const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

		const highlight = document.createElement('div');
		highlight.className = 'guide-highlight';
		highlight.style.top = (rect.top + scrollTop - 4) + 'px';
		highlight.style.left = (rect.left + scrollLeft - 4) + 'px';
		highlight.style.width = (rect.width + 8) + 'px';
		highlight.style.height = (rect.height + 8) + 'px';
		container.appendChild(highlight);

		const tooltip = document.createElement('div');
		tooltip.className = 'guide-tooltip';
		tooltip.innerHTML = `
			<div class="guide-tooltip-header">
				<span class="step-badge">Step ${stepIndex + 1}</span>
				<h4>${step.title}</h4>
			</div>
			<div class="guide-tooltip-body">${step.content}</div>
			<div class="guide-tooltip-footer">
				<span class="guide-progress">${stepIndex + 1} of ${guideSteps.length}</span>
				<div class="guide-buttons">
					<button class="guide-btn guide-btn-skip" onclick="endGuide()">Skip</button>
					${stepIndex > 0 ? '<button class="guide-btn guide-btn-prev" onclick="prevGuideStep()"><i class="fas fa-arrow-left"></i> Back</button>' : ''}
					${stepIndex < guideSteps.length - 1 
						? '<button class="guide-btn guide-btn-next" onclick="nextGuideStep()">Next <i class="fas fa-arrow-right"></i></button>' 
						: '<button class="guide-btn guide-btn-finish" onclick="endGuide()"><i class="fas fa-check"></i> Finish</button>'}
				</div>
			</div>
		`;

		const tooltipWidth = 340;
		const tooltipHeight = 180;
		let tooltipTop, tooltipLeft;

		switch(step.position) {
			case 'top':
				tooltipTop = rect.top + scrollTop - tooltipHeight - 20;
				tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - (tooltipWidth / 2);
				break;
			case 'bottom':
				tooltipTop = rect.bottom + scrollTop + 20;
				tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - (tooltipWidth / 2);
				break;
			case 'left':
				tooltipTop = rect.top + scrollTop + (rect.height / 2) - (tooltipHeight / 2);
				tooltipLeft = rect.left + scrollLeft - tooltipWidth - 20;
				break;
			case 'right':
				tooltipTop = rect.top + scrollTop + (rect.height / 2) - (tooltipHeight / 2);
				tooltipLeft = rect.right + scrollLeft + 20;
				break;
			default:
				tooltipTop = rect.bottom + scrollTop + 20;
				tooltipLeft = rect.left + scrollLeft;
		}

		tooltipLeft = Math.max(10, Math.min(tooltipLeft, window.innerWidth - tooltipWidth - 10));
		tooltipTop = Math.max(10, tooltipTop);

		tooltip.style.top = tooltipTop + 'px';
		tooltip.style.left = tooltipLeft + 'px';
		container.appendChild(tooltip);
	}, 300);
}

function nextGuideStep() {
	currentGuideStep++;
	showGuideStep(currentGuideStep);
}

function prevGuideStep() {
	currentGuideStep--;
	showGuideStep(currentGuideStep);
}

function endGuide() {
	guideActive = false;
	const container = document.getElementById('guideContainer');
	if (container) container.innerHTML = '';
	document.getElementById('startGuideBtn').style.display = 'flex';
}
// ===== END DEMO AND HELP GUIDE FUNCTIONS =====

// Use centralized AuthManager
const authManager=new AuthManager();
async function waitForCompanyId(timeoutMs=6000){
	const start=Date.now();
	return new Promise(resolve=>{
		const t=setInterval(()=>{
			if(authManager.currentUser && authManager.currentUser.companyId){ clearInterval(t); resolve(); }
			else if(Date.now()-start>timeoutMs){ clearInterval(t); resolve(); }
		},150);
	});
}

(async function initIncidentBoard(){
	await waitForCompanyId();
	const user=authManager.currentUser; window.authManager = authManager; // expose for menu auth
	if(!user) return;
	setBranding(authManager.currentCompany||{});
	// Initialize role-based sidebar after auth
	if(typeof initializeMenuAuthorization==='function') initializeMenuAuthorization(); else updateMenuWithFeatureAuthorization();
	// Initialize EmailJS for notifications
	initEmailJS();
	await loadUsersMap();
	await loadIncidents(user.companyId);
})();
</script>
</body>
</html>
