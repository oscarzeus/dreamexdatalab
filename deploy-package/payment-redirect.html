<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processing Payment...</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff6b35;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
  <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8 text-center">
    <div class="spinner mx-auto mb-6"></div>
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Processing Payment...</h1>
    <p class="text-gray-600 mb-6">Please wait while we connect you to Orange Money.</p>
    
    <div id="connectionStatus" class="text-sm text-gray-500 mb-4">
      Checking payment gateway connection...
    </div>
    
    <div id="fallbackOptions" class="hidden">
      <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
        <p class="text-yellow-800 text-sm mb-3">
          <strong>Connection Issue:</strong> Unable to reach the payment gateway.
        </p>
        <p class="text-yellow-700 text-xs mb-3">
          This usually means the Orange Money backend server is not running.
        </p>
      </div>
      
      <div class="space-y-3">
        <button id="retryBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded">
          Retry Connection
        </button>
        <button id="manualPayBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded">
          Manual Payment Instructions
        </button>
        <a href="/company-complete-registration.html" class="block w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded text-decoration-none">
          Return to Registration
        </a>
      </div>
    </div>
    
    <div id="manualInstructions" class="hidden bg-blue-50 border border-blue-200 rounded-md p-4 text-left">
      <h3 class="font-semibold text-blue-800 mb-2">Manual Payment Instructions</h3>
      <ol class="text-sm text-blue-700 space-y-1">
        <li>1. Open Orange Money app on your phone</li>
        <li>2. Select "Pay Merchant" or "Payer Marchand"</li>
        <li>3. Enter merchant code: <strong id="merchantCode">DREAMEX</strong></li>
        <li>4. Enter amount: <strong id="paymentAmount">Loading...</strong></li>
        <li>5. Enter reference: <strong id="orderReference">Loading...</strong></li>
        <li>6. Complete payment with your PIN</li>
        <li>7. Screenshot the confirmation and email it to: <strong>support@dreamexdatalab.com</strong></li>
      </ol>
      <div class="mt-3 text-xs text-blue-600">
        After manual payment, <a href="/company-complete-registration.html?payment=manual" class="underline">click here to continue registration</a>
      </div>
    </div>
  </div>

  <script>
    // Get payment parameters from URL
    const params = new URLSearchParams(window.location.search);
    const amount = params.get('amount') || '0';
    const orderId = params.get('order_id') || 'N/A';
    const description = params.get('description') || 'Payment';
    
    // Update manual payment instructions
    document.getElementById('paymentAmount').textContent = amount + ' GNF';
    document.getElementById('orderReference').textContent = orderId;

    // Connection test URLs to try
    const paymentUrls = [
      'https://api.dreamexdatalab.com',
      'http://localhost:8080',
      'http://localhost:3000'
    ];

    let currentUrlIndex = 0;
    let connectionSuccessful = false;

    async function testConnection(url) {
      try {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), 5000); // 5s timeout
        
        const response = await fetch(url + '/health', {
          signal: controller.signal,
          mode: 'cors'
        });
        
        return response.ok;
      } catch (error) {
        console.log('Connection failed for:', url, error.message);
        return false;
      }
    }

    async function tryNextConnection() {
      if (currentUrlIndex >= paymentUrls.length) {
        // All URLs failed, show fallback options
        showFallbackOptions();
        return;
      }

      const currentUrl = paymentUrls[currentUrlIndex];
      document.getElementById('connectionStatus').textContent = `Trying ${currentUrl.replace('http://', '').replace('https://', '')}...`;
      
      const isReachable = await testConnection(currentUrl);
      
      if (isReachable) {
        // Success! Redirect to payment page
        connectionSuccessful = true;
        document.getElementById('connectionStatus').innerHTML = `
          <span class="text-green-600">✓ Connected successfully!</span><br>
          <span class="text-sm">Redirecting to Orange Money...</span>
        `;
        
        const paymentUrl = currentUrl + '/?' + params.toString();
        setTimeout(() => {
          window.location.href = paymentUrl;
        }, 1500);
      } else {
        currentUrlIndex++;
        setTimeout(tryNextConnection, 1000);
      }
    }

    function showFallbackOptions() {
      document.getElementById('connectionStatus').innerHTML = '<span class="text-red-600">✗ Unable to connect to payment gateway</span>';
      document.getElementById('fallbackOptions').classList.remove('hidden');
    }

    // Retry button
    document.getElementById('retryBtn').addEventListener('click', () => {
      currentUrlIndex = 0;
      document.getElementById('fallbackOptions').classList.add('hidden');
      document.getElementById('manualInstructions').classList.add('hidden');
      tryNextConnection();
    });

    // Manual payment instructions button
    document.getElementById('manualPayBtn').addEventListener('click', () => {
      document.getElementById('manualInstructions').classList.toggle('hidden');
    });

    // Start connection testing
    setTimeout(tryNextConnection, 1000);
  </script>
</body>
</html>